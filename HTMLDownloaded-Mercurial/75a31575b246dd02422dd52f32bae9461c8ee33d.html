<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 28867:75a31575b246dd02422dd52f32bae9461c8ee33d</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 75a31575b246dd02422dd52f32bae9461c8ee33d" />
<meta property="og:url" content="/comm-central/rev/75a31575b246dd02422dd52f32bae9461c8ee33d" />
<meta property="og:description" content="Bug 1619022 - Stop using png2ico.py for Windows builds. r=rjl" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 75a31575b246dd02422dd52f32bae9461c8ee33d 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/75a31575b246dd02422dd52f32bae9461c8ee33d">shortlog</a> |
<a href="/comm-central/log/75a31575b246dd02422dd52f32bae9461c8ee33d">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/75a31575b246dd02422dd52f32bae9461c8ee33d">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/75a31575b246dd02422dd52f32bae9461c8ee33d">files</a> |
changeset |
<a href="/comm-central/raw-rev/75a31575b246dd02422dd52f32bae9461c8ee33d">raw</a>  | <a href="/comm-central/archive/75a31575b246dd02422dd52f32bae9461c8ee33d.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1619022">Bug 1619022</a> - Stop using png2ico.py for Windows builds. r=rjl
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#82;&#105;&#99;&#104;&#97;&#114;&#100;&#32;&#77;&#97;&#114;&#116;&#105;&#32;&#60;&#114;&#105;&#99;&#104;&#97;&#114;&#100;&#46;&#109;&#97;&#114;&#116;&#105;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Sat, 29 Feb 2020 13:55:34 +0100</td></tr>

<tr>
 <td>changeset 28867</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/75a31575b246dd02422dd52f32bae9461c8ee33d">75a31575b246dd02422dd52f32bae9461c8ee33d</a></td>
</tr>



<tr>
<td>parent 28866</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/0ebeb53641ffc6ba167f05f26ab585ad11371b93">0ebeb53641ffc6ba167f05f26ab585ad11371b93</a>
</td>
</tr>

<tr>
<td>child 28868</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/a2b845d81aa7ec01565155a3f20300d18f9014ca">a2b845d81aa7ec01565155a3f20300d18f9014ca</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=75a31575b246dd02422dd52f32bae9461c8ee33d">17084</a></td></tr>
<tr><td>push user</td><td>thunderbird@calypsoblue.org</td></tr>
<tr><td>push date</td><td class="date age">Sun, 01 Mar 2020 16:43:39 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@a2b845d81aa7 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=a2b845d81aa7ec01565155a3f20300d18f9014ca">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=a2b845d81aa7ec01565155a3f20300d18f9014ca&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a2b845d81aa7ec01565155a3f20300d18f9014ca&newProject=comm-central&newRevision=75a31575b246dd02422dd52f32bae9461c8ee33d&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a2b845d81aa7ec01565155a3f20300d18f9014ca&newProject=comm-central&newRevision=75a31575b246dd02422dd52f32bae9461c8ee33d&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a2b845d81aa7ec01565155a3f20300d18f9014ca&newProject=comm-central&newRevision=75a31575b246dd02422dd52f32bae9461c8ee33d&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28rjl%29&revcount=50">rjl</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1619022">1619022</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1619022">Bug 1619022</a> - Stop using png2ico.py for Windows builds. r=rjl</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/75a31575b246dd02422dd52f32bae9461c8ee33d/mail/app/Makefile.in">mail/app/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/75a31575b246dd02422dd52f32bae9461c8ee33d/mail/app/Makefile.in">file</a> |
<a href="/comm-central/annotate/75a31575b246dd02422dd52f32bae9461c8ee33d/mail/app/Makefile.in">annotate</a> |
<a href="/comm-central/diff/75a31575b246dd02422dd52f32bae9461c8ee33d/mail/app/Makefile.in">diff</a> |
<a href="/comm-central/comparison/75a31575b246dd02422dd52f32bae9461c8ee33d/mail/app/Makefile.in">comparison</a> |
<a href="/comm-central/log/75a31575b246dd02422dd52f32bae9461c8ee33d/mail/app/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/75a31575b246dd02422dd52f32bae9461c8ee33d/mail/app/moz.build">mail/app/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/75a31575b246dd02422dd52f32bae9461c8ee33d/mail/app/moz.build">file</a> |
<a href="/comm-central/annotate/75a31575b246dd02422dd52f32bae9461c8ee33d/mail/app/moz.build">annotate</a> |
<a href="/comm-central/diff/75a31575b246dd02422dd52f32bae9461c8ee33d/mail/app/moz.build">diff</a> |
<a href="/comm-central/comparison/75a31575b246dd02422dd52f32bae9461c8ee33d/mail/app/moz.build">comparison</a> |
<a href="/comm-central/log/75a31575b246dd02422dd52f32bae9461c8ee33d/mail/app/moz.build">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/75a31575b246dd02422dd52f32bae9461c8ee33d/mail/app/png.py">mail/app/png.py</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/75a31575b246dd02422dd52f32bae9461c8ee33d/mail/app/png.py">diff</a> |
<a href="/comm-central/comparison/75a31575b246dd02422dd52f32bae9461c8ee33d/mail/app/png.py">comparison</a> |
<a href="/comm-central/log/75a31575b246dd02422dd52f32bae9461c8ee33d/mail/app/png.py">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/75a31575b246dd02422dd52f32bae9461c8ee33d/mail/app/png2ico.py">mail/app/png2ico.py</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/75a31575b246dd02422dd52f32bae9461c8ee33d/mail/app/png2ico.py">diff</a> |
<a href="/comm-central/comparison/75a31575b246dd02422dd52f32bae9461c8ee33d/mail/app/png2ico.py">comparison</a> |
<a href="/comm-central/log/75a31575b246dd02422dd52f32bae9461c8ee33d/mail/app/png2ico.py">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/75a31575b246dd02422dd52f32bae9461c8ee33d/mail/app/splash.rc">mail/app/splash.rc</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/75a31575b246dd02422dd52f32bae9461c8ee33d/mail/app/splash.rc">file</a> |
<a href="/comm-central/annotate/75a31575b246dd02422dd52f32bae9461c8ee33d/mail/app/splash.rc">annotate</a> |
<a href="/comm-central/diff/75a31575b246dd02422dd52f32bae9461c8ee33d/mail/app/splash.rc">diff</a> |
<a href="/comm-central/comparison/75a31575b246dd02422dd52f32bae9461c8ee33d/mail/app/splash.rc">comparison</a> |
<a href="/comm-central/log/75a31575b246dd02422dd52f32bae9461c8ee33d/mail/app/splash.rc">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/75a31575b246dd02422dd52f32bae9461c8ee33d/mail/branding/nightly/addressbook.ico">mail/branding/nightly/addressbook.ico</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/75a31575b246dd02422dd52f32bae9461c8ee33d/mail/branding/nightly/addressbook.ico">file</a> |
<a href="/comm-central/annotate/75a31575b246dd02422dd52f32bae9461c8ee33d/mail/branding/nightly/addressbook.ico">annotate</a> |
<a href="/comm-central/diff/75a31575b246dd02422dd52f32bae9461c8ee33d/mail/branding/nightly/addressbook.ico">diff</a> |
<a href="/comm-central/comparison/75a31575b246dd02422dd52f32bae9461c8ee33d/mail/branding/nightly/addressbook.ico">comparison</a> |
<a href="/comm-central/log/75a31575b246dd02422dd52f32bae9461c8ee33d/mail/branding/nightly/addressbook.ico">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/75a31575b246dd02422dd52f32bae9461c8ee33d/mail/branding/nightly/windows/messengerWindow.ico">mail/branding/nightly/windows/messengerWindow.ico</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/75a31575b246dd02422dd52f32bae9461c8ee33d/mail/branding/nightly/windows/messengerWindow.ico">diff</a> |
<a href="/comm-central/comparison/75a31575b246dd02422dd52f32bae9461c8ee33d/mail/branding/nightly/windows/messengerWindow.ico">comparison</a> |
<a href="/comm-central/log/75a31575b246dd02422dd52f32bae9461c8ee33d/mail/branding/nightly/windows/messengerWindow.ico">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/75a31575b246dd02422dd52f32bae9461c8ee33d/mail/branding/nightly/writeMessage.ico">mail/branding/nightly/writeMessage.ico</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/75a31575b246dd02422dd52f32bae9461c8ee33d/mail/branding/nightly/writeMessage.ico">file</a> |
<a href="/comm-central/annotate/75a31575b246dd02422dd52f32bae9461c8ee33d/mail/branding/nightly/writeMessage.ico">annotate</a> |
<a href="/comm-central/diff/75a31575b246dd02422dd52f32bae9461c8ee33d/mail/branding/nightly/writeMessage.ico">diff</a> |
<a href="/comm-central/comparison/75a31575b246dd02422dd52f32bae9461c8ee33d/mail/branding/nightly/writeMessage.ico">comparison</a> |
<a href="/comm-central/log/75a31575b246dd02422dd52f32bae9461c8ee33d/mail/branding/nightly/writeMessage.ico">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/75a31575b246dd02422dd52f32bae9461c8ee33d/mail/branding/thunderbird/addressbook.ico">mail/branding/thunderbird/addressbook.ico</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/75a31575b246dd02422dd52f32bae9461c8ee33d/mail/branding/thunderbird/addressbook.ico">file</a> |
<a href="/comm-central/annotate/75a31575b246dd02422dd52f32bae9461c8ee33d/mail/branding/thunderbird/addressbook.ico">annotate</a> |
<a href="/comm-central/diff/75a31575b246dd02422dd52f32bae9461c8ee33d/mail/branding/thunderbird/addressbook.ico">diff</a> |
<a href="/comm-central/comparison/75a31575b246dd02422dd52f32bae9461c8ee33d/mail/branding/thunderbird/addressbook.ico">comparison</a> |
<a href="/comm-central/log/75a31575b246dd02422dd52f32bae9461c8ee33d/mail/branding/thunderbird/addressbook.ico">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/75a31575b246dd02422dd52f32bae9461c8ee33d/mail/branding/thunderbird/writeMessage.ico">mail/branding/thunderbird/writeMessage.ico</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/75a31575b246dd02422dd52f32bae9461c8ee33d/mail/branding/thunderbird/writeMessage.ico">file</a> |
<a href="/comm-central/annotate/75a31575b246dd02422dd52f32bae9461c8ee33d/mail/branding/thunderbird/writeMessage.ico">annotate</a> |
<a href="/comm-central/diff/75a31575b246dd02422dd52f32bae9461c8ee33d/mail/branding/thunderbird/writeMessage.ico">diff</a> |
<a href="/comm-central/comparison/75a31575b246dd02422dd52f32bae9461c8ee33d/mail/branding/thunderbird/writeMessage.ico">comparison</a> |
<a href="/comm-central/log/75a31575b246dd02422dd52f32bae9461c8ee33d/mail/branding/thunderbird/writeMessage.ico">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/app/Makefile.in</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/app/Makefile.in</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -2,22 +2,16 @@</span>
<a href="#l1.4"></a><span id="l1.4"> # License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l1.5"></a><span id="l1.5"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l1.6"></a><span id="l1.6"> </span>
<a href="#l1.7"></a><span id="l1.7"> AB_CD = $(MOZ_UI_LOCALE)</span>
<a href="#l1.8"></a><span id="l1.8"> </span>
<a href="#l1.9"></a><span id="l1.9"> GRE_MILESTONE = $(shell $(PYTHON) $(moztopsrcdir)/config/printconfigsetting.py $(DIST)/bin/platform.ini Build Milestone)</span>
<a href="#l1.10"></a><span id="l1.10"> MOZ_BUILDID = $(shell $(PYTHON) $(moztopsrcdir)/config/printconfigsetting.py $(DIST)/bin/platform.ini Build BuildID)</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-DEFINES += \</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-  -DTHUNDERBIRD_ICO='&quot;$(topsrcdir)/$(MOZ_BRANDING_DIRECTORY)/messengerWindow.ico&quot;' \</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineminus">-  -DTB_MAILBIFF_ICO='&quot;$(topsrcdir)/$(MOZ_BRANDING_DIRECTORY)/newmail.ico&quot;' \</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineminus">-   $(NULL)</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineminus">-</span>
<a href="#l1.18"></a><span id="l1.18"> # Build a binary bootstrapping with XRE_main</span>
<a href="#l1.19"></a><span id="l1.19"> </span>
<a href="#l1.20"></a><span id="l1.20"> ifndef MOZ_WINCONSOLE</span>
<a href="#l1.21"></a><span id="l1.21"> ifdef MOZ_DEBUG</span>
<a href="#l1.22"></a><span id="l1.22"> MOZ_WINCONSOLE = 1</span>
<a href="#l1.23"></a><span id="l1.23"> else</span>
<a href="#l1.24"></a><span id="l1.24"> MOZ_WINCONSOLE = 0</span>
<a href="#l1.25"></a><span id="l1.25"> endif</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineat">@@ -27,50 +21,18 @@ include $(moztopsrcdir)/config/config.mk</span>
<a href="#l1.27"></a><span id="l1.27"> </span>
<a href="#l1.28"></a><span id="l1.28"> # If we are trying to show an error dialog about the lack of SSE2 support,</span>
<a href="#l1.29"></a><span id="l1.29"> # make sure that code itself doesn't use SSE2.</span>
<a href="#l1.30"></a><span id="l1.30"> ifdef MOZ_LINUX_32_SSE2_STARTUP_ERROR</span>
<a href="#l1.31"></a><span id="l1.31"> CXX := $(filter-out -march=% -msse -msse2 -mfpmath=sse,$(CXX))</span>
<a href="#l1.32"></a><span id="l1.32"> CXX += -march=pentiumpro</span>
<a href="#l1.33"></a><span id="l1.33"> endif</span>
<a href="#l1.34"></a><span id="l1.34"> </span>
<a href="#l1.35"></a><span id="l1.35" class="difflineminus">-ifeq ($(OS_ARCH),WINNT)</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineminus">-# Extract the icons we care about embedding into the EXE</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineminus">-mailtoolbar = $(commtopsrcdir)/mail/themes/windows/mail/icons/jumplist.png</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineminus">-</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineminus">-# png to ico converter. The function takes 5 arguments, in order: source png</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineminus">-# file, left, top, size, output ico file.</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineminus">-png2ico = $(PYTHON) $(srcdir)/png2ico.py $(1) $(2) $(3) $(4) $(5)</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineminus">-</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineminus">-# Each icon is 18x18 in the toolbar, and we want a 16x16 icon here, so we cut</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineminus">-# off a pixel at each end.</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineminus">-write-message.ico: $(mailtoolbar) $(srcdir)/png2ico.py</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineminus">-	$(call png2ico,$(mailtoolbar),0,0,16,write-message.ico)</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineminus">-</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineminus">-address-book.ico: $(mailtoolbar) $(srcdir)/png2ico.py</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineminus">-	$(call png2ico,$(mailtoolbar),16,0,16,address-book.ico)</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineminus">-</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineminus">-embedded-icons:: write-message.ico address-book.ico</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineminus">-GARBAGE += write-message.ico address-book.ico</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineminus">-</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineminus">-# Rebuild thunderbird.exe if the manifest changes - it's included by splash.rc.</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineminus">-# (this dependency should really be just for thunderbird.exe, not other targets)</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineminus">-# Note the manifest file exists in the tree, so we use the explicit filename</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineminus">-# here.</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineminus">-EXTRA_DEPS += $(srcdir)/thunderbird.exe.manifest</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineminus">-endif</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineminus">-</span>
<a href="#l1.61"></a><span id="l1.61"> include $(moztopsrcdir)/config/rules.mk</span>
<a href="#l1.62"></a><span id="l1.62"> </span>
<a href="#l1.63"></a><span id="l1.63" class="difflineminus">-ifeq ($(OS_ARCH),WINNT)</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineminus">-</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineminus">-$(RESFILE): embedded-icons</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineminus">-</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineminus">-endif</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineminus">-</span>
<a href="#l1.69"></a><span id="l1.69"> ifneq ($(OS_ARCH),WINNT)</span>
<a href="#l1.70"></a><span id="l1.70"> ifdef COMPILE_ENVIRONMENT</span>
<a href="#l1.71"></a><span id="l1.71"> ifndef MOZ_NO_PIE_COMPAT</span>
<a href="#l1.72"></a><span id="l1.72"> libs::</span>
<a href="#l1.73"></a><span id="l1.73"> 	cp -p $(DIST)/bin/$(MOZ_APP_NAME)$(BIN_SUFFIX) $(DIST)/bin/$(MOZ_APP_NAME)-bin$(BIN_SUFFIX)</span>
<a href="#l1.74"></a><span id="l1.74"> endif</span>
<a href="#l1.75"></a><span id="l1.75"> endif</span>
<a href="#l1.76"></a><span id="l1.76"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/app/moz.build</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/app/moz.build</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -85,8 +85,12 @@ if CONFIG['MOZ_LINUX_32_SSE2_STARTUP_ERR</span>
<a href="#l2.4"></a><span id="l2.4">         if not f.startswith('-march=') and f not in ('-msse', '-msse2', '-mfpmath=sse')</span>
<a href="#l2.5"></a><span id="l2.5">     ] + [</span>
<a href="#l2.6"></a><span id="l2.6">         '-mno-sse', '-mno-sse2', '-mfpmath=387',</span>
<a href="#l2.7"></a><span id="l2.7">     ]</span>
<a href="#l2.8"></a><span id="l2.8"> </span>
<a href="#l2.9"></a><span id="l2.9"> JS_PREFERENCE_PP_FILES += [</span>
<a href="#l2.10"></a><span id="l2.10">     'profile/all-thunderbird.js',</span>
<a href="#l2.11"></a><span id="l2.11"> ]</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+for icon in ('messengerWindow', 'newmail', 'writeMessage', 'addressbook'):</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+    DEFINES[icon.upper() + '_ICO'] = '&quot;%s/%s/%s.ico&quot;' % (</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+        TOPSRCDIR, CONFIG['MOZ_BRANDING_DIRECTORY'], icon)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1">deleted file mode 100644</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineminus">--- a/mail/app/png.py</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineplus">+++ /dev/null</span>
<a href="#l3.4"></a><span id="l3.4" class="difflineat">@@ -1,3785 +0,0 @@</span>
<a href="#l3.5"></a><span id="l3.5" class="difflineminus">-#!/usr/bin/env python</span>
<a href="#l3.6"></a><span id="l3.6" class="difflineminus">-</span>
<a href="#l3.7"></a><span id="l3.7" class="difflineminus">-# $URL: http://pypng.googlecode.com/svn/trunk/code/png.py $</span>
<a href="#l3.8"></a><span id="l3.8" class="difflineminus">-# $Rev: 228 $</span>
<a href="#l3.9"></a><span id="l3.9" class="difflineminus">-</span>
<a href="#l3.10"></a><span id="l3.10" class="difflineminus">-# png.py - PNG encoder/decoder in pure Python</span>
<a href="#l3.11"></a><span id="l3.11" class="difflineminus">-#</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-# Copyright (C) 2006 Johann C. Rocholl &lt;johann@browsershots.org&gt;</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-# Portions Copyright (C) 2009 David Jones &lt;drj@pobox.com&gt;</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-# And probably portions Copyright (C) 2006 Nicko van Someren &lt;nicko@nicko.org&gt;</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-#</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineminus">-# Original concept by Johann C. Rocholl.</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineminus">-#</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineminus">-# LICENSE (The MIT License)</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineminus">-#</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineminus">-# Permission is hereby granted, free of charge, to any person</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineminus">-# obtaining a copy of this software and associated documentation files</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineminus">-# (the &quot;Software&quot;), to deal in the Software without restriction,</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineminus">-# including without limitation the rights to use, copy, modify, merge,</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineminus">-# publish, distribute, sublicense, and/or sell copies of the Software,</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineminus">-# and to permit persons to whom the Software is furnished to do so,</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineminus">-# subject to the following conditions:</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineminus">-#</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineminus">-# The above copyright notice and this permission notice shall be</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineminus">-# included in all copies or substantial portions of the Software.</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineminus">-#</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-# THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineminus">-# EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineminus">-# MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineminus">-# NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineminus">-# BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineminus">-# ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineminus">-# CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineminus">-# SOFTWARE.</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineminus">-#</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineminus">-# Changelog (recent first):</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineminus">-# 2009-03-11 David: interlaced bit depth &lt; 8 (writing).</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineminus">-# 2009-03-10 David: interlaced bit depth &lt; 8 (reading).</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineminus">-# 2009-03-04 David: Flat and Boxed pixel formats.</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineminus">-# 2009-02-26 David: Palette support (writing).</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineminus">-# 2009-02-23 David: Bit-depths &lt; 8; better PNM support.</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineminus">-# 2006-06-17 Nicko: Reworked into a class, faster interlacing.</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineminus">-# 2006-06-17 Johann: Very simple prototype PNG decoder.</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineminus">-# 2006-06-17 Nicko: Test suite with various image generators.</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineminus">-# 2006-06-17 Nicko: Alpha-channel, grey-scale, 16-bit/plane support.</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineminus">-# 2006-06-15 Johann: Scanline iterator interface for large input files.</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineminus">-# 2006-06-09 Johann: Very simple prototype PNG encoder.</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineminus">-</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineminus">-# Incorporated into Bangai-O Development Tools by drj on 2009-02-11 from</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineminus">-# http://trac.browsershots.org/browser/trunk/pypng/lib/png.py?rev=2885</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineminus">-</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineminus">-# Incorporated into pypng by drj on 2009-03-12 from</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineminus">-# //depot/prj/bangaio/master/code/png.py#67</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineminus">-</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineminus">-</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineminus">-&quot;&quot;&quot;</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineminus">-Pure Python PNG Reader/Writer</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineminus">-</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineminus">-This Python module implements support for PNG images (see PNG</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineminus">-specification at http://www.w3.org/TR/2003/REC-PNG-20031110/ ). It reads</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineminus">-and writes PNG files with all allowable bit depths (1/2/4/8/16/24/32/48/64</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineminus">-bits per pixel) and colour combinations: greyscale (1/2/4/8/16 bit); RGB,</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineminus">-RGBA, LA (greyscale with alpha) with 8/16 bits per channel; colour mapped</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineminus">-images (1/2/4/8 bit).  Adam7 interlacing is supported for reading and</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineminus">-writing.  A number of optional chunks can be specified (when writing)</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineminus">-and understood (when reading): ``tRNS``, ``bKGD``, ``gAMA``.</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineminus">-</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineminus">-For help, type ``import png; help(png)`` in your python interpreter.</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineminus">-</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineminus">-A good place to start is the :class:`Reader` and :class:`Writer` classes.</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineminus">-</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineminus">-Requires Python 2.3.  Limited support is available for Python 2.2, but</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineminus">-not everything works.  Best with Python 2.4 and higher.  Installation is</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineminus">-trivial, but see the ``README.txt`` file (with the source distribution)</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineminus">-for details.</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineminus">-</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineminus">-This file can also be used as a command-line utility to convert</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineminus">-`Netpbm &lt;http://netpbm.sourceforge.net/&gt;`_ PNM files to PNG, and the reverse conversion from PNG to</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineminus">-PNM. The interface is similar to that of the ``pnmtopng`` program from</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineminus">-Netpbm.  Type ``python png.py --help`` at the shell prompt</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineminus">-for usage and a list of options.</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineminus">-</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineminus">-A note on spelling and terminology</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineminus">-----------------------------------</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineminus">-</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineminus">-Generally British English spelling is used in the documentation.  So</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineminus">-that's &quot;greyscale&quot; and &quot;colour&quot;.  This not only matches the author's</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineminus">-native language, it's also used by the PNG specification.</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineminus">-</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineminus">-The major colour models supported by PNG (and hence by PyPNG) are:</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineminus">-greyscale, RGB, greyscale--alpha, RGB--alpha.  These are sometimes</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineminus">-referred to using the abbreviations: L, RGB, LA, RGBA.  In this case</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineminus">-each letter abbreviates a single channel: *L* is for Luminance or Luma or</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineminus">-Lightness which is the channel used in greyscale images; *R*, *G*, *B* stand</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineminus">-for Red, Green, Blue, the components of a colour image; *A* stands for</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineminus">-Alpha, the opacity channel (used for transparency effects, but higher</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineminus">-values are more opaque, so it makes sense to call it opacity).</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineminus">-</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineminus">-A note on formats</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineminus">------------------</span>
<a href="#l3.105"></a><span id="l3.105" class="difflineminus">-</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineminus">-When getting pixel data out of this module (reading) and presenting</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineminus">-data to this module (writing) there are a number of ways the data could</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineminus">-be represented as a Python value.  Generally this module uses one of</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineminus">-three formats called &quot;flat row flat pixel&quot;, &quot;boxed row flat pixel&quot;, and</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineminus">-&quot;boxed row boxed pixel&quot;.  Basically the concern is whether each pixel</span>
<a href="#l3.111"></a><span id="l3.111" class="difflineminus">-and each row comes in its own little tuple (box), or not.</span>
<a href="#l3.112"></a><span id="l3.112" class="difflineminus">-</span>
<a href="#l3.113"></a><span id="l3.113" class="difflineminus">-Consider an image that is 3 pixels wide by 2 pixels high, and each pixel</span>
<a href="#l3.114"></a><span id="l3.114" class="difflineminus">-has RGB components:</span>
<a href="#l3.115"></a><span id="l3.115" class="difflineminus">-</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineminus">-Boxed row flat pixel::</span>
<a href="#l3.117"></a><span id="l3.117" class="difflineminus">-</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineminus">-  list([R,G,B, R,G,B, R,G,B],</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineminus">-       [R,G,B, R,G,B, R,G,B])</span>
<a href="#l3.120"></a><span id="l3.120" class="difflineminus">-</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineminus">-Each row appears as its own list, but the pixels are flattened so that</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineminus">-three values for one pixel simply follow the three values for the previous</span>
<a href="#l3.123"></a><span id="l3.123" class="difflineminus">-pixel.  This is the most common format used, because it provides a good</span>
<a href="#l3.124"></a><span id="l3.124" class="difflineminus">-compromise between space and convenience.  PyPNG regards itself as</span>
<a href="#l3.125"></a><span id="l3.125" class="difflineminus">-at liberty to replace any sequence type with any sufficiently compatible</span>
<a href="#l3.126"></a><span id="l3.126" class="difflineminus">-other sequence type; in practice each row is an array (from the array</span>
<a href="#l3.127"></a><span id="l3.127" class="difflineminus">-module), and the outer list is sometimes an iterator rather than an</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineminus">-explicit list (so that streaming is possible).</span>
<a href="#l3.129"></a><span id="l3.129" class="difflineminus">-</span>
<a href="#l3.130"></a><span id="l3.130" class="difflineminus">-Flat row flat pixel::</span>
<a href="#l3.131"></a><span id="l3.131" class="difflineminus">-</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineminus">-  [R,G,B, R,G,B, R,G,B,</span>
<a href="#l3.133"></a><span id="l3.133" class="difflineminus">-   R,G,B, R,G,B, R,G,B]</span>
<a href="#l3.134"></a><span id="l3.134" class="difflineminus">-</span>
<a href="#l3.135"></a><span id="l3.135" class="difflineminus">-The entire image is one single giant sequence of colour values.</span>
<a href="#l3.136"></a><span id="l3.136" class="difflineminus">-Generally an array will be used (to save space), not a list.</span>
<a href="#l3.137"></a><span id="l3.137" class="difflineminus">-</span>
<a href="#l3.138"></a><span id="l3.138" class="difflineminus">-Boxed row boxed pixel::</span>
<a href="#l3.139"></a><span id="l3.139" class="difflineminus">-</span>
<a href="#l3.140"></a><span id="l3.140" class="difflineminus">-  list([ (R,G,B), (R,G,B), (R,G,B) ],</span>
<a href="#l3.141"></a><span id="l3.141" class="difflineminus">-       [ (R,G,B), (R,G,B), (R,G,B) ])</span>
<a href="#l3.142"></a><span id="l3.142" class="difflineminus">-</span>
<a href="#l3.143"></a><span id="l3.143" class="difflineminus">-Each row appears in its own list, but each pixel also appears in its own</span>
<a href="#l3.144"></a><span id="l3.144" class="difflineminus">-tuple.  A serious memory burn in Python.</span>
<a href="#l3.145"></a><span id="l3.145" class="difflineminus">-</span>
<a href="#l3.146"></a><span id="l3.146" class="difflineminus">-In all cases the top row comes first, and for each row the pixels are</span>
<a href="#l3.147"></a><span id="l3.147" class="difflineminus">-ordered from left-to-right.  Within a pixel the values appear in the</span>
<a href="#l3.148"></a><span id="l3.148" class="difflineminus">-order, R-G-B-A (or L-A for greyscale--alpha).</span>
<a href="#l3.149"></a><span id="l3.149" class="difflineminus">-</span>
<a href="#l3.150"></a><span id="l3.150" class="difflineminus">-There is a fourth format, mentioned because it is used internally,</span>
<a href="#l3.151"></a><span id="l3.151" class="difflineminus">-is close to what lies inside a PNG file itself, and has some support</span>
<a href="#l3.152"></a><span id="l3.152" class="difflineminus">-from the public API.  This format is called packed.  When packed,</span>
<a href="#l3.153"></a><span id="l3.153" class="difflineminus">-each row is a sequence of bytes (integers from 0 to 255), just as</span>
<a href="#l3.154"></a><span id="l3.154" class="difflineminus">-it is before PNG scanline filtering is applied.  When the bit depth</span>
<a href="#l3.155"></a><span id="l3.155" class="difflineminus">-is 8 this is essentially the same as boxed row flat pixel; when the</span>
<a href="#l3.156"></a><span id="l3.156" class="difflineminus">-bit depth is less than 8, several pixels are packed into each byte;</span>
<a href="#l3.157"></a><span id="l3.157" class="difflineminus">-when the bit depth is 16 (the only value more than 8 that is supported</span>
<a href="#l3.158"></a><span id="l3.158" class="difflineminus">-by the PNG image format) each pixel value is decomposed into 2 bytes</span>
<a href="#l3.159"></a><span id="l3.159" class="difflineminus">-(and `packed` is a misnomer).  This format is used by the</span>
<a href="#l3.160"></a><span id="l3.160" class="difflineminus">-:meth:`Writer.write_packed` method.  It isn't usually a convenient</span>
<a href="#l3.161"></a><span id="l3.161" class="difflineminus">-format, but may be just right if the source data for the PNG image</span>
<a href="#l3.162"></a><span id="l3.162" class="difflineminus">-comes from something that uses a similar format (for example, 1-bit</span>
<a href="#l3.163"></a><span id="l3.163" class="difflineminus">-BMPs, or another PNG file).</span>
<a href="#l3.164"></a><span id="l3.164" class="difflineminus">-</span>
<a href="#l3.165"></a><span id="l3.165" class="difflineminus">-And now, my famous members</span>
<a href="#l3.166"></a><span id="l3.166" class="difflineminus">---------------------------</span>
<a href="#l3.167"></a><span id="l3.167" class="difflineminus">-&quot;&quot;&quot;</span>
<a href="#l3.168"></a><span id="l3.168" class="difflineminus">-</span>
<a href="#l3.169"></a><span id="l3.169" class="difflineminus">-# http://www.python.org/doc/2.2.3/whatsnew/node5.html</span>
<a href="#l3.170"></a><span id="l3.170" class="difflineminus">-from __future__ import generators</span>
<a href="#l3.171"></a><span id="l3.171" class="difflineminus">-</span>
<a href="#l3.172"></a><span id="l3.172" class="difflineminus">-__version__ = &quot;$URL: http://pypng.googlecode.com/svn/trunk/code/png.py $ $Rev: 228 $&quot;</span>
<a href="#l3.173"></a><span id="l3.173" class="difflineminus">-</span>
<a href="#l3.174"></a><span id="l3.174" class="difflineminus">-from array import array</span>
<a href="#l3.175"></a><span id="l3.175" class="difflineminus">-try: # See :pyver:old</span>
<a href="#l3.176"></a><span id="l3.176" class="difflineminus">-    import itertools</span>
<a href="#l3.177"></a><span id="l3.177" class="difflineminus">-except:</span>
<a href="#l3.178"></a><span id="l3.178" class="difflineminus">-    pass</span>
<a href="#l3.179"></a><span id="l3.179" class="difflineminus">-import math</span>
<a href="#l3.180"></a><span id="l3.180" class="difflineminus">-# http://www.python.org/doc/2.4.4/lib/module-operator.html</span>
<a href="#l3.181"></a><span id="l3.181" class="difflineminus">-import operator</span>
<a href="#l3.182"></a><span id="l3.182" class="difflineminus">-import struct</span>
<a href="#l3.183"></a><span id="l3.183" class="difflineminus">-import sys</span>
<a href="#l3.184"></a><span id="l3.184" class="difflineminus">-import zlib</span>
<a href="#l3.185"></a><span id="l3.185" class="difflineminus">-# http://www.python.org/doc/2.4.4/lib/module-warnings.html</span>
<a href="#l3.186"></a><span id="l3.186" class="difflineminus">-import warnings</span>
<a href="#l3.187"></a><span id="l3.187" class="difflineminus">-</span>
<a href="#l3.188"></a><span id="l3.188" class="difflineminus">-</span>
<a href="#l3.189"></a><span id="l3.189" class="difflineminus">-__all__ = ['Image', 'Reader', 'Writer', 'write_chunks', 'from_array']</span>
<a href="#l3.190"></a><span id="l3.190" class="difflineminus">-</span>
<a href="#l3.191"></a><span id="l3.191" class="difflineminus">-</span>
<a href="#l3.192"></a><span id="l3.192" class="difflineminus">-# The PNG signature.</span>
<a href="#l3.193"></a><span id="l3.193" class="difflineminus">-# http://www.w3.org/TR/PNG/#5PNG-file-signature</span>
<a href="#l3.194"></a><span id="l3.194" class="difflineminus">-_signature = struct.pack('8B', 137, 80, 78, 71, 13, 10, 26, 10)</span>
<a href="#l3.195"></a><span id="l3.195" class="difflineminus">-</span>
<a href="#l3.196"></a><span id="l3.196" class="difflineminus">-_adam7 = ((0, 0, 8, 8),</span>
<a href="#l3.197"></a><span id="l3.197" class="difflineminus">-          (4, 0, 8, 8),</span>
<a href="#l3.198"></a><span id="l3.198" class="difflineminus">-          (0, 4, 4, 8),</span>
<a href="#l3.199"></a><span id="l3.199" class="difflineminus">-          (2, 0, 4, 4),</span>
<a href="#l3.200"></a><span id="l3.200" class="difflineminus">-          (0, 2, 2, 4),</span>
<a href="#l3.201"></a><span id="l3.201" class="difflineminus">-          (1, 0, 2, 2),</span>
<a href="#l3.202"></a><span id="l3.202" class="difflineminus">-          (0, 1, 1, 2))</span>
<a href="#l3.203"></a><span id="l3.203" class="difflineminus">-</span>
<a href="#l3.204"></a><span id="l3.204" class="difflineminus">-def group(s, n):</span>
<a href="#l3.205"></a><span id="l3.205" class="difflineminus">-    # See</span>
<a href="#l3.206"></a><span id="l3.206" class="difflineminus">-    # http://www.python.org/doc/2.6/library/functions.html#zip</span>
<a href="#l3.207"></a><span id="l3.207" class="difflineminus">-    return zip(*[iter(s)]*n)</span>
<a href="#l3.208"></a><span id="l3.208" class="difflineminus">-</span>
<a href="#l3.209"></a><span id="l3.209" class="difflineminus">-def isarray(x):</span>
<a href="#l3.210"></a><span id="l3.210" class="difflineminus">-    &quot;&quot;&quot;Same as ``isinstance(x, array)`` except on Python 2.2, where it</span>
<a href="#l3.211"></a><span id="l3.211" class="difflineminus">-    always returns ``False``.  This helps PyPNG work on Python 2.2.</span>
<a href="#l3.212"></a><span id="l3.212" class="difflineminus">-    &quot;&quot;&quot;</span>
<a href="#l3.213"></a><span id="l3.213" class="difflineminus">-</span>
<a href="#l3.214"></a><span id="l3.214" class="difflineminus">-    try:</span>
<a href="#l3.215"></a><span id="l3.215" class="difflineminus">-        return isinstance(x, array)</span>
<a href="#l3.216"></a><span id="l3.216" class="difflineminus">-    except:</span>
<a href="#l3.217"></a><span id="l3.217" class="difflineminus">-        return False</span>
<a href="#l3.218"></a><span id="l3.218" class="difflineminus">-</span>
<a href="#l3.219"></a><span id="l3.219" class="difflineminus">-try:  # see :pyver:old</span>
<a href="#l3.220"></a><span id="l3.220" class="difflineminus">-    array.tostring</span>
<a href="#l3.221"></a><span id="l3.221" class="difflineminus">-except:</span>
<a href="#l3.222"></a><span id="l3.222" class="difflineminus">-    def tostring(row):</span>
<a href="#l3.223"></a><span id="l3.223" class="difflineminus">-        l = len(row)</span>
<a href="#l3.224"></a><span id="l3.224" class="difflineminus">-        return struct.pack('%dB' % l, *row)</span>
<a href="#l3.225"></a><span id="l3.225" class="difflineminus">-else:</span>
<a href="#l3.226"></a><span id="l3.226" class="difflineminus">-    def tostring(row):</span>
<a href="#l3.227"></a><span id="l3.227" class="difflineminus">-        &quot;&quot;&quot;Convert row of bytes to string.  Expects `row` to be an</span>
<a href="#l3.228"></a><span id="l3.228" class="difflineminus">-        ``array``.</span>
<a href="#l3.229"></a><span id="l3.229" class="difflineminus">-        &quot;&quot;&quot;</span>
<a href="#l3.230"></a><span id="l3.230" class="difflineminus">-        return row.tostring()</span>
<a href="#l3.231"></a><span id="l3.231" class="difflineminus">-</span>
<a href="#l3.232"></a><span id="l3.232" class="difflineminus">-# Conditionally convert to bytes.  Works on Python 2 and Python 3.</span>
<a href="#l3.233"></a><span id="l3.233" class="difflineminus">-try:</span>
<a href="#l3.234"></a><span id="l3.234" class="difflineminus">-    bytes('', 'ascii')</span>
<a href="#l3.235"></a><span id="l3.235" class="difflineminus">-    def strtobytes(x): return bytes(x, 'iso8859-1')</span>
<a href="#l3.236"></a><span id="l3.236" class="difflineminus">-    def bytestostr(x): return str(x, 'iso8859-1')</span>
<a href="#l3.237"></a><span id="l3.237" class="difflineminus">-except:</span>
<a href="#l3.238"></a><span id="l3.238" class="difflineminus">-    strtobytes = str</span>
<a href="#l3.239"></a><span id="l3.239" class="difflineminus">-    bytestostr = str</span>
<a href="#l3.240"></a><span id="l3.240" class="difflineminus">-</span>
<a href="#l3.241"></a><span id="l3.241" class="difflineminus">-def interleave_planes(ipixels, apixels, ipsize, apsize):</span>
<a href="#l3.242"></a><span id="l3.242" class="difflineminus">-    &quot;&quot;&quot;</span>
<a href="#l3.243"></a><span id="l3.243" class="difflineminus">-    Interleave (colour) planes, e.g. RGB + A = RGBA.</span>
<a href="#l3.244"></a><span id="l3.244" class="difflineminus">-</span>
<a href="#l3.245"></a><span id="l3.245" class="difflineminus">-    Return an array of pixels consisting of the `ipsize` elements of data</span>
<a href="#l3.246"></a><span id="l3.246" class="difflineminus">-    from each pixel in `ipixels` followed by the `apsize` elements of data</span>
<a href="#l3.247"></a><span id="l3.247" class="difflineminus">-    from each pixel in `apixels`.  Conventionally `ipixels` and</span>
<a href="#l3.248"></a><span id="l3.248" class="difflineminus">-    `apixels` are byte arrays so the sizes are bytes, but it actually</span>
<a href="#l3.249"></a><span id="l3.249" class="difflineminus">-    works with any arrays of the same type.  The returned array is the</span>
<a href="#l3.250"></a><span id="l3.250" class="difflineminus">-    same type as the input arrays which should be the same type as each other.</span>
<a href="#l3.251"></a><span id="l3.251" class="difflineminus">-    &quot;&quot;&quot;</span>
<a href="#l3.252"></a><span id="l3.252" class="difflineminus">-</span>
<a href="#l3.253"></a><span id="l3.253" class="difflineminus">-    itotal = len(ipixels)</span>
<a href="#l3.254"></a><span id="l3.254" class="difflineminus">-    atotal = len(apixels)</span>
<a href="#l3.255"></a><span id="l3.255" class="difflineminus">-    newtotal = itotal + atotal</span>
<a href="#l3.256"></a><span id="l3.256" class="difflineminus">-    newpsize = ipsize + apsize</span>
<a href="#l3.257"></a><span id="l3.257" class="difflineminus">-    # Set up the output buffer</span>
<a href="#l3.258"></a><span id="l3.258" class="difflineminus">-    # See http://www.python.org/doc/2.4.4/lib/module-array.html#l2h-1356</span>
<a href="#l3.259"></a><span id="l3.259" class="difflineminus">-    out = array(ipixels.typecode)</span>
<a href="#l3.260"></a><span id="l3.260" class="difflineminus">-    # It's annoying that there is no cheap way to set the array size :-(</span>
<a href="#l3.261"></a><span id="l3.261" class="difflineminus">-    out.extend(ipixels)</span>
<a href="#l3.262"></a><span id="l3.262" class="difflineminus">-    out.extend(apixels)</span>
<a href="#l3.263"></a><span id="l3.263" class="difflineminus">-    # Interleave in the pixel data</span>
<a href="#l3.264"></a><span id="l3.264" class="difflineminus">-    for i in range(ipsize):</span>
<a href="#l3.265"></a><span id="l3.265" class="difflineminus">-        out[i:newtotal:newpsize] = ipixels[i:itotal:ipsize]</span>
<a href="#l3.266"></a><span id="l3.266" class="difflineminus">-    for i in range(apsize):</span>
<a href="#l3.267"></a><span id="l3.267" class="difflineminus">-        out[i+ipsize:newtotal:newpsize] = apixels[i:atotal:apsize]</span>
<a href="#l3.268"></a><span id="l3.268" class="difflineminus">-    return out</span>
<a href="#l3.269"></a><span id="l3.269" class="difflineminus">-</span>
<a href="#l3.270"></a><span id="l3.270" class="difflineminus">-def check_palette(palette):</span>
<a href="#l3.271"></a><span id="l3.271" class="difflineminus">-    &quot;&quot;&quot;Check a palette argument (to the :class:`Writer` class) for validity.</span>
<a href="#l3.272"></a><span id="l3.272" class="difflineminus">-    Returns the palette as a list if okay; raises an exception otherwise.</span>
<a href="#l3.273"></a><span id="l3.273" class="difflineminus">-    &quot;&quot;&quot;</span>
<a href="#l3.274"></a><span id="l3.274" class="difflineminus">-</span>
<a href="#l3.275"></a><span id="l3.275" class="difflineminus">-    # None is the default and is allowed.</span>
<a href="#l3.276"></a><span id="l3.276" class="difflineminus">-    if palette is None:</span>
<a href="#l3.277"></a><span id="l3.277" class="difflineminus">-        return None</span>
<a href="#l3.278"></a><span id="l3.278" class="difflineminus">-</span>
<a href="#l3.279"></a><span id="l3.279" class="difflineminus">-    p = list(palette)</span>
<a href="#l3.280"></a><span id="l3.280" class="difflineminus">-    if not (0 &lt; len(p) &lt;= 256):</span>
<a href="#l3.281"></a><span id="l3.281" class="difflineminus">-        raise ValueError(&quot;a palette must have between 1 and 256 entries&quot;)</span>
<a href="#l3.282"></a><span id="l3.282" class="difflineminus">-    seen_triple = False</span>
<a href="#l3.283"></a><span id="l3.283" class="difflineminus">-    for i,t in enumerate(p):</span>
<a href="#l3.284"></a><span id="l3.284" class="difflineminus">-        if len(t) not in (3,4):</span>
<a href="#l3.285"></a><span id="l3.285" class="difflineminus">-            raise ValueError(</span>
<a href="#l3.286"></a><span id="l3.286" class="difflineminus">-              &quot;palette entry %d: entries must be 3- or 4-tuples.&quot; % i)</span>
<a href="#l3.287"></a><span id="l3.287" class="difflineminus">-        if len(t) == 3:</span>
<a href="#l3.288"></a><span id="l3.288" class="difflineminus">-            seen_triple = True</span>
<a href="#l3.289"></a><span id="l3.289" class="difflineminus">-        if seen_triple and len(t) == 4:</span>
<a href="#l3.290"></a><span id="l3.290" class="difflineminus">-            raise ValueError(</span>
<a href="#l3.291"></a><span id="l3.291" class="difflineminus">-              &quot;palette entry %d: all 4-tuples must precede all 3-tuples&quot; % i)</span>
<a href="#l3.292"></a><span id="l3.292" class="difflineminus">-        for x in t:</span>
<a href="#l3.293"></a><span id="l3.293" class="difflineminus">-            if int(x) != x or not(0 &lt;= x &lt;= 255):</span>
<a href="#l3.294"></a><span id="l3.294" class="difflineminus">-                raise ValueError(</span>
<a href="#l3.295"></a><span id="l3.295" class="difflineminus">-                  &quot;palette entry %d: values must be integer: 0 &lt;= x &lt;= 255&quot; % i)</span>
<a href="#l3.296"></a><span id="l3.296" class="difflineminus">-    return p</span>
<a href="#l3.297"></a><span id="l3.297" class="difflineminus">-</span>
<a href="#l3.298"></a><span id="l3.298" class="difflineminus">-class Error(Exception):</span>
<a href="#l3.299"></a><span id="l3.299" class="difflineminus">-    prefix = 'Error'</span>
<a href="#l3.300"></a><span id="l3.300" class="difflineminus">-    def __str__(self):</span>
<a href="#l3.301"></a><span id="l3.301" class="difflineminus">-        return self.prefix + ': ' + ' '.join(self.args)</span>
<a href="#l3.302"></a><span id="l3.302" class="difflineminus">-</span>
<a href="#l3.303"></a><span id="l3.303" class="difflineminus">-class FormatError(Error):</span>
<a href="#l3.304"></a><span id="l3.304" class="difflineminus">-    &quot;&quot;&quot;Problem with input file format.  In other words, PNG file does</span>
<a href="#l3.305"></a><span id="l3.305" class="difflineminus">-    not conform to the specification in some way and is invalid.</span>
<a href="#l3.306"></a><span id="l3.306" class="difflineminus">-    &quot;&quot;&quot;</span>
<a href="#l3.307"></a><span id="l3.307" class="difflineminus">-</span>
<a href="#l3.308"></a><span id="l3.308" class="difflineminus">-    prefix = 'FormatError'</span>
<a href="#l3.309"></a><span id="l3.309" class="difflineminus">-</span>
<a href="#l3.310"></a><span id="l3.310" class="difflineminus">-class ChunkError(FormatError):</span>
<a href="#l3.311"></a><span id="l3.311" class="difflineminus">-    prefix = 'ChunkError'</span>
<a href="#l3.312"></a><span id="l3.312" class="difflineminus">-</span>
<a href="#l3.313"></a><span id="l3.313" class="difflineminus">-</span>
<a href="#l3.314"></a><span id="l3.314" class="difflineminus">-class Writer:</span>
<a href="#l3.315"></a><span id="l3.315" class="difflineminus">-    &quot;&quot;&quot;</span>
<a href="#l3.316"></a><span id="l3.316" class="difflineminus">-    PNG encoder in pure Python.</span>
<a href="#l3.317"></a><span id="l3.317" class="difflineminus">-    &quot;&quot;&quot;</span>
<a href="#l3.318"></a><span id="l3.318" class="difflineminus">-</span>
<a href="#l3.319"></a><span id="l3.319" class="difflineminus">-    def __init__(self, width=None, height=None,</span>
<a href="#l3.320"></a><span id="l3.320" class="difflineminus">-                 size=None,</span>
<a href="#l3.321"></a><span id="l3.321" class="difflineminus">-                 greyscale=False,</span>
<a href="#l3.322"></a><span id="l3.322" class="difflineminus">-                 alpha=False,</span>
<a href="#l3.323"></a><span id="l3.323" class="difflineminus">-                 bitdepth=8,</span>
<a href="#l3.324"></a><span id="l3.324" class="difflineminus">-                 palette=None,</span>
<a href="#l3.325"></a><span id="l3.325" class="difflineminus">-                 transparent=None,</span>
<a href="#l3.326"></a><span id="l3.326" class="difflineminus">-                 background=None,</span>
<a href="#l3.327"></a><span id="l3.327" class="difflineminus">-                 gamma=None,</span>
<a href="#l3.328"></a><span id="l3.328" class="difflineminus">-                 compression=None,</span>
<a href="#l3.329"></a><span id="l3.329" class="difflineminus">-                 interlace=False,</span>
<a href="#l3.330"></a><span id="l3.330" class="difflineminus">-                 bytes_per_sample=None, # deprecated</span>
<a href="#l3.331"></a><span id="l3.331" class="difflineminus">-                 planes=None,</span>
<a href="#l3.332"></a><span id="l3.332" class="difflineminus">-                 colormap=None,</span>
<a href="#l3.333"></a><span id="l3.333" class="difflineminus">-                 maxval=None,</span>
<a href="#l3.334"></a><span id="l3.334" class="difflineminus">-                 chunk_limit=2**20):</span>
<a href="#l3.335"></a><span id="l3.335" class="difflineminus">-        &quot;&quot;&quot;</span>
<a href="#l3.336"></a><span id="l3.336" class="difflineminus">-        Create a PNG encoder object.</span>
<a href="#l3.337"></a><span id="l3.337" class="difflineminus">-</span>
<a href="#l3.338"></a><span id="l3.338" class="difflineminus">-        Arguments:</span>
<a href="#l3.339"></a><span id="l3.339" class="difflineminus">-</span>
<a href="#l3.340"></a><span id="l3.340" class="difflineminus">-        width, height</span>
<a href="#l3.341"></a><span id="l3.341" class="difflineminus">-          Image size in pixels, as two separate arguments.</span>
<a href="#l3.342"></a><span id="l3.342" class="difflineminus">-        size</span>
<a href="#l3.343"></a><span id="l3.343" class="difflineminus">-          Image size (w,h) in pixels, as single argument.</span>
<a href="#l3.344"></a><span id="l3.344" class="difflineminus">-        greyscale</span>
<a href="#l3.345"></a><span id="l3.345" class="difflineminus">-          Input data is greyscale, not RGB.</span>
<a href="#l3.346"></a><span id="l3.346" class="difflineminus">-        alpha</span>
<a href="#l3.347"></a><span id="l3.347" class="difflineminus">-          Input data has alpha channel (RGBA or LA).</span>
<a href="#l3.348"></a><span id="l3.348" class="difflineminus">-        bitdepth</span>
<a href="#l3.349"></a><span id="l3.349" class="difflineminus">-          Bit depth: from 1 to 16.</span>
<a href="#l3.350"></a><span id="l3.350" class="difflineminus">-        palette</span>
<a href="#l3.351"></a><span id="l3.351" class="difflineminus">-          Create a palette for a colour mapped image (colour type 3).</span>
<a href="#l3.352"></a><span id="l3.352" class="difflineminus">-        transparent</span>
<a href="#l3.353"></a><span id="l3.353" class="difflineminus">-          Specify a transparent colour (create a ``tRNS`` chunk).</span>
<a href="#l3.354"></a><span id="l3.354" class="difflineminus">-        background</span>
<a href="#l3.355"></a><span id="l3.355" class="difflineminus">-          Specify a default background colour (create a ``bKGD`` chunk).</span>
<a href="#l3.356"></a><span id="l3.356" class="difflineminus">-        gamma</span>
<a href="#l3.357"></a><span id="l3.357" class="difflineminus">-          Specify a gamma value (create a ``gAMA`` chunk).</span>
<a href="#l3.358"></a><span id="l3.358" class="difflineminus">-        compression</span>
<a href="#l3.359"></a><span id="l3.359" class="difflineminus">-          zlib compression level (1-9).</span>
<a href="#l3.360"></a><span id="l3.360" class="difflineminus">-        interlace</span>
<a href="#l3.361"></a><span id="l3.361" class="difflineminus">-          Create an interlaced image.</span>
<a href="#l3.362"></a><span id="l3.362" class="difflineminus">-        chunk_limit</span>
<a href="#l3.363"></a><span id="l3.363" class="difflineminus">-          Write multiple ``IDAT`` chunks to save memory.</span>
<a href="#l3.364"></a><span id="l3.364" class="difflineminus">-</span>
<a href="#l3.365"></a><span id="l3.365" class="difflineminus">-        The image size (in pixels) can be specified either by using the</span>
<a href="#l3.366"></a><span id="l3.366" class="difflineminus">-        `width` and `height` arguments, or with the single `size`</span>
<a href="#l3.367"></a><span id="l3.367" class="difflineminus">-        argument.  If `size` is used it should be a pair (*width*,</span>
<a href="#l3.368"></a><span id="l3.368" class="difflineminus">-        *height*).</span>
<a href="#l3.369"></a><span id="l3.369" class="difflineminus">-</span>
<a href="#l3.370"></a><span id="l3.370" class="difflineminus">-        `greyscale` and `alpha` are booleans that specify whether</span>
<a href="#l3.371"></a><span id="l3.371" class="difflineminus">-        an image is greyscale (or colour), and whether it has an</span>
<a href="#l3.372"></a><span id="l3.372" class="difflineminus">-        alpha channel (or not).</span>
<a href="#l3.373"></a><span id="l3.373" class="difflineminus">-</span>
<a href="#l3.374"></a><span id="l3.374" class="difflineminus">-        `bitdepth` specifies the bit depth of the source pixel values.</span>
<a href="#l3.375"></a><span id="l3.375" class="difflineminus">-        Each source pixel value must be an integer between 0 and</span>
<a href="#l3.376"></a><span id="l3.376" class="difflineminus">-        ``2**bitdepth-1``.  For example, 8-bit images have values</span>
<a href="#l3.377"></a><span id="l3.377" class="difflineminus">-        between 0 and 255.  PNG only stores images with bit depths of</span>
<a href="#l3.378"></a><span id="l3.378" class="difflineminus">-        1,2,4,8, or 16.  When `bitdepth` is not one of these values,</span>
<a href="#l3.379"></a><span id="l3.379" class="difflineminus">-        the next highest valid bit depth is selected, and an ``sBIT``</span>
<a href="#l3.380"></a><span id="l3.380" class="difflineminus">-        (significant bits) chunk is generated that specifies the original</span>
<a href="#l3.381"></a><span id="l3.381" class="difflineminus">-        precision of the source image.  In this case the supplied pixel</span>
<a href="#l3.382"></a><span id="l3.382" class="difflineminus">-        values will be rescaled to fit the range of the selected bit depth.</span>
<a href="#l3.383"></a><span id="l3.383" class="difflineminus">-</span>
<a href="#l3.384"></a><span id="l3.384" class="difflineminus">-        The details of which bit depth / colour model combinations the</span>
<a href="#l3.385"></a><span id="l3.385" class="difflineminus">-        PNG file format supports directly, are somewhat arcane</span>
<a href="#l3.386"></a><span id="l3.386" class="difflineminus">-        (refer to the PNG specification for full details).  Briefly:</span>
<a href="#l3.387"></a><span id="l3.387" class="difflineminus">-        &quot;small&quot; bit depths (1,2,4) are only allowed with greyscale and</span>
<a href="#l3.388"></a><span id="l3.388" class="difflineminus">-        colour mapped images; colour mapped images cannot have bit depth</span>
<a href="#l3.389"></a><span id="l3.389" class="difflineminus">-        16.</span>
<a href="#l3.390"></a><span id="l3.390" class="difflineminus">-</span>
<a href="#l3.391"></a><span id="l3.391" class="difflineminus">-        For colour mapped images (in other words, when the `palette`</span>
<a href="#l3.392"></a><span id="l3.392" class="difflineminus">-        argument is specified) the `bitdepth` argument must match one of</span>
<a href="#l3.393"></a><span id="l3.393" class="difflineminus">-        the valid PNG bit depths: 1, 2, 4, or 8.  (It is valid to have a</span>
<a href="#l3.394"></a><span id="l3.394" class="difflineminus">-        PNG image with a palette and an ``sBIT`` chunk, but the meaning</span>
<a href="#l3.395"></a><span id="l3.395" class="difflineminus">-        is slightly different; it would be awkward to press the</span>
<a href="#l3.396"></a><span id="l3.396" class="difflineminus">-        `bitdepth` argument into service for this.)</span>
<a href="#l3.397"></a><span id="l3.397" class="difflineminus">-</span>
<a href="#l3.398"></a><span id="l3.398" class="difflineminus">-        The `palette` option, when specified, causes a colour mapped image</span>
<a href="#l3.399"></a><span id="l3.399" class="difflineminus">-        to be created: the PNG colour type is set to 3; greyscale</span>
<a href="#l3.400"></a><span id="l3.400" class="difflineminus">-        must not be set; alpha must not be set; transparent must</span>
<a href="#l3.401"></a><span id="l3.401" class="difflineminus">-        not be set; the bit depth must be 1,2,4, or 8.  When a colour</span>
<a href="#l3.402"></a><span id="l3.402" class="difflineminus">-        mapped image is created, the pixel values are palette indexes</span>
<a href="#l3.403"></a><span id="l3.403" class="difflineminus">-        and the `bitdepth` argument specifies the size of these indexes</span>
<a href="#l3.404"></a><span id="l3.404" class="difflineminus">-        (not the size of the colour values in the palette).</span>
<a href="#l3.405"></a><span id="l3.405" class="difflineminus">-</span>
<a href="#l3.406"></a><span id="l3.406" class="difflineminus">-        The palette argument value should be a sequence of 3- or</span>
<a href="#l3.407"></a><span id="l3.407" class="difflineminus">-        4-tuples.  3-tuples specify RGB palette entries; 4-tuples</span>
<a href="#l3.408"></a><span id="l3.408" class="difflineminus">-        specify RGBA palette entries.  If both 4-tuples and 3-tuples</span>
<a href="#l3.409"></a><span id="l3.409" class="difflineminus">-        appear in the sequence then all the 4-tuples must come</span>
<a href="#l3.410"></a><span id="l3.410" class="difflineminus">-        before all the 3-tuples.  A ``PLTE`` chunk is created; if there</span>
<a href="#l3.411"></a><span id="l3.411" class="difflineminus">-        are 4-tuples then a ``tRNS`` chunk is created as well.  The</span>
<a href="#l3.412"></a><span id="l3.412" class="difflineminus">-        ``PLTE`` chunk will contain all the RGB triples in the same</span>
<a href="#l3.413"></a><span id="l3.413" class="difflineminus">-        sequence; the ``tRNS`` chunk will contain the alpha channel for</span>
<a href="#l3.414"></a><span id="l3.414" class="difflineminus">-        all the 4-tuples, in the same sequence.  Palette entries</span>
<a href="#l3.415"></a><span id="l3.415" class="difflineminus">-        are always 8-bit.</span>
<a href="#l3.416"></a><span id="l3.416" class="difflineminus">-</span>
<a href="#l3.417"></a><span id="l3.417" class="difflineminus">-        If specified, the `transparent` and `background` parameters must</span>
<a href="#l3.418"></a><span id="l3.418" class="difflineminus">-        be a tuple with three integer values for red, green, blue, or</span>
<a href="#l3.419"></a><span id="l3.419" class="difflineminus">-        a simple integer (or singleton tuple) for a greyscale image.</span>
<a href="#l3.420"></a><span id="l3.420" class="difflineminus">-</span>
<a href="#l3.421"></a><span id="l3.421" class="difflineminus">-        If specified, the `gamma` parameter must be a positive number</span>
<a href="#l3.422"></a><span id="l3.422" class="difflineminus">-        (generally, a float).  A ``gAMA`` chunk will be created.  Note that</span>
<a href="#l3.423"></a><span id="l3.423" class="difflineminus">-        this will not change the values of the pixels as they appear in</span>
<a href="#l3.424"></a><span id="l3.424" class="difflineminus">-        the PNG file, they are assumed to have already been converted</span>
<a href="#l3.425"></a><span id="l3.425" class="difflineminus">-        appropriately for the gamma specified.</span>
<a href="#l3.426"></a><span id="l3.426" class="difflineminus">-</span>
<a href="#l3.427"></a><span id="l3.427" class="difflineminus">-        The `compression` argument specifies the compression level</span>
<a href="#l3.428"></a><span id="l3.428" class="difflineminus">-        to be used by the ``zlib`` module.  Higher values are likely</span>
<a href="#l3.429"></a><span id="l3.429" class="difflineminus">-        to compress better, but will be slower to compress.  The</span>
<a href="#l3.430"></a><span id="l3.430" class="difflineminus">-        default for this argument is ``None``; this does not mean</span>
<a href="#l3.431"></a><span id="l3.431" class="difflineminus">-        no compression, rather it means that the default from the</span>
<a href="#l3.432"></a><span id="l3.432" class="difflineminus">-        ``zlib`` module is used (which is generally acceptable).</span>
<a href="#l3.433"></a><span id="l3.433" class="difflineminus">-</span>
<a href="#l3.434"></a><span id="l3.434" class="difflineminus">-        If `interlace` is true then an interlaced image is created</span>
<a href="#l3.435"></a><span id="l3.435" class="difflineminus">-        (using PNG's so far only interface method, *Adam7*).  This does not</span>
<a href="#l3.436"></a><span id="l3.436" class="difflineminus">-        affect how the pixels should be presented to the encoder, rather</span>
<a href="#l3.437"></a><span id="l3.437" class="difflineminus">-        it changes how they are arranged into the PNG file.  On slow</span>
<a href="#l3.438"></a><span id="l3.438" class="difflineminus">-        connexions interlaced images can be partially decoded by the</span>
<a href="#l3.439"></a><span id="l3.439" class="difflineminus">-        browser to give a rough view of the image that is successively</span>
<a href="#l3.440"></a><span id="l3.440" class="difflineminus">-        refined as more image data appears.</span>
<a href="#l3.441"></a><span id="l3.441" class="difflineminus">-        </span>
<a href="#l3.442"></a><span id="l3.442" class="difflineminus">-        .. note ::</span>
<a href="#l3.443"></a><span id="l3.443" class="difflineminus">-        </span>
<a href="#l3.444"></a><span id="l3.444" class="difflineminus">-          Enabling the `interlace` option requires the entire image</span>
<a href="#l3.445"></a><span id="l3.445" class="difflineminus">-          to be processed in working memory.</span>
<a href="#l3.446"></a><span id="l3.446" class="difflineminus">-</span>
<a href="#l3.447"></a><span id="l3.447" class="difflineminus">-        `chunk_limit` is used to limit the amount of memory used whilst</span>
<a href="#l3.448"></a><span id="l3.448" class="difflineminus">-        compressing the image.  In order to avoid using large amounts of</span>
<a href="#l3.449"></a><span id="l3.449" class="difflineminus">-        memory, multiple ``IDAT`` chunks may be created.</span>
<a href="#l3.450"></a><span id="l3.450" class="difflineminus">-        &quot;&quot;&quot;</span>
<a href="#l3.451"></a><span id="l3.451" class="difflineminus">-</span>
<a href="#l3.452"></a><span id="l3.452" class="difflineminus">-        # At the moment the `planes` argument is ignored;</span>
<a href="#l3.453"></a><span id="l3.453" class="difflineminus">-        # its purpose is to act as a dummy so that</span>
<a href="#l3.454"></a><span id="l3.454" class="difflineminus">-        # ``Writer(x, y, **info)`` works, where `info` is a dictionary</span>
<a href="#l3.455"></a><span id="l3.455" class="difflineminus">-        # returned by Reader.read and friends.</span>
<a href="#l3.456"></a><span id="l3.456" class="difflineminus">-        # Ditto for `colormap`.</span>
<a href="#l3.457"></a><span id="l3.457" class="difflineminus">-</span>
<a href="#l3.458"></a><span id="l3.458" class="difflineminus">-        # A couple of helper functions come first.  Best skipped if you</span>
<a href="#l3.459"></a><span id="l3.459" class="difflineminus">-        # are reading through.</span>
<a href="#l3.460"></a><span id="l3.460" class="difflineminus">-</span>
<a href="#l3.461"></a><span id="l3.461" class="difflineminus">-        def isinteger(x):</span>
<a href="#l3.462"></a><span id="l3.462" class="difflineminus">-            try:</span>
<a href="#l3.463"></a><span id="l3.463" class="difflineminus">-                return int(x) == x</span>
<a href="#l3.464"></a><span id="l3.464" class="difflineminus">-            except:</span>
<a href="#l3.465"></a><span id="l3.465" class="difflineminus">-                return False</span>
<a href="#l3.466"></a><span id="l3.466" class="difflineminus">-</span>
<a href="#l3.467"></a><span id="l3.467" class="difflineminus">-        def check_color(c, which):</span>
<a href="#l3.468"></a><span id="l3.468" class="difflineminus">-            &quot;&quot;&quot;Checks that a colour argument for transparent or</span>
<a href="#l3.469"></a><span id="l3.469" class="difflineminus">-            background options is the right form.  Also &quot;corrects&quot; bare</span>
<a href="#l3.470"></a><span id="l3.470" class="difflineminus">-            integers to 1-tuples.</span>
<a href="#l3.471"></a><span id="l3.471" class="difflineminus">-            &quot;&quot;&quot;</span>
<a href="#l3.472"></a><span id="l3.472" class="difflineminus">-</span>
<a href="#l3.473"></a><span id="l3.473" class="difflineminus">-            if c is None:</span>
<a href="#l3.474"></a><span id="l3.474" class="difflineminus">-                return c</span>
<a href="#l3.475"></a><span id="l3.475" class="difflineminus">-            if greyscale:</span>
<a href="#l3.476"></a><span id="l3.476" class="difflineminus">-                try:</span>
<a href="#l3.477"></a><span id="l3.477" class="difflineminus">-                    l = len(c)</span>
<a href="#l3.478"></a><span id="l3.478" class="difflineminus">-                except TypeError:</span>
<a href="#l3.479"></a><span id="l3.479" class="difflineminus">-                    c = (c,)</span>
<a href="#l3.480"></a><span id="l3.480" class="difflineminus">-                if len(c) != 1:</span>
<a href="#l3.481"></a><span id="l3.481" class="difflineminus">-                    raise ValueError(&quot;%s for greyscale must be 1-tuple&quot; %</span>
<a href="#l3.482"></a><span id="l3.482" class="difflineminus">-                        which)</span>
<a href="#l3.483"></a><span id="l3.483" class="difflineminus">-                if not isinteger(c[0]):</span>
<a href="#l3.484"></a><span id="l3.484" class="difflineminus">-                    raise ValueError(</span>
<a href="#l3.485"></a><span id="l3.485" class="difflineminus">-                        &quot;%s colour for greyscale must be integer&quot; %</span>
<a href="#l3.486"></a><span id="l3.486" class="difflineminus">-                        which)</span>
<a href="#l3.487"></a><span id="l3.487" class="difflineminus">-            else:</span>
<a href="#l3.488"></a><span id="l3.488" class="difflineminus">-                if not (len(c) == 3 and</span>
<a href="#l3.489"></a><span id="l3.489" class="difflineminus">-                        isinteger(c[0]) and</span>
<a href="#l3.490"></a><span id="l3.490" class="difflineminus">-                        isinteger(c[1]) and</span>
<a href="#l3.491"></a><span id="l3.491" class="difflineminus">-                        isinteger(c[2])):</span>
<a href="#l3.492"></a><span id="l3.492" class="difflineminus">-                    raise ValueError(</span>
<a href="#l3.493"></a><span id="l3.493" class="difflineminus">-                        &quot;%s colour must be a triple of integers&quot; %</span>
<a href="#l3.494"></a><span id="l3.494" class="difflineminus">-                        which)</span>
<a href="#l3.495"></a><span id="l3.495" class="difflineminus">-            return c</span>
<a href="#l3.496"></a><span id="l3.496" class="difflineminus">-</span>
<a href="#l3.497"></a><span id="l3.497" class="difflineminus">-        if size:</span>
<a href="#l3.498"></a><span id="l3.498" class="difflineminus">-            if len(size) != 2:</span>
<a href="#l3.499"></a><span id="l3.499" class="difflineminus">-                raise ValueError(</span>
<a href="#l3.500"></a><span id="l3.500" class="difflineminus">-                  &quot;size argument should be a pair (width, height)&quot;)</span>
<a href="#l3.501"></a><span id="l3.501" class="difflineminus">-            if width is not None and width != size[0]:</span>
<a href="#l3.502"></a><span id="l3.502" class="difflineminus">-                raise ValueError(</span>
<a href="#l3.503"></a><span id="l3.503" class="difflineminus">-                  &quot;size[0] (%r) and width (%r) should match when both are used.&quot;</span>
<a href="#l3.504"></a><span id="l3.504" class="difflineminus">-                    % (size[0], width))</span>
<a href="#l3.505"></a><span id="l3.505" class="difflineminus">-            if height is not None and height != size[1]:</span>
<a href="#l3.506"></a><span id="l3.506" class="difflineminus">-                raise ValueError(</span>
<a href="#l3.507"></a><span id="l3.507" class="difflineminus">-                  &quot;size[1] (%r) and height (%r) should match when both are used.&quot;</span>
<a href="#l3.508"></a><span id="l3.508" class="difflineminus">-                    % (size[1], height))</span>
<a href="#l3.509"></a><span id="l3.509" class="difflineminus">-            width,height = size</span>
<a href="#l3.510"></a><span id="l3.510" class="difflineminus">-        del size</span>
<a href="#l3.511"></a><span id="l3.511" class="difflineminus">-</span>
<a href="#l3.512"></a><span id="l3.512" class="difflineminus">-        if width &lt;= 0 or height &lt;= 0:</span>
<a href="#l3.513"></a><span id="l3.513" class="difflineminus">-            raise ValueError(&quot;width and height must be greater than zero&quot;)</span>
<a href="#l3.514"></a><span id="l3.514" class="difflineminus">-        if not isinteger(width) or not isinteger(height):</span>
<a href="#l3.515"></a><span id="l3.515" class="difflineminus">-            raise ValueError(&quot;width and height must be integers&quot;)</span>
<a href="#l3.516"></a><span id="l3.516" class="difflineminus">-        # http://www.w3.org/TR/PNG/#7Integers-and-byte-order</span>
<a href="#l3.517"></a><span id="l3.517" class="difflineminus">-        if width &gt; 2**32-1 or height &gt; 2**32-1:</span>
<a href="#l3.518"></a><span id="l3.518" class="difflineminus">-            raise ValueError(&quot;width and height cannot exceed 2**32-1&quot;)</span>
<a href="#l3.519"></a><span id="l3.519" class="difflineminus">-</span>
<a href="#l3.520"></a><span id="l3.520" class="difflineminus">-        if alpha and transparent is not None:</span>
<a href="#l3.521"></a><span id="l3.521" class="difflineminus">-            raise ValueError(</span>
<a href="#l3.522"></a><span id="l3.522" class="difflineminus">-                &quot;transparent colour not allowed with alpha channel&quot;)</span>
<a href="#l3.523"></a><span id="l3.523" class="difflineminus">-</span>
<a href="#l3.524"></a><span id="l3.524" class="difflineminus">-        if bytes_per_sample is not None:</span>
<a href="#l3.525"></a><span id="l3.525" class="difflineminus">-            warnings.warn('please use bitdepth instead of bytes_per_sample',</span>
<a href="#l3.526"></a><span id="l3.526" class="difflineminus">-                          DeprecationWarning)</span>
<a href="#l3.527"></a><span id="l3.527" class="difflineminus">-            if bytes_per_sample not in (0.125, 0.25, 0.5, 1, 2):</span>
<a href="#l3.528"></a><span id="l3.528" class="difflineminus">-                raise ValueError(</span>
<a href="#l3.529"></a><span id="l3.529" class="difflineminus">-                    &quot;bytes per sample must be .125, .25, .5, 1, or 2&quot;)</span>
<a href="#l3.530"></a><span id="l3.530" class="difflineminus">-            bitdepth = int(8*bytes_per_sample)</span>
<a href="#l3.531"></a><span id="l3.531" class="difflineminus">-        del bytes_per_sample</span>
<a href="#l3.532"></a><span id="l3.532" class="difflineminus">-        if not isinteger(bitdepth) or bitdepth &lt; 1 or 16 &lt; bitdepth:</span>
<a href="#l3.533"></a><span id="l3.533" class="difflineminus">-            raise ValueError(&quot;bitdepth (%r) must be a positive integer &lt;= 16&quot; %</span>
<a href="#l3.534"></a><span id="l3.534" class="difflineminus">-              bitdepth)</span>
<a href="#l3.535"></a><span id="l3.535" class="difflineminus">-</span>
<a href="#l3.536"></a><span id="l3.536" class="difflineminus">-        self.rescale = None</span>
<a href="#l3.537"></a><span id="l3.537" class="difflineminus">-        if palette:</span>
<a href="#l3.538"></a><span id="l3.538" class="difflineminus">-            if bitdepth not in (1,2,4,8):</span>
<a href="#l3.539"></a><span id="l3.539" class="difflineminus">-                raise ValueError(&quot;with palette, bitdepth must be 1, 2, 4, or 8&quot;)</span>
<a href="#l3.540"></a><span id="l3.540" class="difflineminus">-            if transparent is not None:</span>
<a href="#l3.541"></a><span id="l3.541" class="difflineminus">-                raise ValueError(&quot;transparent and palette not compatible&quot;)</span>
<a href="#l3.542"></a><span id="l3.542" class="difflineminus">-            if alpha:</span>
<a href="#l3.543"></a><span id="l3.543" class="difflineminus">-                raise ValueError(&quot;alpha and palette not compatible&quot;)</span>
<a href="#l3.544"></a><span id="l3.544" class="difflineminus">-            if greyscale:</span>
<a href="#l3.545"></a><span id="l3.545" class="difflineminus">-                raise ValueError(&quot;greyscale and palette not compatible&quot;)</span>
<a href="#l3.546"></a><span id="l3.546" class="difflineminus">-        else:</span>
<a href="#l3.547"></a><span id="l3.547" class="difflineminus">-            # No palette, check for sBIT chunk generation.</span>
<a href="#l3.548"></a><span id="l3.548" class="difflineminus">-            if alpha or not greyscale:</span>
<a href="#l3.549"></a><span id="l3.549" class="difflineminus">-                if bitdepth not in (8,16):</span>
<a href="#l3.550"></a><span id="l3.550" class="difflineminus">-                    targetbitdepth = (8,16)[bitdepth &gt; 8]</span>
<a href="#l3.551"></a><span id="l3.551" class="difflineminus">-                    self.rescale = (bitdepth, targetbitdepth)</span>
<a href="#l3.552"></a><span id="l3.552" class="difflineminus">-                    bitdepth = targetbitdepth</span>
<a href="#l3.553"></a><span id="l3.553" class="difflineminus">-                    del targetbitdepth</span>
<a href="#l3.554"></a><span id="l3.554" class="difflineminus">-            else:</span>
<a href="#l3.555"></a><span id="l3.555" class="difflineminus">-                assert greyscale</span>
<a href="#l3.556"></a><span id="l3.556" class="difflineminus">-                assert not alpha</span>
<a href="#l3.557"></a><span id="l3.557" class="difflineminus">-                if bitdepth not in (1,2,4,8,16):</span>
<a href="#l3.558"></a><span id="l3.558" class="difflineminus">-                    if bitdepth &gt; 8:</span>
<a href="#l3.559"></a><span id="l3.559" class="difflineminus">-                        targetbitdepth = 16</span>
<a href="#l3.560"></a><span id="l3.560" class="difflineminus">-                    elif bitdepth == 3:</span>
<a href="#l3.561"></a><span id="l3.561" class="difflineminus">-                        targetbitdepth = 4</span>
<a href="#l3.562"></a><span id="l3.562" class="difflineminus">-                    else:</span>
<a href="#l3.563"></a><span id="l3.563" class="difflineminus">-                        assert bitdepth in (5,6,7)</span>
<a href="#l3.564"></a><span id="l3.564" class="difflineminus">-                        targetbitdepth = 8</span>
<a href="#l3.565"></a><span id="l3.565" class="difflineminus">-                    self.rescale = (bitdepth, targetbitdepth)</span>
<a href="#l3.566"></a><span id="l3.566" class="difflineminus">-                    bitdepth = targetbitdepth</span>
<a href="#l3.567"></a><span id="l3.567" class="difflineminus">-                    del targetbitdepth</span>
<a href="#l3.568"></a><span id="l3.568" class="difflineminus">-</span>
<a href="#l3.569"></a><span id="l3.569" class="difflineminus">-        if bitdepth &lt; 8 and (alpha or not greyscale and not palette):</span>
<a href="#l3.570"></a><span id="l3.570" class="difflineminus">-            raise ValueError(</span>
<a href="#l3.571"></a><span id="l3.571" class="difflineminus">-              &quot;bitdepth &lt; 8 only permitted with greyscale or palette&quot;)</span>
<a href="#l3.572"></a><span id="l3.572" class="difflineminus">-        if bitdepth &gt; 8 and palette:</span>
<a href="#l3.573"></a><span id="l3.573" class="difflineminus">-            raise ValueError(</span>
<a href="#l3.574"></a><span id="l3.574" class="difflineminus">-                &quot;bit depth must be 8 or less for images with palette&quot;)</span>
<a href="#l3.575"></a><span id="l3.575" class="difflineminus">-</span>
<a href="#l3.576"></a><span id="l3.576" class="difflineminus">-        transparent = check_color(transparent, 'transparent')</span>
<a href="#l3.577"></a><span id="l3.577" class="difflineminus">-        background = check_color(background, 'background')</span>
<a href="#l3.578"></a><span id="l3.578" class="difflineminus">-</span>
<a href="#l3.579"></a><span id="l3.579" class="difflineminus">-        # It's important that the true boolean values (greyscale, alpha,</span>
<a href="#l3.580"></a><span id="l3.580" class="difflineminus">-        # colormap, interlace) are converted to bool because Iverson's</span>
<a href="#l3.581"></a><span id="l3.581" class="difflineminus">-        # convention is relied upon later on.</span>
<a href="#l3.582"></a><span id="l3.582" class="difflineminus">-        self.width = width</span>
<a href="#l3.583"></a><span id="l3.583" class="difflineminus">-        self.height = height</span>
<a href="#l3.584"></a><span id="l3.584" class="difflineminus">-        self.transparent = transparent</span>
<a href="#l3.585"></a><span id="l3.585" class="difflineminus">-        self.background = background</span>
<a href="#l3.586"></a><span id="l3.586" class="difflineminus">-        self.gamma = gamma</span>
<a href="#l3.587"></a><span id="l3.587" class="difflineminus">-        self.greyscale = bool(greyscale)</span>
<a href="#l3.588"></a><span id="l3.588" class="difflineminus">-        self.alpha = bool(alpha)</span>
<a href="#l3.589"></a><span id="l3.589" class="difflineminus">-        self.colormap = bool(palette)</span>
<a href="#l3.590"></a><span id="l3.590" class="difflineminus">-        self.bitdepth = int(bitdepth)</span>
<a href="#l3.591"></a><span id="l3.591" class="difflineminus">-        self.compression = compression</span>
<a href="#l3.592"></a><span id="l3.592" class="difflineminus">-        self.chunk_limit = chunk_limit</span>
<a href="#l3.593"></a><span id="l3.593" class="difflineminus">-        self.interlace = bool(interlace)</span>
<a href="#l3.594"></a><span id="l3.594" class="difflineminus">-        self.palette = check_palette(palette)</span>
<a href="#l3.595"></a><span id="l3.595" class="difflineminus">-</span>
<a href="#l3.596"></a><span id="l3.596" class="difflineminus">-        self.color_type = 4*self.alpha + 2*(not greyscale) + 1*self.colormap</span>
<a href="#l3.597"></a><span id="l3.597" class="difflineminus">-        assert self.color_type in (0,2,3,4,6)</span>
<a href="#l3.598"></a><span id="l3.598" class="difflineminus">-</span>
<a href="#l3.599"></a><span id="l3.599" class="difflineminus">-        self.color_planes = (3,1)[self.greyscale or self.colormap]</span>
<a href="#l3.600"></a><span id="l3.600" class="difflineminus">-        self.planes = self.color_planes + self.alpha</span>
<a href="#l3.601"></a><span id="l3.601" class="difflineminus">-        # :todo: fix for bitdepth &lt; 8</span>
<a href="#l3.602"></a><span id="l3.602" class="difflineminus">-        self.psize = (self.bitdepth/8) * self.planes</span>
<a href="#l3.603"></a><span id="l3.603" class="difflineminus">-</span>
<a href="#l3.604"></a><span id="l3.604" class="difflineminus">-    def make_palette(self):</span>
<a href="#l3.605"></a><span id="l3.605" class="difflineminus">-        &quot;&quot;&quot;Create the byte sequences for a ``PLTE`` and if necessary a</span>
<a href="#l3.606"></a><span id="l3.606" class="difflineminus">-        ``tRNS`` chunk.  Returned as a pair (*p*, *t*).  *t* will be</span>
<a href="#l3.607"></a><span id="l3.607" class="difflineminus">-        ``None`` if no ``tRNS`` chunk is necessary.</span>
<a href="#l3.608"></a><span id="l3.608" class="difflineminus">-        &quot;&quot;&quot;</span>
<a href="#l3.609"></a><span id="l3.609" class="difflineminus">-</span>
<a href="#l3.610"></a><span id="l3.610" class="difflineminus">-        p = array('B')</span>
<a href="#l3.611"></a><span id="l3.611" class="difflineminus">-        t = array('B')</span>
<a href="#l3.612"></a><span id="l3.612" class="difflineminus">-</span>
<a href="#l3.613"></a><span id="l3.613" class="difflineminus">-        for x in self.palette:</span>
<a href="#l3.614"></a><span id="l3.614" class="difflineminus">-            p.extend(x[0:3])</span>
<a href="#l3.615"></a><span id="l3.615" class="difflineminus">-            if len(x) &gt; 3:</span>
<a href="#l3.616"></a><span id="l3.616" class="difflineminus">-                t.append(x[3])</span>
<a href="#l3.617"></a><span id="l3.617" class="difflineminus">-        p = tostring(p)</span>
<a href="#l3.618"></a><span id="l3.618" class="difflineminus">-        t = tostring(t)</span>
<a href="#l3.619"></a><span id="l3.619" class="difflineminus">-        if t:</span>
<a href="#l3.620"></a><span id="l3.620" class="difflineminus">-            return p,t</span>
<a href="#l3.621"></a><span id="l3.621" class="difflineminus">-        return p,None</span>
<a href="#l3.622"></a><span id="l3.622" class="difflineminus">-</span>
<a href="#l3.623"></a><span id="l3.623" class="difflineminus">-    def write(self, outfile, rows):</span>
<a href="#l3.624"></a><span id="l3.624" class="difflineminus">-        &quot;&quot;&quot;Write a PNG image to the output file.  `rows` should be</span>
<a href="#l3.625"></a><span id="l3.625" class="difflineminus">-        an iterable that yields each row in boxed row flat pixel format.</span>
<a href="#l3.626"></a><span id="l3.626" class="difflineminus">-        The rows should be the rows of the original image, so there</span>
<a href="#l3.627"></a><span id="l3.627" class="difflineminus">-        should be ``self.height`` rows of ``self.width * self.planes`` values.</span>
<a href="#l3.628"></a><span id="l3.628" class="difflineminus">-        If `interlace` is specified (when creating the instance), then</span>
<a href="#l3.629"></a><span id="l3.629" class="difflineminus">-        an interlaced PNG file will be written.  Supply the rows in the</span>
<a href="#l3.630"></a><span id="l3.630" class="difflineminus">-        normal image order; the interlacing is carried out internally.</span>
<a href="#l3.631"></a><span id="l3.631" class="difflineminus">-        </span>
<a href="#l3.632"></a><span id="l3.632" class="difflineminus">-        .. note ::</span>
<a href="#l3.633"></a><span id="l3.633" class="difflineminus">-</span>
<a href="#l3.634"></a><span id="l3.634" class="difflineminus">-          Interlacing will require the entire image to be in working memory.</span>
<a href="#l3.635"></a><span id="l3.635" class="difflineminus">-        &quot;&quot;&quot;</span>
<a href="#l3.636"></a><span id="l3.636" class="difflineminus">-</span>
<a href="#l3.637"></a><span id="l3.637" class="difflineminus">-        if self.interlace:</span>
<a href="#l3.638"></a><span id="l3.638" class="difflineminus">-            fmt = 'BH'[self.bitdepth &gt; 8]</span>
<a href="#l3.639"></a><span id="l3.639" class="difflineminus">-            a = array(fmt, itertools.chain(*rows))</span>
<a href="#l3.640"></a><span id="l3.640" class="difflineminus">-            return self.write_array(outfile, a)</span>
<a href="#l3.641"></a><span id="l3.641" class="difflineminus">-        else:</span>
<a href="#l3.642"></a><span id="l3.642" class="difflineminus">-            nrows = self.write_passes(outfile, rows)</span>
<a href="#l3.643"></a><span id="l3.643" class="difflineminus">-            if nrows != self.height:</span>
<a href="#l3.644"></a><span id="l3.644" class="difflineminus">-                raise ValueError(</span>
<a href="#l3.645"></a><span id="l3.645" class="difflineminus">-                  &quot;rows supplied (%d) does not match height (%d)&quot; %</span>
<a href="#l3.646"></a><span id="l3.646" class="difflineminus">-                  (nrows, self.height))</span>
<a href="#l3.647"></a><span id="l3.647" class="difflineminus">-</span>
<a href="#l3.648"></a><span id="l3.648" class="difflineminus">-    def write_passes(self, outfile, rows, packed=False):</span>
<a href="#l3.649"></a><span id="l3.649" class="difflineminus">-        &quot;&quot;&quot;</span>
<a href="#l3.650"></a><span id="l3.650" class="difflineminus">-        Write a PNG image to the output file.</span>
<a href="#l3.651"></a><span id="l3.651" class="difflineminus">-</span>
<a href="#l3.652"></a><span id="l3.652" class="difflineminus">-        Most users are expected to find the :meth:`write` or</span>
<a href="#l3.653"></a><span id="l3.653" class="difflineminus">-        :meth:`write_array` method more convenient.</span>
<a href="#l3.654"></a><span id="l3.654" class="difflineminus">-        </span>
<a href="#l3.655"></a><span id="l3.655" class="difflineminus">-        The rows should be given to this method in the order that</span>
<a href="#l3.656"></a><span id="l3.656" class="difflineminus">-        they appear in the output file.  For straightlaced images,</span>
<a href="#l3.657"></a><span id="l3.657" class="difflineminus">-        this is the usual top to bottom ordering, but for interlaced</span>
<a href="#l3.658"></a><span id="l3.658" class="difflineminus">-        images the rows should have already been interlaced before</span>
<a href="#l3.659"></a><span id="l3.659" class="difflineminus">-        passing them to this function.</span>
<a href="#l3.660"></a><span id="l3.660" class="difflineminus">-</span>
<a href="#l3.661"></a><span id="l3.661" class="difflineminus">-        `rows` should be an iterable that yields each row.  When</span>
<a href="#l3.662"></a><span id="l3.662" class="difflineminus">-        `packed` is ``False`` the rows should be in boxed row flat pixel</span>
<a href="#l3.663"></a><span id="l3.663" class="difflineminus">-        format; when `packed` is ``True`` each row should be a packed</span>
<a href="#l3.664"></a><span id="l3.664" class="difflineminus">-        sequence of bytes.</span>
<a href="#l3.665"></a><span id="l3.665" class="difflineminus">-</span>
<a href="#l3.666"></a><span id="l3.666" class="difflineminus">-        &quot;&quot;&quot;</span>
<a href="#l3.667"></a><span id="l3.667" class="difflineminus">-</span>
<a href="#l3.668"></a><span id="l3.668" class="difflineminus">-        # http://www.w3.org/TR/PNG/#5PNG-file-signature</span>
<a href="#l3.669"></a><span id="l3.669" class="difflineminus">-        outfile.write(_signature)</span>
<a href="#l3.670"></a><span id="l3.670" class="difflineminus">-</span>
<a href="#l3.671"></a><span id="l3.671" class="difflineminus">-        # http://www.w3.org/TR/PNG/#11IHDR</span>
<a href="#l3.672"></a><span id="l3.672" class="difflineminus">-        write_chunk(outfile, 'IHDR',</span>
<a href="#l3.673"></a><span id="l3.673" class="difflineminus">-                    struct.pack(&quot;!2I5B&quot;, self.width, self.height,</span>
<a href="#l3.674"></a><span id="l3.674" class="difflineminus">-                                self.bitdepth, self.color_type,</span>
<a href="#l3.675"></a><span id="l3.675" class="difflineminus">-                                0, 0, self.interlace))</span>
<a href="#l3.676"></a><span id="l3.676" class="difflineminus">-</span>
<a href="#l3.677"></a><span id="l3.677" class="difflineminus">-        # See :chunk:order</span>
<a href="#l3.678"></a><span id="l3.678" class="difflineminus">-        # http://www.w3.org/TR/PNG/#11gAMA</span>
<a href="#l3.679"></a><span id="l3.679" class="difflineminus">-        if self.gamma is not None:</span>
<a href="#l3.680"></a><span id="l3.680" class="difflineminus">-            write_chunk(outfile, 'gAMA',</span>
<a href="#l3.681"></a><span id="l3.681" class="difflineminus">-                        struct.pack(&quot;!L&quot;, int(round(self.gamma*1e5))))</span>
<a href="#l3.682"></a><span id="l3.682" class="difflineminus">-</span>
<a href="#l3.683"></a><span id="l3.683" class="difflineminus">-        # See :chunk:order</span>
<a href="#l3.684"></a><span id="l3.684" class="difflineminus">-        # http://www.w3.org/TR/PNG/#11sBIT</span>
<a href="#l3.685"></a><span id="l3.685" class="difflineminus">-        if self.rescale:</span>
<a href="#l3.686"></a><span id="l3.686" class="difflineminus">-            write_chunk(outfile, 'sBIT',</span>
<a href="#l3.687"></a><span id="l3.687" class="difflineminus">-                struct.pack('%dB' % self.planes,</span>
<a href="#l3.688"></a><span id="l3.688" class="difflineminus">-                            *[self.rescale[0]]*self.planes))</span>
<a href="#l3.689"></a><span id="l3.689" class="difflineminus">-        </span>
<a href="#l3.690"></a><span id="l3.690" class="difflineminus">-        # :chunk:order: Without a palette (PLTE chunk), ordering is</span>
<a href="#l3.691"></a><span id="l3.691" class="difflineminus">-        # relatively relaxed.  With one, gAMA chunk must precede PLTE</span>
<a href="#l3.692"></a><span id="l3.692" class="difflineminus">-        # chunk which must precede tRNS and bKGD.</span>
<a href="#l3.693"></a><span id="l3.693" class="difflineminus">-        # See http://www.w3.org/TR/PNG/#5ChunkOrdering</span>
<a href="#l3.694"></a><span id="l3.694" class="difflineminus">-        if self.palette:</span>
<a href="#l3.695"></a><span id="l3.695" class="difflineminus">-            p,t = self.make_palette()</span>
<a href="#l3.696"></a><span id="l3.696" class="difflineminus">-            write_chunk(outfile, 'PLTE', p)</span>
<a href="#l3.697"></a><span id="l3.697" class="difflineminus">-            if t:</span>
<a href="#l3.698"></a><span id="l3.698" class="difflineminus">-                # tRNS chunk is optional.  Only needed if palette entries</span>
<a href="#l3.699"></a><span id="l3.699" class="difflineminus">-                # have alpha.</span>
<a href="#l3.700"></a><span id="l3.700" class="difflineminus">-                write_chunk(outfile, 'tRNS', t)</span>
<a href="#l3.701"></a><span id="l3.701" class="difflineminus">-</span>
<a href="#l3.702"></a><span id="l3.702" class="difflineminus">-        # http://www.w3.org/TR/PNG/#11tRNS</span>
<a href="#l3.703"></a><span id="l3.703" class="difflineminus">-        if self.transparent is not None:</span>
<a href="#l3.704"></a><span id="l3.704" class="difflineminus">-            if self.greyscale:</span>
<a href="#l3.705"></a><span id="l3.705" class="difflineminus">-                write_chunk(outfile, 'tRNS',</span>
<a href="#l3.706"></a><span id="l3.706" class="difflineminus">-                            struct.pack(&quot;!1H&quot;, *self.transparent))</span>
<a href="#l3.707"></a><span id="l3.707" class="difflineminus">-            else:</span>
<a href="#l3.708"></a><span id="l3.708" class="difflineminus">-                write_chunk(outfile, 'tRNS',</span>
<a href="#l3.709"></a><span id="l3.709" class="difflineminus">-                            struct.pack(&quot;!3H&quot;, *self.transparent))</span>
<a href="#l3.710"></a><span id="l3.710" class="difflineminus">-</span>
<a href="#l3.711"></a><span id="l3.711" class="difflineminus">-        # http://www.w3.org/TR/PNG/#11bKGD</span>
<a href="#l3.712"></a><span id="l3.712" class="difflineminus">-        if self.background is not None:</span>
<a href="#l3.713"></a><span id="l3.713" class="difflineminus">-            if self.greyscale:</span>
<a href="#l3.714"></a><span id="l3.714" class="difflineminus">-                write_chunk(outfile, 'bKGD',</span>
<a href="#l3.715"></a><span id="l3.715" class="difflineminus">-                            struct.pack(&quot;!1H&quot;, *self.background))</span>
<a href="#l3.716"></a><span id="l3.716" class="difflineminus">-            else:</span>
<a href="#l3.717"></a><span id="l3.717" class="difflineminus">-                write_chunk(outfile, 'bKGD',</span>
<a href="#l3.718"></a><span id="l3.718" class="difflineminus">-                            struct.pack(&quot;!3H&quot;, *self.background))</span>
<a href="#l3.719"></a><span id="l3.719" class="difflineminus">-</span>
<a href="#l3.720"></a><span id="l3.720" class="difflineminus">-        # http://www.w3.org/TR/PNG/#11IDAT</span>
<a href="#l3.721"></a><span id="l3.721" class="difflineminus">-        if self.compression is not None:</span>
<a href="#l3.722"></a><span id="l3.722" class="difflineminus">-            compressor = zlib.compressobj(self.compression)</span>
<a href="#l3.723"></a><span id="l3.723" class="difflineminus">-        else:</span>
<a href="#l3.724"></a><span id="l3.724" class="difflineminus">-            compressor = zlib.compressobj()</span>
<a href="#l3.725"></a><span id="l3.725" class="difflineminus">-</span>
<a href="#l3.726"></a><span id="l3.726" class="difflineminus">-        # Choose an extend function based on the bitdepth.  The extend</span>
<a href="#l3.727"></a><span id="l3.727" class="difflineminus">-        # function packs/decomposes the pixel values into bytes and</span>
<a href="#l3.728"></a><span id="l3.728" class="difflineminus">-        # stuffs them onto the data array.</span>
<a href="#l3.729"></a><span id="l3.729" class="difflineminus">-        data = array('B')</span>
<a href="#l3.730"></a><span id="l3.730" class="difflineminus">-        if self.bitdepth == 8 or packed:</span>
<a href="#l3.731"></a><span id="l3.731" class="difflineminus">-            extend = data.extend</span>
<a href="#l3.732"></a><span id="l3.732" class="difflineminus">-        elif self.bitdepth == 16:</span>
<a href="#l3.733"></a><span id="l3.733" class="difflineminus">-            # Decompose into bytes</span>
<a href="#l3.734"></a><span id="l3.734" class="difflineminus">-            def extend(sl):</span>
<a href="#l3.735"></a><span id="l3.735" class="difflineminus">-                fmt = '!%dH' % len(sl)</span>
<a href="#l3.736"></a><span id="l3.736" class="difflineminus">-                data.extend(array('B', struct.pack(fmt, *sl)))</span>
<a href="#l3.737"></a><span id="l3.737" class="difflineminus">-        else:</span>
<a href="#l3.738"></a><span id="l3.738" class="difflineminus">-            # Pack into bytes</span>
<a href="#l3.739"></a><span id="l3.739" class="difflineminus">-            assert self.bitdepth &lt; 8</span>
<a href="#l3.740"></a><span id="l3.740" class="difflineminus">-            # samples per byte</span>
<a href="#l3.741"></a><span id="l3.741" class="difflineminus">-            spb = int(8/self.bitdepth)</span>
<a href="#l3.742"></a><span id="l3.742" class="difflineminus">-            def extend(sl):</span>
<a href="#l3.743"></a><span id="l3.743" class="difflineminus">-                a = array('B', sl)</span>
<a href="#l3.744"></a><span id="l3.744" class="difflineminus">-                # Adding padding bytes so we can group into a whole</span>
<a href="#l3.745"></a><span id="l3.745" class="difflineminus">-                # number of spb-tuples.</span>
<a href="#l3.746"></a><span id="l3.746" class="difflineminus">-                l = float(len(a))</span>
<a href="#l3.747"></a><span id="l3.747" class="difflineminus">-                extra = math.ceil(l / float(spb))*spb - l</span>
<a href="#l3.748"></a><span id="l3.748" class="difflineminus">-                a.extend([0]*int(extra))</span>
<a href="#l3.749"></a><span id="l3.749" class="difflineminus">-                # Pack into bytes</span>
<a href="#l3.750"></a><span id="l3.750" class="difflineminus">-                l = group(a, spb)</span>
<a href="#l3.751"></a><span id="l3.751" class="difflineminus">-                l = map(lambda e: reduce(lambda x,y:</span>
<a href="#l3.752"></a><span id="l3.752" class="difflineminus">-                                           (x &lt;&lt; self.bitdepth) + y, e), l)</span>
<a href="#l3.753"></a><span id="l3.753" class="difflineminus">-                data.extend(l)</span>
<a href="#l3.754"></a><span id="l3.754" class="difflineminus">-        if self.rescale:</span>
<a href="#l3.755"></a><span id="l3.755" class="difflineminus">-            oldextend = extend</span>
<a href="#l3.756"></a><span id="l3.756" class="difflineminus">-            factor = \</span>
<a href="#l3.757"></a><span id="l3.757" class="difflineminus">-              float(2**self.rescale[1]-1) / float(2**self.rescale[0]-1)</span>
<a href="#l3.758"></a><span id="l3.758" class="difflineminus">-            def extend(sl):</span>
<a href="#l3.759"></a><span id="l3.759" class="difflineminus">-                oldextend(map(lambda x: int(round(factor*x)), sl))</span>
<a href="#l3.760"></a><span id="l3.760" class="difflineminus">-</span>
<a href="#l3.761"></a><span id="l3.761" class="difflineminus">-        # Build the first row, testing mostly to see if we need to</span>
<a href="#l3.762"></a><span id="l3.762" class="difflineminus">-        # changed the extend function to cope with NumPy integer types</span>
<a href="#l3.763"></a><span id="l3.763" class="difflineminus">-        # (they cause our ordinary definition of extend to fail, so we</span>
<a href="#l3.764"></a><span id="l3.764" class="difflineminus">-        # wrap it).  See</span>
<a href="#l3.765"></a><span id="l3.765" class="difflineminus">-        # http://code.google.com/p/pypng/issues/detail?id=44</span>
<a href="#l3.766"></a><span id="l3.766" class="difflineminus">-        enumrows = enumerate(rows)</span>
<a href="#l3.767"></a><span id="l3.767" class="difflineminus">-        del rows</span>
<a href="#l3.768"></a><span id="l3.768" class="difflineminus">-</span>
<a href="#l3.769"></a><span id="l3.769" class="difflineminus">-        # First row's filter type.</span>
<a href="#l3.770"></a><span id="l3.770" class="difflineminus">-        data.append(0)</span>
<a href="#l3.771"></a><span id="l3.771" class="difflineminus">-        # :todo: Certain exceptions in the call to ``.next()`` or the</span>
<a href="#l3.772"></a><span id="l3.772" class="difflineminus">-        # following try would indicate no row data supplied.</span>
<a href="#l3.773"></a><span id="l3.773" class="difflineminus">-        # Should catch.</span>
<a href="#l3.774"></a><span id="l3.774" class="difflineminus">-        i,row = enumrows.next()</span>
<a href="#l3.775"></a><span id="l3.775" class="difflineminus">-        try:</span>
<a href="#l3.776"></a><span id="l3.776" class="difflineminus">-            # If this fails...</span>
<a href="#l3.777"></a><span id="l3.777" class="difflineminus">-            extend(row)</span>
<a href="#l3.778"></a><span id="l3.778" class="difflineminus">-        except:</span>
<a href="#l3.779"></a><span id="l3.779" class="difflineminus">-            # ... try a version that converts the values to int first.</span>
<a href="#l3.780"></a><span id="l3.780" class="difflineminus">-            # Not only does this work for the (slightly broken) NumPy</span>
<a href="#l3.781"></a><span id="l3.781" class="difflineminus">-            # types, there are probably lots of other, unknown, &quot;nearly&quot;</span>
<a href="#l3.782"></a><span id="l3.782" class="difflineminus">-            # int types it works for.</span>
<a href="#l3.783"></a><span id="l3.783" class="difflineminus">-            def wrapmapint(f):</span>
<a href="#l3.784"></a><span id="l3.784" class="difflineminus">-                return lambda sl: f(map(int, sl))</span>
<a href="#l3.785"></a><span id="l3.785" class="difflineminus">-            extend = wrapmapint(extend)</span>
<a href="#l3.786"></a><span id="l3.786" class="difflineminus">-            del wrapmapint</span>
<a href="#l3.787"></a><span id="l3.787" class="difflineminus">-            extend(row)</span>
<a href="#l3.788"></a><span id="l3.788" class="difflineminus">-</span>
<a href="#l3.789"></a><span id="l3.789" class="difflineminus">-        for i,row in enumrows:</span>
<a href="#l3.790"></a><span id="l3.790" class="difflineminus">-            # Add &quot;None&quot; filter type.  Currently, it's essential that</span>
<a href="#l3.791"></a><span id="l3.791" class="difflineminus">-            # this filter type be used for every scanline as we do not</span>
<a href="#l3.792"></a><span id="l3.792" class="difflineminus">-            # mark the first row of a reduced pass image; that means we</span>
<a href="#l3.793"></a><span id="l3.793" class="difflineminus">-            # could accidentally compute the wrong filtered scanline if</span>
<a href="#l3.794"></a><span id="l3.794" class="difflineminus">-            # we used &quot;up&quot;, &quot;average&quot;, or &quot;paeth&quot; on such a line.</span>
<a href="#l3.795"></a><span id="l3.795" class="difflineminus">-            data.append(0)</span>
<a href="#l3.796"></a><span id="l3.796" class="difflineminus">-            extend(row)</span>
<a href="#l3.797"></a><span id="l3.797" class="difflineminus">-            if len(data) &gt; self.chunk_limit:</span>
<a href="#l3.798"></a><span id="l3.798" class="difflineminus">-                compressed = compressor.compress(tostring(data))</span>
<a href="#l3.799"></a><span id="l3.799" class="difflineminus">-                if len(compressed):</span>
<a href="#l3.800"></a><span id="l3.800" class="difflineminus">-                    # print &gt;&gt; sys.stderr, len(data), len(compressed)</span>
<a href="#l3.801"></a><span id="l3.801" class="difflineminus">-                    write_chunk(outfile, 'IDAT', compressed)</span>
<a href="#l3.802"></a><span id="l3.802" class="difflineminus">-                # Because of our very witty definition of ``extend``,</span>
<a href="#l3.803"></a><span id="l3.803" class="difflineminus">-                # above, we must re-use the same ``data`` object.  Hence</span>
<a href="#l3.804"></a><span id="l3.804" class="difflineminus">-                # we use ``del`` to empty this one, rather than create a</span>
<a href="#l3.805"></a><span id="l3.805" class="difflineminus">-                # fresh one (which would be my natural FP instinct).</span>
<a href="#l3.806"></a><span id="l3.806" class="difflineminus">-                del data[:]</span>
<a href="#l3.807"></a><span id="l3.807" class="difflineminus">-        if len(data):</span>
<a href="#l3.808"></a><span id="l3.808" class="difflineminus">-            compressed = compressor.compress(tostring(data))</span>
<a href="#l3.809"></a><span id="l3.809" class="difflineminus">-        else:</span>
<a href="#l3.810"></a><span id="l3.810" class="difflineminus">-            compressed = ''</span>
<a href="#l3.811"></a><span id="l3.811" class="difflineminus">-        flushed = compressor.flush()</span>
<a href="#l3.812"></a><span id="l3.812" class="difflineminus">-        if len(compressed) or len(flushed):</span>
<a href="#l3.813"></a><span id="l3.813" class="difflineminus">-            # print &gt;&gt; sys.stderr, len(data), len(compressed), len(flushed)</span>
<a href="#l3.814"></a><span id="l3.814" class="difflineminus">-            write_chunk(outfile, 'IDAT', compressed + flushed)</span>
<a href="#l3.815"></a><span id="l3.815" class="difflineminus">-        # http://www.w3.org/TR/PNG/#11IEND</span>
<a href="#l3.816"></a><span id="l3.816" class="difflineminus">-        write_chunk(outfile, 'IEND')</span>
<a href="#l3.817"></a><span id="l3.817" class="difflineminus">-        return i+1</span>
<a href="#l3.818"></a><span id="l3.818" class="difflineminus">-</span>
<a href="#l3.819"></a><span id="l3.819" class="difflineminus">-    def write_array(self, outfile, pixels):</span>
<a href="#l3.820"></a><span id="l3.820" class="difflineminus">-        &quot;&quot;&quot;</span>
<a href="#l3.821"></a><span id="l3.821" class="difflineminus">-        Write an array in flat row flat pixel format as a PNG file on</span>
<a href="#l3.822"></a><span id="l3.822" class="difflineminus">-        the output file.  See also :meth:`write` method.</span>
<a href="#l3.823"></a><span id="l3.823" class="difflineminus">-        &quot;&quot;&quot;</span>
<a href="#l3.824"></a><span id="l3.824" class="difflineminus">-</span>
<a href="#l3.825"></a><span id="l3.825" class="difflineminus">-        if self.interlace:</span>
<a href="#l3.826"></a><span id="l3.826" class="difflineminus">-            self.write_passes(outfile, self.array_scanlines_interlace(pixels))</span>
<a href="#l3.827"></a><span id="l3.827" class="difflineminus">-        else:</span>
<a href="#l3.828"></a><span id="l3.828" class="difflineminus">-            self.write_passes(outfile, self.array_scanlines(pixels))</span>
<a href="#l3.829"></a><span id="l3.829" class="difflineminus">-</span>
<a href="#l3.830"></a><span id="l3.830" class="difflineminus">-    def write_packed(self, outfile, rows):</span>
<a href="#l3.831"></a><span id="l3.831" class="difflineminus">-        &quot;&quot;&quot;</span>
<a href="#l3.832"></a><span id="l3.832" class="difflineminus">-        Write PNG file to `outfile`.  The pixel data comes from `rows`</span>
<a href="#l3.833"></a><span id="l3.833" class="difflineminus">-        which should be in boxed row packed format.  Each row should be</span>
<a href="#l3.834"></a><span id="l3.834" class="difflineminus">-        a sequence of packed bytes.</span>
<a href="#l3.835"></a><span id="l3.835" class="difflineminus">-</span>
<a href="#l3.836"></a><span id="l3.836" class="difflineminus">-        Technically, this method does work for interlaced images but it</span>
<a href="#l3.837"></a><span id="l3.837" class="difflineminus">-        is best avoided.  For interlaced images, the rows should be</span>
<a href="#l3.838"></a><span id="l3.838" class="difflineminus">-        presented in the order that they appear in the file.</span>
<a href="#l3.839"></a><span id="l3.839" class="difflineminus">-</span>
<a href="#l3.840"></a><span id="l3.840" class="difflineminus">-        This method should not be used when the source image bit depth</span>
<a href="#l3.841"></a><span id="l3.841" class="difflineminus">-        is not one naturally supported by PNG; the bit depth should be</span>
<a href="#l3.842"></a><span id="l3.842" class="difflineminus">-        1, 2, 4, 8, or 16.</span>
<a href="#l3.843"></a><span id="l3.843" class="difflineminus">-        &quot;&quot;&quot;</span>
<a href="#l3.844"></a><span id="l3.844" class="difflineminus">-</span>
<a href="#l3.845"></a><span id="l3.845" class="difflineminus">-        if self.rescale:</span>
<a href="#l3.846"></a><span id="l3.846" class="difflineminus">-            raise Error(&quot;write_packed method not suitable for bit depth %d&quot; %</span>
<a href="#l3.847"></a><span id="l3.847" class="difflineminus">-              self.rescale[0])</span>
<a href="#l3.848"></a><span id="l3.848" class="difflineminus">-        return self.write_passes(outfile, rows, packed=True)</span>
<a href="#l3.849"></a><span id="l3.849" class="difflineminus">-</span>
<a href="#l3.850"></a><span id="l3.850" class="difflineminus">-    def convert_pnm(self, infile, outfile):</span>
<a href="#l3.851"></a><span id="l3.851" class="difflineminus">-        &quot;&quot;&quot;</span>
<a href="#l3.852"></a><span id="l3.852" class="difflineminus">-        Convert a PNM file containing raw pixel data into a PNG file</span>
<a href="#l3.853"></a><span id="l3.853" class="difflineminus">-        with the parameters set in the writer object.  Works for</span>
<a href="#l3.854"></a><span id="l3.854" class="difflineminus">-        (binary) PGM, PPM, and PAM formats.</span>
<a href="#l3.855"></a><span id="l3.855" class="difflineminus">-        &quot;&quot;&quot;</span>
<a href="#l3.856"></a><span id="l3.856" class="difflineminus">-</span>
<a href="#l3.857"></a><span id="l3.857" class="difflineminus">-        if self.interlace:</span>
<a href="#l3.858"></a><span id="l3.858" class="difflineminus">-            pixels = array('B')</span>
<a href="#l3.859"></a><span id="l3.859" class="difflineminus">-            pixels.fromfile(infile,</span>
<a href="#l3.860"></a><span id="l3.860" class="difflineminus">-                            (self.bitdepth/8) * self.color_planes *</span>
<a href="#l3.861"></a><span id="l3.861" class="difflineminus">-                            self.width * self.height)</span>
<a href="#l3.862"></a><span id="l3.862" class="difflineminus">-            self.write_passes(outfile, self.array_scanlines_interlace(pixels))</span>
<a href="#l3.863"></a><span id="l3.863" class="difflineminus">-        else:</span>
<a href="#l3.864"></a><span id="l3.864" class="difflineminus">-            self.write_passes(outfile, self.file_scanlines(infile))</span>
<a href="#l3.865"></a><span id="l3.865" class="difflineminus">-</span>
<a href="#l3.866"></a><span id="l3.866" class="difflineminus">-    def convert_ppm_and_pgm(self, ppmfile, pgmfile, outfile):</span>
<a href="#l3.867"></a><span id="l3.867" class="difflineminus">-        &quot;&quot;&quot;</span>
<a href="#l3.868"></a><span id="l3.868" class="difflineminus">-        Convert a PPM and PGM file containing raw pixel data into a</span>
<a href="#l3.869"></a><span id="l3.869" class="difflineminus">-        PNG outfile with the parameters set in the writer object.</span>
<a href="#l3.870"></a><span id="l3.870" class="difflineminus">-        &quot;&quot;&quot;</span>
<a href="#l3.871"></a><span id="l3.871" class="difflineminus">-        pixels = array('B')</span>
<a href="#l3.872"></a><span id="l3.872" class="difflineminus">-        pixels.fromfile(ppmfile,</span>
<a href="#l3.873"></a><span id="l3.873" class="difflineminus">-                        (self.bitdepth/8) * self.color_planes *</span>
<a href="#l3.874"></a><span id="l3.874" class="difflineminus">-                        self.width * self.height)</span>
<a href="#l3.875"></a><span id="l3.875" class="difflineminus">-        apixels = array('B')</span>
<a href="#l3.876"></a><span id="l3.876" class="difflineminus">-        apixels.fromfile(pgmfile,</span>
<a href="#l3.877"></a><span id="l3.877" class="difflineminus">-                         (self.bitdepth/8) *</span>
<a href="#l3.878"></a><span id="l3.878" class="difflineminus">-                         self.width * self.height)</span>
<a href="#l3.879"></a><span id="l3.879" class="difflineminus">-        pixels = interleave_planes(pixels, apixels,</span>
<a href="#l3.880"></a><span id="l3.880" class="difflineminus">-                                   (self.bitdepth/8) * self.color_planes,</span>
<a href="#l3.881"></a><span id="l3.881" class="difflineminus">-                                   (self.bitdepth/8))</span>
<a href="#l3.882"></a><span id="l3.882" class="difflineminus">-        if self.interlace:</span>
<a href="#l3.883"></a><span id="l3.883" class="difflineminus">-            self.write_passes(outfile, self.array_scanlines_interlace(pixels))</span>
<a href="#l3.884"></a><span id="l3.884" class="difflineminus">-        else:</span>
<a href="#l3.885"></a><span id="l3.885" class="difflineminus">-            self.write_passes(outfile, self.array_scanlines(pixels))</span>
<a href="#l3.886"></a><span id="l3.886" class="difflineminus">-</span>
<a href="#l3.887"></a><span id="l3.887" class="difflineminus">-    def file_scanlines(self, infile):</span>
<a href="#l3.888"></a><span id="l3.888" class="difflineminus">-        &quot;&quot;&quot;</span>
<a href="#l3.889"></a><span id="l3.889" class="difflineminus">-        Generates boxed rows in flat pixel format, from the input file</span>
<a href="#l3.890"></a><span id="l3.890" class="difflineminus">-        `infile`.  It assumes that the input file is in a &quot;Netpbm-like&quot;</span>
<a href="#l3.891"></a><span id="l3.891" class="difflineminus">-        binary format, and is positioned at the beginning of the first</span>
<a href="#l3.892"></a><span id="l3.892" class="difflineminus">-        pixel.  The number of pixels to read is taken from the image</span>
<a href="#l3.893"></a><span id="l3.893" class="difflineminus">-        dimensions (`width`, `height`, `planes`) and the number of bytes</span>
<a href="#l3.894"></a><span id="l3.894" class="difflineminus">-        per value is implied by the image `bitdepth`.</span>
<a href="#l3.895"></a><span id="l3.895" class="difflineminus">-        &quot;&quot;&quot;</span>
<a href="#l3.896"></a><span id="l3.896" class="difflineminus">-</span>
<a href="#l3.897"></a><span id="l3.897" class="difflineminus">-        # Values per row</span>
<a href="#l3.898"></a><span id="l3.898" class="difflineminus">-        vpr = self.width * self.planes</span>
<a href="#l3.899"></a><span id="l3.899" class="difflineminus">-        row_bytes = vpr</span>
<a href="#l3.900"></a><span id="l3.900" class="difflineminus">-        if self.bitdepth &gt; 8:</span>
<a href="#l3.901"></a><span id="l3.901" class="difflineminus">-            assert self.bitdepth == 16</span>
<a href="#l3.902"></a><span id="l3.902" class="difflineminus">-            row_bytes *= 2</span>
<a href="#l3.903"></a><span id="l3.903" class="difflineminus">-            fmt = '&gt;%dH' % vpr</span>
<a href="#l3.904"></a><span id="l3.904" class="difflineminus">-            def line():</span>
<a href="#l3.905"></a><span id="l3.905" class="difflineminus">-                return array('H', struct.unpack(fmt, infile.read(row_bytes)))</span>
<a href="#l3.906"></a><span id="l3.906" class="difflineminus">-        else:</span>
<a href="#l3.907"></a><span id="l3.907" class="difflineminus">-            def line():</span>
<a href="#l3.908"></a><span id="l3.908" class="difflineminus">-                scanline = array('B', infile.read(row_bytes))</span>
<a href="#l3.909"></a><span id="l3.909" class="difflineminus">-                return scanline</span>
<a href="#l3.910"></a><span id="l3.910" class="difflineminus">-        for y in range(self.height):</span>
<a href="#l3.911"></a><span id="l3.911" class="difflineminus">-            yield line()</span>
<a href="#l3.912"></a><span id="l3.912" class="difflineminus">-</span>
<a href="#l3.913"></a><span id="l3.913" class="difflineminus">-    def array_scanlines(self, pixels):</span>
<a href="#l3.914"></a><span id="l3.914" class="difflineminus">-        &quot;&quot;&quot;</span>
<a href="#l3.915"></a><span id="l3.915" class="difflineminus">-        Generates boxed rows (flat pixels) from flat rows (flat pixels)</span>
<a href="#l3.916"></a><span id="l3.916" class="difflineminus">-        in an array.</span>
<a href="#l3.917"></a><span id="l3.917" class="difflineminus">-        &quot;&quot;&quot;</span>
<a href="#l3.918"></a><span id="l3.918" class="difflineminus">-</span>
<a href="#l3.919"></a><span id="l3.919" class="difflineminus">-        # Values per row</span>
<a href="#l3.920"></a><span id="l3.920" class="difflineminus">-        vpr = self.width * self.planes</span>
<a href="#l3.921"></a><span id="l3.921" class="difflineminus">-        stop = 0</span>
<a href="#l3.922"></a><span id="l3.922" class="difflineminus">-        for y in range(self.height):</span>
<a href="#l3.923"></a><span id="l3.923" class="difflineminus">-            start = stop</span>
<a href="#l3.924"></a><span id="l3.924" class="difflineminus">-            stop = start + vpr</span>
<a href="#l3.925"></a><span id="l3.925" class="difflineminus">-            yield pixels[start:stop]</span>
<a href="#l3.926"></a><span id="l3.926" class="difflineminus">-</span>
<a href="#l3.927"></a><span id="l3.927" class="difflineminus">-    def array_scanlines_interlace(self, pixels):</span>
<a href="#l3.928"></a><span id="l3.928" class="difflineminus">-        &quot;&quot;&quot;</span>
<a href="#l3.929"></a><span id="l3.929" class="difflineminus">-        Generator for interlaced scanlines from an array.  `pixels` is</span>
<a href="#l3.930"></a><span id="l3.930" class="difflineminus">-        the full source image in flat row flat pixel format.  The</span>
<a href="#l3.931"></a><span id="l3.931" class="difflineminus">-        generator yields each scanline of the reduced passes in turn, in</span>
<a href="#l3.932"></a><span id="l3.932" class="difflineminus">-        boxed row flat pixel format.</span>
<a href="#l3.933"></a><span id="l3.933" class="difflineminus">-        &quot;&quot;&quot;</span>
<a href="#l3.934"></a><span id="l3.934" class="difflineminus">-</span>
<a href="#l3.935"></a><span id="l3.935" class="difflineminus">-        # http://www.w3.org/TR/PNG/#8InterlaceMethods</span>
<a href="#l3.936"></a><span id="l3.936" class="difflineminus">-        # Array type.</span>
<a href="#l3.937"></a><span id="l3.937" class="difflineminus">-        fmt = 'BH'[self.bitdepth &gt; 8]</span>
<a href="#l3.938"></a><span id="l3.938" class="difflineminus">-        # Value per row</span>
<a href="#l3.939"></a><span id="l3.939" class="difflineminus">-        vpr = self.width * self.planes</span>
<a href="#l3.940"></a><span id="l3.940" class="difflineminus">-        for xstart, ystart, xstep, ystep in _adam7:</span>
<a href="#l3.941"></a><span id="l3.941" class="difflineminus">-            if xstart &gt;= self.width:</span>
<a href="#l3.942"></a><span id="l3.942" class="difflineminus">-                continue</span>
<a href="#l3.943"></a><span id="l3.943" class="difflineminus">-            # Pixels per row (of reduced image)</span>
<a href="#l3.944"></a><span id="l3.944" class="difflineminus">-            ppr = int(math.ceil((self.width-xstart)/float(xstep)))</span>
<a href="#l3.945"></a><span id="l3.945" class="difflineminus">-            # number of values in reduced image row.</span>
<a href="#l3.946"></a><span id="l3.946" class="difflineminus">-            row_len = ppr*self.planes</span>
<a href="#l3.947"></a><span id="l3.947" class="difflineminus">-            for y in range(ystart, self.height, ystep):</span>
<a href="#l3.948"></a><span id="l3.948" class="difflineminus">-                if xstep == 1:</span>
<a href="#l3.949"></a><span id="l3.949" class="difflineminus">-                    offset = y * vpr</span>
<a href="#l3.950"></a><span id="l3.950" class="difflineminus">-                    yield pixels[offset:offset+vpr]</span>
<a href="#l3.951"></a><span id="l3.951" class="difflineminus">-                else:</span>
<a href="#l3.952"></a><span id="l3.952" class="difflineminus">-                    row = array(fmt)</span>
<a href="#l3.953"></a><span id="l3.953" class="difflineminus">-                    # There's no easier way to set the length of an array</span>
<a href="#l3.954"></a><span id="l3.954" class="difflineminus">-                    row.extend(pixels[0:row_len])</span>
<a href="#l3.955"></a><span id="l3.955" class="difflineminus">-                    offset = y * vpr + xstart * self.planes</span>
<a href="#l3.956"></a><span id="l3.956" class="difflineminus">-                    end_offset = (y+1) * vpr</span>
<a href="#l3.957"></a><span id="l3.957" class="difflineminus">-                    skip = self.planes * xstep</span>
<a href="#l3.958"></a><span id="l3.958" class="difflineminus">-                    for i in range(self.planes):</span>
<a href="#l3.959"></a><span id="l3.959" class="difflineminus">-                        row[i::self.planes] = \</span>
<a href="#l3.960"></a><span id="l3.960" class="difflineminus">-                            pixels[offset+i:end_offset:skip]</span>
<a href="#l3.961"></a><span id="l3.961" class="difflineminus">-                    yield row</span>
<a href="#l3.962"></a><span id="l3.962" class="difflineminus">-</span>
<a href="#l3.963"></a><span id="l3.963" class="difflineminus">-def write_chunk(outfile, tag, data=strtobytes('')):</span>
<a href="#l3.964"></a><span id="l3.964" class="difflineminus">-    &quot;&quot;&quot;</span>
<a href="#l3.965"></a><span id="l3.965" class="difflineminus">-    Write a PNG chunk to the output file, including length and</span>
<a href="#l3.966"></a><span id="l3.966" class="difflineminus">-    checksum.</span>
<a href="#l3.967"></a><span id="l3.967" class="difflineminus">-    &quot;&quot;&quot;</span>
<a href="#l3.968"></a><span id="l3.968" class="difflineminus">-</span>
<a href="#l3.969"></a><span id="l3.969" class="difflineminus">-    # http://www.w3.org/TR/PNG/#5Chunk-layout</span>
<a href="#l3.970"></a><span id="l3.970" class="difflineminus">-    outfile.write(struct.pack(&quot;!I&quot;, len(data)))</span>
<a href="#l3.971"></a><span id="l3.971" class="difflineminus">-    tag = strtobytes(tag)</span>
<a href="#l3.972"></a><span id="l3.972" class="difflineminus">-    outfile.write(tag)</span>
<a href="#l3.973"></a><span id="l3.973" class="difflineminus">-    outfile.write(data)</span>
<a href="#l3.974"></a><span id="l3.974" class="difflineminus">-    checksum = zlib.crc32(tag)</span>
<a href="#l3.975"></a><span id="l3.975" class="difflineminus">-    checksum = zlib.crc32(data, checksum)</span>
<a href="#l3.976"></a><span id="l3.976" class="difflineminus">-    checksum &amp;= 2**32-1</span>
<a href="#l3.977"></a><span id="l3.977" class="difflineminus">-    outfile.write(struct.pack(&quot;!I&quot;, checksum))</span>
<a href="#l3.978"></a><span id="l3.978" class="difflineminus">-</span>
<a href="#l3.979"></a><span id="l3.979" class="difflineminus">-def write_chunks(out, chunks):</span>
<a href="#l3.980"></a><span id="l3.980" class="difflineminus">-    &quot;&quot;&quot;Create a PNG file by writing out the chunks.&quot;&quot;&quot;</span>
<a href="#l3.981"></a><span id="l3.981" class="difflineminus">-</span>
<a href="#l3.982"></a><span id="l3.982" class="difflineminus">-    out.write(_signature)</span>
<a href="#l3.983"></a><span id="l3.983" class="difflineminus">-    for chunk in chunks:</span>
<a href="#l3.984"></a><span id="l3.984" class="difflineminus">-        write_chunk(out, *chunk)</span>
<a href="#l3.985"></a><span id="l3.985" class="difflineminus">-</span>
<a href="#l3.986"></a><span id="l3.986" class="difflineminus">-def filter_scanline(type, line, fo, prev=None):</span>
<a href="#l3.987"></a><span id="l3.987" class="difflineminus">-    &quot;&quot;&quot;Apply a scanline filter to a scanline.  `type` specifies the</span>
<a href="#l3.988"></a><span id="l3.988" class="difflineminus">-    filter type (0 to 4); `line` specifies the current (unfiltered)</span>
<a href="#l3.989"></a><span id="l3.989" class="difflineminus">-    scanline as a sequence of bytes; `prev` specifies the previous</span>
<a href="#l3.990"></a><span id="l3.990" class="difflineminus">-    (unfiltered) scanline as a sequence of bytes. `fo` specifies the</span>
<a href="#l3.991"></a><span id="l3.991" class="difflineminus">-    filter offset; normally this is size of a pixel in bytes (the number</span>
<a href="#l3.992"></a><span id="l3.992" class="difflineminus">-    of bytes per sample times the number of channels), but when this is</span>
<a href="#l3.993"></a><span id="l3.993" class="difflineminus">-    &lt; 1 (for bit depths &lt; 8) then the filter offset is 1.</span>
<a href="#l3.994"></a><span id="l3.994" class="difflineminus">-    &quot;&quot;&quot;</span>
<a href="#l3.995"></a><span id="l3.995" class="difflineminus">-</span>
<a href="#l3.996"></a><span id="l3.996" class="difflineminus">-    assert 0 &lt;= type &lt; 5</span>
<a href="#l3.997"></a><span id="l3.997" class="difflineminus">-</span>
<a href="#l3.998"></a><span id="l3.998" class="difflineminus">-    # The output array.  Which, pathetically, we extend one-byte at a</span>
<a href="#l3.999"></a><span id="l3.999" class="difflineminus">-    # time (fortunately this is linear).</span>
<a href="#l3.1000"></a><span id="l3.1000" class="difflineminus">-    out = array('B', [type])</span>
<a href="#l3.1001"></a><span id="l3.1001" class="difflineminus">-</span>
<a href="#l3.1002"></a><span id="l3.1002" class="difflineminus">-    def sub():</span>
<a href="#l3.1003"></a><span id="l3.1003" class="difflineminus">-        ai = -fo</span>
<a href="#l3.1004"></a><span id="l3.1004" class="difflineminus">-        for x in line:</span>
<a href="#l3.1005"></a><span id="l3.1005" class="difflineminus">-            if ai &gt;= 0:</span>
<a href="#l3.1006"></a><span id="l3.1006" class="difflineminus">-                x = (x - line[ai]) &amp; 0xff</span>
<a href="#l3.1007"></a><span id="l3.1007" class="difflineminus">-            out.append(x)</span>
<a href="#l3.1008"></a><span id="l3.1008" class="difflineminus">-            ai += 1</span>
<a href="#l3.1009"></a><span id="l3.1009" class="difflineminus">-    def up():</span>
<a href="#l3.1010"></a><span id="l3.1010" class="difflineminus">-        for i,x in enumerate(line):</span>
<a href="#l3.1011"></a><span id="l3.1011" class="difflineminus">-            x = (x - prev[i]) &amp; 0xff</span>
<a href="#l3.1012"></a><span id="l3.1012" class="difflineminus">-            out.append(x)</span>
<a href="#l3.1013"></a><span id="l3.1013" class="difflineminus">-    def average():</span>
<a href="#l3.1014"></a><span id="l3.1014" class="difflineminus">-        ai = -fo</span>
<a href="#l3.1015"></a><span id="l3.1015" class="difflineminus">-        for i,x in enumerate(line):</span>
<a href="#l3.1016"></a><span id="l3.1016" class="difflineminus">-            if ai &gt;= 0:</span>
<a href="#l3.1017"></a><span id="l3.1017" class="difflineminus">-                x = (x - ((line[ai] + prev[i]) &gt;&gt; 1)) &amp; 0xff</span>
<a href="#l3.1018"></a><span id="l3.1018" class="difflineminus">-            else:</span>
<a href="#l3.1019"></a><span id="l3.1019" class="difflineminus">-                x = (x - (prev[i] &gt;&gt; 1)) &amp; 0xff</span>
<a href="#l3.1020"></a><span id="l3.1020" class="difflineminus">-            out.append(x)</span>
<a href="#l3.1021"></a><span id="l3.1021" class="difflineminus">-            ai += 1</span>
<a href="#l3.1022"></a><span id="l3.1022" class="difflineminus">-    def paeth():</span>
<a href="#l3.1023"></a><span id="l3.1023" class="difflineminus">-        # http://www.w3.org/TR/PNG/#9Filter-type-4-Paeth</span>
<a href="#l3.1024"></a><span id="l3.1024" class="difflineminus">-        ai = -fo # also used for ci</span>
<a href="#l3.1025"></a><span id="l3.1025" class="difflineminus">-        for i,x in enumerate(line):</span>
<a href="#l3.1026"></a><span id="l3.1026" class="difflineminus">-            a = 0</span>
<a href="#l3.1027"></a><span id="l3.1027" class="difflineminus">-            b = prev[i]</span>
<a href="#l3.1028"></a><span id="l3.1028" class="difflineminus">-            c = 0</span>
<a href="#l3.1029"></a><span id="l3.1029" class="difflineminus">-</span>
<a href="#l3.1030"></a><span id="l3.1030" class="difflineminus">-            if ai &gt;= 0:</span>
<a href="#l3.1031"></a><span id="l3.1031" class="difflineminus">-                a = line[ai]</span>
<a href="#l3.1032"></a><span id="l3.1032" class="difflineminus">-                c = prev[ai]</span>
<a href="#l3.1033"></a><span id="l3.1033" class="difflineminus">-            p = a + b - c</span>
<a href="#l3.1034"></a><span id="l3.1034" class="difflineminus">-            pa = abs(p - a)</span>
<a href="#l3.1035"></a><span id="l3.1035" class="difflineminus">-            pb = abs(p - b)</span>
<a href="#l3.1036"></a><span id="l3.1036" class="difflineminus">-            pc = abs(p - c)</span>
<a href="#l3.1037"></a><span id="l3.1037" class="difflineminus">-            if pa &lt;= pb and pa &lt;= pc: Pr = a</span>
<a href="#l3.1038"></a><span id="l3.1038" class="difflineminus">-            elif pb &lt;= pc: Pr = b</span>
<a href="#l3.1039"></a><span id="l3.1039" class="difflineminus">-            else: Pr = c</span>
<a href="#l3.1040"></a><span id="l3.1040" class="difflineminus">-</span>
<a href="#l3.1041"></a><span id="l3.1041" class="difflineminus">-            x = (x - Pr) &amp; 0xff</span>
<a href="#l3.1042"></a><span id="l3.1042" class="difflineminus">-            out.append(x)</span>
<a href="#l3.1043"></a><span id="l3.1043" class="difflineminus">-            ai += 1</span>
<a href="#l3.1044"></a><span id="l3.1044" class="difflineminus">-</span>
<a href="#l3.1045"></a><span id="l3.1045" class="difflineminus">-    if not prev:</span>
<a href="#l3.1046"></a><span id="l3.1046" class="difflineminus">-        # We're on the first line.  Some of the filters can be reduced</span>
<a href="#l3.1047"></a><span id="l3.1047" class="difflineminus">-        # to simpler cases which makes handling the line &quot;off the top&quot;</span>
<a href="#l3.1048"></a><span id="l3.1048" class="difflineminus">-        # of the image simpler.  &quot;up&quot; becomes &quot;none&quot;; &quot;paeth&quot; becomes</span>
<a href="#l3.1049"></a><span id="l3.1049" class="difflineminus">-        # &quot;left&quot; (non-trivial, but true). &quot;average&quot; needs to be handled</span>
<a href="#l3.1050"></a><span id="l3.1050" class="difflineminus">-        # specially.</span>
<a href="#l3.1051"></a><span id="l3.1051" class="difflineminus">-        if type == 2: # &quot;up&quot;</span>
<a href="#l3.1052"></a><span id="l3.1052" class="difflineminus">-            return line # type = 0</span>
<a href="#l3.1053"></a><span id="l3.1053" class="difflineminus">-        elif type == 3:</span>
<a href="#l3.1054"></a><span id="l3.1054" class="difflineminus">-            prev = [0]*len(line)</span>
<a href="#l3.1055"></a><span id="l3.1055" class="difflineminus">-        elif type == 4: # &quot;paeth&quot;</span>
<a href="#l3.1056"></a><span id="l3.1056" class="difflineminus">-            type = 1</span>
<a href="#l3.1057"></a><span id="l3.1057" class="difflineminus">-    if type == 0:</span>
<a href="#l3.1058"></a><span id="l3.1058" class="difflineminus">-        out.extend(line)</span>
<a href="#l3.1059"></a><span id="l3.1059" class="difflineminus">-    elif type == 1:</span>
<a href="#l3.1060"></a><span id="l3.1060" class="difflineminus">-        sub()</span>
<a href="#l3.1061"></a><span id="l3.1061" class="difflineminus">-    elif type == 2:</span>
<a href="#l3.1062"></a><span id="l3.1062" class="difflineminus">-        up()</span>
<a href="#l3.1063"></a><span id="l3.1063" class="difflineminus">-    elif type == 3:</span>
<a href="#l3.1064"></a><span id="l3.1064" class="difflineminus">-        average()</span>
<a href="#l3.1065"></a><span id="l3.1065" class="difflineminus">-    else: # type == 4</span>
<a href="#l3.1066"></a><span id="l3.1066" class="difflineminus">-        paeth()</span>
<a href="#l3.1067"></a><span id="l3.1067" class="difflineminus">-    return out</span>
<a href="#l3.1068"></a><span id="l3.1068" class="difflineminus">-</span>
<a href="#l3.1069"></a><span id="l3.1069" class="difflineminus">-</span>
<a href="#l3.1070"></a><span id="l3.1070" class="difflineminus">-def from_array(a, mode=None, info={}):</span>
<a href="#l3.1071"></a><span id="l3.1071" class="difflineminus">-    &quot;&quot;&quot;Create a PNG :class:`Image` object from a 2- or 3-dimensional array.</span>
<a href="#l3.1072"></a><span id="l3.1072" class="difflineminus">-    One application of this function is easy PIL-style saving:</span>
<a href="#l3.1073"></a><span id="l3.1073" class="difflineminus">-    ``png.from_array(pixels, 'L').save('foo.png')``.</span>
<a href="#l3.1074"></a><span id="l3.1074" class="difflineminus">-</span>
<a href="#l3.1075"></a><span id="l3.1075" class="difflineminus">-    .. note :</span>
<a href="#l3.1076"></a><span id="l3.1076" class="difflineminus">-</span>
<a href="#l3.1077"></a><span id="l3.1077" class="difflineminus">-      The use of the term *3-dimensional* is for marketing purposes</span>
<a href="#l3.1078"></a><span id="l3.1078" class="difflineminus">-      only.  It doesn't actually work.  Please bear with us.  Meanwhile</span>
<a href="#l3.1079"></a><span id="l3.1079" class="difflineminus">-      enjoy the complimentary snacks (on request) and please use a</span>
<a href="#l3.1080"></a><span id="l3.1080" class="difflineminus">-      2-dimensional array.</span>
<a href="#l3.1081"></a><span id="l3.1081" class="difflineminus">-    </span>
<a href="#l3.1082"></a><span id="l3.1082" class="difflineminus">-    Unless they are specified using the *info* parameter, the PNG's</span>
<a href="#l3.1083"></a><span id="l3.1083" class="difflineminus">-    height and width are taken from the array size.  For a 3 dimensional</span>
<a href="#l3.1084"></a><span id="l3.1084" class="difflineminus">-    array the first axis is the height; the second axis is the width;</span>
<a href="#l3.1085"></a><span id="l3.1085" class="difflineminus">-    and the third axis is the channel number.  Thus an RGB image that is</span>
<a href="#l3.1086"></a><span id="l3.1086" class="difflineminus">-    16 pixels high and 8 wide will use an array that is 16x8x3.  For 2</span>
<a href="#l3.1087"></a><span id="l3.1087" class="difflineminus">-    dimensional arrays the first axis is the height, but the second axis</span>
<a href="#l3.1088"></a><span id="l3.1088" class="difflineminus">-    is ``width*channels``, so an RGB image that is 16 pixels high and 8</span>
<a href="#l3.1089"></a><span id="l3.1089" class="difflineminus">-    wide will use a 2-dimensional array that is 16x24 (each row will be</span>
<a href="#l3.1090"></a><span id="l3.1090" class="difflineminus">-    8*3==24 sample values).</span>
<a href="#l3.1091"></a><span id="l3.1091" class="difflineminus">-</span>
<a href="#l3.1092"></a><span id="l3.1092" class="difflineminus">-    *mode* is a string that specifies the image colour format in a</span>
<a href="#l3.1093"></a><span id="l3.1093" class="difflineminus">-    PIL-style mode.  It can be:</span>
<a href="#l3.1094"></a><span id="l3.1094" class="difflineminus">-</span>
<a href="#l3.1095"></a><span id="l3.1095" class="difflineminus">-    ``'L'``</span>
<a href="#l3.1096"></a><span id="l3.1096" class="difflineminus">-      greyscale (1 channel)</span>
<a href="#l3.1097"></a><span id="l3.1097" class="difflineminus">-    ``'LA'``</span>
<a href="#l3.1098"></a><span id="l3.1098" class="difflineminus">-      greyscale with alpha (2 channel)</span>
<a href="#l3.1099"></a><span id="l3.1099" class="difflineminus">-    ``'RGB'``</span>
<a href="#l3.1100"></a><span id="l3.1100" class="difflineminus">-      colour image (3 channel)</span>
<a href="#l3.1101"></a><span id="l3.1101" class="difflineminus">-    ``'RGBA'``</span>
<a href="#l3.1102"></a><span id="l3.1102" class="difflineminus">-      colour image with alpha (4 channel)</span>
<a href="#l3.1103"></a><span id="l3.1103" class="difflineminus">-</span>
<a href="#l3.1104"></a><span id="l3.1104" class="difflineminus">-    The mode string can also specify the bit depth (overriding how this</span>
<a href="#l3.1105"></a><span id="l3.1105" class="difflineminus">-    function normally derives the bit depth, see below).  Appending</span>
<a href="#l3.1106"></a><span id="l3.1106" class="difflineminus">-    ``';16'`` to the mode will cause the PNG to be 16 bits per channel;</span>
<a href="#l3.1107"></a><span id="l3.1107" class="difflineminus">-    any decimal from 1 to 16 can be used to specify the bit depth.</span>
<a href="#l3.1108"></a><span id="l3.1108" class="difflineminus">-</span>
<a href="#l3.1109"></a><span id="l3.1109" class="difflineminus">-    When a 2-dimensional array is used *mode* determines how many</span>
<a href="#l3.1110"></a><span id="l3.1110" class="difflineminus">-    channels the image has, and so allows the width to be derived from</span>
<a href="#l3.1111"></a><span id="l3.1111" class="difflineminus">-    the second array dimension.</span>
<a href="#l3.1112"></a><span id="l3.1112" class="difflineminus">-</span>
<a href="#l3.1113"></a><span id="l3.1113" class="difflineminus">-    The array is expected to be a ``numpy`` array, but it can be any</span>
<a href="#l3.1114"></a><span id="l3.1114" class="difflineminus">-    suitable Python sequence.  For example, a list of lists can be used:</span>
<a href="#l3.1115"></a><span id="l3.1115" class="difflineminus">-    ``png.from_array([[0, 255, 0], [255, 0, 255]], 'L')``.  The exact</span>
<a href="#l3.1116"></a><span id="l3.1116" class="difflineminus">-    rules are: ``len(a)`` gives the first dimension, height;</span>
<a href="#l3.1117"></a><span id="l3.1117" class="difflineminus">-    ``len(a[0])`` gives the second dimension; ``len(a[0][0])`` gives the</span>
<a href="#l3.1118"></a><span id="l3.1118" class="difflineminus">-    third dimension, unless an exception is raised in which case a</span>
<a href="#l3.1119"></a><span id="l3.1119" class="difflineminus">-    2-dimensional array is assumed.  It's slightly more complicated than</span>
<a href="#l3.1120"></a><span id="l3.1120" class="difflineminus">-    that because an iterator of rows can be used, and it all still</span>
<a href="#l3.1121"></a><span id="l3.1121" class="difflineminus">-    works.  Using an iterator allows data to be streamed efficiently.</span>
<a href="#l3.1122"></a><span id="l3.1122" class="difflineminus">-</span>
<a href="#l3.1123"></a><span id="l3.1123" class="difflineminus">-    The bit depth of the PNG is normally taken from the array element's</span>
<a href="#l3.1124"></a><span id="l3.1124" class="difflineminus">-    datatype (but if *mode* specifies a bitdepth then that is used</span>
<a href="#l3.1125"></a><span id="l3.1125" class="difflineminus">-    instead).  The array element's datatype is determined in a way which</span>
<a href="#l3.1126"></a><span id="l3.1126" class="difflineminus">-    is supposed to work both for ``numpy`` arrays and for Python</span>
<a href="#l3.1127"></a><span id="l3.1127" class="difflineminus">-    ``array.array`` objects.  A 1 byte datatype will give a bit depth of</span>
<a href="#l3.1128"></a><span id="l3.1128" class="difflineminus">-    8, a 2 byte datatype will give a bit depth of 16.  If the datatype</span>
<a href="#l3.1129"></a><span id="l3.1129" class="difflineminus">-    does not have an implicit size, for example it is a plain Python</span>
<a href="#l3.1130"></a><span id="l3.1130" class="difflineminus">-    list of lists, as above, then a default of 8 is used.</span>
<a href="#l3.1131"></a><span id="l3.1131" class="difflineminus">-</span>
<a href="#l3.1132"></a><span id="l3.1132" class="difflineminus">-    The *info* parameter is a dictionary that can be used to specify</span>
<a href="#l3.1133"></a><span id="l3.1133" class="difflineminus">-    metadata (in the same style as the arguments to the</span>
<a href="#l3.1134"></a><span id="l3.1134" class="difflineminus">-    :class:``png.Writer`` class).  For this function the keys that are</span>
<a href="#l3.1135"></a><span id="l3.1135" class="difflineminus">-    useful are:</span>
<a href="#l3.1136"></a><span id="l3.1136" class="difflineminus">-    </span>
<a href="#l3.1137"></a><span id="l3.1137" class="difflineminus">-    height</span>
<a href="#l3.1138"></a><span id="l3.1138" class="difflineminus">-      overrides the height derived from the array dimensions and allows</span>
<a href="#l3.1139"></a><span id="l3.1139" class="difflineminus">-      *a* to be an iterable.</span>
<a href="#l3.1140"></a><span id="l3.1140" class="difflineminus">-    width</span>
<a href="#l3.1141"></a><span id="l3.1141" class="difflineminus">-      overrides the width derived from the array dimensions.</span>
<a href="#l3.1142"></a><span id="l3.1142" class="difflineminus">-    bitdepth</span>
<a href="#l3.1143"></a><span id="l3.1143" class="difflineminus">-      overrides the bit depth derived from the element datatype (but</span>
<a href="#l3.1144"></a><span id="l3.1144" class="difflineminus">-      must match *mode* if that also specifies a bit depth).</span>
<a href="#l3.1145"></a><span id="l3.1145" class="difflineminus">-</span>
<a href="#l3.1146"></a><span id="l3.1146" class="difflineminus">-    Generally anything specified in the</span>
<a href="#l3.1147"></a><span id="l3.1147" class="difflineminus">-    *info* dictionary will override any implicit choices that this</span>
<a href="#l3.1148"></a><span id="l3.1148" class="difflineminus">-    function would otherwise make, but must match any explicit ones.</span>
<a href="#l3.1149"></a><span id="l3.1149" class="difflineminus">-    For example, if the *info* dictionary has a ``greyscale`` key then</span>
<a href="#l3.1150"></a><span id="l3.1150" class="difflineminus">-    this must be true when mode is ``'L'`` or ``'LA'`` and false when</span>
<a href="#l3.1151"></a><span id="l3.1151" class="difflineminus">-    mode is ``'RGB'`` or ``'RGBA'``.</span>
<a href="#l3.1152"></a><span id="l3.1152" class="difflineminus">-    &quot;&quot;&quot;</span>
<a href="#l3.1153"></a><span id="l3.1153" class="difflineminus">-</span>
<a href="#l3.1154"></a><span id="l3.1154" class="difflineminus">-    # We abuse the *info* parameter by modifying it.  Take a copy here.</span>
<a href="#l3.1155"></a><span id="l3.1155" class="difflineminus">-    # (Also typechecks *info* to some extent).</span>
<a href="#l3.1156"></a><span id="l3.1156" class="difflineminus">-    info = dict(info)</span>
<a href="#l3.1157"></a><span id="l3.1157" class="difflineminus">-</span>
<a href="#l3.1158"></a><span id="l3.1158" class="difflineminus">-    # Syntax check mode string.</span>
<a href="#l3.1159"></a><span id="l3.1159" class="difflineminus">-    bitdepth = None</span>
<a href="#l3.1160"></a><span id="l3.1160" class="difflineminus">-    try:</span>
<a href="#l3.1161"></a><span id="l3.1161" class="difflineminus">-        mode = mode.split(';')</span>
<a href="#l3.1162"></a><span id="l3.1162" class="difflineminus">-        if len(mode) not in (1,2):</span>
<a href="#l3.1163"></a><span id="l3.1163" class="difflineminus">-            raise Error()</span>
<a href="#l3.1164"></a><span id="l3.1164" class="difflineminus">-        if mode[0] not in ('L', 'LA', 'RGB', 'RGBA'):</span>
<a href="#l3.1165"></a><span id="l3.1165" class="difflineminus">-            raise Error()</span>
<a href="#l3.1166"></a><span id="l3.1166" class="difflineminus">-        if len(mode) == 2:</span>
<a href="#l3.1167"></a><span id="l3.1167" class="difflineminus">-            try:</span>
<a href="#l3.1168"></a><span id="l3.1168" class="difflineminus">-                bitdepth = int(mode[1])</span>
<a href="#l3.1169"></a><span id="l3.1169" class="difflineminus">-            except:</span>
<a href="#l3.1170"></a><span id="l3.1170" class="difflineminus">-                raise Error()</span>
<a href="#l3.1171"></a><span id="l3.1171" class="difflineminus">-    except Error:</span>
<a href="#l3.1172"></a><span id="l3.1172" class="difflineminus">-        raise Error(&quot;mode string should be 'RGB' or 'L;16' or similar.&quot;)</span>
<a href="#l3.1173"></a><span id="l3.1173" class="difflineminus">-    mode = mode[0]</span>
<a href="#l3.1174"></a><span id="l3.1174" class="difflineminus">-</span>
<a href="#l3.1175"></a><span id="l3.1175" class="difflineminus">-    # Get bitdepth from *mode* if possible.</span>
<a href="#l3.1176"></a><span id="l3.1176" class="difflineminus">-    if bitdepth:</span>
<a href="#l3.1177"></a><span id="l3.1177" class="difflineminus">-        if info.get('bitdepth') and bitdepth != info['bitdepth']:</span>
<a href="#l3.1178"></a><span id="l3.1178" class="difflineminus">-            raise Error(&quot;mode bitdepth (%d) should match info bitdepth (%d).&quot; %</span>
<a href="#l3.1179"></a><span id="l3.1179" class="difflineminus">-              (bitdepth, info['bitdepth']))</span>
<a href="#l3.1180"></a><span id="l3.1180" class="difflineminus">-        info['bitdepth'] = bitdepth</span>
<a href="#l3.1181"></a><span id="l3.1181" class="difflineminus">-</span>
<a href="#l3.1182"></a><span id="l3.1182" class="difflineminus">-    # Fill in and/or check entries in *info*.</span>
<a href="#l3.1183"></a><span id="l3.1183" class="difflineminus">-    # Dimensions.</span>
<a href="#l3.1184"></a><span id="l3.1184" class="difflineminus">-    if 'size' in info:</span>
<a href="#l3.1185"></a><span id="l3.1185" class="difflineminus">-        # Check width, height, size all match where used.</span>
<a href="#l3.1186"></a><span id="l3.1186" class="difflineminus">-        for dimension,axis in [('width', 0), ('height', 1)]:</span>
<a href="#l3.1187"></a><span id="l3.1187" class="difflineminus">-            if dimension in info:</span>
<a href="#l3.1188"></a><span id="l3.1188" class="difflineminus">-                if info[dimension] != info['size'][axis]:</span>
<a href="#l3.1189"></a><span id="l3.1189" class="difflineminus">-                    raise Error(</span>
<a href="#l3.1190"></a><span id="l3.1190" class="difflineminus">-                      &quot;info[%r] shhould match info['size'][%r].&quot; %</span>
<a href="#l3.1191"></a><span id="l3.1191" class="difflineminus">-                      (dimension, axis))</span>
<a href="#l3.1192"></a><span id="l3.1192" class="difflineminus">-        info['width'],info['height'] = info['size']</span>
<a href="#l3.1193"></a><span id="l3.1193" class="difflineminus">-    if 'height' not in info:</span>
<a href="#l3.1194"></a><span id="l3.1194" class="difflineminus">-        try:</span>
<a href="#l3.1195"></a><span id="l3.1195" class="difflineminus">-            l = len(a)</span>
<a href="#l3.1196"></a><span id="l3.1196" class="difflineminus">-        except:</span>
<a href="#l3.1197"></a><span id="l3.1197" class="difflineminus">-            raise Error(</span>
<a href="#l3.1198"></a><span id="l3.1198" class="difflineminus">-              &quot;len(a) does not work, supply info['height'] instead.&quot;)</span>
<a href="#l3.1199"></a><span id="l3.1199" class="difflineminus">-        info['height'] = l</span>
<a href="#l3.1200"></a><span id="l3.1200" class="difflineminus">-    # Colour format.</span>
<a href="#l3.1201"></a><span id="l3.1201" class="difflineminus">-    if 'greyscale' in info:</span>
<a href="#l3.1202"></a><span id="l3.1202" class="difflineminus">-        if bool(info['greyscale']) != ('L' in mode):</span>
<a href="#l3.1203"></a><span id="l3.1203" class="difflineminus">-            raise Error(&quot;info['greyscale'] should match mode.&quot;)</span>
<a href="#l3.1204"></a><span id="l3.1204" class="difflineminus">-    info['greyscale'] = 'L' in mode</span>
<a href="#l3.1205"></a><span id="l3.1205" class="difflineminus">-    if 'alpha' in info:</span>
<a href="#l3.1206"></a><span id="l3.1206" class="difflineminus">-        if bool(info['alpha']) != ('A' in mode):</span>
<a href="#l3.1207"></a><span id="l3.1207" class="difflineminus">-            raise Error(&quot;info['alpha'] should match mode.&quot;)</span>
<a href="#l3.1208"></a><span id="l3.1208" class="difflineminus">-    info['alpha'] = 'A' in mode</span>
<a href="#l3.1209"></a><span id="l3.1209" class="difflineminus">-</span>
<a href="#l3.1210"></a><span id="l3.1210" class="difflineminus">-    planes = len(mode)</span>
<a href="#l3.1211"></a><span id="l3.1211" class="difflineminus">-    if 'planes' in info:</span>
<a href="#l3.1212"></a><span id="l3.1212" class="difflineminus">-        if info['planes'] != planes:</span>
<a href="#l3.1213"></a><span id="l3.1213" class="difflineminus">-            raise Error(&quot;info['planes'] should match mode.&quot;)</span>
<a href="#l3.1214"></a><span id="l3.1214" class="difflineminus">-</span>
<a href="#l3.1215"></a><span id="l3.1215" class="difflineminus">-    # In order to work out whether we the array is 2D or 3D we need its</span>
<a href="#l3.1216"></a><span id="l3.1216" class="difflineminus">-    # first row, which requires that we take a copy of its iterator.</span>
<a href="#l3.1217"></a><span id="l3.1217" class="difflineminus">-    # We may also need the first row to derive width and bitdepth.</span>
<a href="#l3.1218"></a><span id="l3.1218" class="difflineminus">-    a,t = itertools.tee(a)</span>
<a href="#l3.1219"></a><span id="l3.1219" class="difflineminus">-    row = t.next()</span>
<a href="#l3.1220"></a><span id="l3.1220" class="difflineminus">-    del t</span>
<a href="#l3.1221"></a><span id="l3.1221" class="difflineminus">-    try:</span>
<a href="#l3.1222"></a><span id="l3.1222" class="difflineminus">-        row[0][0]</span>
<a href="#l3.1223"></a><span id="l3.1223" class="difflineminus">-        threed = True</span>
<a href="#l3.1224"></a><span id="l3.1224" class="difflineminus">-        testelement = row[0]</span>
<a href="#l3.1225"></a><span id="l3.1225" class="difflineminus">-    except:</span>
<a href="#l3.1226"></a><span id="l3.1226" class="difflineminus">-        threed = False</span>
<a href="#l3.1227"></a><span id="l3.1227" class="difflineminus">-        testelement = row</span>
<a href="#l3.1228"></a><span id="l3.1228" class="difflineminus">-    if 'width' not in info:</span>
<a href="#l3.1229"></a><span id="l3.1229" class="difflineminus">-        if threed:</span>
<a href="#l3.1230"></a><span id="l3.1230" class="difflineminus">-            width = len(row)</span>
<a href="#l3.1231"></a><span id="l3.1231" class="difflineminus">-        else:</span>
<a href="#l3.1232"></a><span id="l3.1232" class="difflineminus">-            width = len(row) // planes</span>
<a href="#l3.1233"></a><span id="l3.1233" class="difflineminus">-        info['width'] = width</span>
<a href="#l3.1234"></a><span id="l3.1234" class="difflineminus">-</span>
<a href="#l3.1235"></a><span id="l3.1235" class="difflineminus">-    # Not implemented yet</span>
<a href="#l3.1236"></a><span id="l3.1236" class="difflineminus">-    assert not threed</span>
<a href="#l3.1237"></a><span id="l3.1237" class="difflineminus">-</span>
<a href="#l3.1238"></a><span id="l3.1238" class="difflineminus">-    if 'bitdepth' not in info:</span>
<a href="#l3.1239"></a><span id="l3.1239" class="difflineminus">-        try:</span>
<a href="#l3.1240"></a><span id="l3.1240" class="difflineminus">-            dtype = testelement.dtype</span>
<a href="#l3.1241"></a><span id="l3.1241" class="difflineminus">-            # goto the &quot;else:&quot; clause.  Sorry.</span>
<a href="#l3.1242"></a><span id="l3.1242" class="difflineminus">-        except:</span>
<a href="#l3.1243"></a><span id="l3.1243" class="difflineminus">-            try:</span>
<a href="#l3.1244"></a><span id="l3.1244" class="difflineminus">-                # Try a Python array.array.</span>
<a href="#l3.1245"></a><span id="l3.1245" class="difflineminus">-                bitdepth = 8 * testelement.itemsize</span>
<a href="#l3.1246"></a><span id="l3.1246" class="difflineminus">-            except:</span>
<a href="#l3.1247"></a><span id="l3.1247" class="difflineminus">-                # We can't determine it from the array element's</span>
<a href="#l3.1248"></a><span id="l3.1248" class="difflineminus">-                # datatype, use a default of 8.</span>
<a href="#l3.1249"></a><span id="l3.1249" class="difflineminus">-                bitdepth = 8</span>
<a href="#l3.1250"></a><span id="l3.1250" class="difflineminus">-        else:</span>
<a href="#l3.1251"></a><span id="l3.1251" class="difflineminus">-            # If we got here without exception, we now assume that</span>
<a href="#l3.1252"></a><span id="l3.1252" class="difflineminus">-            # the array is a numpy array.</span>
<a href="#l3.1253"></a><span id="l3.1253" class="difflineminus">-            if dtype.kind == 'b':</span>
<a href="#l3.1254"></a><span id="l3.1254" class="difflineminus">-                bitdepth = 1</span>
<a href="#l3.1255"></a><span id="l3.1255" class="difflineminus">-            else:</span>
<a href="#l3.1256"></a><span id="l3.1256" class="difflineminus">-                bitdepth = 8 * dtype.itemsize</span>
<a href="#l3.1257"></a><span id="l3.1257" class="difflineminus">-        info['bitdepth'] = bitdepth</span>
<a href="#l3.1258"></a><span id="l3.1258" class="difflineminus">-</span>
<a href="#l3.1259"></a><span id="l3.1259" class="difflineminus">-    for thing in 'width height bitdepth greyscale alpha'.split():</span>
<a href="#l3.1260"></a><span id="l3.1260" class="difflineminus">-        assert thing in info</span>
<a href="#l3.1261"></a><span id="l3.1261" class="difflineminus">-    return Image(a, info)</span>
<a href="#l3.1262"></a><span id="l3.1262" class="difflineminus">-</span>
<a href="#l3.1263"></a><span id="l3.1263" class="difflineminus">-# So that refugee's from PIL feel more at home.  Not documented.</span>
<a href="#l3.1264"></a><span id="l3.1264" class="difflineminus">-fromarray = from_array</span>
<a href="#l3.1265"></a><span id="l3.1265" class="difflineminus">-</span>
<a href="#l3.1266"></a><span id="l3.1266" class="difflineminus">-class Image:</span>
<a href="#l3.1267"></a><span id="l3.1267" class="difflineminus">-    &quot;&quot;&quot;A PNG image.</span>
<a href="#l3.1268"></a><span id="l3.1268" class="difflineminus">-    You can create an :class:`Image` object from an array of pixels by calling</span>
<a href="#l3.1269"></a><span id="l3.1269" class="difflineminus">-    :meth:`png.from_array`.  It can be saved to disk with the</span>
<a href="#l3.1270"></a><span id="l3.1270" class="difflineminus">-    :meth:`save` method.&quot;&quot;&quot;</span>
<a href="#l3.1271"></a><span id="l3.1271" class="difflineminus">-    def __init__(self, rows, info):</span>
<a href="#l3.1272"></a><span id="l3.1272" class="difflineminus">-        &quot;&quot;&quot;</span>
<a href="#l3.1273"></a><span id="l3.1273" class="difflineminus">-        .. note ::</span>
<a href="#l3.1274"></a><span id="l3.1274" class="difflineminus">-        </span>
<a href="#l3.1275"></a><span id="l3.1275" class="difflineminus">-          The constructor is not public.  Please do not call it.</span>
<a href="#l3.1276"></a><span id="l3.1276" class="difflineminus">-        &quot;&quot;&quot;</span>
<a href="#l3.1277"></a><span id="l3.1277" class="difflineminus">-        </span>
<a href="#l3.1278"></a><span id="l3.1278" class="difflineminus">-        self.rows = rows</span>
<a href="#l3.1279"></a><span id="l3.1279" class="difflineminus">-        self.info = info</span>
<a href="#l3.1280"></a><span id="l3.1280" class="difflineminus">-</span>
<a href="#l3.1281"></a><span id="l3.1281" class="difflineminus">-    def save(self, file):</span>
<a href="#l3.1282"></a><span id="l3.1282" class="difflineminus">-        &quot;&quot;&quot;Save the image to *file*.  If *file* looks like an open file</span>
<a href="#l3.1283"></a><span id="l3.1283" class="difflineminus">-        descriptor then it is used, otherwise it is treated as a</span>
<a href="#l3.1284"></a><span id="l3.1284" class="difflineminus">-        filename and a fresh file is opened.</span>
<a href="#l3.1285"></a><span id="l3.1285" class="difflineminus">-</span>
<a href="#l3.1286"></a><span id="l3.1286" class="difflineminus">-        In general, you can only call this method once; after it has</span>
<a href="#l3.1287"></a><span id="l3.1287" class="difflineminus">-        been called the first time and the PNG image has been saved, the</span>
<a href="#l3.1288"></a><span id="l3.1288" class="difflineminus">-        source data will have been streamed, and cannot be streamed</span>
<a href="#l3.1289"></a><span id="l3.1289" class="difflineminus">-        again.</span>
<a href="#l3.1290"></a><span id="l3.1290" class="difflineminus">-        &quot;&quot;&quot;</span>
<a href="#l3.1291"></a><span id="l3.1291" class="difflineminus">-</span>
<a href="#l3.1292"></a><span id="l3.1292" class="difflineminus">-        w = Writer(**self.info)</span>
<a href="#l3.1293"></a><span id="l3.1293" class="difflineminus">-</span>
<a href="#l3.1294"></a><span id="l3.1294" class="difflineminus">-        try:</span>
<a href="#l3.1295"></a><span id="l3.1295" class="difflineminus">-            file.write</span>
<a href="#l3.1296"></a><span id="l3.1296" class="difflineminus">-            def close(): pass</span>
<a href="#l3.1297"></a><span id="l3.1297" class="difflineminus">-        except:</span>
<a href="#l3.1298"></a><span id="l3.1298" class="difflineminus">-            file = open(file, 'wb')</span>
<a href="#l3.1299"></a><span id="l3.1299" class="difflineminus">-            def close(): file.close()</span>
<a href="#l3.1300"></a><span id="l3.1300" class="difflineminus">-</span>
<a href="#l3.1301"></a><span id="l3.1301" class="difflineminus">-        try:</span>
<a href="#l3.1302"></a><span id="l3.1302" class="difflineminus">-            w.write(file, self.rows)</span>
<a href="#l3.1303"></a><span id="l3.1303" class="difflineminus">-        finally:</span>
<a href="#l3.1304"></a><span id="l3.1304" class="difflineminus">-            close()</span>
<a href="#l3.1305"></a><span id="l3.1305" class="difflineminus">-</span>
<a href="#l3.1306"></a><span id="l3.1306" class="difflineminus">-class _readable:</span>
<a href="#l3.1307"></a><span id="l3.1307" class="difflineminus">-    &quot;&quot;&quot;</span>
<a href="#l3.1308"></a><span id="l3.1308" class="difflineminus">-    A simple file-like interface for strings and arrays.</span>
<a href="#l3.1309"></a><span id="l3.1309" class="difflineminus">-    &quot;&quot;&quot;</span>
<a href="#l3.1310"></a><span id="l3.1310" class="difflineminus">-</span>
<a href="#l3.1311"></a><span id="l3.1311" class="difflineminus">-    def __init__(self, buf):</span>
<a href="#l3.1312"></a><span id="l3.1312" class="difflineminus">-        self.buf = buf</span>
<a href="#l3.1313"></a><span id="l3.1313" class="difflineminus">-        self.offset = 0</span>
<a href="#l3.1314"></a><span id="l3.1314" class="difflineminus">-</span>
<a href="#l3.1315"></a><span id="l3.1315" class="difflineminus">-    def read(self, n):</span>
<a href="#l3.1316"></a><span id="l3.1316" class="difflineminus">-        r = self.buf[self.offset:self.offset+n]</span>
<a href="#l3.1317"></a><span id="l3.1317" class="difflineminus">-        if isarray(r):</span>
<a href="#l3.1318"></a><span id="l3.1318" class="difflineminus">-            r = r.tostring()</span>
<a href="#l3.1319"></a><span id="l3.1319" class="difflineminus">-        self.offset += n</span>
<a href="#l3.1320"></a><span id="l3.1320" class="difflineminus">-        return r</span>
<a href="#l3.1321"></a><span id="l3.1321" class="difflineminus">-</span>
<a href="#l3.1322"></a><span id="l3.1322" class="difflineminus">-</span>
<a href="#l3.1323"></a><span id="l3.1323" class="difflineminus">-class Reader:</span>
<a href="#l3.1324"></a><span id="l3.1324" class="difflineminus">-    &quot;&quot;&quot;</span>
<a href="#l3.1325"></a><span id="l3.1325" class="difflineminus">-    PNG decoder in pure Python.</span>
<a href="#l3.1326"></a><span id="l3.1326" class="difflineminus">-    &quot;&quot;&quot;</span>
<a href="#l3.1327"></a><span id="l3.1327" class="difflineminus">-</span>
<a href="#l3.1328"></a><span id="l3.1328" class="difflineminus">-    def __init__(self, _guess=None, **kw):</span>
<a href="#l3.1329"></a><span id="l3.1329" class="difflineminus">-        &quot;&quot;&quot;</span>
<a href="#l3.1330"></a><span id="l3.1330" class="difflineminus">-        Create a PNG decoder object.</span>
<a href="#l3.1331"></a><span id="l3.1331" class="difflineminus">-</span>
<a href="#l3.1332"></a><span id="l3.1332" class="difflineminus">-        The constructor expects exactly one keyword argument. If you</span>
<a href="#l3.1333"></a><span id="l3.1333" class="difflineminus">-        supply a positional argument instead, it will guess the input</span>
<a href="#l3.1334"></a><span id="l3.1334" class="difflineminus">-        type. You can choose among the following keyword arguments:</span>
<a href="#l3.1335"></a><span id="l3.1335" class="difflineminus">-</span>
<a href="#l3.1336"></a><span id="l3.1336" class="difflineminus">-        filename</span>
<a href="#l3.1337"></a><span id="l3.1337" class="difflineminus">-          Name of input file (a PNG file).</span>
<a href="#l3.1338"></a><span id="l3.1338" class="difflineminus">-        file</span>
<a href="#l3.1339"></a><span id="l3.1339" class="difflineminus">-          A file-like object (object with a read() method).</span>
<a href="#l3.1340"></a><span id="l3.1340" class="difflineminus">-        bytes</span>
<a href="#l3.1341"></a><span id="l3.1341" class="difflineminus">-          ``array`` or ``string`` with PNG data.</span>
<a href="#l3.1342"></a><span id="l3.1342" class="difflineminus">-</span>
<a href="#l3.1343"></a><span id="l3.1343" class="difflineminus">-        &quot;&quot;&quot;</span>
<a href="#l3.1344"></a><span id="l3.1344" class="difflineminus">-        if ((_guess is not None and len(kw) != 0) or</span>
<a href="#l3.1345"></a><span id="l3.1345" class="difflineminus">-            (_guess is None and len(kw) != 1)):</span>
<a href="#l3.1346"></a><span id="l3.1346" class="difflineminus">-            raise TypeError(&quot;Reader() takes exactly 1 argument&quot;)</span>
<a href="#l3.1347"></a><span id="l3.1347" class="difflineminus">-</span>
<a href="#l3.1348"></a><span id="l3.1348" class="difflineminus">-        # Will be the first 8 bytes, later on.  See validate_signature.</span>
<a href="#l3.1349"></a><span id="l3.1349" class="difflineminus">-        self.signature = None</span>
<a href="#l3.1350"></a><span id="l3.1350" class="difflineminus">-        self.transparent = None</span>
<a href="#l3.1351"></a><span id="l3.1351" class="difflineminus">-        # A pair of (len,type) if a chunk has been read but its data and</span>
<a href="#l3.1352"></a><span id="l3.1352" class="difflineminus">-        # checksum have not (in other words the file position is just</span>
<a href="#l3.1353"></a><span id="l3.1353" class="difflineminus">-        # past the 4 bytes that specify the chunk type).  See preamble</span>
<a href="#l3.1354"></a><span id="l3.1354" class="difflineminus">-        # method for how this is used.</span>
<a href="#l3.1355"></a><span id="l3.1355" class="difflineminus">-        self.atchunk = None</span>
<a href="#l3.1356"></a><span id="l3.1356" class="difflineminus">-</span>
<a href="#l3.1357"></a><span id="l3.1357" class="difflineminus">-        if _guess is not None:</span>
<a href="#l3.1358"></a><span id="l3.1358" class="difflineminus">-            if isarray(_guess):</span>
<a href="#l3.1359"></a><span id="l3.1359" class="difflineminus">-                kw[&quot;bytes&quot;] = _guess</span>
<a href="#l3.1360"></a><span id="l3.1360" class="difflineminus">-            elif isinstance(_guess, str):</span>
<a href="#l3.1361"></a><span id="l3.1361" class="difflineminus">-                kw[&quot;filename&quot;] = _guess</span>
<a href="#l3.1362"></a><span id="l3.1362" class="difflineminus">-            elif isinstance(_guess, file):</span>
<a href="#l3.1363"></a><span id="l3.1363" class="difflineminus">-                kw[&quot;file&quot;] = _guess</span>
<a href="#l3.1364"></a><span id="l3.1364" class="difflineminus">-</span>
<a href="#l3.1365"></a><span id="l3.1365" class="difflineminus">-        if &quot;filename&quot; in kw:</span>
<a href="#l3.1366"></a><span id="l3.1366" class="difflineminus">-            self.file = open(kw[&quot;filename&quot;], &quot;rb&quot;)</span>
<a href="#l3.1367"></a><span id="l3.1367" class="difflineminus">-        elif &quot;file&quot; in kw:</span>
<a href="#l3.1368"></a><span id="l3.1368" class="difflineminus">-            self.file = kw[&quot;file&quot;]</span>
<a href="#l3.1369"></a><span id="l3.1369" class="difflineminus">-        elif &quot;bytes&quot; in kw:</span>
<a href="#l3.1370"></a><span id="l3.1370" class="difflineminus">-            self.file = _readable(kw[&quot;bytes&quot;])</span>
<a href="#l3.1371"></a><span id="l3.1371" class="difflineminus">-        else:</span>
<a href="#l3.1372"></a><span id="l3.1372" class="difflineminus">-            raise TypeError(&quot;expecting filename, file or bytes array&quot;)</span>
<a href="#l3.1373"></a><span id="l3.1373" class="difflineminus">-</span>
<a href="#l3.1374"></a><span id="l3.1374" class="difflineminus">-    def chunk(self, seek=None):</span>
<a href="#l3.1375"></a><span id="l3.1375" class="difflineminus">-        &quot;&quot;&quot;</span>
<a href="#l3.1376"></a><span id="l3.1376" class="difflineminus">-        Read the next PNG chunk from the input file; returns a</span>
<a href="#l3.1377"></a><span id="l3.1377" class="difflineminus">-        (*type*,*data*) tuple.  *type* is the chunk's type as a string</span>
<a href="#l3.1378"></a><span id="l3.1378" class="difflineminus">-        (all PNG chunk types are 4 characters long).  *data* is the</span>
<a href="#l3.1379"></a><span id="l3.1379" class="difflineminus">-        chunk's data content, as a string.</span>
<a href="#l3.1380"></a><span id="l3.1380" class="difflineminus">-</span>
<a href="#l3.1381"></a><span id="l3.1381" class="difflineminus">-        If the optional `seek` argument is</span>
<a href="#l3.1382"></a><span id="l3.1382" class="difflineminus">-        specified then it will keep reading chunks until it either runs</span>
<a href="#l3.1383"></a><span id="l3.1383" class="difflineminus">-        out of file or finds the type specified by the argument.  Note</span>
<a href="#l3.1384"></a><span id="l3.1384" class="difflineminus">-        that in general the order of chunks in PNGs is unspecified, so</span>
<a href="#l3.1385"></a><span id="l3.1385" class="difflineminus">-        using `seek` can cause you to miss chunks.</span>
<a href="#l3.1386"></a><span id="l3.1386" class="difflineminus">-        &quot;&quot;&quot;</span>
<a href="#l3.1387"></a><span id="l3.1387" class="difflineminus">-</span>
<a href="#l3.1388"></a><span id="l3.1388" class="difflineminus">-        self.validate_signature()</span>
<a href="#l3.1389"></a><span id="l3.1389" class="difflineminus">-</span>
<a href="#l3.1390"></a><span id="l3.1390" class="difflineminus">-        while True:</span>
<a href="#l3.1391"></a><span id="l3.1391" class="difflineminus">-            # http://www.w3.org/TR/PNG/#5Chunk-layout</span>
<a href="#l3.1392"></a><span id="l3.1392" class="difflineminus">-            if not self.atchunk:</span>
<a href="#l3.1393"></a><span id="l3.1393" class="difflineminus">-                self.atchunk = self.chunklentype()</span>
<a href="#l3.1394"></a><span id="l3.1394" class="difflineminus">-            length,type = self.atchunk</span>
<a href="#l3.1395"></a><span id="l3.1395" class="difflineminus">-            self.atchunk = None</span>
<a href="#l3.1396"></a><span id="l3.1396" class="difflineminus">-            data = self.file.read(length)</span>
<a href="#l3.1397"></a><span id="l3.1397" class="difflineminus">-            if len(data) != length:</span>
<a href="#l3.1398"></a><span id="l3.1398" class="difflineminus">-                raise ChunkError('Chunk %s too short for required %i octets.'</span>
<a href="#l3.1399"></a><span id="l3.1399" class="difflineminus">-                  % (type, length))</span>
<a href="#l3.1400"></a><span id="l3.1400" class="difflineminus">-            checksum = self.file.read(4)</span>
<a href="#l3.1401"></a><span id="l3.1401" class="difflineminus">-            if len(checksum) != 4:</span>
<a href="#l3.1402"></a><span id="l3.1402" class="difflineminus">-                raise ValueError('Chunk %s too short for checksum.', tag)</span>
<a href="#l3.1403"></a><span id="l3.1403" class="difflineminus">-            if seek and type != seek:</span>
<a href="#l3.1404"></a><span id="l3.1404" class="difflineminus">-                continue</span>
<a href="#l3.1405"></a><span id="l3.1405" class="difflineminus">-            verify = zlib.crc32(strtobytes(type))</span>
<a href="#l3.1406"></a><span id="l3.1406" class="difflineminus">-            verify = zlib.crc32(data, verify)</span>
<a href="#l3.1407"></a><span id="l3.1407" class="difflineminus">-            # Whether the output from zlib.crc32 is signed or not varies</span>
<a href="#l3.1408"></a><span id="l3.1408" class="difflineminus">-            # according to hideous implementation details, see</span>
<a href="#l3.1409"></a><span id="l3.1409" class="difflineminus">-            # http://bugs.python.org/issue1202 .</span>
<a href="#l3.1410"></a><span id="l3.1410" class="difflineminus">-            # We coerce it to be positive here (in a way which works on</span>
<a href="#l3.1411"></a><span id="l3.1411" class="difflineminus">-            # Python 2.3 and older).</span>
<a href="#l3.1412"></a><span id="l3.1412" class="difflineminus">-            verify &amp;= 2**32 - 1</span>
<a href="#l3.1413"></a><span id="l3.1413" class="difflineminus">-            verify = struct.pack('!I', verify)</span>
<a href="#l3.1414"></a><span id="l3.1414" class="difflineminus">-            if checksum != verify:</span>
<a href="#l3.1415"></a><span id="l3.1415" class="difflineminus">-                # print repr(checksum)</span>
<a href="#l3.1416"></a><span id="l3.1416" class="difflineminus">-                (a, ) = struct.unpack('!I', checksum)</span>
<a href="#l3.1417"></a><span id="l3.1417" class="difflineminus">-                (b, ) = struct.unpack('!I', verify)</span>
<a href="#l3.1418"></a><span id="l3.1418" class="difflineminus">-                raise ChunkError(</span>
<a href="#l3.1419"></a><span id="l3.1419" class="difflineminus">-                  &quot;Checksum error in %s chunk: 0x%08X != 0x%08X.&quot; %</span>
<a href="#l3.1420"></a><span id="l3.1420" class="difflineminus">-                  (type, a, b))</span>
<a href="#l3.1421"></a><span id="l3.1421" class="difflineminus">-            return type, data</span>
<a href="#l3.1422"></a><span id="l3.1422" class="difflineminus">-</span>
<a href="#l3.1423"></a><span id="l3.1423" class="difflineminus">-    def chunks(self):</span>
<a href="#l3.1424"></a><span id="l3.1424" class="difflineminus">-        &quot;&quot;&quot;Return an iterator that will yield each chunk as a</span>
<a href="#l3.1425"></a><span id="l3.1425" class="difflineminus">-        (*chunktype*, *content*) pair.</span>
<a href="#l3.1426"></a><span id="l3.1426" class="difflineminus">-        &quot;&quot;&quot;</span>
<a href="#l3.1427"></a><span id="l3.1427" class="difflineminus">-</span>
<a href="#l3.1428"></a><span id="l3.1428" class="difflineminus">-        while True:</span>
<a href="#l3.1429"></a><span id="l3.1429" class="difflineminus">-            t,v = self.chunk()</span>
<a href="#l3.1430"></a><span id="l3.1430" class="difflineminus">-            yield t,v</span>
<a href="#l3.1431"></a><span id="l3.1431" class="difflineminus">-            if t == 'IEND':</span>
<a href="#l3.1432"></a><span id="l3.1432" class="difflineminus">-                break</span>
<a href="#l3.1433"></a><span id="l3.1433" class="difflineminus">-</span>
<a href="#l3.1434"></a><span id="l3.1434" class="difflineminus">-    def undo_filter(self, filter_type, scanline, previous):</span>
<a href="#l3.1435"></a><span id="l3.1435" class="difflineminus">-        &quot;&quot;&quot;Undo the filter for a scanline.  `scanline` is a sequence of</span>
<a href="#l3.1436"></a><span id="l3.1436" class="difflineminus">-        bytes that does not include the initial filter type byte.</span>
<a href="#l3.1437"></a><span id="l3.1437" class="difflineminus">-        `previous` is decoded previous scanline (for straightlaced</span>
<a href="#l3.1438"></a><span id="l3.1438" class="difflineminus">-        images this is the previous pixel row, but for interlaced</span>
<a href="#l3.1439"></a><span id="l3.1439" class="difflineminus">-        images, it is the previous scanline in the reduced image, which</span>
<a href="#l3.1440"></a><span id="l3.1440" class="difflineminus">-        in general is not the previous pixel row in the final image).</span>
<a href="#l3.1441"></a><span id="l3.1441" class="difflineminus">-        When there is no previous scanline (the first row of a</span>
<a href="#l3.1442"></a><span id="l3.1442" class="difflineminus">-        straightlaced image, or the first row in one of the passes in an</span>
<a href="#l3.1443"></a><span id="l3.1443" class="difflineminus">-        interlaced image), then this argument should be ``None``.</span>
<a href="#l3.1444"></a><span id="l3.1444" class="difflineminus">-</span>
<a href="#l3.1445"></a><span id="l3.1445" class="difflineminus">-        The scanline will have the effects of filtering removed, and the</span>
<a href="#l3.1446"></a><span id="l3.1446" class="difflineminus">-        result will be returned as a fresh sequence of bytes.</span>
<a href="#l3.1447"></a><span id="l3.1447" class="difflineminus">-        &quot;&quot;&quot;</span>
<a href="#l3.1448"></a><span id="l3.1448" class="difflineminus">-</span>
<a href="#l3.1449"></a><span id="l3.1449" class="difflineminus">-        # :todo: Would it be better to update scanline in place?</span>
<a href="#l3.1450"></a><span id="l3.1450" class="difflineminus">-</span>
<a href="#l3.1451"></a><span id="l3.1451" class="difflineminus">-        # Create the result byte array.  It seems that the best way to</span>
<a href="#l3.1452"></a><span id="l3.1452" class="difflineminus">-        # create the array to be the right size is to copy from an</span>
<a href="#l3.1453"></a><span id="l3.1453" class="difflineminus">-        # existing sequence.  *sigh*</span>
<a href="#l3.1454"></a><span id="l3.1454" class="difflineminus">-        # If we fill the result with scanline, then this allows a</span>
<a href="#l3.1455"></a><span id="l3.1455" class="difflineminus">-        # micro-optimisation in the &quot;null&quot; and &quot;sub&quot; cases.</span>
<a href="#l3.1456"></a><span id="l3.1456" class="difflineminus">-        result = array('B', scanline)</span>
<a href="#l3.1457"></a><span id="l3.1457" class="difflineminus">-</span>
<a href="#l3.1458"></a><span id="l3.1458" class="difflineminus">-        if filter_type == 0:</span>
<a href="#l3.1459"></a><span id="l3.1459" class="difflineminus">-            # And here, we _rely_ on filling the result with scanline,</span>
<a href="#l3.1460"></a><span id="l3.1460" class="difflineminus">-            # above.</span>
<a href="#l3.1461"></a><span id="l3.1461" class="difflineminus">-            return result</span>
<a href="#l3.1462"></a><span id="l3.1462" class="difflineminus">-</span>
<a href="#l3.1463"></a><span id="l3.1463" class="difflineminus">-        if filter_type not in (1,2,3,4):</span>
<a href="#l3.1464"></a><span id="l3.1464" class="difflineminus">-            raise FormatError('Invalid PNG Filter Type.'</span>
<a href="#l3.1465"></a><span id="l3.1465" class="difflineminus">-              '  See http://www.w3.org/TR/2003/REC-PNG-20031110/#9Filters .')</span>
<a href="#l3.1466"></a><span id="l3.1466" class="difflineminus">-</span>
<a href="#l3.1467"></a><span id="l3.1467" class="difflineminus">-        # Filter unit.  The stride from one pixel to the corresponding</span>
<a href="#l3.1468"></a><span id="l3.1468" class="difflineminus">-        # byte from the previous previous.  Normally this is the pixel</span>
<a href="#l3.1469"></a><span id="l3.1469" class="difflineminus">-        # size in bytes, but when this is smaller than 1, the previous</span>
<a href="#l3.1470"></a><span id="l3.1470" class="difflineminus">-        # byte is used instead.</span>
<a href="#l3.1471"></a><span id="l3.1471" class="difflineminus">-        fu = max(1, self.psize)</span>
<a href="#l3.1472"></a><span id="l3.1472" class="difflineminus">-</span>
<a href="#l3.1473"></a><span id="l3.1473" class="difflineminus">-        # For the first line of a pass, synthesize a dummy previous</span>
<a href="#l3.1474"></a><span id="l3.1474" class="difflineminus">-        # line.  An alternative approach would be to observe that on the</span>
<a href="#l3.1475"></a><span id="l3.1475" class="difflineminus">-        # first line 'up' is the same as 'null', 'paeth' is the same</span>
<a href="#l3.1476"></a><span id="l3.1476" class="difflineminus">-        # as 'sub', with only 'average' requiring any special case.</span>
<a href="#l3.1477"></a><span id="l3.1477" class="difflineminus">-        if not previous:</span>
<a href="#l3.1478"></a><span id="l3.1478" class="difflineminus">-            previous = array('B', [0]*len(scanline))</span>
<a href="#l3.1479"></a><span id="l3.1479" class="difflineminus">-</span>
<a href="#l3.1480"></a><span id="l3.1480" class="difflineminus">-        def sub():</span>
<a href="#l3.1481"></a><span id="l3.1481" class="difflineminus">-            &quot;&quot;&quot;Undo sub filter.&quot;&quot;&quot;</span>
<a href="#l3.1482"></a><span id="l3.1482" class="difflineminus">-</span>
<a href="#l3.1483"></a><span id="l3.1483" class="difflineminus">-            ai = 0</span>
<a href="#l3.1484"></a><span id="l3.1484" class="difflineminus">-            # Loops starts at index fu.  Observe that the initial part</span>
<a href="#l3.1485"></a><span id="l3.1485" class="difflineminus">-            # of the result is already filled in correctly with</span>
<a href="#l3.1486"></a><span id="l3.1486" class="difflineminus">-            # scanline.</span>
<a href="#l3.1487"></a><span id="l3.1487" class="difflineminus">-            for i in range(fu, len(result)):</span>
<a href="#l3.1488"></a><span id="l3.1488" class="difflineminus">-                x = scanline[i]</span>
<a href="#l3.1489"></a><span id="l3.1489" class="difflineminus">-                a = result[ai]</span>
<a href="#l3.1490"></a><span id="l3.1490" class="difflineminus">-                result[i] = (x + a) &amp; 0xff</span>
<a href="#l3.1491"></a><span id="l3.1491" class="difflineminus">-                ai += 1</span>
<a href="#l3.1492"></a><span id="l3.1492" class="difflineminus">-</span>
<a href="#l3.1493"></a><span id="l3.1493" class="difflineminus">-        def up():</span>
<a href="#l3.1494"></a><span id="l3.1494" class="difflineminus">-            &quot;&quot;&quot;Undo up filter.&quot;&quot;&quot;</span>
<a href="#l3.1495"></a><span id="l3.1495" class="difflineminus">-</span>
<a href="#l3.1496"></a><span id="l3.1496" class="difflineminus">-            for i in range(len(result)):</span>
<a href="#l3.1497"></a><span id="l3.1497" class="difflineminus">-                x = scanline[i]</span>
<a href="#l3.1498"></a><span id="l3.1498" class="difflineminus">-                b = previous[i]</span>
<a href="#l3.1499"></a><span id="l3.1499" class="difflineminus">-                result[i] = (x + b) &amp; 0xff</span>
<a href="#l3.1500"></a><span id="l3.1500" class="difflineminus">-</span>
<a href="#l3.1501"></a><span id="l3.1501" class="difflineminus">-        def average():</span>
<a href="#l3.1502"></a><span id="l3.1502" class="difflineminus">-            &quot;&quot;&quot;Undo average filter.&quot;&quot;&quot;</span>
<a href="#l3.1503"></a><span id="l3.1503" class="difflineminus">-</span>
<a href="#l3.1504"></a><span id="l3.1504" class="difflineminus">-            ai = -fu</span>
<a href="#l3.1505"></a><span id="l3.1505" class="difflineminus">-            for i in range(len(result)):</span>
<a href="#l3.1506"></a><span id="l3.1506" class="difflineminus">-                x = scanline[i]</span>
<a href="#l3.1507"></a><span id="l3.1507" class="difflineminus">-                if ai &lt; 0:</span>
<a href="#l3.1508"></a><span id="l3.1508" class="difflineminus">-                    a = 0</span>
<a href="#l3.1509"></a><span id="l3.1509" class="difflineminus">-                else:</span>
<a href="#l3.1510"></a><span id="l3.1510" class="difflineminus">-                    a = result[ai]</span>
<a href="#l3.1511"></a><span id="l3.1511" class="difflineminus">-                b = previous[i]</span>
<a href="#l3.1512"></a><span id="l3.1512" class="difflineminus">-                result[i] = (x + ((a + b) &gt;&gt; 1)) &amp; 0xff</span>
<a href="#l3.1513"></a><span id="l3.1513" class="difflineminus">-                ai += 1</span>
<a href="#l3.1514"></a><span id="l3.1514" class="difflineminus">-</span>
<a href="#l3.1515"></a><span id="l3.1515" class="difflineminus">-        def paeth():</span>
<a href="#l3.1516"></a><span id="l3.1516" class="difflineminus">-            &quot;&quot;&quot;Undo Paeth filter.&quot;&quot;&quot;</span>
<a href="#l3.1517"></a><span id="l3.1517" class="difflineminus">-</span>
<a href="#l3.1518"></a><span id="l3.1518" class="difflineminus">-            # Also used for ci.</span>
<a href="#l3.1519"></a><span id="l3.1519" class="difflineminus">-            ai = -fu</span>
<a href="#l3.1520"></a><span id="l3.1520" class="difflineminus">-            for i in range(len(result)):</span>
<a href="#l3.1521"></a><span id="l3.1521" class="difflineminus">-                x = scanline[i]</span>
<a href="#l3.1522"></a><span id="l3.1522" class="difflineminus">-                if ai &lt; 0:</span>
<a href="#l3.1523"></a><span id="l3.1523" class="difflineminus">-                    a = c = 0</span>
<a href="#l3.1524"></a><span id="l3.1524" class="difflineminus">-                else:</span>
<a href="#l3.1525"></a><span id="l3.1525" class="difflineminus">-                    a = result[ai]</span>
<a href="#l3.1526"></a><span id="l3.1526" class="difflineminus">-                    c = previous[ai]</span>
<a href="#l3.1527"></a><span id="l3.1527" class="difflineminus">-                b = previous[i]</span>
<a href="#l3.1528"></a><span id="l3.1528" class="difflineminus">-                p = a + b - c</span>
<a href="#l3.1529"></a><span id="l3.1529" class="difflineminus">-                pa = abs(p - a)</span>
<a href="#l3.1530"></a><span id="l3.1530" class="difflineminus">-                pb = abs(p - b)</span>
<a href="#l3.1531"></a><span id="l3.1531" class="difflineminus">-                pc = abs(p - c)</span>
<a href="#l3.1532"></a><span id="l3.1532" class="difflineminus">-                if pa &lt;= pb and pa &lt;= pc:</span>
<a href="#l3.1533"></a><span id="l3.1533" class="difflineminus">-                    pr = a</span>
<a href="#l3.1534"></a><span id="l3.1534" class="difflineminus">-                elif pb &lt;= pc:</span>
<a href="#l3.1535"></a><span id="l3.1535" class="difflineminus">-                    pr = b</span>
<a href="#l3.1536"></a><span id="l3.1536" class="difflineminus">-                else:</span>
<a href="#l3.1537"></a><span id="l3.1537" class="difflineminus">-                    pr = c</span>
<a href="#l3.1538"></a><span id="l3.1538" class="difflineminus">-                result[i] = (x + pr) &amp; 0xff</span>
<a href="#l3.1539"></a><span id="l3.1539" class="difflineminus">-                ai += 1</span>
<a href="#l3.1540"></a><span id="l3.1540" class="difflineminus">-</span>
<a href="#l3.1541"></a><span id="l3.1541" class="difflineminus">-        # Call appropriate filter algorithm.  Note that 0 has already</span>
<a href="#l3.1542"></a><span id="l3.1542" class="difflineminus">-        # been dealt with.</span>
<a href="#l3.1543"></a><span id="l3.1543" class="difflineminus">-        (None, sub, up, average, paeth)[filter_type]()</span>
<a href="#l3.1544"></a><span id="l3.1544" class="difflineminus">-        return result</span>
<a href="#l3.1545"></a><span id="l3.1545" class="difflineminus">-</span>
<a href="#l3.1546"></a><span id="l3.1546" class="difflineminus">-    def deinterlace(self, raw):</span>
<a href="#l3.1547"></a><span id="l3.1547" class="difflineminus">-        &quot;&quot;&quot;</span>
<a href="#l3.1548"></a><span id="l3.1548" class="difflineminus">-        Read raw pixel data, undo filters, deinterlace, and flatten.</span>
<a href="#l3.1549"></a><span id="l3.1549" class="difflineminus">-        Return in flat row flat pixel format.</span>
<a href="#l3.1550"></a><span id="l3.1550" class="difflineminus">-        &quot;&quot;&quot;</span>
<a href="#l3.1551"></a><span id="l3.1551" class="difflineminus">-</span>
<a href="#l3.1552"></a><span id="l3.1552" class="difflineminus">-        # print &gt;&gt; sys.stderr, (&quot;Reading interlaced, w=%s, r=%s, planes=%s,&quot; +</span>
<a href="#l3.1553"></a><span id="l3.1553" class="difflineminus">-        #     &quot; bpp=%s&quot;) % (self.width, self.height, self.planes, self.bps)</span>
<a href="#l3.1554"></a><span id="l3.1554" class="difflineminus">-        # Values per row (of the target image)</span>
<a href="#l3.1555"></a><span id="l3.1555" class="difflineminus">-        vpr = self.width * self.planes</span>
<a href="#l3.1556"></a><span id="l3.1556" class="difflineminus">-</span>
<a href="#l3.1557"></a><span id="l3.1557" class="difflineminus">-        # Make a result array, and make it big enough.  Interleaving</span>
<a href="#l3.1558"></a><span id="l3.1558" class="difflineminus">-        # writes to the output array randomly (well, not quite), so the</span>
<a href="#l3.1559"></a><span id="l3.1559" class="difflineminus">-        # entire output array must be in memory.</span>
<a href="#l3.1560"></a><span id="l3.1560" class="difflineminus">-        fmt = 'BH'[self.bitdepth &gt; 8]</span>
<a href="#l3.1561"></a><span id="l3.1561" class="difflineminus">-        a = array(fmt, [0]*vpr*self.height)</span>
<a href="#l3.1562"></a><span id="l3.1562" class="difflineminus">-        source_offset = 0</span>
<a href="#l3.1563"></a><span id="l3.1563" class="difflineminus">-</span>
<a href="#l3.1564"></a><span id="l3.1564" class="difflineminus">-        for xstart, ystart, xstep, ystep in _adam7:</span>
<a href="#l3.1565"></a><span id="l3.1565" class="difflineminus">-            # print &gt;&gt; sys.stderr, &quot;Adam7: start=%s,%s step=%s,%s&quot; % (</span>
<a href="#l3.1566"></a><span id="l3.1566" class="difflineminus">-            #     xstart, ystart, xstep, ystep)</span>
<a href="#l3.1567"></a><span id="l3.1567" class="difflineminus">-            if xstart &gt;= self.width:</span>
<a href="#l3.1568"></a><span id="l3.1568" class="difflineminus">-                continue</span>
<a href="#l3.1569"></a><span id="l3.1569" class="difflineminus">-            # The previous (reconstructed) scanline.  None at the</span>
<a href="#l3.1570"></a><span id="l3.1570" class="difflineminus">-            # beginning of a pass to indicate that there is no previous</span>
<a href="#l3.1571"></a><span id="l3.1571" class="difflineminus">-            # line.</span>
<a href="#l3.1572"></a><span id="l3.1572" class="difflineminus">-            recon = None</span>
<a href="#l3.1573"></a><span id="l3.1573" class="difflineminus">-            # Pixels per row (reduced pass image)</span>
<a href="#l3.1574"></a><span id="l3.1574" class="difflineminus">-            ppr = int(math.ceil((self.width-xstart)/float(xstep)))</span>
<a href="#l3.1575"></a><span id="l3.1575" class="difflineminus">-            # Row size in bytes for this pass.</span>
<a href="#l3.1576"></a><span id="l3.1576" class="difflineminus">-            row_size = int(math.ceil(self.psize * ppr))</span>
<a href="#l3.1577"></a><span id="l3.1577" class="difflineminus">-            for y in range(ystart, self.height, ystep):</span>
<a href="#l3.1578"></a><span id="l3.1578" class="difflineminus">-                filter_type = raw[source_offset]</span>
<a href="#l3.1579"></a><span id="l3.1579" class="difflineminus">-                source_offset += 1</span>
<a href="#l3.1580"></a><span id="l3.1580" class="difflineminus">-                scanline = raw[source_offset:source_offset+row_size]</span>
<a href="#l3.1581"></a><span id="l3.1581" class="difflineminus">-                source_offset += row_size</span>
<a href="#l3.1582"></a><span id="l3.1582" class="difflineminus">-                recon = self.undo_filter(filter_type, scanline, recon)</span>
<a href="#l3.1583"></a><span id="l3.1583" class="difflineminus">-                # Convert so that there is one element per pixel value</span>
<a href="#l3.1584"></a><span id="l3.1584" class="difflineminus">-                flat = self.serialtoflat(recon, ppr)</span>
<a href="#l3.1585"></a><span id="l3.1585" class="difflineminus">-                if xstep == 1:</span>
<a href="#l3.1586"></a><span id="l3.1586" class="difflineminus">-                    assert xstart == 0</span>
<a href="#l3.1587"></a><span id="l3.1587" class="difflineminus">-                    offset = y * vpr</span>
<a href="#l3.1588"></a><span id="l3.1588" class="difflineminus">-                    a[offset:offset+vpr] = flat</span>
<a href="#l3.1589"></a><span id="l3.1589" class="difflineminus">-                else:</span>
<a href="#l3.1590"></a><span id="l3.1590" class="difflineminus">-                    offset = y * vpr + xstart * self.planes</span>
<a href="#l3.1591"></a><span id="l3.1591" class="difflineminus">-                    end_offset = (y+1) * vpr</span>
<a href="#l3.1592"></a><span id="l3.1592" class="difflineminus">-                    skip = self.planes * xstep</span>
<a href="#l3.1593"></a><span id="l3.1593" class="difflineminus">-                    for i in range(self.planes):</span>
<a href="#l3.1594"></a><span id="l3.1594" class="difflineminus">-                        a[offset+i:end_offset:skip] = \</span>
<a href="#l3.1595"></a><span id="l3.1595" class="difflineminus">-                            flat[i::self.planes]</span>
<a href="#l3.1596"></a><span id="l3.1596" class="difflineminus">-        return a</span>
<a href="#l3.1597"></a><span id="l3.1597" class="difflineminus">-</span>
<a href="#l3.1598"></a><span id="l3.1598" class="difflineminus">-    def iterboxed(self, rows):</span>
<a href="#l3.1599"></a><span id="l3.1599" class="difflineminus">-        &quot;&quot;&quot;Iterator that yields each scanline in boxed row flat pixel</span>
<a href="#l3.1600"></a><span id="l3.1600" class="difflineminus">-        format.  `rows` should be an iterator that yields the bytes of</span>
<a href="#l3.1601"></a><span id="l3.1601" class="difflineminus">-        each row in turn.</span>
<a href="#l3.1602"></a><span id="l3.1602" class="difflineminus">-        &quot;&quot;&quot;</span>
<a href="#l3.1603"></a><span id="l3.1603" class="difflineminus">-</span>
<a href="#l3.1604"></a><span id="l3.1604" class="difflineminus">-        def asvalues(raw):</span>
<a href="#l3.1605"></a><span id="l3.1605" class="difflineminus">-            &quot;&quot;&quot;Convert a row of raw bytes into a flat row.  Result may</span>
<a href="#l3.1606"></a><span id="l3.1606" class="difflineminus">-            or may not share with argument&quot;&quot;&quot;</span>
<a href="#l3.1607"></a><span id="l3.1607" class="difflineminus">-</span>
<a href="#l3.1608"></a><span id="l3.1608" class="difflineminus">-            if self.bitdepth == 8:</span>
<a href="#l3.1609"></a><span id="l3.1609" class="difflineminus">-                return raw</span>
<a href="#l3.1610"></a><span id="l3.1610" class="difflineminus">-            if self.bitdepth == 16:</span>
<a href="#l3.1611"></a><span id="l3.1611" class="difflineminus">-                raw = tostring(raw)</span>
<a href="#l3.1612"></a><span id="l3.1612" class="difflineminus">-                return array('H', struct.unpack('!%dH' % (len(raw)//2), raw))</span>
<a href="#l3.1613"></a><span id="l3.1613" class="difflineminus">-            assert self.bitdepth &lt; 8</span>
<a href="#l3.1614"></a><span id="l3.1614" class="difflineminus">-            width = self.width</span>
<a href="#l3.1615"></a><span id="l3.1615" class="difflineminus">-            # Samples per byte</span>
<a href="#l3.1616"></a><span id="l3.1616" class="difflineminus">-            spb = 8//self.bitdepth</span>
<a href="#l3.1617"></a><span id="l3.1617" class="difflineminus">-            out = array('B')</span>
<a href="#l3.1618"></a><span id="l3.1618" class="difflineminus">-            mask = 2**self.bitdepth - 1</span>
<a href="#l3.1619"></a><span id="l3.1619" class="difflineminus">-            shifts = map(self.bitdepth.__mul__, reversed(range(spb)))</span>
<a href="#l3.1620"></a><span id="l3.1620" class="difflineminus">-            for o in raw:</span>
<a href="#l3.1621"></a><span id="l3.1621" class="difflineminus">-                out.extend(map(lambda i: mask&amp;(o&gt;&gt;i), shifts))</span>
<a href="#l3.1622"></a><span id="l3.1622" class="difflineminus">-            return out[:width]</span>
<a href="#l3.1623"></a><span id="l3.1623" class="difflineminus">-</span>
<a href="#l3.1624"></a><span id="l3.1624" class="difflineminus">-        return itertools.imap(asvalues, rows)</span>
<a href="#l3.1625"></a><span id="l3.1625" class="difflineminus">-</span>
<a href="#l3.1626"></a><span id="l3.1626" class="difflineminus">-    def serialtoflat(self, bytes, width=None):</span>
<a href="#l3.1627"></a><span id="l3.1627" class="difflineminus">-        &quot;&quot;&quot;Convert serial format (byte stream) pixel data to flat row</span>
<a href="#l3.1628"></a><span id="l3.1628" class="difflineminus">-        flat pixel.</span>
<a href="#l3.1629"></a><span id="l3.1629" class="difflineminus">-        &quot;&quot;&quot;</span>
<a href="#l3.1630"></a><span id="l3.1630" class="difflineminus">-</span>
<a href="#l3.1631"></a><span id="l3.1631" class="difflineminus">-        if self.bitdepth == 8:</span>
<a href="#l3.1632"></a><span id="l3.1632" class="difflineminus">-            return bytes</span>
<a href="#l3.1633"></a><span id="l3.1633" class="difflineminus">-        if self.bitdepth == 16:</span>
<a href="#l3.1634"></a><span id="l3.1634" class="difflineminus">-            bytes = tostring(bytes)</span>
<a href="#l3.1635"></a><span id="l3.1635" class="difflineminus">-            return array('H',</span>
<a href="#l3.1636"></a><span id="l3.1636" class="difflineminus">-              struct.unpack('!%dH' % (len(bytes)//2), bytes))</span>
<a href="#l3.1637"></a><span id="l3.1637" class="difflineminus">-        assert self.bitdepth &lt; 8</span>
<a href="#l3.1638"></a><span id="l3.1638" class="difflineminus">-        if width is None:</span>
<a href="#l3.1639"></a><span id="l3.1639" class="difflineminus">-            width = self.width</span>
<a href="#l3.1640"></a><span id="l3.1640" class="difflineminus">-        # Samples per byte</span>
<a href="#l3.1641"></a><span id="l3.1641" class="difflineminus">-        spb = 8//self.bitdepth</span>
<a href="#l3.1642"></a><span id="l3.1642" class="difflineminus">-        out = array('B')</span>
<a href="#l3.1643"></a><span id="l3.1643" class="difflineminus">-        mask = 2**self.bitdepth - 1</span>
<a href="#l3.1644"></a><span id="l3.1644" class="difflineminus">-        shifts = map(self.bitdepth.__mul__, reversed(range(spb)))</span>
<a href="#l3.1645"></a><span id="l3.1645" class="difflineminus">-        l = width</span>
<a href="#l3.1646"></a><span id="l3.1646" class="difflineminus">-        for o in bytes:</span>
<a href="#l3.1647"></a><span id="l3.1647" class="difflineminus">-            out.extend([(mask&amp;(o&gt;&gt;s)) for s in shifts][:l])</span>
<a href="#l3.1648"></a><span id="l3.1648" class="difflineminus">-            l -= spb</span>
<a href="#l3.1649"></a><span id="l3.1649" class="difflineminus">-            if l &lt;= 0:</span>
<a href="#l3.1650"></a><span id="l3.1650" class="difflineminus">-                l = width</span>
<a href="#l3.1651"></a><span id="l3.1651" class="difflineminus">-        return out</span>
<a href="#l3.1652"></a><span id="l3.1652" class="difflineminus">-</span>
<a href="#l3.1653"></a><span id="l3.1653" class="difflineminus">-    def iterstraight(self, raw):</span>
<a href="#l3.1654"></a><span id="l3.1654" class="difflineminus">-        &quot;&quot;&quot;Iterator that undoes the effect of filtering, and yields each</span>
<a href="#l3.1655"></a><span id="l3.1655" class="difflineminus">-        row in serialised format (as a sequence of bytes).  Assumes input</span>
<a href="#l3.1656"></a><span id="l3.1656" class="difflineminus">-        is straightlaced.  `raw` should be an iterable that yields the</span>
<a href="#l3.1657"></a><span id="l3.1657" class="difflineminus">-        raw bytes in chunks of arbitrary size.&quot;&quot;&quot;</span>
<a href="#l3.1658"></a><span id="l3.1658" class="difflineminus">-</span>
<a href="#l3.1659"></a><span id="l3.1659" class="difflineminus">-        # length of row, in bytes</span>
<a href="#l3.1660"></a><span id="l3.1660" class="difflineminus">-        rb = self.row_bytes</span>
<a href="#l3.1661"></a><span id="l3.1661" class="difflineminus">-        a = array('B')</span>
<a href="#l3.1662"></a><span id="l3.1662" class="difflineminus">-        # The previous (reconstructed) scanline.  None indicates first</span>
<a href="#l3.1663"></a><span id="l3.1663" class="difflineminus">-        # line of image.</span>
<a href="#l3.1664"></a><span id="l3.1664" class="difflineminus">-        recon = None</span>
<a href="#l3.1665"></a><span id="l3.1665" class="difflineminus">-        for some in raw:</span>
<a href="#l3.1666"></a><span id="l3.1666" class="difflineminus">-            a.extend(some)</span>
<a href="#l3.1667"></a><span id="l3.1667" class="difflineminus">-            while len(a) &gt;= rb + 1:</span>
<a href="#l3.1668"></a><span id="l3.1668" class="difflineminus">-                filter_type = a[0]</span>
<a href="#l3.1669"></a><span id="l3.1669" class="difflineminus">-                scanline = a[1:rb+1]</span>
<a href="#l3.1670"></a><span id="l3.1670" class="difflineminus">-                del a[:rb+1]</span>
<a href="#l3.1671"></a><span id="l3.1671" class="difflineminus">-                recon = self.undo_filter(filter_type, scanline, recon)</span>
<a href="#l3.1672"></a><span id="l3.1672" class="difflineminus">-                yield recon</span>
<a href="#l3.1673"></a><span id="l3.1673" class="difflineminus">-        if len(a) != 0:</span>
<a href="#l3.1674"></a><span id="l3.1674" class="difflineminus">-            # :file:format We get here with a file format error: when the</span>
<a href="#l3.1675"></a><span id="l3.1675" class="difflineminus">-            # available bytes (after decompressing) do not pack into exact</span>
<a href="#l3.1676"></a><span id="l3.1676" class="difflineminus">-            # rows.</span>
<a href="#l3.1677"></a><span id="l3.1677" class="difflineminus">-            raise FormatError(</span>
<a href="#l3.1678"></a><span id="l3.1678" class="difflineminus">-              'Wrong size for decompressed IDAT chunk.')</span>
<a href="#l3.1679"></a><span id="l3.1679" class="difflineminus">-        assert len(a) == 0</span>
<a href="#l3.1680"></a><span id="l3.1680" class="difflineminus">-</span>
<a href="#l3.1681"></a><span id="l3.1681" class="difflineminus">-    def validate_signature(self):</span>
<a href="#l3.1682"></a><span id="l3.1682" class="difflineminus">-        &quot;&quot;&quot;If signature (header) has not been read then read and</span>
<a href="#l3.1683"></a><span id="l3.1683" class="difflineminus">-        validate it; otherwise do nothing.</span>
<a href="#l3.1684"></a><span id="l3.1684" class="difflineminus">-        &quot;&quot;&quot;</span>
<a href="#l3.1685"></a><span id="l3.1685" class="difflineminus">-</span>
<a href="#l3.1686"></a><span id="l3.1686" class="difflineminus">-        if self.signature:</span>
<a href="#l3.1687"></a><span id="l3.1687" class="difflineminus">-            return</span>
<a href="#l3.1688"></a><span id="l3.1688" class="difflineminus">-        self.signature = self.file.read(8)</span>
<a href="#l3.1689"></a><span id="l3.1689" class="difflineminus">-        if self.signature != _signature:</span>
<a href="#l3.1690"></a><span id="l3.1690" class="difflineminus">-            raise FormatError(&quot;PNG file has invalid signature.&quot;)</span>
<a href="#l3.1691"></a><span id="l3.1691" class="difflineminus">-</span>
<a href="#l3.1692"></a><span id="l3.1692" class="difflineminus">-    def preamble(self):</span>
<a href="#l3.1693"></a><span id="l3.1693" class="difflineminus">-        &quot;&quot;&quot;</span>
<a href="#l3.1694"></a><span id="l3.1694" class="difflineminus">-        Extract the image metadata by reading the initial part of the PNG</span>
<a href="#l3.1695"></a><span id="l3.1695" class="difflineminus">-        file up to the start of the ``IDAT`` chunk.  All the chunks that</span>
<a href="#l3.1696"></a><span id="l3.1696" class="difflineminus">-        precede the ``IDAT`` chunk are read and either processed for</span>
<a href="#l3.1697"></a><span id="l3.1697" class="difflineminus">-        metadata or discarded.</span>
<a href="#l3.1698"></a><span id="l3.1698" class="difflineminus">-        &quot;&quot;&quot;</span>
<a href="#l3.1699"></a><span id="l3.1699" class="difflineminus">-</span>
<a href="#l3.1700"></a><span id="l3.1700" class="difflineminus">-        self.validate_signature()</span>
<a href="#l3.1701"></a><span id="l3.1701" class="difflineminus">-</span>
<a href="#l3.1702"></a><span id="l3.1702" class="difflineminus">-        while True:</span>
<a href="#l3.1703"></a><span id="l3.1703" class="difflineminus">-            if not self.atchunk:</span>
<a href="#l3.1704"></a><span id="l3.1704" class="difflineminus">-                self.atchunk = self.chunklentype()</span>
<a href="#l3.1705"></a><span id="l3.1705" class="difflineminus">-                if self.atchunk is None:</span>
<a href="#l3.1706"></a><span id="l3.1706" class="difflineminus">-                    raise FormatError(</span>
<a href="#l3.1707"></a><span id="l3.1707" class="difflineminus">-                      'This PNG file has no IDAT chunks.')</span>
<a href="#l3.1708"></a><span id="l3.1708" class="difflineminus">-            if self.atchunk[1] == 'IDAT':</span>
<a href="#l3.1709"></a><span id="l3.1709" class="difflineminus">-                return</span>
<a href="#l3.1710"></a><span id="l3.1710" class="difflineminus">-            self.process_chunk()</span>
<a href="#l3.1711"></a><span id="l3.1711" class="difflineminus">-</span>
<a href="#l3.1712"></a><span id="l3.1712" class="difflineminus">-    def chunklentype(self):</span>
<a href="#l3.1713"></a><span id="l3.1713" class="difflineminus">-        &quot;&quot;&quot;Reads just enough of the input to determine the next</span>
<a href="#l3.1714"></a><span id="l3.1714" class="difflineminus">-        chunk's length and type, returned as a (*length*, *type*) pair</span>
<a href="#l3.1715"></a><span id="l3.1715" class="difflineminus">-        where *type* is a string.  If there are no more chunks, ``None``</span>
<a href="#l3.1716"></a><span id="l3.1716" class="difflineminus">-        is returned.</span>
<a href="#l3.1717"></a><span id="l3.1717" class="difflineminus">-        &quot;&quot;&quot;</span>
<a href="#l3.1718"></a><span id="l3.1718" class="difflineminus">-</span>
<a href="#l3.1719"></a><span id="l3.1719" class="difflineminus">-        x = self.file.read(8)</span>
<a href="#l3.1720"></a><span id="l3.1720" class="difflineminus">-        if not x:</span>
<a href="#l3.1721"></a><span id="l3.1721" class="difflineminus">-            return None</span>
<a href="#l3.1722"></a><span id="l3.1722" class="difflineminus">-        if len(x) != 8:</span>
<a href="#l3.1723"></a><span id="l3.1723" class="difflineminus">-            raise FormatError(</span>
<a href="#l3.1724"></a><span id="l3.1724" class="difflineminus">-              'End of file whilst reading chunk length and type.')</span>
<a href="#l3.1725"></a><span id="l3.1725" class="difflineminus">-        length,type = struct.unpack('!I4s', x)</span>
<a href="#l3.1726"></a><span id="l3.1726" class="difflineminus">-        type = bytestostr(type)</span>
<a href="#l3.1727"></a><span id="l3.1727" class="difflineminus">-        if length &gt; 2**31-1:</span>
<a href="#l3.1728"></a><span id="l3.1728" class="difflineminus">-            raise FormatError('Chunk %s is too large: %d.' % (type,length))</span>
<a href="#l3.1729"></a><span id="l3.1729" class="difflineminus">-        return length,type</span>
<a href="#l3.1730"></a><span id="l3.1730" class="difflineminus">-</span>
<a href="#l3.1731"></a><span id="l3.1731" class="difflineminus">-    def process_chunk(self):</span>
<a href="#l3.1732"></a><span id="l3.1732" class="difflineminus">-        &quot;&quot;&quot;Process the next chunk and its data.  This only processes the</span>
<a href="#l3.1733"></a><span id="l3.1733" class="difflineminus">-        following chunk types, all others are ignored: ``IHDR``,</span>
<a href="#l3.1734"></a><span id="l3.1734" class="difflineminus">-        ``PLTE``, ``bKGD``, ``tRNS``, ``gAMA``, ``sBIT``.</span>
<a href="#l3.1735"></a><span id="l3.1735" class="difflineminus">-        &quot;&quot;&quot;</span>
<a href="#l3.1736"></a><span id="l3.1736" class="difflineminus">-</span>
<a href="#l3.1737"></a><span id="l3.1737" class="difflineminus">-        type, data = self.chunk()</span>
<a href="#l3.1738"></a><span id="l3.1738" class="difflineminus">-        if type == 'IHDR':</span>
<a href="#l3.1739"></a><span id="l3.1739" class="difflineminus">-            # http://www.w3.org/TR/PNG/#11IHDR</span>
<a href="#l3.1740"></a><span id="l3.1740" class="difflineminus">-            if len(data) != 13:</span>
<a href="#l3.1741"></a><span id="l3.1741" class="difflineminus">-                raise FormatError('IHDR chunk has incorrect length.')</span>
<a href="#l3.1742"></a><span id="l3.1742" class="difflineminus">-            (self.width, self.height, self.bitdepth, self.color_type,</span>
<a href="#l3.1743"></a><span id="l3.1743" class="difflineminus">-             self.compression, self.filter,</span>
<a href="#l3.1744"></a><span id="l3.1744" class="difflineminus">-             self.interlace) = struct.unpack(&quot;!2I5B&quot;, data)</span>
<a href="#l3.1745"></a><span id="l3.1745" class="difflineminus">-</span>
<a href="#l3.1746"></a><span id="l3.1746" class="difflineminus">-            # Check that the header specifies only valid combinations.</span>
<a href="#l3.1747"></a><span id="l3.1747" class="difflineminus">-            if self.bitdepth not in (1,2,4,8,16):</span>
<a href="#l3.1748"></a><span id="l3.1748" class="difflineminus">-                raise Error(&quot;invalid bit depth %d&quot; % self.bitdepth)</span>
<a href="#l3.1749"></a><span id="l3.1749" class="difflineminus">-            if self.color_type not in (0,2,3,4,6):</span>
<a href="#l3.1750"></a><span id="l3.1750" class="difflineminus">-                raise Error(&quot;invalid colour type %d&quot; % self.color_type)</span>
<a href="#l3.1751"></a><span id="l3.1751" class="difflineminus">-            # Check indexed (palettized) images have 8 or fewer bits</span>
<a href="#l3.1752"></a><span id="l3.1752" class="difflineminus">-            # per pixel; check only indexed or greyscale images have</span>
<a href="#l3.1753"></a><span id="l3.1753" class="difflineminus">-            # fewer than 8 bits per pixel.</span>
<a href="#l3.1754"></a><span id="l3.1754" class="difflineminus">-            if ((self.color_type &amp; 1 and self.bitdepth &gt; 8) or</span>
<a href="#l3.1755"></a><span id="l3.1755" class="difflineminus">-                (self.bitdepth &lt; 8 and self.color_type not in (0,3))):</span>
<a href="#l3.1756"></a><span id="l3.1756" class="difflineminus">-                raise FormatError(&quot;Illegal combination of bit depth (%d)&quot;</span>
<a href="#l3.1757"></a><span id="l3.1757" class="difflineminus">-                  &quot; and colour type (%d).&quot;</span>
<a href="#l3.1758"></a><span id="l3.1758" class="difflineminus">-                  &quot; See http://www.w3.org/TR/2003/REC-PNG-20031110/#table111 .&quot;</span>
<a href="#l3.1759"></a><span id="l3.1759" class="difflineminus">-                  % (self.bitdepth, self.color_type))</span>
<a href="#l3.1760"></a><span id="l3.1760" class="difflineminus">-            if self.compression != 0:</span>
<a href="#l3.1761"></a><span id="l3.1761" class="difflineminus">-                raise Error(&quot;unknown compression method %d&quot; % self.compression)</span>
<a href="#l3.1762"></a><span id="l3.1762" class="difflineminus">-            if self.filter != 0:</span>
<a href="#l3.1763"></a><span id="l3.1763" class="difflineminus">-                raise FormatError(&quot;Unknown filter method %d,&quot;</span>
<a href="#l3.1764"></a><span id="l3.1764" class="difflineminus">-                  &quot; see http://www.w3.org/TR/2003/REC-PNG-20031110/#9Filters .&quot;</span>
<a href="#l3.1765"></a><span id="l3.1765" class="difflineminus">-                  % self.filter)</span>
<a href="#l3.1766"></a><span id="l3.1766" class="difflineminus">-            if self.interlace not in (0,1):</span>
<a href="#l3.1767"></a><span id="l3.1767" class="difflineminus">-                raise FormatError(&quot;Unknown interlace method %d,&quot;</span>
<a href="#l3.1768"></a><span id="l3.1768" class="difflineminus">-                  &quot; see http://www.w3.org/TR/2003/REC-PNG-20031110/#8InterlaceMethods .&quot;</span>
<a href="#l3.1769"></a><span id="l3.1769" class="difflineminus">-                  % self.interlace)</span>
<a href="#l3.1770"></a><span id="l3.1770" class="difflineminus">-</span>
<a href="#l3.1771"></a><span id="l3.1771" class="difflineminus">-            # Derived values</span>
<a href="#l3.1772"></a><span id="l3.1772" class="difflineminus">-            # http://www.w3.org/TR/PNG/#6Colour-values</span>
<a href="#l3.1773"></a><span id="l3.1773" class="difflineminus">-            colormap =  bool(self.color_type &amp; 1)</span>
<a href="#l3.1774"></a><span id="l3.1774" class="difflineminus">-            greyscale = not (self.color_type &amp; 2)</span>
<a href="#l3.1775"></a><span id="l3.1775" class="difflineminus">-            alpha = bool(self.color_type &amp; 4)</span>
<a href="#l3.1776"></a><span id="l3.1776" class="difflineminus">-            color_planes = (3,1)[greyscale or colormap]</span>
<a href="#l3.1777"></a><span id="l3.1777" class="difflineminus">-            planes = color_planes + alpha</span>
<a href="#l3.1778"></a><span id="l3.1778" class="difflineminus">-</span>
<a href="#l3.1779"></a><span id="l3.1779" class="difflineminus">-            self.colormap = colormap</span>
<a href="#l3.1780"></a><span id="l3.1780" class="difflineminus">-            self.greyscale = greyscale</span>
<a href="#l3.1781"></a><span id="l3.1781" class="difflineminus">-            self.alpha = alpha</span>
<a href="#l3.1782"></a><span id="l3.1782" class="difflineminus">-            self.color_planes = color_planes</span>
<a href="#l3.1783"></a><span id="l3.1783" class="difflineminus">-            self.planes = planes</span>
<a href="#l3.1784"></a><span id="l3.1784" class="difflineminus">-            self.psize = float(self.bitdepth)/float(8) * planes</span>
<a href="#l3.1785"></a><span id="l3.1785" class="difflineminus">-            if int(self.psize) == self.psize:</span>
<a href="#l3.1786"></a><span id="l3.1786" class="difflineminus">-                self.psize = int(self.psize)</span>
<a href="#l3.1787"></a><span id="l3.1787" class="difflineminus">-            self.row_bytes = int(math.ceil(self.width * self.psize))</span>
<a href="#l3.1788"></a><span id="l3.1788" class="difflineminus">-            # Stores PLTE chunk if present, and is used to check</span>
<a href="#l3.1789"></a><span id="l3.1789" class="difflineminus">-            # chunk ordering constraints.</span>
<a href="#l3.1790"></a><span id="l3.1790" class="difflineminus">-            self.plte = None</span>
<a href="#l3.1791"></a><span id="l3.1791" class="difflineminus">-            # Stores tRNS chunk if present, and is used to check chunk</span>
<a href="#l3.1792"></a><span id="l3.1792" class="difflineminus">-            # ordering constraints.</span>
<a href="#l3.1793"></a><span id="l3.1793" class="difflineminus">-            self.trns = None</span>
<a href="#l3.1794"></a><span id="l3.1794" class="difflineminus">-            # Stores sbit chunk if present.</span>
<a href="#l3.1795"></a><span id="l3.1795" class="difflineminus">-            self.sbit = None</span>
<a href="#l3.1796"></a><span id="l3.1796" class="difflineminus">-        elif type == 'PLTE':</span>
<a href="#l3.1797"></a><span id="l3.1797" class="difflineminus">-            # http://www.w3.org/TR/PNG/#11PLTE</span>
<a href="#l3.1798"></a><span id="l3.1798" class="difflineminus">-            if self.plte:</span>
<a href="#l3.1799"></a><span id="l3.1799" class="difflineminus">-                warnings.warn(&quot;Multiple PLTE chunks present.&quot;)</span>
<a href="#l3.1800"></a><span id="l3.1800" class="difflineminus">-            self.plte = data</span>
<a href="#l3.1801"></a><span id="l3.1801" class="difflineminus">-            if len(data) % 3 != 0:</span>
<a href="#l3.1802"></a><span id="l3.1802" class="difflineminus">-                raise FormatError(</span>
<a href="#l3.1803"></a><span id="l3.1803" class="difflineminus">-                  &quot;PLTE chunk's length should be a multiple of 3.&quot;)</span>
<a href="#l3.1804"></a><span id="l3.1804" class="difflineminus">-            if len(data) &gt; (2**self.bitdepth)*3:</span>
<a href="#l3.1805"></a><span id="l3.1805" class="difflineminus">-                raise FormatError(&quot;PLTE chunk is too long.&quot;)</span>
<a href="#l3.1806"></a><span id="l3.1806" class="difflineminus">-            if len(data) == 0:</span>
<a href="#l3.1807"></a><span id="l3.1807" class="difflineminus">-                raise FormatError(&quot;Empty PLTE is not allowed.&quot;)</span>
<a href="#l3.1808"></a><span id="l3.1808" class="difflineminus">-        elif type == 'bKGD':</span>
<a href="#l3.1809"></a><span id="l3.1809" class="difflineminus">-            try:</span>
<a href="#l3.1810"></a><span id="l3.1810" class="difflineminus">-                if self.colormap:</span>
<a href="#l3.1811"></a><span id="l3.1811" class="difflineminus">-                    if not self.plte:</span>
<a href="#l3.1812"></a><span id="l3.1812" class="difflineminus">-                        warnings.warn(</span>
<a href="#l3.1813"></a><span id="l3.1813" class="difflineminus">-                          &quot;PLTE chunk is required before bKGD chunk.&quot;)</span>
<a href="#l3.1814"></a><span id="l3.1814" class="difflineminus">-                    self.background = struct.unpack('B', data)</span>
<a href="#l3.1815"></a><span id="l3.1815" class="difflineminus">-                else:</span>
<a href="#l3.1816"></a><span id="l3.1816" class="difflineminus">-                    self.background = struct.unpack(&quot;!%dH&quot; % self.color_planes,</span>
<a href="#l3.1817"></a><span id="l3.1817" class="difflineminus">-                      data)</span>
<a href="#l3.1818"></a><span id="l3.1818" class="difflineminus">-            except struct.error:</span>
<a href="#l3.1819"></a><span id="l3.1819" class="difflineminus">-                raise FormatError(&quot;bKGD chunk has incorrect length.&quot;)</span>
<a href="#l3.1820"></a><span id="l3.1820" class="difflineminus">-        elif type == 'tRNS':</span>
<a href="#l3.1821"></a><span id="l3.1821" class="difflineminus">-            # http://www.w3.org/TR/PNG/#11tRNS</span>
<a href="#l3.1822"></a><span id="l3.1822" class="difflineminus">-            self.trns = data</span>
<a href="#l3.1823"></a><span id="l3.1823" class="difflineminus">-            if self.colormap:</span>
<a href="#l3.1824"></a><span id="l3.1824" class="difflineminus">-                if not self.plte:</span>
<a href="#l3.1825"></a><span id="l3.1825" class="difflineminus">-                    warnings.warn(&quot;PLTE chunk is required before tRNS chunk.&quot;)</span>
<a href="#l3.1826"></a><span id="l3.1826" class="difflineminus">-                else:</span>
<a href="#l3.1827"></a><span id="l3.1827" class="difflineminus">-                    if len(data) &gt; len(self.plte)/3:</span>
<a href="#l3.1828"></a><span id="l3.1828" class="difflineminus">-                        # Was warning, but promoted to Error as it</span>
<a href="#l3.1829"></a><span id="l3.1829" class="difflineminus">-                        # would otherwise cause pain later on.</span>
<a href="#l3.1830"></a><span id="l3.1830" class="difflineminus">-                        raise FormatError(&quot;tRNS chunk is too long.&quot;)</span>
<a href="#l3.1831"></a><span id="l3.1831" class="difflineminus">-            else:</span>
<a href="#l3.1832"></a><span id="l3.1832" class="difflineminus">-                if self.alpha:</span>
<a href="#l3.1833"></a><span id="l3.1833" class="difflineminus">-                    raise FormatError(</span>
<a href="#l3.1834"></a><span id="l3.1834" class="difflineminus">-                      &quot;tRNS chunk is not valid with colour type %d.&quot; %</span>
<a href="#l3.1835"></a><span id="l3.1835" class="difflineminus">-                      self.color_type)</span>
<a href="#l3.1836"></a><span id="l3.1836" class="difflineminus">-                try:</span>
<a href="#l3.1837"></a><span id="l3.1837" class="difflineminus">-                    self.transparent = \</span>
<a href="#l3.1838"></a><span id="l3.1838" class="difflineminus">-                        struct.unpack(&quot;!%dH&quot; % self.color_planes, data)</span>
<a href="#l3.1839"></a><span id="l3.1839" class="difflineminus">-                except struct.error:</span>
<a href="#l3.1840"></a><span id="l3.1840" class="difflineminus">-                    raise FormatError(&quot;tRNS chunk has incorrect length.&quot;)</span>
<a href="#l3.1841"></a><span id="l3.1841" class="difflineminus">-        elif type == 'gAMA':</span>
<a href="#l3.1842"></a><span id="l3.1842" class="difflineminus">-            try:</span>
<a href="#l3.1843"></a><span id="l3.1843" class="difflineminus">-                self.gamma = struct.unpack(&quot;!L&quot;, data)[0] / 100000.0</span>
<a href="#l3.1844"></a><span id="l3.1844" class="difflineminus">-            except struct.error:</span>
<a href="#l3.1845"></a><span id="l3.1845" class="difflineminus">-                raise FormatError(&quot;gAMA chunk has incorrect length.&quot;)</span>
<a href="#l3.1846"></a><span id="l3.1846" class="difflineminus">-        elif type == 'sBIT':</span>
<a href="#l3.1847"></a><span id="l3.1847" class="difflineminus">-            self.sbit = data</span>
<a href="#l3.1848"></a><span id="l3.1848" class="difflineminus">-            if (self.colormap and len(data) != 3 or</span>
<a href="#l3.1849"></a><span id="l3.1849" class="difflineminus">-                not self.colormap and len(data) != self.planes):</span>
<a href="#l3.1850"></a><span id="l3.1850" class="difflineminus">-                raise FormatError(&quot;sBIT chunk has incorrect length.&quot;)</span>
<a href="#l3.1851"></a><span id="l3.1851" class="difflineminus">-</span>
<a href="#l3.1852"></a><span id="l3.1852" class="difflineminus">-    def read(self):</span>
<a href="#l3.1853"></a><span id="l3.1853" class="difflineminus">-        &quot;&quot;&quot;</span>
<a href="#l3.1854"></a><span id="l3.1854" class="difflineminus">-        Read the PNG file and decode it.  Returns (`width`, `height`,</span>
<a href="#l3.1855"></a><span id="l3.1855" class="difflineminus">-        `pixels`, `metadata`).</span>
<a href="#l3.1856"></a><span id="l3.1856" class="difflineminus">-</span>
<a href="#l3.1857"></a><span id="l3.1857" class="difflineminus">-        May use excessive memory.</span>
<a href="#l3.1858"></a><span id="l3.1858" class="difflineminus">-</span>
<a href="#l3.1859"></a><span id="l3.1859" class="difflineminus">-        `pixels` are returned in boxed row flat pixel format.</span>
<a href="#l3.1860"></a><span id="l3.1860" class="difflineminus">-        &quot;&quot;&quot;</span>
<a href="#l3.1861"></a><span id="l3.1861" class="difflineminus">-</span>
<a href="#l3.1862"></a><span id="l3.1862" class="difflineminus">-        def iteridat():</span>
<a href="#l3.1863"></a><span id="l3.1863" class="difflineminus">-            &quot;&quot;&quot;Iterator that yields all the ``IDAT`` chunks as strings.&quot;&quot;&quot;</span>
<a href="#l3.1864"></a><span id="l3.1864" class="difflineminus">-            while True:</span>
<a href="#l3.1865"></a><span id="l3.1865" class="difflineminus">-                try:</span>
<a href="#l3.1866"></a><span id="l3.1866" class="difflineminus">-                    type, data = self.chunk()</span>
<a href="#l3.1867"></a><span id="l3.1867" class="difflineminus">-                except ValueError, e:</span>
<a href="#l3.1868"></a><span id="l3.1868" class="difflineminus">-                    raise ChunkError(e.args[0])</span>
<a href="#l3.1869"></a><span id="l3.1869" class="difflineminus">-                if type == 'IEND':</span>
<a href="#l3.1870"></a><span id="l3.1870" class="difflineminus">-                    # http://www.w3.org/TR/PNG/#11IEND</span>
<a href="#l3.1871"></a><span id="l3.1871" class="difflineminus">-                    break</span>
<a href="#l3.1872"></a><span id="l3.1872" class="difflineminus">-                if type != 'IDAT':</span>
<a href="#l3.1873"></a><span id="l3.1873" class="difflineminus">-                    continue</span>
<a href="#l3.1874"></a><span id="l3.1874" class="difflineminus">-                # type == 'IDAT'</span>
<a href="#l3.1875"></a><span id="l3.1875" class="difflineminus">-                # http://www.w3.org/TR/PNG/#11IDAT</span>
<a href="#l3.1876"></a><span id="l3.1876" class="difflineminus">-                if self.colormap and not self.plte:</span>
<a href="#l3.1877"></a><span id="l3.1877" class="difflineminus">-                    warnings.warn(&quot;PLTE chunk is required before IDAT chunk&quot;)</span>
<a href="#l3.1878"></a><span id="l3.1878" class="difflineminus">-                yield data</span>
<a href="#l3.1879"></a><span id="l3.1879" class="difflineminus">-</span>
<a href="#l3.1880"></a><span id="l3.1880" class="difflineminus">-        def iterdecomp(idat):</span>
<a href="#l3.1881"></a><span id="l3.1881" class="difflineminus">-            &quot;&quot;&quot;Iterator that yields decompressed strings.  `idat` should</span>
<a href="#l3.1882"></a><span id="l3.1882" class="difflineminus">-            be an iterator that yields the ``IDAT`` chunk data.</span>
<a href="#l3.1883"></a><span id="l3.1883" class="difflineminus">-            &quot;&quot;&quot;</span>
<a href="#l3.1884"></a><span id="l3.1884" class="difflineminus">-</span>
<a href="#l3.1885"></a><span id="l3.1885" class="difflineminus">-            # Currently, with no max_length parameter to decompress, this</span>
<a href="#l3.1886"></a><span id="l3.1886" class="difflineminus">-            # routine will do one yield per IDAT chunk.  So not very</span>
<a href="#l3.1887"></a><span id="l3.1887" class="difflineminus">-            # incremental.</span>
<a href="#l3.1888"></a><span id="l3.1888" class="difflineminus">-            d = zlib.decompressobj()</span>
<a href="#l3.1889"></a><span id="l3.1889" class="difflineminus">-            # Each IDAT chunk is passed to the decompressor, then any</span>
<a href="#l3.1890"></a><span id="l3.1890" class="difflineminus">-            # remaining state is decompressed out.</span>
<a href="#l3.1891"></a><span id="l3.1891" class="difflineminus">-            for data in idat:</span>
<a href="#l3.1892"></a><span id="l3.1892" class="difflineminus">-                # :todo: add a max_length argument here to limit output</span>
<a href="#l3.1893"></a><span id="l3.1893" class="difflineminus">-                # size.</span>
<a href="#l3.1894"></a><span id="l3.1894" class="difflineminus">-                yield array('B', d.decompress(data))</span>
<a href="#l3.1895"></a><span id="l3.1895" class="difflineminus">-            yield array('B', d.flush())</span>
<a href="#l3.1896"></a><span id="l3.1896" class="difflineminus">-</span>
<a href="#l3.1897"></a><span id="l3.1897" class="difflineminus">-        self.preamble()</span>
<a href="#l3.1898"></a><span id="l3.1898" class="difflineminus">-        raw = iterdecomp(iteridat())</span>
<a href="#l3.1899"></a><span id="l3.1899" class="difflineminus">-</span>
<a href="#l3.1900"></a><span id="l3.1900" class="difflineminus">-        if self.interlace:</span>
<a href="#l3.1901"></a><span id="l3.1901" class="difflineminus">-            raw = array('B', itertools.chain(*raw))</span>
<a href="#l3.1902"></a><span id="l3.1902" class="difflineminus">-            arraycode = 'BH'[self.bitdepth&gt;8]</span>
<a href="#l3.1903"></a><span id="l3.1903" class="difflineminus">-            # Like :meth:`group` but producing an array.array object for</span>
<a href="#l3.1904"></a><span id="l3.1904" class="difflineminus">-            # each row.</span>
<a href="#l3.1905"></a><span id="l3.1905" class="difflineminus">-            pixels = itertools.imap(lambda *row: array(arraycode, row),</span>
<a href="#l3.1906"></a><span id="l3.1906" class="difflineminus">-                       *[iter(self.deinterlace(raw))]*self.width*self.planes)</span>
<a href="#l3.1907"></a><span id="l3.1907" class="difflineminus">-        else:</span>
<a href="#l3.1908"></a><span id="l3.1908" class="difflineminus">-            pixels = self.iterboxed(self.iterstraight(raw))</span>
<a href="#l3.1909"></a><span id="l3.1909" class="difflineminus">-        meta = dict()</span>
<a href="#l3.1910"></a><span id="l3.1910" class="difflineminus">-        for attr in 'greyscale alpha planes bitdepth interlace'.split():</span>
<a href="#l3.1911"></a><span id="l3.1911" class="difflineminus">-            meta[attr] = getattr(self, attr)</span>
<a href="#l3.1912"></a><span id="l3.1912" class="difflineminus">-        meta['size'] = (self.width, self.height)</span>
<a href="#l3.1913"></a><span id="l3.1913" class="difflineminus">-        for attr in 'gamma transparent background'.split():</span>
<a href="#l3.1914"></a><span id="l3.1914" class="difflineminus">-            a = getattr(self, attr, None)</span>
<a href="#l3.1915"></a><span id="l3.1915" class="difflineminus">-            if a is not None:</span>
<a href="#l3.1916"></a><span id="l3.1916" class="difflineminus">-                meta[attr] = a</span>
<a href="#l3.1917"></a><span id="l3.1917" class="difflineminus">-        return self.width, self.height, pixels, meta</span>
<a href="#l3.1918"></a><span id="l3.1918" class="difflineminus">-</span>
<a href="#l3.1919"></a><span id="l3.1919" class="difflineminus">-</span>
<a href="#l3.1920"></a><span id="l3.1920" class="difflineminus">-    def read_flat(self):</span>
<a href="#l3.1921"></a><span id="l3.1921" class="difflineminus">-        &quot;&quot;&quot;</span>
<a href="#l3.1922"></a><span id="l3.1922" class="difflineminus">-        Read a PNG file and decode it into flat row flat pixel format.</span>
<a href="#l3.1923"></a><span id="l3.1923" class="difflineminus">-        Returns (*width*, *height*, *pixels*, *metadata*).</span>
<a href="#l3.1924"></a><span id="l3.1924" class="difflineminus">-</span>
<a href="#l3.1925"></a><span id="l3.1925" class="difflineminus">-        May use excessive memory.</span>
<a href="#l3.1926"></a><span id="l3.1926" class="difflineminus">-</span>
<a href="#l3.1927"></a><span id="l3.1927" class="difflineminus">-        `pixels` are returned in flat row flat pixel format.</span>
<a href="#l3.1928"></a><span id="l3.1928" class="difflineminus">-</span>
<a href="#l3.1929"></a><span id="l3.1929" class="difflineminus">-        See also the :meth:`read` method which returns pixels in the</span>
<a href="#l3.1930"></a><span id="l3.1930" class="difflineminus">-        more stream-friendly boxed row flat pixel format.</span>
<a href="#l3.1931"></a><span id="l3.1931" class="difflineminus">-        &quot;&quot;&quot;</span>
<a href="#l3.1932"></a><span id="l3.1932" class="difflineminus">-</span>
<a href="#l3.1933"></a><span id="l3.1933" class="difflineminus">-        x, y, pixel, meta = self.read()</span>
<a href="#l3.1934"></a><span id="l3.1934" class="difflineminus">-        arraycode = 'BH'[meta['bitdepth']&gt;8]</span>
<a href="#l3.1935"></a><span id="l3.1935" class="difflineminus">-        pixel = array(arraycode, itertools.chain(*pixel))</span>
<a href="#l3.1936"></a><span id="l3.1936" class="difflineminus">-        return x, y, pixel, meta</span>
<a href="#l3.1937"></a><span id="l3.1937" class="difflineminus">-</span>
<a href="#l3.1938"></a><span id="l3.1938" class="difflineminus">-    def palette(self, alpha='natural'):</span>
<a href="#l3.1939"></a><span id="l3.1939" class="difflineminus">-        &quot;&quot;&quot;Returns a palette that is a sequence of 3-tuples or 4-tuples,</span>
<a href="#l3.1940"></a><span id="l3.1940" class="difflineminus">-        synthesizing it from the ``PLTE`` and ``tRNS`` chunks.  These</span>
<a href="#l3.1941"></a><span id="l3.1941" class="difflineminus">-        chunks should have already been processed (for example, by</span>
<a href="#l3.1942"></a><span id="l3.1942" class="difflineminus">-        calling the :meth:`preamble` method).  All the tuples are the</span>
<a href="#l3.1943"></a><span id="l3.1943" class="difflineminus">-        same size: 3-tuples if there is no ``tRNS`` chunk, 4-tuples when</span>
<a href="#l3.1944"></a><span id="l3.1944" class="difflineminus">-        there is a ``tRNS`` chunk.  Assumes that the image is colour type</span>
<a href="#l3.1945"></a><span id="l3.1945" class="difflineminus">-        3 and therefore a ``PLTE`` chunk is required.</span>
<a href="#l3.1946"></a><span id="l3.1946" class="difflineminus">-</span>
<a href="#l3.1947"></a><span id="l3.1947" class="difflineminus">-        If the `alpha` argument is ``'force'`` then an alpha channel is</span>
<a href="#l3.1948"></a><span id="l3.1948" class="difflineminus">-        always added, forcing the result to be a sequence of 4-tuples.</span>
<a href="#l3.1949"></a><span id="l3.1949" class="difflineminus">-        &quot;&quot;&quot;</span>
<a href="#l3.1950"></a><span id="l3.1950" class="difflineminus">-</span>
<a href="#l3.1951"></a><span id="l3.1951" class="difflineminus">-        if not self.plte:</span>
<a href="#l3.1952"></a><span id="l3.1952" class="difflineminus">-            raise FormatError(</span>
<a href="#l3.1953"></a><span id="l3.1953" class="difflineminus">-                &quot;Required PLTE chunk is missing in colour type 3 image.&quot;)</span>
<a href="#l3.1954"></a><span id="l3.1954" class="difflineminus">-        plte = group(array('B', self.plte), 3)</span>
<a href="#l3.1955"></a><span id="l3.1955" class="difflineminus">-        if self.trns or alpha == 'force':</span>
<a href="#l3.1956"></a><span id="l3.1956" class="difflineminus">-            trns = array('B', self.trns or '')</span>
<a href="#l3.1957"></a><span id="l3.1957" class="difflineminus">-            trns.extend([255]*(len(plte)-len(trns)))</span>
<a href="#l3.1958"></a><span id="l3.1958" class="difflineminus">-            plte = map(operator.add, plte, group(trns, 1))</span>
<a href="#l3.1959"></a><span id="l3.1959" class="difflineminus">-        return plte</span>
<a href="#l3.1960"></a><span id="l3.1960" class="difflineminus">-</span>
<a href="#l3.1961"></a><span id="l3.1961" class="difflineminus">-    def asDirect(self):</span>
<a href="#l3.1962"></a><span id="l3.1962" class="difflineminus">-        &quot;&quot;&quot;Returns the image data as a direct representation of an</span>
<a href="#l3.1963"></a><span id="l3.1963" class="difflineminus">-        ``x * y * planes`` array.  This method is intended to remove the</span>
<a href="#l3.1964"></a><span id="l3.1964" class="difflineminus">-        need for callers to deal with palettes and transparency</span>
<a href="#l3.1965"></a><span id="l3.1965" class="difflineminus">-        themselves.  Images with a palette (colour type 3)</span>
<a href="#l3.1966"></a><span id="l3.1966" class="difflineminus">-        are converted to RGB or RGBA; images with transparency (a</span>
<a href="#l3.1967"></a><span id="l3.1967" class="difflineminus">-        ``tRNS`` chunk) are converted to LA or RGBA as appropriate.</span>
<a href="#l3.1968"></a><span id="l3.1968" class="difflineminus">-        When returned in this format the pixel values represent the</span>
<a href="#l3.1969"></a><span id="l3.1969" class="difflineminus">-        colour value directly without needing to refer to palettes or</span>
<a href="#l3.1970"></a><span id="l3.1970" class="difflineminus">-        transparency information.</span>
<a href="#l3.1971"></a><span id="l3.1971" class="difflineminus">-</span>
<a href="#l3.1972"></a><span id="l3.1972" class="difflineminus">-        Like the :meth:`read` method this method returns a 4-tuple:</span>
<a href="#l3.1973"></a><span id="l3.1973" class="difflineminus">-</span>
<a href="#l3.1974"></a><span id="l3.1974" class="difflineminus">-        (*width*, *height*, *pixels*, *meta*)</span>
<a href="#l3.1975"></a><span id="l3.1975" class="difflineminus">-</span>
<a href="#l3.1976"></a><span id="l3.1976" class="difflineminus">-        This method normally returns pixel values with the bit depth</span>
<a href="#l3.1977"></a><span id="l3.1977" class="difflineminus">-        they have in the source image, but when the source PNG has an</span>
<a href="#l3.1978"></a><span id="l3.1978" class="difflineminus">-        ``sBIT`` chunk it is inspected and can reduce the bit depth of</span>
<a href="#l3.1979"></a><span id="l3.1979" class="difflineminus">-        the result pixels; pixel values will be reduced according to</span>
<a href="#l3.1980"></a><span id="l3.1980" class="difflineminus">-        the bit depth specified in the ``sBIT`` chunk (PNG nerds should</span>
<a href="#l3.1981"></a><span id="l3.1981" class="difflineminus">-        note a single result bit depth is used for all channels; the</span>
<a href="#l3.1982"></a><span id="l3.1982" class="difflineminus">-        maximum of the ones specified in the ``sBIT`` chunk.  An RGB565</span>
<a href="#l3.1983"></a><span id="l3.1983" class="difflineminus">-        image will be rescaled to 6-bit RGB666).</span>
<a href="#l3.1984"></a><span id="l3.1984" class="difflineminus">-</span>
<a href="#l3.1985"></a><span id="l3.1985" class="difflineminus">-        The *meta* dictionary that is returned reflects the `direct`</span>
<a href="#l3.1986"></a><span id="l3.1986" class="difflineminus">-        format and not the original source image.  For example, an RGB</span>
<a href="#l3.1987"></a><span id="l3.1987" class="difflineminus">-        source image with a ``tRNS`` chunk to represent a transparent</span>
<a href="#l3.1988"></a><span id="l3.1988" class="difflineminus">-        colour, will have ``planes=3`` and ``alpha=False`` for the</span>
<a href="#l3.1989"></a><span id="l3.1989" class="difflineminus">-        source image, but the *meta* dictionary returned by this method</span>
<a href="#l3.1990"></a><span id="l3.1990" class="difflineminus">-        will have ``planes=4`` and ``alpha=True`` because an alpha</span>
<a href="#l3.1991"></a><span id="l3.1991" class="difflineminus">-        channel is synthesized and added.</span>
<a href="#l3.1992"></a><span id="l3.1992" class="difflineminus">-</span>
<a href="#l3.1993"></a><span id="l3.1993" class="difflineminus">-        *pixels* is the pixel data in boxed row flat pixel format (just</span>
<a href="#l3.1994"></a><span id="l3.1994" class="difflineminus">-        like the :meth:`read` method).</span>
<a href="#l3.1995"></a><span id="l3.1995" class="difflineminus">-</span>
<a href="#l3.1996"></a><span id="l3.1996" class="difflineminus">-        All the other aspects of the image data are not changed.</span>
<a href="#l3.1997"></a><span id="l3.1997" class="difflineminus">-        &quot;&quot;&quot;</span>
<a href="#l3.1998"></a><span id="l3.1998" class="difflineminus">-</span>
<a href="#l3.1999"></a><span id="l3.1999" class="difflineminus">-        self.preamble()</span>
<a href="#l3.2000"></a><span id="l3.2000" class="difflineminus">-</span>
<a href="#l3.2001"></a><span id="l3.2001" class="difflineminus">-        # Simple case, no conversion necessary.</span>
<a href="#l3.2002"></a><span id="l3.2002" class="difflineminus">-        if not self.colormap and not self.trns and not self.sbit:</span>
<a href="#l3.2003"></a><span id="l3.2003" class="difflineminus">-            return self.read()</span>
<a href="#l3.2004"></a><span id="l3.2004" class="difflineminus">-</span>
<a href="#l3.2005"></a><span id="l3.2005" class="difflineminus">-        x,y,pixels,meta = self.read()</span>
<a href="#l3.2006"></a><span id="l3.2006" class="difflineminus">-</span>
<a href="#l3.2007"></a><span id="l3.2007" class="difflineminus">-        if self.colormap:</span>
<a href="#l3.2008"></a><span id="l3.2008" class="difflineminus">-            meta['colormap'] = False</span>
<a href="#l3.2009"></a><span id="l3.2009" class="difflineminus">-            meta['alpha'] = bool(self.trns)</span>
<a href="#l3.2010"></a><span id="l3.2010" class="difflineminus">-            meta['bitdepth'] = 8</span>
<a href="#l3.2011"></a><span id="l3.2011" class="difflineminus">-            meta['planes'] = 3 + bool(self.trns)</span>
<a href="#l3.2012"></a><span id="l3.2012" class="difflineminus">-            plte = self.palette()</span>
<a href="#l3.2013"></a><span id="l3.2013" class="difflineminus">-            def iterpal(pixels):</span>
<a href="#l3.2014"></a><span id="l3.2014" class="difflineminus">-                for row in pixels:</span>
<a href="#l3.2015"></a><span id="l3.2015" class="difflineminus">-                    row = map(plte.__getitem__, row)</span>
<a href="#l3.2016"></a><span id="l3.2016" class="difflineminus">-                    yield array('B', itertools.chain(*row))</span>
<a href="#l3.2017"></a><span id="l3.2017" class="difflineminus">-            pixels = iterpal(pixels)</span>
<a href="#l3.2018"></a><span id="l3.2018" class="difflineminus">-        elif self.trns:</span>
<a href="#l3.2019"></a><span id="l3.2019" class="difflineminus">-            # It would be nice if there was some reasonable way of doing</span>
<a href="#l3.2020"></a><span id="l3.2020" class="difflineminus">-            # this without generating a whole load of intermediate tuples.</span>
<a href="#l3.2021"></a><span id="l3.2021" class="difflineminus">-            # But tuples does seem like the easiest way, with no other way</span>
<a href="#l3.2022"></a><span id="l3.2022" class="difflineminus">-            # clearly much simpler or much faster.  (Actually, the L to LA</span>
<a href="#l3.2023"></a><span id="l3.2023" class="difflineminus">-            # conversion could perhaps go faster (all those 1-tuples!), but</span>
<a href="#l3.2024"></a><span id="l3.2024" class="difflineminus">-            # I still wonder whether the code proliferation is worth it)</span>
<a href="#l3.2025"></a><span id="l3.2025" class="difflineminus">-            it = self.transparent</span>
<a href="#l3.2026"></a><span id="l3.2026" class="difflineminus">-            maxval = 2**meta['bitdepth']-1</span>
<a href="#l3.2027"></a><span id="l3.2027" class="difflineminus">-            planes = meta['planes']</span>
<a href="#l3.2028"></a><span id="l3.2028" class="difflineminus">-            meta['alpha'] = True</span>
<a href="#l3.2029"></a><span id="l3.2029" class="difflineminus">-            meta['planes'] += 1</span>
<a href="#l3.2030"></a><span id="l3.2030" class="difflineminus">-            typecode = 'BH'[meta['bitdepth']&gt;8]</span>
<a href="#l3.2031"></a><span id="l3.2031" class="difflineminus">-            def itertrns(pixels):</span>
<a href="#l3.2032"></a><span id="l3.2032" class="difflineminus">-                for row in pixels:</span>
<a href="#l3.2033"></a><span id="l3.2033" class="difflineminus">-                    # For each row we group it into pixels, then form a</span>
<a href="#l3.2034"></a><span id="l3.2034" class="difflineminus">-                    # characterisation vector that says whether each pixel</span>
<a href="#l3.2035"></a><span id="l3.2035" class="difflineminus">-                    # is opaque or not.  Then we convert True/False to</span>
<a href="#l3.2036"></a><span id="l3.2036" class="difflineminus">-                    # 0/maxval (by multiplication), and add it as the extra</span>
<a href="#l3.2037"></a><span id="l3.2037" class="difflineminus">-                    # channel.</span>
<a href="#l3.2038"></a><span id="l3.2038" class="difflineminus">-                    row = group(row, planes)</span>
<a href="#l3.2039"></a><span id="l3.2039" class="difflineminus">-                    opa = map(it.__ne__, row)</span>
<a href="#l3.2040"></a><span id="l3.2040" class="difflineminus">-                    opa = map(maxval.__mul__, opa)</span>
<a href="#l3.2041"></a><span id="l3.2041" class="difflineminus">-                    opa = zip(opa) # convert to 1-tuples</span>
<a href="#l3.2042"></a><span id="l3.2042" class="difflineminus">-                    yield array(typecode,</span>
<a href="#l3.2043"></a><span id="l3.2043" class="difflineminus">-                      itertools.chain(*map(operator.add, row, opa)))</span>
<a href="#l3.2044"></a><span id="l3.2044" class="difflineminus">-            pixels = itertrns(pixels)</span>
<a href="#l3.2045"></a><span id="l3.2045" class="difflineminus">-        targetbitdepth = None</span>
<a href="#l3.2046"></a><span id="l3.2046" class="difflineminus">-        if self.sbit:</span>
<a href="#l3.2047"></a><span id="l3.2047" class="difflineminus">-            sbit = struct.unpack('%dB' % len(self.sbit), self.sbit)</span>
<a href="#l3.2048"></a><span id="l3.2048" class="difflineminus">-            targetbitdepth = max(sbit)</span>
<a href="#l3.2049"></a><span id="l3.2049" class="difflineminus">-            if targetbitdepth &gt; meta['bitdepth']:</span>
<a href="#l3.2050"></a><span id="l3.2050" class="difflineminus">-                raise Error('sBIT chunk %r exceeds bitdepth %d' %</span>
<a href="#l3.2051"></a><span id="l3.2051" class="difflineminus">-                    (sbit,self.bitdepth))</span>
<a href="#l3.2052"></a><span id="l3.2052" class="difflineminus">-            if min(sbit) &lt;= 0:</span>
<a href="#l3.2053"></a><span id="l3.2053" class="difflineminus">-                raise Error('sBIT chunk %r has a 0-entry' % sbit)</span>
<a href="#l3.2054"></a><span id="l3.2054" class="difflineminus">-            if targetbitdepth == meta['bitdepth']:</span>
<a href="#l3.2055"></a><span id="l3.2055" class="difflineminus">-                targetbitdepth = None</span>
<a href="#l3.2056"></a><span id="l3.2056" class="difflineminus">-        if targetbitdepth:</span>
<a href="#l3.2057"></a><span id="l3.2057" class="difflineminus">-            shift = meta['bitdepth'] - targetbitdepth</span>
<a href="#l3.2058"></a><span id="l3.2058" class="difflineminus">-            meta['bitdepth'] = targetbitdepth</span>
<a href="#l3.2059"></a><span id="l3.2059" class="difflineminus">-            def itershift(pixels):</span>
<a href="#l3.2060"></a><span id="l3.2060" class="difflineminus">-                for row in pixels:</span>
<a href="#l3.2061"></a><span id="l3.2061" class="difflineminus">-                    yield map(shift.__rrshift__, row)</span>
<a href="#l3.2062"></a><span id="l3.2062" class="difflineminus">-            pixels = itershift(pixels)</span>
<a href="#l3.2063"></a><span id="l3.2063" class="difflineminus">-        return x,y,pixels,meta</span>
<a href="#l3.2064"></a><span id="l3.2064" class="difflineminus">-</span>
<a href="#l3.2065"></a><span id="l3.2065" class="difflineminus">-    def asFloat(self, maxval=1.0):</span>
<a href="#l3.2066"></a><span id="l3.2066" class="difflineminus">-        &quot;&quot;&quot;Return image pixels as per :meth:`asDirect` method, but scale</span>
<a href="#l3.2067"></a><span id="l3.2067" class="difflineminus">-        all pixel values to be floating point values between 0.0 and</span>
<a href="#l3.2068"></a><span id="l3.2068" class="difflineminus">-        *maxval*.</span>
<a href="#l3.2069"></a><span id="l3.2069" class="difflineminus">-        &quot;&quot;&quot;</span>
<a href="#l3.2070"></a><span id="l3.2070" class="difflineminus">-</span>
<a href="#l3.2071"></a><span id="l3.2071" class="difflineminus">-        x,y,pixels,info = self.asDirect()</span>
<a href="#l3.2072"></a><span id="l3.2072" class="difflineminus">-        sourcemaxval = 2**info['bitdepth']-1</span>
<a href="#l3.2073"></a><span id="l3.2073" class="difflineminus">-        del info['bitdepth']</span>
<a href="#l3.2074"></a><span id="l3.2074" class="difflineminus">-        info['maxval'] = float(maxval)</span>
<a href="#l3.2075"></a><span id="l3.2075" class="difflineminus">-        factor = float(maxval)/float(sourcemaxval)</span>
<a href="#l3.2076"></a><span id="l3.2076" class="difflineminus">-        def iterfloat():</span>
<a href="#l3.2077"></a><span id="l3.2077" class="difflineminus">-            for row in pixels:</span>
<a href="#l3.2078"></a><span id="l3.2078" class="difflineminus">-                yield map(factor.__mul__, row)</span>
<a href="#l3.2079"></a><span id="l3.2079" class="difflineminus">-        return x,y,iterfloat(),info</span>
<a href="#l3.2080"></a><span id="l3.2080" class="difflineminus">-</span>
<a href="#l3.2081"></a><span id="l3.2081" class="difflineminus">-    def _as_rescale(self, get, targetbitdepth):</span>
<a href="#l3.2082"></a><span id="l3.2082" class="difflineminus">-        &quot;&quot;&quot;Helper used by :meth:`asRGB8` and :meth:`asRGBA8`.&quot;&quot;&quot;</span>
<a href="#l3.2083"></a><span id="l3.2083" class="difflineminus">-</span>
<a href="#l3.2084"></a><span id="l3.2084" class="difflineminus">-        width,height,pixels,meta = get()</span>
<a href="#l3.2085"></a><span id="l3.2085" class="difflineminus">-        maxval = 2**meta['bitdepth'] - 1</span>
<a href="#l3.2086"></a><span id="l3.2086" class="difflineminus">-        targetmaxval = 2**targetbitdepth - 1</span>
<a href="#l3.2087"></a><span id="l3.2087" class="difflineminus">-        factor = float(targetmaxval) / float(maxval)</span>
<a href="#l3.2088"></a><span id="l3.2088" class="difflineminus">-        meta['bitdepth'] = targetbitdepth</span>
<a href="#l3.2089"></a><span id="l3.2089" class="difflineminus">-        def iterscale():</span>
<a href="#l3.2090"></a><span id="l3.2090" class="difflineminus">-            for row in pixels:</span>
<a href="#l3.2091"></a><span id="l3.2091" class="difflineminus">-                yield map(lambda x: int(round(x*factor)), row)</span>
<a href="#l3.2092"></a><span id="l3.2092" class="difflineminus">-        return width, height, iterscale(), meta</span>
<a href="#l3.2093"></a><span id="l3.2093" class="difflineminus">-</span>
<a href="#l3.2094"></a><span id="l3.2094" class="difflineminus">-    def asRGB8(self):</span>
<a href="#l3.2095"></a><span id="l3.2095" class="difflineminus">-        &quot;&quot;&quot;Return the image data as an RGB pixels with 8-bits per</span>
<a href="#l3.2096"></a><span id="l3.2096" class="difflineminus">-        sample.  This is like the :meth:`asRGB` method except that</span>
<a href="#l3.2097"></a><span id="l3.2097" class="difflineminus">-        this method additionally rescales the values so that they</span>
<a href="#l3.2098"></a><span id="l3.2098" class="difflineminus">-        are all between 0 and 255 (8-bit).  In the case where the</span>
<a href="#l3.2099"></a><span id="l3.2099" class="difflineminus">-        source image has a bit depth &lt; 8 the transformation preserves</span>
<a href="#l3.2100"></a><span id="l3.2100" class="difflineminus">-        all the information; where the source image has bit depth</span>
<a href="#l3.2101"></a><span id="l3.2101" class="difflineminus">-        &gt; 8, then rescaling to 8-bit values loses precision.  No</span>
<a href="#l3.2102"></a><span id="l3.2102" class="difflineminus">-        dithering is performed.  Like :meth:`asRGB`, an alpha channel</span>
<a href="#l3.2103"></a><span id="l3.2103" class="difflineminus">-        in the source image will raise an exception.</span>
<a href="#l3.2104"></a><span id="l3.2104" class="difflineminus">-</span>
<a href="#l3.2105"></a><span id="l3.2105" class="difflineminus">-        This function returns a 4-tuple:</span>
<a href="#l3.2106"></a><span id="l3.2106" class="difflineminus">-        (*width*, *height*, *pixels*, *metadata*).</span>
<a href="#l3.2107"></a><span id="l3.2107" class="difflineminus">-        *width*, *height*, *metadata* are as per the :meth:`read` method.</span>
<a href="#l3.2108"></a><span id="l3.2108" class="difflineminus">-        </span>
<a href="#l3.2109"></a><span id="l3.2109" class="difflineminus">-        *pixels* is the pixel data in boxed row flat pixel format.</span>
<a href="#l3.2110"></a><span id="l3.2110" class="difflineminus">-        &quot;&quot;&quot;</span>
<a href="#l3.2111"></a><span id="l3.2111" class="difflineminus">-</span>
<a href="#l3.2112"></a><span id="l3.2112" class="difflineminus">-        return self._as_rescale(self.asRGB, 8)</span>
<a href="#l3.2113"></a><span id="l3.2113" class="difflineminus">-</span>
<a href="#l3.2114"></a><span id="l3.2114" class="difflineminus">-    def asRGBA8(self):</span>
<a href="#l3.2115"></a><span id="l3.2115" class="difflineminus">-        &quot;&quot;&quot;Return the image data as RGBA pixels with 8-bits per</span>
<a href="#l3.2116"></a><span id="l3.2116" class="difflineminus">-        sample.  This method is similar to :meth:`asRGB8` and</span>
<a href="#l3.2117"></a><span id="l3.2117" class="difflineminus">-        :meth:`asRGBA`:  The result pixels have an alpha channel, *and*</span>
<a href="#l3.2118"></a><span id="l3.2118" class="difflineminus">-        values are rescaled to the range 0 to 255.  The alpha channel is</span>
<a href="#l3.2119"></a><span id="l3.2119" class="difflineminus">-        synthesized if necessary (with a small speed penalty).</span>
<a href="#l3.2120"></a><span id="l3.2120" class="difflineminus">-        &quot;&quot;&quot;</span>
<a href="#l3.2121"></a><span id="l3.2121" class="difflineminus">-</span>
<a href="#l3.2122"></a><span id="l3.2122" class="difflineminus">-        return self._as_rescale(self.asRGBA, 8)</span>
<a href="#l3.2123"></a><span id="l3.2123" class="difflineminus">-</span>
<a href="#l3.2124"></a><span id="l3.2124" class="difflineminus">-    def asRGB(self):</span>
<a href="#l3.2125"></a><span id="l3.2125" class="difflineminus">-        &quot;&quot;&quot;Return image as RGB pixels.  RGB colour images are passed</span>
<a href="#l3.2126"></a><span id="l3.2126" class="difflineminus">-        through unchanged; greyscales are expanded into RGB</span>
<a href="#l3.2127"></a><span id="l3.2127" class="difflineminus">-        triplets (there is a small speed overhead for doing this).</span>
<a href="#l3.2128"></a><span id="l3.2128" class="difflineminus">-</span>
<a href="#l3.2129"></a><span id="l3.2129" class="difflineminus">-        An alpha channel in the source image will raise an</span>
<a href="#l3.2130"></a><span id="l3.2130" class="difflineminus">-        exception.</span>
<a href="#l3.2131"></a><span id="l3.2131" class="difflineminus">-</span>
<a href="#l3.2132"></a><span id="l3.2132" class="difflineminus">-        The return values are as for the :meth:`read` method</span>
<a href="#l3.2133"></a><span id="l3.2133" class="difflineminus">-        except that the *metadata* reflect the returned pixels, not the</span>
<a href="#l3.2134"></a><span id="l3.2134" class="difflineminus">-        source image.  In particular, for this method</span>
<a href="#l3.2135"></a><span id="l3.2135" class="difflineminus">-        ``metadata['greyscale']`` will be ``False``.</span>
<a href="#l3.2136"></a><span id="l3.2136" class="difflineminus">-        &quot;&quot;&quot;</span>
<a href="#l3.2137"></a><span id="l3.2137" class="difflineminus">-</span>
<a href="#l3.2138"></a><span id="l3.2138" class="difflineminus">-        width,height,pixels,meta = self.asDirect()</span>
<a href="#l3.2139"></a><span id="l3.2139" class="difflineminus">-        if meta['alpha']:</span>
<a href="#l3.2140"></a><span id="l3.2140" class="difflineminus">-            raise Error(&quot;will not convert image with alpha channel to RGB&quot;)</span>
<a href="#l3.2141"></a><span id="l3.2141" class="difflineminus">-        if not meta['greyscale']:</span>
<a href="#l3.2142"></a><span id="l3.2142" class="difflineminus">-            return width,height,pixels,meta</span>
<a href="#l3.2143"></a><span id="l3.2143" class="difflineminus">-        meta['greyscale'] = False</span>
<a href="#l3.2144"></a><span id="l3.2144" class="difflineminus">-        typecode = 'BH'[meta['bitdepth'] &gt; 8]</span>
<a href="#l3.2145"></a><span id="l3.2145" class="difflineminus">-        def iterrgb():</span>
<a href="#l3.2146"></a><span id="l3.2146" class="difflineminus">-            for row in pixels:</span>
<a href="#l3.2147"></a><span id="l3.2147" class="difflineminus">-                a = array(typecode, [0]) * 3 * width</span>
<a href="#l3.2148"></a><span id="l3.2148" class="difflineminus">-                for i in range(3):</span>
<a href="#l3.2149"></a><span id="l3.2149" class="difflineminus">-                    a[i::3] = row</span>
<a href="#l3.2150"></a><span id="l3.2150" class="difflineminus">-                yield a</span>
<a href="#l3.2151"></a><span id="l3.2151" class="difflineminus">-        return width,height,iterrgb(),meta</span>
<a href="#l3.2152"></a><span id="l3.2152" class="difflineminus">-</span>
<a href="#l3.2153"></a><span id="l3.2153" class="difflineminus">-    def asRGBA(self):</span>
<a href="#l3.2154"></a><span id="l3.2154" class="difflineminus">-        &quot;&quot;&quot;Return image as RGBA pixels.  Greyscales are expanded into</span>
<a href="#l3.2155"></a><span id="l3.2155" class="difflineminus">-        RGB triplets; an alpha channel is synthesized if necessary.</span>
<a href="#l3.2156"></a><span id="l3.2156" class="difflineminus">-        The return values are as for the :meth:`read` method</span>
<a href="#l3.2157"></a><span id="l3.2157" class="difflineminus">-        except that the *metadata* reflect the returned pixels, not the</span>
<a href="#l3.2158"></a><span id="l3.2158" class="difflineminus">-        source image.  In particular, for this method</span>
<a href="#l3.2159"></a><span id="l3.2159" class="difflineminus">-        ``metadata['greyscale']`` will be ``False``, and</span>
<a href="#l3.2160"></a><span id="l3.2160" class="difflineminus">-        ``metadata['alpha']`` will be ``True``.</span>
<a href="#l3.2161"></a><span id="l3.2161" class="difflineminus">-        &quot;&quot;&quot;</span>
<a href="#l3.2162"></a><span id="l3.2162" class="difflineminus">-</span>
<a href="#l3.2163"></a><span id="l3.2163" class="difflineminus">-        width,height,pixels,meta = self.asDirect()</span>
<a href="#l3.2164"></a><span id="l3.2164" class="difflineminus">-        if meta['alpha'] and not meta['greyscale']:</span>
<a href="#l3.2165"></a><span id="l3.2165" class="difflineminus">-            return width,height,pixels,meta</span>
<a href="#l3.2166"></a><span id="l3.2166" class="difflineminus">-        typecode = 'BH'[meta['bitdepth'] &gt; 8]</span>
<a href="#l3.2167"></a><span id="l3.2167" class="difflineminus">-        maxval = 2**meta['bitdepth'] - 1</span>
<a href="#l3.2168"></a><span id="l3.2168" class="difflineminus">-        def newarray():</span>
<a href="#l3.2169"></a><span id="l3.2169" class="difflineminus">-            return array(typecode, [0]) * 4 * width</span>
<a href="#l3.2170"></a><span id="l3.2170" class="difflineminus">-        if meta['alpha'] and meta['greyscale']:</span>
<a href="#l3.2171"></a><span id="l3.2171" class="difflineminus">-            # LA to RGBA</span>
<a href="#l3.2172"></a><span id="l3.2172" class="difflineminus">-            def convert():</span>
<a href="#l3.2173"></a><span id="l3.2173" class="difflineminus">-                for row in pixels:</span>
<a href="#l3.2174"></a><span id="l3.2174" class="difflineminus">-                    # Create a fresh target row, then copy L channel</span>
<a href="#l3.2175"></a><span id="l3.2175" class="difflineminus">-                    # into first three target channels, and A channel</span>
<a href="#l3.2176"></a><span id="l3.2176" class="difflineminus">-                    # into fourth channel.</span>
<a href="#l3.2177"></a><span id="l3.2177" class="difflineminus">-                    a = newarray()</span>
<a href="#l3.2178"></a><span id="l3.2178" class="difflineminus">-                    for i in range(3):</span>
<a href="#l3.2179"></a><span id="l3.2179" class="difflineminus">-                        a[i::4] = row[0::2]</span>
<a href="#l3.2180"></a><span id="l3.2180" class="difflineminus">-                    a[3::4] = row[1::2]</span>
<a href="#l3.2181"></a><span id="l3.2181" class="difflineminus">-                    yield a</span>
<a href="#l3.2182"></a><span id="l3.2182" class="difflineminus">-        elif meta['greyscale']:</span>
<a href="#l3.2183"></a><span id="l3.2183" class="difflineminus">-            # L to RGBA</span>
<a href="#l3.2184"></a><span id="l3.2184" class="difflineminus">-            def convert():</span>
<a href="#l3.2185"></a><span id="l3.2185" class="difflineminus">-                for row in pixels:</span>
<a href="#l3.2186"></a><span id="l3.2186" class="difflineminus">-                    a = newarray()</span>
<a href="#l3.2187"></a><span id="l3.2187" class="difflineminus">-                    for i in range(3):</span>
<a href="#l3.2188"></a><span id="l3.2188" class="difflineminus">-                        a[i::4] = row</span>
<a href="#l3.2189"></a><span id="l3.2189" class="difflineminus">-                    a[3::4] = array(typecode, [maxval]) * width</span>
<a href="#l3.2190"></a><span id="l3.2190" class="difflineminus">-                    yield a</span>
<a href="#l3.2191"></a><span id="l3.2191" class="difflineminus">-        else:</span>
<a href="#l3.2192"></a><span id="l3.2192" class="difflineminus">-            assert not meta['alpha'] and not meta['greyscale']</span>
<a href="#l3.2193"></a><span id="l3.2193" class="difflineminus">-            # RGB to RGBA</span>
<a href="#l3.2194"></a><span id="l3.2194" class="difflineminus">-            def convert():</span>
<a href="#l3.2195"></a><span id="l3.2195" class="difflineminus">-                for row in pixels:</span>
<a href="#l3.2196"></a><span id="l3.2196" class="difflineminus">-                    a = newarray()</span>
<a href="#l3.2197"></a><span id="l3.2197" class="difflineminus">-                    for i in range(3):</span>
<a href="#l3.2198"></a><span id="l3.2198" class="difflineminus">-                        a[i::4] = row[i::3]</span>
<a href="#l3.2199"></a><span id="l3.2199" class="difflineminus">-                    a[3::4] = array(typecode, [maxval]) * width</span>
<a href="#l3.2200"></a><span id="l3.2200" class="difflineminus">-                    yield a</span>
<a href="#l3.2201"></a><span id="l3.2201" class="difflineminus">-        meta['alpha'] = True</span>
<a href="#l3.2202"></a><span id="l3.2202" class="difflineminus">-        meta['greyscale'] = False</span>
<a href="#l3.2203"></a><span id="l3.2203" class="difflineminus">-        return width,height,convert(),meta</span>
<a href="#l3.2204"></a><span id="l3.2204" class="difflineminus">-</span>
<a href="#l3.2205"></a><span id="l3.2205" class="difflineminus">-</span>
<a href="#l3.2206"></a><span id="l3.2206" class="difflineminus">-# === Legacy Version Support ===</span>
<a href="#l3.2207"></a><span id="l3.2207" class="difflineminus">-</span>
<a href="#l3.2208"></a><span id="l3.2208" class="difflineminus">-# :pyver:old:  PyPNG works on Python versions 2.3 and 2.2, but not</span>
<a href="#l3.2209"></a><span id="l3.2209" class="difflineminus">-# without some awkward problems.  Really PyPNG works on Python 2.4 (and</span>
<a href="#l3.2210"></a><span id="l3.2210" class="difflineminus">-# above); it works on Pythons 2.3 and 2.2 by virtue of fixing up</span>
<a href="#l3.2211"></a><span id="l3.2211" class="difflineminus">-# problems here.  It's a bit ugly (which is why it's hidden down here).</span>
<a href="#l3.2212"></a><span id="l3.2212" class="difflineminus">-#</span>
<a href="#l3.2213"></a><span id="l3.2213" class="difflineminus">-# Generally the strategy is one of pretending that we're running on</span>
<a href="#l3.2214"></a><span id="l3.2214" class="difflineminus">-# Python 2.4 (or above), and patching up the library support on earlier</span>
<a href="#l3.2215"></a><span id="l3.2215" class="difflineminus">-# versions so that it looks enough like Python 2.4.  When it comes to</span>
<a href="#l3.2216"></a><span id="l3.2216" class="difflineminus">-# Python 2.2 there is one thing we cannot patch: extended slices</span>
<a href="#l3.2217"></a><span id="l3.2217" class="difflineminus">-# http://www.python.org/doc/2.3/whatsnew/section-slices.html.</span>
<a href="#l3.2218"></a><span id="l3.2218" class="difflineminus">-# Instead we simply declare that features that are implemented using</span>
<a href="#l3.2219"></a><span id="l3.2219" class="difflineminus">-# extended slices will not work on Python 2.2.</span>
<a href="#l3.2220"></a><span id="l3.2220" class="difflineminus">-#</span>
<a href="#l3.2221"></a><span id="l3.2221" class="difflineminus">-# In order to work on Python 2.3 we fix up a recurring annoyance involving</span>
<a href="#l3.2222"></a><span id="l3.2222" class="difflineminus">-# the array type.  In Python 2.3 an array cannot be initialised with an</span>
<a href="#l3.2223"></a><span id="l3.2223" class="difflineminus">-# array, and it cannot be extended with a list (or other sequence).</span>
<a href="#l3.2224"></a><span id="l3.2224" class="difflineminus">-# Both of those are repeated issues in the code.  Whilst I would not</span>
<a href="#l3.2225"></a><span id="l3.2225" class="difflineminus">-# normally tolerate this sort of behaviour, here we &quot;shim&quot; a replacement</span>
<a href="#l3.2226"></a><span id="l3.2226" class="difflineminus">-# for array into place (and hope no-ones notices).  You never read this.</span>
<a href="#l3.2227"></a><span id="l3.2227" class="difflineminus">-#</span>
<a href="#l3.2228"></a><span id="l3.2228" class="difflineminus">-# In an amusing case of warty hacks on top of warty hacks... the array</span>
<a href="#l3.2229"></a><span id="l3.2229" class="difflineminus">-# shimming we try and do only works on Python 2.3 and above (you can't</span>
<a href="#l3.2230"></a><span id="l3.2230" class="difflineminus">-# subclass array.array in Python 2.2).  So to get it working on Python</span>
<a href="#l3.2231"></a><span id="l3.2231" class="difflineminus">-# 2.2 we go for something much simpler and (probably) way slower.</span>
<a href="#l3.2232"></a><span id="l3.2232" class="difflineminus">-try:</span>
<a href="#l3.2233"></a><span id="l3.2233" class="difflineminus">-    array('B').extend([])</span>
<a href="#l3.2234"></a><span id="l3.2234" class="difflineminus">-    array('B', array('B'))</span>
<a href="#l3.2235"></a><span id="l3.2235" class="difflineminus">-except:</span>
<a href="#l3.2236"></a><span id="l3.2236" class="difflineminus">-    # Expect to get here on Python 2.3</span>
<a href="#l3.2237"></a><span id="l3.2237" class="difflineminus">-    try:</span>
<a href="#l3.2238"></a><span id="l3.2238" class="difflineminus">-        class _array_shim(array):</span>
<a href="#l3.2239"></a><span id="l3.2239" class="difflineminus">-            true_array = array</span>
<a href="#l3.2240"></a><span id="l3.2240" class="difflineminus">-            def __new__(cls, typecode, init=None):</span>
<a href="#l3.2241"></a><span id="l3.2241" class="difflineminus">-                super_new = super(_array_shim, cls).__new__</span>
<a href="#l3.2242"></a><span id="l3.2242" class="difflineminus">-                it = super_new(cls, typecode)</span>
<a href="#l3.2243"></a><span id="l3.2243" class="difflineminus">-                if init is None:</span>
<a href="#l3.2244"></a><span id="l3.2244" class="difflineminus">-                    return it</span>
<a href="#l3.2245"></a><span id="l3.2245" class="difflineminus">-                it.extend(init)</span>
<a href="#l3.2246"></a><span id="l3.2246" class="difflineminus">-                return it</span>
<a href="#l3.2247"></a><span id="l3.2247" class="difflineminus">-            def extend(self, extension):</span>
<a href="#l3.2248"></a><span id="l3.2248" class="difflineminus">-                super_extend = super(_array_shim, self).extend</span>
<a href="#l3.2249"></a><span id="l3.2249" class="difflineminus">-                if isinstance(extension, self.true_array):</span>
<a href="#l3.2250"></a><span id="l3.2250" class="difflineminus">-                    return super_extend(extension)</span>
<a href="#l3.2251"></a><span id="l3.2251" class="difflineminus">-                if not isinstance(extension, (list, str)):</span>
<a href="#l3.2252"></a><span id="l3.2252" class="difflineminus">-                    # Convert to list.  Allows iterators to work.</span>
<a href="#l3.2253"></a><span id="l3.2253" class="difflineminus">-                    extension = list(extension)</span>
<a href="#l3.2254"></a><span id="l3.2254" class="difflineminus">-                return super_extend(self.true_array(self.typecode, extension))</span>
<a href="#l3.2255"></a><span id="l3.2255" class="difflineminus">-        array = _array_shim</span>
<a href="#l3.2256"></a><span id="l3.2256" class="difflineminus">-    except:</span>
<a href="#l3.2257"></a><span id="l3.2257" class="difflineminus">-        # Expect to get here on Python 2.2</span>
<a href="#l3.2258"></a><span id="l3.2258" class="difflineminus">-        def array(typecode, init=()):</span>
<a href="#l3.2259"></a><span id="l3.2259" class="difflineminus">-            if type(init) == str:</span>
<a href="#l3.2260"></a><span id="l3.2260" class="difflineminus">-                return map(ord, init)</span>
<a href="#l3.2261"></a><span id="l3.2261" class="difflineminus">-            return list(init)</span>
<a href="#l3.2262"></a><span id="l3.2262" class="difflineminus">-</span>
<a href="#l3.2263"></a><span id="l3.2263" class="difflineminus">-# Further hacks to get it limping along on Python 2.2</span>
<a href="#l3.2264"></a><span id="l3.2264" class="difflineminus">-try:</span>
<a href="#l3.2265"></a><span id="l3.2265" class="difflineminus">-    enumerate</span>
<a href="#l3.2266"></a><span id="l3.2266" class="difflineminus">-except:</span>
<a href="#l3.2267"></a><span id="l3.2267" class="difflineminus">-    def enumerate(seq):</span>
<a href="#l3.2268"></a><span id="l3.2268" class="difflineminus">-        i=0</span>
<a href="#l3.2269"></a><span id="l3.2269" class="difflineminus">-        for x in seq:</span>
<a href="#l3.2270"></a><span id="l3.2270" class="difflineminus">-            yield i,x</span>
<a href="#l3.2271"></a><span id="l3.2271" class="difflineminus">-            i += 1</span>
<a href="#l3.2272"></a><span id="l3.2272" class="difflineminus">-</span>
<a href="#l3.2273"></a><span id="l3.2273" class="difflineminus">-try:</span>
<a href="#l3.2274"></a><span id="l3.2274" class="difflineminus">-    reversed</span>
<a href="#l3.2275"></a><span id="l3.2275" class="difflineminus">-except:</span>
<a href="#l3.2276"></a><span id="l3.2276" class="difflineminus">-    def reversed(l):</span>
<a href="#l3.2277"></a><span id="l3.2277" class="difflineminus">-        l = list(l)</span>
<a href="#l3.2278"></a><span id="l3.2278" class="difflineminus">-        l.reverse()</span>
<a href="#l3.2279"></a><span id="l3.2279" class="difflineminus">-        for x in l:</span>
<a href="#l3.2280"></a><span id="l3.2280" class="difflineminus">-            yield x</span>
<a href="#l3.2281"></a><span id="l3.2281" class="difflineminus">-</span>
<a href="#l3.2282"></a><span id="l3.2282" class="difflineminus">-try:</span>
<a href="#l3.2283"></a><span id="l3.2283" class="difflineminus">-    itertools</span>
<a href="#l3.2284"></a><span id="l3.2284" class="difflineminus">-except:</span>
<a href="#l3.2285"></a><span id="l3.2285" class="difflineminus">-    class _dummy_itertools:</span>
<a href="#l3.2286"></a><span id="l3.2286" class="difflineminus">-        pass</span>
<a href="#l3.2287"></a><span id="l3.2287" class="difflineminus">-    itertools = _dummy_itertools()</span>
<a href="#l3.2288"></a><span id="l3.2288" class="difflineminus">-    def _itertools_imap(f, seq):</span>
<a href="#l3.2289"></a><span id="l3.2289" class="difflineminus">-        for x in seq:</span>
<a href="#l3.2290"></a><span id="l3.2290" class="difflineminus">-            yield f(x)</span>
<a href="#l3.2291"></a><span id="l3.2291" class="difflineminus">-    itertools.imap = _itertools_imap</span>
<a href="#l3.2292"></a><span id="l3.2292" class="difflineminus">-    def _itertools_chain(*iterables):</span>
<a href="#l3.2293"></a><span id="l3.2293" class="difflineminus">-        for it in iterables:</span>
<a href="#l3.2294"></a><span id="l3.2294" class="difflineminus">-            for element in it:</span>
<a href="#l3.2295"></a><span id="l3.2295" class="difflineminus">-                yield element</span>
<a href="#l3.2296"></a><span id="l3.2296" class="difflineminus">-    itertools.chain = _itertools_chain</span>
<a href="#l3.2297"></a><span id="l3.2297" class="difflineminus">-</span>
<a href="#l3.2298"></a><span id="l3.2298" class="difflineminus">-</span>
<a href="#l3.2299"></a><span id="l3.2299" class="difflineminus">-</span>
<a href="#l3.2300"></a><span id="l3.2300" class="difflineminus">-# === Internal Test Support ===</span>
<a href="#l3.2301"></a><span id="l3.2301" class="difflineminus">-</span>
<a href="#l3.2302"></a><span id="l3.2302" class="difflineminus">-# This section comprises the tests that are internally validated (as</span>
<a href="#l3.2303"></a><span id="l3.2303" class="difflineminus">-# opposed to tests which produce output files that are externally</span>
<a href="#l3.2304"></a><span id="l3.2304" class="difflineminus">-# validated).  Primarily they are unittests.</span>
<a href="#l3.2305"></a><span id="l3.2305" class="difflineminus">-</span>
<a href="#l3.2306"></a><span id="l3.2306" class="difflineminus">-# Note that it is difficult to internally validate the results of</span>
<a href="#l3.2307"></a><span id="l3.2307" class="difflineminus">-# writing a PNG file.  The only thing we can do is read it back in</span>
<a href="#l3.2308"></a><span id="l3.2308" class="difflineminus">-# again, which merely checks consistency, not that the PNG file we</span>
<a href="#l3.2309"></a><span id="l3.2309" class="difflineminus">-# produce is valid.</span>
<a href="#l3.2310"></a><span id="l3.2310" class="difflineminus">-</span>
<a href="#l3.2311"></a><span id="l3.2311" class="difflineminus">-# Run the tests from the command line:</span>
<a href="#l3.2312"></a><span id="l3.2312" class="difflineminus">-# python -c 'import png;png.test()'</span>
<a href="#l3.2313"></a><span id="l3.2313" class="difflineminus">-</span>
<a href="#l3.2314"></a><span id="l3.2314" class="difflineminus">-# (For an in-memory binary file IO object) We use BytesIO where</span>
<a href="#l3.2315"></a><span id="l3.2315" class="difflineminus">-# available, otherwise we use StringIO, but name it BytesIO.</span>
<a href="#l3.2316"></a><span id="l3.2316" class="difflineminus">-try:</span>
<a href="#l3.2317"></a><span id="l3.2317" class="difflineminus">-    from io import BytesIO</span>
<a href="#l3.2318"></a><span id="l3.2318" class="difflineminus">-except:</span>
<a href="#l3.2319"></a><span id="l3.2319" class="difflineminus">-    from StringIO import StringIO as BytesIO</span>
<a href="#l3.2320"></a><span id="l3.2320" class="difflineminus">-import tempfile</span>
<a href="#l3.2321"></a><span id="l3.2321" class="difflineminus">-# http://www.python.org/doc/2.4.4/lib/module-unittest.html</span>
<a href="#l3.2322"></a><span id="l3.2322" class="difflineminus">-import unittest</span>
<a href="#l3.2323"></a><span id="l3.2323" class="difflineminus">-</span>
<a href="#l3.2324"></a><span id="l3.2324" class="difflineminus">-</span>
<a href="#l3.2325"></a><span id="l3.2325" class="difflineminus">-def test():</span>
<a href="#l3.2326"></a><span id="l3.2326" class="difflineminus">-    unittest.main(__name__)</span>
<a href="#l3.2327"></a><span id="l3.2327" class="difflineminus">-</span>
<a href="#l3.2328"></a><span id="l3.2328" class="difflineminus">-def topngbytes(name, rows, x, y, **k):</span>
<a href="#l3.2329"></a><span id="l3.2329" class="difflineminus">-    &quot;&quot;&quot;Convenience function for creating a PNG file &quot;in memory&quot; as a</span>
<a href="#l3.2330"></a><span id="l3.2330" class="difflineminus">-    string.  Creates a :class:`Writer` instance using the keyword arguments,</span>
<a href="#l3.2331"></a><span id="l3.2331" class="difflineminus">-    then passes `rows` to its :meth:`Writer.write` method.  The resulting</span>
<a href="#l3.2332"></a><span id="l3.2332" class="difflineminus">-    PNG file is returned as a string.  `name` is used to identify the file for</span>
<a href="#l3.2333"></a><span id="l3.2333" class="difflineminus">-    debugging.</span>
<a href="#l3.2334"></a><span id="l3.2334" class="difflineminus">-    &quot;&quot;&quot;</span>
<a href="#l3.2335"></a><span id="l3.2335" class="difflineminus">-</span>
<a href="#l3.2336"></a><span id="l3.2336" class="difflineminus">-    import os</span>
<a href="#l3.2337"></a><span id="l3.2337" class="difflineminus">-</span>
<a href="#l3.2338"></a><span id="l3.2338" class="difflineminus">-    print name</span>
<a href="#l3.2339"></a><span id="l3.2339" class="difflineminus">-    f = BytesIO()</span>
<a href="#l3.2340"></a><span id="l3.2340" class="difflineminus">-    w = Writer(x, y, **k)</span>
<a href="#l3.2341"></a><span id="l3.2341" class="difflineminus">-    w.write(f, rows)</span>
<a href="#l3.2342"></a><span id="l3.2342" class="difflineminus">-    if os.environ.get('PYPNG_TEST_TMP'):</span>
<a href="#l3.2343"></a><span id="l3.2343" class="difflineminus">-        w = open(name, 'wb')</span>
<a href="#l3.2344"></a><span id="l3.2344" class="difflineminus">-        w.write(f.getvalue())</span>
<a href="#l3.2345"></a><span id="l3.2345" class="difflineminus">-        w.close()</span>
<a href="#l3.2346"></a><span id="l3.2346" class="difflineminus">-    return f.getvalue()</span>
<a href="#l3.2347"></a><span id="l3.2347" class="difflineminus">-</span>
<a href="#l3.2348"></a><span id="l3.2348" class="difflineminus">-def testWithIO(inp, out, f):</span>
<a href="#l3.2349"></a><span id="l3.2349" class="difflineminus">-    &quot;&quot;&quot;Calls the function `f` with ``sys.stdin`` changed to `inp`</span>
<a href="#l3.2350"></a><span id="l3.2350" class="difflineminus">-    and ``sys.stdout`` changed to `out`.  They are restored when `f`</span>
<a href="#l3.2351"></a><span id="l3.2351" class="difflineminus">-    returns.  This function returns whatever `f` returns.</span>
<a href="#l3.2352"></a><span id="l3.2352" class="difflineminus">-    &quot;&quot;&quot;</span>
<a href="#l3.2353"></a><span id="l3.2353" class="difflineminus">-</span>
<a href="#l3.2354"></a><span id="l3.2354" class="difflineminus">-    import os</span>
<a href="#l3.2355"></a><span id="l3.2355" class="difflineminus">-</span>
<a href="#l3.2356"></a><span id="l3.2356" class="difflineminus">-    try:</span>
<a href="#l3.2357"></a><span id="l3.2357" class="difflineminus">-        oldin,sys.stdin = sys.stdin,inp</span>
<a href="#l3.2358"></a><span id="l3.2358" class="difflineminus">-        oldout,sys.stdout = sys.stdout,out</span>
<a href="#l3.2359"></a><span id="l3.2359" class="difflineminus">-        x = f()</span>
<a href="#l3.2360"></a><span id="l3.2360" class="difflineminus">-    finally:</span>
<a href="#l3.2361"></a><span id="l3.2361" class="difflineminus">-        sys.stdin = oldin</span>
<a href="#l3.2362"></a><span id="l3.2362" class="difflineminus">-        sys.stdout = oldout</span>
<a href="#l3.2363"></a><span id="l3.2363" class="difflineminus">-    if os.environ.get('PYPNG_TEST_TMP') and hasattr(out,'getvalue'):</span>
<a href="#l3.2364"></a><span id="l3.2364" class="difflineminus">-        name = mycallersname()</span>
<a href="#l3.2365"></a><span id="l3.2365" class="difflineminus">-        if name:</span>
<a href="#l3.2366"></a><span id="l3.2366" class="difflineminus">-            w = open(name+'.png', 'wb')</span>
<a href="#l3.2367"></a><span id="l3.2367" class="difflineminus">-            w.write(out.getvalue())</span>
<a href="#l3.2368"></a><span id="l3.2368" class="difflineminus">-            w.close()</span>
<a href="#l3.2369"></a><span id="l3.2369" class="difflineminus">-    return x</span>
<a href="#l3.2370"></a><span id="l3.2370" class="difflineminus">-</span>
<a href="#l3.2371"></a><span id="l3.2371" class="difflineminus">-def mycallersname():</span>
<a href="#l3.2372"></a><span id="l3.2372" class="difflineminus">-    &quot;&quot;&quot;Returns the name of the caller of the caller of this function</span>
<a href="#l3.2373"></a><span id="l3.2373" class="difflineminus">-    (hence the name of the caller of the function in which</span>
<a href="#l3.2374"></a><span id="l3.2374" class="difflineminus">-    &quot;mycallersname()&quot; textually appears).  Returns None if this cannot</span>
<a href="#l3.2375"></a><span id="l3.2375" class="difflineminus">-    be determined.&quot;&quot;&quot;</span>
<a href="#l3.2376"></a><span id="l3.2376" class="difflineminus">-</span>
<a href="#l3.2377"></a><span id="l3.2377" class="difflineminus">-    # http://docs.python.org/library/inspect.html#the-interpreter-stack</span>
<a href="#l3.2378"></a><span id="l3.2378" class="difflineminus">-    import inspect</span>
<a href="#l3.2379"></a><span id="l3.2379" class="difflineminus">-</span>
<a href="#l3.2380"></a><span id="l3.2380" class="difflineminus">-    frame = inspect.currentframe()</span>
<a href="#l3.2381"></a><span id="l3.2381" class="difflineminus">-    if not frame:</span>
<a href="#l3.2382"></a><span id="l3.2382" class="difflineminus">-        return None</span>
<a href="#l3.2383"></a><span id="l3.2383" class="difflineminus">-    frame_,filename_,lineno_,funname,linelist_,listi_ = (</span>
<a href="#l3.2384"></a><span id="l3.2384" class="difflineminus">-      inspect.getouterframes(frame)[2])</span>
<a href="#l3.2385"></a><span id="l3.2385" class="difflineminus">-    return funname</span>
<a href="#l3.2386"></a><span id="l3.2386" class="difflineminus">-</span>
<a href="#l3.2387"></a><span id="l3.2387" class="difflineminus">-def seqtobytes(s):</span>
<a href="#l3.2388"></a><span id="l3.2388" class="difflineminus">-    &quot;&quot;&quot;Convert a sequence of integers to a *bytes* instance.  Good for</span>
<a href="#l3.2389"></a><span id="l3.2389" class="difflineminus">-    plastering over Python 2 / Python 3 cracks.</span>
<a href="#l3.2390"></a><span id="l3.2390" class="difflineminus">-    &quot;&quot;&quot;</span>
<a href="#l3.2391"></a><span id="l3.2391" class="difflineminus">-</span>
<a href="#l3.2392"></a><span id="l3.2392" class="difflineminus">-    return strtobytes(''.join(chr(x) for x in s))</span>
<a href="#l3.2393"></a><span id="l3.2393" class="difflineminus">-</span>
<a href="#l3.2394"></a><span id="l3.2394" class="difflineminus">-class Test(unittest.TestCase):</span>
<a href="#l3.2395"></a><span id="l3.2395" class="difflineminus">-    # This member is used by the superclass.  If we don't define a new</span>
<a href="#l3.2396"></a><span id="l3.2396" class="difflineminus">-    # class here then when we use self.assertRaises() and the PyPNG code</span>
<a href="#l3.2397"></a><span id="l3.2397" class="difflineminus">-    # raises an assertion then we get no proper traceback.  I can't work</span>
<a href="#l3.2398"></a><span id="l3.2398" class="difflineminus">-    # out why, but defining a new class here means we get a proper</span>
<a href="#l3.2399"></a><span id="l3.2399" class="difflineminus">-    # traceback.</span>
<a href="#l3.2400"></a><span id="l3.2400" class="difflineminus">-    class failureException(Exception):</span>
<a href="#l3.2401"></a><span id="l3.2401" class="difflineminus">-        pass</span>
<a href="#l3.2402"></a><span id="l3.2402" class="difflineminus">-</span>
<a href="#l3.2403"></a><span id="l3.2403" class="difflineminus">-    def helperLN(self, n):</span>
<a href="#l3.2404"></a><span id="l3.2404" class="difflineminus">-        mask = (1 &lt;&lt; n) - 1</span>
<a href="#l3.2405"></a><span id="l3.2405" class="difflineminus">-        # Use small chunk_limit so that multiple chunk writing is</span>
<a href="#l3.2406"></a><span id="l3.2406" class="difflineminus">-        # tested.  Making it a test for Issue 20.</span>
<a href="#l3.2407"></a><span id="l3.2407" class="difflineminus">-        w = Writer(15, 17, greyscale=True, bitdepth=n, chunk_limit=99)</span>
<a href="#l3.2408"></a><span id="l3.2408" class="difflineminus">-        f = BytesIO()</span>
<a href="#l3.2409"></a><span id="l3.2409" class="difflineminus">-        w.write_array(f, array('B', map(mask.__and__, range(1, 256))))</span>
<a href="#l3.2410"></a><span id="l3.2410" class="difflineminus">-        r = Reader(bytes=f.getvalue())</span>
<a href="#l3.2411"></a><span id="l3.2411" class="difflineminus">-        x,y,pixels,meta = r.read()</span>
<a href="#l3.2412"></a><span id="l3.2412" class="difflineminus">-        self.assertEqual(x, 15)</span>
<a href="#l3.2413"></a><span id="l3.2413" class="difflineminus">-        self.assertEqual(y, 17)</span>
<a href="#l3.2414"></a><span id="l3.2414" class="difflineminus">-        self.assertEqual(list(itertools.chain(*pixels)),</span>
<a href="#l3.2415"></a><span id="l3.2415" class="difflineminus">-                         map(mask.__and__, range(1,256)))</span>
<a href="#l3.2416"></a><span id="l3.2416" class="difflineminus">-    def testL8(self):</span>
<a href="#l3.2417"></a><span id="l3.2417" class="difflineminus">-        return self.helperLN(8)</span>
<a href="#l3.2418"></a><span id="l3.2418" class="difflineminus">-    def testL4(self):</span>
<a href="#l3.2419"></a><span id="l3.2419" class="difflineminus">-        return self.helperLN(4)</span>
<a href="#l3.2420"></a><span id="l3.2420" class="difflineminus">-    def testL2(self):</span>
<a href="#l3.2421"></a><span id="l3.2421" class="difflineminus">-        &quot;Also tests asRGB8.&quot;</span>
<a href="#l3.2422"></a><span id="l3.2422" class="difflineminus">-        w = Writer(1, 4, greyscale=True, bitdepth=2)</span>
<a href="#l3.2423"></a><span id="l3.2423" class="difflineminus">-        f = BytesIO()</span>
<a href="#l3.2424"></a><span id="l3.2424" class="difflineminus">-        w.write_array(f, array('B', range(4)))</span>
<a href="#l3.2425"></a><span id="l3.2425" class="difflineminus">-        r = Reader(bytes=f.getvalue())</span>
<a href="#l3.2426"></a><span id="l3.2426" class="difflineminus">-        x,y,pixels,meta = r.asRGB8()</span>
<a href="#l3.2427"></a><span id="l3.2427" class="difflineminus">-        self.assertEqual(x, 1)</span>
<a href="#l3.2428"></a><span id="l3.2428" class="difflineminus">-        self.assertEqual(y, 4)</span>
<a href="#l3.2429"></a><span id="l3.2429" class="difflineminus">-        for i,row in enumerate(pixels):</span>
<a href="#l3.2430"></a><span id="l3.2430" class="difflineminus">-            self.assertEqual(len(row), 3)</span>
<a href="#l3.2431"></a><span id="l3.2431" class="difflineminus">-            self.assertEqual(list(row), [0x55*i]*3)</span>
<a href="#l3.2432"></a><span id="l3.2432" class="difflineminus">-    def testP2(self):</span>
<a href="#l3.2433"></a><span id="l3.2433" class="difflineminus">-        &quot;2-bit palette.&quot;</span>
<a href="#l3.2434"></a><span id="l3.2434" class="difflineminus">-        a = (255,255,255)</span>
<a href="#l3.2435"></a><span id="l3.2435" class="difflineminus">-        b = (200,120,120)</span>
<a href="#l3.2436"></a><span id="l3.2436" class="difflineminus">-        c = (50,99,50)</span>
<a href="#l3.2437"></a><span id="l3.2437" class="difflineminus">-        w = Writer(1, 4, bitdepth=2, palette=[a,b,c])</span>
<a href="#l3.2438"></a><span id="l3.2438" class="difflineminus">-        f = BytesIO()</span>
<a href="#l3.2439"></a><span id="l3.2439" class="difflineminus">-        w.write_array(f, array('B', (0,1,1,2)))</span>
<a href="#l3.2440"></a><span id="l3.2440" class="difflineminus">-        r = Reader(bytes=f.getvalue())</span>
<a href="#l3.2441"></a><span id="l3.2441" class="difflineminus">-        x,y,pixels,meta = r.asRGB8()</span>
<a href="#l3.2442"></a><span id="l3.2442" class="difflineminus">-        self.assertEqual(x, 1)</span>
<a href="#l3.2443"></a><span id="l3.2443" class="difflineminus">-        self.assertEqual(y, 4)</span>
<a href="#l3.2444"></a><span id="l3.2444" class="difflineminus">-        self.assertEqual(list(pixels), map(list, [a, b, b, c]))</span>
<a href="#l3.2445"></a><span id="l3.2445" class="difflineminus">-    def testPtrns(self):</span>
<a href="#l3.2446"></a><span id="l3.2446" class="difflineminus">-        &quot;Test colour type 3 and tRNS chunk (and 4-bit palette).&quot;</span>
<a href="#l3.2447"></a><span id="l3.2447" class="difflineminus">-        a = (50,99,50,50)</span>
<a href="#l3.2448"></a><span id="l3.2448" class="difflineminus">-        b = (200,120,120,80)</span>
<a href="#l3.2449"></a><span id="l3.2449" class="difflineminus">-        c = (255,255,255)</span>
<a href="#l3.2450"></a><span id="l3.2450" class="difflineminus">-        d = (200,120,120)</span>
<a href="#l3.2451"></a><span id="l3.2451" class="difflineminus">-        e = (50,99,50)</span>
<a href="#l3.2452"></a><span id="l3.2452" class="difflineminus">-        w = Writer(3, 3, bitdepth=4, palette=[a,b,c,d,e])</span>
<a href="#l3.2453"></a><span id="l3.2453" class="difflineminus">-        f = BytesIO()</span>
<a href="#l3.2454"></a><span id="l3.2454" class="difflineminus">-        w.write_array(f, array('B', (4, 3, 2, 3, 2, 0, 2, 0, 1)))</span>
<a href="#l3.2455"></a><span id="l3.2455" class="difflineminus">-        r = Reader(bytes=f.getvalue())</span>
<a href="#l3.2456"></a><span id="l3.2456" class="difflineminus">-        x,y,pixels,meta = r.asRGBA8()</span>
<a href="#l3.2457"></a><span id="l3.2457" class="difflineminus">-        self.assertEqual(x, 3)</span>
<a href="#l3.2458"></a><span id="l3.2458" class="difflineminus">-        self.assertEqual(y, 3)</span>
<a href="#l3.2459"></a><span id="l3.2459" class="difflineminus">-        c = c+(255,)</span>
<a href="#l3.2460"></a><span id="l3.2460" class="difflineminus">-        d = d+(255,)</span>
<a href="#l3.2461"></a><span id="l3.2461" class="difflineminus">-        e = e+(255,)</span>
<a href="#l3.2462"></a><span id="l3.2462" class="difflineminus">-        boxed = [(e,d,c),(d,c,a),(c,a,b)]</span>
<a href="#l3.2463"></a><span id="l3.2463" class="difflineminus">-        flat = map(lambda row: itertools.chain(*row), boxed)</span>
<a href="#l3.2464"></a><span id="l3.2464" class="difflineminus">-        self.assertEqual(map(list, pixels), map(list, flat))</span>
<a href="#l3.2465"></a><span id="l3.2465" class="difflineminus">-    def testRGBtoRGBA(self):</span>
<a href="#l3.2466"></a><span id="l3.2466" class="difflineminus">-        &quot;asRGBA8() on colour type 2 source.&quot;&quot;&quot;</span>
<a href="#l3.2467"></a><span id="l3.2467" class="difflineminus">-        # Test for Issue 26</span>
<a href="#l3.2468"></a><span id="l3.2468" class="difflineminus">-        r = Reader(bytes=_pngsuite['basn2c08'])</span>
<a href="#l3.2469"></a><span id="l3.2469" class="difflineminus">-        x,y,pixels,meta = r.asRGBA8()</span>
<a href="#l3.2470"></a><span id="l3.2470" class="difflineminus">-        # Test the pixels at row 9 columns 0 and 1.</span>
<a href="#l3.2471"></a><span id="l3.2471" class="difflineminus">-        row9 = list(pixels)[9]</span>
<a href="#l3.2472"></a><span id="l3.2472" class="difflineminus">-        self.assertEqual(row9[0:8],</span>
<a href="#l3.2473"></a><span id="l3.2473" class="difflineminus">-                         [0xff, 0xdf, 0xff, 0xff, 0xff, 0xde, 0xff, 0xff])</span>
<a href="#l3.2474"></a><span id="l3.2474" class="difflineminus">-    def testLtoRGBA(self):</span>
<a href="#l3.2475"></a><span id="l3.2475" class="difflineminus">-        &quot;asRGBA() on grey source.&quot;&quot;&quot;</span>
<a href="#l3.2476"></a><span id="l3.2476" class="difflineminus">-        # Test for Issue 60</span>
<a href="#l3.2477"></a><span id="l3.2477" class="difflineminus">-        r = Reader(bytes=_pngsuite['basi0g08'])</span>
<a href="#l3.2478"></a><span id="l3.2478" class="difflineminus">-        x,y,pixels,meta = r.asRGBA()</span>
<a href="#l3.2479"></a><span id="l3.2479" class="difflineminus">-        row9 = list(list(pixels)[9])</span>
<a href="#l3.2480"></a><span id="l3.2480" class="difflineminus">-        self.assertEqual(row9[0:8],</span>
<a href="#l3.2481"></a><span id="l3.2481" class="difflineminus">-          [222, 222, 222, 255, 221, 221, 221, 255])</span>
<a href="#l3.2482"></a><span id="l3.2482" class="difflineminus">-    def testCtrns(self):</span>
<a href="#l3.2483"></a><span id="l3.2483" class="difflineminus">-        &quot;Test colour type 2 and tRNS chunk.&quot;</span>
<a href="#l3.2484"></a><span id="l3.2484" class="difflineminus">-        # Test for Issue 25</span>
<a href="#l3.2485"></a><span id="l3.2485" class="difflineminus">-        r = Reader(bytes=_pngsuite['tbrn2c08'])</span>
<a href="#l3.2486"></a><span id="l3.2486" class="difflineminus">-        x,y,pixels,meta = r.asRGBA8()</span>
<a href="#l3.2487"></a><span id="l3.2487" class="difflineminus">-        # I just happen to know that the first pixel is transparent.</span>
<a href="#l3.2488"></a><span id="l3.2488" class="difflineminus">-        # In particular it should be #7f7f7f00</span>
<a href="#l3.2489"></a><span id="l3.2489" class="difflineminus">-        row0 = list(pixels)[0]</span>
<a href="#l3.2490"></a><span id="l3.2490" class="difflineminus">-        self.assertEqual(tuple(row0[0:4]), (0x7f, 0x7f, 0x7f, 0x00))</span>
<a href="#l3.2491"></a><span id="l3.2491" class="difflineminus">-    def testAdam7read(self):</span>
<a href="#l3.2492"></a><span id="l3.2492" class="difflineminus">-        &quot;&quot;&quot;Adam7 interlace reading.</span>
<a href="#l3.2493"></a><span id="l3.2493" class="difflineminus">-        Specifically, test that for images in the PngSuite that</span>
<a href="#l3.2494"></a><span id="l3.2494" class="difflineminus">-        have both an interlaced and straightlaced pair that both</span>
<a href="#l3.2495"></a><span id="l3.2495" class="difflineminus">-        images from the pair produce the same array of pixels.&quot;&quot;&quot;</span>
<a href="#l3.2496"></a><span id="l3.2496" class="difflineminus">-        for candidate in _pngsuite:</span>
<a href="#l3.2497"></a><span id="l3.2497" class="difflineminus">-            if not candidate.startswith('basn'):</span>
<a href="#l3.2498"></a><span id="l3.2498" class="difflineminus">-                continue</span>
<a href="#l3.2499"></a><span id="l3.2499" class="difflineminus">-            candi = candidate.replace('n', 'i')</span>
<a href="#l3.2500"></a><span id="l3.2500" class="difflineminus">-            if candi not in _pngsuite:</span>
<a href="#l3.2501"></a><span id="l3.2501" class="difflineminus">-                continue</span>
<a href="#l3.2502"></a><span id="l3.2502" class="difflineminus">-            print 'adam7 read', candidate</span>
<a href="#l3.2503"></a><span id="l3.2503" class="difflineminus">-            straight = Reader(bytes=_pngsuite[candidate])</span>
<a href="#l3.2504"></a><span id="l3.2504" class="difflineminus">-            adam7 = Reader(bytes=_pngsuite[candi])</span>
<a href="#l3.2505"></a><span id="l3.2505" class="difflineminus">-            # Just compare the pixels.  Ignore x,y (because they're</span>
<a href="#l3.2506"></a><span id="l3.2506" class="difflineminus">-            # likely to be correct?); metadata is ignored because the</span>
<a href="#l3.2507"></a><span id="l3.2507" class="difflineminus">-            # &quot;interlace&quot; member differs.  Lame.</span>
<a href="#l3.2508"></a><span id="l3.2508" class="difflineminus">-            straight = straight.read()[2]</span>
<a href="#l3.2509"></a><span id="l3.2509" class="difflineminus">-            adam7 = adam7.read()[2]</span>
<a href="#l3.2510"></a><span id="l3.2510" class="difflineminus">-            self.assertEqual(map(list, straight), map(list, adam7))</span>
<a href="#l3.2511"></a><span id="l3.2511" class="difflineminus">-    def testAdam7write(self):</span>
<a href="#l3.2512"></a><span id="l3.2512" class="difflineminus">-        &quot;&quot;&quot;Adam7 interlace writing.</span>
<a href="#l3.2513"></a><span id="l3.2513" class="difflineminus">-        For each test image in the PngSuite, write an interlaced</span>
<a href="#l3.2514"></a><span id="l3.2514" class="difflineminus">-        and a straightlaced version.  Decode both, and compare results.</span>
<a href="#l3.2515"></a><span id="l3.2515" class="difflineminus">-        &quot;&quot;&quot;</span>
<a href="#l3.2516"></a><span id="l3.2516" class="difflineminus">-        # Not such a great test, because the only way we can check what</span>
<a href="#l3.2517"></a><span id="l3.2517" class="difflineminus">-        # we have written is to read it back again.</span>
<a href="#l3.2518"></a><span id="l3.2518" class="difflineminus">-</span>
<a href="#l3.2519"></a><span id="l3.2519" class="difflineminus">-        for name,bytes in _pngsuite.items():</span>
<a href="#l3.2520"></a><span id="l3.2520" class="difflineminus">-            # Only certain colour types supported for this test.</span>
<a href="#l3.2521"></a><span id="l3.2521" class="difflineminus">-            if name[3:5] not in ['n0', 'n2', 'n4', 'n6']:</span>
<a href="#l3.2522"></a><span id="l3.2522" class="difflineminus">-                continue</span>
<a href="#l3.2523"></a><span id="l3.2523" class="difflineminus">-            it = Reader(bytes=bytes)</span>
<a href="#l3.2524"></a><span id="l3.2524" class="difflineminus">-            x,y,pixels,meta = it.read()</span>
<a href="#l3.2525"></a><span id="l3.2525" class="difflineminus">-            pngi = topngbytes('adam7wn'+name+'.png', pixels,</span>
<a href="#l3.2526"></a><span id="l3.2526" class="difflineminus">-              x=x, y=y, bitdepth=it.bitdepth,</span>
<a href="#l3.2527"></a><span id="l3.2527" class="difflineminus">-              greyscale=it.greyscale, alpha=it.alpha,</span>
<a href="#l3.2528"></a><span id="l3.2528" class="difflineminus">-              transparent=it.transparent,</span>
<a href="#l3.2529"></a><span id="l3.2529" class="difflineminus">-              interlace=False)</span>
<a href="#l3.2530"></a><span id="l3.2530" class="difflineminus">-            x,y,ps,meta = Reader(bytes=pngi).read()</span>
<a href="#l3.2531"></a><span id="l3.2531" class="difflineminus">-            it = Reader(bytes=bytes)</span>
<a href="#l3.2532"></a><span id="l3.2532" class="difflineminus">-            x,y,pixels,meta = it.read()</span>
<a href="#l3.2533"></a><span id="l3.2533" class="difflineminus">-            pngs = topngbytes('adam7wi'+name+'.png', pixels,</span>
<a href="#l3.2534"></a><span id="l3.2534" class="difflineminus">-              x=x, y=y, bitdepth=it.bitdepth,</span>
<a href="#l3.2535"></a><span id="l3.2535" class="difflineminus">-              greyscale=it.greyscale, alpha=it.alpha,</span>
<a href="#l3.2536"></a><span id="l3.2536" class="difflineminus">-              transparent=it.transparent,</span>
<a href="#l3.2537"></a><span id="l3.2537" class="difflineminus">-              interlace=True)</span>
<a href="#l3.2538"></a><span id="l3.2538" class="difflineminus">-            x,y,pi,meta = Reader(bytes=pngs).read()</span>
<a href="#l3.2539"></a><span id="l3.2539" class="difflineminus">-            self.assertEqual(map(list, ps), map(list, pi))</span>
<a href="#l3.2540"></a><span id="l3.2540" class="difflineminus">-    def testPGMin(self):</span>
<a href="#l3.2541"></a><span id="l3.2541" class="difflineminus">-        &quot;&quot;&quot;Test that the command line tool can read PGM files.&quot;&quot;&quot;</span>
<a href="#l3.2542"></a><span id="l3.2542" class="difflineminus">-        def do():</span>
<a href="#l3.2543"></a><span id="l3.2543" class="difflineminus">-            return _main(['testPGMin'])</span>
<a href="#l3.2544"></a><span id="l3.2544" class="difflineminus">-        s = BytesIO()</span>
<a href="#l3.2545"></a><span id="l3.2545" class="difflineminus">-        s.write(strtobytes('P5 2 2 3\n'))</span>
<a href="#l3.2546"></a><span id="l3.2546" class="difflineminus">-        s.write(strtobytes('\x00\x01\x02\x03'))</span>
<a href="#l3.2547"></a><span id="l3.2547" class="difflineminus">-        s.flush()</span>
<a href="#l3.2548"></a><span id="l3.2548" class="difflineminus">-        s.seek(0)</span>
<a href="#l3.2549"></a><span id="l3.2549" class="difflineminus">-        o = BytesIO()</span>
<a href="#l3.2550"></a><span id="l3.2550" class="difflineminus">-        testWithIO(s, o, do)</span>
<a href="#l3.2551"></a><span id="l3.2551" class="difflineminus">-        r = Reader(bytes=o.getvalue())</span>
<a href="#l3.2552"></a><span id="l3.2552" class="difflineminus">-        x,y,pixels,meta = r.read()</span>
<a href="#l3.2553"></a><span id="l3.2553" class="difflineminus">-        self.assertTrue(r.greyscale)</span>
<a href="#l3.2554"></a><span id="l3.2554" class="difflineminus">-        self.assertEqual(r.bitdepth, 2)</span>
<a href="#l3.2555"></a><span id="l3.2555" class="difflineminus">-    def testPAMin(self):</span>
<a href="#l3.2556"></a><span id="l3.2556" class="difflineminus">-        &quot;&quot;&quot;Test that the command line tool can read PAM file.&quot;&quot;&quot;</span>
<a href="#l3.2557"></a><span id="l3.2557" class="difflineminus">-        def do():</span>
<a href="#l3.2558"></a><span id="l3.2558" class="difflineminus">-            return _main(['testPAMin'])</span>
<a href="#l3.2559"></a><span id="l3.2559" class="difflineminus">-        s = BytesIO()</span>
<a href="#l3.2560"></a><span id="l3.2560" class="difflineminus">-        s.write(strtobytes('P7\nWIDTH 3\nHEIGHT 1\nDEPTH 4\nMAXVAL 255\n'</span>
<a href="#l3.2561"></a><span id="l3.2561" class="difflineminus">-                'TUPLTYPE RGB_ALPHA\nENDHDR\n'))</span>
<a href="#l3.2562"></a><span id="l3.2562" class="difflineminus">-        # The pixels in flat row flat pixel format</span>
<a href="#l3.2563"></a><span id="l3.2563" class="difflineminus">-        flat =  [255,0,0,255, 0,255,0,120, 0,0,255,30]</span>
<a href="#l3.2564"></a><span id="l3.2564" class="difflineminus">-        asbytes = seqtobytes(flat)</span>
<a href="#l3.2565"></a><span id="l3.2565" class="difflineminus">-        s.write(asbytes)</span>
<a href="#l3.2566"></a><span id="l3.2566" class="difflineminus">-        s.flush()</span>
<a href="#l3.2567"></a><span id="l3.2567" class="difflineminus">-        s.seek(0)</span>
<a href="#l3.2568"></a><span id="l3.2568" class="difflineminus">-        o = BytesIO()</span>
<a href="#l3.2569"></a><span id="l3.2569" class="difflineminus">-        testWithIO(s, o, do)</span>
<a href="#l3.2570"></a><span id="l3.2570" class="difflineminus">-        r = Reader(bytes=o.getvalue())</span>
<a href="#l3.2571"></a><span id="l3.2571" class="difflineminus">-        x,y,pixels,meta = r.read()</span>
<a href="#l3.2572"></a><span id="l3.2572" class="difflineminus">-        self.assertTrue(r.alpha)</span>
<a href="#l3.2573"></a><span id="l3.2573" class="difflineminus">-        self.assertTrue(not r.greyscale)</span>
<a href="#l3.2574"></a><span id="l3.2574" class="difflineminus">-        self.assertEqual(list(itertools.chain(*pixels)), flat)</span>
<a href="#l3.2575"></a><span id="l3.2575" class="difflineminus">-    def testLA4(self):</span>
<a href="#l3.2576"></a><span id="l3.2576" class="difflineminus">-        &quot;&quot;&quot;Create an LA image with bitdepth 4.&quot;&quot;&quot;</span>
<a href="#l3.2577"></a><span id="l3.2577" class="difflineminus">-        bytes = topngbytes('la4.png', [[5, 12]], 1, 1,</span>
<a href="#l3.2578"></a><span id="l3.2578" class="difflineminus">-          greyscale=True, alpha=True, bitdepth=4)</span>
<a href="#l3.2579"></a><span id="l3.2579" class="difflineminus">-        sbit = Reader(bytes=bytes).chunk('sBIT')[1]</span>
<a href="#l3.2580"></a><span id="l3.2580" class="difflineminus">-        self.assertEqual(sbit, strtobytes('\x04\x04'))</span>
<a href="#l3.2581"></a><span id="l3.2581" class="difflineminus">-    def testPNMsbit(self):</span>
<a href="#l3.2582"></a><span id="l3.2582" class="difflineminus">-        &quot;&quot;&quot;Test that PNM files can generates sBIT chunk.&quot;&quot;&quot;</span>
<a href="#l3.2583"></a><span id="l3.2583" class="difflineminus">-        def do():</span>
<a href="#l3.2584"></a><span id="l3.2584" class="difflineminus">-            return _main(['testPNMsbit'])</span>
<a href="#l3.2585"></a><span id="l3.2585" class="difflineminus">-        s = BytesIO()</span>
<a href="#l3.2586"></a><span id="l3.2586" class="difflineminus">-        s.write(strtobytes('P6 8 1 1\n'))</span>
<a href="#l3.2587"></a><span id="l3.2587" class="difflineminus">-        for pixel in range(8):</span>
<a href="#l3.2588"></a><span id="l3.2588" class="difflineminus">-            s.write(struct.pack('&lt;I', (0x4081*pixel)&amp;0x10101)[:3])</span>
<a href="#l3.2589"></a><span id="l3.2589" class="difflineminus">-        s.flush()</span>
<a href="#l3.2590"></a><span id="l3.2590" class="difflineminus">-        s.seek(0)</span>
<a href="#l3.2591"></a><span id="l3.2591" class="difflineminus">-        o = BytesIO()</span>
<a href="#l3.2592"></a><span id="l3.2592" class="difflineminus">-        testWithIO(s, o, do)</span>
<a href="#l3.2593"></a><span id="l3.2593" class="difflineminus">-        r = Reader(bytes=o.getvalue())</span>
<a href="#l3.2594"></a><span id="l3.2594" class="difflineminus">-        sbit = r.chunk('sBIT')[1]</span>
<a href="#l3.2595"></a><span id="l3.2595" class="difflineminus">-        self.assertEqual(sbit, strtobytes('\x01\x01\x01'))</span>
<a href="#l3.2596"></a><span id="l3.2596" class="difflineminus">-    def testLtrns0(self):</span>
<a href="#l3.2597"></a><span id="l3.2597" class="difflineminus">-        &quot;&quot;&quot;Create greyscale image with tRNS chunk.&quot;&quot;&quot;</span>
<a href="#l3.2598"></a><span id="l3.2598" class="difflineminus">-        return self.helperLtrns(0)</span>
<a href="#l3.2599"></a><span id="l3.2599" class="difflineminus">-    def testLtrns1(self):</span>
<a href="#l3.2600"></a><span id="l3.2600" class="difflineminus">-        &quot;&quot;&quot;Using 1-tuple for transparent arg.&quot;&quot;&quot;</span>
<a href="#l3.2601"></a><span id="l3.2601" class="difflineminus">-        return self.helperLtrns((0,))</span>
<a href="#l3.2602"></a><span id="l3.2602" class="difflineminus">-    def helperLtrns(self, transparent):</span>
<a href="#l3.2603"></a><span id="l3.2603" class="difflineminus">-        &quot;&quot;&quot;Helper used by :meth:`testLtrns*`.&quot;&quot;&quot;</span>
<a href="#l3.2604"></a><span id="l3.2604" class="difflineminus">-        pixels = zip([0x00, 0x38, 0x4c, 0x54, 0x5c, 0x40, 0x38, 0x00])</span>
<a href="#l3.2605"></a><span id="l3.2605" class="difflineminus">-        o = BytesIO()</span>
<a href="#l3.2606"></a><span id="l3.2606" class="difflineminus">-        w = Writer(8, 8, greyscale=True, bitdepth=1, transparent=transparent)</span>
<a href="#l3.2607"></a><span id="l3.2607" class="difflineminus">-        w.write_packed(o, pixels)</span>
<a href="#l3.2608"></a><span id="l3.2608" class="difflineminus">-        r = Reader(bytes=o.getvalue())</span>
<a href="#l3.2609"></a><span id="l3.2609" class="difflineminus">-        x,y,pixels,meta = r.asDirect()</span>
<a href="#l3.2610"></a><span id="l3.2610" class="difflineminus">-        self.assertTrue(meta['alpha'])</span>
<a href="#l3.2611"></a><span id="l3.2611" class="difflineminus">-        self.assertTrue(meta['greyscale'])</span>
<a href="#l3.2612"></a><span id="l3.2612" class="difflineminus">-        self.assertEqual(meta['bitdepth'], 1)</span>
<a href="#l3.2613"></a><span id="l3.2613" class="difflineminus">-    def testWinfo(self):</span>
<a href="#l3.2614"></a><span id="l3.2614" class="difflineminus">-        &quot;&quot;&quot;Test the dictionary returned by a `read` method can be used</span>
<a href="#l3.2615"></a><span id="l3.2615" class="difflineminus">-        as args for :meth:`Writer`.</span>
<a href="#l3.2616"></a><span id="l3.2616" class="difflineminus">-        &quot;&quot;&quot;</span>
<a href="#l3.2617"></a><span id="l3.2617" class="difflineminus">-        r = Reader(bytes=_pngsuite['basn2c16'])</span>
<a href="#l3.2618"></a><span id="l3.2618" class="difflineminus">-        info = r.read()[3]</span>
<a href="#l3.2619"></a><span id="l3.2619" class="difflineminus">-        w = Writer(**info)</span>
<a href="#l3.2620"></a><span id="l3.2620" class="difflineminus">-    def testPackedIter(self):</span>
<a href="#l3.2621"></a><span id="l3.2621" class="difflineminus">-        &quot;&quot;&quot;Test iterator for row when using write_packed.</span>
<a href="#l3.2622"></a><span id="l3.2622" class="difflineminus">-</span>
<a href="#l3.2623"></a><span id="l3.2623" class="difflineminus">-        Indicative for Issue 47.</span>
<a href="#l3.2624"></a><span id="l3.2624" class="difflineminus">-        &quot;&quot;&quot;</span>
<a href="#l3.2625"></a><span id="l3.2625" class="difflineminus">-        w = Writer(16, 2, greyscale=True, alpha=False, bitdepth=1)</span>
<a href="#l3.2626"></a><span id="l3.2626" class="difflineminus">-        o = BytesIO()</span>
<a href="#l3.2627"></a><span id="l3.2627" class="difflineminus">-        w.write_packed(o, [itertools.chain([0x0a], [0xaa]),</span>
<a href="#l3.2628"></a><span id="l3.2628" class="difflineminus">-                           itertools.chain([0x0f], [0xff])])</span>
<a href="#l3.2629"></a><span id="l3.2629" class="difflineminus">-        r = Reader(bytes=o.getvalue())</span>
<a href="#l3.2630"></a><span id="l3.2630" class="difflineminus">-        x,y,pixels,info = r.asDirect()</span>
<a href="#l3.2631"></a><span id="l3.2631" class="difflineminus">-        pixels = list(pixels)</span>
<a href="#l3.2632"></a><span id="l3.2632" class="difflineminus">-        self.assertEqual(len(pixels), 2)</span>
<a href="#l3.2633"></a><span id="l3.2633" class="difflineminus">-        self.assertEqual(len(pixels[0]), 16)</span>
<a href="#l3.2634"></a><span id="l3.2634" class="difflineminus">-    def testInterlacedArray(self):</span>
<a href="#l3.2635"></a><span id="l3.2635" class="difflineminus">-        &quot;&quot;&quot;Test that reading an interlaced PNG yields each row as an</span>
<a href="#l3.2636"></a><span id="l3.2636" class="difflineminus">-        array.&quot;&quot;&quot;</span>
<a href="#l3.2637"></a><span id="l3.2637" class="difflineminus">-        r = Reader(bytes=_pngsuite['basi0g08'])</span>
<a href="#l3.2638"></a><span id="l3.2638" class="difflineminus">-        list(r.read()[2])[0].tostring</span>
<a href="#l3.2639"></a><span id="l3.2639" class="difflineminus">-    def testTrnsArray(self):</span>
<a href="#l3.2640"></a><span id="l3.2640" class="difflineminus">-        &quot;&quot;&quot;Test that reading a type 2 PNG with tRNS chunk yields each</span>
<a href="#l3.2641"></a><span id="l3.2641" class="difflineminus">-        row as an array (using asDirect).&quot;&quot;&quot;</span>
<a href="#l3.2642"></a><span id="l3.2642" class="difflineminus">-        r = Reader(bytes=_pngsuite['tbrn2c08'])</span>
<a href="#l3.2643"></a><span id="l3.2643" class="difflineminus">-        list(r.asDirect()[2])[0].tostring</span>
<a href="#l3.2644"></a><span id="l3.2644" class="difflineminus">-</span>
<a href="#l3.2645"></a><span id="l3.2645" class="difflineminus">-    # Invalid file format tests.  These construct various badly</span>
<a href="#l3.2646"></a><span id="l3.2646" class="difflineminus">-    # formatted PNG files, then feed them into a Reader.  When</span>
<a href="#l3.2647"></a><span id="l3.2647" class="difflineminus">-    # everything is working properly, we should get FormatError</span>
<a href="#l3.2648"></a><span id="l3.2648" class="difflineminus">-    # exceptions raised.</span>
<a href="#l3.2649"></a><span id="l3.2649" class="difflineminus">-    def testEmpty(self):</span>
<a href="#l3.2650"></a><span id="l3.2650" class="difflineminus">-        &quot;&quot;&quot;Test empty file.&quot;&quot;&quot;</span>
<a href="#l3.2651"></a><span id="l3.2651" class="difflineminus">-</span>
<a href="#l3.2652"></a><span id="l3.2652" class="difflineminus">-        r = Reader(bytes='')</span>
<a href="#l3.2653"></a><span id="l3.2653" class="difflineminus">-        self.assertRaises(FormatError, r.asDirect)</span>
<a href="#l3.2654"></a><span id="l3.2654" class="difflineminus">-    def testSigOnly(self):</span>
<a href="#l3.2655"></a><span id="l3.2655" class="difflineminus">-        &quot;&quot;&quot;Test file containing just signature bytes.&quot;&quot;&quot;</span>
<a href="#l3.2656"></a><span id="l3.2656" class="difflineminus">-</span>
<a href="#l3.2657"></a><span id="l3.2657" class="difflineminus">-        r = Reader(bytes=_signature)</span>
<a href="#l3.2658"></a><span id="l3.2658" class="difflineminus">-        self.assertRaises(FormatError, r.asDirect)</span>
<a href="#l3.2659"></a><span id="l3.2659" class="difflineminus">-    def testExtraPixels(self):</span>
<a href="#l3.2660"></a><span id="l3.2660" class="difflineminus">-        &quot;&quot;&quot;Test file that contains too many pixels.&quot;&quot;&quot;</span>
<a href="#l3.2661"></a><span id="l3.2661" class="difflineminus">-</span>
<a href="#l3.2662"></a><span id="l3.2662" class="difflineminus">-        def eachchunk(chunk):</span>
<a href="#l3.2663"></a><span id="l3.2663" class="difflineminus">-            if chunk[0] != 'IDAT':</span>
<a href="#l3.2664"></a><span id="l3.2664" class="difflineminus">-                return chunk</span>
<a href="#l3.2665"></a><span id="l3.2665" class="difflineminus">-            data = zlib.decompress(chunk[1])</span>
<a href="#l3.2666"></a><span id="l3.2666" class="difflineminus">-            data += strtobytes('\x00garbage')</span>
<a href="#l3.2667"></a><span id="l3.2667" class="difflineminus">-            data = zlib.compress(data)</span>
<a href="#l3.2668"></a><span id="l3.2668" class="difflineminus">-            chunk = (chunk[0], data)</span>
<a href="#l3.2669"></a><span id="l3.2669" class="difflineminus">-            return chunk</span>
<a href="#l3.2670"></a><span id="l3.2670" class="difflineminus">-        self.assertRaises(FormatError, self.helperFormat, eachchunk)</span>
<a href="#l3.2671"></a><span id="l3.2671" class="difflineminus">-    def testNotEnoughPixels(self):</span>
<a href="#l3.2672"></a><span id="l3.2672" class="difflineminus">-        def eachchunk(chunk):</span>
<a href="#l3.2673"></a><span id="l3.2673" class="difflineminus">-            if chunk[0] != 'IDAT':</span>
<a href="#l3.2674"></a><span id="l3.2674" class="difflineminus">-                return chunk</span>
<a href="#l3.2675"></a><span id="l3.2675" class="difflineminus">-            # Remove last byte.</span>
<a href="#l3.2676"></a><span id="l3.2676" class="difflineminus">-            data = zlib.decompress(chunk[1])</span>
<a href="#l3.2677"></a><span id="l3.2677" class="difflineminus">-            data = data[:-1]</span>
<a href="#l3.2678"></a><span id="l3.2678" class="difflineminus">-            data = zlib.compress(data)</span>
<a href="#l3.2679"></a><span id="l3.2679" class="difflineminus">-            return (chunk[0], data)</span>
<a href="#l3.2680"></a><span id="l3.2680" class="difflineminus">-        self.assertRaises(FormatError, self.helperFormat, eachchunk)</span>
<a href="#l3.2681"></a><span id="l3.2681" class="difflineminus">-    def helperFormat(self, f):</span>
<a href="#l3.2682"></a><span id="l3.2682" class="difflineminus">-        r = Reader(bytes=_pngsuite['basn0g01'])</span>
<a href="#l3.2683"></a><span id="l3.2683" class="difflineminus">-        o = BytesIO()</span>
<a href="#l3.2684"></a><span id="l3.2684" class="difflineminus">-        def newchunks():</span>
<a href="#l3.2685"></a><span id="l3.2685" class="difflineminus">-            for chunk in r.chunks():</span>
<a href="#l3.2686"></a><span id="l3.2686" class="difflineminus">-                yield f(chunk)</span>
<a href="#l3.2687"></a><span id="l3.2687" class="difflineminus">-        write_chunks(o, newchunks())</span>
<a href="#l3.2688"></a><span id="l3.2688" class="difflineminus">-        r = Reader(bytes=o.getvalue())</span>
<a href="#l3.2689"></a><span id="l3.2689" class="difflineminus">-        return list(r.asDirect()[2])</span>
<a href="#l3.2690"></a><span id="l3.2690" class="difflineminus">-    def testBadFilter(self):</span>
<a href="#l3.2691"></a><span id="l3.2691" class="difflineminus">-        def eachchunk(chunk):</span>
<a href="#l3.2692"></a><span id="l3.2692" class="difflineminus">-            if chunk[0] != 'IDAT':</span>
<a href="#l3.2693"></a><span id="l3.2693" class="difflineminus">-                return chunk</span>
<a href="#l3.2694"></a><span id="l3.2694" class="difflineminus">-            data = zlib.decompress(chunk[1])</span>
<a href="#l3.2695"></a><span id="l3.2695" class="difflineminus">-            # Corrupt the first filter byte</span>
<a href="#l3.2696"></a><span id="l3.2696" class="difflineminus">-            data = strtobytes('\x99') + data[1:]</span>
<a href="#l3.2697"></a><span id="l3.2697" class="difflineminus">-            data = zlib.compress(data)</span>
<a href="#l3.2698"></a><span id="l3.2698" class="difflineminus">-            return (chunk[0], data)</span>
<a href="#l3.2699"></a><span id="l3.2699" class="difflineminus">-        self.assertRaises(FormatError, self.helperFormat, eachchunk)</span>
<a href="#l3.2700"></a><span id="l3.2700" class="difflineminus">-    def testFlat(self):</span>
<a href="#l3.2701"></a><span id="l3.2701" class="difflineminus">-        &quot;&quot;&quot;Test read_flat.&quot;&quot;&quot;</span>
<a href="#l3.2702"></a><span id="l3.2702" class="difflineminus">-        import hashlib</span>
<a href="#l3.2703"></a><span id="l3.2703" class="difflineminus">-</span>
<a href="#l3.2704"></a><span id="l3.2704" class="difflineminus">-        r = Reader(bytes=_pngsuite['basn0g02'])</span>
<a href="#l3.2705"></a><span id="l3.2705" class="difflineminus">-        x,y,pixel,meta = r.read_flat()</span>
<a href="#l3.2706"></a><span id="l3.2706" class="difflineminus">-        d = hashlib.md5(seqtobytes(pixel)).digest()</span>
<a href="#l3.2707"></a><span id="l3.2707" class="difflineminus">-        self.assertEqual(_enhex(d), '255cd971ab8cd9e7275ff906e5041aa0')</span>
<a href="#l3.2708"></a><span id="l3.2708" class="difflineminus">-    def testfromarray(self):</span>
<a href="#l3.2709"></a><span id="l3.2709" class="difflineminus">-        img = from_array([[0, 0x33, 0x66], [0xff, 0xcc, 0x99]], 'L')</span>
<a href="#l3.2710"></a><span id="l3.2710" class="difflineminus">-        img.save('testfromarray.png')</span>
<a href="#l3.2711"></a><span id="l3.2711" class="difflineminus">-    def testfromarrayL16(self):</span>
<a href="#l3.2712"></a><span id="l3.2712" class="difflineminus">-        img = from_array(group(range(2**16), 256), 'L;16')</span>
<a href="#l3.2713"></a><span id="l3.2713" class="difflineminus">-        img.save('testL16.png')</span>
<a href="#l3.2714"></a><span id="l3.2714" class="difflineminus">-    def testfromarrayRGB(self):</span>
<a href="#l3.2715"></a><span id="l3.2715" class="difflineminus">-        img = from_array([[0,0,0, 0,0,1, 0,1,0, 0,1,1],</span>
<a href="#l3.2716"></a><span id="l3.2716" class="difflineminus">-                          [1,0,0, 1,0,1, 1,1,0, 1,1,1]], 'RGB;1')</span>
<a href="#l3.2717"></a><span id="l3.2717" class="difflineminus">-        o = BytesIO()</span>
<a href="#l3.2718"></a><span id="l3.2718" class="difflineminus">-        img.save(o)</span>
<a href="#l3.2719"></a><span id="l3.2719" class="difflineminus">-    def testfromarrayIter(self):</span>
<a href="#l3.2720"></a><span id="l3.2720" class="difflineminus">-        import itertools</span>
<a href="#l3.2721"></a><span id="l3.2721" class="difflineminus">-</span>
<a href="#l3.2722"></a><span id="l3.2722" class="difflineminus">-        i = itertools.islice(itertools.count(10), 20)</span>
<a href="#l3.2723"></a><span id="l3.2723" class="difflineminus">-        i = itertools.imap(lambda x: [x, x, x], i)</span>
<a href="#l3.2724"></a><span id="l3.2724" class="difflineminus">-        img = from_array(i, 'RGB;5', dict(height=20))</span>
<a href="#l3.2725"></a><span id="l3.2725" class="difflineminus">-        f = open('testiter.png', 'wb')</span>
<a href="#l3.2726"></a><span id="l3.2726" class="difflineminus">-        img.save(f)</span>
<a href="#l3.2727"></a><span id="l3.2727" class="difflineminus">-        f.close()</span>
<a href="#l3.2728"></a><span id="l3.2728" class="difflineminus">-</span>
<a href="#l3.2729"></a><span id="l3.2729" class="difflineminus">-    # numpy dependent tests.  These are skipped (with a message to</span>
<a href="#l3.2730"></a><span id="l3.2730" class="difflineminus">-    # sys.stderr) if numpy cannot be imported.</span>
<a href="#l3.2731"></a><span id="l3.2731" class="difflineminus">-    def testNumpyuint16(self):</span>
<a href="#l3.2732"></a><span id="l3.2732" class="difflineminus">-        &quot;&quot;&quot;numpy uint16.&quot;&quot;&quot;</span>
<a href="#l3.2733"></a><span id="l3.2733" class="difflineminus">-</span>
<a href="#l3.2734"></a><span id="l3.2734" class="difflineminus">-        try:</span>
<a href="#l3.2735"></a><span id="l3.2735" class="difflineminus">-            import numpy</span>
<a href="#l3.2736"></a><span id="l3.2736" class="difflineminus">-        except ImportError:</span>
<a href="#l3.2737"></a><span id="l3.2737" class="difflineminus">-            print &gt;&gt;sys.stderr, &quot;skipping numpy test&quot;</span>
<a href="#l3.2738"></a><span id="l3.2738" class="difflineminus">-            return</span>
<a href="#l3.2739"></a><span id="l3.2739" class="difflineminus">-</span>
<a href="#l3.2740"></a><span id="l3.2740" class="difflineminus">-        rows = [map(numpy.uint16, range(0,0x10000,0x5555))]</span>
<a href="#l3.2741"></a><span id="l3.2741" class="difflineminus">-        b = topngbytes('numpyuint16.png', rows, 4, 1,</span>
<a href="#l3.2742"></a><span id="l3.2742" class="difflineminus">-            greyscale=True, alpha=False, bitdepth=16)</span>
<a href="#l3.2743"></a><span id="l3.2743" class="difflineminus">-    def testNumpyuint8(self):</span>
<a href="#l3.2744"></a><span id="l3.2744" class="difflineminus">-        &quot;&quot;&quot;numpy uint8.&quot;&quot;&quot;</span>
<a href="#l3.2745"></a><span id="l3.2745" class="difflineminus">-</span>
<a href="#l3.2746"></a><span id="l3.2746" class="difflineminus">-        try:</span>
<a href="#l3.2747"></a><span id="l3.2747" class="difflineminus">-            import numpy</span>
<a href="#l3.2748"></a><span id="l3.2748" class="difflineminus">-        except ImportError:</span>
<a href="#l3.2749"></a><span id="l3.2749" class="difflineminus">-            print &gt;&gt;sys.stderr, &quot;skipping numpy test&quot;</span>
<a href="#l3.2750"></a><span id="l3.2750" class="difflineminus">-            return</span>
<a href="#l3.2751"></a><span id="l3.2751" class="difflineminus">-</span>
<a href="#l3.2752"></a><span id="l3.2752" class="difflineminus">-        rows = [map(numpy.uint8, range(0,0x100,0x55))]</span>
<a href="#l3.2753"></a><span id="l3.2753" class="difflineminus">-        b = topngbytes('numpyuint8.png', rows, 4, 1,</span>
<a href="#l3.2754"></a><span id="l3.2754" class="difflineminus">-            greyscale=True, alpha=False, bitdepth=8)</span>
<a href="#l3.2755"></a><span id="l3.2755" class="difflineminus">-    def testNumpybool(self):</span>
<a href="#l3.2756"></a><span id="l3.2756" class="difflineminus">-        &quot;&quot;&quot;numpy bool.&quot;&quot;&quot;</span>
<a href="#l3.2757"></a><span id="l3.2757" class="difflineminus">-</span>
<a href="#l3.2758"></a><span id="l3.2758" class="difflineminus">-        try:</span>
<a href="#l3.2759"></a><span id="l3.2759" class="difflineminus">-            import numpy</span>
<a href="#l3.2760"></a><span id="l3.2760" class="difflineminus">-        except ImportError:</span>
<a href="#l3.2761"></a><span id="l3.2761" class="difflineminus">-            print &gt;&gt;sys.stderr, &quot;skipping numpy test&quot;</span>
<a href="#l3.2762"></a><span id="l3.2762" class="difflineminus">-            return</span>
<a href="#l3.2763"></a><span id="l3.2763" class="difflineminus">-</span>
<a href="#l3.2764"></a><span id="l3.2764" class="difflineminus">-        rows = [map(numpy.bool, [0,1])]</span>
<a href="#l3.2765"></a><span id="l3.2765" class="difflineminus">-        b = topngbytes('numpybool.png', rows, 2, 1,</span>
<a href="#l3.2766"></a><span id="l3.2766" class="difflineminus">-            greyscale=True, alpha=False, bitdepth=1)</span>
<a href="#l3.2767"></a><span id="l3.2767" class="difflineminus">-    def testNumpyarray(self):</span>
<a href="#l3.2768"></a><span id="l3.2768" class="difflineminus">-        &quot;&quot;&quot;numpy array.&quot;&quot;&quot;</span>
<a href="#l3.2769"></a><span id="l3.2769" class="difflineminus">-        try:</span>
<a href="#l3.2770"></a><span id="l3.2770" class="difflineminus">-            import numpy</span>
<a href="#l3.2771"></a><span id="l3.2771" class="difflineminus">-        except ImportError:</span>
<a href="#l3.2772"></a><span id="l3.2772" class="difflineminus">-            print &gt;&gt;sys.stderr, &quot;skipping numpy test&quot;</span>
<a href="#l3.2773"></a><span id="l3.2773" class="difflineminus">-            return</span>
<a href="#l3.2774"></a><span id="l3.2774" class="difflineminus">-</span>
<a href="#l3.2775"></a><span id="l3.2775" class="difflineminus">-        pixels = numpy.array([[0,0x5555],[0x5555,0xaaaa]], numpy.uint16)</span>
<a href="#l3.2776"></a><span id="l3.2776" class="difflineminus">-        img = from_array(pixels, 'L')</span>
<a href="#l3.2777"></a><span id="l3.2777" class="difflineminus">-        img.save('testnumpyL16.png')</span>
<a href="#l3.2778"></a><span id="l3.2778" class="difflineminus">-</span>
<a href="#l3.2779"></a><span id="l3.2779" class="difflineminus">-# === Command Line Support ===</span>
<a href="#l3.2780"></a><span id="l3.2780" class="difflineminus">-</span>
<a href="#l3.2781"></a><span id="l3.2781" class="difflineminus">-def _dehex(s):</span>
<a href="#l3.2782"></a><span id="l3.2782" class="difflineminus">-    &quot;&quot;&quot;Liberally convert from hex string to binary string.&quot;&quot;&quot;</span>
<a href="#l3.2783"></a><span id="l3.2783" class="difflineminus">-    import re</span>
<a href="#l3.2784"></a><span id="l3.2784" class="difflineminus">-    import binascii</span>
<a href="#l3.2785"></a><span id="l3.2785" class="difflineminus">-</span>
<a href="#l3.2786"></a><span id="l3.2786" class="difflineminus">-    # Remove all non-hexadecimal digits</span>
<a href="#l3.2787"></a><span id="l3.2787" class="difflineminus">-    s = re.sub(r'[^a-fA-F\d]', '', s)</span>
<a href="#l3.2788"></a><span id="l3.2788" class="difflineminus">-    # binscii.unhexlify works in Python 2 and Python 3 (unlike</span>
<a href="#l3.2789"></a><span id="l3.2789" class="difflineminus">-    # thing.decode('hex')).</span>
<a href="#l3.2790"></a><span id="l3.2790" class="difflineminus">-    return binascii.unhexlify(strtobytes(s))</span>
<a href="#l3.2791"></a><span id="l3.2791" class="difflineminus">-def _enhex(s):</span>
<a href="#l3.2792"></a><span id="l3.2792" class="difflineminus">-    &quot;&quot;&quot;Convert from binary string (bytes) to hex string (str).&quot;&quot;&quot;</span>
<a href="#l3.2793"></a><span id="l3.2793" class="difflineminus">-</span>
<a href="#l3.2794"></a><span id="l3.2794" class="difflineminus">-    import binascii</span>
<a href="#l3.2795"></a><span id="l3.2795" class="difflineminus">-</span>
<a href="#l3.2796"></a><span id="l3.2796" class="difflineminus">-    return bytestostr(binascii.hexlify(s))</span>
<a href="#l3.2797"></a><span id="l3.2797" class="difflineminus">-</span>
<a href="#l3.2798"></a><span id="l3.2798" class="difflineminus">-# Copies of PngSuite test files taken</span>
<a href="#l3.2799"></a><span id="l3.2799" class="difflineminus">-# from http://www.schaik.com/pngsuite/pngsuite_bas_png.html</span>
<a href="#l3.2800"></a><span id="l3.2800" class="difflineminus">-# on 2009-02-19 by drj and converted to hex.</span>
<a href="#l3.2801"></a><span id="l3.2801" class="difflineminus">-# Some of these are not actually in PngSuite (but maybe they should</span>
<a href="#l3.2802"></a><span id="l3.2802" class="difflineminus">-# be?), they use the same naming scheme, but start with a capital</span>
<a href="#l3.2803"></a><span id="l3.2803" class="difflineminus">-# letter.</span>
<a href="#l3.2804"></a><span id="l3.2804" class="difflineminus">-_pngsuite = {</span>
<a href="#l3.2805"></a><span id="l3.2805" class="difflineminus">-  'basi0g01': _dehex(&quot;&quot;&quot;</span>
<a href="#l3.2806"></a><span id="l3.2806" class="difflineminus">-89504e470d0a1a0a0000000d49484452000000200000002001000000012c0677</span>
<a href="#l3.2807"></a><span id="l3.2807" class="difflineminus">-cf0000000467414d41000186a031e8965f0000009049444154789c2d8d310ec2</span>
<a href="#l3.2808"></a><span id="l3.2808" class="difflineminus">-300c45dfc682c415187a00a42e197ab81e83b127e00c5639001363a580d8582c</span>
<a href="#l3.2809"></a><span id="l3.2809" class="difflineminus">-65c910357c4b78b0bfbfdf4f70168c19e7acb970a3f2d1ded9695ce5bf5963df</span>
<a href="#l3.2810"></a><span id="l3.2810" class="difflineminus">-d92aaf4c9fd927ea449e6487df5b9c36e799b91bdf082b4d4bd4014fe4014b01</span>
<a href="#l3.2811"></a><span id="l3.2811" class="difflineminus">-ab7a17aee694d28d328a2d63837a70451e1648702d9a9ff4a11d2f7a51aa21e5</span>
<a href="#l3.2812"></a><span id="l3.2812" class="difflineminus">-a18c7ffd0094e3511d661822f20000000049454e44ae426082</span>
<a href="#l3.2813"></a><span id="l3.2813" class="difflineminus">-&quot;&quot;&quot;),</span>
<a href="#l3.2814"></a><span id="l3.2814" class="difflineminus">-  'basi0g02': _dehex(&quot;&quot;&quot;</span>
<a href="#l3.2815"></a><span id="l3.2815" class="difflineminus">-89504e470d0a1a0a0000000d49484452000000200000002002000000016ba60d</span>
<a href="#l3.2816"></a><span id="l3.2816" class="difflineminus">-1f0000000467414d41000186a031e8965f0000005149444154789c635062e860</span>
<a href="#l3.2817"></a><span id="l3.2817" class="difflineminus">-00e17286bb609c93c370ec189494960631366e4467b3ae675dcf10f521ea0303</span>
<a href="#l3.2818"></a><span id="l3.2818" class="difflineminus">-90c1ca006444e11643482064114a4852c710baea3f18c31918020c30410403a6</span>
<a href="#l3.2819"></a><span id="l3.2819" class="difflineminus">-0ac1a09239009c52804d85b6d97d0000000049454e44ae426082</span>
<a href="#l3.2820"></a><span id="l3.2820" class="difflineminus">-&quot;&quot;&quot;),</span>
<a href="#l3.2821"></a><span id="l3.2821" class="difflineminus">-  'basi0g04': _dehex(&quot;&quot;&quot;</span>
<a href="#l3.2822"></a><span id="l3.2822" class="difflineminus">-89504e470d0a1a0a0000000d4948445200000020000000200400000001e4e6f8</span>
<a href="#l3.2823"></a><span id="l3.2823" class="difflineminus">-bf0000000467414d41000186a031e8965f000000ae49444154789c658e5111c2</span>
<a href="#l3.2824"></a><span id="l3.2824" class="difflineminus">-301044171c141c141c041c843a287510ea20d441c041c141c141c04191102454</span>
<a href="#l3.2825"></a><span id="l3.2825" class="difflineminus">-03994998cecd7edcecedbb9bdbc3b2c2b6457545fbc4bac1be437347f7c66a77</span>
<a href="#l3.2826"></a><span id="l3.2826" class="difflineminus">-3c23d60db15e88f5c5627338a5416c2e691a9b475a89cd27eda12895ae8dfdab</span>
<a href="#l3.2827"></a><span id="l3.2827" class="difflineminus">-43d61e590764f5c83a226b40d669bec307f93247701687723abf31ff83a2284b</span>
<a href="#l3.2828"></a><span id="l3.2828" class="difflineminus">-a5b4ae6b63ac6520ad730ca4ed7b06d20e030369bd6720ed383290360406d24e</span>
<a href="#l3.2829"></a><span id="l3.2829" class="difflineminus">-13811f2781eba9d34d07160000000049454e44ae426082</span>
<a href="#l3.2830"></a><span id="l3.2830" class="difflineminus">-&quot;&quot;&quot;),</span>
<a href="#l3.2831"></a><span id="l3.2831" class="difflineminus">-  'basi0g08': _dehex(&quot;&quot;&quot;</span>
<a href="#l3.2832"></a><span id="l3.2832" class="difflineminus">-89504e470d0a1a0a0000000d4948445200000020000000200800000001211615</span>
<a href="#l3.2833"></a><span id="l3.2833" class="difflineminus">-be0000000467414d41000186a031e8965f000000b549444154789cb5905d0ac2</span>
<a href="#l3.2834"></a><span id="l3.2834" class="difflineminus">-3010849dbac81c42c47bf843cf253e8878b0aa17110f214bdca6be240f5d21a5</span>
<a href="#l3.2835"></a><span id="l3.2835" class="difflineminus">-94ced3e49bcd322c1624115515154998aa424822a82a5624a1aa8a8b24c58f99</span>
<a href="#l3.2836"></a><span id="l3.2836" class="difflineminus">-999908130989a04a00d76c2c09e76cf21adcb209393a6553577da17140a2c59e</span>
<a href="#l3.2837"></a><span id="l3.2837" class="difflineminus">-70ecbfa388dff1f03b82fb82bd07f05f7cb13f80bb07ad2fd60c011c3c588eef</span>
<a href="#l3.2838"></a><span id="l3.2838" class="difflineminus">-f1f4e03bbec7ce832dca927aea005e431b625796345307b019c845e6bfc3bb98</span>
<a href="#l3.2839"></a><span id="l3.2839" class="difflineminus">-769d84f9efb02ea6c00f9bb9ff45e81f9f280000000049454e44ae426082</span>
<a href="#l3.2840"></a><span id="l3.2840" class="difflineminus">-&quot;&quot;&quot;),</span>
<a href="#l3.2841"></a><span id="l3.2841" class="difflineminus">-  'basi0g16': _dehex(&quot;&quot;&quot;</span>
<a href="#l3.2842"></a><span id="l3.2842" class="difflineminus">-89504e470d0a1a0a0000000d49484452000000200000002010000000017186c9</span>
<a href="#l3.2843"></a><span id="l3.2843" class="difflineminus">-fd0000000467414d41000186a031e8965f000000e249444154789cb5913b0ec2</span>
<a href="#l3.2844"></a><span id="l3.2844" class="difflineminus">-301044c7490aa8f85d81c3e4301c8f53a4ca0da8902c8144b3920b4043111282</span>
<a href="#l3.2845"></a><span id="l3.2845" class="difflineminus">-23bc4956681a6bf5fc3c5a3ba0448912d91a4de2c38dd8e380231eede4c4f7a1</span>
<a href="#l3.2846"></a><span id="l3.2846" class="difflineminus">-4677700bec7bd9b1d344689315a3418d1a6efbe5b8305ba01f8ff4808c063e26</span>
<a href="#l3.2847"></a><span id="l3.2847" class="difflineminus">-c60d5c81edcf6c58c535e252839e93801b15c0a70d810ae0d306b205dc32b187</span>
<a href="#l3.2848"></a><span id="l3.2848" class="difflineminus">-272b64057e4720ff0502154034831520154034c3df81400510cdf0015c86e5cc</span>
<a href="#l3.2849"></a><span id="l3.2849" class="difflineminus">-5c79c639fddba9dcb5456b51d7980eb52d8e7d7fa620a75120d6064641a05120</span>
<a href="#l3.2850"></a><span id="l3.2850" class="difflineminus">-b606771a05626b401a05f1f589827cf0fe44c1f0bae0055698ee8914fffffe00</span>
<a href="#l3.2851"></a><span id="l3.2851" class="difflineminus">-00000049454e44ae426082</span>
<a href="#l3.2852"></a><span id="l3.2852" class="difflineminus">-&quot;&quot;&quot;),</span>
<a href="#l3.2853"></a><span id="l3.2853" class="difflineminus">-  'basi2c08': _dehex(&quot;&quot;&quot;</span>
<a href="#l3.2854"></a><span id="l3.2854" class="difflineminus">-89504e470d0a1a0a0000000d49484452000000200000002008020000018b1fdd</span>
<a href="#l3.2855"></a><span id="l3.2855" class="difflineminus">-350000000467414d41000186a031e8965f000000f249444154789cd59341aa04</span>
<a href="#l3.2856"></a><span id="l3.2856" class="difflineminus">-210c44abc07b78133d59d37333bd89d76868b566d10cf4675af8596431a11662</span>
<a href="#l3.2857"></a><span id="l3.2857" class="difflineminus">-7c5688919280e312257dd6a0a4cf1a01008ee312a5f3c69c37e6fcc3f47e6776</span>
<a href="#l3.2858"></a><span id="l3.2858" class="difflineminus">-a07f8bdaf5b40feed2d33e025e2ff4fe2d4a63e1a16d91180b736d8bc45854c5</span>
<a href="#l3.2859"></a><span id="l3.2859" class="difflineminus">-6d951863f4a7e0b66dcf09a900f3ffa2948d4091e53ca86c048a64390f662b50</span>
<a href="#l3.2860"></a><span id="l3.2860" class="difflineminus">-4a999660ced906182b9a01a8be00a56404a6ede182b1223b4025e32c4de34304</span>
<a href="#l3.2861"></a><span id="l3.2861" class="difflineminus">-63457680c93aada6c99b73865aab2fc094920d901a203f5ddfe1970d28456783</span>
<a href="#l3.2862"></a><span id="l3.2862" class="difflineminus">-26cffbafeffcd30654f46d119be4793f827387fc0d189d5bc4d69a3c23d45a7f</span>
<a href="#l3.2863"></a><span id="l3.2863" class="difflineminus">-db803146578337df4d0a3121fc3d330000000049454e44ae426082</span>
<a href="#l3.2864"></a><span id="l3.2864" class="difflineminus">-&quot;&quot;&quot;),</span>
<a href="#l3.2865"></a><span id="l3.2865" class="difflineminus">-  'basi2c16': _dehex(&quot;&quot;&quot;</span>
<a href="#l3.2866"></a><span id="l3.2866" class="difflineminus">-89504e470d0a1a0a0000000d4948445200000020000000201002000001db8f01</span>
<a href="#l3.2867"></a><span id="l3.2867" class="difflineminus">-760000000467414d41000186a031e8965f0000020a49444154789cd5962173e3</span>
<a href="#l3.2868"></a><span id="l3.2868" class="difflineminus">-3010853fcf1838cc61a1818185a53e56787fa13fa130852e3b5878b4b0b03081</span>
<a href="#l3.2869"></a><span id="l3.2869" class="difflineminus">-b97f7030070b53e6b057a0a8912bbb9163b9f109ececbc59bd7dcf2b45492409</span>
<a href="#l3.2870"></a><span id="l3.2870" class="difflineminus">-d66f00eb1dd83cb5497d65456aeb8e1040913b3b2c04504c936dd5a9c7e2c6eb</span>
<a href="#l3.2871"></a><span id="l3.2871" class="difflineminus">-b1b8f17a58e8d043da56f06f0f9f62e5217b6ba3a1b76f6c9e99e8696a2a72e2</span>
<a href="#l3.2872"></a><span id="l3.2872" class="difflineminus">-c4fb1e4d452e92ec9652b807486d12b6669be00db38d9114b0c1961e375461a5</span>
<a href="#l3.2873"></a><span id="l3.2873" class="difflineminus">-5f76682a85c367ad6f682ff53a9c2a353191764b78bb07d8ddc3c97c1950f391</span>
<a href="#l3.2874"></a><span id="l3.2874" class="difflineminus">-6745c7b9852c73c2f212605a466a502705c8338069c8b9e84efab941eb393a97</span>
<a href="#l3.2875"></a><span id="l3.2875" class="difflineminus">-d4c9fd63148314209f1c1d3434e847ead6380de291d6f26a25c1ebb5047f5f24</span>
<a href="#l3.2876"></a><span id="l3.2876" class="difflineminus">-d85c49f0f22cc1d34282c72709cab90477bf25b89d49f0f351822297e0ea9704</span>
<a href="#l3.2877"></a><span id="l3.2877" class="difflineminus">-f34c82bc94002448ede51866e5656aef5d7c6a385cb4d80e6a538ceba04e6df2</span>
<a href="#l3.2878"></a><span id="l3.2878" class="difflineminus">-480e9aa84ddedb413bb5c97b3838456df2d4fec2c7a706983e7474d085fae820</span>
<a href="#l3.2879"></a><span id="l3.2879" class="difflineminus">-a841776a83073838973ac0413fea2f1dc4a06e71108fda73109bdae48954ad60</span>
<a href="#l3.2880"></a><span id="l3.2880" class="difflineminus">-bf867aac3ce44c7c1589a711cf8a81df9b219679d96d1cec3d8bbbeaa2012626</span>
<a href="#l3.2881"></a><span id="l3.2881" class="difflineminus">-df8c7802eda201b2d2e0239b409868171fc104ba8b76f10b4da09f6817ffc609</span>
<a href="#l3.2882"></a><span id="l3.2882" class="difflineminus">-c413ede267fd1fbab46880c90f80eccf0013185eb48b47ba03df2bdaadef3181</span>
<a href="#l3.2883"></a><span id="l3.2883" class="difflineminus">-cb8976f18e13188768170f98c0f844bb78cb04c62ddac59d09fc3fa25dfc1da4</span>
<a href="#l3.2884"></a><span id="l3.2884" class="difflineminus">-14deb3df1344f70000000049454e44ae426082</span>
<a href="#l3.2885"></a><span id="l3.2885" class="difflineminus">-&quot;&quot;&quot;),</span>
<a href="#l3.2886"></a><span id="l3.2886" class="difflineminus">-  'basi3p08': _dehex(&quot;&quot;&quot;</span>
<a href="#l3.2887"></a><span id="l3.2887" class="difflineminus">-89504e470d0a1a0a0000000d494844520000002000000020080300000133a3ba</span>
<a href="#l3.2888"></a><span id="l3.2888" class="difflineminus">-500000000467414d41000186a031e8965f00000300504c5445224400f5ffed77</span>
<a href="#l3.2889"></a><span id="l3.2889" class="difflineminus">-ff77cbffff110a003a77002222ffff11ff110000222200ffac5566ff66ff6666</span>
<a href="#l3.2890"></a><span id="l3.2890" class="difflineminus">-ff01ff221200dcffffccff994444ff005555220000cbcbff44440055ff55cbcb</span>
<a href="#l3.2891"></a><span id="l3.2891" class="difflineminus">-00331a00ffecdcedffffe4ffcbffdcdc44ff446666ff330000442200ededff66</span>
<a href="#l3.2892"></a><span id="l3.2892" class="difflineminus">-6600ffa444ffffaaeded0000cbcbfefffffdfffeffff0133ff33552a000101ff</span>
<a href="#l3.2893"></a><span id="l3.2893" class="difflineminus">-8888ff00aaaa010100440000888800ffe4cbba5b0022ff22663200ffff99aaaa</span>
<a href="#l3.2894"></a><span id="l3.2894" class="difflineminus">-ff550000aaaa00cb630011ff11d4ffaa773a00ff4444dc6b0066000001ff0188</span>
<a href="#l3.2895"></a><span id="l3.2895" class="difflineminus">-4200ecffdc6bdc00ffdcba00333300ed00ed7300ffff88994a0011ffff770000</span>
<a href="#l3.2896"></a><span id="l3.2896" class="difflineminus">-ff8301ffbabafe7b00fffeff00cb00ff999922ffff880000ffff77008888ffdc</span>
<a href="#l3.2897"></a><span id="l3.2897" class="difflineminus">-ff1a33000000aa33ffff009900990000000001326600ffbaff44ffffffaaff00</span>
<a href="#l3.2898"></a><span id="l3.2898" class="difflineminus">-770000fefeaa00004a9900ffff66ff22220000998bff1155ffffff0101ff88ff</span>
<a href="#l3.2899"></a><span id="l3.2899" class="difflineminus">-005500001111fffffefffdfea4ff4466ffffff66ff003300ffff55ff77770000</span>
<a href="#l3.2900"></a><span id="l3.2900" class="difflineminus">-88ff44ff00110077ffff006666ffffed000100fff5ed1111ffffff44ff22ffff</span>
<a href="#l3.2901"></a><span id="l3.2901" class="difflineminus">-eded11110088ffff00007793ff2200dcdc3333fffe00febabaff99ffff333300</span>
<a href="#l3.2902"></a><span id="l3.2902" class="difflineminus">-63cb00baba00acff55ffffdcffff337bfe00ed00ed5555ffaaffffdcdcff5555</span>
<a href="#l3.2903"></a><span id="l3.2903" class="difflineminus">-00000066dcdc00dc00dc83ff017777fffefeffffffcbff5555777700fefe00cb</span>
<a href="#l3.2904"></a><span id="l3.2904" class="difflineminus">-00cb0000fe010200010000122200ffff220044449bff33ffd4aa0000559999ff</span>
<a href="#l3.2905"></a><span id="l3.2905" class="difflineminus">-999900ba00ba2a5500ffcbcbb4ff66ff9b33ffffbaaa00aa42880053aa00ffaa</span>
<a href="#l3.2906"></a><span id="l3.2906" class="difflineminus">-aa0000ed00babaffff1100fe00000044009999990099ffcc99ba000088008800</span>
<a href="#l3.2907"></a><span id="l3.2907" class="difflineminus">-dc00ff93220000dcfefffeaa5300770077020100cb0000000033ffedff00ba00</span>
<a href="#l3.2908"></a><span id="l3.2908" class="difflineminus">-ff3333edffedffc488bcff7700aa00660066002222dc0000ffcbffdcffdcff8b</span>
<a href="#l3.2909"></a><span id="l3.2909" class="difflineminus">-110000cb00010155005500880000002201ffffcbffcbed0000ff88884400445b</span>
<a href="#l3.2910"></a><span id="l3.2910" class="difflineminus">-ba00ffbc77ff99ff006600baffba00777773ed00fe00003300330000baff77ff</span>
<a href="#l3.2911"></a><span id="l3.2911" class="difflineminus">-004400aaffaafffefe000011220022c4ff8800eded99ff99ff55ff002200ffb4</span>
<a href="#l3.2912"></a><span id="l3.2912" class="difflineminus">-661100110a1100ff1111dcffbabaffff88ff88010001ff33ffb98ed362000002</span>
<a href="#l3.2913"></a><span id="l3.2913" class="difflineminus">-a249444154789c65d0695c0b001806f03711a9904a94d24dac63292949e5a810</span>
<a href="#l3.2914"></a><span id="l3.2914" class="difflineminus">-d244588a14ca5161d1a1323973252242d62157d12ae498c8124d25ca3a11398a</span>
<a href="#l3.2915"></a><span id="l3.2915" class="difflineminus">-16e55a3cdffab0ffe7f77d7fcff3528645349b584c3187824d9d19d4ec2e3523</span>
<a href="#l3.2916"></a><span id="l3.2916" class="difflineminus">-9eb0ae975cf8de02f2486d502191841b42967a1ad49e5ddc4265f69a899e26b5</span>
<a href="#l3.2917"></a><span id="l3.2917" class="difflineminus">-e9e468181baae3a71a41b95669da8df2ea3594c1b31046d7b17bfb86592e4cbe</span>
<a href="#l3.2918"></a><span id="l3.2918" class="difflineminus">-d89b23e8db0af6304d756e60a8f4ad378bdc2552ae5948df1d35b52143141533</span>
<a href="#l3.2919"></a><span id="l3.2919" class="difflineminus">-33bbbbababebeb3b3bc9c9c9c6c6c0c0d7b7b535323225a5aa8a02024a4bedec</span>
<a href="#l3.2920"></a><span id="l3.2920" class="difflineminus">-0a0a2a2bcdcd7d7cf2f3a9a9c9cdcdd8b8adcdd5b5ababa828298982824a4ab2</span>
<a href="#l3.2921"></a><span id="l3.2921" class="difflineminus">-b21212acadbdbc1414e2e24859b9a72730302f4f49292c4c57373c9c0a0b7372</span>
<a href="#l3.2922"></a><span id="l3.2922" class="difflineminus">-8c8c1c1c3a3a92936d6dfdfd293e3e26262a4a4eaea2424b4b5fbfbc9c323278</span>
<a href="#l3.2923"></a><span id="l3.2923" class="difflineminus">-3c0b0ba1303abaae8ecdeeed950d6669a9a7a7a141d4de9e9d5d5cdcd2229b94</span>
<a href="#l3.2924"></a><span id="l3.2924" class="difflineminus">-c572716132f97cb1d8db9bc3110864a39795d9db6b6a26267a7a9a98d4d6a6a7</span>
<a href="#l3.2925"></a><span id="l3.2925" class="difflineminus">-cb76090ef6f030354d4d75766e686030545464cb393a1a1ac6c68686eae8f8f9</span>
<a href="#l3.2926"></a><span id="l3.2926" class="difflineminus">-a9aa4644c8b66d6e1689dcdd2512a994cb35330b0991ad9f9b6b659596a6addd</span>
<a href="#l3.2927"></a><span id="l3.2927" class="difflineminus">-d8282fafae5e5323fb8f41d01f76c22fd8061be01bfc041a0323e1002c81cd30</span>
<a href="#l3.2928"></a><span id="l3.2928" class="difflineminus">-0b9ec027a0c930014ec035580fc3e112bc069a0b53e11c0c8095f00176c163a0</span>
<a href="#l3.2929"></a><span id="l3.2929" class="difflineminus">-e5301baec06a580677600ddc05ba0f13e120bc81a770133ec355a017300d4ec2</span>
<a href="#l3.2930"></a><span id="l3.2930" class="difflineminus">-0c7800bbe1219c02fa08f3e13c1c85dbb00a2ec05ea0dff00a6ec15a98027360</span>
<a href="#l3.2931"></a><span id="l3.2931" class="difflineminus">-070c047a06d7e1085c84f1b014f6c03fa0b33018b6c0211801ebe018fc00da0a</span>
<a href="#l3.2932"></a><span id="l3.2932" class="difflineminus">-6f61113c877eb01d4ec317a085700f26c130f80efbe132bc039a0733e106fc81</span>
<a href="#l3.2933"></a><span id="l3.2933" class="difflineminus">-f7f017f6c10aa0d1300a0ec374780943e1382c06fa0a9b60238c83473016cec0</span>
<a href="#l3.2934"></a><span id="l3.2934" class="difflineminus">-02f80f73fefe1072afc1e50000000049454e44ae426082</span>
<a href="#l3.2935"></a><span id="l3.2935" class="difflineminus">-&quot;&quot;&quot;),</span>
<a href="#l3.2936"></a><span id="l3.2936" class="difflineminus">-  'basi6a08': _dehex(&quot;&quot;&quot;</span>
<a href="#l3.2937"></a><span id="l3.2937" class="difflineminus">-89504e470d0a1a0a0000000d4948445200000020000000200806000001047d4a</span>
<a href="#l3.2938"></a><span id="l3.2938" class="difflineminus">-620000000467414d41000186a031e8965f0000012049444154789cc595414ec3</span>
<a href="#l3.2939"></a><span id="l3.2939" class="difflineminus">-3010459fa541b8bbb26641b8069b861e8b4d12c1c112c1452a710a2a65d840d5</span>
<a href="#l3.2940"></a><span id="l3.2940" class="difflineminus">-949041fc481ec98ae27c7f3f8d27e3e4648047600fec0d1f390fbbe2633a31e2</span>
<a href="#l3.2941"></a><span id="l3.2941" class="difflineminus">-9389e4e4ea7bfdbf3d9a6b800ab89f1bd6b553cfcbb0679e960563d72e0a9293</span>
<a href="#l3.2942"></a><span id="l3.2942" class="difflineminus">-b7337b9f988cc67f5f0e186d20e808042f1c97054e1309da40d02d7e27f92e03</span>
<a href="#l3.2943"></a><span id="l3.2943" class="difflineminus">-6cbfc64df0fc3117a6210a1b6ad1a00df21c1abcf2a01944c7101b0cb568a001</span>
<a href="#l3.2944"></a><span id="l3.2944" class="difflineminus">-909c9cf9e399cf3d8d9d4660a875405d9a60d000b05e2de55e25780b7a5268e0</span>
<a href="#l3.2945"></a><span id="l3.2945" class="difflineminus">-622118e2399aab063a815808462f1ab86890fc2e03e48bb109ded7d26ce4bf59</span>
<a href="#l3.2946"></a><span id="l3.2946" class="difflineminus">-0db91bac0050747fec5015ce80da0e5700281be533f0ce6d5900b59bcb00ea6d</span>
<a href="#l3.2947"></a><span id="l3.2947" class="difflineminus">-200314cf801faab200ea752803a8d7a90c503a039f824a53f4694e7342000000</span>
<a href="#l3.2948"></a><span id="l3.2948" class="difflineminus">-0049454e44ae426082</span>
<a href="#l3.2949"></a><span id="l3.2949" class="difflineminus">-&quot;&quot;&quot;),</span>
<a href="#l3.2950"></a><span id="l3.2950" class="difflineminus">-  'basn0g01': _dehex(&quot;&quot;&quot;</span>
<a href="#l3.2951"></a><span id="l3.2951" class="difflineminus">-89504e470d0a1a0a0000000d49484452000000200000002001000000005b0147</span>
<a href="#l3.2952"></a><span id="l3.2952" class="difflineminus">-590000000467414d41000186a031e8965f0000005b49444154789c2dccb10903</span>
<a href="#l3.2953"></a><span id="l3.2953" class="difflineminus">-300c05d1ebd204b24a200b7a346f90153c82c18d0a61450751f1e08a2faaead2</span>
<a href="#l3.2954"></a><span id="l3.2954" class="difflineminus">-a4846ccea9255306e753345712e211b221bf4b263d1b427325255e8bdab29e6f</span>
<a href="#l3.2955"></a><span id="l3.2955" class="difflineminus">-6aca30692e9d29616ee96f3065f0bf1f1087492fd02f14c90000000049454e44</span>
<a href="#l3.2956"></a><span id="l3.2956" class="difflineminus">-ae426082</span>
<a href="#l3.2957"></a><span id="l3.2957" class="difflineminus">-&quot;&quot;&quot;),</span>
<a href="#l3.2958"></a><span id="l3.2958" class="difflineminus">-  'basn0g02': _dehex(&quot;&quot;&quot;</span>
<a href="#l3.2959"></a><span id="l3.2959" class="difflineminus">-89504e470d0a1a0a0000000d49484452000000200000002002000000001ca13d</span>
<a href="#l3.2960"></a><span id="l3.2960" class="difflineminus">-890000000467414d41000186a031e8965f0000001f49444154789c6360085df5</span>
<a href="#l3.2961"></a><span id="l3.2961" class="difflineminus">-1f8cf1308850c20053868f0133091f6390b90700bd497f818b0989a900000000</span>
<a href="#l3.2962"></a><span id="l3.2962" class="difflineminus">-49454e44ae426082</span>
<a href="#l3.2963"></a><span id="l3.2963" class="difflineminus">-&quot;&quot;&quot;),</span>
<a href="#l3.2964"></a><span id="l3.2964" class="difflineminus">-  # A version of basn0g04 dithered down to 3 bits.</span>
<a href="#l3.2965"></a><span id="l3.2965" class="difflineminus">-  'Basn0g03': _dehex(&quot;&quot;&quot;</span>
<a href="#l3.2966"></a><span id="l3.2966" class="difflineminus">-89504e470d0a1a0a0000000d494844520000002000000020040000000093e1c8</span>
<a href="#l3.2967"></a><span id="l3.2967" class="difflineminus">-2900000001734249540371d88211000000fd49444154789c6d90d18906210c84</span>
<a href="#l3.2968"></a><span id="l3.2968" class="difflineminus">-c356f22356b2889588604301b112112b11d94a96bb495cf7fe87f32d996f2689</span>
<a href="#l3.2969"></a><span id="l3.2969" class="difflineminus">-44741cc658e39c0b118f883e1f63cc89dafbc04c0f619d7d898396c54b875517</span>
<a href="#l3.2970"></a><span id="l3.2970" class="difflineminus">-83f3a2e7ac09a2074430e7f497f00f1138a5444f82839c5206b1f51053cca968</span>
<a href="#l3.2971"></a><span id="l3.2971" class="difflineminus">-63258821e7f2b5438aac16fbecc052b646e709de45cf18996b29648508728612</span>
<a href="#l3.2972"></a><span id="l3.2972" class="difflineminus">-952ca606a73566d44612b876845e9a347084ea4868d2907ff06be4436c4b41a3</span>
<a href="#l3.2973"></a><span id="l3.2973" class="difflineminus">-a3e1774285614c5affb40dbd931a526619d9fa18e4c2be420858de1df0e69893</span>
<a href="#l3.2974"></a><span id="l3.2974" class="difflineminus">-a0e3e5523461be448561001042b7d4a15309ce2c57aef2ba89d1c13794a109d7</span>
<a href="#l3.2975"></a><span id="l3.2975" class="difflineminus">-b5880aa27744fc5c4aecb5e7bcef5fe528ec6293a930690000000049454e44ae</span>
<a href="#l3.2976"></a><span id="l3.2976" class="difflineminus">-426082</span>
<a href="#l3.2977"></a><span id="l3.2977" class="difflineminus">-&quot;&quot;&quot;),</span>
<a href="#l3.2978"></a><span id="l3.2978" class="difflineminus">-  'basn0g04': _dehex(&quot;&quot;&quot;</span>
<a href="#l3.2979"></a><span id="l3.2979" class="difflineminus">-89504e470d0a1a0a0000000d494844520000002000000020040000000093e1c8</span>
<a href="#l3.2980"></a><span id="l3.2980" class="difflineminus">-290000000467414d41000186a031e8965f0000004849444154789c6360601014</span>
<a href="#l3.2981"></a><span id="l3.2981" class="difflineminus">-545232367671090d4d4b2b2f6720430095dbd1418e002a77e64c720450b9ab56</span>
<a href="#l3.2982"></a><span id="l3.2982" class="difflineminus">-912380caddbd9b1c0154ee9933e408a072efde25470095fbee1d1902001f14ee</span>
<a href="#l3.2983"></a><span id="l3.2983" class="difflineminus">-01eaff41fa0000000049454e44ae426082</span>
<a href="#l3.2984"></a><span id="l3.2984" class="difflineminus">-&quot;&quot;&quot;),</span>
<a href="#l3.2985"></a><span id="l3.2985" class="difflineminus">-  'basn0g08': _dehex(&quot;&quot;&quot;</span>
<a href="#l3.2986"></a><span id="l3.2986" class="difflineminus">-89504e470d0a1a0a0000000d4948445200000020000000200800000000561125</span>
<a href="#l3.2987"></a><span id="l3.2987" class="difflineminus">-280000000467414d41000186a031e8965f0000004149444154789c6364602400</span>
<a href="#l3.2988"></a><span id="l3.2988" class="difflineminus">-1408c8b30c05058c0f0829f8f71f3f6079301c1430ca11906764a2795c0c0605</span>
<a href="#l3.2989"></a><span id="l3.2989" class="difflineminus">-8c8ff0cafeffcff887e67131181430cae0956564040050e5fe7135e2d8590000</span>
<a href="#l3.2990"></a><span id="l3.2990" class="difflineminus">-000049454e44ae426082</span>
<a href="#l3.2991"></a><span id="l3.2991" class="difflineminus">-&quot;&quot;&quot;),</span>
<a href="#l3.2992"></a><span id="l3.2992" class="difflineminus">-  'basn0g16': _dehex(&quot;&quot;&quot;</span>
<a href="#l3.2993"></a><span id="l3.2993" class="difflineminus">-89504e470d0a1a0a0000000d49484452000000200000002010000000000681f9</span>
<a href="#l3.2994"></a><span id="l3.2994" class="difflineminus">-6b0000000467414d41000186a031e8965f0000005e49444154789cd5d2310ac0</span>
<a href="#l3.2995"></a><span id="l3.2995" class="difflineminus">-300c4351395bef7fc6dca093c0287b32d52a04a3d98f3f3880a7b857131363a0</span>
<a href="#l3.2996"></a><span id="l3.2996" class="difflineminus">-3a82601d089900dd82f640ca04e816dc06422640b7a03d903201ba05b7819009</span>
<a href="#l3.2997"></a><span id="l3.2997" class="difflineminus">-d02d680fa44c603f6f07ec4ff41938cf7f0016d84bd85fae2b9fd70000000049</span>
<a href="#l3.2998"></a><span id="l3.2998" class="difflineminus">-454e44ae426082</span>
<a href="#l3.2999"></a><span id="l3.2999" class="difflineminus">-&quot;&quot;&quot;),</span>
<a href="#l3.3000"></a><span id="l3.3000" class="difflineminus">-  'basn2c08': _dehex(&quot;&quot;&quot;</span>
<a href="#l3.3001"></a><span id="l3.3001" class="difflineminus">-89504e470d0a1a0a0000000d4948445200000020000000200802000000fc18ed</span>
<a href="#l3.3002"></a><span id="l3.3002" class="difflineminus">-a30000000467414d41000186a031e8965f0000004849444154789cedd5c10900</span>
<a href="#l3.3003"></a><span id="l3.3003" class="difflineminus">-300c024085ec91fdb772133b442bf4a1f8cee12bb40d043b800a14f81ca0ede4</span>
<a href="#l3.3004"></a><span id="l3.3004" class="difflineminus">-7d4c784081020f4a871fc284071428f0a0743823a94081bb7077a3c00182b1f9</span>
<a href="#l3.3005"></a><span id="l3.3005" class="difflineminus">-5e0f40cf4b0000000049454e44ae426082</span>
<a href="#l3.3006"></a><span id="l3.3006" class="difflineminus">-&quot;&quot;&quot;),</span>
<a href="#l3.3007"></a><span id="l3.3007" class="difflineminus">-  'basn2c16': _dehex(&quot;&quot;&quot;</span>
<a href="#l3.3008"></a><span id="l3.3008" class="difflineminus">-89504e470d0a1a0a0000000d4948445200000020000000201002000000ac8831</span>
<a href="#l3.3009"></a><span id="l3.3009" class="difflineminus">-e00000000467414d41000186a031e8965f000000e549444154789cd596c10a83</span>
<a href="#l3.3010"></a><span id="l3.3010" class="difflineminus">-301044a7e0417fcb7eb7fdadf6961e06039286266693cc7a188645e43dd6a08f</span>
<a href="#l3.3011"></a><span id="l3.3011" class="difflineminus">-1042003e2fe09aef6472737e183d27335fcee2f35a77b702ebce742870a23397</span>
<a href="#l3.3012"></a><span id="l3.3012" class="difflineminus">-f3edf2705dd10160f3b2815fe8ecf2027974a6b0c03f74a6e4192843e75c6c03</span>
<a href="#l3.3013"></a><span id="l3.3013" class="difflineminus">-35e8ec3202f5e84c0181bbe8cca967a00d9df3491bb040671f2e6087ce1c2860</span>
<a href="#l3.3014"></a><span id="l3.3014" class="difflineminus">-8d1e05f8c7ee0f1d00b667e70df44467ef26d01fbd9bc028f42860f71d188bce</span>
<a href="#l3.3015"></a><span id="l3.3015" class="difflineminus">-fb8d3630039dbd59601e7ab3c06cf428507f0634d039afdc80123a7bb1801e7a</span>
<a href="#l3.3016"></a><span id="l3.3016" class="difflineminus">-b1802a7a14c89f016d74ce331bf080ce9e08f8414f04bca133bfe642fe5e07bb</span>
<a href="#l3.3017"></a><span id="l3.3017" class="difflineminus">-c4ec0000000049454e44ae426082</span>
<a href="#l3.3018"></a><span id="l3.3018" class="difflineminus">-&quot;&quot;&quot;),</span>
<a href="#l3.3019"></a><span id="l3.3019" class="difflineminus">-  'basn6a08': _dehex(&quot;&quot;&quot;</span>
<a href="#l3.3020"></a><span id="l3.3020" class="difflineminus">-89504e470d0a1a0a0000000d4948445200000020000000200806000000737a7a</span>
<a href="#l3.3021"></a><span id="l3.3021" class="difflineminus">-f40000000467414d41000186a031e8965f0000006f49444154789cedd6310a80</span>
<a href="#l3.3022"></a><span id="l3.3022" class="difflineminus">-300c46e12764684fa1f73f55048f21c4ddc545781d52e85028fc1f4d28d98a01</span>
<a href="#l3.3023"></a><span id="l3.3023" class="difflineminus">-305e7b7e9cffba33831d75054703ca06a8f90d58a0074e351e227d805c8254e3</span>
<a href="#l3.3024"></a><span id="l3.3024" class="difflineminus">-1bb0420f5cdc2e0079208892ffe2a00136a07b4007943c1004d900195036407f</span>
<a href="#l3.3025"></a><span id="l3.3025" class="difflineminus">-011bf00052201a9c160fb84c0000000049454e44ae426082</span>
<a href="#l3.3026"></a><span id="l3.3026" class="difflineminus">-&quot;&quot;&quot;),</span>
<a href="#l3.3027"></a><span id="l3.3027" class="difflineminus">-  'cs3n3p08': _dehex(&quot;&quot;&quot;</span>
<a href="#l3.3028"></a><span id="l3.3028" class="difflineminus">-89504e470d0a1a0a0000000d494844520000002000000020080300000044a48a</span>
<a href="#l3.3029"></a><span id="l3.3029" class="difflineminus">-c60000000467414d41000186a031e8965f0000000373424954030303a392a042</span>
<a href="#l3.3030"></a><span id="l3.3030" class="difflineminus">-00000054504c544592ff0000ff9200ffff00ff0000dbff00ff6dffb600006dff</span>
<a href="#l3.3031"></a><span id="l3.3031" class="difflineminus">-b6ff00ff9200dbff000049ffff2400ff000024ff0049ff0000ffdb00ff4900ff</span>
<a href="#l3.3032"></a><span id="l3.3032" class="difflineminus">-b6ffff0000ff2400b6ffffdb000092ffff6d000024ffff49006dff00df702b17</span>
<a href="#l3.3033"></a><span id="l3.3033" class="difflineminus">-0000004b49444154789c85cac70182000000b1b3625754b0edbfa72324ef7486</span>
<a href="#l3.3034"></a><span id="l3.3034" class="difflineminus">-184ed0177a437b680bcdd0031c0ed00ea21f74852ed00a1c9ed0086da0057487</span>
<a href="#l3.3035"></a><span id="l3.3035" class="difflineminus">-6ed0121cd6d004bda0013a421ff803224033e177f4ae260000000049454e44ae</span>
<a href="#l3.3036"></a><span id="l3.3036" class="difflineminus">-426082</span>
<a href="#l3.3037"></a><span id="l3.3037" class="difflineminus">-&quot;&quot;&quot;),</span>
<a href="#l3.3038"></a><span id="l3.3038" class="difflineminus">-  's09n3p02': _dehex(&quot;&quot;&quot;</span>
<a href="#l3.3039"></a><span id="l3.3039" class="difflineminus">-89504e470d0a1a0a0000000d49484452000000090000000902030000009dffee</span>
<a href="#l3.3040"></a><span id="l3.3040" class="difflineminus">-830000000467414d41000186a031e8965f000000037342495404040477f8b5a3</span>
<a href="#l3.3041"></a><span id="l3.3041" class="difflineminus">-0000000c504c544500ff000077ffff00ffff7700ff5600640000001f49444154</span>
<a href="#l3.3042"></a><span id="l3.3042" class="difflineminus">-789c63600002fbff0c0c56ab19182ca381581a4283f82071200000696505c36a</span>
<a href="#l3.3043"></a><span id="l3.3043" class="difflineminus">-437f230000000049454e44ae426082</span>
<a href="#l3.3044"></a><span id="l3.3044" class="difflineminus">-&quot;&quot;&quot;),</span>
<a href="#l3.3045"></a><span id="l3.3045" class="difflineminus">-  'tbgn3p08': _dehex(&quot;&quot;&quot;</span>
<a href="#l3.3046"></a><span id="l3.3046" class="difflineminus">-89504e470d0a1a0a0000000d494844520000002000000020080300000044a48a</span>
<a href="#l3.3047"></a><span id="l3.3047" class="difflineminus">-c60000000467414d41000186a031e8965f00000207504c54457f7f7fafafafab</span>
<a href="#l3.3048"></a><span id="l3.3048" class="difflineminus">-abab110000222200737300999999510d00444400959500959595e6e600919191</span>
<a href="#l3.3049"></a><span id="l3.3049" class="difflineminus">-8d8d8d620d00898989666600b7b700911600000000730d007373736f6f6faaaa</span>
<a href="#l3.3050"></a><span id="l3.3050" class="difflineminus">-006b6b6b676767c41a00cccc0000f30000ef00d51e0055555567670000dd0051</span>
<a href="#l3.3051"></a><span id="l3.3051" class="difflineminus">-515100d1004d4d4de61e0038380000b700160d0d00ab00560d00090900009500</span>
<a href="#l3.3052"></a><span id="l3.3052" class="difflineminus">-009100008d003333332f2f2f2f2b2f2b2b000077007c7c001a05002b27000073</span>
<a href="#l3.3053"></a><span id="l3.3053" class="difflineminus">-002b2b2b006f00bb1600272727780d002323230055004d4d00cc1e00004d00cc</span>
<a href="#l3.3054"></a><span id="l3.3054" class="difflineminus">-1a000d00003c09006f6f00002f003811271111110d0d0d55554d090909001100</span>
<a href="#l3.3055"></a><span id="l3.3055" class="difflineminus">-4d0900050505000d00e2e200000900000500626200a6a6a6a2a2a29e9e9e8484</span>
<a href="#l3.3056"></a><span id="l3.3056" class="difflineminus">-00fb00fbd5d500801100800d00ea00ea555500a6a600e600e6f7f700e200e233</span>
<a href="#l3.3057"></a><span id="l3.3057" class="difflineminus">-0500888888d900d9848484c01a007777003c3c05c8c8008080804409007c7c7c</span>
<a href="#l3.3058"></a><span id="l3.3058" class="difflineminus">-bb00bbaa00aaa600a61e09056262629e009e9a009af322005e5e5e05050000ee</span>
<a href="#l3.3059"></a><span id="l3.3059" class="difflineminus">-005a5a5adddd00a616008d008d00e20016050027270088110078780000c40078</span>
<a href="#l3.3060"></a><span id="l3.3060" class="difflineminus">-00787300736f006f44444400aa00c81e004040406600663c3c3c090000550055</span>
<a href="#l3.3061"></a><span id="l3.3061" class="difflineminus">-1a1a00343434d91e000084004d004d007c004500453c3c00ea1e00222222113c</span>
<a href="#l3.3062"></a><span id="l3.3062" class="difflineminus">-113300331e1e1efb22001a1a1a004400afaf00270027003c001616161e001e0d</span>
<a href="#l3.3063"></a><span id="l3.3063" class="difflineminus">-160d2f2f00808000001e00d1d1001100110d000db7b7b7090009050005b3b3b3</span>
<a href="#l3.3064"></a><span id="l3.3064" class="difflineminus">-6d34c4230000000174524e530040e6d86600000001624b474402660b7c640000</span>
<a href="#l3.3065"></a><span id="l3.3065" class="difflineminus">-01f249444154789c6360c0048c8c58049100575f215ee92e6161ef109cd2a15e</span>
<a href="#l3.3066"></a><span id="l3.3066" class="difflineminus">-4b9645ce5d2c8f433aa4c24f3cbd4c98833b2314ab74a186f094b9c2c27571d2</span>
<a href="#l3.3067"></a><span id="l3.3067" class="difflineminus">-6a2a58e4253c5cda8559057a392363854db4d9d0641973660b0b0bb76bb16656</span>
<a href="#l3.3068"></a><span id="l3.3068" class="difflineminus">-06970997256877a07a95c75a1804b2fbcd128c80b482a0b0300f8a824276a9a8</span>
<a href="#l3.3069"></a><span id="l3.3069" class="difflineminus">-ec6e61612b3e57ee06fbf0009619d5fac846ac5c60ed20e754921625a2daadc6</span>
<a href="#l3.3070"></a><span id="l3.3070" class="difflineminus">-1967e29e97d2239c8aec7e61fdeca9cecebef54eb36c848517164514af16169e</span>
<a href="#l3.3071"></a><span id="l3.3071" class="difflineminus">-866444b2b0b7b55534c815cc2ec22d89cd1353800a8473100a4485852d924a6a</span>
<a href="#l3.3072"></a><span id="l3.3072" class="difflineminus">-412adc74e7ad1016ceed043267238c901716f633a812022998a4072267c4af02</span>
<a href="#l3.3073"></a><span id="l3.3073" class="difflineminus">-92127005c0f811b62830054935ce017b38bf0948cc5c09955f030a24617d9d46</span>
<a href="#l3.3074"></a><span id="l3.3074" class="difflineminus">-63371fd940b0827931cbfdf4956076ac018b592f72d45594a9b1f307f3261b1a</span>
<a href="#l3.3075"></a><span id="l3.3075" class="difflineminus">-084bc2ad50018b1900719ba6ba4ca325d0427d3f6161449486f981144cf3100e</span>
<a href="#l3.3076"></a><span id="l3.3076" class="difflineminus">-2a5f2a1ce8683e4ddf1b64275240c8438d98af0c729bbe07982b8a1c94201dc2</span>
<a href="#l3.3077"></a><span id="l3.3077" class="difflineminus">-b3174c9820bcc06201585ad81b25b64a2146384e3798290c05ad280a18c0a62e</span>
<a href="#l3.3078"></a><span id="l3.3078" class="difflineminus">-e898260c07fca80a24c076cc864b777131a00190cdfa3069035eccbc038c30e1</span>
<a href="#l3.3079"></a><span id="l3.3079" class="difflineminus">-3e88b46d16b6acc5380d6ac202511c392f4b789aa7b0b08718765990111606c2</span>
<a href="#l3.3080"></a><span id="l3.3080" class="difflineminus">-9e854c38e5191878fbe471e749b0112bb18902008dc473b2b2e8e72700000000</span>
<a href="#l3.3081"></a><span id="l3.3081" class="difflineminus">-49454e44ae426082</span>
<a href="#l3.3082"></a><span id="l3.3082" class="difflineminus">-&quot;&quot;&quot;),</span>
<a href="#l3.3083"></a><span id="l3.3083" class="difflineminus">-  'Tp2n3p08': _dehex(&quot;&quot;&quot;</span>
<a href="#l3.3084"></a><span id="l3.3084" class="difflineminus">-89504e470d0a1a0a0000000d494844520000002000000020080300000044a48a</span>
<a href="#l3.3085"></a><span id="l3.3085" class="difflineminus">-c60000000467414d41000186a031e8965f00000300504c544502ffff80ff05ff</span>
<a href="#l3.3086"></a><span id="l3.3086" class="difflineminus">-7f0703ff7f0180ff04ff00ffff06ff000880ff05ff7f07ffff06ff000804ff00</span>
<a href="#l3.3087"></a><span id="l3.3087" class="difflineminus">-0180ff02ffff03ff7f02ffff80ff0503ff7f0180ffff0008ff7f0704ff00ffff</span>
<a href="#l3.3088"></a><span id="l3.3088" class="difflineminus">-06ff000802ffffff7f0704ff0003ff7fffff0680ff050180ff04ff000180ffff</span>
<a href="#l3.3089"></a><span id="l3.3089" class="difflineminus">-0008ffff0603ff7f80ff05ff7f0702ffffff000880ff05ffff0603ff7f02ffff</span>
<a href="#l3.3090"></a><span id="l3.3090" class="difflineminus">-ff7f070180ff04ff00ffff06ff000880ff050180ffff7f0702ffff04ff0003ff</span>
<a href="#l3.3091"></a><span id="l3.3091" class="difflineminus">-7fff7f0704ff0003ff7f0180ffffff06ff000880ff0502ffffffff0603ff7fff</span>
<a href="#l3.3092"></a><span id="l3.3092" class="difflineminus">-7f0702ffff04ff000180ff80ff05ff0008ff7f07ffff0680ff0504ff00ff0008</span>
<a href="#l3.3093"></a><span id="l3.3093" class="difflineminus">-0180ff03ff7f02ffff02ffffffff0604ff0003ff7f0180ffff000880ff05ff7f</span>
<a href="#l3.3094"></a><span id="l3.3094" class="difflineminus">-0780ff05ff00080180ff02ffffff7f0703ff7fffff0604ff00ff7f07ff0008ff</span>
<a href="#l3.3095"></a><span id="l3.3095" class="difflineminus">-ff0680ff0504ff0002ffff0180ff03ff7fff0008ffff0680ff0504ff000180ff</span>
<a href="#l3.3096"></a><span id="l3.3096" class="difflineminus">-02ffff03ff7fff7f070180ff02ffff04ff00ffff06ff0008ff7f0780ff0503ff</span>
<a href="#l3.3097"></a><span id="l3.3097" class="difflineminus">-7fffff06ff0008ff7f0780ff0502ffff03ff7f0180ff04ff0002ffffff7f07ff</span>
<a href="#l3.3098"></a><span id="l3.3098" class="difflineminus">-ff0604ff0003ff7fff00080180ff80ff05ffff0603ff7f0180ffff000804ff00</span>
<a href="#l3.3099"></a><span id="l3.3099" class="difflineminus">-80ff0502ffffff7f0780ff05ffff0604ff000180ffff000802ffffff7f0703ff</span>
<a href="#l3.3100"></a><span id="l3.3100" class="difflineminus">-7fff0008ff7f070180ff03ff7f02ffff80ff05ffff0604ff00ff0008ffff0602</span>
<a href="#l3.3101"></a><span id="l3.3101" class="difflineminus">-ffff0180ff04ff0003ff7f80ff05ff7f070180ff04ff00ff7f0780ff0502ffff</span>
<a href="#l3.3102"></a><span id="l3.3102" class="difflineminus">-ff000803ff7fffff0602ffffff7f07ffff0680ff05ff000804ff0003ff7f0180</span>
<a href="#l3.3103"></a><span id="l3.3103" class="difflineminus">-ff02ffff0180ffff7f0703ff7fff000804ff0080ff05ffff0602ffff04ff00ff</span>
<a href="#l3.3104"></a><span id="l3.3104" class="difflineminus">-ff0603ff7fff7f070180ff80ff05ff000803ff7f0180ffff7f0702ffffff0008</span>
<a href="#l3.3105"></a><span id="l3.3105" class="difflineminus">-04ff00ffff0680ff0503ff7f0180ff04ff0080ff05ffff06ff000802ffffff7f</span>
<a href="#l3.3106"></a><span id="l3.3106" class="difflineminus">-0780ff05ff0008ff7f070180ff03ff7f04ff0002ffffffff0604ff00ff7f07ff</span>
<a href="#l3.3107"></a><span id="l3.3107" class="difflineminus">-000880ff05ffff060180ff02ffff03ff7f80ff05ffff0602ffff0180ff03ff7f</span>
<a href="#l3.3108"></a><span id="l3.3108" class="difflineminus">-04ff00ff7f07ff00080180ffff000880ff0502ffff04ff00ff7f0703ff7fffff</span>
<a href="#l3.3109"></a><span id="l3.3109" class="difflineminus">-06ff0008ffff0604ff00ff7f0780ff0502ffff03ff7f0180ffdeb83387000000</span>
<a href="#l3.3110"></a><span id="l3.3110" class="difflineminus">-f874524e53000000000000000008080808080808081010101010101010181818</span>
<a href="#l3.3111"></a><span id="l3.3111" class="difflineminus">-1818181818202020202020202029292929292929293131313131313131393939</span>
<a href="#l3.3112"></a><span id="l3.3112" class="difflineminus">-393939393941414141414141414a4a4a4a4a4a4a4a52525252525252525a5a5a</span>
<a href="#l3.3113"></a><span id="l3.3113" class="difflineminus">-5a5a5a5a5a62626262626262626a6a6a6a6a6a6a6a73737373737373737b7b7b</span>
<a href="#l3.3114"></a><span id="l3.3114" class="difflineminus">-7b7b7b7b7b83838383838383838b8b8b8b8b8b8b8b94949494949494949c9c9c</span>
<a href="#l3.3115"></a><span id="l3.3115" class="difflineminus">-9c9c9c9c9ca4a4a4a4a4a4a4a4acacacacacacacacb4b4b4b4b4b4b4b4bdbdbd</span>
<a href="#l3.3116"></a><span id="l3.3116" class="difflineminus">-bdbdbdbdbdc5c5c5c5c5c5c5c5cdcdcdcdcdcdcdcdd5d5d5d5d5d5d5d5dedede</span>
<a href="#l3.3117"></a><span id="l3.3117" class="difflineminus">-dededededee6e6e6e6e6e6e6e6eeeeeeeeeeeeeeeef6f6f6f6f6f6f6f6b98ac5</span>
<a href="#l3.3118"></a><span id="l3.3118" class="difflineminus">-ca0000012c49444154789c6360e7169150d230b475f7098d4ccc28a96ced9e32</span>
<a href="#l3.3119"></a><span id="l3.3119" class="difflineminus">-63c1da2d7b8e9fb97af3d1fb8f3f18e8a0808953544a4dd7c4c2c9233c2621bf</span>
<a href="#l3.3120"></a><span id="l3.3120" class="difflineminus">-b4aab17fdacce5ab36ee3a72eafaad87efbefea68702362e7159652d031b07cf</span>
<a href="#l3.3121"></a><span id="l3.3121" class="difflineminus">-c0b8a4cce28aa68e89f316aedfb4ffd0b92bf79fbcfcfe931e0a183904e55435</span>
<a href="#l3.3122"></a><span id="l3.3122" class="difflineminus">-8decdcbcc22292b3caaadb7b27cc5db67af3be63e72fdf78fce2d31f7a2860e5</span>
<a href="#l3.3123"></a><span id="l3.3123" class="difflineminus">-119356d037b374f10e8a4fc92eaa6fee99347fc9caad7b0f9ebd74f7c1db2fbf</span>
<a href="#l3.3124"></a><span id="l3.3124" class="difflineminus">-e8a180995f484645dbdccad12f38363dafbcb6a573faeca5ebb6ed3e7ce2c29d</span>
<a href="#l3.3125"></a><span id="l3.3125" class="difflineminus">-e76fbefda38702063e0149751d537b67ff80e8d4dcc29a86bea97316add9b0e3</span>
<a href="#l3.3126"></a><span id="l3.3126" class="difflineminus">-c0e96bf79ebdfafc971e0a587885e515f58cad5d7d43a2d2720aeadaba26cf5a</span>
<a href="#l3.3127"></a><span id="l3.3127" class="difflineminus">-bc62fbcea3272fde7efafac37f3a28000087c0fe101bc2f85f0000000049454e</span>
<a href="#l3.3128"></a><span id="l3.3128" class="difflineminus">-44ae426082</span>
<a href="#l3.3129"></a><span id="l3.3129" class="difflineminus">-&quot;&quot;&quot;),</span>
<a href="#l3.3130"></a><span id="l3.3130" class="difflineminus">-  'tbbn1g04': _dehex(&quot;&quot;&quot;</span>
<a href="#l3.3131"></a><span id="l3.3131" class="difflineminus">-89504e470d0a1a0a0000000d494844520000002000000020040000000093e1c8</span>
<a href="#l3.3132"></a><span id="l3.3132" class="difflineminus">-290000000467414d41000186a031e8965f0000000274524e530007e8f7589b00</span>
<a href="#l3.3133"></a><span id="l3.3133" class="difflineminus">-000002624b47440000aa8d23320000013e49444154789c55d1cd4b024118c7f1</span>
<a href="#l3.3134"></a><span id="l3.3134" class="difflineminus">-efbe6419045b6a48a72d352808b435284f9187ae9b098627a1573a19945beba5</span>
<a href="#l3.3135"></a><span id="l3.3135" class="difflineminus">-e8129e8222af11d81e3a4545742de8ef6af6d5762e0fbf0fc33c33f36085cb76</span>
<a href="#l3.3136"></a><span id="l3.3136" class="difflineminus">-bc4204778771b867260683ee57e13f0c922df5c719c2b3b6c6c25b2382cea4b9</span>
<a href="#l3.3137"></a><span id="l3.3137" class="difflineminus">-9f7d4f244370746ac71f4ca88e0f173a6496749af47de8e44ba8f3bf9bdfa98a</span>
<a href="#l3.3138"></a><span id="l3.3138" class="difflineminus">-0faf857a7dd95c7dc8d7c67c782c99727997f41eb2e3c1e554152465bb00fe8e</span>
<a href="#l3.3139"></a><span id="l3.3139" class="difflineminus">-b692d190b718d159f4c0a45c4435915a243c58a7a4312a7a57913f05747594c6</span>
<a href="#l3.3140"></a><span id="l3.3140" class="difflineminus">-46169866c57101e4d4ce4d511423119c419183a3530cc63db88559ae28e7342a</span>
<a href="#l3.3141"></a><span id="l3.3141" class="difflineminus">-1e9c8122b71139b8872d6e913153224bc1f35b60e4445bd4004e20ed6682c759</span>
<a href="#l3.3142"></a><span id="l3.3142" class="difflineminus">-1d9873b3da0fbf50137dc5c9bde84fdb2ec8bde1189e0448b63584735993c209</span>
<a href="#l3.3143"></a><span id="l3.3143" class="difflineminus">-7a601bd2710caceba6158797285b7f2084a2f82c57c01a0000000049454e44ae</span>
<a href="#l3.3144"></a><span id="l3.3144" class="difflineminus">-426082</span>
<a href="#l3.3145"></a><span id="l3.3145" class="difflineminus">-&quot;&quot;&quot;),</span>
<a href="#l3.3146"></a><span id="l3.3146" class="difflineminus">-  'tbrn2c08': _dehex(&quot;&quot;&quot;</span>
<a href="#l3.3147"></a><span id="l3.3147" class="difflineminus">-89504e470d0a1a0a0000000d4948445200000020000000200802000000fc18ed</span>
<a href="#l3.3148"></a><span id="l3.3148" class="difflineminus">-a30000000467414d41000186a031e8965f0000000674524e53007f007f007f8a</span>
<a href="#l3.3149"></a><span id="l3.3149" class="difflineminus">-33334f00000006624b474400ff0000000033277cf3000004d649444154789cad</span>
<a href="#l3.3150"></a><span id="l3.3150" class="difflineminus">-965f68537714c73fd912d640235e692f34d0406fa0c1663481045ab060065514</span>
<a href="#l3.3151"></a><span id="l3.3151" class="difflineminus">-56660a295831607df0a1488715167060840a1614e6431e9cb34fd2c00a762c85</span>
<a href="#l3.3152"></a><span id="l3.3152" class="difflineminus">-f6a10f816650c13b0cf40612e1822ddc4863bd628a8924d23d6464f9d3665dd9</span>
<a href="#l3.3153"></a><span id="l3.3153" class="difflineminus">-f7e977ce3dbff3cd3939bfdfef6bb87dfb364782dbed065ebe7cd93acc78b4ec</span>
<a href="#l3.3154"></a><span id="l3.3154" class="difflineminus">-a228debd7bb7bfbfbfbbbbfb7f261045311a8d261209405194274f9ea4d3e916</span>
<a href="#l3.3155"></a><span id="l3.3155" class="difflineminus">-f15f1c3eb5dd6e4fa5fecce526239184a2b0b8486f6f617171b1f5ae4311381c</span>
<a href="#l3.3156"></a><span id="l3.3156" class="difflineminus">-8e57af5e5dbd7a351088150a78bd389d44222c2f93cdfe66b7db8f4ee07038b6</span>
<a href="#l3.3157"></a><span id="l3.3157" class="difflineminus">-b6b6bebf766d7e7e7e60a06432313b4ba984c3c1c4049a46b95c5a58583822c1</span>
<a href="#l3.3158"></a><span id="l3.3158" class="difflineminus">-dbb76f27272733d1b9df853c3030c0f232562b9108cf9eb1b888d7cbf030abab</span>
<a href="#l3.3159"></a><span id="l3.3159" class="difflineminus">-31abd5fa1f08dc6ef7e7cf9f1f3f7e1c8944745d4f1400c62c001313acad21cb</span>
<a href="#l3.3160"></a><span id="l3.3160" class="difflineminus">-b8dd2c2c603271eb1640341aad4c6d331aa7e8c48913a150a861307ecc11e964</span>
<a href="#l3.3161"></a><span id="l3.3161" class="difflineminus">-74899919bc5e14e56fffc404f1388502f178dceff7ef4bf0a5cfe7abb533998c</span>
<a href="#l3.3162"></a><span id="l3.3162" class="difflineminus">-e5f9ea2f1dd88c180d64cb94412df3dd57e83a6b3b3c7a84c98420100c72fd3a</span>
<a href="#l3.3163"></a><span id="l3.3163" class="difflineminus">-636348bae726379fe69e8e8d8dbd79f3a6558b0607079796965256479b918085</span>
<a href="#l3.3164"></a><span id="l3.3164" class="difflineminus">-7b02db12712b6181950233023f3f647494ee6e2e5ea45864cce5b8a7fe3acffc</span>
<a href="#l3.3165"></a><span id="l3.3165" class="difflineminus">-3aebb22c2bd5d20e22d0757d7b7bbbbdbd3d94a313bed1b0aa3cd069838b163a</span>
<a href="#l3.3166"></a><span id="l3.3166" class="difflineminus">-8d4c59585f677292d0b84d9a995bd337def3fe6bbe5e6001989b9b6bfe27ea08</span>
<a href="#l3.3167"></a><span id="l3.3167" class="difflineminus">-36373781542ab56573248b4c5bc843ac4048c7ab21aa24ca00534c25482828a3</span>
<a href="#l3.3168"></a><span id="l3.3168" class="difflineminus">-8c9ee67475bbaaaab22cb722c8e57240a150301a8d219de94e44534d7d90e885</span>
<a href="#l3.3169"></a><span id="l3.3169" class="difflineminus">-87acb0e2c4f9800731629b6c5ee14a35a6b9887d2a0032994cb9cf15dbe59650</span>
<a href="#l3.3170"></a><span id="l3.3170" class="difflineminus">-ff7b46a04c9a749e7cc5112214266cc65c31354d5b5d5d3d90209bcd5616a552</span>
<a href="#l3.3171"></a><span id="l3.3171" class="difflineminus">-a95c2e87f2a659bd9ee01c2cd73964e438f129a6aa9e582c363838b80f81d7eb</span>
<a href="#l3.3172"></a><span id="l3.3172" class="difflineminus">-5555b56a2a8ad2d9d7affd0409f8015c208013fea00177b873831b0282c964f2</span>
<a href="#l3.3173"></a><span id="l3.3173" class="difflineminus">-783c1e8fa7582cee5f81a669b5e6eeeeaee58e8559b0c233d8843c7c0b963a82</span>
<a href="#l3.3174"></a><span id="l3.3174" class="difflineminus">-34e94b5cb2396d7d7d7db22c8ba258fb0afd43f0e2c58b919191ba9de9b4d425</span>
<a href="#l3.3175"></a><span id="l3.3175" class="difflineminus">-118329b0c3323c8709d02041b52b4ea7f39de75d2a934a2693c0a953a76a93d4</span>
<a href="#l3.3176"></a><span id="l3.3176" class="difflineminus">-5d157ebf7f6565a5542a553df97c5e10045dd731c130b86113cc300cbd489224</span>
<a href="#l3.3177"></a><span id="l3.3177" class="difflineminus">-08422a952a140a95788fc763b1d41558d7a2d7af5f5fb870a1d6a3aaaacd6603</span>
<a href="#l3.3178"></a><span id="l3.3178" class="difflineminus">-18802da84c59015bd2e6897b745d9765b99a1df0f97c0daf74e36deaf7fbcd66</span>
<a href="#l3.3179"></a><span id="l3.3179" class="difflineminus">-73ad2797cb89a2c839880188a2e8743a8bc5a22ccbba5e376466b3b9bdbdbd21</span>
<a href="#l3.3180"></a><span id="l3.3180" class="difflineminus">-6123413a9d0e0402b51e4dd3bababa788eb022b85caeb6b6364551b6b7b76942</span>
<a href="#l3.3181"></a><span id="l3.3181" class="difflineminus">-43f7f727007a7a7a04a1ee8065b3595fde2768423299ac1ec6669c3973e65004</span>
<a href="#l3.3182"></a><span id="l3.3182" class="difflineminus">-c0f8f878ad69341a33994ced2969c0d0d0502412f9f8f163f3a7fd654b474787</span>
<a href="#l3.3183"></a><span id="l3.3183" class="difflineminus">-288ad53e74757535df6215b85cae60302849d2410aecc037f9f2e5cbd5b5c160</span>
<a href="#l3.3184"></a><span id="l3.3184" class="difflineminus">-680eb0dbede170381c0e7ff8f0a185be3b906068684892a4ca7a6f6faff69328</span>
<a href="#l3.3185"></a><span id="l3.3185" class="difflineminus">-8ad3d3d3f7efdfdfdbdbfb57e96868a14d0d0643381c96242997cbe5f3794010</span>
<a href="#l3.3186"></a><span id="l3.3186" class="difflineminus">-84603078fcf8f1d6496bd14a3aba5c2ea7d369341a5555b5582c8140e0fcf9f3</span>
<a href="#l3.3187"></a><span id="l3.3187" class="difflineminus">-1b1b1b87cf4eeb0a8063c78e45a3d19e9e1ebfdfdf5a831e844655d18093274f</span>
<a href="#l3.3188"></a><span id="l3.3188" class="difflineminus">-9e3d7bf6d3a74f3b3b3b47c80efc05ff7af28fefb70d9b0000000049454e44ae</span>
<a href="#l3.3189"></a><span id="l3.3189" class="difflineminus">-426082</span>
<a href="#l3.3190"></a><span id="l3.3190" class="difflineminus">-&quot;&quot;&quot;),</span>
<a href="#l3.3191"></a><span id="l3.3191" class="difflineminus">-  'basn6a16': _dehex(&quot;&quot;&quot;</span>
<a href="#l3.3192"></a><span id="l3.3192" class="difflineminus">-89504e470d0a1a0a0000000d494844520000002000000020100600000023eaa6</span>
<a href="#l3.3193"></a><span id="l3.3193" class="difflineminus">-b70000000467414d41000186a031e8965f00000d2249444154789cdd995f6c1c</span>
<a href="#l3.3194"></a><span id="l3.3194" class="difflineminus">-d775c67ff38fb34b724d2ee55a8e4b04a0ac87049100cab4dbd8c6528902cb4d</span>
<a href="#l3.3195"></a><span id="l3.3195" class="difflineminus">-10881620592e52d4325ac0905bc98a94025e71fd622cb5065ac98a0c283050c0</span>
<a href="#l3.3196"></a><span id="l3.3196" class="difflineminus">-728a00b6e542a1d126885cd3298928891d9a0444037e904434951d4b90b84b2f</span>
<a href="#l3.3197"></a><span id="l3.3197" class="difflineminus">-c9dde1fcebc33977a95555348f411e16dfce9d3b77ee77eebde77ce78c95a669</span>
<a href="#l3.3198"></a><span id="l3.3198" class="difflineminus">-0ad07c17009a13edd898b87dfb1fcb7d2b4d1bff217f33df80deb1e6267df0ff</span>
<a href="#l3.3199"></a><span id="l3.3199" class="difflineminus">-c1e6e6dfafdf1f5a7fd30f9aef66b6d546dd355bf02c40662e3307f9725a96c6</span>
<a href="#l3.3200"></a><span id="l3.3200" class="difflineminus">-744c3031f83782f171c148dbc3bf1774f5dad1e79d6f095a3f54d4fbec5234ef</span>
<a href="#l3.3201"></a><span id="l3.3201" class="difflineminus">-d9a2f8d73afe4f14f57ef4f42def7b44f19060f06b45bddf1c5534d77fd922be</span>
<a href="#l3.3202"></a><span id="l3.3202" class="difflineminus">-2973a15a82e648661c6e3240aa3612ead952b604bde57458894f29deaf133bac</span>
<a href="#l3.3203"></a><span id="l3.3203" class="difflineminus">-13d2766f5227a4a3b8cf08da7adfd6fbd6bd8a4fe9dbb43d35e3dfa3f844fbf8</span>
<a href="#l3.3204"></a><span id="l3.3204" class="difflineminus">-9119bf4f7144094fb56333abf8a86063ca106f94b3a3b512343765e60082097f</span>
<a href="#l3.3205"></a><span id="l3.3205" class="difflineminus">-1bb86ba72439a653519b09f5cee1ce61c897d37eedf5553580ae60f4af8af33a</span>
<a href="#l3.3206"></a><span id="l3.3206" class="difflineminus">-b14fd400b6a0f34535c0434afc0b3a9f07147527a5fa7ca218ff56c74d74dc3f</span>
<a href="#l3.3207"></a><span id="l3.3207" class="difflineminus">-155cfd3325fc278acf2ae1cb4a539f5f9937c457263b0bd51234c732a300cdd1</span>
<a href="#l3.3208"></a><span id="l3.3208" class="difflineminus">-cc1840f0aaff54db0e4874ed5a9b5d6d27d4bb36746d80de72baa877ff4b275a</span>
<a href="#l3.3209"></a><span id="l3.3209" class="difflineminus">-d7895ed1897ea4139b5143fcbb1a62560da1ed9662aaed895ec78a91c18795b8</span>
<a href="#l3.3210"></a><span id="l3.3210" class="difflineminus">-5e07ab4af8ba128e95e682e0728bf8f2e5ae815a091a53d902ac1920d8e05f06</span>
<a href="#l3.3211"></a><span id="l3.3211" class="difflineminus">-589de8d8d66680789f4e454fb9d9ec66cd857af796ee2d902fa73fd5bba775a2</span>
<a href="#l3.3212"></a><span id="l3.3212" class="difflineminus">-153580ae44705ed0d37647d15697cb8f14bfa3e3e8fdf8031d47af571503357c</span>
<a href="#l3.3213"></a><span id="l3.3213" class="difflineminus">-f30d25acedcbbf135c9a35c49766ba07ab255859e8ec03684e66860182dff8f7</span>
<a href="#l3.3214"></a><span id="l3.3214" class="difflineminus">-0304bff6ff1c20fc81b7afdd00a71475539a536e36bb5973a19e3b923b02bde5</span>
<a href="#l3.3215"></a><span id="l3.3215" class="difflineminus">-e4efd4003ac170eb2d13fe274157afedbd82d6fb3a9a1e85e4551d47cf7078f8</span>
<a href="#l3.3216"></a><span id="l3.3216" class="difflineminus">-9671fe4289ebf5f2bf08d63f37c4eb4773c55a0996efeefa0ca011671d8060ca</span>
<a href="#l3.3217"></a><span id="l3.3217" class="difflineminus">-2f0004c7fcc300e166ef0240f825efe3361f106d57d423d0723f7acacd66376b</span>
<a href="#l3.3218"></a><span id="l3.3218" class="difflineminus">-2ed47b7a7a7a205f4ef4ac4691e0aad9aa0d41cf13741c3580a506487574ddca</span>
<a href="#l3.3219"></a><span id="l3.3219" class="difflineminus">-61a8c403c1863ebfbcac3475168b2de28b8b3d77544bb05ce92a02aceced3c0d</span>
<a href="#l3.3220"></a><span id="l3.3220" class="difflineminus">-d0cc65ea371b201cf1c601c24dde1c4078cedbdeb60322f50126a019bf6edc9b</span>
<a href="#l3.3221"></a><span id="l3.3221" class="difflineminus">-39e566b39b3517eaf97c3e0fbde5e4491d45bd74537145d155b476aa0176e868</span>
<a href="#l3.3222"></a><span id="l3.3222" class="difflineminus">-c6abebf30dbd5e525c54ac8e18e2d56abeb756827a3d970358a97416019a6f64</span>
<a href="#l3.3223"></a><span id="l3.3223" class="difflineminus">-f60004fdfe1580d5c98e618070cc1b05887eee7e0d209a70db7d8063029889b4</span>
<a href="#l3.3224"></a><span id="l3.3224" class="difflineminus">-c620ead78d7b33a7dc6c76b3e6427ddddbebde867c393aa7845e5403e8ca794a</span>
<a href="#l3.3225"></a><span id="l3.3225" class="difflineminus">-d0d6fb897af5f03525fe5782f5e7046bdaef468bf88d1debc6ab25583cd17310</span>
<a href="#l3.3226"></a><span id="l3.3226" class="difflineminus">-6079b9ab0ba059c914018245bf076075b5a303200c3c1f209a733701444fbbaf</span>
<a href="#l3.3227"></a><span id="l3.3227" class="difflineminus">-00c4134ebb016c5d0b23614c243701cdf875e3decce9349bddacb9505fbf7dfd</span>
<a href="#l3.3228"></a><span id="l3.3228" class="difflineminus">-76e82d87736a00f5d2b5ffd4b7dce2719a4d25ae717ee153c1abef18e257cfad</span>
<a href="#l3.3229"></a><span id="l3.3229" class="difflineminus">-7fa45682da48ef38c052b53b0fd06864b300c151ff08c0ea431de701a287dd5f</span>
<a href="#l3.3230"></a><span id="l3.3230" class="difflineminus">-004497dc7b01a253ee3e80b8c7f91c20f967fb6fdb7c80ada7d8683723614c24</span>
<a href="#l3.3231"></a><span id="l3.3231" class="difflineminus">-3701cdf875e3decc29379bddacb950ef3fd47f08f2e5a61ea4aa2a3eb757cd55</span>
<a href="#l3.3232"></a><span id="l3.3232" class="difflineminus">-13345efcfa59c12b2f19e2578ef77fb75a82854ffbee01a83f977b11a031931d</span>
<a href="#l3.3233"></a><span id="l3.3233" class="difflineminus">-040802df07082b5e11207cc17b1e209a770700e2df0a83e409fb7580f827c230</span>
<a href="#l3.3234"></a><span id="l3.3234" class="difflineminus">-99b06fd901fb058d6835dacd481813c94d40337eddb83773cacd66376b2ed437</span>
<a href="#l3.3235"></a><span id="l3.3235" class="difflineminus">-bebcf165e82d2f4e4beb7f3fa6e652c2d7ee10bc78c010bfb87fe3c95a09ae9f</span>
<a href="#l3.3236"></a><span id="l3.3236" class="difflineminus">-bd732740bd2fb700d0f865f64180e059ff044018ca0ca28a5b04883f701e0088</span>
<a href="#l3.3237"></a><span id="l3.3237" class="difflineminus">-bfec7c0c909cb71f0448c6ec518074b375012079d9dedf66004bcfbc51eb2dd1</span>
<a href="#l3.3238"></a><span id="l3.3238" class="difflineminus">-aadacd481813c94d40337eddb83773cacd66376b2ed487868686205fbe7c49ef</span>
<a href="#l3.3239"></a><span id="l3.3239" class="difflineminus">-5605a73f34c4a7a787eeab96e0da81bb4e022c15ba27019a5b339300e16bf286</span>
<a href="#l3.3240"></a><span id="l3.3240" class="difflineminus">-a8eae601e25866907cdf3e0890acb36f00245fb57f05904e59c300e92561946e</span>
<a href="#l3.3241"></a><span id="l3.3241" class="difflineminus">-b2e600d209ab7d07f04d458dfb46ad1bd16ab49b913026929b8066fcba716fe6</span>
<a href="#l3.3242"></a><span id="l3.3242" class="difflineminus">-949bcd6ed65ca8ef7e7cf7e3d05b7e7c8f217ee6cdddbb6a25a856f37980e0c7</span>
<a href="#l3.3243"></a><span id="l3.3243" class="difflineminus">-fe4e80a82623c48193014846ec7180f4acf518409aca0cd28a5504e03b32c374</span>
<a href="#l3.3244"></a><span id="l3.3244" class="difflineminus">-de1a00608a0240faaa327a4b19fe946fb6f90054dbb5f2333d022db56eb4966a</span>
<a href="#l3.3245"></a><span id="l3.3245" class="difflineminus">-3723614c243701cdf8f556bea8a7dc6c76b3e66bd46584ddbbcebc0990cf4b0f</span>
<a href="#l3.3246"></a><span id="l3.3246" class="difflineminus">-ff4070520c282338a7e26700ec725202b01e4bcf0258963c6f1d4d8f0030cb20</span>
<a href="#l3.3247"></a><span id="l3.3247" class="difflineminus">-805549c520930c03584fa522b676f11600ffc03fde3e1b3489a9c9054c9aa23b</span>
<a href="#l3.3248"></a><span id="l3.3248" class="difflineminus">-c08856a3dd8c843191dc0434e3d78d7b33a75c36fb993761f7ae5a69f72ef97f</span>
<a href="#l3.3249"></a><span id="l3.3249" class="difflineminus">-e6ad336fed7e1c60e8bee96980bbdebbb60da07b7069062033d9dc0ae03d296f</span>
<a href="#l3.3250"></a><span id="l3.3250" class="difflineminus">-70ab511ec071640676252902d833c916007b3e1900b0a6d2028035968e025861</span>
<a href="#l3.3251"></a><span id="l3.3251" class="difflineminus">-ea01581369fb11488c34d18cbc95989afccca42baad65ba2d5683723614c24d7</span>
<a href="#l3.3252"></a><span id="l3.3252" class="difflineminus">-8066fcbab8b7e96918baaf5aaa56219f975fb50a43f7c9bde90fa73f1c1a02d8</span>
<a href="#l3.3253"></a><span id="l3.3253" class="difflineminus">-78f2e27e803b77ca08b90519315b6fe400fc1392097a9eccc0ad444500e70199</span>
<a href="#l3.3254"></a><span id="l3.3254" class="difflineminus">-a1331f0f00d8934901c07e5d526ceb87c2d07e2579badd005a2b31a5089391b7</span>
<a href="#l3.3255"></a><span id="l3.3255" class="difflineminus">-1253358049535a6add8856dd0146c298482e01ede27ed878b256ba7600ee3a09</span>
<a href="#l3.3256"></a><span id="l3.3256" class="difflineminus">-c18fc1df09fe01084ec25defc1b56db0f1a4f4bd78e0e2818d2f0334e7330300</span>
<a href="#l3.3257"></a><span id="l3.3257" class="difflineminus">-7df7c888b917e50dd9c1c60c80efcb0cbc63e1f700bce7c31700dccbd1060027</span>
<a href="#l3.3258"></a><span id="l3.3258" class="difflineminus">-8add9b0de06c8e2f00d84962b7d7030e2a61538331b98051f92631bd253f336a</span>
<a href="#l3.3259"></a><span id="l3.3259" class="difflineminus">-dd8856a3dd44c25c390efddfad96ae9f853b77c25201ba27c533b8bdf28b6ad0</span>
<a href="#l3.3260"></a><span id="l3.3260" class="difflineminus">-3d084b33d2e7fa59099e9901b8f2d29597fa0f01848f78e70082117f1ca07b76</span>
<a href="#l3.3261"></a><span id="l3.3261" class="difflineminus">-6910209b9519f895a008d031bbba05c09d8f06005c5b18b8fba25300cea6780e</span>
<a href="#l3.3262"></a><span id="l3.3262" class="difflineminus">-c03e911c6ccf06d507b48a4fa606634a114609de929f9934c5a87511ad57cfc1</span>
<a href="#l3.3263"></a><span id="l3.3263" class="difflineminus">-fa476aa5854fa1ef1e3910b905686e85cc24c40138198915f133d2d6dc2a7dea</span>
<a href="#l3.3264"></a><span id="l3.3264" class="difflineminus">-7df2ccc2a752faf2cec1d577aebeb37e3b4034eeee0008dff3be0e6b923773b4</span>
<a href="#l3.3265"></a><span id="l3.3265" class="difflineminus">-7904c0ef9119767cb4fa1500ef1361e08e452500f71561e84cc4ed3e20fab6a2</span>
<a href="#l3.3266"></a><span id="l3.3266" class="difflineminus">-c905f40cb76a3026bf3319b91ac2e46792a6dcd801ebc6aba5da08f48ecb81c8</span>
<a href="#l3.3267"></a><span id="l3.3267" class="difflineminus">-bd088d5f42f6417191de93908c803d0e76199292b485af41b60e8d9c3c537f0e</span>
<a href="#l3.3268"></a><span id="l3.3268" class="difflineminus">-8211f0c7211a077707dc18b931b2ee6d80a4d7ae024491ebc24d4a708ff70680</span>
<a href="#l3.3269"></a><span id="l3.3269" class="difflineminus">-7f25e807e8785f1878e322d6ddaf453f0770ff2dfa769b01423dbbad72a391b6</span>
<a href="#l3.3270"></a><span id="l3.3270" class="difflineminus">-5a7c3235985629423372494cab55c8f7d64a8b27a0e7202c55a13b0f8d19c80e</span>
<a href="#l3.3271"></a><span id="l3.3271" class="difflineminus">-4ae9ca3f015115dc3ca467c17a4c7ee95970ab10e5a54ff0ac3cd39881ee5958</span>
<a href="#l3.3272"></a><span id="l3.3272" class="difflineminus">-1a84f03df0be0e492fd855a8d6aa35d10b4962dbb0a604a3d3ee5e80a8eee600</span>
<a href="#l3.3273"></a><span id="l3.3273" class="difflineminus">-a24977f8660378bf0bbf00e01d0a8fb7f980f04b8aa6ce6aca8d5a7533c52753</span>
<a href="#l3.3274"></a><span id="l3.3274" class="difflineminus">-839152c4e222f4dc512dd5eb90cbc981e8ea12cf90cd8a8bf47d89159e2741d3</span>
<a href="#l3.3275"></a><span id="l3.3275" class="difflineminus">-7124f65b96fcd254dae258fa84a13c13043246a32129574787e49eae2b49b86d</span>
<a href="#l3.3276"></a><span id="l3.3276" class="difflineminus">-c3e2e78b9ff7f4002415bb08907c66df0d103b4e0c104db90500ff70700c203a</span>
<a href="#l3.3277"></a><span id="l3.3277" class="difflineminus">-ee1e82dba4c3e16e256c0acca6ceaae9afd1f612d7eb472157ac95962bd05594</span>
<a href="#l3.3278"></a><span id="l3.3278" class="difflineminus">-7dd1598466053245088e827f44628657942a825b84e4fb601f84b4025611aca3</span>
<a href="#l3.3279"></a><span id="l3.3279" class="difflineminus">-901e01bb024911dc0a4445f08e41f83df02b10142173149ab71baf027611ea95</span>
<a href="#l3.3280"></a><span id="l3.3280" class="difflineminus">-7a257704201d14cd9af4d90b00f194530088cb4e09c0df1c5c0088f7393f6833</span>
<a href="#l3.3281"></a><span id="l3.3281" class="difflineminus">-c0aa3ac156655de3bca9b34ab9716906ba07aba5e5bba1eb3358d90b9da7c533</span>
<a href="#l3.3282"></a><span id="l3.3282" class="difflineminus">-64f6888bf47b60f521e8380fe10be03d2feac17900927560df40f4e48f805960</span>
<a href="#l3.3283"></a><span id="l3.3283" class="difflineminus">-50328d648bf4893f9067c217a0631656b7c898c122847bc07b03a2d3e0ee85e4</span>
<a href="#l3.3284"></a><span id="l3.3284" class="difflineminus">-33b0ef867450c4fad2ecd26cf7168074c0ba0c904cdac300c9cfec4701924df6</span>
<a href="#l3.3285"></a><span id="l3.3285" class="difflineminus">-1cdca61e10685c6f7d52d0caba1498972f43d740adb4b2009d7d7220b20e3473</span>
<a href="#l3.3286"></a><span id="l3.3286" class="difflineminus">-90a943d00ffe959bb6eac3e0fe42ea49ee00c45f06e76329b1dabf127d690d80</span>
<a href="#l3.3287"></a><span id="l3.3287" class="difflineminus">-5581b408f63c2403e0cc433c00ee658836803b0fd100747c04ab5f917704fd10</span>
<a href="#l3.3288"></a><span id="l3.3288" class="difflineminus">-d5c1cd41ec801343d207f602a403605d86e5f9e5f9ae0d00e994556833806685</span>
<a href="#l3.3289"></a><span id="l3.3289" class="difflineminus">-c931fb709b0f08b4e869bea5c827859549e82c544b8d29c816a0390999613920</span>
<a href="#l3.3290"></a><span id="l3.3290" class="difflineminus">-7e610d5727a16318c2003c1fa24be0de2b32caf92224e7c17e5004b6350c4c01</span>
<a href="#l3.3291"></a><span id="l3.3291" class="difflineminus">-05601218066b0ad28224e149019c086257ca315102de2712903bde97b8144d82</span>
<a href="#l3.3292"></a><span id="l3.3292" class="difflineminus">-3b2c6ac52d403c054e019249b087f53d0558995a99ea946c70cc927458b3c1ff</span>
<a href="#l3.3293"></a><span id="l3.3293" class="difflineminus">-550f30050df988d4284376b4566a8e416654cc921985e037e0df0fc131f00f4b</span>
<a href="#l3.3294"></a><span id="l3.3294" class="difflineminus">-acf0c6211c036f14a239703741740adc7da227edd7e56b833d0ae92549b4d357</span>
<a href="#l3.3295"></a><span id="l3.3295" class="difflineminus">-25dfb49ed2ff63908e6adf27d6d0dda7638d4154d2778daca17f58e61297c129</span>
<a href="#l3.3296"></a><span id="l3.3296" class="difflineminus">-41f233b01f5dc3740cac51688c35c6b22580f48224fee9b83502569a66b629f1</span>
<a href="#l3.3297"></a><span id="l3.3297" class="difflineminus">-09f3713473413e2666e7fe6f6c6efefdfafda1f56f6e06f93496d9d67cb7366a</span>
<a href="#l3.3298"></a><span id="l3.3298" class="difflineminus">-9964b6f92e64b689196ec6c604646fd3fe4771ff1bf03f65d8ecc3addbb5f300</span>
<a href="#l3.3299"></a><span id="l3.3299" class="difflineminus">-00000049454e44ae426082</span>
<a href="#l3.3300"></a><span id="l3.3300" class="difflineminus">-&quot;&quot;&quot;),</span>
<a href="#l3.3301"></a><span id="l3.3301" class="difflineminus">-}</span>
<a href="#l3.3302"></a><span id="l3.3302" class="difflineminus">-</span>
<a href="#l3.3303"></a><span id="l3.3303" class="difflineminus">-def test_suite(options, args):</span>
<a href="#l3.3304"></a><span id="l3.3304" class="difflineminus">-    &quot;&quot;&quot;</span>
<a href="#l3.3305"></a><span id="l3.3305" class="difflineminus">-    Create a PNG test image and write the file to stdout.</span>
<a href="#l3.3306"></a><span id="l3.3306" class="difflineminus">-    &quot;&quot;&quot;</span>
<a href="#l3.3307"></a><span id="l3.3307" class="difflineminus">-</span>
<a href="#l3.3308"></a><span id="l3.3308" class="difflineminus">-    # Below is a big stack of test image generators.</span>
<a href="#l3.3309"></a><span id="l3.3309" class="difflineminus">-    # They're all really tiny, so PEP 8 rules are suspended.</span>
<a href="#l3.3310"></a><span id="l3.3310" class="difflineminus">-</span>
<a href="#l3.3311"></a><span id="l3.3311" class="difflineminus">-    def test_gradient_horizontal_lr(x, y): return x</span>
<a href="#l3.3312"></a><span id="l3.3312" class="difflineminus">-    def test_gradient_horizontal_rl(x, y): return 1-x</span>
<a href="#l3.3313"></a><span id="l3.3313" class="difflineminus">-    def test_gradient_vertical_tb(x, y): return y</span>
<a href="#l3.3314"></a><span id="l3.3314" class="difflineminus">-    def test_gradient_vertical_bt(x, y): return 1-y</span>
<a href="#l3.3315"></a><span id="l3.3315" class="difflineminus">-    def test_radial_tl(x, y): return max(1-math.sqrt(x*x+y*y), 0.0)</span>
<a href="#l3.3316"></a><span id="l3.3316" class="difflineminus">-    def test_radial_center(x, y): return test_radial_tl(x-0.5, y-0.5)</span>
<a href="#l3.3317"></a><span id="l3.3317" class="difflineminus">-    def test_radial_tr(x, y): return test_radial_tl(1-x, y)</span>
<a href="#l3.3318"></a><span id="l3.3318" class="difflineminus">-    def test_radial_bl(x, y): return test_radial_tl(x, 1-y)</span>
<a href="#l3.3319"></a><span id="l3.3319" class="difflineminus">-    def test_radial_br(x, y): return test_radial_tl(1-x, 1-y)</span>
<a href="#l3.3320"></a><span id="l3.3320" class="difflineminus">-    def test_stripe(x, n): return float(int(x*n) &amp; 1)</span>
<a href="#l3.3321"></a><span id="l3.3321" class="difflineminus">-    def test_stripe_h_2(x, y): return test_stripe(x, 2)</span>
<a href="#l3.3322"></a><span id="l3.3322" class="difflineminus">-    def test_stripe_h_4(x, y): return test_stripe(x, 4)</span>
<a href="#l3.3323"></a><span id="l3.3323" class="difflineminus">-    def test_stripe_h_10(x, y): return test_stripe(x, 10)</span>
<a href="#l3.3324"></a><span id="l3.3324" class="difflineminus">-    def test_stripe_v_2(x, y): return test_stripe(y, 2)</span>
<a href="#l3.3325"></a><span id="l3.3325" class="difflineminus">-    def test_stripe_v_4(x, y): return test_stripe(y, 4)</span>
<a href="#l3.3326"></a><span id="l3.3326" class="difflineminus">-    def test_stripe_v_10(x, y): return test_stripe(y, 10)</span>
<a href="#l3.3327"></a><span id="l3.3327" class="difflineminus">-    def test_stripe_lr_10(x, y): return test_stripe(x+y, 10)</span>
<a href="#l3.3328"></a><span id="l3.3328" class="difflineminus">-    def test_stripe_rl_10(x, y): return test_stripe(1+x-y, 10)</span>
<a href="#l3.3329"></a><span id="l3.3329" class="difflineminus">-    def test_checker(x, y, n): return float((int(x*n) &amp; 1) ^ (int(y*n) &amp; 1))</span>
<a href="#l3.3330"></a><span id="l3.3330" class="difflineminus">-    def test_checker_8(x, y): return test_checker(x, y, 8)</span>
<a href="#l3.3331"></a><span id="l3.3331" class="difflineminus">-    def test_checker_15(x, y): return test_checker(x, y, 15)</span>
<a href="#l3.3332"></a><span id="l3.3332" class="difflineminus">-    def test_zero(x, y): return 0</span>
<a href="#l3.3333"></a><span id="l3.3333" class="difflineminus">-    def test_one(x, y): return 1</span>
<a href="#l3.3334"></a><span id="l3.3334" class="difflineminus">-</span>
<a href="#l3.3335"></a><span id="l3.3335" class="difflineminus">-    test_patterns = {</span>
<a href="#l3.3336"></a><span id="l3.3336" class="difflineminus">-        'GLR': test_gradient_horizontal_lr,</span>
<a href="#l3.3337"></a><span id="l3.3337" class="difflineminus">-        'GRL': test_gradient_horizontal_rl,</span>
<a href="#l3.3338"></a><span id="l3.3338" class="difflineminus">-        'GTB': test_gradient_vertical_tb,</span>
<a href="#l3.3339"></a><span id="l3.3339" class="difflineminus">-        'GBT': test_gradient_vertical_bt,</span>
<a href="#l3.3340"></a><span id="l3.3340" class="difflineminus">-        'RTL': test_radial_tl,</span>
<a href="#l3.3341"></a><span id="l3.3341" class="difflineminus">-        'RTR': test_radial_tr,</span>
<a href="#l3.3342"></a><span id="l3.3342" class="difflineminus">-        'RBL': test_radial_bl,</span>
<a href="#l3.3343"></a><span id="l3.3343" class="difflineminus">-        'RBR': test_radial_br,</span>
<a href="#l3.3344"></a><span id="l3.3344" class="difflineminus">-        'RCTR': test_radial_center,</span>
<a href="#l3.3345"></a><span id="l3.3345" class="difflineminus">-        'HS2': test_stripe_h_2,</span>
<a href="#l3.3346"></a><span id="l3.3346" class="difflineminus">-        'HS4': test_stripe_h_4,</span>
<a href="#l3.3347"></a><span id="l3.3347" class="difflineminus">-        'HS10': test_stripe_h_10,</span>
<a href="#l3.3348"></a><span id="l3.3348" class="difflineminus">-        'VS2': test_stripe_v_2,</span>
<a href="#l3.3349"></a><span id="l3.3349" class="difflineminus">-        'VS4': test_stripe_v_4,</span>
<a href="#l3.3350"></a><span id="l3.3350" class="difflineminus">-        'VS10': test_stripe_v_10,</span>
<a href="#l3.3351"></a><span id="l3.3351" class="difflineminus">-        'LRS': test_stripe_lr_10,</span>
<a href="#l3.3352"></a><span id="l3.3352" class="difflineminus">-        'RLS': test_stripe_rl_10,</span>
<a href="#l3.3353"></a><span id="l3.3353" class="difflineminus">-        'CK8': test_checker_8,</span>
<a href="#l3.3354"></a><span id="l3.3354" class="difflineminus">-        'CK15': test_checker_15,</span>
<a href="#l3.3355"></a><span id="l3.3355" class="difflineminus">-        'ZERO': test_zero,</span>
<a href="#l3.3356"></a><span id="l3.3356" class="difflineminus">-        'ONE': test_one,</span>
<a href="#l3.3357"></a><span id="l3.3357" class="difflineminus">-        }</span>
<a href="#l3.3358"></a><span id="l3.3358" class="difflineminus">-</span>
<a href="#l3.3359"></a><span id="l3.3359" class="difflineminus">-    def test_pattern(width, height, bitdepth, pattern):</span>
<a href="#l3.3360"></a><span id="l3.3360" class="difflineminus">-        &quot;&quot;&quot;Create a single plane (monochrome) test pattern.  Returns a</span>
<a href="#l3.3361"></a><span id="l3.3361" class="difflineminus">-        flat row flat pixel array.</span>
<a href="#l3.3362"></a><span id="l3.3362" class="difflineminus">-        &quot;&quot;&quot;</span>
<a href="#l3.3363"></a><span id="l3.3363" class="difflineminus">-</span>
<a href="#l3.3364"></a><span id="l3.3364" class="difflineminus">-        maxval = 2**bitdepth-1</span>
<a href="#l3.3365"></a><span id="l3.3365" class="difflineminus">-        if maxval &gt; 255:</span>
<a href="#l3.3366"></a><span id="l3.3366" class="difflineminus">-            a = array('H')</span>
<a href="#l3.3367"></a><span id="l3.3367" class="difflineminus">-        else:</span>
<a href="#l3.3368"></a><span id="l3.3368" class="difflineminus">-            a = array('B')</span>
<a href="#l3.3369"></a><span id="l3.3369" class="difflineminus">-        fw = float(width)</span>
<a href="#l3.3370"></a><span id="l3.3370" class="difflineminus">-        fh = float(height)</span>
<a href="#l3.3371"></a><span id="l3.3371" class="difflineminus">-        pfun = test_patterns[pattern]</span>
<a href="#l3.3372"></a><span id="l3.3372" class="difflineminus">-        for y in range(height):</span>
<a href="#l3.3373"></a><span id="l3.3373" class="difflineminus">-            fy = float(y)/fh</span>
<a href="#l3.3374"></a><span id="l3.3374" class="difflineminus">-            for x in range(width):</span>
<a href="#l3.3375"></a><span id="l3.3375" class="difflineminus">-                a.append(int(round(pfun(float(x)/fw, fy) * maxval)))</span>
<a href="#l3.3376"></a><span id="l3.3376" class="difflineminus">-        return a</span>
<a href="#l3.3377"></a><span id="l3.3377" class="difflineminus">-</span>
<a href="#l3.3378"></a><span id="l3.3378" class="difflineminus">-    def test_rgba(size=256, bitdepth=8,</span>
<a href="#l3.3379"></a><span id="l3.3379" class="difflineminus">-                    red=&quot;GTB&quot;, green=&quot;GLR&quot;, blue=&quot;RTL&quot;, alpha=None):</span>
<a href="#l3.3380"></a><span id="l3.3380" class="difflineminus">-        &quot;&quot;&quot;</span>
<a href="#l3.3381"></a><span id="l3.3381" class="difflineminus">-        Create a test image.  Each channel is generated from the</span>
<a href="#l3.3382"></a><span id="l3.3382" class="difflineminus">-        specified pattern; any channel apart from red can be set to</span>
<a href="#l3.3383"></a><span id="l3.3383" class="difflineminus">-        None, which will cause it not to be in the image.  It</span>
<a href="#l3.3384"></a><span id="l3.3384" class="difflineminus">-        is possible to create all PNG channel types (L, RGB, LA, RGBA),</span>
<a href="#l3.3385"></a><span id="l3.3385" class="difflineminus">-        as well as non PNG channel types (RGA, and so on).</span>
<a href="#l3.3386"></a><span id="l3.3386" class="difflineminus">-        &quot;&quot;&quot;</span>
<a href="#l3.3387"></a><span id="l3.3387" class="difflineminus">-</span>
<a href="#l3.3388"></a><span id="l3.3388" class="difflineminus">-        i = test_pattern(size, size, bitdepth, red)</span>
<a href="#l3.3389"></a><span id="l3.3389" class="difflineminus">-        psize = 1</span>
<a href="#l3.3390"></a><span id="l3.3390" class="difflineminus">-        for channel in (green, blue, alpha):</span>
<a href="#l3.3391"></a><span id="l3.3391" class="difflineminus">-            if channel:</span>
<a href="#l3.3392"></a><span id="l3.3392" class="difflineminus">-                c = test_pattern(size, size, bitdepth, channel)</span>
<a href="#l3.3393"></a><span id="l3.3393" class="difflineminus">-                i = interleave_planes(i, c, psize, 1)</span>
<a href="#l3.3394"></a><span id="l3.3394" class="difflineminus">-                psize += 1</span>
<a href="#l3.3395"></a><span id="l3.3395" class="difflineminus">-        return i</span>
<a href="#l3.3396"></a><span id="l3.3396" class="difflineminus">-</span>
<a href="#l3.3397"></a><span id="l3.3397" class="difflineminus">-    def pngsuite_image(name):</span>
<a href="#l3.3398"></a><span id="l3.3398" class="difflineminus">-        &quot;&quot;&quot;</span>
<a href="#l3.3399"></a><span id="l3.3399" class="difflineminus">-        Create a test image by reading an internal copy of the files</span>
<a href="#l3.3400"></a><span id="l3.3400" class="difflineminus">-        from the PngSuite.  Returned in flat row flat pixel format.</span>
<a href="#l3.3401"></a><span id="l3.3401" class="difflineminus">-        &quot;&quot;&quot;</span>
<a href="#l3.3402"></a><span id="l3.3402" class="difflineminus">-</span>
<a href="#l3.3403"></a><span id="l3.3403" class="difflineminus">-        if name not in _pngsuite:</span>
<a href="#l3.3404"></a><span id="l3.3404" class="difflineminus">-            raise NotImplementedError(&quot;cannot find PngSuite file %s (use -L for a list)&quot; % name)</span>
<a href="#l3.3405"></a><span id="l3.3405" class="difflineminus">-        r = Reader(bytes=_pngsuite[name])</span>
<a href="#l3.3406"></a><span id="l3.3406" class="difflineminus">-        w,h,pixels,meta = r.asDirect()</span>
<a href="#l3.3407"></a><span id="l3.3407" class="difflineminus">-        assert w == h</span>
<a href="#l3.3408"></a><span id="l3.3408" class="difflineminus">-        # LAn for n &lt; 8 is a special case for which we need to rescale</span>
<a href="#l3.3409"></a><span id="l3.3409" class="difflineminus">-        # the data.</span>
<a href="#l3.3410"></a><span id="l3.3410" class="difflineminus">-        if meta['greyscale'] and meta['alpha'] and meta['bitdepth'] &lt; 8:</span>
<a href="#l3.3411"></a><span id="l3.3411" class="difflineminus">-            factor = 255 // (2**meta['bitdepth']-1)</span>
<a href="#l3.3412"></a><span id="l3.3412" class="difflineminus">-            def rescale(data):</span>
<a href="#l3.3413"></a><span id="l3.3413" class="difflineminus">-                for row in data:</span>
<a href="#l3.3414"></a><span id="l3.3414" class="difflineminus">-                    yield map(factor.__mul__, row)</span>
<a href="#l3.3415"></a><span id="l3.3415" class="difflineminus">-            pixels = rescale(pixels)</span>
<a href="#l3.3416"></a><span id="l3.3416" class="difflineminus">-            meta['bitdepth'] = 8</span>
<a href="#l3.3417"></a><span id="l3.3417" class="difflineminus">-        arraycode = 'BH'[meta['bitdepth']&gt;8]</span>
<a href="#l3.3418"></a><span id="l3.3418" class="difflineminus">-        return w, array(arraycode, itertools.chain(*pixels)), meta</span>
<a href="#l3.3419"></a><span id="l3.3419" class="difflineminus">-</span>
<a href="#l3.3420"></a><span id="l3.3420" class="difflineminus">-    # The body of test_suite()</span>
<a href="#l3.3421"></a><span id="l3.3421" class="difflineminus">-    size = 256</span>
<a href="#l3.3422"></a><span id="l3.3422" class="difflineminus">-    if options.test_size:</span>
<a href="#l3.3423"></a><span id="l3.3423" class="difflineminus">-        size = options.test_size</span>
<a href="#l3.3424"></a><span id="l3.3424" class="difflineminus">-    options.bitdepth = options.test_depth</span>
<a href="#l3.3425"></a><span id="l3.3425" class="difflineminus">-    options.greyscale=bool(options.test_black)</span>
<a href="#l3.3426"></a><span id="l3.3426" class="difflineminus">-</span>
<a href="#l3.3427"></a><span id="l3.3427" class="difflineminus">-    kwargs = {}</span>
<a href="#l3.3428"></a><span id="l3.3428" class="difflineminus">-    if options.test_red:</span>
<a href="#l3.3429"></a><span id="l3.3429" class="difflineminus">-        kwargs[&quot;red&quot;] = options.test_red</span>
<a href="#l3.3430"></a><span id="l3.3430" class="difflineminus">-    if options.test_green:</span>
<a href="#l3.3431"></a><span id="l3.3431" class="difflineminus">-        kwargs[&quot;green&quot;] = options.test_green</span>
<a href="#l3.3432"></a><span id="l3.3432" class="difflineminus">-    if options.test_blue:</span>
<a href="#l3.3433"></a><span id="l3.3433" class="difflineminus">-        kwargs[&quot;blue&quot;] = options.test_blue</span>
<a href="#l3.3434"></a><span id="l3.3434" class="difflineminus">-    if options.test_alpha:</span>
<a href="#l3.3435"></a><span id="l3.3435" class="difflineminus">-        kwargs[&quot;alpha&quot;] = options.test_alpha</span>
<a href="#l3.3436"></a><span id="l3.3436" class="difflineminus">-    if options.greyscale:</span>
<a href="#l3.3437"></a><span id="l3.3437" class="difflineminus">-        if options.test_red or options.test_green or options.test_blue:</span>
<a href="#l3.3438"></a><span id="l3.3438" class="difflineminus">-            raise ValueError(&quot;cannot specify colours (R, G, B) when greyscale image (black channel, K) is specified&quot;)</span>
<a href="#l3.3439"></a><span id="l3.3439" class="difflineminus">-        kwargs[&quot;red&quot;] = options.test_black</span>
<a href="#l3.3440"></a><span id="l3.3440" class="difflineminus">-        kwargs[&quot;green&quot;] = None</span>
<a href="#l3.3441"></a><span id="l3.3441" class="difflineminus">-        kwargs[&quot;blue&quot;] = None</span>
<a href="#l3.3442"></a><span id="l3.3442" class="difflineminus">-    options.alpha = bool(options.test_alpha)</span>
<a href="#l3.3443"></a><span id="l3.3443" class="difflineminus">-    if not args:</span>
<a href="#l3.3444"></a><span id="l3.3444" class="difflineminus">-        pixels = test_rgba(size, options.bitdepth, **kwargs)</span>
<a href="#l3.3445"></a><span id="l3.3445" class="difflineminus">-    else:</span>
<a href="#l3.3446"></a><span id="l3.3446" class="difflineminus">-        size,pixels,meta = pngsuite_image(args[0])</span>
<a href="#l3.3447"></a><span id="l3.3447" class="difflineminus">-        for k in ['bitdepth', 'alpha', 'greyscale']:</span>
<a href="#l3.3448"></a><span id="l3.3448" class="difflineminus">-            setattr(options, k, meta[k])</span>
<a href="#l3.3449"></a><span id="l3.3449" class="difflineminus">-</span>
<a href="#l3.3450"></a><span id="l3.3450" class="difflineminus">-    writer = Writer(size, size,</span>
<a href="#l3.3451"></a><span id="l3.3451" class="difflineminus">-                    bitdepth=options.bitdepth,</span>
<a href="#l3.3452"></a><span id="l3.3452" class="difflineminus">-                    transparent=options.transparent,</span>
<a href="#l3.3453"></a><span id="l3.3453" class="difflineminus">-                    background=options.background,</span>
<a href="#l3.3454"></a><span id="l3.3454" class="difflineminus">-                    gamma=options.gamma,</span>
<a href="#l3.3455"></a><span id="l3.3455" class="difflineminus">-                    greyscale=options.greyscale,</span>
<a href="#l3.3456"></a><span id="l3.3456" class="difflineminus">-                    alpha=options.alpha,</span>
<a href="#l3.3457"></a><span id="l3.3457" class="difflineminus">-                    compression=options.compression,</span>
<a href="#l3.3458"></a><span id="l3.3458" class="difflineminus">-                    interlace=options.interlace)</span>
<a href="#l3.3459"></a><span id="l3.3459" class="difflineminus">-    writer.write_array(sys.stdout, pixels)</span>
<a href="#l3.3460"></a><span id="l3.3460" class="difflineminus">-</span>
<a href="#l3.3461"></a><span id="l3.3461" class="difflineminus">-def read_pam_header(infile):</span>
<a href="#l3.3462"></a><span id="l3.3462" class="difflineminus">-    &quot;&quot;&quot;</span>
<a href="#l3.3463"></a><span id="l3.3463" class="difflineminus">-    Read (the rest of a) PAM header.  `infile` should be positioned</span>
<a href="#l3.3464"></a><span id="l3.3464" class="difflineminus">-    immediately after the initial 'P7' line (at the beginning of the</span>
<a href="#l3.3465"></a><span id="l3.3465" class="difflineminus">-    second line).  Returns are as for `read_pnm_header`.</span>
<a href="#l3.3466"></a><span id="l3.3466" class="difflineminus">-    &quot;&quot;&quot;</span>
<a href="#l3.3467"></a><span id="l3.3467" class="difflineminus">-    </span>
<a href="#l3.3468"></a><span id="l3.3468" class="difflineminus">-    # Unlike PBM, PGM, and PPM, we can read the header a line at a time.</span>
<a href="#l3.3469"></a><span id="l3.3469" class="difflineminus">-    header = dict()</span>
<a href="#l3.3470"></a><span id="l3.3470" class="difflineminus">-    while True:</span>
<a href="#l3.3471"></a><span id="l3.3471" class="difflineminus">-        l = infile.readline().strip()</span>
<a href="#l3.3472"></a><span id="l3.3472" class="difflineminus">-        if l == strtobytes('ENDHDR'):</span>
<a href="#l3.3473"></a><span id="l3.3473" class="difflineminus">-            break</span>
<a href="#l3.3474"></a><span id="l3.3474" class="difflineminus">-        if not l:</span>
<a href="#l3.3475"></a><span id="l3.3475" class="difflineminus">-            raise EOFError('PAM ended prematurely')</span>
<a href="#l3.3476"></a><span id="l3.3476" class="difflineminus">-        if l[0] == strtobytes('#'):</span>
<a href="#l3.3477"></a><span id="l3.3477" class="difflineminus">-            continue</span>
<a href="#l3.3478"></a><span id="l3.3478" class="difflineminus">-        l = l.split(None, 1)</span>
<a href="#l3.3479"></a><span id="l3.3479" class="difflineminus">-        if l[0] not in header:</span>
<a href="#l3.3480"></a><span id="l3.3480" class="difflineminus">-            header[l[0]] = l[1]</span>
<a href="#l3.3481"></a><span id="l3.3481" class="difflineminus">-        else:</span>
<a href="#l3.3482"></a><span id="l3.3482" class="difflineminus">-            header[l[0]] += strtobytes(' ') + l[1]</span>
<a href="#l3.3483"></a><span id="l3.3483" class="difflineminus">-</span>
<a href="#l3.3484"></a><span id="l3.3484" class="difflineminus">-    required = ['WIDTH', 'HEIGHT', 'DEPTH', 'MAXVAL']</span>
<a href="#l3.3485"></a><span id="l3.3485" class="difflineminus">-    required = [strtobytes(x) for x in required]</span>
<a href="#l3.3486"></a><span id="l3.3486" class="difflineminus">-    WIDTH,HEIGHT,DEPTH,MAXVAL = required</span>
<a href="#l3.3487"></a><span id="l3.3487" class="difflineminus">-    present = [x for x in required if x in header]</span>
<a href="#l3.3488"></a><span id="l3.3488" class="difflineminus">-    if len(present) != len(required):</span>
<a href="#l3.3489"></a><span id="l3.3489" class="difflineminus">-        raise Error('PAM file must specify WIDTH, HEIGHT, DEPTH, and MAXVAL')</span>
<a href="#l3.3490"></a><span id="l3.3490" class="difflineminus">-    width = int(header[WIDTH])</span>
<a href="#l3.3491"></a><span id="l3.3491" class="difflineminus">-    height = int(header[HEIGHT])</span>
<a href="#l3.3492"></a><span id="l3.3492" class="difflineminus">-    depth = int(header[DEPTH])</span>
<a href="#l3.3493"></a><span id="l3.3493" class="difflineminus">-    maxval = int(header[MAXVAL])</span>
<a href="#l3.3494"></a><span id="l3.3494" class="difflineminus">-    if (width &lt;= 0 or</span>
<a href="#l3.3495"></a><span id="l3.3495" class="difflineminus">-        height &lt;= 0 or</span>
<a href="#l3.3496"></a><span id="l3.3496" class="difflineminus">-        depth &lt;= 0 or</span>
<a href="#l3.3497"></a><span id="l3.3497" class="difflineminus">-        maxval &lt;= 0):</span>
<a href="#l3.3498"></a><span id="l3.3498" class="difflineminus">-        raise Error(</span>
<a href="#l3.3499"></a><span id="l3.3499" class="difflineminus">-          'WIDTH, HEIGHT, DEPTH, MAXVAL must all be positive integers')</span>
<a href="#l3.3500"></a><span id="l3.3500" class="difflineminus">-    return 'P7', width, height, depth, maxval</span>
<a href="#l3.3501"></a><span id="l3.3501" class="difflineminus">-</span>
<a href="#l3.3502"></a><span id="l3.3502" class="difflineminus">-def read_pnm_header(infile, supported=('P5','P6')):</span>
<a href="#l3.3503"></a><span id="l3.3503" class="difflineminus">-    &quot;&quot;&quot;</span>
<a href="#l3.3504"></a><span id="l3.3504" class="difflineminus">-    Read a PNM header, returning (format,width,height,depth,maxval).</span>
<a href="#l3.3505"></a><span id="l3.3505" class="difflineminus">-    `width` and `height` are in pixels.  `depth` is the number of</span>
<a href="#l3.3506"></a><span id="l3.3506" class="difflineminus">-    channels in the image; for PBM and PGM it is synthesized as 1, for</span>
<a href="#l3.3507"></a><span id="l3.3507" class="difflineminus">-    PPM as 3; for PAM images it is read from the header.  `maxval` is</span>
<a href="#l3.3508"></a><span id="l3.3508" class="difflineminus">-    synthesized (as 1) for PBM images.</span>
<a href="#l3.3509"></a><span id="l3.3509" class="difflineminus">-    &quot;&quot;&quot;</span>
<a href="#l3.3510"></a><span id="l3.3510" class="difflineminus">-</span>
<a href="#l3.3511"></a><span id="l3.3511" class="difflineminus">-    # Generally, see http://netpbm.sourceforge.net/doc/ppm.html</span>
<a href="#l3.3512"></a><span id="l3.3512" class="difflineminus">-    # and http://netpbm.sourceforge.net/doc/pam.html</span>
<a href="#l3.3513"></a><span id="l3.3513" class="difflineminus">-</span>
<a href="#l3.3514"></a><span id="l3.3514" class="difflineminus">-    supported = [strtobytes(x) for x in supported]</span>
<a href="#l3.3515"></a><span id="l3.3515" class="difflineminus">-</span>
<a href="#l3.3516"></a><span id="l3.3516" class="difflineminus">-    # Technically 'P7' must be followed by a newline, so by using</span>
<a href="#l3.3517"></a><span id="l3.3517" class="difflineminus">-    # rstrip() we are being liberal in what we accept.  I think this</span>
<a href="#l3.3518"></a><span id="l3.3518" class="difflineminus">-    # is acceptable.</span>
<a href="#l3.3519"></a><span id="l3.3519" class="difflineminus">-    type = infile.read(3).rstrip()</span>
<a href="#l3.3520"></a><span id="l3.3520" class="difflineminus">-    if type not in supported:</span>
<a href="#l3.3521"></a><span id="l3.3521" class="difflineminus">-        raise NotImplementedError('file format %s not supported' % type)</span>
<a href="#l3.3522"></a><span id="l3.3522" class="difflineminus">-    if type == strtobytes('P7'):</span>
<a href="#l3.3523"></a><span id="l3.3523" class="difflineminus">-        # PAM header parsing is completely different.</span>
<a href="#l3.3524"></a><span id="l3.3524" class="difflineminus">-        return read_pam_header(infile)</span>
<a href="#l3.3525"></a><span id="l3.3525" class="difflineminus">-    # Expected number of tokens in header (3 for P4, 4 for P6)</span>
<a href="#l3.3526"></a><span id="l3.3526" class="difflineminus">-    expected = 4</span>
<a href="#l3.3527"></a><span id="l3.3527" class="difflineminus">-    pbm = ('P1', 'P4')</span>
<a href="#l3.3528"></a><span id="l3.3528" class="difflineminus">-    if type in pbm:</span>
<a href="#l3.3529"></a><span id="l3.3529" class="difflineminus">-        expected = 3</span>
<a href="#l3.3530"></a><span id="l3.3530" class="difflineminus">-    header = [type]</span>
<a href="#l3.3531"></a><span id="l3.3531" class="difflineminus">-</span>
<a href="#l3.3532"></a><span id="l3.3532" class="difflineminus">-    # We have to read the rest of the header byte by byte because the</span>
<a href="#l3.3533"></a><span id="l3.3533" class="difflineminus">-    # final whitespace character (immediately following the MAXVAL in</span>
<a href="#l3.3534"></a><span id="l3.3534" class="difflineminus">-    # the case of P6) may not be a newline.  Of course all PNM files in</span>
<a href="#l3.3535"></a><span id="l3.3535" class="difflineminus">-    # the wild use a newline at this point, so it's tempting to use</span>
<a href="#l3.3536"></a><span id="l3.3536" class="difflineminus">-    # readline; but it would be wrong.</span>
<a href="#l3.3537"></a><span id="l3.3537" class="difflineminus">-    def getc():</span>
<a href="#l3.3538"></a><span id="l3.3538" class="difflineminus">-        c = infile.read(1)</span>
<a href="#l3.3539"></a><span id="l3.3539" class="difflineminus">-        if not c:</span>
<a href="#l3.3540"></a><span id="l3.3540" class="difflineminus">-            raise Error('premature EOF reading PNM header')</span>
<a href="#l3.3541"></a><span id="l3.3541" class="difflineminus">-        return c</span>
<a href="#l3.3542"></a><span id="l3.3542" class="difflineminus">-</span>
<a href="#l3.3543"></a><span id="l3.3543" class="difflineminus">-    c = getc()</span>
<a href="#l3.3544"></a><span id="l3.3544" class="difflineminus">-    while True:</span>
<a href="#l3.3545"></a><span id="l3.3545" class="difflineminus">-        # Skip whitespace that precedes a token.</span>
<a href="#l3.3546"></a><span id="l3.3546" class="difflineminus">-        while c.isspace():</span>
<a href="#l3.3547"></a><span id="l3.3547" class="difflineminus">-            c = getc()</span>
<a href="#l3.3548"></a><span id="l3.3548" class="difflineminus">-        # Skip comments.</span>
<a href="#l3.3549"></a><span id="l3.3549" class="difflineminus">-        while c == '#':</span>
<a href="#l3.3550"></a><span id="l3.3550" class="difflineminus">-            while c not in '\n\r':</span>
<a href="#l3.3551"></a><span id="l3.3551" class="difflineminus">-                c = getc()</span>
<a href="#l3.3552"></a><span id="l3.3552" class="difflineminus">-        if not c.isdigit():</span>
<a href="#l3.3553"></a><span id="l3.3553" class="difflineminus">-            raise Error('unexpected character %s found in header' % c)</span>
<a href="#l3.3554"></a><span id="l3.3554" class="difflineminus">-        # According to the specification it is legal to have comments</span>
<a href="#l3.3555"></a><span id="l3.3555" class="difflineminus">-        # that appear in the middle of a token.</span>
<a href="#l3.3556"></a><span id="l3.3556" class="difflineminus">-        # This is bonkers; I've never seen it; and it's a bit awkward to</span>
<a href="#l3.3557"></a><span id="l3.3557" class="difflineminus">-        # code good lexers in Python (no goto).  So we break on such</span>
<a href="#l3.3558"></a><span id="l3.3558" class="difflineminus">-        # cases.</span>
<a href="#l3.3559"></a><span id="l3.3559" class="difflineminus">-        token = strtobytes('')</span>
<a href="#l3.3560"></a><span id="l3.3560" class="difflineminus">-        while c.isdigit():</span>
<a href="#l3.3561"></a><span id="l3.3561" class="difflineminus">-            token += c</span>
<a href="#l3.3562"></a><span id="l3.3562" class="difflineminus">-            c = getc()</span>
<a href="#l3.3563"></a><span id="l3.3563" class="difflineminus">-        # Slight hack.  All &quot;tokens&quot; are decimal integers, so convert</span>
<a href="#l3.3564"></a><span id="l3.3564" class="difflineminus">-        # them here.</span>
<a href="#l3.3565"></a><span id="l3.3565" class="difflineminus">-        header.append(int(token))</span>
<a href="#l3.3566"></a><span id="l3.3566" class="difflineminus">-        if len(header) == expected:</span>
<a href="#l3.3567"></a><span id="l3.3567" class="difflineminus">-            break</span>
<a href="#l3.3568"></a><span id="l3.3568" class="difflineminus">-    # Skip comments (again)</span>
<a href="#l3.3569"></a><span id="l3.3569" class="difflineminus">-    while c == '#':</span>
<a href="#l3.3570"></a><span id="l3.3570" class="difflineminus">-        while c not in '\n\r':</span>
<a href="#l3.3571"></a><span id="l3.3571" class="difflineminus">-            c = getc()</span>
<a href="#l3.3572"></a><span id="l3.3572" class="difflineminus">-    if not c.isspace():</span>
<a href="#l3.3573"></a><span id="l3.3573" class="difflineminus">-        raise Error('expected header to end with whitespace, not %s' % c)</span>
<a href="#l3.3574"></a><span id="l3.3574" class="difflineminus">-</span>
<a href="#l3.3575"></a><span id="l3.3575" class="difflineminus">-    if type in pbm:</span>
<a href="#l3.3576"></a><span id="l3.3576" class="difflineminus">-        # synthesize a MAXVAL</span>
<a href="#l3.3577"></a><span id="l3.3577" class="difflineminus">-        header.append(1)</span>
<a href="#l3.3578"></a><span id="l3.3578" class="difflineminus">-    depth = (1,3)[type == strtobytes('P6')]</span>
<a href="#l3.3579"></a><span id="l3.3579" class="difflineminus">-    return header[0], header[1], header[2], depth, header[3]</span>
<a href="#l3.3580"></a><span id="l3.3580" class="difflineminus">-</span>
<a href="#l3.3581"></a><span id="l3.3581" class="difflineminus">-def write_pnm(file, width, height, pixels, meta):</span>
<a href="#l3.3582"></a><span id="l3.3582" class="difflineminus">-    &quot;&quot;&quot;Write a Netpbm PNM/PAM file.&quot;&quot;&quot;</span>
<a href="#l3.3583"></a><span id="l3.3583" class="difflineminus">-</span>
<a href="#l3.3584"></a><span id="l3.3584" class="difflineminus">-    bitdepth = meta['bitdepth']</span>
<a href="#l3.3585"></a><span id="l3.3585" class="difflineminus">-    maxval = 2**bitdepth - 1</span>
<a href="#l3.3586"></a><span id="l3.3586" class="difflineminus">-    # Rudely, the number of image planes can be used to determine</span>
<a href="#l3.3587"></a><span id="l3.3587" class="difflineminus">-    # whether we are L (PGM), LA (PAM), RGB (PPM), or RGBA (PAM).</span>
<a href="#l3.3588"></a><span id="l3.3588" class="difflineminus">-    planes = meta['planes']</span>
<a href="#l3.3589"></a><span id="l3.3589" class="difflineminus">-    # Can be an assert as long as we assume that pixels and meta came</span>
<a href="#l3.3590"></a><span id="l3.3590" class="difflineminus">-    # from a PNG file.</span>
<a href="#l3.3591"></a><span id="l3.3591" class="difflineminus">-    assert planes in (1,2,3,4)</span>
<a href="#l3.3592"></a><span id="l3.3592" class="difflineminus">-    if planes in (1,3):</span>
<a href="#l3.3593"></a><span id="l3.3593" class="difflineminus">-        if 1 == planes:</span>
<a href="#l3.3594"></a><span id="l3.3594" class="difflineminus">-            # PGM</span>
<a href="#l3.3595"></a><span id="l3.3595" class="difflineminus">-            # Could generate PBM if maxval is 1, but we don't (for one</span>
<a href="#l3.3596"></a><span id="l3.3596" class="difflineminus">-            # thing, we'd have to convert the data, not just blat it</span>
<a href="#l3.3597"></a><span id="l3.3597" class="difflineminus">-            # out).</span>
<a href="#l3.3598"></a><span id="l3.3598" class="difflineminus">-            fmt = 'P5'</span>
<a href="#l3.3599"></a><span id="l3.3599" class="difflineminus">-        else:</span>
<a href="#l3.3600"></a><span id="l3.3600" class="difflineminus">-            # PPM</span>
<a href="#l3.3601"></a><span id="l3.3601" class="difflineminus">-            fmt = 'P6'</span>
<a href="#l3.3602"></a><span id="l3.3602" class="difflineminus">-        file.write('%s %d %d %d\n' % (fmt, width, height, maxval))</span>
<a href="#l3.3603"></a><span id="l3.3603" class="difflineminus">-    if planes in (2,4):</span>
<a href="#l3.3604"></a><span id="l3.3604" class="difflineminus">-        # PAM</span>
<a href="#l3.3605"></a><span id="l3.3605" class="difflineminus">-        # See http://netpbm.sourceforge.net/doc/pam.html</span>
<a href="#l3.3606"></a><span id="l3.3606" class="difflineminus">-        if 2 == planes:</span>
<a href="#l3.3607"></a><span id="l3.3607" class="difflineminus">-            tupltype = 'GRAYSCALE_ALPHA'</span>
<a href="#l3.3608"></a><span id="l3.3608" class="difflineminus">-        else:</span>
<a href="#l3.3609"></a><span id="l3.3609" class="difflineminus">-            tupltype = 'RGB_ALPHA'</span>
<a href="#l3.3610"></a><span id="l3.3610" class="difflineminus">-        file.write('P7\nWIDTH %d\nHEIGHT %d\nDEPTH %d\nMAXVAL %d\n'</span>
<a href="#l3.3611"></a><span id="l3.3611" class="difflineminus">-                   'TUPLTYPE %s\nENDHDR\n' %</span>
<a href="#l3.3612"></a><span id="l3.3612" class="difflineminus">-                   (width, height, planes, maxval, tupltype))</span>
<a href="#l3.3613"></a><span id="l3.3613" class="difflineminus">-    # Values per row</span>
<a href="#l3.3614"></a><span id="l3.3614" class="difflineminus">-    vpr = planes * width</span>
<a href="#l3.3615"></a><span id="l3.3615" class="difflineminus">-    # struct format</span>
<a href="#l3.3616"></a><span id="l3.3616" class="difflineminus">-    fmt = '&gt;%d' % vpr</span>
<a href="#l3.3617"></a><span id="l3.3617" class="difflineminus">-    if maxval &gt; 0xff:</span>
<a href="#l3.3618"></a><span id="l3.3618" class="difflineminus">-        fmt = fmt + 'H'</span>
<a href="#l3.3619"></a><span id="l3.3619" class="difflineminus">-    else:</span>
<a href="#l3.3620"></a><span id="l3.3620" class="difflineminus">-        fmt = fmt + 'B'</span>
<a href="#l3.3621"></a><span id="l3.3621" class="difflineminus">-    for row in pixels:</span>
<a href="#l3.3622"></a><span id="l3.3622" class="difflineminus">-        file.write(struct.pack(fmt, *row))</span>
<a href="#l3.3623"></a><span id="l3.3623" class="difflineminus">-    file.flush()</span>
<a href="#l3.3624"></a><span id="l3.3624" class="difflineminus">-</span>
<a href="#l3.3625"></a><span id="l3.3625" class="difflineminus">-def color_triple(color):</span>
<a href="#l3.3626"></a><span id="l3.3626" class="difflineminus">-    &quot;&quot;&quot;</span>
<a href="#l3.3627"></a><span id="l3.3627" class="difflineminus">-    Convert a command line colour value to a RGB triple of integers.</span>
<a href="#l3.3628"></a><span id="l3.3628" class="difflineminus">-    FIXME: Somewhere we need support for greyscale backgrounds etc.</span>
<a href="#l3.3629"></a><span id="l3.3629" class="difflineminus">-    &quot;&quot;&quot;</span>
<a href="#l3.3630"></a><span id="l3.3630" class="difflineminus">-    if color.startswith('#') and len(color) == 4:</span>
<a href="#l3.3631"></a><span id="l3.3631" class="difflineminus">-        return (int(color[1], 16),</span>
<a href="#l3.3632"></a><span id="l3.3632" class="difflineminus">-                int(color[2], 16),</span>
<a href="#l3.3633"></a><span id="l3.3633" class="difflineminus">-                int(color[3], 16))</span>
<a href="#l3.3634"></a><span id="l3.3634" class="difflineminus">-    if color.startswith('#') and len(color) == 7:</span>
<a href="#l3.3635"></a><span id="l3.3635" class="difflineminus">-        return (int(color[1:3], 16),</span>
<a href="#l3.3636"></a><span id="l3.3636" class="difflineminus">-                int(color[3:5], 16),</span>
<a href="#l3.3637"></a><span id="l3.3637" class="difflineminus">-                int(color[5:7], 16))</span>
<a href="#l3.3638"></a><span id="l3.3638" class="difflineminus">-    elif color.startswith('#') and len(color) == 13:</span>
<a href="#l3.3639"></a><span id="l3.3639" class="difflineminus">-        return (int(color[1:5], 16),</span>
<a href="#l3.3640"></a><span id="l3.3640" class="difflineminus">-                int(color[5:9], 16),</span>
<a href="#l3.3641"></a><span id="l3.3641" class="difflineminus">-                int(color[9:13], 16))</span>
<a href="#l3.3642"></a><span id="l3.3642" class="difflineminus">-</span>
<a href="#l3.3643"></a><span id="l3.3643" class="difflineminus">-</span>
<a href="#l3.3644"></a><span id="l3.3644" class="difflineminus">-def _main(argv):</span>
<a href="#l3.3645"></a><span id="l3.3645" class="difflineminus">-    &quot;&quot;&quot;</span>
<a href="#l3.3646"></a><span id="l3.3646" class="difflineminus">-    Run the PNG encoder with options from the command line.</span>
<a href="#l3.3647"></a><span id="l3.3647" class="difflineminus">-    &quot;&quot;&quot;</span>
<a href="#l3.3648"></a><span id="l3.3648" class="difflineminus">-</span>
<a href="#l3.3649"></a><span id="l3.3649" class="difflineminus">-    # Parse command line arguments</span>
<a href="#l3.3650"></a><span id="l3.3650" class="difflineminus">-    from optparse import OptionParser</span>
<a href="#l3.3651"></a><span id="l3.3651" class="difflineminus">-    import re</span>
<a href="#l3.3652"></a><span id="l3.3652" class="difflineminus">-    version = '%prog ' + re.sub(r'( ?\$|URL: |Rev:)', '', __version__)</span>
<a href="#l3.3653"></a><span id="l3.3653" class="difflineminus">-    parser = OptionParser(version=version)</span>
<a href="#l3.3654"></a><span id="l3.3654" class="difflineminus">-    parser.set_usage(&quot;%prog [options] [imagefile]&quot;)</span>
<a href="#l3.3655"></a><span id="l3.3655" class="difflineminus">-    parser.add_option('-r', '--read-png', default=False,</span>
<a href="#l3.3656"></a><span id="l3.3656" class="difflineminus">-                      action='store_true',</span>
<a href="#l3.3657"></a><span id="l3.3657" class="difflineminus">-                      help='Read PNG, write PNM')</span>
<a href="#l3.3658"></a><span id="l3.3658" class="difflineminus">-    parser.add_option(&quot;-i&quot;, &quot;--interlace&quot;,</span>
<a href="#l3.3659"></a><span id="l3.3659" class="difflineminus">-                      default=False, action=&quot;store_true&quot;,</span>
<a href="#l3.3660"></a><span id="l3.3660" class="difflineminus">-                      help=&quot;create an interlaced PNG file (Adam7)&quot;)</span>
<a href="#l3.3661"></a><span id="l3.3661" class="difflineminus">-    parser.add_option(&quot;-t&quot;, &quot;--transparent&quot;,</span>
<a href="#l3.3662"></a><span id="l3.3662" class="difflineminus">-                      action=&quot;store&quot;, type=&quot;string&quot;, metavar=&quot;color&quot;,</span>
<a href="#l3.3663"></a><span id="l3.3663" class="difflineminus">-                      help=&quot;mark the specified colour (#RRGGBB) as transparent&quot;)</span>
<a href="#l3.3664"></a><span id="l3.3664" class="difflineminus">-    parser.add_option(&quot;-b&quot;, &quot;--background&quot;,</span>
<a href="#l3.3665"></a><span id="l3.3665" class="difflineminus">-                      action=&quot;store&quot;, type=&quot;string&quot;, metavar=&quot;color&quot;,</span>
<a href="#l3.3666"></a><span id="l3.3666" class="difflineminus">-                      help=&quot;save the specified background colour&quot;)</span>
<a href="#l3.3667"></a><span id="l3.3667" class="difflineminus">-    parser.add_option(&quot;-a&quot;, &quot;--alpha&quot;,</span>
<a href="#l3.3668"></a><span id="l3.3668" class="difflineminus">-                      action=&quot;store&quot;, type=&quot;string&quot;, metavar=&quot;pgmfile&quot;,</span>
<a href="#l3.3669"></a><span id="l3.3669" class="difflineminus">-                      help=&quot;alpha channel transparency (RGBA)&quot;)</span>
<a href="#l3.3670"></a><span id="l3.3670" class="difflineminus">-    parser.add_option(&quot;-g&quot;, &quot;--gamma&quot;,</span>
<a href="#l3.3671"></a><span id="l3.3671" class="difflineminus">-                      action=&quot;store&quot;, type=&quot;float&quot;, metavar=&quot;value&quot;,</span>
<a href="#l3.3672"></a><span id="l3.3672" class="difflineminus">-                      help=&quot;save the specified gamma value&quot;)</span>
<a href="#l3.3673"></a><span id="l3.3673" class="difflineminus">-    parser.add_option(&quot;-c&quot;, &quot;--compression&quot;,</span>
<a href="#l3.3674"></a><span id="l3.3674" class="difflineminus">-                      action=&quot;store&quot;, type=&quot;int&quot;, metavar=&quot;level&quot;,</span>
<a href="#l3.3675"></a><span id="l3.3675" class="difflineminus">-                      help=&quot;zlib compression level (0-9)&quot;)</span>
<a href="#l3.3676"></a><span id="l3.3676" class="difflineminus">-    parser.add_option(&quot;-T&quot;, &quot;--test&quot;,</span>
<a href="#l3.3677"></a><span id="l3.3677" class="difflineminus">-                      default=False, action=&quot;store_true&quot;,</span>
<a href="#l3.3678"></a><span id="l3.3678" class="difflineminus">-                      help=&quot;create a test image (a named PngSuite image if an argument is supplied)&quot;)</span>
<a href="#l3.3679"></a><span id="l3.3679" class="difflineminus">-    parser.add_option('-L', '--list',</span>
<a href="#l3.3680"></a><span id="l3.3680" class="difflineminus">-                      default=False, action='store_true',</span>
<a href="#l3.3681"></a><span id="l3.3681" class="difflineminus">-                      help=&quot;print list of named test images&quot;)</span>
<a href="#l3.3682"></a><span id="l3.3682" class="difflineminus">-    parser.add_option(&quot;-R&quot;, &quot;--test-red&quot;,</span>
<a href="#l3.3683"></a><span id="l3.3683" class="difflineminus">-                      action=&quot;store&quot;, type=&quot;string&quot;, metavar=&quot;pattern&quot;,</span>
<a href="#l3.3684"></a><span id="l3.3684" class="difflineminus">-                      help=&quot;test pattern for the red image layer&quot;)</span>
<a href="#l3.3685"></a><span id="l3.3685" class="difflineminus">-    parser.add_option(&quot;-G&quot;, &quot;--test-green&quot;,</span>
<a href="#l3.3686"></a><span id="l3.3686" class="difflineminus">-                      action=&quot;store&quot;, type=&quot;string&quot;, metavar=&quot;pattern&quot;,</span>
<a href="#l3.3687"></a><span id="l3.3687" class="difflineminus">-                      help=&quot;test pattern for the green image layer&quot;)</span>
<a href="#l3.3688"></a><span id="l3.3688" class="difflineminus">-    parser.add_option(&quot;-B&quot;, &quot;--test-blue&quot;,</span>
<a href="#l3.3689"></a><span id="l3.3689" class="difflineminus">-                      action=&quot;store&quot;, type=&quot;string&quot;, metavar=&quot;pattern&quot;,</span>
<a href="#l3.3690"></a><span id="l3.3690" class="difflineminus">-                      help=&quot;test pattern for the blue image layer&quot;)</span>
<a href="#l3.3691"></a><span id="l3.3691" class="difflineminus">-    parser.add_option(&quot;-A&quot;, &quot;--test-alpha&quot;,</span>
<a href="#l3.3692"></a><span id="l3.3692" class="difflineminus">-                      action=&quot;store&quot;, type=&quot;string&quot;, metavar=&quot;pattern&quot;,</span>
<a href="#l3.3693"></a><span id="l3.3693" class="difflineminus">-                      help=&quot;test pattern for the alpha image layer&quot;)</span>
<a href="#l3.3694"></a><span id="l3.3694" class="difflineminus">-    parser.add_option(&quot;-K&quot;, &quot;--test-black&quot;,</span>
<a href="#l3.3695"></a><span id="l3.3695" class="difflineminus">-                      action=&quot;store&quot;, type=&quot;string&quot;, metavar=&quot;pattern&quot;,</span>
<a href="#l3.3696"></a><span id="l3.3696" class="difflineminus">-                      help=&quot;test pattern for greyscale image&quot;)</span>
<a href="#l3.3697"></a><span id="l3.3697" class="difflineminus">-    parser.add_option(&quot;-d&quot;, &quot;--test-depth&quot;,</span>
<a href="#l3.3698"></a><span id="l3.3698" class="difflineminus">-                      default=8, action=&quot;store&quot;, type=&quot;int&quot;,</span>
<a href="#l3.3699"></a><span id="l3.3699" class="difflineminus">-                      metavar='NBITS',</span>
<a href="#l3.3700"></a><span id="l3.3700" class="difflineminus">-                      help=&quot;create test PNGs that are NBITS bits per channel&quot;)</span>
<a href="#l3.3701"></a><span id="l3.3701" class="difflineminus">-    parser.add_option(&quot;-S&quot;, &quot;--test-size&quot;,</span>
<a href="#l3.3702"></a><span id="l3.3702" class="difflineminus">-                      action=&quot;store&quot;, type=&quot;int&quot;, metavar=&quot;size&quot;,</span>
<a href="#l3.3703"></a><span id="l3.3703" class="difflineminus">-                      help=&quot;width and height of the test image&quot;)</span>
<a href="#l3.3704"></a><span id="l3.3704" class="difflineminus">-    (options, args) = parser.parse_args(args=argv[1:])</span>
<a href="#l3.3705"></a><span id="l3.3705" class="difflineminus">-</span>
<a href="#l3.3706"></a><span id="l3.3706" class="difflineminus">-    # Convert options</span>
<a href="#l3.3707"></a><span id="l3.3707" class="difflineminus">-    if options.transparent is not None:</span>
<a href="#l3.3708"></a><span id="l3.3708" class="difflineminus">-        options.transparent = color_triple(options.transparent)</span>
<a href="#l3.3709"></a><span id="l3.3709" class="difflineminus">-    if options.background is not None:</span>
<a href="#l3.3710"></a><span id="l3.3710" class="difflineminus">-        options.background = color_triple(options.background)</span>
<a href="#l3.3711"></a><span id="l3.3711" class="difflineminus">-</span>
<a href="#l3.3712"></a><span id="l3.3712" class="difflineminus">-    if options.list:</span>
<a href="#l3.3713"></a><span id="l3.3713" class="difflineminus">-        names = list(_pngsuite)</span>
<a href="#l3.3714"></a><span id="l3.3714" class="difflineminus">-        names.sort()</span>
<a href="#l3.3715"></a><span id="l3.3715" class="difflineminus">-        for name in names:</span>
<a href="#l3.3716"></a><span id="l3.3716" class="difflineminus">-            print name</span>
<a href="#l3.3717"></a><span id="l3.3717" class="difflineminus">-        return</span>
<a href="#l3.3718"></a><span id="l3.3718" class="difflineminus">-</span>
<a href="#l3.3719"></a><span id="l3.3719" class="difflineminus">-    # Run regression tests</span>
<a href="#l3.3720"></a><span id="l3.3720" class="difflineminus">-    if options.test:</span>
<a href="#l3.3721"></a><span id="l3.3721" class="difflineminus">-        return test_suite(options, args)</span>
<a href="#l3.3722"></a><span id="l3.3722" class="difflineminus">-</span>
<a href="#l3.3723"></a><span id="l3.3723" class="difflineminus">-    # Prepare input and output files</span>
<a href="#l3.3724"></a><span id="l3.3724" class="difflineminus">-    if len(args) == 0:</span>
<a href="#l3.3725"></a><span id="l3.3725" class="difflineminus">-        infilename = '-'</span>
<a href="#l3.3726"></a><span id="l3.3726" class="difflineminus">-        infile = sys.stdin</span>
<a href="#l3.3727"></a><span id="l3.3727" class="difflineminus">-    elif len(args) == 1:</span>
<a href="#l3.3728"></a><span id="l3.3728" class="difflineminus">-        infilename = args[0]</span>
<a href="#l3.3729"></a><span id="l3.3729" class="difflineminus">-        infile = open(infilename, 'rb')</span>
<a href="#l3.3730"></a><span id="l3.3730" class="difflineminus">-    else:</span>
<a href="#l3.3731"></a><span id="l3.3731" class="difflineminus">-        parser.error(&quot;more than one input file&quot;)</span>
<a href="#l3.3732"></a><span id="l3.3732" class="difflineminus">-    outfile = sys.stdout</span>
<a href="#l3.3733"></a><span id="l3.3733" class="difflineminus">-</span>
<a href="#l3.3734"></a><span id="l3.3734" class="difflineminus">-    if options.read_png:</span>
<a href="#l3.3735"></a><span id="l3.3735" class="difflineminus">-        # Encode PNG to PPM</span>
<a href="#l3.3736"></a><span id="l3.3736" class="difflineminus">-        png = Reader(file=infile)</span>
<a href="#l3.3737"></a><span id="l3.3737" class="difflineminus">-        width,height,pixels,meta = png.asDirect()</span>
<a href="#l3.3738"></a><span id="l3.3738" class="difflineminus">-        write_pnm(outfile, width, height, pixels, meta) </span>
<a href="#l3.3739"></a><span id="l3.3739" class="difflineminus">-    else:</span>
<a href="#l3.3740"></a><span id="l3.3740" class="difflineminus">-        # Encode PNM to PNG</span>
<a href="#l3.3741"></a><span id="l3.3741" class="difflineminus">-        format, width, height, depth, maxval = \</span>
<a href="#l3.3742"></a><span id="l3.3742" class="difflineminus">-          read_pnm_header(infile, ('P5','P6','P7'))</span>
<a href="#l3.3743"></a><span id="l3.3743" class="difflineminus">-        # When it comes to the variety of input formats, we do something</span>
<a href="#l3.3744"></a><span id="l3.3744" class="difflineminus">-        # rather rude.  Observe that L, LA, RGB, RGBA are the 4 colour</span>
<a href="#l3.3745"></a><span id="l3.3745" class="difflineminus">-        # types supported by PNG and that they correspond to 1, 2, 3, 4</span>
<a href="#l3.3746"></a><span id="l3.3746" class="difflineminus">-        # channels respectively.  So we use the number of channels in</span>
<a href="#l3.3747"></a><span id="l3.3747" class="difflineminus">-        # the source image to determine which one we have.  We do not</span>
<a href="#l3.3748"></a><span id="l3.3748" class="difflineminus">-        # care about TUPLTYPE.</span>
<a href="#l3.3749"></a><span id="l3.3749" class="difflineminus">-        greyscale = depth &lt;= 2</span>
<a href="#l3.3750"></a><span id="l3.3750" class="difflineminus">-        pamalpha = depth in (2,4)</span>
<a href="#l3.3751"></a><span id="l3.3751" class="difflineminus">-        supported = map(lambda x: 2**x-1, range(1,17))</span>
<a href="#l3.3752"></a><span id="l3.3752" class="difflineminus">-        try:</span>
<a href="#l3.3753"></a><span id="l3.3753" class="difflineminus">-            mi = supported.index(maxval)</span>
<a href="#l3.3754"></a><span id="l3.3754" class="difflineminus">-        except ValueError:</span>
<a href="#l3.3755"></a><span id="l3.3755" class="difflineminus">-            raise NotImplementedError(</span>
<a href="#l3.3756"></a><span id="l3.3756" class="difflineminus">-              'your maxval (%s) not in supported list %s' %</span>
<a href="#l3.3757"></a><span id="l3.3757" class="difflineminus">-              (maxval, str(supported)))</span>
<a href="#l3.3758"></a><span id="l3.3758" class="difflineminus">-        bitdepth = mi+1</span>
<a href="#l3.3759"></a><span id="l3.3759" class="difflineminus">-        writer = Writer(width, height,</span>
<a href="#l3.3760"></a><span id="l3.3760" class="difflineminus">-                        greyscale=greyscale,</span>
<a href="#l3.3761"></a><span id="l3.3761" class="difflineminus">-                        bitdepth=bitdepth,</span>
<a href="#l3.3762"></a><span id="l3.3762" class="difflineminus">-                        interlace=options.interlace,</span>
<a href="#l3.3763"></a><span id="l3.3763" class="difflineminus">-                        transparent=options.transparent,</span>
<a href="#l3.3764"></a><span id="l3.3764" class="difflineminus">-                        background=options.background,</span>
<a href="#l3.3765"></a><span id="l3.3765" class="difflineminus">-                        alpha=bool(pamalpha or options.alpha),</span>
<a href="#l3.3766"></a><span id="l3.3766" class="difflineminus">-                        gamma=options.gamma,</span>
<a href="#l3.3767"></a><span id="l3.3767" class="difflineminus">-                        compression=options.compression)</span>
<a href="#l3.3768"></a><span id="l3.3768" class="difflineminus">-        if options.alpha:</span>
<a href="#l3.3769"></a><span id="l3.3769" class="difflineminus">-            pgmfile = open(options.alpha, 'rb')</span>
<a href="#l3.3770"></a><span id="l3.3770" class="difflineminus">-            format, awidth, aheight, adepth, amaxval = \</span>
<a href="#l3.3771"></a><span id="l3.3771" class="difflineminus">-              read_pnm_header(pgmfile, 'P5')</span>
<a href="#l3.3772"></a><span id="l3.3772" class="difflineminus">-            if amaxval != '255':</span>
<a href="#l3.3773"></a><span id="l3.3773" class="difflineminus">-                raise NotImplementedError(</span>
<a href="#l3.3774"></a><span id="l3.3774" class="difflineminus">-                  'maxval %s not supported for alpha channel' % amaxval)</span>
<a href="#l3.3775"></a><span id="l3.3775" class="difflineminus">-            if (awidth, aheight) != (width, height):</span>
<a href="#l3.3776"></a><span id="l3.3776" class="difflineminus">-                raise ValueError(&quot;alpha channel image size mismatch&quot;</span>
<a href="#l3.3777"></a><span id="l3.3777" class="difflineminus">-                                 &quot; (%s has %sx%s but %s has %sx%s)&quot;</span>
<a href="#l3.3778"></a><span id="l3.3778" class="difflineminus">-                                 % (infilename, width, height,</span>
<a href="#l3.3779"></a><span id="l3.3779" class="difflineminus">-                                    options.alpha, awidth, aheight))</span>
<a href="#l3.3780"></a><span id="l3.3780" class="difflineminus">-            writer.convert_ppm_and_pgm(infile, pgmfile, outfile)</span>
<a href="#l3.3781"></a><span id="l3.3781" class="difflineminus">-        else:</span>
<a href="#l3.3782"></a><span id="l3.3782" class="difflineminus">-            writer.convert_pnm(infile, outfile)</span>
<a href="#l3.3783"></a><span id="l3.3783" class="difflineminus">-</span>
<a href="#l3.3784"></a><span id="l3.3784" class="difflineminus">-</span>
<a href="#l3.3785"></a><span id="l3.3785" class="difflineminus">-if __name__ == '__main__':</span>
<a href="#l3.3786"></a><span id="l3.3786" class="difflineminus">-    try:</span>
<a href="#l3.3787"></a><span id="l3.3787" class="difflineminus">-        _main(sys.argv)</span>
<a href="#l3.3788"></a><span id="l3.3788" class="difflineminus">-    except Error, e:</span>
<a href="#l3.3789"></a><span id="l3.3789" class="difflineminus">-        print &gt;&gt;sys.stderr, e</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1">deleted file mode 100644</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineminus">--- a/mail/app/png2ico.py</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineplus">+++ /dev/null</span>
<a href="#l4.4"></a><span id="l4.4" class="difflineat">@@ -1,82 +0,0 @@</span>
<a href="#l4.5"></a><span id="l4.5" class="difflineminus">-#!/usr/bin/env python</span>
<a href="#l4.6"></a><span id="l4.6" class="difflineminus">-# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l4.7"></a><span id="l4.7" class="difflineminus">-# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l4.8"></a><span id="l4.8" class="difflineminus">-# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l4.9"></a><span id="l4.9" class="difflineminus">-</span>
<a href="#l4.10"></a><span id="l4.10" class="difflineminus">-import png</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineminus">-import sys</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-import StringIO</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-import struct</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-import ctypes</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineminus">-</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineminus">-# ref: http://msdn.microsoft.com/en-us/library/ms997538</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineminus">-class ICONDIR(ctypes.LittleEndianStructure):</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineminus">-    _pack_ = 1</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineminus">-    _fields_ = [(&quot;idReserved&quot;, ctypes.c_ushort),</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineminus">-                (&quot;idType&quot;, ctypes.c_ushort),</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineminus">-                (&quot;idCount&quot;, ctypes.c_ushort)]</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineminus">-</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineminus">-class ICONDIRENTRY(ctypes.LittleEndianStructure):</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineminus">-    _pack_ = 1</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineminus">-    _fields_ = [(&quot;bWidth&quot;, ctypes.c_byte),</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineminus">-                (&quot;bHeight&quot;, ctypes.c_byte),</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineminus">-                (&quot;bColorCount&quot;, ctypes.c_byte),</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineminus">-                (&quot;bReserved&quot;, ctypes.c_byte),</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineminus">-                (&quot;wPlanes&quot;, ctypes.c_ushort),</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineminus">-                (&quot;wBitCount&quot;, ctypes.c_ushort),</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">-                (&quot;dwBytesInRes&quot;, ctypes.c_ulong),</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineminus">-                (&quot;dwImageOffset&quot;, ctypes.c_ulong)]</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineminus">-</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineminus">-# R, G, B, A, so 4 columns per pixel</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineminus">-COLS_PP = 4</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineminus">-</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineminus">-def main(infile, left, top, size, outfile):</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineminus">-    img = png.Reader(filename=infile)</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineminus">-    pixels = list(img.asRGBA()[2])</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineminus">-    # Take the subarray out. This is the ugliest but probably most efficient way</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineminus">-    # to do it</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineminus">-    outpixels = [[0] * (size * COLS_PP) for x in xrange(size)]</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineminus">-    for row in xrange(size):</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineminus">-        for col in xrange(size * COLS_PP):</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineminus">-            outpixels[row][col] = pixels[top + row][left * COLS_PP + col]</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineminus">-</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineminus">-    # Set up a 32bpp RGBA PNG.</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineminus">-    writer = png.Writer(size=(size, size), bitdepth=8, alpha=True)</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineminus">-    # Write to a memory buffer</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineminus">-    outpng = StringIO.StringIO()</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineminus">-    writer.write(outpng, outpixels)</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineminus">-    outpngbuf = outpng.getvalue()</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineminus">-    outpng.close()</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineminus">-</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineminus">-    # Set up an icon header</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineminus">-    icondir = ICONDIR()</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineminus">-    icondir.idReserved = 0</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineminus">-    # Icons are type 1</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineminus">-    icondir.idType = 1</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineminus">-    icondir.idCount = 1</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineminus">-</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineminus">-    iconentry = ICONDIRENTRY()</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineminus">-    iconentry.bWidth = size</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineminus">-    iconentry.bHeight = size</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineminus">-    # Truecolor images have color count set to 0</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineminus">-    iconentry.bColorCount = 0</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineminus">-    iconentry.bReserved = 0</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineminus">-    # PNGs have 1 color plane</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineminus">-    iconentry.wPlanes = 1</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineminus">-    # We're RGBA, so 32 bits per pixel</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineminus">-    iconentry.wBitCount = 32</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineminus">-    # Length of the buffer</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineminus">-    iconentry.dwBytesInRes = len(outpngbuf)</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineminus">-    # The data will be right after the icondir and iconentry</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineminus">-    iconentry.dwImageOffset = ctypes.sizeof(icondir) + ctypes.sizeof(iconentry)</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineminus">-</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineminus">-    # Time to write everything out</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineminus">-    out = open(outfile, &quot;wb&quot;)</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineminus">-    out.write(icondir)</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineminus">-    out.write(iconentry)</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineminus">-    out.write(outpngbuf)</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineminus">-    out.close()</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineminus">-</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineminus">-if __name__ == &quot;__main__&quot;:</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineminus">-    # Convert left, top and size into integers</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineminus">-    main(*([sys.argv[1]] + [int(val) for val in sys.argv[2:5]] + [sys.argv[5]]))</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/app/splash.rc</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/app/splash.rc</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -8,19 +8,19 @@</span>
<a href="#l5.4"></a><span id="l5.4"> 1 24 &quot;thunderbird.exe.manifest&quot;</span>
<a href="#l5.5"></a><span id="l5.5"> </span>
<a href="#l5.6"></a><span id="l5.6"> STRINGTABLE DISCARDABLE</span>
<a href="#l5.7"></a><span id="l5.7"> BEGIN</span>
<a href="#l5.8"></a><span id="l5.8">     IDS_STARTMENU_APPNAME,              &quot;@MOZ_APP_DISPLAYNAME@&quot;</span>
<a href="#l5.9"></a><span id="l5.9"> END</span>
<a href="#l5.10"></a><span id="l5.10"> </span>
<a href="#l5.11"></a><span id="l5.11"> // Program icon.</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-IDI_APPLICATION ICON THUNDERBIRD_ICO</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+IDI_APPLICATION ICON MESSENGERWINDOW_ICO</span>
<a href="#l5.14"></a><span id="l5.14"> </span>
<a href="#l5.15"></a><span id="l5.15"> // For some reason IDI_MAILBIFF needs to be larger than the value of IDI_APPLICATION for static builds</span>
<a href="#l5.16"></a><span id="l5.16"> #define IDI_MAILBIFF 32576</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineminus">-IDI_MAILBIFF  ICON  TB_MAILBIFF_ICO</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+IDI_MAILBIFF  ICON  NEWMAIL_ICO</span>
<a href="#l5.19"></a><span id="l5.19"> </span>
<a href="#l5.20"></a><span id="l5.20"> // Windows taskbar icons</span>
<a href="#l5.21"></a><span id="l5.21"> #define IDI_WRITE_MESSAGE 32577</span>
<a href="#l5.22"></a><span id="l5.22"> #define IDI_ADDRESS_BOOK  32578</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineminus">-IDI_WRITE_MESSAGE ICON &quot;write-message.ico&quot;</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineminus">-IDI_ADDRESS_BOOK  ICON &quot;address-book.ico&quot;</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineplus">+IDI_WRITE_MESSAGE ICON WRITEMESSAGE_ICO</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineplus">+IDI_ADDRESS_BOOK  ICON ADDRESSBOOK_ICO</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1">new file mode 100644</span>
<a href="#l6.2"></a><span id="l6.2">index e69de29bb2d1d6434b8b29ae775ad8c2e48c5391..04eab008641eb34bee00946695fd46f69656f30b</span>
<a href="#l6.3"></a><span id="l6.3">GIT binary patch
literal 421
zc$@*H0b2e50096201yxW0096X0FMCx02TlM0EtjeM-2)Z3IG5A4M|8uQUCw|5C8xG
z5C{eU001BJ|6u?C0ai&amp;wK~#90V_?7n{{R2a1jLbFzka;|!a#N?Hg#A5P;u&lt;{A3uM7
z`~LmkjXU@M-MstYABYVU`vH&lt;8q*?OUuiyWctlRp(qIJUmawrC|mu=Yo|HqGCe}QVa
z@EOnyvaPtW=RY&lt;Kk^`#Az-Peb1IJGP&amp;#UdgijST?4^;AhB~Amr|M&gt;A|!mP#rvnrag
z;z@It{{Q~{$1j`)eEIhM=Y-jd|EHGJW5xZm7XAPF_4^NeURVk8XJSG1e{2{U1`F^R
z;0#psKclSSe@u263eK)*`v3FiFHjihVbjPCOfa**e*5+c6pbK5it0Q5N2C{ladCYo
z$oBugfB*gmRP!9@jk!QQoQS~t{$m&lt;Y!P}&amp;Qs{g^sd3bS3A=oQ#K^DRd013q9l&gt;YaR
z%OncNWS4*qK{3E9D)m1p7{dU!u*CnQU=#!X{rd;XC?o-(o}W0QlN0~|&gt;@VQ3uWAQm
P00000NkvXXu0mjfC^N}l</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1">deleted file mode 100644</span>
<a href="#l7.2"></a><span id="l7.2">index ff6094cb7cafdb9b636fb17cc0baa13a452e1038..e69de29bb2d1d6434b8b29ae775ad8c2e48c5391</span>
<a href="#l7.3"></a><span id="l7.3">GIT binary patch
literal 0
Hc$@&lt;O00001</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1">new file mode 100644</span>
<a href="#l8.2"></a><span id="l8.2">index e69de29bb2d1d6434b8b29ae775ad8c2e48c5391..62ec69573ee977f8740594007e8dc430a804dd78</span>
<a href="#l8.3"></a><span id="l8.3">GIT binary patch
literal 337
zc$@)I0j~Z40096201yxW0096X06PHy02TlM0EtjeM-2)Z3IG5A4M|8uQUCw|5C8xG
z5C{eU001BJ|6u?C0Rl-xK~#90V_={L_)jFjYe0GH1iTn#0FdJQ`t|D#AkBkfKyhOa
zUJM0dA3lEi|MlDV{~#J}2#A$e+kqE@07%oBi&amp;y?97F7Q)Zt4N^;Ra+?G~&gt;kOEq!1E
z_8&amp;bB)(pZR&amp;EJ3gcm+2gwWJ;^25AN&lt;-oEcJm=DwZ&lt;Hye@Ky4gw17Id2&lt;I1*vu;LXP
zwxQbm{l`t978aC1jL9xT!PV^(z&gt;4#0+Q57e4blAb7}jWvNH2op`mV`v%^*IA27%wd
z|8ByW4uX^O;27vXuqF^2rkP+u@{h}eV;CQ%xogTC!UlLnrNS``0Hf)DO~(Yd7+wS1
j!V&gt;Xff(B5OnJ57Owfg@gKP%tC00000NkvXXu0mjfnTm;j</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1">new file mode 100644</span>
<a href="#l9.2"></a><span id="l9.2">index e69de29bb2d1d6434b8b29ae775ad8c2e48c5391..04eab008641eb34bee00946695fd46f69656f30b</span>
<a href="#l9.3"></a><span id="l9.3">GIT binary patch
literal 421
zc$@*H0b2e50096201yxW0096X0FMCx02TlM0EtjeM-2)Z3IG5A4M|8uQUCw|5C8xG
z5C{eU001BJ|6u?C0ai&amp;wK~#90V_?7n{{R2a1jLbFzka;|!a#N?Hg#A5P;u&lt;{A3uM7
z`~LmkjXU@M-MstYABYVU`vH&lt;8q*?OUuiyWctlRp(qIJUmawrC|mu=Yo|HqGCe}QVa
z@EOnyvaPtW=RY&lt;Kk^`#Az-Peb1IJGP&amp;#UdgijST?4^;AhB~Amr|M&gt;A|!mP#rvnrag
z;z@It{{Q~{$1j`)eEIhM=Y-jd|EHGJW5xZm7XAPF_4^NeURVk8XJSG1e{2{U1`F^R
z;0#psKclSSe@u263eK)*`v3FiFHjihVbjPCOfa**e*5+c6pbK5it0Q5N2C{ladCYo
z$oBugfB*gmRP!9@jk!QQoQS~t{$m&lt;Y!P}&amp;Qs{g^sd3bS3A=oQ#K^DRd013q9l&gt;YaR
z%OncNWS4*qK{3E9D)m1p7{dU!u*CnQU=#!X{rd;XC?o-(o}W0QlN0~|&gt;@VQ3uWAQm
P00000NkvXXu0mjfC^N}l</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1">new file mode 100644</span>
<a href="#l10.2"></a><span id="l10.2">index e69de29bb2d1d6434b8b29ae775ad8c2e48c5391..62ec69573ee977f8740594007e8dc430a804dd78</span>
<a href="#l10.3"></a><span id="l10.3">GIT binary patch
literal 337
zc$@)I0j~Z40096201yxW0096X06PHy02TlM0EtjeM-2)Z3IG5A4M|8uQUCw|5C8xG
z5C{eU001BJ|6u?C0Rl-xK~#90V_={L_)jFjYe0GH1iTn#0FdJQ`t|D#AkBkfKyhOa
zUJM0dA3lEi|MlDV{~#J}2#A$e+kqE@07%oBi&amp;y?97F7Q)Zt4N^;Ra+?G~&gt;kOEq!1E
z_8&amp;bB)(pZR&amp;EJ3gcm+2gwWJ;^25AN&lt;-oEcJm=DwZ&lt;Hye@Ky4gw17Id2&lt;I1*vu;LXP
zwxQbm{l`t978aC1jL9xT!PV^(z&gt;4#0+Q57e4blAb7}jWvNH2op`mV`v%^*IA27%wd
z|8ByW4uX^O;27vXuqF^2rkP+u@{h}eV;CQ%xogTC!UlLnrNS``0Hf)DO~(Yd7+wS1
j!V&gt;Xff(B5OnJ57Owfg@gKP%tC00000NkvXXu0mjfnTm;j</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

