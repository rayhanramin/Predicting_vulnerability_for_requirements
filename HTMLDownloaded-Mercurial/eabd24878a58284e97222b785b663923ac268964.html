<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 22361:eabd24878a58284e97222b785b663923ac268964</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ eabd24878a58284e97222b785b663923ac268964" />
<meta property="og:url" content="/comm-central/rev/eabd24878a58284e97222b785b663923ac268964" />
<meta property="og:description" content="Bug 1399756 - remove trailing spaces in mailnews/addrbook. rs=white-space-only" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / eabd24878a58284e97222b785b663923ac268964 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/eabd24878a58284e97222b785b663923ac268964">shortlog</a> |
<a href="/comm-central/log/eabd24878a58284e97222b785b663923ac268964">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/eabd24878a58284e97222b785b663923ac268964">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/eabd24878a58284e97222b785b663923ac268964">files</a> |
changeset |
<a href="/comm-central/raw-rev/eabd24878a58284e97222b785b663923ac268964">raw</a>  | <a href="/comm-central/archive/eabd24878a58284e97222b785b663923ac268964.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1399756">Bug 1399756</a> - remove trailing spaces in mailnews/addrbook. rs=white-space-only
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#111;&#114;&#103;&#32;&#75;&#32;&#60;&#106;&#111;&#114;&#103;&#107;&#64;&#106;&#111;&#114;&#103;&#107;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 17 Oct 2017 11:46:05 +0200</td></tr>

<tr>
 <td>changeset 22361</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/eabd24878a58284e97222b785b663923ac268964">eabd24878a58284e97222b785b663923ac268964</a></td>
</tr>



<tr>
<td>parent 22360</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/b5a7d14c4cd2c2f8cb0560c493dac664d6c3c1c9">b5a7d14c4cd2c2f8cb0560c493dac664d6c3c1c9</a>
</td>
</tr>

<tr>
<td>child 22362</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/a9943edf1fed34d4caf53f89126be5365f9ea881">a9943edf1fed34d4caf53f89126be5365f9ea881</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=eabd24878a58284e97222b785b663923ac268964">13629</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Tue, 17 Oct 2017 09:50:42 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@eabd24878a58 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=eabd24878a58284e97222b785b663923ac268964">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=eabd24878a58284e97222b785b663923ac268964&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=eabd24878a58284e97222b785b663923ac268964&newProject=comm-central&newRevision=eabd24878a58284e97222b785b663923ac268964&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=eabd24878a58284e97222b785b663923ac268964&newProject=comm-central&newRevision=eabd24878a58284e97222b785b663923ac268964&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=eabd24878a58284e97222b785b663923ac268964&newProject=comm-central&newRevision=eabd24878a58284e97222b785b663923ac268964&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28white-space-only%29&revcount=50">white-space-only</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1399756">1399756</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1399756">Bug 1399756</a> - remove trailing spaces in mailnews/addrbook. rs=white-space-only</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/public/nsAbBaseCID.h">mailnews/addrbook/public/nsAbBaseCID.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/public/nsAbBaseCID.h">file</a> |
<a href="/comm-central/annotate/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/public/nsAbBaseCID.h">annotate</a> |
<a href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/public/nsAbBaseCID.h">diff</a> |
<a href="/comm-central/comparison/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/public/nsAbBaseCID.h">comparison</a> |
<a href="/comm-central/log/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/public/nsAbBaseCID.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbAddressCollector.cpp">mailnews/addrbook/src/nsAbAddressCollector.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbAddressCollector.cpp">file</a> |
<a href="/comm-central/annotate/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbAddressCollector.cpp">annotate</a> |
<a href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbAddressCollector.cpp">diff</a> |
<a href="/comm-central/comparison/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbAddressCollector.cpp">comparison</a> |
<a href="/comm-central/log/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbAddressCollector.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbBSDirectory.cpp">mailnews/addrbook/src/nsAbBSDirectory.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbBSDirectory.cpp">file</a> |
<a href="/comm-central/annotate/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbBSDirectory.cpp">annotate</a> |
<a href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbBSDirectory.cpp">diff</a> |
<a href="/comm-central/comparison/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbBSDirectory.cpp">comparison</a> |
<a href="/comm-central/log/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbBSDirectory.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbBoolExprToLDAPFilter.cpp">mailnews/addrbook/src/nsAbBoolExprToLDAPFilter.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbBoolExprToLDAPFilter.cpp">file</a> |
<a href="/comm-central/annotate/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbBoolExprToLDAPFilter.cpp">annotate</a> |
<a href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbBoolExprToLDAPFilter.cpp">diff</a> |
<a href="/comm-central/comparison/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbBoolExprToLDAPFilter.cpp">comparison</a> |
<a href="/comm-central/log/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbBoolExprToLDAPFilter.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbCardProperty.cpp">mailnews/addrbook/src/nsAbCardProperty.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbCardProperty.cpp">file</a> |
<a href="/comm-central/annotate/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbCardProperty.cpp">annotate</a> |
<a href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbCardProperty.cpp">diff</a> |
<a href="/comm-central/comparison/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbCardProperty.cpp">comparison</a> |
<a href="/comm-central/log/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbCardProperty.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbCardProperty.h">mailnews/addrbook/src/nsAbCardProperty.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbCardProperty.h">file</a> |
<a href="/comm-central/annotate/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbCardProperty.h">annotate</a> |
<a href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbCardProperty.h">diff</a> |
<a href="/comm-central/comparison/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbCardProperty.h">comparison</a> |
<a href="/comm-central/log/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbCardProperty.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbContentHandler.cpp">mailnews/addrbook/src/nsAbContentHandler.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbContentHandler.cpp">file</a> |
<a href="/comm-central/annotate/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbContentHandler.cpp">annotate</a> |
<a href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbContentHandler.cpp">diff</a> |
<a href="/comm-central/comparison/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbContentHandler.cpp">comparison</a> |
<a href="/comm-central/log/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbContentHandler.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbContentHandler.h">mailnews/addrbook/src/nsAbContentHandler.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbContentHandler.h">file</a> |
<a href="/comm-central/annotate/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbContentHandler.h">annotate</a> |
<a href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbContentHandler.h">diff</a> |
<a href="/comm-central/comparison/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbContentHandler.h">comparison</a> |
<a href="/comm-central/log/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbContentHandler.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbDirFactoryService.cpp">mailnews/addrbook/src/nsAbDirFactoryService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbDirFactoryService.cpp">file</a> |
<a href="/comm-central/annotate/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbDirFactoryService.cpp">annotate</a> |
<a href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbDirFactoryService.cpp">diff</a> |
<a href="/comm-central/comparison/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbDirFactoryService.cpp">comparison</a> |
<a href="/comm-central/log/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbDirFactoryService.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbDirProperty.cpp">mailnews/addrbook/src/nsAbDirProperty.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbDirProperty.cpp">file</a> |
<a href="/comm-central/annotate/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbDirProperty.cpp">annotate</a> |
<a href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbDirProperty.cpp">diff</a> |
<a href="/comm-central/comparison/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbDirProperty.cpp">comparison</a> |
<a href="/comm-central/log/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbDirProperty.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbDirProperty.h">mailnews/addrbook/src/nsAbDirProperty.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbDirProperty.h">file</a> |
<a href="/comm-central/annotate/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbDirProperty.h">annotate</a> |
<a href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbDirProperty.h">diff</a> |
<a href="/comm-central/comparison/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbDirProperty.h">comparison</a> |
<a href="/comm-central/log/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbDirProperty.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbDirectoryQuery.cpp">mailnews/addrbook/src/nsAbDirectoryQuery.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbDirectoryQuery.cpp">file</a> |
<a href="/comm-central/annotate/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbDirectoryQuery.cpp">annotate</a> |
<a href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbDirectoryQuery.cpp">diff</a> |
<a href="/comm-central/comparison/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbDirectoryQuery.cpp">comparison</a> |
<a href="/comm-central/log/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbDirectoryQuery.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPCard.cpp">mailnews/addrbook/src/nsAbLDAPCard.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPCard.cpp">file</a> |
<a href="/comm-central/annotate/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPCard.cpp">annotate</a> |
<a href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPCard.cpp">diff</a> |
<a href="/comm-central/comparison/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPCard.cpp">comparison</a> |
<a href="/comm-central/log/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPCard.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPChangeLogData.cpp">mailnews/addrbook/src/nsAbLDAPChangeLogData.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPChangeLogData.cpp">file</a> |
<a href="/comm-central/annotate/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPChangeLogData.cpp">annotate</a> |
<a href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPChangeLogData.cpp">diff</a> |
<a href="/comm-central/comparison/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPChangeLogData.cpp">comparison</a> |
<a href="/comm-central/log/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPChangeLogData.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPChangeLogData.h">mailnews/addrbook/src/nsAbLDAPChangeLogData.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPChangeLogData.h">file</a> |
<a href="/comm-central/annotate/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPChangeLogData.h">annotate</a> |
<a href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPChangeLogData.h">diff</a> |
<a href="/comm-central/comparison/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPChangeLogData.h">comparison</a> |
<a href="/comm-central/log/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPChangeLogData.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPChangeLogQuery.cpp">mailnews/addrbook/src/nsAbLDAPChangeLogQuery.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPChangeLogQuery.cpp">file</a> |
<a href="/comm-central/annotate/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPChangeLogQuery.cpp">annotate</a> |
<a href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPChangeLogQuery.cpp">diff</a> |
<a href="/comm-central/comparison/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPChangeLogQuery.cpp">comparison</a> |
<a href="/comm-central/log/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPChangeLogQuery.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPDirFactory.cpp">mailnews/addrbook/src/nsAbLDAPDirFactory.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPDirFactory.cpp">file</a> |
<a href="/comm-central/annotate/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPDirFactory.cpp">annotate</a> |
<a href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPDirFactory.cpp">diff</a> |
<a href="/comm-central/comparison/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPDirFactory.cpp">comparison</a> |
<a href="/comm-central/log/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPDirFactory.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPDirectory.cpp">mailnews/addrbook/src/nsAbLDAPDirectory.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPDirectory.cpp">file</a> |
<a href="/comm-central/annotate/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPDirectory.cpp">annotate</a> |
<a href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPDirectory.cpp">diff</a> |
<a href="/comm-central/comparison/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPDirectory.cpp">comparison</a> |
<a href="/comm-central/log/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPDirectory.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPDirectoryModify.cpp">mailnews/addrbook/src/nsAbLDAPDirectoryModify.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPDirectoryModify.cpp">file</a> |
<a href="/comm-central/annotate/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPDirectoryModify.cpp">annotate</a> |
<a href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPDirectoryModify.cpp">diff</a> |
<a href="/comm-central/comparison/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPDirectoryModify.cpp">comparison</a> |
<a href="/comm-central/log/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPDirectoryModify.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.cpp">mailnews/addrbook/src/nsAbLDAPDirectoryQuery.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.cpp">file</a> |
<a href="/comm-central/annotate/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.cpp">annotate</a> |
<a href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.cpp">diff</a> |
<a href="/comm-central/comparison/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.cpp">comparison</a> |
<a href="/comm-central/log/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPReplicationData.cpp">mailnews/addrbook/src/nsAbLDAPReplicationData.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPReplicationData.cpp">file</a> |
<a href="/comm-central/annotate/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPReplicationData.cpp">annotate</a> |
<a href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPReplicationData.cpp">diff</a> |
<a href="/comm-central/comparison/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPReplicationData.cpp">comparison</a> |
<a href="/comm-central/log/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPReplicationData.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPReplicationData.h">mailnews/addrbook/src/nsAbLDAPReplicationData.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPReplicationData.h">file</a> |
<a href="/comm-central/annotate/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPReplicationData.h">annotate</a> |
<a href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPReplicationData.h">diff</a> |
<a href="/comm-central/comparison/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPReplicationData.h">comparison</a> |
<a href="/comm-central/log/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPReplicationData.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPReplicationQuery.cpp">mailnews/addrbook/src/nsAbLDAPReplicationQuery.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPReplicationQuery.cpp">file</a> |
<a href="/comm-central/annotate/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPReplicationQuery.cpp">annotate</a> |
<a href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPReplicationQuery.cpp">diff</a> |
<a href="/comm-central/comparison/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPReplicationQuery.cpp">comparison</a> |
<a href="/comm-central/log/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPReplicationQuery.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPReplicationService.cpp">mailnews/addrbook/src/nsAbLDAPReplicationService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPReplicationService.cpp">file</a> |
<a href="/comm-central/annotate/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPReplicationService.cpp">annotate</a> |
<a href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPReplicationService.cpp">diff</a> |
<a href="/comm-central/comparison/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPReplicationService.cpp">comparison</a> |
<a href="/comm-central/log/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPReplicationService.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPReplicationService.h">mailnews/addrbook/src/nsAbLDAPReplicationService.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPReplicationService.h">file</a> |
<a href="/comm-central/annotate/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPReplicationService.h">annotate</a> |
<a href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPReplicationService.h">diff</a> |
<a href="/comm-central/comparison/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPReplicationService.h">comparison</a> |
<a href="/comm-central/log/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDAPReplicationService.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDIFService.cpp">mailnews/addrbook/src/nsAbLDIFService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDIFService.cpp">file</a> |
<a href="/comm-central/annotate/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDIFService.cpp">annotate</a> |
<a href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDIFService.cpp">diff</a> |
<a href="/comm-central/comparison/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDIFService.cpp">comparison</a> |
<a href="/comm-central/log/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbLDIFService.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbMDBDirFactory.cpp">mailnews/addrbook/src/nsAbMDBDirFactory.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbMDBDirFactory.cpp">file</a> |
<a href="/comm-central/annotate/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbMDBDirFactory.cpp">annotate</a> |
<a href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbMDBDirFactory.cpp">diff</a> |
<a href="/comm-central/comparison/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbMDBDirFactory.cpp">comparison</a> |
<a href="/comm-central/log/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbMDBDirFactory.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbMDBDirProperty.cpp">mailnews/addrbook/src/nsAbMDBDirProperty.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbMDBDirProperty.cpp">file</a> |
<a href="/comm-central/annotate/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbMDBDirProperty.cpp">annotate</a> |
<a href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbMDBDirProperty.cpp">diff</a> |
<a href="/comm-central/comparison/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbMDBDirProperty.cpp">comparison</a> |
<a href="/comm-central/log/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbMDBDirProperty.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbMDBDirProperty.h">mailnews/addrbook/src/nsAbMDBDirProperty.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbMDBDirProperty.h">file</a> |
<a href="/comm-central/annotate/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbMDBDirProperty.h">annotate</a> |
<a href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbMDBDirProperty.h">diff</a> |
<a href="/comm-central/comparison/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbMDBDirProperty.h">comparison</a> |
<a href="/comm-central/log/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbMDBDirProperty.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbMDBDirectory.cpp">mailnews/addrbook/src/nsAbMDBDirectory.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbMDBDirectory.cpp">file</a> |
<a href="/comm-central/annotate/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbMDBDirectory.cpp">annotate</a> |
<a href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbMDBDirectory.cpp">diff</a> |
<a href="/comm-central/comparison/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbMDBDirectory.cpp">comparison</a> |
<a href="/comm-central/log/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbMDBDirectory.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbMDBDirectory.h">mailnews/addrbook/src/nsAbMDBDirectory.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbMDBDirectory.h">file</a> |
<a href="/comm-central/annotate/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbMDBDirectory.h">annotate</a> |
<a href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbMDBDirectory.h">diff</a> |
<a href="/comm-central/comparison/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbMDBDirectory.h">comparison</a> |
<a href="/comm-central/log/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbMDBDirectory.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbManager.h">mailnews/addrbook/src/nsAbManager.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbManager.h">file</a> |
<a href="/comm-central/annotate/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbManager.h">annotate</a> |
<a href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbManager.h">diff</a> |
<a href="/comm-central/comparison/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbManager.h">comparison</a> |
<a href="/comm-central/log/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbManager.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbOSXCard.h">mailnews/addrbook/src/nsAbOSXCard.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbOSXCard.h">file</a> |
<a href="/comm-central/annotate/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbOSXCard.h">annotate</a> |
<a href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbOSXCard.h">diff</a> |
<a href="/comm-central/comparison/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbOSXCard.h">comparison</a> |
<a href="/comm-central/log/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbOSXCard.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbOSXDirFactory.cpp">mailnews/addrbook/src/nsAbOSXDirFactory.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbOSXDirFactory.cpp">file</a> |
<a href="/comm-central/annotate/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbOSXDirFactory.cpp">annotate</a> |
<a href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbOSXDirFactory.cpp">diff</a> |
<a href="/comm-central/comparison/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbOSXDirFactory.cpp">comparison</a> |
<a href="/comm-central/log/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbOSXDirFactory.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbOSXDirectory.h">mailnews/addrbook/src/nsAbOSXDirectory.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbOSXDirectory.h">file</a> |
<a href="/comm-central/annotate/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbOSXDirectory.h">annotate</a> |
<a href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbOSXDirectory.h">diff</a> |
<a href="/comm-central/comparison/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbOSXDirectory.h">comparison</a> |
<a href="/comm-central/log/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbOSXDirectory.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbOutlookDirectory.cpp">mailnews/addrbook/src/nsAbOutlookDirectory.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbOutlookDirectory.cpp">file</a> |
<a href="/comm-central/annotate/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbOutlookDirectory.cpp">annotate</a> |
<a href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbOutlookDirectory.cpp">diff</a> |
<a href="/comm-central/comparison/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbOutlookDirectory.cpp">comparison</a> |
<a href="/comm-central/log/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbOutlookDirectory.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbQueryStringToExpression.cpp">mailnews/addrbook/src/nsAbQueryStringToExpression.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbQueryStringToExpression.cpp">file</a> |
<a href="/comm-central/annotate/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbQueryStringToExpression.cpp">annotate</a> |
<a href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbQueryStringToExpression.cpp">diff</a> |
<a href="/comm-central/comparison/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbQueryStringToExpression.cpp">comparison</a> |
<a href="/comm-central/log/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbQueryStringToExpression.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbView.cpp">mailnews/addrbook/src/nsAbView.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbView.cpp">file</a> |
<a href="/comm-central/annotate/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbView.cpp">annotate</a> |
<a href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbView.cpp">diff</a> |
<a href="/comm-central/comparison/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbView.cpp">comparison</a> |
<a href="/comm-central/log/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbView.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbView.h">mailnews/addrbook/src/nsAbView.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbView.h">file</a> |
<a href="/comm-central/annotate/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbView.h">annotate</a> |
<a href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbView.h">diff</a> |
<a href="/comm-central/comparison/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbView.h">comparison</a> |
<a href="/comm-central/log/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbView.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbWinHelper.cpp">mailnews/addrbook/src/nsAbWinHelper.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbWinHelper.cpp">file</a> |
<a href="/comm-central/annotate/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbWinHelper.cpp">annotate</a> |
<a href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbWinHelper.cpp">diff</a> |
<a href="/comm-central/comparison/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbWinHelper.cpp">comparison</a> |
<a href="/comm-central/log/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbWinHelper.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbWinHelper.h">mailnews/addrbook/src/nsAbWinHelper.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbWinHelper.h">file</a> |
<a href="/comm-central/annotate/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbWinHelper.h">annotate</a> |
<a href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbWinHelper.h">diff</a> |
<a href="/comm-central/comparison/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbWinHelper.h">comparison</a> |
<a href="/comm-central/log/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAbWinHelper.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAddbookProtocolHandler.cpp">mailnews/addrbook/src/nsAddbookProtocolHandler.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAddbookProtocolHandler.cpp">file</a> |
<a href="/comm-central/annotate/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAddbookProtocolHandler.cpp">annotate</a> |
<a href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAddbookProtocolHandler.cpp">diff</a> |
<a href="/comm-central/comparison/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAddbookProtocolHandler.cpp">comparison</a> |
<a href="/comm-central/log/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAddbookProtocolHandler.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAddbookProtocolHandler.h">mailnews/addrbook/src/nsAddbookProtocolHandler.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAddbookProtocolHandler.h">file</a> |
<a href="/comm-central/annotate/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAddbookProtocolHandler.h">annotate</a> |
<a href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAddbookProtocolHandler.h">diff</a> |
<a href="/comm-central/comparison/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAddbookProtocolHandler.h">comparison</a> |
<a href="/comm-central/log/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAddbookProtocolHandler.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAddrDatabase.cpp">mailnews/addrbook/src/nsAddrDatabase.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAddrDatabase.cpp">file</a> |
<a href="/comm-central/annotate/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAddrDatabase.cpp">annotate</a> |
<a href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAddrDatabase.cpp">diff</a> |
<a href="/comm-central/comparison/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAddrDatabase.cpp">comparison</a> |
<a href="/comm-central/log/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsAddrDatabase.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsDirPrefs.cpp">mailnews/addrbook/src/nsDirPrefs.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsDirPrefs.cpp">file</a> |
<a href="/comm-central/annotate/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsDirPrefs.cpp">annotate</a> |
<a href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsDirPrefs.cpp">diff</a> |
<a href="/comm-central/comparison/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsDirPrefs.cpp">comparison</a> |
<a href="/comm-central/log/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsDirPrefs.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsDirPrefs.h">mailnews/addrbook/src/nsDirPrefs.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsDirPrefs.h">file</a> |
<a href="/comm-central/annotate/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsDirPrefs.h">annotate</a> |
<a href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsDirPrefs.h">diff</a> |
<a href="/comm-central/comparison/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsDirPrefs.h">comparison</a> |
<a href="/comm-central/log/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsDirPrefs.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsMapiAddressBook.cpp">mailnews/addrbook/src/nsMapiAddressBook.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsMapiAddressBook.cpp">file</a> |
<a href="/comm-central/annotate/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsMapiAddressBook.cpp">annotate</a> |
<a href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsMapiAddressBook.cpp">diff</a> |
<a href="/comm-central/comparison/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsMapiAddressBook.cpp">comparison</a> |
<a href="/comm-central/log/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsMapiAddressBook.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsMapiAddressBook.h">mailnews/addrbook/src/nsMapiAddressBook.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsMapiAddressBook.h">file</a> |
<a href="/comm-central/annotate/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsMapiAddressBook.h">annotate</a> |
<a href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsMapiAddressBook.h">diff</a> |
<a href="/comm-central/comparison/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsMapiAddressBook.h">comparison</a> |
<a href="/comm-central/log/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsMapiAddressBook.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsMsgVCardService.cpp">mailnews/addrbook/src/nsMsgVCardService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsMsgVCardService.cpp">file</a> |
<a href="/comm-central/annotate/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsMsgVCardService.cpp">annotate</a> |
<a href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsMsgVCardService.cpp">diff</a> |
<a href="/comm-central/comparison/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsMsgVCardService.cpp">comparison</a> |
<a href="/comm-central/log/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsMsgVCardService.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsVCard.h">mailnews/addrbook/src/nsVCard.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsVCard.h">file</a> |
<a href="/comm-central/annotate/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsVCard.h">annotate</a> |
<a href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsVCard.h">diff</a> |
<a href="/comm-central/comparison/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsVCard.h">comparison</a> |
<a href="/comm-central/log/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsVCard.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsWabAddressBook.h">mailnews/addrbook/src/nsWabAddressBook.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsWabAddressBook.h">file</a> |
<a href="/comm-central/annotate/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsWabAddressBook.h">annotate</a> |
<a href="/comm-central/diff/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsWabAddressBook.h">diff</a> |
<a href="/comm-central/comparison/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsWabAddressBook.h">comparison</a> |
<a href="/comm-central/log/eabd24878a58284e97222b785b663923ac268964/mailnews/addrbook/src/nsWabAddressBook.h">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/addrbook/public/nsAbBaseCID.h</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/addrbook/public/nsAbBaseCID.h</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -244,17 +244,17 @@</span>
<a href="#l1.4"></a><span id="l1.4"> </span>
<a href="#l1.5"></a><span id="l1.5"> #define NS_BOOLEANEXPRESSION_CID                         \</span>
<a href="#l1.6"></a><span id="l1.6"> { /* {2c2e75c8-6f56-4a50-af1c-72af5d0e8d41} */        \</span>
<a href="#l1.7"></a><span id="l1.7">   0x2c2e75c8, 0x6f56, 0x4a50, \</span>
<a href="#l1.8"></a><span id="l1.8">     { 0xaf, 0x1c, 0x72, 0xaf, 0x5d, 0x0e, 0x8d, 0x41 } \</span>
<a href="#l1.9"></a><span id="l1.9"> }</span>
<a href="#l1.10"></a><span id="l1.10"> </span>
<a href="#l1.11"></a><span id="l1.11"> #define NS_ABDIRECTORYQUERYPROXY_CONTRACTID                     \</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-        &quot;@mozilla.org/addressbook/directory-query/proxy;1&quot;      </span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+        &quot;@mozilla.org/addressbook/directory-query/proxy;1&quot;</span>
<a href="#l1.14"></a><span id="l1.14"> </span>
<a href="#l1.15"></a><span id="l1.15"> #define NS_ABDIRECTORYQUERYPROXY_CID                            \</span>
<a href="#l1.16"></a><span id="l1.16"> { /* {E162E335-541B-43B4-AAEA-FE591E240CAF}*/                   \</span>
<a href="#l1.17"></a><span id="l1.17">         0xE162E335, 0x541B, 0x43B4,                             \</span>
<a href="#l1.18"></a><span id="l1.18">         {0xAA, 0xEA, 0xFE, 0x59, 0x1E, 0x24, 0x0C, 0xAF}        \</span>
<a href="#l1.19"></a><span id="l1.19"> }</span>
<a href="#l1.20"></a><span id="l1.20"> </span>
<a href="#l1.21"></a><span id="l1.21"> // nsAbLDAPDirectory</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbAddressCollector.cpp</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbAddressCollector.cpp</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -201,17 +201,17 @@ nsAbAddressCollector::AutoCollectScreenN</span>
<a href="#l2.4"></a><span id="l2.4">   int32_t atPos = aEmail.FindChar('@');</span>
<a href="#l2.5"></a><span id="l2.5">   if (atPos == -1)</span>
<a href="#l2.6"></a><span id="l2.6">     return;</span>
<a href="#l2.7"></a><span id="l2.7"> </span>
<a href="#l2.8"></a><span id="l2.8">   const nsACString&amp; domain = Substring(aEmail, atPos + 1);</span>
<a href="#l2.9"></a><span id="l2.9"> </span>
<a href="#l2.10"></a><span id="l2.10">   if (domain.IsEmpty())</span>
<a href="#l2.11"></a><span id="l2.11">     return;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-  // username in </span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+  // username in</span>
<a href="#l2.14"></a><span id="l2.14">   // username@aol.com (America Online)</span>
<a href="#l2.15"></a><span id="l2.15">   // username@cs.com (Compuserve)</span>
<a href="#l2.16"></a><span id="l2.16">   // username@netscape.net (Netscape webmail)</span>
<a href="#l2.17"></a><span id="l2.17">   // are all AIM screennames.  autocollect that info.</span>
<a href="#l2.18"></a><span id="l2.18">   if (domain.EqualsLiteral(&quot;aol.com&quot;) || domain.EqualsLiteral(&quot;cs.com&quot;) ||</span>
<a href="#l2.19"></a><span id="l2.19">       domain.EqualsLiteral(&quot;netscape.net&quot;))</span>
<a href="#l2.20"></a><span id="l2.20">     aCard-&gt;SetPropertyAsAUTF8String(kScreenNameProperty, Substring(aEmail, 0, atPos));</span>
<a href="#l2.21"></a><span id="l2.21">   else if (domain.EqualsLiteral(&quot;gmail.com&quot;) || domain.EqualsLiteral(&quot;googlemail.com&quot;))</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbBSDirectory.cpp</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbBSDirectory.cpp</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -38,59 +38,59 @@ NS_IMPL_ISUPPORTS_INHERITED0(nsAbBSDirec</span>
<a href="#l3.4"></a><span id="l3.4"> </span>
<a href="#l3.5"></a><span id="l3.5"> nsresult nsAbBSDirectory::CreateDirectoriesFromFactory(const nsACString &amp;aURI,</span>
<a href="#l3.6"></a><span id="l3.6">                                                        DIR_Server *aServer,</span>
<a href="#l3.7"></a><span id="l3.7">                                                        bool aNotify)</span>
<a href="#l3.8"></a><span id="l3.8"> {</span>
<a href="#l3.9"></a><span id="l3.9">   nsresult rv;</span>
<a href="#l3.10"></a><span id="l3.10"> </span>
<a href="#l3.11"></a><span id="l3.11">   // Get the directory factory service</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-  nsCOMPtr&lt;nsIAbDirFactoryService&gt; dirFactoryService = </span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+  nsCOMPtr&lt;nsIAbDirFactoryService&gt; dirFactoryService =</span>
<a href="#l3.14"></a><span id="l3.14">     do_GetService(NS_ABDIRFACTORYSERVICE_CONTRACTID,&amp;rv);</span>
<a href="#l3.15"></a><span id="l3.15">   NS_ENSURE_SUCCESS (rv, rv);</span>
<a href="#l3.16"></a><span id="l3.16"> 		</span>
<a href="#l3.17"></a><span id="l3.17">   // Get the directory factory from the URI</span>
<a href="#l3.18"></a><span id="l3.18">   nsCOMPtr&lt;nsIAbDirFactory&gt; dirFactory;</span>
<a href="#l3.19"></a><span id="l3.19">   rv = dirFactoryService-&gt;GetDirFactory(aURI, getter_AddRefs(dirFactory));</span>
<a href="#l3.20"></a><span id="l3.20">   NS_ENSURE_SUCCESS (rv, rv);</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineminus">-  </span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+</span>
<a href="#l3.23"></a><span id="l3.23">   // Create the directories</span>
<a href="#l3.24"></a><span id="l3.24">   nsCOMPtr&lt;nsISimpleEnumerator&gt; newDirEnumerator;</span>
<a href="#l3.25"></a><span id="l3.25">   rv = dirFactory-&gt;GetDirectories(NS_ConvertUTF8toUTF16(aServer-&gt;description),</span>
<a href="#l3.26"></a><span id="l3.26">                                   aURI,</span>
<a href="#l3.27"></a><span id="l3.27">                                   nsDependentCString(aServer-&gt;prefName),</span>
<a href="#l3.28"></a><span id="l3.28">                                   getter_AddRefs(newDirEnumerator));</span>
<a href="#l3.29"></a><span id="l3.29">   NS_ENSURE_SUCCESS (rv, rv);</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineminus">-  </span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+</span>
<a href="#l3.32"></a><span id="l3.32">   // Enumerate through the directories adding them</span>
<a href="#l3.33"></a><span id="l3.33">   // to the sub directories array</span>
<a href="#l3.34"></a><span id="l3.34">   bool hasMore;</span>
<a href="#l3.35"></a><span id="l3.35">   nsCOMPtr&lt;nsIAbManager&gt; abManager = do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l3.36"></a><span id="l3.36"> </span>
<a href="#l3.37"></a><span id="l3.37">   while (NS_SUCCEEDED(newDirEnumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore)</span>
<a href="#l3.38"></a><span id="l3.38">   {</span>
<a href="#l3.39"></a><span id="l3.39">     nsCOMPtr&lt;nsISupports&gt; newDirSupports;</span>
<a href="#l3.40"></a><span id="l3.40">     rv = newDirEnumerator-&gt;GetNext(getter_AddRefs(newDirSupports));</span>
<a href="#l3.41"></a><span id="l3.41">     if(NS_FAILED(rv))</span>
<a href="#l3.42"></a><span id="l3.42">       continue;</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineminus">-    </span>
<a href="#l3.44"></a><span id="l3.44" class="difflineminus">-    nsCOMPtr&lt;nsIAbDirectory&gt; childDir = do_QueryInterface(newDirSupports, &amp;rv); </span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineplus">+    nsCOMPtr&lt;nsIAbDirectory&gt; childDir = do_QueryInterface(newDirSupports, &amp;rv);</span>
<a href="#l3.47"></a><span id="l3.47">     if(NS_FAILED(rv))</span>
<a href="#l3.48"></a><span id="l3.48">       continue;</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineminus">-    </span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+</span>
<a href="#l3.51"></a><span id="l3.51">     // Define a relationship between the preference</span>
<a href="#l3.52"></a><span id="l3.52">     // entry and the directory</span>
<a href="#l3.53"></a><span id="l3.53">     mServers.Put(childDir, aServer);</span>
<a href="#l3.54"></a><span id="l3.54"> </span>
<a href="#l3.55"></a><span id="l3.55">     mSubDirectories.AppendObject(childDir);</span>
<a href="#l3.56"></a><span id="l3.56"> </span>
<a href="#l3.57"></a><span id="l3.57">     if (aNotify &amp;&amp; abManager)</span>
<a href="#l3.58"></a><span id="l3.58">       abManager-&gt;NotifyDirectoryItemAdded(this, childDir);</span>
<a href="#l3.59"></a><span id="l3.59">   }</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineminus">-  </span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+</span>
<a href="#l3.62"></a><span id="l3.62">   return NS_OK;</span>
<a href="#l3.63"></a><span id="l3.63"> }</span>
<a href="#l3.64"></a><span id="l3.64"> </span>
<a href="#l3.65"></a><span id="l3.65"> NS_IMETHODIMP nsAbBSDirectory::GetChildNodes(nsISimpleEnumerator* *aResult)</span>
<a href="#l3.66"></a><span id="l3.66"> {</span>
<a href="#l3.67"></a><span id="l3.67">   nsresult rv = EnsureInitialized();</span>
<a href="#l3.68"></a><span id="l3.68">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.69"></a><span id="l3.69"> </span>
<a href="#l3.70"></a><span id="l3.70" class="difflineat">@@ -98,70 +98,70 @@ NS_IMETHODIMP nsAbBSDirectory::GetChildN</span>
<a href="#l3.71"></a><span id="l3.71"> }</span>
<a href="#l3.72"></a><span id="l3.72"> </span>
<a href="#l3.73"></a><span id="l3.73"> nsresult nsAbBSDirectory::EnsureInitialized()</span>
<a href="#l3.74"></a><span id="l3.74"> {</span>
<a href="#l3.75"></a><span id="l3.75">   if (mInitialized)</span>
<a href="#l3.76"></a><span id="l3.76">     return NS_OK;</span>
<a href="#l3.77"></a><span id="l3.77"> </span>
<a href="#l3.78"></a><span id="l3.78">   nsresult rv;</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineminus">-  nsCOMPtr&lt;nsIAbDirFactoryService&gt; dirFactoryService = </span>
<a href="#l3.80"></a><span id="l3.80" class="difflineplus">+  nsCOMPtr&lt;nsIAbDirFactoryService&gt; dirFactoryService =</span>
<a href="#l3.81"></a><span id="l3.81">     do_GetService(NS_ABDIRFACTORYSERVICE_CONTRACTID,&amp;rv);</span>
<a href="#l3.82"></a><span id="l3.82">   NS_ENSURE_SUCCESS (rv, rv);</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineminus">-    </span>
<a href="#l3.84"></a><span id="l3.84" class="difflineplus">+</span>
<a href="#l3.85"></a><span id="l3.85">   nsTArray&lt;DIR_Server*&gt; *directories = DIR_GetDirectories();</span>
<a href="#l3.86"></a><span id="l3.86">   if (!directories)</span>
<a href="#l3.87"></a><span id="l3.87">     return NS_ERROR_FAILURE;</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineminus">-    </span>
<a href="#l3.89"></a><span id="l3.89" class="difflineplus">+</span>
<a href="#l3.90"></a><span id="l3.90">   int32_t count = directories-&gt;Length();</span>
<a href="#l3.91"></a><span id="l3.91">   for (int32_t i = 0; i &lt; count; i++)</span>
<a href="#l3.92"></a><span id="l3.92">   {</span>
<a href="#l3.93"></a><span id="l3.93">     DIR_Server *server = directories-&gt;ElementAt(i);</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineminus">-      </span>
<a href="#l3.95"></a><span id="l3.95" class="difflineplus">+</span>
<a href="#l3.96"></a><span id="l3.96">     // if this is a 4.x, local .na2 addressbook (PABDirectory)</span>
<a href="#l3.97"></a><span id="l3.97">     // we must skip it.</span>
<a href="#l3.98"></a><span id="l3.98">     // mozilla can't handle 4.x .na2 addressbooks</span>
<a href="#l3.99"></a><span id="l3.99">     // note, the filename might be na2 for 4.x LDAP directories</span>
<a href="#l3.100"></a><span id="l3.100">     // (we used the .na2 file for replication), and we don't want to skip</span>
<a href="#l3.101"></a><span id="l3.101">     // those.  see bug #127007</span>
<a href="#l3.102"></a><span id="l3.102">     uint32_t fileNameLen = strlen(server-&gt;fileName);</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineminus">-    if (((fileNameLen &gt; kABFileName_PreviousSuffixLen) &amp;&amp; </span>
<a href="#l3.104"></a><span id="l3.104" class="difflineplus">+    if (((fileNameLen &gt; kABFileName_PreviousSuffixLen) &amp;&amp;</span>
<a href="#l3.105"></a><span id="l3.105">       strcmp(server-&gt;fileName + fileNameLen - kABFileName_PreviousSuffixLen,</span>
<a href="#l3.106"></a><span id="l3.106">              kABFileName_PreviousSuffix) == 0) &amp;&amp;</span>
<a href="#l3.107"></a><span id="l3.107">       (server-&gt;dirType == PABDirectory))</span>
<a href="#l3.108"></a><span id="l3.108">       continue;</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineminus">-      </span>
<a href="#l3.110"></a><span id="l3.110" class="difflineplus">+</span>
<a href="#l3.111"></a><span id="l3.111">     // Set the uri property</span>
<a href="#l3.112"></a><span id="l3.112">     nsAutoCString URI (server-&gt;uri);</span>
<a href="#l3.113"></a><span id="l3.113">     // This is in case the uri is never set</span>
<a href="#l3.114"></a><span id="l3.114">     // in the nsDirPref.cpp code.</span>
<a href="#l3.115"></a><span id="l3.115" class="difflineminus">-    if (!server-&gt;uri) </span>
<a href="#l3.116"></a><span id="l3.116" class="difflineplus">+    if (!server-&gt;uri)</span>
<a href="#l3.117"></a><span id="l3.117">     {</span>
<a href="#l3.118"></a><span id="l3.118">       URI = NS_LITERAL_CSTRING(kMDBDirectoryRoot);</span>
<a href="#l3.119"></a><span id="l3.119">       URI += nsDependentCString(server-&gt;fileName);</span>
<a href="#l3.120"></a><span id="l3.120">     }</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineminus">-      </span>
<a href="#l3.122"></a><span id="l3.122" class="difflineplus">+</span>
<a href="#l3.123"></a><span id="l3.123">     /*</span>
<a href="#l3.124"></a><span id="l3.124">      * Check that we are not converting from a</span>
<a href="#l3.125"></a><span id="l3.125">      * a 4.x address book file e.g. pab.na2</span>
<a href="#l3.126"></a><span id="l3.126">      * check if the URI ends with &quot;.na2&quot;</span>
<a href="#l3.127"></a><span id="l3.127">      */</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineminus">-    if (StringEndsWith(URI, NS_LITERAL_CSTRING(kABFileName_PreviousSuffix))) </span>
<a href="#l3.129"></a><span id="l3.129" class="difflineplus">+    if (StringEndsWith(URI, NS_LITERAL_CSTRING(kABFileName_PreviousSuffix)))</span>
<a href="#l3.130"></a><span id="l3.130">       URI.Replace(kMDBDirectoryRootLen, URI.Length() - kMDBDirectoryRootLen, server-&gt;fileName);</span>
<a href="#l3.131"></a><span id="l3.131" class="difflineminus">-      </span>
<a href="#l3.132"></a><span id="l3.132" class="difflineplus">+</span>
<a href="#l3.133"></a><span id="l3.133">     // Create the directories</span>
<a href="#l3.134"></a><span id="l3.134">     rv = CreateDirectoriesFromFactory(URI, server, false /* notify */);</span>
<a href="#l3.135"></a><span id="l3.135"> </span>
<a href="#l3.136"></a><span id="l3.136">     // If we failed, this could be because something has set a pref for us</span>
<a href="#l3.137"></a><span id="l3.137">     // which is now broke (e.g. no factory present). So just ignore this one</span>
<a href="#l3.138"></a><span id="l3.138">     // and move on.</span>
<a href="#l3.139"></a><span id="l3.139">     if (NS_FAILED(rv))</span>
<a href="#l3.140"></a><span id="l3.140">       NS_WARNING(&quot;CreateDirectoriesFromFactory failed - Invalid factory?&quot;);</span>
<a href="#l3.141"></a><span id="l3.141">   }</span>
<a href="#l3.142"></a><span id="l3.142" class="difflineminus">-    </span>
<a href="#l3.143"></a><span id="l3.143" class="difflineplus">+</span>
<a href="#l3.144"></a><span id="l3.144">   mInitialized = true;</span>
<a href="#l3.145"></a><span id="l3.145">   // sort directories by position...</span>
<a href="#l3.146"></a><span id="l3.146">   return NS_OK;</span>
<a href="#l3.147"></a><span id="l3.147"> }</span>
<a href="#l3.148"></a><span id="l3.148"> </span>
<a href="#l3.149"></a><span id="l3.149"> NS_IMETHODIMP nsAbBSDirectory::CreateNewDirectory(const nsAString &amp;aDirName,</span>
<a href="#l3.150"></a><span id="l3.150">                                                   const nsACString &amp;aURI,</span>
<a href="#l3.151"></a><span id="l3.151">                                                   uint32_t aType,</span>
<a href="#l3.152"></a><span id="l3.152" class="difflineat">@@ -188,17 +188,17 @@ NS_IMETHODIMP nsAbBSDirectory::CreateNew</span>
<a href="#l3.153"></a><span id="l3.153">    * Somehow have to resolve this issue so that it</span>
<a href="#l3.154"></a><span id="l3.154">    * is more general.</span>
<a href="#l3.155"></a><span id="l3.155">    *</span>
<a href="#l3.156"></a><span id="l3.156">    */</span>
<a href="#l3.157"></a><span id="l3.157">   DIR_Server* server = nullptr;</span>
<a href="#l3.158"></a><span id="l3.158">   rv = DIR_AddNewAddressBook(aDirName, EmptyCString(), URI,</span>
<a href="#l3.159"></a><span id="l3.159">                              (DirectoryType)aType, aPrefName, &amp;server);</span>
<a href="#l3.160"></a><span id="l3.160">   NS_ENSURE_SUCCESS (rv, rv);</span>
<a href="#l3.161"></a><span id="l3.161" class="difflineminus">-  </span>
<a href="#l3.162"></a><span id="l3.162" class="difflineplus">+</span>
<a href="#l3.163"></a><span id="l3.163">   if (aType == PABDirectory) {</span>
<a href="#l3.164"></a><span id="l3.164">     // Add the URI property</span>
<a href="#l3.165"></a><span id="l3.165">     URI.AssignLiteral(kMDBDirectoryRoot);</span>
<a href="#l3.166"></a><span id="l3.166">     URI.Append(nsDependentCString(server-&gt;fileName));</span>
<a href="#l3.167"></a><span id="l3.167">   }</span>
<a href="#l3.168"></a><span id="l3.168"> </span>
<a href="#l3.169"></a><span id="l3.169">   aResult.Assign(server-&gt;prefName);</span>
<a href="#l3.170"></a><span id="l3.170"> </span>
<a href="#l3.171"></a><span id="l3.171" class="difflineat">@@ -252,17 +252,17 @@ NS_IMETHODIMP nsAbBSDirectory::DeleteDir</span>
<a href="#l3.172"></a><span id="l3.172">     if (iter.UserData() == getDirectories.mServer) {</span>
<a href="#l3.173"></a><span id="l3.173">       nsCOMPtr&lt;nsIAbDirectory&gt; abDir = do_QueryInterface(iter.Key());</span>
<a href="#l3.174"></a><span id="l3.174">       getDirectories.directories.AppendObject(abDir);</span>
<a href="#l3.175"></a><span id="l3.175">     }</span>
<a href="#l3.176"></a><span id="l3.176">   }</span>
<a href="#l3.177"></a><span id="l3.177"> </span>
<a href="#l3.178"></a><span id="l3.178">   DIR_DeleteServerFromList(server);</span>
<a href="#l3.179"></a><span id="l3.179"> </span>
<a href="#l3.180"></a><span id="l3.180" class="difflineminus">-  nsCOMPtr&lt;nsIAbDirFactoryService&gt; dirFactoryService = </span>
<a href="#l3.181"></a><span id="l3.181" class="difflineplus">+  nsCOMPtr&lt;nsIAbDirFactoryService&gt; dirFactoryService =</span>
<a href="#l3.182"></a><span id="l3.182">     do_GetService(NS_ABDIRFACTORYSERVICE_CONTRACTID,&amp;rv);</span>
<a href="#l3.183"></a><span id="l3.183">   NS_ENSURE_SUCCESS (rv, rv);</span>
<a href="#l3.184"></a><span id="l3.184"> </span>
<a href="#l3.185"></a><span id="l3.185">   uint32_t count = getDirectories.directories.Count();</span>
<a href="#l3.186"></a><span id="l3.186"> </span>
<a href="#l3.187"></a><span id="l3.187">   nsCOMPtr&lt;nsIAbManager&gt; abManager = do_GetService(NS_ABMANAGER_CONTRACTID);</span>
<a href="#l3.188"></a><span id="l3.188"> </span>
<a href="#l3.189"></a><span id="l3.189">   for (uint32_t i = 0; i &lt; count; i++) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbBoolExprToLDAPFilter.cpp</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbBoolExprToLDAPFilter.cpp</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -30,39 +30,39 @@ nsresult nsAbBoolExprToLDAPFilter::Filte</span>
<a href="#l4.4"></a><span id="l4.4">     nsIAbLDAPAttributeMap* map,</span>
<a href="#l4.5"></a><span id="l4.5">     nsIAbBooleanExpression* expression,</span>
<a href="#l4.6"></a><span id="l4.6">     nsCString&amp; filter,</span>
<a href="#l4.7"></a><span id="l4.7">     int flags)</span>
<a href="#l4.8"></a><span id="l4.8"> {</span>
<a href="#l4.9"></a><span id="l4.9">     nsCOMPtr&lt;nsIArray&gt; childExpressions;</span>
<a href="#l4.10"></a><span id="l4.10">     nsresult rv = expression-&gt;GetExpressions(getter_AddRefs(childExpressions));</span>
<a href="#l4.11"></a><span id="l4.11">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-    </span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+</span>
<a href="#l4.14"></a><span id="l4.14">     uint32_t count;</span>
<a href="#l4.15"></a><span id="l4.15">     rv = childExpressions-&gt;GetLength(&amp;count);</span>
<a href="#l4.16"></a><span id="l4.16">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.17"></a><span id="l4.17"> </span>
<a href="#l4.18"></a><span id="l4.18">     if (count == 0)</span>
<a href="#l4.19"></a><span id="l4.19">         return NS_OK;</span>
<a href="#l4.20"></a><span id="l4.20"> </span>
<a href="#l4.21"></a><span id="l4.21">     nsAbBooleanOperationType operation;</span>
<a href="#l4.22"></a><span id="l4.22">     rv = expression-&gt;GetOperation(&amp;operation);</span>
<a href="#l4.23"></a><span id="l4.23">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.24"></a><span id="l4.24"> </span>
<a href="#l4.25"></a><span id="l4.25">     /*</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineminus">-     * 3rd party query integration with Mozilla is achieved </span>
<a href="#l4.27"></a><span id="l4.27" class="difflineplus">+     * 3rd party query integration with Mozilla is achieved</span>
<a href="#l4.28"></a><span id="l4.28">      * by calling nsAbLDAPDirectoryQuery::DoQuery(). Thus</span>
<a href="#l4.29"></a><span id="l4.29">      * we can arrive here with a query asking for all the</span>
<a href="#l4.30"></a><span id="l4.30">      * ldap attributes using the card:nsIAbCard interface.</span>
<a href="#l4.31"></a><span id="l4.31">      *</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineminus">-     * So we need to check that we are not creating a condition </span>
<a href="#l4.33"></a><span id="l4.33" class="difflineminus">-     * filter against this expression otherwise we will end up with an invalid </span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+     * So we need to check that we are not creating a condition</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+     * filter against this expression otherwise we will end up with an invalid</span>
<a href="#l4.36"></a><span id="l4.36">      * filter equal to &quot;(|)&quot;.</span>
<a href="#l4.37"></a><span id="l4.37">     */</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineminus">-    </span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+</span>
<a href="#l4.40"></a><span id="l4.40">     if (count == 1 )</span>
<a href="#l4.41"></a><span id="l4.41">     {</span>
<a href="#l4.42"></a><span id="l4.42">         nsCOMPtr&lt;nsIAbBooleanConditionString&gt;</span>
<a href="#l4.43"></a><span id="l4.43">             childCondition(do_QueryElementAt(childExpressions, 1, &amp;rv));</span>
<a href="#l4.44"></a><span id="l4.44">         if (NS_SUCCEEDED(rv))</span>
<a href="#l4.45"></a><span id="l4.45">         {</span>
<a href="#l4.46"></a><span id="l4.46">             nsCString name;</span>
<a href="#l4.47"></a><span id="l4.47">             rv = childCondition-&gt;GetName (getter_Copies (name));</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineat">@@ -141,39 +141,39 @@ nsresult nsAbBoolExprToLDAPFilter::Filte</span>
<a href="#l4.49"></a><span id="l4.49">     nsCString name;</span>
<a href="#l4.50"></a><span id="l4.50">     nsresult rv = condition-&gt;GetName(getter_Copies (name));</span>
<a href="#l4.51"></a><span id="l4.51">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.52"></a><span id="l4.52"> </span>
<a href="#l4.53"></a><span id="l4.53">     nsAutoCString ldapAttr(name);</span>
<a href="#l4.54"></a><span id="l4.54">     if (flags &amp; TRANSLATE_CARD_PROPERTY)</span>
<a href="#l4.55"></a><span id="l4.55">     {</span>
<a href="#l4.56"></a><span id="l4.56">         rv = map-&gt;GetFirstAttribute (name, ldapAttr);</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineminus">-        if (!(flags &amp; ALLOW_NON_CONVERTABLE_CARD_PROPERTY) &amp;&amp; </span>
<a href="#l4.58"></a><span id="l4.58" class="difflineplus">+        if (!(flags &amp; ALLOW_NON_CONVERTABLE_CARD_PROPERTY) &amp;&amp;</span>
<a href="#l4.59"></a><span id="l4.59">             !ATTRMAP_FOUND_ATTR(rv, ldapAttr))</span>
<a href="#l4.60"></a><span id="l4.60">             return NS_OK;</span>
<a href="#l4.61"></a><span id="l4.61">     }</span>
<a href="#l4.62"></a><span id="l4.62"> </span>
<a href="#l4.63"></a><span id="l4.63">     nsAbBooleanConditionType conditionType;</span>
<a href="#l4.64"></a><span id="l4.64">     rv = condition-&gt;GetCondition(&amp;conditionType);</span>
<a href="#l4.65"></a><span id="l4.65">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.66"></a><span id="l4.66"> </span>
<a href="#l4.67"></a><span id="l4.67">     nsString value;</span>
<a href="#l4.68"></a><span id="l4.68">     rv = condition-&gt;GetValue (getter_Copies (value));</span>
<a href="#l4.69"></a><span id="l4.69">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.70"></a><span id="l4.70">     NS_ConvertUTF16toUTF8 vUTF8 (value);</span>
<a href="#l4.71"></a><span id="l4.71"> </span>
<a href="#l4.72"></a><span id="l4.72">     switch (conditionType)</span>
<a href="#l4.73"></a><span id="l4.73">     {</span>
<a href="#l4.74"></a><span id="l4.74">         case nsIAbBooleanConditionTypes::DoesNotExist:</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineminus">-            filter.AppendLiteral(&quot;(!(&quot;); </span>
<a href="#l4.76"></a><span id="l4.76" class="difflineplus">+            filter.AppendLiteral(&quot;(!(&quot;);</span>
<a href="#l4.77"></a><span id="l4.77">             filter.Append(ldapAttr);</span>
<a href="#l4.78"></a><span id="l4.78">             filter.AppendLiteral(&quot;=*))&quot;);</span>
<a href="#l4.79"></a><span id="l4.79">             break;</span>
<a href="#l4.80"></a><span id="l4.80">         case nsIAbBooleanConditionTypes::Exists:</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineminus">-            filter.Append('('); </span>
<a href="#l4.82"></a><span id="l4.82" class="difflineplus">+            filter.Append('(');</span>
<a href="#l4.83"></a><span id="l4.83">             filter.Append(ldapAttr);</span>
<a href="#l4.84"></a><span id="l4.84">             filter.AppendLiteral(&quot;=*)&quot;);</span>
<a href="#l4.85"></a><span id="l4.85">             break;</span>
<a href="#l4.86"></a><span id="l4.86">         case nsIAbBooleanConditionTypes::Contains:</span>
<a href="#l4.87"></a><span id="l4.87">             filter.Append('(');</span>
<a href="#l4.88"></a><span id="l4.88">             filter.Append(ldapAttr);</span>
<a href="#l4.89"></a><span id="l4.89">             filter.AppendLiteral(&quot;=*&quot;);</span>
<a href="#l4.90"></a><span id="l4.90">             filter.Append(vUTF8);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbCardProperty.cpp</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbCardProperty.cpp</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -1097,17 +1097,17 @@ NS_IMETHODIMP nsAbCardProperty::Generate</span>
<a href="#l5.4"></a><span id="l5.4">     aResult = lastName;</span>
<a href="#l5.5"></a><span id="l5.5">   else {</span>
<a href="#l5.6"></a><span id="l5.6">     nsresult rv;</span>
<a href="#l5.7"></a><span id="l5.7">     nsCOMPtr&lt;nsIStringBundle&gt; bundle(aBundle);</span>
<a href="#l5.8"></a><span id="l5.8">     if (!bundle) {</span>
<a href="#l5.9"></a><span id="l5.9">       nsCOMPtr&lt;nsIStringBundleService&gt; stringBundleService =</span>
<a href="#l5.10"></a><span id="l5.10">         mozilla::services::GetStringBundleService();</span>
<a href="#l5.11"></a><span id="l5.11">       NS_ENSURE_TRUE(stringBundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-        </span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+</span>
<a href="#l5.14"></a><span id="l5.14">       rv = stringBundleService-&gt;CreateBundle(sAddrbookProperties,</span>
<a href="#l5.15"></a><span id="l5.15">                                              getter_AddRefs(bundle));</span>
<a href="#l5.16"></a><span id="l5.16">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.17"></a><span id="l5.17">     }</span>
<a href="#l5.18"></a><span id="l5.18"> </span>
<a href="#l5.19"></a><span id="l5.19">     nsString result;</span>
<a href="#l5.20"></a><span id="l5.20"> </span>
<a href="#l5.21"></a><span id="l5.21">     if (aGenerateFormat == GENERATE_LAST_FIRST_ORDER) {</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineat">@@ -1117,17 +1117,17 @@ NS_IMETHODIMP nsAbCardProperty::Generate</span>
<a href="#l5.23"></a><span id="l5.23">                                         stringParams, 2, result);</span>
<a href="#l5.24"></a><span id="l5.24">     }</span>
<a href="#l5.25"></a><span id="l5.25">     else {</span>
<a href="#l5.26"></a><span id="l5.26">       const char16_t *stringParams[2] = {firstName.get(), lastName.get()};</span>
<a href="#l5.27"></a><span id="l5.27"> </span>
<a href="#l5.28"></a><span id="l5.28">       rv = bundle-&gt;FormatStringFromName(&quot;firstLastFormat&quot;,</span>
<a href="#l5.29"></a><span id="l5.29">                                         stringParams, 2, result);</span>
<a href="#l5.30"></a><span id="l5.30">     }</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv); </span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.33"></a><span id="l5.33"> </span>
<a href="#l5.34"></a><span id="l5.34">     aResult.Assign(result);</span>
<a href="#l5.35"></a><span id="l5.35">   }</span>
<a href="#l5.36"></a><span id="l5.36"> </span>
<a href="#l5.37"></a><span id="l5.37">   if (aResult.IsEmpty())</span>
<a href="#l5.38"></a><span id="l5.38">   {</span>
<a href="#l5.39"></a><span id="l5.39">     // The normal names have failed, does this card have a company name? If so,</span>
<a href="#l5.40"></a><span id="l5.40">     // use that instead, because that is likely to be more meaningful than an</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbCardProperty.h</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbCardProperty.h</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -1,40 +1,40 @@</span>
<a href="#l6.4"></a><span id="l6.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l6.5"></a><span id="l6.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l6.6"></a><span id="l6.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l6.7"></a><span id="l6.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l6.8"></a><span id="l6.8"> </span>
<a href="#l6.9"></a><span id="l6.9"> /********************************************************************************************************</span>
<a href="#l6.10"></a><span id="l6.10" class="difflineminus">- </span>
<a href="#l6.11"></a><span id="l6.11" class="difflineplus">+</span>
<a href="#l6.12"></a><span id="l6.12">    Interface for representing Address Book Person Card Property</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">- </span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+</span>
<a href="#l6.15"></a><span id="l6.15"> *********************************************************************************************************/</span>
<a href="#l6.16"></a><span id="l6.16"> </span>
<a href="#l6.17"></a><span id="l6.17"> #ifndef nsAbCardProperty_h__</span>
<a href="#l6.18"></a><span id="l6.18"> #define nsAbCardProperty_h__</span>
<a href="#l6.19"></a><span id="l6.19"> </span>
<a href="#l6.20"></a><span id="l6.20" class="difflineminus">-#include &quot;nsIAbCard.h&quot;  </span>
<a href="#l6.21"></a><span id="l6.21" class="difflineplus">+#include &quot;nsIAbCard.h&quot;</span>
<a href="#l6.22"></a><span id="l6.22"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l6.23"></a><span id="l6.23"> #include &quot;nsString.h&quot;</span>
<a href="#l6.24"></a><span id="l6.24"> </span>
<a href="#l6.25"></a><span id="l6.25"> #include &quot;nsInterfaceHashtable.h&quot;</span>
<a href="#l6.26"></a><span id="l6.26"> #include &quot;nsIVariant.h&quot;</span>
<a href="#l6.27"></a><span id="l6.27"> </span>
<a href="#l6.28"></a><span id="l6.28"> class nsIStringBundle;</span>
<a href="#l6.29"></a><span id="l6.29"> class mozITXTToHTMLConv;</span>
<a href="#l6.30"></a><span id="l6.30"> struct AppendItem;</span>
<a href="#l6.31"></a><span id="l6.31"> </span>
<a href="#l6.32"></a><span id="l6.32" class="difflineminus">- /* </span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+ /*</span>
<a href="#l6.34"></a><span id="l6.34">   * Address Book Card Property</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineminus">-  */ </span>
<a href="#l6.36"></a><span id="l6.36" class="difflineplus">+  */</span>
<a href="#l6.37"></a><span id="l6.37"> </span>
<a href="#l6.38"></a><span id="l6.38"> class nsAbCardProperty: public nsIAbCard</span>
<a href="#l6.39"></a><span id="l6.39"> {</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineminus">-public: </span>
<a href="#l6.41"></a><span id="l6.41" class="difflineplus">+public:</span>
<a href="#l6.42"></a><span id="l6.42">   NS_DECL_ISUPPORTS</span>
<a href="#l6.43"></a><span id="l6.43">   NS_DECL_NSIABCARD</span>
<a href="#l6.44"></a><span id="l6.44">   NS_DECL_NSIABITEM</span>
<a href="#l6.45"></a><span id="l6.45"> </span>
<a href="#l6.46"></a><span id="l6.46">   nsAbCardProperty();</span>
<a href="#l6.47"></a><span id="l6.47"> </span>
<a href="#l6.48"></a><span id="l6.48"> protected:</span>
<a href="#l6.49"></a><span id="l6.49">   virtual ~nsAbCardProperty();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbContentHandler.cpp</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbContentHandler.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -56,19 +56,19 @@ nsAbContentHandler::HandleContent(const </span>
<a href="#l7.4"></a><span id="l7.4">         nsAutoCString path;</span>
<a href="#l7.5"></a><span id="l7.5">         rv = uri-&gt;GetPathQueryRef(path);</span>
<a href="#l7.6"></a><span id="l7.6">         NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l7.7"></a><span id="l7.7"> </span>
<a href="#l7.8"></a><span id="l7.8">         const char *startOfVCard = strstr(path.get(), &quot;add?vcard=&quot;);</span>
<a href="#l7.9"></a><span id="l7.9">         if (startOfVCard)</span>
<a href="#l7.10"></a><span id="l7.10">         {</span>
<a href="#l7.11"></a><span id="l7.11">             nsCString unescapedData;</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-            </span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+</span>
<a href="#l7.14"></a><span id="l7.14">             // XXX todo, explain why we is escaped twice</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineminus">-            MsgUnescapeString(nsDependentCString(startOfVCard + strlen(&quot;add?vcard=&quot;)), </span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+            MsgUnescapeString(nsDependentCString(startOfVCard + strlen(&quot;add?vcard=&quot;)),</span>
<a href="#l7.17"></a><span id="l7.17">                                                  0, unescapedData);</span>
<a href="#l7.18"></a><span id="l7.18"> </span>
<a href="#l7.19"></a><span id="l7.19">             if (!aWindowContext)</span>
<a href="#l7.20"></a><span id="l7.20">                 return NS_ERROR_FAILURE;</span>
<a href="#l7.21"></a><span id="l7.21"> </span>
<a href="#l7.22"></a><span id="l7.22">             nsCOMPtr&lt;mozIDOMWindowProxy&gt; domWindow = do_GetInterface(aWindowContext);</span>
<a href="#l7.23"></a><span id="l7.23">             NS_ENSURE_TRUE(domWindow, NS_ERROR_FAILURE);</span>
<a href="#l7.24"></a><span id="l7.24">             nsCOMPtr&lt;nsPIDOMWindowOuter&gt; parentWindow = nsPIDOMWindowOuter::From(domWindow);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbContentHandler.h</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbContentHandler.h</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -1,16 +1,16 @@</span>
<a href="#l8.4"></a><span id="l8.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l8.5"></a><span id="l8.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l8.6"></a><span id="l8.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l8.7"></a><span id="l8.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l8.8"></a><span id="l8.8"> </span>
<a href="#l8.9"></a><span id="l8.9"> #ifndef __nsAbContentHandler_h</span>
<a href="#l8.10"></a><span id="l8.10"> #define __nsAbContentHandler_h</span>
<a href="#l8.11"></a><span id="l8.11" class="difflineminus">- </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+</span>
<a href="#l8.13"></a><span id="l8.13"> #include &quot;nsIStreamLoader.h&quot;</span>
<a href="#l8.14"></a><span id="l8.14"> #include &quot;nsIContentHandler.h&quot;</span>
<a href="#l8.15"></a><span id="l8.15"> </span>
<a href="#l8.16"></a><span id="l8.16"> class nsAbContentHandler : public nsIContentHandler,</span>
<a href="#l8.17"></a><span id="l8.17">                            public nsIStreamLoaderObserver</span>
<a href="#l8.18"></a><span id="l8.18"> {</span>
<a href="#l8.19"></a><span id="l8.19"> public:</span>
<a href="#l8.20"></a><span id="l8.20">   nsAbContentHandler();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbDirFactoryService.cpp</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbDirFactoryService.cpp</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -34,17 +34,17 @@ nsAbDirFactoryService::GetDirFactory(con</span>
<a href="#l9.4"></a><span id="l9.4">   NS_ENSURE_ARG_POINTER(aDirFactory);</span>
<a href="#l9.5"></a><span id="l9.5"> </span>
<a href="#l9.6"></a><span id="l9.6">   nsresult rv;</span>
<a href="#l9.7"></a><span id="l9.7"> </span>
<a href="#l9.8"></a><span id="l9.8">   // Obtain the network IO service</span>
<a href="#l9.9"></a><span id="l9.9">   nsCOMPtr&lt;nsIIOService&gt; nsService =</span>
<a href="#l9.10"></a><span id="l9.10">     mozilla::services::GetIOService();</span>
<a href="#l9.11"></a><span id="l9.11">   NS_ENSURE_TRUE(nsService, NS_ERROR_UNEXPECTED);</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-    </span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+</span>
<a href="#l9.14"></a><span id="l9.14">   // Extract the scheme</span>
<a href="#l9.15"></a><span id="l9.15">   nsAutoCString scheme;</span>
<a href="#l9.16"></a><span id="l9.16">   rv = nsService-&gt;ExtractScheme(aURI, scheme);</span>
<a href="#l9.17"></a><span id="l9.17">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.18"></a><span id="l9.18"> </span>
<a href="#l9.19"></a><span id="l9.19">   // Try to find a factory using the component manager.</span>
<a href="#l9.20"></a><span id="l9.20">   nsAutoCString contractID;</span>
<a href="#l9.21"></a><span id="l9.21">   contractID.AssignLiteral(NS_AB_DIRECTORY_FACTORY_CONTRACTID_PREFIX);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbDirProperty.cpp</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbDirProperty.cpp</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -207,17 +207,17 @@ NS_IMETHODIMP nsAbDirProperty::GetIsMail</span>
<a href="#l10.4"></a><span id="l10.4"> NS_IMETHODIMP nsAbDirProperty::SetIsMailList(bool aIsMailList)</span>
<a href="#l10.5"></a><span id="l10.5"> {</span>
<a href="#l10.6"></a><span id="l10.6"> 	m_IsMailList = aIsMailList;</span>
<a href="#l10.7"></a><span id="l10.7"> 	return NS_OK;</span>
<a href="#l10.8"></a><span id="l10.8"> }</span>
<a href="#l10.9"></a><span id="l10.9"> </span>
<a href="#l10.10"></a><span id="l10.10"> NS_IMETHODIMP nsAbDirProperty::GetAddressLists(nsIMutableArray * *aAddressLists)</span>
<a href="#l10.11"></a><span id="l10.11"> {</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-  if (!m_AddressList) </span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+  if (!m_AddressList)</span>
<a href="#l10.14"></a><span id="l10.14">   {</span>
<a href="#l10.15"></a><span id="l10.15">     nsresult rv;</span>
<a href="#l10.16"></a><span id="l10.16">     m_AddressList = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l10.17"></a><span id="l10.17">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.18"></a><span id="l10.18">   }</span>
<a href="#l10.19"></a><span id="l10.19"> </span>
<a href="#l10.20"></a><span id="l10.20">   NS_ADDREF(*aAddressLists = m_AddressList);</span>
<a href="#l10.21"></a><span id="l10.21">   return NS_OK;</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineat">@@ -447,17 +447,17 @@ NS_IMETHODIMP nsAbDirProperty::SetDirPre</span>
<a href="#l10.23"></a><span id="l10.23">   }</span>
<a href="#l10.24"></a><span id="l10.24">   return NS_OK;</span>
<a href="#l10.25"></a><span id="l10.25"> }</span>
<a href="#l10.26"></a><span id="l10.26"> </span>
<a href="#l10.27"></a><span id="l10.27"> nsresult nsAbDirProperty::InitDirectoryPrefs()</span>
<a href="#l10.28"></a><span id="l10.28"> {</span>
<a href="#l10.29"></a><span id="l10.29">   if (m_DirPrefId.IsEmpty())</span>
<a href="#l10.30"></a><span id="l10.30">     return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineminus">-    </span>
<a href="#l10.32"></a><span id="l10.32" class="difflineplus">+</span>
<a href="#l10.33"></a><span id="l10.33">   nsresult rv;</span>
<a href="#l10.34"></a><span id="l10.34">   nsCOMPtr&lt;nsIPrefService&gt; prefService(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l10.35"></a><span id="l10.35">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.36"></a><span id="l10.36"> </span>
<a href="#l10.37"></a><span id="l10.37">   nsCString realPrefId(m_DirPrefId);</span>
<a href="#l10.38"></a><span id="l10.38">   realPrefId.Append('.');</span>
<a href="#l10.39"></a><span id="l10.39"> </span>
<a href="#l10.40"></a><span id="l10.40">   return prefService-&gt;GetBranch(realPrefId.get(), getter_AddRefs(m_DirectoryPrefs));</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineat">@@ -489,17 +489,17 @@ NS_IMETHODIMP nsAbDirProperty::GetBoolVa</span>
<a href="#l10.42"></a><span id="l10.42"> </span>
<a href="#l10.43"></a><span id="l10.43">   if (NS_FAILED(m_DirectoryPrefs-&gt;GetBoolPref(aName, aResult)))</span>
<a href="#l10.44"></a><span id="l10.44">     *aResult = aDefaultValue;</span>
<a href="#l10.45"></a><span id="l10.45"> </span>
<a href="#l10.46"></a><span id="l10.46">   return NS_OK;</span>
<a href="#l10.47"></a><span id="l10.47"> }</span>
<a href="#l10.48"></a><span id="l10.48"> </span>
<a href="#l10.49"></a><span id="l10.49"> NS_IMETHODIMP nsAbDirProperty::GetStringValue(const char *aName,</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineminus">-                                              const nsACString &amp;aDefaultValue, </span>
<a href="#l10.51"></a><span id="l10.51" class="difflineplus">+                                              const nsACString &amp;aDefaultValue,</span>
<a href="#l10.52"></a><span id="l10.52">                                               nsACString &amp;aResult)</span>
<a href="#l10.53"></a><span id="l10.53"> {</span>
<a href="#l10.54"></a><span id="l10.54">   if (!m_DirectoryPrefs &amp;&amp; NS_FAILED(InitDirectoryPrefs()))</span>
<a href="#l10.55"></a><span id="l10.55">     return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l10.56"></a><span id="l10.56"> </span>
<a href="#l10.57"></a><span id="l10.57">   nsCString value;</span>
<a href="#l10.58"></a><span id="l10.58"> </span>
<a href="#l10.59"></a><span id="l10.59">     /* unfortunately, there may be some prefs out there which look like (null) */</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineat">@@ -514,17 +514,17 @@ NS_IMETHODIMP nsAbDirProperty::GetString</span>
<a href="#l10.61"></a><span id="l10.61"> /*</span>
<a href="#l10.62"></a><span id="l10.62">  * Get localized unicode string pref from properties file, convert into an</span>
<a href="#l10.63"></a><span id="l10.63">  * UTF8 string since address book prefs store as UTF8 strings. So far there</span>
<a href="#l10.64"></a><span id="l10.64">  * are 2 default prefs stored in addressbook.properties.</span>
<a href="#l10.65"></a><span id="l10.65">  * &quot;ldap_2.servers.pab.description&quot;</span>
<a href="#l10.66"></a><span id="l10.66">  * &quot;ldap_2.servers.history.description&quot;</span>
<a href="#l10.67"></a><span id="l10.67">  */</span>
<a href="#l10.68"></a><span id="l10.68"> NS_IMETHODIMP nsAbDirProperty::GetLocalizedStringValue(const char *aName,</span>
<a href="#l10.69"></a><span id="l10.69" class="difflineminus">-                                                       const nsACString &amp;aDefaultValue, </span>
<a href="#l10.70"></a><span id="l10.70" class="difflineplus">+                                                       const nsACString &amp;aDefaultValue,</span>
<a href="#l10.71"></a><span id="l10.71">                                                        nsACString &amp;aResult)</span>
<a href="#l10.72"></a><span id="l10.72"> {</span>
<a href="#l10.73"></a><span id="l10.73">   if (!m_DirectoryPrefs &amp;&amp; NS_FAILED(InitDirectoryPrefs()))</span>
<a href="#l10.74"></a><span id="l10.74">     return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l10.75"></a><span id="l10.75"> </span>
<a href="#l10.76"></a><span id="l10.76">   nsString wvalue;</span>
<a href="#l10.77"></a><span id="l10.77">   nsCOMPtr&lt;nsIPrefLocalizedString&gt; locStr;</span>
<a href="#l10.78"></a><span id="l10.78"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbDirProperty.h</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbDirProperty.h</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -1,40 +1,40 @@</span>
<a href="#l11.4"></a><span id="l11.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l11.5"></a><span id="l11.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l11.6"></a><span id="l11.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l11.7"></a><span id="l11.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l11.8"></a><span id="l11.8"> </span>
<a href="#l11.9"></a><span id="l11.9"> /********************************************************************************************************</span>
<a href="#l11.10"></a><span id="l11.10" class="difflineminus">- </span>
<a href="#l11.11"></a><span id="l11.11" class="difflineplus">+</span>
<a href="#l11.12"></a><span id="l11.12">    Interface for representing Address Book Directory</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">- </span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+</span>
<a href="#l11.15"></a><span id="l11.15"> *********************************************************************************************************/</span>
<a href="#l11.16"></a><span id="l11.16"> </span>
<a href="#l11.17"></a><span id="l11.17"> #ifndef nsAbDirProperty_h__</span>
<a href="#l11.18"></a><span id="l11.18"> #define nsAbDirProperty_h__</span>
<a href="#l11.19"></a><span id="l11.19"> </span>
<a href="#l11.20"></a><span id="l11.20"> #include &quot;nsIAbDirectory.h&quot; /* include the interface we are going to support */</span>
<a href="#l11.21"></a><span id="l11.21"> #include &quot;nsIAbCard.h&quot;</span>
<a href="#l11.22"></a><span id="l11.22"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l11.23"></a><span id="l11.23"> #include &quot;nsDirPrefs.h&quot;</span>
<a href="#l11.24"></a><span id="l11.24"> #include &quot;nsIAddrDatabase.h&quot;</span>
<a href="#l11.25"></a><span id="l11.25"> #include &quot;nsString.h&quot;</span>
<a href="#l11.26"></a><span id="l11.26"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l11.27"></a><span id="l11.27"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l11.28"></a><span id="l11.28"> #include &quot;nsWeakReference.h&quot;</span>
<a href="#l11.29"></a><span id="l11.29"> </span>
<a href="#l11.30"></a><span id="l11.30" class="difflineminus">- /* </span>
<a href="#l11.31"></a><span id="l11.31" class="difflineplus">+ /*</span>
<a href="#l11.32"></a><span id="l11.32">   * Address Book Directory</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineminus">-  */ </span>
<a href="#l11.34"></a><span id="l11.34" class="difflineplus">+  */</span>
<a href="#l11.35"></a><span id="l11.35"> </span>
<a href="#l11.36"></a><span id="l11.36"> class nsAbDirProperty: public nsIAbDirectory,</span>
<a href="#l11.37"></a><span id="l11.37">                        public nsSupportsWeakReference</span>
<a href="#l11.38"></a><span id="l11.38"> {</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineminus">-public: </span>
<a href="#l11.40"></a><span id="l11.40" class="difflineplus">+public:</span>
<a href="#l11.41"></a><span id="l11.41"> 	nsAbDirProperty(void);</span>
<a href="#l11.42"></a><span id="l11.42"> </span>
<a href="#l11.43"></a><span id="l11.43">   NS_DECL_ISUPPORTS</span>
<a href="#l11.44"></a><span id="l11.44">   NS_DECL_NSIABITEM</span>
<a href="#l11.45"></a><span id="l11.45">   NS_DECL_NSIABCOLLECTION</span>
<a href="#l11.46"></a><span id="l11.46">   NS_DECL_NSIABDIRECTORY</span>
<a href="#l11.47"></a><span id="l11.47"> </span>
<a href="#l11.48"></a><span id="l11.48"> protected:</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbDirectoryQuery.cpp</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbDirectoryQuery.cpp</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -188,17 +188,17 @@ NS_IMETHODIMP nsAbDirectoryQueryProperty</span>
<a href="#l12.4"></a><span id="l12.4"> </span>
<a href="#l12.5"></a><span id="l12.5">     return NS_OK;</span>
<a href="#l12.6"></a><span id="l12.6"> }</span>
<a href="#l12.7"></a><span id="l12.7"> </span>
<a href="#l12.8"></a><span id="l12.8"> /* read only attribute wstring value; */</span>
<a href="#l12.9"></a><span id="l12.9"> NS_IMETHODIMP nsAbDirectoryQueryPropertyValue::GetValue(char16_t*  *aValue)</span>
<a href="#l12.10"></a><span id="l12.10"> {</span>
<a href="#l12.11"></a><span id="l12.11">     *aValue = ToNewUnicode(mValue);</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-    if (!(*aValue)) </span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+    if (!(*aValue))</span>
<a href="#l12.14"></a><span id="l12.14">         return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l12.15"></a><span id="l12.15">     else</span>
<a href="#l12.16"></a><span id="l12.16">         return NS_OK;</span>
<a href="#l12.17"></a><span id="l12.17"> }</span>
<a href="#l12.18"></a><span id="l12.18"> </span>
<a href="#l12.19"></a><span id="l12.19"> /* readonly attribute nsISupports valueISupports; */</span>
<a href="#l12.20"></a><span id="l12.20"> NS_IMETHODIMP nsAbDirectoryQueryPropertyValue::GetValueISupports(nsISupports*  *aValueISupports)</span>
<a href="#l12.21"></a><span id="l12.21"> {</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineat">@@ -292,17 +292,17 @@ nsresult nsAbDirectoryQuery::queryChildr</span>
<a href="#l12.23"></a><span id="l12.23">     while (NS_SUCCEEDED(rv = subDirectories-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore)</span>
<a href="#l12.24"></a><span id="l12.24">     {</span>
<a href="#l12.25"></a><span id="l12.25">         nsCOMPtr&lt;nsISupports&gt; item;</span>
<a href="#l12.26"></a><span id="l12.26">         rv = subDirectories-&gt;GetNext (getter_AddRefs (item));</span>
<a href="#l12.27"></a><span id="l12.27">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.28"></a><span id="l12.28"> </span>
<a href="#l12.29"></a><span id="l12.29">         nsCOMPtr&lt;nsIAbDirectory&gt; subDirectory(do_QueryInterface(item, &amp;rv));</span>
<a href="#l12.30"></a><span id="l12.30">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineminus">-        </span>
<a href="#l12.32"></a><span id="l12.32" class="difflineplus">+</span>
<a href="#l12.33"></a><span id="l12.33">         rv = query(subDirectory, expression, listener, doSubDirectories, resultLimit);</span>
<a href="#l12.34"></a><span id="l12.34">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.35"></a><span id="l12.35"> </span>
<a href="#l12.36"></a><span id="l12.36">     }</span>
<a href="#l12.37"></a><span id="l12.37">     return NS_OK;</span>
<a href="#l12.38"></a><span id="l12.38"> }</span>
<a href="#l12.39"></a><span id="l12.39"> </span>
<a href="#l12.40"></a><span id="l12.40"> nsresult nsAbDirectoryQuery::queryCards(nsIAbDirectory* directory,</span>
<a href="#l12.41"></a><span id="l12.41" class="difflineat">@@ -329,17 +329,17 @@ nsresult nsAbDirectoryQuery::queryCards(</span>
<a href="#l12.42"></a><span id="l12.42">     while (NS_SUCCEEDED(cards-&gt;HasMoreElements(&amp;more)) &amp;&amp; more)</span>
<a href="#l12.43"></a><span id="l12.43">     {</span>
<a href="#l12.44"></a><span id="l12.44">         nsCOMPtr&lt;nsISupports&gt; item;</span>
<a href="#l12.45"></a><span id="l12.45">         rv = cards-&gt;GetNext(getter_AddRefs(item));</span>
<a href="#l12.46"></a><span id="l12.46">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.47"></a><span id="l12.47"> </span>
<a href="#l12.48"></a><span id="l12.48">         nsCOMPtr&lt;nsIAbCard&gt; card(do_QueryInterface(item, &amp;rv));</span>
<a href="#l12.49"></a><span id="l12.49">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.50"></a><span id="l12.50" class="difflineminus">-        </span>
<a href="#l12.51"></a><span id="l12.51" class="difflineplus">+</span>
<a href="#l12.52"></a><span id="l12.52">         rv = matchCard (card, expression, listener, resultLimit);</span>
<a href="#l12.53"></a><span id="l12.53">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.54"></a><span id="l12.54"> </span>
<a href="#l12.55"></a><span id="l12.55">         if (*resultLimit == 0)</span>
<a href="#l12.56"></a><span id="l12.56">             return NS_OK;</span>
<a href="#l12.57"></a><span id="l12.57">     }</span>
<a href="#l12.58"></a><span id="l12.58"> </span>
<a href="#l12.59"></a><span id="l12.59">     return NS_OK;</span>
<a href="#l12.60"></a><span id="l12.60" class="difflineat">@@ -370,17 +370,17 @@ nsresult nsAbDirectoryQuery::matchCardEx</span>
<a href="#l12.61"></a><span id="l12.61"> {</span>
<a href="#l12.62"></a><span id="l12.62">     nsAbBooleanOperationType operation;</span>
<a href="#l12.63"></a><span id="l12.63">     nsresult rv = expression-&gt;GetOperation (&amp;operation);</span>
<a href="#l12.64"></a><span id="l12.64">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.65"></a><span id="l12.65"> </span>
<a href="#l12.66"></a><span id="l12.66">     nsCOMPtr&lt;nsIArray&gt; childExpressions;</span>
<a href="#l12.67"></a><span id="l12.67">     rv = expression-&gt;GetExpressions (getter_AddRefs (childExpressions));</span>
<a href="#l12.68"></a><span id="l12.68">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.69"></a><span id="l12.69" class="difflineminus">-    </span>
<a href="#l12.70"></a><span id="l12.70" class="difflineplus">+</span>
<a href="#l12.71"></a><span id="l12.71">     uint32_t count;</span>
<a href="#l12.72"></a><span id="l12.72">     rv = childExpressions-&gt;GetLength(&amp;count);</span>
<a href="#l12.73"></a><span id="l12.73">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.74"></a><span id="l12.74"> </span>
<a href="#l12.75"></a><span id="l12.75">     if (operation == nsIAbBooleanOperationTypes::NOT &amp;&amp;</span>
<a href="#l12.76"></a><span id="l12.76">         count &gt; 1)</span>
<a href="#l12.77"></a><span id="l12.77">         return NS_ERROR_FAILURE;</span>
<a href="#l12.78"></a><span id="l12.78"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPCard.cpp</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPCard.cpp</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -41,72 +41,72 @@ NS_IMPL_ISUPPORTS_INHERITED(nsAbLDAPCard</span>
<a href="#l13.4"></a><span id="l13.4">  * classes to add, or  what attributes to clear.</span>
<a href="#l13.5"></a><span id="l13.5">  *</span>
<a href="#l13.6"></a><span id="l13.6">  * XXX: We need to take care when integrating this code with the asynchronous</span>
<a href="#l13.7"></a><span id="l13.7">  * update dialogs, as the current code in nsAbLDAPDirectory has a problem</span>
<a href="#l13.8"></a><span id="l13.8">  * when an update fails: the modified card still gets stored and shown to</span>
<a href="#l13.9"></a><span id="l13.9">  * the user instead of being discarded. There is one especially tricky case:</span>
<a href="#l13.10"></a><span id="l13.10">  * when you do an update on a card which changes its DN, you have two</span>
<a href="#l13.11"></a><span id="l13.11">  * operations (rename, then update the other attributes). If the rename</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">- * operation succeeds and not the update of the attributes, you are </span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+ * operation succeeds and not the update of the attributes, you are</span>
<a href="#l13.14"></a><span id="l13.14">  * &quot;somewhere in between&quot; the original card and the updated card.</span>
<a href="#l13.15"></a><span id="l13.15"> */</span>
<a href="#l13.16"></a><span id="l13.16"> NS_IMETHODIMP nsAbLDAPCard::GetLDAPMessageInfo(</span>
<a href="#l13.17"></a><span id="l13.17">   nsIAbLDAPAttributeMap *aAttributeMap,</span>
<a href="#l13.18"></a><span id="l13.18">   const uint32_t aClassCount,</span>
<a href="#l13.19"></a><span id="l13.19">   const char **aClasses,</span>
<a href="#l13.20"></a><span id="l13.20">   int32_t aType,</span>
<a href="#l13.21"></a><span id="l13.21">   nsIArray **aLDAPAddMessageInfo)</span>
<a href="#l13.22"></a><span id="l13.22"> {</span>
<a href="#l13.23"></a><span id="l13.23">   NS_ENSURE_ARG_POINTER(aAttributeMap);</span>
<a href="#l13.24"></a><span id="l13.24">   NS_ENSURE_ARG_POINTER(aClasses);</span>
<a href="#l13.25"></a><span id="l13.25">   NS_ENSURE_ARG_POINTER(aLDAPAddMessageInfo);</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineminus">-  </span>
<a href="#l13.27"></a><span id="l13.27" class="difflineplus">+</span>
<a href="#l13.28"></a><span id="l13.28">   nsresult rv;</span>
<a href="#l13.29"></a><span id="l13.29">   nsCOMPtr&lt;nsIMutableArray&gt; modArray =</span>
<a href="#l13.30"></a><span id="l13.30">     do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l13.31"></a><span id="l13.31">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineminus">-  </span>
<a href="#l13.33"></a><span id="l13.33" class="difflineplus">+</span>
<a href="#l13.34"></a><span id="l13.34">   // Add any missing object classes. We never remove any object</span>
<a href="#l13.35"></a><span id="l13.35">   // classes: if an entry has additional object classes, it's probably</span>
<a href="#l13.36"></a><span id="l13.36">   // for a good reason.</span>
<a href="#l13.37"></a><span id="l13.37">   nsAutoCString oclass;</span>
<a href="#l13.38"></a><span id="l13.38">   for (uint32_t i = 0; i &lt; aClassCount; ++i)</span>
<a href="#l13.39"></a><span id="l13.39">   {</span>
<a href="#l13.40"></a><span id="l13.40">     oclass.Assign(nsDependentCString(aClasses[i]));</span>
<a href="#l13.41"></a><span id="l13.41">     ToLowerCase(oclass);</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineminus">-   </span>
<a href="#l13.43"></a><span id="l13.43" class="difflineplus">+</span>
<a href="#l13.44"></a><span id="l13.44">     if (!m_objectClass.Contains(oclass))</span>
<a href="#l13.45"></a><span id="l13.45">     {</span>
<a href="#l13.46"></a><span id="l13.46">       m_objectClass.AppendElement(oclass);</span>
<a href="#l13.47"></a><span id="l13.47">       printf(&quot;LDAP : adding objectClass %s\n&quot;, oclass.get());</span>
<a href="#l13.48"></a><span id="l13.48">     }</span>
<a href="#l13.49"></a><span id="l13.49">   }</span>
<a href="#l13.50"></a><span id="l13.50"> </span>
<a href="#l13.51"></a><span id="l13.51">   nsCOMPtr&lt;nsILDAPModification&gt; mod =</span>
<a href="#l13.52"></a><span id="l13.52">     do_CreateInstance(&quot;@mozilla.org/network/ldap-modification;1&quot;, &amp;rv);</span>
<a href="#l13.53"></a><span id="l13.53">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineminus">- </span>
<a href="#l13.55"></a><span id="l13.55" class="difflineplus">+</span>
<a href="#l13.56"></a><span id="l13.56">   nsCOMPtr&lt;nsIMutableArray&gt; values =</span>
<a href="#l13.57"></a><span id="l13.57">     do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l13.58"></a><span id="l13.58">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineminus">-  </span>
<a href="#l13.60"></a><span id="l13.60" class="difflineplus">+</span>
<a href="#l13.61"></a><span id="l13.61">   for (uint32_t i = 0; i &lt; m_objectClass.Length(); ++i)</span>
<a href="#l13.62"></a><span id="l13.62">   {</span>
<a href="#l13.63"></a><span id="l13.63">     nsCOMPtr&lt;nsILDAPBERValue&gt; value =</span>
<a href="#l13.64"></a><span id="l13.64">       do_CreateInstance(&quot;@mozilla.org/network/ldap-ber-value;1&quot;, &amp;rv);</span>
<a href="#l13.65"></a><span id="l13.65">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.66"></a><span id="l13.66"> </span>
<a href="#l13.67"></a><span id="l13.67">     rv = value-&gt;SetFromUTF8(m_objectClass.ElementAt(i));</span>
<a href="#l13.68"></a><span id="l13.68">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.69"></a><span id="l13.69"> </span>
<a href="#l13.70"></a><span id="l13.70">     rv = values-&gt;AppendElement(value, false);</span>
<a href="#l13.71"></a><span id="l13.71">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.72"></a><span id="l13.72">   }</span>
<a href="#l13.73"></a><span id="l13.73" class="difflineminus">-  </span>
<a href="#l13.74"></a><span id="l13.74" class="difflineplus">+</span>
<a href="#l13.75"></a><span id="l13.75">   rv = mod-&gt;SetUpModification(aType, NS_LITERAL_CSTRING(&quot;objectClass&quot;), values);</span>
<a href="#l13.76"></a><span id="l13.76">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.77"></a><span id="l13.77"> </span>
<a href="#l13.78"></a><span id="l13.78">   modArray-&gt;AppendElement(mod, false);</span>
<a href="#l13.79"></a><span id="l13.79"> </span>
<a href="#l13.80"></a><span id="l13.80">   // Add card properties</span>
<a href="#l13.81"></a><span id="l13.81">   CharPtrArrayGuard props;</span>
<a href="#l13.82"></a><span id="l13.82">   rv = aAttributeMap-&gt;GetAllCardProperties(props.GetSizeAddr(),</span>
<a href="#l13.83"></a><span id="l13.83" class="difflineat">@@ -126,47 +126,47 @@ NS_IMETHODIMP nsAbLDAPCard::GetLDAPMessa</span>
<a href="#l13.84"></a><span id="l13.84">     // which cannot be modified</span>
<a href="#l13.85"></a><span id="l13.85">     //</span>
<a href="#l13.86"></a><span id="l13.86">     // PreferMailFormat : by default this is mapped to 'mozillaUseHtmlMail',</span>
<a href="#l13.87"></a><span id="l13.87">     // which is a boolean, not plaintext/html/unknown</span>
<a href="#l13.88"></a><span id="l13.88">     if (!strcmp(props[i], kBirthYearProperty) ||</span>
<a href="#l13.89"></a><span id="l13.89">         !strcmp(props[i], kLastModifiedDateProperty) ||</span>
<a href="#l13.90"></a><span id="l13.90">         !strcmp(props[i], kPreferMailFormatProperty))</span>
<a href="#l13.91"></a><span id="l13.91">       continue;</span>
<a href="#l13.92"></a><span id="l13.92" class="difflineminus">-    </span>
<a href="#l13.93"></a><span id="l13.93" class="difflineplus">+</span>
<a href="#l13.94"></a><span id="l13.94">     rv = aAttributeMap-&gt;GetFirstAttribute(nsDependentCString(props[i]),</span>
<a href="#l13.95"></a><span id="l13.95">       attr);</span>
<a href="#l13.96"></a><span id="l13.96">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.97"></a><span id="l13.97">     ToLowerCase(attr);</span>
<a href="#l13.98"></a><span id="l13.98"> </span>
<a href="#l13.99"></a><span id="l13.99">     // If the property is not mapped to an attribute, skip it.</span>
<a href="#l13.100"></a><span id="l13.100">     if (attr.IsEmpty())</span>
<a href="#l13.101"></a><span id="l13.101">       continue;</span>
<a href="#l13.102"></a><span id="l13.102" class="difflineminus">- </span>
<a href="#l13.103"></a><span id="l13.103" class="difflineplus">+</span>
<a href="#l13.104"></a><span id="l13.104">     nsCOMPtr&lt;nsILDAPModification&gt; mod =</span>
<a href="#l13.105"></a><span id="l13.105">       do_CreateInstance(&quot;@mozilla.org/network/ldap-modification;1&quot;, &amp;rv);</span>
<a href="#l13.106"></a><span id="l13.106">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.107"></a><span id="l13.107" class="difflineminus">-   </span>
<a href="#l13.108"></a><span id="l13.108" class="difflineplus">+</span>
<a href="#l13.109"></a><span id="l13.109">     size_t index = m_attributes.IndexOf(attr);</span>
<a href="#l13.110"></a><span id="l13.110"> </span>
<a href="#l13.111"></a><span id="l13.111">     rv = GetPropertyAsAUTF8String(props[i], propvalue);</span>
<a href="#l13.112"></a><span id="l13.112"> </span>
<a href="#l13.113"></a><span id="l13.113">     if (NS_SUCCEEDED(rv) &amp;&amp;!propvalue.IsEmpty())</span>
<a href="#l13.114"></a><span id="l13.114">     {</span>
<a href="#l13.115"></a><span id="l13.115">       // If the new value is not empty, add/update it</span>
<a href="#l13.116"></a><span id="l13.116">       nsCOMPtr&lt;nsILDAPBERValue&gt; value =</span>
<a href="#l13.117"></a><span id="l13.117">         do_CreateInstance(&quot;@mozilla.org/network/ldap-ber-value;1&quot;, &amp;rv);</span>
<a href="#l13.118"></a><span id="l13.118">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.119"></a><span id="l13.119"> </span>
<a href="#l13.120"></a><span id="l13.120">       rv = value-&gt;SetFromUTF8(propvalue);</span>
<a href="#l13.121"></a><span id="l13.121">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.122"></a><span id="l13.122" class="difflineminus">- </span>
<a href="#l13.123"></a><span id="l13.123" class="difflineplus">+</span>
<a href="#l13.124"></a><span id="l13.124">       rv = mod-&gt;SetUpModificationOneValue(aType, attr, value);</span>
<a href="#l13.125"></a><span id="l13.125">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.126"></a><span id="l13.126" class="difflineminus">-    </span>
<a href="#l13.127"></a><span id="l13.127" class="difflineplus">+</span>
<a href="#l13.128"></a><span id="l13.128">       printf(&quot;LDAP : setting attribute %s (%s) to '%s'\n&quot;, attr.get(),</span>
<a href="#l13.129"></a><span id="l13.129">         props[i], propvalue.get());</span>
<a href="#l13.130"></a><span id="l13.130">       modArray-&gt;AppendElement(mod, false);</span>
<a href="#l13.131"></a><span id="l13.131">       if (index != m_attributes.NoIndex)</span>
<a href="#l13.132"></a><span id="l13.132">         m_attributes.AppendElement(attr);</span>
<a href="#l13.133"></a><span id="l13.133"> </span>
<a href="#l13.134"></a><span id="l13.134">     }</span>
<a href="#l13.135"></a><span id="l13.135">     else if (aType == nsILDAPModification::MOD_REPLACE &amp;&amp;</span>
<a href="#l13.136"></a><span id="l13.136" class="difflineat">@@ -175,17 +175,17 @@ NS_IMETHODIMP nsAbLDAPCard::GetLDAPMessa</span>
<a href="#l13.137"></a><span id="l13.137">       // If the new value is empty, we are performing an update</span>
<a href="#l13.138"></a><span id="l13.138">       // and the attribute was previously set, clear it</span>
<a href="#l13.139"></a><span id="l13.139">       nsCOMPtr&lt;nsIMutableArray&gt; novalues =</span>
<a href="#l13.140"></a><span id="l13.140">         do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l13.141"></a><span id="l13.141">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.142"></a><span id="l13.142"> </span>
<a href="#l13.143"></a><span id="l13.143">       rv = mod-&gt;SetUpModification(aType, attr, novalues);</span>
<a href="#l13.144"></a><span id="l13.144">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.145"></a><span id="l13.145" class="difflineminus">-      </span>
<a href="#l13.146"></a><span id="l13.146" class="difflineplus">+</span>
<a href="#l13.147"></a><span id="l13.147">       printf(&quot;LDAP : removing attribute %s (%s)\n&quot;, attr.get(), props[i]);</span>
<a href="#l13.148"></a><span id="l13.148">       modArray-&gt;AppendElement(mod, false);</span>
<a href="#l13.149"></a><span id="l13.149">       m_attributes.RemoveElementAt(index);</span>
<a href="#l13.150"></a><span id="l13.150">     }</span>
<a href="#l13.151"></a><span id="l13.151">   }</span>
<a href="#l13.152"></a><span id="l13.152"> </span>
<a href="#l13.153"></a><span id="l13.153">   modArray.forget(aLDAPAddMessageInfo);</span>
<a href="#l13.154"></a><span id="l13.154"> </span>
<a href="#l13.155"></a><span id="l13.155" class="difflineat">@@ -194,43 +194,43 @@ NS_IMETHODIMP nsAbLDAPCard::GetLDAPMessa</span>
<a href="#l13.156"></a><span id="l13.156"> </span>
<a href="#l13.157"></a><span id="l13.157"> NS_IMETHODIMP nsAbLDAPCard::BuildRdn(nsIAbLDAPAttributeMap *aAttributeMap,</span>
<a href="#l13.158"></a><span id="l13.158">                                      const uint32_t aAttrCount,</span>
<a href="#l13.159"></a><span id="l13.159">                                      const char **aAttributes,</span>
<a href="#l13.160"></a><span id="l13.160">                                      nsACString &amp;aRdn)</span>
<a href="#l13.161"></a><span id="l13.161"> {</span>
<a href="#l13.162"></a><span id="l13.162">   NS_ENSURE_ARG_POINTER(aAttributeMap);</span>
<a href="#l13.163"></a><span id="l13.163">   NS_ENSURE_ARG_POINTER(aAttributes);</span>
<a href="#l13.164"></a><span id="l13.164" class="difflineminus">-  </span>
<a href="#l13.165"></a><span id="l13.165" class="difflineplus">+</span>
<a href="#l13.166"></a><span id="l13.166">   nsresult rv;</span>
<a href="#l13.167"></a><span id="l13.167">   nsCString attr;</span>
<a href="#l13.168"></a><span id="l13.168">   nsAutoCString prop;</span>
<a href="#l13.169"></a><span id="l13.169">   nsCString propvalue;</span>
<a href="#l13.170"></a><span id="l13.170"> </span>
<a href="#l13.171"></a><span id="l13.171">   aRdn.Truncate();</span>
<a href="#l13.172"></a><span id="l13.172">   for (uint32_t i = 0; i &lt; aAttrCount; ++i)</span>
<a href="#l13.173"></a><span id="l13.173">   {</span>
<a href="#l13.174"></a><span id="l13.174">     attr.Assign(nsDependentCString(aAttributes[i]));</span>
<a href="#l13.175"></a><span id="l13.175" class="difflineminus">-   </span>
<a href="#l13.176"></a><span id="l13.176" class="difflineplus">+</span>
<a href="#l13.177"></a><span id="l13.177">     // Lookup the property corresponding to the attribute</span>
<a href="#l13.178"></a><span id="l13.178">     rv = aAttributeMap-&gt;GetProperty(attr, prop);</span>
<a href="#l13.179"></a><span id="l13.179">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.180"></a><span id="l13.180"> </span>
<a href="#l13.181"></a><span id="l13.181">     // Get the property value</span>
<a href="#l13.182"></a><span id="l13.182">     rv = GetPropertyAsAUTF8String(prop.get(), propvalue);</span>
<a href="#l13.183"></a><span id="l13.183"> </span>
<a href="#l13.184"></a><span id="l13.184">     // XXX The case where an attribute needed to build the Relative</span>
<a href="#l13.185"></a><span id="l13.185">     // Distinguished Name is not set needs to be handled by the caller,</span>
<a href="#l13.186"></a><span id="l13.186">     // so as to let the user know what is missing.</span>
<a href="#l13.187"></a><span id="l13.187">     if (NS_FAILED(rv) || propvalue.IsEmpty())</span>
<a href="#l13.188"></a><span id="l13.188">     {</span>
<a href="#l13.189"></a><span id="l13.189">       NS_ERROR(&quot;nsAbLDAPCard::BuildRdn: a required attribute is not set&quot;);</span>
<a href="#l13.190"></a><span id="l13.190">       return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l13.191"></a><span id="l13.191">     }</span>
<a href="#l13.192"></a><span id="l13.192" class="difflineminus">-  </span>
<a href="#l13.193"></a><span id="l13.193" class="difflineplus">+</span>
<a href="#l13.194"></a><span id="l13.194">     aRdn.Append(attr);</span>
<a href="#l13.195"></a><span id="l13.195">     aRdn.Append('=');</span>
<a href="#l13.196"></a><span id="l13.196">     aRdn.Append(propvalue);</span>
<a href="#l13.197"></a><span id="l13.197">     if (i &lt; aAttrCount - 1)</span>
<a href="#l13.198"></a><span id="l13.198">       aRdn.Append('+');</span>
<a href="#l13.199"></a><span id="l13.199">   }</span>
<a href="#l13.200"></a><span id="l13.200">   return NS_OK;</span>
<a href="#l13.201"></a><span id="l13.201"> }</span>
<a href="#l13.202"></a><span id="l13.202" class="difflineat">@@ -244,29 +244,29 @@ NS_IMETHODIMP nsAbLDAPCard::SetDn(const </span>
<a href="#l13.203"></a><span id="l13.203"> {</span>
<a href="#l13.204"></a><span id="l13.204">   SetLocalId(aDN);</span>
<a href="#l13.205"></a><span id="l13.205">   return SetPropertyAsAUTF8String(kDNColumn, aDN);</span>
<a href="#l13.206"></a><span id="l13.206"> }</span>
<a href="#l13.207"></a><span id="l13.207"> </span>
<a href="#l13.208"></a><span id="l13.208"> NS_IMETHODIMP nsAbLDAPCard::SetMetaProperties(nsILDAPMessage *aMessage)</span>
<a href="#l13.209"></a><span id="l13.209"> {</span>
<a href="#l13.210"></a><span id="l13.210">   NS_ENSURE_ARG_POINTER(aMessage);</span>
<a href="#l13.211"></a><span id="l13.211" class="difflineminus">-  </span>
<a href="#l13.212"></a><span id="l13.212" class="difflineplus">+</span>
<a href="#l13.213"></a><span id="l13.213">   // Get DN</span>
<a href="#l13.214"></a><span id="l13.214">   nsAutoCString dn;</span>
<a href="#l13.215"></a><span id="l13.215">   nsresult rv = aMessage-&gt;GetDn(dn);</span>
<a href="#l13.216"></a><span id="l13.216">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.217"></a><span id="l13.217"> </span>
<a href="#l13.218"></a><span id="l13.218">   SetDn(dn);</span>
<a href="#l13.219"></a><span id="l13.219"> </span>
<a href="#l13.220"></a><span id="l13.220">   // Get the list of set attributes</span>
<a href="#l13.221"></a><span id="l13.221">   CharPtrArrayGuard attrs;</span>
<a href="#l13.222"></a><span id="l13.222">   rv = aMessage-&gt;GetAttributes(attrs.GetSizeAddr(), attrs.GetArrayAddr());</span>
<a href="#l13.223"></a><span id="l13.223">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.224"></a><span id="l13.224" class="difflineminus">- </span>
<a href="#l13.225"></a><span id="l13.225" class="difflineplus">+</span>
<a href="#l13.226"></a><span id="l13.226">   nsAutoCString attr;</span>
<a href="#l13.227"></a><span id="l13.227">   m_attributes.Clear();</span>
<a href="#l13.228"></a><span id="l13.228">   for (uint32_t i = 0; i &lt; attrs.GetSize(); ++i)</span>
<a href="#l13.229"></a><span id="l13.229">   {</span>
<a href="#l13.230"></a><span id="l13.230">     attr.Assign(nsDependentCString(attrs[i]));</span>
<a href="#l13.231"></a><span id="l13.231">     ToLowerCase(attr);</span>
<a href="#l13.232"></a><span id="l13.232">     m_attributes.AppendElement(attr);</span>
<a href="#l13.233"></a><span id="l13.233">   }</span>
<a href="#l13.234"></a><span id="l13.234" class="difflineat">@@ -279,17 +279,17 @@ NS_IMETHODIMP nsAbLDAPCard::SetMetaPrope</span>
<a href="#l13.235"></a><span id="l13.235"> </span>
<a href="#l13.236"></a><span id="l13.236">   // objectClass is not always included in search result entries and</span>
<a href="#l13.237"></a><span id="l13.237">   // nsILDAPMessage::GetValues returns NS_ERROR_LDAP_DECODING_ERROR if the</span>
<a href="#l13.238"></a><span id="l13.238">   // requested attribute doesn't exist.</span>
<a href="#l13.239"></a><span id="l13.239">   if (rv ==  NS_ERROR_LDAP_DECODING_ERROR)</span>
<a href="#l13.240"></a><span id="l13.240">     return NS_OK;</span>
<a href="#l13.241"></a><span id="l13.241"> </span>
<a href="#l13.242"></a><span id="l13.242">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.243"></a><span id="l13.243" class="difflineminus">-  </span>
<a href="#l13.244"></a><span id="l13.244" class="difflineplus">+</span>
<a href="#l13.245"></a><span id="l13.245">   nsAutoCString oclass;</span>
<a href="#l13.246"></a><span id="l13.246">   for (uint32_t i = 0; i &lt; vals.GetSize(); ++i)</span>
<a href="#l13.247"></a><span id="l13.247">   {</span>
<a href="#l13.248"></a><span id="l13.248">     oclass.Assign(NS_LossyConvertUTF16toASCII(nsDependentString(vals[i])));</span>
<a href="#l13.249"></a><span id="l13.249">     ToLowerCase(oclass);</span>
<a href="#l13.250"></a><span id="l13.250">     m_objectClass.AppendElement(oclass);</span>
<a href="#l13.251"></a><span id="l13.251">   }</span>
<a href="#l13.252"></a><span id="l13.252"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPChangeLogData.cpp</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPChangeLogData.cpp</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -50,25 +50,25 @@ NS_IMETHODIMP nsAbLDAPProcessChangeLogDa</span>
<a href="#l14.4"></a><span id="l14.4">    NS_ENSURE_ARG_POINTER(query);</span>
<a href="#l14.5"></a><span id="l14.5"> </span>
<a href="#l14.6"></a><span id="l14.6">    // Here we are assuming that the caller will pass a nsAbLDAPChangeLogQuery object,</span>
<a href="#l14.7"></a><span id="l14.7">    // an implementation derived from the implementation of nsIAbLDAPReplicationQuery.</span>
<a href="#l14.8"></a><span id="l14.8">    nsresult rv = NS_OK;</span>
<a href="#l14.9"></a><span id="l14.9">    mChangeLogQuery = do_QueryInterface(query, &amp;rv);</span>
<a href="#l14.10"></a><span id="l14.10">    if(NS_FAILED(rv))</span>
<a href="#l14.11"></a><span id="l14.11">        return rv;</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-   </span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+</span>
<a href="#l14.14"></a><span id="l14.14">    // Call the parent's Init now.</span>
<a href="#l14.15"></a><span id="l14.15">    return nsAbLDAPProcessReplicationData::Init(query, progressListener);</span>
<a href="#l14.16"></a><span id="l14.16"> }</span>
<a href="#l14.17"></a><span id="l14.17"> </span>
<a href="#l14.18"></a><span id="l14.18"> nsresult nsAbLDAPProcessChangeLogData::OnLDAPBind(nsILDAPMessage *aMessage)</span>
<a href="#l14.19"></a><span id="l14.19"> {</span>
<a href="#l14.20"></a><span id="l14.20">     NS_ENSURE_ARG_POINTER(aMessage);</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineminus">-	if(!mInitialized) </span>
<a href="#l14.22"></a><span id="l14.22" class="difflineplus">+	if(!mInitialized)</span>
<a href="#l14.23"></a><span id="l14.23">         return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l14.24"></a><span id="l14.24"> </span>
<a href="#l14.25"></a><span id="l14.25">     int32_t errCode;</span>
<a href="#l14.26"></a><span id="l14.26"> </span>
<a href="#l14.27"></a><span id="l14.27">     nsresult rv = aMessage-&gt;GetErrorCode(&amp;errCode);</span>
<a href="#l14.28"></a><span id="l14.28">     if(NS_FAILED(rv)) {</span>
<a href="#l14.29"></a><span id="l14.29">         Done(false);</span>
<a href="#l14.30"></a><span id="l14.30">         return rv;</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineat">@@ -77,41 +77,41 @@ nsresult nsAbLDAPProcessChangeLogData::O</span>
<a href="#l14.32"></a><span id="l14.32">     if(errCode != nsILDAPErrors::SUCCESS) {</span>
<a href="#l14.33"></a><span id="l14.33">         Done(false);</span>
<a href="#l14.34"></a><span id="l14.34">         return NS_ERROR_FAILURE;</span>
<a href="#l14.35"></a><span id="l14.35">     }</span>
<a href="#l14.36"></a><span id="l14.36"> </span>
<a href="#l14.37"></a><span id="l14.37">     switch(mState) {</span>
<a href="#l14.38"></a><span id="l14.38">     case kAnonymousBinding :</span>
<a href="#l14.39"></a><span id="l14.39">         rv = GetAuthData();</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineminus">-        if(NS_SUCCEEDED(rv)) </span>
<a href="#l14.41"></a><span id="l14.41" class="difflineplus">+        if(NS_SUCCEEDED(rv))</span>
<a href="#l14.42"></a><span id="l14.42">             rv = mChangeLogQuery-&gt;QueryAuthDN(mAuthUserID);</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineminus">-        if(NS_SUCCEEDED(rv)) </span>
<a href="#l14.44"></a><span id="l14.44" class="difflineplus">+        if(NS_SUCCEEDED(rv))</span>
<a href="#l14.45"></a><span id="l14.45">             mState = kSearchingAuthDN;</span>
<a href="#l14.46"></a><span id="l14.46">         break;</span>
<a href="#l14.47"></a><span id="l14.47">     case kAuthenticatedBinding :</span>
<a href="#l14.48"></a><span id="l14.48">         rv = mChangeLogQuery-&gt;QueryRootDSE();</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineminus">-        if(NS_SUCCEEDED(rv)) </span>
<a href="#l14.50"></a><span id="l14.50" class="difflineplus">+        if(NS_SUCCEEDED(rv))</span>
<a href="#l14.51"></a><span id="l14.51">             mState = kSearchingRootDSE;</span>
<a href="#l14.52"></a><span id="l14.52">         break;</span>
<a href="#l14.53"></a><span id="l14.53">     } //end of switch</span>
<a href="#l14.54"></a><span id="l14.54"> </span>
<a href="#l14.55"></a><span id="l14.55">     if(NS_FAILED(rv))</span>
<a href="#l14.56"></a><span id="l14.56">         Abort();</span>
<a href="#l14.57"></a><span id="l14.57"> </span>
<a href="#l14.58"></a><span id="l14.58">     return rv;</span>
<a href="#l14.59"></a><span id="l14.59"> }</span>
<a href="#l14.60"></a><span id="l14.60"> </span>
<a href="#l14.61"></a><span id="l14.61"> nsresult nsAbLDAPProcessChangeLogData::OnLDAPSearchEntry(nsILDAPMessage *aMessage)</span>
<a href="#l14.62"></a><span id="l14.62"> {</span>
<a href="#l14.63"></a><span id="l14.63">     NS_ENSURE_ARG_POINTER(aMessage);</span>
<a href="#l14.64"></a><span id="l14.64" class="difflineminus">-    if(!mInitialized) </span>
<a href="#l14.65"></a><span id="l14.65" class="difflineplus">+    if(!mInitialized)</span>
<a href="#l14.66"></a><span id="l14.66">         return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l14.67"></a><span id="l14.67"> </span>
<a href="#l14.68"></a><span id="l14.68" class="difflineminus">-    nsresult rv = NS_OK;       </span>
<a href="#l14.69"></a><span id="l14.69" class="difflineplus">+    nsresult rv = NS_OK;</span>
<a href="#l14.70"></a><span id="l14.70"> </span>
<a href="#l14.71"></a><span id="l14.71">     switch(mState)</span>
<a href="#l14.72"></a><span id="l14.72">     {</span>
<a href="#l14.73"></a><span id="l14.73">     case kSearchingAuthDN :</span>
<a href="#l14.74"></a><span id="l14.74">         {</span>
<a href="#l14.75"></a><span id="l14.75">             nsAutoCString authDN;</span>
<a href="#l14.76"></a><span id="l14.76">             rv = aMessage-&gt;GetDn(authDN);</span>
<a href="#l14.77"></a><span id="l14.77">             if(NS_SUCCEEDED(rv) &amp;&amp; !authDN.IsEmpty())</span>
<a href="#l14.78"></a><span id="l14.78" class="difflineat">@@ -138,69 +138,69 @@ nsresult nsAbLDAPProcessChangeLogData::O</span>
<a href="#l14.79"></a><span id="l14.79"> </span>
<a href="#l14.80"></a><span id="l14.80"> nsresult nsAbLDAPProcessChangeLogData::OnLDAPSearchResult(nsILDAPMessage *aMessage)</span>
<a href="#l14.81"></a><span id="l14.81"> {</span>
<a href="#l14.82"></a><span id="l14.82">     NS_ENSURE_ARG_POINTER(aMessage);</span>
<a href="#l14.83"></a><span id="l14.83">     if (!mInitialized)</span>
<a href="#l14.84"></a><span id="l14.84">         return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l14.85"></a><span id="l14.85"> </span>
<a href="#l14.86"></a><span id="l14.86">     int32_t errorCode;</span>
<a href="#l14.87"></a><span id="l14.87" class="difflineminus">-    </span>
<a href="#l14.88"></a><span id="l14.88" class="difflineplus">+</span>
<a href="#l14.89"></a><span id="l14.89">     nsresult rv = aMessage-&gt;GetErrorCode(&amp;errorCode);</span>
<a href="#l14.90"></a><span id="l14.90"> </span>
<a href="#l14.91"></a><span id="l14.91">     if(NS_SUCCEEDED(rv))</span>
<a href="#l14.92"></a><span id="l14.92">     {</span>
<a href="#l14.93"></a><span id="l14.93">         if(errorCode == nsILDAPErrors::SUCCESS || errorCode == nsILDAPErrors::SIZELIMIT_EXCEEDED) {</span>
<a href="#l14.94"></a><span id="l14.94">             switch(mState) {</span>
<a href="#l14.95"></a><span id="l14.95">             case kSearchingAuthDN :</span>
<a href="#l14.96"></a><span id="l14.96">                 rv = OnSearchAuthDNDone();</span>
<a href="#l14.97"></a><span id="l14.97">                 break;</span>
<a href="#l14.98"></a><span id="l14.98">             case kSearchingRootDSE:</span>
<a href="#l14.99"></a><span id="l14.99">              {</span>
<a href="#l14.100"></a><span id="l14.100">                 // Before starting the changeLog check the DB file, if its not there or bogus</span>
<a href="#l14.101"></a><span id="l14.101">                 // we need to create a new one and set to all.</span>
<a href="#l14.102"></a><span id="l14.102">                 nsCOMPtr&lt;nsIAddrBookSession&gt; abSession = do_GetService(NS_ADDRBOOKSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l14.103"></a><span id="l14.103" class="difflineminus">-                if (NS_FAILED(rv)) </span>
<a href="#l14.104"></a><span id="l14.104" class="difflineplus">+                if (NS_FAILED(rv))</span>
<a href="#l14.105"></a><span id="l14.105">                     break;</span>
<a href="#l14.106"></a><span id="l14.106">                 nsCOMPtr&lt;nsIFile&gt; dbPath;</span>
<a href="#l14.107"></a><span id="l14.107">                 rv = abSession-&gt;GetUserProfileDirectory(getter_AddRefs(dbPath));</span>
<a href="#l14.108"></a><span id="l14.108" class="difflineminus">-                if (NS_FAILED(rv)) </span>
<a href="#l14.109"></a><span id="l14.109" class="difflineplus">+                if (NS_FAILED(rv))</span>
<a href="#l14.110"></a><span id="l14.110">                     break;</span>
<a href="#l14.111"></a><span id="l14.111"> </span>
<a href="#l14.112"></a><span id="l14.112">                 nsAutoCString fileName;</span>
<a href="#l14.113"></a><span id="l14.113">                 rv = mDirectory-&gt;GetReplicationFileName(fileName);</span>
<a href="#l14.114"></a><span id="l14.114">                 if (NS_FAILED(rv))</span>
<a href="#l14.115"></a><span id="l14.115">                   break;</span>
<a href="#l14.116"></a><span id="l14.116"> </span>
<a href="#l14.117"></a><span id="l14.117">                 rv = dbPath-&gt;AppendNative(fileName);</span>
<a href="#l14.118"></a><span id="l14.118" class="difflineminus">-                if (NS_FAILED(rv)) </span>
<a href="#l14.119"></a><span id="l14.119" class="difflineplus">+                if (NS_FAILED(rv))</span>
<a href="#l14.120"></a><span id="l14.120">                     break;</span>
<a href="#l14.121"></a><span id="l14.121"> </span>
<a href="#l14.122"></a><span id="l14.122">                 bool fileExists;</span>
<a href="#l14.123"></a><span id="l14.123">                 rv = dbPath-&gt;Exists(&amp;fileExists);</span>
<a href="#l14.124"></a><span id="l14.124" class="difflineminus">-                if (NS_FAILED(rv)) </span>
<a href="#l14.125"></a><span id="l14.125" class="difflineplus">+                if (NS_FAILED(rv))</span>
<a href="#l14.126"></a><span id="l14.126">                     break;</span>
<a href="#l14.127"></a><span id="l14.127"> </span>
<a href="#l14.128"></a><span id="l14.128">                 int64_t fileSize;</span>
<a href="#l14.129"></a><span id="l14.129">                 rv = dbPath-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l14.130"></a><span id="l14.130" class="difflineminus">-                if(NS_FAILED(rv)) </span>
<a href="#l14.131"></a><span id="l14.131" class="difflineplus">+                if(NS_FAILED(rv))</span>
<a href="#l14.132"></a><span id="l14.132">                     break;</span>
<a href="#l14.133"></a><span id="l14.133"> </span>
<a href="#l14.134"></a><span id="l14.134">                 if (!fileExists || !fileSize)</span>
<a href="#l14.135"></a><span id="l14.135">                     mUseChangeLog = false;</span>
<a href="#l14.136"></a><span id="l14.136"> </span>
<a href="#l14.137"></a><span id="l14.137">                 // Open / create the AB here since it calls Done,</span>
<a href="#l14.138"></a><span id="l14.138">                 // just return from here.</span>
<a href="#l14.139"></a><span id="l14.139">                 if (mUseChangeLog)</span>
<a href="#l14.140"></a><span id="l14.140">                    rv = OpenABForReplicatedDir(false);</span>
<a href="#l14.141"></a><span id="l14.141">                 else</span>
<a href="#l14.142"></a><span id="l14.142">                    rv = OpenABForReplicatedDir(true);</span>
<a href="#l14.143"></a><span id="l14.143">                 if (NS_FAILED(rv))</span>
<a href="#l14.144"></a><span id="l14.144">                    return rv;</span>
<a href="#l14.145"></a><span id="l14.145" class="difflineminus">-                </span>
<a href="#l14.146"></a><span id="l14.146" class="difflineplus">+</span>
<a href="#l14.147"></a><span id="l14.147">                 // Now start the appropriate query</span>
<a href="#l14.148"></a><span id="l14.148">                 rv = OnSearchRootDSEDone();</span>
<a href="#l14.149"></a><span id="l14.149">                 break;</span>
<a href="#l14.150"></a><span id="l14.150">              }</span>
<a href="#l14.151"></a><span id="l14.151">             case kFindingChanges:</span>
<a href="#l14.152"></a><span id="l14.152">                 rv = OnFindingChangesDone();</span>
<a href="#l14.153"></a><span id="l14.153">                 // If success we return from here since</span>
<a href="#l14.154"></a><span id="l14.154">                 // this changes state to kReplicatingChanges</span>
<a href="#l14.155"></a><span id="l14.155" class="difflineat">@@ -223,65 +223,65 @@ nsresult nsAbLDAPProcessChangeLogData::O</span>
<a href="#l14.156"></a><span id="l14.156">     if(NS_FAILED(rv))</span>
<a href="#l14.157"></a><span id="l14.157">         Abort();</span>
<a href="#l14.158"></a><span id="l14.158"> </span>
<a href="#l14.159"></a><span id="l14.159">     return rv;</span>
<a href="#l14.160"></a><span id="l14.160"> }</span>
<a href="#l14.161"></a><span id="l14.161"> </span>
<a href="#l14.162"></a><span id="l14.162"> nsresult nsAbLDAPProcessChangeLogData::GetAuthData()</span>
<a href="#l14.163"></a><span id="l14.163"> {</span>
<a href="#l14.164"></a><span id="l14.164" class="difflineminus">-    if(!mInitialized) </span>
<a href="#l14.165"></a><span id="l14.165" class="difflineplus">+    if(!mInitialized)</span>
<a href="#l14.166"></a><span id="l14.166">         return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l14.167"></a><span id="l14.167"> </span>
<a href="#l14.168"></a><span id="l14.168">     nsCOMPtr&lt;nsIWindowWatcher&gt; wwatch(do_GetService(NS_WINDOWWATCHER_CONTRACTID));</span>
<a href="#l14.169"></a><span id="l14.169">     if (!wwatch)</span>
<a href="#l14.170"></a><span id="l14.170">         return NS_ERROR_FAILURE;</span>
<a href="#l14.171"></a><span id="l14.171" class="difflineminus">-    </span>
<a href="#l14.172"></a><span id="l14.172" class="difflineplus">+</span>
<a href="#l14.173"></a><span id="l14.173">     nsCOMPtr&lt;nsIAuthPrompt&gt; dialog;</span>
<a href="#l14.174"></a><span id="l14.174">     nsresult rv = wwatch-&gt;GetNewAuthPrompter(0, getter_AddRefs(dialog));</span>
<a href="#l14.175"></a><span id="l14.175">     if (NS_FAILED(rv))</span>
<a href="#l14.176"></a><span id="l14.176">         return rv;</span>
<a href="#l14.177"></a><span id="l14.177" class="difflineminus">-    if (!dialog) </span>
<a href="#l14.178"></a><span id="l14.178" class="difflineplus">+    if (!dialog)</span>
<a href="#l14.179"></a><span id="l14.179">         return NS_ERROR_FAILURE;</span>
<a href="#l14.180"></a><span id="l14.180"> </span>
<a href="#l14.181"></a><span id="l14.181">     nsCOMPtr&lt;nsILDAPURL&gt; url;</span>
<a href="#l14.182"></a><span id="l14.182">     rv = mQuery-&gt;GetReplicationURL(getter_AddRefs(url));</span>
<a href="#l14.183"></a><span id="l14.183">     if (NS_FAILED(rv))</span>
<a href="#l14.184"></a><span id="l14.184">         return rv;</span>
<a href="#l14.185"></a><span id="l14.185"> </span>
<a href="#l14.186"></a><span id="l14.186">     nsAutoCString serverUri;</span>
<a href="#l14.187"></a><span id="l14.187">     rv = url-&gt;GetSpec(serverUri);</span>
<a href="#l14.188"></a><span id="l14.188" class="difflineminus">-    if (NS_FAILED(rv)) </span>
<a href="#l14.189"></a><span id="l14.189" class="difflineplus">+    if (NS_FAILED(rv))</span>
<a href="#l14.190"></a><span id="l14.190">         return rv;</span>
<a href="#l14.191"></a><span id="l14.191"> </span>
<a href="#l14.192"></a><span id="l14.192">     nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l14.193"></a><span id="l14.193">       mozilla::services::GetStringBundleService();</span>
<a href="#l14.194"></a><span id="l14.194">     NS_ENSURE_TRUE(bundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l14.195"></a><span id="l14.195">     nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l14.196"></a><span id="l14.196">     rv = bundleService-&gt;CreateBundle(&quot;chrome://messenger/locale/addressbook/addressBook.properties&quot;, getter_AddRefs(bundle));</span>
<a href="#l14.197"></a><span id="l14.197" class="difflineminus">-    if (NS_FAILED (rv)) </span>
<a href="#l14.198"></a><span id="l14.198" class="difflineplus">+    if (NS_FAILED (rv))</span>
<a href="#l14.199"></a><span id="l14.199">         return rv ;</span>
<a href="#l14.200"></a><span id="l14.200"> </span>
<a href="#l14.201"></a><span id="l14.201">     nsString title;</span>
<a href="#l14.202"></a><span id="l14.202">     rv = bundle-&gt;GetStringFromName(&quot;AuthDlgTitle&quot;, title);</span>
<a href="#l14.203"></a><span id="l14.203" class="difflineminus">-    if (NS_FAILED (rv)) </span>
<a href="#l14.204"></a><span id="l14.204" class="difflineplus">+    if (NS_FAILED (rv))</span>
<a href="#l14.205"></a><span id="l14.205">         return rv ;</span>
<a href="#l14.206"></a><span id="l14.206"> </span>
<a href="#l14.207"></a><span id="l14.207">     nsString desc;</span>
<a href="#l14.208"></a><span id="l14.208">     rv = bundle-&gt;GetStringFromName(&quot;AuthDlgDesc&quot;, desc);</span>
<a href="#l14.209"></a><span id="l14.209" class="difflineminus">-    if (NS_FAILED (rv)) </span>
<a href="#l14.210"></a><span id="l14.210" class="difflineplus">+    if (NS_FAILED (rv))</span>
<a href="#l14.211"></a><span id="l14.211">         return rv ;</span>
<a href="#l14.212"></a><span id="l14.212"> </span>
<a href="#l14.213"></a><span id="l14.213">     nsString username;</span>
<a href="#l14.214"></a><span id="l14.214">     nsString password;</span>
<a href="#l14.215"></a><span id="l14.215">     bool btnResult = false;</span>
<a href="#l14.216"></a><span id="l14.216" class="difflineminus">-	rv = dialog-&gt;PromptUsernameAndPassword(title, desc, </span>
<a href="#l14.217"></a><span id="l14.217" class="difflineminus">-                                            NS_ConvertUTF8toUTF16(serverUri).get(), </span>
<a href="#l14.218"></a><span id="l14.218" class="difflineplus">+	rv = dialog-&gt;PromptUsernameAndPassword(title, desc,</span>
<a href="#l14.219"></a><span id="l14.219" class="difflineplus">+                                            NS_ConvertUTF8toUTF16(serverUri).get(),</span>
<a href="#l14.220"></a><span id="l14.220">                                             nsIAuthPrompt::SAVE_PASSWORD_PERMANENTLY,</span>
<a href="#l14.221"></a><span id="l14.221" class="difflineminus">-                                            getter_Copies(username), getter_Copies(password), </span>
<a href="#l14.222"></a><span id="l14.222" class="difflineplus">+                                            getter_Copies(username), getter_Copies(password),</span>
<a href="#l14.223"></a><span id="l14.223">                                             &amp;btnResult);</span>
<a href="#l14.224"></a><span id="l14.224">     if(NS_SUCCEEDED(rv) &amp;&amp; btnResult) {</span>
<a href="#l14.225"></a><span id="l14.225">         CopyUTF16toUTF8(username, mAuthUserID);</span>
<a href="#l14.226"></a><span id="l14.226">         CopyUTF16toUTF8(password, mAuthPswd);</span>
<a href="#l14.227"></a><span id="l14.227">     }</span>
<a href="#l14.228"></a><span id="l14.228">     else</span>
<a href="#l14.229"></a><span id="l14.229">         rv = NS_ERROR_FAILURE;</span>
<a href="#l14.230"></a><span id="l14.230"> </span>
<a href="#l14.231"></a><span id="l14.231" class="difflineat">@@ -310,17 +310,17 @@ nsresult nsAbLDAPProcessChangeLogData::P</span>
<a href="#l14.232"></a><span id="l14.232">     NS_ENSURE_ARG_POINTER(aMessage);</span>
<a href="#l14.233"></a><span id="l14.233">     if (!mInitialized)</span>
<a href="#l14.234"></a><span id="l14.234">         return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l14.235"></a><span id="l14.235"> </span>
<a href="#l14.236"></a><span id="l14.236">     // Populate the RootDSEChangeLogEntry</span>
<a href="#l14.237"></a><span id="l14.237">     CharPtrArrayGuard attrs;</span>
<a href="#l14.238"></a><span id="l14.238">     nsresult rv = aMessage-&gt;GetAttributes(attrs.GetSizeAddr(), attrs.GetArrayAddr());</span>
<a href="#l14.239"></a><span id="l14.239">     // No attributes</span>
<a href="#l14.240"></a><span id="l14.240" class="difflineminus">-    if(NS_FAILED(rv)) </span>
<a href="#l14.241"></a><span id="l14.241" class="difflineplus">+    if(NS_FAILED(rv))</span>
<a href="#l14.242"></a><span id="l14.242">         return rv;</span>
<a href="#l14.243"></a><span id="l14.243"> </span>
<a href="#l14.244"></a><span id="l14.244">     for(int32_t i=attrs.GetSize()-1; i &gt;= 0; i--) {</span>
<a href="#l14.245"></a><span id="l14.245">         PRUnicharPtrArrayGuard vals;</span>
<a href="#l14.246"></a><span id="l14.246">         rv = aMessage-&gt;GetValues(attrs.GetArray()[i], vals.GetSizeAddr(), vals.GetArrayAddr());</span>
<a href="#l14.247"></a><span id="l14.247">         if(NS_FAILED(rv))</span>
<a href="#l14.248"></a><span id="l14.248">             continue;</span>
<a href="#l14.249"></a><span id="l14.249">         if(vals.GetSize()) {</span>
<a href="#l14.250"></a><span id="l14.250" class="difflineat">@@ -382,24 +382,24 @@ nsresult nsAbLDAPProcessChangeLogData::O</span>
<a href="#l14.251"></a><span id="l14.251">     rv = mDirectory-&gt;SetDataVersion(mRootDSEEntry.dataVersion);</span>
<a href="#l14.252"></a><span id="l14.252"> </span>
<a href="#l14.253"></a><span id="l14.253">     return rv;</span>
<a href="#l14.254"></a><span id="l14.254"> }</span>
<a href="#l14.255"></a><span id="l14.255"> </span>
<a href="#l14.256"></a><span id="l14.256"> nsresult nsAbLDAPProcessChangeLogData::ParseChangeLogEntries(nsILDAPMessage *aMessage)</span>
<a href="#l14.257"></a><span id="l14.257"> {</span>
<a href="#l14.258"></a><span id="l14.258">     NS_ENSURE_ARG_POINTER(aMessage);</span>
<a href="#l14.259"></a><span id="l14.259" class="difflineminus">-    if(!mInitialized) </span>
<a href="#l14.260"></a><span id="l14.260" class="difflineplus">+    if(!mInitialized)</span>
<a href="#l14.261"></a><span id="l14.261">         return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l14.262"></a><span id="l14.262"> </span>
<a href="#l14.263"></a><span id="l14.263">     // Populate the RootDSEChangeLogEntry</span>
<a href="#l14.264"></a><span id="l14.264">     CharPtrArrayGuard attrs;</span>
<a href="#l14.265"></a><span id="l14.265">     nsresult rv = aMessage-&gt;GetAttributes(attrs.GetSizeAddr(), attrs.GetArrayAddr());</span>
<a href="#l14.266"></a><span id="l14.266">     // No attributes</span>
<a href="#l14.267"></a><span id="l14.267" class="difflineminus">-    if(NS_FAILED(rv)) </span>
<a href="#l14.268"></a><span id="l14.268" class="difflineplus">+    if(NS_FAILED(rv))</span>
<a href="#l14.269"></a><span id="l14.269">         return rv;</span>
<a href="#l14.270"></a><span id="l14.270"> </span>
<a href="#l14.271"></a><span id="l14.271">     nsAutoString targetDN;</span>
<a href="#l14.272"></a><span id="l14.272">     UpdateOp operation = NO_OP;</span>
<a href="#l14.273"></a><span id="l14.273">     for(int32_t i = attrs.GetSize()-1; i &gt;= 0; i--) {</span>
<a href="#l14.274"></a><span id="l14.274">         PRUnicharPtrArrayGuard vals;</span>
<a href="#l14.275"></a><span id="l14.275">         rv = aMessage-&gt;GetValues(attrs.GetArray()[i], vals.GetSizeAddr(), vals.GetArrayAddr());</span>
<a href="#l14.276"></a><span id="l14.276">         if(NS_FAILED(rv))</span>
<a href="#l14.277"></a><span id="l14.277" class="difflineat">@@ -422,17 +422,17 @@ nsresult nsAbLDAPProcessChangeLogData::P</span>
<a href="#l14.278"></a><span id="l14.278">     if(!(mChangeLogEntriesCount % 10)) { // Inform the listener every 10 entries</span>
<a href="#l14.279"></a><span id="l14.279">         mListener-&gt;OnProgressChange(nullptr,nullptr,mChangeLogEntriesCount, -1, mChangeLogEntriesCount, -1);</span>
<a href="#l14.280"></a><span id="l14.280">         // In case if the LDAP Connection thread is starved and causes problem</span>
<a href="#l14.281"></a><span id="l14.281">         // uncomment this one and try.</span>
<a href="#l14.282"></a><span id="l14.282">         // PR_Sleep(PR_INTERVAL_NO_WAIT); // give others a chance</span>
<a href="#l14.283"></a><span id="l14.283">     }</span>
<a href="#l14.284"></a><span id="l14.284"> </span>
<a href="#l14.285"></a><span id="l14.285"> #ifdef DEBUG_rdayal</span>
<a href="#l14.286"></a><span id="l14.286" class="difflineminus">-    printf (&quot;ChangeLog Replication : Updated Entry : %s for OpType : %u\n&quot;, </span>
<a href="#l14.287"></a><span id="l14.287" class="difflineplus">+    printf (&quot;ChangeLog Replication : Updated Entry : %s for OpType : %u\n&quot;,</span>
<a href="#l14.288"></a><span id="l14.288">                                     NS_ConvertUTF16toUTF8(targetDN).get(), operation);</span>
<a href="#l14.289"></a><span id="l14.289"> #endif</span>
<a href="#l14.290"></a><span id="l14.290"> </span>
<a href="#l14.291"></a><span id="l14.291">     switch(operation) {</span>
<a href="#l14.292"></a><span id="l14.292">     case ENTRY_ADD:</span>
<a href="#l14.293"></a><span id="l14.293">         // Add the DN to the add list if not already in the list</span>
<a href="#l14.294"></a><span id="l14.294">         if(!(mEntriesToAdd.IndexOf(targetDN) &gt;= 0))</span>
<a href="#l14.295"></a><span id="l14.295">             mEntriesToAdd.AppendString(targetDN);</span>
<a href="#l14.296"></a><span id="l14.296" class="difflineat">@@ -442,17 +442,17 @@ nsresult nsAbLDAPProcessChangeLogData::P</span>
<a href="#l14.297"></a><span id="l14.297">         // entry deleted in changelog does not exist in DB</span>
<a href="#l14.298"></a><span id="l14.298">         // for e.g if the user specifies a filter, so go next entry</span>
<a href="#l14.299"></a><span id="l14.299">         DeleteCard(targetDN);</span>
<a href="#l14.300"></a><span id="l14.300">         break;</span>
<a href="#l14.301"></a><span id="l14.301">     case ENTRY_MODIFY:</span>
<a href="#l14.302"></a><span id="l14.302">         // For modify, delete the entry from DB and add updated entry</span>
<a href="#l14.303"></a><span id="l14.303">         // we do this since we cannot access the changes attribs of changelog</span>
<a href="#l14.304"></a><span id="l14.304">         rv = DeleteCard(targetDN);</span>
<a href="#l14.305"></a><span id="l14.305" class="difflineminus">-        if (NS_SUCCEEDED(rv)) </span>
<a href="#l14.306"></a><span id="l14.306" class="difflineplus">+        if (NS_SUCCEEDED(rv))</span>
<a href="#l14.307"></a><span id="l14.307">             if(!(mEntriesToAdd.IndexOf(targetDN) &gt;= 0))</span>
<a href="#l14.308"></a><span id="l14.308">                 mEntriesToAdd.AppendString(targetDN);</span>
<a href="#l14.309"></a><span id="l14.309">         break;</span>
<a href="#l14.310"></a><span id="l14.310">     default:</span>
<a href="#l14.311"></a><span id="l14.311">         // Should not come here, would come here only</span>
<a href="#l14.312"></a><span id="l14.312">         // if the entry is not a changeLog entry</span>
<a href="#l14.313"></a><span id="l14.313">         NS_WARNING(&quot;nsAbLDAPProcessChangeLogData::ParseChangeLogEntries&quot;</span>
<a href="#l14.314"></a><span id="l14.314">            &quot;Not an changelog entry&quot;);</span>
<a href="#l14.315"></a><span id="l14.315" class="difflineat">@@ -461,17 +461,17 @@ nsresult nsAbLDAPProcessChangeLogData::P</span>
<a href="#l14.316"></a><span id="l14.316">     // Go ahead processing the next entry, a modify or delete DB operation</span>
<a href="#l14.317"></a><span id="l14.317">     // can 'correctly' fail if the entry is not present in the DB,</span>
<a href="#l14.318"></a><span id="l14.318">     // e.g. in case a filter is specified.</span>
<a href="#l14.319"></a><span id="l14.319">     return NS_OK;</span>
<a href="#l14.320"></a><span id="l14.320"> }</span>
<a href="#l14.321"></a><span id="l14.321"> </span>
<a href="#l14.322"></a><span id="l14.322"> nsresult nsAbLDAPProcessChangeLogData::OnFindingChangesDone()</span>
<a href="#l14.323"></a><span id="l14.323"> {</span>
<a href="#l14.324"></a><span id="l14.324" class="difflineminus">-    if(!mInitialized) </span>
<a href="#l14.325"></a><span id="l14.325" class="difflineplus">+    if(!mInitialized)</span>
<a href="#l14.326"></a><span id="l14.326">         return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l14.327"></a><span id="l14.327"> </span>
<a href="#l14.328"></a><span id="l14.328"> #ifdef DEBUG_rdayal</span>
<a href="#l14.329"></a><span id="l14.329">     printf (&quot;ChangeLog Replication : Finding Changes Done \n&quot;);</span>
<a href="#l14.330"></a><span id="l14.330"> #endif</span>
<a href="#l14.331"></a><span id="l14.331"> </span>
<a href="#l14.332"></a><span id="l14.332">     nsresult rv = NS_OK;</span>
<a href="#l14.333"></a><span id="l14.333"> </span>
<a href="#l14.334"></a><span id="l14.334" class="difflineat">@@ -505,17 +505,17 @@ nsresult nsAbLDAPProcessChangeLogData::O</span>
<a href="#l14.335"></a><span id="l14.335">         mListener-&gt;OnStateChange(nullptr, nullptr, nsIWebProgressListener::STATE_START, true);</span>
<a href="#l14.336"></a><span id="l14.336"> </span>
<a href="#l14.337"></a><span id="l14.337">     mState = kReplicatingChanges;</span>
<a href="#l14.338"></a><span id="l14.338">     return rv;</span>
<a href="#l14.339"></a><span id="l14.339"> }</span>
<a href="#l14.340"></a><span id="l14.340"> </span>
<a href="#l14.341"></a><span id="l14.341"> nsresult nsAbLDAPProcessChangeLogData::OnReplicatingChangeDone()</span>
<a href="#l14.342"></a><span id="l14.342"> {</span>
<a href="#l14.343"></a><span id="l14.343" class="difflineminus">-    if(!mInitialized) </span>
<a href="#l14.344"></a><span id="l14.344" class="difflineplus">+    if(!mInitialized)</span>
<a href="#l14.345"></a><span id="l14.345">         return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l14.346"></a><span id="l14.346"> </span>
<a href="#l14.347"></a><span id="l14.347">     nsresult rv = NS_OK;</span>
<a href="#l14.348"></a><span id="l14.348"> </span>
<a href="#l14.349"></a><span id="l14.349">     if(!mEntriesAddedQueryCount)</span>
<a href="#l14.350"></a><span id="l14.350">     {</span>
<a href="#l14.351"></a><span id="l14.351">         if(mReplicationDB &amp;&amp; mDBOpen) {</span>
<a href="#l14.352"></a><span id="l14.352">             rv = mReplicationDB-&gt;Close(true); // Commit and close the DB</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPChangeLogData.h</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPChangeLogData.h</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -14,17 +14,17 @@ typedef struct {</span>
<a href="#l15.4"></a><span id="l15.4">   int32_t       firstChangeNumber;</span>
<a href="#l15.5"></a><span id="l15.5">   int32_t       lastChangeNumber;</span>
<a href="#l15.6"></a><span id="l15.6">   nsCString     dataVersion;</span>
<a href="#l15.7"></a><span id="l15.7"> } RootDSEChangeLogEntry;</span>
<a href="#l15.8"></a><span id="l15.8"> </span>
<a href="#l15.9"></a><span id="l15.9"> class nsAbLDAPProcessChangeLogData : public nsAbLDAPProcessReplicationData</span>
<a href="#l15.10"></a><span id="l15.10"> {</span>
<a href="#l15.11"></a><span id="l15.11"> public :</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-   </span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+</span>
<a href="#l15.14"></a><span id="l15.14">   nsAbLDAPProcessChangeLogData();</span>
<a href="#l15.15"></a><span id="l15.15"> </span>
<a href="#l15.16"></a><span id="l15.16">   NS_IMETHOD Init(nsIAbLDAPReplicationQuery * query, nsIWebProgressListener *progressListener);</span>
<a href="#l15.17"></a><span id="l15.17"> </span>
<a href="#l15.18"></a><span id="l15.18"> protected :</span>
<a href="#l15.19"></a><span id="l15.19">   ~nsAbLDAPProcessChangeLogData();</span>
<a href="#l15.20"></a><span id="l15.20"> </span>
<a href="#l15.21"></a><span id="l15.21">   nsCOMPtr &lt;nsIAbLDAPChangeLogQuery&gt; mChangeLogQuery;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPChangeLogQuery.cpp</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPChangeLogQuery.cpp</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -13,25 +13,25 @@</span>
<a href="#l16.4"></a><span id="l16.4"> #include &quot;prprf.h&quot;</span>
<a href="#l16.5"></a><span id="l16.5"> #include &quot;nsDirPrefs.h&quot;</span>
<a href="#l16.6"></a><span id="l16.6"> #include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l16.7"></a><span id="l16.7"> </span>
<a href="#l16.8"></a><span id="l16.8"> </span>
<a href="#l16.9"></a><span id="l16.9"> // The tables below were originally in nsAbLDAPProperties.cpp, which has since</span>
<a href="#l16.10"></a><span id="l16.10"> // gone away.</span>
<a href="#l16.11"></a><span id="l16.11"> static const char * sChangeLogRootDSEAttribs[] =</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-{ </span>
<a href="#l16.13"></a><span id="l16.13" class="difflineminus">-  &quot;changelog&quot;, </span>
<a href="#l16.14"></a><span id="l16.14" class="difflineminus">-  &quot;firstChangeNumber&quot;, </span>
<a href="#l16.15"></a><span id="l16.15" class="difflineplus">+{</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineplus">+  &quot;changelog&quot;,</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineplus">+  &quot;firstChangeNumber&quot;,</span>
<a href="#l16.18"></a><span id="l16.18">   &quot;lastChangeNumber&quot;,</span>
<a href="#l16.19"></a><span id="l16.19">   &quot;dataVersion&quot;</span>
<a href="#l16.20"></a><span id="l16.20"> };</span>
<a href="#l16.21"></a><span id="l16.21"> static const char * sChangeLogEntryAttribs[] =</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineminus">-{ </span>
<a href="#l16.23"></a><span id="l16.23" class="difflineminus">-  &quot;targetdn&quot;, </span>
<a href="#l16.24"></a><span id="l16.24" class="difflineplus">+{</span>
<a href="#l16.25"></a><span id="l16.25" class="difflineplus">+  &quot;targetdn&quot;,</span>
<a href="#l16.26"></a><span id="l16.26">   &quot;changetype&quot;</span>
<a href="#l16.27"></a><span id="l16.27"> };</span>
<a href="#l16.28"></a><span id="l16.28"> </span>
<a href="#l16.29"></a><span id="l16.29"> </span>
<a href="#l16.30"></a><span id="l16.30"> NS_IMPL_ISUPPORTS_INHERITED(nsAbLDAPChangeLogQuery, nsAbLDAPReplicationQuery, nsIAbLDAPChangeLogQuery)</span>
<a href="#l16.31"></a><span id="l16.31"> </span>
<a href="#l16.32"></a><span id="l16.32"> nsAbLDAPChangeLogQuery::nsAbLDAPChangeLogQuery()</span>
<a href="#l16.33"></a><span id="l16.33"> {</span>
<a href="#l16.34"></a><span id="l16.34" class="difflineat">@@ -42,39 +42,39 @@ nsAbLDAPChangeLogQuery::~nsAbLDAPChangeL</span>
<a href="#l16.35"></a><span id="l16.35"> </span>
<a href="#l16.36"></a><span id="l16.36"> }</span>
<a href="#l16.37"></a><span id="l16.37"> </span>
<a href="#l16.38"></a><span id="l16.38"> // this is to be defined only till this is not hooked to SSL to get authDN and authPswd</span>
<a href="#l16.39"></a><span id="l16.39"> #define USE_AUTHDLG</span>
<a href="#l16.40"></a><span id="l16.40"> </span>
<a href="#l16.41"></a><span id="l16.41"> NS_IMETHODIMP nsAbLDAPChangeLogQuery::Init(const nsACString &amp; aPrefName, nsIWebProgressListener *aProgressListener)</span>
<a href="#l16.42"></a><span id="l16.42"> {</span>
<a href="#l16.43"></a><span id="l16.43" class="difflineminus">-    if(aPrefName.IsEmpty()) </span>
<a href="#l16.44"></a><span id="l16.44" class="difflineplus">+    if(aPrefName.IsEmpty())</span>
<a href="#l16.45"></a><span id="l16.45">         return NS_ERROR_UNEXPECTED;</span>
<a href="#l16.46"></a><span id="l16.46"> </span>
<a href="#l16.47"></a><span id="l16.47">     mDirPrefName = aPrefName;</span>
<a href="#l16.48"></a><span id="l16.48"> </span>
<a href="#l16.49"></a><span id="l16.49">     nsresult rv = InitLDAPData();</span>
<a href="#l16.50"></a><span id="l16.50" class="difflineminus">-    if(NS_FAILED(rv)) </span>
<a href="#l16.51"></a><span id="l16.51" class="difflineplus">+    if(NS_FAILED(rv))</span>
<a href="#l16.52"></a><span id="l16.52">         return rv;</span>
<a href="#l16.53"></a><span id="l16.53"> </span>
<a href="#l16.54"></a><span id="l16.54">     // create the ChangeLog Data Processor</span>
<a href="#l16.55"></a><span id="l16.55">     mDataProcessor =  do_CreateInstance(NS_ABLDAP_PROCESSCHANGELOGDATA_CONTRACTID, &amp;rv);</span>
<a href="#l16.56"></a><span id="l16.56" class="difflineminus">-    if(NS_FAILED(rv)) </span>
<a href="#l16.57"></a><span id="l16.57" class="difflineplus">+    if(NS_FAILED(rv))</span>
<a href="#l16.58"></a><span id="l16.58">         return rv;</span>
<a href="#l16.59"></a><span id="l16.59"> </span>
<a href="#l16.60"></a><span id="l16.60">     // 'this' initialized</span>
<a href="#l16.61"></a><span id="l16.61">     mInitialized = true;</span>
<a href="#l16.62"></a><span id="l16.62"> </span>
<a href="#l16.63"></a><span id="l16.63">     return mDataProcessor-&gt;Init(this, aProgressListener);</span>
<a href="#l16.64"></a><span id="l16.64"> }</span>
<a href="#l16.65"></a><span id="l16.65"> </span>
<a href="#l16.66"></a><span id="l16.66"> NS_IMETHODIMP nsAbLDAPChangeLogQuery::DoReplicationQuery()</span>
<a href="#l16.67"></a><span id="l16.67"> {</span>
<a href="#l16.68"></a><span id="l16.68" class="difflineminus">-    if(!mInitialized) </span>
<a href="#l16.69"></a><span id="l16.69" class="difflineplus">+    if(!mInitialized)</span>
<a href="#l16.70"></a><span id="l16.70">         return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l16.71"></a><span id="l16.71"> </span>
<a href="#l16.72"></a><span id="l16.72"> #ifdef USE_AUTHDLG</span>
<a href="#l16.73"></a><span id="l16.73">     return ConnectToLDAPServer(mURL, EmptyCString());</span>
<a href="#l16.74"></a><span id="l16.74"> #else</span>
<a href="#l16.75"></a><span id="l16.75">     mDataProcessor-&gt;PopulateAuthData();</span>
<a href="#l16.76"></a><span id="l16.76">     return ConnectToLDAPServer(mURL, mAuthDN);</span>
<a href="#l16.77"></a><span id="l16.77"> #endif</span>
<a href="#l16.78"></a><span id="l16.78" class="difflineat">@@ -93,88 +93,88 @@ NS_IMETHODIMP nsAbLDAPChangeLogQuery::Qu</span>
<a href="#l16.79"></a><span id="l16.79">     rv = attrMap-&gt;GetFirstAttribute(NS_LITERAL_CSTRING(&quot;PrimaryEmail&quot;), filter);</span>
<a href="#l16.80"></a><span id="l16.80">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.81"></a><span id="l16.81"> </span>
<a href="#l16.82"></a><span id="l16.82">     filter += '=';</span>
<a href="#l16.83"></a><span id="l16.83">     filter += aValueUsedToFindDn;</span>
<a href="#l16.84"></a><span id="l16.84"> </span>
<a href="#l16.85"></a><span id="l16.85">     nsAutoCString dn;</span>
<a href="#l16.86"></a><span id="l16.86">     rv = mURL-&gt;GetDn(dn);</span>
<a href="#l16.87"></a><span id="l16.87" class="difflineminus">-    if(NS_FAILED(rv)) </span>
<a href="#l16.88"></a><span id="l16.88" class="difflineplus">+    if(NS_FAILED(rv))</span>
<a href="#l16.89"></a><span id="l16.89">         return rv;</span>
<a href="#l16.90"></a><span id="l16.90"> </span>
<a href="#l16.91"></a><span id="l16.91">     rv = CreateNewLDAPOperation();</span>
<a href="#l16.92"></a><span id="l16.92">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.93"></a><span id="l16.93"> </span>
<a href="#l16.94"></a><span id="l16.94">     // XXX We really should be using LDAP_NO_ATTRS here once its exposed via</span>
<a href="#l16.95"></a><span id="l16.95">     // the XPCOM layer of the directory code.</span>
<a href="#l16.96"></a><span id="l16.96" class="difflineminus">-    return mOperation-&gt;SearchExt(dn, nsILDAPURL::SCOPE_SUBTREE, filter, </span>
<a href="#l16.97"></a><span id="l16.97" class="difflineplus">+    return mOperation-&gt;SearchExt(dn, nsILDAPURL::SCOPE_SUBTREE, filter,</span>
<a href="#l16.98"></a><span id="l16.98">                                0, nullptr,</span>
<a href="#l16.99"></a><span id="l16.99">                                0, 0);</span>
<a href="#l16.100"></a><span id="l16.100"> }</span>
<a href="#l16.101"></a><span id="l16.101"> </span>
<a href="#l16.102"></a><span id="l16.102"> NS_IMETHODIMP nsAbLDAPChangeLogQuery::QueryRootDSE()</span>
<a href="#l16.103"></a><span id="l16.103"> {</span>
<a href="#l16.104"></a><span id="l16.104" class="difflineminus">-    if(!mInitialized) </span>
<a href="#l16.105"></a><span id="l16.105" class="difflineplus">+    if(!mInitialized)</span>
<a href="#l16.106"></a><span id="l16.106">         return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l16.107"></a><span id="l16.107"> </span>
<a href="#l16.108"></a><span id="l16.108">     nsresult rv = CreateNewLDAPOperation();</span>
<a href="#l16.109"></a><span id="l16.109">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.110"></a><span id="l16.110" class="difflineminus">-    return mOperation-&gt;SearchExt(EmptyCString(), nsILDAPURL::SCOPE_BASE, </span>
<a href="#l16.111"></a><span id="l16.111" class="difflineminus">-                                 NS_LITERAL_CSTRING(&quot;objectclass=*&quot;), </span>
<a href="#l16.112"></a><span id="l16.112" class="difflineplus">+    return mOperation-&gt;SearchExt(EmptyCString(), nsILDAPURL::SCOPE_BASE,</span>
<a href="#l16.113"></a><span id="l16.113" class="difflineplus">+                                 NS_LITERAL_CSTRING(&quot;objectclass=*&quot;),</span>
<a href="#l16.114"></a><span id="l16.114">                                  sizeof(sChangeLogRootDSEAttribs),</span>
<a href="#l16.115"></a><span id="l16.115">                                  sChangeLogRootDSEAttribs, 0, 0);</span>
<a href="#l16.116"></a><span id="l16.116"> }</span>
<a href="#l16.117"></a><span id="l16.117"> </span>
<a href="#l16.118"></a><span id="l16.118"> NS_IMETHODIMP nsAbLDAPChangeLogQuery::QueryChangeLog(const nsACString &amp; aChangeLogDN, int32_t aLastChangeNo)</span>
<a href="#l16.119"></a><span id="l16.119"> {</span>
<a href="#l16.120"></a><span id="l16.120">   if (!mInitialized)</span>
<a href="#l16.121"></a><span id="l16.121">     return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l16.122"></a><span id="l16.122" class="difflineminus">-  if (aChangeLogDN.IsEmpty()) </span>
<a href="#l16.123"></a><span id="l16.123" class="difflineplus">+  if (aChangeLogDN.IsEmpty())</span>
<a href="#l16.124"></a><span id="l16.124">     return NS_ERROR_UNEXPECTED;</span>
<a href="#l16.125"></a><span id="l16.125"> </span>
<a href="#l16.126"></a><span id="l16.126">   int32_t lastChangeNumber;</span>
<a href="#l16.127"></a><span id="l16.127">   nsresult rv = mDirectory-&gt;GetLastChangeNumber(&amp;lastChangeNumber);</span>
<a href="#l16.128"></a><span id="l16.128">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.129"></a><span id="l16.129"> </span>
<a href="#l16.130"></a><span id="l16.130" class="difflineminus">-  // make sure that the filter here just have one condition </span>
<a href="#l16.131"></a><span id="l16.131" class="difflineplus">+  // make sure that the filter here just have one condition</span>
<a href="#l16.132"></a><span id="l16.132">   // and should not be enclosed in enclosing brackets.</span>
<a href="#l16.133"></a><span id="l16.133">   // also condition '&gt;' doesnot work, it should be '&gt;='/</span>
<a href="#l16.134"></a><span id="l16.134">   nsAutoCString filter (NS_LITERAL_CSTRING(&quot;changenumber&gt;=&quot;));</span>
<a href="#l16.135"></a><span id="l16.135">   filter.AppendInt(lastChangeNumber + 1);</span>
<a href="#l16.136"></a><span id="l16.136"> </span>
<a href="#l16.137"></a><span id="l16.137">   rv = CreateNewLDAPOperation();</span>
<a href="#l16.138"></a><span id="l16.138">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.139"></a><span id="l16.139"> </span>
<a href="#l16.140"></a><span id="l16.140" class="difflineminus">-  return mOperation-&gt;SearchExt(aChangeLogDN, nsILDAPURL::SCOPE_ONELEVEL, filter, </span>
<a href="#l16.141"></a><span id="l16.141" class="difflineplus">+  return mOperation-&gt;SearchExt(aChangeLogDN, nsILDAPURL::SCOPE_ONELEVEL, filter,</span>
<a href="#l16.142"></a><span id="l16.142">                                sizeof(sChangeLogEntryAttribs),</span>
<a href="#l16.143"></a><span id="l16.143">                                sChangeLogEntryAttribs, 0, 0);</span>
<a href="#l16.144"></a><span id="l16.144"> }</span>
<a href="#l16.145"></a><span id="l16.145"> </span>
<a href="#l16.146"></a><span id="l16.146"> NS_IMETHODIMP nsAbLDAPChangeLogQuery::QueryChangedEntries(const nsACString &amp; aChangedEntryDN)</span>
<a href="#l16.147"></a><span id="l16.147"> {</span>
<a href="#l16.148"></a><span id="l16.148" class="difflineminus">-    if(!mInitialized) </span>
<a href="#l16.149"></a><span id="l16.149" class="difflineplus">+    if(!mInitialized)</span>
<a href="#l16.150"></a><span id="l16.150">         return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l16.151"></a><span id="l16.151" class="difflineminus">-    if(aChangedEntryDN.IsEmpty()) </span>
<a href="#l16.152"></a><span id="l16.152" class="difflineplus">+    if(aChangedEntryDN.IsEmpty())</span>
<a href="#l16.153"></a><span id="l16.153">         return NS_ERROR_UNEXPECTED;</span>
<a href="#l16.154"></a><span id="l16.154"> </span>
<a href="#l16.155"></a><span id="l16.155">     nsAutoCString urlFilter;</span>
<a href="#l16.156"></a><span id="l16.156">     nsresult rv = mURL-&gt;GetFilter(urlFilter);</span>
<a href="#l16.157"></a><span id="l16.157" class="difflineminus">-    if(NS_FAILED(rv)) </span>
<a href="#l16.158"></a><span id="l16.158" class="difflineplus">+    if(NS_FAILED(rv))</span>
<a href="#l16.159"></a><span id="l16.159">         return rv;</span>
<a href="#l16.160"></a><span id="l16.160"> </span>
<a href="#l16.161"></a><span id="l16.161">     int32_t scope;</span>
<a href="#l16.162"></a><span id="l16.162">     rv = mURL-&gt;GetScope(&amp;scope);</span>
<a href="#l16.163"></a><span id="l16.163" class="difflineminus">-    if(NS_FAILED(rv)) </span>
<a href="#l16.164"></a><span id="l16.164" class="difflineplus">+    if(NS_FAILED(rv))</span>
<a href="#l16.165"></a><span id="l16.165">         return rv;</span>
<a href="#l16.166"></a><span id="l16.166"> </span>
<a href="#l16.167"></a><span id="l16.167">     CharPtrArrayGuard attributes;</span>
<a href="#l16.168"></a><span id="l16.168">     rv = mURL-&gt;GetAttributes(attributes.GetSizeAddr(), attributes.GetArrayAddr());</span>
<a href="#l16.169"></a><span id="l16.169" class="difflineminus">-    if(NS_FAILED(rv)) </span>
<a href="#l16.170"></a><span id="l16.170" class="difflineplus">+    if(NS_FAILED(rv))</span>
<a href="#l16.171"></a><span id="l16.171">         return rv;</span>
<a href="#l16.172"></a><span id="l16.172"> </span>
<a href="#l16.173"></a><span id="l16.173">     rv = CreateNewLDAPOperation();</span>
<a href="#l16.174"></a><span id="l16.174">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.175"></a><span id="l16.175" class="difflineminus">-    return mOperation-&gt;SearchExt(aChangedEntryDN, scope, urlFilter, </span>
<a href="#l16.176"></a><span id="l16.176" class="difflineplus">+    return mOperation-&gt;SearchExt(aChangedEntryDN, scope, urlFilter,</span>
<a href="#l16.177"></a><span id="l16.177">                                attributes.GetSize(), attributes.GetArray(),</span>
<a href="#l16.178"></a><span id="l16.178">                                0, 0);</span>
<a href="#l16.179"></a><span id="l16.179"> }</span>
<a href="#l16.180"></a><span id="l16.180"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPDirFactory.cpp</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPDirFactory.cpp</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -38,18 +38,18 @@ nsAbLDAPDirFactory::GetDirectories(const</span>
<a href="#l17.4"></a><span id="l17.4"> </span>
<a href="#l17.5"></a><span id="l17.5">   nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l17.6"></a><span id="l17.6">   if (Substring(aURI, 0, 5).EqualsLiteral(&quot;ldap:&quot;) ||</span>
<a href="#l17.7"></a><span id="l17.7">       Substring(aURI, 0, 6).EqualsLiteral(&quot;ldaps:&quot;)) {</span>
<a href="#l17.8"></a><span id="l17.8">     /*</span>
<a href="#l17.9"></a><span id="l17.9">      * If the URI starts with ldap: or ldaps:</span>
<a href="#l17.10"></a><span id="l17.10">      * then this directory is an LDAP directory.</span>
<a href="#l17.11"></a><span id="l17.11">      *</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-     * We don't want to use the ldap:// or ldaps:// URI </span>
<a href="#l17.13"></a><span id="l17.13" class="difflineminus">-     * as the URI because the ldap:// or ldaps:// URI </span>
<a href="#l17.14"></a><span id="l17.14" class="difflineplus">+     * We don't want to use the ldap:// or ldaps:// URI</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineplus">+     * as the URI because the ldap:// or ldaps:// URI</span>
<a href="#l17.16"></a><span id="l17.16">      * will contain the hostname, basedn, port, etc.</span>
<a href="#l17.17"></a><span id="l17.17">      * so if those attributes changed, we'll run into the</span>
<a href="#l17.18"></a><span id="l17.18">      * the same problem that we hit with changing username / hostname</span>
<a href="#l17.19"></a><span id="l17.19">      * for mail servers.  To solve this problem, we add an extra</span>
<a href="#l17.20"></a><span id="l17.20">      * level of indirection.  The URI that we generate</span>
<a href="#l17.21"></a><span id="l17.21">      * (the bridge URI) will be moz-abldapdirectory://&lt;prefName&gt;</span>
<a href="#l17.22"></a><span id="l17.22">      * and when we need the hostname, basedn, port, etc,</span>
<a href="#l17.23"></a><span id="l17.23">      * we'll use the &lt;prefName&gt; to get the necessary prefs.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPDirectory.cpp</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPDirectory.cpp</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -78,17 +78,17 @@ NS_IMETHODIMP nsAbLDAPDirectory::Init(co</span>
<a href="#l18.4"></a><span id="l18.4">   return nsAbDirProperty::Init(aURI);</span>
<a href="#l18.5"></a><span id="l18.5"> }</span>
<a href="#l18.6"></a><span id="l18.6"> </span>
<a href="#l18.7"></a><span id="l18.7"> nsresult nsAbLDAPDirectory::Initiate()</span>
<a href="#l18.8"></a><span id="l18.8"> {</span>
<a href="#l18.9"></a><span id="l18.9">   return NS_OK;</span>
<a href="#l18.10"></a><span id="l18.10"> }</span>
<a href="#l18.11"></a><span id="l18.11"> </span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-/* </span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+/*</span>
<a href="#l18.14"></a><span id="l18.14">  *</span>
<a href="#l18.15"></a><span id="l18.15">  * nsIAbDirectory methods</span>
<a href="#l18.16"></a><span id="l18.16">  *</span>
<a href="#l18.17"></a><span id="l18.17">  */</span>
<a href="#l18.18"></a><span id="l18.18"> </span>
<a href="#l18.19"></a><span id="l18.19"> NS_IMETHODIMP nsAbLDAPDirectory::GetURI(nsACString &amp;aURI)</span>
<a href="#l18.20"></a><span id="l18.20"> {</span>
<a href="#l18.21"></a><span id="l18.21">   if (mURI.IsEmpty())</span>
<a href="#l18.22"></a><span id="l18.22" class="difflineat">@@ -101,38 +101,38 @@ NS_IMETHODIMP nsAbLDAPDirectory::GetURI(</span>
<a href="#l18.23"></a><span id="l18.23"> NS_IMETHODIMP nsAbLDAPDirectory::GetChildNodes(nsISimpleEnumerator* *aResult)</span>
<a href="#l18.24"></a><span id="l18.24"> {</span>
<a href="#l18.25"></a><span id="l18.25">   return NS_NewEmptyEnumerator(aResult);</span>
<a href="#l18.26"></a><span id="l18.26"> }</span>
<a href="#l18.27"></a><span id="l18.27"> </span>
<a href="#l18.28"></a><span id="l18.28"> NS_IMETHODIMP nsAbLDAPDirectory::GetChildCards(nsISimpleEnumerator** result)</span>
<a href="#l18.29"></a><span id="l18.29"> {</span>
<a href="#l18.30"></a><span id="l18.30">     nsresult rv;</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineminus">-    </span>
<a href="#l18.32"></a><span id="l18.32" class="difflineminus">-    // when offline, we need to get the child cards for the local, replicated mdb directory </span>
<a href="#l18.33"></a><span id="l18.33" class="difflineplus">+</span>
<a href="#l18.34"></a><span id="l18.34" class="difflineplus">+    // when offline, we need to get the child cards for the local, replicated mdb directory</span>
<a href="#l18.35"></a><span id="l18.35">     bool offline;</span>
<a href="#l18.36"></a><span id="l18.36">     nsCOMPtr &lt;nsIIOService&gt; ioService =</span>
<a href="#l18.37"></a><span id="l18.37">       mozilla::services::GetIOService();</span>
<a href="#l18.38"></a><span id="l18.38">     NS_ENSURE_TRUE(ioService, NS_ERROR_UNEXPECTED);</span>
<a href="#l18.39"></a><span id="l18.39">     rv = ioService-&gt;GetOffline(&amp;offline);</span>
<a href="#l18.40"></a><span id="l18.40">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l18.41"></a><span id="l18.41" class="difflineminus">-    </span>
<a href="#l18.42"></a><span id="l18.42" class="difflineplus">+</span>
<a href="#l18.43"></a><span id="l18.43">     if (offline) {</span>
<a href="#l18.44"></a><span id="l18.44">       nsCString fileName;</span>
<a href="#l18.45"></a><span id="l18.45">       rv = GetReplicationFileName(fileName);</span>
<a href="#l18.46"></a><span id="l18.46">       NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l18.47"></a><span id="l18.47" class="difflineminus">-      </span>
<a href="#l18.48"></a><span id="l18.48" class="difflineplus">+</span>
<a href="#l18.49"></a><span id="l18.49">       // if there is no fileName, bail out now.</span>
<a href="#l18.50"></a><span id="l18.50">       if (fileName.IsEmpty())</span>
<a href="#l18.51"></a><span id="l18.51">         return NS_OK;</span>
<a href="#l18.52"></a><span id="l18.52"> </span>
<a href="#l18.53"></a><span id="l18.53">       // perform the same query, but on the local directory</span>
<a href="#l18.54"></a><span id="l18.54">       nsAutoCString localDirectoryURI(NS_LITERAL_CSTRING(kMDBDirectoryRoot));</span>
<a href="#l18.55"></a><span id="l18.55">       localDirectoryURI.Append(fileName);</span>
<a href="#l18.56"></a><span id="l18.56" class="difflineminus">-      if (mIsQueryURI) </span>
<a href="#l18.57"></a><span id="l18.57" class="difflineplus">+      if (mIsQueryURI)</span>
<a href="#l18.58"></a><span id="l18.58">       {</span>
<a href="#l18.59"></a><span id="l18.59">         localDirectoryURI.Append('?');</span>
<a href="#l18.60"></a><span id="l18.60">         localDirectoryURI.Append(mQueryString);</span>
<a href="#l18.61"></a><span id="l18.61">       }</span>
<a href="#l18.62"></a><span id="l18.62"> </span>
<a href="#l18.63"></a><span id="l18.63">       nsCOMPtr&lt;nsIAbManager&gt; abManager(do_GetService(NS_ABMANAGER_CONTRACTID,</span>
<a href="#l18.64"></a><span id="l18.64">                                                      &amp;rv));</span>
<a href="#l18.65"></a><span id="l18.65">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.66"></a><span id="l18.66" class="difflineat">@@ -188,20 +188,20 @@ NS_IMETHODIMP nsAbLDAPDirectory::GetLDAP</span>
<a href="#l18.67"></a><span id="l18.67">   nsAutoCString URI;</span>
<a href="#l18.68"></a><span id="l18.68">   nsresult rv = GetStringValue(&quot;uri&quot;, EmptyCString(), URI);</span>
<a href="#l18.69"></a><span id="l18.69">   if (NS_FAILED(rv) || URI.IsEmpty())</span>
<a href="#l18.70"></a><span id="l18.70">   {</span>
<a href="#l18.71"></a><span id="l18.71">     /*</span>
<a href="#l18.72"></a><span id="l18.72">      * A recent change in Mozilla now means that the LDAP Address Book</span>
<a href="#l18.73"></a><span id="l18.73">      * URI is based on the unique preference name value i.e.</span>
<a href="#l18.74"></a><span id="l18.74">      * [moz-abldapdirectory://prefName]</span>
<a href="#l18.75"></a><span id="l18.75" class="difflineminus">-     * Prior to this valid change it was based on the actual uri i.e. </span>
<a href="#l18.76"></a><span id="l18.76" class="difflineplus">+     * Prior to this valid change it was based on the actual uri i.e.</span>
<a href="#l18.77"></a><span id="l18.77">      * [moz-abldapdirectory://host:port/basedn]</span>
<a href="#l18.78"></a><span id="l18.78" class="difflineminus">-     * Basing the resource on the prefName allows these attributes to </span>
<a href="#l18.79"></a><span id="l18.79" class="difflineminus">-     * change. </span>
<a href="#l18.80"></a><span id="l18.80" class="difflineplus">+     * Basing the resource on the prefName allows these attributes to</span>
<a href="#l18.81"></a><span id="l18.81" class="difflineplus">+     * change.</span>
<a href="#l18.82"></a><span id="l18.82">      *</span>
<a href="#l18.83"></a><span id="l18.83">      * But the uri value was also the means by which third-party</span>
<a href="#l18.84"></a><span id="l18.84">      * products could integrate with Mozilla's LDAP Address Books</span>
<a href="#l18.85"></a><span id="l18.85">      * without necessarily having an entry in the preferences file</span>
<a href="#l18.86"></a><span id="l18.86">      * or more importantly needing to be able to change the</span>
<a href="#l18.87"></a><span id="l18.87">      * preferences entries. Thus to set the URI Spec now, it is</span>
<a href="#l18.88"></a><span id="l18.88">      * only necessary to read the uri pref entry, while in the</span>
<a href="#l18.89"></a><span id="l18.89">      * case where it is not a preference, we need to replace the</span>
<a href="#l18.90"></a><span id="l18.90" class="difflineat">@@ -258,17 +258,17 @@ NS_IMETHODIMP nsAbLDAPDirectory::SetLDAP</span>
<a href="#l18.91"></a><span id="l18.91">       &quot;IsSecure&quot;,</span>
<a href="#l18.92"></a><span id="l18.92">       (newIsNotSecure ? u&quot;true&quot; : u&quot;false&quot;),</span>
<a href="#l18.93"></a><span id="l18.93">       (newIsNotSecure ? u&quot;false&quot; : u&quot;true&quot;));</span>
<a href="#l18.94"></a><span id="l18.94">   }</span>
<a href="#l18.95"></a><span id="l18.95"> </span>
<a href="#l18.96"></a><span id="l18.96">   return NS_OK;</span>
<a href="#l18.97"></a><span id="l18.97"> }</span>
<a href="#l18.98"></a><span id="l18.98"> </span>
<a href="#l18.99"></a><span id="l18.99" class="difflineminus">-/* </span>
<a href="#l18.100"></a><span id="l18.100" class="difflineplus">+/*</span>
<a href="#l18.101"></a><span id="l18.101">  *</span>
<a href="#l18.102"></a><span id="l18.102">  * nsIAbDirectorySearch methods</span>
<a href="#l18.103"></a><span id="l18.103">  *</span>
<a href="#l18.104"></a><span id="l18.104">  */</span>
<a href="#l18.105"></a><span id="l18.105"> </span>
<a href="#l18.106"></a><span id="l18.106"> NS_IMETHODIMP nsAbLDAPDirectory::StartSearch ()</span>
<a href="#l18.107"></a><span id="l18.107"> {</span>
<a href="#l18.108"></a><span id="l18.108">     if (!mIsQueryURI || mQueryString.IsEmpty())</span>
<a href="#l18.109"></a><span id="l18.109" class="difflineat">@@ -324,17 +324,17 @@ NS_IMETHODIMP nsAbLDAPDirectory::StartSe</span>
<a href="#l18.110"></a><span id="l18.110">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.111"></a><span id="l18.111"> </span>
<a href="#l18.112"></a><span id="l18.112">     // Enter lock</span>
<a href="#l18.113"></a><span id="l18.113">     MutexAutoLock lock(mLock);</span>
<a href="#l18.114"></a><span id="l18.114">     mPerformingQuery = true;</span>
<a href="#l18.115"></a><span id="l18.115">     mCache.Clear();</span>
<a href="#l18.116"></a><span id="l18.116"> </span>
<a href="#l18.117"></a><span id="l18.117">     return rv;</span>
<a href="#l18.118"></a><span id="l18.118" class="difflineminus">-}  </span>
<a href="#l18.119"></a><span id="l18.119" class="difflineplus">+}</span>
<a href="#l18.120"></a><span id="l18.120"> </span>
<a href="#l18.121"></a><span id="l18.121"> NS_IMETHODIMP nsAbLDAPDirectory::StopSearch ()</span>
<a href="#l18.122"></a><span id="l18.122"> {</span>
<a href="#l18.123"></a><span id="l18.123">   nsresult rv = Initiate();</span>
<a href="#l18.124"></a><span id="l18.124">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.125"></a><span id="l18.125"> </span>
<a href="#l18.126"></a><span id="l18.126">   // Enter lock</span>
<a href="#l18.127"></a><span id="l18.127">   {</span>
<a href="#l18.128"></a><span id="l18.128" class="difflineat">@@ -346,17 +346,17 @@ NS_IMETHODIMP nsAbLDAPDirectory::StopSea</span>
<a href="#l18.129"></a><span id="l18.129">   // Exit lock</span>
<a href="#l18.130"></a><span id="l18.130"> </span>
<a href="#l18.131"></a><span id="l18.131">   if (!mDirectoryQuery)</span>
<a href="#l18.132"></a><span id="l18.132">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l18.133"></a><span id="l18.133"> </span>
<a href="#l18.134"></a><span id="l18.134">   return mDirectoryQuery-&gt;StopQuery(mContext);</span>
<a href="#l18.135"></a><span id="l18.135"> }</span>
<a href="#l18.136"></a><span id="l18.136"> </span>
<a href="#l18.137"></a><span id="l18.137" class="difflineminus">-/* </span>
<a href="#l18.138"></a><span id="l18.138" class="difflineplus">+/*</span>
<a href="#l18.139"></a><span id="l18.139">  *</span>
<a href="#l18.140"></a><span id="l18.140">  * nsAbDirSearchListenerContext methods</span>
<a href="#l18.141"></a><span id="l18.141">  *</span>
<a href="#l18.142"></a><span id="l18.142">  */</span>
<a href="#l18.143"></a><span id="l18.143"> NS_IMETHODIMP nsAbLDAPDirectory::OnSearchFinished(int32_t aResult, const nsAString &amp;aErrorMessage)</span>
<a href="#l18.144"></a><span id="l18.144"> {</span>
<a href="#l18.145"></a><span id="l18.145">   nsresult rv = Initiate();</span>
<a href="#l18.146"></a><span id="l18.146">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.147"></a><span id="l18.147" class="difflineat">@@ -432,17 +432,17 @@ NS_IMETHODIMP nsAbLDAPDirectory::GetIsRe</span>
<a href="#l18.148"></a><span id="l18.148"> </span>
<a href="#l18.149"></a><span id="l18.149"> NS_IMETHODIMP nsAbLDAPDirectory::GetIsSecure(bool *aIsSecure)</span>
<a href="#l18.150"></a><span id="l18.150"> {</span>
<a href="#l18.151"></a><span id="l18.151">   NS_ENSURE_ARG_POINTER(aIsSecure);</span>
<a href="#l18.152"></a><span id="l18.152"> </span>
<a href="#l18.153"></a><span id="l18.153">   nsAutoCString URI;</span>
<a href="#l18.154"></a><span id="l18.154">   nsresult rv = GetStringValue(&quot;uri&quot;, EmptyCString(), URI);</span>
<a href="#l18.155"></a><span id="l18.155">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.156"></a><span id="l18.156" class="difflineminus">-  </span>
<a href="#l18.157"></a><span id="l18.157" class="difflineplus">+</span>
<a href="#l18.158"></a><span id="l18.158">   // to determine if this is a secure directory, check if the uri is ldaps:// or not</span>
<a href="#l18.159"></a><span id="l18.159">   *aIsSecure = (strncmp(URI.get(), &quot;ldaps:&quot;, 6) == 0);</span>
<a href="#l18.160"></a><span id="l18.160">   return NS_OK;</span>
<a href="#l18.161"></a><span id="l18.161"> }</span>
<a href="#l18.162"></a><span id="l18.162"> </span>
<a href="#l18.163"></a><span id="l18.163"> NS_IMETHODIMP nsAbLDAPDirectory::UseForAutocomplete(const nsACString &amp;aIdentityKey,</span>
<a href="#l18.164"></a><span id="l18.164">                                                     bool *aResult)</span>
<a href="#l18.165"></a><span id="l18.165"> {</span>
<a href="#l18.166"></a><span id="l18.166" class="difflineat">@@ -642,19 +642,19 @@ NS_IMETHODIMP nsAbLDAPDirectory::GetData</span>
<a href="#l18.167"></a><span id="l18.167"> NS_IMETHODIMP nsAbLDAPDirectory::SetDataVersion(const nsACString &amp;aDataVersion)</span>
<a href="#l18.168"></a><span id="l18.168"> {</span>
<a href="#l18.169"></a><span id="l18.169">   return SetStringValue(&quot;dataVersion&quot;, aDataVersion);</span>
<a href="#l18.170"></a><span id="l18.170"> }</span>
<a href="#l18.171"></a><span id="l18.171"> </span>
<a href="#l18.172"></a><span id="l18.172"> NS_IMETHODIMP nsAbLDAPDirectory::GetAttributeMap(nsIAbLDAPAttributeMap **aAttributeMap)</span>
<a href="#l18.173"></a><span id="l18.173"> {</span>
<a href="#l18.174"></a><span id="l18.174">   NS_ENSURE_ARG_POINTER(aAttributeMap);</span>
<a href="#l18.175"></a><span id="l18.175" class="difflineminus">-  </span>
<a href="#l18.176"></a><span id="l18.176" class="difflineplus">+</span>
<a href="#l18.177"></a><span id="l18.177">   nsresult rv;</span>
<a href="#l18.178"></a><span id="l18.178" class="difflineminus">-  nsCOMPtr&lt;nsIAbLDAPAttributeMapService&gt; mapSvc = </span>
<a href="#l18.179"></a><span id="l18.179" class="difflineplus">+  nsCOMPtr&lt;nsIAbLDAPAttributeMapService&gt; mapSvc =</span>
<a href="#l18.180"></a><span id="l18.180">     do_GetService(&quot;@mozilla.org/addressbook/ldap-attribute-map-service;1&quot;, &amp;rv);</span>
<a href="#l18.181"></a><span id="l18.181">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.182"></a><span id="l18.182"> </span>
<a href="#l18.183"></a><span id="l18.183">   return mapSvc-&gt;GetMapForPrefBranch(m_DirPrefId, aAttributeMap);</span>
<a href="#l18.184"></a><span id="l18.184"> }</span>
<a href="#l18.185"></a><span id="l18.185"> </span>
<a href="#l18.186"></a><span id="l18.186"> NS_IMETHODIMP nsAbLDAPDirectory::GetReplicationFile(nsIFile **aResult)</span>
<a href="#l18.187"></a><span id="l18.187"> {</span>
<a href="#l18.188"></a><span id="l18.188" class="difflineat">@@ -697,17 +697,17 @@ NS_IMETHODIMP nsAbLDAPDirectory::GetRepl</span>
<a href="#l18.189"></a><span id="l18.189">                            aResult);</span>
<a href="#l18.190"></a><span id="l18.190"> }</span>
<a href="#l18.191"></a><span id="l18.191"> </span>
<a href="#l18.192"></a><span id="l18.192"> NS_IMETHODIMP nsAbLDAPDirectory::AddCard(nsIAbCard *aUpdatedCard,</span>
<a href="#l18.193"></a><span id="l18.193">                                          nsIAbCard **aAddedCard)</span>
<a href="#l18.194"></a><span id="l18.194"> {</span>
<a href="#l18.195"></a><span id="l18.195">   NS_ENSURE_ARG_POINTER(aUpdatedCard);</span>
<a href="#l18.196"></a><span id="l18.196">   NS_ENSURE_ARG_POINTER(aAddedCard);</span>
<a href="#l18.197"></a><span id="l18.197" class="difflineminus">-  </span>
<a href="#l18.198"></a><span id="l18.198" class="difflineplus">+</span>
<a href="#l18.199"></a><span id="l18.199">   nsCOMPtr&lt;nsIAbLDAPAttributeMap&gt; attrMap;</span>
<a href="#l18.200"></a><span id="l18.200">   nsresult rv = GetAttributeMap(getter_AddRefs(attrMap));</span>
<a href="#l18.201"></a><span id="l18.201">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.202"></a><span id="l18.202"> </span>
<a href="#l18.203"></a><span id="l18.203">   // Create a new LDAP card</span>
<a href="#l18.204"></a><span id="l18.204">   nsCOMPtr&lt;nsIAbLDAPCard&gt; card =</span>
<a href="#l18.205"></a><span id="l18.205">     do_CreateInstance(NS_ABLDAPCARD_CONTRACTID, &amp;rv);</span>
<a href="#l18.206"></a><span id="l18.206">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.207"></a><span id="l18.207" class="difflineat">@@ -716,50 +716,50 @@ NS_IMETHODIMP nsAbLDAPDirectory::AddCard</span>
<a href="#l18.208"></a><span id="l18.208">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.209"></a><span id="l18.209"> </span>
<a href="#l18.210"></a><span id="l18.210">   // Copy over the card data</span>
<a href="#l18.211"></a><span id="l18.211">   nsCOMPtr&lt;nsIAbCard&gt; copyToCard = do_QueryInterface(card, &amp;rv);</span>
<a href="#l18.212"></a><span id="l18.212">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.213"></a><span id="l18.213"> </span>
<a href="#l18.214"></a><span id="l18.214">   rv = copyToCard-&gt;Copy(aUpdatedCard);</span>
<a href="#l18.215"></a><span id="l18.215">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.216"></a><span id="l18.216" class="difflineminus">-  </span>
<a href="#l18.217"></a><span id="l18.217" class="difflineplus">+</span>
<a href="#l18.218"></a><span id="l18.218">   // Retrieve preferences</span>
<a href="#l18.219"></a><span id="l18.219">   nsAutoCString prefString;</span>
<a href="#l18.220"></a><span id="l18.220">   rv = GetRdnAttributes(prefString);</span>
<a href="#l18.221"></a><span id="l18.221">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.222"></a><span id="l18.222"> </span>
<a href="#l18.223"></a><span id="l18.223">   CharPtrArrayGuard rdnAttrs;</span>
<a href="#l18.224"></a><span id="l18.224">   rv = SplitStringList(prefString, rdnAttrs.GetSizeAddr(),</span>
<a href="#l18.225"></a><span id="l18.225">     rdnAttrs.GetArrayAddr());</span>
<a href="#l18.226"></a><span id="l18.226">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.227"></a><span id="l18.227" class="difflineminus">-  </span>
<a href="#l18.228"></a><span id="l18.228" class="difflineplus">+</span>
<a href="#l18.229"></a><span id="l18.229">   rv = GetObjectClasses(prefString);</span>
<a href="#l18.230"></a><span id="l18.230">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.231"></a><span id="l18.231" class="difflineminus">-  </span>
<a href="#l18.232"></a><span id="l18.232" class="difflineplus">+</span>
<a href="#l18.233"></a><span id="l18.233">   CharPtrArrayGuard objClass;</span>
<a href="#l18.234"></a><span id="l18.234">   rv = SplitStringList(prefString, objClass.GetSizeAddr(),</span>
<a href="#l18.235"></a><span id="l18.235">     objClass.GetArrayAddr());</span>
<a href="#l18.236"></a><span id="l18.236">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.237"></a><span id="l18.237"> </span>
<a href="#l18.238"></a><span id="l18.238">   // Process updates</span>
<a href="#l18.239"></a><span id="l18.239">   nsCOMPtr&lt;nsIArray&gt; modArray;</span>
<a href="#l18.240"></a><span id="l18.240">   rv = card-&gt;GetLDAPMessageInfo(attrMap, objClass.GetSize(), objClass.GetArray(),</span>
<a href="#l18.241"></a><span id="l18.241">     nsILDAPModification::MOD_ADD, getter_AddRefs(modArray));</span>
<a href="#l18.242"></a><span id="l18.242">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.243"></a><span id="l18.243" class="difflineminus">-  </span>
<a href="#l18.244"></a><span id="l18.244" class="difflineplus">+</span>
<a href="#l18.245"></a><span id="l18.245">   // For new cards, the base DN is the search base DN</span>
<a href="#l18.246"></a><span id="l18.246">   nsCOMPtr&lt;nsILDAPURL&gt; currentUrl;</span>
<a href="#l18.247"></a><span id="l18.247">   rv = GetLDAPURL(getter_AddRefs(currentUrl));</span>
<a href="#l18.248"></a><span id="l18.248">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.249"></a><span id="l18.249"> </span>
<a href="#l18.250"></a><span id="l18.250">   nsAutoCString baseDN;</span>
<a href="#l18.251"></a><span id="l18.251">   rv = currentUrl-&gt;GetDn(baseDN);</span>
<a href="#l18.252"></a><span id="l18.252">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.253"></a><span id="l18.253" class="difflineminus">- </span>
<a href="#l18.254"></a><span id="l18.254" class="difflineplus">+</span>
<a href="#l18.255"></a><span id="l18.255">   // Calculate DN</span>
<a href="#l18.256"></a><span id="l18.256">   nsAutoCString cardDN;</span>
<a href="#l18.257"></a><span id="l18.257">   rv = card-&gt;BuildRdn(attrMap, rdnAttrs.GetSize(), rdnAttrs.GetArray(),</span>
<a href="#l18.258"></a><span id="l18.258">     cardDN);</span>
<a href="#l18.259"></a><span id="l18.259">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.260"></a><span id="l18.260">   cardDN.Append(',');</span>
<a href="#l18.261"></a><span id="l18.261">   cardDN.Append(baseDN);</span>
<a href="#l18.262"></a><span id="l18.262"> </span>
<a href="#l18.263"></a><span id="l18.263" class="difflineat">@@ -782,76 +782,76 @@ NS_IMETHODIMP nsAbLDAPDirectory::AddCard</span>
<a href="#l18.264"></a><span id="l18.264"> NS_IMETHODIMP nsAbLDAPDirectory::DeleteCards(nsIArray *aCards)</span>
<a href="#l18.265"></a><span id="l18.265"> {</span>
<a href="#l18.266"></a><span id="l18.266">   uint32_t cardCount;</span>
<a href="#l18.267"></a><span id="l18.267">   uint32_t i;</span>
<a href="#l18.268"></a><span id="l18.268">   nsAutoCString cardDN;</span>
<a href="#l18.269"></a><span id="l18.269"> </span>
<a href="#l18.270"></a><span id="l18.270">   nsresult rv = aCards-&gt;GetLength(&amp;cardCount);</span>
<a href="#l18.271"></a><span id="l18.271">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.272"></a><span id="l18.272" class="difflineminus">- </span>
<a href="#l18.273"></a><span id="l18.273" class="difflineplus">+</span>
<a href="#l18.274"></a><span id="l18.274">   for (i = 0; i &lt; cardCount; ++i)</span>
<a href="#l18.275"></a><span id="l18.275">   {</span>
<a href="#l18.276"></a><span id="l18.276">     nsCOMPtr&lt;nsIAbLDAPCard&gt; card(do_QueryElementAt(aCards, i, &amp;rv));</span>
<a href="#l18.277"></a><span id="l18.277">     if (NS_FAILED(rv))</span>
<a href="#l18.278"></a><span id="l18.278">     {</span>
<a href="#l18.279"></a><span id="l18.279">       NS_WARNING(&quot;Wrong type of card passed to nsAbLDAPDirectory::DeleteCards&quot;);</span>
<a href="#l18.280"></a><span id="l18.280">       break;</span>
<a href="#l18.281"></a><span id="l18.281">     }</span>
<a href="#l18.282"></a><span id="l18.282"> </span>
<a href="#l18.283"></a><span id="l18.283">     // Set up the search ldap url - this is mURL</span>
<a href="#l18.284"></a><span id="l18.284">     rv = Initiate();</span>
<a href="#l18.285"></a><span id="l18.285">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.286"></a><span id="l18.286" class="difflineminus">-    </span>
<a href="#l18.287"></a><span id="l18.287" class="difflineplus">+</span>
<a href="#l18.288"></a><span id="l18.288">     rv = card-&gt;GetDn(cardDN);</span>
<a href="#l18.289"></a><span id="l18.289">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.290"></a><span id="l18.290"> </span>
<a href="#l18.291"></a><span id="l18.291">     nsCOMPtr&lt;nsIAbCard&gt; realCard(do_QueryInterface(card));</span>
<a href="#l18.292"></a><span id="l18.292">     realCard-&gt;SetDirectoryId(EmptyCString());</span>
<a href="#l18.293"></a><span id="l18.293" class="difflineminus">-   </span>
<a href="#l18.294"></a><span id="l18.294" class="difflineplus">+</span>
<a href="#l18.295"></a><span id="l18.295">     // Launch query</span>
<a href="#l18.296"></a><span id="l18.296">     rv = DoModify(this, nsILDAPModification::MOD_DELETE, cardDN, nullptr,</span>
<a href="#l18.297"></a><span id="l18.297">                   EmptyCString(), EmptyCString());</span>
<a href="#l18.298"></a><span id="l18.298">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.299"></a><span id="l18.299">   }</span>
<a href="#l18.300"></a><span id="l18.300"> </span>
<a href="#l18.301"></a><span id="l18.301">   return NS_OK;</span>
<a href="#l18.302"></a><span id="l18.302"> }</span>
<a href="#l18.303"></a><span id="l18.303"> </span>
<a href="#l18.304"></a><span id="l18.304"> NS_IMETHODIMP nsAbLDAPDirectory::ModifyCard(nsIAbCard *aUpdatedCard)</span>
<a href="#l18.305"></a><span id="l18.305"> {</span>
<a href="#l18.306"></a><span id="l18.306">   NS_ENSURE_ARG_POINTER(aUpdatedCard);</span>
<a href="#l18.307"></a><span id="l18.307" class="difflineminus">-  </span>
<a href="#l18.308"></a><span id="l18.308" class="difflineplus">+</span>
<a href="#l18.309"></a><span id="l18.309">   nsCOMPtr&lt;nsIAbLDAPAttributeMap&gt; attrMap;</span>
<a href="#l18.310"></a><span id="l18.310">   nsresult rv = GetAttributeMap(getter_AddRefs(attrMap));</span>
<a href="#l18.311"></a><span id="l18.311">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.312"></a><span id="l18.312"> </span>
<a href="#l18.313"></a><span id="l18.313">   // Get the LDAP card</span>
<a href="#l18.314"></a><span id="l18.314">   nsCOMPtr&lt;nsIAbLDAPCard&gt; card = do_QueryInterface(aUpdatedCard, &amp;rv);</span>
<a href="#l18.315"></a><span id="l18.315">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.316"></a><span id="l18.316"> </span>
<a href="#l18.317"></a><span id="l18.317">   rv = Initiate();</span>
<a href="#l18.318"></a><span id="l18.318">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.319"></a><span id="l18.319" class="difflineminus">-  </span>
<a href="#l18.320"></a><span id="l18.320" class="difflineplus">+</span>
<a href="#l18.321"></a><span id="l18.321">   // Retrieve preferences</span>
<a href="#l18.322"></a><span id="l18.322">   nsAutoCString prefString;</span>
<a href="#l18.323"></a><span id="l18.323">   rv = GetObjectClasses(prefString);</span>
<a href="#l18.324"></a><span id="l18.324">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.325"></a><span id="l18.325" class="difflineminus">-  </span>
<a href="#l18.326"></a><span id="l18.326" class="difflineplus">+</span>
<a href="#l18.327"></a><span id="l18.327">   CharPtrArrayGuard objClass;</span>
<a href="#l18.328"></a><span id="l18.328">   rv = SplitStringList(prefString, objClass.GetSizeAddr(),</span>
<a href="#l18.329"></a><span id="l18.329">     objClass.GetArrayAddr());</span>
<a href="#l18.330"></a><span id="l18.330">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.331"></a><span id="l18.331"> </span>
<a href="#l18.332"></a><span id="l18.332">   // Process updates</span>
<a href="#l18.333"></a><span id="l18.333">   nsCOMPtr&lt;nsIArray&gt; modArray;</span>
<a href="#l18.334"></a><span id="l18.334">   rv = card-&gt;GetLDAPMessageInfo(attrMap, objClass.GetSize(), objClass.GetArray(),</span>
<a href="#l18.335"></a><span id="l18.335">     nsILDAPModification::MOD_REPLACE, getter_AddRefs(modArray));</span>
<a href="#l18.336"></a><span id="l18.336">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.337"></a><span id="l18.337" class="difflineminus">-  </span>
<a href="#l18.338"></a><span id="l18.338" class="difflineplus">+</span>
<a href="#l18.339"></a><span id="l18.339">   // Get current DN</span>
<a href="#l18.340"></a><span id="l18.340">   nsAutoCString oldDN;</span>
<a href="#l18.341"></a><span id="l18.341">   rv = card-&gt;GetDn(oldDN);</span>
<a href="#l18.342"></a><span id="l18.342">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.343"></a><span id="l18.343"> </span>
<a href="#l18.344"></a><span id="l18.344">   nsCOMPtr&lt;nsILDAPService&gt; ldapSvc = do_GetService(</span>
<a href="#l18.345"></a><span id="l18.345">     &quot;@mozilla.org/network/ldap-service;1&quot;, &amp;rv);</span>
<a href="#l18.346"></a><span id="l18.346">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.347"></a><span id="l18.347" class="difflineat">@@ -864,33 +864,33 @@ NS_IMETHODIMP nsAbLDAPDirectory::ModifyC</span>
<a href="#l18.348"></a><span id="l18.348">                         rdnAttrs.GetSizeAddr(), rdnAttrs.GetArrayAddr());</span>
<a href="#l18.349"></a><span id="l18.349">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.350"></a><span id="l18.350"> </span>
<a href="#l18.351"></a><span id="l18.351">   // Calculate new RDN and check whether it has changed</span>
<a href="#l18.352"></a><span id="l18.352">   nsAutoCString newRDN;</span>
<a href="#l18.353"></a><span id="l18.353">   rv = card-&gt;BuildRdn(attrMap, rdnAttrs.GetSize(), rdnAttrs.GetArray(),</span>
<a href="#l18.354"></a><span id="l18.354">     newRDN);</span>
<a href="#l18.355"></a><span id="l18.355">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.356"></a><span id="l18.356" class="difflineminus">-      </span>
<a href="#l18.357"></a><span id="l18.357" class="difflineplus">+</span>
<a href="#l18.358"></a><span id="l18.358">   if (newRDN.Equals(oldRDN))</span>
<a href="#l18.359"></a><span id="l18.359">   {</span>
<a href="#l18.360"></a><span id="l18.360">     // Launch query</span>
<a href="#l18.361"></a><span id="l18.361">     rv = DoModify(this, nsILDAPModification::MOD_REPLACE, oldDN, modArray,</span>
<a href="#l18.362"></a><span id="l18.362">                   EmptyCString(), EmptyCString());</span>
<a href="#l18.363"></a><span id="l18.363">   }</span>
<a href="#l18.364"></a><span id="l18.364">   else</span>
<a href="#l18.365"></a><span id="l18.365">   {</span>
<a href="#l18.366"></a><span id="l18.366">     // Build and store the new DN</span>
<a href="#l18.367"></a><span id="l18.367">     nsAutoCString newDN(newRDN);</span>
<a href="#l18.368"></a><span id="l18.368">     newDN.Append(',');</span>
<a href="#l18.369"></a><span id="l18.369">     newDN.Append(baseDN);</span>
<a href="#l18.370"></a><span id="l18.370" class="difflineminus">-    </span>
<a href="#l18.371"></a><span id="l18.371" class="difflineplus">+</span>
<a href="#l18.372"></a><span id="l18.372">     rv = card-&gt;SetDn(newDN);</span>
<a href="#l18.373"></a><span id="l18.373">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.374"></a><span id="l18.374" class="difflineminus">-    </span>
<a href="#l18.375"></a><span id="l18.375" class="difflineplus">+</span>
<a href="#l18.376"></a><span id="l18.376">     // Launch query</span>
<a href="#l18.377"></a><span id="l18.377">     rv = DoModify(this, nsILDAPModification::MOD_REPLACE, oldDN, modArray,</span>
<a href="#l18.378"></a><span id="l18.378">                   newRDN, baseDN);</span>
<a href="#l18.379"></a><span id="l18.379">   }</span>
<a href="#l18.380"></a><span id="l18.380">   return rv;</span>
<a href="#l18.381"></a><span id="l18.381"> }</span>
<a href="#l18.382"></a><span id="l18.382"> </span>
<a href="#l18.383"></a><span id="l18.383"> NS_IMETHODIMP nsAbLDAPDirectory::GetRdnAttributes(nsACString &amp;aRdnAttributes)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPDirectoryModify.cpp</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPDirectoryModify.cpp</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -116,28 +116,28 @@ nsresult nsAbModifyLDAPMessageListener::</span>
<a href="#l19.4"></a><span id="l19.4"> NS_IMETHODIMP nsAbModifyLDAPMessageListener::OnLDAPMessage(nsILDAPMessage *aMessage)</span>
<a href="#l19.5"></a><span id="l19.5"> {</span>
<a href="#l19.6"></a><span id="l19.6">   nsresult rv = Initiate();</span>
<a href="#l19.7"></a><span id="l19.7">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.8"></a><span id="l19.8"> </span>
<a href="#l19.9"></a><span id="l19.9">   int32_t messageType;</span>
<a href="#l19.10"></a><span id="l19.10">   rv = aMessage-&gt;GetType(&amp;messageType);</span>
<a href="#l19.11"></a><span id="l19.11">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-  </span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+</span>
<a href="#l19.14"></a><span id="l19.14">   bool cancelOperation = false;</span>
<a href="#l19.15"></a><span id="l19.15"> </span>
<a href="#l19.16"></a><span id="l19.16">   // Enter lock</span>
<a href="#l19.17"></a><span id="l19.17">   {</span>
<a href="#l19.18"></a><span id="l19.18">     MutexAutoLock lock (mLock);</span>
<a href="#l19.19"></a><span id="l19.19"> </span>
<a href="#l19.20"></a><span id="l19.20">     if (mFinished)</span>
<a href="#l19.21"></a><span id="l19.21">       return NS_OK;</span>
<a href="#l19.22"></a><span id="l19.22"> </span>
<a href="#l19.23"></a><span id="l19.23">     // for these messages, no matter the outcome, we're done</span>
<a href="#l19.24"></a><span id="l19.24" class="difflineminus">-    if ((messageType == nsILDAPMessage::RES_ADD) || </span>
<a href="#l19.25"></a><span id="l19.25" class="difflineplus">+    if ((messageType == nsILDAPMessage::RES_ADD) ||</span>
<a href="#l19.26"></a><span id="l19.26">         (messageType == nsILDAPMessage::RES_DELETE) ||</span>
<a href="#l19.27"></a><span id="l19.27">         (messageType == nsILDAPMessage::RES_MODIFY))</span>
<a href="#l19.28"></a><span id="l19.28">       mFinished = true;</span>
<a href="#l19.29"></a><span id="l19.29">     else if (mCanceled)</span>
<a href="#l19.30"></a><span id="l19.30">     {</span>
<a href="#l19.31"></a><span id="l19.31">       mFinished = true;</span>
<a href="#l19.32"></a><span id="l19.32">       cancelOperation = true;</span>
<a href="#l19.33"></a><span id="l19.33">     }</span>
<a href="#l19.34"></a><span id="l19.34" class="difflineat">@@ -146,31 +146,31 @@ NS_IMETHODIMP nsAbModifyLDAPMessageListe</span>
<a href="#l19.35"></a><span id="l19.35"> </span>
<a href="#l19.36"></a><span id="l19.36">   //    nsCOMPtr&lt;nsIAbDirectoryQueryResult&gt; queryResult;</span>
<a href="#l19.37"></a><span id="l19.37">   if (!cancelOperation)</span>
<a href="#l19.38"></a><span id="l19.38">   {</span>
<a href="#l19.39"></a><span id="l19.39">     switch (messageType)</span>
<a href="#l19.40"></a><span id="l19.40">     {</span>
<a href="#l19.41"></a><span id="l19.41">     case nsILDAPMessage::RES_BIND:</span>
<a href="#l19.42"></a><span id="l19.42">       rv = OnLDAPMessageBind(aMessage);</span>
<a href="#l19.43"></a><span id="l19.43" class="difflineminus">-      if (NS_FAILED(rv)) </span>
<a href="#l19.44"></a><span id="l19.44" class="difflineplus">+      if (NS_FAILED(rv))</span>
<a href="#l19.45"></a><span id="l19.45">         // We know the bind failed and hence the message has an error, so we</span>
<a href="#l19.46"></a><span id="l19.46">         // can just call ModifyResult with the message and that'll sort it out</span>
<a href="#l19.47"></a><span id="l19.47">         // for us.</span>
<a href="#l19.48"></a><span id="l19.48">         rv = OnLDAPMessageModifyResult(aMessage);</span>
<a href="#l19.49"></a><span id="l19.49">       break;</span>
<a href="#l19.50"></a><span id="l19.50">     case nsILDAPMessage::RES_ADD:</span>
<a href="#l19.51"></a><span id="l19.51">     case nsILDAPMessage::RES_MODIFY:</span>
<a href="#l19.52"></a><span id="l19.52">     case nsILDAPMessage::RES_DELETE:</span>
<a href="#l19.53"></a><span id="l19.53">       rv = OnLDAPMessageModifyResult(aMessage);</span>
<a href="#l19.54"></a><span id="l19.54">       break;</span>
<a href="#l19.55"></a><span id="l19.55">     case nsILDAPMessage::RES_MODDN:</span>
<a href="#l19.56"></a><span id="l19.56">       mFlagRename = false;</span>
<a href="#l19.57"></a><span id="l19.57">       rv = OnLDAPMessageRenameResult(aMessage);</span>
<a href="#l19.58"></a><span id="l19.58" class="difflineminus">-      if (NS_FAILED(rv)) </span>
<a href="#l19.59"></a><span id="l19.59" class="difflineplus">+      if (NS_FAILED(rv))</span>
<a href="#l19.60"></a><span id="l19.60">         // Rename failed, so we stop here</span>
<a href="#l19.61"></a><span id="l19.61">         mFinished = true;</span>
<a href="#l19.62"></a><span id="l19.62">       break;</span>
<a href="#l19.63"></a><span id="l19.63">     default:</span>
<a href="#l19.64"></a><span id="l19.64">       break;</span>
<a href="#l19.65"></a><span id="l19.65">     }</span>
<a href="#l19.66"></a><span id="l19.66">   }</span>
<a href="#l19.67"></a><span id="l19.67">   else</span>
<a href="#l19.68"></a><span id="l19.68" class="difflineat">@@ -228,66 +228,66 @@ nsresult nsAbModifyLDAPMessageListener::</span>
<a href="#l19.69"></a><span id="l19.69">       return NS_ERROR_UNEXPECTED;</span>
<a href="#l19.70"></a><span id="l19.70">   }</span>
<a href="#l19.71"></a><span id="l19.71"> }</span>
<a href="#l19.72"></a><span id="l19.72"> </span>
<a href="#l19.73"></a><span id="l19.73"> nsresult nsAbModifyLDAPMessageListener::OnLDAPMessageModifyResult(nsILDAPMessage *aMessage)</span>
<a href="#l19.74"></a><span id="l19.74"> {</span>
<a href="#l19.75"></a><span id="l19.75">   nsresult rv;</span>
<a href="#l19.76"></a><span id="l19.76">   NS_ENSURE_ARG_POINTER(aMessage);</span>
<a href="#l19.77"></a><span id="l19.77" class="difflineminus">-  </span>
<a href="#l19.78"></a><span id="l19.78" class="difflineplus">+</span>
<a href="#l19.79"></a><span id="l19.79">   int32_t errCode;</span>
<a href="#l19.80"></a><span id="l19.80">   rv = aMessage-&gt;GetErrorCode(&amp;errCode);</span>
<a href="#l19.81"></a><span id="l19.81">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.82"></a><span id="l19.82" class="difflineminus">- </span>
<a href="#l19.83"></a><span id="l19.83" class="difflineplus">+</span>
<a href="#l19.84"></a><span id="l19.84">   if (errCode != nsILDAPErrors::SUCCESS)</span>
<a href="#l19.85"></a><span id="l19.85">   {</span>
<a href="#l19.86"></a><span id="l19.86">     nsAutoCString errMessage;</span>
<a href="#l19.87"></a><span id="l19.87">     rv = aMessage-&gt;GetErrorMessage(errMessage);</span>
<a href="#l19.88"></a><span id="l19.88">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.89"></a><span id="l19.89"> </span>
<a href="#l19.90"></a><span id="l19.90">     printf(&quot;LDAP modification failed (code: %i, message: %s)\n&quot;,</span>
<a href="#l19.91"></a><span id="l19.91">            errCode, errMessage.get());</span>
<a href="#l19.92"></a><span id="l19.92">     return NS_ERROR_FAILURE;</span>
<a href="#l19.93"></a><span id="l19.93">   }</span>
<a href="#l19.94"></a><span id="l19.94" class="difflineminus">-  </span>
<a href="#l19.95"></a><span id="l19.95" class="difflineplus">+</span>
<a href="#l19.96"></a><span id="l19.96">   printf(&quot;LDAP modification succeeded\n&quot;);</span>
<a href="#l19.97"></a><span id="l19.97">   return NS_OK;</span>
<a href="#l19.98"></a><span id="l19.98"> }</span>
<a href="#l19.99"></a><span id="l19.99"> </span>
<a href="#l19.100"></a><span id="l19.100"> nsresult nsAbModifyLDAPMessageListener::OnLDAPMessageRenameResult(nsILDAPMessage *aMessage)</span>
<a href="#l19.101"></a><span id="l19.101"> {</span>
<a href="#l19.102"></a><span id="l19.102">   nsresult rv;</span>
<a href="#l19.103"></a><span id="l19.103">   NS_ENSURE_ARG_POINTER(aMessage);</span>
<a href="#l19.104"></a><span id="l19.104" class="difflineminus">-  </span>
<a href="#l19.105"></a><span id="l19.105" class="difflineplus">+</span>
<a href="#l19.106"></a><span id="l19.106">   int32_t errCode;</span>
<a href="#l19.107"></a><span id="l19.107">   rv = aMessage-&gt;GetErrorCode(&amp;errCode);</span>
<a href="#l19.108"></a><span id="l19.108">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.109"></a><span id="l19.109"> </span>
<a href="#l19.110"></a><span id="l19.110">   if (errCode != nsILDAPErrors::SUCCESS)</span>
<a href="#l19.111"></a><span id="l19.111">   {</span>
<a href="#l19.112"></a><span id="l19.112">     nsAutoCString errMessage;</span>
<a href="#l19.113"></a><span id="l19.113">     rv = aMessage-&gt;GetErrorMessage(errMessage);</span>
<a href="#l19.114"></a><span id="l19.114">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.115"></a><span id="l19.115"> </span>
<a href="#l19.116"></a><span id="l19.116">     printf(&quot;LDAP rename failed (code: %i, message: %s)\n&quot;,</span>
<a href="#l19.117"></a><span id="l19.117">            errCode, errMessage.get());</span>
<a href="#l19.118"></a><span id="l19.118">     return NS_ERROR_FAILURE;</span>
<a href="#l19.119"></a><span id="l19.119">   }</span>
<a href="#l19.120"></a><span id="l19.120" class="difflineminus">-  </span>
<a href="#l19.121"></a><span id="l19.121" class="difflineplus">+</span>
<a href="#l19.122"></a><span id="l19.122">   // Rename succeeded, now update the card DN and</span>
<a href="#l19.123"></a><span id="l19.123">   // process the main task</span>
<a href="#l19.124"></a><span id="l19.124">   mCardDN.Assign(mNewRDN);</span>
<a href="#l19.125"></a><span id="l19.125">   mCardDN.Append(',');</span>
<a href="#l19.126"></a><span id="l19.126">   mCardDN.Append(mNewBaseDN);</span>
<a href="#l19.127"></a><span id="l19.127" class="difflineminus">-     </span>
<a href="#l19.128"></a><span id="l19.128" class="difflineplus">+</span>
<a href="#l19.129"></a><span id="l19.129">   printf(&quot;LDAP rename succeeded\n&quot;);</span>
<a href="#l19.130"></a><span id="l19.130">   return DoTask();</span>
<a href="#l19.131"></a><span id="l19.131"> }</span>
<a href="#l19.132"></a><span id="l19.132" class="difflineminus">- </span>
<a href="#l19.133"></a><span id="l19.133" class="difflineplus">+</span>
<a href="#l19.134"></a><span id="l19.134"> nsAbLDAPDirectoryModify::nsAbLDAPDirectoryModify()</span>
<a href="#l19.135"></a><span id="l19.135"> {</span>
<a href="#l19.136"></a><span id="l19.136"> }</span>
<a href="#l19.137"></a><span id="l19.137"> </span>
<a href="#l19.138"></a><span id="l19.138"> nsAbLDAPDirectoryModify::~nsAbLDAPDirectoryModify()</span>
<a href="#l19.139"></a><span id="l19.139"> {</span>
<a href="#l19.140"></a><span id="l19.140"> }</span>
<a href="#l19.141"></a><span id="l19.141"> </span>
<a href="#l19.142"></a><span id="l19.142" class="difflineat">@@ -305,41 +305,41 @@ nsresult nsAbLDAPDirectoryModify::DoModi</span>
<a href="#l19.143"></a><span id="l19.143">        updateType == nsILDAPModification::MOD_REPLACE))</span>
<a href="#l19.144"></a><span id="l19.144">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l19.145"></a><span id="l19.145"> </span>
<a href="#l19.146"></a><span id="l19.146">   nsresult rv;</span>
<a href="#l19.147"></a><span id="l19.147"> </span>
<a href="#l19.148"></a><span id="l19.148">   // it's an error if we don't have a dn</span>
<a href="#l19.149"></a><span id="l19.149">   if (cardDN.IsEmpty())</span>
<a href="#l19.150"></a><span id="l19.150">     return NS_ERROR_INVALID_ARG;</span>
<a href="#l19.151"></a><span id="l19.151" class="difflineminus">- </span>
<a href="#l19.152"></a><span id="l19.152" class="difflineplus">+</span>
<a href="#l19.153"></a><span id="l19.153">   nsCOMPtr&lt;nsILDAPURL&gt; currentUrl;</span>
<a href="#l19.154"></a><span id="l19.154">   rv = directory-&gt;GetLDAPURL(getter_AddRefs(currentUrl));</span>
<a href="#l19.155"></a><span id="l19.155">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.156"></a><span id="l19.156"> </span>
<a href="#l19.157"></a><span id="l19.157">   // Get the ldap connection</span>
<a href="#l19.158"></a><span id="l19.158">   nsCOMPtr&lt;nsILDAPConnection&gt; ldapConnection =</span>
<a href="#l19.159"></a><span id="l19.159">     do_CreateInstance(NS_LDAPCONNECTION_CONTRACTID, &amp;rv);</span>
<a href="#l19.160"></a><span id="l19.160" class="difflineminus">-  </span>
<a href="#l19.161"></a><span id="l19.161" class="difflineplus">+</span>
<a href="#l19.162"></a><span id="l19.162">   nsCOMPtr&lt;nsIMutableArray&gt; serverSearchControls;</span>
<a href="#l19.163"></a><span id="l19.163">   rv = directory-&gt;GetSearchServerControls(getter_AddRefs(serverSearchControls));</span>
<a href="#l19.164"></a><span id="l19.164">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.165"></a><span id="l19.165"> </span>
<a href="#l19.166"></a><span id="l19.166">   nsCOMPtr&lt;nsIMutableArray&gt; clientSearchControls;</span>
<a href="#l19.167"></a><span id="l19.167">   rv = directory-&gt;GetSearchClientControls(getter_AddRefs(clientSearchControls));</span>
<a href="#l19.168"></a><span id="l19.168">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.169"></a><span id="l19.169"> </span>
<a href="#l19.170"></a><span id="l19.170">   /*</span>
<a href="#l19.171"></a><span id="l19.171">   // XXX we need to fix how this all works - specifically, see the first patch</span>
<a href="#l19.172"></a><span id="l19.172">   // on bug 124553 for how the query equivalent did this</span>
<a href="#l19.173"></a><span id="l19.173">   // too soon? Do we need a new listener?</span>
<a href="#l19.174"></a><span id="l19.174">   if (alreadyInitialized)</span>
<a href="#l19.175"></a><span id="l19.175">   {</span>
<a href="#l19.176"></a><span id="l19.176">     nsAbQueryLDAPMessageListener *msgListener =</span>
<a href="#l19.177"></a><span id="l19.177" class="difflineminus">-      NS_STATIC_CAST(nsAbQueryLDAPMessageListener *, </span>
<a href="#l19.178"></a><span id="l19.178" class="difflineplus">+      NS_STATIC_CAST(nsAbQueryLDAPMessageListener *,</span>
<a href="#l19.179"></a><span id="l19.179">                      NS_STATIC_CAST(nsILDAPMessageListener *, mListener.get()));</span>
<a href="#l19.180"></a><span id="l19.180">     if (msgListener)</span>
<a href="#l19.181"></a><span id="l19.181">       {</span>
<a href="#l19.182"></a><span id="l19.182">         msgListener-&gt;mUrl = url;</span>
<a href="#l19.183"></a><span id="l19.183">         return msgListener-&gt;DoSearch();</span>
<a href="#l19.184"></a><span id="l19.184">       }</span>
<a href="#l19.185"></a><span id="l19.185">   }*/</span>
<a href="#l19.186"></a><span id="l19.186"> </span>
<a href="#l19.187"></a><span id="l19.187" class="difflineat">@@ -358,15 +358,15 @@ nsresult nsAbLDAPDirectoryModify::DoModi</span>
<a href="#l19.188"></a><span id="l19.188">                                       currentUrl,</span>
<a href="#l19.189"></a><span id="l19.189">                                       ldapConnection,</span>
<a href="#l19.190"></a><span id="l19.190">                                       serverSearchControls,</span>
<a href="#l19.191"></a><span id="l19.191">                                       clientSearchControls,</span>
<a href="#l19.192"></a><span id="l19.192">                                       login,</span>
<a href="#l19.193"></a><span id="l19.193">                                       0);</span>
<a href="#l19.194"></a><span id="l19.194">   if (_messageListener == NULL)</span>
<a href="#l19.195"></a><span id="l19.195">     return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l19.196"></a><span id="l19.196" class="difflineminus">-  </span>
<a href="#l19.197"></a><span id="l19.197" class="difflineplus">+</span>
<a href="#l19.198"></a><span id="l19.198">   // Now lets initialize the LDAP connection properly. We'll kick</span>
<a href="#l19.199"></a><span id="l19.199">   // off the bind operation in the callback function, |OnLDAPInit()|.</span>
<a href="#l19.200"></a><span id="l19.200">   return ldapConnection-&gt;Init(currentUrl, login,</span>
<a href="#l19.201"></a><span id="l19.201">                               _messageListener, nullptr, protocolVersion);</span>
<a href="#l19.202"></a><span id="l19.202"> }</span>
<a href="#l19.203"></a><span id="l19.203"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.cpp</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.cpp</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -155,17 +155,17 @@ NS_IMETHODIMP nsAbQueryLDAPMessageListen</span>
<a href="#l20.4"></a><span id="l20.4">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l20.5"></a><span id="l20.5"> </span>
<a href="#l20.6"></a><span id="l20.6">   if (!cancelOperation)</span>
<a href="#l20.7"></a><span id="l20.7">   {</span>
<a href="#l20.8"></a><span id="l20.8">     switch (messageType)</span>
<a href="#l20.9"></a><span id="l20.9">     {</span>
<a href="#l20.10"></a><span id="l20.10">     case nsILDAPMessage::RES_BIND:</span>
<a href="#l20.11"></a><span id="l20.11">       rv = OnLDAPMessageBind(aMessage);</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-      if (NS_FAILED(rv)) </span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+      if (NS_FAILED(rv))</span>
<a href="#l20.14"></a><span id="l20.14">         // We know the bind failed and hence the message has an error, so we</span>
<a href="#l20.15"></a><span id="l20.15">         // can just call SearchResult with the message and that'll sort it out</span>
<a href="#l20.16"></a><span id="l20.16">         // for us.</span>
<a href="#l20.17"></a><span id="l20.17">         rv = OnLDAPMessageSearchResult(aMessage);</span>
<a href="#l20.18"></a><span id="l20.18">       break;</span>
<a href="#l20.19"></a><span id="l20.19">     case nsILDAPMessage::RES_SEARCH_ENTRY:</span>
<a href="#l20.20"></a><span id="l20.20">       if (!mFinished &amp;&amp; !mWaitingForPrevQueryToFinish)</span>
<a href="#l20.21"></a><span id="l20.21">         rv = OnLDAPMessageSearchEntry(aMessage);</span>
<a href="#l20.22"></a><span id="l20.22" class="difflineat">@@ -261,32 +261,32 @@ nsresult nsAbQueryLDAPMessageListener::O</span>
<a href="#l20.23"></a><span id="l20.23">   nsCOMPtr&lt;nsIAbLDAPAttributeMap&gt; map = do_QueryInterface(iSupportsMap, &amp;rv);</span>
<a href="#l20.24"></a><span id="l20.24">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.25"></a><span id="l20.25"> </span>
<a href="#l20.26"></a><span id="l20.26">   nsCOMPtr&lt;nsIAbCard&gt; card = do_CreateInstance(NS_ABLDAPCARD_CONTRACTID, &amp;rv);</span>
<a href="#l20.27"></a><span id="l20.27">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.28"></a><span id="l20.28"> </span>
<a href="#l20.29"></a><span id="l20.29">   rv = map-&gt;SetCardPropertiesFromLDAPMessage(aMessage, card);</span>
<a href="#l20.30"></a><span id="l20.30">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.31"></a><span id="l20.31" class="difflineminus">-  </span>
<a href="#l20.32"></a><span id="l20.32" class="difflineplus">+</span>
<a href="#l20.33"></a><span id="l20.33">   nsCOMPtr&lt;nsIAbLDAPCard&gt; ldapCard = do_QueryInterface(card, &amp;rv);</span>
<a href="#l20.34"></a><span id="l20.34">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.35"></a><span id="l20.35"> </span>
<a href="#l20.36"></a><span id="l20.36">   rv = ldapCard-&gt;SetMetaProperties(aMessage);</span>
<a href="#l20.37"></a><span id="l20.37">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.38"></a><span id="l20.38"> </span>
<a href="#l20.39"></a><span id="l20.39">   return mResultListener-&gt;OnQueryFoundCard(card);</span>
<a href="#l20.40"></a><span id="l20.40"> }</span>
<a href="#l20.41"></a><span id="l20.41"> </span>
<a href="#l20.42"></a><span id="l20.42"> nsresult nsAbQueryLDAPMessageListener::OnLDAPMessageSearchResult(nsILDAPMessage *aMessage)</span>
<a href="#l20.43"></a><span id="l20.43"> {</span>
<a href="#l20.44"></a><span id="l20.44">   int32_t errorCode;</span>
<a href="#l20.45"></a><span id="l20.45">   nsresult rv = aMessage-&gt;GetErrorCode(&amp;errorCode);</span>
<a href="#l20.46"></a><span id="l20.46">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.47"></a><span id="l20.47" class="difflineminus">-    </span>
<a href="#l20.48"></a><span id="l20.48" class="difflineplus">+</span>
<a href="#l20.49"></a><span id="l20.49">   if (errorCode == nsILDAPErrors::SUCCESS || errorCode == nsILDAPErrors::SIZELIMIT_EXCEEDED)</span>
<a href="#l20.50"></a><span id="l20.50">     return mResultListener-&gt;OnQueryResult(</span>
<a href="#l20.51"></a><span id="l20.51">       nsIAbDirectoryQueryResultListener::queryResultComplete, 0);</span>
<a href="#l20.52"></a><span id="l20.52"> </span>
<a href="#l20.53"></a><span id="l20.53">   return mResultListener-&gt;OnQueryResult(</span>
<a href="#l20.54"></a><span id="l20.54">       nsIAbDirectoryQueryResultListener::queryResultError, errorCode);</span>
<a href="#l20.55"></a><span id="l20.55"> }</span>
<a href="#l20.56"></a><span id="l20.56"> </span>
<a href="#l20.57"></a><span id="l20.57" class="difflineat">@@ -320,41 +320,41 @@ NS_IMETHODIMP nsAbLDAPDirectoryQuery::Do</span>
<a href="#l20.58"></a><span id="l20.58">   nsresult rv = StopQuery(0);</span>
<a href="#l20.59"></a><span id="l20.59">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.60"></a><span id="l20.60"> </span>
<a href="#l20.61"></a><span id="l20.61">   mInitialized = true;</span>
<a href="#l20.62"></a><span id="l20.62"> </span>
<a href="#l20.63"></a><span id="l20.63">   // Get the current directory as LDAP specific</span>
<a href="#l20.64"></a><span id="l20.64">   nsCOMPtr&lt;nsIAbLDAPDirectory&gt; directory(do_QueryInterface(aDirectory, &amp;rv));</span>
<a href="#l20.65"></a><span id="l20.65">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.66"></a><span id="l20.66" class="difflineminus">-  </span>
<a href="#l20.67"></a><span id="l20.67" class="difflineplus">+</span>
<a href="#l20.68"></a><span id="l20.68">   // We also need the current URL to check as well...</span>
<a href="#l20.69"></a><span id="l20.69">   nsCOMPtr&lt;nsILDAPURL&gt; currentUrl;</span>
<a href="#l20.70"></a><span id="l20.70">   rv = directory-&gt;GetLDAPURL(getter_AddRefs(currentUrl));</span>
<a href="#l20.71"></a><span id="l20.71">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.72"></a><span id="l20.72" class="difflineminus">-  </span>
<a href="#l20.73"></a><span id="l20.73" class="difflineplus">+</span>
<a href="#l20.74"></a><span id="l20.74">   nsAutoCString login;</span>
<a href="#l20.75"></a><span id="l20.75">   rv = directory-&gt;GetAuthDn(login);</span>
<a href="#l20.76"></a><span id="l20.76">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.77"></a><span id="l20.77" class="difflineminus">-  </span>
<a href="#l20.78"></a><span id="l20.78" class="difflineplus">+</span>
<a href="#l20.79"></a><span id="l20.79">   nsAutoCString saslMechanism;</span>
<a href="#l20.80"></a><span id="l20.80">   rv = directory-&gt;GetSaslMechanism(saslMechanism);</span>
<a href="#l20.81"></a><span id="l20.81">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.82"></a><span id="l20.82" class="difflineminus">-  </span>
<a href="#l20.83"></a><span id="l20.83" class="difflineplus">+</span>
<a href="#l20.84"></a><span id="l20.84">   uint32_t protocolVersion;</span>
<a href="#l20.85"></a><span id="l20.85">   rv = directory-&gt;GetProtocolVersion(&amp;protocolVersion);</span>
<a href="#l20.86"></a><span id="l20.86">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.87"></a><span id="l20.87" class="difflineminus">-  </span>
<a href="#l20.88"></a><span id="l20.88" class="difflineplus">+</span>
<a href="#l20.89"></a><span id="l20.89">   // To do:</span>
<a href="#l20.90"></a><span id="l20.90">   // Ensure query is stopped</span>
<a href="#l20.91"></a><span id="l20.91">   // If connection params have changed re-create connection</span>
<a href="#l20.92"></a><span id="l20.92">   // else reuse existing connection</span>
<a href="#l20.93"></a><span id="l20.93" class="difflineminus">-  </span>
<a href="#l20.94"></a><span id="l20.94" class="difflineplus">+</span>
<a href="#l20.95"></a><span id="l20.95">   bool redoConnection = false;</span>
<a href="#l20.96"></a><span id="l20.96" class="difflineminus">-  </span>
<a href="#l20.97"></a><span id="l20.97" class="difflineplus">+</span>
<a href="#l20.98"></a><span id="l20.98">   if (!mConnection || !mDirectoryUrl)</span>
<a href="#l20.99"></a><span id="l20.99">   {</span>
<a href="#l20.100"></a><span id="l20.100">     mDirectoryUrl = currentUrl;</span>
<a href="#l20.101"></a><span id="l20.101">     aDirectory-&gt;GetUuid(mDirectoryId);</span>
<a href="#l20.102"></a><span id="l20.102">     mCurrentLogin = login;</span>
<a href="#l20.103"></a><span id="l20.103">     mCurrentMechanism = saslMechanism;</span>
<a href="#l20.104"></a><span id="l20.104">     mCurrentProtocolVersion = protocolVersion;</span>
<a href="#l20.105"></a><span id="l20.105">     redoConnection = true;</span>
<a href="#l20.106"></a><span id="l20.106" class="difflineat">@@ -417,17 +417,17 @@ NS_IMETHODIMP nsAbLDAPDirectoryQuery::Do</span>
<a href="#l20.107"></a><span id="l20.107">   // nsAbLDAPCard::SetMetaProperties</span>
<a href="#l20.108"></a><span id="l20.108">   rv = url-&gt;AddAttribute(NS_LITERAL_CSTRING(&quot;objectClass&quot;));</span>
<a href="#l20.109"></a><span id="l20.109"> </span>
<a href="#l20.110"></a><span id="l20.110">   nsAutoCString filter;</span>
<a href="#l20.111"></a><span id="l20.111"> </span>
<a href="#l20.112"></a><span id="l20.112">   // Get filter from arguments if set:</span>
<a href="#l20.113"></a><span id="l20.113">   rv = aArguments-&gt;GetFilter(filter);</span>
<a href="#l20.114"></a><span id="l20.114">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.115"></a><span id="l20.115" class="difflineminus">-  </span>
<a href="#l20.116"></a><span id="l20.116" class="difflineplus">+</span>
<a href="#l20.117"></a><span id="l20.117">   if (filter.IsEmpty()) {</span>
<a href="#l20.118"></a><span id="l20.118">     // Get the filter</span>
<a href="#l20.119"></a><span id="l20.119">     nsCOMPtr&lt;nsISupports&gt; supportsExpression;</span>
<a href="#l20.120"></a><span id="l20.120">     rv = aArguments-&gt;GetExpression(getter_AddRefs(supportsExpression));</span>
<a href="#l20.121"></a><span id="l20.121">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.122"></a><span id="l20.122"> </span>
<a href="#l20.123"></a><span id="l20.123">     nsCOMPtr&lt;nsIAbBooleanExpression&gt; expression(do_QueryInterface(supportsExpression, &amp;rv));</span>
<a href="#l20.124"></a><span id="l20.124"> </span>
<a href="#l20.125"></a><span id="l20.125" class="difflineat">@@ -435,39 +435,39 @@ NS_IMETHODIMP nsAbLDAPDirectoryQuery::Do</span>
<a href="#l20.126"></a><span id="l20.126">     // query</span>
<a href="#l20.127"></a><span id="l20.127">     rv = nsAbBoolExprToLDAPFilter::Convert(map, expression, filter);</span>
<a href="#l20.128"></a><span id="l20.128">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.129"></a><span id="l20.129">   }</span>
<a href="#l20.130"></a><span id="l20.130"> </span>
<a href="#l20.131"></a><span id="l20.131">   /*</span>
<a href="#l20.132"></a><span id="l20.132">    * Mozilla itself cannot arrive here with a blank filter</span>
<a href="#l20.133"></a><span id="l20.133">    * as the nsAbLDAPDirectory::StartSearch() disallows it.</span>
<a href="#l20.134"></a><span id="l20.134" class="difflineminus">-   * But 3rd party LDAP query integration with Mozilla begins </span>
<a href="#l20.135"></a><span id="l20.135" class="difflineplus">+   * But 3rd party LDAP query integration with Mozilla begins</span>
<a href="#l20.136"></a><span id="l20.136">    * in this method.</span>
<a href="#l20.137"></a><span id="l20.137">    *</span>
<a href="#l20.138"></a><span id="l20.138">    * Default the filter string if blank, otherwise it gets</span>
<a href="#l20.139"></a><span id="l20.139" class="difflineminus">-   * set to (objectclass=*) which returns everything. Set </span>
<a href="#l20.140"></a><span id="l20.140" class="difflineminus">-   * the default to (objectclass=inetorgperson) as this </span>
<a href="#l20.141"></a><span id="l20.141" class="difflineminus">-   * is the most appropriate default objectclass which is </span>
<a href="#l20.142"></a><span id="l20.142" class="difflineminus">-   * central to the makeup of the mozilla ldap address book </span>
<a href="#l20.143"></a><span id="l20.143" class="difflineplus">+   * set to (objectclass=*) which returns everything. Set</span>
<a href="#l20.144"></a><span id="l20.144" class="difflineplus">+   * the default to (objectclass=inetorgperson) as this</span>
<a href="#l20.145"></a><span id="l20.145" class="difflineplus">+   * is the most appropriate default objectclass which is</span>
<a href="#l20.146"></a><span id="l20.146" class="difflineplus">+   * central to the makeup of the mozilla ldap address book</span>
<a href="#l20.147"></a><span id="l20.147">    * entries.</span>
<a href="#l20.148"></a><span id="l20.148">    */</span>
<a href="#l20.149"></a><span id="l20.149">   if (filter.IsEmpty())</span>
<a href="#l20.150"></a><span id="l20.150">   {</span>
<a href="#l20.151"></a><span id="l20.151">     filter.AssignLiteral(&quot;(objectclass=inetorgperson)&quot;);</span>
<a href="#l20.152"></a><span id="l20.152">   }</span>
<a href="#l20.153"></a><span id="l20.153"> </span>
<a href="#l20.154"></a><span id="l20.154">   // get the directoryFilter from the directory url and merge it with the user's</span>
<a href="#l20.155"></a><span id="l20.155">   // search filter</span>
<a href="#l20.156"></a><span id="l20.156">   nsAutoCString urlFilter;</span>
<a href="#l20.157"></a><span id="l20.157">   rv = mDirectoryUrl-&gt;GetFilter(urlFilter);</span>
<a href="#l20.158"></a><span id="l20.158" class="difflineminus">-  </span>
<a href="#l20.159"></a><span id="l20.159" class="difflineplus">+</span>
<a href="#l20.160"></a><span id="l20.160">   // if urlFilter is unset (or set to the default &quot;objectclass=*&quot;), there's</span>
<a href="#l20.161"></a><span id="l20.161">   // no need to AND in an empty search term, so leave prefix and suffix empty</span>
<a href="#l20.162"></a><span id="l20.162" class="difflineminus">-  </span>
<a href="#l20.163"></a><span id="l20.163" class="difflineplus">+</span>
<a href="#l20.164"></a><span id="l20.164">   nsAutoCString searchFilter;</span>
<a href="#l20.165"></a><span id="l20.165">   if (urlFilter.Length() &amp;&amp; !urlFilter.EqualsLiteral(&quot;(objectclass=*)&quot;))</span>
<a href="#l20.166"></a><span id="l20.166">   {</span>
<a href="#l20.167"></a><span id="l20.167">     // if urlFilter isn't parenthesized, we need to add in parens so that</span>
<a href="#l20.168"></a><span id="l20.168">     // the filter works as a term to &amp;</span>
<a href="#l20.169"></a><span id="l20.169">     //</span>
<a href="#l20.170"></a><span id="l20.170">     if (urlFilter[0] != '(')</span>
<a href="#l20.171"></a><span id="l20.171">     {</span>
<a href="#l20.172"></a><span id="l20.172" class="difflineat">@@ -475,57 +475,57 @@ NS_IMETHODIMP nsAbLDAPDirectoryQuery::Do</span>
<a href="#l20.173"></a><span id="l20.173">       searchFilter.Append(urlFilter);</span>
<a href="#l20.174"></a><span id="l20.174">       searchFilter.Append(')');</span>
<a href="#l20.175"></a><span id="l20.175">     }</span>
<a href="#l20.176"></a><span id="l20.176">     else</span>
<a href="#l20.177"></a><span id="l20.177">     {</span>
<a href="#l20.178"></a><span id="l20.178">       searchFilter.AssignLiteral(&quot;(&amp;&quot;);</span>
<a href="#l20.179"></a><span id="l20.179">       searchFilter.Append(urlFilter);</span>
<a href="#l20.180"></a><span id="l20.180">     }</span>
<a href="#l20.181"></a><span id="l20.181" class="difflineminus">-  </span>
<a href="#l20.182"></a><span id="l20.182" class="difflineplus">+</span>
<a href="#l20.183"></a><span id="l20.183">     searchFilter += filter;</span>
<a href="#l20.184"></a><span id="l20.184">     searchFilter += ')';</span>
<a href="#l20.185"></a><span id="l20.185" class="difflineminus">-  } </span>
<a href="#l20.186"></a><span id="l20.186" class="difflineplus">+  }</span>
<a href="#l20.187"></a><span id="l20.187">   else</span>
<a href="#l20.188"></a><span id="l20.188">     searchFilter = filter;</span>
<a href="#l20.189"></a><span id="l20.189"> </span>
<a href="#l20.190"></a><span id="l20.190">   rv = url-&gt;SetFilter(searchFilter);</span>
<a href="#l20.191"></a><span id="l20.191">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.192"></a><span id="l20.192"> </span>
<a href="#l20.193"></a><span id="l20.193">   // Now formulate the search string</span>
<a href="#l20.194"></a><span id="l20.194" class="difflineminus">-  </span>
<a href="#l20.195"></a><span id="l20.195" class="difflineplus">+</span>
<a href="#l20.196"></a><span id="l20.196">   // Get the scope</span>
<a href="#l20.197"></a><span id="l20.197">   int32_t scope;</span>
<a href="#l20.198"></a><span id="l20.198">   bool doSubDirectories;</span>
<a href="#l20.199"></a><span id="l20.199">   rv = aArguments-&gt;GetQuerySubDirectories (&amp;doSubDirectories);</span>
<a href="#l20.200"></a><span id="l20.200">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.201"></a><span id="l20.201">   scope = doSubDirectories ? nsILDAPURL::SCOPE_SUBTREE :</span>
<a href="#l20.202"></a><span id="l20.202">                              nsILDAPURL::SCOPE_ONELEVEL;</span>
<a href="#l20.203"></a><span id="l20.203"> </span>
<a href="#l20.204"></a><span id="l20.204">   rv = url-&gt;SetScope(scope);</span>
<a href="#l20.205"></a><span id="l20.205">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.206"></a><span id="l20.206"> </span>
<a href="#l20.207"></a><span id="l20.207">   // too soon? Do we need a new listener?</span>
<a href="#l20.208"></a><span id="l20.208">   // If we already have a connection, and don't need to re-do it, give it the</span>
<a href="#l20.209"></a><span id="l20.209">   // new search details and go for it...</span>
<a href="#l20.210"></a><span id="l20.210">   if (!redoConnection)</span>
<a href="#l20.211"></a><span id="l20.211">   {</span>
<a href="#l20.212"></a><span id="l20.212" class="difflineminus">-    nsAbQueryLDAPMessageListener *msgListener = </span>
<a href="#l20.213"></a><span id="l20.213" class="difflineplus">+    nsAbQueryLDAPMessageListener *msgListener =</span>
<a href="#l20.214"></a><span id="l20.214">       static_cast&lt;nsAbQueryLDAPMessageListener *&gt;(static_cast&lt;nsILDAPMessageListener *&gt;(mListener.get()));</span>
<a href="#l20.215"></a><span id="l20.215">     if (msgListener)</span>
<a href="#l20.216"></a><span id="l20.216">     {</span>
<a href="#l20.217"></a><span id="l20.217">       // Ensure the urls are correct</span>
<a href="#l20.218"></a><span id="l20.218">       msgListener-&gt;mDirectoryUrl = mDirectoryUrl;</span>
<a href="#l20.219"></a><span id="l20.219">       msgListener-&gt;mSearchUrl = url;</span>
<a href="#l20.220"></a><span id="l20.220">       // Also ensure we set the correct result limit</span>
<a href="#l20.221"></a><span id="l20.221">       msgListener-&gt;mResultLimit = aResultLimit;</span>
<a href="#l20.222"></a><span id="l20.222">       return msgListener-&gt;DoTask();</span>
<a href="#l20.223"></a><span id="l20.223">     }</span>
<a href="#l20.224"></a><span id="l20.224">   }</span>
<a href="#l20.225"></a><span id="l20.225" class="difflineminus">-  </span>
<a href="#l20.226"></a><span id="l20.226" class="difflineplus">+</span>
<a href="#l20.227"></a><span id="l20.227">   nsCOMPtr&lt;nsIAbLDAPDirectory&gt; abLDAPDir = do_QueryInterface(aDirectory, &amp;rv);</span>
<a href="#l20.228"></a><span id="l20.228">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.229"></a><span id="l20.229"> </span>
<a href="#l20.230"></a><span id="l20.230">   nsCOMPtr&lt;nsIMutableArray&gt; serverSearchControls;</span>
<a href="#l20.231"></a><span id="l20.231">   rv = abLDAPDir-&gt;GetSearchServerControls(getter_AddRefs(serverSearchControls));</span>
<a href="#l20.232"></a><span id="l20.232">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.233"></a><span id="l20.233"> </span>
<a href="#l20.234"></a><span id="l20.234">   nsCOMPtr&lt;nsIMutableArray&gt; clientSearchControls;</span>
<a href="#l20.235"></a><span id="l20.235" class="difflineat">@@ -544,17 +544,17 @@ NS_IMETHODIMP nsAbLDAPDirectoryQuery::Do</span>
<a href="#l20.236"></a><span id="l20.236">   nsAbQueryLDAPMessageListener* _messageListener =</span>
<a href="#l20.237"></a><span id="l20.237">     new nsAbQueryLDAPMessageListener(resultListener, mDirectoryUrl, url,</span>
<a href="#l20.238"></a><span id="l20.238">                                      mConnection, aArguments,</span>
<a href="#l20.239"></a><span id="l20.239">                                      serverSearchControls, clientSearchControls,</span>
<a href="#l20.240"></a><span id="l20.240">                                      mCurrentLogin, mCurrentMechanism,</span>
<a href="#l20.241"></a><span id="l20.241">                                      aResultLimit, aTimeOut);</span>
<a href="#l20.242"></a><span id="l20.242">   if (_messageListener == NULL)</span>
<a href="#l20.243"></a><span id="l20.243">     return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l20.244"></a><span id="l20.244" class="difflineminus">-  </span>
<a href="#l20.245"></a><span id="l20.245" class="difflineplus">+</span>
<a href="#l20.246"></a><span id="l20.246">   mListener = _messageListener;</span>
<a href="#l20.247"></a><span id="l20.247">   *_retval = 1;</span>
<a href="#l20.248"></a><span id="l20.248"> </span>
<a href="#l20.249"></a><span id="l20.249">   // Now lets initialize the LDAP connection properly. We'll kick</span>
<a href="#l20.250"></a><span id="l20.250">   // off the bind operation in the callback function, |OnLDAPInit()|.</span>
<a href="#l20.251"></a><span id="l20.251">   rv = mConnection-&gt;Init(mDirectoryUrl, mCurrentLogin,</span>
<a href="#l20.252"></a><span id="l20.252">                          mListener, nullptr, mCurrentProtocolVersion);</span>
<a href="#l20.253"></a><span id="l20.253">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.254"></a><span id="l20.254" class="difflineat">@@ -565,17 +565,17 @@ NS_IMETHODIMP nsAbLDAPDirectoryQuery::Do</span>
<a href="#l20.255"></a><span id="l20.255"> /* void stopQuery (in long contextID); */</span>
<a href="#l20.256"></a><span id="l20.256"> NS_IMETHODIMP nsAbLDAPDirectoryQuery::StopQuery(int32_t contextID)</span>
<a href="#l20.257"></a><span id="l20.257"> {</span>
<a href="#l20.258"></a><span id="l20.258">   mInitialized = true;</span>
<a href="#l20.259"></a><span id="l20.259"> </span>
<a href="#l20.260"></a><span id="l20.260">   if (!mListener)</span>
<a href="#l20.261"></a><span id="l20.261">     return NS_OK;</span>
<a href="#l20.262"></a><span id="l20.262"> </span>
<a href="#l20.263"></a><span id="l20.263" class="difflineminus">-  nsAbQueryLDAPMessageListener *listener = </span>
<a href="#l20.264"></a><span id="l20.264" class="difflineplus">+  nsAbQueryLDAPMessageListener *listener =</span>
<a href="#l20.265"></a><span id="l20.265">     static_cast&lt;nsAbQueryLDAPMessageListener *&gt;(static_cast&lt;nsILDAPMessageListener *&gt;(mListener.get()));</span>
<a href="#l20.266"></a><span id="l20.266">   if (listener)</span>
<a href="#l20.267"></a><span id="l20.267">     return listener-&gt;Cancel();</span>
<a href="#l20.268"></a><span id="l20.268"> </span>
<a href="#l20.269"></a><span id="l20.269">   return NS_OK;</span>
<a href="#l20.270"></a><span id="l20.270"> }</span>
<a href="#l20.271"></a><span id="l20.271"> </span>
<a href="#l20.272"></a><span id="l20.272"> NS_IMETHODIMP nsAbLDAPDirectoryQuery::OnQueryFoundCard(nsIAbCard *aCard)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPReplicationData.cpp</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPReplicationData.cpp</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -9,17 +9,17 @@</span>
<a href="#l21.4"></a><span id="l21.4"> #include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l21.5"></a><span id="l21.5"> #include &quot;nsAbUtils.h&quot;</span>
<a href="#l21.6"></a><span id="l21.6"> #include &quot;nsAbLDAPReplicationQuery.h&quot;</span>
<a href="#l21.7"></a><span id="l21.7"> #include &quot;nsILDAPErrors.h&quot;</span>
<a href="#l21.8"></a><span id="l21.8"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l21.9"></a><span id="l21.9"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l21.10"></a><span id="l21.10"> </span>
<a href="#l21.11"></a><span id="l21.11"> // once bug # 101252 gets fixed, this should be reverted back to be non threadsafe</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-// implementation is not really thread safe since each object should exist </span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+// implementation is not really thread safe since each object should exist</span>
<a href="#l21.14"></a><span id="l21.14"> // independently along with its related independent nsAbLDAPReplicationQuery object.</span>
<a href="#l21.15"></a><span id="l21.15"> NS_IMPL_ISUPPORTS(nsAbLDAPProcessReplicationData, nsIAbLDAPProcessReplicationData, nsILDAPMessageListener)</span>
<a href="#l21.16"></a><span id="l21.16"> </span>
<a href="#l21.17"></a><span id="l21.17"> nsAbLDAPProcessReplicationData::nsAbLDAPProcessReplicationData() :</span>
<a href="#l21.18"></a><span id="l21.18">   nsAbLDAPListenerBase(),</span>
<a href="#l21.19"></a><span id="l21.19">   mState(kIdle),</span>
<a href="#l21.20"></a><span id="l21.20">   mProtocol(-1),</span>
<a href="#l21.21"></a><span id="l21.21">   mCount(0),</span>
<a href="#l21.22"></a><span id="l21.22" class="difflineat">@@ -60,40 +60,40 @@ NS_IMETHODIMP nsAbLDAPProcessReplication</span>
<a href="#l21.23"></a><span id="l21.23">     return rv;</span>
<a href="#l21.24"></a><span id="l21.24">   }</span>
<a href="#l21.25"></a><span id="l21.25"> </span>
<a href="#l21.26"></a><span id="l21.26">   rv = mDirectory-&gt;GetAuthDn(mLogin);</span>
<a href="#l21.27"></a><span id="l21.27">   if (NS_FAILED(rv)) {</span>
<a href="#l21.28"></a><span id="l21.28">     mQuery = nullptr;</span>
<a href="#l21.29"></a><span id="l21.29">     return rv;</span>
<a href="#l21.30"></a><span id="l21.30">   }</span>
<a href="#l21.31"></a><span id="l21.31" class="difflineminus">-  </span>
<a href="#l21.32"></a><span id="l21.32" class="difflineplus">+</span>
<a href="#l21.33"></a><span id="l21.33">   rv = mDirectory-&gt;GetSaslMechanism(mSaslMechanism);</span>
<a href="#l21.34"></a><span id="l21.34">   if (NS_FAILED(rv)) {</span>
<a href="#l21.35"></a><span id="l21.35">     mQuery = nullptr;</span>
<a href="#l21.36"></a><span id="l21.36">     return rv;</span>
<a href="#l21.37"></a><span id="l21.37">   }</span>
<a href="#l21.38"></a><span id="l21.38"> </span>
<a href="#l21.39"></a><span id="l21.39">   mInitialized = true;</span>
<a href="#l21.40"></a><span id="l21.40"> </span>
<a href="#l21.41"></a><span id="l21.41">   return rv;</span>
<a href="#l21.42"></a><span id="l21.42"> }</span>
<a href="#l21.43"></a><span id="l21.43"> </span>
<a href="#l21.44"></a><span id="l21.44" class="difflineminus">-NS_IMETHODIMP nsAbLDAPProcessReplicationData::GetReplicationState(int32_t *aReplicationState) </span>
<a href="#l21.45"></a><span id="l21.45" class="difflineplus">+NS_IMETHODIMP nsAbLDAPProcessReplicationData::GetReplicationState(int32_t *aReplicationState)</span>
<a href="#l21.46"></a><span id="l21.46"> {</span>
<a href="#l21.47"></a><span id="l21.47">     NS_ENSURE_ARG_POINTER(aReplicationState);</span>
<a href="#l21.48"></a><span id="l21.48" class="difflineminus">-    *aReplicationState = mState; </span>
<a href="#l21.49"></a><span id="l21.49" class="difflineminus">-    return NS_OK; </span>
<a href="#l21.50"></a><span id="l21.50" class="difflineplus">+    *aReplicationState = mState;</span>
<a href="#l21.51"></a><span id="l21.51" class="difflineplus">+    return NS_OK;</span>
<a href="#l21.52"></a><span id="l21.52"> }</span>
<a href="#l21.53"></a><span id="l21.53"> </span>
<a href="#l21.54"></a><span id="l21.54" class="difflineminus">-NS_IMETHODIMP nsAbLDAPProcessReplicationData::GetProtocolUsed(int32_t *aProtocolUsed) </span>
<a href="#l21.55"></a><span id="l21.55" class="difflineplus">+NS_IMETHODIMP nsAbLDAPProcessReplicationData::GetProtocolUsed(int32_t *aProtocolUsed)</span>
<a href="#l21.56"></a><span id="l21.56"> {</span>
<a href="#l21.57"></a><span id="l21.57">     NS_ENSURE_ARG_POINTER(aProtocolUsed);</span>
<a href="#l21.58"></a><span id="l21.58" class="difflineminus">-    *aProtocolUsed = mProtocol; </span>
<a href="#l21.59"></a><span id="l21.59" class="difflineminus">-    return NS_OK; </span>
<a href="#l21.60"></a><span id="l21.60" class="difflineplus">+    *aProtocolUsed = mProtocol;</span>
<a href="#l21.61"></a><span id="l21.61" class="difflineplus">+    return NS_OK;</span>
<a href="#l21.62"></a><span id="l21.62"> }</span>
<a href="#l21.63"></a><span id="l21.63"> </span>
<a href="#l21.64"></a><span id="l21.64"> NS_IMETHODIMP nsAbLDAPProcessReplicationData::OnLDAPMessage(nsILDAPMessage *aMessage)</span>
<a href="#l21.65"></a><span id="l21.65"> {</span>
<a href="#l21.66"></a><span id="l21.66">   NS_ENSURE_ARG_POINTER(aMessage);</span>
<a href="#l21.67"></a><span id="l21.67"> </span>
<a href="#l21.68"></a><span id="l21.68">   if (!mInitialized)</span>
<a href="#l21.69"></a><span id="l21.69">     return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l21.70"></a><span id="l21.70" class="difflineat">@@ -220,17 +220,17 @@ void nsAbLDAPProcessReplicationData::Ini</span>
<a href="#l21.71"></a><span id="l21.71">   Done(false);</span>
<a href="#l21.72"></a><span id="l21.72"> }</span>
<a href="#l21.73"></a><span id="l21.73"> </span>
<a href="#l21.74"></a><span id="l21.74"> nsresult nsAbLDAPProcessReplicationData::OnLDAPSearchEntry(nsILDAPMessage *aMessage)</span>
<a href="#l21.75"></a><span id="l21.75"> {</span>
<a href="#l21.76"></a><span id="l21.76">     NS_ENSURE_ARG_POINTER(aMessage);</span>
<a href="#l21.77"></a><span id="l21.77">     if (!mInitialized)</span>
<a href="#l21.78"></a><span id="l21.78">         return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l21.79"></a><span id="l21.79" class="difflineminus">-    // since this runs on the main thread and is single threaded, this will </span>
<a href="#l21.80"></a><span id="l21.80" class="difflineplus">+    // since this runs on the main thread and is single threaded, this will</span>
<a href="#l21.81"></a><span id="l21.81">     // take care of entries returned by LDAP Connection thread after Abort.</span>
<a href="#l21.82"></a><span id="l21.82">     if (!mReplicationDB || !mDBOpen)</span>
<a href="#l21.83"></a><span id="l21.83">         return NS_ERROR_FAILURE;</span>
<a href="#l21.84"></a><span id="l21.84"> </span>
<a href="#l21.85"></a><span id="l21.85">     nsresult rv = NS_OK;</span>
<a href="#l21.86"></a><span id="l21.86"> </span>
<a href="#l21.87"></a><span id="l21.87">     // Although we would may naturally create an nsIAbLDAPCard here, we don't</span>
<a href="#l21.88"></a><span id="l21.88">     // need to as we are writing this straight to the database, so just create</span>
<a href="#l21.89"></a><span id="l21.89" class="difflineat">@@ -265,17 +265,17 @@ nsresult nsAbLDAPProcessReplicationData:</span>
<a href="#l21.90"></a><span id="l21.90">         newCard-&gt;SetPropertyAsAUTF8String(&quot;_DN&quot;, authDN);</span>
<a href="#l21.91"></a><span id="l21.91">     }</span>
<a href="#l21.92"></a><span id="l21.92"> </span>
<a href="#l21.93"></a><span id="l21.93">     rv = mReplicationDB-&gt;EditCard(newCard, false, nullptr);</span>
<a href="#l21.94"></a><span id="l21.94">     if(NS_FAILED(rv)) {</span>
<a href="#l21.95"></a><span id="l21.95">         Abort();</span>
<a href="#l21.96"></a><span id="l21.96">         return rv;</span>
<a href="#l21.97"></a><span id="l21.97">     }</span>
<a href="#l21.98"></a><span id="l21.98" class="difflineminus">-    </span>
<a href="#l21.99"></a><span id="l21.99" class="difflineplus">+</span>
<a href="#l21.100"></a><span id="l21.100"> </span>
<a href="#l21.101"></a><span id="l21.101">     mCount ++;</span>
<a href="#l21.102"></a><span id="l21.102"> </span>
<a href="#l21.103"></a><span id="l21.103">     if (mListener &amp;&amp; !(mCount % 10)) // inform the listener every 10 entries</span>
<a href="#l21.104"></a><span id="l21.104">     {</span>
<a href="#l21.105"></a><span id="l21.105">         mListener-&gt;OnProgressChange(nullptr,nullptr,mCount, -1, mCount, -1);</span>
<a href="#l21.106"></a><span id="l21.106">         // in case if the LDAP Connection thread is starved and causes problem</span>
<a href="#l21.107"></a><span id="l21.107">         // uncomment this one and try.</span>
<a href="#l21.108"></a><span id="l21.108" class="difflineat">@@ -288,17 +288,17 @@ nsresult nsAbLDAPProcessReplicationData:</span>
<a href="#l21.109"></a><span id="l21.109"> </span>
<a href="#l21.110"></a><span id="l21.110"> nsresult nsAbLDAPProcessReplicationData::OnLDAPSearchResult(nsILDAPMessage *aMessage)</span>
<a href="#l21.111"></a><span id="l21.111"> {</span>
<a href="#l21.112"></a><span id="l21.112"> #ifdef DEBUG_rdayal</span>
<a href="#l21.113"></a><span id="l21.113">     printf(&quot;LDAP Replication : Got Results for Completion&quot;);</span>
<a href="#l21.114"></a><span id="l21.114"> #endif</span>
<a href="#l21.115"></a><span id="l21.115"> </span>
<a href="#l21.116"></a><span id="l21.116">     NS_ENSURE_ARG_POINTER(aMessage);</span>
<a href="#l21.117"></a><span id="l21.117" class="difflineminus">-    if(!mInitialized) </span>
<a href="#l21.118"></a><span id="l21.118" class="difflineplus">+    if(!mInitialized)</span>
<a href="#l21.119"></a><span id="l21.119">         return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l21.120"></a><span id="l21.120"> </span>
<a href="#l21.121"></a><span id="l21.121">     int32_t errorCode;</span>
<a href="#l21.122"></a><span id="l21.122">     nsresult rv = aMessage-&gt;GetErrorCode(&amp;errorCode);</span>
<a href="#l21.123"></a><span id="l21.123"> </span>
<a href="#l21.124"></a><span id="l21.124">     if(NS_SUCCEEDED(rv)) {</span>
<a href="#l21.125"></a><span id="l21.125">         // We are done with the LDAP search for all entries.</span>
<a href="#l21.126"></a><span id="l21.126">         if(errorCode == nsILDAPErrors::SUCCESS || errorCode == nsILDAPErrors::SIZELIMIT_EXCEEDED) {</span>
<a href="#l21.127"></a><span id="l21.127" class="difflineat">@@ -326,17 +326,17 @@ nsresult nsAbLDAPProcessReplicationData:</span>
<a href="#l21.128"></a><span id="l21.128">         NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Replication DB ForceClosed on Failure failed&quot;);</span>
<a href="#l21.129"></a><span id="l21.129">         mDBOpen = false;</span>
<a href="#l21.130"></a><span id="l21.130">         // if error result is returned remove the replicated file</span>
<a href="#l21.131"></a><span id="l21.131">         if(mReplicationFile) {</span>
<a href="#l21.132"></a><span id="l21.132">             rv = mReplicationFile-&gt;Remove(false);</span>
<a href="#l21.133"></a><span id="l21.133">             NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Replication File Remove on Failure failed&quot;);</span>
<a href="#l21.134"></a><span id="l21.134">             if(NS_SUCCEEDED(rv)) {</span>
<a href="#l21.135"></a><span id="l21.135">                 // now put back the backed up replicated file</span>
<a href="#l21.136"></a><span id="l21.136" class="difflineminus">-                if(mBackupReplicationFile &amp;&amp; mDirectory) </span>
<a href="#l21.137"></a><span id="l21.137" class="difflineplus">+                if(mBackupReplicationFile &amp;&amp; mDirectory)</span>
<a href="#l21.138"></a><span id="l21.138">                 {</span>
<a href="#l21.139"></a><span id="l21.139">                   nsAutoCString fileName;</span>
<a href="#l21.140"></a><span id="l21.140">                   rv = mDirectory-&gt;GetReplicationFileName(fileName);</span>
<a href="#l21.141"></a><span id="l21.141">                   if (NS_SUCCEEDED(rv) &amp;&amp; !fileName.IsEmpty())</span>
<a href="#l21.142"></a><span id="l21.142">                   {</span>
<a href="#l21.143"></a><span id="l21.143">                     rv = mBackupReplicationFile-&gt;MoveToNative(nullptr, fileName);</span>
<a href="#l21.144"></a><span id="l21.144">                     NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Replication Backup File Move back on Failure failed&quot;);</span>
<a href="#l21.145"></a><span id="l21.145">                   }</span>
<a href="#l21.146"></a><span id="l21.146" class="difflineat">@@ -363,26 +363,26 @@ nsresult nsAbLDAPProcessReplicationData:</span>
<a href="#l21.147"></a><span id="l21.147"> </span>
<a href="#l21.148"></a><span id="l21.148">   nsCString fileName;</span>
<a href="#l21.149"></a><span id="l21.149">   rv = mReplicationFile-&gt;GetNativeLeafName(fileName);</span>
<a href="#l21.150"></a><span id="l21.150">   if (NS_FAILED(rv)) {</span>
<a href="#l21.151"></a><span id="l21.151">     Done(false);</span>
<a href="#l21.152"></a><span id="l21.152">     return rv;</span>
<a href="#l21.153"></a><span id="l21.153">   }</span>
<a href="#l21.154"></a><span id="l21.154"> </span>
<a href="#l21.155"></a><span id="l21.155" class="difflineminus">-    // if the AB DB already exists backup existing one, </span>
<a href="#l21.156"></a><span id="l21.156" class="difflineplus">+    // if the AB DB already exists backup existing one,</span>
<a href="#l21.157"></a><span id="l21.157">     // in case if the user cancels or Abort put back the backed up file</span>
<a href="#l21.158"></a><span id="l21.158">     bool fileExists;</span>
<a href="#l21.159"></a><span id="l21.159">     rv = mReplicationFile-&gt;Exists(&amp;fileExists);</span>
<a href="#l21.160"></a><span id="l21.160">     if(NS_SUCCEEDED(rv) &amp;&amp; fileExists) {</span>
<a href="#l21.161"></a><span id="l21.161">         // create the backup file object same as the Replication file object.</span>
<a href="#l21.162"></a><span id="l21.162">         // we create a backup file here since we need to cleanup the existing file</span>
<a href="#l21.163"></a><span id="l21.163">         // for create and then commit so instead of deleting existing cards we just</span>
<a href="#l21.164"></a><span id="l21.164">         // clone the existing one for a much better performance - for Download All.</span>
<a href="#l21.165"></a><span id="l21.165" class="difflineminus">-        // And also important in case if replication fails we donot lose user's existing </span>
<a href="#l21.166"></a><span id="l21.166" class="difflineplus">+        // And also important in case if replication fails we donot lose user's existing</span>
<a href="#l21.167"></a><span id="l21.167">         // replicated data for both Download all and Changelog.</span>
<a href="#l21.168"></a><span id="l21.168">         nsCOMPtr&lt;nsIFile&gt; clone;</span>
<a href="#l21.169"></a><span id="l21.169">         rv = mReplicationFile-&gt;Clone(getter_AddRefs(clone));</span>
<a href="#l21.170"></a><span id="l21.170">         if(NS_FAILED(rv))  {</span>
<a href="#l21.171"></a><span id="l21.171">             Done(false);</span>
<a href="#l21.172"></a><span id="l21.172">             return rv;</span>
<a href="#l21.173"></a><span id="l21.173">         }</span>
<a href="#l21.174"></a><span id="l21.174">         mBackupReplicationFile = do_QueryInterface(clone, &amp;rv);</span>
<a href="#l21.175"></a><span id="l21.175" class="difflineat">@@ -416,57 +416,57 @@ nsresult nsAbLDAPProcessReplicationData:</span>
<a href="#l21.176"></a><span id="l21.176">             // set the backup file leaf name now</span>
<a href="#l21.177"></a><span id="l21.177">             if (NS_SUCCEEDED(rv))</span>
<a href="#l21.178"></a><span id="l21.178">                 mBackupReplicationFile-&gt;SetLeafName(backupFileLeafName);</span>
<a href="#l21.179"></a><span id="l21.179">         }</span>
<a href="#l21.180"></a><span id="l21.180">         else {</span>
<a href="#l21.181"></a><span id="l21.181">             // set backup file to existing replication file for copy</span>
<a href="#l21.182"></a><span id="l21.182">             mBackupReplicationFile-&gt;SetNativeLeafName(fileName);</span>
<a href="#l21.183"></a><span id="l21.183"> </span>
<a href="#l21.184"></a><span id="l21.184" class="difflineminus">-            // specify the parent here specifically, </span>
<a href="#l21.185"></a><span id="l21.185" class="difflineplus">+            // specify the parent here specifically,</span>
<a href="#l21.186"></a><span id="l21.186">             // passing nullptr to copy to the same dir actually renames existing file</span>
<a href="#l21.187"></a><span id="l21.187">             // instead of making another copy of the existing file.</span>
<a href="#l21.188"></a><span id="l21.188">             nsCOMPtr&lt;nsIFile&gt; parent;</span>
<a href="#l21.189"></a><span id="l21.189">             rv = mBackupReplicationFile-&gt;GetParent(getter_AddRefs(parent));</span>
<a href="#l21.190"></a><span id="l21.190">             if (NS_SUCCEEDED(rv))</span>
<a href="#l21.191"></a><span id="l21.191">                 rv = mBackupReplicationFile-&gt;CopyTo(parent, backupFileLeafName);</span>
<a href="#l21.192"></a><span id="l21.192">             // set the backup file leaf name now</span>
<a href="#l21.193"></a><span id="l21.193">             if (NS_SUCCEEDED(rv))</span>
<a href="#l21.194"></a><span id="l21.194">                 mBackupReplicationFile-&gt;SetLeafName(backupFileLeafName);</span>
<a href="#l21.195"></a><span id="l21.195">         }</span>
<a href="#l21.196"></a><span id="l21.196">         if(NS_FAILED(rv))  {</span>
<a href="#l21.197"></a><span id="l21.197">             Done(false);</span>
<a href="#l21.198"></a><span id="l21.198">             return rv;</span>
<a href="#l21.199"></a><span id="l21.199">         }</span>
<a href="#l21.200"></a><span id="l21.200">     }</span>
<a href="#l21.201"></a><span id="l21.201"> </span>
<a href="#l21.202"></a><span id="l21.202" class="difflineminus">-    nsCOMPtr&lt;nsIAddrDatabase&gt; addrDBFactory = </span>
<a href="#l21.203"></a><span id="l21.203" class="difflineplus">+    nsCOMPtr&lt;nsIAddrDatabase&gt; addrDBFactory =</span>
<a href="#l21.204"></a><span id="l21.204">              do_GetService(NS_ADDRDATABASE_CONTRACTID, &amp;rv);</span>
<a href="#l21.205"></a><span id="l21.205">     if(NS_FAILED(rv)) {</span>
<a href="#l21.206"></a><span id="l21.206">         if (mBackupReplicationFile)</span>
<a href="#l21.207"></a><span id="l21.207">             mBackupReplicationFile-&gt;Remove(false);</span>
<a href="#l21.208"></a><span id="l21.208">         Done(false);</span>
<a href="#l21.209"></a><span id="l21.209">         return rv;</span>
<a href="#l21.210"></a><span id="l21.210">     }</span>
<a href="#l21.211"></a><span id="l21.211" class="difflineminus">-    </span>
<a href="#l21.212"></a><span id="l21.212" class="difflineplus">+</span>
<a href="#l21.213"></a><span id="l21.213">     rv = addrDBFactory-&gt;Open(mReplicationFile, aCreate, true, getter_AddRefs(mReplicationDB));</span>
<a href="#l21.214"></a><span id="l21.214">     if(NS_FAILED(rv)) {</span>
<a href="#l21.215"></a><span id="l21.215">         Done(false);</span>
<a href="#l21.216"></a><span id="l21.216">         if (mBackupReplicationFile)</span>
<a href="#l21.217"></a><span id="l21.217">             mBackupReplicationFile-&gt;Remove(false);</span>
<a href="#l21.218"></a><span id="l21.218">         return rv;</span>
<a href="#l21.219"></a><span id="l21.219">     }</span>
<a href="#l21.220"></a><span id="l21.220"> </span>
<a href="#l21.221"></a><span id="l21.221">     mDBOpen = true;  // replication DB is now Open</span>
<a href="#l21.222"></a><span id="l21.222">     return rv;</span>
<a href="#l21.223"></a><span id="l21.223"> }</span>
<a href="#l21.224"></a><span id="l21.224"> </span>
<a href="#l21.225"></a><span id="l21.225"> void nsAbLDAPProcessReplicationData::Done(bool aSuccess)</span>
<a href="#l21.226"></a><span id="l21.226"> {</span>
<a href="#l21.227"></a><span id="l21.227" class="difflineminus">-   if (!mInitialized) </span>
<a href="#l21.228"></a><span id="l21.228" class="difflineplus">+   if (!mInitialized)</span>
<a href="#l21.229"></a><span id="l21.229">        return;</span>
<a href="#l21.230"></a><span id="l21.230"> </span>
<a href="#l21.231"></a><span id="l21.231">    mState = kReplicationDone;</span>
<a href="#l21.232"></a><span id="l21.232"> </span>
<a href="#l21.233"></a><span id="l21.233">    if (mQuery)</span>
<a href="#l21.234"></a><span id="l21.234">      mQuery-&gt;Done(aSuccess);</span>
<a href="#l21.235"></a><span id="l21.235"> </span>
<a href="#l21.236"></a><span id="l21.236">    if (mListener)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPReplicationData.h</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPReplicationData.h</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -45,22 +45,22 @@ protected:</span>
<a href="#l22.4"></a><span id="l22.4">   nsCOMPtr &lt;nsIFile&gt; mBackupReplicationFile;</span>
<a href="#l22.5"></a><span id="l22.5"> </span>
<a href="#l22.6"></a><span id="l22.6">   // state of processing, protocol used and count of results</span>
<a href="#l22.7"></a><span id="l22.7">   int32_t         mState;</span>
<a href="#l22.8"></a><span id="l22.8">   int32_t         mProtocol;</span>
<a href="#l22.9"></a><span id="l22.9">   int32_t         mCount;</span>
<a href="#l22.10"></a><span id="l22.10">   bool            mDBOpen;</span>
<a href="#l22.11"></a><span id="l22.11">   bool            mInitialized;</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-  </span>
<a href="#l22.13"></a><span id="l22.13" class="difflineplus">+</span>
<a href="#l22.14"></a><span id="l22.14">   nsCOMPtr&lt;nsIAbLDAPDirectory&gt; mDirectory;</span>
<a href="#l22.15"></a><span id="l22.15">   nsCOMPtr&lt;nsIAbLDAPAttributeMap&gt; mAttrMap; // maps ab properties to ldap attrs</span>
<a href="#l22.16"></a><span id="l22.16" class="difflineminus">-  </span>
<a href="#l22.17"></a><span id="l22.17" class="difflineplus">+</span>
<a href="#l22.18"></a><span id="l22.18">   virtual nsresult OnLDAPSearchEntry(nsILDAPMessage *aMessage);</span>
<a href="#l22.19"></a><span id="l22.19">   virtual nsresult OnLDAPSearchResult(nsILDAPMessage *aMessage);</span>
<a href="#l22.20"></a><span id="l22.20" class="difflineminus">-  </span>
<a href="#l22.21"></a><span id="l22.21" class="difflineplus">+</span>
<a href="#l22.22"></a><span id="l22.22">   nsresult OpenABForReplicatedDir(bool bCreate);</span>
<a href="#l22.23"></a><span id="l22.23">   nsresult DeleteCard(nsString &amp; aDn);</span>
<a href="#l22.24"></a><span id="l22.24">   void Done(bool aSuccess);</span>
<a href="#l22.25"></a><span id="l22.25"> };</span>
<a href="#l22.26"></a><span id="l22.26"> </span>
<a href="#l22.27"></a><span id="l22.27"> </span>
<a href="#l22.28"></a><span id="l22.28"> #endif // nsAbLDAPReplicationData_h__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPReplicationQuery.cpp</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPReplicationQuery.cpp</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -52,28 +52,28 @@ nsresult nsAbLDAPReplicationQuery::InitL</span>
<a href="#l23.4"></a><span id="l23.4">     DIR_Server* server = DIR_GetServerFromList(dirPrefId.get());</span>
<a href="#l23.5"></a><span id="l23.5">     if (server)</span>
<a href="#l23.6"></a><span id="l23.6">     {</span>
<a href="#l23.7"></a><span id="l23.7">       DIR_SetServerFileName(server);</span>
<a href="#l23.8"></a><span id="l23.8">       // Now ensure the prefs are saved</span>
<a href="#l23.9"></a><span id="l23.9">       DIR_SavePrefsForOneServer(server);</span>
<a href="#l23.10"></a><span id="l23.10">     }</span>
<a href="#l23.11"></a><span id="l23.11">   }</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">- </span>
<a href="#l23.13"></a><span id="l23.13" class="difflineplus">+</span>
<a href="#l23.14"></a><span id="l23.14">   rv = mDirectory-&gt;SetReplicationFileName(fileName);</span>
<a href="#l23.15"></a><span id="l23.15">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.16"></a><span id="l23.16" class="difflineminus">- </span>
<a href="#l23.17"></a><span id="l23.17" class="difflineplus">+</span>
<a href="#l23.18"></a><span id="l23.18">   rv = mDirectory-&gt;GetLDAPURL(getter_AddRefs(mURL));</span>
<a href="#l23.19"></a><span id="l23.19">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.20"></a><span id="l23.20"> </span>
<a href="#l23.21"></a><span id="l23.21">   rv = mDirectory-&gt;GetAuthDn(mLogin);</span>
<a href="#l23.22"></a><span id="l23.22">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.23"></a><span id="l23.23"> </span>
<a href="#l23.24"></a><span id="l23.24">   mConnection = do_CreateInstance(NS_LDAPCONNECTION_CONTRACTID, &amp;rv);</span>
<a href="#l23.25"></a><span id="l23.25" class="difflineminus">-  if (NS_FAILED(rv)) </span>
<a href="#l23.26"></a><span id="l23.26" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l23.27"></a><span id="l23.27">     return rv;</span>
<a href="#l23.28"></a><span id="l23.28"> </span>
<a href="#l23.29"></a><span id="l23.29">   mOperation = do_CreateInstance(NS_LDAPOPERATION_CONTRACTID, &amp;rv);</span>
<a href="#l23.30"></a><span id="l23.30"> </span>
<a href="#l23.31"></a><span id="l23.31">   return rv;</span>
<a href="#l23.32"></a><span id="l23.32"> }</span>
<a href="#l23.33"></a><span id="l23.33"> </span>
<a href="#l23.34"></a><span id="l23.34"> nsresult nsAbLDAPReplicationQuery::ConnectToLDAPServer()</span>
<a href="#l23.35"></a><span id="l23.35" class="difflineat">@@ -105,49 +105,49 @@ nsresult nsAbLDAPReplicationQuery::Conne</span>
<a href="#l23.36"></a><span id="l23.36"> NS_IMETHODIMP nsAbLDAPReplicationQuery::Init(nsIAbLDAPDirectory *aDirectory,</span>
<a href="#l23.37"></a><span id="l23.37">                                              nsIWebProgressListener *aProgressListener)</span>
<a href="#l23.38"></a><span id="l23.38"> {</span>
<a href="#l23.39"></a><span id="l23.39">   NS_ENSURE_ARG_POINTER(aDirectory);</span>
<a href="#l23.40"></a><span id="l23.40"> </span>
<a href="#l23.41"></a><span id="l23.41">   mDirectory = aDirectory;</span>
<a href="#l23.42"></a><span id="l23.42"> </span>
<a href="#l23.43"></a><span id="l23.43">   nsresult rv = InitLDAPData();</span>
<a href="#l23.44"></a><span id="l23.44" class="difflineminus">-  if (NS_FAILED(rv)) </span>
<a href="#l23.45"></a><span id="l23.45" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l23.46"></a><span id="l23.46">     return rv;</span>
<a href="#l23.47"></a><span id="l23.47"> </span>
<a href="#l23.48"></a><span id="l23.48">   mDataProcessor =</span>
<a href="#l23.49"></a><span id="l23.49">     do_CreateInstance(NS_ABLDAP_PROCESSREPLICATIONDATA_CONTRACTID, &amp;rv);</span>
<a href="#l23.50"></a><span id="l23.50" class="difflineminus">-  if (NS_FAILED(rv)) </span>
<a href="#l23.51"></a><span id="l23.51" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l23.52"></a><span id="l23.52">     return rv;</span>
<a href="#l23.53"></a><span id="l23.53"> </span>
<a href="#l23.54"></a><span id="l23.54">   // 'this' initialized</span>
<a href="#l23.55"></a><span id="l23.55">   mInitialized = true;</span>
<a href="#l23.56"></a><span id="l23.56"> </span>
<a href="#l23.57"></a><span id="l23.57">   return mDataProcessor-&gt;Init(mDirectory, mConnection, mURL, this,</span>
<a href="#l23.58"></a><span id="l23.58">                               aProgressListener);</span>
<a href="#l23.59"></a><span id="l23.59"> }</span>
<a href="#l23.60"></a><span id="l23.60"> </span>
<a href="#l23.61"></a><span id="l23.61"> NS_IMETHODIMP nsAbLDAPReplicationQuery::DoReplicationQuery()</span>
<a href="#l23.62"></a><span id="l23.62"> {</span>
<a href="#l23.63"></a><span id="l23.63">     return ConnectToLDAPServer();</span>
<a href="#l23.64"></a><span id="l23.64"> }</span>
<a href="#l23.65"></a><span id="l23.65"> </span>
<a href="#l23.66"></a><span id="l23.66"> NS_IMETHODIMP nsAbLDAPReplicationQuery::CancelQuery()</span>
<a href="#l23.67"></a><span id="l23.67"> {</span>
<a href="#l23.68"></a><span id="l23.68" class="difflineminus">-    if (!mInitialized) </span>
<a href="#l23.69"></a><span id="l23.69" class="difflineplus">+    if (!mInitialized)</span>
<a href="#l23.70"></a><span id="l23.70">         return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l23.71"></a><span id="l23.71"> </span>
<a href="#l23.72"></a><span id="l23.72">     return mDataProcessor-&gt;Abort();</span>
<a href="#l23.73"></a><span id="l23.73"> }</span>
<a href="#l23.74"></a><span id="l23.74"> </span>
<a href="#l23.75"></a><span id="l23.75"> NS_IMETHODIMP nsAbLDAPReplicationQuery::Done(bool aSuccess)</span>
<a href="#l23.76"></a><span id="l23.76"> {</span>
<a href="#l23.77"></a><span id="l23.77" class="difflineminus">-   if (!mInitialized) </span>
<a href="#l23.78"></a><span id="l23.78" class="difflineplus">+   if (!mInitialized)</span>
<a href="#l23.79"></a><span id="l23.79">        return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l23.80"></a><span id="l23.80"> </span>
<a href="#l23.81"></a><span id="l23.81">    nsresult rv = NS_OK;</span>
<a href="#l23.82"></a><span id="l23.82" class="difflineminus">-   nsCOMPtr&lt;nsIAbLDAPReplicationService&gt; replicationService = </span>
<a href="#l23.83"></a><span id="l23.83" class="difflineplus">+   nsCOMPtr&lt;nsIAbLDAPReplicationService&gt; replicationService =</span>
<a href="#l23.84"></a><span id="l23.84">                             do_GetService(NS_ABLDAP_REPLICATIONSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l23.85"></a><span id="l23.85">    if (NS_SUCCEEDED(rv))</span>
<a href="#l23.86"></a><span id="l23.86">       replicationService-&gt;Done(aSuccess);</span>
<a href="#l23.87"></a><span id="l23.87"> </span>
<a href="#l23.88"></a><span id="l23.88">    return rv;</span>
<a href="#l23.89"></a><span id="l23.89"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPReplicationService.cpp</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPReplicationService.cpp</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -14,17 +14,17 @@</span>
<a href="#l24.4"></a><span id="l24.4"> // XXX Change log replication doesn't work. Bug 311632 should fix it.</span>
<a href="#l24.5"></a><span id="l24.5"> //#include &quot;nsAbLDAPChangeLogQuery.h&quot;</span>
<a href="#l24.6"></a><span id="l24.6"> #include &quot;nsIAbLDAPReplicationData.h&quot;</span>
<a href="#l24.7"></a><span id="l24.7"> </span>
<a href="#l24.8"></a><span id="l24.8"> /*** implementation of the service ******/</span>
<a href="#l24.9"></a><span id="l24.9"> </span>
<a href="#l24.10"></a><span id="l24.10"> NS_IMPL_ISUPPORTS(nsAbLDAPReplicationService, nsIAbLDAPReplicationService)</span>
<a href="#l24.11"></a><span id="l24.11"> </span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-nsAbLDAPReplicationService::nsAbLDAPReplicationService() </span>
<a href="#l24.13"></a><span id="l24.13" class="difflineplus">+nsAbLDAPReplicationService::nsAbLDAPReplicationService()</span>
<a href="#l24.14"></a><span id="l24.14">     : mReplicating(false)</span>
<a href="#l24.15"></a><span id="l24.15"> {</span>
<a href="#l24.16"></a><span id="l24.16"> }</span>
<a href="#l24.17"></a><span id="l24.17"> </span>
<a href="#l24.18"></a><span id="l24.18"> nsAbLDAPReplicationService::~nsAbLDAPReplicationService()</span>
<a href="#l24.19"></a><span id="l24.19"> {</span>
<a href="#l24.20"></a><span id="l24.20"> }</span>
<a href="#l24.21"></a><span id="l24.21"> </span>
<a href="#l24.22"></a><span id="l24.22" class="difflineat">@@ -92,17 +92,17 @@ NS_IMETHODIMP nsAbLDAPReplicationService</span>
<a href="#l24.23"></a><span id="l24.23"> {</span>
<a href="#l24.24"></a><span id="l24.24">   NS_ENSURE_ARG_POINTER(aDirectory);</span>
<a href="#l24.25"></a><span id="l24.25"> </span>
<a href="#l24.26"></a><span id="l24.26">   nsresult rv = NS_ERROR_FAILURE;</span>
<a href="#l24.27"></a><span id="l24.27"> </span>
<a href="#l24.28"></a><span id="l24.28">   if (aDirectory == mDirectory)</span>
<a href="#l24.29"></a><span id="l24.29">   {</span>
<a href="#l24.30"></a><span id="l24.30">     if (mQuery &amp;&amp; mReplicating)</span>
<a href="#l24.31"></a><span id="l24.31" class="difflineminus">-      rv = mQuery-&gt;CancelQuery();  </span>
<a href="#l24.32"></a><span id="l24.32" class="difflineplus">+      rv = mQuery-&gt;CancelQuery();</span>
<a href="#l24.33"></a><span id="l24.33">   }</span>
<a href="#l24.34"></a><span id="l24.34"> </span>
<a href="#l24.35"></a><span id="l24.35">   // If query has been cancelled successfully</span>
<a href="#l24.36"></a><span id="l24.36">   if (NS_SUCCEEDED(rv))</span>
<a href="#l24.37"></a><span id="l24.37">     Done(false);</span>
<a href="#l24.38"></a><span id="l24.38"> </span>
<a href="#l24.39"></a><span id="l24.39">   return rv;</span>
<a href="#l24.40"></a><span id="l24.40"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPReplicationService.h</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPReplicationService.h</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -18,16 +18,16 @@ public:</span>
<a href="#l25.4"></a><span id="l25.4">   NS_DECL_NSIABLDAPREPLICATIONSERVICE</span>
<a href="#l25.5"></a><span id="l25.5"> </span>
<a href="#l25.6"></a><span id="l25.6">   nsAbLDAPReplicationService();</span>
<a href="#l25.7"></a><span id="l25.7"> </span>
<a href="#l25.8"></a><span id="l25.8">   int32_t DecideProtocol();</span>
<a href="#l25.9"></a><span id="l25.9"> </span>
<a href="#l25.10"></a><span id="l25.10"> protected:</span>
<a href="#l25.11"></a><span id="l25.11">   virtual ~nsAbLDAPReplicationService();</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-  nsCOMPtr&lt;nsIAbLDAPReplicationQuery&gt; mQuery; </span>
<a href="#l25.13"></a><span id="l25.13" class="difflineplus">+  nsCOMPtr&lt;nsIAbLDAPReplicationQuery&gt; mQuery;</span>
<a href="#l25.14"></a><span id="l25.14">   bool           mReplicating;</span>
<a href="#l25.15"></a><span id="l25.15">   nsCOMPtr&lt;nsIAbLDAPDirectory&gt; mDirectory;</span>
<a href="#l25.16"></a><span id="l25.16"> </span>
<a href="#l25.17"></a><span id="l25.17"> };</span>
<a href="#l25.18"></a><span id="l25.18"> </span>
<a href="#l25.19"></a><span id="l25.19"> </span>
<a href="#l25.20"></a><span id="l25.20"> #endif /* nsAbLDAPReplicationService_h___ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDIFService.cpp</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDIFService.cpp</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -158,17 +158,17 @@ NS_IMETHODIMP nsAbLDIFService::ImportLDI</span>
<a href="#l26.4"></a><span id="l26.4">   return aDb-&gt;Commit(nsAddrDBCommitType::kLargeCommit);</span>
<a href="#l26.5"></a><span id="l26.5"> }</span>
<a href="#l26.6"></a><span id="l26.6"> </span>
<a href="#l26.7"></a><span id="l26.7"> /*</span>
<a href="#l26.8"></a><span id="l26.8">  * str_parse_line - takes a line of the form &quot;type:[:] value&quot; and splits it</span>
<a href="#l26.9"></a><span id="l26.9">  * into components &quot;type&quot; and &quot;value&quot;.  if a double colon separates type from</span>
<a href="#l26.10"></a><span id="l26.10">  * value, then value is encoded in base 64, and parse_line un-decodes it</span>
<a href="#l26.11"></a><span id="l26.11">  * (in place) before returning.</span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">- * in LDIF, non-ASCII data is treated as base64 encoded UTF-8 </span>
<a href="#l26.13"></a><span id="l26.13" class="difflineplus">+ * in LDIF, non-ASCII data is treated as base64 encoded UTF-8</span>
<a href="#l26.14"></a><span id="l26.14">  */</span>
<a href="#l26.15"></a><span id="l26.15"> </span>
<a href="#l26.16"></a><span id="l26.16"> nsresult nsAbLDIFService::str_parse_line(char *line, char **type, char **value, int *vlen) const</span>
<a href="#l26.17"></a><span id="l26.17"> {</span>
<a href="#l26.18"></a><span id="l26.18">   char    *p, *s, *d, *byte, *stop;</span>
<a href="#l26.19"></a><span id="l26.19">   char    nib;</span>
<a href="#l26.20"></a><span id="l26.20">   int    i, b64;</span>
<a href="#l26.21"></a><span id="l26.21"> </span>
<a href="#l26.22"></a><span id="l26.22" class="difflineat">@@ -295,17 +295,17 @@ char* nsAbLDIFService::str_getline(char </span>
<a href="#l26.23"></a><span id="l26.23">     }</span>
<a href="#l26.24"></a><span id="l26.24">   }</span>
<a href="#l26.25"></a><span id="l26.25"> </span>
<a href="#l26.26"></a><span id="l26.26">   return( lineStr );</span>
<a href="#l26.27"></a><span id="l26.27"> }</span>
<a href="#l26.28"></a><span id="l26.28"> </span>
<a href="#l26.29"></a><span id="l26.29"> nsresult nsAbLDIFService::GetLdifStringRecord(char* buf, int32_t len, int32_t&amp; stopPos)</span>
<a href="#l26.30"></a><span id="l26.30"> {</span>
<a href="#l26.31"></a><span id="l26.31" class="difflineminus">-  for (; stopPos &lt; len; stopPos++) </span>
<a href="#l26.32"></a><span id="l26.32" class="difflineplus">+  for (; stopPos &lt; len; stopPos++)</span>
<a href="#l26.33"></a><span id="l26.33">   {</span>
<a href="#l26.34"></a><span id="l26.34">     char c = buf[stopPos];</span>
<a href="#l26.35"></a><span id="l26.35"> </span>
<a href="#l26.36"></a><span id="l26.36">     if (c == 0xA)</span>
<a href="#l26.37"></a><span id="l26.37">     {</span>
<a href="#l26.38"></a><span id="l26.38">       mLFCount++;</span>
<a href="#l26.39"></a><span id="l26.39">     }</span>
<a href="#l26.40"></a><span id="l26.40">     else if (c == 0xD)</span>
<a href="#l26.41"></a><span id="l26.41" class="difflineat">@@ -348,58 +348,58 @@ void nsAbLDIFService::AddLdifRowToDataba</span>
<a href="#l26.42"></a><span id="l26.42">     mCRCount = 0;</span>
<a href="#l26.43"></a><span id="l26.43">     return;</span>
<a href="#l26.44"></a><span id="l26.44">   }</span>
<a href="#l26.45"></a><span id="l26.45"> </span>
<a href="#l26.46"></a><span id="l26.46">   nsCOMPtr &lt;nsIMdbRow&gt; newRow;</span>
<a href="#l26.47"></a><span id="l26.47">   if (aDatabase)</span>
<a href="#l26.48"></a><span id="l26.48">   {</span>
<a href="#l26.49"></a><span id="l26.49">     if (bIsList)</span>
<a href="#l26.50"></a><span id="l26.50" class="difflineminus">-      aDatabase-&gt;GetNewListRow(getter_AddRefs(newRow)); </span>
<a href="#l26.51"></a><span id="l26.51" class="difflineplus">+      aDatabase-&gt;GetNewListRow(getter_AddRefs(newRow));</span>
<a href="#l26.52"></a><span id="l26.52">     else</span>
<a href="#l26.53"></a><span id="l26.53" class="difflineminus">-      aDatabase-&gt;GetNewRow(getter_AddRefs(newRow)); </span>
<a href="#l26.54"></a><span id="l26.54" class="difflineplus">+      aDatabase-&gt;GetNewRow(getter_AddRefs(newRow));</span>
<a href="#l26.55"></a><span id="l26.55"> </span>
<a href="#l26.56"></a><span id="l26.56">     if (!newRow)</span>
<a href="#l26.57"></a><span id="l26.57">       return;</span>
<a href="#l26.58"></a><span id="l26.58">   }</span>
<a href="#l26.59"></a><span id="l26.59">   else</span>
<a href="#l26.60"></a><span id="l26.60">     return;</span>
<a href="#l26.61"></a><span id="l26.61"> </span>
<a href="#l26.62"></a><span id="l26.62" class="difflineminus">-  char* cursor = ToNewCString(mLdifLine); </span>
<a href="#l26.63"></a><span id="l26.63" class="difflineminus">-  char* saveCursor = cursor;  /* keep for deleting */ </span>
<a href="#l26.64"></a><span id="l26.64" class="difflineminus">-  char* line = 0; </span>
<a href="#l26.65"></a><span id="l26.65" class="difflineminus">-  char* typeSlot = 0; </span>
<a href="#l26.66"></a><span id="l26.66" class="difflineminus">-  char* valueSlot = 0; </span>
<a href="#l26.67"></a><span id="l26.67" class="difflineplus">+  char* cursor = ToNewCString(mLdifLine);</span>
<a href="#l26.68"></a><span id="l26.68" class="difflineplus">+  char* saveCursor = cursor;  /* keep for deleting */</span>
<a href="#l26.69"></a><span id="l26.69" class="difflineplus">+  char* line = 0;</span>
<a href="#l26.70"></a><span id="l26.70" class="difflineplus">+  char* typeSlot = 0;</span>
<a href="#l26.71"></a><span id="l26.71" class="difflineplus">+  char* valueSlot = 0;</span>
<a href="#l26.72"></a><span id="l26.72">   int length = 0;  // the length  of an ldif attribute</span>
<a href="#l26.73"></a><span id="l26.73">   while ( (line = str_getline(&amp;cursor)) != nullptr)</span>
<a href="#l26.74"></a><span id="l26.74">   {</span>
<a href="#l26.75"></a><span id="l26.75">     if (NS_SUCCEEDED(str_parse_line(line, &amp;typeSlot, &amp;valueSlot, &amp;length))) {</span>
<a href="#l26.76"></a><span id="l26.76">       AddLdifColToDatabase(aDatabase, newRow, typeSlot, valueSlot, bIsList);</span>
<a href="#l26.77"></a><span id="l26.77">     }</span>
<a href="#l26.78"></a><span id="l26.78">     else</span>
<a href="#l26.79"></a><span id="l26.79">       continue; // parse error: continue with next loop iteration</span>
<a href="#l26.80"></a><span id="l26.80">   }</span>
<a href="#l26.81"></a><span id="l26.81">   free(saveCursor);</span>
<a href="#l26.82"></a><span id="l26.82" class="difflineminus">-  aDatabase-&gt;AddCardRowToDB(newRow);    </span>
<a href="#l26.83"></a><span id="l26.83" class="difflineplus">+  aDatabase-&gt;AddCardRowToDB(newRow);</span>
<a href="#l26.84"></a><span id="l26.84"> </span>
<a href="#l26.85"></a><span id="l26.85">   if (bIsList)</span>
<a href="#l26.86"></a><span id="l26.86">     aDatabase-&gt;AddListDirNode(newRow);</span>
<a href="#l26.87"></a><span id="l26.87" class="difflineminus">-        </span>
<a href="#l26.88"></a><span id="l26.88" class="difflineplus">+</span>
<a href="#l26.89"></a><span id="l26.89">   // Clear buffer for next record</span>
<a href="#l26.90"></a><span id="l26.90">   ClearLdifRecordBuffer();</span>
<a href="#l26.91"></a><span id="l26.91"> }</span>
<a href="#l26.92"></a><span id="l26.92"> </span>
<a href="#l26.93"></a><span id="l26.93"> void nsAbLDIFService::AddLdifColToDatabase(nsIAddrDatabase *aDatabase,</span>
<a href="#l26.94"></a><span id="l26.94">                                            nsIMdbRow* newRow, char* typeSlot,</span>
<a href="#l26.95"></a><span id="l26.95">                                            char* valueSlot, bool bIsList)</span>
<a href="#l26.96"></a><span id="l26.96"> {</span>
<a href="#l26.97"></a><span id="l26.97">   nsAutoCString colType(typeSlot);</span>
<a href="#l26.98"></a><span id="l26.98">   nsAutoCString column(valueSlot);</span>
<a href="#l26.99"></a><span id="l26.99"> </span>
<a href="#l26.100"></a><span id="l26.100" class="difflineminus">-  // 4.x exports attributes like &quot;givenname&quot;, </span>
<a href="#l26.101"></a><span id="l26.101" class="difflineplus">+  // 4.x exports attributes like &quot;givenname&quot;,</span>
<a href="#l26.102"></a><span id="l26.102">   // mozilla does &quot;givenName&quot; to be compliant with RFC 2798</span>
<a href="#l26.103"></a><span id="l26.103">   ToLowerCase(colType);</span>
<a href="#l26.104"></a><span id="l26.104"> </span>
<a href="#l26.105"></a><span id="l26.105">   mdb_u1 firstByte = (mdb_u1)(colType.get())[0];</span>
<a href="#l26.106"></a><span id="l26.106">   switch ( firstByte )</span>
<a href="#l26.107"></a><span id="l26.107">   {</span>
<a href="#l26.108"></a><span id="l26.108">   case 'b':</span>
<a href="#l26.109"></a><span id="l26.109">     if (colType.EqualsLiteral(&quot;birthyear&quot;))</span>
<a href="#l26.110"></a><span id="l26.110" class="difflineat">@@ -426,29 +426,29 @@ void nsAbLDIFService::AddLdifColToDataba</span>
<a href="#l26.111"></a><span id="l26.111">         aDatabase-&gt;AddWorkCountry(newRow, column.get());</span>
<a href="#l26.112"></a><span id="l26.112">     }</span>
<a href="#l26.113"></a><span id="l26.113"> </span>
<a href="#l26.114"></a><span id="l26.114">     else if (colType.EqualsLiteral(&quot;cellphone&quot;) )</span>
<a href="#l26.115"></a><span id="l26.115">       aDatabase-&gt;AddCellularNumber(newRow, column.get());</span>
<a href="#l26.116"></a><span id="l26.116"> </span>
<a href="#l26.117"></a><span id="l26.117">     else if (colType.EqualsLiteral(&quot;carphone&quot;))</span>
<a href="#l26.118"></a><span id="l26.118">       aDatabase-&gt;AddCellularNumber(newRow, column.get());</span>
<a href="#l26.119"></a><span id="l26.119" class="difflineminus">-        </span>
<a href="#l26.120"></a><span id="l26.120" class="difflineplus">+</span>
<a href="#l26.121"></a><span id="l26.121">     else if (colType.EqualsLiteral(&quot;custom1&quot;))</span>
<a href="#l26.122"></a><span id="l26.122">       aDatabase-&gt;AddCustom1(newRow, column.get());</span>
<a href="#l26.123"></a><span id="l26.123" class="difflineminus">-        </span>
<a href="#l26.124"></a><span id="l26.124" class="difflineplus">+</span>
<a href="#l26.125"></a><span id="l26.125">     else if (colType.EqualsLiteral(&quot;custom2&quot;))</span>
<a href="#l26.126"></a><span id="l26.126">       aDatabase-&gt;AddCustom2(newRow, column.get());</span>
<a href="#l26.127"></a><span id="l26.127" class="difflineminus">-        </span>
<a href="#l26.128"></a><span id="l26.128" class="difflineplus">+</span>
<a href="#l26.129"></a><span id="l26.129">     else if (colType.EqualsLiteral(&quot;custom3&quot;))</span>
<a href="#l26.130"></a><span id="l26.130">       aDatabase-&gt;AddCustom3(newRow, column.get());</span>
<a href="#l26.131"></a><span id="l26.131" class="difflineminus">-        </span>
<a href="#l26.132"></a><span id="l26.132" class="difflineplus">+</span>
<a href="#l26.133"></a><span id="l26.133">     else if (colType.EqualsLiteral(&quot;custom4&quot;))</span>
<a href="#l26.134"></a><span id="l26.134">       aDatabase-&gt;AddCustom4(newRow, column.get());</span>
<a href="#l26.135"></a><span id="l26.135" class="difflineminus">-        </span>
<a href="#l26.136"></a><span id="l26.136" class="difflineplus">+</span>
<a href="#l26.137"></a><span id="l26.137">     else if (colType.EqualsLiteral(&quot;company&quot;))</span>
<a href="#l26.138"></a><span id="l26.138">       aDatabase-&gt;AddCompany(newRow, column.get());</span>
<a href="#l26.139"></a><span id="l26.139">     break; // 'c'</span>
<a href="#l26.140"></a><span id="l26.140"> </span>
<a href="#l26.141"></a><span id="l26.141">   case 'd':</span>
<a href="#l26.142"></a><span id="l26.142">     if (colType.EqualsLiteral(&quot;description&quot;))</span>
<a href="#l26.143"></a><span id="l26.143">     {</span>
<a href="#l26.144"></a><span id="l26.144">       if (bIsList)</span>
<a href="#l26.145"></a><span id="l26.145" class="difflineat">@@ -524,23 +524,23 @@ void nsAbLDIFService::AddLdifColToDataba</span>
<a href="#l26.146"></a><span id="l26.146">     else if (colType.EqualsLiteral(&quot;mobile&quot;))</span>
<a href="#l26.147"></a><span id="l26.147">       aDatabase-&gt;AddCellularNumber(newRow, column.get());</span>
<a href="#l26.148"></a><span id="l26.148"> </span>
<a href="#l26.149"></a><span id="l26.149">     else if (colType.EqualsLiteral(&quot;mozilla_aimscreenname&quot;))</span>
<a href="#l26.150"></a><span id="l26.150">       aDatabase-&gt;AddAimScreenName(newRow, column.get());</span>
<a href="#l26.151"></a><span id="l26.151"> </span>
<a href="#l26.152"></a><span id="l26.152">     else if (colType.EqualsLiteral(&quot;mozillacustom1&quot;))</span>
<a href="#l26.153"></a><span id="l26.153">       aDatabase-&gt;AddCustom1(newRow, column.get());</span>
<a href="#l26.154"></a><span id="l26.154" class="difflineminus">-        </span>
<a href="#l26.155"></a><span id="l26.155" class="difflineplus">+</span>
<a href="#l26.156"></a><span id="l26.156">     else if (colType.EqualsLiteral(&quot;mozillacustom2&quot;))</span>
<a href="#l26.157"></a><span id="l26.157">       aDatabase-&gt;AddCustom2(newRow, column.get());</span>
<a href="#l26.158"></a><span id="l26.158" class="difflineminus">-        </span>
<a href="#l26.159"></a><span id="l26.159" class="difflineplus">+</span>
<a href="#l26.160"></a><span id="l26.160">     else if (colType.EqualsLiteral(&quot;mozillacustom3&quot;))</span>
<a href="#l26.161"></a><span id="l26.161">       aDatabase-&gt;AddCustom3(newRow, column.get());</span>
<a href="#l26.162"></a><span id="l26.162" class="difflineminus">-        </span>
<a href="#l26.163"></a><span id="l26.163" class="difflineplus">+</span>
<a href="#l26.164"></a><span id="l26.164">     else if (colType.EqualsLiteral(&quot;mozillacustom4&quot;))</span>
<a href="#l26.165"></a><span id="l26.165">       aDatabase-&gt;AddCustom4(newRow, column.get());</span>
<a href="#l26.166"></a><span id="l26.166"> </span>
<a href="#l26.167"></a><span id="l26.167">     else if (colType.EqualsLiteral(&quot;mozillahomecountryname&quot;))</span>
<a href="#l26.168"></a><span id="l26.168">       aDatabase-&gt;AddHomeCountry(newRow, column.get());</span>
<a href="#l26.169"></a><span id="l26.169"> </span>
<a href="#l26.170"></a><span id="l26.170">     else if (colType.EqualsLiteral(&quot;mozillahomelocalityname&quot;))</span>
<a href="#l26.171"></a><span id="l26.171">       aDatabase-&gt;AddHomeCity(newRow, column.get());</span>
<a href="#l26.172"></a><span id="l26.172" class="difflineat">@@ -589,17 +589,17 @@ void nsAbLDIFService::AddLdifColToDataba</span>
<a href="#l26.173"></a><span id="l26.173">       aDatabase-&gt;AddWebPage1(newRow, column.get());</span>
<a href="#l26.174"></a><span id="l26.174"> </span>
<a href="#l26.175"></a><span id="l26.175">     break; // 'm'</span>
<a href="#l26.176"></a><span id="l26.176"> </span>
<a href="#l26.177"></a><span id="l26.177">   case 'n':</span>
<a href="#l26.178"></a><span id="l26.178">     if (colType.EqualsLiteral(&quot;notes&quot;))</span>
<a href="#l26.179"></a><span id="l26.179">       aDatabase-&gt;AddNotes(newRow, column.get());</span>
<a href="#l26.180"></a><span id="l26.180"> </span>
<a href="#l26.181"></a><span id="l26.181" class="difflineminus">-    else if (colType.EqualsLiteral(&quot;nscpaimscreenname&quot;) || </span>
<a href="#l26.182"></a><span id="l26.182" class="difflineplus">+    else if (colType.EqualsLiteral(&quot;nscpaimscreenname&quot;) ||</span>
<a href="#l26.183"></a><span id="l26.183">              colType.EqualsLiteral(&quot;nsaimid&quot;))</span>
<a href="#l26.184"></a><span id="l26.184">       aDatabase-&gt;AddAimScreenName(newRow, column.get());</span>
<a href="#l26.185"></a><span id="l26.185"> </span>
<a href="#l26.186"></a><span id="l26.186">     break; // 'n'</span>
<a href="#l26.187"></a><span id="l26.187"> </span>
<a href="#l26.188"></a><span id="l26.188">   case 'o':</span>
<a href="#l26.189"></a><span id="l26.189">     if (colType.EqualsLiteral(&quot;objectclass&quot;))</span>
<a href="#l26.190"></a><span id="l26.190">       break;</span>
<a href="#l26.191"></a><span id="l26.191" class="difflineat">@@ -665,17 +665,17 @@ void nsAbLDIFService::AddLdifColToDataba</span>
<a href="#l26.192"></a><span id="l26.192">     }</span>
<a href="#l26.193"></a><span id="l26.193">     else if (colType.EqualsLiteral(&quot;st&quot;))</span>
<a href="#l26.194"></a><span id="l26.194">     {</span>
<a href="#l26.195"></a><span id="l26.195">     if (mStoreLocAsHome)</span>
<a href="#l26.196"></a><span id="l26.196">       aDatabase-&gt;AddHomeState(newRow, column.get());</span>
<a href="#l26.197"></a><span id="l26.197">     else</span>
<a href="#l26.198"></a><span id="l26.198">       aDatabase-&gt;AddWorkState(newRow, column.get());</span>
<a href="#l26.199"></a><span id="l26.199">     }</span>
<a href="#l26.200"></a><span id="l26.200" class="difflineminus">-        </span>
<a href="#l26.201"></a><span id="l26.201" class="difflineplus">+</span>
<a href="#l26.202"></a><span id="l26.202">     break; // 's'</span>
<a href="#l26.203"></a><span id="l26.203"> </span>
<a href="#l26.204"></a><span id="l26.204">   case 't':</span>
<a href="#l26.205"></a><span id="l26.205">     if (colType.EqualsLiteral(&quot;title&quot;))</span>
<a href="#l26.206"></a><span id="l26.206">       aDatabase-&gt;AddJobTitle(newRow, column.get());</span>
<a href="#l26.207"></a><span id="l26.207"> </span>
<a href="#l26.208"></a><span id="l26.208">     else if (colType.EqualsLiteral(&quot;telephonenumber&quot;) )</span>
<a href="#l26.209"></a><span id="l26.209">     {</span>
<a href="#l26.210"></a><span id="l26.210" class="difflineat">@@ -753,17 +753,17 @@ static const char *const sLDIFFields[] =</span>
<a href="#l26.211"></a><span id="l26.211">     &quot;dn&quot;,</span>
<a href="#l26.212"></a><span id="l26.212">     &quot;cn&quot;,</span>
<a href="#l26.213"></a><span id="l26.213">     &quot;givenName&quot;,</span>
<a href="#l26.214"></a><span id="l26.214">     &quot;mail&quot;,</span>
<a href="#l26.215"></a><span id="l26.215">     nullptr</span>
<a href="#l26.216"></a><span id="l26.216"> };</span>
<a href="#l26.217"></a><span id="l26.217"> #define kMaxLDIFLen        14</span>
<a href="#l26.218"></a><span id="l26.218"> </span>
<a href="#l26.219"></a><span id="l26.219" class="difflineminus">-// Count total number of legal ldif fields and records in the first 100 lines of the </span>
<a href="#l26.220"></a><span id="l26.220" class="difflineplus">+// Count total number of legal ldif fields and records in the first 100 lines of the</span>
<a href="#l26.221"></a><span id="l26.221"> // file and if the average legal ldif field is 3 or higher than it's a valid ldif file.</span>
<a href="#l26.222"></a><span id="l26.222"> NS_IMETHODIMP nsAbLDIFService::IsLDIFFile(nsIFile *pSrc, bool *_retval)</span>
<a href="#l26.223"></a><span id="l26.223"> {</span>
<a href="#l26.224"></a><span id="l26.224">   NS_ENSURE_ARG_POINTER(pSrc);</span>
<a href="#l26.225"></a><span id="l26.225">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l26.226"></a><span id="l26.226"> </span>
<a href="#l26.227"></a><span id="l26.227">   *_retval = false;</span>
<a href="#l26.228"></a><span id="l26.228"> </span>
<a href="#l26.229"></a><span id="l26.229" class="difflineat">@@ -796,29 +796,29 @@ NS_IMETHODIMP nsAbLDIFService::IsLDIFFil</span>
<a href="#l26.230"></a><span id="l26.230">     {</span>
<a href="#l26.231"></a><span id="l26.231">       pChar = line.get();</span>
<a href="#l26.232"></a><span id="l26.232">       lineLen = line.Length();</span>
<a href="#l26.233"></a><span id="l26.233">       if (!lineLen &amp;&amp; gotLDIF)</span>
<a href="#l26.234"></a><span id="l26.234">       {</span>
<a href="#l26.235"></a><span id="l26.235">         recCount++;</span>
<a href="#l26.236"></a><span id="l26.236">         gotLDIF = false;</span>
<a href="#l26.237"></a><span id="l26.237">       }</span>
<a href="#l26.238"></a><span id="l26.238" class="difflineminus">-                   </span>
<a href="#l26.239"></a><span id="l26.239" class="difflineplus">+</span>
<a href="#l26.240"></a><span id="l26.240">       if (lineLen &amp;&amp; (*pChar != ' ') &amp;&amp; (*pChar != '\t'))</span>
<a href="#l26.241"></a><span id="l26.241">       {</span>
<a href="#l26.242"></a><span id="l26.242">         fLen = 0;</span>
<a href="#l26.243"></a><span id="l26.243"> </span>
<a href="#l26.244"></a><span id="l26.244">         while (lineLen &amp;&amp; (fLen &lt; (kMaxLDIFLen - 1)) &amp;&amp; (*pChar != ':'))</span>
<a href="#l26.245"></a><span id="l26.245">         {</span>
<a href="#l26.246"></a><span id="l26.246">           field[fLen] = *pChar;</span>
<a href="#l26.247"></a><span id="l26.247">           pChar++;</span>
<a href="#l26.248"></a><span id="l26.248">           fLen++;</span>
<a href="#l26.249"></a><span id="l26.249">           lineLen--;</span>
<a href="#l26.250"></a><span id="l26.250">         }</span>
<a href="#l26.251"></a><span id="l26.251" class="difflineminus">-                </span>
<a href="#l26.252"></a><span id="l26.252" class="difflineplus">+</span>
<a href="#l26.253"></a><span id="l26.253">         field[fLen] = 0;</span>
<a href="#l26.254"></a><span id="l26.254"> </span>
<a href="#l26.255"></a><span id="l26.255">         if (lineLen &amp;&amp; (*pChar == ':') &amp;&amp; (fLen &lt; (kMaxLDIFLen - 1)))</span>
<a href="#l26.256"></a><span id="l26.256">         {</span>
<a href="#l26.257"></a><span id="l26.257">           // see if this is an ldif field (case insensitive)?</span>
<a href="#l26.258"></a><span id="l26.258">           i = 0;</span>
<a href="#l26.259"></a><span id="l26.259">           while (sLDIFFields[i])</span>
<a href="#l26.260"></a><span id="l26.260">           {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbMDBDirFactory.cpp</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbMDBDirFactory.cpp</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -29,17 +29,17 @@ nsAbMDBDirFactory::~nsAbMDBDirFactory()</span>
<a href="#l27.4"></a><span id="l27.4"> }</span>
<a href="#l27.5"></a><span id="l27.5"> </span>
<a href="#l27.6"></a><span id="l27.6"> NS_IMETHODIMP nsAbMDBDirFactory::GetDirectories(const nsAString &amp;aDirName,</span>
<a href="#l27.7"></a><span id="l27.7">                                                 const nsACString &amp;aURI,</span>
<a href="#l27.8"></a><span id="l27.8">                                                 const nsACString &amp;aPrefName,</span>
<a href="#l27.9"></a><span id="l27.9">                                                 nsISimpleEnumerator **_retval)</span>
<a href="#l27.10"></a><span id="l27.10"> {</span>
<a href="#l27.11"></a><span id="l27.11">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-  </span>
<a href="#l27.13"></a><span id="l27.13" class="difflineplus">+</span>
<a href="#l27.14"></a><span id="l27.14">   nsresult rv;</span>
<a href="#l27.15"></a><span id="l27.15"> </span>
<a href="#l27.16"></a><span id="l27.16">   nsCOMPtr&lt;nsIAbManager&gt; abManager = do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l27.17"></a><span id="l27.17">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l27.18"></a><span id="l27.18"> </span>
<a href="#l27.19"></a><span id="l27.19">   nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l27.20"></a><span id="l27.20">   rv = abManager-&gt;GetDirectory(aURI, getter_AddRefs(directory));</span>
<a href="#l27.21"></a><span id="l27.21">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l27.22"></a><span id="l27.22" class="difflineat">@@ -49,17 +49,17 @@ NS_IMETHODIMP nsAbMDBDirFactory::GetDire</span>
<a href="#l27.23"></a><span id="l27.23"> </span>
<a href="#l27.24"></a><span id="l27.24">   nsCOMPtr&lt;nsIFile&gt; dbPath;</span>
<a href="#l27.25"></a><span id="l27.25">   rv = abManager-&gt;GetUserProfileDirectory(getter_AddRefs(dbPath));</span>
<a href="#l27.26"></a><span id="l27.26"> </span>
<a href="#l27.27"></a><span id="l27.27">   nsCOMPtr&lt;nsIAddrDatabase&gt; listDatabase;</span>
<a href="#l27.28"></a><span id="l27.28">   if (NS_SUCCEEDED(rv))</span>
<a href="#l27.29"></a><span id="l27.29">   {</span>
<a href="#l27.30"></a><span id="l27.30">     nsAutoCString fileName;</span>
<a href="#l27.31"></a><span id="l27.31" class="difflineminus">-      </span>
<a href="#l27.32"></a><span id="l27.32" class="difflineplus">+</span>
<a href="#l27.33"></a><span id="l27.33">     if (StringBeginsWith(aURI, NS_LITERAL_CSTRING(kMDBDirectoryRoot)))</span>
<a href="#l27.34"></a><span id="l27.34">       fileName = Substring(aURI, kMDBDirectoryRootLen, aURI.Length() - kMDBDirectoryRootLen);</span>
<a href="#l27.35"></a><span id="l27.35"> </span>
<a href="#l27.36"></a><span id="l27.36">     rv = dbPath-&gt;AppendNative(fileName);</span>
<a href="#l27.37"></a><span id="l27.37">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l27.38"></a><span id="l27.38"> </span>
<a href="#l27.39"></a><span id="l27.39">     nsCOMPtr&lt;nsIAddrDatabase&gt; addrDBFactory = do_GetService(NS_ADDRDATABASE_CONTRACTID, &amp;rv);</span>
<a href="#l27.40"></a><span id="l27.40">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l27.41"></a><span id="l27.41" class="difflineat">@@ -74,17 +74,17 @@ NS_IMETHODIMP nsAbMDBDirFactory::GetDire</span>
<a href="#l27.42"></a><span id="l27.42">   return NS_NewSingletonEnumerator(_retval, directory);</span>
<a href="#l27.43"></a><span id="l27.43"> }</span>
<a href="#l27.44"></a><span id="l27.44"> </span>
<a href="#l27.45"></a><span id="l27.45"> /* void deleteDirectory (in nsIAbDirectory directory); */</span>
<a href="#l27.46"></a><span id="l27.46"> NS_IMETHODIMP nsAbMDBDirFactory::DeleteDirectory(nsIAbDirectory *directory)</span>
<a href="#l27.47"></a><span id="l27.47"> {</span>
<a href="#l27.48"></a><span id="l27.48">     if (!directory)</span>
<a href="#l27.49"></a><span id="l27.49">         return NS_ERROR_NULL_POINTER;</span>
<a href="#l27.50"></a><span id="l27.50" class="difflineminus">-    </span>
<a href="#l27.51"></a><span id="l27.51" class="difflineplus">+</span>
<a href="#l27.52"></a><span id="l27.52">     nsresult rv = NS_OK;</span>
<a href="#l27.53"></a><span id="l27.53"> </span>
<a href="#l27.54"></a><span id="l27.54">     nsCOMPtr&lt;nsIMutableArray&gt; pAddressLists;</span>
<a href="#l27.55"></a><span id="l27.55">     rv = directory-&gt;GetAddressLists(getter_AddRefs(pAddressLists));</span>
<a href="#l27.56"></a><span id="l27.56">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l27.57"></a><span id="l27.57"> </span>
<a href="#l27.58"></a><span id="l27.58">     uint32_t total;</span>
<a href="#l27.59"></a><span id="l27.59">     rv = pAddressLists-&gt;GetLength(&amp;total);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbMDBDirProperty.cpp</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbMDBDirProperty.cpp</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -1,14 +1,14 @@</span>
<a href="#l28.4"></a><span id="l28.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l28.5"></a><span id="l28.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l28.6"></a><span id="l28.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l28.7"></a><span id="l28.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l28.8"></a><span id="l28.8"> </span>
<a href="#l28.9"></a><span id="l28.9" class="difflineminus">-#include &quot;nsAbMDBDirProperty.h&quot;	 </span>
<a href="#l28.10"></a><span id="l28.10" class="difflineplus">+#include &quot;nsAbMDBDirProperty.h&quot;	</span>
<a href="#l28.11"></a><span id="l28.11"> #include &quot;nsIServiceManager.h&quot;</span>
<a href="#l28.12"></a><span id="l28.12"> #include &quot;nsString.h&quot;</span>
<a href="#l28.13"></a><span id="l28.13"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l28.14"></a><span id="l28.14"> #include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l28.15"></a><span id="l28.15"> #include &quot;nsAddrDatabase.h&quot;</span>
<a href="#l28.16"></a><span id="l28.16"> #include &quot;nsIAbCard.h&quot;</span>
<a href="#l28.17"></a><span id="l28.17"> #include &quot;nsIAbListener.h&quot;</span>
<a href="#l28.18"></a><span id="l28.18"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l28.19"></a><span id="l28.19" class="difflineat">@@ -17,17 +17,17 @@</span>
<a href="#l28.20"></a><span id="l28.20"> </span>
<a href="#l28.21"></a><span id="l28.21"> nsAbMDBDirProperty::nsAbMDBDirProperty(void)</span>
<a href="#l28.22"></a><span id="l28.22">   : nsAbDirProperty()</span>
<a href="#l28.23"></a><span id="l28.23"> {</span>
<a href="#l28.24"></a><span id="l28.24">   m_dbRowID = 0;</span>
<a href="#l28.25"></a><span id="l28.25"> }</span>
<a href="#l28.26"></a><span id="l28.26"> </span>
<a href="#l28.27"></a><span id="l28.27"> nsAbMDBDirProperty::~nsAbMDBDirProperty(void)</span>
<a href="#l28.28"></a><span id="l28.28" class="difflineminus">-{ </span>
<a href="#l28.29"></a><span id="l28.29" class="difflineplus">+{</span>
<a href="#l28.30"></a><span id="l28.30"> }</span>
<a href="#l28.31"></a><span id="l28.31"> </span>
<a href="#l28.32"></a><span id="l28.32"> </span>
<a href="#l28.33"></a><span id="l28.33"> NS_IMPL_ISUPPORTS_INHERITED(nsAbMDBDirProperty, nsAbDirProperty,</span>
<a href="#l28.34"></a><span id="l28.34">                              nsIAbDirectory,</span>
<a href="#l28.35"></a><span id="l28.35">                              nsISupportsWeakReference, nsIAbMDBDirectory)</span>
<a href="#l28.36"></a><span id="l28.36"> </span>
<a href="#l28.37"></a><span id="l28.37"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l28.38"></a><span id="l28.38" class="difflineat">@@ -84,17 +84,17 @@ NS_IMETHODIMP nsAbMDBDirProperty::AddAdd</span>
<a href="#l28.39"></a><span id="l28.39"> </span>
<a href="#l28.40"></a><span id="l28.40">   return NS_OK;</span>
<a href="#l28.41"></a><span id="l28.41"> }</span>
<a href="#l28.42"></a><span id="l28.42"> </span>
<a href="#l28.43"></a><span id="l28.43"> NS_IMETHODIMP nsAbMDBDirProperty::CopyDBMailList(nsIAbMDBDirectory* srcListDB)</span>
<a href="#l28.44"></a><span id="l28.44"> {</span>
<a href="#l28.45"></a><span id="l28.45"> 	nsresult err = NS_OK;</span>
<a href="#l28.46"></a><span id="l28.46"> 	nsCOMPtr&lt;nsIAbDirectory&gt; srcList(do_QueryInterface(srcListDB));</span>
<a href="#l28.47"></a><span id="l28.47" class="difflineminus">-	if (NS_FAILED(err)) </span>
<a href="#l28.48"></a><span id="l28.48" class="difflineplus">+	if (NS_FAILED(err))</span>
<a href="#l28.49"></a><span id="l28.49"> 		return NS_ERROR_NULL_POINTER;</span>
<a href="#l28.50"></a><span id="l28.50"> </span>
<a href="#l28.51"></a><span id="l28.51"> 	CopyMailList (srcList);</span>
<a href="#l28.52"></a><span id="l28.52"> </span>
<a href="#l28.53"></a><span id="l28.53"> 	uint32_t rowID;</span>
<a href="#l28.54"></a><span id="l28.54"> 	srcListDB-&gt;GetDbRowID(&amp;rowID);</span>
<a href="#l28.55"></a><span id="l28.55"> 	SetDbRowID(rowID);</span>
<a href="#l28.56"></a><span id="l28.56"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbMDBDirProperty.h</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbMDBDirProperty.h</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -1,36 +1,36 @@</span>
<a href="#l29.4"></a><span id="l29.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l29.5"></a><span id="l29.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l29.6"></a><span id="l29.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l29.7"></a><span id="l29.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l29.8"></a><span id="l29.8"> </span>
<a href="#l29.9"></a><span id="l29.9"> /********************************************************************************************************</span>
<a href="#l29.10"></a><span id="l29.10" class="difflineminus">- </span>
<a href="#l29.11"></a><span id="l29.11" class="difflineplus">+</span>
<a href="#l29.12"></a><span id="l29.12">    Interface for representing Address Book Directory</span>
<a href="#l29.13"></a><span id="l29.13" class="difflineminus">- </span>
<a href="#l29.14"></a><span id="l29.14" class="difflineplus">+</span>
<a href="#l29.15"></a><span id="l29.15"> *********************************************************************************************************/</span>
<a href="#l29.16"></a><span id="l29.16"> </span>
<a href="#l29.17"></a><span id="l29.17"> #ifndef nsAbMDBDirProperty_h__</span>
<a href="#l29.18"></a><span id="l29.18"> #define nsAbMDBDirProperty_h__</span>
<a href="#l29.19"></a><span id="l29.19"> </span>
<a href="#l29.20"></a><span id="l29.20"> #include &quot;nsIAbMDBDirectory.h&quot;</span>
<a href="#l29.21"></a><span id="l29.21"> #include &quot;nsAbDirProperty.h&quot;</span>
<a href="#l29.22"></a><span id="l29.22"> #include &quot;nsIAbCard.h&quot;</span>
<a href="#l29.23"></a><span id="l29.23"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l29.24"></a><span id="l29.24"> #include &quot;nsDirPrefs.h&quot;</span>
<a href="#l29.25"></a><span id="l29.25"> #include &quot;nsIAddrDatabase.h&quot;</span>
<a href="#l29.26"></a><span id="l29.26"> </span>
<a href="#l29.27"></a><span id="l29.27" class="difflineminus">- /* </span>
<a href="#l29.28"></a><span id="l29.28" class="difflineplus">+ /*</span>
<a href="#l29.29"></a><span id="l29.29">   * Address Book Directory</span>
<a href="#l29.30"></a><span id="l29.30" class="difflineminus">-  */ </span>
<a href="#l29.31"></a><span id="l29.31" class="difflineplus">+  */</span>
<a href="#l29.32"></a><span id="l29.32"> </span>
<a href="#l29.33"></a><span id="l29.33"> class nsAbMDBDirProperty: public nsIAbMDBDirectory, public nsAbDirProperty</span>
<a href="#l29.34"></a><span id="l29.34"> {</span>
<a href="#l29.35"></a><span id="l29.35" class="difflineminus">-public: </span>
<a href="#l29.36"></a><span id="l29.36" class="difflineplus">+public:</span>
<a href="#l29.37"></a><span id="l29.37"> 	nsAbMDBDirProperty(void);</span>
<a href="#l29.38"></a><span id="l29.38"> </span>
<a href="#l29.39"></a><span id="l29.39"> 	NS_DECL_ISUPPORTS</span>
<a href="#l29.40"></a><span id="l29.40"> 	NS_DECL_NSIABMDBDIRECTORY</span>
<a href="#l29.41"></a><span id="l29.41"> </span>
<a href="#l29.42"></a><span id="l29.42"> protected:</span>
<a href="#l29.43"></a><span id="l29.43">   virtual ~nsAbMDBDirProperty();</span>
<a href="#l29.44"></a><span id="l29.44"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbMDBDirectory.cpp</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbMDBDirectory.cpp</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -1,14 +1,14 @@</span>
<a href="#l30.4"></a><span id="l30.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l30.5"></a><span id="l30.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l30.6"></a><span id="l30.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l30.7"></a><span id="l30.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l30.8"></a><span id="l30.8"> </span>
<a href="#l30.9"></a><span id="l30.9" class="difflineminus">-#include &quot;nsAbMDBDirectory.h&quot; </span>
<a href="#l30.10"></a><span id="l30.10" class="difflineplus">+#include &quot;nsAbMDBDirectory.h&quot;</span>
<a href="#l30.11"></a><span id="l30.11"> #include &quot;nsString.h&quot;</span>
<a href="#l30.12"></a><span id="l30.12"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l30.13"></a><span id="l30.13"> #include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l30.14"></a><span id="l30.14"> #include &quot;nsAddrDatabase.h&quot;</span>
<a href="#l30.15"></a><span id="l30.15"> #include &quot;nsIAbListener.h&quot;</span>
<a href="#l30.16"></a><span id="l30.16"> #include &quot;nsIAbManager.h&quot;</span>
<a href="#l30.17"></a><span id="l30.17"> #include &quot;nsIURL.h&quot;</span>
<a href="#l30.18"></a><span id="l30.18"> #include &quot;nsNetCID.h&quot;</span>
<a href="#l30.19"></a><span id="l30.19" class="difflineat">@@ -112,17 +112,17 @@ NS_IMETHODIMP nsAbMDBDirectory::Init(con</span>
<a href="#l30.20"></a><span id="l30.20">             {</span>
<a href="#l30.21"></a><span id="l30.21">               nsAutoCString prefName(StringHead(child, dotOffset));</span>
<a href="#l30.22"></a><span id="l30.22">               m_DirPrefId.AssignLiteral(PREF_LDAP_SERVER_TREE_NAME &quot;.&quot;);</span>
<a href="#l30.23"></a><span id="l30.23">               m_DirPrefId.Append(prefName);</span>
<a href="#l30.24"></a><span id="l30.24">             }</span>
<a href="#l30.25"></a><span id="l30.25">           }</span>
<a href="#l30.26"></a><span id="l30.26">         }</span>
<a href="#l30.27"></a><span id="l30.27">       }</span>
<a href="#l30.28"></a><span id="l30.28" class="difflineminus">-    }     </span>
<a href="#l30.29"></a><span id="l30.29" class="difflineplus">+    }</span>
<a href="#l30.30"></a><span id="l30.30">     NS_FREE_XPCOM_ALLOCATED_POINTER_ARRAY(childCount, childArray);</span>
<a href="#l30.31"></a><span id="l30.31"> </span>
<a href="#l30.32"></a><span id="l30.32">     NS_ASSERTION(!m_DirPrefId.IsEmpty(),</span>
<a href="#l30.33"></a><span id="l30.33">                  &quot;Error, Could not set m_DirPrefId in nsAbMDBDirectory::Init&quot;);</span>
<a href="#l30.34"></a><span id="l30.34">   }</span>
<a href="#l30.35"></a><span id="l30.35"> </span>
<a href="#l30.36"></a><span id="l30.36">   return nsAbDirProperty::Init(aUri);</span>
<a href="#l30.37"></a><span id="l30.37"> }</span>
<a href="#l30.38"></a><span id="l30.38" class="difflineat">@@ -165,17 +165,17 @@ nsresult nsAbMDBDirectory::RemoveCardFro</span>
<a href="#l30.39"></a><span id="l30.39">     {</span>
<a href="#l30.40"></a><span id="l30.40">       // First remove the instance in the database</span>
<a href="#l30.41"></a><span id="l30.41">       mDatabase-&gt;DeleteCardFromMailList(listDir, card, false);</span>
<a href="#l30.42"></a><span id="l30.42"> </span>
<a href="#l30.43"></a><span id="l30.43">       // Now remove the instance in any lists we hold.</span>
<a href="#l30.44"></a><span id="l30.44">       nsCOMPtr&lt;nsIMutableArray&gt; pAddressLists;</span>
<a href="#l30.45"></a><span id="l30.45">       listDir-&gt;GetAddressLists(getter_AddRefs(pAddressLists));</span>
<a href="#l30.46"></a><span id="l30.46">       if (pAddressLists)</span>
<a href="#l30.47"></a><span id="l30.47" class="difflineminus">-      {  </span>
<a href="#l30.48"></a><span id="l30.48" class="difflineplus">+      {</span>
<a href="#l30.49"></a><span id="l30.49">         uint32_t total;</span>
<a href="#l30.50"></a><span id="l30.50">         rv = pAddressLists-&gt;GetLength(&amp;total);</span>
<a href="#l30.51"></a><span id="l30.51">         for (j = total - 1; j &gt;= 0; j--)</span>
<a href="#l30.52"></a><span id="l30.52">         {</span>
<a href="#l30.53"></a><span id="l30.53">           nsCOMPtr&lt;nsIAbCard&gt; cardInList(do_QueryElementAt(pAddressLists, j, &amp;rv));</span>
<a href="#l30.54"></a><span id="l30.54">           bool equals;</span>
<a href="#l30.55"></a><span id="l30.55">           rv = cardInList-&gt;Equals(card, &amp;equals);  // should we checking email?</span>
<a href="#l30.56"></a><span id="l30.56">           if (NS_SUCCEEDED(rv) &amp;&amp; equals)</span>
<a href="#l30.57"></a><span id="l30.57" class="difflineat">@@ -252,26 +252,26 @@ nsresult nsAbMDBDirectory::NotifyItemDel</span>
<a href="#l30.58"></a><span id="l30.58">     abManager-&gt;NotifyDirectoryItemDeleted(this, item);</span>
<a href="#l30.59"></a><span id="l30.59"> </span>
<a href="#l30.60"></a><span id="l30.60">   return NS_OK;</span>
<a href="#l30.61"></a><span id="l30.61"> }</span>
<a href="#l30.62"></a><span id="l30.62"> </span>
<a href="#l30.63"></a><span id="l30.63"> // nsIAbMDBDirectory methods</span>
<a href="#l30.64"></a><span id="l30.64"> </span>
<a href="#l30.65"></a><span id="l30.65"> NS_IMETHODIMP nsAbMDBDirectory::ClearDatabase()</span>
<a href="#l30.66"></a><span id="l30.66" class="difflineminus">-{       </span>
<a href="#l30.67"></a><span id="l30.67" class="difflineplus">+{</span>
<a href="#l30.68"></a><span id="l30.68">   if (mIsQueryURI)</span>
<a href="#l30.69"></a><span id="l30.69">     return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l30.70"></a><span id="l30.70"> </span>
<a href="#l30.71"></a><span id="l30.71">   if (mDatabase)</span>
<a href="#l30.72"></a><span id="l30.72">   {</span>
<a href="#l30.73"></a><span id="l30.73">     mDatabase-&gt;RemoveListener(this);</span>
<a href="#l30.74"></a><span id="l30.74" class="difflineminus">-    mDatabase = nullptr; </span>
<a href="#l30.75"></a><span id="l30.75" class="difflineplus">+    mDatabase = nullptr;</span>
<a href="#l30.76"></a><span id="l30.76">   }</span>
<a href="#l30.77"></a><span id="l30.77" class="difflineminus">-  return NS_OK; </span>
<a href="#l30.78"></a><span id="l30.78" class="difflineplus">+  return NS_OK;</span>
<a href="#l30.79"></a><span id="l30.79"> }</span>
<a href="#l30.80"></a><span id="l30.80"> </span>
<a href="#l30.81"></a><span id="l30.81"> NS_IMETHODIMP nsAbMDBDirectory::RemoveElementsFromAddressList()</span>
<a href="#l30.82"></a><span id="l30.82"> {</span>
<a href="#l30.83"></a><span id="l30.83">   if (mIsQueryURI)</span>
<a href="#l30.84"></a><span id="l30.84">     return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l30.85"></a><span id="l30.85"> </span>
<a href="#l30.86"></a><span id="l30.86">   if (m_AddressList)</span>
<a href="#l30.87"></a><span id="l30.87" class="difflineat">@@ -477,17 +477,17 @@ NS_IMETHODIMP nsAbMDBDirectory::DeleteCa</span>
<a href="#l30.88"></a><span id="l30.88">         {</span>
<a href="#l30.89"></a><span id="l30.89">           mDatabase-&gt;DeleteCardFromMailList(this, card, true);</span>
<a href="#l30.90"></a><span id="l30.90"> </span>
<a href="#l30.91"></a><span id="l30.91">           uint32_t cardTotal = 0;</span>
<a href="#l30.92"></a><span id="l30.92">           int32_t i;</span>
<a href="#l30.93"></a><span id="l30.93">           if (m_AddressList)</span>
<a href="#l30.94"></a><span id="l30.94">             rv = m_AddressList-&gt;GetLength(&amp;cardTotal);</span>
<a href="#l30.95"></a><span id="l30.95">           for (i = cardTotal - 1; i &gt;= 0; i--)</span>
<a href="#l30.96"></a><span id="l30.96" class="difflineminus">-          {            </span>
<a href="#l30.97"></a><span id="l30.97" class="difflineplus">+          {</span>
<a href="#l30.98"></a><span id="l30.98">             nsCOMPtr&lt;nsIAbCard&gt; arrayCard(do_QueryElementAt(m_AddressList, i, &amp;rv));</span>
<a href="#l30.99"></a><span id="l30.99">             if (arrayCard)</span>
<a href="#l30.100"></a><span id="l30.100">             {</span>
<a href="#l30.101"></a><span id="l30.101">               // No card can have a row ID of 0</span>
<a href="#l30.102"></a><span id="l30.102">               uint32_t arrayRowID = 0;</span>
<a href="#l30.103"></a><span id="l30.103">               arrayCard-&gt;GetPropertyAsUint32(&quot;DbRowID&quot;, &amp;arrayRowID);</span>
<a href="#l30.104"></a><span id="l30.104">               if (rowID == arrayRowID)</span>
<a href="#l30.105"></a><span id="l30.105">                 m_AddressList-&gt;RemoveElementAt(i);</span>
<a href="#l30.106"></a><span id="l30.106" class="difflineat">@@ -523,17 +523,17 @@ NS_IMETHODIMP nsAbMDBDirectory::DeleteCa</span>
<a href="#l30.107"></a><span id="l30.107"> </span>
<a href="#l30.108"></a><span id="l30.108">               mSubDirectories.RemoveObject(listDir);</span>
<a href="#l30.109"></a><span id="l30.109"> </span>
<a href="#l30.110"></a><span id="l30.110">               if (listDir)</span>
<a href="#l30.111"></a><span id="l30.111">                 NotifyItemDeleted(listDir);</span>
<a href="#l30.112"></a><span id="l30.112">             }</span>
<a href="#l30.113"></a><span id="l30.113">           }</span>
<a href="#l30.114"></a><span id="l30.114">           else</span>
<a href="#l30.115"></a><span id="l30.115" class="difflineminus">-          { </span>
<a href="#l30.116"></a><span id="l30.116" class="difflineplus">+          {</span>
<a href="#l30.117"></a><span id="l30.117">             rv = RemoveCardFromAddressList(card);</span>
<a href="#l30.118"></a><span id="l30.118">             NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l30.119"></a><span id="l30.119">           }</span>
<a href="#l30.120"></a><span id="l30.120">         }</span>
<a href="#l30.121"></a><span id="l30.121">       }</span>
<a href="#l30.122"></a><span id="l30.122">     }</span>
<a href="#l30.123"></a><span id="l30.123">     mDatabase-&gt;Commit(nsAddrDBCommitType::kLargeCommit);</span>
<a href="#l30.124"></a><span id="l30.124">   }</span>
<a href="#l30.125"></a><span id="l30.125" class="difflineat">@@ -567,17 +567,17 @@ NS_IMETHODIMP nsAbMDBDirectory::HasDirec</span>
<a href="#l30.126"></a><span id="l30.126"> {</span>
<a href="#l30.127"></a><span id="l30.127">   if (!hasDir)</span>
<a href="#l30.128"></a><span id="l30.128">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l30.129"></a><span id="l30.129"> </span>
<a href="#l30.130"></a><span id="l30.130">   nsresult rv;</span>
<a href="#l30.131"></a><span id="l30.131"> </span>
<a href="#l30.132"></a><span id="l30.132">   nsCOMPtr&lt;nsIAbMDBDirectory&gt; dbdir(do_QueryInterface(dir, &amp;rv));</span>
<a href="#l30.133"></a><span id="l30.133">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.134"></a><span id="l30.134" class="difflineminus">-  </span>
<a href="#l30.135"></a><span id="l30.135" class="difflineplus">+</span>
<a href="#l30.136"></a><span id="l30.136">   bool bIsMailingList  = false;</span>
<a href="#l30.137"></a><span id="l30.137">   dir-&gt;GetIsMailList(&amp;bIsMailingList);</span>
<a href="#l30.138"></a><span id="l30.138">   if (bIsMailingList)</span>
<a href="#l30.139"></a><span id="l30.139">   {</span>
<a href="#l30.140"></a><span id="l30.140">     nsCOMPtr&lt;nsIAddrDatabase&gt; database;</span>
<a href="#l30.141"></a><span id="l30.141">     rv = GetDatabase(getter_AddRefs(database));</span>
<a href="#l30.142"></a><span id="l30.142"> </span>
<a href="#l30.143"></a><span id="l30.143">     if (NS_SUCCEEDED(rv))</span>
<a href="#l30.144"></a><span id="l30.144" class="difflineat">@@ -624,17 +624,17 @@ NS_IMETHODIMP nsAbMDBDirectory::AddMailL</span>
<a href="#l30.145"></a><span id="l30.145">     if (!newlist)</span>
<a href="#l30.146"></a><span id="l30.146">       return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l30.147"></a><span id="l30.147"> </span>
<a href="#l30.148"></a><span id="l30.148">     rv = newlist-&gt;CopyMailList(list);</span>
<a href="#l30.149"></a><span id="l30.149">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.150"></a><span id="l30.150"> </span>
<a href="#l30.151"></a><span id="l30.151">     dblist = do_QueryInterface(newlist, &amp;rv);</span>
<a href="#l30.152"></a><span id="l30.152">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.153"></a><span id="l30.153" class="difflineminus">-    </span>
<a href="#l30.154"></a><span id="l30.154" class="difflineplus">+</span>
<a href="#l30.155"></a><span id="l30.155">     mDatabase-&gt;CreateMailListAndAddToDB(newlist, true, this);</span>
<a href="#l30.156"></a><span id="l30.156">   }</span>
<a href="#l30.157"></a><span id="l30.157">   else</span>
<a href="#l30.158"></a><span id="l30.158">     mDatabase-&gt;CreateMailListAndAddToDB(list, true, this);</span>
<a href="#l30.159"></a><span id="l30.159"> </span>
<a href="#l30.160"></a><span id="l30.160">   mDatabase-&gt;Commit(nsAddrDBCommitType::kLargeCommit);</span>
<a href="#l30.161"></a><span id="l30.161"> </span>
<a href="#l30.162"></a><span id="l30.162">   uint32_t dbRowID;</span>
<a href="#l30.163"></a><span id="l30.163" class="difflineat">@@ -721,22 +721,22 @@ NS_IMETHODIMP nsAbMDBDirectory::DropCard</span>
<a href="#l30.164"></a><span id="l30.164">     newCard = do_CreateInstance(NS_ABMDBCARD_CONTRACTID, &amp;rv);</span>
<a href="#l30.165"></a><span id="l30.165">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.166"></a><span id="l30.166"> </span>
<a href="#l30.167"></a><span id="l30.167">     rv = newCard-&gt;Copy(aCard);</span>
<a href="#l30.168"></a><span id="l30.168">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.169"></a><span id="l30.169">   }</span>
<a href="#l30.170"></a><span id="l30.170">   else {</span>
<a href="#l30.171"></a><span id="l30.171">     newCard = aCard;</span>
<a href="#l30.172"></a><span id="l30.172" class="difflineminus">-  }  </span>
<a href="#l30.173"></a><span id="l30.173" class="difflineplus">+  }</span>
<a href="#l30.174"></a><span id="l30.174"> </span>
<a href="#l30.175"></a><span id="l30.175">   if (m_IsMailList) {</span>
<a href="#l30.176"></a><span id="l30.176">     if (needToCopyCard) {</span>
<a href="#l30.177"></a><span id="l30.177">       nsCOMPtr &lt;nsIMdbRow&gt; cardRow;</span>
<a href="#l30.178"></a><span id="l30.178" class="difflineminus">-      // if card doesn't exist in db, add the card to the directory that </span>
<a href="#l30.179"></a><span id="l30.179" class="difflineplus">+      // if card doesn't exist in db, add the card to the directory that</span>
<a href="#l30.180"></a><span id="l30.180">       // contains the mailing list.</span>
<a href="#l30.181"></a><span id="l30.181">       mDatabase-&gt;FindRowByCard(newCard, getter_AddRefs(cardRow));</span>
<a href="#l30.182"></a><span id="l30.182">       if (!cardRow)</span>
<a href="#l30.183"></a><span id="l30.183">         mDatabase-&gt;CreateNewCardAndAddToDB(newCard, true /* notify */, this);</span>
<a href="#l30.184"></a><span id="l30.184">       else</span>
<a href="#l30.185"></a><span id="l30.185">         mDatabase-&gt;InitCardFromRow(newCard, cardRow);</span>
<a href="#l30.186"></a><span id="l30.186">     }</span>
<a href="#l30.187"></a><span id="l30.187">     // since we didn't copy the card, we don't have to notify that it was inserted</span>
<a href="#l30.188"></a><span id="l30.188" class="difflineat">@@ -841,32 +841,32 @@ NS_IMETHODIMP nsAbMDBDirectory::OnCardEn</span>
<a href="#l30.189"></a><span id="l30.189">     break;</span>
<a href="#l30.190"></a><span id="l30.190">   case AB_NotifyPropertyChanged:</span>
<a href="#l30.191"></a><span id="l30.191">     rv = NotifyItemChanged(cardSupports);</span>
<a href="#l30.192"></a><span id="l30.192">     break;</span>
<a href="#l30.193"></a><span id="l30.193">   default:</span>
<a href="#l30.194"></a><span id="l30.194">     rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l30.195"></a><span id="l30.195">     break;</span>
<a href="#l30.196"></a><span id="l30.196">   }</span>
<a href="#l30.197"></a><span id="l30.197" class="difflineminus">-    </span>
<a href="#l30.198"></a><span id="l30.198" class="difflineplus">+</span>
<a href="#l30.199"></a><span id="l30.199">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.200"></a><span id="l30.200">   return rv;</span>
<a href="#l30.201"></a><span id="l30.201"> }</span>
<a href="#l30.202"></a><span id="l30.202"> </span>
<a href="#l30.203"></a><span id="l30.203"> NS_IMETHODIMP nsAbMDBDirectory::OnListEntryChange</span>
<a href="#l30.204"></a><span id="l30.204"> (uint32_t abCode, nsIAbDirectory *list)</span>
<a href="#l30.205"></a><span id="l30.205"> {</span>
<a href="#l30.206"></a><span id="l30.206">   nsresult rv = NS_OK;</span>
<a href="#l30.207"></a><span id="l30.207" class="difflineminus">-  </span>
<a href="#l30.208"></a><span id="l30.208" class="difflineplus">+</span>
<a href="#l30.209"></a><span id="l30.209">   if (abCode == AB_NotifyPropertyChanged &amp;&amp; list)</span>
<a href="#l30.210"></a><span id="l30.210">   {</span>
<a href="#l30.211"></a><span id="l30.211">     bool bIsMailList = false;</span>
<a href="#l30.212"></a><span id="l30.212">     rv = list-&gt;GetIsMailList(&amp;bIsMailList);</span>
<a href="#l30.213"></a><span id="l30.213">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l30.214"></a><span id="l30.214" class="difflineminus">-    </span>
<a href="#l30.215"></a><span id="l30.215" class="difflineplus">+</span>
<a href="#l30.216"></a><span id="l30.216">     nsCOMPtr&lt;nsIAbMDBDirectory&gt; dblist(do_QueryInterface(list, &amp;rv));</span>
<a href="#l30.217"></a><span id="l30.217">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l30.218"></a><span id="l30.218"> </span>
<a href="#l30.219"></a><span id="l30.219">     if (bIsMailList) {</span>
<a href="#l30.220"></a><span id="l30.220">       nsString listName;</span>
<a href="#l30.221"></a><span id="l30.221">       rv = list-&gt;GetDirName(listName);</span>
<a href="#l30.222"></a><span id="l30.222">       NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l30.223"></a><span id="l30.223"> </span>
<a href="#l30.224"></a><span id="l30.224" class="difflineat">@@ -902,17 +902,17 @@ NS_IMETHODIMP nsAbMDBDirectory::StartSea</span>
<a href="#l30.225"></a><span id="l30.225">   nsCOMPtr&lt;nsIAbBooleanExpression&gt; expression;</span>
<a href="#l30.226"></a><span id="l30.226">   rv = nsAbQueryStringToExpression::Convert(mQueryString,</span>
<a href="#l30.227"></a><span id="l30.227">     getter_AddRefs(expression));</span>
<a href="#l30.228"></a><span id="l30.228">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.229"></a><span id="l30.229"> </span>
<a href="#l30.230"></a><span id="l30.230">   rv = arguments-&gt;SetExpression(expression);</span>
<a href="#l30.231"></a><span id="l30.231">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.232"></a><span id="l30.232"> </span>
<a href="#l30.233"></a><span id="l30.233" class="difflineminus">-  // don't search the subdirectories </span>
<a href="#l30.234"></a><span id="l30.234" class="difflineplus">+  // don't search the subdirectories</span>
<a href="#l30.235"></a><span id="l30.235">   // if the current directory is a mailing list, it won't have any subdirectories</span>
<a href="#l30.236"></a><span id="l30.236">   // if the current directory is a addressbook, searching both it</span>
<a href="#l30.237"></a><span id="l30.237">   // and the subdirectories (the mailing lists), will yield duplicate results</span>
<a href="#l30.238"></a><span id="l30.238">   // because every entry in a mailing list will be an entry in the parent addressbook</span>
<a href="#l30.239"></a><span id="l30.239">   rv = arguments-&gt;SetQuerySubDirectories(false);</span>
<a href="#l30.240"></a><span id="l30.240">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.241"></a><span id="l30.241"> </span>
<a href="#l30.242"></a><span id="l30.242">   nsCOMPtr&lt;nsIAbManager&gt; abManager =</span>
<a href="#l30.243"></a><span id="l30.243" class="difflineat">@@ -934,17 +934,17 @@ NS_IMETHODIMP nsAbMDBDirectory::StartSea</span>
<a href="#l30.244"></a><span id="l30.244"> </span>
<a href="#l30.245"></a><span id="l30.245">   if (isQuery)</span>
<a href="#l30.246"></a><span id="l30.246">   {</span>
<a href="#l30.247"></a><span id="l30.247">     NS_ERROR(&quot;Attempting to search a directory within a search&quot;);</span>
<a href="#l30.248"></a><span id="l30.248">     return NS_ERROR_FAILURE;</span>
<a href="#l30.249"></a><span id="l30.249">   }</span>
<a href="#l30.250"></a><span id="l30.250"> </span>
<a href="#l30.251"></a><span id="l30.251">   // Initiate the proxy query with the no query directory</span>
<a href="#l30.252"></a><span id="l30.252" class="difflineminus">-  nsCOMPtr&lt;nsIAbDirectoryQueryProxy&gt; queryProxy = </span>
<a href="#l30.253"></a><span id="l30.253" class="difflineplus">+  nsCOMPtr&lt;nsIAbDirectoryQueryProxy&gt; queryProxy =</span>
<a href="#l30.254"></a><span id="l30.254">       do_CreateInstance(NS_ABDIRECTORYQUERYPROXY_CONTRACTID, &amp;rv);</span>
<a href="#l30.255"></a><span id="l30.255">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.256"></a><span id="l30.256"> </span>
<a href="#l30.257"></a><span id="l30.257">   rv = queryProxy-&gt;Initiate();</span>
<a href="#l30.258"></a><span id="l30.258">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.259"></a><span id="l30.259"> </span>
<a href="#l30.260"></a><span id="l30.260">   rv = queryProxy-&gt;DoQuery(directory, arguments, this, -1, 0, &amp;mContext);</span>
<a href="#l30.261"></a><span id="l30.261">   return NS_OK;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbMDBDirectory.h</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbMDBDirectory.h</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -1,44 +1,44 @@</span>
<a href="#l31.4"></a><span id="l31.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l31.5"></a><span id="l31.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l31.6"></a><span id="l31.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l31.7"></a><span id="l31.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l31.8"></a><span id="l31.8"> </span>
<a href="#l31.9"></a><span id="l31.9"> /********************************************************************************************************</span>
<a href="#l31.10"></a><span id="l31.10" class="difflineminus">- </span>
<a href="#l31.11"></a><span id="l31.11" class="difflineplus">+</span>
<a href="#l31.12"></a><span id="l31.12">    Interface for representing Address Book Directory</span>
<a href="#l31.13"></a><span id="l31.13" class="difflineminus">- </span>
<a href="#l31.14"></a><span id="l31.14" class="difflineplus">+</span>
<a href="#l31.15"></a><span id="l31.15"> *********************************************************************************************************/</span>
<a href="#l31.16"></a><span id="l31.16"> </span>
<a href="#l31.17"></a><span id="l31.17"> #ifndef nsAbMDBDirectory_h__</span>
<a href="#l31.18"></a><span id="l31.18"> #define nsAbMDBDirectory_h__</span>
<a href="#l31.19"></a><span id="l31.19"> </span>
<a href="#l31.20"></a><span id="l31.20"> #include &quot;mozilla/Attributes.h&quot;</span>
<a href="#l31.21"></a><span id="l31.21" class="difflineminus">-#include &quot;nsAbMDBDirProperty.h&quot;  </span>
<a href="#l31.22"></a><span id="l31.22" class="difflineplus">+#include &quot;nsAbMDBDirProperty.h&quot;</span>
<a href="#l31.23"></a><span id="l31.23"> #include &quot;nsIAbCard.h&quot;</span>
<a href="#l31.24"></a><span id="l31.24"> #include &quot;nsCOMArray.h&quot;</span>
<a href="#l31.25"></a><span id="l31.25"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l31.26"></a><span id="l31.26"> #include &quot;nsDirPrefs.h&quot;</span>
<a href="#l31.27"></a><span id="l31.27"> #include &quot;nsIAbDirectorySearch.h&quot;</span>
<a href="#l31.28"></a><span id="l31.28"> #include &quot;nsIAbDirSearchListener.h&quot;</span>
<a href="#l31.29"></a><span id="l31.29"> #include &quot;nsInterfaceHashtable.h&quot;</span>
<a href="#l31.30"></a><span id="l31.30"> #include &quot;nsIAddrDBListener.h&quot;</span>
<a href="#l31.31"></a><span id="l31.31"> </span>
<a href="#l31.32"></a><span id="l31.32" class="difflineminus">-/* </span>
<a href="#l31.33"></a><span id="l31.33" class="difflineplus">+/*</span>
<a href="#l31.34"></a><span id="l31.34">  * Address Book Directory</span>
<a href="#l31.35"></a><span id="l31.35" class="difflineminus">- */ </span>
<a href="#l31.36"></a><span id="l31.36" class="difflineplus">+ */</span>
<a href="#l31.37"></a><span id="l31.37"> </span>
<a href="#l31.38"></a><span id="l31.38"> class nsAbMDBDirectory:</span>
<a href="#l31.39"></a><span id="l31.39">   public nsAbMDBDirProperty,	// nsIAbDirectory, nsIAbMDBDirectory</span>
<a href="#l31.40"></a><span id="l31.40">   public nsIAbDirSearchListener,</span>
<a href="#l31.41"></a><span id="l31.41" class="difflineminus">-  public nsIAddrDBListener, </span>
<a href="#l31.42"></a><span id="l31.42" class="difflineplus">+  public nsIAddrDBListener,</span>
<a href="#l31.43"></a><span id="l31.43">   public nsIAbDirectorySearch</span>
<a href="#l31.44"></a><span id="l31.44"> {</span>
<a href="#l31.45"></a><span id="l31.45" class="difflineminus">-public: </span>
<a href="#l31.46"></a><span id="l31.46" class="difflineplus">+public:</span>
<a href="#l31.47"></a><span id="l31.47">   nsAbMDBDirectory(void);</span>
<a href="#l31.48"></a><span id="l31.48"> </span>
<a href="#l31.49"></a><span id="l31.49">   NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l31.50"></a><span id="l31.50">   NS_DECL_NSIADDRDBLISTENER</span>
<a href="#l31.51"></a><span id="l31.51"> </span>
<a href="#l31.52"></a><span id="l31.52">   // Override nsAbMDBDirProperty::Init</span>
<a href="#l31.53"></a><span id="l31.53">   NS_IMETHOD Init(const char *aUri) override;</span>
<a href="#l31.54"></a><span id="l31.54"> </span>
<a href="#l31.55"></a><span id="l31.55" class="difflineat">@@ -86,17 +86,17 @@ protected:</span>
<a href="#l31.56"></a><span id="l31.56">   virtual ~nsAbMDBDirectory();</span>
<a href="#l31.57"></a><span id="l31.57">   nsresult NotifyPropertyChanged(nsIAbDirectory *list, const char *property, const char16_t* oldValue, const char16_t* newValue);</span>
<a href="#l31.58"></a><span id="l31.58">   nsresult NotifyItemAdded(nsISupports *item);</span>
<a href="#l31.59"></a><span id="l31.59">   nsresult NotifyItemDeleted(nsISupports *item);</span>
<a href="#l31.60"></a><span id="l31.60">   nsresult NotifyItemChanged(nsISupports *item);</span>
<a href="#l31.61"></a><span id="l31.61">   nsresult RemoveCardFromAddressList(nsIAbCard* card);</span>
<a href="#l31.62"></a><span id="l31.62"> </span>
<a href="#l31.63"></a><span id="l31.63">   nsresult GetAbDatabase();</span>
<a href="#l31.64"></a><span id="l31.64" class="difflineminus">-  nsCOMPtr&lt;nsIAddrDatabase&gt; mDatabase;  </span>
<a href="#l31.65"></a><span id="l31.65" class="difflineplus">+  nsCOMPtr&lt;nsIAddrDatabase&gt; mDatabase;</span>
<a href="#l31.66"></a><span id="l31.66"> </span>
<a href="#l31.67"></a><span id="l31.67">   nsCOMArray&lt;nsIAbDirectory&gt; mSubDirectories;</span>
<a href="#l31.68"></a><span id="l31.68"> </span>
<a href="#l31.69"></a><span id="l31.69">   int32_t mContext;</span>
<a href="#l31.70"></a><span id="l31.70">   bool mPerformingQuery;</span>
<a href="#l31.71"></a><span id="l31.71"> </span>
<a href="#l31.72"></a><span id="l31.72">   nsInterfaceHashtable&lt;nsISupportsHashKey, nsIAbCard&gt; mSearchCache;</span>
<a href="#l31.73"></a><span id="l31.73"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbManager.h</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbManager.h</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -1,33 +1,33 @@</span>
<a href="#l32.4"></a><span id="l32.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l32.5"></a><span id="l32.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l32.6"></a><span id="l32.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l32.7"></a><span id="l32.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l32.8"></a><span id="l32.8"> </span>
<a href="#l32.9"></a><span id="l32.9"> #ifndef __nsAbManager_h</span>
<a href="#l32.10"></a><span id="l32.10"> #define __nsAbManager_h</span>
<a href="#l32.11"></a><span id="l32.11" class="difflineminus">- </span>
<a href="#l32.12"></a><span id="l32.12" class="difflineplus">+</span>
<a href="#l32.13"></a><span id="l32.13"> #include &quot;nsIAbManager.h&quot;</span>
<a href="#l32.14"></a><span id="l32.14"> #include &quot;nsTObserverArray.h&quot;</span>
<a href="#l32.15"></a><span id="l32.15"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l32.16"></a><span id="l32.16"> #include &quot;nsICommandLineHandler.h&quot;</span>
<a href="#l32.17"></a><span id="l32.17"> #include &quot;nsIObserver.h&quot;</span>
<a href="#l32.18"></a><span id="l32.18"> #include &quot;nsInterfaceHashtable.h&quot;</span>
<a href="#l32.19"></a><span id="l32.19"> #include &quot;nsIAbDirFactoryService.h&quot;</span>
<a href="#l32.20"></a><span id="l32.20"> #include &quot;nsIAbDirectory.h&quot;</span>
<a href="#l32.21"></a><span id="l32.21"> #include &quot;nsIFilePicker.h&quot;</span>
<a href="#l32.22"></a><span id="l32.22"> </span>
<a href="#l32.23"></a><span id="l32.23"> class nsIAbLDAPAttributeMap;</span>
<a href="#l32.24"></a><span id="l32.24"> </span>
<a href="#l32.25"></a><span id="l32.25"> class nsAbManager : public nsIAbManager,</span>
<a href="#l32.26"></a><span id="l32.26">                     public nsICommandLineHandler,</span>
<a href="#l32.27"></a><span id="l32.27">                     public nsIObserver</span>
<a href="#l32.28"></a><span id="l32.28"> {</span>
<a href="#l32.29"></a><span id="l32.29" class="difflineminus">-  </span>
<a href="#l32.30"></a><span id="l32.30" class="difflineplus">+</span>
<a href="#l32.31"></a><span id="l32.31"> public:</span>
<a href="#l32.32"></a><span id="l32.32"> 	nsAbManager();</span>
<a href="#l32.33"></a><span id="l32.33"> </span>
<a href="#l32.34"></a><span id="l32.34"> 	NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l32.35"></a><span id="l32.35">  	NS_DECL_NSIABMANAGER</span>
<a href="#l32.36"></a><span id="l32.36">   NS_DECL_NSIOBSERVER</span>
<a href="#l32.37"></a><span id="l32.37">   NS_DECL_NSICOMMANDLINEHANDLER</span>
<a href="#l32.38"></a><span id="l32.38"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbOSXCard.h</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbOSXCard.h</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineat">@@ -27,17 +27,17 @@ public:</span>
<a href="#l33.4"></a><span id="l33.4"> </span>
<a href="#l33.5"></a><span id="l33.5"> NS_DEFINE_STATIC_IID_ACCESSOR(nsIAbOSXCard, NS_IABOSXCARD_IID)</span>
<a href="#l33.6"></a><span id="l33.6"> </span>
<a href="#l33.7"></a><span id="l33.7"> class nsAbOSXCard : public nsAbCardProperty,</span>
<a href="#l33.8"></a><span id="l33.8">                     public nsIAbOSXCard</span>
<a href="#l33.9"></a><span id="l33.9"> {</span>
<a href="#l33.10"></a><span id="l33.10"> public:</span>
<a href="#l33.11"></a><span id="l33.11">   NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l33.12"></a><span id="l33.12" class="difflineminus">-    </span>
<a href="#l33.13"></a><span id="l33.13" class="difflineplus">+</span>
<a href="#l33.14"></a><span id="l33.14">   nsresult Update(bool aNotify) override;</span>
<a href="#l33.15"></a><span id="l33.15">   nsresult GetURI(nsACString &amp;aURI) override;</span>
<a href="#l33.16"></a><span id="l33.16">   nsresult Init(const char *aUri) override;</span>
<a href="#l33.17"></a><span id="l33.17">   // this is needed so nsAbOSXUtils.mm can get at nsAbCardProperty</span>
<a href="#l33.18"></a><span id="l33.18">   friend class nsAbOSXUtils;</span>
<a href="#l33.19"></a><span id="l33.19"> private:</span>
<a href="#l33.20"></a><span id="l33.20">   nsCString mURI;</span>
<a href="#l33.21"></a><span id="l33.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbOSXDirFactory.cpp</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbOSXDirFactory.cpp</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineat">@@ -16,34 +16,34 @@ NS_IMPL_ISUPPORTS(nsAbOSXDirFactory, nsI</span>
<a href="#l34.4"></a><span id="l34.4"> </span>
<a href="#l34.5"></a><span id="l34.5"> NS_IMETHODIMP</span>
<a href="#l34.6"></a><span id="l34.6"> nsAbOSXDirFactory::GetDirectories(const nsAString &amp;aDirName,</span>
<a href="#l34.7"></a><span id="l34.7">                                   const nsACString &amp;aURI,</span>
<a href="#l34.8"></a><span id="l34.8">                                   const nsACString &amp;aPrefName,</span>
<a href="#l34.9"></a><span id="l34.9">                                   nsISimpleEnumerator **aDirectories)</span>
<a href="#l34.10"></a><span id="l34.10"> {</span>
<a href="#l34.11"></a><span id="l34.11">   NS_ENSURE_ARG_POINTER(aDirectories);</span>
<a href="#l34.12"></a><span id="l34.12" class="difflineminus">-  </span>
<a href="#l34.13"></a><span id="l34.13" class="difflineplus">+</span>
<a href="#l34.14"></a><span id="l34.14">   *aDirectories = nullptr;</span>
<a href="#l34.15"></a><span id="l34.15"> </span>
<a href="#l34.16"></a><span id="l34.16">   nsresult rv;</span>
<a href="#l34.17"></a><span id="l34.17">   nsCOMPtr&lt;nsIAbManager&gt; abManager(do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv));</span>
<a href="#l34.18"></a><span id="l34.18">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.19"></a><span id="l34.19"> </span>
<a href="#l34.20"></a><span id="l34.20">   nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l34.21"></a><span id="l34.21">   rv = abManager-&gt;GetDirectory(NS_LITERAL_CSTRING(NS_ABOSXDIRECTORY_URI_PREFIX &quot;/&quot;),</span>
<a href="#l34.22"></a><span id="l34.22">                                getter_AddRefs(directory));</span>
<a href="#l34.23"></a><span id="l34.23">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.24"></a><span id="l34.24" class="difflineminus">-  </span>
<a href="#l34.25"></a><span id="l34.25" class="difflineplus">+</span>
<a href="#l34.26"></a><span id="l34.26">   nsCOMPtr&lt;nsIAbOSXDirectory&gt; osxDirectory(do_QueryInterface(directory, &amp;rv));</span>
<a href="#l34.27"></a><span id="l34.27">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.28"></a><span id="l34.28"> </span>
<a href="#l34.29"></a><span id="l34.29">   rv = osxDirectory-&gt;AssertChildNodes();</span>
<a href="#l34.30"></a><span id="l34.30">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.31"></a><span id="l34.31" class="difflineminus">-  </span>
<a href="#l34.32"></a><span id="l34.32" class="difflineplus">+</span>
<a href="#l34.33"></a><span id="l34.33">   return NS_NewSingletonEnumerator(aDirectories, osxDirectory);</span>
<a href="#l34.34"></a><span id="l34.34"> }</span>
<a href="#l34.35"></a><span id="l34.35"> </span>
<a href="#l34.36"></a><span id="l34.36"> // No actual deletion, since you cannot create the address books from Mozilla.</span>
<a href="#l34.37"></a><span id="l34.37"> NS_IMETHODIMP</span>
<a href="#l34.38"></a><span id="l34.38"> nsAbOSXDirFactory::DeleteDirectory(nsIAbDirectory *aDirectory)</span>
<a href="#l34.39"></a><span id="l34.39"> {</span>
<a href="#l34.40"></a><span id="l34.40">   return NS_OK;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbOSXDirectory.h</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbOSXDirectory.h</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineat">@@ -26,17 +26,17 @@ class nsIAbBooleanExpression;</span>
<a href="#l35.4"></a><span id="l35.4"> #define NS_IABOSXDIRECTORY_IID \</span>
<a href="#l35.5"></a><span id="l35.5"> { 0x87ee4bd9, 0x8552, 0x498f, \</span>
<a href="#l35.6"></a><span id="l35.6">   { 0x80, 0x85, 0x34, 0xf0, 0x2a, 0xbb, 0x56, 0x16 } }</span>
<a href="#l35.7"></a><span id="l35.7"> </span>
<a href="#l35.8"></a><span id="l35.8"> class nsIAbOSXDirectory : public nsISupports</span>
<a href="#l35.9"></a><span id="l35.9"> {</span>
<a href="#l35.10"></a><span id="l35.10"> public:</span>
<a href="#l35.11"></a><span id="l35.11">   NS_DECLARE_STATIC_IID_ACCESSOR(NS_IABOSXDIRECTORY_IID)</span>
<a href="#l35.12"></a><span id="l35.12" class="difflineminus">-  </span>
<a href="#l35.13"></a><span id="l35.13" class="difflineplus">+</span>
<a href="#l35.14"></a><span id="l35.14">   virtual nsresult AssertChildNodes() = 0;</span>
<a href="#l35.15"></a><span id="l35.15">   virtual nsresult Update() = 0;</span>
<a href="#l35.16"></a><span id="l35.16">   virtual nsresult AssertDirectory(nsIAbManager *aManager,</span>
<a href="#l35.17"></a><span id="l35.17">                                    nsIAbDirectory *aDirectory) = 0;</span>
<a href="#l35.18"></a><span id="l35.18">   virtual nsresult AssertCard(nsIAbManager *aManager,</span>
<a href="#l35.19"></a><span id="l35.19">                               nsIAbCard *aCard) = 0;</span>
<a href="#l35.20"></a><span id="l35.20">   virtual nsresult UnassertCard(nsIAbManager *aManager,</span>
<a href="#l35.21"></a><span id="l35.21">                                 nsIAbCard *aCard,</span>
<a href="#l35.22"></a><span id="l35.22" class="difflineat">@@ -52,23 +52,23 @@ public:</span>
<a href="#l35.23"></a><span id="l35.23"> NS_DEFINE_STATIC_IID_ACCESSOR(nsIAbOSXDirectory, NS_IABOSXDIRECTORY_IID)</span>
<a href="#l35.24"></a><span id="l35.24"> </span>
<a href="#l35.25"></a><span id="l35.25"> class nsAbOSXDirectory final : public nsAbDirProperty,</span>
<a href="#l35.26"></a><span id="l35.26"> public nsIAbDirSearchListener,</span>
<a href="#l35.27"></a><span id="l35.27"> public nsIAbOSXDirectory</span>
<a href="#l35.28"></a><span id="l35.28"> {</span>
<a href="#l35.29"></a><span id="l35.29"> public:</span>
<a href="#l35.30"></a><span id="l35.30">   nsAbOSXDirectory();</span>
<a href="#l35.31"></a><span id="l35.31" class="difflineminus">-  </span>
<a href="#l35.32"></a><span id="l35.32" class="difflineplus">+</span>
<a href="#l35.33"></a><span id="l35.33">   NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l35.34"></a><span id="l35.34">   NS_DECL_NSIABDIRSEARCHLISTENER</span>
<a href="#l35.35"></a><span id="l35.35" class="difflineminus">-    </span>
<a href="#l35.36"></a><span id="l35.36" class="difflineplus">+</span>
<a href="#l35.37"></a><span id="l35.37">   // nsIAbOSXDirectory method</span>
<a href="#l35.38"></a><span id="l35.38">   NS_IMETHOD Init(const char *aUri) override;</span>
<a href="#l35.39"></a><span id="l35.39" class="difflineminus">-  </span>
<a href="#l35.40"></a><span id="l35.40" class="difflineplus">+</span>
<a href="#l35.41"></a><span id="l35.41">   // nsAbDirProperty methods</span>
<a href="#l35.42"></a><span id="l35.42">   NS_IMETHOD GetReadOnly(bool *aReadOnly) override;</span>
<a href="#l35.43"></a><span id="l35.43">   NS_IMETHOD GetChildCards(nsISimpleEnumerator **aCards) override;</span>
<a href="#l35.44"></a><span id="l35.44">   NS_IMETHOD GetChildNodes(nsISimpleEnumerator **aNodes) override;</span>
<a href="#l35.45"></a><span id="l35.45">   NS_IMETHOD GetIsQuery(bool *aResult) override;</span>
<a href="#l35.46"></a><span id="l35.46">   NS_IMETHOD HasCard(nsIAbCard *aCard, bool *aHasCard) override;</span>
<a href="#l35.47"></a><span id="l35.47">   NS_IMETHOD HasDirectory(nsIAbDirectory *aDirectory, bool *aHasDirectory) override;</span>
<a href="#l35.48"></a><span id="l35.48">   NS_IMETHOD GetURI(nsACString &amp;aURI) override;</span>
<a href="#l35.49"></a><span id="l35.49" class="difflineat">@@ -89,17 +89,17 @@ public:</span>
<a href="#l35.50"></a><span id="l35.50">                            nsIAbDirectory *aDirectory) override;</span>
<a href="#l35.51"></a><span id="l35.51">   nsresult AssertCard(nsIAbManager *aManager,</span>
<a href="#l35.52"></a><span id="l35.52">                       nsIAbCard *aCard) override;</span>
<a href="#l35.53"></a><span id="l35.53">   nsresult UnassertCard(nsIAbManager *aManager,</span>
<a href="#l35.54"></a><span id="l35.54">                         nsIAbCard *aCard,</span>
<a href="#l35.55"></a><span id="l35.55">                         nsIMutableArray *aCardList) override;</span>
<a href="#l35.56"></a><span id="l35.56">   nsresult UnassertDirectory(nsIAbManager *aManager,</span>
<a href="#l35.57"></a><span id="l35.57">                              nsIAbDirectory *aDirectory) override;</span>
<a href="#l35.58"></a><span id="l35.58" class="difflineminus">-  </span>
<a href="#l35.59"></a><span id="l35.59" class="difflineplus">+</span>
<a href="#l35.60"></a><span id="l35.60">   nsresult Update() override;</span>
<a href="#l35.61"></a><span id="l35.61"> </span>
<a href="#l35.62"></a><span id="l35.62">   nsresult DeleteUid(const nsACString &amp;aUid) override;</span>
<a href="#l35.63"></a><span id="l35.63"> </span>
<a href="#l35.64"></a><span id="l35.64">   nsresult GetCardByUri(const nsACString &amp;aUri, nsIAbOSXCard **aResult) override;</span>
<a href="#l35.65"></a><span id="l35.65"> </span>
<a href="#l35.66"></a><span id="l35.66">   nsresult GetRootOSXDirectory(nsIAbOSXDirectory **aResult);</span>
<a href="#l35.67"></a><span id="l35.67"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbOutlookDirectory.cpp</span>
<a href="#l36.2"></a><span id="l36.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbOutlookDirectory.cpp</span>
<a href="#l36.3"></a><span id="l36.3" class="difflineat">@@ -116,17 +116,17 @@ NS_IMETHODIMP nsAbOutlookDirectory::GetU</span>
<a href="#l36.4"></a><span id="l36.4">   return NS_OK;</span>
<a href="#l36.5"></a><span id="l36.5"> }</span>
<a href="#l36.6"></a><span id="l36.6"> </span>
<a href="#l36.7"></a><span id="l36.7"> NS_IMETHODIMP nsAbOutlookDirectory::GetChildNodes(nsISimpleEnumerator **aNodes)</span>
<a href="#l36.8"></a><span id="l36.8"> {</span>
<a href="#l36.9"></a><span id="l36.9">   NS_ENSURE_ARG_POINTER(aNodes);</span>
<a href="#l36.10"></a><span id="l36.10"> </span>
<a href="#l36.11"></a><span id="l36.11">   *aNodes = nullptr;</span>
<a href="#l36.12"></a><span id="l36.12" class="difflineminus">-    </span>
<a href="#l36.13"></a><span id="l36.13" class="difflineplus">+</span>
<a href="#l36.14"></a><span id="l36.14">   if (mIsQueryURI) {</span>
<a href="#l36.15"></a><span id="l36.15">     return NS_NewEmptyEnumerator(aNodes);</span>
<a href="#l36.16"></a><span id="l36.16">   }</span>
<a href="#l36.17"></a><span id="l36.17"> </span>
<a href="#l36.18"></a><span id="l36.18">   nsresult rv;</span>
<a href="#l36.19"></a><span id="l36.19">   nsCOMPtr&lt;nsIMutableArray&gt; nodeList(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l36.20"></a><span id="l36.20">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l36.21"></a><span id="l36.21"> </span>
<a href="#l36.22"></a><span id="l36.22" class="difflineat">@@ -272,38 +272,38 @@ NS_IMETHODIMP nsAbOutlookDirectory::Dele</span>
<a href="#l36.23"></a><span id="l36.23"> {</span>
<a href="#l36.24"></a><span id="l36.24">     if (mIsQueryURI) { return NS_ERROR_NOT_IMPLEMENTED ; }</span>
<a href="#l36.25"></a><span id="l36.25">     if (!aCardList) { return NS_ERROR_NULL_POINTER ; }</span>
<a href="#l36.26"></a><span id="l36.26">     uint32_t nbCards = 0 ;</span>
<a href="#l36.27"></a><span id="l36.27">     nsresult retCode = NS_OK ;</span>
<a href="#l36.28"></a><span id="l36.28">     nsAbWinHelperGuard mapiAddBook (mAbWinType) ;</span>
<a href="#l36.29"></a><span id="l36.29"> </span>
<a href="#l36.30"></a><span id="l36.30">     if (!mapiAddBook-&gt;IsOK()) { return NS_ERROR_FAILURE ; }</span>
<a href="#l36.31"></a><span id="l36.31" class="difflineminus">-    </span>
<a href="#l36.32"></a><span id="l36.32" class="difflineplus">+</span>
<a href="#l36.33"></a><span id="l36.33">     retCode = aCardList-&gt;GetLength(&amp;nbCards);</span>
<a href="#l36.34"></a><span id="l36.34">     NS_ENSURE_SUCCESS(retCode, retCode) ;</span>
<a href="#l36.35"></a><span id="l36.35">     uint32_t i = 0 ;</span>
<a href="#l36.36"></a><span id="l36.36">     nsAutoCString entryString ;</span>
<a href="#l36.37"></a><span id="l36.37">     nsMapiEntry cardEntry ;</span>
<a href="#l36.38"></a><span id="l36.38"> </span>
<a href="#l36.39"></a><span id="l36.39" class="difflineminus">-    for (i = 0 ; i &lt; nbCards ; ++ i) {</span>
<a href="#l36.40"></a><span id="l36.40" class="difflineplus">+    for (i = 0 ; i &lt; nbCards ; ++i) {</span>
<a href="#l36.41"></a><span id="l36.41">         nsCOMPtr&lt;nsIAbCard&gt; card(do_QueryElementAt(aCardList, i, &amp;retCode));</span>
<a href="#l36.42"></a><span id="l36.42">         NS_ENSURE_SUCCESS(retCode, retCode);</span>
<a href="#l36.43"></a><span id="l36.43"> </span>
<a href="#l36.44"></a><span id="l36.44">         retCode = ExtractCardEntry(card, entryString) ;</span>
<a href="#l36.45"></a><span id="l36.45">         if (NS_SUCCEEDED(retCode) &amp;&amp; !entryString.IsEmpty()) {</span>
<a href="#l36.46"></a><span id="l36.46">             card-&gt;SetDirectoryId(EmptyCString());</span>
<a href="#l36.47"></a><span id="l36.47"> </span>
<a href="#l36.48"></a><span id="l36.48">             cardEntry.Assign(entryString) ;</span>
<a href="#l36.49"></a><span id="l36.49">             if (!mapiAddBook-&gt;DeleteEntry(*mMapiData, cardEntry)) {</span>
<a href="#l36.50"></a><span id="l36.50">                 PRINTF((&quot;Cannot delete card %s.\n&quot;, entryString.get())) ;</span>
<a href="#l36.51"></a><span id="l36.51">             }</span>
<a href="#l36.52"></a><span id="l36.52">             else {</span>
<a href="#l36.53"></a><span id="l36.53">                 mCardList.Remove(card);</span>
<a href="#l36.54"></a><span id="l36.54" class="difflineminus">-                if (m_IsMailList &amp;&amp; m_AddressList) </span>
<a href="#l36.55"></a><span id="l36.55" class="difflineplus">+                if (m_IsMailList &amp;&amp; m_AddressList)</span>
<a href="#l36.56"></a><span id="l36.56">                 {</span>
<a href="#l36.57"></a><span id="l36.57">                     uint32_t pos;</span>
<a href="#l36.58"></a><span id="l36.58">                     if (NS_SUCCEEDED(m_AddressList-&gt;IndexOf(0, card, &amp;pos)))</span>
<a href="#l36.59"></a><span id="l36.59">                         m_AddressList-&gt;RemoveElementAt(pos);</span>
<a href="#l36.60"></a><span id="l36.60">                 }</span>
<a href="#l36.61"></a><span id="l36.61">                 retCode = NotifyItemDeletion(card);</span>
<a href="#l36.62"></a><span id="l36.62">                 NS_ENSURE_SUCCESS(retCode, retCode) ;</span>
<a href="#l36.63"></a><span id="l36.63">             }</span>
<a href="#l36.64"></a><span id="l36.64" class="difflineat">@@ -351,27 +351,27 @@ NS_IMETHODIMP nsAbOutlookDirectory::AddC</span>
<a href="#l36.65"></a><span id="l36.65"> {</span>
<a href="#l36.66"></a><span id="l36.66">     if (mIsQueryURI)</span>
<a href="#l36.67"></a><span id="l36.67">       return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l36.68"></a><span id="l36.68"> </span>
<a href="#l36.69"></a><span id="l36.69">     NS_ENSURE_ARG_POINTER(aData);</span>
<a href="#l36.70"></a><span id="l36.70"> </span>
<a href="#l36.71"></a><span id="l36.71">     nsresult retCode = NS_OK ;</span>
<a href="#l36.72"></a><span id="l36.72">     bool hasCard = false ;</span>
<a href="#l36.73"></a><span id="l36.73" class="difflineminus">-    </span>
<a href="#l36.74"></a><span id="l36.74" class="difflineplus">+</span>
<a href="#l36.75"></a><span id="l36.75">     retCode = HasCard(aData, &amp;hasCard) ;</span>
<a href="#l36.76"></a><span id="l36.76">     NS_ENSURE_SUCCESS(retCode, retCode) ;</span>
<a href="#l36.77"></a><span id="l36.77">     if (hasCard) {</span>
<a href="#l36.78"></a><span id="l36.78">         PRINTF((&quot;Has card.\n&quot;)) ;</span>
<a href="#l36.79"></a><span id="l36.79">         NS_IF_ADDREF(*addedCard = aData);</span>
<a href="#l36.80"></a><span id="l36.80" class="difflineminus">-        return NS_OK ; </span>
<a href="#l36.81"></a><span id="l36.81" class="difflineplus">+        return NS_OK ;</span>
<a href="#l36.82"></a><span id="l36.82">     }</span>
<a href="#l36.83"></a><span id="l36.83">     retCode = CreateCard(aData, addedCard) ;</span>
<a href="#l36.84"></a><span id="l36.84">     NS_ENSURE_SUCCESS(retCode, retCode) ;</span>
<a href="#l36.85"></a><span id="l36.85" class="difflineminus">-    </span>
<a href="#l36.86"></a><span id="l36.86" class="difflineplus">+</span>
<a href="#l36.87"></a><span id="l36.87">     mCardList.Put(*addedCard, *addedCard);</span>
<a href="#l36.88"></a><span id="l36.88"> </span>
<a href="#l36.89"></a><span id="l36.89">     if (!m_AddressList)</span>
<a href="#l36.90"></a><span id="l36.90">     {</span>
<a href="#l36.91"></a><span id="l36.91">         m_AddressList = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;retCode);</span>
<a href="#l36.92"></a><span id="l36.92">         NS_ENSURE_SUCCESS(retCode, retCode);</span>
<a href="#l36.93"></a><span id="l36.93">     }</span>
<a href="#l36.94"></a><span id="l36.94"> </span>
<a href="#l36.95"></a><span id="l36.95" class="difflineat">@@ -478,80 +478,80 @@ struct OutlookTableAttr</span>
<a href="#l36.96"></a><span id="l36.96"> {</span>
<a href="#l36.97"></a><span id="l36.97">     const char *mOuterName ;</span>
<a href="#l36.98"></a><span id="l36.98">     ULONG mMapiProp ;</span>
<a href="#l36.99"></a><span id="l36.99"> } ;</span>
<a href="#l36.100"></a><span id="l36.100"> </span>
<a href="#l36.101"></a><span id="l36.101"> // Here, we are forced to use the Ascii versions of the properties</span>
<a href="#l36.102"></a><span id="l36.102"> // instead of the widechar ones, because the content restriction</span>
<a href="#l36.103"></a><span id="l36.103"> // operators do not work on unicode strings in mapi.</span>
<a href="#l36.104"></a><span id="l36.104" class="difflineminus">-static const OutlookTableAttr OutlookTableStringToProp [] = </span>
<a href="#l36.105"></a><span id="l36.105" class="difflineplus">+static const OutlookTableAttr OutlookTableStringToProp[] =</span>
<a href="#l36.106"></a><span id="l36.106"> {</span>
<a href="#l36.107"></a><span id="l36.107">     {kFirstNameProperty, PR_GIVEN_NAME_A},</span>
<a href="#l36.108"></a><span id="l36.108">     {kLastNameProperty, PR_SURNAME_A},</span>
<a href="#l36.109"></a><span id="l36.109">     {kDisplayNameProperty, PR_DISPLAY_NAME_A},</span>
<a href="#l36.110"></a><span id="l36.110">     {kNicknameProperty, PR_NICKNAME_A},</span>
<a href="#l36.111"></a><span id="l36.111">     {kPriEmailProperty, PR_EMAIL_ADDRESS_A},</span>
<a href="#l36.112"></a><span id="l36.112">     {kWorkPhoneProperty, PR_BUSINESS_TELEPHONE_NUMBER_A},</span>
<a href="#l36.113"></a><span id="l36.113">     {kHomePhoneProperty, PR_HOME_TELEPHONE_NUMBER_A},</span>
<a href="#l36.114"></a><span id="l36.114">     {kFaxProperty, PR_BUSINESS_FAX_NUMBER_A},</span>
<a href="#l36.115"></a><span id="l36.115">     {kPagerProperty, PR_PAGER_TELEPHONE_NUMBER_A},</span>
<a href="#l36.116"></a><span id="l36.116">     {kCellularProperty, PR_MOBILE_TELEPHONE_NUMBER_A},</span>
<a href="#l36.117"></a><span id="l36.117">     {kHomeAddressProperty, PR_HOME_ADDRESS_STREET_A},</span>
<a href="#l36.118"></a><span id="l36.118">     {kHomeCityProperty, PR_HOME_ADDRESS_CITY_A},</span>
<a href="#l36.119"></a><span id="l36.119">     {kHomeStateProperty, PR_HOME_ADDRESS_STATE_OR_PROVINCE_A},</span>
<a href="#l36.120"></a><span id="l36.120">     {kHomeZipCodeProperty, PR_HOME_ADDRESS_POSTAL_CODE_A},</span>
<a href="#l36.121"></a><span id="l36.121">     {kHomeCountryProperty, PR_HOME_ADDRESS_COUNTRY_A},</span>
<a href="#l36.122"></a><span id="l36.122" class="difflineminus">-    {kWorkAddressProperty, PR_BUSINESS_ADDRESS_STREET_A}, </span>
<a href="#l36.123"></a><span id="l36.123" class="difflineplus">+    {kWorkAddressProperty, PR_BUSINESS_ADDRESS_STREET_A},</span>
<a href="#l36.124"></a><span id="l36.124">     {kWorkCityProperty, PR_BUSINESS_ADDRESS_CITY_A},</span>
<a href="#l36.125"></a><span id="l36.125">     {kWorkStateProperty, PR_BUSINESS_ADDRESS_STATE_OR_PROVINCE_A},</span>
<a href="#l36.126"></a><span id="l36.126">     {kWorkZipCodeProperty, PR_BUSINESS_ADDRESS_POSTAL_CODE_A},</span>
<a href="#l36.127"></a><span id="l36.127">     {kWorkCountryProperty, PR_BUSINESS_ADDRESS_COUNTRY_A},</span>
<a href="#l36.128"></a><span id="l36.128">     {kJobTitleProperty, PR_TITLE_A},</span>
<a href="#l36.129"></a><span id="l36.129">     {kDepartmentProperty, PR_DEPARTMENT_NAME_A},</span>
<a href="#l36.130"></a><span id="l36.130">     {kCompanyProperty, PR_COMPANY_NAME_A},</span>
<a href="#l36.131"></a><span id="l36.131">     {kWorkWebPageProperty, PR_BUSINESS_HOME_PAGE_A},</span>
<a href="#l36.132"></a><span id="l36.132">     {kHomeWebPageProperty, PR_PERSONAL_HOME_PAGE_A},</span>
<a href="#l36.133"></a><span id="l36.133">     // For the moment, we don't support querying on the birthday</span>
<a href="#l36.134"></a><span id="l36.134">     // sub-elements.</span>
<a href="#l36.135"></a><span id="l36.135"> #if 0</span>
<a href="#l36.136"></a><span id="l36.136">     {kBirthYearProperty, PR_BIRTHDAY},</span>
<a href="#l36.137"></a><span id="l36.137" class="difflineminus">-    {kBirthMonthProperty, PR_BIRTHDAY}, </span>
<a href="#l36.138"></a><span id="l36.138" class="difflineplus">+    {kBirthMonthProperty, PR_BIRTHDAY},</span>
<a href="#l36.139"></a><span id="l36.139">     {kBirthDayProperty, PR_BIRTHDAY},</span>
<a href="#l36.140"></a><span id="l36.140"> #endif // 0</span>
<a href="#l36.141"></a><span id="l36.141">     {kNotesProperty, PR_COMMENT_A}</span>
<a href="#l36.142"></a><span id="l36.142"> } ;</span>
<a href="#l36.143"></a><span id="l36.143"> </span>
<a href="#l36.144"></a><span id="l36.144"> static const uint32_t OutlookTableNbProps = sizeof(OutlookTableStringToProp) /</span>
<a href="#l36.145"></a><span id="l36.145" class="difflineminus">-                                            sizeof(OutlookTableStringToProp [0]) ;</span>
<a href="#l36.146"></a><span id="l36.146" class="difflineplus">+                                            sizeof(OutlookTableStringToProp[0]) ;</span>
<a href="#l36.147"></a><span id="l36.147"> </span>
<a href="#l36.148"></a><span id="l36.148"> static ULONG findPropertyTag(const char *aName) {</span>
<a href="#l36.149"></a><span id="l36.149">     uint32_t i = 0 ;</span>
<a href="#l36.150"></a><span id="l36.150" class="difflineminus">-    </span>
<a href="#l36.151"></a><span id="l36.151" class="difflineminus">-    for (i = 0 ; i &lt; OutlookTableNbProps ; ++ i) {</span>
<a href="#l36.152"></a><span id="l36.152" class="difflineminus">-        if (strcmp(aName, OutlookTableStringToProp [i].mOuterName) == 0) {</span>
<a href="#l36.153"></a><span id="l36.153" class="difflineminus">-            return OutlookTableStringToProp [i].mMapiProp ;</span>
<a href="#l36.154"></a><span id="l36.154" class="difflineplus">+</span>
<a href="#l36.155"></a><span id="l36.155" class="difflineplus">+    for (i = 0 ; i &lt; OutlookTableNbProps ; ++i) {</span>
<a href="#l36.156"></a><span id="l36.156" class="difflineplus">+        if (strcmp(aName, OutlookTableStringToProp[i].mOuterName) == 0) {</span>
<a href="#l36.157"></a><span id="l36.157" class="difflineplus">+            return OutlookTableStringToProp[i].mMapiProp ;</span>
<a href="#l36.158"></a><span id="l36.158">         }</span>
<a href="#l36.159"></a><span id="l36.159">     }</span>
<a href="#l36.160"></a><span id="l36.160">     return 0 ;</span>
<a href="#l36.161"></a><span id="l36.161"> }</span>
<a href="#l36.162"></a><span id="l36.162"> </span>
<a href="#l36.163"></a><span id="l36.163" class="difflineminus">-static nsresult BuildRestriction(nsIAbBooleanConditionString *aCondition, </span>
<a href="#l36.164"></a><span id="l36.164" class="difflineplus">+static nsresult BuildRestriction(nsIAbBooleanConditionString *aCondition,</span>
<a href="#l36.165"></a><span id="l36.165">                                  SRestriction&amp; aRestriction,</span>
<a href="#l36.166"></a><span id="l36.166">                                  bool&amp; aSkipItem)</span>
<a href="#l36.167"></a><span id="l36.167"> {</span>
<a href="#l36.168"></a><span id="l36.168">     if (!aCondition) { return NS_ERROR_NULL_POINTER ; }</span>
<a href="#l36.169"></a><span id="l36.169">     aSkipItem = false ;</span>
<a href="#l36.170"></a><span id="l36.170">     nsAbBooleanConditionType conditionType = 0 ;</span>
<a href="#l36.171"></a><span id="l36.171">     nsresult retCode = NS_OK ;</span>
<a href="#l36.172"></a><span id="l36.172">     nsCString name;</span>
<a href="#l36.173"></a><span id="l36.173">     nsString value;</span>
<a href="#l36.174"></a><span id="l36.174">     ULONG propertyTag = 0 ;</span>
<a href="#l36.175"></a><span id="l36.175">     nsAutoCString valueAscii ;</span>
<a href="#l36.176"></a><span id="l36.176" class="difflineminus">-    </span>
<a href="#l36.177"></a><span id="l36.177" class="difflineplus">+</span>
<a href="#l36.178"></a><span id="l36.178">     retCode = aCondition-&gt;GetCondition(&amp;conditionType) ;</span>
<a href="#l36.179"></a><span id="l36.179">     NS_ENSURE_SUCCESS(retCode, retCode) ;</span>
<a href="#l36.180"></a><span id="l36.180">     retCode = aCondition-&gt;GetName(getter_Copies(name)) ;</span>
<a href="#l36.181"></a><span id="l36.181">     NS_ENSURE_SUCCESS(retCode, retCode) ;</span>
<a href="#l36.182"></a><span id="l36.182">     retCode = aCondition-&gt;GetValue(getter_Copies(value)) ;</span>
<a href="#l36.183"></a><span id="l36.183">     NS_ENSURE_SUCCESS(retCode, retCode) ;</span>
<a href="#l36.184"></a><span id="l36.184">     LossyCopyUTF16toASCII(value, valueAscii);</span>
<a href="#l36.185"></a><span id="l36.185">     propertyTag = findPropertyTag(name.get()) ;</span>
<a href="#l36.186"></a><span id="l36.186" class="difflineat">@@ -664,41 +664,41 @@ static nsresult BuildRestriction(nsIAbBo</span>
<a href="#l36.187"></a><span id="l36.187">         break ;</span>
<a href="#l36.188"></a><span id="l36.188">     default :</span>
<a href="#l36.189"></a><span id="l36.189">         aSkipItem = true ;</span>
<a href="#l36.190"></a><span id="l36.190">         break ;</span>
<a href="#l36.191"></a><span id="l36.191">     }</span>
<a href="#l36.192"></a><span id="l36.192">     return retCode ;</span>
<a href="#l36.193"></a><span id="l36.193"> }</span>
<a href="#l36.194"></a><span id="l36.194"> </span>
<a href="#l36.195"></a><span id="l36.195" class="difflineminus">-static nsresult BuildRestriction(nsIAbBooleanExpression *aLevel, </span>
<a href="#l36.196"></a><span id="l36.196" class="difflineplus">+static nsresult BuildRestriction(nsIAbBooleanExpression *aLevel,</span>
<a href="#l36.197"></a><span id="l36.197">                                  SRestriction&amp; aRestriction)</span>
<a href="#l36.198"></a><span id="l36.198"> {</span>
<a href="#l36.199"></a><span id="l36.199">     if (!aLevel) { return NS_ERROR_NULL_POINTER ; }</span>
<a href="#l36.200"></a><span id="l36.200">     aRestriction.rt = RES_COMMENT ;</span>
<a href="#l36.201"></a><span id="l36.201">     nsresult retCode = NS_OK ;</span>
<a href="#l36.202"></a><span id="l36.202">     nsAbBooleanOperationType operationType = 0 ;</span>
<a href="#l36.203"></a><span id="l36.203">     uint32_t nbExpressions = 0 ;</span>
<a href="#l36.204"></a><span id="l36.204">     nsCOMPtr&lt;nsIArray&gt; expressions;</span>
<a href="#l36.205"></a><span id="l36.205"> </span>
<a href="#l36.206"></a><span id="l36.206">     retCode = aLevel-&gt;GetOperation(&amp;operationType);</span>
<a href="#l36.207"></a><span id="l36.207">     NS_ENSURE_SUCCESS(retCode, retCode);</span>
<a href="#l36.208"></a><span id="l36.208">     retCode = aLevel-&gt;GetExpressions(getter_AddRefs(expressions));</span>
<a href="#l36.209"></a><span id="l36.209">     NS_ENSURE_SUCCESS(retCode, retCode);</span>
<a href="#l36.210"></a><span id="l36.210">     retCode = expressions-&gt;GetLength(&amp;nbExpressions);</span>
<a href="#l36.211"></a><span id="l36.211">     NS_ENSURE_SUCCESS(retCode, retCode);</span>
<a href="#l36.212"></a><span id="l36.212" class="difflineminus">-    if (nbExpressions == 0) { </span>
<a href="#l36.213"></a><span id="l36.213" class="difflineplus">+    if (nbExpressions == 0) {</span>
<a href="#l36.214"></a><span id="l36.214">         PRINTF((&quot;Error, no expressions.\n&quot;)) ;</span>
<a href="#l36.215"></a><span id="l36.215">         return NS_OK ;</span>
<a href="#l36.216"></a><span id="l36.216">     }</span>
<a href="#l36.217"></a><span id="l36.217">     if (operationType == nsIAbBooleanOperationTypes::NOT &amp;&amp; nbExpressions != 1) {</span>
<a href="#l36.218"></a><span id="l36.218">         PRINTF((&quot;Error, unary operation NOT with multiple operands.\n&quot;)) ;</span>
<a href="#l36.219"></a><span id="l36.219">         return NS_OK ;</span>
<a href="#l36.220"></a><span id="l36.220">     }</span>
<a href="#l36.221"></a><span id="l36.221" class="difflineminus">-    LPSRestriction restrictionArray = new SRestriction [nbExpressions] ;</span>
<a href="#l36.222"></a><span id="l36.222" class="difflineplus">+    LPSRestriction restrictionArray = new SRestriction[nbExpressions] ;</span>
<a href="#l36.223"></a><span id="l36.223">     uint32_t realNbExpressions = 0 ;</span>
<a href="#l36.224"></a><span id="l36.224">     bool skipItem = false ;</span>
<a href="#l36.225"></a><span id="l36.225">     uint32_t i = 0 ;</span>
<a href="#l36.226"></a><span id="l36.226"> </span>
<a href="#l36.227"></a><span id="l36.227">     nsCOMPtr&lt;nsIAbBooleanConditionString&gt; condition;</span>
<a href="#l36.228"></a><span id="l36.228">     nsCOMPtr&lt;nsIAbBooleanExpression&gt; subExpression;</span>
<a href="#l36.229"></a><span id="l36.229"> </span>
<a href="#l36.230"></a><span id="l36.230">     for (i = 0; i &lt; nbExpressions; ++i) {</span>
<a href="#l36.231"></a><span id="l36.231" class="difflineat">@@ -710,17 +710,17 @@ static nsresult BuildRestriction(nsIAbBo</span>
<a href="#l36.232"></a><span id="l36.232">           if (!skipItem) {</span>
<a href="#l36.233"></a><span id="l36.233">             ++restrictionArray;</span>
<a href="#l36.234"></a><span id="l36.234">             ++realNbExpressions;</span>
<a href="#l36.235"></a><span id="l36.235">           }</span>
<a href="#l36.236"></a><span id="l36.236">         }</span>
<a href="#l36.237"></a><span id="l36.237">         else</span>
<a href="#l36.238"></a><span id="l36.238">           PRINTF((&quot;Cannot build restriction for item %d %08x.\n&quot;, i, retCode));</span>
<a href="#l36.239"></a><span id="l36.239">       }</span>
<a href="#l36.240"></a><span id="l36.240" class="difflineminus">-      else { </span>
<a href="#l36.241"></a><span id="l36.241" class="difflineplus">+      else {</span>
<a href="#l36.242"></a><span id="l36.242">         subExpression = do_QueryElementAt(expressions, i, &amp;retCode);</span>
<a href="#l36.243"></a><span id="l36.243"> </span>
<a href="#l36.244"></a><span id="l36.244">         if (NS_SUCCEEDED(retCode)) {</span>
<a href="#l36.245"></a><span id="l36.245">           retCode = BuildRestriction(subExpression, *restrictionArray);</span>
<a href="#l36.246"></a><span id="l36.246">           if (NS_SUCCEEDED(retCode)) {</span>
<a href="#l36.247"></a><span id="l36.247">             if (restrictionArray-&gt;rt != RES_COMMENT) {</span>
<a href="#l36.248"></a><span id="l36.248">               ++restrictionArray;</span>
<a href="#l36.249"></a><span id="l36.249">               ++realNbExpressions;</span>
<a href="#l36.250"></a><span id="l36.250" class="difflineat">@@ -746,17 +746,17 @@ static nsresult BuildRestriction(nsIAbBo</span>
<a href="#l36.251"></a><span id="l36.251">         }</span>
<a href="#l36.252"></a><span id="l36.252">         else {</span>
<a href="#l36.253"></a><span id="l36.253">             PRINTF((&quot;Unsupported operation %d.\n&quot;, operationType)) ;</span>
<a href="#l36.254"></a><span id="l36.254">         }</span>
<a href="#l36.255"></a><span id="l36.255">     }</span>
<a href="#l36.256"></a><span id="l36.256">     else if (realNbExpressions == 1) {</span>
<a href="#l36.257"></a><span id="l36.257">         if (operationType == nsIAbBooleanOperationTypes::NOT) {</span>
<a href="#l36.258"></a><span id="l36.258">             aRestriction.rt = RES_NOT ;</span>
<a href="#l36.259"></a><span id="l36.259" class="difflineminus">-            // This copy is to ensure that every NOT restriction is being </span>
<a href="#l36.260"></a><span id="l36.260" class="difflineplus">+            // This copy is to ensure that every NOT restriction is being</span>
<a href="#l36.261"></a><span id="l36.261">             // allocated by new and not new[] (see destruction of restriction)</span>
<a href="#l36.262"></a><span id="l36.262">             aRestriction.res.resNot.lpRes = new SRestriction ;</span>
<a href="#l36.263"></a><span id="l36.263">             memcpy(aRestriction.res.resNot.lpRes, restrictionArray, sizeof(SRestriction)) ;</span>
<a href="#l36.264"></a><span id="l36.264">         }</span>
<a href="#l36.265"></a><span id="l36.265">         else {</span>
<a href="#l36.266"></a><span id="l36.266">             // Case where the restriction array is redundant,</span>
<a href="#l36.267"></a><span id="l36.267">             // we need to fill the restriction directly.</span>
<a href="#l36.268"></a><span id="l36.268">             memcpy(&amp;aRestriction, restrictionArray, sizeof(SRestriction)) ;</span>
<a href="#l36.269"></a><span id="l36.269" class="difflineat">@@ -765,17 +765,17 @@ static nsresult BuildRestriction(nsIAbBo</span>
<a href="#l36.270"></a><span id="l36.270">     }</span>
<a href="#l36.271"></a><span id="l36.271">     if (aRestriction.rt == RES_COMMENT) {</span>
<a href="#l36.272"></a><span id="l36.272">         // This means we haven't really built any useful expression</span>
<a href="#l36.273"></a><span id="l36.273">         delete [] restrictionArray ;</span>
<a href="#l36.274"></a><span id="l36.274">     }</span>
<a href="#l36.275"></a><span id="l36.275">     return NS_OK ;</span>
<a href="#l36.276"></a><span id="l36.276"> }</span>
<a href="#l36.277"></a><span id="l36.277"> </span>
<a href="#l36.278"></a><span id="l36.278" class="difflineminus">-static nsresult BuildRestriction(nsIAbDirectoryQueryArguments *aArguments, </span>
<a href="#l36.279"></a><span id="l36.279" class="difflineplus">+static nsresult BuildRestriction(nsIAbDirectoryQueryArguments *aArguments,</span>
<a href="#l36.280"></a><span id="l36.280">                                  SRestriction&amp; aRestriction)</span>
<a href="#l36.281"></a><span id="l36.281"> {</span>
<a href="#l36.282"></a><span id="l36.282">     if (!aArguments) { return NS_ERROR_NULL_POINTER ; }</span>
<a href="#l36.283"></a><span id="l36.283">     nsresult retCode = NS_OK ;</span>
<a href="#l36.284"></a><span id="l36.284"> </span>
<a href="#l36.285"></a><span id="l36.285">     nsCOMPtr&lt;nsISupports&gt; supports ;</span>
<a href="#l36.286"></a><span id="l36.286">     retCode = aArguments-&gt;GetExpression(getter_AddRefs(supports)) ;</span>
<a href="#l36.287"></a><span id="l36.287">     NS_ENSURE_SUCCESS(retCode, retCode) ;</span>
<a href="#l36.288"></a><span id="l36.288" class="difflineat">@@ -787,18 +787,18 @@ static nsresult BuildRestriction(nsIAbDi</span>
<a href="#l36.289"></a><span id="l36.289"> }</span>
<a href="#l36.290"></a><span id="l36.290"> </span>
<a href="#l36.291"></a><span id="l36.291"> static void DestroyRestriction(SRestriction&amp; aRestriction)</span>
<a href="#l36.292"></a><span id="l36.292"> {</span>
<a href="#l36.293"></a><span id="l36.293">     switch(aRestriction.rt) {</span>
<a href="#l36.294"></a><span id="l36.294">     case RES_AND :</span>
<a href="#l36.295"></a><span id="l36.295">     case RES_OR :</span>
<a href="#l36.296"></a><span id="l36.296">         {</span>
<a href="#l36.297"></a><span id="l36.297" class="difflineminus">-            for (ULONG i = 0 ; i &lt; aRestriction.res.resAnd.cRes ; ++ i) {</span>
<a href="#l36.298"></a><span id="l36.298" class="difflineminus">-                DestroyRestriction(aRestriction.res.resAnd.lpRes [i]) ;</span>
<a href="#l36.299"></a><span id="l36.299" class="difflineplus">+            for (ULONG i = 0 ; i &lt; aRestriction.res.resAnd.cRes ; ++i) {</span>
<a href="#l36.300"></a><span id="l36.300" class="difflineplus">+                DestroyRestriction(aRestriction.res.resAnd.lpRes[i]) ;</span>
<a href="#l36.301"></a><span id="l36.301">             }</span>
<a href="#l36.302"></a><span id="l36.302">             delete [] aRestriction.res.resAnd.lpRes ;</span>
<a href="#l36.303"></a><span id="l36.303">         }</span>
<a href="#l36.304"></a><span id="l36.304">         break ;</span>
<a href="#l36.305"></a><span id="l36.305">     case RES_COMMENT :</span>
<a href="#l36.306"></a><span id="l36.306">         break ;</span>
<a href="#l36.307"></a><span id="l36.307">     case RES_CONTENT :</span>
<a href="#l36.308"></a><span id="l36.308">         if (PROP_TYPE(aRestriction.res.resContent.ulPropTag) == PT_UNICODE) {</span>
<a href="#l36.309"></a><span id="l36.309" class="difflineat">@@ -827,17 +827,17 @@ static void DestroyRestriction(SRestrict</span>
<a href="#l36.310"></a><span id="l36.310">         }</span>
<a href="#l36.311"></a><span id="l36.311">         delete aRestriction.res.resProperty.lpProp ;</span>
<a href="#l36.312"></a><span id="l36.312">     case RES_SIZE :</span>
<a href="#l36.313"></a><span id="l36.313">     case RES_SUBRESTRICTION :</span>
<a href="#l36.314"></a><span id="l36.314">         break ;</span>
<a href="#l36.315"></a><span id="l36.315">     }</span>
<a href="#l36.316"></a><span id="l36.316"> }</span>
<a href="#l36.317"></a><span id="l36.317"> </span>
<a href="#l36.318"></a><span id="l36.318" class="difflineminus">-struct QueryThreadArgs </span>
<a href="#l36.319"></a><span id="l36.319" class="difflineplus">+struct QueryThreadArgs</span>
<a href="#l36.320"></a><span id="l36.320"> {</span>
<a href="#l36.321"></a><span id="l36.321">     nsAbOutlookDirectory *mThis ;</span>
<a href="#l36.322"></a><span id="l36.322">     SRestriction mRestriction ;</span>
<a href="#l36.323"></a><span id="l36.323">     nsCOMPtr&lt;nsIAbDirSearchListener&gt; mListener ;</span>
<a href="#l36.324"></a><span id="l36.324">     int32_t mResultLimit ;</span>
<a href="#l36.325"></a><span id="l36.325">     int32_t mTimeout ;</span>
<a href="#l36.326"></a><span id="l36.326">     int32_t mThreadId ;</span>
<a href="#l36.327"></a><span id="l36.327"> } ;</span>
<a href="#l36.328"></a><span id="l36.328" class="difflineat">@@ -855,21 +855,21 @@ static void QueryThreadFunc(void *aArgum</span>
<a href="#l36.329"></a><span id="l36.329"> }</span>
<a href="#l36.330"></a><span id="l36.330"> </span>
<a href="#l36.331"></a><span id="l36.331"> NS_IMETHODIMP nsAbOutlookDirectory::DoQuery(nsIAbDirectory *aDirectory,</span>
<a href="#l36.332"></a><span id="l36.332">                                             nsIAbDirectoryQueryArguments *aArguments,</span>
<a href="#l36.333"></a><span id="l36.333">                                             nsIAbDirSearchListener *aListener,</span>
<a href="#l36.334"></a><span id="l36.334">                                             int32_t aResultLimit, int32_t aTimeout,</span>
<a href="#l36.335"></a><span id="l36.335">                                             int32_t *aReturnValue)</span>
<a href="#l36.336"></a><span id="l36.336"> {</span>
<a href="#l36.337"></a><span id="l36.337" class="difflineminus">-  if (!aArguments || !aListener || !aReturnValue)  { </span>
<a href="#l36.338"></a><span id="l36.338" class="difflineplus">+  if (!aArguments || !aListener || !aReturnValue)  {</span>
<a href="#l36.339"></a><span id="l36.339">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l36.340"></a><span id="l36.340">   }</span>
<a href="#l36.341"></a><span id="l36.341">   *aReturnValue = -1;</span>
<a href="#l36.342"></a><span id="l36.342" class="difflineminus">-    </span>
<a href="#l36.343"></a><span id="l36.343" class="difflineplus">+</span>
<a href="#l36.344"></a><span id="l36.344">   QueryThreadArgs *threadArgs = new QueryThreadArgs;</span>
<a href="#l36.345"></a><span id="l36.345">   PRThread *newThread = nullptr;</span>
<a href="#l36.346"></a><span id="l36.346"> </span>
<a href="#l36.347"></a><span id="l36.347">   if (!threadArgs)</span>
<a href="#l36.348"></a><span id="l36.348">     return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l36.349"></a><span id="l36.349"> </span>
<a href="#l36.350"></a><span id="l36.350">   nsresult rv = BuildRestriction(aArguments, threadArgs-&gt;mRestriction);</span>
<a href="#l36.351"></a><span id="l36.351">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l36.352"></a><span id="l36.352" class="difflineat">@@ -912,17 +912,17 @@ NS_IMETHODIMP nsAbOutlookDirectory::Stop</span>
<a href="#l36.353"></a><span id="l36.353">     return NS_OK;</span>
<a href="#l36.354"></a><span id="l36.354"> }</span>
<a href="#l36.355"></a><span id="l36.355"> </span>
<a href="#l36.356"></a><span id="l36.356"> // nsIAbDirectorySearch methods</span>
<a href="#l36.357"></a><span id="l36.357"> NS_IMETHODIMP nsAbOutlookDirectory::StartSearch(void)</span>
<a href="#l36.358"></a><span id="l36.358"> {</span>
<a href="#l36.359"></a><span id="l36.359">     if (!mIsQueryURI) { return NS_ERROR_NOT_IMPLEMENTED ; }</span>
<a href="#l36.360"></a><span id="l36.360">     nsresult retCode = NS_OK ;</span>
<a href="#l36.361"></a><span id="l36.361" class="difflineminus">-    </span>
<a href="#l36.362"></a><span id="l36.362" class="difflineplus">+</span>
<a href="#l36.363"></a><span id="l36.363">     retCode = StopSearch() ;</span>
<a href="#l36.364"></a><span id="l36.364">     NS_ENSURE_SUCCESS(retCode, retCode) ;</span>
<a href="#l36.365"></a><span id="l36.365">     mCardList.Clear();</span>
<a href="#l36.366"></a><span id="l36.366"> </span>
<a href="#l36.367"></a><span id="l36.367">     nsCOMPtr&lt;nsIAbBooleanExpression&gt; expression ;</span>
<a href="#l36.368"></a><span id="l36.368"> </span>
<a href="#l36.369"></a><span id="l36.369">     nsCOMPtr&lt;nsIAbDirectoryQueryArguments&gt; arguments = do_CreateInstance(NS_ABDIRECTORYQUERYARGUMENTS_CONTRACTID,&amp;retCode);</span>
<a href="#l36.370"></a><span id="l36.370">     NS_ENSURE_SUCCESS(retCode, retCode);</span>
<a href="#l36.371"></a><span id="l36.371" class="difflineat">@@ -933,44 +933,44 @@ NS_IMETHODIMP nsAbOutlookDirectory::Star</span>
<a href="#l36.372"></a><span id="l36.372">     NS_ENSURE_SUCCESS(retCode, retCode) ;</span>
<a href="#l36.373"></a><span id="l36.373"> </span>
<a href="#l36.374"></a><span id="l36.374">     retCode = arguments-&gt;SetQuerySubDirectories(true) ;</span>
<a href="#l36.375"></a><span id="l36.375">     NS_ENSURE_SUCCESS(retCode, retCode) ;</span>
<a href="#l36.376"></a><span id="l36.376"> </span>
<a href="#l36.377"></a><span id="l36.377">     return DoQuery(this, arguments, this, -1, 0, &amp;mSearchContext);</span>
<a href="#l36.378"></a><span id="l36.378"> }</span>
<a href="#l36.379"></a><span id="l36.379"> </span>
<a href="#l36.380"></a><span id="l36.380" class="difflineminus">-NS_IMETHODIMP nsAbOutlookDirectory::StopSearch(void) </span>
<a href="#l36.381"></a><span id="l36.381" class="difflineplus">+NS_IMETHODIMP nsAbOutlookDirectory::StopSearch(void)</span>
<a href="#l36.382"></a><span id="l36.382"> {</span>
<a href="#l36.383"></a><span id="l36.383">     if (!mIsQueryURI) { return NS_ERROR_NOT_IMPLEMENTED ; }</span>
<a href="#l36.384"></a><span id="l36.384">     return StopQuery(mSearchContext) ;</span>
<a href="#l36.385"></a><span id="l36.385"> }</span>
<a href="#l36.386"></a><span id="l36.386"> </span>
<a href="#l36.387"></a><span id="l36.387"> // nsIAbDirSearchListener</span>
<a href="#l36.388"></a><span id="l36.388"> NS_IMETHODIMP nsAbOutlookDirectory::OnSearchFinished(int32_t aResult,</span>
<a href="#l36.389"></a><span id="l36.389">                                                      const nsAString &amp;aErrorMsg)</span>
<a href="#l36.390"></a><span id="l36.390"> {</span>
<a href="#l36.391"></a><span id="l36.391">   return NS_OK;</span>
<a href="#l36.392"></a><span id="l36.392"> }</span>
<a href="#l36.393"></a><span id="l36.393"> </span>
<a href="#l36.394"></a><span id="l36.394" class="difflineminus">-NS_IMETHODIMP nsAbOutlookDirectory::OnSearchFoundCard(nsIAbCard *aCard) </span>
<a href="#l36.395"></a><span id="l36.395" class="difflineplus">+NS_IMETHODIMP nsAbOutlookDirectory::OnSearchFoundCard(nsIAbCard *aCard)</span>
<a href="#l36.396"></a><span id="l36.396"> {</span>
<a href="#l36.397"></a><span id="l36.397">   mCardList.Put(aCard, aCard);</span>
<a href="#l36.398"></a><span id="l36.398">   nsresult rv;</span>
<a href="#l36.399"></a><span id="l36.399">   nsCOMPtr&lt;nsIAbManager&gt; abManager(do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv));</span>
<a href="#l36.400"></a><span id="l36.400">   if (NS_SUCCEEDED(rv))</span>
<a href="#l36.401"></a><span id="l36.401">     rv = abManager-&gt;NotifyDirectoryItemAdded(this, aCard);</span>
<a href="#l36.402"></a><span id="l36.402"> </span>
<a href="#l36.403"></a><span id="l36.403">   return rv;</span>
<a href="#l36.404"></a><span id="l36.404"> }</span>
<a href="#l36.405"></a><span id="l36.405"> </span>
<a href="#l36.406"></a><span id="l36.406"> nsresult nsAbOutlookDirectory::ExecuteQuery(SRestriction &amp;aRestriction,</span>
<a href="#l36.407"></a><span id="l36.407">                                             nsIAbDirSearchListener *aListener,</span>
<a href="#l36.408"></a><span id="l36.408">                                             int32_t aResultLimit, int32_t aTimeout,</span>
<a href="#l36.409"></a><span id="l36.409" class="difflineminus">-                                            int32_t aThreadId) </span>
<a href="#l36.410"></a><span id="l36.410" class="difflineplus">+                                            int32_t aThreadId)</span>
<a href="#l36.411"></a><span id="l36.411"> </span>
<a href="#l36.412"></a><span id="l36.412"> {</span>
<a href="#l36.413"></a><span id="l36.413">   if (!aListener)</span>
<a href="#l36.414"></a><span id="l36.414">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l36.415"></a><span id="l36.415"> </span>
<a href="#l36.416"></a><span id="l36.416">   nsresult retCode = NS_OK;</span>
<a href="#l36.417"></a><span id="l36.417"> </span>
<a href="#l36.418"></a><span id="l36.418">   nsCOMPtr&lt;nsIMutableArray&gt; resultsArray(do_CreateInstance(NS_ARRAY_CONTRACTID,</span>
<a href="#l36.419"></a><span id="l36.419" class="difflineat">@@ -980,24 +980,24 @@ nsresult nsAbOutlookDirectory::ExecuteQu</span>
<a href="#l36.420"></a><span id="l36.420">   retCode = GetChildCards(resultsArray,</span>
<a href="#l36.421"></a><span id="l36.421">                           aRestriction.rt == RES_COMMENT ? nullptr : &amp;aRestriction);</span>
<a href="#l36.422"></a><span id="l36.422">   NS_ENSURE_SUCCESS(retCode, retCode);</span>
<a href="#l36.423"></a><span id="l36.423"> </span>
<a href="#l36.424"></a><span id="l36.424">   uint32_t nbResults = 0;</span>
<a href="#l36.425"></a><span id="l36.425">   retCode = resultsArray-&gt;GetLength(&amp;nbResults);</span>
<a href="#l36.426"></a><span id="l36.426">   NS_ENSURE_SUCCESS(retCode, retCode);</span>
<a href="#l36.427"></a><span id="l36.427"> </span>
<a href="#l36.428"></a><span id="l36.428" class="difflineminus">-  if (aResultLimit &gt; 0 &amp;&amp; nbResults &gt; static_cast&lt;uint32_t&gt;(aResultLimit)) { </span>
<a href="#l36.429"></a><span id="l36.429" class="difflineminus">-    nbResults = static_cast&lt;uint32_t&gt;(aResultLimit) ; </span>
<a href="#l36.430"></a><span id="l36.430" class="difflineplus">+  if (aResultLimit &gt; 0 &amp;&amp; nbResults &gt; static_cast&lt;uint32_t&gt;(aResultLimit)) {</span>
<a href="#l36.431"></a><span id="l36.431" class="difflineplus">+    nbResults = static_cast&lt;uint32_t&gt;(aResultLimit) ;</span>
<a href="#l36.432"></a><span id="l36.432">   }</span>
<a href="#l36.433"></a><span id="l36.433"> </span>
<a href="#l36.434"></a><span id="l36.434">   uint32_t i = 0;</span>
<a href="#l36.435"></a><span id="l36.435">   nsCOMPtr&lt;nsIAbCard&gt; card;</span>
<a href="#l36.436"></a><span id="l36.436" class="difflineminus">-    </span>
<a href="#l36.437"></a><span id="l36.437" class="difflineminus">-  for (i = 0 ; i &lt; nbResults ; ++ i) {</span>
<a href="#l36.438"></a><span id="l36.438" class="difflineplus">+</span>
<a href="#l36.439"></a><span id="l36.439" class="difflineplus">+  for (i = 0 ; i &lt; nbResults ; ++i) {</span>
<a href="#l36.440"></a><span id="l36.440">     card = do_QueryElementAt(resultsArray, i, &amp;retCode);</span>
<a href="#l36.441"></a><span id="l36.441">     NS_ENSURE_SUCCESS(retCode, retCode);</span>
<a href="#l36.442"></a><span id="l36.442"> </span>
<a href="#l36.443"></a><span id="l36.443">     aListener-&gt;OnSearchFoundCard(card);</span>
<a href="#l36.444"></a><span id="l36.444">   }</span>
<a href="#l36.445"></a><span id="l36.445"> </span>
<a href="#l36.446"></a><span id="l36.446">   mQueryThreads.Remove(aThreadId);</span>
<a href="#l36.447"></a><span id="l36.447"> </span>
<a href="#l36.448"></a><span id="l36.448" class="difflineat">@@ -1080,43 +1080,43 @@ nsresult nsAbOutlookDirectory::GetChildN</span>
<a href="#l36.449"></a><span id="l36.449">     rv = abManager-&gt;GetDirectory(uriName, getter_AddRefs(directory));</span>
<a href="#l36.450"></a><span id="l36.450">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l36.451"></a><span id="l36.451"> </span>
<a href="#l36.452"></a><span id="l36.452">     aNodes-&gt;AppendElement(directory, false);</span>
<a href="#l36.453"></a><span id="l36.453">   }</span>
<a href="#l36.454"></a><span id="l36.454">   return rv;</span>
<a href="#l36.455"></a><span id="l36.455"> }</span>
<a href="#l36.456"></a><span id="l36.456"> </span>
<a href="#l36.457"></a><span id="l36.457" class="difflineminus">-nsresult nsAbOutlookDirectory::NotifyItemDeletion(nsISupports *aItem) </span>
<a href="#l36.458"></a><span id="l36.458" class="difflineplus">+nsresult nsAbOutlookDirectory::NotifyItemDeletion(nsISupports *aItem)</span>
<a href="#l36.459"></a><span id="l36.459"> {</span>
<a href="#l36.460"></a><span id="l36.460">   nsresult rv;</span>
<a href="#l36.461"></a><span id="l36.461">   nsCOMPtr&lt;nsIAbManager&gt; abManager(do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv));</span>
<a href="#l36.462"></a><span id="l36.462"> </span>
<a href="#l36.463"></a><span id="l36.463">   if (NS_SUCCEEDED(rv))</span>
<a href="#l36.464"></a><span id="l36.464">     rv = abManager-&gt;NotifyDirectoryItemDeleted(this, aItem);</span>
<a href="#l36.465"></a><span id="l36.465"> </span>
<a href="#l36.466"></a><span id="l36.466">   return rv;</span>
<a href="#l36.467"></a><span id="l36.467"> }</span>
<a href="#l36.468"></a><span id="l36.468"> </span>
<a href="#l36.469"></a><span id="l36.469" class="difflineminus">-nsresult nsAbOutlookDirectory::NotifyItemAddition(nsISupports *aItem) </span>
<a href="#l36.470"></a><span id="l36.470" class="difflineplus">+nsresult nsAbOutlookDirectory::NotifyItemAddition(nsISupports *aItem)</span>
<a href="#l36.471"></a><span id="l36.471"> {</span>
<a href="#l36.472"></a><span id="l36.472">   nsresult rv;</span>
<a href="#l36.473"></a><span id="l36.473">   nsCOMPtr&lt;nsIAbManager&gt; abManager = do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l36.474"></a><span id="l36.474">   if (NS_SUCCEEDED(rv))</span>
<a href="#l36.475"></a><span id="l36.475">     rv = abManager-&gt;NotifyDirectoryItemAdded(this, aItem);</span>
<a href="#l36.476"></a><span id="l36.476"> </span>
<a href="#l36.477"></a><span id="l36.477">   return rv;</span>
<a href="#l36.478"></a><span id="l36.478"> }</span>
<a href="#l36.479"></a><span id="l36.479"> </span>
<a href="#l36.480"></a><span id="l36.480"> // This is called from EditMailListToDatabase.</span>
<a href="#l36.481"></a><span id="l36.481"> // We got m_AddressList containing the list of cards the mailing</span>
<a href="#l36.482"></a><span id="l36.482"> // list is supposed to contain at the end.</span>
<a href="#l36.483"></a><span id="l36.483"> nsresult nsAbOutlookDirectory::CommitAddressList(void)</span>
<a href="#l36.484"></a><span id="l36.484"> {</span>
<a href="#l36.485"></a><span id="l36.485" class="difflineminus">-  if (!m_IsMailList) { </span>
<a href="#l36.486"></a><span id="l36.486" class="difflineplus">+  if (!m_IsMailList) {</span>
<a href="#l36.487"></a><span id="l36.487">     PRINTF((&quot;We are not in a mailing list, no commit can be done.\n&quot;));</span>
<a href="#l36.488"></a><span id="l36.488">     return NS_ERROR_UNEXPECTED;</span>
<a href="#l36.489"></a><span id="l36.489">   }</span>
<a href="#l36.490"></a><span id="l36.490"> </span>
<a href="#l36.491"></a><span id="l36.491">   nsresult rv;</span>
<a href="#l36.492"></a><span id="l36.492">   uint32_t i = 0;</span>
<a href="#l36.493"></a><span id="l36.493">   nsCOMPtr&lt;nsIMutableArray&gt; oldList(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l36.494"></a><span id="l36.494">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l36.495"></a><span id="l36.495" class="difflineat">@@ -1163,34 +1163,34 @@ nsresult nsAbOutlookDirectory::UpdateAdd</span>
<a href="#l36.496"></a><span id="l36.496">         m_AddressList = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l36.497"></a><span id="l36.497">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l36.498"></a><span id="l36.498">     }</span>
<a href="#l36.499"></a><span id="l36.499"> </span>
<a href="#l36.500"></a><span id="l36.500">     return m_IsMailList ? GetChildCards(m_AddressList, nullptr) :</span>
<a href="#l36.501"></a><span id="l36.501">                           GetChildNodes(m_AddressList);</span>
<a href="#l36.502"></a><span id="l36.502"> }</span>
<a href="#l36.503"></a><span id="l36.503"> </span>
<a href="#l36.504"></a><span id="l36.504" class="difflineminus">-nsresult nsAbOutlookDirectory::CreateCard(nsIAbCard *aData, nsIAbCard **aNewCard) </span>
<a href="#l36.505"></a><span id="l36.505" class="difflineplus">+nsresult nsAbOutlookDirectory::CreateCard(nsIAbCard *aData, nsIAbCard **aNewCard)</span>
<a href="#l36.506"></a><span id="l36.506"> {</span>
<a href="#l36.507"></a><span id="l36.507">     if (!aData || !aNewCard) { return NS_ERROR_NULL_POINTER ; }</span>
<a href="#l36.508"></a><span id="l36.508">     *aNewCard = nullptr ;</span>
<a href="#l36.509"></a><span id="l36.509">     nsresult retCode = NS_OK ;</span>
<a href="#l36.510"></a><span id="l36.510">     nsAbWinHelperGuard mapiAddBook (mAbWinType) ;</span>
<a href="#l36.511"></a><span id="l36.511">     nsMapiEntry newEntry ;</span>
<a href="#l36.512"></a><span id="l36.512">     nsAutoCString entryString ;</span>
<a href="#l36.513"></a><span id="l36.513">     bool didCopy = false ;</span>
<a href="#l36.514"></a><span id="l36.514"> </span>
<a href="#l36.515"></a><span id="l36.515">     if (!mapiAddBook-&gt;IsOK()) { return NS_ERROR_FAILURE ; }</span>
<a href="#l36.516"></a><span id="l36.516">     // If we get an nsIAbCard that maps onto an Outlook card uri</span>
<a href="#l36.517"></a><span id="l36.517">     // we simply copy the contents of the Outlook card.</span>
<a href="#l36.518"></a><span id="l36.518">     retCode = ExtractCardEntry(aData, entryString) ;</span>
<a href="#l36.519"></a><span id="l36.519">     if (NS_SUCCEEDED(retCode) &amp;&amp; !entryString.IsEmpty()) {</span>
<a href="#l36.520"></a><span id="l36.520">         nsMapiEntry sourceEntry ;</span>
<a href="#l36.521"></a><span id="l36.521" class="difflineminus">-        </span>
<a href="#l36.522"></a><span id="l36.522" class="difflineminus">-        </span>
<a href="#l36.523"></a><span id="l36.523" class="difflineplus">+</span>
<a href="#l36.524"></a><span id="l36.524" class="difflineplus">+</span>
<a href="#l36.525"></a><span id="l36.525">         sourceEntry.Assign(entryString) ;</span>
<a href="#l36.526"></a><span id="l36.526">         if (m_IsMailList) {</span>
<a href="#l36.527"></a><span id="l36.527">             // In the case of a mailing list, we can use the address</span>
<a href="#l36.528"></a><span id="l36.528">             // as a direct template to build the new one (which is done</span>
<a href="#l36.529"></a><span id="l36.529">             // by CopyEntry).</span>
<a href="#l36.530"></a><span id="l36.530">             mapiAddBook-&gt;CopyEntry(*mMapiData, sourceEntry, newEntry) ;</span>
<a href="#l36.531"></a><span id="l36.531">             didCopy = true ;</span>
<a href="#l36.532"></a><span id="l36.532">         }</span>
<a href="#l36.533"></a><span id="l36.533" class="difflineat">@@ -1228,17 +1228,17 @@ nsresult nsAbOutlookDirectory::CreateCar</span>
<a href="#l36.534"></a><span id="l36.534">             return NS_ERROR_FAILURE ;</span>
<a href="#l36.535"></a><span id="l36.535">         }</span>
<a href="#l36.536"></a><span id="l36.536">     }</span>
<a href="#l36.537"></a><span id="l36.537">     newEntry.ToString(entryString) ;</span>
<a href="#l36.538"></a><span id="l36.538">     nsAutoCString uri ;</span>
<a href="#l36.539"></a><span id="l36.539"> </span>
<a href="#l36.540"></a><span id="l36.540">     buildAbWinUri(kOutlookCardScheme, mAbWinType, uri) ;</span>
<a href="#l36.541"></a><span id="l36.541">     uri.Append(entryString) ;</span>
<a href="#l36.542"></a><span id="l36.542" class="difflineminus">-    </span>
<a href="#l36.543"></a><span id="l36.543" class="difflineplus">+</span>
<a href="#l36.544"></a><span id="l36.544">     nsCOMPtr&lt;nsIAbCard&gt; newCard;</span>
<a href="#l36.545"></a><span id="l36.545">     retCode = OutlookCardForURI(uri, getter_AddRefs(newCard));</span>
<a href="#l36.546"></a><span id="l36.546">     NS_ENSURE_SUCCESS(retCode, retCode);</span>
<a href="#l36.547"></a><span id="l36.547"> </span>
<a href="#l36.548"></a><span id="l36.548">     nsAutoCString ourUuid;</span>
<a href="#l36.549"></a><span id="l36.549">     GetUuid(ourUuid);</span>
<a href="#l36.550"></a><span id="l36.550">     newCard-&gt;SetDirectoryId(ourUuid);</span>
<a href="#l36.551"></a><span id="l36.551"> </span>
<a href="#l36.552"></a><span id="l36.552" class="difflineat">@@ -1292,18 +1292,18 @@ NS_IMETHODIMP nsAbOutlookDirectory::Modi</span>
<a href="#l36.553"></a><span id="l36.553">   // First, all the standard properties in one go</span>
<a href="#l36.554"></a><span id="l36.554">   properties = new nsString[index_LastProp];</span>
<a href="#l36.555"></a><span id="l36.555">   if (!properties) {</span>
<a href="#l36.556"></a><span id="l36.556">     return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l36.557"></a><span id="l36.557">   }</span>
<a href="#l36.558"></a><span id="l36.558">   aModifiedCard-&gt;GetFirstName(properties[index_FirstName]);</span>
<a href="#l36.559"></a><span id="l36.559">   aModifiedCard-&gt;GetLastName(properties[index_LastName]);</span>
<a href="#l36.560"></a><span id="l36.560">   // This triple search for something to put in the name</span>
<a href="#l36.561"></a><span id="l36.561" class="difflineminus">-  // is because in the case of a mailing list edition in </span>
<a href="#l36.562"></a><span id="l36.562" class="difflineminus">-  // Mozilla, the display name will not be provided, and </span>
<a href="#l36.563"></a><span id="l36.563" class="difflineplus">+  // is because in the case of a mailing list edition in</span>
<a href="#l36.564"></a><span id="l36.564" class="difflineplus">+  // Mozilla, the display name will not be provided, and</span>
<a href="#l36.565"></a><span id="l36.565">   // MAPI doesn't allow that, so we fall back on an optional</span>
<a href="#l36.566"></a><span id="l36.566">   // name, and when all fails, on the email address.</span>
<a href="#l36.567"></a><span id="l36.567">   aModifiedCard-&gt;GetDisplayName(properties[index_DisplayName]);</span>
<a href="#l36.568"></a><span id="l36.568">   if (properties[index_DisplayName].IsEmpty()) {</span>
<a href="#l36.569"></a><span id="l36.569">     nsresult rv;</span>
<a href="#l36.570"></a><span id="l36.570">     nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch =</span>
<a href="#l36.571"></a><span id="l36.571">       do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l36.572"></a><span id="l36.572">     NS_ENSURE_SUCCESS(rv,rv);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l37.1"></a><span id="l37.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbQueryStringToExpression.cpp</span>
<a href="#l37.2"></a><span id="l37.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbQueryStringToExpression.cpp</span>
<a href="#l37.3"></a><span id="l37.3" class="difflineat">@@ -171,17 +171,17 @@ nsresult nsAbQueryStringToExpression::Pa</span>
<a href="#l37.4"></a><span id="l37.4">     {</span>
<a href="#l37.5"></a><span id="l37.5">         rv = ParseConditionEntry (index, indexBracketClose,</span>
<a href="#l37.6"></a><span id="l37.6">                 getter_Copies (entries[i]));</span>
<a href="#l37.7"></a><span id="l37.7">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l37.8"></a><span id="l37.8"> </span>
<a href="#l37.9"></a><span id="l37.9">         if (*index == indexBracketClose)</span>
<a href="#l37.10"></a><span id="l37.10">             break;</span>
<a href="#l37.11"></a><span id="l37.11">     }</span>
<a href="#l37.12"></a><span id="l37.12" class="difflineminus">-    </span>
<a href="#l37.13"></a><span id="l37.13" class="difflineplus">+</span>
<a href="#l37.14"></a><span id="l37.14">     if (*index != indexBracketClose)</span>
<a href="#l37.15"></a><span id="l37.15">         return NS_ERROR_FAILURE;</span>
<a href="#l37.16"></a><span id="l37.16"> </span>
<a href="#l37.17"></a><span id="l37.17">     nsCOMPtr&lt;nsIAbBooleanConditionString&gt; c;</span>
<a href="#l37.18"></a><span id="l37.18">     rv = CreateBooleanConditionString (</span>
<a href="#l37.19"></a><span id="l37.19">         entries[0].get(),</span>
<a href="#l37.20"></a><span id="l37.20">         entries[1].get(),</span>
<a href="#l37.21"></a><span id="l37.21">         entries[2].get(),</span>
<a href="#l37.22"></a><span id="l37.22" class="difflineat">@@ -199,17 +199,17 @@ nsresult nsAbQueryStringToExpression::Pa</span>
<a href="#l37.23"></a><span id="l37.23"> {</span>
<a href="#l37.24"></a><span id="l37.24">     const char* indexDeliminator = *index;</span>
<a href="#l37.25"></a><span id="l37.25">     while (indexDeliminator != indexBracketClose &amp;&amp;</span>
<a href="#l37.26"></a><span id="l37.26">         *indexDeliminator != ',')</span>
<a href="#l37.27"></a><span id="l37.27">         indexDeliminator++;</span>
<a href="#l37.28"></a><span id="l37.28"> </span>
<a href="#l37.29"></a><span id="l37.29">     int entryLength = indexDeliminator - *index;</span>
<a href="#l37.30"></a><span id="l37.30">     if (entryLength)</span>
<a href="#l37.31"></a><span id="l37.31" class="difflineminus">-      *entry = PL_strndup (*index, entryLength); </span>
<a href="#l37.32"></a><span id="l37.32" class="difflineplus">+      *entry = PL_strndup (*index, entryLength);</span>
<a href="#l37.33"></a><span id="l37.33">     else</span>
<a href="#l37.34"></a><span id="l37.34">         *entry = 0;</span>
<a href="#l37.35"></a><span id="l37.35"> </span>
<a href="#l37.36"></a><span id="l37.36">     if (indexDeliminator != indexBracketClose)</span>
<a href="#l37.37"></a><span id="l37.37">         *index = indexDeliminator + 1;</span>
<a href="#l37.38"></a><span id="l37.38">     else</span>
<a href="#l37.39"></a><span id="l37.39">         *index = indexDeliminator;</span>
<a href="#l37.40"></a><span id="l37.40"> </span>
<a href="#l37.41"></a><span id="l37.41" class="difflineat">@@ -219,17 +219,17 @@ nsresult nsAbQueryStringToExpression::Pa</span>
<a href="#l37.42"></a><span id="l37.42"> nsresult nsAbQueryStringToExpression::ParseOperationEntry (</span>
<a href="#l37.43"></a><span id="l37.43">     const char* indexBracketOpen1,</span>
<a href="#l37.44"></a><span id="l37.44">     const char* indexBracketOpen2,</span>
<a href="#l37.45"></a><span id="l37.45">     char** operation)</span>
<a href="#l37.46"></a><span id="l37.46"> {</span>
<a href="#l37.47"></a><span id="l37.47">     int operationLength = indexBracketOpen2 - indexBracketOpen1 - 1;</span>
<a href="#l37.48"></a><span id="l37.48">     if (operationLength)</span>
<a href="#l37.49"></a><span id="l37.49">         *operation = PL_strndup (indexBracketOpen1 + 1,</span>
<a href="#l37.50"></a><span id="l37.50" class="difflineminus">-            operationLength); </span>
<a href="#l37.51"></a><span id="l37.51" class="difflineplus">+            operationLength);</span>
<a href="#l37.52"></a><span id="l37.52">     else</span>
<a href="#l37.53"></a><span id="l37.53">         *operation = 0;</span>
<a href="#l37.54"></a><span id="l37.54"> </span>
<a href="#l37.55"></a><span id="l37.55">     return NS_OK;</span>
<a href="#l37.56"></a><span id="l37.56"> }</span>
<a href="#l37.57"></a><span id="l37.57"> </span>
<a href="#l37.58"></a><span id="l37.58"> nsresult nsAbQueryStringToExpression::CreateBooleanExpression(</span>
<a href="#l37.59"></a><span id="l37.59">         const char* operation,</span>
<a href="#l37.60"></a><span id="l37.60" class="difflineat">@@ -292,17 +292,17 @@ nsresult nsAbQueryStringToExpression::Cr</span>
<a href="#l37.61"></a><span id="l37.61">     nsresult rv;</span>
<a href="#l37.62"></a><span id="l37.62"> </span>
<a href="#l37.63"></a><span id="l37.63">     nsCOMPtr&lt;nsIAbBooleanConditionString&gt; cs = do_CreateInstance(NS_BOOLEANCONDITIONSTRING_CONTRACTID, &amp;rv);</span>
<a href="#l37.64"></a><span id="l37.64">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l37.65"></a><span id="l37.65"> </span>
<a href="#l37.66"></a><span id="l37.66">     rv = cs-&gt;SetCondition (c);</span>
<a href="#l37.67"></a><span id="l37.67">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l37.68"></a><span id="l37.68"> </span>
<a href="#l37.69"></a><span id="l37.69" class="difflineminus">-    nsCOMPtr&lt;nsITextToSubURI&gt; textToSubURI = do_GetService(NS_ITEXTTOSUBURI_CONTRACTID,&amp;rv); </span>
<a href="#l37.70"></a><span id="l37.70" class="difflineplus">+    nsCOMPtr&lt;nsITextToSubURI&gt; textToSubURI = do_GetService(NS_ITEXTTOSUBURI_CONTRACTID,&amp;rv);</span>
<a href="#l37.71"></a><span id="l37.71">     if (NS_SUCCEEDED(rv))</span>
<a href="#l37.72"></a><span id="l37.72">     {</span>
<a href="#l37.73"></a><span id="l37.73">         nsString attributeUCS2;</span>
<a href="#l37.74"></a><span id="l37.74">         nsString valueUCS2;</span>
<a href="#l37.75"></a><span id="l37.75"> </span>
<a href="#l37.76"></a><span id="l37.76">         rv = textToSubURI-&gt;UnEscapeAndConvert(nsDependentCString(&quot;UTF-8&quot;),</span>
<a href="#l37.77"></a><span id="l37.77">             nsDependentCString(attribute), attributeUCS2);</span>
<a href="#l37.78"></a><span id="l37.78">         NS_ENSURE_SUCCESS(rv, rv);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l38.1"></a><span id="l38.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbView.cpp</span>
<a href="#l38.2"></a><span id="l38.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbView.cpp</span>
<a href="#l38.3"></a><span id="l38.3" class="difflineat">@@ -33,17 +33,17 @@ using namespace mozilla;</span>
<a href="#l38.4"></a><span id="l38.4"> #define CARD_NOT_FOUND -1</span>
<a href="#l38.5"></a><span id="l38.5"> #define ALL_ROWS -1</span>
<a href="#l38.6"></a><span id="l38.6"> </span>
<a href="#l38.7"></a><span id="l38.7"> #define PREF_MAIL_ADDR_BOOK_LASTNAMEFIRST &quot;mail.addr_book.lastnamefirst&quot;</span>
<a href="#l38.8"></a><span id="l38.8"> #define PREF_MAIL_ADDR_BOOK_DISPLAYNAME_AUTOGENERATION &quot;mail.addr_book.displayName.autoGeneration&quot;</span>
<a href="#l38.9"></a><span id="l38.9"> #define PREF_MAIL_ADDR_BOOK_DISPLAYNAME_LASTNAMEFIRST &quot;mail.addr_book.displayName.lastnamefirst&quot;</span>
<a href="#l38.10"></a><span id="l38.10"> </span>
<a href="#l38.11"></a><span id="l38.11"> // Also, our default primary sort</span>
<a href="#l38.12"></a><span id="l38.12" class="difflineminus">-#define GENERATED_NAME_COLUMN_ID &quot;GeneratedName&quot; </span>
<a href="#l38.13"></a><span id="l38.13" class="difflineplus">+#define GENERATED_NAME_COLUMN_ID &quot;GeneratedName&quot;</span>
<a href="#l38.14"></a><span id="l38.14"> </span>
<a href="#l38.15"></a><span id="l38.15"> NS_IMPL_ISUPPORTS(nsAbView, nsIAbView, nsITreeView, nsIAbListener, nsIObserver)</span>
<a href="#l38.16"></a><span id="l38.16"> </span>
<a href="#l38.17"></a><span id="l38.17"> nsAbView::nsAbView() : mInitialized(false),</span>
<a href="#l38.18"></a><span id="l38.18">                        mIsAllDirectoryRootView(false),</span>
<a href="#l38.19"></a><span id="l38.19">                        mSuppressSelectionChange(false),</span>
<a href="#l38.20"></a><span id="l38.20">                        mSuppressCountChange(false),</span>
<a href="#l38.21"></a><span id="l38.21">                        mGeneratedNameFormat(0)</span>
<a href="#l38.22"></a><span id="l38.22" class="difflineat">@@ -98,17 +98,17 @@ nsresult nsAbView::RemoveCardAt(int32_t </span>
<a href="#l38.23"></a><span id="l38.23"> </span>
<a href="#l38.24"></a><span id="l38.24">   AbCard *abcard = mCards.ElementAt(row);</span>
<a href="#l38.25"></a><span id="l38.25">   NS_IF_RELEASE(abcard-&gt;card);</span>
<a href="#l38.26"></a><span id="l38.26">   mCards.RemoveElementAt(row);</span>
<a href="#l38.27"></a><span id="l38.27">   PR_FREEIF(abcard-&gt;primaryCollationKey);</span>
<a href="#l38.28"></a><span id="l38.28">   PR_FREEIF(abcard-&gt;secondaryCollationKey);</span>
<a href="#l38.29"></a><span id="l38.29">   PR_FREEIF(abcard);</span>
<a href="#l38.30"></a><span id="l38.30"> </span>
<a href="#l38.31"></a><span id="l38.31" class="difflineminus">-  </span>
<a href="#l38.32"></a><span id="l38.32" class="difflineplus">+</span>
<a href="#l38.33"></a><span id="l38.33">   // This needs to happen after we remove the card, as RowCountChanged() will call GetRowCount()</span>
<a href="#l38.34"></a><span id="l38.34">   if (mTree) {</span>
<a href="#l38.35"></a><span id="l38.35">     rv = mTree-&gt;RowCountChanged(row, -1);</span>
<a href="#l38.36"></a><span id="l38.36">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l38.37"></a><span id="l38.37">   }</span>
<a href="#l38.38"></a><span id="l38.38"> </span>
<a href="#l38.39"></a><span id="l38.39">   if (mAbViewListener &amp;&amp; !mSuppressCountChange) {</span>
<a href="#l38.40"></a><span id="l38.40">     rv = mAbViewListener-&gt;OnCountChanged(mCards.Length());</span>
<a href="#l38.41"></a><span id="l38.41" class="difflineat">@@ -279,17 +279,17 @@ NS_IMETHODIMP nsAbView::GetDirectory(nsI</span>
<a href="#l38.42"></a><span id="l38.42"> {</span>
<a href="#l38.43"></a><span id="l38.43">   NS_ENSURE_ARG_POINTER(aDirectory);</span>
<a href="#l38.44"></a><span id="l38.44">   NS_IF_ADDREF(*aDirectory = mDirectory);</span>
<a href="#l38.45"></a><span id="l38.45">   return NS_OK;</span>
<a href="#l38.46"></a><span id="l38.46"> }</span>
<a href="#l38.47"></a><span id="l38.47"> </span>
<a href="#l38.48"></a><span id="l38.48"> nsresult nsAbView::EnumerateCards()</span>
<a href="#l38.49"></a><span id="l38.49"> {</span>
<a href="#l38.50"></a><span id="l38.50" class="difflineminus">-  nsresult rv;    </span>
<a href="#l38.51"></a><span id="l38.51" class="difflineplus">+  nsresult rv;</span>
<a href="#l38.52"></a><span id="l38.52">   nsCOMPtr&lt;nsISimpleEnumerator&gt; cardsEnumerator;</span>
<a href="#l38.53"></a><span id="l38.53">   nsCOMPtr&lt;nsIAbCard&gt; card;</span>
<a href="#l38.54"></a><span id="l38.54"> </span>
<a href="#l38.55"></a><span id="l38.55">   if (!mDirectory)</span>
<a href="#l38.56"></a><span id="l38.56">     return NS_ERROR_UNEXPECTED;</span>
<a href="#l38.57"></a><span id="l38.57"> </span>
<a href="#l38.58"></a><span id="l38.58">   rv = mDirectory-&gt;GetChildCards(getter_AddRefs(cardsEnumerator));</span>
<a href="#l38.59"></a><span id="l38.59">   if (NS_SUCCEEDED(rv) &amp;&amp; cardsEnumerator)</span>
<a href="#l38.60"></a><span id="l38.60" class="difflineat">@@ -299,17 +299,17 @@ nsresult nsAbView::EnumerateCards()</span>
<a href="#l38.61"></a><span id="l38.61">     while (NS_SUCCEEDED(cardsEnumerator-&gt;HasMoreElements(&amp;more)) &amp;&amp; more)</span>
<a href="#l38.62"></a><span id="l38.62">     {</span>
<a href="#l38.63"></a><span id="l38.63">       rv = cardsEnumerator-&gt;GetNext(getter_AddRefs(item));</span>
<a href="#l38.64"></a><span id="l38.64">       if (NS_SUCCEEDED(rv))</span>
<a href="#l38.65"></a><span id="l38.65">       {</span>
<a href="#l38.66"></a><span id="l38.66">         nsCOMPtr &lt;nsIAbCard&gt; card = do_QueryInterface(item);</span>
<a href="#l38.67"></a><span id="l38.67">         // Malloc these from an arena</span>
<a href="#l38.68"></a><span id="l38.68">         AbCard *abcard = (AbCard *) PR_Calloc(1, sizeof(struct AbCard));</span>
<a href="#l38.69"></a><span id="l38.69" class="difflineminus">-        if (!abcard) </span>
<a href="#l38.70"></a><span id="l38.70" class="difflineplus">+        if (!abcard)</span>
<a href="#l38.71"></a><span id="l38.71">           return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l38.72"></a><span id="l38.72"> </span>
<a href="#l38.73"></a><span id="l38.73">         abcard-&gt;card = card;</span>
<a href="#l38.74"></a><span id="l38.74">         NS_IF_ADDREF(abcard-&gt;card);</span>
<a href="#l38.75"></a><span id="l38.75"> </span>
<a href="#l38.76"></a><span id="l38.76">         // XXX todo</span>
<a href="#l38.77"></a><span id="l38.77">         // Would it be better to do an insertion sort, than append and sort?</span>
<a href="#l38.78"></a><span id="l38.78">         // XXX todo</span>
<a href="#l38.79"></a><span id="l38.79" class="difflineat">@@ -495,17 +495,17 @@ nsresult nsAbView::RefreshTree()</span>
<a href="#l38.80"></a><span id="l38.80">   //</span>
<a href="#l38.81"></a><span id="l38.81">   // XXX optimize me</span>
<a href="#l38.82"></a><span id="l38.82">   // PrimaryEmail is always the secondary sort, unless it is currently the</span>
<a href="#l38.83"></a><span id="l38.83">   // primary sort.  So, if PrimaryEmail is the primary sort,</span>
<a href="#l38.84"></a><span id="l38.84">   // GeneratedName might be the secondary sort.</span>
<a href="#l38.85"></a><span id="l38.85">   //</span>
<a href="#l38.86"></a><span id="l38.86">   // One day, we can get fancy and remember what the secondary sort is.</span>
<a href="#l38.87"></a><span id="l38.87">   // We do that, we can fix this code. At best, it will turn a sort into a invalidate.</span>
<a href="#l38.88"></a><span id="l38.88" class="difflineminus">-  // </span>
<a href="#l38.89"></a><span id="l38.89" class="difflineplus">+  //</span>
<a href="#l38.90"></a><span id="l38.90">   // If neither the primary nor the secondary sorts are GeneratedName (or kPhoneticNameColumn),</span>
<a href="#l38.91"></a><span id="l38.91">   // all we have to do is invalidate (to show the new GeneratedNames),</span>
<a href="#l38.92"></a><span id="l38.92">   // but the sort will not change.</span>
<a href="#l38.93"></a><span id="l38.93">   if (mSortColumn.EqualsLiteral(GENERATED_NAME_COLUMN_ID) ||</span>
<a href="#l38.94"></a><span id="l38.94">       mSortColumn.EqualsLiteral(kPriEmailProperty) ||</span>
<a href="#l38.95"></a><span id="l38.95">       mSortColumn.EqualsLiteral(kPhoneticNameColumn)) {</span>
<a href="#l38.96"></a><span id="l38.96">     rv = SortBy(mSortColumn.get(), mSortDirection.get(), true);</span>
<a href="#l38.97"></a><span id="l38.97">   }</span>
<a href="#l38.98"></a><span id="l38.98" class="difflineat">@@ -546,17 +546,17 @@ NS_IMETHODIMP nsAbView::CycleHeader(nsIT</span>
<a href="#l38.99"></a><span id="l38.99"> {</span>
<a href="#l38.100"></a><span id="l38.100">   return NS_OK;</span>
<a href="#l38.101"></a><span id="l38.101"> }</span>
<a href="#l38.102"></a><span id="l38.102"> </span>
<a href="#l38.103"></a><span id="l38.103"> nsresult nsAbView::InvalidateTree(int32_t row)</span>
<a href="#l38.104"></a><span id="l38.104"> {</span>
<a href="#l38.105"></a><span id="l38.105">   if (!mTree)</span>
<a href="#l38.106"></a><span id="l38.106">     return NS_OK;</span>
<a href="#l38.107"></a><span id="l38.107" class="difflineminus">-  </span>
<a href="#l38.108"></a><span id="l38.108" class="difflineplus">+</span>
<a href="#l38.109"></a><span id="l38.109">   if (row == ALL_ROWS)</span>
<a href="#l38.110"></a><span id="l38.110">     return mTree-&gt;Invalidate();</span>
<a href="#l38.111"></a><span id="l38.111">   else</span>
<a href="#l38.112"></a><span id="l38.112">     return mTree-&gt;InvalidateRow(row);</span>
<a href="#l38.113"></a><span id="l38.113"> }</span>
<a href="#l38.114"></a><span id="l38.114"> </span>
<a href="#l38.115"></a><span id="l38.115"> NS_IMETHODIMP nsAbView::SelectionChanged()</span>
<a href="#l38.116"></a><span id="l38.116"> {</span>
<a href="#l38.117"></a><span id="l38.117" class="difflineat">@@ -604,17 +604,17 @@ NS_IMETHODIMP nsAbView::PerformActionOnR</span>
<a href="#l38.118"></a><span id="l38.118"> </span>
<a href="#l38.119"></a><span id="l38.119"> NS_IMETHODIMP nsAbView::PerformActionOnCell(const char16_t *action, int32_t row, nsITreeColumn* col)</span>
<a href="#l38.120"></a><span id="l38.120"> {</span>
<a href="#l38.121"></a><span id="l38.121">     return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l38.122"></a><span id="l38.122"> }</span>
<a href="#l38.123"></a><span id="l38.123"> </span>
<a href="#l38.124"></a><span id="l38.124"> NS_IMETHODIMP nsAbView::GetCardFromRow(int32_t row, nsIAbCard **aCard)</span>
<a href="#l38.125"></a><span id="l38.125"> {</span>
<a href="#l38.126"></a><span id="l38.126" class="difflineminus">-  *aCard = nullptr;  </span>
<a href="#l38.127"></a><span id="l38.127" class="difflineplus">+  *aCard = nullptr;</span>
<a href="#l38.128"></a><span id="l38.128">   NS_ENSURE_TRUE(row &gt;= 0, NS_ERROR_UNEXPECTED);</span>
<a href="#l38.129"></a><span id="l38.129">   if (mCards.Length() &lt;= (size_t)row) {</span>
<a href="#l38.130"></a><span id="l38.130">     return NS_OK;</span>
<a href="#l38.131"></a><span id="l38.131">   }</span>
<a href="#l38.132"></a><span id="l38.132"> </span>
<a href="#l38.133"></a><span id="l38.133">   AbCard *a = mCards.ElementAt(row);</span>
<a href="#l38.134"></a><span id="l38.134">   if (!a)</span>
<a href="#l38.135"></a><span id="l38.135">       return NS_OK;</span>
<a href="#l38.136"></a><span id="l38.136" class="difflineat">@@ -632,17 +632,17 @@ typedef struct SortClosure</span>
<a href="#l38.137"></a><span id="l38.137">   int32_t factor;</span>
<a href="#l38.138"></a><span id="l38.138">   nsAbView *abView;</span>
<a href="#l38.139"></a><span id="l38.139"> } SortClosure;</span>
<a href="#l38.140"></a><span id="l38.140"> </span>
<a href="#l38.141"></a><span id="l38.141"> static int</span>
<a href="#l38.142"></a><span id="l38.142"> inplaceSortCallback(const AbCard *card1, const AbCard *card2, SortClosure *closure)</span>
<a href="#l38.143"></a><span id="l38.143"> {</span>
<a href="#l38.144"></a><span id="l38.144">   int32_t sortValue;</span>
<a href="#l38.145"></a><span id="l38.145" class="difflineminus">-  </span>
<a href="#l38.146"></a><span id="l38.146" class="difflineplus">+</span>
<a href="#l38.147"></a><span id="l38.147">   // If we are sorting the &quot;PrimaryEmail&quot;, swap the collation keys, as the secondary is always the</span>
<a href="#l38.148"></a><span id="l38.148">   // PrimaryEmail. Use the last primary key as the secondary key.</span>
<a href="#l38.149"></a><span id="l38.149">   //</span>
<a href="#l38.150"></a><span id="l38.150">   // &quot;Pr&quot; to distinguish &quot;PrimaryEmail&quot; from &quot;PagerNumber&quot;</span>
<a href="#l38.151"></a><span id="l38.151">   if (closure-&gt;colID[0] == char16_t('P') &amp;&amp; closure-&gt;colID[1] == char16_t('r')) {</span>
<a href="#l38.152"></a><span id="l38.152">     sortValue = closure-&gt;abView-&gt;CompareCollationKeys(card1-&gt;secondaryCollationKey,card1-&gt;secondaryCollationKeyLen,card2-&gt;secondaryCollationKey,card2-&gt;secondaryCollationKeyLen);</span>
<a href="#l38.153"></a><span id="l38.153">     if (sortValue)</span>
<a href="#l38.154"></a><span id="l38.154">       return sortValue * closure-&gt;factor;</span>
<a href="#l38.155"></a><span id="l38.155" class="difflineat">@@ -656,20 +656,20 @@ inplaceSortCallback(const AbCard *card1,</span>
<a href="#l38.156"></a><span id="l38.156">     else</span>
<a href="#l38.157"></a><span id="l38.157">       return closure-&gt;abView-&gt;CompareCollationKeys(card1-&gt;secondaryCollationKey,card1-&gt;secondaryCollationKeyLen,card2-&gt;secondaryCollationKey,card2-&gt;secondaryCollationKeyLen) * (closure-&gt;factor);</span>
<a href="#l38.158"></a><span id="l38.158">   }</span>
<a href="#l38.159"></a><span id="l38.159"> }</span>
<a href="#l38.160"></a><span id="l38.160"> </span>
<a href="#l38.161"></a><span id="l38.161"> static void SetSortClosure(const char16_t *sortColumn, const char16_t *sortDirection, nsAbView *abView, SortClosure *closure)</span>
<a href="#l38.162"></a><span id="l38.162"> {</span>
<a href="#l38.163"></a><span id="l38.163">   closure-&gt;colID = sortColumn;</span>
<a href="#l38.164"></a><span id="l38.164" class="difflineminus">-  </span>
<a href="#l38.165"></a><span id="l38.165" class="difflineplus">+</span>
<a href="#l38.166"></a><span id="l38.166">   if (sortDirection &amp;&amp; !NS_strcmp(sortDirection, u&quot;descending&quot;))</span>
<a href="#l38.167"></a><span id="l38.167">     closure-&gt;factor = DESCENDING_SORT_FACTOR;</span>
<a href="#l38.168"></a><span id="l38.168" class="difflineminus">-  else </span>
<a href="#l38.169"></a><span id="l38.169" class="difflineplus">+  else</span>
<a href="#l38.170"></a><span id="l38.170">     closure-&gt;factor = ASCENDING_SORT_FACTOR;</span>
<a href="#l38.171"></a><span id="l38.171"> </span>
<a href="#l38.172"></a><span id="l38.172">   closure-&gt;abView = abView;</span>
<a href="#l38.173"></a><span id="l38.173">   return;</span>
<a href="#l38.174"></a><span id="l38.174"> }</span>
<a href="#l38.175"></a><span id="l38.175"> </span>
<a href="#l38.176"></a><span id="l38.176"> class CardComparator</span>
<a href="#l38.177"></a><span id="l38.177"> {</span>
<a href="#l38.178"></a><span id="l38.178" class="difflineat">@@ -798,28 +798,28 @@ nsresult nsAbView::GenerateCollationKeys</span>
<a href="#l38.179"></a><span id="l38.179">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l38.180"></a><span id="l38.180"> </span>
<a href="#l38.181"></a><span id="l38.181">     rv = factory-&gt;CreateCollation(getter_AddRefs(mCollationKeyGenerator));</span>
<a href="#l38.182"></a><span id="l38.182">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l38.183"></a><span id="l38.183">   }</span>
<a href="#l38.184"></a><span id="l38.184"> </span>
<a href="#l38.185"></a><span id="l38.185">   rv = GetCardValue(abcard-&gt;card, colID, value);</span>
<a href="#l38.186"></a><span id="l38.186">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l38.187"></a><span id="l38.187" class="difflineminus">-  </span>
<a href="#l38.188"></a><span id="l38.188" class="difflineplus">+</span>
<a href="#l38.189"></a><span id="l38.189">   PR_FREEIF(abcard-&gt;primaryCollationKey);</span>
<a href="#l38.190"></a><span id="l38.190">   rv = mCollationKeyGenerator-&gt;AllocateRawSortKey(nsICollation::kCollationCaseInSensitive,</span>
<a href="#l38.191"></a><span id="l38.191">     value, &amp;(abcard-&gt;primaryCollationKey), &amp;(abcard-&gt;primaryCollationKeyLen));</span>
<a href="#l38.192"></a><span id="l38.192">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l38.193"></a><span id="l38.193" class="difflineminus">-  </span>
<a href="#l38.194"></a><span id="l38.194" class="difflineplus">+</span>
<a href="#l38.195"></a><span id="l38.195">   // Hardcode email to be our secondary key. As we are doing this, just call</span>
<a href="#l38.196"></a><span id="l38.196">   // the card's GetCardValue direct, rather than our own function which will</span>
<a href="#l38.197"></a><span id="l38.197">   // end up doing the same as then we can save a bit of time.</span>
<a href="#l38.198"></a><span id="l38.198">   rv = abcard-&gt;card-&gt;GetPrimaryEmail(value);</span>
<a href="#l38.199"></a><span id="l38.199">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l38.200"></a><span id="l38.200" class="difflineminus">-  </span>
<a href="#l38.201"></a><span id="l38.201" class="difflineplus">+</span>
<a href="#l38.202"></a><span id="l38.202">   PR_FREEIF(abcard-&gt;secondaryCollationKey);</span>
<a href="#l38.203"></a><span id="l38.203">   rv = mCollationKeyGenerator-&gt;AllocateRawSortKey(nsICollation::kCollationCaseInSensitive,</span>
<a href="#l38.204"></a><span id="l38.204">     value, &amp;(abcard-&gt;secondaryCollationKey), &amp;(abcard-&gt;secondaryCollationKeyLen));</span>
<a href="#l38.205"></a><span id="l38.205">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l38.206"></a><span id="l38.206">   return rv;</span>
<a href="#l38.207"></a><span id="l38.207"> }</span>
<a href="#l38.208"></a><span id="l38.208"> </span>
<a href="#l38.209"></a><span id="l38.209"> // A helper method currently returns true if the directory is an LDAP.</span>
<a href="#l38.210"></a><span id="l38.210" class="difflineat">@@ -876,17 +876,17 @@ NS_IMETHODIMP nsAbView::OnItemAdded(nsIS</span>
<a href="#l38.211"></a><span id="l38.211">     if (addedCard) {</span>
<a href="#l38.212"></a><span id="l38.212">       // Malloc these from an arena</span>
<a href="#l38.213"></a><span id="l38.213">       AbCard *abcard = (AbCard *) PR_Calloc(1, sizeof(struct AbCard));</span>
<a href="#l38.214"></a><span id="l38.214">       if (!abcard)</span>
<a href="#l38.215"></a><span id="l38.215">         return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l38.216"></a><span id="l38.216"> </span>
<a href="#l38.217"></a><span id="l38.217">       abcard-&gt;card = addedCard;</span>
<a href="#l38.218"></a><span id="l38.218">       NS_IF_ADDREF(abcard-&gt;card);</span>
<a href="#l38.219"></a><span id="l38.219" class="difflineminus">-    </span>
<a href="#l38.220"></a><span id="l38.220" class="difflineplus">+</span>
<a href="#l38.221"></a><span id="l38.221">       rv = GenerateCollationKeysForCard(mSortColumn.get(), abcard);</span>
<a href="#l38.222"></a><span id="l38.222">       NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l38.223"></a><span id="l38.223"> </span>
<a href="#l38.224"></a><span id="l38.224">       int32_t index;</span>
<a href="#l38.225"></a><span id="l38.225">       rv = AddCard(abcard, false /* select card */, &amp;index);</span>
<a href="#l38.226"></a><span id="l38.226">       NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l38.227"></a><span id="l38.227">     }</span>
<a href="#l38.228"></a><span id="l38.228">   }</span>
<a href="#l38.229"></a><span id="l38.229" class="difflineat">@@ -906,17 +906,17 @@ NS_IMETHODIMP nsAbView::Observe(nsISuppo</span>
<a href="#l38.230"></a><span id="l38.230">   }</span>
<a href="#l38.231"></a><span id="l38.231">   return NS_OK;</span>
<a href="#l38.232"></a><span id="l38.232"> }</span>
<a href="#l38.233"></a><span id="l38.233"> </span>
<a href="#l38.234"></a><span id="l38.234"> nsresult nsAbView::AddCard(AbCard *abcard, bool selectCardAfterAdding, int32_t *index)</span>
<a href="#l38.235"></a><span id="l38.235"> {</span>
<a href="#l38.236"></a><span id="l38.236">   nsresult rv = NS_OK;</span>
<a href="#l38.237"></a><span id="l38.237">   NS_ENSURE_ARG_POINTER(abcard);</span>
<a href="#l38.238"></a><span id="l38.238" class="difflineminus">-  </span>
<a href="#l38.239"></a><span id="l38.239" class="difflineplus">+</span>
<a href="#l38.240"></a><span id="l38.240">   *index = FindIndexForInsert(abcard);</span>
<a href="#l38.241"></a><span id="l38.241">   mCards.InsertElementAt(*index, abcard);</span>
<a href="#l38.242"></a><span id="l38.242"> </span>
<a href="#l38.243"></a><span id="l38.243">   // This needs to happen after we insert the card, as RowCountChanged() will call GetRowCount()</span>
<a href="#l38.244"></a><span id="l38.244">   if (mTree)</span>
<a href="#l38.245"></a><span id="l38.245">     rv = mTree-&gt;RowCountChanged(*index, 1);</span>
<a href="#l38.246"></a><span id="l38.246"> </span>
<a href="#l38.247"></a><span id="l38.247">   // Checking for mTree here works around core bug 399227</span>
<a href="#l38.248"></a><span id="l38.248" class="difflineat">@@ -935,23 +935,23 @@ nsresult nsAbView::AddCard(AbCard *abcar</span>
<a href="#l38.249"></a><span id="l38.249"> </span>
<a href="#l38.250"></a><span id="l38.250"> int32_t nsAbView::FindIndexForInsert(AbCard *abcard)</span>
<a href="#l38.251"></a><span id="l38.251"> {</span>
<a href="#l38.252"></a><span id="l38.252">   int32_t count = mCards.Length();</span>
<a href="#l38.253"></a><span id="l38.253">   int32_t i;</span>
<a href="#l38.254"></a><span id="l38.254"> </span>
<a href="#l38.255"></a><span id="l38.255">   SortClosure closure;</span>
<a href="#l38.256"></a><span id="l38.256">   SetSortClosure(mSortColumn.get(), mSortDirection.get(), this, &amp;closure);</span>
<a href="#l38.257"></a><span id="l38.257" class="difflineminus">-  </span>
<a href="#l38.258"></a><span id="l38.258" class="difflineplus">+</span>
<a href="#l38.259"></a><span id="l38.259">   // XXX todo</span>
<a href="#l38.260"></a><span id="l38.260">   // Make this a binary search</span>
<a href="#l38.261"></a><span id="l38.261">   for (i=0; i &lt; count; i++) {</span>
<a href="#l38.262"></a><span id="l38.262">     int32_t value = inplaceSortCallback(abcard, mCards.ElementAt(i), &amp;closure);</span>
<a href="#l38.263"></a><span id="l38.263">     // XXX Fix me, this is not right for both ascending and descending</span>
<a href="#l38.264"></a><span id="l38.264" class="difflineminus">-    if (value &lt;= 0) </span>
<a href="#l38.265"></a><span id="l38.265" class="difflineplus">+    if (value &lt;= 0)</span>
<a href="#l38.266"></a><span id="l38.266">       break;</span>
<a href="#l38.267"></a><span id="l38.267">   }</span>
<a href="#l38.268"></a><span id="l38.268">   return i;</span>
<a href="#l38.269"></a><span id="l38.269"> }</span>
<a href="#l38.270"></a><span id="l38.270"> </span>
<a href="#l38.271"></a><span id="l38.271"> NS_IMETHODIMP nsAbView::OnItemRemoved(nsISupports *parentDir, nsISupports *item)</span>
<a href="#l38.272"></a><span id="l38.272"> {</span>
<a href="#l38.273"></a><span id="l38.273">   nsresult rv;</span>
<a href="#l38.274"></a><span id="l38.274" class="difflineat">@@ -1019,17 +1019,17 @@ nsresult nsAbView::RemoveCardAndSelectNe</span>
<a href="#l38.275"></a><span id="l38.275">   }</span>
<a href="#l38.276"></a><span id="l38.276">   return rv;</span>
<a href="#l38.277"></a><span id="l38.277"> }</span>
<a href="#l38.278"></a><span id="l38.278"> </span>
<a href="#l38.279"></a><span id="l38.279"> int32_t nsAbView::FindIndexForCard(nsIAbCard *card)</span>
<a href="#l38.280"></a><span id="l38.280"> {</span>
<a href="#l38.281"></a><span id="l38.281">   int32_t count = mCards.Length();</span>
<a href="#l38.282"></a><span id="l38.282">   int32_t i;</span>
<a href="#l38.283"></a><span id="l38.283" class="difflineminus">- </span>
<a href="#l38.284"></a><span id="l38.284" class="difflineplus">+</span>
<a href="#l38.285"></a><span id="l38.285">   // You can't implement the binary search here, as all you have is the nsIAbCard</span>
<a href="#l38.286"></a><span id="l38.286">   // you might be here because one of the card properties has changed, and that property</span>
<a href="#l38.287"></a><span id="l38.287">   // could be the collation key.</span>
<a href="#l38.288"></a><span id="l38.288">   for (i=0; i &lt; count; i++) {</span>
<a href="#l38.289"></a><span id="l38.289">     AbCard *abcard = mCards.ElementAt(i);</span>
<a href="#l38.290"></a><span id="l38.290">     bool equals;</span>
<a href="#l38.291"></a><span id="l38.291">     nsresult rv = card-&gt;Equals(abcard-&gt;card, &amp;equals);</span>
<a href="#l38.292"></a><span id="l38.292">     if (NS_SUCCEEDED(rv) &amp;&amp; equals) {</span>
<a href="#l38.293"></a><span id="l38.293" class="difflineat">@@ -1055,27 +1055,27 @@ NS_IMETHODIMP nsAbView::OnItemPropertyCh</span>
<a href="#l38.294"></a><span id="l38.294"> </span>
<a href="#l38.295"></a><span id="l38.295">   // Malloc these from an arena</span>
<a href="#l38.296"></a><span id="l38.296">   AbCard *newCard = (AbCard *) PR_Calloc(1, sizeof(struct AbCard));</span>
<a href="#l38.297"></a><span id="l38.297">   if (!newCard)</span>
<a href="#l38.298"></a><span id="l38.298">     return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l38.299"></a><span id="l38.299"> </span>
<a href="#l38.300"></a><span id="l38.300">   newCard-&gt;card = card;</span>
<a href="#l38.301"></a><span id="l38.301">   NS_IF_ADDREF(newCard-&gt;card);</span>
<a href="#l38.302"></a><span id="l38.302" class="difflineminus">-    </span>
<a href="#l38.303"></a><span id="l38.303" class="difflineplus">+</span>
<a href="#l38.304"></a><span id="l38.304">   rv = GenerateCollationKeysForCard(mSortColumn.get(), newCard);</span>
<a href="#l38.305"></a><span id="l38.305">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l38.306"></a><span id="l38.306"> </span>
<a href="#l38.307"></a><span id="l38.307">   bool cardWasSelected = false;</span>
<a href="#l38.308"></a><span id="l38.308"> </span>
<a href="#l38.309"></a><span id="l38.309">   if (mTreeSelection) {</span>
<a href="#l38.310"></a><span id="l38.310">     rv = mTreeSelection-&gt;IsSelected(index, &amp;cardWasSelected);</span>
<a href="#l38.311"></a><span id="l38.311">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l38.312"></a><span id="l38.312">   }</span>
<a href="#l38.313"></a><span id="l38.313" class="difflineminus">-  </span>
<a href="#l38.314"></a><span id="l38.314" class="difflineplus">+</span>
<a href="#l38.315"></a><span id="l38.315">   if (!CompareCollationKeys(newCard-&gt;primaryCollationKey,newCard-&gt;primaryCollationKeyLen,oldCard-&gt;primaryCollationKey,oldCard-&gt;primaryCollationKeyLen)</span>
<a href="#l38.316"></a><span id="l38.316">     &amp;&amp; CompareCollationKeys(newCard-&gt;secondaryCollationKey,newCard-&gt;secondaryCollationKeyLen,oldCard-&gt;secondaryCollationKey,oldCard-&gt;secondaryCollationKeyLen)) {</span>
<a href="#l38.317"></a><span id="l38.317">     // No need to remove and add, since the collation keys haven't changed.</span>
<a href="#l38.318"></a><span id="l38.318">     // Since they haven't changed, the card will sort to the same place.</span>
<a href="#l38.319"></a><span id="l38.319">     // We just need to clean up what we allocated.</span>
<a href="#l38.320"></a><span id="l38.320">     NS_IF_RELEASE(newCard-&gt;card);</span>
<a href="#l38.321"></a><span id="l38.321">     if (newCard-&gt;primaryCollationKey)</span>
<a href="#l38.322"></a><span id="l38.322">       free(newCard-&gt;primaryCollationKey);</span>
<a href="#l38.323"></a><span id="l38.323" class="difflineat">@@ -1098,17 +1098,17 @@ NS_IMETHODIMP nsAbView::OnItemPropertyCh</span>
<a href="#l38.324"></a><span id="l38.324">     // Add the card we created, and select it (to restore selection) if it was selected.</span>
<a href="#l38.325"></a><span id="l38.325">     rv = AddCard(newCard, cardWasSelected /* select card */, &amp;index);</span>
<a href="#l38.326"></a><span id="l38.326">     NS_ASSERTION(NS_SUCCEEDED(rv), &quot;add card failed\n&quot;);</span>
<a href="#l38.327"></a><span id="l38.327"> </span>
<a href="#l38.328"></a><span id="l38.328">     mSuppressSelectionChange = false;</span>
<a href="#l38.329"></a><span id="l38.329">     mSuppressCountChange = false;</span>
<a href="#l38.330"></a><span id="l38.330"> </span>
<a href="#l38.331"></a><span id="l38.331">     // Ensure restored selection is visible</span>
<a href="#l38.332"></a><span id="l38.332" class="difflineminus">-    if (cardWasSelected &amp;&amp; mTree) </span>
<a href="#l38.333"></a><span id="l38.333" class="difflineplus">+    if (cardWasSelected &amp;&amp; mTree)</span>
<a href="#l38.334"></a><span id="l38.334">       mTree-&gt;EnsureRowIsVisible(index);</span>
<a href="#l38.335"></a><span id="l38.335">   }</span>
<a href="#l38.336"></a><span id="l38.336"> </span>
<a href="#l38.337"></a><span id="l38.337">   // Although the selection hasn't changed, the card that is selected may need</span>
<a href="#l38.338"></a><span id="l38.338">   // to be displayed differently, therefore pretend that the selection has</span>
<a href="#l38.339"></a><span id="l38.339">   // changed to force that update.</span>
<a href="#l38.340"></a><span id="l38.340">   if (cardWasSelected)</span>
<a href="#l38.341"></a><span id="l38.341">     SelectionChanged();</span>
<a href="#l38.342"></a><span id="l38.342" class="difflineat">@@ -1165,32 +1165,32 @@ nsresult nsAbView::ReselectCards(nsIArra</span>
<a href="#l38.343"></a><span id="l38.343">     }</span>
<a href="#l38.344"></a><span id="l38.344">   }</span>
<a href="#l38.345"></a><span id="l38.345"> </span>
<a href="#l38.346"></a><span id="l38.346">   // Reset the index card, and ensure it is visible.</span>
<a href="#l38.347"></a><span id="l38.347">   if (aIndexCard) {</span>
<a href="#l38.348"></a><span id="l38.348">     int32_t currentIndex = FindIndexForCard(aIndexCard);</span>
<a href="#l38.349"></a><span id="l38.349">     rv = mTreeSelection-&gt;SetCurrentIndex(currentIndex);</span>
<a href="#l38.350"></a><span id="l38.350">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l38.351"></a><span id="l38.351" class="difflineminus">-  </span>
<a href="#l38.352"></a><span id="l38.352" class="difflineplus">+</span>
<a href="#l38.353"></a><span id="l38.353">     if (mTree) {</span>
<a href="#l38.354"></a><span id="l38.354">       rv = mTree-&gt;EnsureRowIsVisible(currentIndex);</span>
<a href="#l38.355"></a><span id="l38.355">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l38.356"></a><span id="l38.356">     }</span>
<a href="#l38.357"></a><span id="l38.357">   }</span>
<a href="#l38.358"></a><span id="l38.358"> </span>
<a href="#l38.359"></a><span id="l38.359">   return NS_OK;</span>
<a href="#l38.360"></a><span id="l38.360"> }</span>
<a href="#l38.361"></a><span id="l38.361"> </span>
<a href="#l38.362"></a><span id="l38.362"> NS_IMETHODIMP nsAbView::DeleteSelectedCards()</span>
<a href="#l38.363"></a><span id="l38.363"> {</span>
<a href="#l38.364"></a><span id="l38.364">   nsresult rv;</span>
<a href="#l38.365"></a><span id="l38.365">   nsCOMPtr&lt;nsIMutableArray&gt; cardsToDelete = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l38.366"></a><span id="l38.366">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l38.367"></a><span id="l38.367" class="difflineminus">-  </span>
<a href="#l38.368"></a><span id="l38.368" class="difflineplus">+</span>
<a href="#l38.369"></a><span id="l38.369">   rv = GetSelectedCards(cardsToDelete);</span>
<a href="#l38.370"></a><span id="l38.370">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l38.371"></a><span id="l38.371"> </span>
<a href="#l38.372"></a><span id="l38.372">   // mDirectory should not be null</span>
<a href="#l38.373"></a><span id="l38.373">   // Bullet proof (and assert) to help figure out bug #127748</span>
<a href="#l38.374"></a><span id="l38.374">   NS_ENSURE_TRUE(mDirectory, NS_ERROR_UNEXPECTED);</span>
<a href="#l38.375"></a><span id="l38.375"> </span>
<a href="#l38.376"></a><span id="l38.376">   rv = mDirectory-&gt;DeleteCards(cardsToDelete);</span>
<a href="#l38.377"></a><span id="l38.377" class="difflineat">@@ -1198,58 +1198,58 @@ NS_IMETHODIMP nsAbView::DeleteSelectedCa</span>
<a href="#l38.378"></a><span id="l38.378">   return rv;</span>
<a href="#l38.379"></a><span id="l38.379"> }</span>
<a href="#l38.380"></a><span id="l38.380"> </span>
<a href="#l38.381"></a><span id="l38.381"> nsresult nsAbView::GetSelectedCards(nsCOMPtr&lt;nsIMutableArray&gt; &amp;aSelectedCards)</span>
<a href="#l38.382"></a><span id="l38.382"> {</span>
<a href="#l38.383"></a><span id="l38.383">   if (!mTreeSelection)</span>
<a href="#l38.384"></a><span id="l38.384">     return NS_OK;</span>
<a href="#l38.385"></a><span id="l38.385"> </span>
<a href="#l38.386"></a><span id="l38.386" class="difflineminus">-  int32_t selectionCount; </span>
<a href="#l38.387"></a><span id="l38.387" class="difflineplus">+  int32_t selectionCount;</span>
<a href="#l38.388"></a><span id="l38.388">   nsresult rv = mTreeSelection-&gt;GetRangeCount(&amp;selectionCount);</span>
<a href="#l38.389"></a><span id="l38.389">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l38.390"></a><span id="l38.390"> </span>
<a href="#l38.391"></a><span id="l38.391">   if (!selectionCount)</span>
<a href="#l38.392"></a><span id="l38.392">     return NS_OK;</span>
<a href="#l38.393"></a><span id="l38.393"> </span>
<a href="#l38.394"></a><span id="l38.394">   for (int32_t i = 0; i &lt; selectionCount; i++)</span>
<a href="#l38.395"></a><span id="l38.395">   {</span>
<a href="#l38.396"></a><span id="l38.396">     int32_t startRange;</span>
<a href="#l38.397"></a><span id="l38.397">     int32_t endRange;</span>
<a href="#l38.398"></a><span id="l38.398">     rv = mTreeSelection-&gt;GetRangeAt(i, &amp;startRange, &amp;endRange);</span>
<a href="#l38.399"></a><span id="l38.399" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, NS_OK); </span>
<a href="#l38.400"></a><span id="l38.400" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, NS_OK);</span>
<a href="#l38.401"></a><span id="l38.401">     int32_t totalCards = mCards.Length();</span>
<a href="#l38.402"></a><span id="l38.402">     if (startRange &gt;= 0 &amp;&amp; startRange &lt; totalCards)</span>
<a href="#l38.403"></a><span id="l38.403">     {</span>
<a href="#l38.404"></a><span id="l38.404">       for (int32_t rangeIndex = startRange; rangeIndex &lt;= endRange &amp;&amp; rangeIndex &lt; totalCards; rangeIndex++) {</span>
<a href="#l38.405"></a><span id="l38.405">         nsCOMPtr&lt;nsIAbCard&gt; abCard;</span>
<a href="#l38.406"></a><span id="l38.406">         rv = GetCardFromRow(rangeIndex, getter_AddRefs(abCard));</span>
<a href="#l38.407"></a><span id="l38.407">         NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l38.408"></a><span id="l38.408" class="difflineminus">-        </span>
<a href="#l38.409"></a><span id="l38.409" class="difflineplus">+</span>
<a href="#l38.410"></a><span id="l38.410">         rv = aSelectedCards-&gt;AppendElement(abCard, false);</span>
<a href="#l38.411"></a><span id="l38.411">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l38.412"></a><span id="l38.412">       }</span>
<a href="#l38.413"></a><span id="l38.413">     }</span>
<a href="#l38.414"></a><span id="l38.414">   }</span>
<a href="#l38.415"></a><span id="l38.415"> </span>
<a href="#l38.416"></a><span id="l38.416">   return NS_OK;</span>
<a href="#l38.417"></a><span id="l38.417"> }</span>
<a href="#l38.418"></a><span id="l38.418"> </span>
<a href="#l38.419"></a><span id="l38.419"> NS_IMETHODIMP nsAbView::SwapFirstNameLastName()</span>
<a href="#l38.420"></a><span id="l38.420"> {</span>
<a href="#l38.421"></a><span id="l38.421">   if (!mTreeSelection)</span>
<a href="#l38.422"></a><span id="l38.422">     return NS_OK;</span>
<a href="#l38.423"></a><span id="l38.423" class="difflineminus">-  </span>
<a href="#l38.424"></a><span id="l38.424" class="difflineminus">-  int32_t selectionCount; </span>
<a href="#l38.425"></a><span id="l38.425" class="difflineplus">+</span>
<a href="#l38.426"></a><span id="l38.426" class="difflineplus">+  int32_t selectionCount;</span>
<a href="#l38.427"></a><span id="l38.427">   nsresult rv = mTreeSelection-&gt;GetRangeCount(&amp;selectionCount);</span>
<a href="#l38.428"></a><span id="l38.428">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l38.429"></a><span id="l38.429" class="difflineminus">-  </span>
<a href="#l38.430"></a><span id="l38.430" class="difflineplus">+</span>
<a href="#l38.431"></a><span id="l38.431">   if (!selectionCount)</span>
<a href="#l38.432"></a><span id="l38.432">     return NS_OK;</span>
<a href="#l38.433"></a><span id="l38.433" class="difflineminus">-  </span>
<a href="#l38.434"></a><span id="l38.434" class="difflineplus">+</span>
<a href="#l38.435"></a><span id="l38.435">   // Prepare for displayname generation</span>
<a href="#l38.436"></a><span id="l38.436">   // No cache for pref and bundle since the swap operation is not executed frequently</span>
<a href="#l38.437"></a><span id="l38.437">   bool displayNameAutoGeneration;</span>
<a href="#l38.438"></a><span id="l38.438">   bool displayNameLastnamefirst = false;</span>
<a href="#l38.439"></a><span id="l38.439"> </span>
<a href="#l38.440"></a><span id="l38.440">   nsCOMPtr&lt;nsIPrefBranch&gt; pPrefBranchInt(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l38.441"></a><span id="l38.441">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l38.442"></a><span id="l38.442"> </span>
<a href="#l38.443"></a><span id="l38.443" class="difflineat">@@ -1266,27 +1266,27 @@ NS_IMETHODIMP nsAbView::SwapFirstNameLas</span>
<a href="#l38.444"></a><span id="l38.444"> </span>
<a href="#l38.445"></a><span id="l38.445">     nsString str;</span>
<a href="#l38.446"></a><span id="l38.446">     pls-&gt;ToString(getter_Copies(str));</span>
<a href="#l38.447"></a><span id="l38.447">     displayNameLastnamefirst = str.EqualsLiteral(&quot;true&quot;);</span>
<a href="#l38.448"></a><span id="l38.448">     nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l38.449"></a><span id="l38.449">       mozilla::services::GetStringBundleService();</span>
<a href="#l38.450"></a><span id="l38.450">     NS_ENSURE_TRUE(bundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l38.451"></a><span id="l38.451"> </span>
<a href="#l38.452"></a><span id="l38.452" class="difflineminus">-    rv = bundleService-&gt;CreateBundle(&quot;chrome://messenger/locale/addressbook/addressBook.properties&quot;, </span>
<a href="#l38.453"></a><span id="l38.453" class="difflineplus">+    rv = bundleService-&gt;CreateBundle(&quot;chrome://messenger/locale/addressbook/addressBook.properties&quot;,</span>
<a href="#l38.454"></a><span id="l38.454">                                      getter_AddRefs(bundle));</span>
<a href="#l38.455"></a><span id="l38.455">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l38.456"></a><span id="l38.456">   }</span>
<a href="#l38.457"></a><span id="l38.457"> </span>
<a href="#l38.458"></a><span id="l38.458">   for (int32_t i = 0; i &lt; selectionCount; i++)</span>
<a href="#l38.459"></a><span id="l38.459">   {</span>
<a href="#l38.460"></a><span id="l38.460">     int32_t startRange;</span>
<a href="#l38.461"></a><span id="l38.461">     int32_t endRange;</span>
<a href="#l38.462"></a><span id="l38.462">     rv = mTreeSelection-&gt;GetRangeAt(i, &amp;startRange, &amp;endRange);</span>
<a href="#l38.463"></a><span id="l38.463" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, NS_OK); </span>
<a href="#l38.464"></a><span id="l38.464" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, NS_OK);</span>
<a href="#l38.465"></a><span id="l38.465">     int32_t totalCards = mCards.Length();</span>
<a href="#l38.466"></a><span id="l38.466">     if (startRange &gt;= 0 &amp;&amp; startRange &lt; totalCards)</span>
<a href="#l38.467"></a><span id="l38.467">     {</span>
<a href="#l38.468"></a><span id="l38.468">       for (int32_t rangeIndex = startRange; rangeIndex &lt;= endRange &amp;&amp; rangeIndex &lt; totalCards; rangeIndex++) {</span>
<a href="#l38.469"></a><span id="l38.469">         nsCOMPtr&lt;nsIAbCard&gt; abCard;</span>
<a href="#l38.470"></a><span id="l38.470">         rv = GetCardFromRow(rangeIndex, getter_AddRefs(abCard));</span>
<a href="#l38.471"></a><span id="l38.471">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l38.472"></a><span id="l38.472"> </span>
<a href="#l38.473"></a><span id="l38.473" class="difflineat">@@ -1428,15 +1428,15 @@ NS_IMETHODIMP nsAbView::GetSelectedAddre</span>
<a href="#l38.474"></a><span id="l38.474">       rv = card-&gt;GetPrimaryEmail(primaryEmail);</span>
<a href="#l38.475"></a><span id="l38.475">       NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l38.476"></a><span id="l38.476"> </span>
<a href="#l38.477"></a><span id="l38.477">       if (!primaryEmail.IsEmpty()) {</span>
<a href="#l38.478"></a><span id="l38.478">         nsCOMPtr&lt;nsISupportsString&gt; supportsEmail(do_CreateInstance(NS_SUPPORTS_STRING_CONTRACTID));</span>
<a href="#l38.479"></a><span id="l38.479">         supportsEmail-&gt;SetData(primaryEmail);</span>
<a href="#l38.480"></a><span id="l38.480">         addresses-&gt;AppendElement(supportsEmail, false);</span>
<a href="#l38.481"></a><span id="l38.481">       }</span>
<a href="#l38.482"></a><span id="l38.482" class="difflineminus">-    }    </span>
<a href="#l38.483"></a><span id="l38.483" class="difflineplus">+    }</span>
<a href="#l38.484"></a><span id="l38.484">   }</span>
<a href="#l38.485"></a><span id="l38.485"> </span>
<a href="#l38.486"></a><span id="l38.486">   addresses.forget(_retval);</span>
<a href="#l38.487"></a><span id="l38.487"> </span>
<a href="#l38.488"></a><span id="l38.488">   return NS_OK;</span>
<a href="#l38.489"></a><span id="l38.489"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l39.1"></a><span id="l39.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbView.h</span>
<a href="#l39.2"></a><span id="l39.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbView.h</span>
<a href="#l39.3"></a><span id="l39.3" class="difflineat">@@ -37,17 +37,17 @@ class nsAbView : public nsIAbView, publi</span>
<a href="#l39.4"></a><span id="l39.4"> public:</span>
<a href="#l39.5"></a><span id="l39.5">   nsAbView();</span>
<a href="#l39.6"></a><span id="l39.6"> </span>
<a href="#l39.7"></a><span id="l39.7">   NS_DECL_ISUPPORTS</span>
<a href="#l39.8"></a><span id="l39.8">   NS_DECL_NSIABVIEW</span>
<a href="#l39.9"></a><span id="l39.9">   NS_DECL_NSITREEVIEW</span>
<a href="#l39.10"></a><span id="l39.10">   NS_DECL_NSIABLISTENER</span>
<a href="#l39.11"></a><span id="l39.11">   NS_DECL_NSIOBSERVER</span>
<a href="#l39.12"></a><span id="l39.12" class="difflineminus">-  </span>
<a href="#l39.13"></a><span id="l39.13" class="difflineplus">+</span>
<a href="#l39.14"></a><span id="l39.14">   int32_t CompareCollationKeys(uint8_t *key1, uint32_t len1, uint8_t *key2, uint32_t len2);</span>
<a href="#l39.15"></a><span id="l39.15"> </span>
<a href="#l39.16"></a><span id="l39.16"> private:</span>
<a href="#l39.17"></a><span id="l39.17">   virtual ~nsAbView();</span>
<a href="#l39.18"></a><span id="l39.18">   nsresult Initialize();</span>
<a href="#l39.19"></a><span id="l39.19">   int32_t FindIndexForInsert(AbCard *abcard);</span>
<a href="#l39.20"></a><span id="l39.20">   int32_t FindIndexForCard(nsIAbCard *card);</span>
<a href="#l39.21"></a><span id="l39.21">   nsresult GenerateCollationKeysForCard(const char16_t *colID, AbCard *abcard);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l40.1"></a><span id="l40.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbWinHelper.cpp</span>
<a href="#l40.2"></a><span id="l40.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbWinHelper.cpp</span>
<a href="#l40.3"></a><span id="l40.3" class="difflineat">@@ -37,17 +37,17 @@ template &lt;class tInterface&gt; struct nsMap</span>
<a href="#l40.4"></a><span id="l40.4"> </span>
<a href="#l40.5"></a><span id="l40.5"> static void assignEntryID(LPENTRYID&amp; aTarget, LPENTRYID aSource, ULONG aByteCount)</span>
<a href="#l40.6"></a><span id="l40.6"> {</span>
<a href="#l40.7"></a><span id="l40.7">     if (aTarget != NULL) {</span>
<a href="#l40.8"></a><span id="l40.8">         delete [] (reinterpret_cast&lt;LPBYTE&gt;(aTarget)) ;</span>
<a href="#l40.9"></a><span id="l40.9">         aTarget = NULL ;</span>
<a href="#l40.10"></a><span id="l40.10">     }</span>
<a href="#l40.11"></a><span id="l40.11">     if (aSource != NULL) {</span>
<a href="#l40.12"></a><span id="l40.12" class="difflineminus">-        aTarget = reinterpret_cast&lt;LPENTRYID&gt;(new BYTE [aByteCount]) ;</span>
<a href="#l40.13"></a><span id="l40.13" class="difflineplus">+        aTarget = reinterpret_cast&lt;LPENTRYID&gt;(new BYTE[aByteCount]) ;</span>
<a href="#l40.14"></a><span id="l40.14">         memcpy(aTarget, aSource, aByteCount) ;</span>
<a href="#l40.15"></a><span id="l40.15">     }</span>
<a href="#l40.16"></a><span id="l40.16"> }</span>
<a href="#l40.17"></a><span id="l40.17"> </span>
<a href="#l40.18"></a><span id="l40.18"> nsMapiEntry::nsMapiEntry(void)</span>
<a href="#l40.19"></a><span id="l40.19"> : mByteCount(0), mEntryId(NULL)</span>
<a href="#l40.20"></a><span id="l40.20"> {</span>
<a href="#l40.21"></a><span id="l40.21">     MOZ_COUNT_CTOR(nsMapiEntry) ;</span>
<a href="#l40.22"></a><span id="l40.22" class="difflineat">@@ -73,113 +73,113 @@ void nsMapiEntry::Assign(ULONG aByteCoun</span>
<a href="#l40.23"></a><span id="l40.23"> }</span>
<a href="#l40.24"></a><span id="l40.24"> </span>
<a href="#l40.25"></a><span id="l40.25"> static char UnsignedToChar(unsigned char aUnsigned)</span>
<a href="#l40.26"></a><span id="l40.26"> {</span>
<a href="#l40.27"></a><span id="l40.27">     if (aUnsigned &lt; 0xA) { return '0' + aUnsigned ; }</span>
<a href="#l40.28"></a><span id="l40.28">     return 'A' + aUnsigned - 0xA ;</span>
<a href="#l40.29"></a><span id="l40.29"> }</span>
<a href="#l40.30"></a><span id="l40.30"> </span>
<a href="#l40.31"></a><span id="l40.31" class="difflineminus">-static char kBase64Encoding [] = &quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-.&quot; ;</span>
<a href="#l40.32"></a><span id="l40.32" class="difflineplus">+static char kBase64Encoding[] = &quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-.&quot; ;</span>
<a href="#l40.33"></a><span id="l40.33"> static const int kARank = 0 ;</span>
<a href="#l40.34"></a><span id="l40.34"> static const int kaRank = 26 ;</span>
<a href="#l40.35"></a><span id="l40.35"> static const int k0Rank = 52 ;</span>
<a href="#l40.36"></a><span id="l40.36"> static const unsigned char kMinusRank = 62 ;</span>
<a href="#l40.37"></a><span id="l40.37"> static const unsigned char kDotRank = 63 ;</span>
<a href="#l40.38"></a><span id="l40.38"> </span>
<a href="#l40.39"></a><span id="l40.39" class="difflineminus">-static void UnsignedToBase64(unsigned char *&amp; aUnsigned, </span>
<a href="#l40.40"></a><span id="l40.40" class="difflineplus">+static void UnsignedToBase64(unsigned char *&amp; aUnsigned,</span>
<a href="#l40.41"></a><span id="l40.41">                              ULONG aNbUnsigned, nsCString&amp; aString)</span>
<a href="#l40.42"></a><span id="l40.42"> {</span>
<a href="#l40.43"></a><span id="l40.43">     if (aNbUnsigned &gt; 0) {</span>
<a href="#l40.44"></a><span id="l40.44">         unsigned char remain0 = (*aUnsigned &amp; 0x03) &lt;&lt; 4 ;</span>
<a href="#l40.45"></a><span id="l40.45"> </span>
<a href="#l40.46"></a><span id="l40.46" class="difflineminus">-        aString.Append(kBase64Encoding [(*aUnsigned &gt;&gt; 2) &amp; 0x3F]) ;</span>
<a href="#l40.47"></a><span id="l40.47" class="difflineminus">-        ++ aUnsigned ;</span>
<a href="#l40.48"></a><span id="l40.48" class="difflineplus">+        aString.Append(kBase64Encoding[(*aUnsigned &gt;&gt; 2) &amp; 0x3F]) ;</span>
<a href="#l40.49"></a><span id="l40.49" class="difflineplus">+        ++aUnsigned ;</span>
<a href="#l40.50"></a><span id="l40.50">         if (aNbUnsigned &gt; 1) {</span>
<a href="#l40.51"></a><span id="l40.51">             unsigned char remain1 = (*aUnsigned &amp; 0x0F) &lt;&lt; 2 ;</span>
<a href="#l40.52"></a><span id="l40.52"> </span>
<a href="#l40.53"></a><span id="l40.53" class="difflineminus">-            aString.Append(kBase64Encoding [remain0 | ((*aUnsigned &gt;&gt; 4) &amp; 0x0F)]) ;</span>
<a href="#l40.54"></a><span id="l40.54" class="difflineminus">-            ++ aUnsigned ;</span>
<a href="#l40.55"></a><span id="l40.55" class="difflineplus">+            aString.Append(kBase64Encoding[remain0 | ((*aUnsigned &gt;&gt; 4) &amp; 0x0F)]) ;</span>
<a href="#l40.56"></a><span id="l40.56" class="difflineplus">+            ++aUnsigned ;</span>
<a href="#l40.57"></a><span id="l40.57">             if (aNbUnsigned &gt; 2) {</span>
<a href="#l40.58"></a><span id="l40.58" class="difflineminus">-                aString.Append(kBase64Encoding [remain1 | ((*aUnsigned &gt;&gt; 6) &amp; 0x03)]) ;</span>
<a href="#l40.59"></a><span id="l40.59" class="difflineminus">-                aString.Append(kBase64Encoding [*aUnsigned &amp; 0x3F]) ;</span>
<a href="#l40.60"></a><span id="l40.60" class="difflineminus">-                ++ aUnsigned ;</span>
<a href="#l40.61"></a><span id="l40.61" class="difflineplus">+                aString.Append(kBase64Encoding[remain1 | ((*aUnsigned &gt;&gt; 6) &amp; 0x03)]) ;</span>
<a href="#l40.62"></a><span id="l40.62" class="difflineplus">+                aString.Append(kBase64Encoding[*aUnsigned &amp; 0x3F]) ;</span>
<a href="#l40.63"></a><span id="l40.63" class="difflineplus">+                ++aUnsigned ;</span>
<a href="#l40.64"></a><span id="l40.64">             }</span>
<a href="#l40.65"></a><span id="l40.65">             else {</span>
<a href="#l40.66"></a><span id="l40.66" class="difflineminus">-                aString.Append(kBase64Encoding [remain1]) ;</span>
<a href="#l40.67"></a><span id="l40.67" class="difflineplus">+                aString.Append(kBase64Encoding[remain1]) ;</span>
<a href="#l40.68"></a><span id="l40.68">             }</span>
<a href="#l40.69"></a><span id="l40.69">         }</span>
<a href="#l40.70"></a><span id="l40.70">         else {</span>
<a href="#l40.71"></a><span id="l40.71" class="difflineminus">-            aString.Append(kBase64Encoding [remain0]) ;</span>
<a href="#l40.72"></a><span id="l40.72" class="difflineplus">+            aString.Append(kBase64Encoding[remain0]) ;</span>
<a href="#l40.73"></a><span id="l40.73">         }</span>
<a href="#l40.74"></a><span id="l40.74">     }</span>
<a href="#l40.75"></a><span id="l40.75"> }</span>
<a href="#l40.76"></a><span id="l40.76"> </span>
<a href="#l40.77"></a><span id="l40.77"> static unsigned char CharToUnsigned(char aChar)</span>
<a href="#l40.78"></a><span id="l40.78"> {</span>
<a href="#l40.79"></a><span id="l40.79">     if (aChar &gt;= '0' &amp;&amp; aChar &lt;= '9') { return static_cast&lt;unsigned char&gt;(aChar) - '0' ; }</span>
<a href="#l40.80"></a><span id="l40.80">     return static_cast&lt;unsigned char&gt;(aChar) - 'A' + 0xA ;</span>
<a href="#l40.81"></a><span id="l40.81"> }</span>
<a href="#l40.82"></a><span id="l40.82"> </span>
<a href="#l40.83"></a><span id="l40.83" class="difflineminus">-// This function must return the rank in kBase64Encoding of the </span>
<a href="#l40.84"></a><span id="l40.84" class="difflineplus">+// This function must return the rank in kBase64Encoding of the</span>
<a href="#l40.85"></a><span id="l40.85"> // character provided.</span>
<a href="#l40.86"></a><span id="l40.86"> static unsigned char Base64To6Bits(char aBase64)</span>
<a href="#l40.87"></a><span id="l40.87"> {</span>
<a href="#l40.88"></a><span id="l40.88" class="difflineminus">-    if (aBase64 &gt;= 'A' &amp;&amp; aBase64 &lt;= 'Z') { </span>
<a href="#l40.89"></a><span id="l40.89" class="difflineminus">-        return static_cast&lt;unsigned char&gt;(aBase64 - 'A' + kARank) ; </span>
<a href="#l40.90"></a><span id="l40.90" class="difflineplus">+    if (aBase64 &gt;= 'A' &amp;&amp; aBase64 &lt;= 'Z') {</span>
<a href="#l40.91"></a><span id="l40.91" class="difflineplus">+        return static_cast&lt;unsigned char&gt;(aBase64 - 'A' + kARank) ;</span>
<a href="#l40.92"></a><span id="l40.92">     }</span>
<a href="#l40.93"></a><span id="l40.93" class="difflineminus">-    if (aBase64 &gt;= 'a' &amp;&amp; aBase64 &lt;= 'z') { </span>
<a href="#l40.94"></a><span id="l40.94" class="difflineminus">-        return static_cast&lt;unsigned char&gt;(aBase64 - 'a' + kaRank) ; </span>
<a href="#l40.95"></a><span id="l40.95" class="difflineplus">+    if (aBase64 &gt;= 'a' &amp;&amp; aBase64 &lt;= 'z') {</span>
<a href="#l40.96"></a><span id="l40.96" class="difflineplus">+        return static_cast&lt;unsigned char&gt;(aBase64 - 'a' + kaRank) ;</span>
<a href="#l40.97"></a><span id="l40.97">     }</span>
<a href="#l40.98"></a><span id="l40.98">     if (aBase64 &gt;= '0' &amp;&amp; aBase64 &lt;= '9') {</span>
<a href="#l40.99"></a><span id="l40.99">         return static_cast&lt;unsigned char&gt;(aBase64 - '0' + k0Rank) ;</span>
<a href="#l40.100"></a><span id="l40.100">     }</span>
<a href="#l40.101"></a><span id="l40.101">     if (aBase64 == '-') { return kMinusRank ; }</span>
<a href="#l40.102"></a><span id="l40.102">     if (aBase64 == '.') { return kDotRank ; }</span>
<a href="#l40.103"></a><span id="l40.103">     return 0 ;</span>
<a href="#l40.104"></a><span id="l40.104"> }</span>
<a href="#l40.105"></a><span id="l40.105"> </span>
<a href="#l40.106"></a><span id="l40.106" class="difflineminus">-static void Base64ToUnsigned(const char *&amp; aBase64, uint32_t aNbBase64, </span>
<a href="#l40.107"></a><span id="l40.107" class="difflineplus">+static void Base64ToUnsigned(const char *&amp; aBase64, uint32_t aNbBase64,</span>
<a href="#l40.108"></a><span id="l40.108">                              unsigned char *&amp;aUnsigned)</span>
<a href="#l40.109"></a><span id="l40.109"> {</span>
<a href="#l40.110"></a><span id="l40.110">     // By design of the encoding, we must have at least two characters to use</span>
<a href="#l40.111"></a><span id="l40.111">     if (aNbBase64 &gt; 1) {</span>
<a href="#l40.112"></a><span id="l40.112" class="difflineminus">-        unsigned char first6Bits = Base64To6Bits(*aBase64 ++) ;</span>
<a href="#l40.113"></a><span id="l40.113" class="difflineminus">-        unsigned char second6Bits = Base64To6Bits(*aBase64 ++) ;</span>
<a href="#l40.114"></a><span id="l40.114" class="difflineplus">+        unsigned char first6Bits = Base64To6Bits(*aBase64++) ;</span>
<a href="#l40.115"></a><span id="l40.115" class="difflineplus">+        unsigned char second6Bits = Base64To6Bits(*aBase64++) ;</span>
<a href="#l40.116"></a><span id="l40.116"> </span>
<a href="#l40.117"></a><span id="l40.117">         *aUnsigned = first6Bits &lt;&lt; 2 ;</span>
<a href="#l40.118"></a><span id="l40.118">         *aUnsigned |= second6Bits &gt;&gt; 4 ;</span>
<a href="#l40.119"></a><span id="l40.119" class="difflineminus">-        ++ aUnsigned ;</span>
<a href="#l40.120"></a><span id="l40.120" class="difflineplus">+        ++aUnsigned ;</span>
<a href="#l40.121"></a><span id="l40.121">         if (aNbBase64 &gt; 2) {</span>
<a href="#l40.122"></a><span id="l40.122" class="difflineminus">-            unsigned char third6Bits = Base64To6Bits(*aBase64 ++) ;</span>
<a href="#l40.123"></a><span id="l40.123" class="difflineplus">+            unsigned char third6Bits = Base64To6Bits(*aBase64++) ;</span>
<a href="#l40.124"></a><span id="l40.124"> </span>
<a href="#l40.125"></a><span id="l40.125">             *aUnsigned = second6Bits &lt;&lt; 4 ;</span>
<a href="#l40.126"></a><span id="l40.126">             *aUnsigned |= third6Bits &gt;&gt; 2 ;</span>
<a href="#l40.127"></a><span id="l40.127" class="difflineminus">-            ++ aUnsigned ;</span>
<a href="#l40.128"></a><span id="l40.128" class="difflineplus">+            ++aUnsigned ;</span>
<a href="#l40.129"></a><span id="l40.129">             if (aNbBase64 &gt; 3) {</span>
<a href="#l40.130"></a><span id="l40.130" class="difflineminus">-                unsigned char fourth6Bits = Base64To6Bits(*aBase64 ++) ;</span>
<a href="#l40.131"></a><span id="l40.131" class="difflineplus">+                unsigned char fourth6Bits = Base64To6Bits(*aBase64++) ;</span>
<a href="#l40.132"></a><span id="l40.132"> </span>
<a href="#l40.133"></a><span id="l40.133">                 *aUnsigned = third6Bits &lt;&lt; 6 ;</span>
<a href="#l40.134"></a><span id="l40.134">                 *aUnsigned |= fourth6Bits ;</span>
<a href="#l40.135"></a><span id="l40.135" class="difflineminus">-                ++ aUnsigned ;</span>
<a href="#l40.136"></a><span id="l40.136" class="difflineplus">+                ++aUnsigned ;</span>
<a href="#l40.137"></a><span id="l40.137">             }</span>
<a href="#l40.138"></a><span id="l40.138">         }</span>
<a href="#l40.139"></a><span id="l40.139">     }</span>
<a href="#l40.140"></a><span id="l40.140"> }</span>
<a href="#l40.141"></a><span id="l40.141"> </span>
<a href="#l40.142"></a><span id="l40.142"> void nsMapiEntry::Assign(const nsCString&amp; aString)</span>
<a href="#l40.143"></a><span id="l40.143"> {</span>
<a href="#l40.144"></a><span id="l40.144">     Assign(0, NULL) ;</span>
<a href="#l40.145"></a><span id="l40.145">     ULONG byteCount = aString.Length() / 4 * 3 ;</span>
<a href="#l40.146"></a><span id="l40.146"> </span>
<a href="#l40.147"></a><span id="l40.147">     if ((aString.Length() &amp; 0x03) != 0) {</span>
<a href="#l40.148"></a><span id="l40.148">         byteCount += (aString.Length() &amp; 0x03) - 1 ;</span>
<a href="#l40.149"></a><span id="l40.149">     }</span>
<a href="#l40.150"></a><span id="l40.150">     const char *currentSource = aString.get() ;</span>
<a href="#l40.151"></a><span id="l40.151" class="difflineminus">-    unsigned char *currentTarget = new unsigned char [byteCount] ;</span>
<a href="#l40.152"></a><span id="l40.152" class="difflineplus">+    unsigned char *currentTarget = new unsigned char[byteCount] ;</span>
<a href="#l40.153"></a><span id="l40.153">     uint32_t i = 0 ;</span>
<a href="#l40.154"></a><span id="l40.154"> </span>
<a href="#l40.155"></a><span id="l40.155">     mByteCount = byteCount ;</span>
<a href="#l40.156"></a><span id="l40.156">     mEntryId = reinterpret_cast&lt;LPENTRYID&gt;(currentTarget) ;</span>
<a href="#l40.157"></a><span id="l40.157">     for (i = aString.Length() ; i &gt;= 4 ; i -= 4) {</span>
<a href="#l40.158"></a><span id="l40.158">         Base64ToUnsigned(currentSource, 4, currentTarget) ;</span>
<a href="#l40.159"></a><span id="l40.159">     }</span>
<a href="#l40.160"></a><span id="l40.160">     Base64ToUnsigned(currentSource, i, currentTarget) ;</span>
<a href="#l40.161"></a><span id="l40.161" class="difflineat">@@ -195,18 +195,18 @@ void nsMapiEntry::ToString(nsCString&amp; aS</span>
<a href="#l40.162"></a><span id="l40.162">         UnsignedToBase64(currentSource, 3, aString) ;</span>
<a href="#l40.163"></a><span id="l40.163">     }</span>
<a href="#l40.164"></a><span id="l40.164">     UnsignedToBase64(currentSource, i, aString) ;</span>
<a href="#l40.165"></a><span id="l40.165"> }</span>
<a href="#l40.166"></a><span id="l40.166"> </span>
<a href="#l40.167"></a><span id="l40.167"> void nsMapiEntry::Dump(void) const</span>
<a href="#l40.168"></a><span id="l40.168"> {</span>
<a href="#l40.169"></a><span id="l40.169">     PRINTF((&quot;%d\n&quot;, mByteCount)) ;</span>
<a href="#l40.170"></a><span id="l40.170" class="difflineminus">-    for (ULONG i = 0 ; i &lt; mByteCount ; ++ i) {</span>
<a href="#l40.171"></a><span id="l40.171" class="difflineminus">-        PRINTF((&quot;%02X&quot;, (reinterpret_cast&lt;unsigned char *&gt;(mEntryId)) [i])) ;</span>
<a href="#l40.172"></a><span id="l40.172" class="difflineplus">+    for (ULONG i = 0 ; i &lt; mByteCount ; ++i) {</span>
<a href="#l40.173"></a><span id="l40.173" class="difflineplus">+        PRINTF((&quot;%02X&quot;, (reinterpret_cast&lt;unsigned char *&gt;(mEntryId))[i])) ;</span>
<a href="#l40.174"></a><span id="l40.174">     }</span>
<a href="#l40.175"></a><span id="l40.175">     PRINTF((&quot;\n&quot;)) ;</span>
<a href="#l40.176"></a><span id="l40.176"> }</span>
<a href="#l40.177"></a><span id="l40.177"> </span>
<a href="#l40.178"></a><span id="l40.178"> nsMapiEntryArray::nsMapiEntryArray(void)</span>
<a href="#l40.179"></a><span id="l40.179"> : mEntries(NULL), mNbEntries(0)</span>
<a href="#l40.180"></a><span id="l40.180"> {</span>
<a href="#l40.181"></a><span id="l40.181">     MOZ_COUNT_CTOR(nsMapiEntryArray) ;</span>
<a href="#l40.182"></a><span id="l40.182" class="difflineat">@@ -215,33 +215,33 @@ nsMapiEntryArray::nsMapiEntryArray(void)</span>
<a href="#l40.183"></a><span id="l40.183"> nsMapiEntryArray::~nsMapiEntryArray(void)</span>
<a href="#l40.184"></a><span id="l40.184"> {</span>
<a href="#l40.185"></a><span id="l40.185">     if (mEntries) { delete [] mEntries ; }</span>
<a href="#l40.186"></a><span id="l40.186">     MOZ_COUNT_DTOR(nsMapiEntryArray) ;</span>
<a href="#l40.187"></a><span id="l40.187"> }</span>
<a href="#l40.188"></a><span id="l40.188"> </span>
<a href="#l40.189"></a><span id="l40.189"> void nsMapiEntryArray::CleanUp(void)</span>
<a href="#l40.190"></a><span id="l40.190"> {</span>
<a href="#l40.191"></a><span id="l40.191" class="difflineminus">-    if (mEntries != NULL) { </span>
<a href="#l40.192"></a><span id="l40.192" class="difflineplus">+    if (mEntries != NULL) {</span>
<a href="#l40.193"></a><span id="l40.193">         delete [] mEntries ;</span>
<a href="#l40.194"></a><span id="l40.194">         mEntries = NULL ;</span>
<a href="#l40.195"></a><span id="l40.195">         mNbEntries = 0 ;</span>
<a href="#l40.196"></a><span id="l40.196">     }</span>
<a href="#l40.197"></a><span id="l40.197"> }</span>
<a href="#l40.198"></a><span id="l40.198"> </span>
<a href="#l40.199"></a><span id="l40.199"> using namespace mozilla;</span>
<a href="#l40.200"></a><span id="l40.200"> </span>
<a href="#l40.201"></a><span id="l40.201"> uint32_t nsAbWinHelper::mEntryCounter = 0;</span>
<a href="#l40.202"></a><span id="l40.202"> nsAutoPtr&lt;mozilla::Mutex&gt; nsAbWinHelper::mMutex;</span>
<a href="#l40.203"></a><span id="l40.203"> uint32_t nsAbWinHelper::mUseCount = 0;</span>
<a href="#l40.204"></a><span id="l40.204"> // There seems to be a deadlock/auto-destruction issue</span>
<a href="#l40.205"></a><span id="l40.205" class="difflineminus">-// in MAPI when multiple threads perform init/release </span>
<a href="#l40.206"></a><span id="l40.206" class="difflineplus">+// in MAPI when multiple threads perform init/release</span>
<a href="#l40.207"></a><span id="l40.207"> // operations at the same time. So I've put a mutex</span>
<a href="#l40.208"></a><span id="l40.208"> // around both the initialize process and the destruction</span>
<a href="#l40.209"></a><span id="l40.209" class="difflineminus">-// one. I just hope the rest of the calls don't need the </span>
<a href="#l40.210"></a><span id="l40.210" class="difflineplus">+// one. I just hope the rest of the calls don't need the</span>
<a href="#l40.211"></a><span id="l40.211"> // same protection (MAPI is supposed to be thread-safe).</span>
<a href="#l40.212"></a><span id="l40.212"> </span>
<a href="#l40.213"></a><span id="l40.213"> nsAbWinHelper::nsAbWinHelper(void)</span>
<a href="#l40.214"></a><span id="l40.214"> : mAddressBook(NULL), mLastError(S_OK)</span>
<a href="#l40.215"></a><span id="l40.215"> {</span>
<a href="#l40.216"></a><span id="l40.216">   if (!mUseCount++)</span>
<a href="#l40.217"></a><span id="l40.217">     mMutex = new mozilla::Mutex(&quot;nsAbWinHelper.mMutex&quot;);</span>
<a href="#l40.218"></a><span id="l40.218"> </span>
<a href="#l40.219"></a><span id="l40.219" class="difflineat">@@ -260,59 +260,59 @@ BOOL nsAbWinHelper::GetFolders(nsMapiEnt</span>
<a href="#l40.220"></a><span id="l40.220">     aFolders.CleanUp() ;</span>
<a href="#l40.221"></a><span id="l40.221">     nsMapiInterfaceWrapper&lt;LPABCONT&gt; rootFolder ;</span>
<a href="#l40.222"></a><span id="l40.222">     nsMapiInterfaceWrapper&lt;LPMAPITABLE&gt; folders ;</span>
<a href="#l40.223"></a><span id="l40.223">     ULONG objType = 0 ;</span>
<a href="#l40.224"></a><span id="l40.224">     ULONG rowCount = 0 ;</span>
<a href="#l40.225"></a><span id="l40.225">     SRestriction restriction ;</span>
<a href="#l40.226"></a><span id="l40.226">     SPropTagArray folderColumns ;</span>
<a href="#l40.227"></a><span id="l40.227"> </span>
<a href="#l40.228"></a><span id="l40.228" class="difflineminus">-    mLastError = mAddressBook-&gt;OpenEntry(0, NULL, NULL, 0, &amp;objType, </span>
<a href="#l40.229"></a><span id="l40.229" class="difflineplus">+    mLastError = mAddressBook-&gt;OpenEntry(0, NULL, NULL, 0, &amp;objType,</span>
<a href="#l40.230"></a><span id="l40.230">                                          rootFolder) ;</span>
<a href="#l40.231"></a><span id="l40.231" class="difflineminus">-    if (HR_FAILED(mLastError)) { </span>
<a href="#l40.232"></a><span id="l40.232" class="difflineplus">+    if (HR_FAILED(mLastError)) {</span>
<a href="#l40.233"></a><span id="l40.233">         PRINTF((&quot;Cannot open root %08x.\n&quot;, mLastError)) ;</span>
<a href="#l40.234"></a><span id="l40.234" class="difflineminus">-        return FALSE ; </span>
<a href="#l40.235"></a><span id="l40.235" class="difflineplus">+        return FALSE ;</span>
<a href="#l40.236"></a><span id="l40.236">     }</span>
<a href="#l40.237"></a><span id="l40.237">     mLastError = rootFolder-&gt;GetHierarchyTable(0, folders) ;</span>
<a href="#l40.238"></a><span id="l40.238">     if (HR_FAILED(mLastError)) {</span>
<a href="#l40.239"></a><span id="l40.239">         PRINTF((&quot;Cannot get hierarchy %08x.\n&quot;, mLastError)) ;</span>
<a href="#l40.240"></a><span id="l40.240" class="difflineminus">-        return FALSE ; </span>
<a href="#l40.241"></a><span id="l40.241" class="difflineplus">+        return FALSE ;</span>
<a href="#l40.242"></a><span id="l40.242">     }</span>
<a href="#l40.243"></a><span id="l40.243" class="difflineminus">-    // We only take into account modifiable containers, </span>
<a href="#l40.244"></a><span id="l40.244" class="difflineplus">+    // We only take into account modifiable containers,</span>
<a href="#l40.245"></a><span id="l40.245">     // otherwise, we end up with all the directory services...</span>
<a href="#l40.246"></a><span id="l40.246">     restriction.rt = RES_BITMASK ;</span>
<a href="#l40.247"></a><span id="l40.247">     restriction.res.resBitMask.ulPropTag = PR_CONTAINER_FLAGS ;</span>
<a href="#l40.248"></a><span id="l40.248">     restriction.res.resBitMask.relBMR = BMR_NEZ ;</span>
<a href="#l40.249"></a><span id="l40.249">     restriction.res.resBitMask.ulMask = AB_MODIFIABLE ;</span>
<a href="#l40.250"></a><span id="l40.250">     mLastError = folders-&gt;Restrict(&amp;restriction, 0) ;</span>
<a href="#l40.251"></a><span id="l40.251">     if (HR_FAILED(mLastError)) {</span>
<a href="#l40.252"></a><span id="l40.252">         PRINTF((&quot;Cannot restrict table %08x.\n&quot;, mLastError)) ;</span>
<a href="#l40.253"></a><span id="l40.253">     }</span>
<a href="#l40.254"></a><span id="l40.254">     folderColumns.cValues = 1 ;</span>
<a href="#l40.255"></a><span id="l40.255" class="difflineminus">-    folderColumns.aulPropTag [0] = PR_ENTRYID ;</span>
<a href="#l40.256"></a><span id="l40.256" class="difflineplus">+    folderColumns.aulPropTag[0] = PR_ENTRYID ;</span>
<a href="#l40.257"></a><span id="l40.257">     mLastError = folders-&gt;SetColumns(&amp;folderColumns, 0) ;</span>
<a href="#l40.258"></a><span id="l40.258">     if (HR_FAILED(mLastError)) {</span>
<a href="#l40.259"></a><span id="l40.259">         PRINTF((&quot;Cannot set columns %08x.\n&quot;, mLastError)) ;</span>
<a href="#l40.260"></a><span id="l40.260">         return FALSE ;</span>
<a href="#l40.261"></a><span id="l40.261">     }</span>
<a href="#l40.262"></a><span id="l40.262">     mLastError = folders-&gt;GetRowCount(0, &amp;rowCount) ;</span>
<a href="#l40.263"></a><span id="l40.263">     if (HR_SUCCEEDED(mLastError)) {</span>
<a href="#l40.264"></a><span id="l40.264" class="difflineminus">-        aFolders.mEntries = new nsMapiEntry [rowCount] ;</span>
<a href="#l40.265"></a><span id="l40.265" class="difflineplus">+        aFolders.mEntries = new nsMapiEntry[rowCount] ;</span>
<a href="#l40.266"></a><span id="l40.266">         aFolders.mNbEntries = 0 ;</span>
<a href="#l40.267"></a><span id="l40.267">         do {</span>
<a href="#l40.268"></a><span id="l40.268">             LPSRowSet rowSet = NULL ;</span>
<a href="#l40.269"></a><span id="l40.269"> </span>
<a href="#l40.270"></a><span id="l40.270">             rowCount = 0 ;</span>
<a href="#l40.271"></a><span id="l40.271">             mLastError = folders-&gt;QueryRows(1, 0, &amp;rowSet) ;</span>
<a href="#l40.272"></a><span id="l40.272">             if (HR_SUCCEEDED(mLastError)) {</span>
<a href="#l40.273"></a><span id="l40.273">                 rowCount = rowSet-&gt;cRows ;</span>
<a href="#l40.274"></a><span id="l40.274">                 if (rowCount &gt; 0) {</span>
<a href="#l40.275"></a><span id="l40.275" class="difflineminus">-                    nsMapiEntry&amp; current = aFolders.mEntries [aFolders.mNbEntries ++] ;</span>
<a href="#l40.276"></a><span id="l40.276" class="difflineminus">-                    SPropValue&amp; currentValue = rowSet-&gt;aRow-&gt;lpProps [0] ;</span>
<a href="#l40.277"></a><span id="l40.277" class="difflineminus">-                    </span>
<a href="#l40.278"></a><span id="l40.278" class="difflineplus">+                    nsMapiEntry&amp; current = aFolders.mEntries[aFolders.mNbEntries++] ;</span>
<a href="#l40.279"></a><span id="l40.279" class="difflineplus">+                    SPropValue&amp; currentValue = rowSet-&gt;aRow-&gt;lpProps[0] ;</span>
<a href="#l40.280"></a><span id="l40.280" class="difflineplus">+</span>
<a href="#l40.281"></a><span id="l40.281">                     current.Assign(currentValue.Value.bin.cb,</span>
<a href="#l40.282"></a><span id="l40.282">                                    reinterpret_cast&lt;LPENTRYID&gt;(currentValue.Value.bin.lpb)) ;</span>
<a href="#l40.283"></a><span id="l40.283">                 }</span>
<a href="#l40.284"></a><span id="l40.284">                 MyFreeProws(rowSet) ;</span>
<a href="#l40.285"></a><span id="l40.285">             }</span>
<a href="#l40.286"></a><span id="l40.286">             else {</span>
<a href="#l40.287"></a><span id="l40.287">                 PRINTF((&quot;Cannot query rows %08x.\n&quot;, mLastError)) ;</span>
<a href="#l40.288"></a><span id="l40.288">             }</span>
<a href="#l40.289"></a><span id="l40.289" class="difflineat">@@ -322,31 +322,31 @@ BOOL nsAbWinHelper::GetFolders(nsMapiEnt</span>
<a href="#l40.290"></a><span id="l40.290"> }</span>
<a href="#l40.291"></a><span id="l40.291"> </span>
<a href="#l40.292"></a><span id="l40.292"> BOOL nsAbWinHelper::GetCards(const nsMapiEntry&amp; aParent, LPSRestriction aRestriction,</span>
<a href="#l40.293"></a><span id="l40.293">                              nsMapiEntryArray&amp; aCards)</span>
<a href="#l40.294"></a><span id="l40.294"> {</span>
<a href="#l40.295"></a><span id="l40.295">     aCards.CleanUp() ;</span>
<a href="#l40.296"></a><span id="l40.296">     return GetContents(aParent, aRestriction, &amp;aCards.mEntries, aCards.mNbEntries, 0) ;</span>
<a href="#l40.297"></a><span id="l40.297"> }</span>
<a href="#l40.298"></a><span id="l40.298" class="difflineminus">- </span>
<a href="#l40.299"></a><span id="l40.299" class="difflineplus">+</span>
<a href="#l40.300"></a><span id="l40.300"> BOOL nsAbWinHelper::GetNodes(const nsMapiEntry&amp; aParent, nsMapiEntryArray&amp; aNodes)</span>
<a href="#l40.301"></a><span id="l40.301" class="difflineminus">-{ </span>
<a href="#l40.302"></a><span id="l40.302" class="difflineplus">+{</span>
<a href="#l40.303"></a><span id="l40.303">     aNodes.CleanUp() ;</span>
<a href="#l40.304"></a><span id="l40.304">     return GetContents(aParent, NULL, &amp;aNodes.mEntries, aNodes.mNbEntries, MAPI_DISTLIST) ;</span>
<a href="#l40.305"></a><span id="l40.305"> }</span>
<a href="#l40.306"></a><span id="l40.306"> </span>
<a href="#l40.307"></a><span id="l40.307" class="difflineminus">-BOOL nsAbWinHelper::GetCardsCount(const nsMapiEntry&amp; aParent, ULONG&amp; aNbCards) </span>
<a href="#l40.308"></a><span id="l40.308" class="difflineplus">+BOOL nsAbWinHelper::GetCardsCount(const nsMapiEntry&amp; aParent, ULONG&amp; aNbCards)</span>
<a href="#l40.309"></a><span id="l40.309"> {</span>
<a href="#l40.310"></a><span id="l40.310">     aNbCards = 0 ;</span>
<a href="#l40.311"></a><span id="l40.311">     return GetContents(aParent, NULL, NULL, aNbCards, 0) ;</span>
<a href="#l40.312"></a><span id="l40.312"> }</span>
<a href="#l40.313"></a><span id="l40.313"> </span>
<a href="#l40.314"></a><span id="l40.314"> BOOL nsAbWinHelper::GetPropertyString(const nsMapiEntry&amp; aObject,</span>
<a href="#l40.315"></a><span id="l40.315" class="difflineminus">-                                      ULONG aPropertyTag, </span>
<a href="#l40.316"></a><span id="l40.316" class="difflineplus">+                                      ULONG aPropertyTag,</span>
<a href="#l40.317"></a><span id="l40.317">                                       nsCString&amp; aName)</span>
<a href="#l40.318"></a><span id="l40.318"> {</span>
<a href="#l40.319"></a><span id="l40.319">     aName.Truncate() ;</span>
<a href="#l40.320"></a><span id="l40.320">     LPSPropValue values = NULL ;</span>
<a href="#l40.321"></a><span id="l40.321">     ULONG valueCount = 0 ;</span>
<a href="#l40.322"></a><span id="l40.322"> </span>
<a href="#l40.323"></a><span id="l40.323">     if (!GetMAPIProperties(aObject, &amp;aPropertyTag, 1, values, valueCount)) { return FALSE ; }</span>
<a href="#l40.324"></a><span id="l40.324">     if (valueCount == 1 &amp;&amp; values != NULL) {</span>
<a href="#l40.325"></a><span id="l40.325" class="difflineat">@@ -384,35 +384,35 @@ BOOL nsAbWinHelper::GetPropertiesUString</span>
<a href="#l40.326"></a><span id="l40.326">   ULONG valueCount = 0;</span>
<a href="#l40.327"></a><span id="l40.327"> </span>
<a href="#l40.328"></a><span id="l40.328">   if (!GetMAPIProperties(aObject, aPropertyTags, aNbProperties, values,</span>
<a href="#l40.329"></a><span id="l40.329">                          valueCount))</span>
<a href="#l40.330"></a><span id="l40.330">     return FALSE;</span>
<a href="#l40.331"></a><span id="l40.331"> </span>
<a href="#l40.332"></a><span id="l40.332">   if (valueCount == aNbProperties &amp;&amp; values != NULL)</span>
<a href="#l40.333"></a><span id="l40.333">   {</span>
<a href="#l40.334"></a><span id="l40.334" class="difflineminus">-    for (ULONG i = 0 ; i &lt; valueCount ; ++ i)</span>
<a href="#l40.335"></a><span id="l40.335" class="difflineplus">+    for (ULONG i = 0 ; i &lt; valueCount ; ++i)</span>
<a href="#l40.336"></a><span id="l40.336">     {</span>
<a href="#l40.337"></a><span id="l40.337">       if (PROP_ID(values[i].ulPropTag) == PROP_ID(aPropertyTags[i]))</span>
<a href="#l40.338"></a><span id="l40.338">       {</span>
<a href="#l40.339"></a><span id="l40.339">         if (PROP_TYPE(values[i].ulPropTag) == PT_STRING8)</span>
<a href="#l40.340"></a><span id="l40.340">           aNames[i].AssignASCII(values[i].Value.lpszA);</span>
<a href="#l40.341"></a><span id="l40.341">         else if (PROP_TYPE(values[i].ulPropTag) == PT_UNICODE)</span>
<a href="#l40.342"></a><span id="l40.342">           aNames[i] = values[i].Value.lpszW;</span>
<a href="#l40.343"></a><span id="l40.343">       }</span>
<a href="#l40.344"></a><span id="l40.344">     }</span>
<a href="#l40.345"></a><span id="l40.345">     FreeBuffer(values);</span>
<a href="#l40.346"></a><span id="l40.346">   }</span>
<a href="#l40.347"></a><span id="l40.347">   return TRUE;</span>
<a href="#l40.348"></a><span id="l40.348"> }</span>
<a href="#l40.349"></a><span id="l40.349"> </span>
<a href="#l40.350"></a><span id="l40.350" class="difflineminus">-BOOL nsAbWinHelper::GetPropertyDate(const nsMapiEntry&amp; aObject, ULONG aPropertyTag, </span>
<a href="#l40.351"></a><span id="l40.351" class="difflineplus">+BOOL nsAbWinHelper::GetPropertyDate(const nsMapiEntry&amp; aObject, ULONG aPropertyTag,</span>
<a href="#l40.352"></a><span id="l40.352">                                     WORD&amp; aYear, WORD&amp; aMonth, WORD&amp; aDay)</span>
<a href="#l40.353"></a><span id="l40.353"> {</span>
<a href="#l40.354"></a><span id="l40.354" class="difflineminus">-    aYear = 0 ; </span>
<a href="#l40.355"></a><span id="l40.355" class="difflineplus">+    aYear = 0 ;</span>
<a href="#l40.356"></a><span id="l40.356">     aMonth = 0 ;</span>
<a href="#l40.357"></a><span id="l40.357">     aDay = 0 ;</span>
<a href="#l40.358"></a><span id="l40.358">     LPSPropValue values = NULL ;</span>
<a href="#l40.359"></a><span id="l40.359">     ULONG valueCount = 0 ;</span>
<a href="#l40.360"></a><span id="l40.360"> </span>
<a href="#l40.361"></a><span id="l40.361">     if (!GetMAPIProperties(aObject, &amp;aPropertyTag, 1, values, valueCount)) { return FALSE ; }</span>
<a href="#l40.362"></a><span id="l40.362">     if (valueCount == 1 &amp;&amp; values != NULL &amp;&amp; PROP_TYPE(values-&gt;ulPropTag) == PT_SYSTIME) {</span>
<a href="#l40.363"></a><span id="l40.363">         SYSTEMTIME readableTime ;</span>
<a href="#l40.364"></a><span id="l40.364" class="difflineat">@@ -422,59 +422,59 @@ BOOL nsAbWinHelper::GetPropertyDate(cons</span>
<a href="#l40.365"></a><span id="l40.365">             aMonth = readableTime.wMonth ;</span>
<a href="#l40.366"></a><span id="l40.366">             aDay = readableTime.wDay ;</span>
<a href="#l40.367"></a><span id="l40.367">         }</span>
<a href="#l40.368"></a><span id="l40.368">     }</span>
<a href="#l40.369"></a><span id="l40.369">     FreeBuffer(values) ;</span>
<a href="#l40.370"></a><span id="l40.370">     return TRUE ;</span>
<a href="#l40.371"></a><span id="l40.371"> }</span>
<a href="#l40.372"></a><span id="l40.372"> </span>
<a href="#l40.373"></a><span id="l40.373" class="difflineminus">-BOOL nsAbWinHelper::GetPropertyLong(const nsMapiEntry&amp; aObject, </span>
<a href="#l40.374"></a><span id="l40.374" class="difflineminus">-                                    ULONG aPropertyTag, </span>
<a href="#l40.375"></a><span id="l40.375" class="difflineplus">+BOOL nsAbWinHelper::GetPropertyLong(const nsMapiEntry&amp; aObject,</span>
<a href="#l40.376"></a><span id="l40.376" class="difflineplus">+                                    ULONG aPropertyTag,</span>
<a href="#l40.377"></a><span id="l40.377">                                     ULONG&amp; aValue)</span>
<a href="#l40.378"></a><span id="l40.378"> {</span>
<a href="#l40.379"></a><span id="l40.379">     aValue = 0 ;</span>
<a href="#l40.380"></a><span id="l40.380">     LPSPropValue values = NULL ;</span>
<a href="#l40.381"></a><span id="l40.381">     ULONG valueCount = 0 ;</span>
<a href="#l40.382"></a><span id="l40.382"> </span>
<a href="#l40.383"></a><span id="l40.383">     if (!GetMAPIProperties(aObject, &amp;aPropertyTag, 1, values, valueCount)) { return FALSE ; }</span>
<a href="#l40.384"></a><span id="l40.384">     if (valueCount == 1 &amp;&amp; values != NULL &amp;&amp; PROP_TYPE(values-&gt;ulPropTag) == PT_LONG) {</span>
<a href="#l40.385"></a><span id="l40.385">         aValue = values-&gt;Value.ul ;</span>
<a href="#l40.386"></a><span id="l40.386">     }</span>
<a href="#l40.387"></a><span id="l40.387">     FreeBuffer(values) ;</span>
<a href="#l40.388"></a><span id="l40.388">     return TRUE ;</span>
<a href="#l40.389"></a><span id="l40.389"> }</span>
<a href="#l40.390"></a><span id="l40.390"> </span>
<a href="#l40.391"></a><span id="l40.391" class="difflineminus">-BOOL nsAbWinHelper::GetPropertyBin(const nsMapiEntry&amp; aObject, ULONG aPropertyTag, </span>
<a href="#l40.392"></a><span id="l40.392" class="difflineplus">+BOOL nsAbWinHelper::GetPropertyBin(const nsMapiEntry&amp; aObject, ULONG aPropertyTag,</span>
<a href="#l40.393"></a><span id="l40.393">                                    nsMapiEntry&amp; aValue)</span>
<a href="#l40.394"></a><span id="l40.394"> {</span>
<a href="#l40.395"></a><span id="l40.395">     aValue.Assign(0, NULL) ;</span>
<a href="#l40.396"></a><span id="l40.396">     LPSPropValue values = NULL ;</span>
<a href="#l40.397"></a><span id="l40.397">     ULONG valueCount = 0 ;</span>
<a href="#l40.398"></a><span id="l40.398"> </span>
<a href="#l40.399"></a><span id="l40.399">     if (!GetMAPIProperties(aObject, &amp;aPropertyTag, 1, values, valueCount)) { return FALSE ; }</span>
<a href="#l40.400"></a><span id="l40.400">     if (valueCount == 1 &amp;&amp; values != NULL &amp;&amp; PROP_TYPE(values-&gt;ulPropTag) == PT_BINARY) {</span>
<a href="#l40.401"></a><span id="l40.401" class="difflineminus">-        aValue.Assign(values-&gt;Value.bin.cb, </span>
<a href="#l40.402"></a><span id="l40.402" class="difflineplus">+        aValue.Assign(values-&gt;Value.bin.cb,</span>
<a href="#l40.403"></a><span id="l40.403">                       reinterpret_cast&lt;LPENTRYID&gt;(values-&gt;Value.bin.lpb)) ;</span>
<a href="#l40.404"></a><span id="l40.404">     }</span>
<a href="#l40.405"></a><span id="l40.405">     FreeBuffer(values) ;</span>
<a href="#l40.406"></a><span id="l40.406">     return TRUE ;</span>
<a href="#l40.407"></a><span id="l40.407"> }</span>
<a href="#l40.408"></a><span id="l40.408"> </span>
<a href="#l40.409"></a><span id="l40.409"> // This function, supposedly indicating whether a particular entry was</span>
<a href="#l40.410"></a><span id="l40.410"> // in a particular container, doesn't seem to work very well (has</span>
<a href="#l40.411"></a><span id="l40.411"> // a tendency to return TRUE even if we're talking to different containers...).</span>
<a href="#l40.412"></a><span id="l40.412"> BOOL nsAbWinHelper::TestOpenEntry(const nsMapiEntry&amp; aContainer, const nsMapiEntry&amp; aEntry)</span>
<a href="#l40.413"></a><span id="l40.413"> {</span>
<a href="#l40.414"></a><span id="l40.414">     nsMapiInterfaceWrapper&lt;LPMAPICONTAINER&gt; container ;</span>
<a href="#l40.415"></a><span id="l40.415">     nsMapiInterfaceWrapper&lt;LPMAPIPROP&gt; subObject ;</span>
<a href="#l40.416"></a><span id="l40.416">     ULONG objType = 0 ;</span>
<a href="#l40.417"></a><span id="l40.417" class="difflineminus">-    </span>
<a href="#l40.418"></a><span id="l40.418" class="difflineplus">+</span>
<a href="#l40.419"></a><span id="l40.419">     mLastError = mAddressBook-&gt;OpenEntry(aContainer.mByteCount, aContainer.mEntryId,</span>
<a href="#l40.420"></a><span id="l40.420" class="difflineminus">-                                         &amp;IID_IMAPIContainer, 0, &amp;objType, </span>
<a href="#l40.421"></a><span id="l40.421" class="difflineplus">+                                         &amp;IID_IMAPIContainer, 0, &amp;objType,</span>
<a href="#l40.422"></a><span id="l40.422">                                          container) ;</span>
<a href="#l40.423"></a><span id="l40.423">     if (HR_FAILED(mLastError)) {</span>
<a href="#l40.424"></a><span id="l40.424">         PRINTF((&quot;Cannot open container %08x.\n&quot;, mLastError)) ;</span>
<a href="#l40.425"></a><span id="l40.425">         return FALSE ;</span>
<a href="#l40.426"></a><span id="l40.426">     }</span>
<a href="#l40.427"></a><span id="l40.427">     mLastError = container-&gt;OpenEntry(aEntry.mByteCount, aEntry.mEntryId,</span>
<a href="#l40.428"></a><span id="l40.428">                                       NULL, 0, &amp;objType, subObject) ;</span>
<a href="#l40.429"></a><span id="l40.429">     return HR_SUCCEEDED(mLastError) ;</span>
<a href="#l40.430"></a><span id="l40.430" class="difflineat">@@ -483,17 +483,17 @@ BOOL nsAbWinHelper::TestOpenEntry(const </span>
<a href="#l40.431"></a><span id="l40.431"> BOOL nsAbWinHelper::DeleteEntry(const nsMapiEntry&amp; aContainer, const nsMapiEntry&amp; aEntry)</span>
<a href="#l40.432"></a><span id="l40.432"> {</span>
<a href="#l40.433"></a><span id="l40.433">     nsMapiInterfaceWrapper&lt;LPABCONT&gt; container ;</span>
<a href="#l40.434"></a><span id="l40.434">     ULONG objType = 0 ;</span>
<a href="#l40.435"></a><span id="l40.435">     SBinary entry ;</span>
<a href="#l40.436"></a><span id="l40.436">     SBinaryArray entryArray ;</span>
<a href="#l40.437"></a><span id="l40.437"> </span>
<a href="#l40.438"></a><span id="l40.438">     mLastError = mAddressBook-&gt;OpenEntry(aContainer.mByteCount, aContainer.mEntryId,</span>
<a href="#l40.439"></a><span id="l40.439" class="difflineminus">-                                         &amp;IID_IABContainer, MAPI_MODIFY, &amp;objType, </span>
<a href="#l40.440"></a><span id="l40.440" class="difflineplus">+                                         &amp;IID_IABContainer, MAPI_MODIFY, &amp;objType,</span>
<a href="#l40.441"></a><span id="l40.441">                                          container) ;</span>
<a href="#l40.442"></a><span id="l40.442">     if (HR_FAILED(mLastError)) {</span>
<a href="#l40.443"></a><span id="l40.443">         PRINTF((&quot;Cannot open container %08x.\n&quot;, mLastError)) ;</span>
<a href="#l40.444"></a><span id="l40.444">         return FALSE ;</span>
<a href="#l40.445"></a><span id="l40.445">     }</span>
<a href="#l40.446"></a><span id="l40.446">     entry.cb = aEntry.mByteCount ;</span>
<a href="#l40.447"></a><span id="l40.447">     entry.lpb = reinterpret_cast&lt;LPBYTE&gt;(aEntry.mEntryId) ;</span>
<a href="#l40.448"></a><span id="l40.448">     entryArray.cValues = 1 ;</span>
<a href="#l40.449"></a><span id="l40.449" class="difflineat">@@ -501,17 +501,17 @@ BOOL nsAbWinHelper::DeleteEntry(const ns</span>
<a href="#l40.450"></a><span id="l40.450">     mLastError = container-&gt;DeleteEntries(&amp;entryArray, 0) ;</span>
<a href="#l40.451"></a><span id="l40.451">     if (HR_FAILED(mLastError)) {</span>
<a href="#l40.452"></a><span id="l40.452">         PRINTF((&quot;Cannot delete entry %08x.\n&quot;, mLastError)) ;</span>
<a href="#l40.453"></a><span id="l40.453">         return FALSE ;</span>
<a href="#l40.454"></a><span id="l40.454">     }</span>
<a href="#l40.455"></a><span id="l40.455">     return TRUE ;</span>
<a href="#l40.456"></a><span id="l40.456"> }</span>
<a href="#l40.457"></a><span id="l40.457"> </span>
<a href="#l40.458"></a><span id="l40.458" class="difflineminus">-BOOL nsAbWinHelper::SetPropertyUString(const nsMapiEntry&amp; aObject, ULONG aPropertyTag, </span>
<a href="#l40.459"></a><span id="l40.459" class="difflineplus">+BOOL nsAbWinHelper::SetPropertyUString(const nsMapiEntry&amp; aObject, ULONG aPropertyTag,</span>
<a href="#l40.460"></a><span id="l40.460">                                        const char16_t *aValue)</span>
<a href="#l40.461"></a><span id="l40.461"> {</span>
<a href="#l40.462"></a><span id="l40.462">     SPropValue value ;</span>
<a href="#l40.463"></a><span id="l40.463">     nsAutoCString alternativeValue ;</span>
<a href="#l40.464"></a><span id="l40.464"> </span>
<a href="#l40.465"></a><span id="l40.465">     value.ulPropTag = aPropertyTag ;</span>
<a href="#l40.466"></a><span id="l40.466">     if (PROP_TYPE(aPropertyTag) == PT_UNICODE) {</span>
<a href="#l40.467"></a><span id="l40.467">         value.Value.lpszW = reinterpret_cast&lt;wchar_t*&gt;(const_cast&lt;char16_t *&gt;(aValue));</span>
<a href="#l40.468"></a><span id="l40.468" class="difflineat">@@ -523,59 +523,59 @@ BOOL nsAbWinHelper::SetPropertyUString(c</span>
<a href="#l40.469"></a><span id="l40.469">     else {</span>
<a href="#l40.470"></a><span id="l40.470">         PRINTF((&quot;Property %08x is not a string.\n&quot;, aPropertyTag)) ;</span>
<a href="#l40.471"></a><span id="l40.471">         return TRUE ;</span>
<a href="#l40.472"></a><span id="l40.472">     }</span>
<a href="#l40.473"></a><span id="l40.473">     return SetMAPIProperties(aObject, 1, &amp;value) ;</span>
<a href="#l40.474"></a><span id="l40.474"> }</span>
<a href="#l40.475"></a><span id="l40.475"> </span>
<a href="#l40.476"></a><span id="l40.476"> BOOL nsAbWinHelper::SetPropertiesUString(const nsMapiEntry&amp; aObject, const ULONG *aPropertiesTag,</span>
<a href="#l40.477"></a><span id="l40.477" class="difflineminus">-                                         ULONG aNbProperties, nsString *aValues) </span>
<a href="#l40.478"></a><span id="l40.478" class="difflineplus">+                                         ULONG aNbProperties, nsString *aValues)</span>
<a href="#l40.479"></a><span id="l40.479"> {</span>
<a href="#l40.480"></a><span id="l40.480" class="difflineminus">-    LPSPropValue values = new SPropValue [aNbProperties] ;</span>
<a href="#l40.481"></a><span id="l40.481" class="difflineplus">+    LPSPropValue values = new SPropValue[aNbProperties] ;</span>
<a href="#l40.482"></a><span id="l40.482">     if (!values)</span>
<a href="#l40.483"></a><span id="l40.483">         return FALSE ;</span>
<a href="#l40.484"></a><span id="l40.484"> </span>
<a href="#l40.485"></a><span id="l40.485">     ULONG i = 0 ;</span>
<a href="#l40.486"></a><span id="l40.486">     ULONG currentValue = 0 ;</span>
<a href="#l40.487"></a><span id="l40.487">     nsAutoCString alternativeValue ;</span>
<a href="#l40.488"></a><span id="l40.488">     BOOL retCode = TRUE ;</span>
<a href="#l40.489"></a><span id="l40.489"> </span>
<a href="#l40.490"></a><span id="l40.490" class="difflineminus">-    for (i = 0 ; i &lt; aNbProperties ; ++ i) {</span>
<a href="#l40.491"></a><span id="l40.491" class="difflineminus">-        values [currentValue].ulPropTag = aPropertiesTag [i] ;</span>
<a href="#l40.492"></a><span id="l40.492" class="difflineminus">-        if (PROP_TYPE(aPropertiesTag [i]) == PT_UNICODE) {</span>
<a href="#l40.493"></a><span id="l40.493" class="difflineminus">-            const wchar_t *value = aValues [i].get() ;</span>
<a href="#l40.494"></a><span id="l40.494" class="difflineminus">-            values [currentValue ++].Value.lpszW = const_cast&lt;wchar_t *&gt;(value) ;</span>
<a href="#l40.495"></a><span id="l40.495" class="difflineplus">+    for (i = 0 ; i &lt; aNbProperties ; ++i) {</span>
<a href="#l40.496"></a><span id="l40.496" class="difflineplus">+        values[currentValue].ulPropTag = aPropertiesTag[i] ;</span>
<a href="#l40.497"></a><span id="l40.497" class="difflineplus">+        if (PROP_TYPE(aPropertiesTag[i]) == PT_UNICODE) {</span>
<a href="#l40.498"></a><span id="l40.498" class="difflineplus">+            const wchar_t *value = aValues[i].get() ;</span>
<a href="#l40.499"></a><span id="l40.499" class="difflineplus">+            values[currentValue++].Value.lpszW = const_cast&lt;wchar_t *&gt;(value) ;</span>
<a href="#l40.500"></a><span id="l40.500">         }</span>
<a href="#l40.501"></a><span id="l40.501" class="difflineminus">-        else if (PROP_TYPE(aPropertiesTag [i]) == PT_STRING8) {</span>
<a href="#l40.502"></a><span id="l40.502" class="difflineminus">-            LossyCopyUTF16toASCII(aValues [i], alternativeValue);</span>
<a href="#l40.503"></a><span id="l40.503" class="difflineplus">+        else if (PROP_TYPE(aPropertiesTag[i]) == PT_STRING8) {</span>
<a href="#l40.504"></a><span id="l40.504" class="difflineplus">+            LossyCopyUTF16toASCII(aValues[i], alternativeValue);</span>
<a href="#l40.505"></a><span id="l40.505">             char *av = strdup(alternativeValue.get()) ;</span>
<a href="#l40.506"></a><span id="l40.506">             if (!av) {</span>
<a href="#l40.507"></a><span id="l40.507">                 retCode = FALSE ;</span>
<a href="#l40.508"></a><span id="l40.508">                 break ;</span>
<a href="#l40.509"></a><span id="l40.509">             }</span>
<a href="#l40.510"></a><span id="l40.510" class="difflineminus">-            values [currentValue ++].Value.lpszA = av ;</span>
<a href="#l40.511"></a><span id="l40.511" class="difflineplus">+            values[currentValue++].Value.lpszA = av ;</span>
<a href="#l40.512"></a><span id="l40.512">         }</span>
<a href="#l40.513"></a><span id="l40.513">     }</span>
<a href="#l40.514"></a><span id="l40.514">     if (retCode)</span>
<a href="#l40.515"></a><span id="l40.515">         retCode = SetMAPIProperties(aObject, currentValue, values) ;</span>
<a href="#l40.516"></a><span id="l40.516" class="difflineminus">-    for (i = 0 ; i &lt; currentValue ; ++ i) {</span>
<a href="#l40.517"></a><span id="l40.517" class="difflineminus">-        if (PROP_TYPE(aPropertiesTag [i]) == PT_STRING8) {</span>
<a href="#l40.518"></a><span id="l40.518" class="difflineminus">-            free(values [i].Value.lpszA) ;</span>
<a href="#l40.519"></a><span id="l40.519" class="difflineplus">+    for (i = 0 ; i &lt; currentValue ; ++i) {</span>
<a href="#l40.520"></a><span id="l40.520" class="difflineplus">+        if (PROP_TYPE(aPropertiesTag[i]) == PT_STRING8) {</span>
<a href="#l40.521"></a><span id="l40.521" class="difflineplus">+            free(values[i].Value.lpszA) ;</span>
<a href="#l40.522"></a><span id="l40.522">         }</span>
<a href="#l40.523"></a><span id="l40.523">     }</span>
<a href="#l40.524"></a><span id="l40.524">     delete [] values ;</span>
<a href="#l40.525"></a><span id="l40.525">     return retCode ;</span>
<a href="#l40.526"></a><span id="l40.526"> }</span>
<a href="#l40.527"></a><span id="l40.527"> </span>
<a href="#l40.528"></a><span id="l40.528" class="difflineminus">-BOOL nsAbWinHelper::SetPropertyDate(const nsMapiEntry&amp; aObject, ULONG aPropertyTag, </span>
<a href="#l40.529"></a><span id="l40.529" class="difflineplus">+BOOL nsAbWinHelper::SetPropertyDate(const nsMapiEntry&amp; aObject, ULONG aPropertyTag,</span>
<a href="#l40.530"></a><span id="l40.530">                                     WORD aYear, WORD aMonth, WORD aDay)</span>
<a href="#l40.531"></a><span id="l40.531"> {</span>
<a href="#l40.532"></a><span id="l40.532">     SPropValue value ;</span>
<a href="#l40.533"></a><span id="l40.533" class="difflineminus">-    </span>
<a href="#l40.534"></a><span id="l40.534" class="difflineplus">+</span>
<a href="#l40.535"></a><span id="l40.535">     value.ulPropTag = aPropertyTag ;</span>
<a href="#l40.536"></a><span id="l40.536">     if (PROP_TYPE(aPropertyTag) == PT_SYSTIME) {</span>
<a href="#l40.537"></a><span id="l40.537">         SYSTEMTIME readableTime ;</span>
<a href="#l40.538"></a><span id="l40.538"> </span>
<a href="#l40.539"></a><span id="l40.539">         readableTime.wYear = aYear ;</span>
<a href="#l40.540"></a><span id="l40.540">         readableTime.wMonth = aMonth ;</span>
<a href="#l40.541"></a><span id="l40.541">         readableTime.wDay = aDay ;</span>
<a href="#l40.542"></a><span id="l40.542">         readableTime.wDayOfWeek = 0 ;</span>
<a href="#l40.543"></a><span id="l40.543" class="difflineat">@@ -594,62 +594,62 @@ BOOL nsAbWinHelper::SetPropertyDate(cons</span>
<a href="#l40.544"></a><span id="l40.544"> BOOL nsAbWinHelper::CreateEntry(const nsMapiEntry&amp; aParent, nsMapiEntry&amp; aNewEntry)</span>
<a href="#l40.545"></a><span id="l40.545"> {</span>
<a href="#l40.546"></a><span id="l40.546">     nsMapiInterfaceWrapper&lt;LPABCONT&gt; container ;</span>
<a href="#l40.547"></a><span id="l40.547">     ULONG objType = 0 ;</span>
<a href="#l40.548"></a><span id="l40.548"> </span>
<a href="#l40.549"></a><span id="l40.549">     mLastError = mAddressBook-&gt;OpenEntry(aParent.mByteCount, aParent.mEntryId,</span>
<a href="#l40.550"></a><span id="l40.550">                                          &amp;IID_IABContainer, MAPI_MODIFY, &amp;objType,</span>
<a href="#l40.551"></a><span id="l40.551">                                          container) ;</span>
<a href="#l40.552"></a><span id="l40.552" class="difflineminus">-    if (HR_FAILED(mLastError)) { </span>
<a href="#l40.553"></a><span id="l40.553" class="difflineplus">+    if (HR_FAILED(mLastError)) {</span>
<a href="#l40.554"></a><span id="l40.554">         PRINTF((&quot;Cannot open container %08x.\n&quot;, mLastError)) ;</span>
<a href="#l40.555"></a><span id="l40.555">         return FALSE ;</span>
<a href="#l40.556"></a><span id="l40.556">     }</span>
<a href="#l40.557"></a><span id="l40.557">     SPropTagArray property ;</span>
<a href="#l40.558"></a><span id="l40.558">     LPSPropValue value = NULL ;</span>
<a href="#l40.559"></a><span id="l40.559">     ULONG valueCount = 0 ;</span>
<a href="#l40.560"></a><span id="l40.560"> </span>
<a href="#l40.561"></a><span id="l40.561">     property.cValues = 1 ;</span>
<a href="#l40.562"></a><span id="l40.562" class="difflineminus">-    property.aulPropTag [0] = PR_DEF_CREATE_MAILUSER ;</span>
<a href="#l40.563"></a><span id="l40.563" class="difflineplus">+    property.aulPropTag[0] = PR_DEF_CREATE_MAILUSER ;</span>
<a href="#l40.564"></a><span id="l40.564">     mLastError = container-&gt;GetProps(&amp;property, 0, &amp;valueCount, &amp;value) ;</span>
<a href="#l40.565"></a><span id="l40.565">     if (HR_FAILED(mLastError) || valueCount != 1) {</span>
<a href="#l40.566"></a><span id="l40.566">         PRINTF((&quot;Cannot obtain template %08x.\n&quot;, mLastError)) ;</span>
<a href="#l40.567"></a><span id="l40.567">         return FALSE ;</span>
<a href="#l40.568"></a><span id="l40.568">     }</span>
<a href="#l40.569"></a><span id="l40.569">     nsMapiInterfaceWrapper&lt;LPMAPIPROP&gt; newEntry ;</span>
<a href="#l40.570"></a><span id="l40.570"> </span>
<a href="#l40.571"></a><span id="l40.571" class="difflineminus">-    mLastError = container-&gt;CreateEntry(value-&gt;Value.bin.cb, </span>
<a href="#l40.572"></a><span id="l40.572" class="difflineplus">+    mLastError = container-&gt;CreateEntry(value-&gt;Value.bin.cb,</span>
<a href="#l40.573"></a><span id="l40.573">                                         reinterpret_cast&lt;LPENTRYID&gt;(value-&gt;Value.bin.lpb),</span>
<a href="#l40.574"></a><span id="l40.574">                                         CREATE_CHECK_DUP_LOOSE,</span>
<a href="#l40.575"></a><span id="l40.575">                                         newEntry) ;</span>
<a href="#l40.576"></a><span id="l40.576">     FreeBuffer(value) ;</span>
<a href="#l40.577"></a><span id="l40.577">     if (HR_FAILED(mLastError)) {</span>
<a href="#l40.578"></a><span id="l40.578">         PRINTF((&quot;Cannot create new entry %08x.\n&quot;, mLastError)) ;</span>
<a href="#l40.579"></a><span id="l40.579">         return FALSE ;</span>
<a href="#l40.580"></a><span id="l40.580">     }</span>
<a href="#l40.581"></a><span id="l40.581">     SPropValue displayName ;</span>
<a href="#l40.582"></a><span id="l40.582">     LPSPropProblemArray problems = NULL ;</span>
<a href="#l40.583"></a><span id="l40.583">     nsAutoString tempName ;</span>
<a href="#l40.584"></a><span id="l40.584"> </span>
<a href="#l40.585"></a><span id="l40.585">     displayName.ulPropTag = PR_DISPLAY_NAME_W ;</span>
<a href="#l40.586"></a><span id="l40.586">     tempName.AssignLiteral(&quot;__MailUser__&quot;) ;</span>
<a href="#l40.587"></a><span id="l40.587" class="difflineminus">-    tempName.AppendInt(mEntryCounter ++) ;</span>
<a href="#l40.588"></a><span id="l40.588" class="difflineplus">+    tempName.AppendInt(mEntryCounter++) ;</span>
<a href="#l40.589"></a><span id="l40.589">     const wchar_t *tempNameValue = tempName.get();</span>
<a href="#l40.590"></a><span id="l40.590">     displayName.Value.lpszW = const_cast&lt;wchar_t *&gt;(tempNameValue) ;</span>
<a href="#l40.591"></a><span id="l40.591">     mLastError = newEntry-&gt;SetProps(1, &amp;displayName, &amp;problems) ;</span>
<a href="#l40.592"></a><span id="l40.592">     if (HR_FAILED(mLastError)) {</span>
<a href="#l40.593"></a><span id="l40.593">         PRINTF((&quot;Cannot set temporary name %08x.\n&quot;, mLastError)) ;</span>
<a href="#l40.594"></a><span id="l40.594">         return FALSE ;</span>
<a href="#l40.595"></a><span id="l40.595">     }</span>
<a href="#l40.596"></a><span id="l40.596">     mLastError = newEntry-&gt;SaveChanges(KEEP_OPEN_READONLY) ;</span>
<a href="#l40.597"></a><span id="l40.597">     if (HR_FAILED(mLastError)) {</span>
<a href="#l40.598"></a><span id="l40.598">         PRINTF((&quot;Cannot commit new entry %08x.\n&quot;, mLastError)) ;</span>
<a href="#l40.599"></a><span id="l40.599">         return FALSE ;</span>
<a href="#l40.600"></a><span id="l40.600">     }</span>
<a href="#l40.601"></a><span id="l40.601" class="difflineminus">-    property.aulPropTag [0] = PR_ENTRYID ;</span>
<a href="#l40.602"></a><span id="l40.602" class="difflineplus">+    property.aulPropTag[0] = PR_ENTRYID ;</span>
<a href="#l40.603"></a><span id="l40.603">     mLastError = newEntry-&gt;GetProps(&amp;property, 0, &amp;valueCount, &amp;value) ;</span>
<a href="#l40.604"></a><span id="l40.604">     if (HR_FAILED(mLastError) || valueCount != 1) {</span>
<a href="#l40.605"></a><span id="l40.605">         PRINTF((&quot;Cannot get entry id %08x.\n&quot;, mLastError)) ;</span>
<a href="#l40.606"></a><span id="l40.606">         return FALSE ;</span>
<a href="#l40.607"></a><span id="l40.607">     }</span>
<a href="#l40.608"></a><span id="l40.608">     aNewEntry.Assign(value-&gt;Value.bin.cb, reinterpret_cast&lt;LPENTRYID&gt;(value-&gt;Value.bin.lpb)) ;</span>
<a href="#l40.609"></a><span id="l40.609">     FreeBuffer(value) ;</span>
<a href="#l40.610"></a><span id="l40.610">     return TRUE ;</span>
<a href="#l40.611"></a><span id="l40.611" class="difflineat">@@ -667,74 +667,74 @@ BOOL nsAbWinHelper::CreateDistList(const</span>
<a href="#l40.612"></a><span id="l40.612">         PRINTF((&quot;Cannot open container %08x.\n&quot;, mLastError)) ;</span>
<a href="#l40.613"></a><span id="l40.613">         return FALSE ;</span>
<a href="#l40.614"></a><span id="l40.614">     }</span>
<a href="#l40.615"></a><span id="l40.615">     SPropTagArray property ;</span>
<a href="#l40.616"></a><span id="l40.616">     LPSPropValue value = NULL ;</span>
<a href="#l40.617"></a><span id="l40.617">     ULONG valueCount = 0 ;</span>
<a href="#l40.618"></a><span id="l40.618"> </span>
<a href="#l40.619"></a><span id="l40.619">     property.cValues = 1 ;</span>
<a href="#l40.620"></a><span id="l40.620" class="difflineminus">-    property.aulPropTag [0] = PR_DEF_CREATE_DL ;</span>
<a href="#l40.621"></a><span id="l40.621" class="difflineplus">+    property.aulPropTag[0] = PR_DEF_CREATE_DL ;</span>
<a href="#l40.622"></a><span id="l40.622">     mLastError = container-&gt;GetProps(&amp;property, 0, &amp;valueCount, &amp;value) ;</span>
<a href="#l40.623"></a><span id="l40.623">     if (HR_FAILED(mLastError) || valueCount != 1) {</span>
<a href="#l40.624"></a><span id="l40.624">         PRINTF((&quot;Cannot obtain template %08x.\n&quot;, mLastError)) ;</span>
<a href="#l40.625"></a><span id="l40.625">         return FALSE ;</span>
<a href="#l40.626"></a><span id="l40.626">     }</span>
<a href="#l40.627"></a><span id="l40.627">     nsMapiInterfaceWrapper&lt;LPMAPIPROP&gt; newEntry ;</span>
<a href="#l40.628"></a><span id="l40.628"> </span>
<a href="#l40.629"></a><span id="l40.629" class="difflineminus">-    mLastError = container-&gt;CreateEntry(value-&gt;Value.bin.cb, </span>
<a href="#l40.630"></a><span id="l40.630" class="difflineplus">+    mLastError = container-&gt;CreateEntry(value-&gt;Value.bin.cb,</span>
<a href="#l40.631"></a><span id="l40.631">                                         reinterpret_cast&lt;LPENTRYID&gt;(value-&gt;Value.bin.lpb),</span>
<a href="#l40.632"></a><span id="l40.632">                                         CREATE_CHECK_DUP_LOOSE,</span>
<a href="#l40.633"></a><span id="l40.633">                                         newEntry) ;</span>
<a href="#l40.634"></a><span id="l40.634">     FreeBuffer(value) ;</span>
<a href="#l40.635"></a><span id="l40.635">     if (HR_FAILED(mLastError)) {</span>
<a href="#l40.636"></a><span id="l40.636">         PRINTF((&quot;Cannot create new entry %08x.\n&quot;, mLastError)) ;</span>
<a href="#l40.637"></a><span id="l40.637">         return FALSE ;</span>
<a href="#l40.638"></a><span id="l40.638">     }</span>
<a href="#l40.639"></a><span id="l40.639">     SPropValue displayName ;</span>
<a href="#l40.640"></a><span id="l40.640">     LPSPropProblemArray problems = NULL ;</span>
<a href="#l40.641"></a><span id="l40.641">     nsAutoString tempName ;</span>
<a href="#l40.642"></a><span id="l40.642"> </span>
<a href="#l40.643"></a><span id="l40.643">     displayName.ulPropTag = PR_DISPLAY_NAME_W ;</span>
<a href="#l40.644"></a><span id="l40.644">     tempName.AssignLiteral(&quot;__MailList__&quot;) ;</span>
<a href="#l40.645"></a><span id="l40.645" class="difflineminus">-    tempName.AppendInt(mEntryCounter ++) ;</span>
<a href="#l40.646"></a><span id="l40.646" class="difflineplus">+    tempName.AppendInt(mEntryCounter++) ;</span>
<a href="#l40.647"></a><span id="l40.647">     const wchar_t *tempNameValue = tempName.get() ;</span>
<a href="#l40.648"></a><span id="l40.648">     displayName.Value.lpszW = const_cast&lt;wchar_t *&gt;(tempNameValue) ;</span>
<a href="#l40.649"></a><span id="l40.649">     mLastError = newEntry-&gt;SetProps(1, &amp;displayName, &amp;problems) ;</span>
<a href="#l40.650"></a><span id="l40.650">     if (HR_FAILED(mLastError)) {</span>
<a href="#l40.651"></a><span id="l40.651">         PRINTF((&quot;Cannot set temporary name %08x.\n&quot;, mLastError)) ;</span>
<a href="#l40.652"></a><span id="l40.652">         return FALSE ;</span>
<a href="#l40.653"></a><span id="l40.653">     }</span>
<a href="#l40.654"></a><span id="l40.654">     mLastError = newEntry-&gt;SaveChanges(KEEP_OPEN_READONLY) ;</span>
<a href="#l40.655"></a><span id="l40.655">     if (HR_FAILED(mLastError)) {</span>
<a href="#l40.656"></a><span id="l40.656">         PRINTF((&quot;Cannot commit new entry %08x.\n&quot;, mLastError)) ;</span>
<a href="#l40.657"></a><span id="l40.657">         return FALSE ;</span>
<a href="#l40.658"></a><span id="l40.658">     }</span>
<a href="#l40.659"></a><span id="l40.659" class="difflineminus">-    property.aulPropTag [0] = PR_ENTRYID ;</span>
<a href="#l40.660"></a><span id="l40.660" class="difflineplus">+    property.aulPropTag[0] = PR_ENTRYID ;</span>
<a href="#l40.661"></a><span id="l40.661">     mLastError = newEntry-&gt;GetProps(&amp;property, 0, &amp;valueCount, &amp;value) ;</span>
<a href="#l40.662"></a><span id="l40.662">     if (HR_FAILED(mLastError) || valueCount != 1) {</span>
<a href="#l40.663"></a><span id="l40.663">         PRINTF((&quot;Cannot get entry id %08x.\n&quot;, mLastError)) ;</span>
<a href="#l40.664"></a><span id="l40.664">         return FALSE ;</span>
<a href="#l40.665"></a><span id="l40.665">     }</span>
<a href="#l40.666"></a><span id="l40.666" class="difflineminus">-    aNewEntry.Assign(value-&gt;Value.bin.cb, </span>
<a href="#l40.667"></a><span id="l40.667" class="difflineplus">+    aNewEntry.Assign(value-&gt;Value.bin.cb,</span>
<a href="#l40.668"></a><span id="l40.668">                      reinterpret_cast&lt;LPENTRYID&gt;(value-&gt;Value.bin.lpb)) ;</span>
<a href="#l40.669"></a><span id="l40.669">     FreeBuffer(value) ;</span>
<a href="#l40.670"></a><span id="l40.670">     return TRUE ;</span>
<a href="#l40.671"></a><span id="l40.671"> }</span>
<a href="#l40.672"></a><span id="l40.672"> </span>
<a href="#l40.673"></a><span id="l40.673"> BOOL nsAbWinHelper::CopyEntry(const nsMapiEntry&amp; aContainer, const nsMapiEntry&amp; aSource,</span>
<a href="#l40.674"></a><span id="l40.674">                               nsMapiEntry&amp; aTarget)</span>
<a href="#l40.675"></a><span id="l40.675"> {</span>
<a href="#l40.676"></a><span id="l40.676">     nsMapiInterfaceWrapper&lt;LPABCONT&gt; container ;</span>
<a href="#l40.677"></a><span id="l40.677">     ULONG objType = 0 ;</span>
<a href="#l40.678"></a><span id="l40.678"> </span>
<a href="#l40.679"></a><span id="l40.679">     mLastError = mAddressBook-&gt;OpenEntry(aContainer.mByteCount, aContainer.mEntryId,</span>
<a href="#l40.680"></a><span id="l40.680">                                          &amp;IID_IABContainer, MAPI_MODIFY, &amp;objType,</span>
<a href="#l40.681"></a><span id="l40.681">                                          container) ;</span>
<a href="#l40.682"></a><span id="l40.682" class="difflineminus">-    if (HR_FAILED(mLastError)) { </span>
<a href="#l40.683"></a><span id="l40.683" class="difflineplus">+    if (HR_FAILED(mLastError)) {</span>
<a href="#l40.684"></a><span id="l40.684">         PRINTF((&quot;Cannot open container %08x.\n&quot;, mLastError)) ;</span>
<a href="#l40.685"></a><span id="l40.685">         return FALSE ;</span>
<a href="#l40.686"></a><span id="l40.686">     }</span>
<a href="#l40.687"></a><span id="l40.687">     nsMapiInterfaceWrapper&lt;LPMAPIPROP&gt; newEntry ;</span>
<a href="#l40.688"></a><span id="l40.688"> </span>
<a href="#l40.689"></a><span id="l40.689">     mLastError = container-&gt;CreateEntry(aSource.mByteCount, aSource.mEntryId,</span>
<a href="#l40.690"></a><span id="l40.690">                                         CREATE_CHECK_DUP_LOOSE, newEntry) ;</span>
<a href="#l40.691"></a><span id="l40.691">     if (HR_FAILED(mLastError)) {</span>
<a href="#l40.692"></a><span id="l40.692" class="difflineat">@@ -744,33 +744,33 @@ BOOL nsAbWinHelper::CopyEntry(const nsMa</span>
<a href="#l40.693"></a><span id="l40.693">     mLastError = newEntry-&gt;SaveChanges(KEEP_OPEN_READONLY) ;</span>
<a href="#l40.694"></a><span id="l40.694">     if (HR_FAILED(mLastError)) {</span>
<a href="#l40.695"></a><span id="l40.695">         PRINTF((&quot;Cannot commit new entry %08x.\n&quot;, mLastError)) ;</span>
<a href="#l40.696"></a><span id="l40.696">         return FALSE ;</span>
<a href="#l40.697"></a><span id="l40.697">     }</span>
<a href="#l40.698"></a><span id="l40.698">     SPropTagArray property ;</span>
<a href="#l40.699"></a><span id="l40.699">     LPSPropValue value = NULL ;</span>
<a href="#l40.700"></a><span id="l40.700">     ULONG valueCount = 0 ;</span>
<a href="#l40.701"></a><span id="l40.701" class="difflineminus">-    </span>
<a href="#l40.702"></a><span id="l40.702" class="difflineplus">+</span>
<a href="#l40.703"></a><span id="l40.703">     property.cValues = 1 ;</span>
<a href="#l40.704"></a><span id="l40.704" class="difflineminus">-    property.aulPropTag [0] = PR_ENTRYID ;</span>
<a href="#l40.705"></a><span id="l40.705" class="difflineplus">+    property.aulPropTag[0] = PR_ENTRYID ;</span>
<a href="#l40.706"></a><span id="l40.706">     mLastError = newEntry-&gt;GetProps(&amp;property, 0, &amp;valueCount, &amp;value) ;</span>
<a href="#l40.707"></a><span id="l40.707">     if (HR_FAILED(mLastError) || valueCount != 1) {</span>
<a href="#l40.708"></a><span id="l40.708">         PRINTF((&quot;Cannot get entry id %08x.\n&quot;, mLastError)) ;</span>
<a href="#l40.709"></a><span id="l40.709">         return FALSE ;</span>
<a href="#l40.710"></a><span id="l40.710">     }</span>
<a href="#l40.711"></a><span id="l40.711" class="difflineminus">-    aTarget.Assign(value-&gt;Value.bin.cb, </span>
<a href="#l40.712"></a><span id="l40.712" class="difflineplus">+    aTarget.Assign(value-&gt;Value.bin.cb,</span>
<a href="#l40.713"></a><span id="l40.713">                    reinterpret_cast&lt;LPENTRYID&gt;(value-&gt;Value.bin.lpb)) ;</span>
<a href="#l40.714"></a><span id="l40.714">     FreeBuffer(value) ;</span>
<a href="#l40.715"></a><span id="l40.715">     return TRUE ;</span>
<a href="#l40.716"></a><span id="l40.716"> }</span>
<a href="#l40.717"></a><span id="l40.717"> </span>
<a href="#l40.718"></a><span id="l40.718"> BOOL nsAbWinHelper::GetDefaultContainer(nsMapiEntry&amp; aContainer)</span>
<a href="#l40.719"></a><span id="l40.719"> {</span>
<a href="#l40.720"></a><span id="l40.720" class="difflineminus">-    LPENTRYID entryId = NULL ; </span>
<a href="#l40.721"></a><span id="l40.721" class="difflineplus">+    LPENTRYID entryId = NULL ;</span>
<a href="#l40.722"></a><span id="l40.722">     ULONG byteCount = 0 ;</span>
<a href="#l40.723"></a><span id="l40.723"> </span>
<a href="#l40.724"></a><span id="l40.724">     mLastError = mAddressBook-&gt;GetPAB(&amp;byteCount, &amp;entryId) ;</span>
<a href="#l40.725"></a><span id="l40.725">     if (HR_FAILED(mLastError)) {</span>
<a href="#l40.726"></a><span id="l40.726">         PRINTF((&quot;Cannot get PAB %08x.\n&quot;, mLastError)) ;</span>
<a href="#l40.727"></a><span id="l40.727">         return FALSE ;</span>
<a href="#l40.728"></a><span id="l40.728">     }</span>
<a href="#l40.729"></a><span id="l40.729">     aContainer.Assign(byteCount, entryId) ;</span>
<a href="#l40.730"></a><span id="l40.730" class="difflineat">@@ -799,29 +799,29 @@ BOOL nsAbWinHelper::GetContents(const ns</span>
<a href="#l40.731"></a><span id="l40.731"> {</span>
<a href="#l40.732"></a><span id="l40.732">     if (aList != NULL) { *aList = NULL ; }</span>
<a href="#l40.733"></a><span id="l40.733">     aNbElements = 0 ;</span>
<a href="#l40.734"></a><span id="l40.734">     nsMapiInterfaceWrapper&lt;LPMAPICONTAINER&gt; parent ;</span>
<a href="#l40.735"></a><span id="l40.735">     nsMapiInterfaceWrapper&lt;LPMAPITABLE&gt; contents ;</span>
<a href="#l40.736"></a><span id="l40.736">     ULONG objType = 0 ;</span>
<a href="#l40.737"></a><span id="l40.737">     ULONG rowCount = 0 ;</span>
<a href="#l40.738"></a><span id="l40.738"> </span>
<a href="#l40.739"></a><span id="l40.739" class="difflineminus">-    mLastError = mAddressBook-&gt;OpenEntry(aParent.mByteCount, aParent.mEntryId, </span>
<a href="#l40.740"></a><span id="l40.740" class="difflineminus">-                                         &amp;IID_IMAPIContainer, 0, &amp;objType, </span>
<a href="#l40.741"></a><span id="l40.741" class="difflineplus">+    mLastError = mAddressBook-&gt;OpenEntry(aParent.mByteCount, aParent.mEntryId,</span>
<a href="#l40.742"></a><span id="l40.742" class="difflineplus">+                                         &amp;IID_IMAPIContainer, 0, &amp;objType,</span>
<a href="#l40.743"></a><span id="l40.743">                                          parent) ;</span>
<a href="#l40.744"></a><span id="l40.744">     if (HR_FAILED(mLastError)) {</span>
<a href="#l40.745"></a><span id="l40.745">         PRINTF((&quot;Cannot open parent %08x.\n&quot;, mLastError)) ;</span>
<a href="#l40.746"></a><span id="l40.746" class="difflineminus">-        return FALSE ; </span>
<a href="#l40.747"></a><span id="l40.747" class="difflineplus">+        return FALSE ;</span>
<a href="#l40.748"></a><span id="l40.748">     }</span>
<a href="#l40.749"></a><span id="l40.749">     // Here, flags for WAB and MAPI could be different, so this works</span>
<a href="#l40.750"></a><span id="l40.750">     // only as long as we don't want to use any flag in GetContentsTable</span>
<a href="#l40.751"></a><span id="l40.751">     mLastError = parent-&gt;GetContentsTable(0, contents) ;</span>
<a href="#l40.752"></a><span id="l40.752">     if (HR_FAILED(mLastError)) {</span>
<a href="#l40.753"></a><span id="l40.753">         PRINTF((&quot;Cannot get contents %08x.\n&quot;, mLastError)) ;</span>
<a href="#l40.754"></a><span id="l40.754" class="difflineminus">-        return FALSE ; </span>
<a href="#l40.755"></a><span id="l40.755" class="difflineplus">+        return FALSE ;</span>
<a href="#l40.756"></a><span id="l40.756">     }</span>
<a href="#l40.757"></a><span id="l40.757">     if (aRestriction != NULL) {</span>
<a href="#l40.758"></a><span id="l40.758">         mLastError = contents-&gt;Restrict(aRestriction, 0) ;</span>
<a href="#l40.759"></a><span id="l40.759">         if (HR_FAILED(mLastError)) {</span>
<a href="#l40.760"></a><span id="l40.760">             PRINTF((&quot;Cannot set restriction %08x.\n&quot;, mLastError)) ;</span>
<a href="#l40.761"></a><span id="l40.761">             return FALSE ;</span>
<a href="#l40.762"></a><span id="l40.762">         }</span>
<a href="#l40.763"></a><span id="l40.763">     }</span>
<a href="#l40.764"></a><span id="l40.764" class="difflineat">@@ -830,121 +830,121 @@ BOOL nsAbWinHelper::GetContents(const ns</span>
<a href="#l40.765"></a><span id="l40.765">         PRINTF((&quot;Cannot set columns %08x.\n&quot;, mLastError)) ;</span>
<a href="#l40.766"></a><span id="l40.766">         return FALSE ;</span>
<a href="#l40.767"></a><span id="l40.767">     }</span>
<a href="#l40.768"></a><span id="l40.768">     mLastError = contents-&gt;GetRowCount(0, &amp;rowCount) ;</span>
<a href="#l40.769"></a><span id="l40.769">     if (HR_FAILED(mLastError)) {</span>
<a href="#l40.770"></a><span id="l40.770">         PRINTF((&quot;Cannot get result count %08x.\n&quot;, mLastError)) ;</span>
<a href="#l40.771"></a><span id="l40.771">         return FALSE ;</span>
<a href="#l40.772"></a><span id="l40.772">     }</span>
<a href="#l40.773"></a><span id="l40.773" class="difflineminus">-    if (aList != NULL) { *aList = new nsMapiEntry [rowCount] ; }</span>
<a href="#l40.774"></a><span id="l40.774" class="difflineplus">+    if (aList != NULL) { *aList = new nsMapiEntry[rowCount] ; }</span>
<a href="#l40.775"></a><span id="l40.775">     aNbElements = 0 ;</span>
<a href="#l40.776"></a><span id="l40.776">     do {</span>
<a href="#l40.777"></a><span id="l40.777">         LPSRowSet rowSet = NULL ;</span>
<a href="#l40.778"></a><span id="l40.778" class="difflineminus">-        </span>
<a href="#l40.779"></a><span id="l40.779" class="difflineplus">+</span>
<a href="#l40.780"></a><span id="l40.780">         rowCount = 0 ;</span>
<a href="#l40.781"></a><span id="l40.781">         mLastError = contents-&gt;QueryRows(1, 0, &amp;rowSet) ;</span>
<a href="#l40.782"></a><span id="l40.782">         if (HR_FAILED(mLastError)) {</span>
<a href="#l40.783"></a><span id="l40.783">             PRINTF((&quot;Cannot query rows %08x.\n&quot;, mLastError)) ;</span>
<a href="#l40.784"></a><span id="l40.784">             return FALSE ;</span>
<a href="#l40.785"></a><span id="l40.785">         }</span>
<a href="#l40.786"></a><span id="l40.786">         rowCount = rowSet-&gt;cRows ;</span>
<a href="#l40.787"></a><span id="l40.787">         if (rowCount &gt; 0 &amp;&amp;</span>
<a href="#l40.788"></a><span id="l40.788">             (aMapiType == 0 ||</span>
<a href="#l40.789"></a><span id="l40.789">             rowSet-&gt;aRow-&gt;lpProps[ContentsColumnObjectType].Value.ul == aMapiType)) {</span>
<a href="#l40.790"></a><span id="l40.790">             if (aList != NULL) {</span>
<a href="#l40.791"></a><span id="l40.791" class="difflineminus">-                nsMapiEntry&amp; current = (*aList) [aNbElements] ;</span>
<a href="#l40.792"></a><span id="l40.792" class="difflineplus">+                nsMapiEntry&amp; current = (*aList)[aNbElements] ;</span>
<a href="#l40.793"></a><span id="l40.793">                 SPropValue&amp; currentValue = rowSet-&gt;aRow-&gt;lpProps[ContentsColumnEntryId] ;</span>
<a href="#l40.794"></a><span id="l40.794" class="difflineminus">-                </span>
<a href="#l40.795"></a><span id="l40.795" class="difflineplus">+</span>
<a href="#l40.796"></a><span id="l40.796">                 current.Assign(currentValue.Value.bin.cb,</span>
<a href="#l40.797"></a><span id="l40.797">                     reinterpret_cast&lt;LPENTRYID&gt;(currentValue.Value.bin.lpb)) ;</span>
<a href="#l40.798"></a><span id="l40.798">             }</span>
<a href="#l40.799"></a><span id="l40.799" class="difflineminus">-            ++ aNbElements ;</span>
<a href="#l40.800"></a><span id="l40.800" class="difflineplus">+            ++aNbElements ;</span>
<a href="#l40.801"></a><span id="l40.801">         }</span>
<a href="#l40.802"></a><span id="l40.802">         MyFreeProws(rowSet) ;</span>
<a href="#l40.803"></a><span id="l40.803">     } while (rowCount &gt; 0) ;</span>
<a href="#l40.804"></a><span id="l40.804">     return TRUE ;</span>
<a href="#l40.805"></a><span id="l40.805"> }</span>
<a href="#l40.806"></a><span id="l40.806"> </span>
<a href="#l40.807"></a><span id="l40.807" class="difflineminus">-BOOL nsAbWinHelper::GetMAPIProperties(const nsMapiEntry&amp; aObject, const ULONG *aPropertyTags, </span>
<a href="#l40.808"></a><span id="l40.808" class="difflineminus">-                                      ULONG aNbProperties, LPSPropValue&amp; aValue, </span>
<a href="#l40.809"></a><span id="l40.809" class="difflineplus">+BOOL nsAbWinHelper::GetMAPIProperties(const nsMapiEntry&amp; aObject, const ULONG *aPropertyTags,</span>
<a href="#l40.810"></a><span id="l40.810" class="difflineplus">+                                      ULONG aNbProperties, LPSPropValue&amp; aValue,</span>
<a href="#l40.811"></a><span id="l40.811">                                       ULONG&amp; aValueCount)</span>
<a href="#l40.812"></a><span id="l40.812"> {</span>
<a href="#l40.813"></a><span id="l40.813">     nsMapiInterfaceWrapper&lt;LPMAPIPROP&gt; object ;</span>
<a href="#l40.814"></a><span id="l40.814">     ULONG objType = 0 ;</span>
<a href="#l40.815"></a><span id="l40.815">     LPSPropTagArray properties = NULL ;</span>
<a href="#l40.816"></a><span id="l40.816">     ULONG i = 0 ;</span>
<a href="#l40.817"></a><span id="l40.817" class="difflineminus">-    </span>
<a href="#l40.818"></a><span id="l40.818" class="difflineplus">+</span>
<a href="#l40.819"></a><span id="l40.819">     mLastError = mAddressBook-&gt;OpenEntry(aObject.mByteCount, aObject.mEntryId,</span>
<a href="#l40.820"></a><span id="l40.820" class="difflineminus">-                                         &amp;IID_IMAPIProp, 0, &amp;objType, </span>
<a href="#l40.821"></a><span id="l40.821" class="difflineplus">+                                         &amp;IID_IMAPIProp, 0, &amp;objType,</span>
<a href="#l40.822"></a><span id="l40.822">                                          object) ;</span>
<a href="#l40.823"></a><span id="l40.823" class="difflineminus">-    if (HR_FAILED(mLastError)) { </span>
<a href="#l40.824"></a><span id="l40.824" class="difflineplus">+    if (HR_FAILED(mLastError)) {</span>
<a href="#l40.825"></a><span id="l40.825">         PRINTF((&quot;Cannot open entry %08x.\n&quot;, mLastError)) ;</span>
<a href="#l40.826"></a><span id="l40.826" class="difflineminus">-        return FALSE ; </span>
<a href="#l40.827"></a><span id="l40.827" class="difflineplus">+        return FALSE ;</span>
<a href="#l40.828"></a><span id="l40.828">     }</span>
<a href="#l40.829"></a><span id="l40.829" class="difflineminus">-    AllocateBuffer(CbNewSPropTagArray(aNbProperties), </span>
<a href="#l40.830"></a><span id="l40.830" class="difflineplus">+    AllocateBuffer(CbNewSPropTagArray(aNbProperties),</span>
<a href="#l40.831"></a><span id="l40.831">                    reinterpret_cast&lt;void **&gt;(&amp;properties)) ;</span>
<a href="#l40.832"></a><span id="l40.832">     properties-&gt;cValues = aNbProperties ;</span>
<a href="#l40.833"></a><span id="l40.833" class="difflineminus">-    for (i = 0 ; i &lt; aNbProperties ; ++ i) {</span>
<a href="#l40.834"></a><span id="l40.834" class="difflineminus">-        properties-&gt;aulPropTag [i] = aPropertyTags [i] ;</span>
<a href="#l40.835"></a><span id="l40.835" class="difflineplus">+    for (i = 0 ; i &lt; aNbProperties ; ++i) {</span>
<a href="#l40.836"></a><span id="l40.836" class="difflineplus">+        properties-&gt;aulPropTag[i] = aPropertyTags[i] ;</span>
<a href="#l40.837"></a><span id="l40.837">     }</span>
<a href="#l40.838"></a><span id="l40.838">     mLastError = object-&gt;GetProps(properties, 0, &amp;aValueCount, &amp;aValue) ;</span>
<a href="#l40.839"></a><span id="l40.839">     FreeBuffer(properties) ;</span>
<a href="#l40.840"></a><span id="l40.840">     if (HR_FAILED(mLastError)) {</span>
<a href="#l40.841"></a><span id="l40.841">         PRINTF((&quot;Cannot get props %08x.\n&quot;, mLastError)) ;</span>
<a href="#l40.842"></a><span id="l40.842">     }</span>
<a href="#l40.843"></a><span id="l40.843">     return HR_SUCCEEDED(mLastError) ;</span>
<a href="#l40.844"></a><span id="l40.844"> }</span>
<a href="#l40.845"></a><span id="l40.845"> </span>
<a href="#l40.846"></a><span id="l40.846" class="difflineminus">-BOOL nsAbWinHelper::SetMAPIProperties(const nsMapiEntry&amp; aObject, ULONG aNbProperties, </span>
<a href="#l40.847"></a><span id="l40.847" class="difflineplus">+BOOL nsAbWinHelper::SetMAPIProperties(const nsMapiEntry&amp; aObject, ULONG aNbProperties,</span>
<a href="#l40.848"></a><span id="l40.848">                                       const LPSPropValue&amp; aValues)</span>
<a href="#l40.849"></a><span id="l40.849"> {</span>
<a href="#l40.850"></a><span id="l40.850">     nsMapiInterfaceWrapper&lt;LPMAPIPROP&gt; object ;</span>
<a href="#l40.851"></a><span id="l40.851">     ULONG objType = 0 ;</span>
<a href="#l40.852"></a><span id="l40.852">     LPSPropProblemArray problems = NULL ;</span>
<a href="#l40.853"></a><span id="l40.853"> </span>
<a href="#l40.854"></a><span id="l40.854">     mLastError = mAddressBook-&gt;OpenEntry(aObject.mByteCount, aObject.mEntryId,</span>
<a href="#l40.855"></a><span id="l40.855" class="difflineminus">-                                         &amp;IID_IMAPIProp, MAPI_MODIFY, &amp;objType, </span>
<a href="#l40.856"></a><span id="l40.856" class="difflineplus">+                                         &amp;IID_IMAPIProp, MAPI_MODIFY, &amp;objType,</span>
<a href="#l40.857"></a><span id="l40.857">                                          object) ;</span>
<a href="#l40.858"></a><span id="l40.858">     if (HR_FAILED(mLastError)) {</span>
<a href="#l40.859"></a><span id="l40.859">         PRINTF((&quot;Cannot open entry %08x.\n&quot;, mLastError)) ;</span>
<a href="#l40.860"></a><span id="l40.860">         return FALSE ;</span>
<a href="#l40.861"></a><span id="l40.861">     }</span>
<a href="#l40.862"></a><span id="l40.862">     mLastError = object-&gt;SetProps(aNbProperties, aValues, &amp;problems) ;</span>
<a href="#l40.863"></a><span id="l40.863">     if (HR_FAILED(mLastError)) {</span>
<a href="#l40.864"></a><span id="l40.864">         PRINTF((&quot;Cannot update the object %08x.\n&quot;, mLastError)) ;</span>
<a href="#l40.865"></a><span id="l40.865">         return FALSE ;</span>
<a href="#l40.866"></a><span id="l40.866">     }</span>
<a href="#l40.867"></a><span id="l40.867">     if (problems != NULL) {</span>
<a href="#l40.868"></a><span id="l40.868" class="difflineminus">-        for (ULONG i = 0 ; i &lt; problems-&gt;cProblem ; ++ i) {</span>
<a href="#l40.869"></a><span id="l40.869" class="difflineminus">-            PRINTF((&quot;Problem %d: index %d code %08x.\n&quot;, i, </span>
<a href="#l40.870"></a><span id="l40.870" class="difflineminus">-                problems-&gt;aProblem [i].ulIndex, </span>
<a href="#l40.871"></a><span id="l40.871" class="difflineminus">-                problems-&gt;aProblem [i].scode)) ;</span>
<a href="#l40.872"></a><span id="l40.872" class="difflineplus">+        for (ULONG i = 0 ; i &lt; problems-&gt;cProblem ; ++i) {</span>
<a href="#l40.873"></a><span id="l40.873" class="difflineplus">+            PRINTF((&quot;Problem %d: index %d code %08x.\n&quot;, i,</span>
<a href="#l40.874"></a><span id="l40.874" class="difflineplus">+                problems-&gt;aProblem[i].ulIndex,</span>
<a href="#l40.875"></a><span id="l40.875" class="difflineplus">+                problems-&gt;aProblem[i].scode)) ;</span>
<a href="#l40.876"></a><span id="l40.876">         }</span>
<a href="#l40.877"></a><span id="l40.877">     }</span>
<a href="#l40.878"></a><span id="l40.878">     mLastError = object-&gt;SaveChanges(0) ;</span>
<a href="#l40.879"></a><span id="l40.879">     if (HR_FAILED(mLastError)) {</span>
<a href="#l40.880"></a><span id="l40.880">         PRINTF((&quot;Cannot commit changes %08x.\n&quot;, mLastError)) ;</span>
<a href="#l40.881"></a><span id="l40.881">     }</span>
<a href="#l40.882"></a><span id="l40.882">     return HR_SUCCEEDED(mLastError) ;</span>
<a href="#l40.883"></a><span id="l40.883"> }</span>
<a href="#l40.884"></a><span id="l40.884"> </span>
<a href="#l40.885"></a><span id="l40.885"> void nsAbWinHelper::MyFreeProws(LPSRowSet aRowset)</span>
<a href="#l40.886"></a><span id="l40.886"> {</span>
<a href="#l40.887"></a><span id="l40.887">     if (aRowset == NULL) { return ; }</span>
<a href="#l40.888"></a><span id="l40.888" class="difflineminus">-    ULONG i = 0 ; </span>
<a href="#l40.889"></a><span id="l40.889" class="difflineplus">+    ULONG i = 0 ;</span>
<a href="#l40.890"></a><span id="l40.890"> </span>
<a href="#l40.891"></a><span id="l40.891" class="difflineminus">-    for (i = 0 ; i &lt; aRowset-&gt;cRows ; ++ i) {</span>
<a href="#l40.892"></a><span id="l40.892" class="difflineminus">-        FreeBuffer(aRowset-&gt;aRow [i].lpProps) ;</span>
<a href="#l40.893"></a><span id="l40.893" class="difflineplus">+    for (i = 0 ; i &lt; aRowset-&gt;cRows ; ++i) {</span>
<a href="#l40.894"></a><span id="l40.894" class="difflineplus">+        FreeBuffer(aRowset-&gt;aRow[i].lpProps) ;</span>
<a href="#l40.895"></a><span id="l40.895">     }</span>
<a href="#l40.896"></a><span id="l40.896">     FreeBuffer(aRowset) ;</span>
<a href="#l40.897"></a><span id="l40.897"> }</span>
<a href="#l40.898"></a><span id="l40.898"> </span>
<a href="#l40.899"></a><span id="l40.899"> nsAbWinHelperGuard::nsAbWinHelperGuard(uint32_t aType)</span>
<a href="#l40.900"></a><span id="l40.900" class="difflineminus">-: mHelper(NULL) </span>
<a href="#l40.901"></a><span id="l40.901" class="difflineplus">+: mHelper(NULL)</span>
<a href="#l40.902"></a><span id="l40.902"> {</span>
<a href="#l40.903"></a><span id="l40.903">     switch(aType) {</span>
<a href="#l40.904"></a><span id="l40.904">     case nsAbWinType_Outlook: mHelper = new nsMapiAddressBook ; break ;</span>
<a href="#l40.905"></a><span id="l40.905">     case nsAbWinType_OutlookExp: mHelper = new nsWabAddressBook ; break ;</span>
<a href="#l40.906"></a><span id="l40.906">     default: break ;</span>
<a href="#l40.907"></a><span id="l40.907">     }</span>
<a href="#l40.908"></a><span id="l40.908"> }</span>
<a href="#l40.909"></a><span id="l40.909"> </span>
<a href="#l40.910"></a><span id="l40.910" class="difflineat">@@ -957,17 +957,17 @@ const char *kOutlookDirectoryScheme = &quot;m</span>
<a href="#l40.911"></a><span id="l40.911"> const int kOutlookDirSchemeLength = 21 ;</span>
<a href="#l40.912"></a><span id="l40.912"> const char *kOutlookStub = &quot;op/&quot; ;</span>
<a href="#l40.913"></a><span id="l40.913"> const int kOutlookStubLength = 3 ;</span>
<a href="#l40.914"></a><span id="l40.914"> const char *kOutlookExpStub = &quot;oe/&quot; ;</span>
<a href="#l40.915"></a><span id="l40.915"> const int kOutlookExpStubLength = 3 ;</span>
<a href="#l40.916"></a><span id="l40.916"> const char *kOutlookCardScheme = &quot;moz-aboutlookcard://&quot; ;</span>
<a href="#l40.917"></a><span id="l40.917"> const int kOutlookCardSchemeLength = 16 ;</span>
<a href="#l40.918"></a><span id="l40.918"> </span>
<a href="#l40.919"></a><span id="l40.919" class="difflineminus">-nsAbWinType getAbWinType(const char *aScheme, const char *aUri, nsCString&amp; aStub, nsCString&amp; aEntry) </span>
<a href="#l40.920"></a><span id="l40.920" class="difflineplus">+nsAbWinType getAbWinType(const char *aScheme, const char *aUri, nsCString&amp; aStub, nsCString&amp; aEntry)</span>
<a href="#l40.921"></a><span id="l40.921"> {</span>
<a href="#l40.922"></a><span id="l40.922">     aStub.Truncate() ;</span>
<a href="#l40.923"></a><span id="l40.923">     aEntry.Truncate() ;</span>
<a href="#l40.924"></a><span id="l40.924">     uint32_t schemeLength = strlen(aScheme) ;</span>
<a href="#l40.925"></a><span id="l40.925"> </span>
<a href="#l40.926"></a><span id="l40.926">     if (strncmp(aUri, aScheme, schemeLength) == 0) {</span>
<a href="#l40.927"></a><span id="l40.927">         if (strncmp(aUri + schemeLength, kOutlookStub, kOutlookStubLength) == 0) {</span>
<a href="#l40.928"></a><span id="l40.928">             aEntry = aUri + schemeLength + kOutlookStubLength ;</span>
<a href="#l40.929"></a><span id="l40.929" class="difflineat">@@ -975,24 +975,24 @@ nsAbWinType getAbWinType(const char *aSc</span>
<a href="#l40.930"></a><span id="l40.930">             return nsAbWinType_Outlook ;</span>
<a href="#l40.931"></a><span id="l40.931">         }</span>
<a href="#l40.932"></a><span id="l40.932">         if (strncmp(aUri + schemeLength, kOutlookExpStub, kOutlookExpStubLength) == 0) {</span>
<a href="#l40.933"></a><span id="l40.933">             aEntry = aUri + schemeLength + kOutlookExpStubLength ;</span>
<a href="#l40.934"></a><span id="l40.934">             aStub = kOutlookExpStub ;</span>
<a href="#l40.935"></a><span id="l40.935">             return nsAbWinType_OutlookExp ;</span>
<a href="#l40.936"></a><span id="l40.936">         }</span>
<a href="#l40.937"></a><span id="l40.937">     }</span>
<a href="#l40.938"></a><span id="l40.938" class="difflineminus">-    return nsAbWinType_Unknown ;   </span>
<a href="#l40.939"></a><span id="l40.939" class="difflineplus">+    return nsAbWinType_Unknown ;</span>
<a href="#l40.940"></a><span id="l40.940"> }</span>
<a href="#l40.941"></a><span id="l40.941"> </span>
<a href="#l40.942"></a><span id="l40.942"> void buildAbWinUri(const char *aScheme, uint32_t aType, nsCString&amp; aUri)</span>
<a href="#l40.943"></a><span id="l40.943"> {</span>
<a href="#l40.944"></a><span id="l40.944">     aUri.Assign(aScheme) ;</span>
<a href="#l40.945"></a><span id="l40.945">     switch(aType) {</span>
<a href="#l40.946"></a><span id="l40.946" class="difflineminus">-    case nsAbWinType_Outlook: aUri.Append(kOutlookStub) ; break ; </span>
<a href="#l40.947"></a><span id="l40.947" class="difflineplus">+    case nsAbWinType_Outlook: aUri.Append(kOutlookStub) ; break ;</span>
<a href="#l40.948"></a><span id="l40.948">     case nsAbWinType_OutlookExp: aUri.Append(kOutlookExpStub) ; break ;</span>
<a href="#l40.949"></a><span id="l40.949">     default: aUri.AssignLiteral(&quot;&quot;) ;</span>
<a href="#l40.950"></a><span id="l40.950">     }</span>
<a href="#l40.951"></a><span id="l40.951"> }</span>
<a href="#l40.952"></a><span id="l40.952"> </span>
<a href="#l40.953"></a><span id="l40.953"> </span>
<a href="#l40.954"></a><span id="l40.954"> </span>
<a href="#l40.955"></a><span id="l40.955"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l41.1"></a><span id="l41.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbWinHelper.h</span>
<a href="#l41.2"></a><span id="l41.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbWinHelper.h</span>
<a href="#l41.3"></a><span id="l41.3" class="difflineat">@@ -22,17 +22,17 @@ struct nsMapiEntry</span>
<a href="#l41.4"></a><span id="l41.4">     nsMapiEntry(ULONG aByteCount, LPENTRYID aEntryId) ;</span>
<a href="#l41.5"></a><span id="l41.5"> </span>
<a href="#l41.6"></a><span id="l41.6">     void Assign(ULONG aByteCount, LPENTRYID aEntryId) ;</span>
<a href="#l41.7"></a><span id="l41.7">     void Assign(const nsCString&amp; aString) ;</span>
<a href="#l41.8"></a><span id="l41.8">     void ToString(nsCString&amp; aString) const ;</span>
<a href="#l41.9"></a><span id="l41.9">     void Dump(void) const ;</span>
<a href="#l41.10"></a><span id="l41.10"> } ;</span>
<a href="#l41.11"></a><span id="l41.11"> </span>
<a href="#l41.12"></a><span id="l41.12" class="difflineminus">-struct nsMapiEntryArray </span>
<a href="#l41.13"></a><span id="l41.13" class="difflineplus">+struct nsMapiEntryArray</span>
<a href="#l41.14"></a><span id="l41.14"> {</span>
<a href="#l41.15"></a><span id="l41.15">     nsMapiEntry *mEntries ;</span>
<a href="#l41.16"></a><span id="l41.16">     ULONG      mNbEntries ;</span>
<a href="#l41.17"></a><span id="l41.17"> </span>
<a href="#l41.18"></a><span id="l41.18">     nsMapiEntryArray(void) ;</span>
<a href="#l41.19"></a><span id="l41.19">     ~nsMapiEntryArray(void) ;</span>
<a href="#l41.20"></a><span id="l41.20"> </span>
<a href="#l41.21"></a><span id="l41.21">     const nsMapiEntry&amp; operator [] (int aIndex) const { return mEntries [aIndex] ; }</span>
<a href="#l41.22"></a><span id="l41.22" class="difflineat">@@ -43,50 +43,50 @@ class nsAbWinHelper</span>
<a href="#l41.23"></a><span id="l41.23"> {</span>
<a href="#l41.24"></a><span id="l41.24"> public:</span>
<a href="#l41.25"></a><span id="l41.25">     nsAbWinHelper(void) ;</span>
<a href="#l41.26"></a><span id="l41.26">     virtual ~nsAbWinHelper(void) ;</span>
<a href="#l41.27"></a><span id="l41.27"> </span>
<a href="#l41.28"></a><span id="l41.28">     // Get the top address books</span>
<a href="#l41.29"></a><span id="l41.29">     BOOL GetFolders(nsMapiEntryArray&amp; aFolders) ;</span>
<a href="#l41.30"></a><span id="l41.30">     // Get a list of entries for cards/mailing lists in a folder/mailing list</span>
<a href="#l41.31"></a><span id="l41.31" class="difflineminus">-    BOOL GetCards(const nsMapiEntry&amp; aParent, LPSRestriction aRestriction, </span>
<a href="#l41.32"></a><span id="l41.32" class="difflineplus">+    BOOL GetCards(const nsMapiEntry&amp; aParent, LPSRestriction aRestriction,</span>
<a href="#l41.33"></a><span id="l41.33">                   nsMapiEntryArray&amp; aCards) ;</span>
<a href="#l41.34"></a><span id="l41.34">     // Get a list of mailing lists in a folder</span>
<a href="#l41.35"></a><span id="l41.35">     BOOL GetNodes(const nsMapiEntry&amp; aParent, nsMapiEntryArray&amp; aNodes) ;</span>
<a href="#l41.36"></a><span id="l41.36">     // Get the number of cards/mailing lists in a folder/mailing list</span>
<a href="#l41.37"></a><span id="l41.37">     BOOL GetCardsCount(const nsMapiEntry&amp; aParent, ULONG&amp; aNbCards) ;</span>
<a href="#l41.38"></a><span id="l41.38">     // Access last MAPI error</span>
<a href="#l41.39"></a><span id="l41.39">     HRESULT LastError(void) const { return mLastError ; }</span>
<a href="#l41.40"></a><span id="l41.40">     // Get the value of a MAPI property of type string</span>
<a href="#l41.41"></a><span id="l41.41">     BOOL GetPropertyString(const nsMapiEntry&amp; aObject, ULONG aPropertyTag, nsCString&amp; aValue) ;</span>
<a href="#l41.42"></a><span id="l41.42">     // Same as previous, but string is returned as unicode</span>
<a href="#l41.43"></a><span id="l41.43">     BOOL GetPropertyUString(const nsMapiEntry&amp; aObject, ULONG aPropertyTag, nsString&amp; aValue) ;</span>
<a href="#l41.44"></a><span id="l41.44">     // Get multiple string MAPI properties in one call.</span>
<a href="#l41.45"></a><span id="l41.45" class="difflineminus">-    BOOL GetPropertiesUString(const nsMapiEntry&amp; aObject, const ULONG *aPropertiesTag, </span>
<a href="#l41.46"></a><span id="l41.46" class="difflineplus">+    BOOL GetPropertiesUString(const nsMapiEntry&amp; aObject, const ULONG *aPropertiesTag,</span>
<a href="#l41.47"></a><span id="l41.47">                               ULONG aNbProperties, nsString *aValues);</span>
<a href="#l41.48"></a><span id="l41.48">     // Get the value of a MAPI property of type SYSTIME</span>
<a href="#l41.49"></a><span id="l41.49" class="difflineminus">-    BOOL GetPropertyDate(const nsMapiEntry&amp; aObject, ULONG aPropertyTag, </span>
<a href="#l41.50"></a><span id="l41.50" class="difflineplus">+    BOOL GetPropertyDate(const nsMapiEntry&amp; aObject, ULONG aPropertyTag,</span>
<a href="#l41.51"></a><span id="l41.51">                          WORD&amp; aYear, WORD&amp; aMonth, WORD&amp; aDay) ;</span>
<a href="#l41.52"></a><span id="l41.52">     // Get the value of a MAPI property of type LONG</span>
<a href="#l41.53"></a><span id="l41.53">     BOOL GetPropertyLong(const nsMapiEntry&amp; aObject, ULONG aPropertyTag, ULONG&amp; aValue) ;</span>
<a href="#l41.54"></a><span id="l41.54">     // Get the value of a MAPI property of type BIN</span>
<a href="#l41.55"></a><span id="l41.55">     BOOL GetPropertyBin(const nsMapiEntry&amp; aObject, ULONG aPropertyTag, nsMapiEntry&amp; aValue) ;</span>
<a href="#l41.56"></a><span id="l41.56">     // Tests if a container contains an entry</span>
<a href="#l41.57"></a><span id="l41.57">     BOOL TestOpenEntry(const nsMapiEntry&amp; aContainer, const nsMapiEntry&amp; aEntry) ;</span>
<a href="#l41.58"></a><span id="l41.58">     // Delete an entry in the address book</span>
<a href="#l41.59"></a><span id="l41.59">     BOOL DeleteEntry(const nsMapiEntry&amp; aContainer, const nsMapiEntry&amp; aEntry) ;</span>
<a href="#l41.60"></a><span id="l41.60">     // Set the value of a MAPI property of type string in unicode</span>
<a href="#l41.61"></a><span id="l41.61" class="difflineminus">-    BOOL SetPropertyUString (const nsMapiEntry&amp; aObject, ULONG aPropertyTag, </span>
<a href="#l41.62"></a><span id="l41.62" class="difflineplus">+    BOOL SetPropertyUString (const nsMapiEntry&amp; aObject, ULONG aPropertyTag,</span>
<a href="#l41.63"></a><span id="l41.63">                              const char16_t *aValue) ;</span>
<a href="#l41.64"></a><span id="l41.64">     // Same as previous, but with a bunch of properties in one call</span>
<a href="#l41.65"></a><span id="l41.65">     BOOL SetPropertiesUString(const nsMapiEntry&amp; aObject, const ULONG *aPropertiesTag,</span>
<a href="#l41.66"></a><span id="l41.66">                               ULONG aNbProperties, nsString *aValues) ;</span>
<a href="#l41.67"></a><span id="l41.67">     // Set the value of a MAPI property of type SYSTIME</span>
<a href="#l41.68"></a><span id="l41.68" class="difflineminus">-    BOOL SetPropertyDate(const nsMapiEntry&amp; aObject, ULONG aPropertyTag, </span>
<a href="#l41.69"></a><span id="l41.69" class="difflineplus">+    BOOL SetPropertyDate(const nsMapiEntry&amp; aObject, ULONG aPropertyTag,</span>
<a href="#l41.70"></a><span id="l41.70">                          WORD aYear, WORD aMonth, WORD aDay) ;</span>
<a href="#l41.71"></a><span id="l41.71">     // Create entry in the address book</span>
<a href="#l41.72"></a><span id="l41.72">     BOOL CreateEntry(const nsMapiEntry&amp; aParent, nsMapiEntry&amp; aNewEntry) ;</span>
<a href="#l41.73"></a><span id="l41.73">     // Create a distribution list in the address book</span>
<a href="#l41.74"></a><span id="l41.74">     BOOL CreateDistList(const nsMapiEntry&amp; aParent, nsMapiEntry&amp; aNewEntry) ;</span>
<a href="#l41.75"></a><span id="l41.75">     // Copy an existing entry in the address book</span>
<a href="#l41.76"></a><span id="l41.76">     BOOL CopyEntry(const nsMapiEntry&amp; aContainer, const nsMapiEntry&amp; aSource, nsMapiEntry&amp; aTarget) ;</span>
<a href="#l41.77"></a><span id="l41.77">     // Get a default address book container</span>
<a href="#l41.78"></a><span id="l41.78" class="difflineat">@@ -97,43 +97,43 @@ public:</span>
<a href="#l41.79"></a><span id="l41.79"> protected:</span>
<a href="#l41.80"></a><span id="l41.80">     HRESULT mLastError ;</span>
<a href="#l41.81"></a><span id="l41.81">     LPADRBOOK mAddressBook ;</span>
<a href="#l41.82"></a><span id="l41.82">     static uint32_t mEntryCounter ;</span>
<a href="#l41.83"></a><span id="l41.83">     static uint32_t mUseCount ;</span>
<a href="#l41.84"></a><span id="l41.84">     static nsAutoPtr&lt;mozilla::Mutex&gt; mMutex ;</span>
<a href="#l41.85"></a><span id="l41.85"> </span>
<a href="#l41.86"></a><span id="l41.86">     // Retrieve the contents of a container, with an optional restriction</span>
<a href="#l41.87"></a><span id="l41.87" class="difflineminus">-    BOOL GetContents(const nsMapiEntry&amp; aParent, LPSRestriction aRestriction, </span>
<a href="#l41.88"></a><span id="l41.88" class="difflineplus">+    BOOL GetContents(const nsMapiEntry&amp; aParent, LPSRestriction aRestriction,</span>
<a href="#l41.89"></a><span id="l41.89">                      nsMapiEntry **aList, ULONG &amp;aNbElements, ULONG aMapiType) ;</span>
<a href="#l41.90"></a><span id="l41.90">     // Retrieve the values of a set of properties on a MAPI object</span>
<a href="#l41.91"></a><span id="l41.91" class="difflineminus">-    BOOL GetMAPIProperties(const nsMapiEntry&amp; aObject, const ULONG *aPropertyTags, </span>
<a href="#l41.92"></a><span id="l41.92" class="difflineplus">+    BOOL GetMAPIProperties(const nsMapiEntry&amp; aObject, const ULONG *aPropertyTags,</span>
<a href="#l41.93"></a><span id="l41.93">                            ULONG aNbProperties,</span>
<a href="#l41.94"></a><span id="l41.94">                            LPSPropValue&amp; aValues, ULONG&amp; aValueCount) ;</span>
<a href="#l41.95"></a><span id="l41.95">     // Set the values of a set of properties on a MAPI object</span>
<a href="#l41.96"></a><span id="l41.96" class="difflineminus">-    BOOL SetMAPIProperties(const nsMapiEntry&amp; aObject, ULONG aNbProperties, </span>
<a href="#l41.97"></a><span id="l41.97" class="difflineplus">+    BOOL SetMAPIProperties(const nsMapiEntry&amp; aObject, ULONG aNbProperties,</span>
<a href="#l41.98"></a><span id="l41.98">                            const LPSPropValue&amp; aValues) ;</span>
<a href="#l41.99"></a><span id="l41.99">     // Clean-up a rowset returned by QueryRows</span>
<a href="#l41.100"></a><span id="l41.100">     void MyFreeProws(LPSRowSet aSet) ;</span>
<a href="#l41.101"></a><span id="l41.101">     // Allocation of a buffer for transmission to interfaces</span>
<a href="#l41.102"></a><span id="l41.102">     virtual void AllocateBuffer(ULONG aByteCount, LPVOID *aBuffer) = 0 ;</span>
<a href="#l41.103"></a><span id="l41.103">     // Destruction of a buffer provided by the interfaces</span>
<a href="#l41.104"></a><span id="l41.104">     virtual void FreeBuffer(LPVOID aBuffer) = 0 ;</span>
<a href="#l41.105"></a><span id="l41.105"> </span>
<a href="#l41.106"></a><span id="l41.106"> private:</span>
<a href="#l41.107"></a><span id="l41.107"> } ;</span>
<a href="#l41.108"></a><span id="l41.108"> </span>
<a href="#l41.109"></a><span id="l41.109" class="difflineminus">-enum nsAbWinType </span>
<a href="#l41.110"></a><span id="l41.110" class="difflineplus">+enum nsAbWinType</span>
<a href="#l41.111"></a><span id="l41.111"> {</span>
<a href="#l41.112"></a><span id="l41.112">     nsAbWinType_Unknown,</span>
<a href="#l41.113"></a><span id="l41.113">     nsAbWinType_Outlook,</span>
<a href="#l41.114"></a><span id="l41.114">     nsAbWinType_OutlookExp</span>
<a href="#l41.115"></a><span id="l41.115"> } ;</span>
<a href="#l41.116"></a><span id="l41.116"> </span>
<a href="#l41.117"></a><span id="l41.117" class="difflineminus">-class nsAbWinHelperGuard </span>
<a href="#l41.118"></a><span id="l41.118" class="difflineplus">+class nsAbWinHelperGuard</span>
<a href="#l41.119"></a><span id="l41.119"> {</span>
<a href="#l41.120"></a><span id="l41.120"> public :</span>
<a href="#l41.121"></a><span id="l41.121">     nsAbWinHelperGuard(uint32_t aType) ;</span>
<a href="#l41.122"></a><span id="l41.122">     ~nsAbWinHelperGuard(void) ;</span>
<a href="#l41.123"></a><span id="l41.123"> </span>
<a href="#l41.124"></a><span id="l41.124">     nsAbWinHelper *operator -&gt;(void) { return mHelper ; }</span>
<a href="#l41.125"></a><span id="l41.125"> </span>
<a href="#l41.126"></a><span id="l41.126"> private:</span>
<a href="#l41.127"></a><span id="l41.127" class="difflineat">@@ -141,16 +141,16 @@ private:</span>
<a href="#l41.128"></a><span id="l41.128"> } ;</span>
<a href="#l41.129"></a><span id="l41.129"> </span>
<a href="#l41.130"></a><span id="l41.130"> extern const char *kOutlookDirectoryScheme ;</span>
<a href="#l41.131"></a><span id="l41.131"> extern const int  kOutlookDirSchemeLength ;</span>
<a href="#l41.132"></a><span id="l41.132"> extern const char *kOutlookStub ;</span>
<a href="#l41.133"></a><span id="l41.133"> extern const char *kOutlookExpStub ;</span>
<a href="#l41.134"></a><span id="l41.134"> extern const char *kOutlookCardScheme ;</span>
<a href="#l41.135"></a><span id="l41.135"> </span>
<a href="#l41.136"></a><span id="l41.136" class="difflineminus">-nsAbWinType getAbWinType(const char *aScheme, const char *aUri, </span>
<a href="#l41.137"></a><span id="l41.137" class="difflineplus">+nsAbWinType getAbWinType(const char *aScheme, const char *aUri,</span>
<a href="#l41.138"></a><span id="l41.138">                          nsCString&amp; aStub, nsCString&amp; aEntry) ;</span>
<a href="#l41.139"></a><span id="l41.139"> void buildAbWinUri(const char *aScheme, uint32_t aType, nsCString&amp; aUri) ;</span>
<a href="#l41.140"></a><span id="l41.140"> </span>
<a href="#l41.141"></a><span id="l41.141"> #endif // nsAbWinHelper_h___</span>
<a href="#l41.142"></a><span id="l41.142"> </span>
<a href="#l41.143"></a><span id="l41.143"> </span>
<a href="#l41.144"></a><span id="l41.144"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l42.1"></a><span id="l42.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAddbookProtocolHandler.cpp</span>
<a href="#l42.2"></a><span id="l42.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAddbookProtocolHandler.cpp</span>
<a href="#l42.3"></a><span id="l42.3" class="difflineat">@@ -37,17 +37,17 @@ nsAddbookProtocolHandler::~nsAddbookProt</span>
<a href="#l42.4"></a><span id="l42.4"> {</span>
<a href="#l42.5"></a><span id="l42.5"> }</span>
<a href="#l42.6"></a><span id="l42.6"> </span>
<a href="#l42.7"></a><span id="l42.7"> NS_IMPL_ISUPPORTS(nsAddbookProtocolHandler, nsIProtocolHandler)</span>
<a href="#l42.8"></a><span id="l42.8"> </span>
<a href="#l42.9"></a><span id="l42.9"> NS_IMETHODIMP nsAddbookProtocolHandler::GetScheme(nsACString &amp;aScheme)</span>
<a href="#l42.10"></a><span id="l42.10"> {</span>
<a href="#l42.11"></a><span id="l42.11"> 	aScheme = &quot;addbook&quot;;</span>
<a href="#l42.12"></a><span id="l42.12" class="difflineminus">-	return NS_OK; </span>
<a href="#l42.13"></a><span id="l42.13" class="difflineplus">+	return NS_OK;</span>
<a href="#l42.14"></a><span id="l42.14"> }</span>
<a href="#l42.15"></a><span id="l42.15"> </span>
<a href="#l42.16"></a><span id="l42.16"> NS_IMETHODIMP nsAddbookProtocolHandler::GetDefaultPort(int32_t *aDefaultPort)</span>
<a href="#l42.17"></a><span id="l42.17"> {</span>
<a href="#l42.18"></a><span id="l42.18">   return NS_OK;</span>
<a href="#l42.19"></a><span id="l42.19"> }</span>
<a href="#l42.20"></a><span id="l42.20"> </span>
<a href="#l42.21"></a><span id="l42.21"> NS_IMETHODIMP nsAddbookProtocolHandler::GetProtocolFlags(uint32_t *aUritype)</span>
<a href="#l42.22"></a><span id="l42.22" class="difflineat">@@ -70,20 +70,20 @@ NS_IMETHODIMP nsAddbookProtocolHandler::</span>
<a href="#l42.23"></a><span id="l42.23"> </span>
<a href="#l42.24"></a><span id="l42.24">   nsCOMPtr&lt;nsIURI&gt; uri = do_QueryInterface(addbookUrl, &amp;rv);</span>
<a href="#l42.25"></a><span id="l42.25">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l42.26"></a><span id="l42.26"> </span>
<a href="#l42.27"></a><span id="l42.27">   uri.forget(_retval);</span>
<a href="#l42.28"></a><span id="l42.28">   return NS_OK;</span>
<a href="#l42.29"></a><span id="l42.29"> }</span>
<a href="#l42.30"></a><span id="l42.30"> </span>
<a href="#l42.31"></a><span id="l42.31" class="difflineminus">-NS_IMETHODIMP </span>
<a href="#l42.32"></a><span id="l42.32" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l42.33"></a><span id="l42.33"> nsAddbookProtocolHandler::AllowPort(int32_t port, const char *scheme, bool *_retval)</span>
<a href="#l42.34"></a><span id="l42.34"> {</span>
<a href="#l42.35"></a><span id="l42.35" class="difflineminus">-    // don't override anything.  </span>
<a href="#l42.36"></a><span id="l42.36" class="difflineplus">+    // don't override anything.</span>
<a href="#l42.37"></a><span id="l42.37">     *_retval = false;</span>
<a href="#l42.38"></a><span id="l42.38">     return NS_OK;</span>
<a href="#l42.39"></a><span id="l42.39"> }</span>
<a href="#l42.40"></a><span id="l42.40"> </span>
<a href="#l42.41"></a><span id="l42.41"> nsresult</span>
<a href="#l42.42"></a><span id="l42.42"> nsAddbookProtocolHandler::GenerateXMLOutputChannel( nsString &amp;aOutput,</span>
<a href="#l42.43"></a><span id="l42.43">                                                      nsIAddbookUrl *addbookUrl,</span>
<a href="#l42.44"></a><span id="l42.44">                                                      nsIURI *aURI,</span>
<a href="#l42.45"></a><span id="l42.45" class="difflineat">@@ -132,39 +132,39 @@ nsAddbookProtocolHandler::NewChannel(nsI</span>
<a href="#l42.46"></a><span id="l42.46"> NS_IMETHODIMP</span>
<a href="#l42.47"></a><span id="l42.47"> nsAddbookProtocolHandler::NewChannel2(nsIURI *aURI,</span>
<a href="#l42.48"></a><span id="l42.48">                                       nsILoadInfo* aLoadInfo,</span>
<a href="#l42.49"></a><span id="l42.49">                                       nsIChannel **_retval)</span>
<a href="#l42.50"></a><span id="l42.50"> {</span>
<a href="#l42.51"></a><span id="l42.51">   nsresult rv;</span>
<a href="#l42.52"></a><span id="l42.52">   nsCOMPtr &lt;nsIAddbookUrl&gt; addbookUrl = do_QueryInterface(aURI, &amp;rv);</span>
<a href="#l42.53"></a><span id="l42.53">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l42.54"></a><span id="l42.54" class="difflineminus">-  </span>
<a href="#l42.55"></a><span id="l42.55" class="difflineplus">+</span>
<a href="#l42.56"></a><span id="l42.56">   rv = addbookUrl-&gt;GetAddbookOperation(&amp;mAddbookOperation);</span>
<a href="#l42.57"></a><span id="l42.57">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l42.58"></a><span id="l42.58"> </span>
<a href="#l42.59"></a><span id="l42.59">   if (mAddbookOperation == nsIAddbookUrlOperation::InvalidUrl) {</span>
<a href="#l42.60"></a><span id="l42.60">     nsAutoString errorString;</span>
<a href="#l42.61"></a><span id="l42.61">     errorString.AssignLiteral(&quot;Unsupported format/operation requested for &quot;);</span>
<a href="#l42.62"></a><span id="l42.62">     nsAutoCString spec;</span>
<a href="#l42.63"></a><span id="l42.63">     rv = aURI-&gt;GetSpec(spec);</span>
<a href="#l42.64"></a><span id="l42.64">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l42.65"></a><span id="l42.65"> </span>
<a href="#l42.66"></a><span id="l42.66">      errorString.Append(NS_ConvertUTF8toUTF16(spec));</span>
<a href="#l42.67"></a><span id="l42.67">     rv = GenerateXMLOutputChannel(errorString, addbookUrl, aURI, aLoadInfo, _retval);</span>
<a href="#l42.68"></a><span id="l42.68">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l42.69"></a><span id="l42.69">     return NS_OK;</span>
<a href="#l42.70"></a><span id="l42.70">   }</span>
<a href="#l42.71"></a><span id="l42.71" class="difflineminus">- </span>
<a href="#l42.72"></a><span id="l42.72" class="difflineplus">+</span>
<a href="#l42.73"></a><span id="l42.73">   if (mAddbookOperation == nsIAddbookUrlOperation::AddVCard) {</span>
<a href="#l42.74"></a><span id="l42.74">       // create an empty pipe for use with the input stream channel.</span>
<a href="#l42.75"></a><span id="l42.75">       nsCOMPtr&lt;nsIAsyncInputStream&gt; pipeIn;</span>
<a href="#l42.76"></a><span id="l42.76">       nsCOMPtr&lt;nsIAsyncOutputStream&gt; pipeOut;</span>
<a href="#l42.77"></a><span id="l42.77">       nsCOMPtr&lt;nsIPipe&gt; pipe = do_CreateInstance(&quot;@mozilla.org/pipe;1&quot;);</span>
<a href="#l42.78"></a><span id="l42.78" class="difflineminus">-      </span>
<a href="#l42.79"></a><span id="l42.79" class="difflineplus">+</span>
<a href="#l42.80"></a><span id="l42.80">       rv = pipe-&gt;Init(false, false, 0, 0);</span>
<a href="#l42.81"></a><span id="l42.81">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l42.82"></a><span id="l42.82"> </span>
<a href="#l42.83"></a><span id="l42.83">       // These always succeed because the pipe is initialized above.</span>
<a href="#l42.84"></a><span id="l42.84">       MOZ_ALWAYS_SUCCEEDS(pipe-&gt;GetInputStream(getter_AddRefs(pipeIn)));</span>
<a href="#l42.85"></a><span id="l42.85">       MOZ_ALWAYS_SUCCEEDS(pipe-&gt;GetOutputStream(getter_AddRefs(pipeOut)));</span>
<a href="#l42.86"></a><span id="l42.86"> </span>
<a href="#l42.87"></a><span id="l42.87">       pipeOut-&gt;Close();</span>
<a href="#l42.88"></a><span id="l42.88" class="difflineat">@@ -196,57 +196,57 @@ nsAddbookProtocolHandler::NewChannel2(ns</span>
<a href="#l42.89"></a><span id="l42.89">   rv = GeneratePrintOutput(addbookUrl, output);</span>
<a href="#l42.90"></a><span id="l42.90">   if (NS_FAILED(rv)) {</span>
<a href="#l42.91"></a><span id="l42.91">     output.AssignLiteral(&quot;failed to print. url=&quot;);</span>
<a href="#l42.92"></a><span id="l42.92">     nsAutoCString spec;</span>
<a href="#l42.93"></a><span id="l42.93">     rv = aURI-&gt;GetSpec(spec);</span>
<a href="#l42.94"></a><span id="l42.94">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l42.95"></a><span id="l42.95">     output.Append(NS_ConvertUTF8toUTF16(spec));</span>
<a href="#l42.96"></a><span id="l42.96">   }</span>
<a href="#l42.97"></a><span id="l42.97" class="difflineminus">- </span>
<a href="#l42.98"></a><span id="l42.98" class="difflineplus">+</span>
<a href="#l42.99"></a><span id="l42.99">   rv = GenerateXMLOutputChannel(output, addbookUrl, aURI, aLoadInfo, _retval);</span>
<a href="#l42.100"></a><span id="l42.100">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l42.101"></a><span id="l42.101">   return NS_OK;</span>
<a href="#l42.102"></a><span id="l42.102"> }</span>
<a href="#l42.103"></a><span id="l42.103"> </span>
<a href="#l42.104"></a><span id="l42.104" class="difflineminus">-nsresult    </span>
<a href="#l42.105"></a><span id="l42.105" class="difflineminus">-nsAddbookProtocolHandler::GeneratePrintOutput(nsIAddbookUrl *addbookUrl, </span>
<a href="#l42.106"></a><span id="l42.106" class="difflineplus">+nsresult</span>
<a href="#l42.107"></a><span id="l42.107" class="difflineplus">+nsAddbookProtocolHandler::GeneratePrintOutput(nsIAddbookUrl *addbookUrl,</span>
<a href="#l42.108"></a><span id="l42.108">                                               nsString &amp;aOutput)</span>
<a href="#l42.109"></a><span id="l42.109"> {</span>
<a href="#l42.110"></a><span id="l42.110">   NS_ENSURE_ARG_POINTER(addbookUrl);</span>
<a href="#l42.111"></a><span id="l42.111"> </span>
<a href="#l42.112"></a><span id="l42.112">   nsAutoCString uri;</span>
<a href="#l42.113"></a><span id="l42.113">   nsresult rv = addbookUrl-&gt;GetPathQueryRef(uri);</span>
<a href="#l42.114"></a><span id="l42.114">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l42.115"></a><span id="l42.115"> </span>
<a href="#l42.116"></a><span id="l42.116">   /* turn</span>
<a href="#l42.117"></a><span id="l42.117">    &quot;//moz-abmdbdirectory/abook.mab?action=print&quot;</span>
<a href="#l42.118"></a><span id="l42.118">    into &quot;moz-abmdbdirectory://abook.mab&quot;</span>
<a href="#l42.119"></a><span id="l42.119">   */</span>
<a href="#l42.120"></a><span id="l42.120"> </span>
<a href="#l42.121"></a><span id="l42.121" class="difflineminus">-  /* step 1:  </span>
<a href="#l42.122"></a><span id="l42.122" class="difflineplus">+  /* step 1:</span>
<a href="#l42.123"></a><span id="l42.123">    turn &quot;//moz-abmdbdirectory/abook.mab?action=print&quot;</span>
<a href="#l42.124"></a><span id="l42.124">    into &quot;moz-abmdbdirectory/abook.mab?action=print&quot;</span>
<a href="#l42.125"></a><span id="l42.125">    */</span>
<a href="#l42.126"></a><span id="l42.126">   if (uri[0] != '/' &amp;&amp; uri[1] != '/')</span>
<a href="#l42.127"></a><span id="l42.127">     return NS_ERROR_UNEXPECTED;</span>
<a href="#l42.128"></a><span id="l42.128"> </span>
<a href="#l42.129"></a><span id="l42.129">   uri.Cut(0,2);</span>
<a href="#l42.130"></a><span id="l42.130"> </span>
<a href="#l42.131"></a><span id="l42.131" class="difflineminus">-  /* step 2:  </span>
<a href="#l42.132"></a><span id="l42.132" class="difflineplus">+  /* step 2:</span>
<a href="#l42.133"></a><span id="l42.133">    turn &quot;moz-abmdbdirectory/abook.mab?action=print&quot;</span>
<a href="#l42.134"></a><span id="l42.134">    into &quot;moz-abmdbdirectory/abook.mab&quot;</span>
<a href="#l42.135"></a><span id="l42.135">    */</span>
<a href="#l42.136"></a><span id="l42.136">   int32_t pos = uri.Find(&quot;?action=print&quot;);</span>
<a href="#l42.137"></a><span id="l42.137"> 	if (pos == -1)</span>
<a href="#l42.138"></a><span id="l42.138">     return NS_ERROR_UNEXPECTED;</span>
<a href="#l42.139"></a><span id="l42.139"> </span>
<a href="#l42.140"></a><span id="l42.140">   uri.SetLength(pos);</span>
<a href="#l42.141"></a><span id="l42.141"> </span>
<a href="#l42.142"></a><span id="l42.142" class="difflineminus">-  /* step 2:  </span>
<a href="#l42.143"></a><span id="l42.143" class="difflineplus">+  /* step 2:</span>
<a href="#l42.144"></a><span id="l42.144">    turn &quot;moz-abmdbdirectory/abook.mab&quot;</span>
<a href="#l42.145"></a><span id="l42.145">    into &quot;moz-abmdbdirectory://abook.mab&quot;</span>
<a href="#l42.146"></a><span id="l42.146">    */</span>
<a href="#l42.147"></a><span id="l42.147">   pos = uri.FindChar('/');</span>
<a href="#l42.148"></a><span id="l42.148">   if (pos == -1)</span>
<a href="#l42.149"></a><span id="l42.149">     return NS_ERROR_UNEXPECTED;</span>
<a href="#l42.150"></a><span id="l42.150"> </span>
<a href="#l42.151"></a><span id="l42.151">   uri.Insert('/', pos);</span>
<a href="#l42.152"></a><span id="l42.152" class="difflineat">@@ -261,22 +261,22 @@ nsAddbookProtocolHandler::GeneratePrintO</span>
<a href="#l42.153"></a><span id="l42.153"> </span>
<a href="#l42.154"></a><span id="l42.154">   rv = BuildDirectoryXML(directory, aOutput);</span>
<a href="#l42.155"></a><span id="l42.155">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l42.156"></a><span id="l42.156"> </span>
<a href="#l42.157"></a><span id="l42.157">   return NS_OK;</span>
<a href="#l42.158"></a><span id="l42.158"> }</span>
<a href="#l42.159"></a><span id="l42.159"> </span>
<a href="#l42.160"></a><span id="l42.160"> nsresult</span>
<a href="#l42.161"></a><span id="l42.161" class="difflineminus">-nsAddbookProtocolHandler::BuildDirectoryXML(nsIAbDirectory *aDirectory, </span>
<a href="#l42.162"></a><span id="l42.162" class="difflineplus">+nsAddbookProtocolHandler::BuildDirectoryXML(nsIAbDirectory *aDirectory,</span>
<a href="#l42.163"></a><span id="l42.163">                                        nsString &amp;aOutput)</span>
<a href="#l42.164"></a><span id="l42.164"> {</span>
<a href="#l42.165"></a><span id="l42.165">   NS_ENSURE_ARG_POINTER(aDirectory);</span>
<a href="#l42.166"></a><span id="l42.166"> </span>
<a href="#l42.167"></a><span id="l42.167" class="difflineminus">-  nsresult rv;    </span>
<a href="#l42.168"></a><span id="l42.168" class="difflineplus">+  nsresult rv;</span>
<a href="#l42.169"></a><span id="l42.169">   nsCOMPtr&lt;nsISimpleEnumerator&gt; cardsEnumerator;</span>
<a href="#l42.170"></a><span id="l42.170">   nsCOMPtr&lt;nsIAbCard&gt; card;</span>
<a href="#l42.171"></a><span id="l42.171"> </span>
<a href="#l42.172"></a><span id="l42.172">   aOutput.AppendLiteral(&quot;&lt;?xml version=\&quot;1.0\&quot;?&gt;\n&quot;</span>
<a href="#l42.173"></a><span id="l42.173">                         &quot;&lt;?xml-stylesheet type=\&quot;text/css\&quot; href=\&quot;chrome://messagebody/content/addressbook/print.css\&quot;?&gt;\n&quot;</span>
<a href="#l42.174"></a><span id="l42.174">                         &quot;&lt;directory&gt;\n&quot;);</span>
<a href="#l42.175"></a><span id="l42.175"> </span>
<a href="#l42.176"></a><span id="l42.176">   // Get Address Book string and set it as title of XML document</span>
<a href="#l42.177"></a><span id="l42.177" class="difflineat">@@ -295,28 +295,28 @@ nsAddbookProtocolHandler::BuildDirectory</span>
<a href="#l42.178"></a><span id="l42.178">       }</span>
<a href="#l42.179"></a><span id="l42.179">     }</span>
<a href="#l42.180"></a><span id="l42.180">   }</span>
<a href="#l42.181"></a><span id="l42.181"> </span>
<a href="#l42.182"></a><span id="l42.182">  // create a view and init it with the generated name sort order. Then, iterate</span>
<a href="#l42.183"></a><span id="l42.183">   // over the view, getting the card for each row, and printing them.</span>
<a href="#l42.184"></a><span id="l42.184">   nsString sortColumn;</span>
<a href="#l42.185"></a><span id="l42.185">   nsCOMPtr &lt;nsIAbView&gt; view = do_CreateInstance(&quot;@mozilla.org/addressbook/abview;1&quot;, &amp;rv);</span>
<a href="#l42.186"></a><span id="l42.186" class="difflineminus">-  </span>
<a href="#l42.187"></a><span id="l42.187" class="difflineplus">+</span>
<a href="#l42.188"></a><span id="l42.188">   view-&gt;SetView(aDirectory, nullptr, NS_LITERAL_STRING(&quot;GeneratedName&quot;),</span>
<a href="#l42.189"></a><span id="l42.189">                 NS_LITERAL_STRING(&quot;ascending&quot;), sortColumn);</span>
<a href="#l42.190"></a><span id="l42.190"> </span>
<a href="#l42.191"></a><span id="l42.191">   int32_t numRows;</span>
<a href="#l42.192"></a><span id="l42.192">   nsCOMPtr &lt;nsITreeView&gt; treeView = do_QueryInterface(view, &amp;rv);</span>
<a href="#l42.193"></a><span id="l42.193">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l42.194"></a><span id="l42.194">   treeView-&gt;GetRowCount(&amp;numRows);</span>
<a href="#l42.195"></a><span id="l42.195" class="difflineminus">-  </span>
<a href="#l42.196"></a><span id="l42.196" class="difflineplus">+</span>
<a href="#l42.197"></a><span id="l42.197">   for (int32_t row = 0; row &lt; numRows; row++)</span>
<a href="#l42.198"></a><span id="l42.198">   {</span>
<a href="#l42.199"></a><span id="l42.199" class="difflineminus">-    </span>
<a href="#l42.200"></a><span id="l42.200" class="difflineplus">+</span>
<a href="#l42.201"></a><span id="l42.201">     nsCOMPtr &lt;nsIAbCard&gt; card;</span>
<a href="#l42.202"></a><span id="l42.202">     view-&gt;GetCardFromRow(row, getter_AddRefs(card));</span>
<a href="#l42.203"></a><span id="l42.203">     nsCString xmlSubstr;</span>
<a href="#l42.204"></a><span id="l42.204"> </span>
<a href="#l42.205"></a><span id="l42.205">     rv = card-&gt;TranslateTo(NS_LITERAL_CSTRING(&quot;xml&quot;), xmlSubstr);</span>
<a href="#l42.206"></a><span id="l42.206">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l42.207"></a><span id="l42.207"> </span>
<a href="#l42.208"></a><span id="l42.208">     aOutput.AppendLiteral(&quot;&lt;separator/&gt;&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l43.1"></a><span id="l43.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAddbookProtocolHandler.h</span>
<a href="#l43.2"></a><span id="l43.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAddbookProtocolHandler.h</span>
<a href="#l43.3"></a><span id="l43.3" class="difflineat">@@ -24,22 +24,22 @@ public:</span>
<a href="#l43.4"></a><span id="l43.4">   // We support the nsIProtocolHandler interface.</span>
<a href="#l43.5"></a><span id="l43.5">   //////////////////////////////////////////////////////////////////////////</span>
<a href="#l43.6"></a><span id="l43.6">   NS_DECL_NSIPROTOCOLHANDLER</span>
<a href="#l43.7"></a><span id="l43.7"> </span>
<a href="#l43.8"></a><span id="l43.8"> private:</span>
<a href="#l43.9"></a><span id="l43.9"> 	virtual ~nsAddbookProtocolHandler();</span>
<a href="#l43.10"></a><span id="l43.10">   nsresult    GenerateXMLOutputChannel(nsString &amp;aOutput,</span>
<a href="#l43.11"></a><span id="l43.11">                                          nsIAddbookUrl *addbookUrl,</span>
<a href="#l43.12"></a><span id="l43.12" class="difflineminus">-                                         nsIURI *aURI, </span>
<a href="#l43.13"></a><span id="l43.13" class="difflineplus">+                                         nsIURI *aURI,</span>
<a href="#l43.14"></a><span id="l43.14">                                          nsILoadInfo *aLoadInfo,</span>
<a href="#l43.15"></a><span id="l43.15">                                          nsIChannel **_retval);</span>
<a href="#l43.16"></a><span id="l43.16"> </span>
<a href="#l43.17"></a><span id="l43.17" class="difflineminus">-  nsresult    GeneratePrintOutput(nsIAddbookUrl *addbookUrl, </span>
<a href="#l43.18"></a><span id="l43.18" class="difflineplus">+  nsresult    GeneratePrintOutput(nsIAddbookUrl *addbookUrl,</span>
<a href="#l43.19"></a><span id="l43.19">                                    nsString &amp;aOutput);</span>
<a href="#l43.20"></a><span id="l43.20"> </span>
<a href="#l43.21"></a><span id="l43.21" class="difflineminus">-  nsresult    BuildDirectoryXML(nsIAbDirectory *aDirectory, </span>
<a href="#l43.22"></a><span id="l43.22" class="difflineplus">+  nsresult    BuildDirectoryXML(nsIAbDirectory *aDirectory,</span>
<a href="#l43.23"></a><span id="l43.23">                                    nsString &amp;aOutput);</span>
<a href="#l43.24"></a><span id="l43.24"> </span>
<a href="#l43.25"></a><span id="l43.25">   int32_t     mAddbookOperation;</span>
<a href="#l43.26"></a><span id="l43.26"> };</span>
<a href="#l43.27"></a><span id="l43.27"> </span>
<a href="#l43.28"></a><span id="l43.28"> #endif /* nsAddbookProtocolHandler_h___ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l44.1"></a><span id="l44.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAddrDatabase.cpp</span>
<a href="#l44.2"></a><span id="l44.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAddrDatabase.cpp</span>
<a href="#l44.3"></a><span id="l44.3" class="difflineat">@@ -1059,25 +1059,25 @@ nsresult nsAddrDatabase::AddAttributeCol</span>
<a href="#l44.4"></a><span id="l44.4">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l44.5"></a><span id="l44.5"> </span>
<a href="#l44.6"></a><span id="l44.6">       nsCOMPtr&lt;nsIProperty&gt; prop = do_QueryInterface(next);</span>
<a href="#l44.7"></a><span id="l44.7">       nsAutoString name;</span>
<a href="#l44.8"></a><span id="l44.8">       prop-&gt;GetName(name);</span>
<a href="#l44.9"></a><span id="l44.9"> </span>
<a href="#l44.10"></a><span id="l44.10">       nsCOMPtr&lt;nsIVariant&gt; variant;</span>
<a href="#l44.11"></a><span id="l44.11">       prop-&gt;GetValue(getter_AddRefs(variant));</span>
<a href="#l44.12"></a><span id="l44.12" class="difflineminus">-      </span>
<a href="#l44.13"></a><span id="l44.13" class="difflineplus">+</span>
<a href="#l44.14"></a><span id="l44.14">       // We can't get as a char * because that messes up UTF8 stuff</span>
<a href="#l44.15"></a><span id="l44.15">       nsAutoCString value;</span>
<a href="#l44.16"></a><span id="l44.16">       variant-&gt;GetAsAUTF8String(value);</span>
<a href="#l44.17"></a><span id="l44.17"> </span>
<a href="#l44.18"></a><span id="l44.18">       mdb_token token;</span>
<a href="#l44.19"></a><span id="l44.19">       rv = m_mdbStore-&gt;StringToToken(m_mdbEnv, NS_ConvertUTF16toUTF8(name).get(), &amp;token);</span>
<a href="#l44.20"></a><span id="l44.20">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l44.21"></a><span id="l44.21" class="difflineminus">- </span>
<a href="#l44.22"></a><span id="l44.22" class="difflineplus">+</span>
<a href="#l44.23"></a><span id="l44.23">       rv = AddCharStringColumn(cardRow, token, value.get());</span>
<a href="#l44.24"></a><span id="l44.24">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l44.25"></a><span id="l44.25">     }</span>
<a href="#l44.26"></a><span id="l44.26"> </span>
<a href="#l44.27"></a><span id="l44.27">     // Primary email is special: it is stored lowercase as well as in its</span>
<a href="#l44.28"></a><span id="l44.28">     // original format.</span>
<a href="#l44.29"></a><span id="l44.29">     nsAutoString primaryEmail;</span>
<a href="#l44.30"></a><span id="l44.30">     card-&gt;GetPrimaryEmail(primaryEmail);</span>
<a href="#l44.31"></a><span id="l44.31" class="difflineat">@@ -1136,17 +1136,17 @@ NS_IMETHODIMP nsAddrDatabase::CreateNewC</span>
<a href="#l44.32"></a><span id="l44.32">     AddAttributeColumnsToRow(aNewCard, cardRow);</span>
<a href="#l44.33"></a><span id="l44.33">     AddRecordKeyColumnToRow(cardRow);</span>
<a href="#l44.34"></a><span id="l44.34"> </span>
<a href="#l44.35"></a><span id="l44.35">     // we need to do this for dnd</span>
<a href="#l44.36"></a><span id="l44.36">     uint32_t key = 0;</span>
<a href="#l44.37"></a><span id="l44.37">     rv = GetIntColumn(cardRow, m_RecordKeyColumnToken, &amp;key, 0);</span>
<a href="#l44.38"></a><span id="l44.38">     if (NS_SUCCEEDED(rv))</span>
<a href="#l44.39"></a><span id="l44.39">       aNewCard-&gt;SetPropertyAsUint32(kRecordKeyColumn, key);</span>
<a href="#l44.40"></a><span id="l44.40" class="difflineminus">-    </span>
<a href="#l44.41"></a><span id="l44.41" class="difflineplus">+</span>
<a href="#l44.42"></a><span id="l44.42">     aNewCard-&gt;GetPropertyAsAUTF8String(kRowIDProperty, id);</span>
<a href="#l44.43"></a><span id="l44.43">     aNewCard-&gt;SetLocalId(id);</span>
<a href="#l44.44"></a><span id="l44.44"> </span>
<a href="#l44.45"></a><span id="l44.45">     nsCOMPtr&lt;nsIAbDirectory&gt; abDir = do_QueryReferent(m_dbDirectory);</span>
<a href="#l44.46"></a><span id="l44.46">     if (abDir)</span>
<a href="#l44.47"></a><span id="l44.47">       abDir-&gt;GetUuid(id);</span>
<a href="#l44.48"></a><span id="l44.48"> </span>
<a href="#l44.49"></a><span id="l44.49">     aNewCard-&gt;SetDirectoryId(id);</span>
<a href="#l44.50"></a><span id="l44.50" class="difflineat">@@ -2201,17 +2201,17 @@ NS_IMETHODIMP nsAddrDatabase::InitCardFr</span>
<a href="#l44.51"></a><span id="l44.51">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l44.52"></a><span id="l44.52"> </span>
<a href="#l44.53"></a><span id="l44.53">       char *name = PL_strndup(static_cast&lt;char *&gt;(colYarn.mYarn_Buf),</span>
<a href="#l44.54"></a><span id="l44.54">           colYarn.mYarn_Fill);</span>
<a href="#l44.55"></a><span id="l44.55">       newCard-&gt;SetPropertyAsAString(name, value);</span>
<a href="#l44.56"></a><span id="l44.56">       PL_strfree(name);</span>
<a href="#l44.57"></a><span id="l44.57">     }</span>
<a href="#l44.58"></a><span id="l44.58">   } while (true);</span>
<a href="#l44.59"></a><span id="l44.59" class="difflineminus">- </span>
<a href="#l44.60"></a><span id="l44.60" class="difflineplus">+</span>
<a href="#l44.61"></a><span id="l44.61">   uint32_t key = 0;</span>
<a href="#l44.62"></a><span id="l44.62">   rv = GetIntColumn(cardRow, m_RecordKeyColumnToken, &amp;key, 0);</span>
<a href="#l44.63"></a><span id="l44.63">   if (NS_SUCCEEDED(rv))</span>
<a href="#l44.64"></a><span id="l44.64">     newCard-&gt;SetPropertyAsUint32(kRecordKeyColumn, key);</span>
<a href="#l44.65"></a><span id="l44.65"> </span>
<a href="#l44.66"></a><span id="l44.66">   return NS_OK;</span>
<a href="#l44.67"></a><span id="l44.67"> }</span>
<a href="#l44.68"></a><span id="l44.68"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l45.1"></a><span id="l45.1" class="difflineminus">--- a/mailnews/addrbook/src/nsDirPrefs.cpp</span>
<a href="#l45.2"></a><span id="l45.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsDirPrefs.cpp</span>
<a href="#l45.3"></a><span id="l45.3" class="difflineat">@@ -57,17 +57,17 @@ static void DIR_GetPrefsForOneServer(DIR</span>
<a href="#l45.4"></a><span id="l45.4"> </span>
<a href="#l45.5"></a><span id="l45.5"> static void DIR_InitServer(DIR_Server *server, DirectoryType dirType = (DirectoryType)0);</span>
<a href="#l45.6"></a><span id="l45.6"> static DIR_PrefId  DIR_AtomizePrefName(const char *prefname);</span>
<a href="#l45.7"></a><span id="l45.7"> </span>
<a href="#l45.8"></a><span id="l45.8"> const int32_t DIR_POS_APPEND = -1;</span>
<a href="#l45.9"></a><span id="l45.9"> const int32_t DIR_POS_DELETE = -2;</span>
<a href="#l45.10"></a><span id="l45.10"> static bool DIR_SetServerPosition(nsTArray&lt;DIR_Server*&gt; *wholeList, DIR_Server *server, int32_t position);</span>
<a href="#l45.11"></a><span id="l45.11"> </span>
<a href="#l45.12"></a><span id="l45.12" class="difflineminus">-/* These two routines should be called to initialize and save </span>
<a href="#l45.13"></a><span id="l45.13" class="difflineplus">+/* These two routines should be called to initialize and save</span>
<a href="#l45.14"></a><span id="l45.14">  * directory preferences from the XP Java Script preferences</span>
<a href="#l45.15"></a><span id="l45.15">  */</span>
<a href="#l45.16"></a><span id="l45.16"> static nsresult DIR_GetServerPreferences(nsTArray&lt;DIR_Server*&gt;** list);</span>
<a href="#l45.17"></a><span id="l45.17"> static void DIR_SaveServerPreferences(nsTArray&lt;DIR_Server*&gt; *wholeList);</span>
<a href="#l45.18"></a><span id="l45.18"> </span>
<a href="#l45.19"></a><span id="l45.19"> static int32_t dir_UserId = 0;</span>
<a href="#l45.20"></a><span id="l45.20"> nsTArray&lt;DIR_Server*&gt; *dir_ServerList = nullptr;</span>
<a href="#l45.21"></a><span id="l45.21"> </span>
<a href="#l45.22"></a><span id="l45.22" class="difflineat">@@ -152,17 +152,17 @@ NS_IMETHODIMP DirPrefObserver::Observe(n</span>
<a href="#l45.23"></a><span id="l45.23"> static RefPtr&lt;DirPrefObserver&gt; prefObserver;</span>
<a href="#l45.24"></a><span id="l45.24"> </span>
<a href="#l45.25"></a><span id="l45.25"> static nsresult DIR_GetDirServers()</span>
<a href="#l45.26"></a><span id="l45.26"> {</span>
<a href="#l45.27"></a><span id="l45.27">   nsresult rv = NS_OK;</span>
<a href="#l45.28"></a><span id="l45.28"> </span>
<a href="#l45.29"></a><span id="l45.29">   if (!dir_ServerList)</span>
<a href="#l45.30"></a><span id="l45.30">   {</span>
<a href="#l45.31"></a><span id="l45.31" class="difflineminus">-    /* we need to build the DIR_Server list */ </span>
<a href="#l45.32"></a><span id="l45.32" class="difflineplus">+    /* we need to build the DIR_Server list */</span>
<a href="#l45.33"></a><span id="l45.33">     rv = DIR_GetServerPreferences(&amp;dir_ServerList);</span>
<a href="#l45.34"></a><span id="l45.34"> </span>
<a href="#l45.35"></a><span id="l45.35">     /* Register the preference call back if necessary. */</span>
<a href="#l45.36"></a><span id="l45.36">     if (NS_SUCCEEDED(rv) &amp;&amp; !prefObserver)</span>
<a href="#l45.37"></a><span id="l45.37">     {</span>
<a href="#l45.38"></a><span id="l45.38">       nsCOMPtr&lt;nsIPrefBranch&gt; pbi(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l45.39"></a><span id="l45.39">       if (NS_FAILED(rv))</span>
<a href="#l45.40"></a><span id="l45.40">         return rv;</span>
<a href="#l45.41"></a><span id="l45.41" class="difflineat">@@ -253,55 +253,55 @@ nsresult DIR_ContainsServer(DIR_Server* </span>
<a href="#l45.42"></a><span id="l45.42">     }</span>
<a href="#l45.43"></a><span id="l45.43">   }</span>
<a href="#l45.44"></a><span id="l45.44">   *hasDir = false;</span>
<a href="#l45.45"></a><span id="l45.45">   return NS_OK;</span>
<a href="#l45.46"></a><span id="l45.46"> }</span>
<a href="#l45.47"></a><span id="l45.47"> </span>
<a href="#l45.48"></a><span id="l45.48"> nsresult DIR_AddNewAddressBook(const nsAString &amp;dirName,</span>
<a href="#l45.49"></a><span id="l45.49">                                const nsACString &amp;fileName,</span>
<a href="#l45.50"></a><span id="l45.50" class="difflineminus">-                               const nsACString &amp;uri, </span>
<a href="#l45.51"></a><span id="l45.51" class="difflineplus">+                               const nsACString &amp;uri,</span>
<a href="#l45.52"></a><span id="l45.52">                                DirectoryType dirType,</span>
<a href="#l45.53"></a><span id="l45.53">                                const nsACString &amp;prefName,</span>
<a href="#l45.54"></a><span id="l45.54">                                DIR_Server** pServer)</span>
<a href="#l45.55"></a><span id="l45.55"> {</span>
<a href="#l45.56"></a><span id="l45.56">   DIR_Server * server = (DIR_Server *) PR_Malloc(sizeof(DIR_Server));</span>
<a href="#l45.57"></a><span id="l45.57">   if (!server)</span>
<a href="#l45.58"></a><span id="l45.58">     return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l45.59"></a><span id="l45.59"> </span>
<a href="#l45.60"></a><span id="l45.60">   DIR_InitServer(server, dirType);</span>
<a href="#l45.61"></a><span id="l45.61">   if (!dir_ServerList)</span>
<a href="#l45.62"></a><span id="l45.62">     DIR_GetDirServers();</span>
<a href="#l45.63"></a><span id="l45.63">   if (dir_ServerList)</span>
<a href="#l45.64"></a><span id="l45.64">   {</span>
<a href="#l45.65"></a><span id="l45.65">     server-&gt;description = ToNewCString(NS_ConvertUTF16toUTF8(dirName));</span>
<a href="#l45.66"></a><span id="l45.66">     server-&gt;position = kDefaultPosition; // don't set position so alphabetic sort will happen.</span>
<a href="#l45.67"></a><span id="l45.67" class="difflineminus">-    </span>
<a href="#l45.68"></a><span id="l45.68" class="difflineplus">+</span>
<a href="#l45.69"></a><span id="l45.69">     if (!fileName.IsEmpty())</span>
<a href="#l45.70"></a><span id="l45.70">       server-&gt;fileName = ToNewCString(fileName);</span>
<a href="#l45.71"></a><span id="l45.71" class="difflineminus">-    else if (dirType == PABDirectory) </span>
<a href="#l45.72"></a><span id="l45.72" class="difflineplus">+    else if (dirType == PABDirectory)</span>
<a href="#l45.73"></a><span id="l45.73">       DIR_SetFileName(&amp;server-&gt;fileName, kPersonalAddressbook);</span>
<a href="#l45.74"></a><span id="l45.74">     else if (dirType == LDAPDirectory)</span>
<a href="#l45.75"></a><span id="l45.75">       DIR_SetFileName(&amp;server-&gt;fileName, kMainLdapAddressBook);</span>
<a href="#l45.76"></a><span id="l45.76"> </span>
<a href="#l45.77"></a><span id="l45.77">     if (dirType != PABDirectory) {</span>
<a href="#l45.78"></a><span id="l45.78">       if (!uri.IsEmpty())</span>
<a href="#l45.79"></a><span id="l45.79">         server-&gt;uri = ToNewCString(uri);</span>
<a href="#l45.80"></a><span id="l45.80">     }</span>
<a href="#l45.81"></a><span id="l45.81"> </span>
<a href="#l45.82"></a><span id="l45.82">     if (!prefName.IsEmpty())</span>
<a href="#l45.83"></a><span id="l45.83">       server-&gt;prefName = ToNewCString(prefName);</span>
<a href="#l45.84"></a><span id="l45.84"> </span>
<a href="#l45.85"></a><span id="l45.85">     dir_ServerList-&gt;AppendElement(server);</span>
<a href="#l45.86"></a><span id="l45.86"> </span>
<a href="#l45.87"></a><span id="l45.87" class="difflineminus">-    DIR_SavePrefsForOneServer(server); </span>
<a href="#l45.88"></a><span id="l45.88" class="difflineplus">+    DIR_SavePrefsForOneServer(server);</span>
<a href="#l45.89"></a><span id="l45.89"> </span>
<a href="#l45.90"></a><span id="l45.90">     *pServer = server;</span>
<a href="#l45.91"></a><span id="l45.91" class="difflineminus">-    </span>
<a href="#l45.92"></a><span id="l45.92" class="difflineminus">-    // save new address book into pref file </span>
<a href="#l45.93"></a><span id="l45.93" class="difflineplus">+</span>
<a href="#l45.94"></a><span id="l45.94" class="difflineplus">+    // save new address book into pref file</span>
<a href="#l45.95"></a><span id="l45.95">     return SavePrefsFile();</span>
<a href="#l45.96"></a><span id="l45.96">   }</span>
<a href="#l45.97"></a><span id="l45.97">   return NS_ERROR_FAILURE;</span>
<a href="#l45.98"></a><span id="l45.98"> }</span>
<a href="#l45.99"></a><span id="l45.99"> </span>
<a href="#l45.100"></a><span id="l45.100"> /*****************************************************************************</span>
<a href="#l45.101"></a><span id="l45.101">  * Functions for creating DIR_Servers</span>
<a href="#l45.102"></a><span id="l45.102">  */</span>
<a href="#l45.103"></a><span id="l45.103" class="difflineat">@@ -335,17 +335,17 @@ static void DIR_InitServer(DIR_Server *s</span>
<a href="#l45.104"></a><span id="l45.104">  */</span>
<a href="#l45.105"></a><span id="l45.105"> static bool DIR_SetServerPosition(nsTArray&lt;DIR_Server*&gt; *wholeList, DIR_Server *server, int32_t position)</span>
<a href="#l45.106"></a><span id="l45.106">  {</span>
<a href="#l45.107"></a><span id="l45.107">    NS_ENSURE_TRUE(wholeList, false);</span>
<a href="#l45.108"></a><span id="l45.108"> </span>
<a href="#l45.109"></a><span id="l45.109">    int32_t    i, count, num;</span>
<a href="#l45.110"></a><span id="l45.110">    bool       resort = false;</span>
<a href="#l45.111"></a><span id="l45.111">    DIR_Server *s=nullptr;</span>
<a href="#l45.112"></a><span id="l45.112" class="difflineminus">-   </span>
<a href="#l45.113"></a><span id="l45.113" class="difflineplus">+</span>
<a href="#l45.114"></a><span id="l45.114">    switch (position) {</span>
<a href="#l45.115"></a><span id="l45.115">    case DIR_POS_APPEND:</span>
<a href="#l45.116"></a><span id="l45.116">    /* Do nothing if the request is to append a server that is already</span>
<a href="#l45.117"></a><span id="l45.117">      * in the list.</span>
<a href="#l45.118"></a><span id="l45.118">      */</span>
<a href="#l45.119"></a><span id="l45.119">      count = wholeList-&gt;Length();</span>
<a href="#l45.120"></a><span id="l45.120">      for (i= 0; i &lt; count; i++)</span>
<a href="#l45.121"></a><span id="l45.121">      {</span>
<a href="#l45.122"></a><span id="l45.122" class="difflineat">@@ -359,20 +359,20 @@ static bool DIR_SetServerPosition(nsTArr</span>
<a href="#l45.123"></a><span id="l45.123">      */</span>
<a href="#l45.124"></a><span id="l45.124">      if (count &gt; 0)</span>
<a href="#l45.125"></a><span id="l45.125">      {</span>
<a href="#l45.126"></a><span id="l45.126">        s = wholeList-&gt;ElementAt(count - 1);</span>
<a href="#l45.127"></a><span id="l45.127">        server-&gt;position = s-&gt;position + 1;</span>
<a href="#l45.128"></a><span id="l45.128">      }</span>
<a href="#l45.129"></a><span id="l45.129">      else</span>
<a href="#l45.130"></a><span id="l45.130">        server-&gt;position = 1;</span>
<a href="#l45.131"></a><span id="l45.131" class="difflineminus">-     </span>
<a href="#l45.132"></a><span id="l45.132" class="difflineplus">+</span>
<a href="#l45.133"></a><span id="l45.133">      wholeList-&gt;AppendElement(server);</span>
<a href="#l45.134"></a><span id="l45.134">      break;</span>
<a href="#l45.135"></a><span id="l45.135" class="difflineminus">-     </span>
<a href="#l45.136"></a><span id="l45.136" class="difflineplus">+</span>
<a href="#l45.137"></a><span id="l45.137">    case DIR_POS_DELETE:</span>
<a href="#l45.138"></a><span id="l45.138">        /* Remove the prefs corresponding to the given server.  If the prefName</span>
<a href="#l45.139"></a><span id="l45.139">        * value is nullptr, the server has never been saved and there are no</span>
<a href="#l45.140"></a><span id="l45.140">        * prefs to remove.</span>
<a href="#l45.141"></a><span id="l45.141">      */</span>
<a href="#l45.142"></a><span id="l45.142">      if (server-&gt;prefName)</span>
<a href="#l45.143"></a><span id="l45.143">      {</span>
<a href="#l45.144"></a><span id="l45.144">        nsresult rv;</span>
<a href="#l45.145"></a><span id="l45.145" class="difflineat">@@ -380,17 +380,17 @@ static bool DIR_SetServerPosition(nsTArr</span>
<a href="#l45.146"></a><span id="l45.146">        if (NS_FAILED(rv))</span>
<a href="#l45.147"></a><span id="l45.147">          return false;</span>
<a href="#l45.148"></a><span id="l45.148"> </span>
<a href="#l45.149"></a><span id="l45.149">        pPref-&gt;DeleteBranch(server-&gt;prefName);</span>
<a href="#l45.150"></a><span id="l45.150"> </span>
<a href="#l45.151"></a><span id="l45.151">        // mark the server as deleted by setting its position to 0</span>
<a href="#l45.152"></a><span id="l45.152">        DIR_SetIntPref(server-&gt;prefName, &quot;position&quot;, 0, -1);</span>
<a href="#l45.153"></a><span id="l45.153">      }</span>
<a href="#l45.154"></a><span id="l45.154" class="difflineminus">-     </span>
<a href="#l45.155"></a><span id="l45.155" class="difflineplus">+</span>
<a href="#l45.156"></a><span id="l45.156">      /* If the server is in the server list, remove it.</span>
<a href="#l45.157"></a><span id="l45.157">      */</span>
<a href="#l45.158"></a><span id="l45.158">      num = wholeList-&gt;IndexOf(server);</span>
<a href="#l45.159"></a><span id="l45.159">      if (num &gt;= 0)</span>
<a href="#l45.160"></a><span id="l45.160">      {</span>
<a href="#l45.161"></a><span id="l45.161">      /* The list does not need to be re-sorted if the server is the</span>
<a href="#l45.162"></a><span id="l45.162">      * last one in the list.</span>
<a href="#l45.163"></a><span id="l45.163">        */</span>
<a href="#l45.164"></a><span id="l45.164" class="difflineat">@@ -401,53 +401,53 @@ static bool DIR_SetServerPosition(nsTArr</span>
<a href="#l45.165"></a><span id="l45.165">        }</span>
<a href="#l45.166"></a><span id="l45.166">        else</span>
<a href="#l45.167"></a><span id="l45.167">        {</span>
<a href="#l45.168"></a><span id="l45.168">          resort = true;</span>
<a href="#l45.169"></a><span id="l45.169">          wholeList-&gt;RemoveElement(server);</span>
<a href="#l45.170"></a><span id="l45.170">        }</span>
<a href="#l45.171"></a><span id="l45.171">      }</span>
<a href="#l45.172"></a><span id="l45.172">      break;</span>
<a href="#l45.173"></a><span id="l45.173" class="difflineminus">-     </span>
<a href="#l45.174"></a><span id="l45.174" class="difflineplus">+</span>
<a href="#l45.175"></a><span id="l45.175">    default:</span>
<a href="#l45.176"></a><span id="l45.176">    /* See if the server is already in the list.</span>
<a href="#l45.177"></a><span id="l45.177">      */</span>
<a href="#l45.178"></a><span id="l45.178">      count = wholeList-&gt;Length();</span>
<a href="#l45.179"></a><span id="l45.179">      for (i= 0; i &lt; count; i++)</span>
<a href="#l45.180"></a><span id="l45.180">      {</span>
<a href="#l45.181"></a><span id="l45.181">        if  ((s = wholeList-&gt;ElementAt(i)) != nullptr)</span>
<a href="#l45.182"></a><span id="l45.182">          if (s == server)</span>
<a href="#l45.183"></a><span id="l45.183">            break;</span>
<a href="#l45.184"></a><span id="l45.184">      }</span>
<a href="#l45.185"></a><span id="l45.185" class="difflineminus">-     </span>
<a href="#l45.186"></a><span id="l45.186" class="difflineplus">+</span>
<a href="#l45.187"></a><span id="l45.187">      /* If the server is not in the list, add it to the beginning and re-sort.</span>
<a href="#l45.188"></a><span id="l45.188">      */</span>
<a href="#l45.189"></a><span id="l45.189">      if (s == nullptr)</span>
<a href="#l45.190"></a><span id="l45.190">      {</span>
<a href="#l45.191"></a><span id="l45.191">        server-&gt;position = position;</span>
<a href="#l45.192"></a><span id="l45.192">        wholeList-&gt;AppendElement(server);</span>
<a href="#l45.193"></a><span id="l45.193">        resort = true;</span>
<a href="#l45.194"></a><span id="l45.194">      }</span>
<a href="#l45.195"></a><span id="l45.195" class="difflineminus">-     </span>
<a href="#l45.196"></a><span id="l45.196" class="difflineplus">+</span>
<a href="#l45.197"></a><span id="l45.197">        /* Don't re-sort if the server is already in the requested position.</span>
<a href="#l45.198"></a><span id="l45.198">      */</span>
<a href="#l45.199"></a><span id="l45.199">      else if (server-&gt;position != position)</span>
<a href="#l45.200"></a><span id="l45.200">      {</span>
<a href="#l45.201"></a><span id="l45.201">        server-&gt;position = position;</span>
<a href="#l45.202"></a><span id="l45.202">        wholeList-&gt;RemoveElement(server);</span>
<a href="#l45.203"></a><span id="l45.203">        wholeList-&gt;AppendElement(server);</span>
<a href="#l45.204"></a><span id="l45.204">        resort = true;</span>
<a href="#l45.205"></a><span id="l45.205">      }</span>
<a href="#l45.206"></a><span id="l45.206">      break;</span>
<a href="#l45.207"></a><span id="l45.207">         }</span>
<a href="#l45.208"></a><span id="l45.208" class="difflineminus">-        </span>
<a href="#l45.209"></a><span id="l45.209" class="difflineplus">+</span>
<a href="#l45.210"></a><span id="l45.210">         /* Make sure our position changes get saved back to prefs</span>
<a href="#l45.211"></a><span id="l45.211">         */</span>
<a href="#l45.212"></a><span id="l45.212">         DIR_SaveServerPreferences(wholeList);</span>
<a href="#l45.213"></a><span id="l45.213" class="difflineminus">-        </span>
<a href="#l45.214"></a><span id="l45.214" class="difflineplus">+</span>
<a href="#l45.215"></a><span id="l45.215">         return resort;</span>
<a href="#l45.216"></a><span id="l45.216"> }</span>
<a href="#l45.217"></a><span id="l45.217"> </span>
<a href="#l45.218"></a><span id="l45.218"> /*****************************************************************************</span>
<a href="#l45.219"></a><span id="l45.219">  * DIR_Server Callback Notification Functions</span>
<a href="#l45.220"></a><span id="l45.220">  */</span>
<a href="#l45.221"></a><span id="l45.221"> </span>
<a href="#l45.222"></a><span id="l45.222"> /* dir_matchServerPrefToServer</span>
<a href="#l45.223"></a><span id="l45.223" class="difflineat">@@ -576,17 +576,17 @@ static DIR_PrefId DIR_AtomizePrefName(co</span>
<a href="#l45.224"></a><span id="l45.224">     rc = idUri;</span>
<a href="#l45.225"></a><span id="l45.225">     break;</span>
<a href="#l45.226"></a><span id="l45.226">   }</span>
<a href="#l45.227"></a><span id="l45.227"> </span>
<a href="#l45.228"></a><span id="l45.228">   return rc;</span>
<a href="#l45.229"></a><span id="l45.229"> }</span>
<a href="#l45.230"></a><span id="l45.230"> </span>
<a href="#l45.231"></a><span id="l45.231"> /*****************************************************************************</span>
<a href="#l45.232"></a><span id="l45.232" class="difflineminus">- * Functions for destroying DIR_Servers </span>
<a href="#l45.233"></a><span id="l45.233" class="difflineplus">+ * Functions for destroying DIR_Servers</span>
<a href="#l45.234"></a><span id="l45.234">  */</span>
<a href="#l45.235"></a><span id="l45.235"> </span>
<a href="#l45.236"></a><span id="l45.236"> /* this function determines if the passed in server is no longer part of the of</span>
<a href="#l45.237"></a><span id="l45.237">    the global server list. */</span>
<a href="#l45.238"></a><span id="l45.238"> static bool dir_IsServerDeleted(DIR_Server * server)</span>
<a href="#l45.239"></a><span id="l45.239"> {</span>
<a href="#l45.240"></a><span id="l45.240">   return (server &amp;&amp; server-&gt;position == 0);</span>
<a href="#l45.241"></a><span id="l45.241"> }</span>
<a href="#l45.242"></a><span id="l45.242" class="difflineat">@@ -616,38 +616,38 @@ static void DIR_DeleteServer(DIR_Server </span>
<a href="#l45.243"></a><span id="l45.243"> nsresult DIR_DeleteServerFromList(DIR_Server *server)</span>
<a href="#l45.244"></a><span id="l45.244"> {</span>
<a href="#l45.245"></a><span id="l45.245">   if (!server)</span>
<a href="#l45.246"></a><span id="l45.246">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l45.247"></a><span id="l45.247"> </span>
<a href="#l45.248"></a><span id="l45.248">   nsresult rv = NS_OK;</span>
<a href="#l45.249"></a><span id="l45.249">   nsCOMPtr&lt;nsIFile&gt; dbPath;</span>
<a href="#l45.250"></a><span id="l45.250"> </span>
<a href="#l45.251"></a><span id="l45.251" class="difflineminus">-  nsCOMPtr&lt;nsIAbManager&gt; abManager = do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv); </span>
<a href="#l45.252"></a><span id="l45.252" class="difflineplus">+  nsCOMPtr&lt;nsIAbManager&gt; abManager = do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l45.253"></a><span id="l45.253">   if (NS_SUCCEEDED(rv))</span>
<a href="#l45.254"></a><span id="l45.254">     rv = abManager-&gt;GetUserProfileDirectory(getter_AddRefs(dbPath));</span>
<a href="#l45.255"></a><span id="l45.255" class="difflineminus">-  </span>
<a href="#l45.256"></a><span id="l45.256" class="difflineplus">+</span>
<a href="#l45.257"></a><span id="l45.257">   if (NS_SUCCEEDED(rv))</span>
<a href="#l45.258"></a><span id="l45.258">   {</span>
<a href="#l45.259"></a><span id="l45.259" class="difflineminus">-    // close the database, as long as it isn't the special ones </span>
<a href="#l45.260"></a><span id="l45.260" class="difflineplus">+    // close the database, as long as it isn't the special ones</span>
<a href="#l45.261"></a><span id="l45.261">     // (personal addressbook and collected addressbook)</span>
<a href="#l45.262"></a><span id="l45.262">     // which can never be deleted.  There was a bug where we would slap in</span>
<a href="#l45.263"></a><span id="l45.263">     // &quot;abook.mab&quot; as the file name for LDAP directories, which would cause a crash</span>
<a href="#l45.264"></a><span id="l45.264">     // on delete of LDAP directories.  this is just extra protection.</span>
<a href="#l45.265"></a><span id="l45.265">     if (server-&gt;fileName &amp;&amp;</span>
<a href="#l45.266"></a><span id="l45.266" class="difflineminus">-        strcmp(server-&gt;fileName, kPersonalAddressbook) &amp;&amp; </span>
<a href="#l45.267"></a><span id="l45.267" class="difflineplus">+        strcmp(server-&gt;fileName, kPersonalAddressbook) &amp;&amp;</span>
<a href="#l45.268"></a><span id="l45.268">         strcmp(server-&gt;fileName, kCollectedAddressbook))</span>
<a href="#l45.269"></a><span id="l45.269">     {</span>
<a href="#l45.270"></a><span id="l45.270">       nsCOMPtr&lt;nsIAddrDatabase&gt; database;</span>
<a href="#l45.271"></a><span id="l45.271"> </span>
<a href="#l45.272"></a><span id="l45.272">       rv = dbPath-&gt;AppendNative(nsDependentCString(server-&gt;fileName));</span>
<a href="#l45.273"></a><span id="l45.273">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l45.274"></a><span id="l45.274"> </span>
<a href="#l45.275"></a><span id="l45.275">       // close file before delete it</span>
<a href="#l45.276"></a><span id="l45.276" class="difflineminus">-      nsCOMPtr&lt;nsIAddrDatabase&gt; addrDBFactory = </span>
<a href="#l45.277"></a><span id="l45.277" class="difflineplus">+      nsCOMPtr&lt;nsIAddrDatabase&gt; addrDBFactory =</span>
<a href="#l45.278"></a><span id="l45.278">                do_GetService(NS_ADDRDATABASE_CONTRACTID, &amp;rv);</span>
<a href="#l45.279"></a><span id="l45.279"> </span>
<a href="#l45.280"></a><span id="l45.280">       if (NS_SUCCEEDED(rv) &amp;&amp; addrDBFactory)</span>
<a href="#l45.281"></a><span id="l45.281">         rv = addrDBFactory-&gt;Open(dbPath, false, true, getter_AddRefs(database));</span>
<a href="#l45.282"></a><span id="l45.282">       if (database)  /* database exists */</span>
<a href="#l45.283"></a><span id="l45.283">       {</span>
<a href="#l45.284"></a><span id="l45.284">         database-&gt;ForceClosed();</span>
<a href="#l45.285"></a><span id="l45.285">         rv = dbPath-&gt;Remove(false);</span>
<a href="#l45.286"></a><span id="l45.286" class="difflineat">@@ -665,32 +665,32 @@ nsresult DIR_DeleteServerFromList(DIR_Se</span>
<a href="#l45.287"></a><span id="l45.287">   return NS_ERROR_NULL_POINTER;</span>
<a href="#l45.288"></a><span id="l45.288"> }</span>
<a href="#l45.289"></a><span id="l45.289"> </span>
<a href="#l45.290"></a><span id="l45.290"> static void DIR_DeleteServerList(nsTArray&lt;DIR_Server*&gt; *wholeList)</span>
<a href="#l45.291"></a><span id="l45.291"> {</span>
<a href="#l45.292"></a><span id="l45.292">   if (wholeList)</span>
<a href="#l45.293"></a><span id="l45.293">   {</span>
<a href="#l45.294"></a><span id="l45.294">     DIR_Server *server = nullptr;</span>
<a href="#l45.295"></a><span id="l45.295" class="difflineminus">-  </span>
<a href="#l45.296"></a><span id="l45.296" class="difflineplus">+</span>
<a href="#l45.297"></a><span id="l45.297">     /* TBD: Send notifications? */</span>
<a href="#l45.298"></a><span id="l45.298">     int32_t count = wholeList-&gt;Length();</span>
<a href="#l45.299"></a><span id="l45.299">     int32_t i;</span>
<a href="#l45.300"></a><span id="l45.300">     for (i = count - 1; i &gt;=0; i--)</span>
<a href="#l45.301"></a><span id="l45.301">     {</span>
<a href="#l45.302"></a><span id="l45.302">       server = wholeList-&gt;ElementAt(i);</span>
<a href="#l45.303"></a><span id="l45.303">       if (server != nullptr)</span>
<a href="#l45.304"></a><span id="l45.304">         DIR_DeleteServer(server);</span>
<a href="#l45.305"></a><span id="l45.305">     }</span>
<a href="#l45.306"></a><span id="l45.306">     delete wholeList;</span>
<a href="#l45.307"></a><span id="l45.307">   }</span>
<a href="#l45.308"></a><span id="l45.308"> }</span>
<a href="#l45.309"></a><span id="l45.309"> </span>
<a href="#l45.310"></a><span id="l45.310"> /*****************************************************************************</span>
<a href="#l45.311"></a><span id="l45.311" class="difflineminus">- * Functions for managing JavaScript prefs for the DIR_Servers </span>
<a href="#l45.312"></a><span id="l45.312" class="difflineplus">+ * Functions for managing JavaScript prefs for the DIR_Servers</span>
<a href="#l45.313"></a><span id="l45.313">  */</span>
<a href="#l45.314"></a><span id="l45.314"> </span>
<a href="#l45.315"></a><span id="l45.315"> static int</span>
<a href="#l45.316"></a><span id="l45.316"> comparePrefArrayMembers(const void* aElement1, const void* aElement2, void* aData)</span>
<a href="#l45.317"></a><span id="l45.317"> {</span>
<a href="#l45.318"></a><span id="l45.318">     const char* element1 = *static_cast&lt;const char* const *&gt;(aElement1);</span>
<a href="#l45.319"></a><span id="l45.319">     const char* element2 = *static_cast&lt;const char* const *&gt;(aElement2);</span>
<a href="#l45.320"></a><span id="l45.320">     const uint32_t offset = *((const uint32_t*)aData);</span>
<a href="#l45.321"></a><span id="l45.321" class="difflineat">@@ -773,31 +773,31 @@ static char *DIR_GetStringPref(const cha</span>
<a href="#l45.322"></a><span id="l45.322">     nsAutoCString prefLocation(prefRoot);</span>
<a href="#l45.323"></a><span id="l45.323"> </span>
<a href="#l45.324"></a><span id="l45.324">     prefLocation.Append('.');</span>
<a href="#l45.325"></a><span id="l45.325">     prefLocation.Append(prefLeaf);</span>
<a href="#l45.326"></a><span id="l45.326"> </span>
<a href="#l45.327"></a><span id="l45.327">     if (NS_SUCCEEDED(pPref-&gt;GetCharPref(prefLocation.get(), getter_Copies(value))))</span>
<a href="#l45.328"></a><span id="l45.328">     {</span>
<a href="#l45.329"></a><span id="l45.329">         /* unfortunately, there may be some prefs out there which look like this */</span>
<a href="#l45.330"></a><span id="l45.330" class="difflineminus">-        if (value.EqualsLiteral(&quot;(null)&quot;)) </span>
<a href="#l45.331"></a><span id="l45.331" class="difflineplus">+        if (value.EqualsLiteral(&quot;(null)&quot;))</span>
<a href="#l45.332"></a><span id="l45.332">         {</span>
<a href="#l45.333"></a><span id="l45.333">             if (defaultValue)</span>
<a href="#l45.334"></a><span id="l45.334">                 value = defaultValue;</span>
<a href="#l45.335"></a><span id="l45.335">             else</span>
<a href="#l45.336"></a><span id="l45.336">                 value.Truncate();</span>
<a href="#l45.337"></a><span id="l45.337">         }</span>
<a href="#l45.338"></a><span id="l45.338"> </span>
<a href="#l45.339"></a><span id="l45.339">         if (value.IsEmpty())</span>
<a href="#l45.340"></a><span id="l45.340">         {</span>
<a href="#l45.341"></a><span id="l45.341">           rv = pPref-&gt;GetCharPref(prefLocation.get(), getter_Copies(value));</span>
<a href="#l45.342"></a><span id="l45.342">         }</span>
<a href="#l45.343"></a><span id="l45.343">     }</span>
<a href="#l45.344"></a><span id="l45.344">     else</span>
<a href="#l45.345"></a><span id="l45.345" class="difflineminus">-        value = defaultValue; </span>
<a href="#l45.346"></a><span id="l45.346" class="difflineplus">+        value = defaultValue;</span>
<a href="#l45.347"></a><span id="l45.347"> </span>
<a href="#l45.348"></a><span id="l45.348">     return ToNewCString(value);</span>
<a href="#l45.349"></a><span id="l45.349"> }</span>
<a href="#l45.350"></a><span id="l45.350"> </span>
<a href="#l45.351"></a><span id="l45.351"> /**</span>
<a href="#l45.352"></a><span id="l45.352">  * Get localized unicode string pref from properties file, convert into an UTF8 string</span>
<a href="#l45.353"></a><span id="l45.353">  * since address book prefs store as UTF8 strings. So far there are 2 default</span>
<a href="#l45.354"></a><span id="l45.354">  * prefs stored in addressbook.properties.</span>
<a href="#l45.355"></a><span id="l45.355" class="difflineat">@@ -903,17 +903,17 @@ void DIR_SetFileName(char** fileName, co</span>
<a href="#l45.356"></a><span id="l45.356">   if (!fileName)</span>
<a href="#l45.357"></a><span id="l45.357">     return;</span>
<a href="#l45.358"></a><span id="l45.358"> </span>
<a href="#l45.359"></a><span id="l45.359">   nsresult rv = NS_OK;</span>
<a href="#l45.360"></a><span id="l45.360">   nsCOMPtr&lt;nsIFile&gt; dbPath;</span>
<a href="#l45.361"></a><span id="l45.361"> </span>
<a href="#l45.362"></a><span id="l45.362">   *fileName = nullptr;</span>
<a href="#l45.363"></a><span id="l45.363"> </span>
<a href="#l45.364"></a><span id="l45.364" class="difflineminus">-  nsCOMPtr&lt;nsIAbManager&gt; abManager = do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv); </span>
<a href="#l45.365"></a><span id="l45.365" class="difflineplus">+  nsCOMPtr&lt;nsIAbManager&gt; abManager = do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l45.366"></a><span id="l45.366">   if (NS_SUCCEEDED(rv))</span>
<a href="#l45.367"></a><span id="l45.367">     rv = abManager-&gt;GetUserProfileDirectory(getter_AddRefs(dbPath));</span>
<a href="#l45.368"></a><span id="l45.368">   if (NS_SUCCEEDED(rv))</span>
<a href="#l45.369"></a><span id="l45.369">   {</span>
<a href="#l45.370"></a><span id="l45.370">     rv = dbPath-&gt;AppendNative(nsDependentCString(defaultName));</span>
<a href="#l45.371"></a><span id="l45.371">     if (NS_SUCCEEDED(rv))</span>
<a href="#l45.372"></a><span id="l45.372">     {</span>
<a href="#l45.373"></a><span id="l45.373">       rv = dbPath-&gt;CreateUnique(nsIFile::NORMAL_FILE_TYPE, 0664);</span>
<a href="#l45.374"></a><span id="l45.374" class="difflineat">@@ -924,18 +924,18 @@ void DIR_SetFileName(char** fileName, co</span>
<a href="#l45.375"></a><span id="l45.375">       if (NS_SUCCEEDED(rv))</span>
<a href="#l45.376"></a><span id="l45.376">         *fileName = ToNewUTF8String(realFileName);</span>
<a href="#l45.377"></a><span id="l45.377">     }</span>
<a href="#l45.378"></a><span id="l45.378">   }</span>
<a href="#l45.379"></a><span id="l45.379"> }</span>
<a href="#l45.380"></a><span id="l45.380"> </span>
<a href="#l45.381"></a><span id="l45.381"> /****************************************************************</span>
<a href="#l45.382"></a><span id="l45.382"> Helper function used to generate a file name from the description</span>
<a href="#l45.383"></a><span id="l45.383" class="difflineminus">-of a directory. Caller must free returned string. </span>
<a href="#l45.384"></a><span id="l45.384" class="difflineminus">-An extension is not applied </span>
<a href="#l45.385"></a><span id="l45.385" class="difflineplus">+of a directory. Caller must free returned string.</span>
<a href="#l45.386"></a><span id="l45.386" class="difflineplus">+An extension is not applied</span>
<a href="#l45.387"></a><span id="l45.387"> *****************************************************************/</span>
<a href="#l45.388"></a><span id="l45.388"> </span>
<a href="#l45.389"></a><span id="l45.389"> static char * dir_ConvertDescriptionToPrefName(DIR_Server * server)</span>
<a href="#l45.390"></a><span id="l45.390"> {</span>
<a href="#l45.391"></a><span id="l45.391"> #define MAX_PREF_NAME_SIZE 25</span>
<a href="#l45.392"></a><span id="l45.392">   char * fileName = nullptr;</span>
<a href="#l45.393"></a><span id="l45.393">   char fileNameBuf[MAX_PREF_NAME_SIZE];</span>
<a href="#l45.394"></a><span id="l45.394">   int32_t srcIndex = 0;</span>
<a href="#l45.395"></a><span id="l45.395" class="difflineat">@@ -964,19 +964,19 @@ static char * dir_ConvertDescriptionToPr</span>
<a href="#l45.396"></a><span id="l45.396">   fileName = strdup(fileNameBuf);</span>
<a href="#l45.397"></a><span id="l45.397"> </span>
<a href="#l45.398"></a><span id="l45.398">   return fileName;</span>
<a href="#l45.399"></a><span id="l45.399"> }</span>
<a href="#l45.400"></a><span id="l45.400"> </span>
<a href="#l45.401"></a><span id="l45.401"> </span>
<a href="#l45.402"></a><span id="l45.402"> void DIR_SetServerFileName(DIR_Server *server)</span>
<a href="#l45.403"></a><span id="l45.403"> {</span>
<a href="#l45.404"></a><span id="l45.404" class="difflineminus">-  char * tempName = nullptr; </span>
<a href="#l45.405"></a><span id="l45.405" class="difflineplus">+  char * tempName = nullptr;</span>
<a href="#l45.406"></a><span id="l45.406">   const char * prefName = nullptr;</span>
<a href="#l45.407"></a><span id="l45.407" class="difflineminus">-  uint32_t numHeaderBytes = 0; </span>
<a href="#l45.408"></a><span id="l45.408" class="difflineplus">+  uint32_t numHeaderBytes = 0;</span>
<a href="#l45.409"></a><span id="l45.409"> </span>
<a href="#l45.410"></a><span id="l45.410">   if (server &amp;&amp; (!server-&gt;fileName || !(*server-&gt;fileName)) )</span>
<a href="#l45.411"></a><span id="l45.411">   {</span>
<a href="#l45.412"></a><span id="l45.412">           PR_FREEIF(server-&gt;fileName); // might be one byte empty string.</span>
<a href="#l45.413"></a><span id="l45.413">     /* make sure we have a pref name...*/</span>
<a href="#l45.414"></a><span id="l45.414">     if (!server-&gt;prefName || !*server-&gt;prefName)</span>
<a href="#l45.415"></a><span id="l45.415">       server-&gt;prefName = dir_CreateServerPrefName(server);</span>
<a href="#l45.416"></a><span id="l45.416"> </span>
<a href="#l45.417"></a><span id="l45.417" class="difflineat">@@ -987,17 +987,17 @@ void DIR_SetServerFileName(DIR_Server *s</span>
<a href="#l45.418"></a><span id="l45.418">     {</span>
<a href="#l45.419"></a><span id="l45.419">       /* now use the pref name as the file name since we know the pref name</span>
<a href="#l45.420"></a><span id="l45.420">          will be unique */</span>
<a href="#l45.421"></a><span id="l45.421">       prefName = server-&gt;prefName;</span>
<a href="#l45.422"></a><span id="l45.422">       if (prefName &amp;&amp; *prefName)</span>
<a href="#l45.423"></a><span id="l45.423">       {</span>
<a href="#l45.424"></a><span id="l45.424">         /* extract just the pref name part and not the ldap tree name portion from the string */</span>
<a href="#l45.425"></a><span id="l45.425">         numHeaderBytes = PL_strlen(PREF_LDAP_SERVER_TREE_NAME) + 1; /* + 1 for the '.' b4 the name */</span>
<a href="#l45.426"></a><span id="l45.426" class="difflineminus">-        if (PL_strlen(prefName) &gt; numHeaderBytes) </span>
<a href="#l45.427"></a><span id="l45.427" class="difflineplus">+        if (PL_strlen(prefName) &gt; numHeaderBytes)</span>
<a href="#l45.428"></a><span id="l45.428">                     tempName = strdup(prefName + numHeaderBytes);</span>
<a href="#l45.429"></a><span id="l45.429"> </span>
<a href="#l45.430"></a><span id="l45.430">         if (tempName)</span>
<a href="#l45.431"></a><span id="l45.431">         {</span>
<a href="#l45.432"></a><span id="l45.432">           server-&gt;fileName = PR_smprintf(&quot;%s%s&quot;, tempName, kABFileName_CurrentSuffix);</span>
<a href="#l45.433"></a><span id="l45.433">           PR_Free(tempName);</span>
<a href="#l45.434"></a><span id="l45.434">         }</span>
<a href="#l45.435"></a><span id="l45.435">       }</span>
<a href="#l45.436"></a><span id="l45.436" class="difflineat">@@ -1077,33 +1077,33 @@ static char *dir_CreateServerPrefName (D</span>
<a href="#l45.437"></a><span id="l45.437"> }</span>
<a href="#l45.438"></a><span id="l45.438"> </span>
<a href="#l45.439"></a><span id="l45.439"> static void DIR_GetPrefsForOneServer(DIR_Server *server)</span>
<a href="#l45.440"></a><span id="l45.440"> {</span>
<a href="#l45.441"></a><span id="l45.441">   nsresult rv;</span>
<a href="#l45.442"></a><span id="l45.442">   nsCOMPtr&lt;nsIPrefBranch&gt; pPref(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l45.443"></a><span id="l45.443">   if (NS_FAILED(rv))</span>
<a href="#l45.444"></a><span id="l45.444">     return;</span>
<a href="#l45.445"></a><span id="l45.445" class="difflineminus">-  </span>
<a href="#l45.446"></a><span id="l45.446" class="difflineplus">+</span>
<a href="#l45.447"></a><span id="l45.447">   char    *prefstring = server-&gt;prefName;</span>
<a href="#l45.448"></a><span id="l45.448"> </span>
<a href="#l45.449"></a><span id="l45.449">   // this call fills in tempstring with the position pref, and</span>
<a href="#l45.450"></a><span id="l45.450">   // we then check to see if it's locked.</span>
<a href="#l45.451"></a><span id="l45.451">   server-&gt;position = DIR_GetIntPref (prefstring, &quot;position&quot;, kDefaultPosition);</span>
<a href="#l45.452"></a><span id="l45.452"> </span>
<a href="#l45.453"></a><span id="l45.453">   // For default address books, this will get the name from the chrome</span>
<a href="#l45.454"></a><span id="l45.454">   // file referenced, for other address books it'll just retrieve it from prefs</span>
<a href="#l45.455"></a><span id="l45.455">   // as normal.</span>
<a href="#l45.456"></a><span id="l45.456">   server-&gt;description = DIR_GetLocalizedStringPref(prefstring, &quot;description&quot;);</span>
<a href="#l45.457"></a><span id="l45.457"> </span>
<a href="#l45.458"></a><span id="l45.458">   server-&gt;dirType = (DirectoryType)DIR_GetIntPref (prefstring, &quot;dirType&quot;, LDAPDirectory);</span>
<a href="#l45.459"></a><span id="l45.459"> </span>
<a href="#l45.460"></a><span id="l45.460">   server-&gt;fileName = DIR_GetStringPref (prefstring, &quot;filename&quot;, &quot;&quot;);</span>
<a href="#l45.461"></a><span id="l45.461">   // if we don't have a file name try and get one</span>
<a href="#l45.462"></a><span id="l45.462" class="difflineminus">-  if (!server-&gt;fileName || !*(server-&gt;fileName)) </span>
<a href="#l45.463"></a><span id="l45.463" class="difflineplus">+  if (!server-&gt;fileName || !*(server-&gt;fileName))</span>
<a href="#l45.464"></a><span id="l45.464">     DIR_SetServerFileName (server);</span>
<a href="#l45.465"></a><span id="l45.465">   if (server-&gt;fileName &amp;&amp; *server-&gt;fileName)</span>
<a href="#l45.466"></a><span id="l45.466">     DIR_ConvertServerFileName(server);</span>
<a href="#l45.467"></a><span id="l45.467"> </span>
<a href="#l45.468"></a><span id="l45.468">   // the string &quot;s&quot; is the default uri ( &lt;scheme&gt; + &quot;://&quot; + &lt;filename&gt; )</span>
<a href="#l45.469"></a><span id="l45.469">   nsCString s((server-&gt;dirType == PABDirectory || server-&gt;dirType == MAPIDirectory) ?</span>
<a href="#l45.470"></a><span id="l45.470"> #if defined(MOZ_LDAP_XPCOM)</span>
<a href="#l45.471"></a><span id="l45.471">     kMDBDirectoryRoot : kLDAPDirectoryRoot);</span>
<a href="#l45.472"></a><span id="l45.472" class="difflineat">@@ -1145,17 +1145,17 @@ static nsresult dir_GetPrefs(nsTArray&lt;DI</span>
<a href="#l45.473"></a><span id="l45.473">         DIR_Server *server;</span>
<a href="#l45.474"></a><span id="l45.474"> </span>
<a href="#l45.475"></a><span id="l45.475">         server = (DIR_Server *)PR_Calloc(1, sizeof(DIR_Server));</span>
<a href="#l45.476"></a><span id="l45.476">         if (server)</span>
<a href="#l45.477"></a><span id="l45.477">         {</span>
<a href="#l45.478"></a><span id="l45.478">             DIR_InitServer(server);</span>
<a href="#l45.479"></a><span id="l45.479">             server-&gt;prefName = strdup(children[i]);</span>
<a href="#l45.480"></a><span id="l45.480">             DIR_GetPrefsForOneServer(server);</span>
<a href="#l45.481"></a><span id="l45.481" class="difflineminus">-            if (server-&gt;description &amp;&amp; server-&gt;description[0] &amp;&amp; </span>
<a href="#l45.482"></a><span id="l45.482" class="difflineplus">+            if (server-&gt;description &amp;&amp; server-&gt;description[0] &amp;&amp;</span>
<a href="#l45.483"></a><span id="l45.483">                 ((server-&gt;dirType == PABDirectory ||</span>
<a href="#l45.484"></a><span id="l45.484">                   server-&gt;dirType == MAPIDirectory ||</span>
<a href="#l45.485"></a><span id="l45.485">                   server-&gt;dirType == FixedQueryLDAPDirectory ||  // this one might go away</span>
<a href="#l45.486"></a><span id="l45.486">                   server-&gt;dirType == LDAPDirectory)))</span>
<a href="#l45.487"></a><span id="l45.487">             {</span>
<a href="#l45.488"></a><span id="l45.488">                 if (!dir_IsServerDeleted(server))</span>
<a href="#l45.489"></a><span id="l45.489">                 {</span>
<a href="#l45.490"></a><span id="l45.490">                     (*list)-&gt;AppendElement(server);</span>
<a href="#l45.491"></a><span id="l45.491" class="difflineat">@@ -1175,17 +1175,17 @@ static nsresult dir_GetPrefs(nsTArray&lt;DI</span>
<a href="#l45.492"></a><span id="l45.492">     return NS_OK;</span>
<a href="#l45.493"></a><span id="l45.493"> }</span>
<a href="#l45.494"></a><span id="l45.494"> </span>
<a href="#l45.495"></a><span id="l45.495"> // I don't think we care about locked positions, etc.</span>
<a href="#l45.496"></a><span id="l45.496"> void DIR_SortServersByPosition(nsTArray&lt;DIR_Server*&gt; *serverList)</span>
<a href="#l45.497"></a><span id="l45.497"> {</span>
<a href="#l45.498"></a><span id="l45.498">   int i, j;</span>
<a href="#l45.499"></a><span id="l45.499">   DIR_Server *server;</span>
<a href="#l45.500"></a><span id="l45.500" class="difflineminus">-  </span>
<a href="#l45.501"></a><span id="l45.501" class="difflineplus">+</span>
<a href="#l45.502"></a><span id="l45.502">   int count = serverList-&gt;Length();</span>
<a href="#l45.503"></a><span id="l45.503">   for (i = 0; i &lt; count - 1; i++)</span>
<a href="#l45.504"></a><span id="l45.504">   {</span>
<a href="#l45.505"></a><span id="l45.505">     for (j = i + 1; j &lt; count; j++)</span>
<a href="#l45.506"></a><span id="l45.506">     {</span>
<a href="#l45.507"></a><span id="l45.507">       if (serverList-&gt;ElementAt(j)-&gt;position &lt; serverList-&gt;ElementAt(i)-&gt;position)</span>
<a href="#l45.508"></a><span id="l45.508">       {</span>
<a href="#l45.509"></a><span id="l45.509">         server = serverList-&gt;ElementAt(i);</span>
<a href="#l45.510"></a><span id="l45.510" class="difflineat">@@ -1200,52 +1200,52 @@ static nsresult DIR_GetServerPreferences</span>
<a href="#l45.511"></a><span id="l45.511"> {</span>
<a href="#l45.512"></a><span id="l45.512">   nsresult err;</span>
<a href="#l45.513"></a><span id="l45.513">   nsCOMPtr&lt;nsIPrefBranch&gt; pPref(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;err));</span>
<a href="#l45.514"></a><span id="l45.514">   if (NS_FAILED(err))</span>
<a href="#l45.515"></a><span id="l45.515">     return err;</span>
<a href="#l45.516"></a><span id="l45.516"> </span>
<a href="#l45.517"></a><span id="l45.517">   int32_t version = -1;</span>
<a href="#l45.518"></a><span id="l45.518">   nsTArray&lt;DIR_Server*&gt; *newList = nullptr;</span>
<a href="#l45.519"></a><span id="l45.519" class="difflineminus">-  </span>
<a href="#l45.520"></a><span id="l45.520" class="difflineplus">+</span>
<a href="#l45.521"></a><span id="l45.521">   /* Update the ldap list version and see if there are old prefs to migrate. */</span>
<a href="#l45.522"></a><span id="l45.522">   err = pPref-&gt;GetIntPref(PREF_LDAP_VERSION_NAME, &amp;version);</span>
<a href="#l45.523"></a><span id="l45.523">   NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l45.524"></a><span id="l45.524"> </span>
<a href="#l45.525"></a><span id="l45.525">   /* Find the new-style &quot;ldap_2.servers&quot; tree in prefs */</span>
<a href="#l45.526"></a><span id="l45.526">   err = dir_GetPrefs(&amp;newList);</span>
<a href="#l45.527"></a><span id="l45.527"> </span>
<a href="#l45.528"></a><span id="l45.528">   if (version &lt; kCurrentListVersion)</span>
<a href="#l45.529"></a><span id="l45.529">   {</span>
<a href="#l45.530"></a><span id="l45.530">     pPref-&gt;SetIntPref(PREF_LDAP_VERSION_NAME, kCurrentListVersion);</span>
<a href="#l45.531"></a><span id="l45.531">   }</span>
<a href="#l45.532"></a><span id="l45.532" class="difflineminus">- </span>
<a href="#l45.533"></a><span id="l45.533" class="difflineplus">+</span>
<a href="#l45.534"></a><span id="l45.534">   DIR_SortServersByPosition(newList);</span>
<a href="#l45.535"></a><span id="l45.535"> </span>
<a href="#l45.536"></a><span id="l45.536">   *list = newList;</span>
<a href="#l45.537"></a><span id="l45.537"> </span>
<a href="#l45.538"></a><span id="l45.538">   return err;</span>
<a href="#l45.539"></a><span id="l45.539"> }</span>
<a href="#l45.540"></a><span id="l45.540"> </span>
<a href="#l45.541"></a><span id="l45.541"> static void DIR_SetStringPref(const char *prefRoot, const char *prefLeaf, const char *value, const char *defaultValue)</span>
<a href="#l45.542"></a><span id="l45.542"> {</span>
<a href="#l45.543"></a><span id="l45.543">   nsresult rv;</span>
<a href="#l45.544"></a><span id="l45.544" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; pPref(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv)); </span>
<a href="#l45.545"></a><span id="l45.545" class="difflineminus">-  if (NS_FAILED(rv)) </span>
<a href="#l45.546"></a><span id="l45.546" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; pPref(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l45.547"></a><span id="l45.547" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l45.548"></a><span id="l45.548">     return;</span>
<a href="#l45.549"></a><span id="l45.549"> </span>
<a href="#l45.550"></a><span id="l45.550">   nsCString defaultPref;</span>
<a href="#l45.551"></a><span id="l45.551">   nsAutoCString prefLocation(prefRoot);</span>
<a href="#l45.552"></a><span id="l45.552"> </span>
<a href="#l45.553"></a><span id="l45.553">   prefLocation.Append('.');</span>
<a href="#l45.554"></a><span id="l45.554">   prefLocation.Append(prefLeaf);</span>
<a href="#l45.555"></a><span id="l45.555"> </span>
<a href="#l45.556"></a><span id="l45.556">   if (NS_SUCCEEDED(pPref-&gt;GetCharPref(prefLocation.get(), getter_Copies(defaultPref))))</span>
<a href="#l45.557"></a><span id="l45.557">   {</span>
<a href="#l45.558"></a><span id="l45.558" class="difflineminus">-    /* If there's a default pref, just set ours in and let libpref worry </span>
<a href="#l45.559"></a><span id="l45.559" class="difflineplus">+    /* If there's a default pref, just set ours in and let libpref worry</span>
<a href="#l45.560"></a><span id="l45.560">      * about potential defaults in all.js</span>
<a href="#l45.561"></a><span id="l45.561">      */</span>
<a href="#l45.562"></a><span id="l45.562">     if (value) /* added this check to make sure we have a value before we try to set it..*/</span>
<a href="#l45.563"></a><span id="l45.563">       rv = pPref-&gt;SetCharPref (prefLocation.get(), value);</span>
<a href="#l45.564"></a><span id="l45.564">     else</span>
<a href="#l45.565"></a><span id="l45.565">       rv = pPref-&gt;ClearUserPref(prefLocation.get());</span>
<a href="#l45.566"></a><span id="l45.566">   }</span>
<a href="#l45.567"></a><span id="l45.567">   else</span>
<a href="#l45.568"></a><span id="l45.568" class="difflineat">@@ -1259,17 +1259,17 @@ static void DIR_SetStringPref(const char</span>
<a href="#l45.569"></a><span id="l45.569">       if (value &amp;&amp; (defaultValue ? PL_strcasecmp(value, defaultValue) : value != defaultValue))</span>
<a href="#l45.570"></a><span id="l45.570">         rv = pPref-&gt;SetCharPref (prefLocation.get(), value);</span>
<a href="#l45.571"></a><span id="l45.571">       else</span>
<a href="#l45.572"></a><span id="l45.572">         rv = pPref-&gt;ClearUserPref(prefLocation.get());</span>
<a href="#l45.573"></a><span id="l45.573">     }</span>
<a href="#l45.574"></a><span id="l45.574">     else</span>
<a href="#l45.575"></a><span id="l45.575">     {</span>
<a href="#l45.576"></a><span id="l45.576">       if (value &amp;&amp; (defaultValue ? PL_strcasecmp(value, defaultValue) : value != defaultValue))</span>
<a href="#l45.577"></a><span id="l45.577" class="difflineminus">-        rv = pPref-&gt;SetCharPref (prefLocation.get(), value); </span>
<a href="#l45.578"></a><span id="l45.578" class="difflineplus">+        rv = pPref-&gt;SetCharPref (prefLocation.get(), value);</span>
<a href="#l45.579"></a><span id="l45.579">     }</span>
<a href="#l45.580"></a><span id="l45.580">   }</span>
<a href="#l45.581"></a><span id="l45.581"> </span>
<a href="#l45.582"></a><span id="l45.582">   NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Could not set pref in DIR_SetStringPref&quot;);</span>
<a href="#l45.583"></a><span id="l45.583"> }</span>
<a href="#l45.584"></a><span id="l45.584"> </span>
<a href="#l45.585"></a><span id="l45.585"> static void DIR_SetLocalizedStringPref</span>
<a href="#l45.586"></a><span id="l45.586"> (const char *prefRoot, const char *prefLeaf, const char *value)</span>
<a href="#l45.587"></a><span id="l45.587" class="difflineat">@@ -1354,18 +1354,18 @@ static void DIR_SetLocalizedStringPref</span>
<a href="#l45.588"></a><span id="l45.588"> </span>
<a href="#l45.589"></a><span id="l45.589">   NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Could not set pref in DIR_SetLocalizedStringPref&quot;);</span>
<a href="#l45.590"></a><span id="l45.590"> }</span>
<a href="#l45.591"></a><span id="l45.591"> </span>
<a href="#l45.592"></a><span id="l45.592"> </span>
<a href="#l45.593"></a><span id="l45.593"> static void DIR_SetIntPref(const char *prefRoot, const char *prefLeaf, int32_t value, int32_t defaultValue)</span>
<a href="#l45.594"></a><span id="l45.594"> {</span>
<a href="#l45.595"></a><span id="l45.595">   nsresult rv;</span>
<a href="#l45.596"></a><span id="l45.596" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; pPref(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv)); </span>
<a href="#l45.597"></a><span id="l45.597" class="difflineminus">-  if (NS_FAILED(rv)) </span>
<a href="#l45.598"></a><span id="l45.598" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; pPref(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l45.599"></a><span id="l45.599" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l45.600"></a><span id="l45.600">     return;</span>
<a href="#l45.601"></a><span id="l45.601"> </span>
<a href="#l45.602"></a><span id="l45.602">   int32_t defaultPref;</span>
<a href="#l45.603"></a><span id="l45.603">   nsAutoCString prefLocation(prefRoot);</span>
<a href="#l45.604"></a><span id="l45.604"> </span>
<a href="#l45.605"></a><span id="l45.605">   prefLocation.Append('.');</span>
<a href="#l45.606"></a><span id="l45.606">   prefLocation.Append(prefLeaf);</span>
<a href="#l45.607"></a><span id="l45.607"> </span>
<a href="#l45.608"></a><span id="l45.608" class="difflineat">@@ -1382,17 +1382,17 @@ static void DIR_SetIntPref(const char *p</span>
<a href="#l45.609"></a><span id="l45.609">       if (value != defaultValue)</span>
<a href="#l45.610"></a><span id="l45.610">         rv = pPref-&gt;SetIntPref(prefLocation.get(), value);</span>
<a href="#l45.611"></a><span id="l45.611">       else</span>
<a href="#l45.612"></a><span id="l45.612">         rv = pPref-&gt;ClearUserPref(prefLocation.get());</span>
<a href="#l45.613"></a><span id="l45.613">     }</span>
<a href="#l45.614"></a><span id="l45.614">     else</span>
<a href="#l45.615"></a><span id="l45.615">     {</span>
<a href="#l45.616"></a><span id="l45.616">       if (value != defaultValue)</span>
<a href="#l45.617"></a><span id="l45.617" class="difflineminus">-        rv = pPref-&gt;SetIntPref(prefLocation.get(), value); </span>
<a href="#l45.618"></a><span id="l45.618" class="difflineplus">+        rv = pPref-&gt;SetIntPref(prefLocation.get(), value);</span>
<a href="#l45.619"></a><span id="l45.619">     }</span>
<a href="#l45.620"></a><span id="l45.620">   }</span>
<a href="#l45.621"></a><span id="l45.621"> </span>
<a href="#l45.622"></a><span id="l45.622">   NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Could not set pref in DIR_SetIntPref&quot;);</span>
<a href="#l45.623"></a><span id="l45.623"> }</span>
<a href="#l45.624"></a><span id="l45.624"> </span>
<a href="#l45.625"></a><span id="l45.625"> void DIR_SavePrefsForOneServer(DIR_Server *server)</span>
<a href="#l45.626"></a><span id="l45.626"> {</span>
<a href="#l45.627"></a><span id="l45.627" class="difflineat">@@ -1421,17 +1421,17 @@ void DIR_SavePrefsForOneServer(DIR_Serve</span>
<a href="#l45.628"></a><span id="l45.628">   server-&gt;savingServer = false;</span>
<a href="#l45.629"></a><span id="l45.629"> }</span>
<a href="#l45.630"></a><span id="l45.630"> </span>
<a href="#l45.631"></a><span id="l45.631"> static void DIR_SaveServerPreferences(nsTArray&lt;DIR_Server*&gt; *wholeList)</span>
<a href="#l45.632"></a><span id="l45.632"> {</span>
<a href="#l45.633"></a><span id="l45.633">   if (wholeList)</span>
<a href="#l45.634"></a><span id="l45.634">   {</span>
<a href="#l45.635"></a><span id="l45.635">     nsresult rv;</span>
<a href="#l45.636"></a><span id="l45.636" class="difflineminus">-    nsCOMPtr&lt;nsIPrefBranch&gt; pPref(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv)); </span>
<a href="#l45.637"></a><span id="l45.637" class="difflineplus">+    nsCOMPtr&lt;nsIPrefBranch&gt; pPref(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l45.638"></a><span id="l45.638">     if (NS_FAILED(rv)) {</span>
<a href="#l45.639"></a><span id="l45.639">       NS_WARNING(&quot;DIR_SaveServerPreferences: Failed to get the pref service\n&quot;);</span>
<a href="#l45.640"></a><span id="l45.640">       return;</span>
<a href="#l45.641"></a><span id="l45.641">     }</span>
<a href="#l45.642"></a><span id="l45.642"> </span>
<a href="#l45.643"></a><span id="l45.643">     int32_t  i;</span>
<a href="#l45.644"></a><span id="l45.644">     int32_t  count = wholeList-&gt;Length();</span>
<a href="#l45.645"></a><span id="l45.645">     DIR_Server *server;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l46.1"></a><span id="l46.1" class="difflineminus">--- a/mailnews/addrbook/src/nsDirPrefs.h</span>
<a href="#l46.2"></a><span id="l46.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsDirPrefs.h</span>
<a href="#l46.3"></a><span id="l46.3" class="difflineat">@@ -28,19 +28,19 @@ typedef enum</span>
<a href="#l46.4"></a><span id="l46.4"> 	HTMLDirectory,</span>
<a href="#l46.5"></a><span id="l46.5">   PABDirectory,</span>
<a href="#l46.6"></a><span id="l46.6">   MAPIDirectory,</span>
<a href="#l46.7"></a><span id="l46.7">   FixedQueryLDAPDirectory = 777</span>
<a href="#l46.8"></a><span id="l46.8"> } DirectoryType;</span>
<a href="#l46.9"></a><span id="l46.9"> </span>
<a href="#l46.10"></a><span id="l46.10"> typedef enum</span>
<a href="#l46.11"></a><span id="l46.11"> {</span>
<a href="#l46.12"></a><span id="l46.12" class="difflineminus">-	idNone = 0,					/* Special value                          */ </span>
<a href="#l46.13"></a><span id="l46.13" class="difflineplus">+	idNone = 0,					/* Special value                          */</span>
<a href="#l46.14"></a><span id="l46.14"> 	idPrefName,</span>
<a href="#l46.15"></a><span id="l46.15" class="difflineminus">-	idPosition, </span>
<a href="#l46.16"></a><span id="l46.16" class="difflineplus">+	idPosition,</span>
<a href="#l46.17"></a><span id="l46.17"> 	idDescription,</span>
<a href="#l46.18"></a><span id="l46.18"> 	idFileName,</span>
<a href="#l46.19"></a><span id="l46.19"> 	idUri,</span>
<a href="#l46.20"></a><span id="l46.20"> 	idType</span>
<a href="#l46.21"></a><span id="l46.21"> } DIR_PrefId;</span>
<a href="#l46.22"></a><span id="l46.22"> </span>
<a href="#l46.23"></a><span id="l46.23"> #define DIR_Server_typedef 1     /* this quiets a redeclare warning in libaddr */</span>
<a href="#l46.24"></a><span id="l46.24"> </span>
<a href="#l46.25"></a><span id="l46.25" class="difflineat">@@ -55,28 +55,28 @@ typedef struct DIR_Server</span>
<a href="#l46.26"></a><span id="l46.26"> 	char   *fileName;			/* XP path name of local DB               */</span>
<a href="#l46.27"></a><span id="l46.27"> 	DirectoryType dirType;	</span>
<a href="#l46.28"></a><span id="l46.28">   char    *uri;       // URI of the address book</span>
<a href="#l46.29"></a><span id="l46.29"> </span>
<a href="#l46.30"></a><span id="l46.30">   // Set whilst saving the server to avoid updating it again</span>
<a href="#l46.31"></a><span id="l46.31">   bool savingServer;</span>
<a href="#l46.32"></a><span id="l46.32"> } DIR_Server;</span>
<a href="#l46.33"></a><span id="l46.33"> </span>
<a href="#l46.34"></a><span id="l46.34" class="difflineminus">-/* We are developing a new model for managing DIR_Servers. In the 4.0x world, the FEs managed each list. </span>
<a href="#l46.35"></a><span id="l46.35" class="difflineplus">+/* We are developing a new model for managing DIR_Servers. In the 4.0x world, the FEs managed each list.</span>
<a href="#l46.36"></a><span id="l46.36"> 	Calls to FE_GetDirServer caused the FEs to manage and return the DIR_Server list. In our new view of the</span>
<a href="#l46.37"></a><span id="l46.37" class="difflineminus">-	world, the back end does most of the list management so we are going to have the back end create and </span>
<a href="#l46.38"></a><span id="l46.38" class="difflineplus">+	world, the back end does most of the list management so we are going to have the back end create and</span>
<a href="#l46.39"></a><span id="l46.39"> 	manage the list. Replace calls to FE_GetDirServers() with DIR_GetDirServers(). */</span>
<a href="#l46.40"></a><span id="l46.40"> </span>
<a href="#l46.41"></a><span id="l46.41"> nsTArray&lt;DIR_Server*&gt;* DIR_GetDirectories();</span>
<a href="#l46.42"></a><span id="l46.42"> DIR_Server* DIR_GetServerFromList(const char* prefName);</span>
<a href="#l46.43"></a><span id="l46.43"> nsresult DIR_ShutDown(void);  /* FEs should call this when the app is shutting down. It frees all DIR_Servers regardless of ref count values! */</span>
<a href="#l46.44"></a><span id="l46.44"> </span>
<a href="#l46.45"></a><span id="l46.45"> nsresult DIR_AddNewAddressBook(const nsAString &amp;dirName,</span>
<a href="#l46.46"></a><span id="l46.46">                                const nsACString &amp;fileName,</span>
<a href="#l46.47"></a><span id="l46.47" class="difflineminus">-                               const nsACString &amp;uri, </span>
<a href="#l46.48"></a><span id="l46.48" class="difflineplus">+                               const nsACString &amp;uri,</span>
<a href="#l46.49"></a><span id="l46.49">                                DirectoryType dirType,</span>
<a href="#l46.50"></a><span id="l46.50">                                const nsACString &amp;prefName,</span>
<a href="#l46.51"></a><span id="l46.51">                                DIR_Server** pServer);</span>
<a href="#l46.52"></a><span id="l46.52"> nsresult DIR_ContainsServer(DIR_Server* pServer, bool *hasDir);</span>
<a href="#l46.53"></a><span id="l46.53"> </span>
<a href="#l46.54"></a><span id="l46.54"> nsresult DIR_DeleteServerFromList (DIR_Server *);</span>
<a href="#l46.55"></a><span id="l46.55"> </span>
<a href="#l46.56"></a><span id="l46.56"> void    DIR_SavePrefsForOneServer(DIR_Server *server);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l47.1"></a><span id="l47.1" class="difflineminus">--- a/mailnews/addrbook/src/nsMapiAddressBook.cpp</span>
<a href="#l47.2"></a><span id="l47.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsMapiAddressBook.cpp</span>
<a href="#l47.3"></a><span id="l47.3" class="difflineat">@@ -48,57 +48,57 @@ BOOL nsMapiAddressBook::LoadMapiLibrary(</span>
<a href="#l47.4"></a><span id="l47.4">     if (!mMAPIAllocateBuffer) { return FALSE ; }</span>
<a href="#l47.5"></a><span id="l47.5">     mMAPIFreeBuffer = reinterpret_cast&lt;LPMAPIFREEBUFFER&gt;(GetProcAddress(mLibrary, &quot;MAPIFreeBuffer&quot;)) ;</span>
<a href="#l47.6"></a><span id="l47.6">     if (!mMAPIFreeBuffer) { return FALSE ; }</span>
<a href="#l47.7"></a><span id="l47.7">     mMAPILogonEx = reinterpret_cast&lt;LPMAPILOGONEX&gt;(GetProcAddress(mLibrary, &quot;MAPILogonEx&quot;)) ;</span>
<a href="#l47.8"></a><span id="l47.8">     if (!mMAPILogonEx) { return FALSE ; }</span>
<a href="#l47.9"></a><span id="l47.9">     MAPIINIT_0 mapiInit = { MAPI_INIT_VERSION, MAPI_MULTITHREAD_NOTIFICATIONS } ;</span>
<a href="#l47.10"></a><span id="l47.10">     HRESULT retCode = mMAPIInitialize(&amp;mapiInit) ;</span>
<a href="#l47.11"></a><span id="l47.11"> </span>
<a href="#l47.12"></a><span id="l47.12" class="difflineminus">-    if (HR_FAILED(retCode)) { </span>
<a href="#l47.13"></a><span id="l47.13" class="difflineplus">+    if (HR_FAILED(retCode)) {</span>
<a href="#l47.14"></a><span id="l47.14">         PRINTF((&quot;Cannot initialize MAPI %08x.\n&quot;, retCode)) ; return FALSE ;</span>
<a href="#l47.15"></a><span id="l47.15">     }</span>
<a href="#l47.16"></a><span id="l47.16">     mInitialized = TRUE ;</span>
<a href="#l47.17"></a><span id="l47.17">     retCode = mMAPILogonEx(0, NULL, NULL,</span>
<a href="#l47.18"></a><span id="l47.18" class="difflineminus">-                           MAPI_NO_MAIL | </span>
<a href="#l47.19"></a><span id="l47.19" class="difflineminus">-                           MAPI_USE_DEFAULT | </span>
<a href="#l47.20"></a><span id="l47.20" class="difflineminus">-                           MAPI_EXTENDED | </span>
<a href="#l47.21"></a><span id="l47.21" class="difflineplus">+                           MAPI_NO_MAIL |</span>
<a href="#l47.22"></a><span id="l47.22" class="difflineplus">+                           MAPI_USE_DEFAULT |</span>
<a href="#l47.23"></a><span id="l47.23" class="difflineplus">+                           MAPI_EXTENDED |</span>
<a href="#l47.24"></a><span id="l47.24">                            MAPI_NEW_SESSION,</span>
<a href="#l47.25"></a><span id="l47.25">                            &amp;mRootSession) ;</span>
<a href="#l47.26"></a><span id="l47.26" class="difflineminus">-    if (HR_FAILED(retCode)) { </span>
<a href="#l47.27"></a><span id="l47.27" class="difflineplus">+    if (HR_FAILED(retCode)) {</span>
<a href="#l47.28"></a><span id="l47.28">         PRINTF((&quot;Cannot logon to MAPI %08x.\n&quot;, retCode)) ; return FALSE ;</span>
<a href="#l47.29"></a><span id="l47.29">     }</span>
<a href="#l47.30"></a><span id="l47.30">     mLogonDone = TRUE ;</span>
<a href="#l47.31"></a><span id="l47.31">     retCode = mRootSession-&gt;OpenAddressBook(0, NULL, 0, &amp;mRootBook) ;</span>
<a href="#l47.32"></a><span id="l47.32" class="difflineminus">-    if (HR_FAILED(retCode)) { </span>
<a href="#l47.33"></a><span id="l47.33" class="difflineplus">+    if (HR_FAILED(retCode)) {</span>
<a href="#l47.34"></a><span id="l47.34">         PRINTF((&quot;Cannot open MAPI address book %08x.\n&quot;, retCode)) ;</span>
<a href="#l47.35"></a><span id="l47.35">     }</span>
<a href="#l47.36"></a><span id="l47.36">     return HR_SUCCEEDED(retCode) ;</span>
<a href="#l47.37"></a><span id="l47.37"> }</span>
<a href="#l47.38"></a><span id="l47.38"> </span>
<a href="#l47.39"></a><span id="l47.39"> void nsMapiAddressBook::FreeMapiLibrary(void)</span>
<a href="#l47.40"></a><span id="l47.40"> {</span>
<a href="#l47.41"></a><span id="l47.41">     if (mLibrary) {</span>
<a href="#l47.42"></a><span id="l47.42">         if (-- mLibUsage == 0) {</span>
<a href="#l47.43"></a><span id="l47.43">             {</span>
<a href="#l47.44"></a><span id="l47.44">                 if (mRootBook) { mRootBook-&gt;Release() ; }</span>
<a href="#l47.45"></a><span id="l47.45">                 if (mRootSession) {</span>
<a href="#l47.46"></a><span id="l47.46" class="difflineminus">-                    if (mLogonDone) { </span>
<a href="#l47.47"></a><span id="l47.47" class="difflineminus">-                        mRootSession-&gt;Logoff(NULL, 0, 0) ; </span>
<a href="#l47.48"></a><span id="l47.48" class="difflineplus">+                    if (mLogonDone) {</span>
<a href="#l47.49"></a><span id="l47.49" class="difflineplus">+                        mRootSession-&gt;Logoff(NULL, 0, 0) ;</span>
<a href="#l47.50"></a><span id="l47.50">                         mLogonDone = FALSE ;</span>
<a href="#l47.51"></a><span id="l47.51">                     }</span>
<a href="#l47.52"></a><span id="l47.52">                     mRootSession-&gt;Release() ;</span>
<a href="#l47.53"></a><span id="l47.53">                 }</span>
<a href="#l47.54"></a><span id="l47.54" class="difflineminus">-                if (mInitialized) { </span>
<a href="#l47.55"></a><span id="l47.55" class="difflineminus">-                    mMAPIUninitialize() ; </span>
<a href="#l47.56"></a><span id="l47.56" class="difflineplus">+                if (mInitialized) {</span>
<a href="#l47.57"></a><span id="l47.57" class="difflineplus">+                    mMAPIUninitialize() ;</span>
<a href="#l47.58"></a><span id="l47.58">                     mInitialized = FALSE ;</span>
<a href="#l47.59"></a><span id="l47.59">                 }</span>
<a href="#l47.60"></a><span id="l47.60" class="difflineminus">-            }  </span>
<a href="#l47.61"></a><span id="l47.61" class="difflineplus">+            }</span>
<a href="#l47.62"></a><span id="l47.62">             FreeLibrary(mLibrary) ;</span>
<a href="#l47.63"></a><span id="l47.63" class="difflineminus">-            mLibrary = NULL ; </span>
<a href="#l47.64"></a><span id="l47.64" class="difflineplus">+            mLibrary = NULL ;</span>
<a href="#l47.65"></a><span id="l47.65">         }</span>
<a href="#l47.66"></a><span id="l47.66">     }</span>
<a href="#l47.67"></a><span id="l47.67"> }</span>
<a href="#l47.68"></a><span id="l47.68"> </span>
<a href="#l47.69"></a><span id="l47.69"> nsMapiAddressBook::nsMapiAddressBook(void)</span>
<a href="#l47.70"></a><span id="l47.70"> : nsAbWinHelper()</span>
<a href="#l47.71"></a><span id="l47.71"> {</span>
<a href="#l47.72"></a><span id="l47.72">     BOOL result = Initialize() ;</span>
<a href="#l47.73"></a><span id="l47.73" class="difflineat">@@ -119,17 +119,17 @@ BOOL nsMapiAddressBook::Initialize(void)</span>
<a href="#l47.74"></a><span id="l47.74"> {</span>
<a href="#l47.75"></a><span id="l47.75">     if (mAddressBook) { return TRUE ; }</span>
<a href="#l47.76"></a><span id="l47.76">     MutexAutoLock guard(*mMutex) ;</span>
<a href="#l47.77"></a><span id="l47.77"> </span>
<a href="#l47.78"></a><span id="l47.78">     if (!LoadMapiLibrary()) {</span>
<a href="#l47.79"></a><span id="l47.79">         PRINTF((&quot;Cannot load library.\n&quot;)) ;</span>
<a href="#l47.80"></a><span id="l47.80">         return FALSE ;</span>
<a href="#l47.81"></a><span id="l47.81">     }</span>
<a href="#l47.82"></a><span id="l47.82" class="difflineminus">-    mAddressBook = mRootBook ; </span>
<a href="#l47.83"></a><span id="l47.83" class="difflineplus">+    mAddressBook = mRootBook ;</span>
<a href="#l47.84"></a><span id="l47.84">     return TRUE ;</span>
<a href="#l47.85"></a><span id="l47.85"> }</span>
<a href="#l47.86"></a><span id="l47.86"> </span>
<a href="#l47.87"></a><span id="l47.87"> void nsMapiAddressBook::AllocateBuffer(ULONG aByteCount, LPVOID *aBuffer)</span>
<a href="#l47.88"></a><span id="l47.88"> {</span>
<a href="#l47.89"></a><span id="l47.89">     mMAPIAllocateBuffer(aByteCount, aBuffer) ;</span>
<a href="#l47.90"></a><span id="l47.90"> }</span>
<a href="#l47.91"></a><span id="l47.91"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l48.1"></a><span id="l48.1" class="difflineminus">--- a/mailnews/addrbook/src/nsMapiAddressBook.h</span>
<a href="#l48.2"></a><span id="l48.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsMapiAddressBook.h</span>
<a href="#l48.3"></a><span id="l48.3" class="difflineat">@@ -2,17 +2,17 @@</span>
<a href="#l48.4"></a><span id="l48.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l48.5"></a><span id="l48.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l48.6"></a><span id="l48.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l48.7"></a><span id="l48.7"> #ifndef nsMapiAddressBook_h___</span>
<a href="#l48.8"></a><span id="l48.8"> #define nsMapiAddressBook_h___</span>
<a href="#l48.9"></a><span id="l48.9"> </span>
<a href="#l48.10"></a><span id="l48.10"> #include &quot;mozilla/Attributes.h&quot;</span>
<a href="#l48.11"></a><span id="l48.11"> #include &quot;nsAbWinHelper.h&quot;</span>
<a href="#l48.12"></a><span id="l48.12" class="difflineminus">- </span>
<a href="#l48.13"></a><span id="l48.13" class="difflineplus">+</span>
<a href="#l48.14"></a><span id="l48.14"> class nsMapiAddressBook : public nsAbWinHelper</span>
<a href="#l48.15"></a><span id="l48.15"> {</span>
<a href="#l48.16"></a><span id="l48.16"> public :</span>
<a href="#l48.17"></a><span id="l48.17">     nsMapiAddressBook(void) ;</span>
<a href="#l48.18"></a><span id="l48.18">     virtual ~nsMapiAddressBook(void) ;</span>
<a href="#l48.19"></a><span id="l48.19"> </span>
<a href="#l48.20"></a><span id="l48.20"> protected :</span>
<a href="#l48.21"></a><span id="l48.21">     // Class members to handle the library/entry points</span>
<a href="#l48.22"></a><span id="l48.22" class="difflineat">@@ -23,32 +23,32 @@ protected :</span>
<a href="#l48.23"></a><span id="l48.23">     static LPMAPIALLOCATEBUFFER mMAPIAllocateBuffer ;</span>
<a href="#l48.24"></a><span id="l48.24">     static LPMAPIFREEBUFFER mMAPIFreeBuffer ;</span>
<a href="#l48.25"></a><span id="l48.25">     static LPMAPILOGONEX mMAPILogonEx ;</span>
<a href="#l48.26"></a><span id="l48.26">     // Shared session and address book used by all instances.</span>
<a href="#l48.27"></a><span id="l48.27">     // For reasons best left unknown, MAPI doesn't seem to like</span>
<a href="#l48.28"></a><span id="l48.28">     // having different threads playing with supposedly different</span>
<a href="#l48.29"></a><span id="l48.29">     // sessions and address books. They ll end up fighting over</span>
<a href="#l48.30"></a><span id="l48.30">     // the same resources, with hangups and GPF resulting. Not nice.</span>
<a href="#l48.31"></a><span id="l48.31" class="difflineminus">-    // So it seems that if everybody (as long as some client is </span>
<a href="#l48.32"></a><span id="l48.32" class="difflineplus">+    // So it seems that if everybody (as long as some client is</span>
<a href="#l48.33"></a><span id="l48.33">     // still alive) is using the same sessions and address books,</span>
<a href="#l48.34"></a><span id="l48.34">     // MAPI feels better. And who are we to get in the way of MAPI</span>
<a href="#l48.35"></a><span id="l48.35">     // happiness? Thus the following class members:</span>
<a href="#l48.36"></a><span id="l48.36">     static BOOL mInitialized ;</span>
<a href="#l48.37"></a><span id="l48.37">     static BOOL mLogonDone ;</span>
<a href="#l48.38"></a><span id="l48.38">     static LPMAPISESSION mRootSession ;</span>
<a href="#l48.39"></a><span id="l48.39">     static LPADRBOOK mRootBook ;</span>
<a href="#l48.40"></a><span id="l48.40"> </span>
<a href="#l48.41"></a><span id="l48.41">     // Load the MAPI environment</span>
<a href="#l48.42"></a><span id="l48.42">     BOOL Initialize(void) ;</span>
<a href="#l48.43"></a><span id="l48.43">     // Allocation of a buffer for transmission to interfaces</span>
<a href="#l48.44"></a><span id="l48.44">     virtual void AllocateBuffer(ULONG aByteCount, LPVOID *aBuffer) override;</span>
<a href="#l48.45"></a><span id="l48.45">     // Destruction of a buffer provided by the interfaces</span>
<a href="#l48.46"></a><span id="l48.46">     virtual void FreeBuffer(LPVOID aBuffer) override;</span>
<a href="#l48.47"></a><span id="l48.47" class="difflineminus">-    // Library management </span>
<a href="#l48.48"></a><span id="l48.48" class="difflineplus">+    // Library management</span>
<a href="#l48.49"></a><span id="l48.49">     static BOOL LoadMapiLibrary(void) ;</span>
<a href="#l48.50"></a><span id="l48.50">     static void FreeMapiLibrary(void) ;</span>
<a href="#l48.51"></a><span id="l48.51"> </span>
<a href="#l48.52"></a><span id="l48.52"> private :</span>
<a href="#l48.53"></a><span id="l48.53"> } ;</span>
<a href="#l48.54"></a><span id="l48.54"> </span>
<a href="#l48.55"></a><span id="l48.55"> #endif // nsMapiAddressBook_h___</span>
<a href="#l48.56"></a><span id="l48.56"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l49.1"></a><span id="l49.1" class="difflineminus">--- a/mailnews/addrbook/src/nsMsgVCardService.cpp</span>
<a href="#l49.2"></a><span id="l49.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsMsgVCardService.cpp</span>
<a href="#l49.3"></a><span id="l49.3" class="difflineat">@@ -2,17 +2,17 @@</span>
<a href="#l49.4"></a><span id="l49.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l49.5"></a><span id="l49.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l49.6"></a><span id="l49.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l49.7"></a><span id="l49.7"> </span>
<a href="#l49.8"></a><span id="l49.8"> #include &quot;nsMsgVCardService.h&quot;</span>
<a href="#l49.9"></a><span id="l49.9"> #include &quot;nsVCard.h&quot;</span>
<a href="#l49.10"></a><span id="l49.10"> #include &quot;prmem.h&quot;</span>
<a href="#l49.11"></a><span id="l49.11"> #include &quot;plstr.h&quot;</span>
<a href="#l49.12"></a><span id="l49.12" class="difflineminus">-    </span>
<a href="#l49.13"></a><span id="l49.13" class="difflineplus">+</span>
<a href="#l49.14"></a><span id="l49.14"> NS_IMPL_ISUPPORTS(nsMsgVCardService, nsIMsgVCardService)</span>
<a href="#l49.15"></a><span id="l49.15"> </span>
<a href="#l49.16"></a><span id="l49.16"> nsMsgVCardService::nsMsgVCardService()</span>
<a href="#l49.17"></a><span id="l49.17"> {</span>
<a href="#l49.18"></a><span id="l49.18"> }</span>
<a href="#l49.19"></a><span id="l49.19"> </span>
<a href="#l49.20"></a><span id="l49.20"> nsMsgVCardService::~nsMsgVCardService()</span>
<a href="#l49.21"></a><span id="l49.21"> {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l50.1"></a><span id="l50.1" class="difflineminus">--- a/mailnews/addrbook/src/nsVCard.h</span>
<a href="#l50.2"></a><span id="l50.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsVCard.h</span>
<a href="#l50.3"></a><span id="l50.3" class="difflineat">@@ -1,49 +1,49 @@</span>
<a href="#l50.4"></a><span id="l50.4"> /* -*- Mode: C; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l50.5"></a><span id="l50.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l50.6"></a><span id="l50.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l50.7"></a><span id="l50.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l50.8"></a><span id="l50.8"> </span>
<a href="#l50.9"></a><span id="l50.9"> </span>
<a href="#l50.10"></a><span id="l50.10"> /***************************************************************************</span>
<a href="#l50.11"></a><span id="l50.11" class="difflineminus">-(C) Copyright 1996 Apple Computer, Inc., AT&amp;T Corp., International             </span>
<a href="#l50.12"></a><span id="l50.12" class="difflineminus">-Business Machines Corporation and Siemens Rolm Communications Inc.             </span>
<a href="#l50.13"></a><span id="l50.13" class="difflineminus">-                                                                               </span>
<a href="#l50.14"></a><span id="l50.14" class="difflineminus">-For purposes of this license notice, the term Licensors shall mean,            </span>
<a href="#l50.15"></a><span id="l50.15" class="difflineminus">-collectively, Apple Computer, Inc., AT&amp;T Corp., International                  </span>
<a href="#l50.16"></a><span id="l50.16" class="difflineminus">-Business Machines Corporation and Siemens Rolm Communications Inc.             </span>
<a href="#l50.17"></a><span id="l50.17" class="difflineminus">-The term Licensor shall mean any of the Licensors.                             </span>
<a href="#l50.18"></a><span id="l50.18" class="difflineminus">-                                                                               </span>
<a href="#l50.19"></a><span id="l50.19" class="difflineminus">-Subject to acceptance of the following conditions, permission is hereby        </span>
<a href="#l50.20"></a><span id="l50.20" class="difflineminus">-granted by Licensors without the need for written agreement and without        </span>
<a href="#l50.21"></a><span id="l50.21" class="difflineminus">-license or royalty fees, to use, copy, modify and distribute this              </span>
<a href="#l50.22"></a><span id="l50.22" class="difflineminus">-software for any purpose.                                                      </span>
<a href="#l50.23"></a><span id="l50.23" class="difflineminus">-                                                                               </span>
<a href="#l50.24"></a><span id="l50.24" class="difflineminus">-The above copyright notice and the following four paragraphs must be           </span>
<a href="#l50.25"></a><span id="l50.25" class="difflineminus">-reproduced in all copies of this software and any software including           </span>
<a href="#l50.26"></a><span id="l50.26" class="difflineminus">-this software.                                                                 </span>
<a href="#l50.27"></a><span id="l50.27" class="difflineminus">-                                                                               </span>
<a href="#l50.28"></a><span id="l50.28" class="difflineminus">-THIS SOFTWARE IS PROVIDED ON AN &quot;AS IS&quot; BASIS AND NO LICENSOR SHALL HAVE       </span>
<a href="#l50.29"></a><span id="l50.29" class="difflineminus">-ANY OBLIGATION TO PROVIDE MAINTENANCE, SUPPORT, UPDATES, ENHANCEMENTS OR       </span>
<a href="#l50.30"></a><span id="l50.30" class="difflineminus">-MODIFICATIONS.                                                                 </span>
<a href="#l50.31"></a><span id="l50.31" class="difflineminus">-                                                                               </span>
<a href="#l50.32"></a><span id="l50.32" class="difflineminus">-IN NO EVENT SHALL ANY LICENSOR BE LIABLE TO ANY PARTY FOR DIRECT,              </span>
<a href="#l50.33"></a><span id="l50.33" class="difflineminus">-INDIRECT, SPECIAL OR CONSEQUENTIAL DAMAGES OR LOST PROFITS ARISING OUT         </span>
<a href="#l50.34"></a><span id="l50.34" class="difflineminus">-OF THE USE OF THIS SOFTWARE EVEN IF ADVISED OF THE POSSIBILITY OF SUCH         </span>
<a href="#l50.35"></a><span id="l50.35" class="difflineminus">-DAMAGE.                                                                        </span>
<a href="#l50.36"></a><span id="l50.36" class="difflineminus">-                                                                               </span>
<a href="#l50.37"></a><span id="l50.37" class="difflineminus">-EACH LICENSOR SPECIFICALLY DISCLAIMS ANY WARRANTIES, EXPRESS OR IMPLIED,       </span>
<a href="#l50.38"></a><span id="l50.38" class="difflineminus">-INCLUDING BUT NOT LIMITED TO ANY WARRANTY OF NONINFRINGEMENT OR THE            </span>
<a href="#l50.39"></a><span id="l50.39" class="difflineminus">-IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR             </span>
<a href="#l50.40"></a><span id="l50.40" class="difflineminus">-PURPOSE.                                                                       </span>
<a href="#l50.41"></a><span id="l50.41" class="difflineplus">+(C) Copyright 1996 Apple Computer, Inc., AT&amp;T Corp., International</span>
<a href="#l50.42"></a><span id="l50.42" class="difflineplus">+Business Machines Corporation and Siemens Rolm Communications Inc.</span>
<a href="#l50.43"></a><span id="l50.43" class="difflineplus">+</span>
<a href="#l50.44"></a><span id="l50.44" class="difflineplus">+For purposes of this license notice, the term Licensors shall mean,</span>
<a href="#l50.45"></a><span id="l50.45" class="difflineplus">+collectively, Apple Computer, Inc., AT&amp;T Corp., International</span>
<a href="#l50.46"></a><span id="l50.46" class="difflineplus">+Business Machines Corporation and Siemens Rolm Communications Inc.</span>
<a href="#l50.47"></a><span id="l50.47" class="difflineplus">+The term Licensor shall mean any of the Licensors.</span>
<a href="#l50.48"></a><span id="l50.48" class="difflineplus">+</span>
<a href="#l50.49"></a><span id="l50.49" class="difflineplus">+Subject to acceptance of the following conditions, permission is hereby</span>
<a href="#l50.50"></a><span id="l50.50" class="difflineplus">+granted by Licensors without the need for written agreement and without</span>
<a href="#l50.51"></a><span id="l50.51" class="difflineplus">+license or royalty fees, to use, copy, modify and distribute this</span>
<a href="#l50.52"></a><span id="l50.52" class="difflineplus">+software for any purpose.</span>
<a href="#l50.53"></a><span id="l50.53" class="difflineplus">+</span>
<a href="#l50.54"></a><span id="l50.54" class="difflineplus">+The above copyright notice and the following four paragraphs must be</span>
<a href="#l50.55"></a><span id="l50.55" class="difflineplus">+reproduced in all copies of this software and any software including</span>
<a href="#l50.56"></a><span id="l50.56" class="difflineplus">+this software.</span>
<a href="#l50.57"></a><span id="l50.57"> </span>
<a href="#l50.58"></a><span id="l50.58" class="difflineminus">-The software is provided with RESTRICTED RIGHTS.  Use, duplication, or         </span>
<a href="#l50.59"></a><span id="l50.59" class="difflineminus">-disclosure by the government are subject to restrictions set forth in          </span>
<a href="#l50.60"></a><span id="l50.60" class="difflineminus">-DFARS 252.227-7013 or 48 CFR 52.227-19, as applicable.                         </span>
<a href="#l50.61"></a><span id="l50.61" class="difflineplus">+THIS SOFTWARE IS PROVIDED ON AN &quot;AS IS&quot; BASIS AND NO LICENSOR SHALL HAVE</span>
<a href="#l50.62"></a><span id="l50.62" class="difflineplus">+ANY OBLIGATION TO PROVIDE MAINTENANCE, SUPPORT, UPDATES, ENHANCEMENTS OR</span>
<a href="#l50.63"></a><span id="l50.63" class="difflineplus">+MODIFICATIONS.</span>
<a href="#l50.64"></a><span id="l50.64" class="difflineplus">+</span>
<a href="#l50.65"></a><span id="l50.65" class="difflineplus">+IN NO EVENT SHALL ANY LICENSOR BE LIABLE TO ANY PARTY FOR DIRECT,</span>
<a href="#l50.66"></a><span id="l50.66" class="difflineplus">+INDIRECT, SPECIAL OR CONSEQUENTIAL DAMAGES OR LOST PROFITS ARISING OUT</span>
<a href="#l50.67"></a><span id="l50.67" class="difflineplus">+OF THE USE OF THIS SOFTWARE EVEN IF ADVISED OF THE POSSIBILITY OF SUCH</span>
<a href="#l50.68"></a><span id="l50.68" class="difflineplus">+DAMAGE.</span>
<a href="#l50.69"></a><span id="l50.69" class="difflineplus">+</span>
<a href="#l50.70"></a><span id="l50.70" class="difflineplus">+EACH LICENSOR SPECIFICALLY DISCLAIMS ANY WARRANTIES, EXPRESS OR IMPLIED,</span>
<a href="#l50.71"></a><span id="l50.71" class="difflineplus">+INCLUDING BUT NOT LIMITED TO ANY WARRANTY OF NONINFRINGEMENT OR THE</span>
<a href="#l50.72"></a><span id="l50.72" class="difflineplus">+IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR</span>
<a href="#l50.73"></a><span id="l50.73" class="difflineplus">+PURPOSE.</span>
<a href="#l50.74"></a><span id="l50.74" class="difflineplus">+</span>
<a href="#l50.75"></a><span id="l50.75" class="difflineplus">+The software is provided with RESTRICTED RIGHTS.  Use, duplication, or</span>
<a href="#l50.76"></a><span id="l50.76" class="difflineplus">+disclosure by the government are subject to restrictions set forth in</span>
<a href="#l50.77"></a><span id="l50.77" class="difflineplus">+DFARS 252.227-7013 or 48 CFR 52.227-19, as applicable.</span>
<a href="#l50.78"></a><span id="l50.78"> </span>
<a href="#l50.79"></a><span id="l50.79"> ***************************************************************************/</span>
<a href="#l50.80"></a><span id="l50.80"> </span>
<a href="#l50.81"></a><span id="l50.81"> #ifndef __VCC_H__</span>
<a href="#l50.82"></a><span id="l50.82"> #define __VCC_H__ 1</span>
<a href="#l50.83"></a><span id="l50.83"> </span>
<a href="#l50.84"></a><span id="l50.84"> #include &quot;nsVCardObj.h&quot;</span>
<a href="#l50.85"></a><span id="l50.85"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l51.1"></a><span id="l51.1" class="difflineminus">--- a/mailnews/addrbook/src/nsWabAddressBook.h</span>
<a href="#l51.2"></a><span id="l51.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsWabAddressBook.h</span>
<a href="#l51.3"></a><span id="l51.3" class="difflineat">@@ -34,17 +34,17 @@ protected :</span>
<a href="#l51.4"></a><span id="l51.4">     // Manage the library</span>
<a href="#l51.5"></a><span id="l51.5">     static BOOL LoadWabLibrary(void) ;</span>
<a href="#l51.6"></a><span id="l51.6">     static void FreeWabLibrary(void) ;</span>
<a href="#l51.7"></a><span id="l51.7"> </span>
<a href="#l51.8"></a><span id="l51.8"> private :</span>
<a href="#l51.9"></a><span id="l51.9"> } ;</span>
<a href="#l51.10"></a><span id="l51.10"> </span>
<a href="#l51.11"></a><span id="l51.11"> // Additional definitions for WAB stuff. These properties are</span>
<a href="#l51.12"></a><span id="l51.12" class="difflineminus">-// only defined with regards to the default character sizes, </span>
<a href="#l51.13"></a><span id="l51.13" class="difflineplus">+// only defined with regards to the default character sizes,</span>
<a href="#l51.14"></a><span id="l51.14"> // and not in two _A and _W versions...</span>
<a href="#l51.15"></a><span id="l51.15"> #define PR_BUSINESS_ADDRESS_CITY_A                    PR_LOCALITY_A</span>
<a href="#l51.16"></a><span id="l51.16"> #define PR_BUSINESS_ADDRESS_COUNTRY_A                 PR_COUNTRY_A</span>
<a href="#l51.17"></a><span id="l51.17"> #define PR_BUSINESS_ADDRESS_POSTAL_CODE_A             PR_POSTAL_CODE_A</span>
<a href="#l51.18"></a><span id="l51.18"> #define PR_BUSINESS_ADDRESS_STATE_OR_PROVINCE_A       PR_STATE_OR_PROVINCE_A</span>
<a href="#l51.19"></a><span id="l51.19"> #define PR_BUSINESS_ADDRESS_STREET_A                  PR_STREET_ADDRESS_A</span>
<a href="#l51.20"></a><span id="l51.20"> </span>
<a href="#l51.21"></a><span id="l51.21"> #define PR_BUSINESS_ADDRESS_CITY_W                    PR_LOCALITY_W</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

