<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 1135:9b7fe8e84e729afa50ea50bde4bae0085d275c2b</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 9b7fe8e84e729afa50ea50bde4bae0085d275c2b" />
<meta property="og:url" content="/comm-central/rev/9b7fe8e84e729afa50ea50bde4bae0085d275c2b" />
<meta property="og:description" content="Fix bug 463047 - Use js 1.7 iterators for properties bag and ical components. r=dbo" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 9b7fe8e84e729afa50ea50bde4bae0085d275c2b 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/9b7fe8e84e729afa50ea50bde4bae0085d275c2b">shortlog</a> |
<a href="/comm-central/log/9b7fe8e84e729afa50ea50bde4bae0085d275c2b">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/9b7fe8e84e729afa50ea50bde4bae0085d275c2b">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/9b7fe8e84e729afa50ea50bde4bae0085d275c2b">files</a> |
changeset |
<a href="/comm-central/raw-rev/9b7fe8e84e729afa50ea50bde4bae0085d275c2b">raw</a>  | <a href="/comm-central/archive/9b7fe8e84e729afa50ea50bde4bae0085d275c2b.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
Fix <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=463047">bug 463047</a> - Use js 1.7 iterators for properties bag and ical components. r=dbo
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#80;&#104;&#105;&#108;&#105;&#112;&#112;&#32;&#75;&#101;&#119;&#105;&#115;&#99;&#104;&#32;&#60;&#109;&#111;&#122;&#105;&#108;&#108;&#97;&#64;&#107;&#101;&#119;&#105;&#115;&#46;&#99;&#104;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 17 Nov 2008 23:05:54 +0100</td></tr>

<tr>
 <td>changeset 1135</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/9b7fe8e84e729afa50ea50bde4bae0085d275c2b">9b7fe8e84e729afa50ea50bde4bae0085d275c2b</a></td>
</tr>



<tr>
<td>parent 1134</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/8b6c95c5c9731993024a88720365439f90f9d3a6">8b6c95c5c9731993024a88720365439f90f9d3a6</a>
</td>
</tr>

<tr>
<td>child 1136</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/641c14ca52102329aa4913a202ce803be44bb31c">641c14ca52102329aa4913a202ce803be44bb31c</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=9b7fe8e84e729afa50ea50bde4bae0085d275c2b">866</a></td></tr>
<tr><td>push user</td><td>mozilla@kewis.ch</td></tr>
<tr><td>push date</td><td class="date age">Mon, 17 Nov 2008 22:06:46 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@9b7fe8e84e72 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=9b7fe8e84e729afa50ea50bde4bae0085d275c2b">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=9b7fe8e84e729afa50ea50bde4bae0085d275c2b&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=9b7fe8e84e729afa50ea50bde4bae0085d275c2b&newProject=comm-central&newRevision=9b7fe8e84e729afa50ea50bde4bae0085d275c2b&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=9b7fe8e84e729afa50ea50bde4bae0085d275c2b&newProject=comm-central&newRevision=9b7fe8e84e729afa50ea50bde4bae0085d275c2b&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=9b7fe8e84e729afa50ea50bde4bae0085d275c2b&newProject=comm-central&newRevision=9b7fe8e84e729afa50ea50bde4bae0085d275c2b&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28dbo%29&revcount=50">dbo</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=463047">463047</a></td></tr>




</table></div>

<div class="page_body description">Fix <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=463047">bug 463047</a> - Use js 1.7 iterators for properties bag and ical components. r=dbo</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/content/calendar-clipboard.js">calendar/base/content/calendar-clipboard.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/content/calendar-clipboard.js">file</a> |
<a href="/comm-central/annotate/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/content/calendar-clipboard.js">annotate</a> |
<a href="/comm-central/diff/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/content/calendar-clipboard.js">diff</a> |
<a href="/comm-central/comparison/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/content/calendar-clipboard.js">comparison</a> |
<a href="/comm-central/log/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/content/calendar-clipboard.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/modules/Makefile.in">calendar/base/modules/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/modules/Makefile.in">file</a> |
<a href="/comm-central/annotate/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/modules/Makefile.in">annotate</a> |
<a href="/comm-central/diff/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/modules/Makefile.in">diff</a> |
<a href="/comm-central/comparison/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/modules/Makefile.in">comparison</a> |
<a href="/comm-central/log/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/modules/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/modules/calIteratorUtils.jsm">calendar/base/modules/calIteratorUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/modules/calIteratorUtils.jsm">file</a> |
<a href="/comm-central/annotate/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/modules/calIteratorUtils.jsm">annotate</a> |
<a href="/comm-central/diff/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/modules/calIteratorUtils.jsm">diff</a> |
<a href="/comm-central/comparison/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/modules/calIteratorUtils.jsm">comparison</a> |
<a href="/comm-central/log/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/modules/calIteratorUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/modules/calItipUtils.jsm">calendar/base/modules/calItipUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/modules/calItipUtils.jsm">file</a> |
<a href="/comm-central/annotate/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/modules/calItipUtils.jsm">annotate</a> |
<a href="/comm-central/diff/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/modules/calItipUtils.jsm">diff</a> |
<a href="/comm-central/comparison/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/modules/calItipUtils.jsm">comparison</a> |
<a href="/comm-central/log/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/modules/calItipUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/modules/calUtils.jsm">calendar/base/modules/calUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/modules/calUtils.jsm">file</a> |
<a href="/comm-central/annotate/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/modules/calUtils.jsm">annotate</a> |
<a href="/comm-central/diff/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/modules/calUtils.jsm">diff</a> |
<a href="/comm-central/comparison/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/modules/calUtils.jsm">comparison</a> |
<a href="/comm-central/log/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/modules/calUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/src/calAttachment.js">calendar/base/src/calAttachment.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/src/calAttachment.js">file</a> |
<a href="/comm-central/annotate/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/src/calAttachment.js">annotate</a> |
<a href="/comm-central/diff/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/src/calAttachment.js">diff</a> |
<a href="/comm-central/comparison/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/src/calAttachment.js">comparison</a> |
<a href="/comm-central/log/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/src/calAttachment.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/src/calAttendee.js">calendar/base/src/calAttendee.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/src/calAttendee.js">file</a> |
<a href="/comm-central/annotate/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/src/calAttendee.js">annotate</a> |
<a href="/comm-central/diff/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/src/calAttendee.js">diff</a> |
<a href="/comm-central/comparison/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/src/calAttendee.js">comparison</a> |
<a href="/comm-central/log/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/src/calAttendee.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/src/calIcsParser.js">calendar/base/src/calIcsParser.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/src/calIcsParser.js">file</a> |
<a href="/comm-central/annotate/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/src/calIcsParser.js">annotate</a> |
<a href="/comm-central/diff/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/src/calIcsParser.js">diff</a> |
<a href="/comm-central/comparison/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/src/calIcsParser.js">comparison</a> |
<a href="/comm-central/log/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/src/calIcsParser.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/src/calIcsSerializer.js">calendar/base/src/calIcsSerializer.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/src/calIcsSerializer.js">file</a> |
<a href="/comm-central/annotate/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/src/calIcsSerializer.js">annotate</a> |
<a href="/comm-central/diff/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/src/calIcsSerializer.js">diff</a> |
<a href="/comm-central/comparison/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/src/calIcsSerializer.js">comparison</a> |
<a href="/comm-central/log/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/src/calIcsSerializer.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/src/calItemBase.js">calendar/base/src/calItemBase.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/src/calItemBase.js">file</a> |
<a href="/comm-central/annotate/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/src/calItemBase.js">annotate</a> |
<a href="/comm-central/diff/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/src/calItemBase.js">diff</a> |
<a href="/comm-central/comparison/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/src/calItemBase.js">comparison</a> |
<a href="/comm-central/log/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/src/calItemBase.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/src/calItemModule.js">calendar/base/src/calItemModule.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/src/calItemModule.js">file</a> |
<a href="/comm-central/annotate/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/src/calItemModule.js">annotate</a> |
<a href="/comm-central/diff/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/src/calItemModule.js">diff</a> |
<a href="/comm-central/comparison/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/src/calItemModule.js">comparison</a> |
<a href="/comm-central/log/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/src/calItemModule.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/src/calItipItem.js">calendar/base/src/calItipItem.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/src/calItipItem.js">file</a> |
<a href="/comm-central/annotate/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/src/calItipItem.js">annotate</a> |
<a href="/comm-central/diff/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/src/calItipItem.js">diff</a> |
<a href="/comm-central/comparison/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/src/calItipItem.js">comparison</a> |
<a href="/comm-central/log/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/src/calItipItem.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/src/calRelation.js">calendar/base/src/calRelation.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/src/calRelation.js">file</a> |
<a href="/comm-central/annotate/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/src/calRelation.js">annotate</a> |
<a href="/comm-central/diff/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/src/calRelation.js">diff</a> |
<a href="/comm-central/comparison/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/src/calRelation.js">comparison</a> |
<a href="/comm-central/log/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/src/calRelation.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/src/calTimezoneService.js">calendar/base/src/calTimezoneService.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/src/calTimezoneService.js">file</a> |
<a href="/comm-central/annotate/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/src/calTimezoneService.js">annotate</a> |
<a href="/comm-central/diff/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/src/calTimezoneService.js">diff</a> |
<a href="/comm-central/comparison/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/src/calTimezoneService.js">comparison</a> |
<a href="/comm-central/log/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/src/calTimezoneService.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/src/calUtils.js">calendar/base/src/calUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/src/calUtils.js">file</a> |
<a href="/comm-central/annotate/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/src/calUtils.js">annotate</a> |
<a href="/comm-central/diff/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/src/calUtils.js">diff</a> |
<a href="/comm-central/comparison/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/src/calUtils.js">comparison</a> |
<a href="/comm-central/log/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/base/src/calUtils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/providers/caldav/calDavCalendar.js">calendar/providers/caldav/calDavCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/providers/caldav/calDavCalendar.js">file</a> |
<a href="/comm-central/annotate/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/providers/caldav/calDavCalendar.js">annotate</a> |
<a href="/comm-central/diff/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/providers/caldav/calDavCalendar.js">diff</a> |
<a href="/comm-central/comparison/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/providers/caldav/calDavCalendar.js">comparison</a> |
<a href="/comm-central/log/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/providers/caldav/calDavCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/providers/gdata/components/calGoogleUtils.js">calendar/providers/gdata/components/calGoogleUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/providers/gdata/components/calGoogleUtils.js">file</a> |
<a href="/comm-central/annotate/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/providers/gdata/components/calGoogleUtils.js">annotate</a> |
<a href="/comm-central/diff/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/providers/gdata/components/calGoogleUtils.js">diff</a> |
<a href="/comm-central/comparison/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/providers/gdata/components/calGoogleUtils.js">comparison</a> |
<a href="/comm-central/log/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/providers/gdata/components/calGoogleUtils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/providers/wcap/calWcapCalendarItems.js">calendar/providers/wcap/calWcapCalendarItems.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/providers/wcap/calWcapCalendarItems.js">file</a> |
<a href="/comm-central/annotate/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/providers/wcap/calWcapCalendarItems.js">annotate</a> |
<a href="/comm-central/diff/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/providers/wcap/calWcapCalendarItems.js">diff</a> |
<a href="/comm-central/comparison/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/providers/wcap/calWcapCalendarItems.js">comparison</a> |
<a href="/comm-central/log/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/providers/wcap/calWcapCalendarItems.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/providers/wcap/calWcapSession.js">calendar/providers/wcap/calWcapSession.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/providers/wcap/calWcapSession.js">file</a> |
<a href="/comm-central/annotate/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/providers/wcap/calWcapSession.js">annotate</a> |
<a href="/comm-central/diff/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/providers/wcap/calWcapSession.js">diff</a> |
<a href="/comm-central/comparison/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/providers/wcap/calWcapSession.js">comparison</a> |
<a href="/comm-central/log/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/providers/wcap/calWcapSession.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/providers/wcap/calWcapUtils.js">calendar/providers/wcap/calWcapUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/providers/wcap/calWcapUtils.js">file</a> |
<a href="/comm-central/annotate/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/providers/wcap/calWcapUtils.js">annotate</a> |
<a href="/comm-central/diff/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/providers/wcap/calWcapUtils.js">diff</a> |
<a href="/comm-central/comparison/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/providers/wcap/calWcapUtils.js">comparison</a> |
<a href="/comm-central/log/9b7fe8e84e729afa50ea50bde4bae0085d275c2b/calendar/providers/wcap/calWcapUtils.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/base/content/calendar-clipboard.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/base/content/calendar-clipboard.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -163,33 +163,31 @@ function pasteFromClipboard() {</span>
<a href="#l1.4"></a><span id="l1.4">         case &quot;text/calendar&quot;:</span>
<a href="#l1.5"></a><span id="l1.5">         case &quot;text/unicode&quot;:</span>
<a href="#l1.6"></a><span id="l1.6">             let destCal = getSelectedCalendar();</span>
<a href="#l1.7"></a><span id="l1.7">             if (!destCal) {</span>
<a href="#l1.8"></a><span id="l1.8">                 return;</span>
<a href="#l1.9"></a><span id="l1.9">             }</span>
<a href="#l1.10"></a><span id="l1.10"> </span>
<a href="#l1.11"></a><span id="l1.11">             let calComp = cal.getIcsService().parseICS(data, null);</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-            let subComp = calComp.getFirstSubcomponent(&quot;ANY&quot;);</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-            while (subComp) {</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+            for (let subComp in cal.ical.calendarComponentIterator(calComp)) {</span>
<a href="#l1.15"></a><span id="l1.15">                 switch (subComp.componentType) {</span>
<a href="#l1.16"></a><span id="l1.16">                     case &quot;VEVENT&quot;:</span>
<a href="#l1.17"></a><span id="l1.17">                         let event = cal.createEvent();</span>
<a href="#l1.18"></a><span id="l1.18">                         event.icalComponent = subComp;</span>
<a href="#l1.19"></a><span id="l1.19">                         items.push(event);</span>
<a href="#l1.20"></a><span id="l1.20">                         break;</span>
<a href="#l1.21"></a><span id="l1.21">                     case &quot;VTODO&quot;:</span>
<a href="#l1.22"></a><span id="l1.22">                         let todo = cal.createTodo();</span>
<a href="#l1.23"></a><span id="l1.23">                         todo.icalComponent = subComp;</span>
<a href="#l1.24"></a><span id="l1.24">                         items.push(todo);</span>
<a href="#l1.25"></a><span id="l1.25">                         break;</span>
<a href="#l1.26"></a><span id="l1.26">                     default:</span>
<a href="#l1.27"></a><span id="l1.27">                         break;</span>
<a href="#l1.28"></a><span id="l1.28">                 }</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineminus">-                subComp = calComp.getNextSubcomponent(&quot;ANY&quot;);</span>
<a href="#l1.30"></a><span id="l1.30">             }</span>
<a href="#l1.31"></a><span id="l1.31"> </span>
<a href="#l1.32"></a><span id="l1.32">             // If there are multiple items on the clipboard, the earliest</span>
<a href="#l1.33"></a><span id="l1.33">             // should be set to the selected day and the rest adjusted.</span>
<a href="#l1.34"></a><span id="l1.34">             let earliestDate = null;</span>
<a href="#l1.35"></a><span id="l1.35">             for each (let item in items) {</span>
<a href="#l1.36"></a><span id="l1.36">                 let date = null;</span>
<a href="#l1.37"></a><span id="l1.37">                 if (item.startDate) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/calendar/base/modules/Makefile.in</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/calendar/base/modules/Makefile.in</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -41,12 +41,13 @@ srcdir    = @srcdir@</span>
<a href="#l2.4"></a><span id="l2.4"> VPATH     = @srcdir@</span>
<a href="#l2.5"></a><span id="l2.5"> </span>
<a href="#l2.6"></a><span id="l2.6"> include $(DEPTH)/config/autoconf.mk</span>
<a href="#l2.7"></a><span id="l2.7"> </span>
<a href="#l2.8"></a><span id="l2.8"> MODULE = calbase</span>
<a href="#l2.9"></a><span id="l2.9"> </span>
<a href="#l2.10"></a><span id="l2.10"> EXTRA_JS_MODULES = \</span>
<a href="#l2.11"></a><span id="l2.11">     calUtils.jsm \</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+    calIteratorUtils.jsm \</span>
<a href="#l2.13"></a><span id="l2.13">     calItipUtils.jsm \</span>
<a href="#l2.14"></a><span id="l2.14">     $(NULL)</span>
<a href="#l2.15"></a><span id="l2.15"> </span>
<a href="#l2.16"></a><span id="l2.16"> include $(topsrcdir)/config/rules.mk</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1">new file mode 100644</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineminus">--- /dev/null</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineplus">+++ b/calendar/base/modules/calIteratorUtils.jsm</span>
<a href="#l3.4"></a><span id="l3.4" class="difflineat">@@ -0,0 +1,184 @@</span>
<a href="#l3.5"></a><span id="l3.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l3.6"></a><span id="l3.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l3.7"></a><span id="l3.7" class="difflineplus">+ *</span>
<a href="#l3.8"></a><span id="l3.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l3.9"></a><span id="l3.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l3.10"></a><span id="l3.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l3.11"></a><span id="l3.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+ *</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+ * License.</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+ *</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+ * The Original Code is Sun Microsystems code.</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+ *</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+ *   Philipp Kewisch &lt;mozilla@kewis.ch&gt;</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+ *</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+ *</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+ *</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+EXPORTED_SYMBOLS = [&quot;cal&quot;]; // even though it's defined in calUtils.jsm, import needs this</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+/**</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineplus">+ * Iterates an array of items, i.e. the passed item including all</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+ * overridden instances of a recurring series.</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineplus">+ *</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineplus">+ * @param items array of items</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+ */</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+cal.itemIterator = function cal_itemIterator(items) {</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineplus">+    return {</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineplus">+        __iterator__: function itemIterator(aWantKeys) {</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineplus">+            cal.ASSERT(aWantKeys, &quot;Please use for() on the item iterator&quot;);</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineplus">+            for each (let item in items) {</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineplus">+                yield item;</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineplus">+                let rec = item.recurrenceInfo;</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineplus">+                if (rec) {</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineplus">+                    for each (let exid in rec.getExceptionIds({})) {</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineplus">+                        yield rec.getExceptionFor(exid, false);</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+                    }</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineplus">+                }</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineplus">+            }</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineplus">+        }</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineplus">+    };</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineplus">+};</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineplus">+</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineplus">+/**</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineplus">+ * &quot;ical&quot; namespace. Used for all iterators (and possibly other functions) that</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineplus">+ * are related to libical.</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineplus">+ */</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineplus">+cal.ical = {</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineplus">+    /**</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineplus">+     *  Yields all subcomponents in all calendars in the passed component.</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineplus">+     *  - If the passed component is an XROOT (contains multiple calendars),</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineplus">+     *    then go through all VCALENDARs in it and get their subcomponents.</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineplus">+     *  - If the passed component is a VCALENDAR, iterate through its direct</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineplus">+     *    subcomponents.</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineplus">+     *  - Otherwise assume the passed component is the item itself and yield</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineplus">+     *    only the passed component.</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineplus">+     *</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineplus">+     * This iterator can only be used in a for() block:</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineplus">+     *   for (let component in cal.ical.calendarComponentIterator(aComp)) { ... }</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineplus">+     *</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineplus">+     *  @param aComponent       The component to iterate given the above rules.</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineplus">+     *  @param aCompType        The type of item to iterate.</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineplus">+     *  @return                 The iterator that yields all items.</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineplus">+     */</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineplus">+    calendarComponentIterator: function cal_ical_calendarComponentIterator(aComponent, aCompType) {</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineplus">+        let compType = (aCompType || &quot;ANY&quot;);</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineplus">+        if (aComponent &amp;&amp; aComponent.componentType == &quot;VCALENDAR&quot;) {</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineplus">+            return cal.ical.subcompentIterator(aComponent, compType);</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineplus">+        } else if (aComponent &amp;&amp; aComponent.componentType == &quot;XROOT&quot;) {</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineplus">+            function calVCALENDARIterator(aWantKeys) {</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineplus">+                cal.ASSERT(aWantKeys, &quot;Please use for() on the calendar component iterator&quot;);</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineplus">+                for (let calComp in cal.ical.subcomponentIterator(aComponent, &quot;VCALENDAR&quot;)) {</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineplus">+                    for (let itemComp in cal.ical.subcomponentIterator(calComp, compType)) {</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineplus">+                        yield itemComp;</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineplus">+                    }</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineplus">+                }</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineplus">+            };</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineplus">+            return { __iterator__: calVCALENDARIterator };</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineplus">+        } else if (aComponent &amp;&amp; (compType == &quot;ANY&quot; || compType == aComponent.componentType)) {</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineplus">+            return {</span>
<a href="#l3.105"></a><span id="l3.105" class="difflineplus">+                __iterator__: function singleItemIterator(aWantKeys) {</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineplus">+                    cal.ASSERT(aWantKeys, &quot;Please use for() on the calendar component iterator&quot;);</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineplus">+                    yield aComponent;</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineplus">+                }</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineplus">+            }</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineplus">+        } else {</span>
<a href="#l3.111"></a><span id="l3.111" class="difflineplus">+            return Iterator({});</span>
<a href="#l3.112"></a><span id="l3.112" class="difflineplus">+        }</span>
<a href="#l3.113"></a><span id="l3.113" class="difflineplus">+    },</span>
<a href="#l3.114"></a><span id="l3.114" class="difflineplus">+</span>
<a href="#l3.115"></a><span id="l3.115" class="difflineplus">+    /**</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineplus">+     * Use to iterate through all subcomponents of a calIIcalComponent. This</span>
<a href="#l3.117"></a><span id="l3.117" class="difflineplus">+     * iterators depth is 1, this means no sub-sub-components will be iterated.</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineplus">+     *</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineplus">+     * This iterator can only be used in a for() block:</span>
<a href="#l3.120"></a><span id="l3.120" class="difflineplus">+     *   for (let component in cal.ical.subcomponentIterator(aComp)) { ... }</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineplus">+     *</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineplus">+     * @param aComponent        The component who's subcomponents to iterate.</span>
<a href="#l3.123"></a><span id="l3.123" class="difflineplus">+     * @param aSubcomp          (optional) the specific subcomponent to</span>
<a href="#l3.124"></a><span id="l3.124" class="difflineplus">+     *                            enumerate. If not given, &quot;ANY&quot; will be used.</span>
<a href="#l3.125"></a><span id="l3.125" class="difflineplus">+     * @return                  An iterator object to iterate the properties.</span>
<a href="#l3.126"></a><span id="l3.126" class="difflineplus">+     */</span>
<a href="#l3.127"></a><span id="l3.127" class="difflineplus">+    subcomponentIterator: function cal_ical_subcomponentIterator(aComponent, aSubcomp) {</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineplus">+        return {</span>
<a href="#l3.129"></a><span id="l3.129" class="difflineplus">+            __iterator__: function icalSubcompIterator(aWantKeys) {</span>
<a href="#l3.130"></a><span id="l3.130" class="difflineplus">+                cal.ASSERT(aWantKeys, &quot;Please use for() on the subcomponent iterator&quot;);</span>
<a href="#l3.131"></a><span id="l3.131" class="difflineplus">+                let subcompName = (aSubcomp || &quot;ANY&quot;);</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineplus">+                for (let subcomp = aComponent.getFirstSubcomponent(subcompName);</span>
<a href="#l3.133"></a><span id="l3.133" class="difflineplus">+                     subcomp;</span>
<a href="#l3.134"></a><span id="l3.134" class="difflineplus">+                     subcomp = aComponent.getNextSubcomponent(subcompName)) {</span>
<a href="#l3.135"></a><span id="l3.135" class="difflineplus">+                    yield subcomp;</span>
<a href="#l3.136"></a><span id="l3.136" class="difflineplus">+                }</span>
<a href="#l3.137"></a><span id="l3.137" class="difflineplus">+            }</span>
<a href="#l3.138"></a><span id="l3.138" class="difflineplus">+        };</span>
<a href="#l3.139"></a><span id="l3.139" class="difflineplus">+    },</span>
<a href="#l3.140"></a><span id="l3.140" class="difflineplus">+</span>
<a href="#l3.141"></a><span id="l3.141" class="difflineplus">+    /**</span>
<a href="#l3.142"></a><span id="l3.142" class="difflineplus">+     * Use to iterate through all properties of a calIIcalComponent.</span>
<a href="#l3.143"></a><span id="l3.143" class="difflineplus">+     * This iterator can only be used in a for() block:</span>
<a href="#l3.144"></a><span id="l3.144" class="difflineplus">+     *   for (let property in cal.ical.propertyIterator(aComp)) { ... }</span>
<a href="#l3.145"></a><span id="l3.145" class="difflineplus">+     *</span>
<a href="#l3.146"></a><span id="l3.146" class="difflineplus">+     * @param aComponent        The component to iterate.</span>
<a href="#l3.147"></a><span id="l3.147" class="difflineplus">+     * @param aProperty         (optional) the specific property to enumerate.</span>
<a href="#l3.148"></a><span id="l3.148" class="difflineplus">+     *                            If not given, &quot;ANY&quot; will be used.</span>
<a href="#l3.149"></a><span id="l3.149" class="difflineplus">+     * @return                  An iterator object to iterate the properties.</span>
<a href="#l3.150"></a><span id="l3.150" class="difflineplus">+     */</span>
<a href="#l3.151"></a><span id="l3.151" class="difflineplus">+    propertyIterator: function cal_ical_propertyIterator(aComponent, aProperty) {</span>
<a href="#l3.152"></a><span id="l3.152" class="difflineplus">+        return {</span>
<a href="#l3.153"></a><span id="l3.153" class="difflineplus">+            __iterator__: function icalPropertyIterator(aWantKeys) {</span>
<a href="#l3.154"></a><span id="l3.154" class="difflineplus">+                cal.ASSERT(aWantKeys, &quot;Please use for() on the property iterator&quot;);</span>
<a href="#l3.155"></a><span id="l3.155" class="difflineplus">+                let propertyName = (aProperty || &quot;ANY&quot;);</span>
<a href="#l3.156"></a><span id="l3.156" class="difflineplus">+                for (let prop = aComponent.getFirstProperty(propertyName);</span>
<a href="#l3.157"></a><span id="l3.157" class="difflineplus">+                     prop;</span>
<a href="#l3.158"></a><span id="l3.158" class="difflineplus">+                     prop = aComponent.getNextProperty(propertyName)) {</span>
<a href="#l3.159"></a><span id="l3.159" class="difflineplus">+                    yield prop;</span>
<a href="#l3.160"></a><span id="l3.160" class="difflineplus">+                }</span>
<a href="#l3.161"></a><span id="l3.161" class="difflineplus">+            }</span>
<a href="#l3.162"></a><span id="l3.162" class="difflineplus">+        };</span>
<a href="#l3.163"></a><span id="l3.163" class="difflineplus">+    },</span>
<a href="#l3.164"></a><span id="l3.164" class="difflineplus">+</span>
<a href="#l3.165"></a><span id="l3.165" class="difflineplus">+    /**</span>
<a href="#l3.166"></a><span id="l3.166" class="difflineplus">+     * Use to iterate through all parameters of a calIIcalProperty.</span>
<a href="#l3.167"></a><span id="l3.167" class="difflineplus">+     * This iterator behaves similar to the object iterator. Possible uses:</span>
<a href="#l3.168"></a><span id="l3.168" class="difflineplus">+     *   for (let paramName in cal.ical.paramIterator(prop)) { ... }</span>
<a href="#l3.169"></a><span id="l3.169" class="difflineplus">+     * or:</span>
<a href="#l3.170"></a><span id="l3.170" class="difflineplus">+     *   for each (let [paramName, paramValue] in cal.ical.paramIterator(prop)) { ... }</span>
<a href="#l3.171"></a><span id="l3.171" class="difflineplus">+     *</span>
<a href="#l3.172"></a><span id="l3.172" class="difflineplus">+     * @param aProperty         The property to iterate.</span>
<a href="#l3.173"></a><span id="l3.173" class="difflineplus">+     * @return                  An iterator object to iterate the properties.</span>
<a href="#l3.174"></a><span id="l3.174" class="difflineplus">+     */</span>
<a href="#l3.175"></a><span id="l3.175" class="difflineplus">+    paramIterator: function cal_ical_paramIterator(aProperty) {</span>
<a href="#l3.176"></a><span id="l3.176" class="difflineplus">+        return {</span>
<a href="#l3.177"></a><span id="l3.177" class="difflineplus">+            __iterator__: function icalParamIterator(aWantKeys) {</span>
<a href="#l3.178"></a><span id="l3.178" class="difflineplus">+                for (let paramName = aProperty.getFirstParameterName();</span>
<a href="#l3.179"></a><span id="l3.179" class="difflineplus">+                     paramName;</span>
<a href="#l3.180"></a><span id="l3.180" class="difflineplus">+                     paramName = aProperty.getNextParameterName()) {</span>
<a href="#l3.181"></a><span id="l3.181" class="difflineplus">+                    yield (aWantKeys ? paramName :</span>
<a href="#l3.182"></a><span id="l3.182" class="difflineplus">+                           [paramName, aProperty.getParameter(paramName)]);</span>
<a href="#l3.183"></a><span id="l3.183" class="difflineplus">+                }</span>
<a href="#l3.184"></a><span id="l3.184" class="difflineplus">+            }</span>
<a href="#l3.185"></a><span id="l3.185" class="difflineplus">+        }</span>
<a href="#l3.186"></a><span id="l3.186" class="difflineplus">+    }</span>
<a href="#l3.187"></a><span id="l3.187" class="difflineplus">+};</span>
<a href="#l3.188"></a><span id="l3.188" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/calendar/base/modules/calItipUtils.jsm</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/calendar/base/modules/calItipUtils.jsm</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -35,16 +35,17 @@</span>
<a href="#l4.4"></a><span id="l4.4">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l4.5"></a><span id="l4.5">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l4.6"></a><span id="l4.6">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l4.7"></a><span id="l4.7">  *</span>
<a href="#l4.8"></a><span id="l4.8">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l4.9"></a><span id="l4.9"> </span>
<a href="#l4.10"></a><span id="l4.10"> Components.utils.import(&quot;resource://gre/modules/debug.js&quot;);</span>
<a href="#l4.11"></a><span id="l4.11"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calIteratorUtils.jsm&quot;);</span>
<a href="#l4.13"></a><span id="l4.13"> </span>
<a href="#l4.14"></a><span id="l4.14"> /*</span>
<a href="#l4.15"></a><span id="l4.15">  * Scheduling and iTIP helper code;</span>
<a href="#l4.16"></a><span id="l4.16">  * don't use deliberately, because it'll be moved into interfaces/components.</span>
<a href="#l4.17"></a><span id="l4.17">  *</span>
<a href="#l4.18"></a><span id="l4.18">  * May replace the current calItipProcessor.js code soon.</span>
<a href="#l4.19"></a><span id="l4.19">  */</span>
<a href="#l4.20"></a><span id="l4.20"> </span>
<a href="#l4.21"></a><span id="l4.21" class="difflineat">@@ -328,51 +329,35 @@ cal.itip = {</span>
<a href="#l4.22"></a><span id="l4.22">             cal.ASSERT(oldItem, &quot;unexpected!&quot;);</span>
<a href="#l4.23"></a><span id="l4.23">             if (!oldItem) {</span>
<a href="#l4.24"></a><span id="l4.24">                 return newItem;</span>
<a href="#l4.25"></a><span id="l4.25">             }</span>
<a href="#l4.26"></a><span id="l4.26">         }</span>
<a href="#l4.27"></a><span id="l4.27"> </span>
<a href="#l4.28"></a><span id="l4.28">         function hashMajorProps(aItem) {</span>
<a href="#l4.29"></a><span id="l4.29">             let propStrings = [];</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineminus">-            function addProps(item) {</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">-                if (item) {</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineminus">-                    const majorProps = {</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineminus">-                        DTSTART: true,</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineminus">-                        DTEND: true,</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineminus">-                        DURATION: true,</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineminus">-                        DUE: true,</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineminus">-                        RDATE: true,</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineminus">-                        RRULE: true,</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineminus">-                        EXDATE: true,</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineminus">-                        STATUS: true,</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineminus">-                        LOCATION: true</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineminus">-                    };</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineminus">-                    cal.calIterateIcalComponent(</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineminus">-                        item.icalComponent,</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineminus">-                        function(subComp) {</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineminus">-                            for (let prop = subComp.getFirstProperty(&quot;ANY&quot;);</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineminus">-                                 prop;</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineminus">-                                 prop = subComp.getNextProperty(&quot;ANY&quot;)) {</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineminus">-                                if (majorProps[prop.propertyName]) {</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineminus">-                                    propStrings.push(item.recurrenceId + &quot;#&quot; + prop.icalString);</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineminus">-                                }</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineminus">-                            }</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineminus">-                        },</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineminus">-                        cal.isEvent(item) ? &quot;VEVENT&quot; : &quot;VTODO&quot;);</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineplus">+            const majorProps = {</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineplus">+                DTSTART: true,</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+                DTEND: true,</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineplus">+                DURATION: true,</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineplus">+                DUE: true,</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineplus">+                RDATE: true,</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineplus">+                RRULE: true,</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineplus">+                EXDATE: true,</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineplus">+                STATUS: true,</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineplus">+                LOCATION: true</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineplus">+            };</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineplus">+</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineplus">+            for (let item in cal.itemIterator(aItem)) {</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineplus">+                for (let prop in cal.ical.propertyIterator(item.icalComponent)) {</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineplus">+                    if (prop.propertyName in majorProps) {</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineplus">+                        propStrings.push(item.recurrenceId + &quot;#&quot; + prop.icalString);</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineplus">+                    }</span>
<a href="#l4.72"></a><span id="l4.72">                 }</span>
<a href="#l4.73"></a><span id="l4.73">             }</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineminus">-            addProps(aItem);</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineminus">-            let rec = (aItem &amp;&amp; aItem.recurrenceInfo);</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineminus">-            if (rec) {</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineminus">-                rec.getExceptionIds({}).forEach(</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineminus">-                    function(rid) {</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineminus">-                        addProps(rec.getExceptionFor(rid, false));</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineminus">-                    });</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineminus">-            }</span>
<a href="#l4.82"></a><span id="l4.82">             propStrings.sort();</span>
<a href="#l4.83"></a><span id="l4.83">             return propStrings.join(&quot;&quot;);</span>
<a href="#l4.84"></a><span id="l4.84">         }</span>
<a href="#l4.85"></a><span id="l4.85"> </span>
<a href="#l4.86"></a><span id="l4.86">         let h1 = hashMajorProps(newItem);</span>
<a href="#l4.87"></a><span id="l4.87">         let h2 = hashMajorProps(oldItem);</span>
<a href="#l4.88"></a><span id="l4.88">         if (h1 != h2) {</span>
<a href="#l4.89"></a><span id="l4.89">             newItem = newItem.clone();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/calendar/base/modules/calUtils.jsm</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/calendar/base/modules/calUtils.jsm</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -63,54 +63,33 @@ let cal = {</span>
<a href="#l5.4"></a><span id="l5.4">         if (!baseDir) {</span>
<a href="#l5.5"></a><span id="l5.5">             baseDir = __LOCATION__.parent.parent.clone();</span>
<a href="#l5.6"></a><span id="l5.6">             baseDir.append(&quot;calendar-js&quot;);</span>
<a href="#l5.7"></a><span id="l5.7">         }</span>
<a href="#l5.8"></a><span id="l5.8"> </span>
<a href="#l5.9"></a><span id="l5.9">         for each (let script in scriptNames) {</span>
<a href="#l5.10"></a><span id="l5.10">             let scriptFile = baseDir.clone();</span>
<a href="#l5.11"></a><span id="l5.11">             scriptFile.append(script);</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+            let scriptUrlSpec = ioService.newFileURI(scriptFile).spec;</span>
<a href="#l5.13"></a><span id="l5.13">             try {</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineminus">-                scriptLoader.loadSubScript(ioService.newFileURI(scriptFile).spec, scope);</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+                scriptLoader.loadSubScript(scriptUrlSpec, scope);</span>
<a href="#l5.16"></a><span id="l5.16">             } catch (exc) {</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineminus">-                Components.utils.reportError(exc);</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+                Components.utils.reportError(exc + &quot; (&quot; + scriptUrlSpec + &quot;)&quot;);</span>
<a href="#l5.19"></a><span id="l5.19">             }</span>
<a href="#l5.20"></a><span id="l5.20">         }</span>
<a href="#l5.21"></a><span id="l5.21">     },</span>
<a href="#l5.22"></a><span id="l5.22"> </span>
<a href="#l5.23"></a><span id="l5.23">     /**</span>
<a href="#l5.24"></a><span id="l5.24">      * Checks whether a timezone lacks a definition.</span>
<a href="#l5.25"></a><span id="l5.25">      */</span>
<a href="#l5.26"></a><span id="l5.26">     isPhantomTimezone: function cal_isPhantomTimezone(tz) {</span>
<a href="#l5.27"></a><span id="l5.27">         return (!tz.icalComponent &amp;&amp; !tz.isUTC &amp;&amp; !tz.isFloating);</span>
<a href="#l5.28"></a><span id="l5.28">     },</span>
<a href="#l5.29"></a><span id="l5.29"> </span>
<a href="#l5.30"></a><span id="l5.30">     /**</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineminus">-     * Iterates an array of items, i.e. the passed item including all</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineminus">-     * overridden instances of a recurring series.</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineminus">-     *</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineminus">-     * @param items array of items</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineminus">-     */</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineminus">-    itemIterator: function cal_itemIterator(items) {</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineminus">-        return {</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineminus">-            __iterator__: function itemIterator_() {</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineminus">-                for each (let item in items) {</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineminus">-                    yield item;</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineminus">-                    let rec = item.recurrenceInfo;</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineminus">-                    if (rec) {</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineminus">-                        for each (let exid in rec.getExceptionIds({})) {</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineminus">-                            yield rec.getExceptionFor(exid, false);</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineminus">-                        }</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineminus">-                    }</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineminus">-                }</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineminus">-            }</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineminus">-        };</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineminus">-    },</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineminus">-</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineminus">-    /**</span>
<a href="#l5.53"></a><span id="l5.53">      * Shortcut function to serialize an item (including all overridden items).</span>
<a href="#l5.54"></a><span id="l5.54">      */</span>
<a href="#l5.55"></a><span id="l5.55">     getSerializedItem: function cal_getSerializedItem(aItem) {</span>
<a href="#l5.56"></a><span id="l5.56">         let serializer = Components.classes[&quot;@mozilla.org/calendar/ics-serializer;1&quot;]</span>
<a href="#l5.57"></a><span id="l5.57">                                    .createInstance(Components.interfaces.calIIcsSerializer);</span>
<a href="#l5.58"></a><span id="l5.58">         serializer.addItems([aItem], 1);</span>
<a href="#l5.59"></a><span id="l5.59">         return serializer.serializeToString();</span>
<a href="#l5.60"></a><span id="l5.60">     },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/calendar/base/src/calAttachment.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/calendar/base/src/calAttachment.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -1,9 +1,8 @@</span>
<a href="#l6.4"></a><span id="l6.4" class="difflineminus">-/* -*- Mode: javascript; tab-width: 20; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l6.5"></a><span id="l6.5"> /* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l6.6"></a><span id="l6.6">  * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l6.7"></a><span id="l6.7">  *</span>
<a href="#l6.8"></a><span id="l6.8">  * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l6.9"></a><span id="l6.9">  * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l6.10"></a><span id="l6.10">  * the License. You may obtain a copy of the License at</span>
<a href="#l6.11"></a><span id="l6.11">  * http://www.mozilla.org/MPL/</span>
<a href="#l6.12"></a><span id="l6.12">  *</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineat">@@ -32,16 +31,18 @@</span>
<a href="#l6.14"></a><span id="l6.14">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l6.15"></a><span id="l6.15">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l6.16"></a><span id="l6.16">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l6.17"></a><span id="l6.17">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l6.18"></a><span id="l6.18">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l6.19"></a><span id="l6.19">  *</span>
<a href="#l6.20"></a><span id="l6.20">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l6.21"></a><span id="l6.21"> </span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calIteratorUtils.jsm&quot;);</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineplus">+</span>
<a href="#l6.24"></a><span id="l6.24"> //</span>
<a href="#l6.25"></a><span id="l6.25"> // calAttachment.js</span>
<a href="#l6.26"></a><span id="l6.26"> //</span>
<a href="#l6.27"></a><span id="l6.27"> function calAttachment() {</span>
<a href="#l6.28"></a><span id="l6.28">     this.wrappedJSObject = this;</span>
<a href="#l6.29"></a><span id="l6.29">     this.mProperties = new calPropertyBag();</span>
<a href="#l6.30"></a><span id="l6.30"> }</span>
<a href="#l6.31"></a><span id="l6.31"> </span>
<a href="#l6.32"></a><span id="l6.32" class="difflineat">@@ -125,46 +126,41 @@ calAttachment.prototype = {</span>
<a href="#l6.33"></a><span id="l6.33">         if (this.mType) {</span>
<a href="#l6.34"></a><span id="l6.34">             icalatt.setParameter(&quot;FMTTYPE&quot;, this.mType);</span>
<a href="#l6.35"></a><span id="l6.35">         }</span>
<a href="#l6.36"></a><span id="l6.36">         </span>
<a href="#l6.37"></a><span id="l6.37">         if (this.mEncoding) {</span>
<a href="#l6.38"></a><span id="l6.38">             icalatt.setParameter(&quot;ENCODING&quot;, this.mEncoding);</span>
<a href="#l6.39"></a><span id="l6.39">         }</span>
<a href="#l6.40"></a><span id="l6.40"> </span>
<a href="#l6.41"></a><span id="l6.41" class="difflineminus">-        var outKeys = {};</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineminus">-        var outValues = {};</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineminus">-        this.mProperties.getAllProperties(outKeys, outValues);</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineminus">-        for (var i = 0; i &lt; outKeys.value.length; i++) {</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineminus">-            icalatt.setParameter(outKeys.value[i], outValues.value[i]);</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineplus">+        for each (let [key, value] in this.mProperties) {</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineplus">+            icalatt.setParameter(key, value);</span>
<a href="#l6.48"></a><span id="l6.48">         }</span>
<a href="#l6.49"></a><span id="l6.49">         return icalatt;</span>
<a href="#l6.50"></a><span id="l6.50">     },</span>
<a href="#l6.51"></a><span id="l6.51"> </span>
<a href="#l6.52"></a><span id="l6.52">     set icalProperty cA_set_icalProperty(attProp) {</span>
<a href="#l6.53"></a><span id="l6.53">         //TODO: handle local uris in a sensible way</span>
<a href="#l6.54"></a><span id="l6.54">         // handle the VALUE = BINARY parameter</span>
<a href="#l6.55"></a><span id="l6.55">         if (attProp.value) {</span>
<a href="#l6.56"></a><span id="l6.56">             this.mUri = makeURL(attProp.value);</span>
<a href="#l6.57"></a><span id="l6.57">         }</span>
<a href="#l6.58"></a><span id="l6.58"> </span>
<a href="#l6.59"></a><span id="l6.59" class="difflineminus">-        for (var paramname = attProp.getFirstParameterName();</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineminus">-             paramname;</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineminus">-             paramname = attProp.getNextParameterName()) {</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineminus">-            if (paramname == &quot;FMTTYPE&quot;) {</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineminus">-                this.mType = attProp.getParameter(&quot;FMTTYPE&quot;);</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineminus">-                continue;</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineplus">+        for each (let [name, value] in cal.ical.paramIterator(attProp)) {</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineplus">+            switch (name) {</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineplus">+                case &quot;FMTTYPE&quot;:</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineplus">+                    this.mType = value;</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineplus">+                    break;</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineplus">+                case &quot;ENCODING&quot;:</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineplus">+                    this.mEncoding = value;</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineplus">+                    break;</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineplus">+                default:</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineplus">+                    this.setProperty(name, value);</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineplus">+                    break;</span>
<a href="#l6.76"></a><span id="l6.76">             }</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineminus">-</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineminus">-            if (paramname == &quot;ENCODING&quot;) {</span>
<a href="#l6.79"></a><span id="l6.79" class="difflineminus">-                this.mEncoding = attProp.getParameter(&quot;ENCODING&quot;);</span>
<a href="#l6.80"></a><span id="l6.80" class="difflineminus">-                continue;</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineminus">-            }</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineminus">-</span>
<a href="#l6.83"></a><span id="l6.83" class="difflineminus">-            this.setProperty(paramname, attProp.getParameter(paramname));</span>
<a href="#l6.84"></a><span id="l6.84">         }</span>
<a href="#l6.85"></a><span id="l6.85">     },</span>
<a href="#l6.86"></a><span id="l6.86"> </span>
<a href="#l6.87"></a><span id="l6.87">     getParameter: function (aName) {</span>
<a href="#l6.88"></a><span id="l6.88">         return this.mProperties.getProperty(aName);</span>
<a href="#l6.89"></a><span id="l6.89">     },</span>
<a href="#l6.90"></a><span id="l6.90"> </span>
<a href="#l6.91"></a><span id="l6.91">     setParameter: function (aName, aValue) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/calendar/base/src/calAttendee.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/calendar/base/src/calAttendee.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -31,16 +31,18 @@</span>
<a href="#l7.4"></a><span id="l7.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l7.5"></a><span id="l7.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l7.6"></a><span id="l7.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l7.7"></a><span id="l7.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l7.8"></a><span id="l7.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l7.9"></a><span id="l7.9">  *</span>
<a href="#l7.10"></a><span id="l7.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calIteratorUtils.jsm&quot;);</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+</span>
<a href="#l7.14"></a><span id="l7.14"> function calAttendee() {</span>
<a href="#l7.15"></a><span id="l7.15">     this.wrappedJSObject = this;</span>
<a href="#l7.16"></a><span id="l7.16">     this.mProperties = new calPropertyBag();</span>
<a href="#l7.17"></a><span id="l7.17"> }</span>
<a href="#l7.18"></a><span id="l7.18"> </span>
<a href="#l7.19"></a><span id="l7.19"> var calAttendeeClassInfo = {</span>
<a href="#l7.20"></a><span id="l7.20">     getInterfaces: function (count) {</span>
<a href="#l7.21"></a><span id="l7.21">         var ifaces = [</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineat">@@ -93,25 +95,24 @@ calAttendee.prototype = {</span>
<a href="#l7.23"></a><span id="l7.23"> </span>
<a href="#l7.24"></a><span id="l7.24">     clone: function() {</span>
<a href="#l7.25"></a><span id="l7.25">         var a = new calAttendee();</span>
<a href="#l7.26"></a><span id="l7.26"> </span>
<a href="#l7.27"></a><span id="l7.27">         if (this.mIsOrganizer) {</span>
<a href="#l7.28"></a><span id="l7.28">             a.isOrganizer = true;</span>
<a href="#l7.29"></a><span id="l7.29">         }</span>
<a href="#l7.30"></a><span id="l7.30"> </span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-        var allProps = [&quot;id&quot;, &quot;commonName&quot;, &quot;rsvp&quot;, &quot;role&quot;, &quot;participationStatus&quot;,</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineminus">-                        &quot;userType&quot;];</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineminus">-        for (var i in allProps)</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineminus">-            a[allProps[i]] = this[allProps[i]];</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+        const allProps = [&quot;id&quot;, &quot;commonName&quot;, &quot;rsvp&quot;, &quot;role&quot;,</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+                          &quot;participationStatus&quot;, &quot;userType&quot;];</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+        for each (let prop in allProps) {</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineplus">+            a[prop] = this[prop];</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineplus">+        }</span>
<a href="#l7.40"></a><span id="l7.40"> </span>
<a href="#l7.41"></a><span id="l7.41" class="difflineminus">-        var bagenum = this.propertyEnumerator;</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineminus">-        while (bagenum.hasMoreElements()) {</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineminus">-            var iprop = bagenum.getNext().QueryInterface(Components.interfaces.nsIProperty);</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineminus">-            a.setProperty(iprop.name, iprop.value);</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineplus">+        for each (let [key, value] in this.mProperties) {</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineplus">+            a.setProperty(key, value);</span>
<a href="#l7.47"></a><span id="l7.47">         }</span>
<a href="#l7.48"></a><span id="l7.48"> </span>
<a href="#l7.49"></a><span id="l7.49">         return a;</span>
<a href="#l7.50"></a><span id="l7.50">     },</span>
<a href="#l7.51"></a><span id="l7.51">     // XXX enforce legal values for our properties;</span>
<a href="#l7.52"></a><span id="l7.52"> </span>
<a href="#l7.53"></a><span id="l7.53">     icalAttendeePropMap: [</span>
<a href="#l7.54"></a><span id="l7.54">     { cal: &quot;rsvp&quot;,                ics: &quot;RSVP&quot; },</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineat">@@ -131,22 +132,20 @@ calAttendee.prototype = {</span>
<a href="#l7.56"></a><span id="l7.56">         var promotedProps = { };</span>
<a href="#l7.57"></a><span id="l7.57">         for (var i = 0; i &lt; this.icalAttendeePropMap.length; i++) {</span>
<a href="#l7.58"></a><span id="l7.58">             var prop = this.icalAttendeePropMap[i];</span>
<a href="#l7.59"></a><span id="l7.59">             this[prop.cal] = icalatt.getParameter(prop.ics);</span>
<a href="#l7.60"></a><span id="l7.60">             // Don't copy these to the property bag.</span>
<a href="#l7.61"></a><span id="l7.61">             promotedProps[prop.ics] = true;</span>
<a href="#l7.62"></a><span id="l7.62">         }</span>
<a href="#l7.63"></a><span id="l7.63"> </span>
<a href="#l7.64"></a><span id="l7.64" class="difflineminus">-        for (var paramname = icalatt.getFirstParameterName();</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineminus">-             paramname;</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineminus">-             paramname = icalatt.getNextParameterName()) {</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineminus">-            if (promotedProps[paramname])</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineminus">-                continue;</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineminus">-            this.setProperty(paramname, icalatt.getParameter(paramname));</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineplus">+        for each (let [name, value] in cal.ical.paramIterator(icalatt)) {</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineplus">+            if (!promotedProps[name]) {</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineplus">+                this.setProperty(name, value);</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineplus">+            }</span>
<a href="#l7.74"></a><span id="l7.74">         }</span>
<a href="#l7.75"></a><span id="l7.75">     },</span>
<a href="#l7.76"></a><span id="l7.76"> </span>
<a href="#l7.77"></a><span id="l7.77">     get icalProperty() {</span>
<a href="#l7.78"></a><span id="l7.78">         var icssvc = getIcsService();</span>
<a href="#l7.79"></a><span id="l7.79">         var icalatt;</span>
<a href="#l7.80"></a><span id="l7.80">         if (!this.mIsOrganizer) {</span>
<a href="#l7.81"></a><span id="l7.81">             icalatt = icssvc.createIcalProperty(&quot;ATTENDEE&quot;);</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineat">@@ -157,20 +156,18 @@ calAttendee.prototype = {</span>
<a href="#l7.83"></a><span id="l7.83">         if (!this.id)</span>
<a href="#l7.84"></a><span id="l7.84">             throw Components.results.NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l7.85"></a><span id="l7.85">         icalatt.valueAsIcalString = this.id;</span>
<a href="#l7.86"></a><span id="l7.86">         for (var i = 0; i &lt; this.icalAttendeePropMap.length; i++) {</span>
<a href="#l7.87"></a><span id="l7.87">             var prop = this.icalAttendeePropMap[i];</span>
<a href="#l7.88"></a><span id="l7.88">             if (this[prop.cal])</span>
<a href="#l7.89"></a><span id="l7.89">                 icalatt.setParameter(prop.ics, this[prop.cal]);</span>
<a href="#l7.90"></a><span id="l7.90">         }</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineminus">-        var bagenum = this.mProperties.enumerator;</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineminus">-        while (bagenum.hasMoreElements()) {</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineminus">-            var iprop = bagenum.getNext();</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineminus">-            icalatt.setParameter(iprop.name, iprop.value);</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineplus">+        for each (let [key, value] in this.mProperties) {</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineplus">+            icalatt.setParameter(key, value);</span>
<a href="#l7.97"></a><span id="l7.97">         }</span>
<a href="#l7.98"></a><span id="l7.98">         return icalatt;</span>
<a href="#l7.99"></a><span id="l7.99">     },</span>
<a href="#l7.100"></a><span id="l7.100"> </span>
<a href="#l7.101"></a><span id="l7.101">     get propertyEnumerator() { return this.mProperties.enumerator; },</span>
<a href="#l7.102"></a><span id="l7.102"> </span>
<a href="#l7.103"></a><span id="l7.103">     // The has/get/set/deleteProperty methods are case-insensitive.</span>
<a href="#l7.104"></a><span id="l7.104">     getProperty: function (aName) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/calendar/base/src/calIcsParser.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/calendar/base/src/calIcsParser.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -30,16 +30,17 @@</span>
<a href="#l8.4"></a><span id="l8.4">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l8.5"></a><span id="l8.5">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l8.6"></a><span id="l8.6">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l8.7"></a><span id="l8.7">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l8.8"></a><span id="l8.8">  *</span>
<a href="#l8.9"></a><span id="l8.9">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l8.10"></a><span id="l8.10"> </span>
<a href="#l8.11"></a><span id="l8.11"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calIteratorUtils.jsm&quot;);</span>
<a href="#l8.13"></a><span id="l8.13"> </span>
<a href="#l8.14"></a><span id="l8.14"> function calIcsParser() {</span>
<a href="#l8.15"></a><span id="l8.15">     this.wrappedJSObject = this;</span>
<a href="#l8.16"></a><span id="l8.16">     this.mItems = new Array();</span>
<a href="#l8.17"></a><span id="l8.17">     this.mParentlessItems = new Array();</span>
<a href="#l8.18"></a><span id="l8.18">     this.mComponents = new Array();</span>
<a href="#l8.19"></a><span id="l8.19">     this.mProperties = new Array();</span>
<a href="#l8.20"></a><span id="l8.20"> }</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineat">@@ -89,55 +90,46 @@ function ip_parseString(aICSString, aTzP</span>
<a href="#l8.22"></a><span id="l8.22">                 tzErrors[hid] = true;</span>
<a href="#l8.23"></a><span id="l8.23">             }</span>
<a href="#l8.24"></a><span id="l8.24">         }</span>
<a href="#l8.25"></a><span id="l8.25">     }</span>
<a href="#l8.26"></a><span id="l8.26"> </span>
<a href="#l8.27"></a><span id="l8.27">     while (calComp) {</span>
<a href="#l8.28"></a><span id="l8.28"> </span>
<a href="#l8.29"></a><span id="l8.29">         // Get unknown properties</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineminus">-        let prop = calComp.getFirstProperty(&quot;ANY&quot;);</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-        while (prop) {</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineminus">-            if (prop.propertyName != &quot;VERSION&quot; &amp;&amp;</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineminus">-                prop.propertyName != &quot;PRODID&quot;) {</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineminus">-                this.mProperties.push(prop);</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineminus">-            }</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineminus">-            prop = calComp.getNextProperty(&quot;ANY&quot;);</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineminus">-        }</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineplus">+        this.mProperties = [ prop for (prop in cal.ical.propertyIterator(calComp))</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineplus">+                                  if (prop.propertyName != &quot;VERSION&quot; &amp;&amp;</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineplus">+                                      prop.propertyName != &quot;PRODID&quot;) ];</span>
<a href="#l8.41"></a><span id="l8.41"> </span>
<a href="#l8.42"></a><span id="l8.42">         let prodId = calComp.getFirstProperty(&quot;PRODID&quot;);</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineminus">-        let isFromOldSunbird;</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineminus">-        if (prodId) {</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineminus">-            isFromOldSunbird = prodId.value == &quot;-//Mozilla.org/NONSGML Mozilla Calendar V1.0//EN&quot;;</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineminus">-        }</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineplus">+        let isFromOldSunbird = (prodId &amp;&amp; prodId.value == &quot;-//Mozilla.org/NONSGML Mozilla Calendar V1.0//EN&quot;);</span>
<a href="#l8.48"></a><span id="l8.48"> </span>
<a href="#l8.49"></a><span id="l8.49" class="difflineminus">-        let subComp = calComp.getFirstSubcomponent(&quot;ANY&quot;);</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineminus">-        while (subComp) {</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+        for (let subComp in cal.ical.subcomponentIterator(calComp)) {</span>
<a href="#l8.52"></a><span id="l8.52">             let item = null;</span>
<a href="#l8.53"></a><span id="l8.53">             switch (subComp.componentType) {</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineminus">-            case &quot;VEVENT&quot;:</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineminus">-                item = cal.createEvent();</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineminus">-                item.icalComponent = subComp;</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineminus">-                checkTimezone(item, item.startDate);</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineminus">-                checkTimezone(item, item.endDate);</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineminus">-                break;</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineminus">-            case &quot;VTODO&quot;:</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineminus">-                item = cal.createTodo();</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineminus">-                item.icalComponent = subComp;</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineminus">-                checkTimezone(item, item.entryDate);</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineminus">-                checkTimezone(item, item.dueDate);</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineminus">-                // completed is defined to be in UTC</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineminus">-                break;</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineminus">-            case &quot;VTIMEZONE&quot;:</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineminus">-                // this should already be attached to the relevant</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineminus">-                // events in the calendar, so there's no need to</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineminus">-                // do anything with it here.</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineminus">-                break;</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineminus">-            default:</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineminus">-                this.mComponents.push(subComp);</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineplus">+                case &quot;VEVENT&quot;:</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineplus">+                    item = cal.createEvent();</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineplus">+                    item.icalComponent = subComp;</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineplus">+                    checkTimezone(item, item.startDate);</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineplus">+                    checkTimezone(item, item.endDate);</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineplus">+                    break;</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineplus">+                case &quot;VTODO&quot;:</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineplus">+                    item = cal.createTodo();</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineplus">+                    item.icalComponent = subComp;</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineplus">+                    checkTimezone(item, item.entryDate);</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineplus">+                    checkTimezone(item, item.dueDate);</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineplus">+                    // completed is defined to be in UTC</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineplus">+                    break;</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineplus">+                case &quot;VTIMEZONE&quot;:</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineplus">+                    // this should already be attached to the relevant</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineplus">+                    // events in the calendar, so there's no need to</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineplus">+                    // do anything with it here.</span>
<a href="#l8.91"></a><span id="l8.91" class="difflineplus">+                    break;</span>
<a href="#l8.92"></a><span id="l8.92" class="difflineplus">+                default:</span>
<a href="#l8.93"></a><span id="l8.93" class="difflineplus">+                    this.mComponents.push(subComp);</span>
<a href="#l8.94"></a><span id="l8.94">             }</span>
<a href="#l8.95"></a><span id="l8.95"> </span>
<a href="#l8.96"></a><span id="l8.96">             if (item) {</span>
<a href="#l8.97"></a><span id="l8.97">                 // Only try to fix ICS from Sunbird 0.2 (and earlier) if it</span>
<a href="#l8.98"></a><span id="l8.98">                 // has an EXDATE.</span>
<a href="#l8.99"></a><span id="l8.99">                 hasExdate = subComp.getFirstProperty(&quot;EXDATE&quot;);</span>
<a href="#l8.100"></a><span id="l8.100">                 if (isFromOldSunbird &amp;&amp; hasExdate) {</span>
<a href="#l8.101"></a><span id="l8.101">                     item = fixOldSunbirdExceptions(item);</span>
<a href="#l8.102"></a><span id="l8.102" class="difflineat">@@ -150,17 +142,16 @@ function ip_parseString(aICSString, aTzP</span>
<a href="#l8.103"></a><span id="l8.103">                         uid2parent[item.id] = item;</span>
<a href="#l8.104"></a><span id="l8.104">                     }</span>
<a href="#l8.105"></a><span id="l8.105">                 } else {</span>
<a href="#l8.106"></a><span id="l8.106">                     // force no recurrence info:</span>
<a href="#l8.107"></a><span id="l8.107">                     item.recurrenceInfo = null;</span>
<a href="#l8.108"></a><span id="l8.108">                     excItems.push(item);</span>
<a href="#l8.109"></a><span id="l8.109">                 }</span>
<a href="#l8.110"></a><span id="l8.110">             }</span>
<a href="#l8.111"></a><span id="l8.111" class="difflineminus">-            subComp = calComp.getNextSubcomponent(&quot;ANY&quot;);</span>
<a href="#l8.112"></a><span id="l8.112">         }</span>
<a href="#l8.113"></a><span id="l8.113">         calComp = rootComp.getNextSubcomponent(&quot;VCALENDAR&quot;);</span>
<a href="#l8.114"></a><span id="l8.114">     }</span>
<a href="#l8.115"></a><span id="l8.115"> </span>
<a href="#l8.116"></a><span id="l8.116">     // tag &quot;exceptions&quot;, i.e. items with rid:</span>
<a href="#l8.117"></a><span id="l8.117">     for each (let item in excItems) {</span>
<a href="#l8.118"></a><span id="l8.118">         let parent = uid2parent[item.id];</span>
<a href="#l8.119"></a><span id="l8.119"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/calendar/base/src/calIcsSerializer.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/calendar/base/src/calIcsSerializer.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -31,16 +31,17 @@</span>
<a href="#l9.4"></a><span id="l9.4">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l9.5"></a><span id="l9.5">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l9.6"></a><span id="l9.6">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l9.7"></a><span id="l9.7">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l9.8"></a><span id="l9.8">  *</span>
<a href="#l9.9"></a><span id="l9.9">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l9.10"></a><span id="l9.10"> </span>
<a href="#l9.11"></a><span id="l9.11"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calIteratorUtils.jsm&quot;);</span>
<a href="#l9.13"></a><span id="l9.13"> </span>
<a href="#l9.14"></a><span id="l9.14"> function calIcsSerializer() {</span>
<a href="#l9.15"></a><span id="l9.15">     this.wrappedJSObject = this;</span>
<a href="#l9.16"></a><span id="l9.16">     this.mItems = [];</span>
<a href="#l9.17"></a><span id="l9.17">     this.mProperties = [];</span>
<a href="#l9.18"></a><span id="l9.18">     this.mComponents = [];</span>
<a href="#l9.19"></a><span id="l9.19"> }</span>
<a href="#l9.20"></a><span id="l9.20"> </span>
<a href="#l9.21"></a><span id="l9.21" class="difflineat">@@ -107,14 +108,14 @@ function is_getIcalComponent() {</span>
<a href="#l9.22"></a><span id="l9.22"> </span>
<a href="#l9.23"></a><span id="l9.23">     for each (var prop in this.mProperties) {</span>
<a href="#l9.24"></a><span id="l9.24">         calComp.addProperty(prop);</span>
<a href="#l9.25"></a><span id="l9.25">     }</span>
<a href="#l9.26"></a><span id="l9.26">     for each (var comp in this.mComponents) {</span>
<a href="#l9.27"></a><span id="l9.27">         calComp.addSubcomponent(comp);</span>
<a href="#l9.28"></a><span id="l9.28">     }</span>
<a href="#l9.29"></a><span id="l9.29"> </span>
<a href="#l9.30"></a><span id="l9.30" class="difflineminus">-    for each (let item in cal.itemIterator(this.mItems)) {</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineplus">+    for (let item in cal.itemIterator(this.mItems)) {</span>
<a href="#l9.32"></a><span id="l9.32">         calComp.addSubcomponent(item.icalComponent);</span>
<a href="#l9.33"></a><span id="l9.33">     }</span>
<a href="#l9.34"></a><span id="l9.34"> </span>
<a href="#l9.35"></a><span id="l9.35">     return calComp;</span>
<a href="#l9.36"></a><span id="l9.36"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/calendar/base/src/calItemBase.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/calendar/base/src/calItemBase.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -35,16 +35,19 @@</span>
<a href="#l10.4"></a><span id="l10.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l10.5"></a><span id="l10.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l10.6"></a><span id="l10.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l10.7"></a><span id="l10.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l10.8"></a><span id="l10.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l10.9"></a><span id="l10.9">  *</span>
<a href="#l10.10"></a><span id="l10.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l10.11"></a><span id="l10.11"> </span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calIteratorUtils.jsm&quot;);</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+</span>
<a href="#l10.15"></a><span id="l10.15"> //</span>
<a href="#l10.16"></a><span id="l10.16"> // calItemBase.js</span>
<a href="#l10.17"></a><span id="l10.17"> //</span>
<a href="#l10.18"></a><span id="l10.18"> </span>
<a href="#l10.19"></a><span id="l10.19"> function calItemBase() {</span>
<a href="#l10.20"></a><span id="l10.20">     ASSERT(false, &quot;Inheriting objects call initItemBase!&quot;);</span>
<a href="#l10.21"></a><span id="l10.21"> }</span>
<a href="#l10.22"></a><span id="l10.22"> </span>
<a href="#l10.23"></a><span id="l10.23" class="difflineat">@@ -161,24 +164,20 @@ calItemBase.prototype = {</span>
<a href="#l10.24"></a><span id="l10.24"> </span>
<a href="#l10.25"></a><span id="l10.25">         if (this.mOrganizer)</span>
<a href="#l10.26"></a><span id="l10.26">             this.mOrganizer.makeImmutable();</span>
<a href="#l10.27"></a><span id="l10.27">         if (this.mAttendees) {</span>
<a href="#l10.28"></a><span id="l10.28">             for (var i = 0; i &lt; this.mAttendees.length; i++)</span>
<a href="#l10.29"></a><span id="l10.29">                 this.mAttendees[i].makeImmutable();</span>
<a href="#l10.30"></a><span id="l10.30">         }</span>
<a href="#l10.31"></a><span id="l10.31"> </span>
<a href="#l10.32"></a><span id="l10.32" class="difflineminus">-        var e = this.mProperties.enumerator;</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineminus">-        while (e.hasMoreElements()) {</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineminus">-            var prop = e.getNext();</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineminus">-            var val = prop.value;</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineminus">-</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineminus">-            if (prop.value instanceof Components.interfaces.calIDateTime) {</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineminus">-                if (prop.value.isMutable)</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineminus">-                    prop.value.makeImmutable();</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineplus">+        for each (let [propKey, propValue] in this.mProperties) {</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineplus">+            if (propValue instanceof Components.interfaces.calIDateTime &amp;&amp;</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineplus">+                propValue.isMutable) {</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineplus">+                propValue.makeImmutable();</span>
<a href="#l10.44"></a><span id="l10.44">             }</span>
<a href="#l10.45"></a><span id="l10.45">         }</span>
<a href="#l10.46"></a><span id="l10.46"> </span>
<a href="#l10.47"></a><span id="l10.47">         if (this.alarmOffset) {</span>
<a href="#l10.48"></a><span id="l10.48">             this.alarmOffset.makeImmutable();</span>
<a href="#l10.49"></a><span id="l10.49">         }</span>
<a href="#l10.50"></a><span id="l10.50">         if (this.alarmLastAck) {</span>
<a href="#l10.51"></a><span id="l10.51">             this.alarmLastAck.makeImmutable();</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineat">@@ -239,32 +238,27 @@ calItemBase.prototype = {</span>
<a href="#l10.53"></a><span id="l10.53">             m.mAttendees = new Array(this.mAttendees.length);</span>
<a href="#l10.54"></a><span id="l10.54">             for (var i = 0; i &lt; this.mAttendees.length; i++)</span>
<a href="#l10.55"></a><span id="l10.55">                 m.mAttendees[i] = this.mAttendees[i].clone();</span>
<a href="#l10.56"></a><span id="l10.56">         }</span>
<a href="#l10.57"></a><span id="l10.57">         else</span>
<a href="#l10.58"></a><span id="l10.58">             m.mAttendees = null;</span>
<a href="#l10.59"></a><span id="l10.59"> </span>
<a href="#l10.60"></a><span id="l10.60">         m.mProperties = new calPropertyBag();</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineminus">-        var e = this.mProperties.enumerator;</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineminus">-        while (e.hasMoreElements()) {</span>
<a href="#l10.63"></a><span id="l10.63" class="difflineminus">-            var prop = e.getNext();</span>
<a href="#l10.64"></a><span id="l10.64" class="difflineminus">-            var name = prop.name;</span>
<a href="#l10.65"></a><span id="l10.65" class="difflineminus">-            var val = prop.value;</span>
<a href="#l10.66"></a><span id="l10.66" class="difflineminus">-</span>
<a href="#l10.67"></a><span id="l10.67" class="difflineminus">-            if (val instanceof Components.interfaces.calIDateTime) {</span>
<a href="#l10.68"></a><span id="l10.68" class="difflineminus">-                val = val.clone();</span>
<a href="#l10.69"></a><span id="l10.69" class="difflineplus">+        for each (let [name, value] in this.mProperties) {</span>
<a href="#l10.70"></a><span id="l10.70" class="difflineplus">+            if (value instanceof Components.interfaces.calIDateTime) {</span>
<a href="#l10.71"></a><span id="l10.71" class="difflineplus">+                value = value.clone();</span>
<a href="#l10.72"></a><span id="l10.72">             }</span>
<a href="#l10.73"></a><span id="l10.73"> </span>
<a href="#l10.74"></a><span id="l10.74" class="difflineminus">-            m.mProperties.setProperty(name, val);</span>
<a href="#l10.75"></a><span id="l10.75" class="difflineplus">+            m.mProperties.setProperty(name, value);</span>
<a href="#l10.76"></a><span id="l10.76"> </span>
<a href="#l10.77"></a><span id="l10.77" class="difflineminus">-            var propBucket = this.mPropertyParams[name];</span>
<a href="#l10.78"></a><span id="l10.78" class="difflineplus">+            let propBucket = this.mPropertyParams[name];</span>
<a href="#l10.79"></a><span id="l10.79">             if (propBucket) {</span>
<a href="#l10.80"></a><span id="l10.80" class="difflineminus">-                var newBucket = {};</span>
<a href="#l10.81"></a><span id="l10.81" class="difflineminus">-                for (var param in propBucket) {</span>
<a href="#l10.82"></a><span id="l10.82" class="difflineplus">+                let newBucket = {};</span>
<a href="#l10.83"></a><span id="l10.83" class="difflineplus">+                for (let param in propBucket) {</span>
<a href="#l10.84"></a><span id="l10.84">                     newBucket[param] = propBucket[param];</span>
<a href="#l10.85"></a><span id="l10.85">                 }</span>
<a href="#l10.86"></a><span id="l10.86">                 m.mPropertyParams[name] = newBucket;</span>
<a href="#l10.87"></a><span id="l10.87">             }</span>
<a href="#l10.88"></a><span id="l10.88">         }</span>
<a href="#l10.89"></a><span id="l10.89"> </span>
<a href="#l10.90"></a><span id="l10.90">         if (this.mAttachments) {</span>
<a href="#l10.91"></a><span id="l10.91">             m.mAttachments = this.mAttachments.concat([]);</span>
<a href="#l10.92"></a><span id="l10.92" class="difflineat">@@ -659,135 +653,113 @@ calItemBase.prototype = {</span>
<a href="#l10.93"></a><span id="l10.93">         }</span>
<a href="#l10.94"></a><span id="l10.94">     },</span>
<a href="#l10.95"></a><span id="l10.95"> </span>
<a href="#l10.96"></a><span id="l10.96">     setItemBaseFromICS: function (icalcomp) {</span>
<a href="#l10.97"></a><span id="l10.97">         this.modify();</span>
<a href="#l10.98"></a><span id="l10.98"> </span>
<a href="#l10.99"></a><span id="l10.99">         this.mapPropsFromICS(icalcomp, this.icsBasePropMap);</span>
<a href="#l10.100"></a><span id="l10.100"> </span>
<a href="#l10.101"></a><span id="l10.101" class="difflineminus">-        for (var attprop = icalcomp.getFirstProperty(&quot;ATTENDEE&quot;);</span>
<a href="#l10.102"></a><span id="l10.102" class="difflineminus">-             attprop;</span>
<a href="#l10.103"></a><span id="l10.103" class="difflineminus">-             attprop = icalcomp.getNextProperty(&quot;ATTENDEE&quot;)) {</span>
<a href="#l10.104"></a><span id="l10.104" class="difflineminus">-</span>
<a href="#l10.105"></a><span id="l10.105" class="difflineminus">-            var att = new CalAttendee();</span>
<a href="#l10.106"></a><span id="l10.106" class="difflineplus">+        for (let attprop in cal.ical.propertyIterator(icalcomp, &quot;ATTENDEE&quot;)) {</span>
<a href="#l10.107"></a><span id="l10.107" class="difflineplus">+            let att = new calAttendee();</span>
<a href="#l10.108"></a><span id="l10.108">             att.icalProperty = attprop;</span>
<a href="#l10.109"></a><span id="l10.109">             this.addAttendee(att);</span>
<a href="#l10.110"></a><span id="l10.110">         }</span>
<a href="#l10.111"></a><span id="l10.111"> </span>
<a href="#l10.112"></a><span id="l10.112" class="difflineminus">-        for (var attprop = icalcomp.getFirstProperty(&quot;ATTACH&quot;);</span>
<a href="#l10.113"></a><span id="l10.113" class="difflineminus">-             attprop;</span>
<a href="#l10.114"></a><span id="l10.114" class="difflineminus">-             attprop = icalcomp.getNextProperty(&quot;ATTACH&quot;)) {</span>
<a href="#l10.115"></a><span id="l10.115" class="difflineminus">-</span>
<a href="#l10.116"></a><span id="l10.116" class="difflineminus">-            var att = createAttachment();</span>
<a href="#l10.117"></a><span id="l10.117" class="difflineplus">+        for (let attprop in cal.ical.propertyIterator(icalcomp, &quot;ATTACH&quot;)) {</span>
<a href="#l10.118"></a><span id="l10.118" class="difflineplus">+            let att = new calAttachment();</span>
<a href="#l10.119"></a><span id="l10.119">             att.icalProperty = attprop;</span>
<a href="#l10.120"></a><span id="l10.120">             this.addAttachment(att);</span>
<a href="#l10.121"></a><span id="l10.121">         }</span>
<a href="#l10.122"></a><span id="l10.122"> </span>
<a href="#l10.123"></a><span id="l10.123" class="difflineminus">-        for (var relprop = icalcomp.getFirstProperty(&quot;RELATED-TO&quot;);</span>
<a href="#l10.124"></a><span id="l10.124" class="difflineminus">-             relprop;</span>
<a href="#l10.125"></a><span id="l10.125" class="difflineminus">-             relprop = icalcomp.getNextProperty(&quot;RELATED-TO&quot;)) {</span>
<a href="#l10.126"></a><span id="l10.126"> </span>
<a href="#l10.127"></a><span id="l10.127" class="difflineminus">-            var rel = createRelation();</span>
<a href="#l10.128"></a><span id="l10.128" class="difflineplus">+        for (let relprop in cal.ical.propertyIterator(icalcomp, &quot;RELATED-TO&quot;)) {</span>
<a href="#l10.129"></a><span id="l10.129" class="difflineplus">+            let rel = new calRelation();</span>
<a href="#l10.130"></a><span id="l10.130">             rel.icalProperty = relprop;</span>
<a href="#l10.131"></a><span id="l10.131">             this.addRelation(rel);</span>
<a href="#l10.132"></a><span id="l10.132">         }</span>
<a href="#l10.133"></a><span id="l10.133"> </span>
<a href="#l10.134"></a><span id="l10.134" class="difflineminus">-        var orgprop = icalcomp.getFirstProperty(&quot;ORGANIZER&quot;);</span>
<a href="#l10.135"></a><span id="l10.135" class="difflineplus">+        let orgprop = icalcomp.getFirstProperty(&quot;ORGANIZER&quot;);</span>
<a href="#l10.136"></a><span id="l10.136">         if (orgprop) {</span>
<a href="#l10.137"></a><span id="l10.137" class="difflineminus">-            var org = new CalAttendee();</span>
<a href="#l10.138"></a><span id="l10.138" class="difflineplus">+            let org = new calAttendee();</span>
<a href="#l10.139"></a><span id="l10.139">             org.icalProperty = orgprop;</span>
<a href="#l10.140"></a><span id="l10.140">             org.isOrganizer = true;</span>
<a href="#l10.141"></a><span id="l10.141">             this.mOrganizer = org;</span>
<a href="#l10.142"></a><span id="l10.142">         }</span>
<a href="#l10.143"></a><span id="l10.143"> </span>
<a href="#l10.144"></a><span id="l10.144" class="difflineminus">-        this.mCategories = [];</span>
<a href="#l10.145"></a><span id="l10.145" class="difflineminus">-        for (var catprop = icalcomp.getFirstProperty(&quot;CATEGORIES&quot;);</span>
<a href="#l10.146"></a><span id="l10.146" class="difflineminus">-             catprop;</span>
<a href="#l10.147"></a><span id="l10.147" class="difflineminus">-             catprop = icalcomp.getNextProperty(&quot;CATEGORIES&quot;)) {</span>
<a href="#l10.148"></a><span id="l10.148" class="difflineminus">-            this.mCategories.push(catprop.value);</span>
<a href="#l10.149"></a><span id="l10.149" class="difflineminus">-        }</span>
<a href="#l10.150"></a><span id="l10.150" class="difflineplus">+        this.mCategories = [ catprop.value for (catprop in cal.ical.propertyIterator(icalcomp, &quot;CATEGORIES&quot;)) ];</span>
<a href="#l10.151"></a><span id="l10.151"> </span>
<a href="#l10.152"></a><span id="l10.152">         // find recurrence properties</span>
<a href="#l10.153"></a><span id="l10.153" class="difflineminus">-        var rec = null;</span>
<a href="#l10.154"></a><span id="l10.154" class="difflineminus">-        for (var recprop = icalcomp.getFirstProperty(&quot;ANY&quot;);</span>
<a href="#l10.155"></a><span id="l10.155" class="difflineminus">-             recprop;</span>
<a href="#l10.156"></a><span id="l10.156" class="difflineminus">-             recprop = icalcomp.getNextProperty(&quot;ANY&quot;))</span>
<a href="#l10.157"></a><span id="l10.157" class="difflineminus">-        {</span>
<a href="#l10.158"></a><span id="l10.158" class="difflineminus">-            var ritem = null;</span>
<a href="#l10.159"></a><span id="l10.159" class="difflineminus">-            if (recprop.propertyName == &quot;RRULE&quot; ||</span>
<a href="#l10.160"></a><span id="l10.160" class="difflineminus">-                recprop.propertyName == &quot;EXRULE&quot;)</span>
<a href="#l10.161"></a><span id="l10.161" class="difflineminus">-            {</span>
<a href="#l10.162"></a><span id="l10.162" class="difflineminus">-                ritem = new CalRecurrenceRule();</span>
<a href="#l10.163"></a><span id="l10.163" class="difflineminus">-            } else if (recprop.propertyName == &quot;RDATE&quot; ||</span>
<a href="#l10.164"></a><span id="l10.164" class="difflineminus">-                       recprop.propertyName == &quot;EXDATE&quot;)</span>
<a href="#l10.165"></a><span id="l10.165" class="difflineminus">-            {</span>
<a href="#l10.166"></a><span id="l10.166" class="difflineminus">-                ritem = new CalRecurrenceDate();</span>
<a href="#l10.167"></a><span id="l10.167" class="difflineminus">-            } else {</span>
<a href="#l10.168"></a><span id="l10.168" class="difflineminus">-                continue;</span>
<a href="#l10.169"></a><span id="l10.169" class="difflineplus">+        let rec = null;</span>
<a href="#l10.170"></a><span id="l10.170" class="difflineplus">+        for (let recprop in cal.ical.propertyIterator(icalcomp)) {</span>
<a href="#l10.171"></a><span id="l10.171" class="difflineplus">+            let ritem = null;</span>
<a href="#l10.172"></a><span id="l10.172" class="difflineplus">+            switch (recprop.propertyName) {</span>
<a href="#l10.173"></a><span id="l10.173" class="difflineplus">+                case &quot;RRULE&quot;:</span>
<a href="#l10.174"></a><span id="l10.174" class="difflineplus">+                case &quot;EXRULE&quot;:</span>
<a href="#l10.175"></a><span id="l10.175" class="difflineplus">+                    ritem = new CalRecurrenceRule();</span>
<a href="#l10.176"></a><span id="l10.176" class="difflineplus">+                    break;</span>
<a href="#l10.177"></a><span id="l10.177" class="difflineplus">+                case &quot;RDATE&quot;:</span>
<a href="#l10.178"></a><span id="l10.178" class="difflineplus">+                case &quot;EXDATE&quot;:</span>
<a href="#l10.179"></a><span id="l10.179" class="difflineplus">+                    ritem = new CalRecurrenceDate();</span>
<a href="#l10.180"></a><span id="l10.180" class="difflineplus">+                    break;</span>
<a href="#l10.181"></a><span id="l10.181" class="difflineplus">+                default:</span>
<a href="#l10.182"></a><span id="l10.182" class="difflineplus">+                    continue;</span>
<a href="#l10.183"></a><span id="l10.183">             }</span>
<a href="#l10.184"></a><span id="l10.184"> </span>
<a href="#l10.185"></a><span id="l10.185">             ritem.icalProperty = recprop;</span>
<a href="#l10.186"></a><span id="l10.186"> </span>
<a href="#l10.187"></a><span id="l10.187">             if (!rec) {</span>
<a href="#l10.188"></a><span id="l10.188">                 rec = new calRecurrenceInfo();</span>
<a href="#l10.189"></a><span id="l10.189">                 rec.item = this;</span>
<a href="#l10.190"></a><span id="l10.190">             }</span>
<a href="#l10.191"></a><span id="l10.191"> </span>
<a href="#l10.192"></a><span id="l10.192">             rec.appendRecurrenceItem(ritem);</span>
<a href="#l10.193"></a><span id="l10.193">         }</span>
<a href="#l10.194"></a><span id="l10.194">         this.mRecurrenceInfo = rec;</span>
<a href="#l10.195"></a><span id="l10.195"> </span>
<a href="#l10.196"></a><span id="l10.196" class="difflineminus">-        var alarmComp = icalcomp.getFirstSubcomponent(&quot;VALARM&quot;);</span>
<a href="#l10.197"></a><span id="l10.197" class="difflineplus">+        let alarmComp = icalcomp.getFirstSubcomponent(&quot;VALARM&quot;);</span>
<a href="#l10.198"></a><span id="l10.198">         if (alarmComp) {</span>
<a href="#l10.199"></a><span id="l10.199" class="difflineminus">-            var triggerProp = alarmComp.getFirstProperty(&quot;TRIGGER&quot;);</span>
<a href="#l10.200"></a><span id="l10.200" class="difflineminus">-            // Really, really old Sunbird/Calendar versions didn't give us a</span>
<a href="#l10.201"></a><span id="l10.201" class="difflineminus">-            // trigger.</span>
<a href="#l10.202"></a><span id="l10.202" class="difflineminus">-            if (!triggerProp) {</span>
<a href="#l10.203"></a><span id="l10.203" class="difflineminus">-                Components.utils.reportError(&quot;No trigger property for alarm on item: &quot;+this.id);</span>
<a href="#l10.204"></a><span id="l10.204" class="difflineminus">-                // No parsing happens after alarms, so just return</span>
<a href="#l10.205"></a><span id="l10.205" class="difflineminus">-                return;</span>
<a href="#l10.206"></a><span id="l10.206" class="difflineplus">+            let triggerProp = alarmComp.getFirstProperty(&quot;TRIGGER&quot;);</span>
<a href="#l10.207"></a><span id="l10.207" class="difflineplus">+            if (triggerProp) {</span>
<a href="#l10.208"></a><span id="l10.208" class="difflineplus">+                this.alarmOffset = cal.createDuration(triggerProp.valueAsIcalString);</span>
<a href="#l10.209"></a><span id="l10.209" class="difflineplus">+</span>
<a href="#l10.210"></a><span id="l10.210" class="difflineplus">+                let related = triggerProp.getParameter(&quot;RELATED&quot;);</span>
<a href="#l10.211"></a><span id="l10.211" class="difflineplus">+                if (related &amp;&amp; related == &quot;END&quot;) {</span>
<a href="#l10.212"></a><span id="l10.212" class="difflineplus">+                    this.alarmRelated = Components.interfaces.calIItemBase.ALARM_RELATED_END;</span>
<a href="#l10.213"></a><span id="l10.213" class="difflineplus">+                } else {</span>
<a href="#l10.214"></a><span id="l10.214" class="difflineplus">+                    this.alarmRelated = Components.interfaces.calIItemBase.ALARM_RELATED_START;</span>
<a href="#l10.215"></a><span id="l10.215" class="difflineplus">+                }</span>
<a href="#l10.216"></a><span id="l10.216" class="difflineplus">+</span>
<a href="#l10.217"></a><span id="l10.217" class="difflineplus">+                let email = alarmComp.getFirstProperty(&quot;X-EMAILADDRESS&quot;);</span>
<a href="#l10.218"></a><span id="l10.218" class="difflineplus">+                if (email) {</span>
<a href="#l10.219"></a><span id="l10.219" class="difflineplus">+                    this.setProperty(&quot;alarmEmailAddress&quot;, email.value);</span>
<a href="#l10.220"></a><span id="l10.220" class="difflineplus">+                }</span>
<a href="#l10.221"></a><span id="l10.221" class="difflineplus">+            } else {</span>
<a href="#l10.222"></a><span id="l10.222" class="difflineplus">+                // Really, really old Sunbird/Calendar versions didn't give us a</span>
<a href="#l10.223"></a><span id="l10.223" class="difflineplus">+                // trigger.</span>
<a href="#l10.224"></a><span id="l10.224" class="difflineplus">+                cal.ERROR(&quot;No trigger property for alarm on item: &quot; + this.id);</span>
<a href="#l10.225"></a><span id="l10.225">             }</span>
<a href="#l10.226"></a><span id="l10.226" class="difflineminus">-            var duration = Components.classes[&quot;@mozilla.org/calendar/duration;1&quot;]</span>
<a href="#l10.227"></a><span id="l10.227" class="difflineminus">-                                     .createInstance(Components.interfaces.calIDuration);</span>
<a href="#l10.228"></a><span id="l10.228" class="difflineminus">-            duration.icalString = triggerProp.valueAsIcalString;</span>
<a href="#l10.229"></a><span id="l10.229" class="difflineminus">-            this.alarmOffset = duration;</span>
<a href="#l10.230"></a><span id="l10.230" class="difflineminus">-</span>
<a href="#l10.231"></a><span id="l10.231" class="difflineminus">-            var related = triggerProp.getParameter(&quot;RELATED&quot;);</span>
<a href="#l10.232"></a><span id="l10.232" class="difflineminus">-            if (related &amp;&amp; related == &quot;END&quot;)</span>
<a href="#l10.233"></a><span id="l10.233" class="difflineminus">-                this.alarmRelated = Components.interfaces.calIItemBase.ALARM_RELATED_END;</span>
<a href="#l10.234"></a><span id="l10.234" class="difflineminus">-            else</span>
<a href="#l10.235"></a><span id="l10.235" class="difflineminus">-                this.alarmRelated = Components.interfaces.calIItemBase.ALARM_RELATED_START;</span>
<a href="#l10.236"></a><span id="l10.236" class="difflineminus">-</span>
<a href="#l10.237"></a><span id="l10.237" class="difflineminus">-            var email = alarmComp.getFirstProperty(&quot;X-EMAILADDRESS&quot;);</span>
<a href="#l10.238"></a><span id="l10.238" class="difflineminus">-            if (email)</span>
<a href="#l10.239"></a><span id="l10.239" class="difflineminus">-                this.setProperty(&quot;alarmEmailAddress&quot;, email.value);</span>
<a href="#l10.240"></a><span id="l10.240">         }</span>
<a href="#l10.241"></a><span id="l10.241"> </span>
<a href="#l10.242"></a><span id="l10.242" class="difflineminus">-        var lastAck = icalcomp.getFirstProperty(&quot;X-MOZ-LASTACK&quot;);</span>
<a href="#l10.243"></a><span id="l10.243" class="difflineplus">+        let lastAck = icalcomp.getFirstProperty(&quot;X-MOZ-LASTACK&quot;);</span>
<a href="#l10.244"></a><span id="l10.244">         if (lastAck) {</span>
<a href="#l10.245"></a><span id="l10.245" class="difflineminus">-            var lastAckTime = createDateTime();</span>
<a href="#l10.246"></a><span id="l10.246" class="difflineminus">-            lastAckTime.icalString = lastAck.value;</span>
<a href="#l10.247"></a><span id="l10.247" class="difflineminus">-            this.alarmLastAck = lastAckTime;</span>
<a href="#l10.248"></a><span id="l10.248" class="difflineplus">+            this.alarmLastAck = cal.createDateTime(lastAck.value);</span>
<a href="#l10.249"></a><span id="l10.249">         }</span>
<a href="#l10.250"></a><span id="l10.250">     },</span>
<a href="#l10.251"></a><span id="l10.251"> </span>
<a href="#l10.252"></a><span id="l10.252">     importUnpromotedProperties: function (icalcomp, promoted) {</span>
<a href="#l10.253"></a><span id="l10.253" class="difflineminus">-        for (var prop = icalcomp.getFirstProperty(&quot;ANY&quot;);</span>
<a href="#l10.254"></a><span id="l10.254" class="difflineminus">-             prop;</span>
<a href="#l10.255"></a><span id="l10.255" class="difflineminus">-             prop = icalcomp.getNextProperty(&quot;ANY&quot;)) {</span>
<a href="#l10.256"></a><span id="l10.256" class="difflineminus">-            if (!promoted[prop.propertyName]) {</span>
<a href="#l10.257"></a><span id="l10.257" class="difflineminus">-                this.setProperty(prop.propertyName, prop.value);</span>
<a href="#l10.258"></a><span id="l10.258" class="difflineminus">-                var param = prop.getFirstParameterName();</span>
<a href="#l10.259"></a><span id="l10.259" class="difflineminus">-                while (param) {</span>
<a href="#l10.260"></a><span id="l10.260" class="difflineminus">-                    if (!(prop.propertyName in this.mPropertyParams)) {</span>
<a href="#l10.261"></a><span id="l10.261" class="difflineminus">-                        this.mPropertyParams[prop.propertyName] = {};</span>
<a href="#l10.262"></a><span id="l10.262" class="difflineplus">+        for (let prop in cal.ical.propertyIterator(icalcomp)) {</span>
<a href="#l10.263"></a><span id="l10.263" class="difflineplus">+            let propName = prop.propertyName;</span>
<a href="#l10.264"></a><span id="l10.264" class="difflineplus">+            if (!promoted[propName]) {</span>
<a href="#l10.265"></a><span id="l10.265" class="difflineplus">+                this.setProperty(propName, prop.value);</span>
<a href="#l10.266"></a><span id="l10.266" class="difflineplus">+                for each (let [paramName, paramValue] in cal.ical.paramIterator(prop)) {</span>
<a href="#l10.267"></a><span id="l10.267" class="difflineplus">+                    if (!(propName in this.mPropertyParams)) {</span>
<a href="#l10.268"></a><span id="l10.268" class="difflineplus">+                        this.mPropertyParams[propName] = {};</span>
<a href="#l10.269"></a><span id="l10.269">                     }</span>
<a href="#l10.270"></a><span id="l10.270" class="difflineminus">-                    this.mPropertyParams[prop.propertyName][param] = prop.getParameter(param);</span>
<a href="#l10.271"></a><span id="l10.271" class="difflineminus">-                    param = prop.getNextParameterName();</span>
<a href="#l10.272"></a><span id="l10.272" class="difflineplus">+                    this.mPropertyParams[propName][paramName] = paramValue;</span>
<a href="#l10.273"></a><span id="l10.273">                 }</span>
<a href="#l10.274"></a><span id="l10.274">             }</span>
<a href="#l10.275"></a><span id="l10.275">         }</span>
<a href="#l10.276"></a><span id="l10.276">     },</span>
<a href="#l10.277"></a><span id="l10.277"> </span>
<a href="#l10.278"></a><span id="l10.278">     // This method is case-insensitive.</span>
<a href="#l10.279"></a><span id="l10.279">     isPropertyPromoted: function (name) {</span>
<a href="#l10.280"></a><span id="l10.280">         return (this.itemBasePromotedProps[name.toUpperCase()]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/calendar/base/src/calItemModule.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/calendar/base/src/calItemModule.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -53,33 +53,30 @@ const kCalIRecurrenceDate = Components.i</span>
<a href="#l11.4"></a><span id="l11.4"> </span>
<a href="#l11.5"></a><span id="l11.5"> /* Constructor helpers, lazily initialized to avoid registration races. */</span>
<a href="#l11.6"></a><span id="l11.6"> var CalRecurrenceInfo = null;</span>
<a href="#l11.7"></a><span id="l11.7"> var CalRecurrenceRule = null;</span>
<a href="#l11.8"></a><span id="l11.8"> var CalRecurrenceDateSet = null;</span>
<a href="#l11.9"></a><span id="l11.9"> var CalRecurrenceDate = null;</span>
<a href="#l11.10"></a><span id="l11.10"> var CalDateTime = null;</span>
<a href="#l11.11"></a><span id="l11.11"> var CalDuration = null;</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-var CalAttendee = null;</span>
<a href="#l11.13"></a><span id="l11.13"> var CalItipItem = null;</span>
<a href="#l11.14"></a><span id="l11.14"> </span>
<a href="#l11.15"></a><span id="l11.15"> var componentInitRun = false;</span>
<a href="#l11.16"></a><span id="l11.16"> function initBaseComponent()</span>
<a href="#l11.17"></a><span id="l11.17"> {</span>
<a href="#l11.18"></a><span id="l11.18">     CalRecurrenceInfo = new Components.Constructor(kCalRecurrenceInfoContractID, kCalIRecurrenceInfo);</span>
<a href="#l11.19"></a><span id="l11.19">     CalRecurrenceRule = new Components.Constructor(kCalRecurrenceRuleContractID, kCalIRecurrenceRule);</span>
<a href="#l11.20"></a><span id="l11.20">     CalRecurrenceDateSet = new Components.Constructor(kCalRecurrenceDateSetContractID, kCalIRecurrenceDateSet);</span>
<a href="#l11.21"></a><span id="l11.21">     CalRecurrenceDate = new Components.Constructor(kCalRecurrenceDateContractID, kCalIRecurrenceDate);</span>
<a href="#l11.22"></a><span id="l11.22"> </span>
<a href="#l11.23"></a><span id="l11.23">     CalDateTime = new Components.Constructor(&quot;@mozilla.org/calendar/datetime;1&quot;,</span>
<a href="#l11.24"></a><span id="l11.24">                                              Components.interfaces.calIDateTime);</span>
<a href="#l11.25"></a><span id="l11.25">     CalDuration = new Components.Constructor(&quot;@mozilla.org/calendar/duration;1&quot;,</span>
<a href="#l11.26"></a><span id="l11.26">                                              Components.interfaces.calIDateTime);</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineminus">-    CalAttendee = new Components.Constructor(&quot;@mozilla.org/calendar/attendee;1&quot;,</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineminus">-                                             Components.interfaces.calIAttendee);</span>
<a href="#l11.29"></a><span id="l11.29">     CalItipItem = new Components.Constructor(&quot;@mozilla.org/calendar/itip-item;1&quot;,</span>
<a href="#l11.30"></a><span id="l11.30">                                              Components.interfaces.calIItipItem);</span>
<a href="#l11.31"></a><span id="l11.31"> }</span>
<a href="#l11.32"></a><span id="l11.32"> </span>
<a href="#l11.33"></a><span id="l11.33"> </span>
<a href="#l11.34"></a><span id="l11.34"> /* Update these in calBaseCID.h */</span>
<a href="#l11.35"></a><span id="l11.35"> const componentData =</span>
<a href="#l11.36"></a><span id="l11.36">     [</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/calendar/base/src/calItipItem.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/calendar/base/src/calItipItem.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -33,16 +33,18 @@</span>
<a href="#l12.4"></a><span id="l12.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l12.5"></a><span id="l12.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l12.6"></a><span id="l12.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l12.7"></a><span id="l12.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l12.8"></a><span id="l12.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l12.9"></a><span id="l12.9">  *</span>
<a href="#l12.10"></a><span id="l12.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l12.11"></a><span id="l12.11"> </span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calIteratorUtils.jsm&quot;);</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+</span>
<a href="#l12.14"></a><span id="l12.14"> /**</span>
<a href="#l12.15"></a><span id="l12.15">  * Constructor of calItipItem object</span>
<a href="#l12.16"></a><span id="l12.16">  */</span>
<a href="#l12.17"></a><span id="l12.17"> function calItipItem() {</span>
<a href="#l12.18"></a><span id="l12.18">     this.wrappedJSObject = this;</span>
<a href="#l12.19"></a><span id="l12.19">     this.mCurrentItemIndex = 0;</span>
<a href="#l12.20"></a><span id="l12.20"> }</span>
<a href="#l12.21"></a><span id="l12.21"> </span>
<a href="#l12.22"></a><span id="l12.22" class="difflineat">@@ -167,17 +169,17 @@ calItipItem.prototype = {</span>
<a href="#l12.23"></a><span id="l12.23">                     att.deleteProperty(&quot;RECEIVED-SEQUENCE&quot;);</span>
<a href="#l12.24"></a><span id="l12.24">                     att.deleteProperty(&quot;RECEIVED-DTSTAMP&quot;);</span>
<a href="#l12.25"></a><span id="l12.25">                 });</span>
<a href="#l12.26"></a><span id="l12.26">             item.setProperty(&quot;DTSTAMP&quot;, stamp);</span>
<a href="#l12.27"></a><span id="l12.27">             item.setProperty(&quot;LAST-MODIFIED&quot;, lastModified); // need to be last to undirty the item</span>
<a href="#l12.28"></a><span id="l12.28">         }</span>
<a href="#l12.29"></a><span id="l12.29"> </span>
<a href="#l12.30"></a><span id="l12.30">         this.mItemList = [];</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineminus">-        for each (let item in cal.itemIterator(parser.getItems({}))) {</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineplus">+        for (let item in cal.itemIterator(parser.getItems({}))) {</span>
<a href="#l12.33"></a><span id="l12.33">             cleanItem(item);</span>
<a href="#l12.34"></a><span id="l12.34">             // only push non-faked master items or</span>
<a href="#l12.35"></a><span id="l12.35">             // the overridden instances of faked master items</span>
<a href="#l12.36"></a><span id="l12.36">             // to the list:</span>
<a href="#l12.37"></a><span id="l12.37">             if (item == item.parentItem) {</span>
<a href="#l12.38"></a><span id="l12.38">                 if (!item.hasProperty(&quot;X-MOZ-FAKED-MASTER&quot;)) {</span>
<a href="#l12.39"></a><span id="l12.39">                     this.mItemList.push(item);</span>
<a href="#l12.40"></a><span id="l12.40">                 }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/calendar/base/src/calRelation.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/calendar/base/src/calRelation.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -29,16 +29,18 @@</span>
<a href="#l13.4"></a><span id="l13.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l13.5"></a><span id="l13.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l13.6"></a><span id="l13.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l13.7"></a><span id="l13.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l13.8"></a><span id="l13.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l13.9"></a><span id="l13.9">  *</span>
<a href="#l13.10"></a><span id="l13.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l13.11"></a><span id="l13.11"> </span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calIteratorUtils.jsm&quot;);</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+</span>
<a href="#l13.14"></a><span id="l13.14"> //</span>
<a href="#l13.15"></a><span id="l13.15"> // calRelation.js</span>
<a href="#l13.16"></a><span id="l13.16"> //</span>
<a href="#l13.17"></a><span id="l13.17"> function calRelation() {</span>
<a href="#l13.18"></a><span id="l13.18">     this.wrappedJSObject = this;</span>
<a href="#l13.19"></a><span id="l13.19">     this.mProperties = new calPropertyBag();</span>
<a href="#l13.20"></a><span id="l13.20"> }</span>
<a href="#l13.21"></a><span id="l13.21"> </span>
<a href="#l13.22"></a><span id="l13.22" class="difflineat">@@ -110,39 +112,33 @@ calRelation.prototype = {</span>
<a href="#l13.23"></a><span id="l13.23">         if (this.mId) {</span>
<a href="#l13.24"></a><span id="l13.24">             icalatt.value = this.mId;</span>
<a href="#l13.25"></a><span id="l13.25">         }</span>
<a href="#l13.26"></a><span id="l13.26"> </span>
<a href="#l13.27"></a><span id="l13.27">         if (this.mType) {</span>
<a href="#l13.28"></a><span id="l13.28">             icalatt.setParameter(&quot;RELTYPE&quot;, this.mType);</span>
<a href="#l13.29"></a><span id="l13.29">         }</span>
<a href="#l13.30"></a><span id="l13.30"> </span>
<a href="#l13.31"></a><span id="l13.31" class="difflineminus">-        var outKeys = {};</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineminus">-        var outValues = {};</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineminus">-        this.mProperties.getAllProperties(outKeys, outValues);</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineminus">-        for (var i = 0; i &lt; outKeys.value.length; i++) {</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineminus">-            icalatt.setParameter(outKeys.value[i], outValues.value[i]);</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineplus">+        for each (let [key, value] in this.mProperties) {</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineplus">+            icalatt.setParameter(key, value);</span>
<a href="#l13.38"></a><span id="l13.38">         }</span>
<a href="#l13.39"></a><span id="l13.39">         return icalatt;</span>
<a href="#l13.40"></a><span id="l13.40">     },</span>
<a href="#l13.41"></a><span id="l13.41"> </span>
<a href="#l13.42"></a><span id="l13.42">     set icalProperty cR_set_icalProperty(attProp) {</span>
<a href="#l13.43"></a><span id="l13.43">         if (attProp.value) {</span>
<a href="#l13.44"></a><span id="l13.44">             this.mId = attProp.value;</span>
<a href="#l13.45"></a><span id="l13.45">         }</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineminus">-</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineminus">-        for (var paramname = attProp.getFirstParameterName();</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineminus">-             paramname;</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineminus">-             paramname = attProp.getNextParameterName()) {</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineminus">-            if (paramname == &quot;RELTYPE&quot;) {</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineminus">-                this.mType = attProp.getParameter(&quot;RELTYPE&quot;);</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineplus">+        for each (let [name, value] in cal.ical.paramIterator(attProp)) {</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineplus">+            if (name == &quot;RELTYPE&quot;) {</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineplus">+                this.mType = value;</span>
<a href="#l13.55"></a><span id="l13.55">                 continue;</span>
<a href="#l13.56"></a><span id="l13.56">             }</span>
<a href="#l13.57"></a><span id="l13.57"> </span>
<a href="#l13.58"></a><span id="l13.58" class="difflineminus">-            this.setProperty(paramname, attProp.getParameter(paramname));</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineplus">+            this.setProperty(name, value);</span>
<a href="#l13.60"></a><span id="l13.60">         }</span>
<a href="#l13.61"></a><span id="l13.61">     },</span>
<a href="#l13.62"></a><span id="l13.62"> </span>
<a href="#l13.63"></a><span id="l13.63">     getParameter: function (aName) {</span>
<a href="#l13.64"></a><span id="l13.64">         return this.mProperties.getProperty(aName);</span>
<a href="#l13.65"></a><span id="l13.65">     },</span>
<a href="#l13.66"></a><span id="l13.66"> </span>
<a href="#l13.67"></a><span id="l13.67">     setParameter: function (aName, aValue) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/calendar/base/src/calTimezoneService.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/calendar/base/src/calTimezoneService.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -32,16 +32,18 @@</span>
<a href="#l14.4"></a><span id="l14.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l14.5"></a><span id="l14.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l14.6"></a><span id="l14.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l14.7"></a><span id="l14.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l14.8"></a><span id="l14.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l14.9"></a><span id="l14.9">  *</span>
<a href="#l14.10"></a><span id="l14.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l14.11"></a><span id="l14.11"> </span>
<a href="#l14.12"></a><span id="l14.12" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calIteratorUtils.jsm&quot;);</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+</span>
<a href="#l14.14"></a><span id="l14.14"> var g_stringBundle = null;</span>
<a href="#l14.15"></a><span id="l14.15"> </span>
<a href="#l14.16"></a><span id="l14.16"> function calIntrinsicTimezone(tzid, component, latitude, longitude) {</span>
<a href="#l14.17"></a><span id="l14.17">     this.wrappedJSObject = this;</span>
<a href="#l14.18"></a><span id="l14.18">     this.tzid = tzid;</span>
<a href="#l14.19"></a><span id="l14.19">     this.mComponent = component;</span>
<a href="#l14.20"></a><span id="l14.20">     this.isUTC = false;</span>
<a href="#l14.21"></a><span id="l14.21">     this.isFloating = false;</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineat">@@ -491,19 +493,17 @@ function guessSystemTimezone() {</span>
<a href="#l14.23"></a><span id="l14.23">     function findCurrentTimePeriod(tz, subComp, standardOrDaylight,</span>
<a href="#l14.24"></a><span id="l14.24">                                    isForNextTransitionDate) {</span>
<a href="#l14.25"></a><span id="l14.25">         // Iterate through 'STANDARD' declarations or 'DAYLIGHT' declarations</span>
<a href="#l14.26"></a><span id="l14.26">         // (periods in history with different settings.</span>
<a href="#l14.27"></a><span id="l14.27">         //  e.g., US changes daylight start in 2007 (from April to March).)</span>
<a href="#l14.28"></a><span id="l14.28">         // Each period is marked by a DTSTART.</span>
<a href="#l14.29"></a><span id="l14.29">         // Find the currently applicable period: has most recent DTSTART</span>
<a href="#l14.30"></a><span id="l14.30">         // not later than today and no UNTIL, or UNTIL is greater than today.</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineminus">-        for (var period = subComp.getFirstSubcomponent(standardOrDaylight);</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineminus">-             period;</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineminus">-             period = subComp.getNextSubcomponent(standardOrDaylight)) {</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineplus">+        for (let period in cal.ical.subcomponentIterator(subComp, standardOrDayLight)) {</span>
<a href="#l14.35"></a><span id="l14.35">             periodStartCalDate.icalString = getIcalString(period, &quot;DTSTART&quot;);</span>
<a href="#l14.36"></a><span id="l14.36">             periodStartCalDate.timezone = tz;</span>
<a href="#l14.37"></a><span id="l14.37">             if (oneYrUTC.nativeTime &lt; periodStartCalDate.nativeTime) {</span>
<a href="#l14.38"></a><span id="l14.38">                 continue; // period starts too far in future</span>
<a href="#l14.39"></a><span id="l14.39">             }</span>
<a href="#l14.40"></a><span id="l14.40">             // Must examine UNTIL date (not next daylight start) because</span>
<a href="#l14.41"></a><span id="l14.41">             // some zones (e.g., Arizona, Hawaii) may stop using daylight</span>
<a href="#l14.42"></a><span id="l14.42">             // time, so there might not be a next daylight start.</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineat">@@ -528,18 +528,19 @@ function guessSystemTimezone() {</span>
<a href="#l14.44"></a><span id="l14.44">                     return periodStartCalDate.jsDate;</span>
<a href="#l14.45"></a><span id="l14.45">                 } else if (rrule) {</span>
<a href="#l14.46"></a><span id="l14.46">                     // find next occurrence after today</span>
<a href="#l14.47"></a><span id="l14.47">                     periodCalRule.icalProperty = rrule;</span>
<a href="#l14.48"></a><span id="l14.48">                     var nextTransitionDate =</span>
<a href="#l14.49"></a><span id="l14.49">                         periodCalRule.getNextOccurrence(periodStartCalDate,</span>
<a href="#l14.50"></a><span id="l14.50">                                                         todayUTC);</span>
<a href="#l14.51"></a><span id="l14.51">                     // make sure rule doesn't end before next transition date.</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineminus">-                    if (nextTransitionDate)</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineplus">+                    if (nextTransitionDate) {</span>
<a href="#l14.54"></a><span id="l14.54">                         return nextTransitionDate.jsDate;</span>
<a href="#l14.55"></a><span id="l14.55" class="difflineplus">+                    }</span>
<a href="#l14.56"></a><span id="l14.56">                 }</span>
<a href="#l14.57"></a><span id="l14.57">             }</span>
<a href="#l14.58"></a><span id="l14.58">         }</span>
<a href="#l14.59"></a><span id="l14.59">         // no such period found</span>
<a href="#l14.60"></a><span id="l14.60">         return null;</span>
<a href="#l14.61"></a><span id="l14.61">     }</span>
<a href="#l14.62"></a><span id="l14.62"> </span>
<a href="#l14.63"></a><span id="l14.63">     // Try to find a tz that matches OS/JSDate timezone.  If no name match,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/calendar/base/src/calUtils.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/calendar/base/src/calUtils.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -978,21 +978,22 @@ function STACK(aDepth, aSkip) {</span>
<a href="#l15.4"></a><span id="l15.4">  *                    if false, code flow will continue</span>
<a href="#l15.5"></a><span id="l15.5">  *                    may be a result code</span>
<a href="#l15.6"></a><span id="l15.6">  */</span>
<a href="#l15.7"></a><span id="l15.7"> function ASSERT(aCondition, aMessage, aCritical) {</span>
<a href="#l15.8"></a><span id="l15.8">     if (aCondition) {</span>
<a href="#l15.9"></a><span id="l15.9">         return;</span>
<a href="#l15.10"></a><span id="l15.10">     }</span>
<a href="#l15.11"></a><span id="l15.11"> </span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-    NS_ASSERT(aCondition, aMessage);</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+    let string = &quot;Assert failed: &quot; + aMessage + '\n' + STACK(0, 1);</span>
<a href="#l15.14"></a><span id="l15.14">     if (aCritical) {</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineminus">-        let string = &quot;Assert failed: &quot; + aMessage + '\n' + STACK(null, 1);</span>
<a href="#l15.16"></a><span id="l15.16">         throw new Components.Exception(string,</span>
<a href="#l15.17"></a><span id="l15.17">                                        aCritical === true ? Components.results.NS_ERROR_UNEXPECTED : aCritical);</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineplus">+    } else {</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineplus">+        Components.utils.reportError(string);</span>
<a href="#l15.20"></a><span id="l15.20">     }</span>
<a href="#l15.21"></a><span id="l15.21"> }</span>
<a href="#l15.22"></a><span id="l15.22"> </span>
<a href="#l15.23"></a><span id="l15.23"> /**</span>
<a href="#l15.24"></a><span id="l15.24">  * Uses the prompt service to display an error message.</span>
<a href="#l15.25"></a><span id="l15.25">  * This function cannot be migrated into a module file, because it relies on an outer window object.</span>
<a href="#l15.26"></a><span id="l15.26">  *</span>
<a href="#l15.27"></a><span id="l15.27">  * @param aMsg The message to be shown</span>
<a href="#l15.28"></a><span id="l15.28" class="difflineat">@@ -1397,44 +1398,16 @@ function sameDay(date1, date2) {</span>
<a href="#l15.29"></a><span id="l15.29">             (date1.year == date2.year)) {</span>
<a href="#l15.30"></a><span id="l15.30">               return true;</span>
<a href="#l15.31"></a><span id="l15.31">         }</span>
<a href="#l15.32"></a><span id="l15.32">     }</span>
<a href="#l15.33"></a><span id="l15.33">     return false;</span>
<a href="#l15.34"></a><span id="l15.34"> }</span>
<a href="#l15.35"></a><span id="l15.35"> </span>
<a href="#l15.36"></a><span id="l15.36"> /**</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineminus">- * Iterates all components inside the passed ical component and calls the passed function.</span>
<a href="#l15.38"></a><span id="l15.38" class="difflineminus">- * If the called function returns false, iteration is stopped.</span>
<a href="#l15.39"></a><span id="l15.39" class="difflineminus">- *</span>
<a href="#l15.40"></a><span id="l15.40" class="difflineminus">- * @param icalComp an ICS component</span>
<a href="#l15.41"></a><span id="l15.41" class="difflineminus">- * @param func functor that will be executed on sub components</span>
<a href="#l15.42"></a><span id="l15.42" class="difflineminus">- * @param compType optional component type to filter, defaults to &quot;ANY&quot;</span>
<a href="#l15.43"></a><span id="l15.43" class="difflineminus">- */</span>
<a href="#l15.44"></a><span id="l15.44" class="difflineminus">-function calIterateIcalComponent(icalComp, func, compType) {</span>
<a href="#l15.45"></a><span id="l15.45" class="difflineminus">-    if (icalComp) {</span>
<a href="#l15.46"></a><span id="l15.46" class="difflineminus">-        if (!compType) {</span>
<a href="#l15.47"></a><span id="l15.47" class="difflineminus">-            compType = &quot;ANY&quot;;</span>
<a href="#l15.48"></a><span id="l15.48" class="difflineminus">-        }</span>
<a href="#l15.49"></a><span id="l15.49" class="difflineminus">-        var ctype = icalComp.componentType;</span>
<a href="#l15.50"></a><span id="l15.50" class="difflineminus">-        if (ctype != &quot;VCALENDAR&quot;) {</span>
<a href="#l15.51"></a><span id="l15.51" class="difflineminus">-            return (ctype == compType ? func(icalComp) : true);</span>
<a href="#l15.52"></a><span id="l15.52" class="difflineminus">-        }</span>
<a href="#l15.53"></a><span id="l15.53" class="difflineminus">-        for (var subComp = icalComp.getFirstSubcomponent(&quot;ANY&quot;);</span>
<a href="#l15.54"></a><span id="l15.54" class="difflineminus">-             subComp;</span>
<a href="#l15.55"></a><span id="l15.55" class="difflineminus">-             subComp = icalComp.getNextSubcomponent(&quot;ANY&quot;)) {</span>
<a href="#l15.56"></a><span id="l15.56" class="difflineminus">-            if (!calIterateIcalComponent(subComp, func, compType)) {</span>
<a href="#l15.57"></a><span id="l15.57" class="difflineminus">-                return false;</span>
<a href="#l15.58"></a><span id="l15.58" class="difflineminus">-            }</span>
<a href="#l15.59"></a><span id="l15.59" class="difflineminus">-        }</span>
<a href="#l15.60"></a><span id="l15.60" class="difflineminus">-    }</span>
<a href="#l15.61"></a><span id="l15.61" class="difflineminus">-    return true;</span>
<a href="#l15.62"></a><span id="l15.62" class="difflineminus">-}</span>
<a href="#l15.63"></a><span id="l15.63" class="difflineminus">-</span>
<a href="#l15.64"></a><span id="l15.64" class="difflineminus">-/**</span>
<a href="#l15.65"></a><span id="l15.65">  * Centralized funtions for accessing prodid and version</span>
<a href="#l15.66"></a><span id="l15.66">  */</span>
<a href="#l15.67"></a><span id="l15.67"> function calGetProductId() {</span>
<a href="#l15.68"></a><span id="l15.68">     return &quot;-//Mozilla.org/NONSGML Mozilla Calendar V1.1//EN&quot;;</span>
<a href="#l15.69"></a><span id="l15.69"> }</span>
<a href="#l15.70"></a><span id="l15.70"> function calGetProductVersion() {</span>
<a href="#l15.71"></a><span id="l15.71">     return &quot;2.0&quot;;</span>
<a href="#l15.72"></a><span id="l15.72"> }</span>
<a href="#l15.73"></a><span id="l15.73" class="difflineat">@@ -1720,27 +1693,26 @@ calPropertyBag.prototype = {</span>
<a href="#l15.74"></a><span id="l15.74">         aOutKeys.value = keys;</span>
<a href="#l15.75"></a><span id="l15.75">         aOutValues.value = values;</span>
<a href="#l15.76"></a><span id="l15.76">     },</span>
<a href="#l15.77"></a><span id="l15.77">     deleteProperty: function cpb_deleteProperty(aName) {</span>
<a href="#l15.78"></a><span id="l15.78">         delete this.mData[aName];</span>
<a href="#l15.79"></a><span id="l15.79">     },</span>
<a href="#l15.80"></a><span id="l15.80">     get enumerator() {</span>
<a href="#l15.81"></a><span id="l15.81">         return new calPropertyBagEnumerator(this);</span>
<a href="#l15.82"></a><span id="l15.82" class="difflineplus">+    },</span>
<a href="#l15.83"></a><span id="l15.83" class="difflineplus">+    __iterator__: function cpb_iterator(aWantKeys) {</span>
<a href="#l15.84"></a><span id="l15.84" class="difflineplus">+        return Iterator(this.mData, aWantKeys);</span>
<a href="#l15.85"></a><span id="l15.85">     }</span>
<a href="#l15.86"></a><span id="l15.86"> };</span>
<a href="#l15.87"></a><span id="l15.87"> // implementation part of calPropertyBag</span>
<a href="#l15.88"></a><span id="l15.88"> function calPropertyBagEnumerator(bag) {</span>
<a href="#l15.89"></a><span id="l15.89">     this.mIndex = 0;</span>
<a href="#l15.90"></a><span id="l15.90">     this.mBag = bag;</span>
<a href="#l15.91"></a><span id="l15.91" class="difflineminus">-    var keys = [];</span>
<a href="#l15.92"></a><span id="l15.92" class="difflineminus">-    for (var key in bag.mData) {</span>
<a href="#l15.93"></a><span id="l15.93" class="difflineminus">-        keys.push(key);</span>
<a href="#l15.94"></a><span id="l15.94" class="difflineminus">-    }</span>
<a href="#l15.95"></a><span id="l15.95" class="difflineminus">-    this.mKeys = keys;</span>
<a href="#l15.96"></a><span id="l15.96" class="difflineplus">+    this.mKeys = [ key for (key in bag.mData) ];</span>
<a href="#l15.97"></a><span id="l15.97"> }</span>
<a href="#l15.98"></a><span id="l15.98"> calPropertyBagEnumerator.prototype = {</span>
<a href="#l15.99"></a><span id="l15.99">     mIndex: 0,</span>
<a href="#l15.100"></a><span id="l15.100">     mBag: null,</span>
<a href="#l15.101"></a><span id="l15.101">     mKeys: null,</span>
<a href="#l15.102"></a><span id="l15.102"> </span>
<a href="#l15.103"></a><span id="l15.103">     // nsISimpleEnumerator:</span>
<a href="#l15.104"></a><span id="l15.104">     getNext: function cpb_enum_getNext() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/calendar/providers/caldav/calDavCalendar.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/calendar/providers/caldav/calDavCalendar.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -38,16 +38,19 @@</span>
<a href="#l16.4"></a><span id="l16.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l16.5"></a><span id="l16.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l16.6"></a><span id="l16.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l16.7"></a><span id="l16.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l16.8"></a><span id="l16.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l16.9"></a><span id="l16.9">  *</span>
<a href="#l16.10"></a><span id="l16.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l16.11"></a><span id="l16.11"> </span>
<a href="#l16.12"></a><span id="l16.12" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calIteratorUtils.jsm&quot;);</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineplus">+</span>
<a href="#l16.15"></a><span id="l16.15"> //</span>
<a href="#l16.16"></a><span id="l16.16"> // calDavCalendar.js</span>
<a href="#l16.17"></a><span id="l16.17"> //</span>
<a href="#l16.18"></a><span id="l16.18"> </span>
<a href="#l16.19"></a><span id="l16.19"> const xmlHeader = '&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;\n';</span>
<a href="#l16.20"></a><span id="l16.20"> </span>
<a href="#l16.21"></a><span id="l16.21"> function calDavCalendar() {</span>
<a href="#l16.22"></a><span id="l16.22">     this.initProviderBase();</span>
<a href="#l16.23"></a><span id="l16.23" class="difflineat">@@ -1977,64 +1980,61 @@ calDavCalendar.prototype = {</span>
<a href="#l16.24"></a><span id="l16.24">                     return;</span>
<a href="#l16.25"></a><span id="l16.25">                 }</span>
<a href="#l16.26"></a><span id="l16.26">                 if (status.substr(0,3) != &quot;2.0&quot;) {</span>
<a href="#l16.27"></a><span id="l16.27">                     LOG(&quot;CalDAV: Got status &quot; + status + &quot; in response to freebusy query&quot;);</span>
<a href="#l16.28"></a><span id="l16.28">                 }</span>
<a href="#l16.29"></a><span id="l16.29"> </span>
<a href="#l16.30"></a><span id="l16.30">                 var caldata = response..C::response..C::[&quot;calendar-data&quot;];</span>
<a href="#l16.31"></a><span id="l16.31">                 try {</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineminus">-                    function iterFunc(fbComp) {</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineminus">-                        var interval;</span>
<a href="#l16.34"></a><span id="l16.34" class="difflineplus">+                    let calComp = getIcsService().parseICS(caldata, null);</span>
<a href="#l16.35"></a><span id="l16.35" class="difflineplus">+                    for (let fbComp in cal.ical.calendarComponentIterator(calComp)) {</span>
<a href="#l16.36"></a><span id="l16.36" class="difflineplus">+                        let interval;</span>
<a href="#l16.37"></a><span id="l16.37"> </span>
<a href="#l16.38"></a><span id="l16.38" class="difflineminus">-                        var replyRangeStart = fbComp.startTime;</span>
<a href="#l16.39"></a><span id="l16.39" class="difflineplus">+                        let replyRangeStart = fbComp.startTime;</span>
<a href="#l16.40"></a><span id="l16.40">                         if (replyRangeStart &amp;&amp; (aRangeStart.compare(replyRangeStart) == -1)) {</span>
<a href="#l16.41"></a><span id="l16.41">                             interval = new calFreeBusyInterval(aCalId,</span>
<a href="#l16.42"></a><span id="l16.42">                                                                calIFreeBusyInterval.UNKNOWN,</span>
<a href="#l16.43"></a><span id="l16.43">                                                                aRangeStart,</span>
<a href="#l16.44"></a><span id="l16.44">                                                                replyRangeStart);</span>
<a href="#l16.45"></a><span id="l16.45">                             periodsToReturn.push(interval);</span>
<a href="#l16.46"></a><span id="l16.46">                         }</span>
<a href="#l16.47"></a><span id="l16.47" class="difflineminus">-                        var replyRangeEnd = fbComp.endTime;</span>
<a href="#l16.48"></a><span id="l16.48" class="difflineplus">+                        let replyRangeEnd = fbComp.endTime;</span>
<a href="#l16.49"></a><span id="l16.49">                         if (replyRangeEnd &amp;&amp; (aRangeEnd.compare(replyRangeEnd) == 1)) {</span>
<a href="#l16.50"></a><span id="l16.50">                             interval = new calFreeBusyInterval(aCalId,</span>
<a href="#l16.51"></a><span id="l16.51">                                                                calIFreeBusyInterval.UNKNOWN,</span>
<a href="#l16.52"></a><span id="l16.52">                                                                replyRangeEnd,</span>
<a href="#l16.53"></a><span id="l16.53">                                                                aRangeEnd);</span>
<a href="#l16.54"></a><span id="l16.54">                             periodsToReturn.push(interval);</span>
<a href="#l16.55"></a><span id="l16.55">                         }</span>
<a href="#l16.56"></a><span id="l16.56"> </span>
<a href="#l16.57"></a><span id="l16.57" class="difflineminus">-                        for (var fbProp = fbComp.getFirstProperty(&quot;FREEBUSY&quot;);</span>
<a href="#l16.58"></a><span id="l16.58" class="difflineminus">-                             fbProp;</span>
<a href="#l16.59"></a><span id="l16.59" class="difflineminus">-                             fbProp = fbComp.getNextProperty(&quot;FREEBUSY&quot;)) {</span>
<a href="#l16.60"></a><span id="l16.60" class="difflineminus">-</span>
<a href="#l16.61"></a><span id="l16.61" class="difflineminus">-                            var fbType = fbProp.getParameter(&quot;FBTYPE&quot;);</span>
<a href="#l16.62"></a><span id="l16.62" class="difflineplus">+                        for (let fbProp in cal.ical.propertyIterator(fbComp, &quot;FREEBUSY&quot;)) {</span>
<a href="#l16.63"></a><span id="l16.63" class="difflineplus">+                            let fbType = fbProp.getParameter(&quot;FBTYPE&quot;);</span>
<a href="#l16.64"></a><span id="l16.64">                             if (fbType) {</span>
<a href="#l16.65"></a><span id="l16.65">                                 fbType = fbTypeMap[fbType];</span>
<a href="#l16.66"></a><span id="l16.66">                             } else {</span>
<a href="#l16.67"></a><span id="l16.67">                                 fbType = calIFreeBusyInterval.UNKNOWN;</span>
<a href="#l16.68"></a><span id="l16.68">                             }</span>
<a href="#l16.69"></a><span id="l16.69" class="difflineminus">-                            var parts = fbProp.value.split(&quot;/&quot;);</span>
<a href="#l16.70"></a><span id="l16.70" class="difflineminus">-                            var begin = createDateTime(parts[0]);</span>
<a href="#l16.71"></a><span id="l16.71" class="difflineminus">-                            var end;</span>
<a href="#l16.72"></a><span id="l16.72" class="difflineplus">+                            let parts = fbProp.value.split(&quot;/&quot;);</span>
<a href="#l16.73"></a><span id="l16.73" class="difflineplus">+                            let begin = cal.createDateTime(parts[0]);</span>
<a href="#l16.74"></a><span id="l16.74" class="difflineplus">+                            let end;</span>
<a href="#l16.75"></a><span id="l16.75">                             if (parts[1].charAt(0) == &quot;P&quot;) { // this is a duration</span>
<a href="#l16.76"></a><span id="l16.76">                                 end = begin.clone();</span>
<a href="#l16.77"></a><span id="l16.77" class="difflineminus">-                                end.addDuration(createDuration(parts[1]))</span>
<a href="#l16.78"></a><span id="l16.78" class="difflineplus">+                                end.addDuration(cal.createDuration(parts[1]))</span>
<a href="#l16.79"></a><span id="l16.79">                             } else {</span>
<a href="#l16.80"></a><span id="l16.80">                                 // This is a date string</span>
<a href="#l16.81"></a><span id="l16.81" class="difflineminus">-                                end = createDateTime(parts[1]);</span>
<a href="#l16.82"></a><span id="l16.82" class="difflineplus">+                                end = cal.createDateTime(parts[1]);</span>
<a href="#l16.83"></a><span id="l16.83">                             }</span>
<a href="#l16.84"></a><span id="l16.84">                             interval = new calFreeBusyInterval(aCalId,</span>
<a href="#l16.85"></a><span id="l16.85">                                                                fbType,</span>
<a href="#l16.86"></a><span id="l16.86">                                                                begin,</span>
<a href="#l16.87"></a><span id="l16.87">                                                                end);</span>
<a href="#l16.88"></a><span id="l16.88">                             periodsToReturn.push(interval);</span>
<a href="#l16.89"></a><span id="l16.89">                         }</span>
<a href="#l16.90"></a><span id="l16.90">                     }</span>
<a href="#l16.91"></a><span id="l16.91" class="difflineminus">-                    calIterateIcalComponent(getIcsService().parseICS(caldata, null), iterFunc);</span>
<a href="#l16.92"></a><span id="l16.92">                 } catch (exc) {</span>
<a href="#l16.93"></a><span id="l16.93">                     LOG(&quot;Error parsing free-busy info.&quot;);</span>
<a href="#l16.94"></a><span id="l16.94">                 }</span>
<a href="#l16.95"></a><span id="l16.95"> </span>
<a href="#l16.96"></a><span id="l16.96">                 aListener.onResult(null, periodsToReturn);</span>
<a href="#l16.97"></a><span id="l16.97">             } else {</span>
<a href="#l16.98"></a><span id="l16.98">                 LOG(&quot;CalDAV: Received status &quot; + request.responseStatus + &quot; from freebusy query&quot;);</span>
<a href="#l16.99"></a><span id="l16.99">                 aListener.onResult(null, null);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/calendar/providers/gdata/components/calGoogleUtils.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/calendar/providers/gdata/components/calGoogleUtils.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -31,16 +31,19 @@</span>
<a href="#l17.4"></a><span id="l17.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l17.5"></a><span id="l17.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l17.6"></a><span id="l17.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l17.7"></a><span id="l17.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l17.8"></a><span id="l17.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l17.9"></a><span id="l17.9">  *</span>
<a href="#l17.10"></a><span id="l17.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l17.11"></a><span id="l17.11"> </span>
<a href="#l17.12"></a><span id="l17.12" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calIteratorUtils.jsm&quot;);</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineplus">+</span>
<a href="#l17.15"></a><span id="l17.15"> /**</span>
<a href="#l17.16"></a><span id="l17.16">  * getGoogleSessionManager</span>
<a href="#l17.17"></a><span id="l17.17">  * Shortcut to the google session manager</span>
<a href="#l17.18"></a><span id="l17.18">  */</span>
<a href="#l17.19"></a><span id="l17.19"> function getGoogleSessionManager() {</span>
<a href="#l17.20"></a><span id="l17.20">     if (this.mObject === undefined) {</span>
<a href="#l17.21"></a><span id="l17.21">         this.mObject =</span>
<a href="#l17.22"></a><span id="l17.22">             Components.classes[&quot;@mozilla.org/calendar/providers/gdata/session-manager;1&quot;]</span>
<a href="#l17.23"></a><span id="l17.23" class="difflineat">@@ -190,17 +193,17 @@ var gdataTimezoneService = {</span>
<a href="#l17.24"></a><span id="l17.24">  */</span>
<a href="#l17.25"></a><span id="l17.25"> function fromRFC3339(aStr, aTimezone) {</span>
<a href="#l17.26"></a><span id="l17.26"> </span>
<a href="#l17.27"></a><span id="l17.27">     // XXX I have not covered leapseconds (matches[8]), this might need to</span>
<a href="#l17.28"></a><span id="l17.28">     // be done. The only reference to leap seconds I found is bug 227329.</span>
<a href="#l17.29"></a><span id="l17.29">     //</span>
<a href="#l17.30"></a><span id="l17.30"> </span>
<a href="#l17.31"></a><span id="l17.31">     // Create a DateTime instance (calUtils.js)</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineminus">-    var dateTime = createDateTime();</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineplus">+    let dateTime = cal.createDateTime();</span>
<a href="#l17.34"></a><span id="l17.34"> </span>
<a href="#l17.35"></a><span id="l17.35">     // Killer regex to parse RFC3339 dates</span>
<a href="#l17.36"></a><span id="l17.36">     var re = new RegExp(&quot;^([0-9]{4})-([0-9]{2})-([0-9]{2})&quot; +</span>
<a href="#l17.37"></a><span id="l17.37">         &quot;([Tt]([0-9]{2}):([0-9]{2}):([0-9]{2})(\.[0-9]+)?)?&quot; +</span>
<a href="#l17.38"></a><span id="l17.38">         &quot;(([Zz]|([+-])([0-9]{2}):([0-9]{2})))?&quot;);</span>
<a href="#l17.39"></a><span id="l17.39"> </span>
<a href="#l17.40"></a><span id="l17.40">     var matches = re.exec(aStr);</span>
<a href="#l17.41"></a><span id="l17.41"> </span>
<a href="#l17.42"></a><span id="l17.42" class="difflineat">@@ -532,17 +535,17 @@ function ItemToXMLEntry(aItem, aAuthorEm</span>
<a href="#l17.43"></a><span id="l17.43">     // need to fix bug 353492 first so we can better take care of finding out</span>
<a href="#l17.44"></a><span id="l17.44">     // what alarm is used for snoozing.</span>
<a href="#l17.45"></a><span id="l17.45"> </span>
<a href="#l17.46"></a><span id="l17.46">     // gd:extendedProperty (snooze time)</span>
<a href="#l17.47"></a><span id="l17.47">     var itemSnoozeTime = aItem.getProperty(&quot;X-MOZ-SNOOZE-TIME&quot;);</span>
<a href="#l17.48"></a><span id="l17.48">     var icalSnoozeTime = null;</span>
<a href="#l17.49"></a><span id="l17.49">     if (itemSnoozeTime) {</span>
<a href="#l17.50"></a><span id="l17.50">         // The propery is saved as a string, translate back to calIDateTime.</span>
<a href="#l17.51"></a><span id="l17.51" class="difflineminus">-        icalSnoozeTime = createDateTime();</span>
<a href="#l17.52"></a><span id="l17.52" class="difflineplus">+        icalSnoozeTime = cal.createDateTime();</span>
<a href="#l17.53"></a><span id="l17.53">         icalSnoozeTime.icalString = itemSnoozeTime;</span>
<a href="#l17.54"></a><span id="l17.54">     }</span>
<a href="#l17.55"></a><span id="l17.55">     addExtendedProperty(&quot;X-MOZ-SNOOZE-TIME&quot;, toRFC3339(icalSnoozeTime));</span>
<a href="#l17.56"></a><span id="l17.56"> </span>
<a href="#l17.57"></a><span id="l17.57">     // gd:extendedProperty (snooze recurring alarms)</span>
<a href="#l17.58"></a><span id="l17.58">     var snoozeValue = &quot;&quot;;</span>
<a href="#l17.59"></a><span id="l17.59">     if (aItem.recurrenceInfo) {</span>
<a href="#l17.60"></a><span id="l17.60">         // This is an evil workaround since we don't have a really good system</span>
<a href="#l17.61"></a><span id="l17.61" class="difflineat">@@ -787,17 +790,17 @@ function XMLEntryToItem(aXMLEntry, aTime</span>
<a href="#l17.62"></a><span id="l17.62">         throw new Components.Exception(&quot;&quot;, Components.results.NS_ERROR_FAILURE);</span>
<a href="#l17.63"></a><span id="l17.63">     }</span>
<a href="#l17.64"></a><span id="l17.64"> </span>
<a href="#l17.65"></a><span id="l17.65">     var gCal = new Namespace(&quot;gCal&quot;, &quot;http://schemas.google.com/gCal/2005&quot;);</span>
<a href="#l17.66"></a><span id="l17.66">     var gd = new Namespace(&quot;gd&quot;, &quot;http://schemas.google.com/g/2005&quot;);</span>
<a href="#l17.67"></a><span id="l17.67">     var atom = new Namespace(&quot;&quot;, &quot;http://www.w3.org/2005/Atom&quot;);</span>
<a href="#l17.68"></a><span id="l17.68">     default xml namespace = atom;</span>
<a href="#l17.69"></a><span id="l17.69"> </span>
<a href="#l17.70"></a><span id="l17.70" class="difflineminus">-    var item = (aReferenceItem ? aReferenceItem.clone() : createEvent());</span>
<a href="#l17.71"></a><span id="l17.71" class="difflineplus">+    let item = (aReferenceItem ? aReferenceItem.clone() : cal.createEvent());</span>
<a href="#l17.72"></a><span id="l17.72"> </span>
<a href="#l17.73"></a><span id="l17.73">     try {</span>
<a href="#l17.74"></a><span id="l17.74">         // id</span>
<a href="#l17.75"></a><span id="l17.75">         item.id = getIdFromEntry(aXMLEntry);</span>
<a href="#l17.76"></a><span id="l17.76"> </span>
<a href="#l17.77"></a><span id="l17.77">         // sequence</span>
<a href="#l17.78"></a><span id="l17.78">         item.setProperty(&quot;SEQUENCE&quot;,</span>
<a href="#l17.79"></a><span id="l17.79">                          aXMLEntry.gCal::sequence.@value.toString() || 0);</span>
<a href="#l17.80"></a><span id="l17.80" class="difflineat">@@ -854,18 +857,17 @@ function XMLEntryToItem(aXMLEntry, aTime</span>
<a href="#l17.81"></a><span id="l17.81">             }</span>
<a href="#l17.82"></a><span id="l17.82">             var lastAlarm;</span>
<a href="#l17.83"></a><span id="l17.83">             var otherAlarms = [];</span>
<a href="#l17.84"></a><span id="l17.84">             // Go through all reminder tags given and pick the best alarm.</span>
<a href="#l17.85"></a><span id="l17.85">             for each (var reminder in reminderTags) {</span>
<a href="#l17.86"></a><span id="l17.86">                 // We are only intrested in &quot;alert&quot; reminders. Other types</span>
<a href="#l17.87"></a><span id="l17.87">                 // include sms and email alerts, but thats not the point here.</span>
<a href="#l17.88"></a><span id="l17.88">                 if (reminder.@method == &quot;alert&quot;) {</span>
<a href="#l17.89"></a><span id="l17.89" class="difflineminus">-                    var alarmOffset = Components.classes[&quot;@mozilla.org/calendar/duration;1&quot;]</span>
<a href="#l17.90"></a><span id="l17.90" class="difflineminus">-                                        .createInstance(Components.interfaces.calIDuration);</span>
<a href="#l17.91"></a><span id="l17.91" class="difflineplus">+                    let alarmOffset = cal.createDuration();</span>
<a href="#l17.92"></a><span id="l17.92"> </span>
<a href="#l17.93"></a><span id="l17.93">                     if (reminder.@absoluteTime.toString()) {</span>
<a href="#l17.94"></a><span id="l17.94">                         var absolute = fromRFC3339(reminder.@absoluteTime,</span>
<a href="#l17.95"></a><span id="l17.95">                                                    aTimezone);</span>
<a href="#l17.96"></a><span id="l17.96">                         alarmOffset = startDate.subtractDate(absolute);</span>
<a href="#l17.97"></a><span id="l17.97">                     } else if (reminder.@days.toString()) {</span>
<a href="#l17.98"></a><span id="l17.98">                         alarmOffset.days = -reminder.@days;</span>
<a href="#l17.99"></a><span id="l17.99">                     } else if (reminder.@hours.toString()) {</span>
<a href="#l17.100"></a><span id="l17.100" class="difflineat">@@ -922,17 +924,17 @@ function XMLEntryToItem(aXMLEntry, aTime</span>
<a href="#l17.101"></a><span id="l17.101">                 // We have a zero-duration event</span>
<a href="#l17.102"></a><span id="l17.102">                 item.endDate = item.startDate.clone();</span>
<a href="#l17.103"></a><span id="l17.103">             }</span>
<a href="#l17.104"></a><span id="l17.104"> </span>
<a href="#l17.105"></a><span id="l17.105">             // gd:reminder</span>
<a href="#l17.106"></a><span id="l17.106">             parseReminders(aXMLEntry.gd::when.gd::reminder);</span>
<a href="#l17.107"></a><span id="l17.107">         } else {</span>
<a href="#l17.108"></a><span id="l17.108">             if (!item.recurrenceInfo) {</span>
<a href="#l17.109"></a><span id="l17.109" class="difflineminus">-                item.recurrenceInfo = createRecurrenceInfo(item);</span>
<a href="#l17.110"></a><span id="l17.110" class="difflineplus">+                item.recurrenceInfo = cal.createRecurrenceInfo(item);</span>
<a href="#l17.111"></a><span id="l17.111">             } else {</span>
<a href="#l17.112"></a><span id="l17.112">                 item.recurrenceInfo.clearRecurrenceItems();</span>
<a href="#l17.113"></a><span id="l17.113">             }</span>
<a href="#l17.114"></a><span id="l17.114"> </span>
<a href="#l17.115"></a><span id="l17.115">             // We don't really care about google's timezone info for</span>
<a href="#l17.116"></a><span id="l17.116">             // now. This may change when bug 314339 is fixed. Split out</span>
<a href="#l17.117"></a><span id="l17.117">             // the timezone information so we only have the first bit</span>
<a href="#l17.118"></a><span id="l17.118">             var vevent = recurrenceInfo;</span>
<a href="#l17.119"></a><span id="l17.119" class="difflineat">@@ -942,50 +944,48 @@ function XMLEntryToItem(aXMLEntry, aTime</span>
<a href="#l17.120"></a><span id="l17.120">                 // timezone info is contained. Only remove it if it shows up.</span>
<a href="#l17.121"></a><span id="l17.121">                 vevent = recurrenceInfo.substring(0, splitpos);</span>
<a href="#l17.122"></a><span id="l17.122">             }</span>
<a href="#l17.123"></a><span id="l17.123"> </span>
<a href="#l17.124"></a><span id="l17.124">             vevent = &quot;BEGIN:VEVENT\n&quot; + vevent + &quot;END:VEVENT&quot;;</span>
<a href="#l17.125"></a><span id="l17.125">             var icsService = getIcsService();</span>
<a href="#l17.126"></a><span id="l17.126"> </span>
<a href="#l17.127"></a><span id="l17.127">             var rootComp = icsService.parseICS(vevent, gdataTimezoneService);</span>
<a href="#l17.128"></a><span id="l17.128" class="difflineminus">-            var prop = rootComp.getFirstProperty(&quot;ANY&quot;);</span>
<a href="#l17.129"></a><span id="l17.129">             var i = 0;</span>
<a href="#l17.130"></a><span id="l17.130">             var hasRecurringRules = false;</span>
<a href="#l17.131"></a><span id="l17.131" class="difflineminus">-            while (prop) {</span>
<a href="#l17.132"></a><span id="l17.132" class="difflineplus">+            for (let prop in cal.ical.propertyIterator(rootComp)) {</span>
<a href="#l17.133"></a><span id="l17.133">                switch (prop.propertyName) {</span>
<a href="#l17.134"></a><span id="l17.134">                     case &quot;EXDATE&quot;:</span>
<a href="#l17.135"></a><span id="l17.135">                         var recItem = Components.classes[&quot;@mozilla.org/calendar/recurrence-date;1&quot;]</span>
<a href="#l17.136"></a><span id="l17.136">                                       .createInstance(Components.interfaces.calIRecurrenceDate);</span>
<a href="#l17.137"></a><span id="l17.137">                         try {</span>
<a href="#l17.138"></a><span id="l17.138">                             recItem.icalProperty = prop;</span>
<a href="#l17.139"></a><span id="l17.139">                             item.recurrenceInfo.appendRecurrenceItem(recItem);</span>
<a href="#l17.140"></a><span id="l17.140">                             hasRecurringRules = true;</span>
<a href="#l17.141"></a><span id="l17.141">                         } catch (e) {</span>
<a href="#l17.142"></a><span id="l17.142">                             Components.utils.reportError(e);</span>
<a href="#l17.143"></a><span id="l17.143">                         }</span>
<a href="#l17.144"></a><span id="l17.144">                         break;</span>
<a href="#l17.145"></a><span id="l17.145">                     case &quot;RRULE&quot;:</span>
<a href="#l17.146"></a><span id="l17.146" class="difflineminus">-                        var recRule = createRecurrenceRule();</span>
<a href="#l17.147"></a><span id="l17.147" class="difflineplus">+                        let recRule = cal.createRecurrenceRule();</span>
<a href="#l17.148"></a><span id="l17.148">                         try {</span>
<a href="#l17.149"></a><span id="l17.149">                             recRule.icalProperty = prop;</span>
<a href="#l17.150"></a><span id="l17.150">                             item.recurrenceInfo.appendRecurrenceItem(recRule);</span>
<a href="#l17.151"></a><span id="l17.151">                             hasRecurringRules = true;</span>
<a href="#l17.152"></a><span id="l17.152">                         } catch (e) {</span>
<a href="#l17.153"></a><span id="l17.153">                             Components.utils.reportError(e);</span>
<a href="#l17.154"></a><span id="l17.154">                         }</span>
<a href="#l17.155"></a><span id="l17.155">                         break;</span>
<a href="#l17.156"></a><span id="l17.156">                     case &quot;DTSTART&quot;:</span>
<a href="#l17.157"></a><span id="l17.157">                         item.startDate = prop.valueAsDatetime;</span>
<a href="#l17.158"></a><span id="l17.158">                         break;</span>
<a href="#l17.159"></a><span id="l17.159">                     case &quot;DTEND&quot;:</span>
<a href="#l17.160"></a><span id="l17.160">                         item.endDate = prop.valueAsDatetime;</span>
<a href="#l17.161"></a><span id="l17.161">                         break;</span>
<a href="#l17.162"></a><span id="l17.162">                 }</span>
<a href="#l17.163"></a><span id="l17.163" class="difflineminus">-                prop = rootComp.getNextProperty(&quot;ANY&quot;);</span>
<a href="#l17.164"></a><span id="l17.164">             }</span>
<a href="#l17.165"></a><span id="l17.165"> </span>
<a href="#l17.166"></a><span id="l17.166">             if (!hasRecurringRules) {</span>
<a href="#l17.167"></a><span id="l17.167">                 // Sometimes Google gives us events that have &lt;gd:recurrence&gt;</span>
<a href="#l17.168"></a><span id="l17.168">                 // but contain no recurrence rules. Treat the event as a normal</span>
<a href="#l17.169"></a><span id="l17.169">                 // event. See gdata issue 353.</span>
<a href="#l17.170"></a><span id="l17.170">                 item.recurrenceInfo = null;</span>
<a href="#l17.171"></a><span id="l17.171">             }</span>
<a href="#l17.172"></a><span id="l17.172" class="difflineat">@@ -1066,17 +1066,17 @@ function XMLEntryToItem(aXMLEntry, aTime</span>
<a href="#l17.173"></a><span id="l17.173">                 &quot;event.tentative&quot;: &quot;TENTATIVE&quot;</span>
<a href="#l17.174"></a><span id="l17.174">             };</span>
<a href="#l17.175"></a><span id="l17.175"> </span>
<a href="#l17.176"></a><span id="l17.176">             // Clear all attendees in case a reference item was passed</span>
<a href="#l17.177"></a><span id="l17.177">             item.removeAllAttendees();</span>
<a href="#l17.178"></a><span id="l17.178"> </span>
<a href="#l17.179"></a><span id="l17.179">             // Iterate all attendee tags.</span>
<a href="#l17.180"></a><span id="l17.180">             for each (var who in aXMLEntry.gd::who) {</span>
<a href="#l17.181"></a><span id="l17.181" class="difflineminus">-                var attendee = createAttendee();</span>
<a href="#l17.182"></a><span id="l17.182" class="difflineplus">+                let attendee = cal.createAttendee();</span>
<a href="#l17.183"></a><span id="l17.183"> </span>
<a href="#l17.184"></a><span id="l17.184">                 var rel = who.@rel.toString().substring(33);</span>
<a href="#l17.185"></a><span id="l17.185">                 var type = who.gd::attendeeType.@value.toString().substring(33);</span>
<a href="#l17.186"></a><span id="l17.186">                 var status = who.gd::attendeeStatus.@value.toString().substring(33);</span>
<a href="#l17.187"></a><span id="l17.187"> </span>
<a href="#l17.188"></a><span id="l17.188">                 attendee.id = &quot;mailto:&quot; + who.@email.toString();</span>
<a href="#l17.189"></a><span id="l17.189">                 attendee.commonName = who.@valueString.toString();</span>
<a href="#l17.190"></a><span id="l17.190">                 attendee.rsvp = &quot;FALSE&quot;;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/calendar/providers/wcap/calWcapCalendarItems.js</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/calendar/providers/wcap/calWcapCalendarItems.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -867,120 +867,121 @@ calWcapCalendar.prototype.patchTimezone </span>
<a href="#l18.4"></a><span id="l18.4">             subComp[attr] = dt;</span>
<a href="#l18.5"></a><span id="l18.5">         }</span>
<a href="#l18.6"></a><span id="l18.6">     }</span>
<a href="#l18.7"></a><span id="l18.7">     return dt;</span>
<a href="#l18.8"></a><span id="l18.8"> }</span>
<a href="#l18.9"></a><span id="l18.9"> </span>
<a href="#l18.10"></a><span id="l18.10"> calWcapCalendar.prototype.parseItems = function calWcapCalendar_parseItems(</span>
<a href="#l18.11"></a><span id="l18.11">     icalRootComp, itemFilter, maxResults, rangeStart, rangeEnd, bLeaveMutable) {</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-    var items = [];</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineminus">-    var unexpandedItems = [];</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineminus">-    var uid2parent = {};</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineminus">-    var excItems = [];</span>
<a href="#l18.16"></a><span id="l18.16" class="difflineplus">+    let items = [];</span>
<a href="#l18.17"></a><span id="l18.17" class="difflineplus">+    let unexpandedItems = [];</span>
<a href="#l18.18"></a><span id="l18.18" class="difflineplus">+    let uid2parent = {};</span>
<a href="#l18.19"></a><span id="l18.19" class="difflineplus">+    let excItems = [];</span>
<a href="#l18.20"></a><span id="l18.20"> </span>
<a href="#l18.21"></a><span id="l18.21" class="difflineminus">-    var componentType = &quot;ANY&quot;;</span>
<a href="#l18.22"></a><span id="l18.22" class="difflineplus">+    let componentType = &quot;ANY&quot;;</span>
<a href="#l18.23"></a><span id="l18.23">     switch (itemFilter &amp; calICalendar.ITEM_FILTER_TYPE_ALL) {</span>
<a href="#l18.24"></a><span id="l18.24">         case calICalendar.ITEM_FILTER_TYPE_TODO:</span>
<a href="#l18.25"></a><span id="l18.25">             componentType = &quot;VTODO&quot;;</span>
<a href="#l18.26"></a><span id="l18.26">             break;</span>
<a href="#l18.27"></a><span id="l18.27">         case calICalendar.ITEM_FILTER_TYPE_EVENT:</span>
<a href="#l18.28"></a><span id="l18.28">             componentType = &quot;VEVENT&quot;;</span>
<a href="#l18.29"></a><span id="l18.29">             break;</span>
<a href="#l18.30"></a><span id="l18.30">     }</span>
<a href="#l18.31"></a><span id="l18.31"> </span>
<a href="#l18.32"></a><span id="l18.32">     var recurrenceBound = this.session.recurrenceBound;</span>
<a href="#l18.33"></a><span id="l18.33"> </span>
<a href="#l18.34"></a><span id="l18.34" class="difflineminus">-    var this_ = this;</span>
<a href="#l18.35"></a><span id="l18.35" class="difflineminus">-    forEachIcalComponent(</span>
<a href="#l18.36"></a><span id="l18.36" class="difflineminus">-        icalRootComp, componentType,</span>
<a href="#l18.37"></a><span id="l18.37" class="difflineminus">-        function(subComp) {</span>
<a href="#l18.38"></a><span id="l18.38" class="difflineminus">-            var organizer = subComp.getFirstProperty(&quot;ORGANIZER&quot;);</span>
<a href="#l18.39"></a><span id="l18.39" class="difflineminus">-            if (organizer &amp;&amp; organizer.getParameter(&quot;SENT-BY&quot;)) { // has SENT-BY</span>
<a href="#l18.40"></a><span id="l18.40" class="difflineminus">-                // &amp;emailorcalid=1 sets wrong email, workaround setting calid...</span>
<a href="#l18.41"></a><span id="l18.41" class="difflineminus">-                var id = organizer.getParameter(&quot;X-S1CS-CALID&quot;);</span>
<a href="#l18.42"></a><span id="l18.42" class="difflineminus">-                if (id) {</span>
<a href="#l18.43"></a><span id="l18.43" class="difflineminus">-                    organizer.value = id;</span>
<a href="#l18.44"></a><span id="l18.44" class="difflineplus">+    let count = 0;</span>
<a href="#l18.45"></a><span id="l18.45" class="difflineplus">+    for (let subComp in cal.ical.calendarComponentIterator(icalRootComp, componentType)) {</span>
<a href="#l18.46"></a><span id="l18.46" class="difflineplus">+        if (++count &gt; maxResults) {</span>
<a href="#l18.47"></a><span id="l18.47" class="difflineplus">+            break;</span>
<a href="#l18.48"></a><span id="l18.48" class="difflineplus">+        }</span>
<a href="#l18.49"></a><span id="l18.49" class="difflineplus">+</span>
<a href="#l18.50"></a><span id="l18.50" class="difflineplus">+        let organizer = subComp.getFirstProperty(&quot;ORGANIZER&quot;);</span>
<a href="#l18.51"></a><span id="l18.51" class="difflineplus">+        if (organizer &amp;&amp; organizer.getParameter(&quot;SENT-BY&quot;)) { // has SENT-BY</span>
<a href="#l18.52"></a><span id="l18.52" class="difflineplus">+            // &amp;emailorcalid=1 sets wrong email, workaround setting calid...</span>
<a href="#l18.53"></a><span id="l18.53" class="difflineplus">+            let id = organizer.getParameter(&quot;X-S1CS-CALID&quot;);</span>
<a href="#l18.54"></a><span id="l18.54" class="difflineplus">+            if (id) {</span>
<a href="#l18.55"></a><span id="l18.55" class="difflineplus">+                organizer.value = id;</span>
<a href="#l18.56"></a><span id="l18.56" class="difflineplus">+            }</span>
<a href="#l18.57"></a><span id="l18.57" class="difflineplus">+        }</span>
<a href="#l18.58"></a><span id="l18.58" class="difflineplus">+</span>
<a href="#l18.59"></a><span id="l18.59" class="difflineplus">+        let dtstart = this.patchTimezone(subComp, &quot;startTime&quot;, &quot;X-NSCP-DTSTART-TZID&quot;);</span>
<a href="#l18.60"></a><span id="l18.60" class="difflineplus">+</span>
<a href="#l18.61"></a><span id="l18.61" class="difflineplus">+        let item = null;</span>
<a href="#l18.62"></a><span id="l18.62" class="difflineplus">+        switch (subComp.componentType) {</span>
<a href="#l18.63"></a><span id="l18.63" class="difflineplus">+            case &quot;VEVENT&quot;: {</span>
<a href="#l18.64"></a><span id="l18.64" class="difflineplus">+                this.patchTimezone(subComp, &quot;endTime&quot;, dtstart ? dtstart.timezone : &quot;X-NSCP-DTEND-TZID&quot;);</span>
<a href="#l18.65"></a><span id="l18.65" class="difflineplus">+                item = createEvent();</span>
<a href="#l18.66"></a><span id="l18.66" class="difflineplus">+                item.icalComponent = subComp;</span>
<a href="#l18.67"></a><span id="l18.67" class="difflineplus">+                break;</span>
<a href="#l18.68"></a><span id="l18.68" class="difflineplus">+            }</span>
<a href="#l18.69"></a><span id="l18.69" class="difflineplus">+            case &quot;VTODO&quot;: {</span>
<a href="#l18.70"></a><span id="l18.70" class="difflineplus">+                this.patchTimezone(subComp, &quot;dueTime&quot;, dtstart ? dtstart.timezone : &quot;X-NSCP-DUE-TZID&quot;);</span>
<a href="#l18.71"></a><span id="l18.71" class="difflineplus">+                item = createTodo();</span>
<a href="#l18.72"></a><span id="l18.72" class="difflineplus">+                item.icalComponent = subComp;</span>
<a href="#l18.73"></a><span id="l18.73" class="difflineplus">+                switch (itemFilter &amp; calICalendar.ITEM_FILTER_COMPLETED_ALL) {</span>
<a href="#l18.74"></a><span id="l18.74" class="difflineplus">+                    case calICalendar.ITEM_FILTER_COMPLETED_YES:</span>
<a href="#l18.75"></a><span id="l18.75" class="difflineplus">+                        if (!item.isCompleted) {</span>
<a href="#l18.76"></a><span id="l18.76" class="difflineplus">+                            delete item;</span>
<a href="#l18.77"></a><span id="l18.77" class="difflineplus">+                            item = null;</span>
<a href="#l18.78"></a><span id="l18.78" class="difflineplus">+                        }</span>
<a href="#l18.79"></a><span id="l18.79" class="difflineplus">+                        break;</span>
<a href="#l18.80"></a><span id="l18.80" class="difflineplus">+                    case calICalendar.ITEM_FILTER_COMPLETED_NO:</span>
<a href="#l18.81"></a><span id="l18.81" class="difflineplus">+                        if (item.isCompleted) {</span>
<a href="#l18.82"></a><span id="l18.82" class="difflineplus">+                            delete item;</span>
<a href="#l18.83"></a><span id="l18.83" class="difflineplus">+                            item = null;</span>
<a href="#l18.84"></a><span id="l18.84" class="difflineplus">+                        }</span>
<a href="#l18.85"></a><span id="l18.85" class="difflineplus">+                        break;</span>
<a href="#l18.86"></a><span id="l18.86" class="difflineplus">+                }</span>
<a href="#l18.87"></a><span id="l18.87" class="difflineplus">+                break;</span>
<a href="#l18.88"></a><span id="l18.88" class="difflineplus">+            }</span>
<a href="#l18.89"></a><span id="l18.89" class="difflineplus">+        }</span>
<a href="#l18.90"></a><span id="l18.90" class="difflineplus">+        if (item) {</span>
<a href="#l18.91"></a><span id="l18.91" class="difflineplus">+            if (!item.title) {</span>
<a href="#l18.92"></a><span id="l18.92" class="difflineplus">+                // assumed to look at a subscribed calendar,</span>
<a href="#l18.93"></a><span id="l18.93" class="difflineplus">+                // so patch title for private items:</span>
<a href="#l18.94"></a><span id="l18.94" class="difflineplus">+                switch (item.privacy) {</span>
<a href="#l18.95"></a><span id="l18.95" class="difflineplus">+                    case &quot;PRIVATE&quot;:</span>
<a href="#l18.96"></a><span id="l18.96" class="difflineplus">+                        item.title = g_privateItemTitle;</span>
<a href="#l18.97"></a><span id="l18.97" class="difflineplus">+                        break;</span>
<a href="#l18.98"></a><span id="l18.98" class="difflineplus">+                    case &quot;CONFIDENTIAL&quot;:</span>
<a href="#l18.99"></a><span id="l18.99" class="difflineplus">+                        item.title = g_confidentialItemTitle;</span>
<a href="#l18.100"></a><span id="l18.100" class="difflineplus">+                        break;</span>
<a href="#l18.101"></a><span id="l18.101">                 }</span>
<a href="#l18.102"></a><span id="l18.102">             }</span>
<a href="#l18.103"></a><span id="l18.103"> </span>
<a href="#l18.104"></a><span id="l18.104" class="difflineminus">-            var dtstart = this_.patchTimezone(subComp, &quot;startTime&quot;, &quot;X-NSCP-DTSTART-TZID&quot;);</span>
<a href="#l18.105"></a><span id="l18.105" class="difflineminus">-</span>
<a href="#l18.106"></a><span id="l18.106" class="difflineminus">-            var item = null;</span>
<a href="#l18.107"></a><span id="l18.107" class="difflineminus">-            switch (subComp.componentType) {</span>
<a href="#l18.108"></a><span id="l18.108" class="difflineminus">-                case &quot;VEVENT&quot;: {</span>
<a href="#l18.109"></a><span id="l18.109" class="difflineminus">-                    this_.patchTimezone(subComp, &quot;endTime&quot;, dtstart ? dtstart.timezone : &quot;X-NSCP-DTEND-TZID&quot;);</span>
<a href="#l18.110"></a><span id="l18.110" class="difflineminus">-                    item = createEvent();</span>
<a href="#l18.111"></a><span id="l18.111" class="difflineminus">-                    item.icalComponent = subComp;</span>
<a href="#l18.112"></a><span id="l18.112" class="difflineminus">-                    break;</span>
<a href="#l18.113"></a><span id="l18.113" class="difflineplus">+            item.calendar = this.superCalendar;</span>
<a href="#l18.114"></a><span id="l18.114" class="difflineplus">+            var rid = item.recurrenceId;</span>
<a href="#l18.115"></a><span id="l18.115" class="difflineplus">+            if (rid) {</span>
<a href="#l18.116"></a><span id="l18.116" class="difflineplus">+                rid = rid.getInTimezone(dtstart.timezone);</span>
<a href="#l18.117"></a><span id="l18.117" class="difflineplus">+                item.recurrenceId = rid;</span>
<a href="#l18.118"></a><span id="l18.118" class="difflineplus">+                item.recurrenceInfo = null;</span>
<a href="#l18.119"></a><span id="l18.119" class="difflineplus">+                if (LOG_LEVEL &gt; 1) {</span>
<a href="#l18.120"></a><span id="l18.120" class="difflineplus">+                    log(&quot;exception item: &quot; + item.title +</span>
<a href="#l18.121"></a><span id="l18.121" class="difflineplus">+                        &quot;\nrid=&quot; + getIcalUTC(rid) +</span>
<a href="#l18.122"></a><span id="l18.122" class="difflineplus">+                        &quot;\nitem.id=&quot; + item.id, this);</span>
<a href="#l18.123"></a><span id="l18.123">                 }</span>
<a href="#l18.124"></a><span id="l18.124" class="difflineminus">-                case &quot;VTODO&quot;: {</span>
<a href="#l18.125"></a><span id="l18.125" class="difflineminus">-                    this_.patchTimezone(subComp, &quot;dueTime&quot;, dtstart ? dtstart.timezone : &quot;X-NSCP-DUE-TZID&quot;);</span>
<a href="#l18.126"></a><span id="l18.126" class="difflineminus">-                    item = createTodo();</span>
<a href="#l18.127"></a><span id="l18.127" class="difflineminus">-                    item.icalComponent = subComp;</span>
<a href="#l18.128"></a><span id="l18.128" class="difflineminus">-                    switch (itemFilter &amp; calICalendar.ITEM_FILTER_COMPLETED_ALL) {</span>
<a href="#l18.129"></a><span id="l18.129" class="difflineminus">-                        case calICalendar.ITEM_FILTER_COMPLETED_YES:</span>
<a href="#l18.130"></a><span id="l18.130" class="difflineminus">-                            if (!item.isCompleted) {</span>
<a href="#l18.131"></a><span id="l18.131" class="difflineminus">-                                delete item;</span>
<a href="#l18.132"></a><span id="l18.132" class="difflineminus">-                                item = null;</span>
<a href="#l18.133"></a><span id="l18.133" class="difflineminus">-                            }</span>
<a href="#l18.134"></a><span id="l18.134" class="difflineminus">-                            break;</span>
<a href="#l18.135"></a><span id="l18.135" class="difflineminus">-                        case calICalendar.ITEM_FILTER_COMPLETED_NO:</span>
<a href="#l18.136"></a><span id="l18.136" class="difflineminus">-                            if (item.isCompleted) {</span>
<a href="#l18.137"></a><span id="l18.137" class="difflineminus">-                                delete item;</span>
<a href="#l18.138"></a><span id="l18.138" class="difflineminus">-                                item = null;</span>
<a href="#l18.139"></a><span id="l18.139" class="difflineminus">-                            }</span>
<a href="#l18.140"></a><span id="l18.140" class="difflineminus">-                            break;</span>
<a href="#l18.141"></a><span id="l18.141" class="difflineminus">-                    }</span>
<a href="#l18.142"></a><span id="l18.142" class="difflineminus">-                    break;</span>
<a href="#l18.143"></a><span id="l18.143" class="difflineplus">+                excItems.push(item);</span>
<a href="#l18.144"></a><span id="l18.144" class="difflineplus">+</span>
<a href="#l18.145"></a><span id="l18.145" class="difflineplus">+            } else if (item.recurrenceInfo) {</span>
<a href="#l18.146"></a><span id="l18.146" class="difflineplus">+                unexpandedItems.push(item);</span>
<a href="#l18.147"></a><span id="l18.147" class="difflineplus">+                uid2parent[item.id] = item;</span>
<a href="#l18.148"></a><span id="l18.148" class="difflineplus">+            } else if ((maxResults == 0 || items.length &lt; maxResults) &amp;&amp;</span>
<a href="#l18.149"></a><span id="l18.149" class="difflineplus">+                       checkIfInRange(item, rangeStart, rangeEnd)) {</span>
<a href="#l18.150"></a><span id="l18.150" class="difflineplus">+                if (LOG_LEVEL &gt; 2) {</span>
<a href="#l18.151"></a><span id="l18.151" class="difflineplus">+                    log(&quot;item: &quot; + item.title + &quot;\n&quot; + item.icalString, this);</span>
<a href="#l18.152"></a><span id="l18.152">                 }</span>
<a href="#l18.153"></a><span id="l18.153" class="difflineplus">+                if (!bLeaveMutable) {</span>
<a href="#l18.154"></a><span id="l18.154" class="difflineplus">+                    item.makeImmutable();</span>
<a href="#l18.155"></a><span id="l18.155" class="difflineplus">+                }</span>
<a href="#l18.156"></a><span id="l18.156" class="difflineplus">+                items.push(item);</span>
<a href="#l18.157"></a><span id="l18.157">             }</span>
<a href="#l18.158"></a><span id="l18.158" class="difflineminus">-            if (item) {</span>
<a href="#l18.159"></a><span id="l18.159" class="difflineminus">-                if (!item.title) {</span>
<a href="#l18.160"></a><span id="l18.160" class="difflineminus">-                    // assumed to look at a subscribed calendar,</span>
<a href="#l18.161"></a><span id="l18.161" class="difflineminus">-                    // so patch title for private items:</span>
<a href="#l18.162"></a><span id="l18.162" class="difflineminus">-                    switch (item.privacy) {</span>
<a href="#l18.163"></a><span id="l18.163" class="difflineminus">-                        case &quot;PRIVATE&quot;:</span>
<a href="#l18.164"></a><span id="l18.164" class="difflineminus">-                            item.title = g_privateItemTitle;</span>
<a href="#l18.165"></a><span id="l18.165" class="difflineminus">-                            break;</span>
<a href="#l18.166"></a><span id="l18.166" class="difflineminus">-                        case &quot;CONFIDENTIAL&quot;:</span>
<a href="#l18.167"></a><span id="l18.167" class="difflineminus">-                            item.title = g_confidentialItemTitle;</span>
<a href="#l18.168"></a><span id="l18.168" class="difflineminus">-                            break;</span>
<a href="#l18.169"></a><span id="l18.169" class="difflineminus">-                    }</span>
<a href="#l18.170"></a><span id="l18.170" class="difflineminus">-                }</span>
<a href="#l18.171"></a><span id="l18.171" class="difflineminus">-</span>
<a href="#l18.172"></a><span id="l18.172" class="difflineminus">-                item.calendar = this_.superCalendar;</span>
<a href="#l18.173"></a><span id="l18.173" class="difflineminus">-                var rid = item.recurrenceId;</span>
<a href="#l18.174"></a><span id="l18.174" class="difflineminus">-                if (rid) {</span>
<a href="#l18.175"></a><span id="l18.175" class="difflineminus">-                    rid = rid.getInTimezone(dtstart.timezone);</span>
<a href="#l18.176"></a><span id="l18.176" class="difflineminus">-                    item.recurrenceId = rid;</span>
<a href="#l18.177"></a><span id="l18.177" class="difflineminus">-                    item.recurrenceInfo = null;</span>
<a href="#l18.178"></a><span id="l18.178" class="difflineminus">-                    if (LOG_LEVEL &gt; 1) {</span>
<a href="#l18.179"></a><span id="l18.179" class="difflineminus">-                        log(&quot;exception item: &quot; + item.title +</span>
<a href="#l18.180"></a><span id="l18.180" class="difflineminus">-                            &quot;\nrid=&quot; + getIcalUTC(rid) +</span>
<a href="#l18.181"></a><span id="l18.181" class="difflineminus">-                            &quot;\nitem.id=&quot; + item.id, this_);</span>
<a href="#l18.182"></a><span id="l18.182" class="difflineminus">-                    }</span>
<a href="#l18.183"></a><span id="l18.183" class="difflineminus">-                    excItems.push(item);</span>
<a href="#l18.184"></a><span id="l18.184" class="difflineminus">-</span>
<a href="#l18.185"></a><span id="l18.185" class="difflineminus">-                } else if (item.recurrenceInfo) {</span>
<a href="#l18.186"></a><span id="l18.186" class="difflineminus">-                    unexpandedItems.push(item);</span>
<a href="#l18.187"></a><span id="l18.187" class="difflineminus">-                    uid2parent[item.id] = item;</span>
<a href="#l18.188"></a><span id="l18.188" class="difflineminus">-                } else if ((maxResults == 0 || items.length &lt; maxResults) &amp;&amp;</span>
<a href="#l18.189"></a><span id="l18.189" class="difflineminus">-                           checkIfInRange(item, rangeStart, rangeEnd)) {</span>
<a href="#l18.190"></a><span id="l18.190" class="difflineminus">-                    if (LOG_LEVEL &gt; 2) {</span>
<a href="#l18.191"></a><span id="l18.191" class="difflineminus">-                        log(&quot;item: &quot; + item.title + &quot;\n&quot; + item.icalString, this_);</span>
<a href="#l18.192"></a><span id="l18.192" class="difflineminus">-                    }</span>
<a href="#l18.193"></a><span id="l18.193" class="difflineminus">-                    if (!bLeaveMutable) {</span>
<a href="#l18.194"></a><span id="l18.194" class="difflineminus">-                        item.makeImmutable();</span>
<a href="#l18.195"></a><span id="l18.195" class="difflineminus">-                    }</span>
<a href="#l18.196"></a><span id="l18.196" class="difflineminus">-                    items.push(item);</span>
<a href="#l18.197"></a><span id="l18.197" class="difflineminus">-                }</span>
<a href="#l18.198"></a><span id="l18.198" class="difflineminus">-            }</span>
<a href="#l18.199"></a><span id="l18.199" class="difflineminus">-        },</span>
<a href="#l18.200"></a><span id="l18.200" class="difflineminus">-        maxResults);</span>
<a href="#l18.201"></a><span id="l18.201" class="difflineplus">+        }</span>
<a href="#l18.202"></a><span id="l18.202" class="difflineplus">+    }</span>
<a href="#l18.203"></a><span id="l18.203"> </span>
<a href="#l18.204"></a><span id="l18.204">     // tag &quot;exceptions&quot;, i.e. items with rid:</span>
<a href="#l18.205"></a><span id="l18.205">     for each (var item in excItems) {</span>
<a href="#l18.206"></a><span id="l18.206">         var parent = uid2parent[item.id];</span>
<a href="#l18.207"></a><span id="l18.207">         if (parent) {</span>
<a href="#l18.208"></a><span id="l18.208">             var recStartDate = parent.recurrenceStartDate;</span>
<a href="#l18.209"></a><span id="l18.209">             if (recStartDate &amp;&amp; recStartDate.isDate &amp;&amp; !item.recurrenceId.isDate) {</span>
<a href="#l18.210"></a><span id="l18.210">                 // cs ought to return proper all-day RECURRENCE-ID!</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/calendar/providers/wcap/calWcapSession.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/calendar/providers/wcap/calWcapSession.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -31,16 +31,18 @@</span>
<a href="#l19.4"></a><span id="l19.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l19.5"></a><span id="l19.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l19.6"></a><span id="l19.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l19.7"></a><span id="l19.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l19.8"></a><span id="l19.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l19.9"></a><span id="l19.9">  *</span>
<a href="#l19.10"></a><span id="l19.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l19.11"></a><span id="l19.11"> </span>
<a href="#l19.12"></a><span id="l19.12" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calIteratorUtils.jsm&quot;);</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+</span>
<a href="#l19.14"></a><span id="l19.14"> function calWcapTimezone(tzProvider, tzid_, component_) {</span>
<a href="#l19.15"></a><span id="l19.15">     this.wrappedJSObject = this;</span>
<a href="#l19.16"></a><span id="l19.16">     this.provider = tzProvider;</span>
<a href="#l19.17"></a><span id="l19.17">     this.icalComponent = component_;</span>
<a href="#l19.18"></a><span id="l19.18">     this.tzid = tzid_;</span>
<a href="#l19.19"></a><span id="l19.19">     this.isUTC = false;</span>
<a href="#l19.20"></a><span id="l19.20">     this.isFloating = false;</span>
<a href="#l19.21"></a><span id="l19.21">     this.latitude = null;</span>
<a href="#l19.22"></a><span id="l19.22" class="difflineat">@@ -678,26 +680,24 @@ calWcapSession.prototype = {</span>
<a href="#l19.23"></a><span id="l19.23">         this.m_serverTimezones = {};</span>
<a href="#l19.24"></a><span id="l19.24">         var this_ = this;</span>
<a href="#l19.25"></a><span id="l19.25">         this_.issueNetworkRequest_(</span>
<a href="#l19.26"></a><span id="l19.26">             request,</span>
<a href="#l19.27"></a><span id="l19.27">             function netResp(err, data) {</span>
<a href="#l19.28"></a><span id="l19.28">                 if (err) {</span>
<a href="#l19.29"></a><span id="l19.29">                     throw err;</span>
<a href="#l19.30"></a><span id="l19.30">                 }</span>
<a href="#l19.31"></a><span id="l19.31" class="difflineminus">-                forEachIcalComponent(</span>
<a href="#l19.32"></a><span id="l19.32" class="difflineminus">-                    data, &quot;VTIMEZONE&quot;,</span>
<a href="#l19.33"></a><span id="l19.33" class="difflineminus">-                    function eachComp(subComp) {</span>
<a href="#l19.34"></a><span id="l19.34" class="difflineminus">-                        try {</span>
<a href="#l19.35"></a><span id="l19.35" class="difflineminus">-                            var tzid = subComp.getFirstProperty(&quot;TZID&quot;).value;</span>
<a href="#l19.36"></a><span id="l19.36" class="difflineminus">-                            this_.m_serverTimezones[tzid] = new calWcapTimezone(this_, tzid, subComp);</span>
<a href="#l19.37"></a><span id="l19.37" class="difflineminus">-                        } catch (exc) { // ignore but errors:</span>
<a href="#l19.38"></a><span id="l19.38" class="difflineminus">-                            logError(exc, this_);</span>
<a href="#l19.39"></a><span id="l19.39" class="difflineminus">-                        }</span>
<a href="#l19.40"></a><span id="l19.40" class="difflineminus">-                    });</span>
<a href="#l19.41"></a><span id="l19.41" class="difflineplus">+                for (let subComp in cal.ical.calendarComponentIterator(data, &quot;VTIMEZONE&quot;)) {</span>
<a href="#l19.42"></a><span id="l19.42" class="difflineplus">+                    try {</span>
<a href="#l19.43"></a><span id="l19.43" class="difflineplus">+                        let tzid = subComp.getFirstProperty(&quot;TZID&quot;).value;</span>
<a href="#l19.44"></a><span id="l19.44" class="difflineplus">+                        this_.m_serverTimezones[tzid] = new calWcapTimezone(this_, tzid, subComp);</span>
<a href="#l19.45"></a><span id="l19.45" class="difflineplus">+                    } catch (exc) { // ignore but errors:</span>
<a href="#l19.46"></a><span id="l19.46" class="difflineplus">+                        logError(exc, this_);</span>
<a href="#l19.47"></a><span id="l19.47" class="difflineplus">+                    }</span>
<a href="#l19.48"></a><span id="l19.48" class="difflineplus">+                }</span>
<a href="#l19.49"></a><span id="l19.49">                 log(&quot;installed timezones.&quot;, this_);</span>
<a href="#l19.50"></a><span id="l19.50">             },</span>
<a href="#l19.51"></a><span id="l19.51">             stringToIcal, &quot;get_all_timezones&quot;, &quot;&amp;fmt-out=text%2Fcalendar&quot;,</span>
<a href="#l19.52"></a><span id="l19.52">             sessionId);</span>
<a href="#l19.53"></a><span id="l19.53">     },</span>
<a href="#l19.54"></a><span id="l19.54"> </span>
<a href="#l19.55"></a><span id="l19.55">     getCommandUrl: function calWcapSession_getCommandUrl(wcapCommand, params, sessionId) {</span>
<a href="#l19.56"></a><span id="l19.56">         var url = this.sessionUri.spec;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/calendar/providers/wcap/calWcapUtils.js</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/calendar/providers/wcap/calWcapUtils.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -31,16 +31,18 @@</span>
<a href="#l20.4"></a><span id="l20.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l20.5"></a><span id="l20.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l20.6"></a><span id="l20.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l20.7"></a><span id="l20.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l20.8"></a><span id="l20.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l20.9"></a><span id="l20.9">  *</span>
<a href="#l20.10"></a><span id="l20.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l20.11"></a><span id="l20.11"> </span>
<a href="#l20.12"></a><span id="l20.12" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calIteratorUtils.jsm&quot;);</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+</span>
<a href="#l20.14"></a><span id="l20.14"> var g_bShutdown = false;</span>
<a href="#l20.15"></a><span id="l20.15"> </span>
<a href="#l20.16"></a><span id="l20.16"> function initLogging() {</span>
<a href="#l20.17"></a><span id="l20.17">     initLogging.mLogTimezone = calendarDefaultTimezone();</span>
<a href="#l20.18"></a><span id="l20.18">     if (initLogging.mLogFilestream) {</span>
<a href="#l20.19"></a><span id="l20.19">         try {</span>
<a href="#l20.20"></a><span id="l20.20">             initLogging.mLogFilestream.close();</span>
<a href="#l20.21"></a><span id="l20.21">         } catch (exc) {</span>
<a href="#l20.22"></a><span id="l20.22" class="difflineat">@@ -197,37 +199,16 @@ function getDomParser() {</span>
<a href="#l20.23"></a><span id="l20.23"> </span>
<a href="#l20.24"></a><span id="l20.24"> function isParent(item) {</span>
<a href="#l20.25"></a><span id="l20.25">     if (item.id != item.parentItem.id) {</span>
<a href="#l20.26"></a><span id="l20.26">         throw new Components.Exception(&quot;proxy has different id than its parent!&quot;);</span>
<a href="#l20.27"></a><span id="l20.27">     }</span>
<a href="#l20.28"></a><span id="l20.28">     return (!item.recurrenceId);</span>
<a href="#l20.29"></a><span id="l20.29"> }</span>
<a href="#l20.30"></a><span id="l20.30"> </span>
<a href="#l20.31"></a><span id="l20.31" class="difflineminus">-function forEachIcalComponent(icalRootComp, componentType, func, maxResults) {</span>
<a href="#l20.32"></a><span id="l20.32" class="difflineminus">-    var itemCount = 0;</span>
<a href="#l20.33"></a><span id="l20.33" class="difflineminus">-    // libical returns the vcalendar component if there is just</span>
<a href="#l20.34"></a><span id="l20.34" class="difflineminus">-    // one vcalendar. If there are multiple vcalendars, it returns</span>
<a href="#l20.35"></a><span id="l20.35" class="difflineminus">-    // an xroot component, with those vcalendar childs. We need to</span>
<a href="#l20.36"></a><span id="l20.36" class="difflineminus">-    // handle both.</span>
<a href="#l20.37"></a><span id="l20.37" class="difflineminus">-    for (var calComp = (icalRootComp.componentType == &quot;VCALENDAR&quot;</span>
<a href="#l20.38"></a><span id="l20.38" class="difflineminus">-                        ? icalRootComp : icalRootComp.getFirstSubcomponent(&quot;VCALENDAR&quot;));</span>
<a href="#l20.39"></a><span id="l20.39" class="difflineminus">-         calComp != null &amp;&amp; (!maxResults || itemCount &lt; maxResults);</span>
<a href="#l20.40"></a><span id="l20.40" class="difflineminus">-         calComp = icalRootComp.getNextSubcomponent(&quot;VCALENDAR&quot;)) {</span>
<a href="#l20.41"></a><span id="l20.41" class="difflineminus">-</span>
<a href="#l20.42"></a><span id="l20.42" class="difflineminus">-        for (var subComp = calComp.getFirstSubcomponent(componentType);</span>
<a href="#l20.43"></a><span id="l20.43" class="difflineminus">-             subComp != null &amp;&amp; (!maxResults || itemCount &lt; maxResults);</span>
<a href="#l20.44"></a><span id="l20.44" class="difflineminus">-             subComp = calComp.getNextSubcomponent(componentType)) {</span>
<a href="#l20.45"></a><span id="l20.45" class="difflineminus">-</span>
<a href="#l20.46"></a><span id="l20.46" class="difflineminus">-            func(subComp);</span>
<a href="#l20.47"></a><span id="l20.47" class="difflineminus">-            ++itemCount;</span>
<a href="#l20.48"></a><span id="l20.48" class="difflineminus">-        }</span>
<a href="#l20.49"></a><span id="l20.49" class="difflineminus">-    }</span>
<a href="#l20.50"></a><span id="l20.50" class="difflineminus">-}</span>
<a href="#l20.51"></a><span id="l20.51" class="difflineminus">-</span>
<a href="#l20.52"></a><span id="l20.52"> function filterXmlNodes(name, rootNode) {</span>
<a href="#l20.53"></a><span id="l20.53">     var ret = [];</span>
<a href="#l20.54"></a><span id="l20.54">     if (rootNode) {</span>
<a href="#l20.55"></a><span id="l20.55">         var nodeList = rootNode.getElementsByTagName(name);</span>
<a href="#l20.56"></a><span id="l20.56">         for (var i = 0; i &lt; nodeList.length; ++i) {</span>
<a href="#l20.57"></a><span id="l20.57">             var node = nodeList.item(i);</span>
<a href="#l20.58"></a><span id="l20.58">             ret.push(trimString(node.textContent));</span>
<a href="#l20.59"></a><span id="l20.59">         }</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

