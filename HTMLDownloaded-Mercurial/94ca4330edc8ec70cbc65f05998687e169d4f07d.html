<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 877:94ca4330edc8ec70cbc65f05998687e169d4f07d</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 94ca4330edc8ec70cbc65f05998687e169d4f07d" />
<meta property="og:url" content="/comm-central/rev/94ca4330edc8ec70cbc65f05998687e169d4f07d" />
<meta property="og:description" content="status commit, end of yesterday." />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 94ca4330edc8ec70cbc65f05998687e169d4f07d 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/94ca4330edc8ec70cbc65f05998687e169d4f07d">shortlog</a> |
<a href="/comm-central/log/94ca4330edc8ec70cbc65f05998687e169d4f07d">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/94ca4330edc8ec70cbc65f05998687e169d4f07d">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/94ca4330edc8ec70cbc65f05998687e169d4f07d">files</a> |
changeset |
<a href="/comm-central/raw-rev/94ca4330edc8ec70cbc65f05998687e169d4f07d">raw</a>  | <a href="/comm-central/archive/94ca4330edc8ec70cbc65f05998687e169d4f07d.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
status commit, end of yesterday.
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#65;&#110;&#100;&#114;&#101;&#119;&#32;&#83;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#32;&#60;&#97;&#115;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#64;&#97;&#115;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#46;&#111;&#114;&#103;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 15 Aug 2008 13:32:38 -0700</td></tr>

<tr>
 <td>changeset 877</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/94ca4330edc8ec70cbc65f05998687e169d4f07d">94ca4330edc8ec70cbc65f05998687e169d4f07d</a></td>
</tr>



<tr>
<td>parent 876</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/a00f7c5786c287753dcbc3f266ec8c8c2de1598f">a00f7c5786c287753dcbc3f266ec8c8c2de1598f</a>
</td>
</tr>

<tr>
<td>child 878</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/cb22786c1ac026e1288a1b0dd1f1c8b7b63441db">cb22786c1ac026e1288a1b0dd1f1c8b7b63441db</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=94ca4330edc8ec70cbc65f05998687e169d4f07d">743</a></td></tr>
<tr><td>push user</td><td>dmosedale@mozilla.com</td></tr>
<tr><td>push date</td><td class="date age">Tue, 04 Nov 2008 20:01:44 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@a79b923a9cba [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=a79b923a9cba395cb3911b27c9599ffb8c997caf">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=a79b923a9cba395cb3911b27c9599ffb8c997caf&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a79b923a9cba395cb3911b27c9599ffb8c997caf&newProject=comm-central&newRevision=d32b4cc6f46d1195ae66fd0cf8395c60b9259ca6&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a79b923a9cba395cb3911b27c9599ffb8c997caf&newProject=comm-central&newRevision=d32b4cc6f46d1195ae66fd0cf8395c60b9259ca6&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a79b923a9cba395cb3911b27c9599ffb8c997caf&newProject=comm-central&newRevision=d32b4cc6f46d1195ae66fd0cf8395c60b9259ca6&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>






</table></div>

<div class="page_body description">status commit, end of yesterday.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/94ca4330edc8ec70cbc65f05998687e169d4f07d/components/glmsgdbview.js">components/glmsgdbview.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/94ca4330edc8ec70cbc65f05998687e169d4f07d/components/glmsgdbview.js">file</a> |
<a href="/comm-central/annotate/94ca4330edc8ec70cbc65f05998687e169d4f07d/components/glmsgdbview.js">annotate</a> |
<a href="/comm-central/diff/94ca4330edc8ec70cbc65f05998687e169d4f07d/components/glmsgdbview.js">diff</a> |
<a href="/comm-central/comparison/94ca4330edc8ec70cbc65f05998687e169d4f07d/components/glmsgdbview.js">comparison</a> |
<a href="/comm-central/log/94ca4330edc8ec70cbc65f05998687e169d4f07d/components/glmsgdbview.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/94ca4330edc8ec70cbc65f05998687e169d4f07d/modules/datamodel.js">modules/datamodel.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/94ca4330edc8ec70cbc65f05998687e169d4f07d/modules/datamodel.js">file</a> |
<a href="/comm-central/annotate/94ca4330edc8ec70cbc65f05998687e169d4f07d/modules/datamodel.js">annotate</a> |
<a href="/comm-central/diff/94ca4330edc8ec70cbc65f05998687e169d4f07d/modules/datamodel.js">diff</a> |
<a href="/comm-central/comparison/94ca4330edc8ec70cbc65f05998687e169d4f07d/modules/datamodel.js">comparison</a> |
<a href="/comm-central/log/94ca4330edc8ec70cbc65f05998687e169d4f07d/modules/datamodel.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/94ca4330edc8ec70cbc65f05998687e169d4f07d/modules/datastore.js">modules/datastore.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/94ca4330edc8ec70cbc65f05998687e169d4f07d/modules/datastore.js">file</a> |
<a href="/comm-central/annotate/94ca4330edc8ec70cbc65f05998687e169d4f07d/modules/datastore.js">annotate</a> |
<a href="/comm-central/diff/94ca4330edc8ec70cbc65f05998687e169d4f07d/modules/datastore.js">diff</a> |
<a href="/comm-central/comparison/94ca4330edc8ec70cbc65f05998687e169d4f07d/modules/datastore.js">comparison</a> |
<a href="/comm-central/log/94ca4330edc8ec70cbc65f05998687e169d4f07d/modules/datastore.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/94ca4330edc8ec70cbc65f05998687e169d4f07d/modules/fundattr.js">modules/fundattr.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/94ca4330edc8ec70cbc65f05998687e169d4f07d/modules/fundattr.js">file</a> |
<a href="/comm-central/annotate/94ca4330edc8ec70cbc65f05998687e169d4f07d/modules/fundattr.js">annotate</a> |
<a href="/comm-central/diff/94ca4330edc8ec70cbc65f05998687e169d4f07d/modules/fundattr.js">diff</a> |
<a href="/comm-central/comparison/94ca4330edc8ec70cbc65f05998687e169d4f07d/modules/fundattr.js">comparison</a> |
<a href="/comm-central/log/94ca4330edc8ec70cbc65f05998687e169d4f07d/modules/fundattr.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/94ca4330edc8ec70cbc65f05998687e169d4f07d/modules/index_ab.js">modules/index_ab.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/94ca4330edc8ec70cbc65f05998687e169d4f07d/modules/index_ab.js">file</a> |
<a href="/comm-central/annotate/94ca4330edc8ec70cbc65f05998687e169d4f07d/modules/index_ab.js">annotate</a> |
<a href="/comm-central/diff/94ca4330edc8ec70cbc65f05998687e169d4f07d/modules/index_ab.js">diff</a> |
<a href="/comm-central/comparison/94ca4330edc8ec70cbc65f05998687e169d4f07d/modules/index_ab.js">comparison</a> |
<a href="/comm-central/log/94ca4330edc8ec70cbc65f05998687e169d4f07d/modules/index_ab.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/94ca4330edc8ec70cbc65f05998687e169d4f07d/modules/indexer.js">modules/indexer.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/94ca4330edc8ec70cbc65f05998687e169d4f07d/modules/indexer.js">file</a> |
<a href="/comm-central/annotate/94ca4330edc8ec70cbc65f05998687e169d4f07d/modules/indexer.js">annotate</a> |
<a href="/comm-central/diff/94ca4330edc8ec70cbc65f05998687e169d4f07d/modules/indexer.js">diff</a> |
<a href="/comm-central/comparison/94ca4330edc8ec70cbc65f05998687e169d4f07d/modules/indexer.js">comparison</a> |
<a href="/comm-central/log/94ca4330edc8ec70cbc65f05998687e169d4f07d/modules/indexer.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/components/glmsgdbview.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/components/glmsgdbview.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -823,17 +823,17 @@ dump(&quot;@@@@@@ GROUPING @@@@@@@@@\n&quot;);</span>
<a href="#l1.4"></a><span id="l1.4">       case Ci.nsMsgNavigationType.editUndo:</span>
<a href="#l1.5"></a><span id="l1.5">       case Ci.nsMsgNavigationType.editRedo:</span>
<a href="#l1.6"></a><span id="l1.6">       case Ci.nsMsgNavigationType.toggleSubthreadKilled:</span>
<a href="#l1.7"></a><span id="l1.7">     }</span>
<a href="#l1.8"></a><span id="l1.8">   },</span>
<a href="#l1.9"></a><span id="l1.9">   </span>
<a href="#l1.10"></a><span id="l1.10">   get msgFolder() {</span>
<a href="#l1.11"></a><span id="l1.11"> dump(&quot;&amp;&amp;&amp; get msgFolder\n&quot;);</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-    if (this._messages.length)</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+    if (this._messages.length &amp;&amp; this._messages[0].folderMessage)</span>
<a href="#l1.14"></a><span id="l1.14">       return this._messages[0].folderMessage.folder;</span>
<a href="#l1.15"></a><span id="l1.15">     return null;</span>
<a href="#l1.16"></a><span id="l1.16">   },</span>
<a href="#l1.17"></a><span id="l1.17">   get viewFolder() {</span>
<a href="#l1.18"></a><span id="l1.18"> dump(&quot;&amp;&amp;&amp; get viewFolder\n&quot;);</span>
<a href="#l1.19"></a><span id="l1.19">     return null;</span>
<a href="#l1.20"></a><span id="l1.20">   },</span>
<a href="#l1.21"></a><span id="l1.21">   </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/modules/datamodel.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/modules/datamodel.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -186,24 +186,25 @@ GlodaConversation.prototype = {</span>
<a href="#l2.4"></a><span id="l2.4">   </span>
<a href="#l2.5"></a><span id="l2.5">   toString: function gloda_conversation_toString() {</span>
<a href="#l2.6"></a><span id="l2.6">     return this._subject;</span>
<a href="#l2.7"></a><span id="l2.7">   },</span>
<a href="#l2.8"></a><span id="l2.8"> };</span>
<a href="#l2.9"></a><span id="l2.9"> </span>
<a href="#l2.10"></a><span id="l2.10"> </span>
<a href="#l2.11"></a><span id="l2.11"> function GlodaMessage(aDatastore, aID, aFolderID, aMessageKey,</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-                      aConversationID, aConversation,</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+                      aConversationID, aConversation, aDate,</span>
<a href="#l2.14"></a><span id="l2.14">                       aHeaderMessageID, aBodySnippet) {</span>
<a href="#l2.15"></a><span id="l2.15">   this._datastore = aDatastore;</span>
<a href="#l2.16"></a><span id="l2.16">   this._id = aID;</span>
<a href="#l2.17"></a><span id="l2.17">   this._folderID = aFolderID;</span>
<a href="#l2.18"></a><span id="l2.18">   this._messageKey = aMessageKey;</span>
<a href="#l2.19"></a><span id="l2.19">   this._conversationID = aConversationID;</span>
<a href="#l2.20"></a><span id="l2.20">   this._conversation = aConversation;</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+  this.date = date;</span>
<a href="#l2.22"></a><span id="l2.22">   this._headerMessageID = aHeaderMessageID;</span>
<a href="#l2.23"></a><span id="l2.23">   this._bodySnippet = aBodySnippet;</span>
<a href="#l2.24"></a><span id="l2.24"> </span>
<a href="#l2.25"></a><span id="l2.25">   // for now, let's always cache this; they should really be forgetting about us</span>
<a href="#l2.26"></a><span id="l2.26">   //  if they want to forget about the underlying storage anyways...</span>
<a href="#l2.27"></a><span id="l2.27">   this._folderMessage = undefined;</span>
<a href="#l2.28"></a><span id="l2.28">   // the list of attributes, un-processed</span>
<a href="#l2.29"></a><span id="l2.29">   this._attributes = null;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/modules/datastore.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/modules/datastore.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -53,17 +53,17 @@ Cu.import(&quot;resource://gloda/modules/data</span>
<a href="#l3.4"></a><span id="l3.4"> Cu.import(&quot;resource://gloda/modules/databind.js&quot;);</span>
<a href="#l3.5"></a><span id="l3.5"> Cu.import(&quot;resource://gloda/modules/collection.js&quot;);</span>
<a href="#l3.6"></a><span id="l3.6"> </span>
<a href="#l3.7"></a><span id="l3.7"> let GlodaDatastore = {</span>
<a href="#l3.8"></a><span id="l3.8">   _log: null,</span>
<a href="#l3.9"></a><span id="l3.9"> </span>
<a href="#l3.10"></a><span id="l3.10">   /* ******************* SCHEMA ******************* */</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-  _schemaVersion: 4,</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+  _schemaVersion: 5,</span>
<a href="#l3.14"></a><span id="l3.14">   _schema: {</span>
<a href="#l3.15"></a><span id="l3.15">     tables: {</span>
<a href="#l3.16"></a><span id="l3.16">       </span>
<a href="#l3.17"></a><span id="l3.17">       // ----- Messages</span>
<a href="#l3.18"></a><span id="l3.18">       folderLocations: {</span>
<a href="#l3.19"></a><span id="l3.19">         columns: [</span>
<a href="#l3.20"></a><span id="l3.20">           &quot;id INTEGER PRIMARY KEY&quot;,</span>
<a href="#l3.21"></a><span id="l3.21">           &quot;folderURI TEXT&quot;,</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineat">@@ -102,27 +102,29 @@ let GlodaDatastore = {</span>
<a href="#l3.23"></a><span id="l3.23">        *  sentinel values if this somehow impacts performance.</span>
<a href="#l3.24"></a><span id="l3.24">        */</span>
<a href="#l3.25"></a><span id="l3.25">       messages: {</span>
<a href="#l3.26"></a><span id="l3.26">         columns: [</span>
<a href="#l3.27"></a><span id="l3.27">           &quot;id INTEGER PRIMARY KEY&quot;,</span>
<a href="#l3.28"></a><span id="l3.28">           &quot;folderID INTEGER REFERENCES folderLocations(id)&quot;,</span>
<a href="#l3.29"></a><span id="l3.29">           &quot;messageKey INTEGER&quot;,</span>
<a href="#l3.30"></a><span id="l3.30">           &quot;conversationID INTEGER NOT NULL REFERENCES conversations(id)&quot;,</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+          &quot;date INTEGER&quot;,</span>
<a href="#l3.32"></a><span id="l3.32">           // we used to have the parentID, but because of the very real</span>
<a href="#l3.33"></a><span id="l3.33">           //  possibility of multiple copies of a message with a given</span>
<a href="#l3.34"></a><span id="l3.34">           //  message-id, the parentID concept is unreliable.</span>
<a href="#l3.35"></a><span id="l3.35">           &quot;headerMessageID TEXT&quot;,</span>
<a href="#l3.36"></a><span id="l3.36">           &quot;bodySnippet TEXT&quot;,</span>
<a href="#l3.37"></a><span id="l3.37">         ],</span>
<a href="#l3.38"></a><span id="l3.38">         </span>
<a href="#l3.39"></a><span id="l3.39">         indices: {</span>
<a href="#l3.40"></a><span id="l3.40">           messageLocation: ['folderID', 'messageKey'],</span>
<a href="#l3.41"></a><span id="l3.41">           headerMessageID: ['headerMessageID'],</span>
<a href="#l3.42"></a><span id="l3.42">           conversationID: ['conversationID'],</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+          date: ['date'],</span>
<a href="#l3.44"></a><span id="l3.44">         },</span>
<a href="#l3.45"></a><span id="l3.45">         </span>
<a href="#l3.46"></a><span id="l3.46">         triggers: {</span>
<a href="#l3.47"></a><span id="l3.47">           delete: &quot;DELETE FROM messageAttributes WHERE messageID = OLD.id&quot;,</span>
<a href="#l3.48"></a><span id="l3.48">         },</span>
<a href="#l3.49"></a><span id="l3.49">       },</span>
<a href="#l3.50"></a><span id="l3.50">       </span>
<a href="#l3.51"></a><span id="l3.51">       // ----- Attributes</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineat">@@ -169,18 +171,24 @@ let GlodaDatastore = {</span>
<a href="#l3.53"></a><span id="l3.53">        *  nick, etc.  Identities belong to contacts, and this relationship is</span>
<a href="#l3.54"></a><span id="l3.54">        *  expressed on the identityAttributes table.</span>
<a href="#l3.55"></a><span id="l3.55">        */</span>
<a href="#l3.56"></a><span id="l3.56">       contacts: {</span>
<a href="#l3.57"></a><span id="l3.57">         columns: [</span>
<a href="#l3.58"></a><span id="l3.58">           &quot;id INTEGER PRIMARY KEY&quot;,</span>
<a href="#l3.59"></a><span id="l3.59">           &quot;directoryUUID TEXT&quot;,</span>
<a href="#l3.60"></a><span id="l3.60">           &quot;contactUUID TEXT&quot;,</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+          &quot;popularity INTEGER&quot;,</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineplus">+          &quot;frecency INTEGER&quot;,</span>
<a href="#l3.63"></a><span id="l3.63">           &quot;name TEXT&quot;</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineminus">-        ]</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineplus">+        ],</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineplus">+        indices: {</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineplus">+          popularity: [&quot;popularity&quot;],</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineplus">+          frecency: [&quot;frecency&quot;],</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineplus">+        },</span>
<a href="#l3.70"></a><span id="l3.70">       },</span>
<a href="#l3.71"></a><span id="l3.71">       </span>
<a href="#l3.72"></a><span id="l3.72">       /**</span>
<a href="#l3.73"></a><span id="l3.73">        * Identities correspond to specific e-mail addresses, IRC nicks, etc.</span>
<a href="#l3.74"></a><span id="l3.74">        */</span>
<a href="#l3.75"></a><span id="l3.75">       identities: {</span>
<a href="#l3.76"></a><span id="l3.76">         columns: [</span>
<a href="#l3.77"></a><span id="l3.77">           &quot;id INTEGER PRIMARY KEY&quot;,</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineat">@@ -653,54 +661,59 @@ let GlodaDatastore = {</span>
<a href="#l3.79"></a><span id="l3.79">     this._selectConversationByIDStatement.reset();</span>
<a href="#l3.80"></a><span id="l3.80">     </span>
<a href="#l3.81"></a><span id="l3.81">     return conversation;</span>
<a href="#l3.82"></a><span id="l3.82">   },</span>
<a href="#l3.83"></a><span id="l3.83">   </span>
<a href="#l3.84"></a><span id="l3.84">   /* ********** Message ********** */</span>
<a href="#l3.85"></a><span id="l3.85">   get _insertMessageStatement() {</span>
<a href="#l3.86"></a><span id="l3.86">     let statement = this._createStatement(</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineminus">-      &quot;INSERT INTO messages (folderID, messageKey, conversationID, \</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineplus">+      &quot;INSERT INTO messages (folderID, messageKey, conversationID, date, \</span>
<a href="#l3.89"></a><span id="l3.89">                              headerMessageID, bodySnippet) \</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineminus">-              VALUES (:folderID, :messageKey, :conversationID, \</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineplus">+              VALUES (:folderID, :messageKey, :conversationID, :date, \</span>
<a href="#l3.92"></a><span id="l3.92">                       :headerMessageID, :bodySnippet)&quot;);</span>
<a href="#l3.93"></a><span id="l3.93">     this.__defineGetter__(&quot;_insertMessageStatement&quot;, function() statement);</span>
<a href="#l3.94"></a><span id="l3.94">     return this._insertMessageStatement; </span>
<a href="#l3.95"></a><span id="l3.95">   }, </span>
<a href="#l3.96"></a><span id="l3.96">   </span>
<a href="#l3.97"></a><span id="l3.97" class="difflineplus">+  /**</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineplus">+   *</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineplus">+   */</span>
<a href="#l3.100"></a><span id="l3.100">   createMessage: function gloda_ds_createMessage(aFolderURI, aMessageKey,</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineminus">-                              aConversationID, aHeaderMessageID,</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineplus">+                              aConversationID, aDatePRTime, aHeaderMessageID,</span>
<a href="#l3.103"></a><span id="l3.103">                               aBodySnippet) {</span>
<a href="#l3.104"></a><span id="l3.104">     let folderID;</span>
<a href="#l3.105"></a><span id="l3.105">     if (aFolderURI != null) {</span>
<a href="#l3.106"></a><span id="l3.106">       folderID = this._mapFolderURI(aFolderURI);</span>
<a href="#l3.107"></a><span id="l3.107">     }</span>
<a href="#l3.108"></a><span id="l3.108">     else {</span>
<a href="#l3.109"></a><span id="l3.109">       folderID = null;</span>
<a href="#l3.110"></a><span id="l3.110">     }</span>
<a href="#l3.111"></a><span id="l3.111">     </span>
<a href="#l3.112"></a><span id="l3.112">     let ims = this._insertMessageStatement;</span>
<a href="#l3.113"></a><span id="l3.113">     ims.params.folderID = folderID;</span>
<a href="#l3.114"></a><span id="l3.114">     ims.params.messageKey = aMessageKey;</span>
<a href="#l3.115"></a><span id="l3.115">     ims.params.conversationID = aConversationID;</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineplus">+    ims.params.date = aDatePRTime;</span>
<a href="#l3.117"></a><span id="l3.117">     ims.params.headerMessageID = aHeaderMessageID;</span>
<a href="#l3.118"></a><span id="l3.118">     ims.params.bodySnippet = aBodySnippet;</span>
<a href="#l3.119"></a><span id="l3.119"> </span>
<a href="#l3.120"></a><span id="l3.120">     try {</span>
<a href="#l3.121"></a><span id="l3.121">        ims.execute();</span>
<a href="#l3.122"></a><span id="l3.122">     }</span>
<a href="#l3.123"></a><span id="l3.123">     catch(ex) {</span>
<a href="#l3.124"></a><span id="l3.124">        throw(&quot;error executing statement... &quot; +</span>
<a href="#l3.125"></a><span id="l3.125">              this.dbConnection.lastError + &quot;: &quot; +</span>
<a href="#l3.126"></a><span id="l3.126">              this.dbConnection.lastErrorString + &quot; - &quot; + ex);</span>
<a href="#l3.127"></a><span id="l3.127">     }</span>
<a href="#l3.128"></a><span id="l3.128">     //ims.execute();</span>
<a href="#l3.129"></a><span id="l3.129">     </span>
<a href="#l3.130"></a><span id="l3.130">     return new GlodaMessage(this, this.dbConnection.lastInsertRowID, folderID,</span>
<a href="#l3.131"></a><span id="l3.131">                             aMessageKey, aConversationID, null,</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineplus">+                            aDatePRTime ? new Date(aDatePRTime / 1000) : null,</span>
<a href="#l3.133"></a><span id="l3.133">                             aHeaderMessageID, aBodySnippet);</span>
<a href="#l3.134"></a><span id="l3.134">   },</span>
<a href="#l3.135"></a><span id="l3.135">   </span>
<a href="#l3.136"></a><span id="l3.136">   get _updateMessageStatement() {</span>
<a href="#l3.137"></a><span id="l3.137">     let statement = this._createStatement(</span>
<a href="#l3.138"></a><span id="l3.138">       &quot;UPDATE messages SET folderID = :folderID, \</span>
<a href="#l3.139"></a><span id="l3.139">                            messageKey = :messageKey, \</span>
<a href="#l3.140"></a><span id="l3.140">                            conversationID = :conversationID, \</span>
<a href="#l3.141"></a><span id="l3.141" class="difflineat">@@ -736,19 +749,21 @@ let GlodaDatastore = {</span>
<a href="#l3.142"></a><span id="l3.142">     let statement = this._createStatement(sqlStr);</span>
<a href="#l3.143"></a><span id="l3.143">     statement.params.id = srcFolderID;</span>
<a href="#l3.144"></a><span id="l3.144">     statement.params.newFolderID = destFolderID;</span>
<a href="#l3.145"></a><span id="l3.145">     statement.params.nullMsgKey = null;</span>
<a href="#l3.146"></a><span id="l3.146">     statement.execute();</span>
<a href="#l3.147"></a><span id="l3.147">   },</span>
<a href="#l3.148"></a><span id="l3.148">   </span>
<a href="#l3.149"></a><span id="l3.149">   _messageFromRow: function gloda_ds_messageFromRow(aRow) {</span>
<a href="#l3.150"></a><span id="l3.150" class="difflineplus">+    let datePRTime = aRow[&quot;date&quot;];</span>
<a href="#l3.151"></a><span id="l3.151">     return new GlodaMessage(this, aRow[&quot;id&quot;], aRow[&quot;folderID&quot;],</span>
<a href="#l3.152"></a><span id="l3.152">                             aRow[&quot;messageKey&quot;],</span>
<a href="#l3.153"></a><span id="l3.153">                             aRow[&quot;conversationID&quot;], null,</span>
<a href="#l3.154"></a><span id="l3.154" class="difflineplus">+                            datePRTime ? new Date(datePRTime / 1000) : null,</span>
<a href="#l3.155"></a><span id="l3.155">                             aRow[&quot;headerMessageID&quot;], aRow[&quot;bodySnippet&quot;]);</span>
<a href="#l3.156"></a><span id="l3.156">   },</span>
<a href="#l3.157"></a><span id="l3.157"> </span>
<a href="#l3.158"></a><span id="l3.158">   get _selectMessageByIDStatement() {</span>
<a href="#l3.159"></a><span id="l3.159">     let statement = this._createStatement(</span>
<a href="#l3.160"></a><span id="l3.160">       &quot;SELECT * FROM messages WHERE id = :id&quot;);</span>
<a href="#l3.161"></a><span id="l3.161">     this.__defineGetter__(&quot;_selectMessageByIDStatement&quot;,</span>
<a href="#l3.162"></a><span id="l3.162">       function() statement);</span>
<a href="#l3.163"></a><span id="l3.163" class="difflineat">@@ -1092,20 +1107,25 @@ let GlodaDatastore = {</span>
<a href="#l3.164"></a><span id="l3.164">           }</span>
<a href="#l3.165"></a><span id="l3.165">           </span>
<a href="#l3.166"></a><span id="l3.166">           // straight value match?</span>
<a href="#l3.167"></a><span id="l3.167">           if (APV.length == 3) {</span>
<a href="#l3.168"></a><span id="l3.168">             if (APV[2] != null)</span>
<a href="#l3.169"></a><span id="l3.169">               valueTests.push(valueColumnName + &quot; = &quot; + APV[2]);</span>
<a href="#l3.170"></a><span id="l3.170">           }</span>
<a href="#l3.171"></a><span id="l3.171">           else { // APV.length == 4, so range match</span>
<a href="#l3.172"></a><span id="l3.172" class="difflineplus">+            if (APV[2] === null) // so just &lt;=</span>
<a href="#l3.173"></a><span id="l3.173" class="difflineplus">+              valueTests.push(valueColumnName + &quot; &lt;= &quot; + APV[3]);</span>
<a href="#l3.174"></a><span id="l3.174" class="difflineplus">+            else if (APV[3] === null) // so just &gt;=</span>
<a href="#l3.175"></a><span id="l3.175">             // BETWEEN is optimized to &gt;= and &lt;=, or we could just do that</span>
<a href="#l3.176"></a><span id="l3.176">             //  ourself (in other words, this shouldn't hurt our use of indices)</span>
<a href="#l3.177"></a><span id="l3.177" class="difflineminus">-            valueTests.push(valueColumnName + &quot; BETWEEN &quot; + APV[2] + &quot; AND &quot; +</span>
<a href="#l3.178"></a><span id="l3.178" class="difflineminus">-                            APV[3]);</span>
<a href="#l3.179"></a><span id="l3.179" class="difflineplus">+              valueTests.push(valueColumnName + &quot; &gt;= &quot; + APV[2]);</span>
<a href="#l3.180"></a><span id="l3.180" class="difflineplus">+            else</span>
<a href="#l3.181"></a><span id="l3.181" class="difflineplus">+              valueTests.push(valueColumnName + &quot; BETWEEN &quot; + APV[2] + &quot; AND &quot; +</span>
<a href="#l3.182"></a><span id="l3.182" class="difflineplus">+                              APV[3]);</span>
<a href="#l3.183"></a><span id="l3.183">           }</span>
<a href="#l3.184"></a><span id="l3.184">         }</span>
<a href="#l3.185"></a><span id="l3.185">         let select = &quot;SELECT &quot; + idColumnName + &quot; FROM &quot; + tableName + </span>
<a href="#l3.186"></a><span id="l3.186">                      &quot; WHERE &quot; +</span>
<a href="#l3.187"></a><span id="l3.187">                      [(&quot;(&quot; + avt[0] + &quot;(&quot; + avt[1].join(&quot; OR &quot;) + &quot;))&quot;)</span>
<a href="#l3.188"></a><span id="l3.188">                       for each (avt in attrValueTests)].join(&quot; OR &quot;);</span>
<a href="#l3.189"></a><span id="l3.189">         selects.push(select);</span>
<a href="#l3.190"></a><span id="l3.190">       }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/modules/fundattr.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/modules/fundattr.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -155,24 +155,26 @@ let GlodaFundAttr = {</span>
<a href="#l4.4"></a><span id="l4.4">     Gloda.defineNounAction(Gloda.NOUN_IDENTITY, {actionType: &quot;filter&quot;,</span>
<a href="#l4.5"></a><span id="l4.5">       actionTarget: Gloda.NOUN_MESSAGE,</span>
<a href="#l4.6"></a><span id="l4.6">       shortName: &quot;cc&quot;,</span>
<a href="#l4.7"></a><span id="l4.7">       makeConstraint: function(aAttrDef, aIdentity) {</span>
<a href="#l4.8"></a><span id="l4.8">         return [GlodaFundAttr._attrCc, null, aIdentity.id];</span>
<a href="#l4.9"></a><span id="l4.9">       },</span>
<a href="#l4.10"></a><span id="l4.10">       });</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-    // Date</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+    // Date.  now lives on the row.</span>
<a href="#l4.14"></a><span id="l4.14">     this._attrDate = Gloda.defineAttribute({</span>
<a href="#l4.15"></a><span id="l4.15">                         provider: this,</span>
<a href="#l4.16"></a><span id="l4.16">                         extensionName: Gloda.BUILT_IN,</span>
<a href="#l4.17"></a><span id="l4.17">                         attributeType: Gloda.kAttrFundamental,</span>
<a href="#l4.18"></a><span id="l4.18">                         attributeName: &quot;date&quot;,</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineminus">-                        bind: true,</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+                        bind: false,</span>
<a href="#l4.21"></a><span id="l4.21">                         singular: true,</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+                        special: true,</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+                        specialColumnName: &quot;date&quot;,</span>
<a href="#l4.24"></a><span id="l4.24">                         subjectNouns: [Gloda.NOUN_MESSAGE],</span>
<a href="#l4.25"></a><span id="l4.25">                         objectNoun: Gloda.NOUN_DATE,</span>
<a href="#l4.26"></a><span id="l4.26">                         parameterNoun: null,</span>
<a href="#l4.27"></a><span id="l4.27">                         explanation: this._strBundle.GetStringFromName(</span>
<a href="#l4.28"></a><span id="l4.28">                                        &quot;attrDateExplanation&quot;),</span>
<a href="#l4.29"></a><span id="l4.29">                         });</span>
<a href="#l4.30"></a><span id="l4.30">     // -- Mailing List</span>
<a href="#l4.31"></a><span id="l4.31">     // Non-singular, but a hard call.  Namely, it is obvious that a message can</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1">new file mode 100644</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/modules/indexer.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/modules/indexer.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -157,22 +157,23 @@ let GlodaIndexer = {</span>
<a href="#l6.4"></a><span id="l6.4">   _inited: false,</span>
<a href="#l6.5"></a><span id="l6.5">   init: function gloda_index_init(aDOMWindow, aMsgWindow, aStrBundle,</span>
<a href="#l6.6"></a><span id="l6.6">                                   aMessenger) {</span>
<a href="#l6.7"></a><span id="l6.7">     if (this._inited)</span>
<a href="#l6.8"></a><span id="l6.8">       return;</span>
<a href="#l6.9"></a><span id="l6.9">     </span>
<a href="#l6.10"></a><span id="l6.10">     this._inited = true;</span>
<a href="#l6.11"></a><span id="l6.11">     </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+    // we need this for setTimeout... what to do about this?</span>
<a href="#l6.13"></a><span id="l6.13">     this._domWindow = aDOMWindow;</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-    </span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+    // not sure we actually need this to pass around?</span>
<a href="#l6.16"></a><span id="l6.16">     this._msgWindow = aMsgWindow;</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineminus">-    </span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+    // XXX we can XPCOM this up instead...</span>
<a href="#l6.19"></a><span id="l6.19">     this._strBundle = aStrBundle;</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineminus">-    </span>
<a href="#l6.21"></a><span id="l6.21" class="difflineplus">+    // XXX we can XPCOM up a messenger instance of our own</span>
<a href="#l6.22"></a><span id="l6.22">     this._messenger = aMessenger;</span>
<a href="#l6.23"></a><span id="l6.23">     </span>
<a href="#l6.24"></a><span id="l6.24">     // topmostMsgWindow explodes for un-clear reasons if we have multiple</span>
<a href="#l6.25"></a><span id="l6.25">     //  windows open.  very sad.</span>
<a href="#l6.26"></a><span id="l6.26">     let mailSession = Cc[&quot;@mozilla.org/messenger/services/session;1&quot;].</span>
<a href="#l6.27"></a><span id="l6.27">                         getService(Ci.nsIMsgMailSession);</span>
<a href="#l6.28"></a><span id="l6.28"> </span>
<a href="#l6.29"></a><span id="l6.29">     this._folderListener._init(this);</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineat">@@ -205,16 +206,17 @@ let GlodaIndexer = {</span>
<a href="#l6.31"></a><span id="l6.31">       this._enabled = false;</span>
<a href="#l6.32"></a><span id="l6.32">     }</span>
<a href="#l6.33"></a><span id="l6.33">     </span>
<a href="#l6.34"></a><span id="l6.34">     this._log.info(&quot;Event-Driven Indexing is now &quot; + this._enabled);</span>
<a href="#l6.35"></a><span id="l6.35">   },</span>
<a href="#l6.36"></a><span id="l6.36"> </span>
<a href="#l6.37"></a><span id="l6.37">   /** Track whether indexing is active (we have timers in-flight). */</span>
<a href="#l6.38"></a><span id="l6.38">   _indexingActive: false,</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineplus">+  /** Indicates whether indexing is active or not. */</span>
<a href="#l6.40"></a><span id="l6.40">   get indexing() { return this._indexingActive; },</span>
<a href="#l6.41"></a><span id="l6.41">   /** You can turn on indexing, but you can't turn it off! */</span>
<a href="#l6.42"></a><span id="l6.42">   set indexing(aShouldIndex) {</span>
<a href="#l6.43"></a><span id="l6.43">     if (!this._indexingActive &amp;&amp; aShouldIndex) {</span>
<a href="#l6.44"></a><span id="l6.44">       this._log.info(&quot;+++ Indexing Queue Processing Commencing&quot;);</span>
<a href="#l6.45"></a><span id="l6.45">       this._indexingActive = true;</span>
<a href="#l6.46"></a><span id="l6.46">       this._domWindow.setTimeout(this._wrapCallbackDriver,</span>
<a href="#l6.47"></a><span id="l6.47">                                  this._indexInterval,</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineat">@@ -262,54 +264,69 @@ let GlodaIndexer = {</span>
<a href="#l6.49"></a><span id="l6.49">    *  or the message progress bar.</span>
<a href="#l6.50"></a><span id="l6.50">    */</span>
<a href="#l6.51"></a><span id="l6.51">   _pendingAddJob: null,</span>
<a href="#l6.52"></a><span id="l6.52">   </span>
<a href="#l6.53"></a><span id="l6.53">   /**</span>
<a href="#l6.54"></a><span id="l6.54">    * The time interval, in milliseconds between performing indexing work.</span>
<a href="#l6.55"></a><span id="l6.55">    *  This may be altered by user session (in)activity.</span>
<a href="#l6.56"></a><span id="l6.56">    */ </span>
<a href="#l6.57"></a><span id="l6.57" class="difflineminus">-  _indexInterval: 100,</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineplus">+  _indexInterval: 80,</span>
<a href="#l6.59"></a><span id="l6.59">   /**</span>
<a href="#l6.60"></a><span id="l6.60">    * Number of indexing 'tokens' we are allowed to consume before yielding for</span>
<a href="#l6.61"></a><span id="l6.61">    *  each incremental pass.  Consider a single token equal to indexing a single</span>
<a href="#l6.62"></a><span id="l6.62">    *  medium-sized message.  This may be altered by user session (in)activity.</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineplus">+   * Because we fetch message bodies, which is potentially asynchronous, this</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineplus">+   *  is not a precise knob to twiddle.</span>
<a href="#l6.65"></a><span id="l6.65">    */</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineminus">-  _indexTokens: 10,</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineplus">+  _indexTokens: 15,</span>
<a href="#l6.68"></a><span id="l6.68">   </span>
<a href="#l6.69"></a><span id="l6.69">   _indexListeners: [],</span>
<a href="#l6.70"></a><span id="l6.70">   /**</span>
<a href="#l6.71"></a><span id="l6.71">    * Add an indexing progress listener.  The listener will be notified of at</span>
<a href="#l6.72"></a><span id="l6.72">    *  least all major status changes (idle -&gt; indexing, indexing -&gt; idle), plus</span>
<a href="#l6.73"></a><span id="l6.73">    *  arbitrary progress updates during the indexing process.</span>
<a href="#l6.74"></a><span id="l6.74">    * If indexing is not active when the listener is added, a synthetic idle</span>
<a href="#l6.75"></a><span id="l6.75">    *  notification will be generated.</span>
<a href="#l6.76"></a><span id="l6.76">    *</span>
<a href="#l6.77"></a><span id="l6.77">    * @param aListener A listener function, taking arguments: status (string),</span>
<a href="#l6.78"></a><span id="l6.78">    *     folder name being indexed (string or null), current zero-based folder</span>
<a href="#l6.79"></a><span id="l6.79">    *     number being indexed (int), total number of folders to index (int),</span>
<a href="#l6.80"></a><span id="l6.80">    *     current message number being indexed in this folder (int), total number</span>
<a href="#l6.81"></a><span id="l6.81">    *     of messages in this folder to be indexed (int).</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineplus">+   *</span>
<a href="#l6.83"></a><span id="l6.83" class="difflineplus">+   * @TODO should probably allow for a 'this' value to be provided</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineplus">+   * @TODO generalize to not be folder/message specific.  use nouns!</span>
<a href="#l6.85"></a><span id="l6.85">    */</span>
<a href="#l6.86"></a><span id="l6.86">   addListener: function gloda_index_addListener(aListener) {</span>
<a href="#l6.87"></a><span id="l6.87">     // should we weakify?</span>
<a href="#l6.88"></a><span id="l6.88">     if (this._indexListeners.indexOf(aListener) == -1)</span>
<a href="#l6.89"></a><span id="l6.89">       this._indexListeners.push(aListener);</span>
<a href="#l6.90"></a><span id="l6.90">     // if we aren't indexing, give them an idle indicator, otherwise they can</span>
<a href="#l6.91"></a><span id="l6.91">     //  just be happy when we hit the next actual status point.</span>
<a href="#l6.92"></a><span id="l6.92">     if (!this.indexing)</span>
<a href="#l6.93"></a><span id="l6.93">       aListener(this._strBundle ? this._strBundle.getString(&quot;actionIdle&quot;) : &quot;&quot;,</span>
<a href="#l6.94"></a><span id="l6.94">                 null, 0, 1, 0, 1);</span>
<a href="#l6.95"></a><span id="l6.95">     return aListener;</span>
<a href="#l6.96"></a><span id="l6.96">   },</span>
<a href="#l6.97"></a><span id="l6.97" class="difflineplus">+  /**</span>
<a href="#l6.98"></a><span id="l6.98" class="difflineplus">+   * Remove the given listener so that it no longer receives indexing progress</span>
<a href="#l6.99"></a><span id="l6.99" class="difflineplus">+   *  updates.</span>
<a href="#l6.100"></a><span id="l6.100" class="difflineplus">+   */</span>
<a href="#l6.101"></a><span id="l6.101">   removeListener: function gloda_index_removeListener(aListener) {</span>
<a href="#l6.102"></a><span id="l6.102">     let index = this._indexListeners.indexOf(aListener);</span>
<a href="#l6.103"></a><span id="l6.103">     if (index != -1)</span>
<a href="#l6.104"></a><span id="l6.104">       this._indexListeners.splice(index, 1);</span>
<a href="#l6.105"></a><span id="l6.105">   },</span>
<a href="#l6.106"></a><span id="l6.106" class="difflineplus">+  /**</span>
<a href="#l6.107"></a><span id="l6.107" class="difflineplus">+   * Helper method to tell listeners what we're up to.  For code simplicity,</span>
<a href="#l6.108"></a><span id="l6.108" class="difflineplus">+   *  the caller is just deciding when to send this update (preferably at</span>
<a href="#l6.109"></a><span id="l6.109" class="difflineplus">+   *  reasonable intervals), and doesn't need to provide any indication of</span>
<a href="#l6.110"></a><span id="l6.110" class="difflineplus">+   *  state... we figure that out ourselves.</span>
<a href="#l6.111"></a><span id="l6.111" class="difflineplus">+   */</span>
<a href="#l6.112"></a><span id="l6.112">   _notifyListeners: function gloda_index_notifyListeners() {</span>
<a href="#l6.113"></a><span id="l6.113">     let status, prettyName, jobIndex, jobTotal, jobItemIndex, jobItemGoal;</span>
<a href="#l6.114"></a><span id="l6.114">     </span>
<a href="#l6.115"></a><span id="l6.115">     if (this._indexingActive &amp;&amp; this._curIndexingJob) {</span>
<a href="#l6.116"></a><span id="l6.116">       let job = this._curIndexingJob;</span>
<a href="#l6.117"></a><span id="l6.117">       if (job.deltaType &gt; 0)</span>
<a href="#l6.118"></a><span id="l6.118">         status = this._strBundle.getString(&quot;actionIndexing&quot;);</span>
<a href="#l6.119"></a><span id="l6.119">       else if (job.deltaType == 0)</span>
<a href="#l6.120"></a><span id="l6.120" class="difflineat">@@ -1217,17 +1234,17 @@ let GlodaIndexer = {</span>
<a href="#l6.121"></a><span id="l6.121">     for (let iAncestor=0; iAncestor &lt; ancestorLists.length; ++iAncestor) {</span>
<a href="#l6.122"></a><span id="l6.122">       let ancestorList = ancestorLists[iAncestor];</span>
<a href="#l6.123"></a><span id="l6.123">       </span>
<a href="#l6.124"></a><span id="l6.124">       if (ancestorList.length == 0) {</span>
<a href="#l6.125"></a><span id="l6.125">         this._log.debug(&quot;creating message with: null, &quot; + conversationID +</span>
<a href="#l6.126"></a><span id="l6.126">                         &quot;, &quot; + references[iAncestor] +</span>
<a href="#l6.127"></a><span id="l6.127">                         &quot;, null.&quot;);</span>
<a href="#l6.128"></a><span id="l6.128">         let ancestor = this._datastore.createMessage(null, null, // ghost</span>
<a href="#l6.129"></a><span id="l6.129" class="difflineminus">-                                                     conversationID,</span>
<a href="#l6.130"></a><span id="l6.130" class="difflineplus">+                                                     conversationID, null,</span>
<a href="#l6.131"></a><span id="l6.131">                                                      references[iAncestor],</span>
<a href="#l6.132"></a><span id="l6.132">                                                      null); // no snippet</span>
<a href="#l6.133"></a><span id="l6.133">         ancestorLists[iAncestor].push(ancestor);</span>
<a href="#l6.134"></a><span id="l6.134">       }</span>
<a href="#l6.135"></a><span id="l6.135">     }</span>
<a href="#l6.136"></a><span id="l6.136">     // now all our ancestors exist, though they may be ghost-like...</span>
<a href="#l6.137"></a><span id="l6.137">     </span>
<a href="#l6.138"></a><span id="l6.138">     // find if there's a ghost version of our message or we already have indexed</span>
<a href="#l6.139"></a><span id="l6.139" class="difflineat">@@ -1269,16 +1286,17 @@ let GlodaIndexer = {</span>
<a href="#l6.140"></a><span id="l6.140">       }</span>
<a href="#l6.141"></a><span id="l6.141">     }</span>
<a href="#l6.142"></a><span id="l6.142">     </span>
<a href="#l6.143"></a><span id="l6.143">     if (curMsg === null) {</span>
<a href="#l6.144"></a><span id="l6.144">       this._log.debug(&quot;...creating new message&quot;);</span>
<a href="#l6.145"></a><span id="l6.145">       curMsg = this._datastore.createMessage(aMsgHdr.folder.URI,</span>
<a href="#l6.146"></a><span id="l6.146">                                              aMsgHdr.messageKey,                </span>
<a href="#l6.147"></a><span id="l6.147">                                              conversationID,</span>
<a href="#l6.148"></a><span id="l6.148" class="difflineplus">+                                             aMsgHdr.date,</span>
<a href="#l6.149"></a><span id="l6.149">                                              aMsgHdr.messageId,</span>
<a href="#l6.150"></a><span id="l6.150">                                              null); // no snippet</span>
<a href="#l6.151"></a><span id="l6.151">      }</span>
<a href="#l6.152"></a><span id="l6.152">      else {</span>
<a href="#l6.153"></a><span id="l6.153">         curMsg._folderID = this._datastore._mapFolderURI(aMsgHdr.folder.URI);</span>
<a href="#l6.154"></a><span id="l6.154">         curMsg._messageKey = aMsgHdr.messageKey;</span>
<a href="#l6.155"></a><span id="l6.155">         this._datastore.updateMessage(curMsg);</span>
<a href="#l6.156"></a><span id="l6.156">      }</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

