<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 3062:c7415baf5df07486031dd7e913f6271aecf2d5bc</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ c7415baf5df07486031dd7e913f6271aecf2d5bc" />
<meta property="og:url" content="/comm-central/rev/c7415baf5df07486031dd7e913f6271aecf2d5bc" />
<meta property="og:description" content="Bug 498209 - Recipient is no longer a choice for column list display in normal (not Sent) folders. r=sid0,r=philor,sr=Standard8" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / c7415baf5df07486031dd7e913f6271aecf2d5bc 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/c7415baf5df07486031dd7e913f6271aecf2d5bc">shortlog</a> |
<a href="/comm-central/log/c7415baf5df07486031dd7e913f6271aecf2d5bc">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/c7415baf5df07486031dd7e913f6271aecf2d5bc">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/c7415baf5df07486031dd7e913f6271aecf2d5bc">files</a> |
changeset |
<a href="/comm-central/raw-rev/c7415baf5df07486031dd7e913f6271aecf2d5bc">raw</a>  | <a href="/comm-central/archive/c7415baf5df07486031dd7e913f6271aecf2d5bc.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=498209">Bug 498209</a> - Recipient is no longer a choice for column list display in normal (not Sent) folders. r=sid0,r=philor,sr=Standard8
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#65;&#110;&#100;&#114;&#101;&#119;&#32;&#83;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#32;&#60;&#97;&#115;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#64;&#97;&#115;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#46;&#111;&#114;&#103;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 14 Jul 2009 20:32:31 -0700</td></tr>

<tr>
 <td>changeset 3062</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/c7415baf5df07486031dd7e913f6271aecf2d5bc">c7415baf5df07486031dd7e913f6271aecf2d5bc</a></td>
</tr>



<tr>
<td>parent 3061</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/916b3ed62ca7defbc05179ccc3fe859247f0dbec">916b3ed62ca7defbc05179ccc3fe859247f0dbec</a>
</td>
</tr>

<tr>
<td>child 3063</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/490507630a606bb6e9ad4defcc912d954fe7bb8f">490507630a606bb6e9ad4defcc912d954fe7bb8f</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=c7415baf5df07486031dd7e913f6271aecf2d5bc">2495</a></td></tr>
<tr><td>push user</td><td>bugmail@asutherland.org</td></tr>
<tr><td>push date</td><td class="date age">Wed, 15 Jul 2009 03:32:40 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@c7415baf5df0 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=c7415baf5df07486031dd7e913f6271aecf2d5bc">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=c7415baf5df07486031dd7e913f6271aecf2d5bc&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=c7415baf5df07486031dd7e913f6271aecf2d5bc&newProject=comm-central&newRevision=c7415baf5df07486031dd7e913f6271aecf2d5bc&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=c7415baf5df07486031dd7e913f6271aecf2d5bc&newProject=comm-central&newRevision=c7415baf5df07486031dd7e913f6271aecf2d5bc&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=c7415baf5df07486031dd7e913f6271aecf2d5bc&newProject=comm-central&newRevision=c7415baf5df07486031dd7e913f6271aecf2d5bc&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28sid0%29&revcount=50">sid0</a>, <a href="/comm-central/log?rev=reviewer%28philor%29&revcount=50">philor</a>, <a href="/comm-central/log?rev=reviewer%28Standard8%29&revcount=50">Standard8</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=498209">498209</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=498209">Bug 498209</a> - Recipient is no longer a choice for column list display in normal (not Sent) folders. r=sid0,r=philor,sr=Standard8</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c7415baf5df07486031dd7e913f6271aecf2d5bc/mail/base/content/SearchDialog.js">mail/base/content/SearchDialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c7415baf5df07486031dd7e913f6271aecf2d5bc/mail/base/content/SearchDialog.js">file</a> |
<a href="/comm-central/annotate/c7415baf5df07486031dd7e913f6271aecf2d5bc/mail/base/content/SearchDialog.js">annotate</a> |
<a href="/comm-central/diff/c7415baf5df07486031dd7e913f6271aecf2d5bc/mail/base/content/SearchDialog.js">diff</a> |
<a href="/comm-central/comparison/c7415baf5df07486031dd7e913f6271aecf2d5bc/mail/base/content/SearchDialog.js">comparison</a> |
<a href="/comm-central/log/c7415baf5df07486031dd7e913f6271aecf2d5bc/mail/base/content/SearchDialog.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c7415baf5df07486031dd7e913f6271aecf2d5bc/mail/base/content/folderDisplay.js">mail/base/content/folderDisplay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c7415baf5df07486031dd7e913f6271aecf2d5bc/mail/base/content/folderDisplay.js">file</a> |
<a href="/comm-central/annotate/c7415baf5df07486031dd7e913f6271aecf2d5bc/mail/base/content/folderDisplay.js">annotate</a> |
<a href="/comm-central/diff/c7415baf5df07486031dd7e913f6271aecf2d5bc/mail/base/content/folderDisplay.js">diff</a> |
<a href="/comm-central/comparison/c7415baf5df07486031dd7e913f6271aecf2d5bc/mail/base/content/folderDisplay.js">comparison</a> |
<a href="/comm-central/log/c7415baf5df07486031dd7e913f6271aecf2d5bc/mail/base/content/folderDisplay.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c7415baf5df07486031dd7e913f6271aecf2d5bc/mail/base/content/mailWindowOverlay.js">mail/base/content/mailWindowOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c7415baf5df07486031dd7e913f6271aecf2d5bc/mail/base/content/mailWindowOverlay.js">file</a> |
<a href="/comm-central/annotate/c7415baf5df07486031dd7e913f6271aecf2d5bc/mail/base/content/mailWindowOverlay.js">annotate</a> |
<a href="/comm-central/diff/c7415baf5df07486031dd7e913f6271aecf2d5bc/mail/base/content/mailWindowOverlay.js">diff</a> |
<a href="/comm-central/comparison/c7415baf5df07486031dd7e913f6271aecf2d5bc/mail/base/content/mailWindowOverlay.js">comparison</a> |
<a href="/comm-central/log/c7415baf5df07486031dd7e913f6271aecf2d5bc/mail/base/content/mailWindowOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c7415baf5df07486031dd7e913f6271aecf2d5bc/mail/base/content/messageWindow.js">mail/base/content/messageWindow.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c7415baf5df07486031dd7e913f6271aecf2d5bc/mail/base/content/messageWindow.js">file</a> |
<a href="/comm-central/annotate/c7415baf5df07486031dd7e913f6271aecf2d5bc/mail/base/content/messageWindow.js">annotate</a> |
<a href="/comm-central/diff/c7415baf5df07486031dd7e913f6271aecf2d5bc/mail/base/content/messageWindow.js">diff</a> |
<a href="/comm-central/comparison/c7415baf5df07486031dd7e913f6271aecf2d5bc/mail/base/content/messageWindow.js">comparison</a> |
<a href="/comm-central/log/c7415baf5df07486031dd7e913f6271aecf2d5bc/mail/base/content/messageWindow.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c7415baf5df07486031dd7e913f6271aecf2d5bc/mail/base/content/messenger.xul">mail/base/content/messenger.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c7415baf5df07486031dd7e913f6271aecf2d5bc/mail/base/content/messenger.xul">file</a> |
<a href="/comm-central/annotate/c7415baf5df07486031dd7e913f6271aecf2d5bc/mail/base/content/messenger.xul">annotate</a> |
<a href="/comm-central/diff/c7415baf5df07486031dd7e913f6271aecf2d5bc/mail/base/content/messenger.xul">diff</a> |
<a href="/comm-central/comparison/c7415baf5df07486031dd7e913f6271aecf2d5bc/mail/base/content/messenger.xul">comparison</a> |
<a href="/comm-central/log/c7415baf5df07486031dd7e913f6271aecf2d5bc/mail/base/content/messenger.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c7415baf5df07486031dd7e913f6271aecf2d5bc/mail/base/content/msgMail3PaneWindow.js">mail/base/content/msgMail3PaneWindow.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c7415baf5df07486031dd7e913f6271aecf2d5bc/mail/base/content/msgMail3PaneWindow.js">file</a> |
<a href="/comm-central/annotate/c7415baf5df07486031dd7e913f6271aecf2d5bc/mail/base/content/msgMail3PaneWindow.js">annotate</a> |
<a href="/comm-central/diff/c7415baf5df07486031dd7e913f6271aecf2d5bc/mail/base/content/msgMail3PaneWindow.js">diff</a> |
<a href="/comm-central/comparison/c7415baf5df07486031dd7e913f6271aecf2d5bc/mail/base/content/msgMail3PaneWindow.js">comparison</a> |
<a href="/comm-central/log/c7415baf5df07486031dd7e913f6271aecf2d5bc/mail/base/content/msgMail3PaneWindow.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c7415baf5df07486031dd7e913f6271aecf2d5bc/mail/test/mozmill/folder-display/test-columns.js">mail/test/mozmill/folder-display/test-columns.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c7415baf5df07486031dd7e913f6271aecf2d5bc/mail/test/mozmill/folder-display/test-columns.js">file</a> |
<a href="/comm-central/annotate/c7415baf5df07486031dd7e913f6271aecf2d5bc/mail/test/mozmill/folder-display/test-columns.js">annotate</a> |
<a href="/comm-central/diff/c7415baf5df07486031dd7e913f6271aecf2d5bc/mail/test/mozmill/folder-display/test-columns.js">diff</a> |
<a href="/comm-central/comparison/c7415baf5df07486031dd7e913f6271aecf2d5bc/mail/test/mozmill/folder-display/test-columns.js">comparison</a> |
<a href="/comm-central/log/c7415baf5df07486031dd7e913f6271aecf2d5bc/mail/test/mozmill/folder-display/test-columns.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c7415baf5df07486031dd7e913f6271aecf2d5bc/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">mail/test/mozmill/shared-modules/test-folder-display-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c7415baf5df07486031dd7e913f6271aecf2d5bc/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">file</a> |
<a href="/comm-central/annotate/c7415baf5df07486031dd7e913f6271aecf2d5bc/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">annotate</a> |
<a href="/comm-central/diff/c7415baf5df07486031dd7e913f6271aecf2d5bc/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">diff</a> |
<a href="/comm-central/comparison/c7415baf5df07486031dd7e913f6271aecf2d5bc/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">comparison</a> |
<a href="/comm-central/log/c7415baf5df07486031dd7e913f6271aecf2d5bc/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c7415baf5df07486031dd7e913f6271aecf2d5bc/mailnews/base/src/dbViewWrapper.js">mailnews/base/src/dbViewWrapper.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c7415baf5df07486031dd7e913f6271aecf2d5bc/mailnews/base/src/dbViewWrapper.js">file</a> |
<a href="/comm-central/annotate/c7415baf5df07486031dd7e913f6271aecf2d5bc/mailnews/base/src/dbViewWrapper.js">annotate</a> |
<a href="/comm-central/diff/c7415baf5df07486031dd7e913f6271aecf2d5bc/mailnews/base/src/dbViewWrapper.js">diff</a> |
<a href="/comm-central/comparison/c7415baf5df07486031dd7e913f6271aecf2d5bc/mailnews/base/src/dbViewWrapper.js">comparison</a> |
<a href="/comm-central/log/c7415baf5df07486031dd7e913f6271aecf2d5bc/mailnews/base/src/dbViewWrapper.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c7415baf5df07486031dd7e913f6271aecf2d5bc/mailnews/mailnews.js">mailnews/mailnews.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c7415baf5df07486031dd7e913f6271aecf2d5bc/mailnews/mailnews.js">file</a> |
<a href="/comm-central/annotate/c7415baf5df07486031dd7e913f6271aecf2d5bc/mailnews/mailnews.js">annotate</a> |
<a href="/comm-central/diff/c7415baf5df07486031dd7e913f6271aecf2d5bc/mailnews/mailnews.js">diff</a> |
<a href="/comm-central/comparison/c7415baf5df07486031dd7e913f6271aecf2d5bc/mailnews/mailnews.js">comparison</a> |
<a href="/comm-central/log/c7415baf5df07486031dd7e913f6271aecf2d5bc/mailnews/mailnews.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c7415baf5df07486031dd7e913f6271aecf2d5bc/mailnews/test/resources/viewWrapperTestUtils.js">mailnews/test/resources/viewWrapperTestUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c7415baf5df07486031dd7e913f6271aecf2d5bc/mailnews/test/resources/viewWrapperTestUtils.js">file</a> |
<a href="/comm-central/annotate/c7415baf5df07486031dd7e913f6271aecf2d5bc/mailnews/test/resources/viewWrapperTestUtils.js">annotate</a> |
<a href="/comm-central/diff/c7415baf5df07486031dd7e913f6271aecf2d5bc/mailnews/test/resources/viewWrapperTestUtils.js">diff</a> |
<a href="/comm-central/comparison/c7415baf5df07486031dd7e913f6271aecf2d5bc/mailnews/test/resources/viewWrapperTestUtils.js">comparison</a> |
<a href="/comm-central/log/c7415baf5df07486031dd7e913f6271aecf2d5bc/mailnews/test/resources/viewWrapperTestUtils.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/base/content/SearchDialog.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/base/content/SearchDialog.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -265,21 +265,22 @@ function searchOnLoad()</span>
<a href="#l1.4"></a><span id="l1.4">   gFolderDisplay.messenger = messenger;</span>
<a href="#l1.5"></a><span id="l1.5">   gFolderDisplay.msgWindow = msgWindow;</span>
<a href="#l1.6"></a><span id="l1.6">   gFolderDisplay.tree = document.getElementById(&quot;threadTree&quot;);</span>
<a href="#l1.7"></a><span id="l1.7">   gFolderDisplay.treeBox = gFolderDisplay.tree.boxObject.QueryInterface(</span>
<a href="#l1.8"></a><span id="l1.8">                              Components.interfaces.nsITreeBoxObject);</span>
<a href="#l1.9"></a><span id="l1.9">   gFolderDisplay.view.openSearchView();</span>
<a href="#l1.10"></a><span id="l1.10">   gFolderDisplay.makeActive();</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-  gFolderDisplay.setVisibleColumns({subjectCol: true,</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-                                    senderCol: true,</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-                                    dateCol: true,</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineminus">-                                    locationCol: true,</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineminus">-                                    });</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+  gFolderDisplay.setColumnStates({</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+    subjectCol: { visible: true },</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+    senderCol: { visible: true },</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+    dateCol: { visible: true },</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+    locationCol: { visible: true },</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+  });</span>
<a href="#l1.23"></a><span id="l1.23"> </span>
<a href="#l1.24"></a><span id="l1.24">   if (window.arguments &amp;&amp; window.arguments[0])</span>
<a href="#l1.25"></a><span id="l1.25">       selectFolder(window.arguments[0].folder);</span>
<a href="#l1.26"></a><span id="l1.26"> </span>
<a href="#l1.27"></a><span id="l1.27">   // trigger searchTermOverlay.js to create the first criterion</span>
<a href="#l1.28"></a><span id="l1.28">   onMore(null);</span>
<a href="#l1.29"></a><span id="l1.29">   // make sure all the buttons are configured</span>
<a href="#l1.30"></a><span id="l1.30">   UpdateMailSearch(&quot;onload&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/base/content/folderDisplay.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/base/content/folderDisplay.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -281,190 +281,308 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l2.4"></a><span id="l2.4"> </span>
<a href="#l2.5"></a><span id="l2.5">   /**</span>
<a href="#l2.6"></a><span id="l2.6">    * @name Columns</span>
<a href="#l2.7"></a><span id="l2.7">    * @protected Folder Display</span>
<a href="#l2.8"></a><span id="l2.8">    */</span>
<a href="#l2.9"></a><span id="l2.9">   //@{</span>
<a href="#l2.10"></a><span id="l2.10"> </span>
<a href="#l2.11"></a><span id="l2.11">   /**</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-   * Maps column ids to functions that test whether the column is legal for</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-   *  display for the folder.  Each function should expect a DBViewWrapper</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+   * The set of potential default columns in their default display order.  Each</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+   *  column in this list is checked against |COLUMN_DEFAULT_TESTERS| to see if</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+   *  it is actually an appropriate default for the folder type.</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+   */</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+  DEFAULT_COLUMNS: [</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+    &quot;threadCol&quot;,</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+    &quot;attachmentCol&quot;,</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+    &quot;flaggedCol&quot;,</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineplus">+    &quot;subjectCol&quot;,</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineplus">+    &quot;unreadButtonColHeader&quot;,</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineplus">+    &quot;senderCol&quot;, // incoming folders</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+    &quot;recipientCol&quot;, // outgoing folders</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineplus">+    &quot;junkStatusCol&quot;,</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineplus">+    &quot;dateCol&quot;,</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineplus">+    &quot;locationCol&quot;, // multiple-folder backed folders</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineplus">+  ],</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineplus">+</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+  /**</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+   * Maps column ids to functions that test whether the column is a good default</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+   *  for display for the folder.  Each function should expect a DBViewWrapper</span>
<a href="#l2.34"></a><span id="l2.34">    *  instance as its argument.  The intent is that the various helper</span>
<a href="#l2.35"></a><span id="l2.35">    *  properties like isMailFolder/isIncomingFolder/isOutgoingFolder allow the</span>
<a href="#l2.36"></a><span id="l2.36">    *  constraint to be expressed concisely.  If a helper does not exist, add</span>
<a href="#l2.37"></a><span id="l2.37">    *  one! (If doing so is out of reach, than access viewWrapper.displayedFolder</span>
<a href="#l2.38"></a><span id="l2.38">    *  to get at the nsIMsgFolder.)</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineminus">-   * If a column does not have a function, it is assumed to be legal for display</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineminus">-   *  in all cases.</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+   * If a column does not have a function, it is assumed that it should be</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+   *  displayed by default.</span>
<a href="#l2.43"></a><span id="l2.43">    */</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineminus">-  COLUMN_LEGALITY_TESTERS: {</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineminus">-    // Only show 'Received' column for e-mails.  For newsgroup messages, the</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineminus">-    // 'Date' header is as reliable as an e-mail's 'Received' header, as it is</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineminus">-    // replaced with the news server's (more reliable) date.</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineminus">-    receivedCol: function (viewWrapper) {</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineminus">-      return viewWrapper.isMailFolder &amp;&amp; !viewWrapper.isOutgoingFolder;</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineminus">-    },</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+  COLUMN_DEFAULT_TESTERS: {</span>
<a href="#l2.52"></a><span id="l2.52">     // senderCol = From.  You only care in incoming folders.</span>
<a href="#l2.53"></a><span id="l2.53">     senderCol: function (viewWrapper) {</span>
<a href="#l2.54"></a><span id="l2.54">       return viewWrapper.isIncomingFolder;</span>
<a href="#l2.55"></a><span id="l2.55">     },</span>
<a href="#l2.56"></a><span id="l2.56">     // recipient = To. You only care in outgoing folders.</span>
<a href="#l2.57"></a><span id="l2.57">     recipientCol: function (viewWrapper) {</span>
<a href="#l2.58"></a><span id="l2.58">       return viewWrapper.isOutgoingFolder;</span>
<a href="#l2.59"></a><span id="l2.59">     },</span>
<a href="#l2.60"></a><span id="l2.60">     // Only show the location column for non-single-folder results</span>
<a href="#l2.61"></a><span id="l2.61">     locationCol: function(viewWrapper) {</span>
<a href="#l2.62"></a><span id="l2.62">       return !viewWrapper.isSingleFolder;</span>
<a href="#l2.63"></a><span id="l2.63">     },</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineplus">+    // core UI does not provide an ability to mark newsgroup messages as spam</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineplus">+    junkStatusCol: function(viewWrapper) {</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineplus">+      return !viewWrapper.isNewsFolder;</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineplus">+    },</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineplus">+  },</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineplus">+</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineplus">+  /**</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineplus">+   * The property name we use to store the column states on the</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineplus">+   *  dbFolderInfo.</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineplus">+   */</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineplus">+  PERSISTED_COLUMN_PROPERTY_NAME: &quot;columnStates&quot;,</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineplus">+</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineplus">+  /**</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineplus">+   * Given a dbFolderInfo, extract the persisted state from it if there is any.</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineplus">+   *</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineplus">+   * @return null if there was no persisted state, the persisted state in object</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineplus">+   *     form otherwise.  (Ideally the state conforms to the documentation on</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineplus">+   *     |_savedColumnStates| but we can't stop people from doing bad things.)</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineplus">+   */</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineplus">+  _depersistColumnStatesFromDbFolderInfo:</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineplus">+      function FolderDisplayWidget__depersistColumnStatesFromDBFolderInfo(</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineplus">+        aDbFolderInfo) {</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineplus">+    let columnJsonString =</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineplus">+      aDbFolderInfo.getCharProperty(this.PERSISTED_COLUMN_PROPERTY_NAME);</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineplus">+    if (!columnJsonString)</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineplus">+      return null;</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineplus">+</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineplus">+    return JSON.parse(columnJsonString);</span>
<a href="#l2.92"></a><span id="l2.92">   },</span>
<a href="#l2.93"></a><span id="l2.93"> </span>
<a href="#l2.94"></a><span id="l2.94">   /**</span>
<a href="#l2.95"></a><span id="l2.95" class="difflineminus">-   * If we determine that a column is illegal but was displayed, use this</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineminus">-   *  mapping to find suggested legal alternatives.  This basically exists</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineminus">-   *  just to flip-flop between senderCol and recipientCol.</span>
<a href="#l2.98"></a><span id="l2.98" class="difflineplus">+   * Persist the column state for the currently displayed folder.  We are</span>
<a href="#l2.99"></a><span id="l2.99" class="difflineplus">+   *  assuming that the message database is already open when we are called and</span>
<a href="#l2.100"></a><span id="l2.100" class="difflineplus">+   *  therefore that we do not need to worry about cleaning up after the message</span>
<a href="#l2.101"></a><span id="l2.101" class="difflineplus">+   *  database.</span>
<a href="#l2.102"></a><span id="l2.102" class="difflineplus">+   * The caller should only call this when they have reason to suspect that the</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineplus">+   *  column state has been changed.  This could be because there was no</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineplus">+   *  persisted state so we figured out a default one and want to save it.</span>
<a href="#l2.105"></a><span id="l2.105" class="difflineplus">+   *  Otherwise this should be because the user explicitly changed up the column</span>
<a href="#l2.106"></a><span id="l2.106" class="difflineplus">+   *  configurations.  You should not call this willy-nilly.</span>
<a href="#l2.107"></a><span id="l2.107" class="difflineplus">+   *</span>
<a href="#l2.108"></a><span id="l2.108" class="difflineplus">+   * @param aState State to persist.</span>
<a href="#l2.109"></a><span id="l2.109">    */</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineminus">-  COLUMN_LEGAL_ALTERNATIVES: {</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineminus">-    // swap between sender and recipient</span>
<a href="#l2.112"></a><span id="l2.112" class="difflineminus">-    senderCol: [&quot;recipientCol&quot;],</span>
<a href="#l2.113"></a><span id="l2.113" class="difflineminus">-    recipientCol: [&quot;senderCol&quot;],</span>
<a href="#l2.114"></a><span id="l2.114" class="difflineminus">-    // if we nuke received, put back date...</span>
<a href="#l2.115"></a><span id="l2.115" class="difflineminus">-    receivedCol: [&quot;dateCol&quot;],</span>
<a href="#l2.116"></a><span id="l2.116" class="difflineplus">+  _persistColumnStates: function FolderDisplayWidget__persistColumnStates(aState) {</span>
<a href="#l2.117"></a><span id="l2.117" class="difflineplus">+    if (!this.view.displayedFolder || !this.view.displayedFolder.msgDatabase)</span>
<a href="#l2.118"></a><span id="l2.118" class="difflineplus">+      return;</span>
<a href="#l2.119"></a><span id="l2.119" class="difflineplus">+    let msgDatabase = this.view.displayedFolder.msgDatabase;</span>
<a href="#l2.120"></a><span id="l2.120" class="difflineplus">+    let dbFolderInfo = msgDatabase.dBFolderInfo;</span>
<a href="#l2.121"></a><span id="l2.121" class="difflineplus">+    dbFolderInfo.setCharProperty(this.PERSISTED_COLUMN_PROPERTY_NAME,</span>
<a href="#l2.122"></a><span id="l2.122" class="difflineplus">+                                 JSON.stringify(aState));</span>
<a href="#l2.123"></a><span id="l2.123" class="difflineplus">+    msgDatabase.Commit(Components.interfaces.nsMsgDBCommitType.kSmallCommit);</span>
<a href="#l2.124"></a><span id="l2.124" class="difflineplus">+  },</span>
<a href="#l2.125"></a><span id="l2.125" class="difflineplus">+</span>
<a href="#l2.126"></a><span id="l2.126" class="difflineplus">+  /**</span>
<a href="#l2.127"></a><span id="l2.127" class="difflineplus">+   * Track whether we know the columns are dirty.  If we know they are dirty we</span>
<a href="#l2.128"></a><span id="l2.128" class="difflineplus">+   *  have kicked off a timer event that will persist things.</span>
<a href="#l2.129"></a><span id="l2.129" class="difflineplus">+   */</span>
<a href="#l2.130"></a><span id="l2.130" class="difflineplus">+  _columnsDirty: false,</span>
<a href="#l2.131"></a><span id="l2.131" class="difflineplus">+</span>
<a href="#l2.132"></a><span id="l2.132" class="difflineplus">+  /**</span>
<a href="#l2.133"></a><span id="l2.133" class="difflineplus">+   * Let us know that the state of the columns has changed.  This is either due</span>
<a href="#l2.134"></a><span id="l2.134" class="difflineplus">+   *  to a re-ordering or hidden-ness being toggled.</span>
<a href="#l2.135"></a><span id="l2.135" class="difflineplus">+   *</span>
<a href="#l2.136"></a><span id="l2.136" class="difflineplus">+   * This method should only be called on (the active) gFolderDisplay.</span>
<a href="#l2.137"></a><span id="l2.137" class="difflineplus">+   */</span>
<a href="#l2.138"></a><span id="l2.138" class="difflineplus">+  hintColumnsChanged: function FolderDisplayWidget_hintColumnsChanged() {</span>
<a href="#l2.139"></a><span id="l2.139" class="difflineplus">+    // ignore this if we are the ones doing things or we already are handling it</span>
<a href="#l2.140"></a><span id="l2.140" class="difflineplus">+    if (this._touchingColumns || this._columnsDirty)</span>
<a href="#l2.141"></a><span id="l2.141" class="difflineplus">+      return;</span>
<a href="#l2.142"></a><span id="l2.142" class="difflineplus">+    this._columnsDirty = true;</span>
<a href="#l2.143"></a><span id="l2.143" class="difflineplus">+    let dis = this;</span>
<a href="#l2.144"></a><span id="l2.144" class="difflineplus">+    // Since DOM manipulations come in batches, use a timer so that we persist</span>
<a href="#l2.145"></a><span id="l2.145" class="difflineplus">+    //  things after the DOM manipulating code has finished its business.</span>
<a href="#l2.146"></a><span id="l2.146" class="difflineplus">+    window.setTimeout(function () {</span>
<a href="#l2.147"></a><span id="l2.147" class="difflineplus">+                        dis._persistColumnStates(dis.getColumnStates());</span>
<a href="#l2.148"></a><span id="l2.148" class="difflineplus">+                        dis._columnsDirty = false;</span>
<a href="#l2.149"></a><span id="l2.149" class="difflineplus">+                      },</span>
<a href="#l2.150"></a><span id="l2.150" class="difflineplus">+                      0);</span>
<a href="#l2.151"></a><span id="l2.151">   },</span>
<a href="#l2.152"></a><span id="l2.152"> </span>
<a href="#l2.153"></a><span id="l2.153">   /**</span>
<a href="#l2.154"></a><span id="l2.154" class="difflineminus">-   * Columns to display whenever we can.  This is currently a bit of a hack to</span>
<a href="#l2.155"></a><span id="l2.155" class="difflineminus">-   *  always show the location column when relevant.  Arguably, it would be</span>
<a href="#l2.156"></a><span id="l2.156" class="difflineminus">-   *  better to use this as a default for a folder you've never been in and</span>
<a href="#l2.157"></a><span id="l2.157" class="difflineminus">-   *  the rest of the time we restore the last column set for that folder from</span>
<a href="#l2.158"></a><span id="l2.158" class="difflineminus">-   *  properties.</span>
<a href="#l2.159"></a><span id="l2.159" class="difflineplus">+   * Either inherit the column state of another folder or use heuristics to</span>
<a href="#l2.160"></a><span id="l2.160" class="difflineplus">+   *  figure out the best column state for the current folder.</span>
<a href="#l2.161"></a><span id="l2.161">    */</span>
<a href="#l2.162"></a><span id="l2.162" class="difflineminus">-  COLUMNS_DISPLAY_WHEN_POSSIBLE: [&quot;locationCol&quot;],</span>
<a href="#l2.163"></a><span id="l2.163" class="difflineminus">-</span>
<a href="#l2.164"></a><span id="l2.164" class="difflineminus">-  /**</span>
<a href="#l2.165"></a><span id="l2.165" class="difflineminus">-   * Update the displayed columns so that:</span>
<a href="#l2.166"></a><span id="l2.166" class="difflineminus">-   * - Only legal columns (per COLUMN_LEGALITY_TESTERS) are displayed.</span>
<a href="#l2.167"></a><span id="l2.167" class="difflineminus">-   * - Alternatives to now-illegal columns may be displayed.</span>
<a href="#l2.168"></a><span id="l2.168" class="difflineminus">-   */</span>
<a href="#l2.169"></a><span id="l2.169" class="difflineminus">-  updateColumns: function() {</span>
<a href="#l2.170"></a><span id="l2.170" class="difflineminus">-    // Keep a list of columns we might want to make show up if they are not</span>
<a href="#l2.171"></a><span id="l2.171" class="difflineminus">-    //  illegal.</span>
<a href="#l2.172"></a><span id="l2.172" class="difflineminus">-    let legalize = this.COLUMNS_DISPLAY_WHEN_POSSIBLE.concat();</span>
<a href="#l2.173"></a><span id="l2.173" class="difflineplus">+  _getDefaultColumnsForCurrentFolder:</span>
<a href="#l2.174"></a><span id="l2.174" class="difflineplus">+      function FolderDisplayWidget__getDefaultColumnsForCurrentFolder() {</span>
<a href="#l2.175"></a><span id="l2.175" class="difflineplus">+    const InboxFlag = Components.interfaces.nsMsgFolderFlags.Inbox;</span>
<a href="#l2.176"></a><span id="l2.176"> </span>
<a href="#l2.177"></a><span id="l2.177" class="difflineminus">-    // figure out who is illegal and make them go away</span>
<a href="#l2.178"></a><span id="l2.178" class="difflineminus">-    for (let [colId, legalityFunc] in Iterator(this.COLUMN_LEGALITY_TESTERS)) {</span>
<a href="#l2.179"></a><span id="l2.179" class="difflineminus">-      let column = document.getElementById(colId);</span>
<a href="#l2.180"></a><span id="l2.180" class="difflineminus">-      // The search window does not have all the columns we know about, bail in</span>
<a href="#l2.181"></a><span id="l2.181" class="difflineminus">-      //  such cases.</span>
<a href="#l2.182"></a><span id="l2.182" class="difflineminus">-      if (!column)</span>
<a href="#l2.183"></a><span id="l2.183" class="difflineminus">-        continue;</span>
<a href="#l2.184"></a><span id="l2.184" class="difflineminus">-      let legal = legalityFunc(this.view);</span>
<a href="#l2.185"></a><span id="l2.185" class="difflineplus">+    // do not inherit from the inbox if:</span>
<a href="#l2.186"></a><span id="l2.186" class="difflineplus">+    // - It's an outgoing folder; these have a different use-case and there</span>
<a href="#l2.187"></a><span id="l2.187" class="difflineplus">+    //    should be a small number of these, so it's okay to have no defaults.</span>
<a href="#l2.188"></a><span id="l2.188" class="difflineplus">+    // - It's a virtual folder (single or multi-folder backed).  Who knows what</span>
<a href="#l2.189"></a><span id="l2.189" class="difflineplus">+    //    the intent of the user is in this case.  This should also be bounded</span>
<a href="#l2.190"></a><span id="l2.190" class="difflineplus">+    //    in number and our default heuristics should be pretty good.</span>
<a href="#l2.191"></a><span id="l2.191" class="difflineplus">+    // - News folders.  There is no inbox so there's nothing to inherit from.</span>
<a href="#l2.192"></a><span id="l2.192" class="difflineplus">+    //    (Although we could try and see if they have opened any other news</span>
<a href="#l2.193"></a><span id="l2.193" class="difflineplus">+    //    folders in the same account.  But it's not all that important to us.)</span>
<a href="#l2.194"></a><span id="l2.194" class="difflineplus">+    // - It's an inbox!</span>
<a href="#l2.195"></a><span id="l2.195" class="difflineplus">+    let doNotInherit =</span>
<a href="#l2.196"></a><span id="l2.196" class="difflineplus">+      this.view.isOutgoingFolder ||</span>
<a href="#l2.197"></a><span id="l2.197" class="difflineplus">+      this.view.isVirtual ||</span>
<a href="#l2.198"></a><span id="l2.198" class="difflineplus">+      this.view.isNewsFolder ||</span>
<a href="#l2.199"></a><span id="l2.199" class="difflineplus">+      this.displayedFolder.flags &amp; InboxFlag;</span>
<a href="#l2.200"></a><span id="l2.200"> </span>
<a href="#l2.201"></a><span id="l2.201" class="difflineminus">-      if (!legal) {</span>
<a href="#l2.202"></a><span id="l2.202" class="difflineminus">-        let isHidden = column.getAttribute(&quot;hidden&quot;) == &quot;true&quot;;</span>
<a href="#l2.203"></a><span id="l2.203" class="difflineminus">-        // If it wasn't hidden, consider making its alternatives visible in the</span>
<a href="#l2.204"></a><span id="l2.204" class="difflineminus">-        //  next pass.</span>
<a href="#l2.205"></a><span id="l2.205" class="difflineminus">-        if (!isHidden &amp;&amp; (colId in this.COLUMN_LEGAL_ALTERNATIVES))</span>
<a href="#l2.206"></a><span id="l2.206" class="difflineminus">-          legalize = legalize.concat(this.COLUMN_LEGAL_ALTERNATIVES[colId]);</span>
<a href="#l2.207"></a><span id="l2.207" class="difflineminus">-        // but definitely hide the heck out of it right now</span>
<a href="#l2.208"></a><span id="l2.208" class="difflineminus">-        column.setAttribute(&quot;hidden&quot;, true);</span>
<a href="#l2.209"></a><span id="l2.209" class="difflineminus">-        column.setAttribute(&quot;ignoreincolumnpicker&quot;, true);</span>
<a href="#l2.210"></a><span id="l2.210" class="difflineminus">-      }</span>
<a href="#l2.211"></a><span id="l2.211" class="difflineminus">-      else {</span>
<a href="#l2.212"></a><span id="l2.212" class="difflineminus">-        column.removeAttribute(&quot;ignoreincolumnpicker&quot;);</span>
<a href="#l2.213"></a><span id="l2.213" class="difflineplus">+    // Try and grab the inbox for this account's settings.  we may not be able</span>
<a href="#l2.214"></a><span id="l2.214" class="difflineplus">+    //  to, in which case we just won't inherit.  (It ends up the same since the</span>
<a href="#l2.215"></a><span id="l2.215" class="difflineplus">+    //  inbox is obviously not customized in this case.)</span>
<a href="#l2.216"></a><span id="l2.216" class="difflineplus">+    if (!doNotInherit) {</span>
<a href="#l2.217"></a><span id="l2.217" class="difflineplus">+      let inboxFolder =</span>
<a href="#l2.218"></a><span id="l2.218" class="difflineplus">+        this.displayedFolder.rootFolder.getFolderWithFlags(InboxFlag);</span>
<a href="#l2.219"></a><span id="l2.219" class="difflineplus">+      if (inboxFolder) {</span>
<a href="#l2.220"></a><span id="l2.220" class="difflineplus">+        let state = this._depersistColumnStatesFromDbFolderInfo(</span>
<a href="#l2.221"></a><span id="l2.221" class="difflineplus">+                      inboxFolder.msgDatabase.dBFolderInfo);</span>
<a href="#l2.222"></a><span id="l2.222" class="difflineplus">+        // inbox message databases don't get closed as a matter of policy.</span>
<a href="#l2.223"></a><span id="l2.223" class="difflineplus">+</span>
<a href="#l2.224"></a><span id="l2.224" class="difflineplus">+        if (state)</span>
<a href="#l2.225"></a><span id="l2.225" class="difflineplus">+          return state;</span>
<a href="#l2.226"></a><span id="l2.226">       }</span>
<a href="#l2.227"></a><span id="l2.227">     }</span>
<a href="#l2.228"></a><span id="l2.228" class="difflineminus">-    // If we have any columns we should consider making visible because they are</span>
<a href="#l2.229"></a><span id="l2.229" class="difflineminus">-    //  alternatives to columns that became illegal, uh, do that.</span>
<a href="#l2.230"></a><span id="l2.230" class="difflineminus">-    for each (let [, colId] in Iterator(legalize)) {</span>
<a href="#l2.231"></a><span id="l2.231" class="difflineminus">-      let column = document.getElementById(colId);</span>
<a href="#l2.232"></a><span id="l2.232" class="difflineminus">-      let isLegal = column.getAttribute(&quot;ignoreincolumnpicker&quot;) != &quot;true&quot;;</span>
<a href="#l2.233"></a><span id="l2.233" class="difflineminus">-      let isHidden = column.getAttribute(&quot;hidden&quot;) == &quot;true&quot;;</span>
<a href="#l2.234"></a><span id="l2.234" class="difflineminus">-      if (isLegal &amp;&amp; isHidden)</span>
<a href="#l2.235"></a><span id="l2.235" class="difflineminus">-        column.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l2.236"></a><span id="l2.236" class="difflineplus">+</span>
<a href="#l2.237"></a><span id="l2.237" class="difflineplus">+    // if we are still here, use the defaults and helper functions</span>
<a href="#l2.238"></a><span id="l2.238" class="difflineplus">+    let state = {};</span>
<a href="#l2.239"></a><span id="l2.239" class="difflineplus">+    for (let [, colId] in Iterator(this.DEFAULT_COLUMNS)) {</span>
<a href="#l2.240"></a><span id="l2.240" class="difflineplus">+      let shouldShowColumn = true;</span>
<a href="#l2.241"></a><span id="l2.241" class="difflineplus">+      if (colId in this.COLUMN_DEFAULT_TESTERS) {</span>
<a href="#l2.242"></a><span id="l2.242" class="difflineplus">+        // This is potentially going to be used by extensions; avoid them</span>
<a href="#l2.243"></a><span id="l2.243" class="difflineplus">+        //  killing us.</span>
<a href="#l2.244"></a><span id="l2.244" class="difflineplus">+        try {</span>
<a href="#l2.245"></a><span id="l2.245" class="difflineplus">+          shouldShowColumn = this.COLUMN_DEFAULT_TESTERS[colId](this.view);</span>
<a href="#l2.246"></a><span id="l2.246" class="difflineplus">+        }</span>
<a href="#l2.247"></a><span id="l2.247" class="difflineplus">+        catch (ex) {</span>
<a href="#l2.248"></a><span id="l2.248" class="difflineplus">+          shouldShowColumn = false;</span>
<a href="#l2.249"></a><span id="l2.249" class="difflineplus">+          Components.utils.reportError(ex);</span>
<a href="#l2.250"></a><span id="l2.250" class="difflineplus">+        }</span>
<a href="#l2.251"></a><span id="l2.251" class="difflineplus">+      }</span>
<a href="#l2.252"></a><span id="l2.252" class="difflineplus">+      state[colId] = {visible: shouldShowColumn};</span>
<a href="#l2.253"></a><span id="l2.253">     }</span>
<a href="#l2.254"></a><span id="l2.254" class="difflineplus">+    return state;</span>
<a href="#l2.255"></a><span id="l2.255">   },</span>
<a href="#l2.256"></a><span id="l2.256"> </span>
<a href="#l2.257"></a><span id="l2.257">   /**</span>
<a href="#l2.258"></a><span id="l2.258" class="difflineminus">-   * @param aColumnMap an object where the attribute names are column ids and</span>
<a href="#l2.259"></a><span id="l2.259" class="difflineminus">-   *     the values are a boolean indicating whether the column should be</span>
<a href="#l2.260"></a><span id="l2.260" class="difflineminus">-   *     visible or not.  If a column is not in the map, it is assumed that it</span>
<a href="#l2.261"></a><span id="l2.261" class="difflineminus">-   *     should be hidden.</span>
<a href="#l2.262"></a><span id="l2.262" class="difflineplus">+   * Is setColumnStates messing with the columns' DOM?  This is used by</span>
<a href="#l2.263"></a><span id="l2.263" class="difflineplus">+   *  hintColumnsChanged to avoid wasteful state persistence.</span>
<a href="#l2.264"></a><span id="l2.264">    */</span>
<a href="#l2.265"></a><span id="l2.265" class="difflineminus">-  setVisibleColumns: function(aColumnMap) {</span>
<a href="#l2.266"></a><span id="l2.266" class="difflineminus">-    let cols = document.getElementById(&quot;threadCols&quot;);</span>
<a href="#l2.267"></a><span id="l2.267" class="difflineminus">-    let colChildren = cols.children;</span>
<a href="#l2.268"></a><span id="l2.268" class="difflineplus">+  _touchingColumns: false,</span>
<a href="#l2.269"></a><span id="l2.269"> </span>
<a href="#l2.270"></a><span id="l2.270" class="difflineminus">-    // because the splitter correspondence can be confusing and tricky, let's</span>
<a href="#l2.271"></a><span id="l2.271" class="difflineminus">-    //  build a list of the nodes ordered by their ordinal</span>
<a href="#l2.272"></a><span id="l2.272" class="difflineminus">-    let ordinalOrdered = [], iKid;</span>
<a href="#l2.273"></a><span id="l2.273" class="difflineminus">-    for (iKid = 0; iKid &lt; colChildren.length; iKid++)</span>
<a href="#l2.274"></a><span id="l2.274" class="difflineminus">-      ordinalOrdered.push(null);</span>
<a href="#l2.275"></a><span id="l2.275" class="difflineminus">-</span>
<a href="#l2.276"></a><span id="l2.276" class="difflineminus">-    for (iKid = 0; iKid &lt; colChildren.length; iKid++) {</span>
<a href="#l2.277"></a><span id="l2.277" class="difflineminus">-      let colChild = colChildren[iKid];</span>
<a href="#l2.278"></a><span id="l2.278" class="difflineminus">-      let ordinal = colChild.getAttribute(&quot;ordinal&quot;) - 1;</span>
<a href="#l2.279"></a><span id="l2.279" class="difflineminus">-      ordinalOrdered[ordinal] = colChild;</span>
<a href="#l2.280"></a><span id="l2.280" class="difflineplus">+  /**</span>
<a href="#l2.281"></a><span id="l2.281" class="difflineplus">+   * Set the column states of this FolderDisplay to the provided state.</span>
<a href="#l2.282"></a><span id="l2.282" class="difflineplus">+   *</span>
<a href="#l2.283"></a><span id="l2.283" class="difflineplus">+   * @param aColumnStates an object of the form described on</span>
<a href="#l2.284"></a><span id="l2.284" class="difflineplus">+   *     |_savedColumnStates|.  If ordinal attributes are omitted then no</span>
<a href="#l2.285"></a><span id="l2.285" class="difflineplus">+   *     re-ordering will be performed.  This is intentional, but potentially a</span>
<a href="#l2.286"></a><span id="l2.286" class="difflineplus">+   *     bad idea.  (Right now only gloda search underspecifies ordinals.)</span>
<a href="#l2.287"></a><span id="l2.287" class="difflineplus">+   * @param [aPersistChanges=false] Should we persist the changes to the view?</span>
<a href="#l2.288"></a><span id="l2.288" class="difflineplus">+   *     This only has an effect if we are active.</span>
<a href="#l2.289"></a><span id="l2.289" class="difflineplus">+   *</span>
<a href="#l2.290"></a><span id="l2.290" class="difflineplus">+   * @public</span>
<a href="#l2.291"></a><span id="l2.291" class="difflineplus">+   */</span>
<a href="#l2.292"></a><span id="l2.292" class="difflineplus">+  setColumnStates: function(aColumnStates, aPersistChanges) {</span>
<a href="#l2.293"></a><span id="l2.293" class="difflineplus">+    // If we are not active, just overwrite our current state with the provided</span>
<a href="#l2.294"></a><span id="l2.294" class="difflineplus">+    //  state and bail.</span>
<a href="#l2.295"></a><span id="l2.295" class="difflineplus">+    if (!this._active) {</span>
<a href="#l2.296"></a><span id="l2.296" class="difflineplus">+      this._savedColumnStates = aColumnStates;</span>
<a href="#l2.297"></a><span id="l2.297" class="difflineplus">+      return;</span>
<a href="#l2.298"></a><span id="l2.298">     }</span>
<a href="#l2.299"></a><span id="l2.299"> </span>
<a href="#l2.300"></a><span id="l2.300" class="difflineminus">-    function twiddleAround(index, makeHidden) {</span>
<a href="#l2.301"></a><span id="l2.301" class="difflineminus">-      if (index + 1 &lt; ordinalOrdered.length) {</span>
<a href="#l2.302"></a><span id="l2.302" class="difflineminus">-        let nexty = ordinalOrdered[index+1];</span>
<a href="#l2.303"></a><span id="l2.303" class="difflineminus">-        if (nexty) {</span>
<a href="#l2.304"></a><span id="l2.304" class="difflineminus">-          let isHidden = nexty.getAttribute(&quot;hidden&quot;) == &quot;true&quot;;</span>
<a href="#l2.305"></a><span id="l2.305" class="difflineminus">-          if (isHidden != makeHidden) {</span>
<a href="#l2.306"></a><span id="l2.306" class="difflineminus">-            nexty.setAttribute(&quot;hidden&quot;, true);</span>
<a href="#l2.307"></a><span id="l2.307" class="difflineminus">-            return;</span>
<a href="#l2.308"></a><span id="l2.308" class="difflineplus">+    this._touchingColumns = true;</span>
<a href="#l2.309"></a><span id="l2.309" class="difflineplus">+</span>
<a href="#l2.310"></a><span id="l2.310" class="difflineplus">+    try {</span>
<a href="#l2.311"></a><span id="l2.311" class="difflineplus">+      let cols = document.getElementById(&quot;threadCols&quot;);</span>
<a href="#l2.312"></a><span id="l2.312" class="difflineplus">+      let colChildren = cols.children;</span>
<a href="#l2.313"></a><span id="l2.313" class="difflineplus">+</span>
<a href="#l2.314"></a><span id="l2.314" class="difflineplus">+      for (let iKid = 0; iKid &lt; colChildren.length; iKid++) {</span>
<a href="#l2.315"></a><span id="l2.315" class="difflineplus">+        let colChild = colChildren[iKid];</span>
<a href="#l2.316"></a><span id="l2.316" class="difflineplus">+        if (colChild == null)</span>
<a href="#l2.317"></a><span id="l2.317" class="difflineplus">+          continue;</span>
<a href="#l2.318"></a><span id="l2.318" class="difflineplus">+</span>
<a href="#l2.319"></a><span id="l2.319" class="difflineplus">+        // We only care about treecols.  The splitters do not need to be marked</span>
<a href="#l2.320"></a><span id="l2.320" class="difflineplus">+        //  hidden or un-hidden.</span>
<a href="#l2.321"></a><span id="l2.321" class="difflineplus">+        if (colChild.tagName == &quot;treecol&quot;) {</span>
<a href="#l2.322"></a><span id="l2.322" class="difflineplus">+          // if it doesn't have preserved state it should be hidden</span>
<a href="#l2.323"></a><span id="l2.323" class="difflineplus">+          let shouldBeHidden = true;</span>
<a href="#l2.324"></a><span id="l2.324" class="difflineplus">+          // restore state</span>
<a href="#l2.325"></a><span id="l2.325" class="difflineplus">+          if (colChild.id in aColumnStates) {</span>
<a href="#l2.326"></a><span id="l2.326" class="difflineplus">+            let colState = aColumnStates[colChild.id];</span>
<a href="#l2.327"></a><span id="l2.327" class="difflineplus">+            if (&quot;visible&quot; in colState)</span>
<a href="#l2.328"></a><span id="l2.328" class="difflineplus">+              shouldBeHidden = !colState.visible;</span>
<a href="#l2.329"></a><span id="l2.329" class="difflineplus">+            if ((&quot;ordinal&quot; in colState) &amp;&amp;</span>
<a href="#l2.330"></a><span id="l2.330" class="difflineplus">+                colChild.getAttribute(&quot;ordinal&quot;) != colState.ordinal)</span>
<a href="#l2.331"></a><span id="l2.331" class="difflineplus">+              colChild.setAttribute(&quot;ordinal&quot;, colState.ordinal);</span>
<a href="#l2.332"></a><span id="l2.332">           }</span>
<a href="#l2.333"></a><span id="l2.333" class="difflineminus">-        }</span>
<a href="#l2.334"></a><span id="l2.334" class="difflineminus">-      }</span>
<a href="#l2.335"></a><span id="l2.335" class="difflineminus">-      if (index - 1 &gt; 0) {</span>
<a href="#l2.336"></a><span id="l2.336" class="difflineminus">-        let prevy = ordinalOrdered[index-1];</span>
<a href="#l2.337"></a><span id="l2.337" class="difflineminus">-        if (prevy) {</span>
<a href="#l2.338"></a><span id="l2.338" class="difflineminus">-          let isHidden = prevy.getAttribute(&quot;hidden&quot;) == &quot;true&quot;;</span>
<a href="#l2.339"></a><span id="l2.339" class="difflineminus">-          if (isHidden != makeHidden) {</span>
<a href="#l2.340"></a><span id="l2.340" class="difflineminus">-            prevy.setAttribute(&quot;hidden&quot;, true);</span>
<a href="#l2.341"></a><span id="l2.341" class="difflineminus">-            return;</span>
<a href="#l2.342"></a><span id="l2.342" class="difflineplus">+          let isHidden = colChild.getAttribute(&quot;hidden&quot;) == &quot;true&quot;;</span>
<a href="#l2.343"></a><span id="l2.343" class="difflineplus">+          if (isHidden != shouldBeHidden) {</span>
<a href="#l2.344"></a><span id="l2.344" class="difflineplus">+            if (shouldBeHidden)</span>
<a href="#l2.345"></a><span id="l2.345" class="difflineplus">+              colChild.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l2.346"></a><span id="l2.346" class="difflineplus">+            else</span>
<a href="#l2.347"></a><span id="l2.347" class="difflineplus">+              colChild.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l2.348"></a><span id="l2.348">           }</span>
<a href="#l2.349"></a><span id="l2.349">         }</span>
<a href="#l2.350"></a><span id="l2.350">       }</span>
<a href="#l2.351"></a><span id="l2.351">     }</span>
<a href="#l2.352"></a><span id="l2.352" class="difflineminus">-</span>
<a href="#l2.353"></a><span id="l2.353" class="difflineminus">-    for (iKid = 0; iKid &lt; ordinalOrdered.length; iKid++) {</span>
<a href="#l2.354"></a><span id="l2.354" class="difflineminus">-      let colChild = ordinalOrdered[iKid];</span>
<a href="#l2.355"></a><span id="l2.355" class="difflineminus">-      if (colChild == null)</span>
<a href="#l2.356"></a><span id="l2.356" class="difflineminus">-        continue;</span>
<a href="#l2.357"></a><span id="l2.357" class="difflineplus">+    finally {</span>
<a href="#l2.358"></a><span id="l2.358" class="difflineplus">+      this._touchingColumns = false;</span>
<a href="#l2.359"></a><span id="l2.359" class="difflineplus">+    }</span>
<a href="#l2.360"></a><span id="l2.360"> </span>
<a href="#l2.361"></a><span id="l2.361" class="difflineminus">-      if (colChild.tagName == &quot;treecol&quot;) {</span>
<a href="#l2.362"></a><span id="l2.362" class="difflineminus">-        if (colChild.id in aColumnMap) {</span>
<a href="#l2.363"></a><span id="l2.363" class="difflineminus">-          // only need to do something if currently hidden</span>
<a href="#l2.364"></a><span id="l2.364" class="difflineminus">-          if (colChild.getAttribute(&quot;hidden&quot;) == &quot;true&quot;) {</span>
<a href="#l2.365"></a><span id="l2.365" class="difflineminus">-            colChild.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l2.366"></a><span id="l2.366" class="difflineminus">-            twiddleAround(iKid, false);</span>
<a href="#l2.367"></a><span id="l2.367" class="difflineminus">-          }</span>
<a href="#l2.368"></a><span id="l2.368" class="difflineminus">-        }</span>
<a href="#l2.369"></a><span id="l2.369" class="difflineminus">-        else {</span>
<a href="#l2.370"></a><span id="l2.370" class="difflineminus">-          // only need to do something if currently visible</span>
<a href="#l2.371"></a><span id="l2.371" class="difflineminus">-          if (colChild.getAttribute(&quot;hidden&quot;) != &quot;true&quot;) {</span>
<a href="#l2.372"></a><span id="l2.372" class="difflineminus">-            colChild.setAttribute(&quot;hidden&quot;, true);</span>
<a href="#l2.373"></a><span id="l2.373" class="difflineminus">-            twiddleAround(iKid, true);</span>
<a href="#l2.374"></a><span id="l2.374" class="difflineminus">-          }</span>
<a href="#l2.375"></a><span id="l2.375" class="difflineminus">-        }</span>
<a href="#l2.376"></a><span id="l2.376" class="difflineminus">-      }</span>
<a href="#l2.377"></a><span id="l2.377" class="difflineminus">-    }</span>
<a href="#l2.378"></a><span id="l2.378" class="difflineplus">+    if (aPersistChanges)</span>
<a href="#l2.379"></a><span id="l2.379" class="difflineplus">+      this.hintColumnsChanged();</span>
<a href="#l2.380"></a><span id="l2.380">   },</span>
<a href="#l2.381"></a><span id="l2.381"> </span>
<a href="#l2.382"></a><span id="l2.382" class="difflineplus">+  /**</span>
<a href="#l2.383"></a><span id="l2.383" class="difflineplus">+   * A dictionary that maps column ids to dictionaries where each dictionary</span>
<a href="#l2.384"></a><span id="l2.384" class="difflineplus">+   *  has the following fields:</span>
<a href="#l2.385"></a><span id="l2.385" class="difflineplus">+   * - visible: Is the column visible.</span>
<a href="#l2.386"></a><span id="l2.386" class="difflineplus">+   * - ordinal: The 1-based XUL 'ordinal' value assigned to the column.  This</span>
<a href="#l2.387"></a><span id="l2.387" class="difflineplus">+   *    corresponds to the position but is not something you want to manipulate.</span>
<a href="#l2.388"></a><span id="l2.388" class="difflineplus">+   *    See the documentation in _saveColumnStates for more information.</span>
<a href="#l2.389"></a><span id="l2.389" class="difflineplus">+   */</span>
<a href="#l2.390"></a><span id="l2.390">   _savedColumnStates: null,</span>
<a href="#l2.391"></a><span id="l2.391"> </span>
<a href="#l2.392"></a><span id="l2.392">   /**</span>
<a href="#l2.393"></a><span id="l2.393" class="difflineplus">+   * Return a dictionary in the form of |_savedColumnStates| representing the</span>
<a href="#l2.394"></a><span id="l2.394" class="difflineplus">+   *  current column states.</span>
<a href="#l2.395"></a><span id="l2.395" class="difflineplus">+   *</span>
<a href="#l2.396"></a><span id="l2.396" class="difflineplus">+   * @public</span>
<a href="#l2.397"></a><span id="l2.397" class="difflineplus">+   */</span>
<a href="#l2.398"></a><span id="l2.398" class="difflineplus">+  getColumnStates: function FolderDisplayWidget_getColumnStates() {</span>
<a href="#l2.399"></a><span id="l2.399" class="difflineplus">+    if (!this._active)</span>
<a href="#l2.400"></a><span id="l2.400" class="difflineplus">+      return this._savedColumnStates;</span>
<a href="#l2.401"></a><span id="l2.401" class="difflineplus">+</span>
<a href="#l2.402"></a><span id="l2.402" class="difflineplus">+    let columnStates = {};</span>
<a href="#l2.403"></a><span id="l2.403" class="difflineplus">+</span>
<a href="#l2.404"></a><span id="l2.404" class="difflineplus">+    let cols = document.getElementById(&quot;threadCols&quot;);</span>
<a href="#l2.405"></a><span id="l2.405" class="difflineplus">+    let colChildren = cols.children;</span>
<a href="#l2.406"></a><span id="l2.406" class="difflineplus">+    for (let iKid = 0; iKid &lt; colChildren.length; iKid++) {</span>
<a href="#l2.407"></a><span id="l2.407" class="difflineplus">+      let colChild = colChildren[iKid];</span>
<a href="#l2.408"></a><span id="l2.408" class="difflineplus">+      if (colChild.tagName != &quot;treecol&quot;)</span>
<a href="#l2.409"></a><span id="l2.409" class="difflineplus">+        continue;</span>
<a href="#l2.410"></a><span id="l2.410" class="difflineplus">+      columnStates[colChild.id] = {</span>
<a href="#l2.411"></a><span id="l2.411" class="difflineplus">+        visible: colChild.getAttribute(&quot;hidden&quot;) != &quot;true&quot;,</span>
<a href="#l2.412"></a><span id="l2.412" class="difflineplus">+        ordinal: colChild.getAttribute(&quot;ordinal&quot;),</span>
<a href="#l2.413"></a><span id="l2.413" class="difflineplus">+      };</span>
<a href="#l2.414"></a><span id="l2.414" class="difflineplus">+    }</span>
<a href="#l2.415"></a><span id="l2.415" class="difflineplus">+</span>
<a href="#l2.416"></a><span id="l2.416" class="difflineplus">+    return columnStates;</span>
<a href="#l2.417"></a><span id="l2.417" class="difflineplus">+  },</span>
<a href="#l2.418"></a><span id="l2.418" class="difflineplus">+</span>
<a href="#l2.419"></a><span id="l2.419" class="difflineplus">+  /**</span>
<a href="#l2.420"></a><span id="l2.420">    * For now, just save the visible columns into a dictionary for use in a</span>
<a href="#l2.421"></a><span id="l2.421" class="difflineminus">-   *  subsequent call to setVisibleColumns.  This does not do anything about</span>
<a href="#l2.422"></a><span id="l2.422" class="difflineminus">-   *  re-arranging columns.</span>
<a href="#l2.423"></a><span id="l2.423" class="difflineplus">+   *  subsequent call to |setColumnStates|.</span>
<a href="#l2.424"></a><span id="l2.424">    */</span>
<a href="#l2.425"></a><span id="l2.425" class="difflineminus">-  saveColumnStates: function() {</span>
<a href="#l2.426"></a><span id="l2.426" class="difflineplus">+  _saveColumnStates: function FolderDisplayWidget__saveColumnStates() {</span>
<a href="#l2.427"></a><span id="l2.427">     // In the actual nsITreeColumn, the index property indicates the column</span>
<a href="#l2.428"></a><span id="l2.428">     //  number.  This column number is a 0-based index with no gaps; it only</span>
<a href="#l2.429"></a><span id="l2.429">     //  increments the number each time it sees a column.</span>
<a href="#l2.430"></a><span id="l2.430">     // However, this is subservient to the 'ordinal' property which</span>
<a href="#l2.431"></a><span id="l2.431">     //  defines the _apparent content sequence_ provided by GetNextSibling.</span>
<a href="#l2.432"></a><span id="l2.432">     //  The underlying content ordering is still the same, which is how</span>
<a href="#l2.433"></a><span id="l2.433">     //  restoreNaturalOrder can reset things to their XUL definition sequence.</span>
<a href="#l2.434"></a><span id="l2.434">     //  The 'ordinal' stuff works because nsBoxFrame::RelayoutChildAtOrdinal</span>
<a href="#l2.435"></a><span id="l2.435" class="difflineat">@@ -473,41 +591,28 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l2.436"></a><span id="l2.436">     //  not know this, although the ordering is relative so it doesn't actually</span>
<a href="#l2.437"></a><span id="l2.437">     //  matter.  The annoying splitters do have ordinals, and live between</span>
<a href="#l2.438"></a><span id="l2.438">     //  tree columns.  The splitters adjacent to a tree column do not need to</span>
<a href="#l2.439"></a><span id="l2.439">     //  have any 'ordinal' relationship, although it would appear user activity</span>
<a href="#l2.440"></a><span id="l2.440">     //  tends to move them around in a predictable fashion with oddness involved</span>
<a href="#l2.441"></a><span id="l2.441">     //  at the edges.</span>
<a href="#l2.442"></a><span id="l2.442">     // Changes to the ordinal attribute should take immediate effect in terms of</span>
<a href="#l2.443"></a><span id="l2.443">     //  sibling relationship, but will merely invalidate the columns rather than</span>
<a href="#l2.444"></a><span id="l2.444" class="difflineminus">-    //  cause a re-computaiton of column relationships every time.</span>
<a href="#l2.445"></a><span id="l2.445" class="difflineplus">+    //  cause a re-computation of column relationships every time.</span>
<a href="#l2.446"></a><span id="l2.446">     // restoreNaturalOrder invalidates the tree when it is done re-ordering; I'm</span>
<a href="#l2.447"></a><span id="l2.447">     //  not sure that's entirely necessary...</span>
<a href="#l2.448"></a><span id="l2.448" class="difflineminus">-</span>
<a href="#l2.449"></a><span id="l2.449" class="difflineminus">-    let visibleMap = {};</span>
<a href="#l2.450"></a><span id="l2.450" class="difflineminus">-</span>
<a href="#l2.451"></a><span id="l2.451" class="difflineminus">-    let cols = document.getElementById(&quot;threadCols&quot;);</span>
<a href="#l2.452"></a><span id="l2.452" class="difflineminus">-    let colChildren = cols.children;</span>
<a href="#l2.453"></a><span id="l2.453" class="difflineminus">-    for (let iKid = 0; iKid &lt; colChildren.length; iKid++) {</span>
<a href="#l2.454"></a><span id="l2.454" class="difflineminus">-      let colChild = colChildren[iKid];</span>
<a href="#l2.455"></a><span id="l2.455" class="difflineminus">-      if (colChild.getAttribute(&quot;hidden&quot;) != &quot;true&quot;)</span>
<a href="#l2.456"></a><span id="l2.456" class="difflineminus">-        visibleMap[colChild.id] = true;</span>
<a href="#l2.457"></a><span id="l2.457" class="difflineminus">-    }</span>
<a href="#l2.458"></a><span id="l2.458" class="difflineminus">-</span>
<a href="#l2.459"></a><span id="l2.459" class="difflineminus">-    this._savedColumnStates = visibleMap;</span>
<a href="#l2.460"></a><span id="l2.460" class="difflineplus">+    this._savedColumnStates = this.getColumnStates();</span>
<a href="#l2.461"></a><span id="l2.461">   },</span>
<a href="#l2.462"></a><span id="l2.462"> </span>
<a href="#l2.463"></a><span id="l2.463">   /**</span>
<a href="#l2.464"></a><span id="l2.464" class="difflineminus">-   * Restores the visible columns saved by saveColumnStates.  Some day, in the</span>
<a href="#l2.465"></a><span id="l2.465" class="difflineminus">-   *  future we might do something about positions and the like.  But we don't</span>
<a href="#l2.466"></a><span id="l2.466" class="difflineminus">-   *  currently.</span>
<a href="#l2.467"></a><span id="l2.467" class="difflineplus">+   * Restores the visible columns saved by |_saveColumnStates|.</span>
<a href="#l2.468"></a><span id="l2.468">    */</span>
<a href="#l2.469"></a><span id="l2.469" class="difflineminus">-  restoreColumnStates: function () {</span>
<a href="#l2.470"></a><span id="l2.470" class="difflineplus">+  _restoreColumnStates: function FolderDisplayWidget__restoreColumnStates() {</span>
<a href="#l2.471"></a><span id="l2.471">     if (this._savedColumnStates) {</span>
<a href="#l2.472"></a><span id="l2.472" class="difflineminus">-      this.setVisibleColumns(this._savedColumnStates);</span>
<a href="#l2.473"></a><span id="l2.473" class="difflineplus">+      this.setColumnStates(this._savedColumnStates);</span>
<a href="#l2.474"></a><span id="l2.474">       this._savedColumnStates = null;</span>
<a href="#l2.475"></a><span id="l2.475">     }</span>
<a href="#l2.476"></a><span id="l2.476">   },</span>
<a href="#l2.477"></a><span id="l2.477">   //@}</span>
<a href="#l2.478"></a><span id="l2.478"> </span>
<a href="#l2.479"></a><span id="l2.479">   /**</span>
<a href="#l2.480"></a><span id="l2.480">    * @name What To Display</span>
<a href="#l2.481"></a><span id="l2.481">    * @protected</span>
<a href="#l2.482"></a><span id="l2.482" class="difflineat">@@ -739,25 +844,47 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l2.483"></a><span id="l2.483">     // Anything pending needs to get cleared out; the new view and its related</span>
<a href="#l2.484"></a><span id="l2.484">     //  events will re-schedule anything required or simply run it when it</span>
<a href="#l2.485"></a><span id="l2.485">     //  has its initial call to makeActive compelled.</span>
<a href="#l2.486"></a><span id="l2.486">     this._notificationsPendingActivation = [];</span>
<a href="#l2.487"></a><span id="l2.487"> </span>
<a href="#l2.488"></a><span id="l2.488">     // and the message display needs to forget</span>
<a href="#l2.489"></a><span id="l2.489">     this.messageDisplay.onDestroyingView(aFolderIsComingBack);</span>
<a href="#l2.490"></a><span id="l2.490">   },</span>
<a href="#l2.491"></a><span id="l2.491" class="difflineplus">+</span>
<a href="#l2.492"></a><span id="l2.492">   /**</span>
<a href="#l2.493"></a><span id="l2.493" class="difflineminus">-   * We are entering the folder for display, set the header cache size.</span>
<a href="#l2.494"></a><span id="l2.494" class="difflineplus">+   * Restore persisted information about what columns to display for the folder.</span>
<a href="#l2.495"></a><span id="l2.495" class="difflineplus">+   *  If we have no persisted information, we leave/set _savedColumnStates null.</span>
<a href="#l2.496"></a><span id="l2.496" class="difflineplus">+   *  The column states will be set to default values in onDisplayingFolder in</span>
<a href="#l2.497"></a><span id="l2.497" class="difflineplus">+   *  that case.</span>
<a href="#l2.498"></a><span id="l2.498" class="difflineplus">+   */</span>
<a href="#l2.499"></a><span id="l2.499" class="difflineplus">+  onLoadingFolder: function FolderDisplayWidget_onLoadingFolder(aDbFolderInfo) {</span>
<a href="#l2.500"></a><span id="l2.500" class="difflineplus">+    this._savedColumnStates =</span>
<a href="#l2.501"></a><span id="l2.501" class="difflineplus">+      this._depersistColumnStatesFromDbFolderInfo(aDbFolderInfo);</span>
<a href="#l2.502"></a><span id="l2.502" class="difflineplus">+  },</span>
<a href="#l2.503"></a><span id="l2.503" class="difflineplus">+</span>
<a href="#l2.504"></a><span id="l2.504" class="difflineplus">+  /**</span>
<a href="#l2.505"></a><span id="l2.505" class="difflineplus">+   * We are entering the folder for display:</span>
<a href="#l2.506"></a><span id="l2.506" class="difflineplus">+   * - set the header cache size.</span>
<a href="#l2.507"></a><span id="l2.507" class="difflineplus">+   * - Setup the columns if we did not already depersist in |onLoadingFolder|.</span>
<a href="#l2.508"></a><span id="l2.508">    */</span>
<a href="#l2.509"></a><span id="l2.509">   onDisplayingFolder: function FolderDisplayWidget_onDisplayingFolder() {</span>
<a href="#l2.510"></a><span id="l2.510">     let msgDatabase = this.view.displayedFolder.msgDatabase;</span>
<a href="#l2.511"></a><span id="l2.511">     if (msgDatabase) {</span>
<a href="#l2.512"></a><span id="l2.512">       msgDatabase.resetHdrCacheSize(this.PERF_HEADER_CACHE_SIZE);</span>
<a href="#l2.513"></a><span id="l2.513">     }</span>
<a href="#l2.514"></a><span id="l2.514"> </span>
<a href="#l2.515"></a><span id="l2.515" class="difflineplus">+    // makeActive will restore the folder state</span>
<a href="#l2.516"></a><span id="l2.516" class="difflineplus">+    if (!this._savedColumnStates) {</span>
<a href="#l2.517"></a><span id="l2.517" class="difflineplus">+      // get the default for this folder</span>
<a href="#l2.518"></a><span id="l2.518" class="difflineplus">+      this._savedColumnStates = this._getDefaultColumnsForCurrentFolder();</span>
<a href="#l2.519"></a><span id="l2.519" class="difflineplus">+      // and save it so it doesn't wiggle if the inbox/prototype changes</span>
<a href="#l2.520"></a><span id="l2.520" class="difflineplus">+      this._persistColumnStates(this._savedColumnStates);</span>
<a href="#l2.521"></a><span id="l2.521" class="difflineplus">+    }</span>
<a href="#l2.522"></a><span id="l2.522" class="difflineplus">+</span>
<a href="#l2.523"></a><span id="l2.523">     // the quick-search gets nuked when we show a new folder</span>
<a href="#l2.524"></a><span id="l2.524">     ClearQSIfNecessary();</span>
<a href="#l2.525"></a><span id="l2.525">     // update the quick-search relative to whether it's incoming/outgoing</span>
<a href="#l2.526"></a><span id="l2.526">     onSearchFolderTypeChanged(this.view.isOutgoingFolder);</span>
<a href="#l2.527"></a><span id="l2.527"> </span>
<a href="#l2.528"></a><span id="l2.528">     if (this.active)</span>
<a href="#l2.529"></a><span id="l2.529">       this.makeActive();</span>
<a href="#l2.530"></a><span id="l2.530">   },</span>
<a href="#l2.531"></a><span id="l2.531" class="difflineat">@@ -1066,28 +1193,16 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l2.532"></a><span id="l2.532">    * We use this hint to figure out the next message to display once the</span>
<a href="#l2.533"></a><span id="l2.533">    *  deletion completes.  We do this before the deletion happens because the</span>
<a href="#l2.534"></a><span id="l2.534">    *  selection is probably going away (except in the IMAP delete model), and it</span>
<a href="#l2.535"></a><span id="l2.535">    *  might be too late to figure this out after the deletion happens.</span>
<a href="#l2.536"></a><span id="l2.536">    * Our automated complement (that calls us) is updateNextMessageAfterDelete.</span>
<a href="#l2.537"></a><span id="l2.537">    */</span>
<a href="#l2.538"></a><span id="l2.538">   hintAboutToDeleteMessages:</span>
<a href="#l2.539"></a><span id="l2.539">       function FolderDisplayWidget_hintAboutToDeleteMessages() {</span>
<a href="#l2.540"></a><span id="l2.540" class="difflineminus">-    // If there is a right click going on, then the possibilities are:</span>
<a href="#l2.541"></a><span id="l2.541" class="difflineminus">-    // 1) The user right-clicked in the selection.  In this case, the selection</span>
<a href="#l2.542"></a><span id="l2.542" class="difflineminus">-    //    is maintained.  This holds true for one or multiple messages.</span>
<a href="#l2.543"></a><span id="l2.543" class="difflineminus">-    // 2) The user right-clicked outside the selection.  In this case, the</span>
<a href="#l2.544"></a><span id="l2.544" class="difflineminus">-    //    selection, but not the current index, reflects the single message</span>
<a href="#l2.545"></a><span id="l2.545" class="difflineminus">-    //    the user right-clicked on.</span>
<a href="#l2.546"></a><span id="l2.546" class="difflineminus">-    // We want to treat case #1 as if a right-click was not involved and we</span>
<a href="#l2.547"></a><span id="l2.547" class="difflineminus">-    //  want to ignore case #2 by bailing because our existing selection (or</span>
<a href="#l2.548"></a><span id="l2.548" class="difflineminus">-    //  lack thereof) we want maintained.</span>
<a href="#l2.549"></a><span id="l2.549" class="difflineminus">-//    if (gRightMouseButtonDown &amp;&amp; gRightMouseButtonChangedSelection)</span>
<a href="#l2.550"></a><span id="l2.550" class="difflineminus">-//      return;</span>
<a href="#l2.551"></a><span id="l2.551" class="difflineminus">-</span>
<a href="#l2.552"></a><span id="l2.552">     // save the value, even if it is nsMsgViewIndex_None.</span>
<a href="#l2.553"></a><span id="l2.553">     this._nextViewIndexAfterDelete = this.view.dbView.msgToSelectAfterDelete;</span>
<a href="#l2.554"></a><span id="l2.554">   },</span>
<a href="#l2.555"></a><span id="l2.555"> </span>
<a href="#l2.556"></a><span id="l2.556">   /**</span>
<a href="#l2.557"></a><span id="l2.557">    * The archive code tells us when it is starting to archive messages.  This</span>
<a href="#l2.558"></a><span id="l2.558">    *  is different from hinting about deletion because it will also tell us</span>
<a href="#l2.559"></a><span id="l2.559">    *  when it has completed its mass move.</span>
<a href="#l2.560"></a><span id="l2.560" class="difflineat">@@ -1149,17 +1264,16 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l2.561"></a><span id="l2.561">     this._restoreSelection();</span>
<a href="#l2.562"></a><span id="l2.562">   },</span>
<a href="#l2.563"></a><span id="l2.563">   //@}</span>
<a href="#l2.564"></a><span id="l2.564">   /* ===== End hints from the command infrastructure ==== */</span>
<a href="#l2.565"></a><span id="l2.565"> </span>
<a href="#l2.566"></a><span id="l2.566">   _updateThreadDisplay: function FolderDisplayWidget__updateThreadDisplay() {</span>
<a href="#l2.567"></a><span id="l2.567">     if (this.active) {</span>
<a href="#l2.568"></a><span id="l2.568">       if (this.view.dbView) {</span>
<a href="#l2.569"></a><span id="l2.569" class="difflineminus">-        this.updateColumns();</span>
<a href="#l2.570"></a><span id="l2.570">         UpdateSortIndicators(this.view.dbView.sortType,</span>
<a href="#l2.571"></a><span id="l2.571">                              this.view.dbView.sortOrder);</span>
<a href="#l2.572"></a><span id="l2.572">         SetNewsFolderColumns();</span>
<a href="#l2.573"></a><span id="l2.573">       }</span>
<a href="#l2.574"></a><span id="l2.574">     }</span>
<a href="#l2.575"></a><span id="l2.575">   },</span>
<a href="#l2.576"></a><span id="l2.576"> </span>
<a href="#l2.577"></a><span id="l2.577">   /**</span>
<a href="#l2.578"></a><span id="l2.578" class="difflineat">@@ -1296,18 +1410,16 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l2.579"></a><span id="l2.579">           if (fakeTreeSelection) {</span>
<a href="#l2.580"></a><span id="l2.580">             fakeTreeSelection.duplicateSelection(this.view.dbView.selection);</span>
<a href="#l2.581"></a><span id="l2.581">             // Since duplicateSelection will fire a selectionChanged event,</span>
<a href="#l2.582"></a><span id="l2.582">             // which will try to reload the message, we shouldn't do the same.</span>
<a href="#l2.583"></a><span id="l2.583">             dontReloadMessage = true;</span>
<a href="#l2.584"></a><span id="l2.584">           }</span>
<a href="#l2.585"></a><span id="l2.585">           if (this._savedFirstVisibleRow != null)</span>
<a href="#l2.586"></a><span id="l2.586">             this.treeBox.scrollToRow(this._savedFirstVisibleRow);</span>
<a href="#l2.587"></a><span id="l2.587" class="difflineminus">-</span>
<a href="#l2.588"></a><span id="l2.588" class="difflineminus">-          this.restoreColumnStates();</span>
<a href="#l2.589"></a><span id="l2.589">         }</span>
<a href="#l2.590"></a><span id="l2.590"> </span>
<a href="#l2.591"></a><span id="l2.591">         // restore the quick search widget</span>
<a href="#l2.592"></a><span id="l2.592">         let searchInput = document.getElementById(&quot;searchInput&quot;);</span>
<a href="#l2.593"></a><span id="l2.593">         if (searchInput &amp;&amp; this._savedQuickSearch) {</span>
<a href="#l2.594"></a><span id="l2.594">           searchInput.searchMode = this._savedQuickSearch.searchMode;</span>
<a href="#l2.595"></a><span id="l2.595">           if (this._savedQuickSearch.text) {</span>
<a href="#l2.596"></a><span id="l2.596">             searchInput.value = this._savedQuickSearch.text;</span>
<a href="#l2.597"></a><span id="l2.597" class="difflineat">@@ -1315,16 +1427,20 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l2.598"></a><span id="l2.598">             searchInput.clearButtonHidden = false;</span>
<a href="#l2.599"></a><span id="l2.599">           }</span>
<a href="#l2.600"></a><span id="l2.600">           else {</span>
<a href="#l2.601"></a><span id="l2.601">             searchInput.setSearchCriteriaText();</span>
<a href="#l2.602"></a><span id="l2.602">           }</span>
<a href="#l2.603"></a><span id="l2.603">         }</span>
<a href="#l2.604"></a><span id="l2.604">       }</span>
<a href="#l2.605"></a><span id="l2.605"> </span>
<a href="#l2.606"></a><span id="l2.606" class="difflineplus">+      // Always restore the column state if we have persisted state.  We restore</span>
<a href="#l2.607"></a><span id="l2.607" class="difflineplus">+      //  state on folder entry, in which case we were probably not inactive.</span>
<a href="#l2.608"></a><span id="l2.608" class="difflineplus">+      this._restoreColumnStates();</span>
<a href="#l2.609"></a><span id="l2.609" class="difflineplus">+</span>
<a href="#l2.610"></a><span id="l2.610">       // the tab mode knows whether we are folder or message display, which</span>
<a href="#l2.611"></a><span id="l2.611">       //  impacts the legal modes</span>
<a href="#l2.612"></a><span id="l2.612">       if (this._tabInfo)</span>
<a href="#l2.613"></a><span id="l2.613">         mailTabType._setPaneStates(this._tabInfo.mode.legalPanes,</span>
<a href="#l2.614"></a><span id="l2.614">           {folder: !this._tabInfo.folderPaneCollapsed,</span>
<a href="#l2.615"></a><span id="l2.615">            message: this.messageDisplay.visible});</span>
<a href="#l2.616"></a><span id="l2.616"> </span>
<a href="#l2.617"></a><span id="l2.617">       // update the columns and such that live inside the thread pane</span>
<a href="#l2.618"></a><span id="l2.618" class="difflineat">@@ -1365,27 +1481,36 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l2.619"></a><span id="l2.619">                            Components.interfaces.nsIPrefLocalizedString).data;</span>
<a href="#l2.620"></a><span id="l2.620">     window.frames[&quot;accountCentralPane&quot;].location.href = acctCentralPage;</span>
<a href="#l2.621"></a><span id="l2.621">   },</span>
<a href="#l2.622"></a><span id="l2.622"> </span>
<a href="#l2.623"></a><span id="l2.623">   /**</span>
<a href="#l2.624"></a><span id="l2.624">    * Call this when the tab using us is being hidden.</span>
<a href="#l2.625"></a><span id="l2.625">    */</span>
<a href="#l2.626"></a><span id="l2.626">   makeInactive: function FolderDisplayWidget_makeInactive() {</span>
<a href="#l2.627"></a><span id="l2.627" class="difflineplus">+    // - things to do before we mark ourselves inactive (because they depend on</span>
<a href="#l2.628"></a><span id="l2.628" class="difflineplus">+    //   us being active)</span>
<a href="#l2.629"></a><span id="l2.629" class="difflineplus">+</span>
<a href="#l2.630"></a><span id="l2.630" class="difflineplus">+    // getColumnStates returns _savedColumnStates when we are inactive (and is</span>
<a href="#l2.631"></a><span id="l2.631" class="difflineplus">+    //  used by _saveColumnStates) so we must do this before marking inactive.</span>
<a href="#l2.632"></a><span id="l2.632" class="difflineplus">+    this._saveColumnStates();</span>
<a href="#l2.633"></a><span id="l2.633" class="difflineplus">+</span>
<a href="#l2.634"></a><span id="l2.634" class="difflineplus">+    // - mark us inactive</span>
<a href="#l2.635"></a><span id="l2.635">     this._active = false;</span>
<a href="#l2.636"></a><span id="l2.636" class="difflineplus">+</span>
<a href="#l2.637"></a><span id="l2.637" class="difflineplus">+    // - (everything after this point doesn't care that we are marked inactive)</span>
<a href="#l2.638"></a><span id="l2.638">     // save the folder pane's state always</span>
<a href="#l2.639"></a><span id="l2.639">     this.folderPaneCollapsed =</span>
<a href="#l2.640"></a><span id="l2.640">       document.getElementById(&quot;folderPaneBox&quot;).collapsed;</span>
<a href="#l2.641"></a><span id="l2.641"> </span>
<a href="#l2.642"></a><span id="l2.642">     if (this.view.dbView) {</span>
<a href="#l2.643"></a><span id="l2.643">       if (this.treeBox)</span>
<a href="#l2.644"></a><span id="l2.644">         this._savedFirstVisibleRow = this.treeBox.getFirstVisibleRow();</span>
<a href="#l2.645"></a><span id="l2.645"> </span>
<a href="#l2.646"></a><span id="l2.646">       // save column states</span>
<a href="#l2.647"></a><span id="l2.647" class="difflineminus">-      this.saveColumnStates();</span>
<a href="#l2.648"></a><span id="l2.648"> </span>
<a href="#l2.649"></a><span id="l2.649">       // save the message pane's state only when it is potentially visible</span>
<a href="#l2.650"></a><span id="l2.650">       this.messagePaneCollapsed =</span>
<a href="#l2.651"></a><span id="l2.651">         document.getElementById(&quot;messagepanebox&quot;).collapsed;</span>
<a href="#l2.652"></a><span id="l2.652"> </span>
<a href="#l2.653"></a><span id="l2.653">       // save the actual quick-search query text</span>
<a href="#l2.654"></a><span id="l2.654">       let searchInput = document.getElementById(&quot;searchInput&quot;);</span>
<a href="#l2.655"></a><span id="l2.655">       if (searchInput) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/base/content/mailWindowOverlay.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/base/content/mailWindowOverlay.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -1915,21 +1915,29 @@ let mailTabType = {</span>
<a href="#l3.4"></a><span id="l3.4">       type: &quot;glodaSearch&quot;,</span>
<a href="#l3.5"></a><span id="l3.5">       /// The set of panes that are legal to be displayed in this mode</span>
<a href="#l3.6"></a><span id="l3.6">       legalPanes: {</span>
<a href="#l3.7"></a><span id="l3.7">         folder: false,</span>
<a href="#l3.8"></a><span id="l3.8">         thread: true,</span>
<a href="#l3.9"></a><span id="l3.9">         message: true,</span>
<a href="#l3.10"></a><span id="l3.10">         glodaFacets: false,</span>
<a href="#l3.11"></a><span id="l3.11">       },</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-      desiredColumns: {</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-        flaggedCol: true,</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-        subjectCol: true,</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-        senderCol: true,</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineminus">-        dateCol: true,</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+      desiredColumnStates: {</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+        flaggedCol: {</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+          visible: true,</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+        },</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+        subjectCol: {</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+          visible: true,</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+        },</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+        senderCol: {</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+          visible: true,</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+        },</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+        dateCol: {</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+          visible: true,</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineplus">+        },</span>
<a href="#l3.30"></a><span id="l3.30">       },</span>
<a href="#l3.31"></a><span id="l3.31">       /**</span>
<a href="#l3.32"></a><span id="l3.32">        * Open a new tab whose view is backed by a gloda search.</span>
<a href="#l3.33"></a><span id="l3.33">        *</span>
<a href="#l3.34"></a><span id="l3.34">        * @param searchString</span>
<a href="#l3.35"></a><span id="l3.35">        * @param facetString</span>
<a href="#l3.36"></a><span id="l3.36">        *     - everything:</span>
<a href="#l3.37"></a><span id="l3.37">        *     - subject:</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineat">@@ -1951,17 +1959,17 @@ let mailTabType = {</span>
<a href="#l3.39"></a><span id="l3.39">         aTab.facetString = aArgs.facetString;</span>
<a href="#l3.40"></a><span id="l3.40"> </span>
<a href="#l3.41"></a><span id="l3.41">         aTab.glodaSynView = new GlodaSyntheticSearchView(aArgs.searchString,</span>
<a href="#l3.42"></a><span id="l3.42">                                                          aArgs.facetString,</span>
<a href="#l3.43"></a><span id="l3.43">                                                          aArgs.location);</span>
<a href="#l3.44"></a><span id="l3.44"> </span>
<a href="#l3.45"></a><span id="l3.45">         this.openTab(aTab, false, new MessagePaneDisplayWidget());</span>
<a href="#l3.46"></a><span id="l3.46">         aTab.folderDisplay.show(aTab.glodaSynView);</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineminus">-        aTab.folderDisplay.setVisibleColumns(aTab.mode.desiredColumns);</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineplus">+        aTab.folderDisplay.setColumnStates(aTab.mode.desiredColumnStates);</span>
<a href="#l3.49"></a><span id="l3.49">         aTab.folderDisplay.makeActive();</span>
<a href="#l3.50"></a><span id="l3.50">       },</span>
<a href="#l3.51"></a><span id="l3.51">     },</span>
<a href="#l3.52"></a><span id="l3.52">   },</span>
<a href="#l3.53"></a><span id="l3.53"> </span>
<a href="#l3.54"></a><span id="l3.54">   _getNumberOfRealAccounts : function() {</span>
<a href="#l3.55"></a><span id="l3.55">     let mgr = Components.classes[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l3.56"></a><span id="l3.56">                         .getService(Components.interfaces.nsIMsgAccountManager);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/base/content/messageWindow.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/base/content/messageWindow.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -153,16 +153,25 @@ StandaloneFolderDisplayWidget.prototype </span>
<a href="#l4.4"></a><span id="l4.4">   },</span>
<a href="#l4.5"></a><span id="l4.5"> </span>
<a href="#l4.6"></a><span id="l4.6">   /// folder display will want to show the thread pane; we need do nothing</span>
<a href="#l4.7"></a><span id="l4.7">   _showThreadPane: function () {},</span>
<a href="#l4.8"></a><span id="l4.8">   _showAccountCentral: function () {},</span>
<a href="#l4.9"></a><span id="l4.9"> </span>
<a href="#l4.10"></a><span id="l4.10">   _updateThreadDisplay: function () {},</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+  // we don't care about columns.</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+  setColumnStates: function () {},</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+  getColumnStates: function () { return {}; },</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+  _depersistColumnStateFromDbFolderInfo: function () { return {}; },</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+  _getDefaultColumnsForCurrentFolder: function () { return {}; },</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+  _persistColumnStates: function () {},</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+  _saveColumnStates: function () {},</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+  _restoreColumnStates: function() {},</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+</span>
<a href="#l4.21"></a><span id="l4.21">   onMessageCountsChanged:</span>
<a href="#l4.22"></a><span id="l4.22">       function StandaloneFolderDisplayWidget_onMessageCountsChaned() {</span>
<a href="#l4.23"></a><span id="l4.23">     UpdateStatusMessageCounts();</span>
<a href="#l4.24"></a><span id="l4.24">   },</span>
<a href="#l4.25"></a><span id="l4.25"> };</span>
<a href="#l4.26"></a><span id="l4.26"> </span>
<a href="#l4.27"></a><span id="l4.27"> </span>
<a href="#l4.28"></a><span id="l4.28"> /**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/base/content/messenger.xul</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/base/content/messenger.xul</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -275,86 +275,86 @@</span>
<a href="#l5.4"></a><span id="l5.4">                           lastfoldersent=&quot;false&quot;</span>
<a href="#l5.5"></a><span id="l5.5">                           keepcurrentinview=&quot;true&quot;</span>
<a href="#l5.6"></a><span id="l5.6">                           disableKeyNavigation=&quot;true&quot;</span>
<a href="#l5.7"></a><span id="l5.7">                           context=&quot;mailContext&quot;</span>
<a href="#l5.8"></a><span id="l5.8">                           onkeypress=&quot;ThreadPaneKeyPress(event);&quot;</span>
<a href="#l5.9"></a><span id="l5.9">                           onselect=&quot;ThreadPaneSelectionChanged();&quot;</span>
<a href="#l5.10"></a><span id="l5.10">                           &gt;</span>
<a href="#l5.11"></a><span id="l5.11">                       &lt;treecols id=&quot;threadCols&quot; pickertooltiptext=&quot;&amp;columnChooser.tooltip;&quot;&gt;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-                        &lt;treecol id=&quot;threadCol&quot; persist=&quot;hidden ordinal&quot; fixed=&quot;true&quot; cycler=&quot;true&quot;</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+                        &lt;treecol id=&quot;threadCol&quot; fixed=&quot;true&quot; cycler=&quot;true&quot;</span>
<a href="#l5.14"></a><span id="l5.14">                                  class=&quot;treecol-image threadColumnHeader&quot; currentView=&quot;unthreaded&quot;</span>
<a href="#l5.15"></a><span id="l5.15">                                  label=&quot;&amp;threadColumn.label;&quot; tooltiptext=&quot;&amp;threadColumn.tooltip;&quot;/&gt;</span>
<a href="#l5.16"></a><span id="l5.16">                         &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineminus">-                        &lt;treecol id=&quot;attachmentCol&quot; persist=&quot;hidden ordinal&quot; fixed=&quot;true&quot;</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineminus">-                                 class=&quot;treecol-image attachmentColumnHeader&quot;</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineminus">-                                 label=&quot;&amp;attachmentColumn.label;&quot; tooltiptext=&quot;&amp;attachmentColumn.tooltip;&quot;/&gt;</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineminus">-                        &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineminus">-                        &lt;treecol id=&quot;flaggedCol&quot; persist=&quot;hidden ordinal&quot; fixed=&quot;true&quot; cycler=&quot;true&quot;</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineplus">+                        &lt;treecol id=&quot;flaggedCol&quot; fixed=&quot;true&quot; cycler=&quot;true&quot;</span>
<a href="#l5.23"></a><span id="l5.23">                                  class=&quot;treecol-image flagColumnHeader&quot;</span>
<a href="#l5.24"></a><span id="l5.24">                                  label=&quot;&amp;starredColumn.label;&quot; tooltiptext=&quot;&amp;starredColumn.tooltip;&quot;/&gt;</span>
<a href="#l5.25"></a><span id="l5.25">                         &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineminus">-                        &lt;treecol id=&quot;subjectCol&quot; persist=&quot;hidden ordinal width&quot; flex=&quot;7&quot; ignoreincolumnpicker=&quot;true&quot;</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineplus">+                        &lt;treecol id=&quot;attachmentCol&quot; fixed=&quot;true&quot;</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineplus">+                                 class=&quot;treecol-image attachmentColumnHeader&quot;</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineplus">+                                 label=&quot;&amp;attachmentColumn.label;&quot; tooltiptext=&quot;&amp;attachmentColumn.tooltip;&quot;/&gt;</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineplus">+                        &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+                        &lt;treecol id=&quot;subjectCol&quot; persist=&quot;width&quot; flex=&quot;7&quot; ignoreincolumnpicker=&quot;true&quot;</span>
<a href="#l5.32"></a><span id="l5.32">                                  label=&quot;&amp;subjectColumn.label;&quot; tooltiptext=&quot;&amp;subjectColumn.tooltip;&quot;/&gt;</span>
<a href="#l5.33"></a><span id="l5.33">                         &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineminus">-                        &lt;treecol id=&quot;unreadButtonColHeader&quot; persist=&quot;hidden ordinal&quot; fixed=&quot;true&quot; cycler=&quot;true&quot;</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineplus">+                        &lt;treecol id=&quot;unreadButtonColHeader&quot; fixed=&quot;true&quot; cycler=&quot;true&quot;</span>
<a href="#l5.36"></a><span id="l5.36">                                  class=&quot;treecol-image readColumnHeader&quot;</span>
<a href="#l5.37"></a><span id="l5.37">                                  label=&quot;&amp;readColumn.label;&quot; tooltiptext=&quot;&amp;readColumn.tooltip;&quot;/&gt;</span>
<a href="#l5.38"></a><span id="l5.38">                         &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineminus">-                        &lt;treecol id=&quot;senderCol&quot; persist=&quot;hidden swappedhidden ordinal width&quot; flex=&quot;4&quot;</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineplus">+                        &lt;treecol id=&quot;senderCol&quot; persist=&quot;width&quot; flex=&quot;4&quot;</span>
<a href="#l5.41"></a><span id="l5.41">                                  hidden=&quot;false&quot; swappedhidden=&quot;true&quot;</span>
<a href="#l5.42"></a><span id="l5.42">                                  label=&quot;&amp;fromColumn.label;&quot; tooltiptext=&quot;&amp;fromColumn.tooltip;&quot;/&gt;</span>
<a href="#l5.43"></a><span id="l5.43">                         &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineminus">-                        &lt;treecol id=&quot;recipientCol&quot; persist=&quot;hidden swappedhidden ordinal width&quot; flex=&quot;4&quot;</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineplus">+                        &lt;treecol id=&quot;recipientCol&quot; persist=&quot;width&quot; flex=&quot;4&quot;</span>
<a href="#l5.46"></a><span id="l5.46">                                  hidden=&quot;true&quot; swappedhidden=&quot;false&quot;</span>
<a href="#l5.47"></a><span id="l5.47">                                  label=&quot;&amp;recipientColumn.label;&quot; tooltiptext=&quot;&amp;recipientColumn.tooltip;&quot;/&gt;</span>
<a href="#l5.48"></a><span id="l5.48">                         &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineminus">-                        &lt;treecol id=&quot;junkStatusCol&quot; persist=&quot;hidden ordinal width&quot; fixed=&quot;true&quot; cycler=&quot;true&quot;</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineplus">+                        &lt;treecol id=&quot;junkStatusCol&quot; persist=&quot;width&quot; fixed=&quot;true&quot; cycler=&quot;true&quot;</span>
<a href="#l5.51"></a><span id="l5.51">                                  class=&quot;treecol-image junkStatusHeader&quot;</span>
<a href="#l5.52"></a><span id="l5.52">                                  label=&quot;&amp;junkStatusColumn.label;&quot; tooltiptext=&quot;&amp;junkStatusColumn.tooltip;&quot;/&gt;</span>
<a href="#l5.53"></a><span id="l5.53">                         &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineminus">-                        &lt;treecol id=&quot;receivedCol&quot; persist=&quot;hidden ordinal width temphidden&quot; flex=&quot;2&quot; hidden=&quot;true&quot;</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineplus">+                        &lt;treecol id=&quot;receivedCol&quot; persist=&quot;width temphidden&quot; flex=&quot;2&quot; hidden=&quot;true&quot;</span>
<a href="#l5.56"></a><span id="l5.56">                                  label=&quot;&amp;receivedColumn.label;&quot; tooltiptext=&quot;&amp;receivedColumn.tooltip;&quot;/&gt;</span>
<a href="#l5.57"></a><span id="l5.57">                         &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineminus">-                        &lt;treecol id=&quot;dateCol&quot; persist=&quot;hidden ordinal width&quot; flex=&quot;2&quot; </span>
<a href="#l5.59"></a><span id="l5.59" class="difflineplus">+                        &lt;treecol id=&quot;dateCol&quot; persist=&quot;width&quot; flex=&quot;2&quot;</span>
<a href="#l5.60"></a><span id="l5.60">                                  label=&quot;&amp;dateColumn.label;&quot; tooltiptext=&quot;&amp;dateColumn.tooltip;&quot;/&gt;</span>
<a href="#l5.61"></a><span id="l5.61">                         &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineminus">-                        &lt;treecol id=&quot;statusCol&quot; persist=&quot;hidden ordinal width&quot; flex=&quot;1&quot; hidden=&quot;true&quot;</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineplus">+                        &lt;treecol id=&quot;statusCol&quot; persist=&quot;width&quot; flex=&quot;1&quot; hidden=&quot;true&quot;</span>
<a href="#l5.64"></a><span id="l5.64">                                  label=&quot;&amp;statusColumn.label;&quot; tooltiptext=&quot;&amp;statusColumn.tooltip;&quot;/&gt;</span>
<a href="#l5.65"></a><span id="l5.65">                         &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineminus">-                        &lt;treecol id=&quot;sizeCol&quot; persist=&quot;hidden ordinal width&quot; flex=&quot;1&quot; hidden=&quot;true&quot;</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineplus">+                        &lt;treecol id=&quot;sizeCol&quot; persist=&quot;width&quot; flex=&quot;1&quot; hidden=&quot;true&quot;</span>
<a href="#l5.68"></a><span id="l5.68">                                  label=&quot;&amp;sizeColumn.label;&quot; tooltiptext=&quot;&amp;sizeColumn.tooltip;&quot;/&gt;</span>
<a href="#l5.69"></a><span id="l5.69">                         &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineminus">-                        &lt;treecol id=&quot;tagsCol&quot; persist=&quot;hidden ordinal width&quot; flex=&quot;1&quot; hidden=&quot;true&quot;</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineplus">+                        &lt;treecol id=&quot;tagsCol&quot; persist=&quot;width&quot; flex=&quot;1&quot; hidden=&quot;true&quot;</span>
<a href="#l5.72"></a><span id="l5.72">                                  label=&quot;&amp;tagsColumn.label;&quot; tooltiptext=&quot;&amp;tagsColumn.tooltip;&quot;/&gt;</span>
<a href="#l5.73"></a><span id="l5.73">                         &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineminus">-                        &lt;treecol id=&quot;accountCol&quot; persist=&quot;hidden ordinal width&quot; flex=&quot;1&quot; hidden=&quot;true&quot;</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineplus">+                        &lt;treecol id=&quot;accountCol&quot; persist=&quot;width&quot; flex=&quot;1&quot; hidden=&quot;true&quot;</span>
<a href="#l5.76"></a><span id="l5.76">                                  label=&quot;&amp;accountColumn.label;&quot; tooltiptext=&quot;&amp;accountColumn.tooltip;&quot;/&gt;</span>
<a href="#l5.77"></a><span id="l5.77">                         &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineminus">-                        &lt;treecol id=&quot;priorityCol&quot; persist=&quot;hidden ordinal width&quot; flex=&quot;1&quot; hidden=&quot;true&quot;</span>
<a href="#l5.79"></a><span id="l5.79" class="difflineplus">+                        &lt;treecol id=&quot;priorityCol&quot; persist=&quot;width&quot; flex=&quot;1&quot; hidden=&quot;true&quot;</span>
<a href="#l5.80"></a><span id="l5.80">                                  label=&quot;&amp;priorityColumn.label;&quot; tooltiptext=&quot;&amp;priorityColumn.tooltip;&quot;/&gt;</span>
<a href="#l5.81"></a><span id="l5.81">                         &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineminus">-                        &lt;treecol id=&quot;unreadCol&quot; persist=&quot;hidden ordinal width&quot; flex=&quot;1&quot; hidden=&quot;true&quot;</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineplus">+                        &lt;treecol id=&quot;unreadCol&quot; persist=&quot;width&quot; flex=&quot;1&quot; hidden=&quot;true&quot;</span>
<a href="#l5.84"></a><span id="l5.84">                                  label=&quot;&amp;unreadColumn.label;&quot; tooltiptext=&quot;&amp;unreadColumn.tooltip;&quot;/&gt;</span>
<a href="#l5.85"></a><span id="l5.85">                         &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineminus">-                        &lt;treecol id=&quot;totalCol&quot; persist=&quot;hidden ordinal width&quot; flex=&quot;1&quot; hidden=&quot;true&quot;</span>
<a href="#l5.87"></a><span id="l5.87" class="difflineplus">+                        &lt;treecol id=&quot;totalCol&quot; persist=&quot;width&quot; flex=&quot;1&quot; hidden=&quot;true&quot;</span>
<a href="#l5.88"></a><span id="l5.88">                                  label=&quot;&amp;totalColumn.label;&quot; tooltiptext=&quot;&amp;totalColumn.tooltip;&quot;/&gt;</span>
<a href="#l5.89"></a><span id="l5.89">                         &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l5.90"></a><span id="l5.90" class="difflineminus">-                        &lt;treecol id=&quot;locationCol&quot; persist=&quot;width&quot; flex=&quot;1&quot; hidden=&quot;true&quot; ignoreincolumnpicker=&quot;true&quot;</span>
<a href="#l5.91"></a><span id="l5.91" class="difflineplus">+                        &lt;treecol id=&quot;locationCol&quot; persist=&quot;width&quot; flex=&quot;1&quot; hidden=&quot;true&quot;</span>
<a href="#l5.92"></a><span id="l5.92">                                  label=&quot;&amp;locationColumn.label;&quot; tooltiptext=&quot;&amp;locationColumn.tooltip;&quot;/&gt;</span>
<a href="#l5.93"></a><span id="l5.93">                         &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l5.94"></a><span id="l5.94" class="difflineminus">-                        &lt;treecol id=&quot;idCol&quot; persist=&quot;hidden ordinal width&quot; flex=&quot;1&quot; hidden=&quot;true&quot;</span>
<a href="#l5.95"></a><span id="l5.95" class="difflineplus">+                        &lt;treecol id=&quot;idCol&quot; persist=&quot;width&quot; flex=&quot;1&quot; hidden=&quot;true&quot;</span>
<a href="#l5.96"></a><span id="l5.96">                                  label=&quot;&amp;idColumn.label;&quot; tooltiptext=&quot;&amp;idColumn.tooltip;&quot;/&gt;</span>
<a href="#l5.97"></a><span id="l5.97">                         &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l5.98"></a><span id="l5.98" class="difflineminus">-                        &lt;treecol id=&quot;glodaWhyCol&quot; persist=&quot;ordinal width&quot; flex=&quot;1&quot;</span>
<a href="#l5.99"></a><span id="l5.99" class="difflineplus">+                        &lt;treecol id=&quot;glodaWhyCol&quot; persist=&quot;width&quot; flex=&quot;1&quot;</span>
<a href="#l5.100"></a><span id="l5.100">                                  hidden=&quot;true&quot; ignoreincolumnpicker=&quot;true&quot;</span>
<a href="#l5.101"></a><span id="l5.101">                                  label=&quot;&amp;glodaWhyColumn.label;&quot;</span>
<a href="#l5.102"></a><span id="l5.102">                                  tooltiptext=&quot;&amp;glodaWhyColumn.tooltip;&quot;/&gt;</span>
<a href="#l5.103"></a><span id="l5.103">                         &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l5.104"></a><span id="l5.104" class="difflineminus">-                        &lt;treecol id=&quot;glodaScoreCol&quot; persist=&quot;ordinal width&quot; flex=&quot;1&quot;</span>
<a href="#l5.105"></a><span id="l5.105" class="difflineplus">+                        &lt;treecol id=&quot;glodaScoreCol&quot; persist=&quot;width&quot; flex=&quot;1&quot;</span>
<a href="#l5.106"></a><span id="l5.106">                                  hidden=&quot;true&quot; ignoreincolumnpicker=&quot;true&quot;</span>
<a href="#l5.107"></a><span id="l5.107">                                  label=&quot;&amp;glodaScoreColumn.label;&quot;</span>
<a href="#l5.108"></a><span id="l5.108">                                  tooltiptext=&quot;&amp;glodaScoreColumn.tooltip;&quot;/&gt;</span>
<a href="#l5.109"></a><span id="l5.109">                       &lt;/treecols&gt;</span>
<a href="#l5.110"></a><span id="l5.110">                     &lt;treechildren ondraggesture=&quot;threadPaneOnDragStart(event);&quot;/&gt;</span>
<a href="#l5.111"></a><span id="l5.111">                   &lt;/tree&gt;</span>
<a href="#l5.112"></a><span id="l5.112">                  &lt;/vbox&gt;</span>
<a href="#l5.113"></a><span id="l5.113">                 &lt;/hbox&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/base/content/msgMail3PaneWindow.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/base/content/msgMail3PaneWindow.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -684,23 +684,29 @@ function UnloadPanes()</span>
<a href="#l6.4"></a><span id="l6.4">   threadTree.removeEventListener(&quot;click&quot;,ThreadTreeOnClick,true);</span>
<a href="#l6.5"></a><span id="l6.5">   var folderTree = document.getElementById(&quot;folderTree&quot;);</span>
<a href="#l6.6"></a><span id="l6.6">   folderTree.removeEventListener(&quot;click&quot;,FolderPaneOnClick,true);</span>
<a href="#l6.7"></a><span id="l6.7">   folderTree.removeEventListener(&quot;mousedown&quot;,TreeOnMouseDown,true);</span>
<a href="#l6.8"></a><span id="l6.8">   gFolderTreeView.unload(&quot;folderTree.json&quot;);</span>
<a href="#l6.9"></a><span id="l6.9">   UnloadCommandUpdateHandlers();</span>
<a href="#l6.10"></a><span id="l6.10"> }</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-// builds prior to 12-08-2001 did not have the labels column</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-// in the thread pane.  so if a user ran an old build, and then</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-// upgraded, they get the new column, and this causes problems.</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineminus">-// We're trying to avoid a similar problem to bug #96979.</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineminus">-// to work around this, we hide the column once, using the</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineminus">-// &quot;mailnews.ui.threadpane.version&quot; pref.</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineminus">-function UpgradeThreadPaneUI()</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+/**</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+ * Abuse the threadpane UI version preference to know whether we should mark all</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineplus">+ * IMAP folders as offline.</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+ *</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineplus">+ * Very important note!  Although I am writing this comment and renamed the</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineplus">+ * function, this is not my doing and by reading this function and not fixing it</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineplus">+ * yourself, you are just as guilty as me, which is not guilty at all, but</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineplus">+ * it certainly won't improve your karma.</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineplus">+ *</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineplus">+ * This used to do things related to updating the visible columns and reordering</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineplus">+ * them, but that is now handled by FolderDisplayWidget.</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineplus">+ */</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+function UpgradeProfileAndBeUglyAboutIt()</span>
<a href="#l6.32"></a><span id="l6.32"> {</span>
<a href="#l6.33"></a><span id="l6.33">   var threadPaneUIVersion;</span>
<a href="#l6.34"></a><span id="l6.34"> </span>
<a href="#l6.35"></a><span id="l6.35">   try {</span>
<a href="#l6.36"></a><span id="l6.36"> </span>
<a href="#l6.37"></a><span id="l6.37">     threadPaneUIVersion = gPrefBranch.getIntPref(&quot;mailnews.ui.threadpane.version&quot;);</span>
<a href="#l6.38"></a><span id="l6.38"> </span>
<a href="#l6.39"></a><span id="l6.39">     if (threadPaneUIVersion &lt; 7)</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineat">@@ -717,70 +723,44 @@ function UpgradeThreadPaneUI()</span>
<a href="#l6.41"></a><span id="l6.41"> </span>
<a href="#l6.42"></a><span id="l6.42">         let allFolders = Components.classes[&quot;@mozilla.org/supports-array;1&quot;]</span>
<a href="#l6.43"></a><span id="l6.43">                           .createInstance(Components.interfaces.nsISupportsArray);</span>
<a href="#l6.44"></a><span id="l6.44">         server.rootFolder.ListDescendents(allFolders);</span>
<a href="#l6.45"></a><span id="l6.45">         for each (let folder in fixIterator(allFolders, Components.interfaces.nsIMsgFolder))</span>
<a href="#l6.46"></a><span id="l6.46">           folder.setFlag(Components.interfaces.nsMsgFolderFlags.Offline);</span>
<a href="#l6.47"></a><span id="l6.47">       }</span>
<a href="#l6.48"></a><span id="l6.48"> </span>
<a href="#l6.49"></a><span id="l6.49" class="difflineminus">-      // Note: threadTree._reorderColumn will throw an ERROR if the columns specified are already in the same order!</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineminus">-      if (threadPaneUIVersion &lt; 6)</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineminus">-      {</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineminus">-        var threadTree = document.getElementById(&quot;threadTree&quot;);</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineminus">-        var dateCol = document.getElementById(&quot;dateCol&quot;);</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineminus">-        var receivedCol = document.getElementById(&quot;receivedCol&quot;);</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineminus">-        var junkCol = document.getElementById(&quot;junkStatusCol&quot;);</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineminus">-</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineminus">-        if (threadPaneUIVersion &lt; 5)</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineminus">-        {</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineminus">-          if (threadPaneUIVersion &lt; 4)</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineminus">-          {</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineminus">-            if (threadPaneUIVersion &lt; 3)</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineminus">-            {</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineminus">-</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineminus">-              // in thunderbird, we are inserting the junk column just before the</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineminus">-              // date column.</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineminus">-              threadTree._reorderColumn(junkCol, dateCol, true);</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineminus">-            }</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineminus">-</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineminus">-            var senderCol = document.getElementById(&quot;senderCol&quot;);</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineminus">-            var recipientCol = document.getElementById(&quot;recipientCol&quot;);</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineminus">-            threadTree._reorderColumn(recipientCol, junkCol, true);</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineminus">-            threadTree._reorderColumn(senderCol, recipientCol, true);</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineminus">-</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineminus">-          } // version 4 upgrades</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineminus">-</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineminus">-          // version 5 adds a new column called attachments</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineminus">-          var attachmentCol = document.getElementById(&quot;attachmentCol&quot;);</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineminus">-          var subjectCol = document.getElementById(&quot;subjectCol&quot;);</span>
<a href="#l6.79"></a><span id="l6.79" class="difflineminus">-</span>
<a href="#l6.80"></a><span id="l6.80" class="difflineminus">-          threadTree._reorderColumn(attachmentCol, subjectCol, true);</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineminus">-</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineminus">-        } // version 5 upgrades</span>
<a href="#l6.83"></a><span id="l6.83" class="difflineminus">-</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineminus">-        if (dateCol)</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineminus">-          threadTree._reorderColumn(receivedCol, dateCol, true);</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineminus">-        else</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineminus">-          threadTree._reorderColumn(receivedCol, junkCol, false);</span>
<a href="#l6.88"></a><span id="l6.88" class="difflineminus">-</span>
<a href="#l6.89"></a><span id="l6.89" class="difflineminus">-      } // version 6 upgrades</span>
<a href="#l6.90"></a><span id="l6.90" class="difflineminus">-</span>
<a href="#l6.91"></a><span id="l6.91">       gPrefBranch.setIntPref(&quot;mailnews.ui.threadpane.version&quot;, 7);</span>
<a href="#l6.92"></a><span id="l6.92"> </span>
<a href="#l6.93"></a><span id="l6.93">     } // version 7 upgrades</span>
<a href="#l6.94"></a><span id="l6.94">   }</span>
<a href="#l6.95"></a><span id="l6.95">   catch (ex) {</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineminus">-    dump(&quot;UpgradeThreadPane: ex = &quot; + ex + &quot;\n&quot;);</span>
<a href="#l6.97"></a><span id="l6.97" class="difflineplus">+    Components.utils.reportError(ex);</span>
<a href="#l6.98"></a><span id="l6.98">   }</span>
<a href="#l6.99"></a><span id="l6.99"> }</span>
<a href="#l6.100"></a><span id="l6.100"> </span>
<a href="#l6.101"></a><span id="l6.101"> function OnLoadThreadPane()</span>
<a href="#l6.102"></a><span id="l6.102"> {</span>
<a href="#l6.103"></a><span id="l6.103" class="difflineminus">-  UpgradeThreadPaneUI();</span>
<a href="#l6.104"></a><span id="l6.104" class="difflineplus">+  // Register a listener on the columns element so that we get a notification</span>
<a href="#l6.105"></a><span id="l6.105" class="difflineplus">+  //  whenever attributes on the columns change.  Because of the XBL bindings</span>
<a href="#l6.106"></a><span id="l6.106" class="difflineplus">+  //  I think we also get the column picker too, but our filtering to only the</span>
<a href="#l6.107"></a><span id="l6.107" class="difflineplus">+  //  attributes we care about takes care of that.</span>
<a href="#l6.108"></a><span id="l6.108" class="difflineplus">+  document.getElementById(&quot;threadCols&quot;).addEventListener(</span>
<a href="#l6.109"></a><span id="l6.109" class="difflineplus">+    &quot;DOMAttrModified&quot;,</span>
<a href="#l6.110"></a><span id="l6.110" class="difflineplus">+    function(aEvent) {</span>
<a href="#l6.111"></a><span id="l6.111" class="difflineplus">+      // we only care about hidden status and ordinal</span>
<a href="#l6.112"></a><span id="l6.112" class="difflineplus">+      if (aEvent.attrName != &quot;hidden&quot; &amp;&amp;</span>
<a href="#l6.113"></a><span id="l6.113" class="difflineplus">+          aEvent.attrName != &quot;ordinal&quot;)</span>
<a href="#l6.114"></a><span id="l6.114" class="difflineplus">+        return;</span>
<a href="#l6.115"></a><span id="l6.115" class="difflineplus">+      if (gFolderDisplay)</span>
<a href="#l6.116"></a><span id="l6.116" class="difflineplus">+        gFolderDisplay.hintColumnsChanged();</span>
<a href="#l6.117"></a><span id="l6.117" class="difflineplus">+    },</span>
<a href="#l6.118"></a><span id="l6.118" class="difflineplus">+    true);</span>
<a href="#l6.119"></a><span id="l6.119" class="difflineplus">+</span>
<a href="#l6.120"></a><span id="l6.120" class="difflineplus">+  UpgradeProfileAndBeUglyAboutIt();</span>
<a href="#l6.121"></a><span id="l6.121"> }</span>
<a href="#l6.122"></a><span id="l6.122"> </span>
<a href="#l6.123"></a><span id="l6.123"> /* Functions for accessing particular parts of the window*/</span>
<a href="#l6.124"></a><span id="l6.124"> function GetSearchInput()</span>
<a href="#l6.125"></a><span id="l6.125"> {</span>
<a href="#l6.126"></a><span id="l6.126">   if (!gSearchInput)</span>
<a href="#l6.127"></a><span id="l6.127">     gSearchInput = document.getElementById(&quot;searchInput&quot;);</span>
<a href="#l6.128"></a><span id="l6.128">   return gSearchInput;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1">new file mode 100644</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineminus">--- /dev/null</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-columns.js</span>
<a href="#l7.4"></a><span id="l7.4" class="difflineat">@@ -0,0 +1,348 @@</span>
<a href="#l7.5"></a><span id="l7.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l7.6"></a><span id="l7.6" class="difflineplus">+ *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l7.7"></a><span id="l7.7" class="difflineplus">+ *</span>
<a href="#l7.8"></a><span id="l7.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l7.9"></a><span id="l7.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l7.10"></a><span id="l7.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l7.11"></a><span id="l7.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+ *</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+ * License.</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+ *</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+ * The Original Code is Thunderbird Mail Client.</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+ *</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+ * Mozilla Messaging, Inc.</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineplus">+ *</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineplus">+ *</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineplus">+ *</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineplus">+</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineplus">+/*</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineplus">+ * Test column default logic and persistence logic.  Persistence comes in both</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+ *  tab-switching (because of the multiplexed implementation) and</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineplus">+ *  folder-switching forms.</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineplus">+ */</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineplus">+</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineplus">+var MODULE_NAME = 'test-columns';</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineplus">+</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineplus">+var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineplus">+var MODULE_REQUIRES = ['folder-display-helpers', 'window-helpers'];</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineplus">+</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineplus">+var folderInbox, folderSent, folderVirtual, folderA, folderB;</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineplus">+// INBOX_DEFAULTS sans 'dateCol' but gains 'tagsCol'</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineplus">+var columnsB;</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineplus">+</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineplus">+function setupModule(module) {</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineplus">+  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineplus">+  fdh.installInto(module);</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineplus">+  let wh = collector.getModule('window-helpers');</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineplus">+  wh.installInto(module);</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineplus">+}</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineplus">+</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineplus">+/**</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineplus">+ * Verify that the provided list of columns is visible in the given order,</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineplus">+ *  throwing an exception if it is not the case.</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineplus">+ *</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineplus">+ * @param aDesiredColumns A list of column ID strings for columns that should be</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineplus">+ *     visible in the order that they should be visisble.</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineplus">+ */</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineplus">+function assert_visible_columns(aDesiredColumns) {</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineplus">+  let cols = mc.e(&quot;threadTree&quot;).columns;</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineplus">+  let iDesired = 0;</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineplus">+</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineplus">+  let visibleColumnIds = [];</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineplus">+  let failCol = null;</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineplus">+  for (let col = cols.getFirstColumn(); col != null; col = col.getNext()) {</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineplus">+    if (col.element.getAttribute(&quot;hidden&quot;) != &quot;true&quot;) {</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineplus">+      visibleColumnIds.push(col.id);</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineplus">+      if (!failCol) {</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineplus">+        if (aDesiredColumns[iDesired] != col.id)</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineplus">+          failCol = col;</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineplus">+        else</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineplus">+          iDesired++;</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineplus">+      }</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineplus">+    }</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineplus">+  }</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineplus">+  if (failCol)</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineplus">+    throw new Error(&quot;Found visible column '&quot; + failCol.id + &quot;' but was &quot; +</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineplus">+                    &quot;expecting '&quot; + aDesiredColumns[iDesired] + &quot;'!&quot; +</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineplus">+                    &quot;\ndesired list: &quot; + aDesiredColumns +</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineplus">+                    &quot;\n actual list: &quot; + visibleColumnIds);</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineplus">+}</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineplus">+</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineplus">+/**</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineplus">+ * Show the column with the given id.</span>
<a href="#l7.97"></a><span id="l7.97" class="difflineplus">+ *</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineplus">+ * @param aColumnId Id of the treecol element you want to show.</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineplus">+ */</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineplus">+function show_column(aColumnId) {</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineplus">+  mc.e(aColumnId).removeAttribute(&quot;hidden&quot;);</span>
<a href="#l7.102"></a><span id="l7.102" class="difflineplus">+}</span>
<a href="#l7.103"></a><span id="l7.103" class="difflineplus">+</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineplus">+/**</span>
<a href="#l7.105"></a><span id="l7.105" class="difflineplus">+ * Hide the column with the given id.</span>
<a href="#l7.106"></a><span id="l7.106" class="difflineplus">+ *</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineplus">+ * @param aColumnId Id of the treecol element you want to hide.</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineplus">+ */</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineplus">+function hide_column(aColumnId) {</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineplus">+  mc.e(aColumnId).setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l7.111"></a><span id="l7.111" class="difflineplus">+}</span>
<a href="#l7.112"></a><span id="l7.112" class="difflineplus">+</span>
<a href="#l7.113"></a><span id="l7.113" class="difflineplus">+/**</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineplus">+ * Move a column before another column.</span>
<a href="#l7.115"></a><span id="l7.115" class="difflineplus">+ *</span>
<a href="#l7.116"></a><span id="l7.116" class="difflineplus">+ * @param aColumnId The id of the column you want to move.</span>
<a href="#l7.117"></a><span id="l7.117" class="difflineplus">+ * @param aBeforeId The id of the column you want the moving column to end up</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineplus">+ *     before.</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineplus">+ */</span>
<a href="#l7.120"></a><span id="l7.120" class="difflineplus">+function reorder_column(aColumnId, aBeforeId) {</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineplus">+  let col = mc.e(aColumnId);</span>
<a href="#l7.122"></a><span id="l7.122" class="difflineplus">+  let before = mc.e(aBeforeId);</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineplus">+  mc.threadTree._reorderColumn(col, before, true);</span>
<a href="#l7.124"></a><span id="l7.124" class="difflineplus">+}</span>
<a href="#l7.125"></a><span id="l7.125" class="difflineplus">+</span>
<a href="#l7.126"></a><span id="l7.126" class="difflineplus">+var INBOX_DEFAULTS = [</span>
<a href="#l7.127"></a><span id="l7.127" class="difflineplus">+  &quot;threadCol&quot;,</span>
<a href="#l7.128"></a><span id="l7.128" class="difflineplus">+  &quot;flaggedCol&quot;,</span>
<a href="#l7.129"></a><span id="l7.129" class="difflineplus">+  &quot;attachmentCol&quot;,</span>
<a href="#l7.130"></a><span id="l7.130" class="difflineplus">+  &quot;subjectCol&quot;,</span>
<a href="#l7.131"></a><span id="l7.131" class="difflineplus">+  &quot;unreadButtonColHeader&quot;,</span>
<a href="#l7.132"></a><span id="l7.132" class="difflineplus">+  &quot;senderCol&quot;,</span>
<a href="#l7.133"></a><span id="l7.133" class="difflineplus">+  &quot;junkStatusCol&quot;,</span>
<a href="#l7.134"></a><span id="l7.134" class="difflineplus">+  &quot;dateCol&quot;</span>
<a href="#l7.135"></a><span id="l7.135" class="difflineplus">+];</span>
<a href="#l7.136"></a><span id="l7.136" class="difflineplus">+</span>
<a href="#l7.137"></a><span id="l7.137" class="difflineplus">+/**</span>
<a href="#l7.138"></a><span id="l7.138" class="difflineplus">+ * Make sure we set the proper defaults for an Inbox.</span>
<a href="#l7.139"></a><span id="l7.139" class="difflineplus">+ */</span>
<a href="#l7.140"></a><span id="l7.140" class="difflineplus">+function test_column_defaults_inbox() {</span>
<a href="#l7.141"></a><span id="l7.141" class="difflineplus">+  // just use the inbox</span>
<a href="#l7.142"></a><span id="l7.142" class="difflineplus">+  folderInbox = gLocalInboxFolder;</span>
<a href="#l7.143"></a><span id="l7.143" class="difflineplus">+  enter_folder(folderInbox);</span>
<a href="#l7.144"></a><span id="l7.144" class="difflineplus">+  assert_visible_columns(INBOX_DEFAULTS);</span>
<a href="#l7.145"></a><span id="l7.145" class="difflineplus">+}</span>
<a href="#l7.146"></a><span id="l7.146" class="difflineplus">+</span>
<a href="#l7.147"></a><span id="l7.147" class="difflineplus">+var SENT_DEFAULTS = [</span>
<a href="#l7.148"></a><span id="l7.148" class="difflineplus">+  &quot;threadCol&quot;,</span>
<a href="#l7.149"></a><span id="l7.149" class="difflineplus">+  &quot;flaggedCol&quot;,</span>
<a href="#l7.150"></a><span id="l7.150" class="difflineplus">+  &quot;attachmentCol&quot;,</span>
<a href="#l7.151"></a><span id="l7.151" class="difflineplus">+  &quot;subjectCol&quot;,</span>
<a href="#l7.152"></a><span id="l7.152" class="difflineplus">+  &quot;unreadButtonColHeader&quot;,</span>
<a href="#l7.153"></a><span id="l7.153" class="difflineplus">+  &quot;recipientCol&quot;,</span>
<a href="#l7.154"></a><span id="l7.154" class="difflineplus">+  &quot;junkStatusCol&quot;,</span>
<a href="#l7.155"></a><span id="l7.155" class="difflineplus">+  &quot;dateCol&quot;</span>
<a href="#l7.156"></a><span id="l7.156" class="difflineplus">+];</span>
<a href="#l7.157"></a><span id="l7.157" class="difflineplus">+</span>
<a href="#l7.158"></a><span id="l7.158" class="difflineplus">+/**</span>
<a href="#l7.159"></a><span id="l7.159" class="difflineplus">+ * Make sure we set the proper defaults for a Sent folder.</span>
<a href="#l7.160"></a><span id="l7.160" class="difflineplus">+ */</span>
<a href="#l7.161"></a><span id="l7.161" class="difflineplus">+function test_column_defaults_sent() {</span>
<a href="#l7.162"></a><span id="l7.162" class="difflineplus">+  folderSent = create_folder(&quot;ColumnsSent&quot;);</span>
<a href="#l7.163"></a><span id="l7.163" class="difflineplus">+  folderSent.setFlag(Ci.nsMsgFolderFlags.SentMail);</span>
<a href="#l7.164"></a><span id="l7.164" class="difflineplus">+</span>
<a href="#l7.165"></a><span id="l7.165" class="difflineplus">+  be_in_folder(folderSent);</span>
<a href="#l7.166"></a><span id="l7.166" class="difflineplus">+  assert_visible_columns(SENT_DEFAULTS);</span>
<a href="#l7.167"></a><span id="l7.167" class="difflineplus">+}</span>
<a href="#l7.168"></a><span id="l7.168" class="difflineplus">+</span>
<a href="#l7.169"></a><span id="l7.169" class="difflineplus">+var VIRTUAL_DEFAULTS = [</span>
<a href="#l7.170"></a><span id="l7.170" class="difflineplus">+  &quot;threadCol&quot;,</span>
<a href="#l7.171"></a><span id="l7.171" class="difflineplus">+  &quot;flaggedCol&quot;,</span>
<a href="#l7.172"></a><span id="l7.172" class="difflineplus">+  &quot;attachmentCol&quot;,</span>
<a href="#l7.173"></a><span id="l7.173" class="difflineplus">+  &quot;subjectCol&quot;,</span>
<a href="#l7.174"></a><span id="l7.174" class="difflineplus">+  &quot;unreadButtonColHeader&quot;,</span>
<a href="#l7.175"></a><span id="l7.175" class="difflineplus">+  &quot;senderCol&quot;,</span>
<a href="#l7.176"></a><span id="l7.176" class="difflineplus">+  &quot;junkStatusCol&quot;,</span>
<a href="#l7.177"></a><span id="l7.177" class="difflineplus">+  &quot;dateCol&quot;,</span>
<a href="#l7.178"></a><span id="l7.178" class="difflineplus">+  &quot;locationCol&quot;</span>
<a href="#l7.179"></a><span id="l7.179" class="difflineplus">+];</span>
<a href="#l7.180"></a><span id="l7.180" class="difflineplus">+</span>
<a href="#l7.181"></a><span id="l7.181" class="difflineplus">+/**</span>
<a href="#l7.182"></a><span id="l7.182" class="difflineplus">+ * Make sure we set the proper defaults for a multi-folder virtual folder.</span>
<a href="#l7.183"></a><span id="l7.183" class="difflineplus">+ */</span>
<a href="#l7.184"></a><span id="l7.184" class="difflineplus">+function test_column_defaults_cross_folder_virtual_folder() {</span>
<a href="#l7.185"></a><span id="l7.185" class="difflineplus">+  folderVirtual = create_virtual_folder([folderInbox, folderSent], {},</span>
<a href="#l7.186"></a><span id="l7.186" class="difflineplus">+                                        true, &quot;ColumnsVirtual&quot;);</span>
<a href="#l7.187"></a><span id="l7.187" class="difflineplus">+</span>
<a href="#l7.188"></a><span id="l7.188" class="difflineplus">+  be_in_folder(folderVirtual);</span>
<a href="#l7.189"></a><span id="l7.189" class="difflineplus">+  assert_visible_columns(VIRTUAL_DEFAULTS);</span>
<a href="#l7.190"></a><span id="l7.190" class="difflineplus">+}</span>
<a href="#l7.191"></a><span id="l7.191" class="difflineplus">+</span>
<a href="#l7.192"></a><span id="l7.192" class="difflineplus">+/**</span>
<a href="#l7.193"></a><span id="l7.193" class="difflineplus">+ * Make sure that we initialize our columns from the inbox and that they persist</span>
<a href="#l7.194"></a><span id="l7.194" class="difflineplus">+ *  after that and don't follow the inbox.  This also does a good workout of the</span>
<a href="#l7.195"></a><span id="l7.195" class="difflineplus">+ *  persistence logic.</span>
<a href="#l7.196"></a><span id="l7.196" class="difflineplus">+ */</span>
<a href="#l7.197"></a><span id="l7.197" class="difflineplus">+function test_column_defaults_inherit_from_inbox() {</span>
<a href="#l7.198"></a><span id="l7.198" class="difflineplus">+  folderA = create_folder(&quot;ColumnsA&quot;);</span>
<a href="#l7.199"></a><span id="l7.199" class="difflineplus">+  // - the folder should inherit from the inbox...</span>
<a href="#l7.200"></a><span id="l7.200" class="difflineplus">+  be_in_folder(folderA);</span>
<a href="#l7.201"></a><span id="l7.201" class="difflineplus">+  assert_visible_columns(INBOX_DEFAULTS);</span>
<a href="#l7.202"></a><span id="l7.202" class="difflineplus">+</span>
<a href="#l7.203"></a><span id="l7.203" class="difflineplus">+  // - if we go back to the inbox and change things then the folder's settings</span>
<a href="#l7.204"></a><span id="l7.204" class="difflineplus">+  //  should not change.</span>
<a href="#l7.205"></a><span id="l7.205" class="difflineplus">+  be_in_folder(folderInbox);</span>
<a href="#l7.206"></a><span id="l7.206" class="difflineplus">+  // show tags, hide date</span>
<a href="#l7.207"></a><span id="l7.207" class="difflineplus">+  hide_column(&quot;dateCol&quot;);</span>
<a href="#l7.208"></a><span id="l7.208" class="difflineplus">+  show_column(&quot;tagsCol&quot;);</span>
<a href="#l7.209"></a><span id="l7.209" class="difflineplus">+  // (paranoia verify)</span>
<a href="#l7.210"></a><span id="l7.210" class="difflineplus">+  columnsB = INBOX_DEFAULTS.slice(0, -1);</span>
<a href="#l7.211"></a><span id="l7.211" class="difflineplus">+  columnsB.push(&quot;tagsCol&quot;);</span>
<a href="#l7.212"></a><span id="l7.212" class="difflineplus">+  assert_visible_columns(columnsB);</span>
<a href="#l7.213"></a><span id="l7.213" class="difflineplus">+</span>
<a href="#l7.214"></a><span id="l7.214" class="difflineplus">+  // make sure A did not change; it should still have dateCol.</span>
<a href="#l7.215"></a><span id="l7.215" class="difflineplus">+  be_in_folder(folderA);</span>
<a href="#l7.216"></a><span id="l7.216" class="difflineplus">+  assert_visible_columns(INBOX_DEFAULTS);</span>
<a href="#l7.217"></a><span id="l7.217" class="difflineplus">+</span>
<a href="#l7.218"></a><span id="l7.218" class="difflineplus">+  // - but folder B should pick up on the modified set</span>
<a href="#l7.219"></a><span id="l7.219" class="difflineplus">+  folderB = create_folder(&quot;ColumnsB&quot;);</span>
<a href="#l7.220"></a><span id="l7.220" class="difflineplus">+  be_in_folder(folderB);</span>
<a href="#l7.221"></a><span id="l7.221" class="difflineplus">+  assert_visible_columns(columnsB);</span>
<a href="#l7.222"></a><span id="l7.222" class="difflineplus">+</span>
<a href="#l7.223"></a><span id="l7.223" class="difflineplus">+  // - and if we restore the inbox, folder B should stay modified too.</span>
<a href="#l7.224"></a><span id="l7.224" class="difflineplus">+  be_in_folder(folderInbox);</span>
<a href="#l7.225"></a><span id="l7.225" class="difflineplus">+  show_column(&quot;dateCol&quot;);</span>
<a href="#l7.226"></a><span id="l7.226" class="difflineplus">+  hide_column(&quot;tagsCol&quot;);</span>
<a href="#l7.227"></a><span id="l7.227" class="difflineplus">+  assert_visible_columns(INBOX_DEFAULTS);</span>
<a href="#l7.228"></a><span id="l7.228" class="difflineplus">+</span>
<a href="#l7.229"></a><span id="l7.229" class="difflineplus">+  be_in_folder(folderB);</span>
<a href="#l7.230"></a><span id="l7.230" class="difflineplus">+  assert_visible_columns(columnsB);</span>
<a href="#l7.231"></a><span id="l7.231" class="difflineplus">+}</span>
<a href="#l7.232"></a><span id="l7.232" class="difflineplus">+</span>
<a href="#l7.233"></a><span id="l7.233" class="difflineplus">+/**</span>
<a href="#l7.234"></a><span id="l7.234" class="difflineplus">+ * Make sure that when we change tabs that things persist/restore correctly.</span>
<a href="#l7.235"></a><span id="l7.235" class="difflineplus">+ */</span>
<a href="#l7.236"></a><span id="l7.236" class="difflineplus">+function test_column_visibility_persists_through_tab_changes() {</span>
<a href="#l7.237"></a><span id="l7.237" class="difflineplus">+  let tabA = be_in_folder(folderA);</span>
<a href="#l7.238"></a><span id="l7.238" class="difflineplus">+  assert_visible_columns(INBOX_DEFAULTS);</span>
<a href="#l7.239"></a><span id="l7.239" class="difflineplus">+</span>
<a href="#l7.240"></a><span id="l7.240" class="difflineplus">+  let tabB = open_folder_in_new_tab(folderB);</span>
<a href="#l7.241"></a><span id="l7.241" class="difflineplus">+  assert_visible_columns(columnsB);</span>
<a href="#l7.242"></a><span id="l7.242" class="difflineplus">+</span>
<a href="#l7.243"></a><span id="l7.243" class="difflineplus">+  // - switch back and forth among the loaded and verify</span>
<a href="#l7.244"></a><span id="l7.244" class="difflineplus">+  switch_tab(tabA);</span>
<a href="#l7.245"></a><span id="l7.245" class="difflineplus">+  assert_visible_columns(INBOX_DEFAULTS);</span>
<a href="#l7.246"></a><span id="l7.246" class="difflineplus">+</span>
<a href="#l7.247"></a><span id="l7.247" class="difflineplus">+  switch_tab(tabB);</span>
<a href="#l7.248"></a><span id="l7.248" class="difflineplus">+  assert_visible_columns(columnsB);</span>
<a href="#l7.249"></a><span id="l7.249" class="difflineplus">+</span>
<a href="#l7.250"></a><span id="l7.250" class="difflineplus">+  // - change things and make sure the changes stick</span>
<a href="#l7.251"></a><span id="l7.251" class="difflineplus">+  // B gain accountCol</span>
<a href="#l7.252"></a><span id="l7.252" class="difflineplus">+  let bWithExtra = columnsB.concat([&quot;accountCol&quot;]);</span>
<a href="#l7.253"></a><span id="l7.253" class="difflineplus">+  show_column(&quot;accountCol&quot;);</span>
<a href="#l7.254"></a><span id="l7.254" class="difflineplus">+  assert_visible_columns(bWithExtra);</span>
<a href="#l7.255"></a><span id="l7.255" class="difflineplus">+</span>
<a href="#l7.256"></a><span id="l7.256" class="difflineplus">+  switch_tab(tabA);</span>
<a href="#l7.257"></a><span id="l7.257" class="difflineplus">+  assert_visible_columns(INBOX_DEFAULTS);</span>
<a href="#l7.258"></a><span id="l7.258" class="difflineplus">+</span>
<a href="#l7.259"></a><span id="l7.259" class="difflineplus">+  // A loses junk</span>
<a href="#l7.260"></a><span id="l7.260" class="difflineplus">+  let aSansJunk = INBOX_DEFAULTS.slice(0, -2); // nukes junk, date</span>
<a href="#l7.261"></a><span id="l7.261" class="difflineplus">+  hide_column(&quot;junkStatusCol&quot;);</span>
<a href="#l7.262"></a><span id="l7.262" class="difflineplus">+  aSansJunk.push(&quot;dateCol&quot;); // put date back</span>
<a href="#l7.263"></a><span id="l7.263" class="difflineplus">+  assert_visible_columns(aSansJunk);</span>
<a href="#l7.264"></a><span id="l7.264" class="difflineplus">+</span>
<a href="#l7.265"></a><span id="l7.265" class="difflineplus">+  switch_tab(tabB);</span>
<a href="#l7.266"></a><span id="l7.266" class="difflineplus">+  assert_visible_columns(bWithExtra);</span>
<a href="#l7.267"></a><span id="l7.267" class="difflineplus">+  // B goes back to normal</span>
<a href="#l7.268"></a><span id="l7.268" class="difflineplus">+  hide_column(&quot;accountCol&quot;);</span>
<a href="#l7.269"></a><span id="l7.269" class="difflineplus">+</span>
<a href="#l7.270"></a><span id="l7.270" class="difflineplus">+  switch_tab(tabA);</span>
<a href="#l7.271"></a><span id="l7.271" class="difflineplus">+  assert_visible_columns(aSansJunk);</span>
<a href="#l7.272"></a><span id="l7.272" class="difflineplus">+  // A goes back to &quot;normal&quot;</span>
<a href="#l7.273"></a><span id="l7.273" class="difflineplus">+  show_column(&quot;junkStatusCol&quot;);</span>
<a href="#l7.274"></a><span id="l7.274" class="difflineplus">+  assert_visible_columns(INBOX_DEFAULTS);</span>
<a href="#l7.275"></a><span id="l7.275" class="difflineplus">+</span>
<a href="#l7.276"></a><span id="l7.276" class="difflineplus">+  close_tab(tabB);</span>
<a href="#l7.277"></a><span id="l7.277" class="difflineplus">+}</span>
<a href="#l7.278"></a><span id="l7.278" class="difflineplus">+</span>
<a href="#l7.279"></a><span id="l7.279" class="difflineplus">+/**</span>
<a href="#l7.280"></a><span id="l7.280" class="difflineplus">+ * Make sure that when we change folders that things persist/restore correctly.</span>
<a href="#l7.281"></a><span id="l7.281" class="difflineplus">+ */</span>
<a href="#l7.282"></a><span id="l7.282" class="difflineplus">+function test_column_visibility_persists_through_folder_changes() {</span>
<a href="#l7.283"></a><span id="l7.283" class="difflineplus">+  be_in_folder(folderA);</span>
<a href="#l7.284"></a><span id="l7.284" class="difflineplus">+  assert_visible_columns(INBOX_DEFAULTS);</span>
<a href="#l7.285"></a><span id="l7.285" class="difflineplus">+</span>
<a href="#l7.286"></a><span id="l7.286" class="difflineplus">+  // more for A</span>
<a href="#l7.287"></a><span id="l7.287" class="difflineplus">+  let aWithExtra = INBOX_DEFAULTS.concat([&quot;sizeCol&quot;, &quot;tagsCol&quot;]);</span>
<a href="#l7.288"></a><span id="l7.288" class="difflineplus">+  show_column(&quot;sizeCol&quot;);</span>
<a href="#l7.289"></a><span id="l7.289" class="difflineplus">+  show_column(&quot;tagsCol&quot;);</span>
<a href="#l7.290"></a><span id="l7.290" class="difflineplus">+  assert_visible_columns(aWithExtra);</span>
<a href="#l7.291"></a><span id="l7.291" class="difflineplus">+</span>
<a href="#l7.292"></a><span id="l7.292" class="difflineplus">+  be_in_folder(folderB);</span>
<a href="#l7.293"></a><span id="l7.293" class="difflineplus">+  assert_visible_columns(columnsB);</span>
<a href="#l7.294"></a><span id="l7.294" class="difflineplus">+</span>
<a href="#l7.295"></a><span id="l7.295" class="difflineplus">+  // B gain accountCol</span>
<a href="#l7.296"></a><span id="l7.296" class="difflineplus">+  let bWithExtra = columnsB.concat([&quot;accountCol&quot;]);</span>
<a href="#l7.297"></a><span id="l7.297" class="difflineplus">+  show_column(&quot;accountCol&quot;);</span>
<a href="#l7.298"></a><span id="l7.298" class="difflineplus">+  assert_visible_columns(bWithExtra);</span>
<a href="#l7.299"></a><span id="l7.299" class="difflineplus">+</span>
<a href="#l7.300"></a><span id="l7.300" class="difflineplus">+  // check A</span>
<a href="#l7.301"></a><span id="l7.301" class="difflineplus">+  be_in_folder(folderA);</span>
<a href="#l7.302"></a><span id="l7.302" class="difflineplus">+  assert_visible_columns(aWithExtra);</span>
<a href="#l7.303"></a><span id="l7.303" class="difflineplus">+</span>
<a href="#l7.304"></a><span id="l7.304" class="difflineplus">+  // check B</span>
<a href="#l7.305"></a><span id="l7.305" class="difflineplus">+  be_in_folder(folderB);</span>
<a href="#l7.306"></a><span id="l7.306" class="difflineplus">+  assert_visible_columns(bWithExtra);</span>
<a href="#l7.307"></a><span id="l7.307" class="difflineplus">+</span>
<a href="#l7.308"></a><span id="l7.308" class="difflineplus">+  // restore B</span>
<a href="#l7.309"></a><span id="l7.309" class="difflineplus">+  hide_column(&quot;accountCol&quot;);</span>
<a href="#l7.310"></a><span id="l7.310" class="difflineplus">+</span>
<a href="#l7.311"></a><span id="l7.311" class="difflineplus">+  // restore A</span>
<a href="#l7.312"></a><span id="l7.312" class="difflineplus">+  be_in_folder(folderA);</span>
<a href="#l7.313"></a><span id="l7.313" class="difflineplus">+  hide_column(&quot;sizeCol&quot;);</span>
<a href="#l7.314"></a><span id="l7.314" class="difflineplus">+  hide_column(&quot;tagsCol&quot;);</span>
<a href="#l7.315"></a><span id="l7.315" class="difflineplus">+</span>
<a href="#l7.316"></a><span id="l7.316" class="difflineplus">+  // check B</span>
<a href="#l7.317"></a><span id="l7.317" class="difflineplus">+  be_in_folder(folderB);</span>
<a href="#l7.318"></a><span id="l7.318" class="difflineplus">+  assert_visible_columns(columnsB);</span>
<a href="#l7.319"></a><span id="l7.319" class="difflineplus">+</span>
<a href="#l7.320"></a><span id="l7.320" class="difflineplus">+  // check A</span>
<a href="#l7.321"></a><span id="l7.321" class="difflineplus">+  be_in_folder(folderA);</span>
<a href="#l7.322"></a><span id="l7.322" class="difflineplus">+  assert_visible_columns(INBOX_DEFAULTS);</span>
<a href="#l7.323"></a><span id="l7.323" class="difflineplus">+}</span>
<a href="#l7.324"></a><span id="l7.324" class="difflineplus">+</span>
<a href="#l7.325"></a><span id="l7.325" class="difflineplus">+/**</span>
<a href="#l7.326"></a><span id="l7.326" class="difflineplus">+ * Test that reordering persists through tab changes and folder changes.</span>
<a href="#l7.327"></a><span id="l7.327" class="difflineplus">+ */</span>
<a href="#l7.328"></a><span id="l7.328" class="difflineplus">+function test_column_reordering_persists() {</span>
<a href="#l7.329"></a><span id="l7.329" class="difflineplus">+  let tabA = be_in_folder(folderA);</span>
<a href="#l7.330"></a><span id="l7.330" class="difflineplus">+  let tabB = open_folder_in_new_tab(folderB);</span>
<a href="#l7.331"></a><span id="l7.331" class="difflineplus">+</span>
<a href="#l7.332"></a><span id="l7.332" class="difflineplus">+  // put sender before subject</span>
<a href="#l7.333"></a><span id="l7.333" class="difflineplus">+  reorder_column(&quot;senderCol&quot;, &quot;subjectCol&quot;);</span>
<a href="#l7.334"></a><span id="l7.334" class="difflineplus">+  let reorderdB = columnsB.concat();</span>
<a href="#l7.335"></a><span id="l7.335" class="difflineplus">+  reorderdB.splice(5, 1);</span>
<a href="#l7.336"></a><span id="l7.336" class="difflineplus">+  reorderdB.splice(3, 0, &quot;senderCol&quot;);</span>
<a href="#l7.337"></a><span id="l7.337" class="difflineplus">+  assert_visible_columns(reorderdB);</span>
<a href="#l7.338"></a><span id="l7.338" class="difflineplus">+</span>
<a href="#l7.339"></a><span id="l7.339" class="difflineplus">+  switch_tab(tabA);</span>
<a href="#l7.340"></a><span id="l7.340" class="difflineplus">+  assert_visible_columns(INBOX_DEFAULTS);</span>
<a href="#l7.341"></a><span id="l7.341" class="difflineplus">+</span>
<a href="#l7.342"></a><span id="l7.342" class="difflineplus">+  switch_tab(tabB);</span>
<a href="#l7.343"></a><span id="l7.343" class="difflineplus">+  assert_visible_columns(reorderdB);</span>
<a href="#l7.344"></a><span id="l7.344" class="difflineplus">+</span>
<a href="#l7.345"></a><span id="l7.345" class="difflineplus">+  be_in_folder(folderInbox);</span>
<a href="#l7.346"></a><span id="l7.346" class="difflineplus">+  assert_visible_columns(INBOX_DEFAULTS);</span>
<a href="#l7.347"></a><span id="l7.347" class="difflineplus">+</span>
<a href="#l7.348"></a><span id="l7.348" class="difflineplus">+  be_in_folder(folderB);</span>
<a href="#l7.349"></a><span id="l7.349" class="difflineplus">+  assert_visible_columns(reorderdB);</span>
<a href="#l7.350"></a><span id="l7.350" class="difflineplus">+</span>
<a href="#l7.351"></a><span id="l7.351" class="difflineplus">+  close_tab(tabB);</span>
<a href="#l7.352"></a><span id="l7.352" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-folder-display-helpers.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-folder-display-helpers.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -124,27 +124,30 @@ function setupModule() {</span>
<a href="#l8.4"></a><span id="l8.4">   msgGen = new messageGenerator.MessageGenerator();</span>
<a href="#l8.5"></a><span id="l8.5">   viewWrapperTestUtils.gMessageGenerator = msgGen;</span>
<a href="#l8.6"></a><span id="l8.6">   viewWrapperTestUtils.gMessageScenarioFactory =</span>
<a href="#l8.7"></a><span id="l8.7">     new messageGenerator.MessageScenarioFactory(msgGen);</span>
<a href="#l8.8"></a><span id="l8.8"> </span>
<a href="#l8.9"></a><span id="l8.9">   make_new_sets_in_folders = make_new_sets_in_folder =</span>
<a href="#l8.10"></a><span id="l8.10">     viewWrapperTestUtils.make_new_sets_in_folders;</span>
<a href="#l8.11"></a><span id="l8.11">   add_sets_to_folders = viewWrapperTestUtils.add_sets_to_folders;</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+  create_virtual_folder = viewWrapperTestUtils.make_virtual_folder;</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+</span>
<a href="#l8.14"></a><span id="l8.14">   viewWrapperTestUtils.Ci = Ci;</span>
<a href="#l8.15"></a><span id="l8.15">   viewWrapperTestUtils.Cu = Cu;</span>
<a href="#l8.16"></a><span id="l8.16">   viewWrapperTestUtils.Cc = Cc;</span>
<a href="#l8.17"></a><span id="l8.17"> </span>
<a href="#l8.18"></a><span id="l8.18">   // use window-helper's augment_controller method to get our extra good stuff</span>
<a href="#l8.19"></a><span id="l8.19">   //  we need.</span>
<a href="#l8.20"></a><span id="l8.20">   windowHelper = collector.getModule('window-helpers');</span>
<a href="#l8.21"></a><span id="l8.21">   mc = mainController = windowHelper.wait_for_existing_window(&quot;mail:3pane&quot;);</span>
<a href="#l8.22"></a><span id="l8.22">   windowHelper.augment_controller(mc);</span>
<a href="#l8.23"></a><span id="l8.23"> </span>
<a href="#l8.24"></a><span id="l8.24">   setupAccountStuff();</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineplus">+  viewWrapperTestUtils.gLocalIncomingServer = gLocalIncomingServer;</span>
<a href="#l8.26"></a><span id="l8.26"> }</span>
<a href="#l8.27"></a><span id="l8.27"> </span>
<a href="#l8.28"></a><span id="l8.28"> /**</span>
<a href="#l8.29"></a><span id="l8.29">  * Install this module into the provided module.</span>
<a href="#l8.30"></a><span id="l8.30">  */</span>
<a href="#l8.31"></a><span id="l8.31"> function installInto(module) {</span>
<a href="#l8.32"></a><span id="l8.32">   setupModule();</span>
<a href="#l8.33"></a><span id="l8.33"> </span>
<a href="#l8.34"></a><span id="l8.34" class="difflineat">@@ -166,17 +169,18 @@ function setupAccountStuff() {</span>
<a href="#l8.35"></a><span id="l8.35"> </span>
<a href="#l8.36"></a><span id="l8.36">   gLocalIncomingServer = acctMgr.localFoldersServer;</span>
<a href="#l8.37"></a><span id="l8.37"> </span>
<a href="#l8.38"></a><span id="l8.38">   rootFolder = gLocalIncomingServer.rootMsgFolder;</span>
<a href="#l8.39"></a><span id="l8.39">   // Note: Inbox is not created automatically when there is no deferred server,</span>
<a href="#l8.40"></a><span id="l8.40">   // so we need to create it.</span>
<a href="#l8.41"></a><span id="l8.41">   gLocalInboxFolder = rootFolder.addSubfolder(&quot;Inbox&quot;);</span>
<a href="#l8.42"></a><span id="l8.42">   // a local inbox should have a Mail flag!</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineminus">-  gLocalInboxFolder.setFlag(Components.interfaces.nsMsgFolderFlags.Mail);</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineplus">+  gLocalInboxFolder.setFlag(Ci.nsMsgFolderFlags.Mail);</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineplus">+  gLocalInboxFolder.setFlag(Ci.nsMsgFolderFlags.Inbox);</span>
<a href="#l8.46"></a><span id="l8.46"> </span>
<a href="#l8.47"></a><span id="l8.47">   // Force an initialization of the Inbox folder database.</span>
<a href="#l8.48"></a><span id="l8.48">   var folderName = gLocalInboxFolder.prettiestName;</span>
<a href="#l8.49"></a><span id="l8.49"> </span>
<a href="#l8.50"></a><span id="l8.50">   gLocalInboxFolder = rootFolder.getChildNamed(&quot;Inbox&quot;);</span>
<a href="#l8.51"></a><span id="l8.51"> }</span>
<a href="#l8.52"></a><span id="l8.52"> </span>
<a href="#l8.53"></a><span id="l8.53"> /*</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineat">@@ -195,32 +199,50 @@ const FAST_INTERVAL = 100;</span>
<a href="#l8.55"></a><span id="l8.55">  */</span>
<a href="#l8.56"></a><span id="l8.56"> function create_folder(aFolderName) {</span>
<a href="#l8.57"></a><span id="l8.57">   let folder = rootFolder.addSubfolder(aFolderName);</span>
<a href="#l8.58"></a><span id="l8.58">   mc.folderTreeView.mode = &quot;all&quot;;</span>
<a href="#l8.59"></a><span id="l8.59">   return folder;</span>
<a href="#l8.60"></a><span id="l8.60"> }</span>
<a href="#l8.61"></a><span id="l8.61"> </span>
<a href="#l8.62"></a><span id="l8.62"> /**</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineplus">+ * Create a virtual folder by deferring to |make_virtual_folder| and making</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineplus">+ *  sure to rebuild the folder tree afterwards.</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineplus">+ */</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineplus">+function create_virtual_folder() {</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineplus">+  let folder = viewWrapperTestUtils.make_virtual_folder.apply(null, arguments);</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineplus">+  mc.folderTreeView.mode = &quot;all&quot;;</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineplus">+  return folder;</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineplus">+}</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineplus">+</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineplus">+</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineplus">+/**</span>
<a href="#l8.74"></a><span id="l8.74">  * Create a thread with the specified number of messages in it.</span>
<a href="#l8.75"></a><span id="l8.75">  */</span>
<a href="#l8.76"></a><span id="l8.76"> function create_thread(aCount) {</span>
<a href="#l8.77"></a><span id="l8.77">   return new viewWrapperTestUtils.SyntheticMessageSet(viewWrapperTestUtils.gMessageScenarioFactory.directReply(aCount));</span>
<a href="#l8.78"></a><span id="l8.78"> }</span>
<a href="#l8.79"></a><span id="l8.79"> </span>
<a href="#l8.80"></a><span id="l8.80"> /**</span>
<a href="#l8.81"></a><span id="l8.81">  * Make sure we are entering the folder from not having been in the folder.  We</span>
<a href="#l8.82"></a><span id="l8.82">  *  will leave the folder and come back if we have to.</span>
<a href="#l8.83"></a><span id="l8.83">  */</span>
<a href="#l8.84"></a><span id="l8.84"> function enter_folder(aFolder) {</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineplus">+  // Drain the event queue prior to doing any work.  It's possible that there's</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineplus">+  //  a pending setTimeout(0) that needs to get fired.</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineplus">+  controller.sleep(0);</span>
<a href="#l8.88"></a><span id="l8.88">   // if we're already selected, go back to the root...</span>
<a href="#l8.89"></a><span id="l8.89">   if (mc.folderDisplay.displayedFolder == aFolder)</span>
<a href="#l8.90"></a><span id="l8.90">     enter_folder(aFolder.rootFolder);</span>
<a href="#l8.91"></a><span id="l8.91"> </span>
<a href="#l8.92"></a><span id="l8.92">   mc.folderTreeView.selectFolder(aFolder);</span>
<a href="#l8.93"></a><span id="l8.93" class="difflineplus">+  // XXX betrayal at startup involving the inbox can happen, so force the folder</span>
<a href="#l8.94"></a><span id="l8.94" class="difflineplus">+  //  to be shown in that case.</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineplus">+  if (mc.folderDisplay.displayedFolder != aFolder)</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineplus">+    mc.folderDisplay.show(aFolder);</span>
<a href="#l8.97"></a><span id="l8.97">   wait_for_all_messages_to_load();</span>
<a href="#l8.98"></a><span id="l8.98">   // and drain the event queue</span>
<a href="#l8.99"></a><span id="l8.99">   controller.sleep(0);</span>
<a href="#l8.100"></a><span id="l8.100"> }</span>
<a href="#l8.101"></a><span id="l8.101"> </span>
<a href="#l8.102"></a><span id="l8.102"> /**</span>
<a href="#l8.103"></a><span id="l8.103">  * Make sure we are in the given folder, entering it if we were not.</span>
<a href="#l8.104"></a><span id="l8.104">  *</span>
<a href="#l8.105"></a><span id="l8.105" class="difflineat">@@ -763,22 +785,16 @@ function press_enter(aController) {</span>
<a href="#l8.106"></a><span id="l8.106">  *  search.</span>
<a href="#l8.107"></a><span id="l8.107">  * This method is generally called automatically most of the time, and you</span>
<a href="#l8.108"></a><span id="l8.108">  *  should not need to call it yourself unless you are operating outside the</span>
<a href="#l8.109"></a><span id="l8.109">  *  helper methods in this file.</span>
<a href="#l8.110"></a><span id="l8.110">  */</span>
<a href="#l8.111"></a><span id="l8.111"> function wait_for_all_messages_to_load(aController) {</span>
<a href="#l8.112"></a><span id="l8.112">   if (aController === undefined)</span>
<a href="#l8.113"></a><span id="l8.113">     aController = mc;</span>
<a href="#l8.114"></a><span id="l8.114" class="difflineminus">-  if (aController.allMessagesLoaded) {</span>
<a href="#l8.115"></a><span id="l8.115" class="difflineminus">-    // even though we're taking the fast-path out, let's give the event loop a</span>
<a href="#l8.116"></a><span id="l8.116" class="difflineminus">-    //  chance to drain.</span>
<a href="#l8.117"></a><span id="l8.117" class="difflineminus">-    aController.sleep(0);</span>
<a href="#l8.118"></a><span id="l8.118" class="difflineminus">-    return;</span>
<a href="#l8.119"></a><span id="l8.119" class="difflineminus">-  }</span>
<a href="#l8.120"></a><span id="l8.120">   if(!controller.waitForEval('subject.allMessagesLoaded', NORMAL_TIMEOUT,</span>
<a href="#l8.121"></a><span id="l8.121">                               FAST_INTERVAL, aController.folderDisplay))</span>
<a href="#l8.122"></a><span id="l8.122">     throw new Error(&quot;Messages never finished loading.  Timed Out.&quot;);</span>
<a href="#l8.123"></a><span id="l8.123">   // the above may return immediately, meaning the event queue might not get a</span>
<a href="#l8.124"></a><span id="l8.124">   //  chance.  give it a chance now.</span>
<a href="#l8.125"></a><span id="l8.125">   aController.sleep(0);</span>
<a href="#l8.126"></a><span id="l8.126"> }</span>
<a href="#l8.127"></a><span id="l8.127"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/base/src/dbViewWrapper.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/base/src/dbViewWrapper.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -431,21 +431,37 @@ IDBViewWrapperListener.prototype = {</span>
<a href="#l9.4"></a><span id="l9.4">    *     new view to display the same folder after we destroy this view.  This</span>
<a href="#l9.5"></a><span id="l9.5">    *     will be the case unless we are switching to display a new folder or</span>
<a href="#l9.6"></a><span id="l9.6">    *     closing the view wrapper entirely.</span>
<a href="#l9.7"></a><span id="l9.7">    */</span>
<a href="#l9.8"></a><span id="l9.8">   onDestroyingView: function(aFolderIsComingBack) {</span>
<a href="#l9.9"></a><span id="l9.9">   },</span>
<a href="#l9.10"></a><span id="l9.10"> </span>
<a href="#l9.11"></a><span id="l9.11">   /**</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+   * Generated when we are loading information about the folder from its</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+   *  dbFolderInfo.  The dbFolderInfo object is passed in.</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+   * The DBViewWrapper has already restored its state when this function is</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+   *  called, but has not yet created the dbView.  A view update is in process,</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+   *  so the view settings can be changed and will take effect when the update</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+   *  is closed.</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+   * |onDisplayingFolder| is the next expected notification following this</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineplus">+   *  notification.</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineplus">+   */</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineplus">+  onLoadingFolder: function(aDbFolderInfo) {</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineplus">+  },</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineplus">+</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineplus">+  /**</span>
<a href="#l9.25"></a><span id="l9.25">    * Generated when the folder is being entered for display.  This is the chance</span>
<a href="#l9.26"></a><span id="l9.26">    *  for the listener to affect any UI-related changes to the folder required.</span>
<a href="#l9.27"></a><span id="l9.27">    *  Currently, this just means setting the header cache size (which needs to</span>
<a href="#l9.28"></a><span id="l9.28">    *  be proportional to the number of lines in the tree view, and is thus a</span>
<a href="#l9.29"></a><span id="l9.29">    *  UI issue.)</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineplus">+   * The dbView has already been created and is valid when this function is</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineplus">+   *  called.</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+   * |onLoadingFolder| is called before this notification.</span>
<a href="#l9.33"></a><span id="l9.33">    */</span>
<a href="#l9.34"></a><span id="l9.34">   onDisplayingFolder: function() {</span>
<a href="#l9.35"></a><span id="l9.35">   },</span>
<a href="#l9.36"></a><span id="l9.36"> </span>
<a href="#l9.37"></a><span id="l9.37">   /**</span>
<a href="#l9.38"></a><span id="l9.38">    * Generated when we are leaving a folder.</span>
<a href="#l9.39"></a><span id="l9.39">    */</span>
<a href="#l9.40"></a><span id="l9.40">   onLeavingFolder: function() {</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineat">@@ -1002,16 +1018,18 @@ DBViewWrapper.prototype = {</span>
<a href="#l9.42"></a><span id="l9.42">             ((MailViewConstants.kViewItemTags + 2 &lt;= mailViewIndex) &amp;&amp;</span>
<a href="#l9.43"></a><span id="l9.43">              (mailViewIndex &lt; MailViewConstants.kViewItemVirtual)))</span>
<a href="#l9.44"></a><span id="l9.44">           this.setMailView(MailViewConstants.kViewItemTags,</span>
<a href="#l9.45"></a><span id="l9.45">                            &quot;$label&quot; + (mailViewIndex-1));</span>
<a href="#l9.46"></a><span id="l9.46">         else</span>
<a href="#l9.47"></a><span id="l9.47">           this.setMailView(mailViewIndex);</span>
<a href="#l9.48"></a><span id="l9.48">       }</span>
<a href="#l9.49"></a><span id="l9.49">     }</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineplus">+</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineplus">+    this.listener.onLoadingFolder(dbFolderInfo);</span>
<a href="#l9.52"></a><span id="l9.52">   },</span>
<a href="#l9.53"></a><span id="l9.53"> </span>
<a href="#l9.54"></a><span id="l9.54">   /**</span>
<a href="#l9.55"></a><span id="l9.55">    * Creates a view appropriate to the current settings of the folder display</span>
<a href="#l9.56"></a><span id="l9.56">    *  widget, returning it.  The caller is responsible to assign the result to</span>
<a href="#l9.57"></a><span id="l9.57">    *  this.dbView (or whatever it wants to do with it.)</span>
<a href="#l9.58"></a><span id="l9.58">    */</span>
<a href="#l9.59"></a><span id="l9.59">   _createView: function DBViewWrapper__createView() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/mailnews.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/mailnews.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -709,18 +709,18 @@ pref(&quot;mailnews.use_received_date&quot;, false</span>
<a href="#l10.4"></a><span id="l10.4"> // 1 -&gt; 2 is for the folder pane tree landing, to hide the</span>
<a href="#l10.5"></a><span id="l10.5"> // unread and total columns, see msgMail3PaneWindow.js</span>
<a href="#l10.6"></a><span id="l10.6"> pref(&quot;mail.ui.folderpane.version&quot;, 1);</span>
<a href="#l10.7"></a><span id="l10.7"> </span>
<a href="#l10.8"></a><span id="l10.8"> // for manual upgrades of certain UI features.</span>
<a href="#l10.9"></a><span id="l10.9"> #ifdef MOZ_SUITE</span>
<a href="#l10.10"></a><span id="l10.10"> pref(&quot;mailnews.ui.threadpane.version&quot;, 5);</span>
<a href="#l10.11"></a><span id="l10.11"> #else</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-// Thunderbird still needs version 1.</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-pref(&quot;mailnews.ui.threadpane.version&quot;, 1);</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+// Thunderbird uses this pref in msgMail3PaneWindow.js for bad reasons.</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+pref(&quot;mailnews.ui.threadpane.version&quot;, 7);</span>
<a href="#l10.16"></a><span id="l10.16"> #endif</span>
<a href="#l10.17"></a><span id="l10.17"> // for manual upgrades of certain UI features.</span>
<a href="#l10.18"></a><span id="l10.18"> // 1 -&gt; 2 is for the ab results pane tree landing</span>
<a href="#l10.19"></a><span id="l10.19"> // to hide the non default columns in the addressbook dialog</span>
<a href="#l10.20"></a><span id="l10.20"> // see abCommon.js and addressbook.js</span>
<a href="#l10.21"></a><span id="l10.21"> pref(&quot;mailnews.ui.addressbook_results.version&quot;, 1);</span>
<a href="#l10.22"></a><span id="l10.22"> // for manual upgrades of certain UI features.</span>
<a href="#l10.23"></a><span id="l10.23"> // 1 -&gt; 2 is for the ab results pane tree landing</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/test/resources/viewWrapperTestUtils.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/test/resources/viewWrapperTestUtils.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -314,19 +314,20 @@ SEARCH_TERM_MAP_HELPER = {</span>
<a href="#l11.4"></a><span id="l11.4">  * Create and return a virtual folder.</span>
<a href="#l11.5"></a><span id="l11.5">  *</span>
<a href="#l11.6"></a><span id="l11.6">  * @param aFolders The real folders this virtual folder should draw from.</span>
<a href="#l11.7"></a><span id="l11.7">  * @param aSearchDef The search definition to use to build the list of search</span>
<a href="#l11.8"></a><span id="l11.8">  *     terms that populate this virtual folder.  Keys should be stuff from</span>
<a href="#l11.9"></a><span id="l11.9">  *     SEARCH_TERM_MAP_HELPER and values should be strings to search for within</span>
<a href="#l11.10"></a><span id="l11.10">  *     those attribute things.</span>
<a href="#l11.11"></a><span id="l11.11">  * @param aBooleanAnd Should the search terms be and-ed together.</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+ * @param [aName] Name to use.</span>
<a href="#l11.13"></a><span id="l11.13">  */</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineminus">-function make_virtual_folder(aFolders, aSearchDef, aBooleanAnd) {</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineminus">-  let name = &quot;virt&quot; + gNextUniqueFolderId++;</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineplus">+function make_virtual_folder(aFolders, aSearchDef, aBooleanAnd, aName) {</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineplus">+  let name = aName ? aName : &quot;virt&quot; + gNextUniqueFolderId++;</span>
<a href="#l11.18"></a><span id="l11.18"> </span>
<a href="#l11.19"></a><span id="l11.19">   let terms = [];</span>
<a href="#l11.20"></a><span id="l11.20">   let termCreator = Components.classes[&quot;@mozilla.org/messenger/searchSession;1&quot;]</span>
<a href="#l11.21"></a><span id="l11.21">                               .createInstance(Ci.nsIMsgSearchSession);</span>
<a href="#l11.22"></a><span id="l11.22">   for each (let [key, val] in Iterator(aSearchDef)) {</span>
<a href="#l11.23"></a><span id="l11.23">     let term = termCreator.createTerm();</span>
<a href="#l11.24"></a><span id="l11.24">     let value = term.value;</span>
<a href="#l11.25"></a><span id="l11.25">     value.str = val;</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

