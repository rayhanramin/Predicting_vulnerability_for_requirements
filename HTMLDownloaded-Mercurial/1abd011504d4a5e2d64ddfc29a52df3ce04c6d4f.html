<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 12362:1abd011504d4a5e2d64ddfc29a52df3ce04c6d4f</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 1abd011504d4a5e2d64ddfc29a52df3ce04c6d4f" />
<meta property="og:url" content="/comm-central/rev/1abd011504d4a5e2d64ddfc29a52df3ce04c6d4f" />
<meta property="og:description" content="Bug 735333 - Use Services.prefs in SeaMonkey code: Feeds. r=Neil" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 1abd011504d4a5e2d64ddfc29a52df3ce04c6d4f 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/1abd011504d4a5e2d64ddfc29a52df3ce04c6d4f">shortlog</a> |
<a href="/comm-central/log/1abd011504d4a5e2d64ddfc29a52df3ce04c6d4f">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/1abd011504d4a5e2d64ddfc29a52df3ce04c6d4f">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/1abd011504d4a5e2d64ddfc29a52df3ce04c6d4f">files</a> |
changeset |
<a href="/comm-central/raw-rev/1abd011504d4a5e2d64ddfc29a52df3ce04c6d4f">raw</a>  | <a href="/comm-central/archive/1abd011504d4a5e2d64ddfc29a52df3ce04c6d4f.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=735333">Bug 735333</a> - Use Services.prefs in SeaMonkey code: Feeds. r=Neil
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#83;&#101;&#98;&#97;&#115;&#116;&#105;&#97;&#110;&#32;&#72;&#101;&#110;&#103;&#115;&#116;&#32;&#60;&#97;&#114;&#99;&#104;&#97;&#101;&#111;&#112;&#116;&#101;&#114;&#121;&#120;&#64;&#99;&#111;&#111;&#108;&#101;&#45;&#102;&#105;&#108;&#101;&#115;&#46;&#100;&#101;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 19 Nov 2012 19:56:50 +0100</td></tr>

<tr>
 <td>changeset 12362</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/1abd011504d4a5e2d64ddfc29a52df3ce04c6d4f">1abd011504d4a5e2d64ddfc29a52df3ce04c6d4f</a></td>
</tr>



<tr>
<td>parent 12361</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/f6139533313a491a428d40a67fb41e30ed463e23">f6139533313a491a428d40a67fb41e30ed463e23</a>
</td>
</tr>

<tr>
<td>child 12363</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/9469da28530bbdc13559d3378169209111af56ce">9469da28530bbdc13559d3378169209111af56ce</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=1abd011504d4a5e2d64ddfc29a52df3ce04c6d4f">9128</a></td></tr>
<tr><td>push user</td><td>mcsmurf@mcsmurf.de</td></tr>
<tr><td>push date</td><td class="date age">Mon, 29 Apr 2013 13:32:38 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@578c72b610fc [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=578c72b610fc8f8970693c7514f0d401b001458f">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=578c72b610fc8f8970693c7514f0d401b001458f&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=578c72b610fc8f8970693c7514f0d401b001458f&newProject=comm-central&newRevision=72c20852b189b4635b6f6001e5cba6ecef9473f1&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=578c72b610fc8f8970693c7514f0d401b001458f&newProject=comm-central&newRevision=72c20852b189b4635b6f6001e5cba6ecef9473f1&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=578c72b610fc8f8970693c7514f0d401b001458f&newProject=comm-central&newRevision=72c20852b189b4635b6f6001e5cba6ecef9473f1&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28Neil%29&revcount=50">Neil</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=735333">735333</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=735333">Bug 735333</a> - Use Services.prefs in SeaMonkey code: Feeds. r=Neil</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1abd011504d4a5e2d64ddfc29a52df3ce04c6d4f/suite/feeds/src/FeedConverter.js">suite/feeds/src/FeedConverter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1abd011504d4a5e2d64ddfc29a52df3ce04c6d4f/suite/feeds/src/FeedConverter.js">file</a> |
<a href="/comm-central/annotate/1abd011504d4a5e2d64ddfc29a52df3ce04c6d4f/suite/feeds/src/FeedConverter.js">annotate</a> |
<a href="/comm-central/diff/1abd011504d4a5e2d64ddfc29a52df3ce04c6d4f/suite/feeds/src/FeedConverter.js">diff</a> |
<a href="/comm-central/comparison/1abd011504d4a5e2d64ddfc29a52df3ce04c6d4f/suite/feeds/src/FeedConverter.js">comparison</a> |
<a href="/comm-central/log/1abd011504d4a5e2d64ddfc29a52df3ce04c6d4f/suite/feeds/src/FeedConverter.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1abd011504d4a5e2d64ddfc29a52df3ce04c6d4f/suite/feeds/src/FeedWriter.js">suite/feeds/src/FeedWriter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1abd011504d4a5e2d64ddfc29a52df3ce04c6d4f/suite/feeds/src/FeedWriter.js">file</a> |
<a href="/comm-central/annotate/1abd011504d4a5e2d64ddfc29a52df3ce04c6d4f/suite/feeds/src/FeedWriter.js">annotate</a> |
<a href="/comm-central/diff/1abd011504d4a5e2d64ddfc29a52df3ce04c6d4f/suite/feeds/src/FeedWriter.js">diff</a> |
<a href="/comm-central/comparison/1abd011504d4a5e2d64ddfc29a52df3ce04c6d4f/suite/feeds/src/FeedWriter.js">comparison</a> |
<a href="/comm-central/log/1abd011504d4a5e2d64ddfc29a52df3ce04c6d4f/suite/feeds/src/FeedWriter.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1abd011504d4a5e2d64ddfc29a52df3ce04c6d4f/suite/feeds/src/WebContentConverter.js">suite/feeds/src/WebContentConverter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1abd011504d4a5e2d64ddfc29a52df3ce04c6d4f/suite/feeds/src/WebContentConverter.js">file</a> |
<a href="/comm-central/annotate/1abd011504d4a5e2d64ddfc29a52df3ce04c6d4f/suite/feeds/src/WebContentConverter.js">annotate</a> |
<a href="/comm-central/diff/1abd011504d4a5e2d64ddfc29a52df3ce04c6d4f/suite/feeds/src/WebContentConverter.js">diff</a> |
<a href="/comm-central/comparison/1abd011504d4a5e2d64ddfc29a52df3ce04c6d4f/suite/feeds/src/WebContentConverter.js">comparison</a> |
<a href="/comm-central/log/1abd011504d4a5e2d64ddfc29a52df3ce04c6d4f/suite/feeds/src/WebContentConverter.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/suite/feeds/src/FeedConverter.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/suite/feeds/src/FeedConverter.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -77,32 +77,27 @@ function getPrefReaderForType(t) {</span>
<a href="#l1.4"></a><span id="l1.4">       return PREF_AUDIO_SELECTED_READER;</span>
<a href="#l1.5"></a><span id="l1.5"> </span>
<a href="#l1.6"></a><span id="l1.6">     default:</span>
<a href="#l1.7"></a><span id="l1.7">       return PREF_SELECTED_READER;</span>
<a href="#l1.8"></a><span id="l1.8">   }</span>
<a href="#l1.9"></a><span id="l1.9"> }</span>
<a href="#l1.10"></a><span id="l1.10"> </span>
<a href="#l1.11"></a><span id="l1.11"> function LOG(str) {</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-  var prefs = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-                        .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-</span>
<a href="#l1.15"></a><span id="l1.15">   try {</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineminus">-    if (prefs.getBoolPref(&quot;feeds.log&quot;))</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+    if (Services.prefs.getBoolPref(&quot;feeds.log&quot;))</span>
<a href="#l1.18"></a><span id="l1.18">       dump(&quot;*** Feeds: &quot; + str + &quot;\n&quot;);</span>
<a href="#l1.19"></a><span id="l1.19">   }</span>
<a href="#l1.20"></a><span id="l1.20">   catch (ex) {</span>
<a href="#l1.21"></a><span id="l1.21">   }</span>
<a href="#l1.22"></a><span id="l1.22"> }</span>
<a href="#l1.23"></a><span id="l1.23"> </span>
<a href="#l1.24"></a><span id="l1.24"> function safeGetCharPref(pref, defaultValue) {</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineminus">-  var prefs = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineminus">-                        .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l1.27"></a><span id="l1.27">   try {</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineminus">-    return prefs.getCharPref(pref);</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineplus">+    return Services.prefs.getCharPref(pref);</span>
<a href="#l1.30"></a><span id="l1.30">   }</span>
<a href="#l1.31"></a><span id="l1.31">   catch (e) {</span>
<a href="#l1.32"></a><span id="l1.32">   }</span>
<a href="#l1.33"></a><span id="l1.33">   return defaultValue;</span>
<a href="#l1.34"></a><span id="l1.34"> }</span>
<a href="#l1.35"></a><span id="l1.35"> </span>
<a href="#l1.36"></a><span id="l1.36"> function FeedConverter() {</span>
<a href="#l1.37"></a><span id="l1.37">   this._ioSvc = Components.classes[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineat">@@ -355,27 +350,24 @@ FeedResultService.prototype = {</span>
<a href="#l1.39"></a><span id="l1.39">    * See nsIFeedResultService.idl</span>
<a href="#l1.40"></a><span id="l1.40">    */</span>
<a href="#l1.41"></a><span id="l1.41">   forcePreviewPage: false,</span>
<a href="#l1.42"></a><span id="l1.42"> </span>
<a href="#l1.43"></a><span id="l1.43">   /**</span>
<a href="#l1.44"></a><span id="l1.44">    * See nsIFeedResultService.idl</span>
<a href="#l1.45"></a><span id="l1.45">    */</span>
<a href="#l1.46"></a><span id="l1.46">   addToClientReader: function addToClientReader(spec, title, subtitle, feedType) {</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineminus">-    var prefs = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineminus">-                          .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineminus">-</span>
<a href="#l1.50"></a><span id="l1.50">     var handler = safeGetCharPref(getPrefActionForType(feedType), &quot;reader&quot;);</span>
<a href="#l1.51"></a><span id="l1.51">     if (handler == &quot;ask&quot; || handler == &quot;reader&quot;)</span>
<a href="#l1.52"></a><span id="l1.52">       handler = safeGetCharPref(getPrefReaderForType(feedType), &quot;messenger&quot;);</span>
<a href="#l1.53"></a><span id="l1.53"> </span>
<a href="#l1.54"></a><span id="l1.54">     switch (handler) {</span>
<a href="#l1.55"></a><span id="l1.55">     case &quot;client&quot;:</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineminus">-      var clientApp = prefs.getComplexValue(getPrefAppForType(feedType),</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineminus">-                                            Components.interfaces.nsILocalFile);</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineplus">+      var clientApp = Services.prefs.getComplexValue(getPrefAppForType(feedType),</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineplus">+                                                     Components.interfaces.nsILocalFile);</span>
<a href="#l1.60"></a><span id="l1.60"> </span>
<a href="#l1.61"></a><span id="l1.61">       // For the benefit of applications that might know how to deal with more</span>
<a href="#l1.62"></a><span id="l1.62">       // URLs than just feeds, send feed: URLs in the following format:</span>
<a href="#l1.63"></a><span id="l1.63">       //</span>
<a href="#l1.64"></a><span id="l1.64">       // http urls: replace scheme with feed, e.g.</span>
<a href="#l1.65"></a><span id="l1.65">       // http://foo.com/index.rdf -&gt; feed://foo.com/index.rdf</span>
<a href="#l1.66"></a><span id="l1.66">       // other urls: prepend feed: scheme, e.g.</span>
<a href="#l1.67"></a><span id="l1.67">       // https://foo.com/index.rdf -&gt; feed:https://foo.com/index.rdf</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/suite/feeds/src/FeedWriter.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/suite/feeds/src/FeedWriter.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -1,13 +1,14 @@</span>
<a href="#l2.4"></a><span id="l2.4"> /* -*- Mode: Javascript; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l2.5"></a><span id="l2.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l2.6"></a><span id="l2.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l2.7"></a><span id="l2.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l2.8"></a><span id="l2.8"> </span>
<a href="#l2.9"></a><span id="l2.9" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l2.10"></a><span id="l2.10"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12"> const FEEDWRITER_CID = Components.ID(&quot;{49bb6593-3aff-4eb3-a068-2712c28bd58e}&quot;);</span>
<a href="#l2.13"></a><span id="l2.13"> const FEEDWRITER_CONTRACTID = &quot;@mozilla.org/browser/feeds/result-writer;1&quot;;</span>
<a href="#l2.14"></a><span id="l2.14"> </span>
<a href="#l2.15"></a><span id="l2.15"> const XML_NS = &quot;http://www.w3.org/XML/1998/namespace&quot;;</span>
<a href="#l2.16"></a><span id="l2.16"> const HTML_NS = &quot;http://www.w3.org/1999/xhtml&quot;;</span>
<a href="#l2.17"></a><span id="l2.17"> const XUL_NS = &quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;;</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineat">@@ -85,32 +86,27 @@ function getPrefReaderForType(t) {</span>
<a href="#l2.19"></a><span id="l2.19">       return PREF_AUDIO_SELECTED_READER;</span>
<a href="#l2.20"></a><span id="l2.20"> </span>
<a href="#l2.21"></a><span id="l2.21">     default:</span>
<a href="#l2.22"></a><span id="l2.22">       return PREF_SELECTED_READER;</span>
<a href="#l2.23"></a><span id="l2.23">   }</span>
<a href="#l2.24"></a><span id="l2.24"> }</span>
<a href="#l2.25"></a><span id="l2.25"> </span>
<a href="#l2.26"></a><span id="l2.26"> function LOG(str) {</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineminus">-  var prefs = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineminus">-                        .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineminus">-</span>
<a href="#l2.30"></a><span id="l2.30">   try {</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-    if (prefs.getBoolPref(&quot;feeds.log&quot;))</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+    if (Services.prefs.getBoolPref(&quot;feeds.log&quot;))</span>
<a href="#l2.33"></a><span id="l2.33">       dump(&quot;*** Feeds: &quot; + str + &quot;\n&quot;);</span>
<a href="#l2.34"></a><span id="l2.34">   }</span>
<a href="#l2.35"></a><span id="l2.35">   catch (ex) {</span>
<a href="#l2.36"></a><span id="l2.36">   }</span>
<a href="#l2.37"></a><span id="l2.37"> }</span>
<a href="#l2.38"></a><span id="l2.38"> </span>
<a href="#l2.39"></a><span id="l2.39"> function safeGetCharPref(pref, defaultValue) {</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineminus">-  var prefs = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineminus">-                        .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l2.42"></a><span id="l2.42">   try {</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineminus">-    return prefs.getCharPref(pref);</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineplus">+    return Services.prefs.getCharPref(pref);</span>
<a href="#l2.45"></a><span id="l2.45">   }</span>
<a href="#l2.46"></a><span id="l2.46">   catch (e) {</span>
<a href="#l2.47"></a><span id="l2.47">   }</span>
<a href="#l2.48"></a><span id="l2.48">   return defaultValue;</span>
<a href="#l2.49"></a><span id="l2.49"> }</span>
<a href="#l2.50"></a><span id="l2.50"> </span>
<a href="#l2.51"></a><span id="l2.51"> /**</span>
<a href="#l2.52"></a><span id="l2.52">  * Wrapper function for nsIIOService::newURI.</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineat">@@ -824,39 +820,37 @@ FeedWriter.prototype = {</span>
<a href="#l2.54"></a><span id="l2.54">           break;</span>
<a href="#l2.55"></a><span id="l2.55">         default:</span>
<a href="#l2.56"></a><span id="l2.56">           this._setAlwaysUseLabel();</span>
<a href="#l2.57"></a><span id="l2.57">       }</span>
<a href="#l2.58"></a><span id="l2.58">     }</span>
<a href="#l2.59"></a><span id="l2.59">   },</span>
<a href="#l2.60"></a><span id="l2.60"> </span>
<a href="#l2.61"></a><span id="l2.61">   _setSelectedHandler: function setSelectedHandler(feedType) {</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineminus">-    var prefs = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineminus">-                          .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l2.64"></a><span id="l2.64">     var handler = safeGetCharPref(getPrefReaderForType(feedType), &quot;messenger&quot;);</span>
<a href="#l2.65"></a><span id="l2.65"> </span>
<a href="#l2.66"></a><span id="l2.66">     switch (handler) {</span>
<a href="#l2.67"></a><span id="l2.67">       case &quot;web&quot;:</span>
<a href="#l2.68"></a><span id="l2.68">         if (this._handlersMenuList) {</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineminus">-          var url = prefs.getComplexValue(getPrefWebForType(feedType),</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineminus">-                                          Components.interfaces.nsISupportsString).data;</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineplus">+          var url = Services.prefs.getComplexValue(getPrefWebForType(feedType),</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineplus">+                                                   Components.interfaces.nsISupportsString).data;</span>
<a href="#l2.73"></a><span id="l2.73">           var handlers = this._handlersMenuList.getElementsByAttribute(&quot;webhandlerurl&quot;, url);</span>
<a href="#l2.74"></a><span id="l2.74">           if (handlers.length == 0) {</span>
<a href="#l2.75"></a><span id="l2.75">             LOG(&quot;FeedWriter._setSelectedHandler: selected web handler isn't in the menulist&quot;);</span>
<a href="#l2.76"></a><span id="l2.76">             return;</span>
<a href="#l2.77"></a><span id="l2.77">           }</span>
<a href="#l2.78"></a><span id="l2.78"> </span>
<a href="#l2.79"></a><span id="l2.79">           this._safeDoCommand(handlers[0]);</span>
<a href="#l2.80"></a><span id="l2.80">         }</span>
<a href="#l2.81"></a><span id="l2.81">         break;</span>
<a href="#l2.82"></a><span id="l2.82">       case &quot;client&quot;:</span>
<a href="#l2.83"></a><span id="l2.83">         try {</span>
<a href="#l2.84"></a><span id="l2.84">           this._selectedApp =</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineminus">-            prefs.getComplexValue(getPrefAppForType(feedType),</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineminus">-                                  Components.interfaces.nsILocalFile);</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineplus">+            Services.prefs.getComplexValue(getPrefAppForType(feedType),</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineplus">+                                           Components.interfaces.nsILocalFile);</span>
<a href="#l2.89"></a><span id="l2.89">         }</span>
<a href="#l2.90"></a><span id="l2.90">         catch(ex) {</span>
<a href="#l2.91"></a><span id="l2.91">           this._selectedApp = null;</span>
<a href="#l2.92"></a><span id="l2.92">         }</span>
<a href="#l2.93"></a><span id="l2.93"> </span>
<a href="#l2.94"></a><span id="l2.94">         if (this._selectedApp) {</span>
<a href="#l2.95"></a><span id="l2.95">           this._initMenuItemWithFile(this._contentSandbox.selectedAppMenuItem,</span>
<a href="#l2.96"></a><span id="l2.96">                                      this._selectedApp);</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineat">@@ -914,20 +908,18 @@ FeedWriter.prototype = {</span>
<a href="#l2.98"></a><span id="l2.98"> </span>
<a href="#l2.99"></a><span id="l2.99">     // Last-selected application</span>
<a href="#l2.100"></a><span id="l2.100">     var menuItem = liveBookmarksMenuItem.cloneNode(false);</span>
<a href="#l2.101"></a><span id="l2.101">     menuItem.removeAttribute(&quot;selected&quot;);</span>
<a href="#l2.102"></a><span id="l2.102">     menuItem.setAttribute(&quot;anonid&quot;, &quot;selectedAppMenuItem&quot;);</span>
<a href="#l2.103"></a><span id="l2.103">     menuItem.className = &quot;menuitem-iconic selectedAppMenuItem&quot;;</span>
<a href="#l2.104"></a><span id="l2.104">     menuItem.setAttribute(&quot;handlerType&quot;, &quot;client&quot;);</span>
<a href="#l2.105"></a><span id="l2.105">     try {</span>
<a href="#l2.106"></a><span id="l2.106" class="difflineminus">-      var prefs = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l2.107"></a><span id="l2.107" class="difflineminus">-                            .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l2.108"></a><span id="l2.108" class="difflineminus">-      this._selectedApp = prefs.getComplexValue(getPrefAppForType(feedType),</span>
<a href="#l2.109"></a><span id="l2.109" class="difflineminus">-                                                Components.interfaces.nsILocalFile);</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineplus">+      this._selectedApp = Services.prefs.getComplexValue(getPrefAppForType(feedType),</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineplus">+                                                         Components.interfaces.nsILocalFile);</span>
<a href="#l2.112"></a><span id="l2.112"> </span>
<a href="#l2.113"></a><span id="l2.113">       if (this._selectedApp.exists())</span>
<a href="#l2.114"></a><span id="l2.114">         this._initMenuItemWithFile(menuItem, this._selectedApp);</span>
<a href="#l2.115"></a><span id="l2.115">       else {</span>
<a href="#l2.116"></a><span id="l2.116">         // Hide the menuitem if the last selected application doesn't exist</span>
<a href="#l2.117"></a><span id="l2.117">         menuItem.hidden = true;</span>
<a href="#l2.118"></a><span id="l2.118">       }</span>
<a href="#l2.119"></a><span id="l2.119">     }</span>
<a href="#l2.120"></a><span id="l2.120" class="difflineat">@@ -1022,17 +1014,17 @@ FeedWriter.prototype = {</span>
<a href="#l2.121"></a><span id="l2.121"> </span>
<a href="#l2.122"></a><span id="l2.122">     // Set up the &quot;Subscribe Now&quot; button</span>
<a href="#l2.123"></a><span id="l2.123">     this._getUIElement(&quot;subscribeButton&quot;)</span>
<a href="#l2.124"></a><span id="l2.124">         .addEventListener(&quot;command&quot;, this, false);</span>
<a href="#l2.125"></a><span id="l2.125"> </span>
<a href="#l2.126"></a><span id="l2.126">     // first-run ui</span>
<a href="#l2.127"></a><span id="l2.127">     var showFirstRunUI = true;</span>
<a href="#l2.128"></a><span id="l2.128">     try {</span>
<a href="#l2.129"></a><span id="l2.129" class="difflineminus">-      showFirstRunUI = prefs.getBoolPref(PREF_SHOW_FIRST_RUN_UI);</span>
<a href="#l2.130"></a><span id="l2.130" class="difflineplus">+      showFirstRunUI = Services.prefs.getBoolPref(PREF_SHOW_FIRST_RUN_UI);</span>
<a href="#l2.131"></a><span id="l2.131">     }</span>
<a href="#l2.132"></a><span id="l2.132">     catch (ex) {</span>
<a href="#l2.133"></a><span id="l2.133">     }</span>
<a href="#l2.134"></a><span id="l2.134">     if (showFirstRunUI) {</span>
<a href="#l2.135"></a><span id="l2.135">       var textfeedinfo1, textfeedinfo2;</span>
<a href="#l2.136"></a><span id="l2.136">       switch (feedType) {</span>
<a href="#l2.137"></a><span id="l2.137">         case Components.interfaces.nsIFeed.TYPE_VIDEO:</span>
<a href="#l2.138"></a><span id="l2.138">           textfeedinfo1 = &quot;feedSubscriptionVideoPodcast1&quot;;</span>
<a href="#l2.139"></a><span id="l2.139" class="difflineat">@@ -1053,17 +1045,17 @@ FeedWriter.prototype = {</span>
<a href="#l2.140"></a><span id="l2.140">       this._contentSandbox.feedinfo2 =</span>
<a href="#l2.141"></a><span id="l2.141">         this._document.getElementById(&quot;feedSubscriptionInfo2&quot;);</span>
<a href="#l2.142"></a><span id="l2.142">       this._contentSandbox.feedinfo2Str = this._getString(textfeedinfo2);</span>
<a href="#l2.143"></a><span id="l2.143">       this._contentSandbox.header = header;</span>
<a href="#l2.144"></a><span id="l2.144">       codeStr = &quot;feedinfo1.textContent = feedinfo1Str; &quot; +</span>
<a href="#l2.145"></a><span id="l2.145">                 &quot;feedinfo2.textContent = feedinfo2Str; &quot; +</span>
<a href="#l2.146"></a><span id="l2.146">                 &quot;header.setAttribute('firstrun', 'true');&quot;;</span>
<a href="#l2.147"></a><span id="l2.147">       Components.utils.evalInSandbox(codeStr, this._contentSandbox);</span>
<a href="#l2.148"></a><span id="l2.148" class="difflineminus">-      prefs.setBoolPref(PREF_SHOW_FIRST_RUN_UI, false);</span>
<a href="#l2.149"></a><span id="l2.149" class="difflineplus">+      Services.prefs.setBoolPref(PREF_SHOW_FIRST_RUN_UI, false);</span>
<a href="#l2.150"></a><span id="l2.150">     }</span>
<a href="#l2.151"></a><span id="l2.151">   },</span>
<a href="#l2.152"></a><span id="l2.152"> </span>
<a href="#l2.153"></a><span id="l2.153">   /**</span>
<a href="#l2.154"></a><span id="l2.154">    * Returns the original URI object of the feed and ensures that this</span>
<a href="#l2.155"></a><span id="l2.155">    * component is only ever invoked from the preview document.</span>
<a href="#l2.156"></a><span id="l2.156">    * @param aWindow</span>
<a href="#l2.157"></a><span id="l2.157">    *        The window of the document invoking the BrowserFeedWriter</span>
<a href="#l2.158"></a><span id="l2.158" class="difflineat">@@ -1103,31 +1095,29 @@ FeedWriter.prototype = {</span>
<a href="#l2.159"></a><span id="l2.159">     var secman = Components.classes[&quot;@mozilla.org/scriptsecuritymanager;1&quot;]</span>
<a href="#l2.160"></a><span id="l2.160">                            .getService(Components.interfaces.nsIScriptSecurityManager);</span>
<a href="#l2.161"></a><span id="l2.161">     this._feedPrincipal = secman.getSimpleCodebasePrincipal(this._feedURI);</span>
<a href="#l2.162"></a><span id="l2.162"> </span>
<a href="#l2.163"></a><span id="l2.163">     LOG(&quot;Subscribe Preview: feed uri = &quot; + this._window.location.href);</span>
<a href="#l2.164"></a><span id="l2.164"> </span>
<a href="#l2.165"></a><span id="l2.165">     // Set up the subscription UI</span>
<a href="#l2.166"></a><span id="l2.166">     this._initSubscriptionUI();</span>
<a href="#l2.167"></a><span id="l2.167" class="difflineminus">-    var prefs = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l2.168"></a><span id="l2.168" class="difflineminus">-                          .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l2.169"></a><span id="l2.169" class="difflineminus">-    prefs.addObserver(PREF_SELECTED_ACTION, this, false);</span>
<a href="#l2.170"></a><span id="l2.170" class="difflineminus">-    prefs.addObserver(PREF_SELECTED_READER, this, false);</span>
<a href="#l2.171"></a><span id="l2.171" class="difflineminus">-    prefs.addObserver(PREF_SELECTED_WEB, this, false);</span>
<a href="#l2.172"></a><span id="l2.172" class="difflineminus">-    prefs.addObserver(PREF_SELECTED_APP, this, false);</span>
<a href="#l2.173"></a><span id="l2.173" class="difflineminus">-    prefs.addObserver(PREF_VIDEO_SELECTED_ACTION, this, false);</span>
<a href="#l2.174"></a><span id="l2.174" class="difflineminus">-    prefs.addObserver(PREF_VIDEO_SELECTED_READER, this, false);</span>
<a href="#l2.175"></a><span id="l2.175" class="difflineminus">-    prefs.addObserver(PREF_VIDEO_SELECTED_WEB, this, false);</span>
<a href="#l2.176"></a><span id="l2.176" class="difflineminus">-    prefs.addObserver(PREF_VIDEO_SELECTED_APP, this, false);</span>
<a href="#l2.177"></a><span id="l2.177" class="difflineplus">+    Services.prefs.addObserver(PREF_SELECTED_ACTION, this, false);</span>
<a href="#l2.178"></a><span id="l2.178" class="difflineplus">+    Services.prefs.addObserver(PREF_SELECTED_READER, this, false);</span>
<a href="#l2.179"></a><span id="l2.179" class="difflineplus">+    Services.prefs.addObserver(PREF_SELECTED_WEB, this, false);</span>
<a href="#l2.180"></a><span id="l2.180" class="difflineplus">+    Services.prefs.addObserver(PREF_SELECTED_APP, this, false);</span>
<a href="#l2.181"></a><span id="l2.181" class="difflineplus">+    Services.prefs.addObserver(PREF_VIDEO_SELECTED_ACTION, this, false);</span>
<a href="#l2.182"></a><span id="l2.182" class="difflineplus">+    Services.prefs.addObserver(PREF_VIDEO_SELECTED_READER, this, false);</span>
<a href="#l2.183"></a><span id="l2.183" class="difflineplus">+    Services.prefs.addObserver(PREF_VIDEO_SELECTED_WEB, this, false);</span>
<a href="#l2.184"></a><span id="l2.184" class="difflineplus">+    Services.prefs.addObserver(PREF_VIDEO_SELECTED_APP, this, false);</span>
<a href="#l2.185"></a><span id="l2.185"> </span>
<a href="#l2.186"></a><span id="l2.186" class="difflineminus">-    prefs.addObserver(PREF_AUDIO_SELECTED_ACTION, this, false);</span>
<a href="#l2.187"></a><span id="l2.187" class="difflineminus">-    prefs.addObserver(PREF_AUDIO_SELECTED_READER, this, false);</span>
<a href="#l2.188"></a><span id="l2.188" class="difflineminus">-    prefs.addObserver(PREF_AUDIO_SELECTED_WEB, this, false);</span>
<a href="#l2.189"></a><span id="l2.189" class="difflineminus">-    prefs.addObserver(PREF_AUDIO_SELECTED_APP, this, false);</span>
<a href="#l2.190"></a><span id="l2.190" class="difflineplus">+    Services.prefs.addObserver(PREF_AUDIO_SELECTED_ACTION, this, false);</span>
<a href="#l2.191"></a><span id="l2.191" class="difflineplus">+    Services.prefs.addObserver(PREF_AUDIO_SELECTED_READER, this, false);</span>
<a href="#l2.192"></a><span id="l2.192" class="difflineplus">+    Services.prefs.addObserver(PREF_AUDIO_SELECTED_WEB, this, false);</span>
<a href="#l2.193"></a><span id="l2.193" class="difflineplus">+    Services.prefs.addObserver(PREF_AUDIO_SELECTED_APP, this, false);</span>
<a href="#l2.194"></a><span id="l2.194"> </span>
<a href="#l2.195"></a><span id="l2.195">     this._window.addEventListener(&quot;load&quot;, this, false);</span>
<a href="#l2.196"></a><span id="l2.196">     this._window.addEventListener(&quot;unload&quot;, this, false);</span>
<a href="#l2.197"></a><span id="l2.197">   },</span>
<a href="#l2.198"></a><span id="l2.198"> </span>
<a href="#l2.199"></a><span id="l2.199">   _writeContent: function writeContent() {</span>
<a href="#l2.200"></a><span id="l2.200">     if (!this._window)</span>
<a href="#l2.201"></a><span id="l2.201">       return;</span>
<a href="#l2.202"></a><span id="l2.202" class="difflineat">@@ -1151,31 +1141,29 @@ FeedWriter.prototype = {</span>
<a href="#l2.203"></a><span id="l2.203">     this._window.removeEventListener(&quot;load&quot;, this, false);</span>
<a href="#l2.204"></a><span id="l2.204">     this._window.removeEventListener(&quot;unload&quot;, this, false);</span>
<a href="#l2.205"></a><span id="l2.205">     this._getUIElement(&quot;handlersMenuPopup&quot;)</span>
<a href="#l2.206"></a><span id="l2.206">         .removeEventListener(&quot;command&quot;, this, false);</span>
<a href="#l2.207"></a><span id="l2.207">     this._getUIElement(&quot;subscribeButton&quot;)</span>
<a href="#l2.208"></a><span id="l2.208">         .removeEventListener(&quot;command&quot;, this, false);</span>
<a href="#l2.209"></a><span id="l2.209">     this._document = null;</span>
<a href="#l2.210"></a><span id="l2.210">     this._window = null;</span>
<a href="#l2.211"></a><span id="l2.211" class="difflineminus">-    var prefs = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l2.212"></a><span id="l2.212" class="difflineminus">-                          .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l2.213"></a><span id="l2.213" class="difflineminus">-    prefs.removeObserver(PREF_SELECTED_ACTION, this);</span>
<a href="#l2.214"></a><span id="l2.214" class="difflineminus">-    prefs.removeObserver(PREF_SELECTED_READER, this);</span>
<a href="#l2.215"></a><span id="l2.215" class="difflineminus">-    prefs.removeObserver(PREF_SELECTED_WEB, this);</span>
<a href="#l2.216"></a><span id="l2.216" class="difflineminus">-    prefs.removeObserver(PREF_SELECTED_APP, this);</span>
<a href="#l2.217"></a><span id="l2.217" class="difflineminus">-    prefs.removeObserver(PREF_VIDEO_SELECTED_ACTION, this);</span>
<a href="#l2.218"></a><span id="l2.218" class="difflineminus">-    prefs.removeObserver(PREF_VIDEO_SELECTED_READER, this);</span>
<a href="#l2.219"></a><span id="l2.219" class="difflineminus">-    prefs.removeObserver(PREF_VIDEO_SELECTED_WEB, this);</span>
<a href="#l2.220"></a><span id="l2.220" class="difflineminus">-    prefs.removeObserver(PREF_VIDEO_SELECTED_APP, this);</span>
<a href="#l2.221"></a><span id="l2.221" class="difflineplus">+    Services.prefs.removeObserver(PREF_SELECTED_ACTION, this);</span>
<a href="#l2.222"></a><span id="l2.222" class="difflineplus">+    Services.prefs.removeObserver(PREF_SELECTED_READER, this);</span>
<a href="#l2.223"></a><span id="l2.223" class="difflineplus">+    Services.prefs.removeObserver(PREF_SELECTED_WEB, this);</span>
<a href="#l2.224"></a><span id="l2.224" class="difflineplus">+    Services.prefs.removeObserver(PREF_SELECTED_APP, this);</span>
<a href="#l2.225"></a><span id="l2.225" class="difflineplus">+    Services.prefs.removeObserver(PREF_VIDEO_SELECTED_ACTION, this);</span>
<a href="#l2.226"></a><span id="l2.226" class="difflineplus">+    Services.prefs.removeObserver(PREF_VIDEO_SELECTED_READER, this);</span>
<a href="#l2.227"></a><span id="l2.227" class="difflineplus">+    Services.prefs.removeObserver(PREF_VIDEO_SELECTED_WEB, this);</span>
<a href="#l2.228"></a><span id="l2.228" class="difflineplus">+    Services.prefs.removeObserver(PREF_VIDEO_SELECTED_APP, this);</span>
<a href="#l2.229"></a><span id="l2.229"> </span>
<a href="#l2.230"></a><span id="l2.230" class="difflineminus">-    prefs.removeObserver(PREF_AUDIO_SELECTED_ACTION, this);</span>
<a href="#l2.231"></a><span id="l2.231" class="difflineminus">-    prefs.removeObserver(PREF_AUDIO_SELECTED_READER, this);</span>
<a href="#l2.232"></a><span id="l2.232" class="difflineminus">-    prefs.removeObserver(PREF_AUDIO_SELECTED_WEB, this);</span>
<a href="#l2.233"></a><span id="l2.233" class="difflineminus">-    prefs.removeObserver(PREF_AUDIO_SELECTED_APP, this);</span>
<a href="#l2.234"></a><span id="l2.234" class="difflineplus">+    Services.prefs.removeObserver(PREF_AUDIO_SELECTED_ACTION, this);</span>
<a href="#l2.235"></a><span id="l2.235" class="difflineplus">+    Services.prefs.removeObserver(PREF_AUDIO_SELECTED_READER, this);</span>
<a href="#l2.236"></a><span id="l2.236" class="difflineplus">+    Services.prefs.removeObserver(PREF_AUDIO_SELECTED_WEB, this);</span>
<a href="#l2.237"></a><span id="l2.237" class="difflineplus">+    Services.prefs.removeObserver(PREF_AUDIO_SELECTED_APP, this);</span>
<a href="#l2.238"></a><span id="l2.238"> </span>
<a href="#l2.239"></a><span id="l2.239">     this._removeFeedFromCache();</span>
<a href="#l2.240"></a><span id="l2.240">     this.__faviconService = null;</span>
<a href="#l2.241"></a><span id="l2.241">     this.__bundle = null;</span>
<a href="#l2.242"></a><span id="l2.242">     this._feedURI = null;</span>
<a href="#l2.243"></a><span id="l2.243">     this.__contentSandbox = null;</span>
<a href="#l2.244"></a><span id="l2.244">   },</span>
<a href="#l2.245"></a><span id="l2.245"> </span>
<a href="#l2.246"></a><span id="l2.246" class="difflineat">@@ -1187,90 +1175,88 @@ FeedWriter.prototype = {</span>
<a href="#l2.247"></a><span id="l2.247">       this._feedURI = null;</span>
<a href="#l2.248"></a><span id="l2.248">     }</span>
<a href="#l2.249"></a><span id="l2.249">   },</span>
<a href="#l2.250"></a><span id="l2.250"> </span>
<a href="#l2.251"></a><span id="l2.251">   _subscribe: function subscribe() {</span>
<a href="#l2.252"></a><span id="l2.252">     var feedType = this._getFeedType();</span>
<a href="#l2.253"></a><span id="l2.253"> </span>
<a href="#l2.254"></a><span id="l2.254">     // Subscribe to the feed using the selected handler and save prefs</span>
<a href="#l2.255"></a><span id="l2.255" class="difflineminus">-    var prefs = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l2.256"></a><span id="l2.256" class="difflineminus">-                          .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l2.257"></a><span id="l2.257">     var defaultHandler = &quot;reader&quot;;</span>
<a href="#l2.258"></a><span id="l2.258">     var useAsDefault = this._getUIElement(&quot;alwaysUse&quot;).getAttribute(&quot;checked&quot;);</span>
<a href="#l2.259"></a><span id="l2.259"> </span>
<a href="#l2.260"></a><span id="l2.260">     var selectedItem = this._getSelectedItemFromMenulist(this._handlersMenuList);</span>
<a href="#l2.261"></a><span id="l2.261"> </span>
<a href="#l2.262"></a><span id="l2.262">     // Show the file picker before subscribing if the</span>
<a href="#l2.263"></a><span id="l2.263">     // choose application menuitem was chosen using the keyboard</span>
<a href="#l2.264"></a><span id="l2.264">     if (selectedItem.getAttribute(&quot;anonid&quot;) == &quot;chooseApplicationMenuItem&quot;) {</span>
<a href="#l2.265"></a><span id="l2.265">       if (!this._chooseClientApp())</span>
<a href="#l2.266"></a><span id="l2.266">         return;</span>
<a href="#l2.267"></a><span id="l2.267"> </span>
<a href="#l2.268"></a><span id="l2.268">       selectedItem = this._getSelectedItemFromMenulist(this._handlersMenuList);</span>
<a href="#l2.269"></a><span id="l2.269">     }</span>
<a href="#l2.270"></a><span id="l2.270"> </span>
<a href="#l2.271"></a><span id="l2.271">     if (selectedItem.hasAttribute(&quot;webhandlerurl&quot;)) {</span>
<a href="#l2.272"></a><span id="l2.272">       var webURI = selectedItem.getAttribute(&quot;webhandlerurl&quot;);</span>
<a href="#l2.273"></a><span id="l2.273" class="difflineminus">-      prefs.setCharPref(getPrefReaderForType(feedType), &quot;web&quot;);</span>
<a href="#l2.274"></a><span id="l2.274" class="difflineplus">+      Services.prefs.setCharPref(getPrefReaderForType(feedType), &quot;web&quot;);</span>
<a href="#l2.275"></a><span id="l2.275"> </span>
<a href="#l2.276"></a><span id="l2.276">       var supportsString = Components.classes[&quot;@mozilla.org/supports-string;1&quot;]</span>
<a href="#l2.277"></a><span id="l2.277">                                      .createInstance(Components.interfaces.nsISupportsString);</span>
<a href="#l2.278"></a><span id="l2.278">       supportsString.data = webURI;</span>
<a href="#l2.279"></a><span id="l2.279" class="difflineminus">-      prefs.setComplexValue(getPrefWebForType(feedType), Components.interfaces.nsISupportsString,</span>
<a href="#l2.280"></a><span id="l2.280" class="difflineminus">-                            supportsString);</span>
<a href="#l2.281"></a><span id="l2.281" class="difflineplus">+      Services.prefs.setComplexValue(getPrefWebForType(feedType), Components.interfaces.nsISupportsString,</span>
<a href="#l2.282"></a><span id="l2.282" class="difflineplus">+                                     supportsString);</span>
<a href="#l2.283"></a><span id="l2.283"> </span>
<a href="#l2.284"></a><span id="l2.284">       var wccr = Components.classes[&quot;@mozilla.org/embeddor.implemented/web-content-handler-registrar;1&quot;]</span>
<a href="#l2.285"></a><span id="l2.285">                            .getService(Components.interfaces.nsIWebContentConverterService);</span>
<a href="#l2.286"></a><span id="l2.286">       var handler = wccr.getWebContentHandlerByURI(this._getMimeTypeForFeedType(feedType), webURI);</span>
<a href="#l2.287"></a><span id="l2.287">       if (handler) {</span>
<a href="#l2.288"></a><span id="l2.288">         if (useAsDefault)</span>
<a href="#l2.289"></a><span id="l2.289">           wccr.setAutoHandler(this._getMimeTypeForFeedType(feedType), handler);</span>
<a href="#l2.290"></a><span id="l2.290"> </span>
<a href="#l2.291"></a><span id="l2.291">         this._window.location.href = handler.getHandlerURI(this._window.location.href);</span>
<a href="#l2.292"></a><span id="l2.292">       }</span>
<a href="#l2.293"></a><span id="l2.293">     }</span>
<a href="#l2.294"></a><span id="l2.294">     else {</span>
<a href="#l2.295"></a><span id="l2.295">       switch (selectedItem.getAttribute(&quot;anonid&quot;)) {</span>
<a href="#l2.296"></a><span id="l2.296">         case &quot;selectedAppMenuItem&quot;:</span>
<a href="#l2.297"></a><span id="l2.297" class="difflineminus">-          prefs.setComplexValue(getPrefAppForType(feedType), Components.interfaces.nsILocalFile,</span>
<a href="#l2.298"></a><span id="l2.298" class="difflineminus">-                                this._selectedApp);</span>
<a href="#l2.299"></a><span id="l2.299" class="difflineminus">-          prefs.setCharPref(getPrefReaderForType(feedType), &quot;client&quot;);</span>
<a href="#l2.300"></a><span id="l2.300" class="difflineplus">+          Services.prefs.setComplexValue(getPrefAppForType(feedType), Components.interfaces.nsILocalFile,</span>
<a href="#l2.301"></a><span id="l2.301" class="difflineplus">+                                         this._selectedApp);</span>
<a href="#l2.302"></a><span id="l2.302" class="difflineplus">+          Services.prefs.setCharPref(getPrefReaderForType(feedType), &quot;client&quot;);</span>
<a href="#l2.303"></a><span id="l2.303">           break;</span>
<a href="#l2.304"></a><span id="l2.304">         case &quot;defaultHandlerMenuItem&quot;:</span>
<a href="#l2.305"></a><span id="l2.305" class="difflineminus">-          prefs.setComplexValue(getPrefAppForType(feedType), Components.interfaces.nsILocalFile,</span>
<a href="#l2.306"></a><span id="l2.306" class="difflineminus">-                                this._defaultSystemReader);</span>
<a href="#l2.307"></a><span id="l2.307" class="difflineminus">-          prefs.setCharPref(getPrefReaderForType(feedType), &quot;client&quot;);</span>
<a href="#l2.308"></a><span id="l2.308" class="difflineplus">+          Services.prefs.setComplexValue(getPrefAppForType(feedType), Components.interfaces.nsILocalFile,</span>
<a href="#l2.309"></a><span id="l2.309" class="difflineplus">+                                         this._defaultSystemReader);</span>
<a href="#l2.310"></a><span id="l2.310" class="difflineplus">+          Services.prefs.setCharPref(getPrefReaderForType(feedType), &quot;client&quot;);</span>
<a href="#l2.311"></a><span id="l2.311">           break;</span>
<a href="#l2.312"></a><span id="l2.312">         case &quot;liveBookmarksMenuItem&quot;:</span>
<a href="#l2.313"></a><span id="l2.313">           defaultHandler = &quot;bookmarks&quot;;</span>
<a href="#l2.314"></a><span id="l2.314" class="difflineminus">-          prefs.setCharPref(getPrefReaderForType(feedType), &quot;bookmarks&quot;);</span>
<a href="#l2.315"></a><span id="l2.315" class="difflineplus">+          Services.prefs.setCharPref(getPrefReaderForType(feedType), &quot;bookmarks&quot;);</span>
<a href="#l2.316"></a><span id="l2.316">           break;</span>
<a href="#l2.317"></a><span id="l2.317">         case &quot;messengerFeedsMenuItem&quot;:</span>
<a href="#l2.318"></a><span id="l2.318">           defaultHandler = &quot;messenger&quot;;</span>
<a href="#l2.319"></a><span id="l2.319" class="difflineminus">-          prefs.setCharPref(getPrefReaderForType(feedType), &quot;messenger&quot;);</span>
<a href="#l2.320"></a><span id="l2.320" class="difflineplus">+          Services.prefs.setCharPref(getPrefReaderForType(feedType), &quot;messenger&quot;);</span>
<a href="#l2.321"></a><span id="l2.321">           break;</span>
<a href="#l2.322"></a><span id="l2.322">       }</span>
<a href="#l2.323"></a><span id="l2.323">       var feedService = Components.classes[&quot;@mozilla.org/browser/feeds/result-service;1&quot;]</span>
<a href="#l2.324"></a><span id="l2.324">                                   .getService(Components.interfaces.nsIFeedResultService);</span>
<a href="#l2.325"></a><span id="l2.325"> </span>
<a href="#l2.326"></a><span id="l2.326">       // Pull the title and subtitle out of the document</span>
<a href="#l2.327"></a><span id="l2.327">       var feedTitle = this._document.getElementById(TITLE_ID).textContent;</span>
<a href="#l2.328"></a><span id="l2.328">       var feedSubtitle = this._document.getElementById(SUBTITLE_ID).textContent;</span>
<a href="#l2.329"></a><span id="l2.329">       feedService.addToClientReader(this._window.location.href, feedTitle, feedSubtitle, feedType);</span>
<a href="#l2.330"></a><span id="l2.330">     }</span>
<a href="#l2.331"></a><span id="l2.331"> </span>
<a href="#l2.332"></a><span id="l2.332">     // If &quot;Always use...&quot; is checked, we should set PREF_*SELECTED_ACTION</span>
<a href="#l2.333"></a><span id="l2.333">     // to either &quot;reader&quot; (If a web reader or if an application is selected),</span>
<a href="#l2.334"></a><span id="l2.334">     // or to &quot;messenger&quot; (if the messenger feeds option is selected).</span>
<a href="#l2.335"></a><span id="l2.335">     // Otherwise, we should set it to &quot;ask&quot;</span>
<a href="#l2.336"></a><span id="l2.336">     if (useAsDefault)</span>
<a href="#l2.337"></a><span id="l2.337" class="difflineminus">-      prefs.setCharPref(getPrefActionForType(feedType), defaultHandler);</span>
<a href="#l2.338"></a><span id="l2.338" class="difflineplus">+      Services.prefs.setCharPref(getPrefActionForType(feedType), defaultHandler);</span>
<a href="#l2.339"></a><span id="l2.339">     else</span>
<a href="#l2.340"></a><span id="l2.340" class="difflineminus">-      prefs.setCharPref(getPrefActionForType(feedType), &quot;ask&quot;);</span>
<a href="#l2.341"></a><span id="l2.341" class="difflineplus">+      Services.prefs.setCharPref(getPrefActionForType(feedType), &quot;ask&quot;);</span>
<a href="#l2.342"></a><span id="l2.342">   },</span>
<a href="#l2.343"></a><span id="l2.343"> </span>
<a href="#l2.344"></a><span id="l2.344">   // nsIObserver</span>
<a href="#l2.345"></a><span id="l2.345">   observe: function observe(subject, topic, data) {</span>
<a href="#l2.346"></a><span id="l2.346">     if (!this._window) {</span>
<a href="#l2.347"></a><span id="l2.347">       // this._window is null unless this.init was called with a trusted</span>
<a href="#l2.348"></a><span id="l2.348">       // window object.</span>
<a href="#l2.349"></a><span id="l2.349">       return;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/suite/feeds/src/WebContentConverter.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/suite/feeds/src/WebContentConverter.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -1,13 +1,14 @@</span>
<a href="#l3.4"></a><span id="l3.4"> /* -*- Mode: Javascript; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l3.5"></a><span id="l3.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l3.6"></a><span id="l3.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l3.7"></a><span id="l3.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l3.8"></a><span id="l3.8"> </span>
<a href="#l3.9"></a><span id="l3.9" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l3.10"></a><span id="l3.10"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12"> const WCCR_CONTRACTID = &quot;@mozilla.org/embeddor.implemented/web-content-handler-registrar;1&quot;;</span>
<a href="#l3.13"></a><span id="l3.13"> const WCCR_CLASSID = Components.ID(&quot;{792a7e82-06a0-437c-af63-b2d12e808acc}&quot;);</span>
<a href="#l3.14"></a><span id="l3.14"> </span>
<a href="#l3.15"></a><span id="l3.15"> const WCC_CLASSID = Components.ID(&quot;{db7ebf28-cc40-415f-8a51-1b111851df1e}&quot;);</span>
<a href="#l3.16"></a><span id="l3.16"> const WCC_CLASSNAME = &quot;Web Service Handler&quot;;</span>
<a href="#l3.17"></a><span id="l3.17"> </span>
<a href="#l3.18"></a><span id="l3.18" class="difflineat">@@ -23,21 +24,18 @@ const PREF_HANDLER_EXTERNAL_PREFIX = &quot;ne</span>
<a href="#l3.19"></a><span id="l3.19"> const PREF_ALLOW_DIFFERENT_HOST = &quot;gecko.handlerService.allowRegisterFromDifferentHost&quot;;</span>
<a href="#l3.20"></a><span id="l3.20"> </span>
<a href="#l3.21"></a><span id="l3.21"> const STRING_BUNDLE_URI = &quot;chrome://communicator/locale/feeds/subscribe.properties&quot;;</span>
<a href="#l3.22"></a><span id="l3.22"> </span>
<a href="#l3.23"></a><span id="l3.23"> const NS_ERROR_MODULE_DOM = 0x80530000;</span>
<a href="#l3.24"></a><span id="l3.24"> const NS_ERROR_DOM_SYNTAX_ERR = NS_ERROR_MODULE_DOM + 12;</span>
<a href="#l3.25"></a><span id="l3.25"> </span>
<a href="#l3.26"></a><span id="l3.26"> function LOG(str) {</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineminus">-  var prefs = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineminus">-                        .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineminus">-</span>
<a href="#l3.30"></a><span id="l3.30">   try {</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-    if (prefs.getBoolPref(&quot;feeds.log&quot;))</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+    if (Services.prefs.getBoolPref(&quot;feeds.log&quot;))</span>
<a href="#l3.33"></a><span id="l3.33">       dump(&quot;*** Feeds: &quot; + str + &quot;\n&quot;);</span>
<a href="#l3.34"></a><span id="l3.34">   }</span>
<a href="#l3.35"></a><span id="l3.35">   catch (ex) {</span>
<a href="#l3.36"></a><span id="l3.36">   }</span>
<a href="#l3.37"></a><span id="l3.37"> }</span>
<a href="#l3.38"></a><span id="l3.38"> </span>
<a href="#l3.39"></a><span id="l3.39"> function getNotificationBox(aWindow)</span>
<a href="#l3.40"></a><span id="l3.40"> {</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineat">@@ -180,25 +178,23 @@ WebContentConverterRegistrar.prototype =</span>
<a href="#l3.42"></a><span id="l3.42">    */</span>
<a href="#l3.43"></a><span id="l3.43">   setAutoHandler: function setAutoHandler(contentType, handler) {</span>
<a href="#l3.44"></a><span id="l3.44">     if (handler &amp;&amp; !this._typeIsRegistered(contentType, handler.uri))</span>
<a href="#l3.45"></a><span id="l3.45">       throw Components.results.NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l3.46"></a><span id="l3.46"> </span>
<a href="#l3.47"></a><span id="l3.47">     contentType = this._resolveContentType(contentType);</span>
<a href="#l3.48"></a><span id="l3.48">     this._setAutoHandler(contentType, handler);</span>
<a href="#l3.49"></a><span id="l3.49"> </span>
<a href="#l3.50"></a><span id="l3.50" class="difflineminus">-    var prefs = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineminus">-                          .getService(Components.interfaces.nsIPrefService);</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineminus">-    var autoBranch = prefs.getBranch(PREF_CONTENTHANDLERS_AUTO);</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineplus">+    var autoBranch = Services.prefs.getBranch(PREF_CONTENTHANDLERS_AUTO);</span>
<a href="#l3.54"></a><span id="l3.54">     if (handler)</span>
<a href="#l3.55"></a><span id="l3.55">       autoBranch.setCharPref(contentType, handler.uri);</span>
<a href="#l3.56"></a><span id="l3.56">     else if (autoBranch.prefHasUserValue(contentType))</span>
<a href="#l3.57"></a><span id="l3.57">       autoBranch.clearUserPref(contentType);</span>
<a href="#l3.58"></a><span id="l3.58"> </span>
<a href="#l3.59"></a><span id="l3.59" class="difflineminus">-    prefs.savePrefFile(null);</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineplus">+    Services.prefs.savePrefFile(null);</span>
<a href="#l3.61"></a><span id="l3.61">   },</span>
<a href="#l3.62"></a><span id="l3.62"> </span>
<a href="#l3.63"></a><span id="l3.63">   /**</span>
<a href="#l3.64"></a><span id="l3.64">    * Update the internal data structure (not persistent)</span>
<a href="#l3.65"></a><span id="l3.65">    */</span>
<a href="#l3.66"></a><span id="l3.66">   _setAutoHandler: function setAutoHandler(contentType, handler) {</span>
<a href="#l3.67"></a><span id="l3.67">     if (handler)</span>
<a href="#l3.68"></a><span id="l3.68">       this._autoHandleContentTypes[contentType] = handler;</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineat">@@ -320,20 +316,18 @@ WebContentConverterRegistrar.prototype =</span>
<a href="#l3.70"></a><span id="l3.70">     // we may need to revise this once we support more content types</span>
<a href="#l3.71"></a><span id="l3.71">     // XXX this should be a &quot;security exception&quot; according to spec, but that</span>
<a href="#l3.72"></a><span id="l3.72">     // isn't defined yet.</span>
<a href="#l3.73"></a><span id="l3.73">     if (uri.scheme != &quot;http&quot; &amp;&amp; uri.scheme != &quot;https&quot;)</span>
<a href="#l3.74"></a><span id="l3.74">       throw(&quot;Permission denied to add &quot; + uri.spec + &quot; as a content or protocol handler&quot;);</span>
<a href="#l3.75"></a><span id="l3.75"> </span>
<a href="#l3.76"></a><span id="l3.76">     // We also reject handlers registered from a different host (see bug 402287)</span>
<a href="#l3.77"></a><span id="l3.77">     // The pref allows us to test the feature</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineminus">-    var pb = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineminus">-                       .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineminus">-    if ((!pb.prefHasUserValue(PREF_ALLOW_DIFFERENT_HOST) ||</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineminus">-         !pb.getBoolPref(PREF_ALLOW_DIFFERENT_HOST)) &amp;&amp;</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineplus">+    if ((!Services.prefs.prefHasUserValue(PREF_ALLOW_DIFFERENT_HOST) ||</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineplus">+         !Services.prefs.getBoolPref(PREF_ALLOW_DIFFERENT_HOST)) &amp;&amp;</span>
<a href="#l3.84"></a><span id="l3.84">         aContentWindow.location.hostname != uri.host)</span>
<a href="#l3.85"></a><span id="l3.85">       throw(&quot;Permission denied to add &quot; + uri.spec + &quot; as a content or protocol handler&quot;);</span>
<a href="#l3.86"></a><span id="l3.86"> </span>
<a href="#l3.87"></a><span id="l3.87">     // If the uri doesn't contain '%s', it won't be a good handler</span>
<a href="#l3.88"></a><span id="l3.88">     if (uri.spec.indexOf(&quot;%s&quot;) &lt; 0)</span>
<a href="#l3.89"></a><span id="l3.89">       throw NS_ERROR_DOM_SYNTAX_ERR;</span>
<a href="#l3.90"></a><span id="l3.90"> </span>
<a href="#l3.91"></a><span id="l3.91">     return uri;</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineat">@@ -394,24 +388,22 @@ WebContentConverterRegistrar.prototype =</span>
<a href="#l3.93"></a><span id="l3.93">     if (!(handler instanceof Components.interfaces.nsIExternalProtocolHandler)) {</span>
<a href="#l3.94"></a><span id="l3.94">       // This is handled internally, so we don't want them to register</span>
<a href="#l3.95"></a><span id="l3.95">       // XXX this should be a &quot;security exception&quot; according to spec, but that</span>
<a href="#l3.96"></a><span id="l3.96">       // isn't defined yet.</span>
<a href="#l3.97"></a><span id="l3.97">       throw(&quot;Permission denied to add &quot; + aURIString + &quot; as a protocol handler&quot;);</span>
<a href="#l3.98"></a><span id="l3.98">     }</span>
<a href="#l3.99"></a><span id="l3.99"> </span>
<a href="#l3.100"></a><span id="l3.100">     // check if it is in the black list</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineminus">-    var pb = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineminus">-                       .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l3.103"></a><span id="l3.103">     var allowed;</span>
<a href="#l3.104"></a><span id="l3.104">     try {</span>
<a href="#l3.105"></a><span id="l3.105" class="difflineminus">-      allowed = pb.getBoolPref(PREF_HANDLER_EXTERNAL_PREFIX + &quot;.&quot; + aProtocol);</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineplus">+      allowed = Services.prefs.getBoolPref(PREF_HANDLER_EXTERNAL_PREFIX + &quot;.&quot; + aProtocol);</span>
<a href="#l3.107"></a><span id="l3.107">     }</span>
<a href="#l3.108"></a><span id="l3.108">     catch (e) {</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineminus">-      allowed = pb.getBoolPref(PREF_HANDLER_EXTERNAL_PREFIX + &quot;-default&quot;);</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineplus">+      allowed = Services.prefs.getBoolPref(PREF_HANDLER_EXTERNAL_PREFIX + &quot;-default&quot;);</span>
<a href="#l3.111"></a><span id="l3.111">     }</span>
<a href="#l3.112"></a><span id="l3.112">     if (!allowed) {</span>
<a href="#l3.113"></a><span id="l3.113">       // XXX this should be a &quot;security exception&quot; according to spec</span>
<a href="#l3.114"></a><span id="l3.114">       throw(&quot;Not allowed to register a protocol handler for &quot; + aProtocol);</span>
<a href="#l3.115"></a><span id="l3.115">     }</span>
<a href="#l3.116"></a><span id="l3.116"> </span>
<a href="#l3.117"></a><span id="l3.117">     var uri = this._checkAndGetURI(aURIString, aContentWindow);</span>
<a href="#l3.118"></a><span id="l3.118"> </span>
<a href="#l3.119"></a><span id="l3.119" class="difflineat">@@ -573,22 +565,20 @@ WebContentConverterRegistrar.prototype =</span>
<a href="#l3.120"></a><span id="l3.120">    *</span>
<a href="#l3.121"></a><span id="l3.121">    * This data is stored under:</span>
<a href="#l3.122"></a><span id="l3.122">    *</span>
<a href="#l3.123"></a><span id="l3.123">    *    browser.contentHandlers.type0 = content/type</span>
<a href="#l3.124"></a><span id="l3.124">    *    browser.contentHandlers.uri0 = http://www.foo.com/q=%s</span>
<a href="#l3.125"></a><span id="l3.125">    *    browser.contentHandlers.title0 = Foo 2.0alphr</span>
<a href="#l3.126"></a><span id="l3.126">    */</span>
<a href="#l3.127"></a><span id="l3.127">   _saveContentHandlerToPrefs: function saveContentHandlerToPrefs(contentType, uri, title) {</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineminus">-    var prefs = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l3.129"></a><span id="l3.129" class="difflineminus">-                          .getService(Components.interfaces.nsIPrefService);</span>
<a href="#l3.130"></a><span id="l3.130">     var i = 0;</span>
<a href="#l3.131"></a><span id="l3.131">     var typeBranch = null;</span>
<a href="#l3.132"></a><span id="l3.132">     while (true) {</span>
<a href="#l3.133"></a><span id="l3.133" class="difflineminus">-      typeBranch = prefs.getBranch(PREF_CONTENTHANDLERS_BRANCH + i + &quot;.&quot;);</span>
<a href="#l3.134"></a><span id="l3.134" class="difflineplus">+      typeBranch = Services.prefs.getBranch(PREF_CONTENTHANDLERS_BRANCH + i + &quot;.&quot;);</span>
<a href="#l3.135"></a><span id="l3.135">       try {</span>
<a href="#l3.136"></a><span id="l3.136">         typeBranch.getCharPref(&quot;type&quot;);</span>
<a href="#l3.137"></a><span id="l3.137">         ++i;</span>
<a href="#l3.138"></a><span id="l3.138">       }</span>
<a href="#l3.139"></a><span id="l3.139">       catch (e) {</span>
<a href="#l3.140"></a><span id="l3.140">         // No more handlers</span>
<a href="#l3.141"></a><span id="l3.141">         break;</span>
<a href="#l3.142"></a><span id="l3.142">       }</span>
<a href="#l3.143"></a><span id="l3.143" class="difflineat">@@ -599,17 +589,17 @@ WebContentConverterRegistrar.prototype =</span>
<a href="#l3.144"></a><span id="l3.144">                           .createInstance(Components.interfaces.nsIPrefLocalizedString);</span>
<a href="#l3.145"></a><span id="l3.145">       pls.data = uri;</span>
<a href="#l3.146"></a><span id="l3.146">       typeBranch.setComplexValue(&quot;uri&quot;,</span>
<a href="#l3.147"></a><span id="l3.147">                                  Components.interfaces.nsIPrefLocalizedString, pls);</span>
<a href="#l3.148"></a><span id="l3.148">       pls.data = title;</span>
<a href="#l3.149"></a><span id="l3.149">       typeBranch.setComplexValue(&quot;title&quot;,</span>
<a href="#l3.150"></a><span id="l3.150">                                  Components.interfaces.nsIPrefLocalizedString, pls);</span>
<a href="#l3.151"></a><span id="l3.151"> </span>
<a href="#l3.152"></a><span id="l3.152" class="difflineminus">-      prefs.savePrefFile(null);</span>
<a href="#l3.153"></a><span id="l3.153" class="difflineplus">+      Services.prefs.savePrefFile(null);</span>
<a href="#l3.154"></a><span id="l3.154">     }</span>
<a href="#l3.155"></a><span id="l3.155">   },</span>
<a href="#l3.156"></a><span id="l3.156"> </span>
<a href="#l3.157"></a><span id="l3.157">   /**</span>
<a href="#l3.158"></a><span id="l3.158">    * Determines if there is a type with a particular uri registered for the</span>
<a href="#l3.159"></a><span id="l3.159">    * specified content type already.</span>
<a href="#l3.160"></a><span id="l3.160">    * @param   contentType</span>
<a href="#l3.161"></a><span id="l3.161">    *          The content type that the uri handles</span>
<a href="#l3.162"></a><span id="l3.162" class="difflineat">@@ -653,26 +643,24 @@ WebContentConverterRegistrar.prototype =</span>
<a href="#l3.163"></a><span id="l3.163">    */</span>
<a href="#l3.164"></a><span id="l3.164">   _registerContentHandler: function registerContentHandler(contentType, uri, title) {</span>
<a href="#l3.165"></a><span id="l3.165">     this._updateContentTypeHandlerMap(contentType, uri, title);</span>
<a href="#l3.166"></a><span id="l3.166">     this._saveContentHandlerToPrefs(contentType, uri, title);</span>
<a href="#l3.167"></a><span id="l3.167"> </span>
<a href="#l3.168"></a><span id="l3.168">     if (contentType == TYPE_MAYBE_FEED) {</span>
<a href="#l3.169"></a><span id="l3.169">       // Make the new handler the last-selected reader in the preview page</span>
<a href="#l3.170"></a><span id="l3.170">       // and make sure the preview page is shown the next time a feed is visited</span>
<a href="#l3.171"></a><span id="l3.171" class="difflineminus">-      var pb = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l3.172"></a><span id="l3.172" class="difflineminus">-                         .getService(Components.interfaces.nsIPrefService).getBranch(null);</span>
<a href="#l3.173"></a><span id="l3.173" class="difflineminus">-      pb.setCharPref(PREF_SELECTED_READER, &quot;web&quot;);</span>
<a href="#l3.174"></a><span id="l3.174" class="difflineplus">+      Services.prefs.setCharPref(PREF_SELECTED_READER, &quot;web&quot;);</span>
<a href="#l3.175"></a><span id="l3.175"> </span>
<a href="#l3.176"></a><span id="l3.176">       var supportsString = Components.classes[&quot;@mozilla.org/supports-string;1&quot;]</span>
<a href="#l3.177"></a><span id="l3.177">                                      .createInstance(Components.interfaces.nsISupportsString);</span>
<a href="#l3.178"></a><span id="l3.178">       supportsString.data = uri;</span>
<a href="#l3.179"></a><span id="l3.179" class="difflineminus">-      pb.setComplexValue(PREF_SELECTED_WEB, Components.interfaces.nsISupportsString,</span>
<a href="#l3.180"></a><span id="l3.180" class="difflineminus">-                         supportsString);</span>
<a href="#l3.181"></a><span id="l3.181" class="difflineminus">-      pb.setCharPref(PREF_SELECTED_ACTION, &quot;ask&quot;);</span>
<a href="#l3.182"></a><span id="l3.182" class="difflineplus">+      Services.prefs.setComplexValue(PREF_SELECTED_WEB, Components.interfaces.nsISupportsString,</span>
<a href="#l3.183"></a><span id="l3.183" class="difflineplus">+                                     supportsString);</span>
<a href="#l3.184"></a><span id="l3.184" class="difflineplus">+      Services.prefs.setCharPref(PREF_SELECTED_ACTION, &quot;ask&quot;);</span>
<a href="#l3.185"></a><span id="l3.185">       this._setAutoHandler(TYPE_MAYBE_FEED, null);</span>
<a href="#l3.186"></a><span id="l3.186">     }</span>
<a href="#l3.187"></a><span id="l3.187">   },</span>
<a href="#l3.188"></a><span id="l3.188"> </span>
<a href="#l3.189"></a><span id="l3.189">   /**</span>
<a href="#l3.190"></a><span id="l3.190">    * Update the content type -&gt; handler map. This mapping is not persisted, use</span>
<a href="#l3.191"></a><span id="l3.191">    * registerContentHandler or _saveContentHandlerToPrefs for that purpose.</span>
<a href="#l3.192"></a><span id="l3.192">    * @param   contentType</span>
<a href="#l3.193"></a><span id="l3.193" class="difflineat">@@ -755,40 +743,37 @@ WebContentConverterRegistrar.prototype =</span>
<a href="#l3.194"></a><span id="l3.194">     }</span>
<a href="#l3.195"></a><span id="l3.195">   },</span>
<a href="#l3.196"></a><span id="l3.196"> </span>
<a href="#l3.197"></a><span id="l3.197">   /**</span>
<a href="#l3.198"></a><span id="l3.198">    * Load the auto handler, content handler and protocol tables from</span>
<a href="#l3.199"></a><span id="l3.199">    * preferences.</span>
<a href="#l3.200"></a><span id="l3.200">    */</span>
<a href="#l3.201"></a><span id="l3.201">   _init: function init() {</span>
<a href="#l3.202"></a><span id="l3.202" class="difflineminus">-    var prefs = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l3.203"></a><span id="l3.203" class="difflineminus">-                          .getService(Components.interfaces.nsIPrefService);</span>
<a href="#l3.204"></a><span id="l3.204" class="difflineminus">-</span>
<a href="#l3.205"></a><span id="l3.205" class="difflineminus">-    var kids = prefs.getBranch(PREF_CONTENTHANDLERS_BRANCH)</span>
<a href="#l3.206"></a><span id="l3.206" class="difflineminus">-                    .getChildList(&quot;&quot;);</span>
<a href="#l3.207"></a><span id="l3.207" class="difflineplus">+    var kids = Services.prefs.getBranch(PREF_CONTENTHANDLERS_BRANCH)</span>
<a href="#l3.208"></a><span id="l3.208" class="difflineplus">+                             .getChildList(&quot;&quot;);</span>
<a href="#l3.209"></a><span id="l3.209">     // first get the numbers of the providers by getting all ###.uri prefs</span>
<a href="#l3.210"></a><span id="l3.210">     var nums = [];</span>
<a href="#l3.211"></a><span id="l3.211">     for (let i = 0; i &lt; kids.length; i++) {</span>
<a href="#l3.212"></a><span id="l3.212">       let match = /^(\d+)\.uri$/.exec(kids[i]);</span>
<a href="#l3.213"></a><span id="l3.213">       if (match)</span>
<a href="#l3.214"></a><span id="l3.214">         nums.push(match[1]);</span>
<a href="#l3.215"></a><span id="l3.215">     }</span>
<a href="#l3.216"></a><span id="l3.216">     // sort them, to get them back in order</span>
<a href="#l3.217"></a><span id="l3.217">     nums.sort(function(a, b) {return a - b;});</span>
<a href="#l3.218"></a><span id="l3.218">     // now register them</span>
<a href="#l3.219"></a><span id="l3.219">     for (let i = 0; i &lt; nums.length; i++) {</span>
<a href="#l3.220"></a><span id="l3.220" class="difflineminus">-      let branch = prefs.getBranch(PREF_CONTENTHANDLERS_BRANCH + nums[i] + &quot;.&quot;);</span>
<a href="#l3.221"></a><span id="l3.221" class="difflineplus">+      let branch = Services.prefs.getBranch(PREF_CONTENTHANDLERS_BRANCH + nums[i] + &quot;.&quot;);</span>
<a href="#l3.222"></a><span id="l3.222">       this._registerContentHandlerWithBranch(branch);</span>
<a href="#l3.223"></a><span id="l3.223">     }</span>
<a href="#l3.224"></a><span id="l3.224"> </span>
<a href="#l3.225"></a><span id="l3.225">     // We need to do this _after_ registering all of the available handlers,</span>
<a href="#l3.226"></a><span id="l3.226">     // so that getWebContentHandlerByURI can return successfully.</span>
<a href="#l3.227"></a><span id="l3.227">     try {</span>
<a href="#l3.228"></a><span id="l3.228" class="difflineminus">-      var autoBranch = prefs.getBranch(PREF_CONTENTHANDLERS_AUTO);</span>
<a href="#l3.229"></a><span id="l3.229" class="difflineplus">+      var autoBranch = Services.prefs.getBranch(PREF_CONTENTHANDLERS_AUTO);</span>
<a href="#l3.230"></a><span id="l3.230">       var childPrefs = autoBranch.getChildList(&quot;&quot;);</span>
<a href="#l3.231"></a><span id="l3.231">       for (let i = 0; i &lt; childPrefs.length; ++i) {</span>
<a href="#l3.232"></a><span id="l3.232">         let type = childPrefs[i];</span>
<a href="#l3.233"></a><span id="l3.233">         let uri = autoBranch.getCharPref(type);</span>
<a href="#l3.234"></a><span id="l3.234">         if (uri) {</span>
<a href="#l3.235"></a><span id="l3.235">           let handler = this.getWebContentHandlerByURI(type, uri);</span>
<a href="#l3.236"></a><span id="l3.236">           this._setAutoHandler(type, handler);</span>
<a href="#l3.237"></a><span id="l3.237">         }</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

