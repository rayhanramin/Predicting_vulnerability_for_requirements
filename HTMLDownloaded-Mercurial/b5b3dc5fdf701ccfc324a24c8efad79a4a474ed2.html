<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 29221:b5b3dc5fdf701ccfc324a24c8efad79a4a474ed2</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ b5b3dc5fdf701ccfc324a24c8efad79a4a474ed2" />
<meta property="og:url" content="/comm-central/rev/b5b3dc5fdf701ccfc324a24c8efad79a4a474ed2" />
<meta property="og:description" content="Bug 1546606 - Move calDavRequestHandlers.js into a JSM. r=Fallen" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / b5b3dc5fdf701ccfc324a24c8efad79a4a474ed2 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/b5b3dc5fdf701ccfc324a24c8efad79a4a474ed2">shortlog</a> |
<a href="/comm-central/log/b5b3dc5fdf701ccfc324a24c8efad79a4a474ed2">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/b5b3dc5fdf701ccfc324a24c8efad79a4a474ed2">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/b5b3dc5fdf701ccfc324a24c8efad79a4a474ed2">files</a> |
changeset |
<a href="/comm-central/raw-rev/b5b3dc5fdf701ccfc324a24c8efad79a4a474ed2">raw</a>  | <a href="/comm-central/archive/b5b3dc5fdf701ccfc324a24c8efad79a4a474ed2.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1546606">Bug 1546606</a> - Move calDavRequestHandlers.js into a JSM. r=Fallen
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#80;&#97;&#117;&#108;&#32;&#77;&#111;&#114;&#114;&#105;&#115;&#32;&#60;&#112;&#97;&#117;&#108;&#64;&#116;&#104;&#117;&#110;&#100;&#101;&#114;&#98;&#105;&#114;&#100;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 09 Apr 2020 13:52:11 +0300</td></tr>

<tr>
 <td>changeset 29221</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/b5b3dc5fdf701ccfc324a24c8efad79a4a474ed2">b5b3dc5fdf701ccfc324a24c8efad79a4a474ed2</a></td>
</tr>



<tr>
<td>parent 29220</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/9deaa698c34d732c24ab76e10dd0083e8472739a">9deaa698c34d732c24ab76e10dd0083e8472739a</a>
</td>
</tr>

<tr>
<td>child 29222</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/1295426fff19b2b7e7da26f0a3d1baf0a295e543">1295426fff19b2b7e7da26f0a3d1baf0a295e543</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=b5b3dc5fdf701ccfc324a24c8efad79a4a474ed2">17264</a></td></tr>
<tr><td>push user</td><td>mkmelin@iki.fi</td></tr>
<tr><td>push date</td><td class="date age">Thu, 09 Apr 2020 10:54:30 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@7ebcf56c0e59 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=7ebcf56c0e59161b0e8dade8311e95d23b38980e">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=7ebcf56c0e59161b0e8dade8311e95d23b38980e&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=7ebcf56c0e59161b0e8dade8311e95d23b38980e&newProject=comm-central&newRevision=84249ce5084a8b7a0925b5d35c00331870a56a0c&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=7ebcf56c0e59161b0e8dade8311e95d23b38980e&newProject=comm-central&newRevision=84249ce5084a8b7a0925b5d35c00331870a56a0c&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=7ebcf56c0e59161b0e8dade8311e95d23b38980e&newProject=comm-central&newRevision=84249ce5084a8b7a0925b5d35c00331870a56a0c&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28Fallen%29&revcount=50">Fallen</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1546606">1546606</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1546606">Bug 1546606</a> - Move calDavRequestHandlers.js into a JSM. r=Fallen</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b5b3dc5fdf701ccfc324a24c8efad79a4a474ed2/calendar/providers/caldav/CalDavCalendar.jsm">calendar/providers/caldav/CalDavCalendar.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b5b3dc5fdf701ccfc324a24c8efad79a4a474ed2/calendar/providers/caldav/CalDavCalendar.jsm">file</a> |
<a href="/comm-central/annotate/b5b3dc5fdf701ccfc324a24c8efad79a4a474ed2/calendar/providers/caldav/CalDavCalendar.jsm">annotate</a> |
<a href="/comm-central/diff/b5b3dc5fdf701ccfc324a24c8efad79a4a474ed2/calendar/providers/caldav/CalDavCalendar.jsm">diff</a> |
<a href="/comm-central/comparison/b5b3dc5fdf701ccfc324a24c8efad79a4a474ed2/calendar/providers/caldav/CalDavCalendar.jsm">comparison</a> |
<a href="/comm-central/log/b5b3dc5fdf701ccfc324a24c8efad79a4a474ed2/calendar/providers/caldav/CalDavCalendar.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b5b3dc5fdf701ccfc324a24c8efad79a4a474ed2/calendar/providers/caldav/calDavRequestHandlers.js">calendar/providers/caldav/calDavRequestHandlers.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/b5b3dc5fdf701ccfc324a24c8efad79a4a474ed2/calendar/providers/caldav/calDavRequestHandlers.js">diff</a> |
<a href="/comm-central/comparison/b5b3dc5fdf701ccfc324a24c8efad79a4a474ed2/calendar/providers/caldav/calDavRequestHandlers.js">comparison</a> |
<a href="/comm-central/log/b5b3dc5fdf701ccfc324a24c8efad79a4a474ed2/calendar/providers/caldav/calDavRequestHandlers.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b5b3dc5fdf701ccfc324a24c8efad79a4a474ed2/calendar/providers/caldav/modules/CalDavRequestHandlers.jsm">calendar/providers/caldav/modules/CalDavRequestHandlers.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b5b3dc5fdf701ccfc324a24c8efad79a4a474ed2/calendar/providers/caldav/modules/CalDavRequestHandlers.jsm">file</a> |
<a href="/comm-central/annotate/b5b3dc5fdf701ccfc324a24c8efad79a4a474ed2/calendar/providers/caldav/modules/CalDavRequestHandlers.jsm">annotate</a> |
<a href="/comm-central/diff/b5b3dc5fdf701ccfc324a24c8efad79a4a474ed2/calendar/providers/caldav/modules/CalDavRequestHandlers.jsm">diff</a> |
<a href="/comm-central/comparison/b5b3dc5fdf701ccfc324a24c8efad79a4a474ed2/calendar/providers/caldav/modules/CalDavRequestHandlers.jsm">comparison</a> |
<a href="/comm-central/log/b5b3dc5fdf701ccfc324a24c8efad79a4a474ed2/calendar/providers/caldav/modules/CalDavRequestHandlers.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b5b3dc5fdf701ccfc324a24c8efad79a4a474ed2/calendar/providers/caldav/moz.build">calendar/providers/caldav/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b5b3dc5fdf701ccfc324a24c8efad79a4a474ed2/calendar/providers/caldav/moz.build">file</a> |
<a href="/comm-central/annotate/b5b3dc5fdf701ccfc324a24c8efad79a4a474ed2/calendar/providers/caldav/moz.build">annotate</a> |
<a href="/comm-central/diff/b5b3dc5fdf701ccfc324a24c8efad79a4a474ed2/calendar/providers/caldav/moz.build">diff</a> |
<a href="/comm-central/comparison/b5b3dc5fdf701ccfc324a24c8efad79a4a474ed2/calendar/providers/caldav/moz.build">comparison</a> |
<a href="/comm-central/log/b5b3dc5fdf701ccfc324a24c8efad79a4a474ed2/calendar/providers/caldav/moz.build">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b5b3dc5fdf701ccfc324a24c8efad79a4a474ed2/mail/installer/package-manifest.in">mail/installer/package-manifest.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b5b3dc5fdf701ccfc324a24c8efad79a4a474ed2/mail/installer/package-manifest.in">file</a> |
<a href="/comm-central/annotate/b5b3dc5fdf701ccfc324a24c8efad79a4a474ed2/mail/installer/package-manifest.in">annotate</a> |
<a href="/comm-central/diff/b5b3dc5fdf701ccfc324a24c8efad79a4a474ed2/mail/installer/package-manifest.in">diff</a> |
<a href="/comm-central/comparison/b5b3dc5fdf701ccfc324a24c8efad79a4a474ed2/mail/installer/package-manifest.in">comparison</a> |
<a href="/comm-central/log/b5b3dc5fdf701ccfc324a24c8efad79a4a474ed2/mail/installer/package-manifest.in">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/providers/caldav/CalDavCalendar.jsm</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/providers/caldav/CalDavCalendar.jsm</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -1,34 +1,33 @@</span>
<a href="#l1.4"></a><span id="l1.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l1.5"></a><span id="l1.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l1.6"></a><span id="l1.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8" class="difflineminus">-/* import-globals-from calDavRequestHandlers.js */</span>
<a href="#l1.9"></a><span id="l1.9" class="difflineminus">-/* globals etagsHandler multigetSyncHandler webDavSyncHandler */</span>
<a href="#l1.10"></a><span id="l1.10" class="difflineminus">-</span>
<a href="#l1.11"></a><span id="l1.11"> var EXPORTED_SYMBOLS = [&quot;CalDavCalendar&quot;];</span>
<a href="#l1.12"></a><span id="l1.12"> </span>
<a href="#l1.13"></a><span id="l1.13"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l1.14"></a><span id="l1.14"> var { cal } = ChromeUtils.import(&quot;resource:///modules/calendar/calUtils.jsm&quot;);</span>
<a href="#l1.15"></a><span id="l1.15"> </span>
<a href="#l1.16"></a><span id="l1.16" class="difflineminus">-Services.scriptloader.loadSubScript(&quot;resource:///components/calDavRequestHandlers.js&quot;);</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineminus">-</span>
<a href="#l1.18"></a><span id="l1.18"> var {</span>
<a href="#l1.19"></a><span id="l1.19">   CalDavGenericRequest,</span>
<a href="#l1.20"></a><span id="l1.20">   CalDavLegacySAXRequest,</span>
<a href="#l1.21"></a><span id="l1.21">   CalDavItemRequest,</span>
<a href="#l1.22"></a><span id="l1.22">   CalDavDeleteItemRequest,</span>
<a href="#l1.23"></a><span id="l1.23">   CalDavPropfindRequest,</span>
<a href="#l1.24"></a><span id="l1.24">   CalDavHeaderRequest,</span>
<a href="#l1.25"></a><span id="l1.25">   CalDavPrincipalPropertySearchRequest,</span>
<a href="#l1.26"></a><span id="l1.26">   CalDavOutboxRequest,</span>
<a href="#l1.27"></a><span id="l1.27">   CalDavFreeBusyRequest,</span>
<a href="#l1.28"></a><span id="l1.28"> } = ChromeUtils.import(&quot;resource:///modules/caldav/CalDavRequest.jsm&quot;);</span>
<a href="#l1.29"></a><span id="l1.29"> </span>
<a href="#l1.30"></a><span id="l1.30" class="difflineplus">+var { CalDavEtagsHandler, CalDavWebDavSyncHandler, CalDavMultigetSyncHandler } = ChromeUtils.import(</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+  &quot;resource:///modules/caldav/CalDavRequestHandlers.jsm&quot;</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+);</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+</span>
<a href="#l1.34"></a><span id="l1.34"> var { CalDavSession } = ChromeUtils.import(&quot;resource:///modules/caldav/CalDavSession.jsm&quot;);</span>
<a href="#l1.35"></a><span id="l1.35"> </span>
<a href="#l1.36"></a><span id="l1.36"> var XML_HEADER = '&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;\n';</span>
<a href="#l1.37"></a><span id="l1.37"> var MIME_TEXT_XML = &quot;text/xml; charset=utf-8&quot;;</span>
<a href="#l1.38"></a><span id="l1.38"> </span>
<a href="#l1.39"></a><span id="l1.39"> var cIOL = Ci.calIOperationListener;</span>
<a href="#l1.40"></a><span id="l1.40"> </span>
<a href="#l1.41"></a><span id="l1.41"> function CalDavCalendar() {</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineat">@@ -453,22 +452,21 @@ CalDavCalendar.prototype = {</span>
<a href="#l1.43"></a><span id="l1.43">   get authRealm() {</span>
<a href="#l1.44"></a><span id="l1.44">     return this.mAuthRealm;</span>
<a href="#l1.45"></a><span id="l1.45">   },</span>
<a href="#l1.46"></a><span id="l1.46"> </span>
<a href="#l1.47"></a><span id="l1.47">   /**</span>
<a href="#l1.48"></a><span id="l1.48">    * Builds a correctly encoded nsIURI based on the baseUri and the insert</span>
<a href="#l1.49"></a><span id="l1.49">    * string. The returned uri is basically the baseURI + aInsertString</span>
<a href="#l1.50"></a><span id="l1.50">    *</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineminus">-   * @param aInsertString  String to append to the base uri, for example,</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineminus">-   *                       when creating an event this would be the</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineminus">-   *                       event file name (event.ics), if null, an empty</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineminus">-   *                       string is used.</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineminus">-   * @param aBaseUri       base uri (nsIURI object), if null, this.calendarUri</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineminus">-   *                       will be used.</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineplus">+   * @param {string} aInsertString - String to append to the base uri, for example,</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineplus">+   *                                 when creating an event this would be the</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineplus">+   *                                 event file name (event.ics). If null, an empty</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineplus">+   *                                 string is used.</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineplus">+   * @param {nsIURI} aBaseUri - Base uri, if null, this.calendarUri will be used.</span>
<a href="#l1.62"></a><span id="l1.62">    */</span>
<a href="#l1.63"></a><span id="l1.63">   makeUri(aInsertString, aBaseUri) {</span>
<a href="#l1.64"></a><span id="l1.64">     let baseUri = aBaseUri || this.calendarUri;</span>
<a href="#l1.65"></a><span id="l1.65">     // Build a string containing the full path, decoded, so it looks like</span>
<a href="#l1.66"></a><span id="l1.66">     // this:</span>
<a href="#l1.67"></a><span id="l1.67">     // /some path/insert string.ics</span>
<a href="#l1.68"></a><span id="l1.68">     let decodedPath = this.ensureDecodedPath(baseUri.pathQueryRef) + (aInsertString || &quot;&quot;);</span>
<a href="#l1.69"></a><span id="l1.69"> </span>
<a href="#l1.70"></a><span id="l1.70" class="difflineat">@@ -1111,17 +1109,17 @@ CalDavCalendar.prototype = {</span>
<a href="#l1.71"></a><span id="l1.71">         &quot;passed in null item&quot;</span>
<a href="#l1.72"></a><span id="l1.72">       );</span>
<a href="#l1.73"></a><span id="l1.73">       return;</span>
<a href="#l1.74"></a><span id="l1.74">     }</span>
<a href="#l1.75"></a><span id="l1.75"> </span>
<a href="#l1.76"></a><span id="l1.76">     let locationPath = this.getItemLocationPath(aItem);</span>
<a href="#l1.77"></a><span id="l1.77">     let itemUri = this.makeUri(locationPath);</span>
<a href="#l1.78"></a><span id="l1.78"> </span>
<a href="#l1.79"></a><span id="l1.79" class="difflineminus">-    let multiget = new multigetSyncHandler(</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineplus">+    let multiget = new CalDavMultigetSyncHandler(</span>
<a href="#l1.81"></a><span id="l1.81">       [this.ensureDecodedPath(itemUri.pathQueryRef)],</span>
<a href="#l1.82"></a><span id="l1.82">       this,</span>
<a href="#l1.83"></a><span id="l1.83">       this.makeUri(),</span>
<a href="#l1.84"></a><span id="l1.84">       null,</span>
<a href="#l1.85"></a><span id="l1.85">       false,</span>
<a href="#l1.86"></a><span id="l1.86">       aListener,</span>
<a href="#l1.87"></a><span id="l1.87">       aChangeLogListener</span>
<a href="#l1.88"></a><span id="l1.88">     );</span>
<a href="#l1.89"></a><span id="l1.89" class="difflineat">@@ -1293,48 +1291,47 @@ CalDavCalendar.prototype = {</span>
<a href="#l1.90"></a><span id="l1.90">       }</span>
<a href="#l1.91"></a><span id="l1.91">     }</span>
<a href="#l1.92"></a><span id="l1.92">     return false;</span>
<a href="#l1.93"></a><span id="l1.93">   },</span>
<a href="#l1.94"></a><span id="l1.94"> </span>
<a href="#l1.95"></a><span id="l1.95">   /**</span>
<a href="#l1.96"></a><span id="l1.96">    * Get updated items</span>
<a href="#l1.97"></a><span id="l1.97">    *</span>
<a href="#l1.98"></a><span id="l1.98" class="difflineminus">-   * @param aUri                  The uri to request the items from.</span>
<a href="#l1.99"></a><span id="l1.99" class="difflineminus">-   *                                NOTE: This must be the uri without any uri</span>
<a href="#l1.100"></a><span id="l1.100" class="difflineminus">-   *                                     params. They will be appended in this</span>
<a href="#l1.101"></a><span id="l1.101" class="difflineminus">-   *                                     function.</span>
<a href="#l1.102"></a><span id="l1.102" class="difflineminus">-   * @param aChangeLogListener    (optional) The listener to notify for cached</span>
<a href="#l1.103"></a><span id="l1.103" class="difflineminus">-   *                                         calendars.</span>
<a href="#l1.104"></a><span id="l1.104" class="difflineplus">+   * @param {nsIURI} aUri - The uri to request the items from.</span>
<a href="#l1.105"></a><span id="l1.105" class="difflineplus">+   *                        NOTE: This must be the uri without any uri</span>
<a href="#l1.106"></a><span id="l1.106" class="difflineplus">+   *                        params. They will be appended in this function.</span>
<a href="#l1.107"></a><span id="l1.107" class="difflineplus">+   * @param aChangeLogListener - (optional) The listener to notify for cached</span>
<a href="#l1.108"></a><span id="l1.108" class="difflineplus">+   *                             calendars.</span>
<a href="#l1.109"></a><span id="l1.109">    */</span>
<a href="#l1.110"></a><span id="l1.110">   getUpdatedItems(aUri, aChangeLogListener) {</span>
<a href="#l1.111"></a><span id="l1.111">     if (this.mDisabled) {</span>
<a href="#l1.112"></a><span id="l1.112">       // check if maybe our calendar has become available</span>
<a href="#l1.113"></a><span id="l1.113">       this.checkDavResourceType(aChangeLogListener);</span>
<a href="#l1.114"></a><span id="l1.114">       return;</span>
<a href="#l1.115"></a><span id="l1.115">     }</span>
<a href="#l1.116"></a><span id="l1.116"> </span>
<a href="#l1.117"></a><span id="l1.117">     if (this.mHasWebdavSyncSupport) {</span>
<a href="#l1.118"></a><span id="l1.118" class="difflineminus">-      let webDavSync = new webDavSyncHandler(this, aUri, aChangeLogListener);</span>
<a href="#l1.119"></a><span id="l1.119" class="difflineplus">+      let webDavSync = new CalDavWebDavSyncHandler(this, aUri, aChangeLogListener);</span>
<a href="#l1.120"></a><span id="l1.120">       webDavSync.doWebDAVSync();</span>
<a href="#l1.121"></a><span id="l1.121">       return;</span>
<a href="#l1.122"></a><span id="l1.122">     }</span>
<a href="#l1.123"></a><span id="l1.123"> </span>
<a href="#l1.124"></a><span id="l1.124">     let queryXml =</span>
<a href="#l1.125"></a><span id="l1.125">       XML_HEADER +</span>
<a href="#l1.126"></a><span id="l1.126">       '&lt;D:propfind xmlns:D=&quot;DAV:&quot;&gt;' +</span>
<a href="#l1.127"></a><span id="l1.127">       &quot;&lt;D:prop&gt;&quot; +</span>
<a href="#l1.128"></a><span id="l1.128">       &quot;&lt;D:getcontenttype/&gt;&quot; +</span>
<a href="#l1.129"></a><span id="l1.129">       &quot;&lt;D:resourcetype/&gt;&quot; +</span>
<a href="#l1.130"></a><span id="l1.130">       &quot;&lt;D:getetag/&gt;&quot; +</span>
<a href="#l1.131"></a><span id="l1.131">       &quot;&lt;/D:prop&gt;&quot; +</span>
<a href="#l1.132"></a><span id="l1.132">       &quot;&lt;/D:propfind&gt;&quot;;</span>
<a href="#l1.133"></a><span id="l1.133"> </span>
<a href="#l1.134"></a><span id="l1.134">     let requestUri = this.makeUri(null, aUri);</span>
<a href="#l1.135"></a><span id="l1.135" class="difflineminus">-    let handler = new etagsHandler(this, aUri, aChangeLogListener);</span>
<a href="#l1.136"></a><span id="l1.136" class="difflineplus">+    let handler = new CalDavEtagsHandler(this, aUri, aChangeLogListener);</span>
<a href="#l1.137"></a><span id="l1.137"> </span>
<a href="#l1.138"></a><span id="l1.138">     let onSetupChannel = channel =&gt; {</span>
<a href="#l1.139"></a><span id="l1.139">       channel.requestMethod = &quot;PROPFIND&quot;;</span>
<a href="#l1.140"></a><span id="l1.140">       channel.setRequestHeader(&quot;Depth&quot;, &quot;1&quot;, false);</span>
<a href="#l1.141"></a><span id="l1.141">     };</span>
<a href="#l1.142"></a><span id="l1.142">     let request = new CalDavLegacySAXRequest(</span>
<a href="#l1.143"></a><span id="l1.143">       this.session,</span>
<a href="#l1.144"></a><span id="l1.144">       this,</span>
<a href="#l1.145"></a><span id="l1.145" class="difflineat">@@ -2040,18 +2037,19 @@ CalDavCalendar.prototype = {</span>
<a href="#l1.146"></a><span id="l1.146">     let uriComponents = aString.split(&quot;/&quot;);</span>
<a href="#l1.147"></a><span id="l1.147">     uriComponents = uriComponents.map(encodeURIComponent);</span>
<a href="#l1.148"></a><span id="l1.148">     return uriComponents.join(&quot;/&quot;);</span>
<a href="#l1.149"></a><span id="l1.149">   },</span>
<a href="#l1.150"></a><span id="l1.150"> </span>
<a href="#l1.151"></a><span id="l1.151">   /**</span>
<a href="#l1.152"></a><span id="l1.152">    * This is called to get a decoded path from an encoded path or uri spec.</span>
<a href="#l1.153"></a><span id="l1.153">    *</span>
<a href="#l1.154"></a><span id="l1.154" class="difflineminus">-   * @param aString {string} Represents either a path</span>
<a href="#l1.155"></a><span id="l1.155" class="difflineminus">-   * or a full uri that needs to be decoded.</span>
<a href="#l1.156"></a><span id="l1.156" class="difflineplus">+   * @param {string} aString - Represents either a path</span>
<a href="#l1.157"></a><span id="l1.157" class="difflineplus">+   *                           or a full uri that needs to be decoded.</span>
<a href="#l1.158"></a><span id="l1.158" class="difflineplus">+   * @return {string} A decoded path.</span>
<a href="#l1.159"></a><span id="l1.159">    */</span>
<a href="#l1.160"></a><span id="l1.160">   ensureDecodedPath(aString) {</span>
<a href="#l1.161"></a><span id="l1.161">     if (aString.charAt(0) != &quot;/&quot;) {</span>
<a href="#l1.162"></a><span id="l1.162">       aString = this.extractPathFromSpec(aString);</span>
<a href="#l1.163"></a><span id="l1.163">     }</span>
<a href="#l1.164"></a><span id="l1.164"> </span>
<a href="#l1.165"></a><span id="l1.165">     let uriComponents = aString.split(&quot;/&quot;);</span>
<a href="#l1.166"></a><span id="l1.166">     for (let i = 0; i &lt; uriComponents.length; i++) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1">rename from calendar/providers/caldav/calDavRequestHandlers.js</span>
<a href="#l2.2"></a><span id="l2.2">rename to calendar/providers/caldav/modules/CalDavRequestHandlers.jsm</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineminus">--- a/calendar/providers/caldav/calDavRequestHandlers.js</span>
<a href="#l2.4"></a><span id="l2.4" class="difflineplus">+++ b/calendar/providers/caldav/modules/CalDavRequestHandlers.jsm</span>
<a href="#l2.5"></a><span id="l2.5" class="difflineat">@@ -1,44 +1,52 @@</span>
<a href="#l2.6"></a><span id="l2.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l2.7"></a><span id="l2.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l2.8"></a><span id="l2.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l2.9"></a><span id="l2.9"> </span>
<a href="#l2.10"></a><span id="l2.10" class="difflineminus">-/* globals XML_HEADER MIME_TEXT_XML */</span>
<a href="#l2.11"></a><span id="l2.11" class="difflineminus">-</span>
<a href="#l2.12"></a><span id="l2.12"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l2.13"></a><span id="l2.13"> var { cal } = ChromeUtils.import(&quot;resource:///modules/calendar/calUtils.jsm&quot;);</span>
<a href="#l2.14"></a><span id="l2.14"> var { setTimeout } = ChromeUtils.import(&quot;resource://gre/modules/Timer.jsm&quot;);</span>
<a href="#l2.15"></a><span id="l2.15"> </span>
<a href="#l2.16"></a><span id="l2.16"> var { CalDavLegacySAXRequest } = ChromeUtils.import(&quot;resource:///modules/caldav/CalDavRequest.jsm&quot;);</span>
<a href="#l2.17"></a><span id="l2.17"> </span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+/* exported CalDavEtagsHandler, CalDavWebDavSyncHandler, CalDavMultigetSyncHandler */</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+this.EXPORTED_SYMBOLS = [</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+  &quot;CalDavEtagsHandler&quot;,</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineplus">+  &quot;CalDavWebDavSyncHandler&quot;,</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineplus">+  &quot;CalDavMultigetSyncHandler&quot;,</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineplus">+];</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineplus">+const XML_HEADER = '&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;\n';</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineplus">+const MIME_TEXT_XML = &quot;text/xml; charset=utf-8&quot;;</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineplus">+</span>
<a href="#l2.29"></a><span id="l2.29"> /**</span>
<a href="#l2.30"></a><span id="l2.30">  * This is a handler for the etag request in calDavCalendar.js' getUpdatedItem.</span>
<a href="#l2.31"></a><span id="l2.31">  * It uses the SAX parser to incrementally parse the items and compose the</span>
<a href="#l2.32"></a><span id="l2.32">  * resulting multiget.</span>
<a href="#l2.33"></a><span id="l2.33">  *</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineminus">- * @param aCalendar             The (unwrapped) calendar this request belongs to</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineminus">- * @param aBaseUri              The URI requested (i.e inbox or collection)</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineminus">- * @param aChangeLogListener    (optional) for cached calendars, the listener to</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineminus">- *                                notify.</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+ * @param {calDavCalendar} aCalendar - The (unwrapped) calendar this request belongs to.</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+ * @param {nsIURI} aBaseUri - The URI requested (i.e inbox or collection).</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+ * @param {*=} aChangeLogListener - (optional) for cached calendars, the listener to notify.</span>
<a href="#l2.41"></a><span id="l2.41">  */</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineminus">-function etagsHandler(aCalendar, aBaseUri, aChangeLogListener) {</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineplus">+function CalDavEtagsHandler(aCalendar, aBaseUri, aChangeLogListener) {</span>
<a href="#l2.44"></a><span id="l2.44">   this.calendar = aCalendar;</span>
<a href="#l2.45"></a><span id="l2.45">   this.baseUri = aBaseUri;</span>
<a href="#l2.46"></a><span id="l2.46">   this.changeLogListener = aChangeLogListener;</span>
<a href="#l2.47"></a><span id="l2.47">   this._reader = Cc[&quot;@mozilla.org/saxparser/xmlreader;1&quot;].createInstance(Ci.nsISAXXMLReader);</span>
<a href="#l2.48"></a><span id="l2.48">   this._reader.contentHandler = this;</span>
<a href="#l2.49"></a><span id="l2.49">   this._reader.errorHandler = this;</span>
<a href="#l2.50"></a><span id="l2.50">   this._reader.parseAsync(null);</span>
<a href="#l2.51"></a><span id="l2.51"> </span>
<a href="#l2.52"></a><span id="l2.52">   this.itemsReported = {};</span>
<a href="#l2.53"></a><span id="l2.53">   this.itemsNeedFetching = [];</span>
<a href="#l2.54"></a><span id="l2.54"> }</span>
<a href="#l2.55"></a><span id="l2.55"> </span>
<a href="#l2.56"></a><span id="l2.56" class="difflineminus">-etagsHandler.prototype = {</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineplus">+CalDavEtagsHandler.prototype = {</span>
<a href="#l2.58"></a><span id="l2.58">   skipIndex: -1,</span>
<a href="#l2.59"></a><span id="l2.59">   currentResponse: null,</span>
<a href="#l2.60"></a><span id="l2.60">   tag: null,</span>
<a href="#l2.61"></a><span id="l2.61">   calendar: null,</span>
<a href="#l2.62"></a><span id="l2.62">   baseUri: null,</span>
<a href="#l2.63"></a><span id="l2.63">   changeLogListener: null,</span>
<a href="#l2.64"></a><span id="l2.64">   logXML: &quot;&quot;,</span>
<a href="#l2.65"></a><span id="l2.65"> </span>
<a href="#l2.66"></a><span id="l2.66" class="difflineat">@@ -48,17 +56,17 @@ etagsHandler.prototype = {</span>
<a href="#l2.67"></a><span id="l2.67">   QueryInterface: cal.generateQI([</span>
<a href="#l2.68"></a><span id="l2.68">     Ci.nsISAXContentHandler,</span>
<a href="#l2.69"></a><span id="l2.69">     Ci.nsISAXErrorHandler,</span>
<a href="#l2.70"></a><span id="l2.70">     Ci.nsIRequestObserver,</span>
<a href="#l2.71"></a><span id="l2.71">     Ci.nsIStreamListener,</span>
<a href="#l2.72"></a><span id="l2.72">   ]),</span>
<a href="#l2.73"></a><span id="l2.73"> </span>
<a href="#l2.74"></a><span id="l2.74">   /**</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineminus">-   * @see nsIStreamListener</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineplus">+   * @see nsIRequestObserver</span>
<a href="#l2.77"></a><span id="l2.77">    */</span>
<a href="#l2.78"></a><span id="l2.78">   onStartRequest(request) {</span>
<a href="#l2.79"></a><span id="l2.79">     let httpchannel = request.QueryInterface(Ci.nsIHttpChannel);</span>
<a href="#l2.80"></a><span id="l2.80"> </span>
<a href="#l2.81"></a><span id="l2.81">     let responseStatus;</span>
<a href="#l2.82"></a><span id="l2.82">     try {</span>
<a href="#l2.83"></a><span id="l2.83">       responseStatus = httpchannel.responseStatus;</span>
<a href="#l2.84"></a><span id="l2.84">     } catch (ex) {</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineat">@@ -125,17 +133,17 @@ etagsHandler.prototype = {</span>
<a href="#l2.86"></a><span id="l2.86">       }</span>
<a href="#l2.87"></a><span id="l2.87">     } finally {</span>
<a href="#l2.88"></a><span id="l2.88">       this.calendar.superCalendar.endBatch();</span>
<a href="#l2.89"></a><span id="l2.89">     }</span>
<a href="#l2.90"></a><span id="l2.90"> </span>
<a href="#l2.91"></a><span id="l2.91">     // Avoid sending empty multiget requests update views if something has</span>
<a href="#l2.92"></a><span id="l2.92">     // been deleted server-side.</span>
<a href="#l2.93"></a><span id="l2.93">     if (this.itemsNeedFetching.length) {</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineminus">-      let multiget = new multigetSyncHandler(</span>
<a href="#l2.95"></a><span id="l2.95" class="difflineplus">+      let multiget = new CalDavMultigetSyncHandler(</span>
<a href="#l2.96"></a><span id="l2.96">         this.itemsNeedFetching,</span>
<a href="#l2.97"></a><span id="l2.97">         this.calendar,</span>
<a href="#l2.98"></a><span id="l2.98">         this.baseUri,</span>
<a href="#l2.99"></a><span id="l2.99">         null,</span>
<a href="#l2.100"></a><span id="l2.100">         false,</span>
<a href="#l2.101"></a><span id="l2.101">         null,</span>
<a href="#l2.102"></a><span id="l2.102">         this.changeLogListener</span>
<a href="#l2.103"></a><span id="l2.103">       );</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineat">@@ -151,16 +159,19 @@ etagsHandler.prototype = {</span>
<a href="#l2.105"></a><span id="l2.105"> </span>
<a href="#l2.106"></a><span id="l2.106">       // but do poll the inbox</span>
<a href="#l2.107"></a><span id="l2.107">       if (this.calendar.mShouldPollInbox &amp;&amp; !this.calendar.isInbox(this.baseUri.spec)) {</span>
<a href="#l2.108"></a><span id="l2.108">         this.calendar.pollInbox();</span>
<a href="#l2.109"></a><span id="l2.109">       }</span>
<a href="#l2.110"></a><span id="l2.110">     }</span>
<a href="#l2.111"></a><span id="l2.111">   },</span>
<a href="#l2.112"></a><span id="l2.112"> </span>
<a href="#l2.113"></a><span id="l2.113" class="difflineplus">+  /**</span>
<a href="#l2.114"></a><span id="l2.114" class="difflineplus">+   * @see nsIStreamListener</span>
<a href="#l2.115"></a><span id="l2.115" class="difflineplus">+   */</span>
<a href="#l2.116"></a><span id="l2.116">   onDataAvailable(request, inputStream, offset, count) {</span>
<a href="#l2.117"></a><span id="l2.117">     if (this._reader) {</span>
<a href="#l2.118"></a><span id="l2.118">       // No reader means request error</span>
<a href="#l2.119"></a><span id="l2.119">       this._reader.onDataAvailable(request, inputStream, offset, count);</span>
<a href="#l2.120"></a><span id="l2.120">     }</span>
<a href="#l2.121"></a><span id="l2.121">   },</span>
<a href="#l2.122"></a><span id="l2.122"> </span>
<a href="#l2.123"></a><span id="l2.123">   /**</span>
<a href="#l2.124"></a><span id="l2.124" class="difflineat">@@ -267,35 +278,34 @@ etagsHandler.prototype = {</span>
<a href="#l2.125"></a><span id="l2.125">   processingInstruction(aTarget, aData) {},</span>
<a href="#l2.126"></a><span id="l2.126"> };</span>
<a href="#l2.127"></a><span id="l2.127"> </span>
<a href="#l2.128"></a><span id="l2.128"> /**</span>
<a href="#l2.129"></a><span id="l2.129">  * This is a handler for the webdav sync request in calDavCalendar.js' getUpdatedItem.</span>
<a href="#l2.130"></a><span id="l2.130">  * It uses the SAX parser to incrementally parse the items and compose the</span>
<a href="#l2.131"></a><span id="l2.131">  * resulting multiget.</span>
<a href="#l2.132"></a><span id="l2.132">  *</span>
<a href="#l2.133"></a><span id="l2.133" class="difflineminus">- * @param aCalendar             The (unwrapped) calendar this request belongs to</span>
<a href="#l2.134"></a><span id="l2.134" class="difflineminus">- * @param aBaseUri              The URI requested (i.e inbox or collection)</span>
<a href="#l2.135"></a><span id="l2.135" class="difflineminus">- * @param aChangeLogListener    (optional) for cached calendars, the listener to</span>
<a href="#l2.136"></a><span id="l2.136" class="difflineminus">- *                                notify.</span>
<a href="#l2.137"></a><span id="l2.137" class="difflineplus">+ * @param {calDavCalendar} aCalendar - The (unwrapped) calendar this request belongs to.</span>
<a href="#l2.138"></a><span id="l2.138" class="difflineplus">+ * @param {nsIURI} aBaseUri - The URI requested (i.e inbox or collection).</span>
<a href="#l2.139"></a><span id="l2.139" class="difflineplus">+ * @param {*=} aChangeLogListener - (optional) for cached calendars, the listener to notify.</span>
<a href="#l2.140"></a><span id="l2.140">  */</span>
<a href="#l2.141"></a><span id="l2.141" class="difflineminus">-function webDavSyncHandler(aCalendar, aBaseUri, aChangeLogListener) {</span>
<a href="#l2.142"></a><span id="l2.142" class="difflineplus">+function CalDavWebDavSyncHandler(aCalendar, aBaseUri, aChangeLogListener) {</span>
<a href="#l2.143"></a><span id="l2.143">   this.calendar = aCalendar;</span>
<a href="#l2.144"></a><span id="l2.144">   this.baseUri = aBaseUri;</span>
<a href="#l2.145"></a><span id="l2.145">   this.changeLogListener = aChangeLogListener;</span>
<a href="#l2.146"></a><span id="l2.146">   this._reader = Cc[&quot;@mozilla.org/saxparser/xmlreader;1&quot;].createInstance(Ci.nsISAXXMLReader);</span>
<a href="#l2.147"></a><span id="l2.147">   this._reader.contentHandler = this;</span>
<a href="#l2.148"></a><span id="l2.148">   this._reader.errorHandler = this;</span>
<a href="#l2.149"></a><span id="l2.149">   this._reader.parseAsync(null);</span>
<a href="#l2.150"></a><span id="l2.150"> </span>
<a href="#l2.151"></a><span id="l2.151">   this.itemsReported = {};</span>
<a href="#l2.152"></a><span id="l2.152">   this.itemsNeedFetching = [];</span>
<a href="#l2.153"></a><span id="l2.153"> }</span>
<a href="#l2.154"></a><span id="l2.154"> </span>
<a href="#l2.155"></a><span id="l2.155" class="difflineminus">-webDavSyncHandler.prototype = {</span>
<a href="#l2.156"></a><span id="l2.156" class="difflineplus">+CalDavWebDavSyncHandler.prototype = {</span>
<a href="#l2.157"></a><span id="l2.157">   currentResponse: null,</span>
<a href="#l2.158"></a><span id="l2.158">   tag: null,</span>
<a href="#l2.159"></a><span id="l2.159">   calendar: null,</span>
<a href="#l2.160"></a><span id="l2.160">   baseUri: null,</span>
<a href="#l2.161"></a><span id="l2.161">   newSyncToken: null,</span>
<a href="#l2.162"></a><span id="l2.162">   changeLogListener: null,</span>
<a href="#l2.163"></a><span id="l2.163">   logXML: &quot;&quot;,</span>
<a href="#l2.164"></a><span id="l2.164">   isInPropStat: false,</span>
<a href="#l2.165"></a><span id="l2.165" class="difflineat">@@ -368,17 +378,17 @@ webDavSyncHandler.prototype = {</span>
<a href="#l2.166"></a><span id="l2.166">           { status: Cr.NS_ERROR_NOT_AVAILABLE },</span>
<a href="#l2.167"></a><span id="l2.167">           Cr.NS_ERROR_NOT_AVAILABLE</span>
<a href="#l2.168"></a><span id="l2.168">         );</span>
<a href="#l2.169"></a><span id="l2.169">       }</span>
<a href="#l2.170"></a><span id="l2.170">     });</span>
<a href="#l2.171"></a><span id="l2.171">   },</span>
<a href="#l2.172"></a><span id="l2.172"> </span>
<a href="#l2.173"></a><span id="l2.173">   /**</span>
<a href="#l2.174"></a><span id="l2.174" class="difflineminus">-   * @see nsIStreamListener</span>
<a href="#l2.175"></a><span id="l2.175" class="difflineplus">+   * @see nsIRequestObserver</span>
<a href="#l2.176"></a><span id="l2.176">    */</span>
<a href="#l2.177"></a><span id="l2.177">   onStartRequest(request) {</span>
<a href="#l2.178"></a><span id="l2.178">     let httpchannel = request.QueryInterface(Ci.nsIHttpChannel);</span>
<a href="#l2.179"></a><span id="l2.179"> </span>
<a href="#l2.180"></a><span id="l2.180">     let responseStatus;</span>
<a href="#l2.181"></a><span id="l2.181">     try {</span>
<a href="#l2.182"></a><span id="l2.182">       responseStatus = httpchannel.responseStatus;</span>
<a href="#l2.183"></a><span id="l2.183">     } catch (ex) {</span>
<a href="#l2.184"></a><span id="l2.184" class="difflineat">@@ -425,16 +435,19 @@ webDavSyncHandler.prototype = {</span>
<a href="#l2.185"></a><span id="l2.185">     }</span>
<a href="#l2.186"></a><span id="l2.186">     try {</span>
<a href="#l2.187"></a><span id="l2.187">       this._reader.onStopRequest(request, statusCode);</span>
<a href="#l2.188"></a><span id="l2.188">     } finally {</span>
<a href="#l2.189"></a><span id="l2.189">       this._reader = null;</span>
<a href="#l2.190"></a><span id="l2.190">     }</span>
<a href="#l2.191"></a><span id="l2.191">   },</span>
<a href="#l2.192"></a><span id="l2.192"> </span>
<a href="#l2.193"></a><span id="l2.193" class="difflineplus">+  /**</span>
<a href="#l2.194"></a><span id="l2.194" class="difflineplus">+   * @see nsIStreamListener</span>
<a href="#l2.195"></a><span id="l2.195" class="difflineplus">+   */</span>
<a href="#l2.196"></a><span id="l2.196">   onDataAvailable(request, inputStream, offset, count) {</span>
<a href="#l2.197"></a><span id="l2.197">     if (this._reader) {</span>
<a href="#l2.198"></a><span id="l2.198">       // No reader means request error</span>
<a href="#l2.199"></a><span id="l2.199">       this._reader.onDataAvailable(request, inputStream, offset, count);</span>
<a href="#l2.200"></a><span id="l2.200">     }</span>
<a href="#l2.201"></a><span id="l2.201">   },</span>
<a href="#l2.202"></a><span id="l2.202"> </span>
<a href="#l2.203"></a><span id="l2.203">   /**</span>
<a href="#l2.204"></a><span id="l2.204" class="difflineat">@@ -479,17 +492,17 @@ webDavSyncHandler.prototype = {</span>
<a href="#l2.205"></a><span id="l2.205">         if (!this.itemsReported[path]) {</span>
<a href="#l2.206"></a><span id="l2.206">           this.calendar.deleteTargetCalendarItem(path);</span>
<a href="#l2.207"></a><span id="l2.207">         }</span>
<a href="#l2.208"></a><span id="l2.208">       }</span>
<a href="#l2.209"></a><span id="l2.209">     }</span>
<a href="#l2.210"></a><span id="l2.210">     this.calendar.superCalendar.endBatch();</span>
<a href="#l2.211"></a><span id="l2.211"> </span>
<a href="#l2.212"></a><span id="l2.212">     if (this.itemsNeedFetching.length) {</span>
<a href="#l2.213"></a><span id="l2.213" class="difflineminus">-      let multiget = new multigetSyncHandler(</span>
<a href="#l2.214"></a><span id="l2.214" class="difflineplus">+      let multiget = new CalDavMultigetSyncHandler(</span>
<a href="#l2.215"></a><span id="l2.215">         this.itemsNeedFetching,</span>
<a href="#l2.216"></a><span id="l2.216">         this.calendar,</span>
<a href="#l2.217"></a><span id="l2.217">         this.baseUri,</span>
<a href="#l2.218"></a><span id="l2.218">         this.newSyncToken,</span>
<a href="#l2.219"></a><span id="l2.219">         this.additionalSyncNeeded,</span>
<a href="#l2.220"></a><span id="l2.220">         null,</span>
<a href="#l2.221"></a><span id="l2.221">         this.changeLogListener</span>
<a href="#l2.222"></a><span id="l2.222">       );</span>
<a href="#l2.223"></a><span id="l2.223" class="difflineat">@@ -656,29 +669,29 @@ webDavSyncHandler.prototype = {</span>
<a href="#l2.224"></a><span id="l2.224">   processingInstruction(aTarget, aData) {},</span>
<a href="#l2.225"></a><span id="l2.225"> };</span>
<a href="#l2.226"></a><span id="l2.226"> </span>
<a href="#l2.227"></a><span id="l2.227"> /**</span>
<a href="#l2.228"></a><span id="l2.228">  * This is a handler for the multiget request.</span>
<a href="#l2.229"></a><span id="l2.229">  * It uses the SAX parser to incrementally parse the items and compose the</span>
<a href="#l2.230"></a><span id="l2.230">  * resulting multiget.</span>
<a href="#l2.231"></a><span id="l2.231">  *</span>
<a href="#l2.232"></a><span id="l2.232" class="difflineminus">- * @param aItemsNeedFetching    The array of items to fetch, this must be an</span>
<a href="#l2.233"></a><span id="l2.233" class="difflineminus">- *                              array of un-encoded paths.</span>
<a href="#l2.234"></a><span id="l2.234" class="difflineminus">- * @param aCalendar             The (unwrapped) calendar this request belongs to</span>
<a href="#l2.235"></a><span id="l2.235" class="difflineminus">- * @param aBaseUri              The URI requested (i.e inbox or collection)</span>
<a href="#l2.236"></a><span id="l2.236" class="difflineminus">- * @param aAdditionalSyncNeeded (optional) If true, the passed sync token is not the</span>
<a href="#l2.237"></a><span id="l2.237" class="difflineminus">- *                                latest, another webdav sync run should be</span>
<a href="#l2.238"></a><span id="l2.238" class="difflineminus">- *                                done after completion.</span>
<a href="#l2.239"></a><span id="l2.239" class="difflineminus">- * @param aNewSyncToken         (optional) new Sync token to set if operation successful</span>
<a href="#l2.240"></a><span id="l2.240" class="difflineminus">- * @param aListener             (optional) The listener to notify</span>
<a href="#l2.241"></a><span id="l2.241" class="difflineminus">- * @param aChangeLogListener    (optional) for cached calendars, the listener to</span>
<a href="#l2.242"></a><span id="l2.242" class="difflineminus">- *                                notify.</span>
<a href="#l2.243"></a><span id="l2.243" class="difflineplus">+ * @param {String[]} aItemsNeedFetching - Array of items to fetch, an array of</span>
<a href="#l2.244"></a><span id="l2.244" class="difflineplus">+ *                                        un-encoded paths.</span>
<a href="#l2.245"></a><span id="l2.245" class="difflineplus">+ * @param {calDavCalendar} aCalendar - The (unwrapped) calendar this request belongs to.</span>
<a href="#l2.246"></a><span id="l2.246" class="difflineplus">+ * @param {nsIURI} aBaseUri - The URI requested (i.e inbox or collection).</span>
<a href="#l2.247"></a><span id="l2.247" class="difflineplus">+ * @param {*=} aNewSyncToken - (optional) New Sync token to set if operation successful.</span>
<a href="#l2.248"></a><span id="l2.248" class="difflineplus">+ * @param {Boolean=} aAdditionalSyncNeeded - (optional) If true, the passed sync token is not the</span>
<a href="#l2.249"></a><span id="l2.249" class="difflineplus">+ *                                           latest, another webdav sync run should be</span>
<a href="#l2.250"></a><span id="l2.250" class="difflineplus">+ *                                           done after completion.</span>
<a href="#l2.251"></a><span id="l2.251" class="difflineplus">+ * @param {*=} aListener - (optional) The listener to notify.</span>
<a href="#l2.252"></a><span id="l2.252" class="difflineplus">+ * @param {*=} aChangeLogListener - (optional) For cached calendars, the listener to</span>
<a href="#l2.253"></a><span id="l2.253" class="difflineplus">+ *                                  notify.</span>
<a href="#l2.254"></a><span id="l2.254">  */</span>
<a href="#l2.255"></a><span id="l2.255" class="difflineminus">-function multigetSyncHandler(</span>
<a href="#l2.256"></a><span id="l2.256" class="difflineplus">+function CalDavMultigetSyncHandler(</span>
<a href="#l2.257"></a><span id="l2.257">   aItemsNeedFetching,</span>
<a href="#l2.258"></a><span id="l2.258">   aCalendar,</span>
<a href="#l2.259"></a><span id="l2.259">   aBaseUri,</span>
<a href="#l2.260"></a><span id="l2.260">   aNewSyncToken,</span>
<a href="#l2.261"></a><span id="l2.261">   aAdditionalSyncNeeded,</span>
<a href="#l2.262"></a><span id="l2.262">   aListener,</span>
<a href="#l2.263"></a><span id="l2.263">   aChangeLogListener</span>
<a href="#l2.264"></a><span id="l2.264"> ) {</span>
<a href="#l2.265"></a><span id="l2.265" class="difflineat">@@ -689,17 +702,17 @@ function multigetSyncHandler(</span>
<a href="#l2.266"></a><span id="l2.266">   this.changeLogListener = aChangeLogListener;</span>
<a href="#l2.267"></a><span id="l2.267">   this._reader = Cc[&quot;@mozilla.org/saxparser/xmlreader;1&quot;].createInstance(Ci.nsISAXXMLReader);</span>
<a href="#l2.268"></a><span id="l2.268">   this._reader.contentHandler = this;</span>
<a href="#l2.269"></a><span id="l2.269">   this._reader.errorHandler = this;</span>
<a href="#l2.270"></a><span id="l2.270">   this._reader.parseAsync(null);</span>
<a href="#l2.271"></a><span id="l2.271">   this.itemsNeedFetching = aItemsNeedFetching;</span>
<a href="#l2.272"></a><span id="l2.272">   this.additionalSyncNeeded = aAdditionalSyncNeeded;</span>
<a href="#l2.273"></a><span id="l2.273"> }</span>
<a href="#l2.274"></a><span id="l2.274" class="difflineminus">-multigetSyncHandler.prototype = {</span>
<a href="#l2.275"></a><span id="l2.275" class="difflineplus">+CalDavMultigetSyncHandler.prototype = {</span>
<a href="#l2.276"></a><span id="l2.276">   currentResponse: null,</span>
<a href="#l2.277"></a><span id="l2.277">   tag: null,</span>
<a href="#l2.278"></a><span id="l2.278">   calendar: null,</span>
<a href="#l2.279"></a><span id="l2.279">   baseUri: null,</span>
<a href="#l2.280"></a><span id="l2.280">   newSyncToken: null,</span>
<a href="#l2.281"></a><span id="l2.281">   listener: null,</span>
<a href="#l2.282"></a><span id="l2.282">   changeLogListener: null,</span>
<a href="#l2.283"></a><span id="l2.283">   logXML: null,</span>
<a href="#l2.284"></a><span id="l2.284" class="difflineat">@@ -768,17 +781,17 @@ multigetSyncHandler.prototype = {</span>
<a href="#l2.285"></a><span id="l2.285">           { status: Cr.NS_ERROR_NOT_AVAILABLE },</span>
<a href="#l2.286"></a><span id="l2.286">           Cr.NS_ERROR_NOT_AVAILABLE</span>
<a href="#l2.287"></a><span id="l2.287">         );</span>
<a href="#l2.288"></a><span id="l2.288">       }</span>
<a href="#l2.289"></a><span id="l2.289">     });</span>
<a href="#l2.290"></a><span id="l2.290">   },</span>
<a href="#l2.291"></a><span id="l2.291"> </span>
<a href="#l2.292"></a><span id="l2.292">   /**</span>
<a href="#l2.293"></a><span id="l2.293" class="difflineminus">-   * @see nsIStreamListener</span>
<a href="#l2.294"></a><span id="l2.294" class="difflineplus">+   * @see nsIRequestObserver</span>
<a href="#l2.295"></a><span id="l2.295">    */</span>
<a href="#l2.296"></a><span id="l2.296">   onStartRequest(request) {</span>
<a href="#l2.297"></a><span id="l2.297">     let httpchannel = request.QueryInterface(Ci.nsIHttpChannel);</span>
<a href="#l2.298"></a><span id="l2.298"> </span>
<a href="#l2.299"></a><span id="l2.299">     let responseStatus;</span>
<a href="#l2.300"></a><span id="l2.300">     try {</span>
<a href="#l2.301"></a><span id="l2.301">       responseStatus = httpchannel.responseStatus;</span>
<a href="#l2.302"></a><span id="l2.302">     } catch (ex) {</span>
<a href="#l2.303"></a><span id="l2.303" class="difflineat">@@ -816,17 +829,21 @@ multigetSyncHandler.prototype = {</span>
<a href="#l2.304"></a><span id="l2.304">       if (this.newSyncToken) {</span>
<a href="#l2.305"></a><span id="l2.305">         this.calendar.mWebdavSyncToken = this.newSyncToken;</span>
<a href="#l2.306"></a><span id="l2.306">         this.calendar.saveCalendarProperties();</span>
<a href="#l2.307"></a><span id="l2.307">         cal.LOG(&quot;CalDAV: New webdav-sync Token: &quot; + this.calendar.mWebdavSyncToken);</span>
<a href="#l2.308"></a><span id="l2.308">       }</span>
<a href="#l2.309"></a><span id="l2.309"> </span>
<a href="#l2.310"></a><span id="l2.310">       if (this.additionalSyncNeeded) {</span>
<a href="#l2.311"></a><span id="l2.311">         setTimeout(() =&gt; {</span>
<a href="#l2.312"></a><span id="l2.312" class="difflineminus">-          let wds = new webDavSyncHandler(this.calendar, this.baseUri, this.changeLogListener);</span>
<a href="#l2.313"></a><span id="l2.313" class="difflineplus">+          let wds = new CalDavWebDavSyncHandler(</span>
<a href="#l2.314"></a><span id="l2.314" class="difflineplus">+            this.calendar,</span>
<a href="#l2.315"></a><span id="l2.315" class="difflineplus">+            this.baseUri,</span>
<a href="#l2.316"></a><span id="l2.316" class="difflineplus">+            this.changeLogListener</span>
<a href="#l2.317"></a><span id="l2.317" class="difflineplus">+          );</span>
<a href="#l2.318"></a><span id="l2.318">           wds.doWebDAVSync();</span>
<a href="#l2.319"></a><span id="l2.319">         }, 0);</span>
<a href="#l2.320"></a><span id="l2.320">       } else {</span>
<a href="#l2.321"></a><span id="l2.321">         this.calendar.finalizeUpdatedItems(this.changeLogListener, this.baseUri);</span>
<a href="#l2.322"></a><span id="l2.322">       }</span>
<a href="#l2.323"></a><span id="l2.323">     }</span>
<a href="#l2.324"></a><span id="l2.324">     if (!this._reader) {</span>
<a href="#l2.325"></a><span id="l2.325">       // No reader means there was a request error. The error is already</span>
<a href="#l2.326"></a><span id="l2.326" class="difflineat">@@ -852,16 +869,19 @@ multigetSyncHandler.prototype = {</span>
<a href="#l2.327"></a><span id="l2.327">           this.requestHandler.doMultiGet();</span>
<a href="#l2.328"></a><span id="l2.328">         },</span>
<a href="#l2.329"></a><span id="l2.329">       };</span>
<a href="#l2.330"></a><span id="l2.330">       this.timer = Cc[&quot;@mozilla.org/timer;1&quot;].createInstance(Ci.nsITimer);</span>
<a href="#l2.331"></a><span id="l2.331">       this.timer.initWithCallback(timerCallback, 0, Ci.nsITimer.TYPE_ONE_SHOT);</span>
<a href="#l2.332"></a><span id="l2.332">     }</span>
<a href="#l2.333"></a><span id="l2.333">   },</span>
<a href="#l2.334"></a><span id="l2.334"> </span>
<a href="#l2.335"></a><span id="l2.335" class="difflineplus">+  /**</span>
<a href="#l2.336"></a><span id="l2.336" class="difflineplus">+   * @see nsIStreamListener</span>
<a href="#l2.337"></a><span id="l2.337" class="difflineplus">+   */</span>
<a href="#l2.338"></a><span id="l2.338">   onDataAvailable(request, inputStream, offset, count) {</span>
<a href="#l2.339"></a><span id="l2.339">     if (this._reader) {</span>
<a href="#l2.340"></a><span id="l2.340">       // No reader means request error</span>
<a href="#l2.341"></a><span id="l2.341">       this._reader.onDataAvailable(request, inputStream, offset, count);</span>
<a href="#l2.342"></a><span id="l2.342">     }</span>
<a href="#l2.343"></a><span id="l2.343">   },</span>
<a href="#l2.344"></a><span id="l2.344"> </span>
<a href="#l2.345"></a><span id="l2.345">   /**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/calendar/providers/caldav/moz.build</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/calendar/providers/caldav/moz.build</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -10,19 +10,15 @@ EXTRA_JS_MODULES += [</span>
<a href="#l3.4"></a><span id="l3.4"> ]</span>
<a href="#l3.5"></a><span id="l3.5"> </span>
<a href="#l3.6"></a><span id="l3.6"> XPCOM_MANIFESTS += [</span>
<a href="#l3.7"></a><span id="l3.7">     'components.conf',</span>
<a href="#l3.8"></a><span id="l3.8"> ]</span>
<a href="#l3.9"></a><span id="l3.9"> </span>
<a href="#l3.10"></a><span id="l3.10"> EXTRA_JS_MODULES.caldav += [</span>
<a href="#l3.11"></a><span id="l3.11">     'modules/CalDavRequest.jsm',</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+    'modules/CalDavRequestHandlers.jsm',</span>
<a href="#l3.13"></a><span id="l3.13">     'modules/CalDavSession.jsm',</span>
<a href="#l3.14"></a><span id="l3.14">     'modules/CalDavUtils.jsm',</span>
<a href="#l3.15"></a><span id="l3.15"> ]</span>
<a href="#l3.16"></a><span id="l3.16"> </span>
<a href="#l3.17"></a><span id="l3.17" class="difflineminus">-# These files go in components so they can be packaged correctly.</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineminus">-FINAL_TARGET_FILES.components += [</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineminus">-    'calDavRequestHandlers.js',</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineminus">-]</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineminus">-</span>
<a href="#l3.22"></a><span id="l3.22"> with Files('**'):</span>
<a href="#l3.23"></a><span id="l3.23">     BUG_COMPONENT = ('Calendar', 'Provider: CalDAV')</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/installer/package-manifest.in</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/installer/package-manifest.in</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -348,17 +348,16 @@</span>
<a href="#l4.4"></a><span id="l4.4"> # Files added to components directory via `EXTRA_COMPONENTS`.</span>
<a href="#l4.5"></a><span id="l4.5"> @RESPATH@/components/calBackendLoader.js</span>
<a href="#l4.6"></a><span id="l4.6"> @RESPATH@/components/calBackendLoader.manifest</span>
<a href="#l4.7"></a><span id="l4.7"> @RESPATH@/components/calICALJSComponents.js</span>
<a href="#l4.8"></a><span id="l4.8"> </span>
<a href="#l4.9"></a><span id="l4.9"> # Files added to components directory via `FINAL_TARGET_FILES.components`.</span>
<a href="#l4.10"></a><span id="l4.10"> @RESPATH@/components/calCachedCalendar.js</span>
<a href="#l4.11"></a><span id="l4.11"> @RESPATH@/components/calDateTime.js</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-@RESPATH@/components/calDavRequestHandlers.js</span>
<a href="#l4.13"></a><span id="l4.13"> @RESPATH@/components/calDuration.js</span>
<a href="#l4.14"></a><span id="l4.14"> @RESPATH@/components/calFilter.js</span>
<a href="#l4.15"></a><span id="l4.15"> @RESPATH@/components/calICSService.js</span>
<a href="#l4.16"></a><span id="l4.16"> @RESPATH@/components/calICSService-worker.js</span>
<a href="#l4.17"></a><span id="l4.17"> @RESPATH@/components/calItemBase.js</span>
<a href="#l4.18"></a><span id="l4.18"> @RESPATH@/components/calPeriod.js</span>
<a href="#l4.19"></a><span id="l4.19"> @RESPATH@/components/calRecurrenceRule.js</span>
<a href="#l4.20"></a><span id="l4.20"> @RESPATH@/components/calTimezone.js</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

