<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 26202:9ec42b993238cc77d539150cfa3a934be3be6053</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 9ec42b993238cc77d539150cfa3a934be3be6053" />
<meta property="og:url" content="/comm-central/rev/9ec42b993238cc77d539150cfa3a934be3be6053" />
<meta property="og:description" content="Bug 1476428 - Only warn the user about possible phishing URLs when they click the link. r=mkmelin" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 9ec42b993238cc77d539150cfa3a934be3be6053 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/9ec42b993238cc77d539150cfa3a934be3be6053">shortlog</a> |
<a href="/comm-central/log/9ec42b993238cc77d539150cfa3a934be3be6053">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/9ec42b993238cc77d539150cfa3a934be3be6053">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/9ec42b993238cc77d539150cfa3a934be3be6053">files</a> |
changeset |
<a href="/comm-central/raw-rev/9ec42b993238cc77d539150cfa3a934be3be6053">raw</a>  | <a href="/comm-central/archive/9ec42b993238cc77d539150cfa3a934be3be6053.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1476428">Bug 1476428</a> - Only warn the user about possible phishing URLs when they click the link. r=mkmelin
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#111;&#115;&#105;&#97;&#104;&#32;&#66;&#114;&#117;&#110;&#101;&#114;&#32;&#60;&#106;&#115;&#98;&#114;&#117;&#110;&#101;&#114;&#64;&#117;&#109;&#105;&#99;&#104;&#46;&#101;&#100;&#117;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 29 Mar 2019 11:06:03 +0200</td></tr>

<tr>
 <td>changeset 26202</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/9ec42b993238cc77d539150cfa3a934be3be6053">9ec42b993238cc77d539150cfa3a934be3be6053</a></td>
</tr>



<tr>
<td>parent 26201</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/fdbbe7d7663239a007f9b790abbdbb3f659146ce">fdbbe7d7663239a007f9b790abbdbb3f659146ce</a>
</td>
</tr>

<tr>
<td>child 26203</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/fe9337e031b81a7a57d4903a9747af2eec51f7ef">fe9337e031b81a7a57d4903a9747af2eec51f7ef</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=9ec42b993238cc77d539150cfa3a934be3be6053">15721</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Fri, 29 Mar 2019 22:00:21 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@9ec42b993238 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=9ec42b993238cc77d539150cfa3a934be3be6053">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=9ec42b993238cc77d539150cfa3a934be3be6053&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=9ec42b993238cc77d539150cfa3a934be3be6053&newProject=comm-central&newRevision=fdbbe7d7663239a007f9b790abbdbb3f659146ce&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=9ec42b993238cc77d539150cfa3a934be3be6053&newProject=comm-central&newRevision=fdbbe7d7663239a007f9b790abbdbb3f659146ce&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=9ec42b993238cc77d539150cfa3a934be3be6053&newProject=comm-central&newRevision=fdbbe7d7663239a007f9b790abbdbb3f659146ce&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mkmelin%29&revcount=50">mkmelin</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1476428">1476428</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1476428">Bug 1476428</a> - Only warn the user about possible phishing URLs when they click the link. r=mkmelin</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9ec42b993238cc77d539150cfa3a934be3be6053/mail/base/content/contentAreaClick.js">mail/base/content/contentAreaClick.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ec42b993238cc77d539150cfa3a934be3be6053/mail/base/content/contentAreaClick.js">file</a> |
<a href="/comm-central/annotate/9ec42b993238cc77d539150cfa3a934be3be6053/mail/base/content/contentAreaClick.js">annotate</a> |
<a href="/comm-central/diff/9ec42b993238cc77d539150cfa3a934be3be6053/mail/base/content/contentAreaClick.js">diff</a> |
<a href="/comm-central/comparison/9ec42b993238cc77d539150cfa3a934be3be6053/mail/base/content/contentAreaClick.js">comparison</a> |
<a href="/comm-central/log/9ec42b993238cc77d539150cfa3a934be3be6053/mail/base/content/contentAreaClick.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9ec42b993238cc77d539150cfa3a934be3be6053/mail/base/content/mailWindowOverlay.js">mail/base/content/mailWindowOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ec42b993238cc77d539150cfa3a934be3be6053/mail/base/content/mailWindowOverlay.js">file</a> |
<a href="/comm-central/annotate/9ec42b993238cc77d539150cfa3a934be3be6053/mail/base/content/mailWindowOverlay.js">annotate</a> |
<a href="/comm-central/diff/9ec42b993238cc77d539150cfa3a934be3be6053/mail/base/content/mailWindowOverlay.js">diff</a> |
<a href="/comm-central/comparison/9ec42b993238cc77d539150cfa3a934be3be6053/mail/base/content/mailWindowOverlay.js">comparison</a> |
<a href="/comm-central/log/9ec42b993238cc77d539150cfa3a934be3be6053/mail/base/content/mailWindowOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9ec42b993238cc77d539150cfa3a934be3be6053/mail/base/content/phishingDetector.js">mail/base/content/phishingDetector.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ec42b993238cc77d539150cfa3a934be3be6053/mail/base/content/phishingDetector.js">file</a> |
<a href="/comm-central/annotate/9ec42b993238cc77d539150cfa3a934be3be6053/mail/base/content/phishingDetector.js">annotate</a> |
<a href="/comm-central/diff/9ec42b993238cc77d539150cfa3a934be3be6053/mail/base/content/phishingDetector.js">diff</a> |
<a href="/comm-central/comparison/9ec42b993238cc77d539150cfa3a934be3be6053/mail/base/content/phishingDetector.js">comparison</a> |
<a href="/comm-central/log/9ec42b993238cc77d539150cfa3a934be3be6053/mail/base/content/phishingDetector.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9ec42b993238cc77d539150cfa3a934be3be6053/mail/base/content/specialTabs.js">mail/base/content/specialTabs.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ec42b993238cc77d539150cfa3a934be3be6053/mail/base/content/specialTabs.js">file</a> |
<a href="/comm-central/annotate/9ec42b993238cc77d539150cfa3a934be3be6053/mail/base/content/specialTabs.js">annotate</a> |
<a href="/comm-central/diff/9ec42b993238cc77d539150cfa3a934be3be6053/mail/base/content/specialTabs.js">diff</a> |
<a href="/comm-central/comparison/9ec42b993238cc77d539150cfa3a934be3be6053/mail/base/content/specialTabs.js">comparison</a> |
<a href="/comm-central/log/9ec42b993238cc77d539150cfa3a934be3be6053/mail/base/content/specialTabs.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9ec42b993238cc77d539150cfa3a934be3be6053/mail/components/newmailaccount/content/accountProvisionerTab.js">mail/components/newmailaccount/content/accountProvisionerTab.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ec42b993238cc77d539150cfa3a934be3be6053/mail/components/newmailaccount/content/accountProvisionerTab.js">file</a> |
<a href="/comm-central/annotate/9ec42b993238cc77d539150cfa3a934be3be6053/mail/components/newmailaccount/content/accountProvisionerTab.js">annotate</a> |
<a href="/comm-central/diff/9ec42b993238cc77d539150cfa3a934be3be6053/mail/components/newmailaccount/content/accountProvisionerTab.js">diff</a> |
<a href="/comm-central/comparison/9ec42b993238cc77d539150cfa3a934be3be6053/mail/components/newmailaccount/content/accountProvisionerTab.js">comparison</a> |
<a href="/comm-central/log/9ec42b993238cc77d539150cfa3a934be3be6053/mail/components/newmailaccount/content/accountProvisionerTab.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9ec42b993238cc77d539150cfa3a934be3be6053/mail/locales/en-US/chrome/messenger/messenger.properties">mail/locales/en-US/chrome/messenger/messenger.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ec42b993238cc77d539150cfa3a934be3be6053/mail/locales/en-US/chrome/messenger/messenger.properties">file</a> |
<a href="/comm-central/annotate/9ec42b993238cc77d539150cfa3a934be3be6053/mail/locales/en-US/chrome/messenger/messenger.properties">annotate</a> |
<a href="/comm-central/diff/9ec42b993238cc77d539150cfa3a934be3be6053/mail/locales/en-US/chrome/messenger/messenger.properties">diff</a> |
<a href="/comm-central/comparison/9ec42b993238cc77d539150cfa3a934be3be6053/mail/locales/en-US/chrome/messenger/messenger.properties">comparison</a> |
<a href="/comm-central/log/9ec42b993238cc77d539150cfa3a934be3be6053/mail/locales/en-US/chrome/messenger/messenger.properties">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9ec42b993238cc77d539150cfa3a934be3be6053/mail/test/mozmill/message-header/evil-attached.eml">mail/test/mozmill/message-header/evil-attached.eml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ec42b993238cc77d539150cfa3a934be3be6053/mail/test/mozmill/message-header/evil-attached.eml">file</a> |
<a href="/comm-central/annotate/9ec42b993238cc77d539150cfa3a934be3be6053/mail/test/mozmill/message-header/evil-attached.eml">annotate</a> |
<a href="/comm-central/diff/9ec42b993238cc77d539150cfa3a934be3be6053/mail/test/mozmill/message-header/evil-attached.eml">diff</a> |
<a href="/comm-central/comparison/9ec42b993238cc77d539150cfa3a934be3be6053/mail/test/mozmill/message-header/evil-attached.eml">comparison</a> |
<a href="/comm-central/log/9ec42b993238cc77d539150cfa3a934be3be6053/mail/test/mozmill/message-header/evil-attached.eml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9ec42b993238cc77d539150cfa3a934be3be6053/mail/test/mozmill/message-header/evil.eml">mail/test/mozmill/message-header/evil.eml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ec42b993238cc77d539150cfa3a934be3be6053/mail/test/mozmill/message-header/evil.eml">file</a> |
<a href="/comm-central/annotate/9ec42b993238cc77d539150cfa3a934be3be6053/mail/test/mozmill/message-header/evil.eml">annotate</a> |
<a href="/comm-central/diff/9ec42b993238cc77d539150cfa3a934be3be6053/mail/test/mozmill/message-header/evil.eml">diff</a> |
<a href="/comm-central/comparison/9ec42b993238cc77d539150cfa3a934be3be6053/mail/test/mozmill/message-header/evil.eml">comparison</a> |
<a href="/comm-central/log/9ec42b993238cc77d539150cfa3a934be3be6053/mail/test/mozmill/message-header/evil.eml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9ec42b993238cc77d539150cfa3a934be3be6053/mail/test/mozmill/message-header/test-phishing-bar.js">mail/test/mozmill/message-header/test-phishing-bar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ec42b993238cc77d539150cfa3a934be3be6053/mail/test/mozmill/message-header/test-phishing-bar.js">file</a> |
<a href="/comm-central/annotate/9ec42b993238cc77d539150cfa3a934be3be6053/mail/test/mozmill/message-header/test-phishing-bar.js">annotate</a> |
<a href="/comm-central/diff/9ec42b993238cc77d539150cfa3a934be3be6053/mail/test/mozmill/message-header/test-phishing-bar.js">diff</a> |
<a href="/comm-central/comparison/9ec42b993238cc77d539150cfa3a934be3be6053/mail/test/mozmill/message-header/test-phishing-bar.js">comparison</a> |
<a href="/comm-central/log/9ec42b993238cc77d539150cfa3a934be3be6053/mail/test/mozmill/message-header/test-phishing-bar.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/base/content/contentAreaClick.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/base/content/contentAreaClick.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -1,61 +1,65 @@</span>
<a href="#l1.4"></a><span id="l1.4"> /**</span>
<a href="#l1.5"></a><span id="l1.5">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l1.6"></a><span id="l1.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l1.7"></a><span id="l1.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l1.8"></a><span id="l1.8"> </span>
<a href="#l1.9"></a><span id="l1.9"> /* import-globals-from ../../../../toolkit/content/contentAreaUtils.js */</span>
<a href="#l1.10"></a><span id="l1.10"> /* import-globals-from mailWindow.js */</span>
<a href="#l1.11"></a><span id="l1.11" class="difflineplus">+/* import-globals-from utilityOverlay.js */</span>
<a href="#l1.12"></a><span id="l1.12"> /* import-globals-from phishingDetector.js */</span>
<a href="#l1.13"></a><span id="l1.13"> </span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+var {PlacesUtils} = ChromeUtils.import(&quot;resource://gre/modules/PlacesUtils.jsm&quot;);</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+</span>
<a href="#l1.17"></a><span id="l1.17"> /**</span>
<a href="#l1.18"></a><span id="l1.18">  * Extract the href from the link click event.</span>
<a href="#l1.19"></a><span id="l1.19">  * We look for HTMLAnchorElement, HTMLAreaElement, HTMLLinkElement,</span>
<a href="#l1.20"></a><span id="l1.20">  * HTMLInputElement.form.action, and nested anchor tags.</span>
<a href="#l1.21"></a><span id="l1.21">  * If the clicked element was a HTMLInputElement or HTMLButtonElement</span>
<a href="#l1.22"></a><span id="l1.22">  * we return the form action.</span>
<a href="#l1.23"></a><span id="l1.23">  *</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineminus">- * @return href for the url being clicked</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineplus">+ * @return [href, linkText] the url and the text for the link being clicked.</span>
<a href="#l1.26"></a><span id="l1.26">  */</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineminus">-</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineminus">-var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineminus">-var {PlacesUtils} = ChromeUtils.import(&quot;resource://gre/modules/PlacesUtils.jsm&quot;);</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineplus">+function hRefForClickEvent(aEvent, aDontCheckInputElement) {</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+  let target = (aEvent.type == &quot;command&quot;) ?</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+    document.commandDispatcher.focusedElement : aEvent.target;</span>
<a href="#l1.33"></a><span id="l1.33"> </span>
<a href="#l1.34"></a><span id="l1.34" class="difflineminus">-function hRefForClickEvent(aEvent, aDontCheckInputElement) {</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineminus">-  var href;</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineminus">-  var isKeyCommand = (aEvent.type == &quot;command&quot;);</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineminus">-  var target =</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineminus">-    isKeyCommand ? document.commandDispatcher.focusedElement : aEvent.target;</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+  if (target instanceof HTMLImageElement &amp;&amp;</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+      target.hasAttribute(&quot;overflowing&quot;)) { // Click on zoomed image.</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineplus">+    return [null, null];</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineplus">+  }</span>
<a href="#l1.43"></a><span id="l1.43"> </span>
<a href="#l1.44"></a><span id="l1.44" class="difflineplus">+  let href = null;</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineplus">+  let linkText = null;</span>
<a href="#l1.46"></a><span id="l1.46">   if (target instanceof HTMLAnchorElement ||</span>
<a href="#l1.47"></a><span id="l1.47">       target instanceof HTMLAreaElement ||</span>
<a href="#l1.48"></a><span id="l1.48">       target instanceof HTMLLinkElement) {</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineminus">-    if (target.hasAttribute(&quot;href&quot;))</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineplus">+    if (target.hasAttribute(&quot;href&quot;)) {</span>
<a href="#l1.51"></a><span id="l1.51">       href = target.href;</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineminus">-  } else if (target instanceof HTMLImageElement &amp;&amp;</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineminus">-             target.hasAttribute(&quot;overflowing&quot;)) {</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineminus">-    // Return if an image is zoomed, otherwise fall through to see if it has</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineminus">-    // a link node.</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineminus">-    return href;</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineplus">+      linkText = gatherTextUnder(target);</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineplus">+    }</span>
<a href="#l1.59"></a><span id="l1.59">   } else if (!aDontCheckInputElement &amp;&amp; ((target instanceof HTMLInputElement) ||</span>
<a href="#l1.60"></a><span id="l1.60">                                          (target instanceof HTMLButtonElement))) {</span>
<a href="#l1.61"></a><span id="l1.61">     if (target.form &amp;&amp; target.form.action)</span>
<a href="#l1.62"></a><span id="l1.62">       href = target.form.action;</span>
<a href="#l1.63"></a><span id="l1.63">   } else {</span>
<a href="#l1.64"></a><span id="l1.64">     // We may be nested inside of a link node.</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineminus">-    var linkNode = aEvent.originalTarget;</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineminus">-    while (linkNode &amp;&amp; !(linkNode instanceof HTMLAnchorElement))</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineplus">+    let linkNode = aEvent.originalTarget;</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineplus">+    while (linkNode &amp;&amp; !(linkNode instanceof HTMLAnchorElement)) {</span>
<a href="#l1.69"></a><span id="l1.69">       linkNode = linkNode.parentNode;</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineplus">+    }</span>
<a href="#l1.71"></a><span id="l1.71"> </span>
<a href="#l1.72"></a><span id="l1.72" class="difflineminus">-    if (linkNode)</span>
<a href="#l1.73"></a><span id="l1.73" class="difflineplus">+    if (linkNode) {</span>
<a href="#l1.74"></a><span id="l1.74">       href = linkNode.href;</span>
<a href="#l1.75"></a><span id="l1.75" class="difflineplus">+      linkText = gatherTextUnder(linkNode);</span>
<a href="#l1.76"></a><span id="l1.76" class="difflineplus">+    }</span>
<a href="#l1.77"></a><span id="l1.77">   }</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineminus">-</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineminus">-  return href;</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineplus">+  return [href, linkText];</span>
<a href="#l1.81"></a><span id="l1.81"> }</span>
<a href="#l1.82"></a><span id="l1.82"> </span>
<a href="#l1.83"></a><span id="l1.83"> function messagePaneOnResize(aEvent) {</span>
<a href="#l1.84"></a><span id="l1.84">   // Scale any overflowing images, exclude http content.</span>
<a href="#l1.85"></a><span id="l1.85">   let browser = getBrowser();</span>
<a href="#l1.86"></a><span id="l1.86">   let doc = browser &amp;&amp; browser.contentDocument ? browser.contentDocument : null;</span>
<a href="#l1.87"></a><span id="l1.87">   if (!doc || doc.URL.startsWith(&quot;http&quot;) || !doc.images)</span>
<a href="#l1.88"></a><span id="l1.88">     return;</span>
<a href="#l1.89"></a><span id="l1.89" class="difflineat">@@ -102,17 +106,17 @@ function contentAreaClick(aEvent) {</span>
<a href="#l1.90"></a><span id="l1.90">   let target = aEvent.target;</span>
<a href="#l1.91"></a><span id="l1.91"> </span>
<a href="#l1.92"></a><span id="l1.92">   // If we've loaded a web page url, and the element's or its ancestor's href</span>
<a href="#l1.93"></a><span id="l1.93">   // points to an anchor on the page, let the click go through.</span>
<a href="#l1.94"></a><span id="l1.94">   // Otherwise fall through and open externally.</span>
<a href="#l1.95"></a><span id="l1.95">   if (isLinkToAnchorOnPage(target))</span>
<a href="#l1.96"></a><span id="l1.96">     return true;</span>
<a href="#l1.97"></a><span id="l1.97"> </span>
<a href="#l1.98"></a><span id="l1.98" class="difflineminus">-  let href = hRefForClickEvent(aEvent);</span>
<a href="#l1.99"></a><span id="l1.99" class="difflineplus">+  let [href, linkText] = hRefForClickEvent(aEvent);</span>
<a href="#l1.100"></a><span id="l1.100"> </span>
<a href="#l1.101"></a><span id="l1.101">   if (!href &amp;&amp; !aEvent.button) {</span>
<a href="#l1.102"></a><span id="l1.102">     // Is this an image that we might want to scale?</span>
<a href="#l1.103"></a><span id="l1.103"> </span>
<a href="#l1.104"></a><span id="l1.104">     if (target instanceof Ci.nsIImageLoadingContent) {</span>
<a href="#l1.105"></a><span id="l1.105">       // Make sure it loaded successfully. No action if not or a broken link.</span>
<a href="#l1.106"></a><span id="l1.106">       var req = target.getRequest(Ci.nsIImageLoadingContent.CURRENT_REQUEST);</span>
<a href="#l1.107"></a><span id="l1.107">       if (!req || req.imageStatus &amp; Ci.imgIRequest.STATUS_ERROR)</span>
<a href="#l1.108"></a><span id="l1.108" class="difflineat">@@ -146,18 +150,26 @@ function contentAreaClick(aEvent) {</span>
<a href="#l1.109"></a><span id="l1.109">       !uri.schemeIs(&quot;http&quot;) &amp;&amp; !uri.schemeIs(&quot;https&quot;))</span>
<a href="#l1.110"></a><span id="l1.110">     return true;</span>
<a href="#l1.111"></a><span id="l1.111"> </span>
<a href="#l1.112"></a><span id="l1.112">   // Now we're here, we know this should be loaded in an external browser, so</span>
<a href="#l1.113"></a><span id="l1.113">   // prevent the default action so we don't try and load it here.</span>
<a href="#l1.114"></a><span id="l1.114">   aEvent.preventDefault();</span>
<a href="#l1.115"></a><span id="l1.115"> </span>
<a href="#l1.116"></a><span id="l1.116">   // Let the phishing detector check the link.</span>
<a href="#l1.117"></a><span id="l1.117" class="difflineminus">-  if (!gPhishingDetector.warnOnSuspiciousLinkClick(href))</span>
<a href="#l1.118"></a><span id="l1.118" class="difflineminus">-    return false;</span>
<a href="#l1.119"></a><span id="l1.119" class="difflineplus">+  let urlPhishCheckResult = gPhishingDetector.warnOnSuspiciousLinkClick(href, linkText);</span>
<a href="#l1.120"></a><span id="l1.120" class="difflineplus">+  if (urlPhishCheckResult === 1) {</span>
<a href="#l1.121"></a><span id="l1.121" class="difflineplus">+    return false; // Block request</span>
<a href="#l1.122"></a><span id="l1.122" class="difflineplus">+  }</span>
<a href="#l1.123"></a><span id="l1.123" class="difflineplus">+</span>
<a href="#l1.124"></a><span id="l1.124" class="difflineplus">+  if (urlPhishCheckResult === 0) {</span>
<a href="#l1.125"></a><span id="l1.125" class="difflineplus">+    // Use linkText instead.</span>
<a href="#l1.126"></a><span id="l1.126" class="difflineplus">+    openLinkExternally(linkText);</span>
<a href="#l1.127"></a><span id="l1.127" class="difflineplus">+    return true;</span>
<a href="#l1.128"></a><span id="l1.128" class="difflineplus">+  }</span>
<a href="#l1.129"></a><span id="l1.129"> </span>
<a href="#l1.130"></a><span id="l1.130">   openLinkExternally(href);</span>
<a href="#l1.131"></a><span id="l1.131">   return true;</span>
<a href="#l1.132"></a><span id="l1.132"> }</span>
<a href="#l1.133"></a><span id="l1.133"> </span>
<a href="#l1.134"></a><span id="l1.134"> /**</span>
<a href="#l1.135"></a><span id="l1.135">  * Forces a url to open in an external application according to the protocol</span>
<a href="#l1.136"></a><span id="l1.136">  * service settings.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/base/content/mailWindowOverlay.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/base/content/mailWindowOverlay.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -2536,17 +2536,17 @@ function SpaceHit(event) {</span>
<a href="#l2.4"></a><span id="l2.4">   if (!gMessageDisplay.singleMessageDisplay) {</span>
<a href="#l2.5"></a><span id="l2.5">     contentWindow = document.getElementById(&quot;multimessage&quot;).contentWindow;</span>
<a href="#l2.6"></a><span id="l2.6">   } else if (contentWindow.top == window) {</span>
<a href="#l2.7"></a><span id="l2.7">     // These elements should always take priority over scrolling.</span>
<a href="#l2.8"></a><span id="l2.8">     const importantElements = [&quot;otherActionsButton&quot;, &quot;attachmentToggle&quot;];</span>
<a href="#l2.9"></a><span id="l2.9">     contentWindow = window.content;</span>
<a href="#l2.10"></a><span id="l2.10">     if (focusedElement &amp;&amp; importantElements.includes(focusedElement.id))</span>
<a href="#l2.11"></a><span id="l2.11">       return;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-  } else if (focusedElement &amp;&amp; !hRefForClickEvent(event)) {</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+  } else if (focusedElement &amp;&amp; !hRefForClickEvent(event)[0]) {</span>
<a href="#l2.14"></a><span id="l2.14">     return;</span>
<a href="#l2.15"></a><span id="l2.15">   }</span>
<a href="#l2.16"></a><span id="l2.16"> </span>
<a href="#l2.17"></a><span id="l2.17">   if (!contentWindow)</span>
<a href="#l2.18"></a><span id="l2.18">     return;</span>
<a href="#l2.19"></a><span id="l2.19"> </span>
<a href="#l2.20"></a><span id="l2.20">   var rssiframe = contentWindow.document.getElementById(&quot;_mailrssiframe&quot;);</span>
<a href="#l2.21"></a><span id="l2.21">   // If we are displaying an RSS article, we really want to scroll</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/base/content/phishingDetector.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/base/content/phishingDetector.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -63,52 +63,42 @@ var gPhishingDetector = {</span>
<a href="#l3.4"></a><span id="l3.4">                           Ci.nsMsgFolderFlags.Templates | Ci.nsMsgFolderFlags.Queue;</span>
<a href="#l3.5"></a><span id="l3.5">       if (folder.isSpecialFolder(outgoingFlags, true))</span>
<a href="#l3.6"></a><span id="l3.6">         return;</span>
<a href="#l3.7"></a><span id="l3.7">     } catch (ex) {</span>
<a href="#l3.8"></a><span id="l3.8">         if (ex.result != Cr.NS_ERROR_FAILURE)</span>
<a href="#l3.9"></a><span id="l3.9">           throw ex;</span>
<a href="#l3.10"></a><span id="l3.10">     }</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-    // extract the link nodes in the message and analyze them, looking for suspicious URLs...</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-    var linkNodes = document.getElementById(&quot;messagepane&quot;).contentDocument.links;</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-    for (var index = 0; index &lt; linkNodes.length; index++)</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-      this.analyzeUrl(linkNodes[index].href, gatherTextUnder(linkNodes[index]));</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineminus">-</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineminus">-    // extract the action urls associated with any form elements in the message and analyze them.</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+    // If the message contains forms with action attributes, warn the user.</span>
<a href="#l3.19"></a><span id="l3.19">     let formNodes = document.getElementById(&quot;messagepane&quot;).contentDocument.querySelectorAll(&quot;form[action]&quot;);</span>
<a href="#l3.20"></a><span id="l3.20"> </span>
<a href="#l3.21"></a><span id="l3.21">     if (this.mDisallowFormActions &amp;&amp; formNodes.length &gt; 0) {</span>
<a href="#l3.22"></a><span id="l3.22">       gMessageNotificationBar.setPhishingMsg();</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineminus">-    } else {</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineminus">-      for (index = 0; index &lt; formNodes.length; index++) {</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineminus">-        this.analyzeUrl(formNodes[index].action);</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineminus">-      }</span>
<a href="#l3.27"></a><span id="l3.27">     }</span>
<a href="#l3.28"></a><span id="l3.28">   },</span>
<a href="#l3.29"></a><span id="l3.29"> </span>
<a href="#l3.30"></a><span id="l3.30">   /**</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-   * Analyze the url contained in aLinkNode for phishing attacks. If a phishing URL is found,</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+   * Analyze the url contained in aLinkNode for phishing attacks.</span>
<a href="#l3.33"></a><span id="l3.33">    *</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineminus">-   * @param aHref the url to be analyzed</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineminus">-   * @param aLinkText (optional) user visible link text associated with aHref in case</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineminus">-   *        we are dealing with a link node.</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineminus">-   * @return asynchronously calls gMessageNotificationBar.setPhishingMsg if the link node</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineminus">-   *         contains a phishing URL.</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+   * @param {String} aHref - the url to be analyzed</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+   * @param {String} [aLinkText] - user visible link text associated with aHref</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+   *         in case we are dealing with a link node.</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+   * @return true if link node contains phishing URL. false otherwise.</span>
<a href="#l3.43"></a><span id="l3.43">    */</span>
<a href="#l3.44"></a><span id="l3.44">   analyzeUrl(aUrl, aLinkText) {</span>
<a href="#l3.45"></a><span id="l3.45">     if (!aUrl)</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineminus">-      return;</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+      return false;</span>
<a href="#l3.48"></a><span id="l3.48"> </span>
<a href="#l3.49"></a><span id="l3.49" class="difflineminus">-    var hrefURL;</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+    let hrefURL;</span>
<a href="#l3.51"></a><span id="l3.51">     // make sure relative link urls don't make us bail out</span>
<a href="#l3.52"></a><span id="l3.52">     try {</span>
<a href="#l3.53"></a><span id="l3.53">       hrefURL = Services.io.newURI(aUrl);</span>
<a href="#l3.54"></a><span id="l3.54">     } catch (ex) {</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineminus">-      return;</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineplus">+      return false;</span>
<a href="#l3.57"></a><span id="l3.57">     }</span>
<a href="#l3.58"></a><span id="l3.58"> </span>
<a href="#l3.59"></a><span id="l3.59">     // only check for phishing urls if the url is an http or https link.</span>
<a href="#l3.60"></a><span id="l3.60">     // this prevents us from flagging imap and other internally handled urls</span>
<a href="#l3.61"></a><span id="l3.61">     if (hrefURL.schemeIs(&quot;http&quot;) || hrefURL.schemeIs(&quot;https&quot;)) {</span>
<a href="#l3.62"></a><span id="l3.62">       // The link is not suspicious if the visible text is the same as the URL,</span>
<a href="#l3.63"></a><span id="l3.63">       // even if the URL is an IP address. URLs are commonly surrounded by</span>
<a href="#l3.64"></a><span id="l3.64">       // &lt; &gt; or &quot;&quot; (RFC2396E) - so strip those from the link text before comparing.</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineat">@@ -128,20 +118,25 @@ var gPhishingDetector = {</span>
<a href="#l3.66"></a><span id="l3.66"> </span>
<a href="#l3.67"></a><span id="l3.67">         if (!failsStaticTests &amp;&amp; this.mCheckForMismatchedHosts) {</span>
<a href="#l3.68"></a><span id="l3.68">           failsStaticTests = (aLinkText &amp;&amp;</span>
<a href="#l3.69"></a><span id="l3.69">             this.misMatchedHostWithLinkText(hrefURL, aLinkText));</span>
<a href="#l3.70"></a><span id="l3.70">         }</span>
<a href="#l3.71"></a><span id="l3.71">       }</span>
<a href="#l3.72"></a><span id="l3.72">       // We don't use dynamic checks anymore. The old implementation was removed</span>
<a href="#l3.73"></a><span id="l3.73">       // in bug bug 1085382. Using the toolkit safebrowsing is bug 778611.</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineplus">+      //</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineplus">+      // Because these static link checks tend to cause false positives</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineplus">+      // we delay showing the warning until a user tries to click the link.</span>
<a href="#l3.77"></a><span id="l3.77">       if (failsStaticTests) {</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineminus">-        gMessageNotificationBar.setPhishingMsg();</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineplus">+        return true;</span>
<a href="#l3.80"></a><span id="l3.80">       }</span>
<a href="#l3.81"></a><span id="l3.81">     }</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineplus">+</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineplus">+    return false;</span>
<a href="#l3.84"></a><span id="l3.84">   },</span>
<a href="#l3.85"></a><span id="l3.85"> </span>
<a href="#l3.86"></a><span id="l3.86">   /**</span>
<a href="#l3.87"></a><span id="l3.87">    * Opens the default browser to a page where the user can submit the given url</span>
<a href="#l3.88"></a><span id="l3.88">    * as a phish.</span>
<a href="#l3.89"></a><span id="l3.89">    * @param aPhishingURL the url we want to report back as a phishing attack</span>
<a href="#l3.90"></a><span id="l3.90">    */</span>
<a href="#l3.91"></a><span id="l3.91">    reportPhishingURL(aPhishingURL) {</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineat">@@ -186,47 +181,66 @@ var gPhishingDetector = {</span>
<a href="#l3.93"></a><span id="l3.93">     return false;</span>
<a href="#l3.94"></a><span id="l3.94">   },</span>
<a href="#l3.95"></a><span id="l3.95"> </span>
<a href="#l3.96"></a><span id="l3.96">   /**</span>
<a href="#l3.97"></a><span id="l3.97">    * If the current message has been identified as an email scam, prompts the user with a warning</span>
<a href="#l3.98"></a><span id="l3.98">    * before allowing the link click to be processed. The warning prompt includes the unobscured host name</span>
<a href="#l3.99"></a><span id="l3.99">    * of the http(s) url the user clicked on.</span>
<a href="#l3.100"></a><span id="l3.100">    *</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineminus">-   * @param aUrl the url</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineminus">-   * @return true if the link should be allowed to load</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineplus">+   * @param {String} aUrl - the url</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineplus">+   * @param {String} [aLinkText] - user visible link text associated with the link</span>
<a href="#l3.105"></a><span id="l3.105" class="difflineplus">+   * @return 0 if the URL implied by aLinkText should be used instead.</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineplus">+   *         1 if the request should be blocked.</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineplus">+   *         2 if aUrl should be allowed to load.</span>
<a href="#l3.108"></a><span id="l3.108">    */</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineminus">-  warnOnSuspiciousLinkClick(aUrl) {</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineminus">-    // If the loaded message has *not* been flagged as a scam...</span>
<a href="#l3.111"></a><span id="l3.111" class="difflineminus">-    if (!gMessageNotificationBar.isShowingPhishingNotification())</span>
<a href="#l3.112"></a><span id="l3.112" class="difflineminus">-      return true; // ...allow the link to load.</span>
<a href="#l3.113"></a><span id="l3.113" class="difflineplus">+  warnOnSuspiciousLinkClick(aUrl, aLinkText) {</span>
<a href="#l3.114"></a><span id="l3.114" class="difflineplus">+    let bundle = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l3.115"></a><span id="l3.115" class="difflineplus">+</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineplus">+    // If the message was detected as a scam in the general sense, display a</span>
<a href="#l3.117"></a><span id="l3.117" class="difflineplus">+    // generic warning...</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineplus">+    if (gMessageNotificationBar.isShowingPhishingNotification()) {</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineplus">+      let hrefURL;</span>
<a href="#l3.120"></a><span id="l3.120" class="difflineplus">+      // make sure relative link urls don't make us bail out</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineplus">+      try {</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineplus">+        hrefURL = Services.io.newURI(aUrl);</span>
<a href="#l3.123"></a><span id="l3.123" class="difflineplus">+      } catch (ex) { return 0; }</span>
<a href="#l3.124"></a><span id="l3.124"> </span>
<a href="#l3.125"></a><span id="l3.125" class="difflineminus">-    var hrefURL;</span>
<a href="#l3.126"></a><span id="l3.126" class="difflineminus">-    // make sure relative link urls don't make us bail out</span>
<a href="#l3.127"></a><span id="l3.127" class="difflineminus">-    try {</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineminus">-      hrefURL = Services.io.newURI(aUrl);</span>
<a href="#l3.129"></a><span id="l3.129" class="difflineminus">-    } catch (ex) {</span>
<a href="#l3.130"></a><span id="l3.130" class="difflineminus">-      return false;</span>
<a href="#l3.131"></a><span id="l3.131" class="difflineplus">+      // only prompt for http and https urls</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineplus">+      if (hrefURL.schemeIs(&quot;http&quot;) || hrefURL.schemeIs(&quot;https&quot;)) {</span>
<a href="#l3.133"></a><span id="l3.133" class="difflineplus">+        // unobscure the host name in case it's an encoded ip address..</span>
<a href="#l3.134"></a><span id="l3.134" class="difflineplus">+        let unobscuredHostNameValue = isLegalIPAddress(hrefURL.host, true) || hrefURL.host;</span>
<a href="#l3.135"></a><span id="l3.135" class="difflineplus">+</span>
<a href="#l3.136"></a><span id="l3.136" class="difflineplus">+        let brandShortName = document.getElementById(&quot;bundle_brand&quot;)</span>
<a href="#l3.137"></a><span id="l3.137" class="difflineplus">+                                     .getString(&quot;brandShortName&quot;);</span>
<a href="#l3.138"></a><span id="l3.138" class="difflineplus">+        let titleMsg = bundle.getString(&quot;confirmPhishingTitle&quot;);</span>
<a href="#l3.139"></a><span id="l3.139" class="difflineplus">+        let dialogMsg = bundle.getFormattedString(&quot;confirmPhishingUrl&quot;,</span>
<a href="#l3.140"></a><span id="l3.140" class="difflineplus">+          [brandShortName, unobscuredHostNameValue], 2);</span>
<a href="#l3.141"></a><span id="l3.141" class="difflineplus">+        let warningButtons = Ci.nsIPromptService.STD_YES_NO_BUTTONS + Ci.nsIPromptService.BUTTON_POS_1_DEFAULT;</span>
<a href="#l3.142"></a><span id="l3.142" class="difflineplus">+        return Services.prompt.confirmEx(window, titleMsg, dialogMsg,</span>
<a href="#l3.143"></a><span id="l3.143" class="difflineplus">+                                         warningButtons, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, {});</span>
<a href="#l3.144"></a><span id="l3.144" class="difflineplus">+      }</span>
<a href="#l3.145"></a><span id="l3.145" class="difflineplus">+      return 0; // allow the link to load</span>
<a href="#l3.146"></a><span id="l3.146">     }</span>
<a href="#l3.147"></a><span id="l3.147"> </span>
<a href="#l3.148"></a><span id="l3.148" class="difflineminus">-    // only prompt for http and https urls</span>
<a href="#l3.149"></a><span id="l3.149" class="difflineminus">-    if (hrefURL.schemeIs(&quot;http&quot;) || hrefURL.schemeIs(&quot;https&quot;)) {</span>
<a href="#l3.150"></a><span id="l3.150" class="difflineminus">-      // unobscure the host name in case it's an encoded ip address..</span>
<a href="#l3.151"></a><span id="l3.151" class="difflineminus">-      let unobscuredHostNameValue = isLegalIPAddress(hrefURL.host, true)</span>
<a href="#l3.152"></a><span id="l3.152" class="difflineminus">-        || hrefURL.host;</span>
<a href="#l3.153"></a><span id="l3.153" class="difflineplus">+    // Otherwise, analyze this URL in particular.</span>
<a href="#l3.154"></a><span id="l3.154" class="difflineplus">+    // If the URL is detected as a phishing attempt, display a warning.</span>
<a href="#l3.155"></a><span id="l3.155" class="difflineplus">+    if (this.analyzeUrl(aUrl, aLinkText)) {</span>
<a href="#l3.156"></a><span id="l3.156" class="difflineplus">+      let actualURI = makeURI(aUrl);</span>
<a href="#l3.157"></a><span id="l3.157" class="difflineplus">+      let displayedURI = makeURI(aLinkText);</span>
<a href="#l3.158"></a><span id="l3.158"> </span>
<a href="#l3.159"></a><span id="l3.159" class="difflineminus">-      var brandShortName = document.getElementById(&quot;bundle_brand&quot;)</span>
<a href="#l3.160"></a><span id="l3.160" class="difflineminus">-                                   .getString(&quot;brandShortName&quot;);</span>
<a href="#l3.161"></a><span id="l3.161" class="difflineminus">-      var bundle = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l3.162"></a><span id="l3.162" class="difflineminus">-      var titleMsg = bundle.getString(&quot;confirmPhishingTitle&quot;);</span>
<a href="#l3.163"></a><span id="l3.163" class="difflineminus">-      var dialogMsg = bundle.getFormattedString(&quot;confirmPhishingUrl&quot;,</span>
<a href="#l3.164"></a><span id="l3.164" class="difflineminus">-                        [brandShortName, unobscuredHostNameValue], 2);</span>
<a href="#l3.165"></a><span id="l3.165" class="difflineminus">-</span>
<a href="#l3.166"></a><span id="l3.166" class="difflineminus">-      const nsIPS = Ci.nsIPromptService;</span>
<a href="#l3.167"></a><span id="l3.167" class="difflineminus">-      return !Services.prompt.confirmEx(window, titleMsg, dialogMsg,</span>
<a href="#l3.168"></a><span id="l3.168" class="difflineminus">-                                        nsIPS.STD_YES_NO_BUTTONS +</span>
<a href="#l3.169"></a><span id="l3.169" class="difflineminus">-                                        nsIPS.BUTTON_POS_1_DEFAULT,</span>
<a href="#l3.170"></a><span id="l3.170" class="difflineminus">-                                        &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, {}); /* the yes button is in position 0 */</span>
<a href="#l3.171"></a><span id="l3.171" class="difflineplus">+      let titleMsg = bundle.getString(&quot;linkMismatchTitle&quot;);</span>
<a href="#l3.172"></a><span id="l3.172" class="difflineplus">+      let dialogMsg = bundle.getFormattedString(&quot;confirmPhishingUrlAlternate&quot;,</span>
<a href="#l3.173"></a><span id="l3.173" class="difflineplus">+        [displayedURI.host, actualURI.host], 2);</span>
<a href="#l3.174"></a><span id="l3.174" class="difflineplus">+      let warningButtons = (Ci.nsIPromptService.BUTTON_POS_0) * (Ci.nsIPromptService.BUTTON_TITLE_IS_STRING) +</span>
<a href="#l3.175"></a><span id="l3.175" class="difflineplus">+       (Ci.nsIPromptService.BUTTON_POS_1) * (Ci.nsIPromptService.BUTTON_TITLE_CANCEL) +</span>
<a href="#l3.176"></a><span id="l3.176" class="difflineplus">+       (Ci.nsIPromptService.BUTTON_POS_2) * (Ci.nsIPromptService.BUTTON_TITLE_IS_STRING);</span>
<a href="#l3.177"></a><span id="l3.177" class="difflineplus">+      let button0Text = bundle.getFormattedString(&quot;confirmPhishingGoDirect&quot;,</span>
<a href="#l3.178"></a><span id="l3.178" class="difflineplus">+        [displayedURI.host], 1);</span>
<a href="#l3.179"></a><span id="l3.179" class="difflineplus">+      let button2Text = bundle.getFormattedString(&quot;confirmPhishingGoAhead&quot;,</span>
<a href="#l3.180"></a><span id="l3.180" class="difflineplus">+        [actualURI.host], 1);</span>
<a href="#l3.181"></a><span id="l3.181" class="difflineplus">+      return Services.prompt.confirmEx(window, titleMsg, dialogMsg,</span>
<a href="#l3.182"></a><span id="l3.182" class="difflineplus">+                                       warningButtons,</span>
<a href="#l3.183"></a><span id="l3.183" class="difflineplus">+                                       button0Text, &quot;&quot;, button2Text, &quot;&quot;, {});</span>
<a href="#l3.184"></a><span id="l3.184">     }</span>
<a href="#l3.185"></a><span id="l3.185" class="difflineminus">-</span>
<a href="#l3.186"></a><span id="l3.186" class="difflineminus">-    return true; // allow the link to load</span>
<a href="#l3.187"></a><span id="l3.187" class="difflineplus">+    return 0; // allow the link to load</span>
<a href="#l3.188"></a><span id="l3.188">   },</span>
<a href="#l3.189"></a><span id="l3.189"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/base/content/specialTabs.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/base/content/specialTabs.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -1040,17 +1040,17 @@ var specialTabs = {</span>
<a href="#l4.4"></a><span id="l4.4">    * browser.</span>
<a href="#l4.5"></a><span id="l4.5">    */</span>
<a href="#l4.6"></a><span id="l4.6">   aboutClickHandler(aEvent) {</span>
<a href="#l4.7"></a><span id="l4.7">     // Don't handle events that: a) aren't trusted, b) have already been</span>
<a href="#l4.8"></a><span id="l4.8">     // handled or c) aren't left-click.</span>
<a href="#l4.9"></a><span id="l4.9">     if (!aEvent.isTrusted || aEvent.defaultPrevented || aEvent.button)</span>
<a href="#l4.10"></a><span id="l4.10">       return true;</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-    let href = hRefForClickEvent(aEvent, true);</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+    let href = hRefForClickEvent(aEvent, true)[0];</span>
<a href="#l4.14"></a><span id="l4.14">     if (href) {</span>
<a href="#l4.15"></a><span id="l4.15">       let uri = makeURI(href);</span>
<a href="#l4.16"></a><span id="l4.16">       if (!this._protocolSvc.isExposedProtocol(uri.scheme) ||</span>
<a href="#l4.17"></a><span id="l4.17">           uri.schemeIs(&quot;http&quot;) || uri.schemeIs(&quot;https&quot;)) {</span>
<a href="#l4.18"></a><span id="l4.18">         aEvent.preventDefault();</span>
<a href="#l4.19"></a><span id="l4.19">         openLinkExternally(href);</span>
<a href="#l4.20"></a><span id="l4.20">       }</span>
<a href="#l4.21"></a><span id="l4.21">     }</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineat">@@ -1063,17 +1063,17 @@ var specialTabs = {</span>
<a href="#l4.23"></a><span id="l4.23">    * page.</span>
<a href="#l4.24"></a><span id="l4.24">    */</span>
<a href="#l4.25"></a><span id="l4.25">   defaultClickHandler(aEvent) {</span>
<a href="#l4.26"></a><span id="l4.26">     // Don't handle events that: a) aren't trusted, b) have already been</span>
<a href="#l4.27"></a><span id="l4.27">     // handled or c) aren't left-click.</span>
<a href="#l4.28"></a><span id="l4.28">     if (!aEvent.isTrusted || aEvent.defaultPrevented || aEvent.button)</span>
<a href="#l4.29"></a><span id="l4.29">       return true;</span>
<a href="#l4.30"></a><span id="l4.30"> </span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">-    let href = hRefForClickEvent(aEvent, true);</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+    let href = hRefForClickEvent(aEvent, true)[0];</span>
<a href="#l4.33"></a><span id="l4.33"> </span>
<a href="#l4.34"></a><span id="l4.34">     // We've explicitly allowed http, https and about as additional exposed</span>
<a href="#l4.35"></a><span id="l4.35">     // protocols in our default prefs, so these are the ones we need to check</span>
<a href="#l4.36"></a><span id="l4.36">     // for here.</span>
<a href="#l4.37"></a><span id="l4.37">     if (href) {</span>
<a href="#l4.38"></a><span id="l4.38">       let uri = makeURI(href);</span>
<a href="#l4.39"></a><span id="l4.39">       if (!this._protocolSvc.isExposedProtocol(uri.scheme) ||</span>
<a href="#l4.40"></a><span id="l4.40">           uri.schemeIs(&quot;http&quot;) || uri.schemeIs(&quot;https&quot;) ||</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineat">@@ -1101,17 +1101,17 @@ var specialTabs = {</span>
<a href="#l4.42"></a><span id="l4.42">    *                    clicked on should be loaded within the browser or not.</span>
<a href="#l4.43"></a><span id="l4.43">    */</span>
<a href="#l4.44"></a><span id="l4.44">   siteClickHandler(aEvent, aSiteRegexp) {</span>
<a href="#l4.45"></a><span id="l4.45">     // Don't handle events that: a) aren't trusted, b) have already been</span>
<a href="#l4.46"></a><span id="l4.46">     // handled or c) aren't left-click.</span>
<a href="#l4.47"></a><span id="l4.47">     if (!aEvent.isTrusted || aEvent.defaultPrevented || aEvent.button)</span>
<a href="#l4.48"></a><span id="l4.48">       return true;</span>
<a href="#l4.49"></a><span id="l4.49"> </span>
<a href="#l4.50"></a><span id="l4.50" class="difflineminus">-    let href = hRefForClickEvent(aEvent, true);</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+    let href = hRefForClickEvent(aEvent, true)[0];</span>
<a href="#l4.52"></a><span id="l4.52"> </span>
<a href="#l4.53"></a><span id="l4.53">     // We've explicitly allowed http, https and about as additional exposed</span>
<a href="#l4.54"></a><span id="l4.54">     // protocols in our default prefs, so these are the ones we need to check</span>
<a href="#l4.55"></a><span id="l4.55">     // for here.</span>
<a href="#l4.56"></a><span id="l4.56">     if (href) {</span>
<a href="#l4.57"></a><span id="l4.57">       let uri = makeURI(href);</span>
<a href="#l4.58"></a><span id="l4.58">       if (!this._protocolSvc.isExposedProtocol(uri.scheme) ||</span>
<a href="#l4.59"></a><span id="l4.59">           ((uri.schemeIs(&quot;http&quot;) || uri.schemeIs(&quot;https&quot;) ||</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/components/newmailaccount/content/accountProvisionerTab.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/components/newmailaccount/content/accountProvisionerTab.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -122,17 +122,17 @@ accountProvisionerTabType._setMonitoring</span>
<a href="#l5.4"></a><span id="l5.4">  * their targets set to _blank - these links open in the default browser.</span>
<a href="#l5.5"></a><span id="l5.5">  */</span>
<a href="#l5.6"></a><span id="l5.6"> accountProvisionerTabType.clickHandler = function(aEvent) {</span>
<a href="#l5.7"></a><span id="l5.7">   // Don't handle events that: a) aren't trusted, b) have already been</span>
<a href="#l5.8"></a><span id="l5.8">   // handled or c) aren't left-click.</span>
<a href="#l5.9"></a><span id="l5.9">   if (!aEvent.isTrusted || aEvent.defaultPrevented || aEvent.button)</span>
<a href="#l5.10"></a><span id="l5.10">     return true;</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-  let href = hRefForClickEvent(aEvent, true);</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+  let href = hRefForClickEvent(aEvent, true)[0];</span>
<a href="#l5.14"></a><span id="l5.14"> </span>
<a href="#l5.15"></a><span id="l5.15">   // Check to see if we're set to open the link externally...</span>
<a href="#l5.16"></a><span id="l5.16">   if (aEvent.target.hasAttribute(&quot;target&quot;)) {</span>
<a href="#l5.17"></a><span id="l5.17">     if (aEvent.target.target == &quot;_blank&quot;) {</span>
<a href="#l5.18"></a><span id="l5.18">       aEvent.preventDefault();</span>
<a href="#l5.19"></a><span id="l5.19">       openLinkExternally(href);</span>
<a href="#l5.20"></a><span id="l5.20">     }</span>
<a href="#l5.21"></a><span id="l5.21">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/messenger.properties</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/messenger.properties</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -537,18 +537,25 @@ folderSummarizedSymbolValue=%S</span>
<a href="#l6.4"></a><span id="l6.4"> subfoldersExplanation=%1$S in this folder, %2$S in subfolders</span>
<a href="#l6.5"></a><span id="l6.5"> </span>
<a href="#l6.6"></a><span id="l6.6"> # Error message if message for a message id wasn't found</span>
<a href="#l6.7"></a><span id="l6.7"> errorOpenMessageForMessageIdTitle=Error opening message-id</span>
<a href="#l6.8"></a><span id="l6.8"> errorOpenMessageForMessageIdMessage=Message for message-id %S not found</span>
<a href="#l6.9"></a><span id="l6.9"> </span>
<a href="#l6.10"></a><span id="l6.10"> # Warnings to alert users about phishing urls</span>
<a href="#l6.11"></a><span id="l6.11"> confirmPhishingTitle=Email Scam Alert</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+linkMismatchTitle=Link Mismatch Detected</span>
<a href="#l6.13"></a><span id="l6.13"> #LOCALIZATION NOTE %1$S is the brand name, %2$S is the host name of the url being visited</span>
<a href="#l6.14"></a><span id="l6.14"> confirmPhishingUrl=%1$S thinks this message is a scam. The links in the message may be trying to impersonate web pages you want to visit. Are you sure you want to visit %2$S?</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+#LOCALIZATION NOTE %1$S is the host name of indicated host, %2$S is the host name of the actual host.</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+confirmPhishingUrlAlternate=The link you just clicked seems to lead to another site than what the link text indicated. This is sometimes used for tracking whether you clicked the link, but it could also be a scam.\n\nThe link text indicated that the link would lead to %1$S, but it leads to %2$S.</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+#LOCALIZATION NOTE $1$S is the host name of the indicated host.</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+confirmPhishingGoAhead=Go to %1$S anyway</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+#LOCALIZATION NOTE %1$S is the host name that was displayed to the user.</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+confirmPhishingGoDirect=Go to %1$S</span>
<a href="#l6.21"></a><span id="l6.21"> </span>
<a href="#l6.22"></a><span id="l6.22"> # Check for Updates</span>
<a href="#l6.23"></a><span id="l6.23"> # LOCALIZATION NOTE (updatesItem_*): these are alternative labels for Check for Update item in Help menu.</span>
<a href="#l6.24"></a><span id="l6.24"> # Which one is used depends on Update process state.</span>
<a href="#l6.25"></a><span id="l6.25"> updatesItem_default=Check for Updates</span>
<a href="#l6.26"></a><span id="l6.26"> updatesItem_defaultFallback=Check for Updates</span>
<a href="#l6.27"></a><span id="l6.27"> updatesItem_default.accesskey=C</span>
<a href="#l6.28"></a><span id="l6.28"> updatesItem_downloading=Downloading %S</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/test/mozmill/message-header/evil-attached.eml</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/test/mozmill/message-header/evil-attached.eml</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -13,10 +13,10 @@ See below.</span>
<a href="#l7.4"></a><span id="l7.4"> Content-Type: message/rfc822</span>
<a href="#l7.5"></a><span id="l7.5"> </span>
<a href="#l7.6"></a><span id="l7.6"> Date: Mon, 10 Jan 2011 12:00:00 -0500</span>
<a href="#l7.7"></a><span id="l7.7"> From: phisher@evil.com</span>
<a href="#l7.8"></a><span id="l7.8"> To: user@example.com</span>
<a href="#l7.9"></a><span id="l7.9"> Subject: Please click on this link!</span>
<a href="#l7.10"></a><span id="l7.10"> Content-Type: text/html</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-&lt;a href=&quot;http://www.evil.com/google&quot;&gt;http://www.google.com&lt;/a&gt;</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+&lt;form action=&quot;http://localhost/download-me&quot;&gt;&lt;input&gt;&lt;/form&gt;</span>
<a href="#l7.14"></a><span id="l7.14"> --BOUNDARY--</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mail/test/mozmill/message-header/evil.eml</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mail/test/mozmill/message-header/evil.eml</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -1,7 +1,7 @@</span>
<a href="#l8.4"></a><span id="l8.4"> Date: Mon, 10 Jan 2011 12:00:00 -0500</span>
<a href="#l8.5"></a><span id="l8.5"> From: phisher@evil.com</span>
<a href="#l8.6"></a><span id="l8.6"> To: user@example.com</span>
<a href="#l8.7"></a><span id="l8.7"> Subject: Please click on this link!</span>
<a href="#l8.8"></a><span id="l8.8"> Content-Type: text/html</span>
<a href="#l8.9"></a><span id="l8.9"> </span>
<a href="#l8.10"></a><span id="l8.10" class="difflineminus">-&lt;a href=&quot;http://www.evil.com/google&quot;&gt;http://www.google.com&lt;/a&gt;</span>
<a href="#l8.11"></a><span id="l8.11" class="difflineplus">+&lt;form action=&quot;http://localhost/download-me&quot;&gt;&lt;input&gt;&lt;/form&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mail/test/mozmill/message-header/test-phishing-bar.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mail/test/mozmill/message-header/test-phishing-bar.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -1,14 +1,14 @@</span>
<a href="#l9.4"></a><span id="l9.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l9.5"></a><span id="l9.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l9.6"></a><span id="l9.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l9.7"></a><span id="l9.7"> </span>
<a href="#l9.8"></a><span id="l9.8"> /**</span>
<a href="#l9.9"></a><span id="l9.9" class="difflineminus">- * Test that the phishing notification behaves properly.</span>
<a href="#l9.10"></a><span id="l9.10" class="difflineplus">+ * Test that phishing notifications behave properly.</span>
<a href="#l9.11"></a><span id="l9.11">  */</span>
<a href="#l9.12"></a><span id="l9.12"> </span>
<a href="#l9.13"></a><span id="l9.13"> // make SOLO_TEST=message-header/test-phishing-bar.js mozmill-one</span>
<a href="#l9.14"></a><span id="l9.14"> </span>
<a href="#l9.15"></a><span id="l9.15"> &quot;use strict&quot;;</span>
<a href="#l9.16"></a><span id="l9.16"> </span>
<a href="#l9.17"></a><span id="l9.17"> var MODULE_NAME = &quot;test-phishing-bar&quot;;</span>
<a href="#l9.18"></a><span id="l9.18"> </span>
<a href="#l9.19"></a><span id="l9.19" class="difflineat">@@ -25,17 +25,17 @@ var kNotificationValue = &quot;maybeScam&quot;;</span>
<a href="#l9.20"></a><span id="l9.20"> </span>
<a href="#l9.21"></a><span id="l9.21"> function setupModule(module) {</span>
<a href="#l9.22"></a><span id="l9.22">   for (let dep of MODULE_REQUIRES) {</span>
<a href="#l9.23"></a><span id="l9.23">     collector.getModule(dep).installInto(module);</span>
<a href="#l9.24"></a><span id="l9.24">   }</span>
<a href="#l9.25"></a><span id="l9.25"> </span>
<a href="#l9.26"></a><span id="l9.26">   folder = create_folder(&quot;PhishingBarA&quot;);</span>
<a href="#l9.27"></a><span id="l9.27">   add_message_to_folder(folder, create_message({body: {</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineminus">-    body: '&lt;a href=&quot;http://www.evil.com/google/&quot;&gt;http://www.google.com&lt;/a&gt;',</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineplus">+    body: '&lt;form action=&quot;http://localhost/download-me&quot;&gt;&lt;input&gt;&lt;/form&gt;.',</span>
<a href="#l9.30"></a><span id="l9.30">     contentType: &quot;text/html&quot;</span>
<a href="#l9.31"></a><span id="l9.31">   }}));</span>
<a href="#l9.32"></a><span id="l9.32">   add_message_to_folder(folder, create_message());</span>
<a href="#l9.33"></a><span id="l9.33">   add_message_to_folder(folder, create_message({body: {</span>
<a href="#l9.34"></a><span id="l9.34">     body: 'check out http://130.128.4.1. and http://130.128.4.2/.',</span>
<a href="#l9.35"></a><span id="l9.35">     contentType: &quot;text/plain&quot;</span>
<a href="#l9.36"></a><span id="l9.36">   }}));</span>
<a href="#l9.37"></a><span id="l9.37">   add_message_to_folder(folder, create_message({body: {</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineat">@@ -66,16 +66,26 @@ function assert_ignore_works(aController</span>
<a href="#l9.39"></a><span id="l9.39">                                            { popup: &quot;phishingOptions&quot; });</span>
<a href="#l9.40"></a><span id="l9.40">   aController.click(new elementslib.Elem(prefButton));</span>
<a href="#l9.41"></a><span id="l9.41">   aController.click_menus_in_sequence(aController.e(&quot;phishingOptions&quot;),</span>
<a href="#l9.42"></a><span id="l9.42">                                       [{id: &quot;phishingOptionIgnore&quot;}]);</span>
<a href="#l9.43"></a><span id="l9.43">   wait_for_notification_to_stop(aController, kBoxId, kNotificationValue);</span>
<a href="#l9.44"></a><span id="l9.44"> }</span>
<a href="#l9.45"></a><span id="l9.45"> </span>
<a href="#l9.46"></a><span id="l9.46"> /**</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineplus">+ * Helper function to click the first link in a message if one is available.</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineplus">+ */</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineplus">+function click_link_if_available() {</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineplus">+  let msgBody = mc.e(&quot;messagepane&quot;).contentDocument.body;</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineplus">+  if (msgBody.getElementsByTagName(&quot;a&quot;).length &gt; 0) {</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineplus">+    msgBody.getElementsByTagName(&quot;a&quot;)[0].click();</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineplus">+  }</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineplus">+}</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineplus">+</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineplus">+/**</span>
<a href="#l9.57"></a><span id="l9.57">  * Test that when viewing a message, choosing ignore hides the the phishing</span>
<a href="#l9.58"></a><span id="l9.58">  * notification.</span>
<a href="#l9.59"></a><span id="l9.59">  */</span>
<a href="#l9.60"></a><span id="l9.60"> function test_ignore_phishing_warning_from_message() {</span>
<a href="#l9.61"></a><span id="l9.61">   be_in_folder(folder);</span>
<a href="#l9.62"></a><span id="l9.62">   select_click_row(0);</span>
<a href="#l9.63"></a><span id="l9.63">   assert_ignore_works(mc);</span>
<a href="#l9.64"></a><span id="l9.64"> </span>
<a href="#l9.65"></a><span id="l9.65" class="difflineat">@@ -123,46 +133,59 @@ function test_ignore_phishing_warning_fr</span>
<a href="#l9.66"></a><span id="l9.66">   wait_for_notification_to_show(msgc2, kBoxId, kNotificationValue);</span>
<a href="#l9.67"></a><span id="l9.67"> </span>
<a href="#l9.68"></a><span id="l9.68">   close_window(msgc2);</span>
<a href="#l9.69"></a><span id="l9.69">   close_window(msgc);</span>
<a href="#l9.70"></a><span id="l9.70"> }</span>
<a href="#l9.71"></a><span id="l9.71"> </span>
<a href="#l9.72"></a><span id="l9.72"> /**</span>
<a href="#l9.73"></a><span id="l9.73">  * Test that when viewing a message with an auto-linked ip address, we don't</span>
<a href="#l9.74"></a><span id="l9.74" class="difflineminus">- * get a warning. We'll have http://130.128.4.1 vs. http://130.128.4.1/</span>
<a href="#l9.75"></a><span id="l9.75" class="difflineplus">+ * get a warning when clicking the link.</span>
<a href="#l9.76"></a><span id="l9.76" class="difflineplus">+ * We'll have http://130.128.4.1 vs. http://130.128.4.1/</span>
<a href="#l9.77"></a><span id="l9.77">  */</span>
<a href="#l9.78"></a><span id="l9.78"> function test_no_phishing_warning_for_ip_sameish_text() {</span>
<a href="#l9.79"></a><span id="l9.79">   be_in_folder(folder);</span>
<a href="#l9.80"></a><span id="l9.80">   select_click_row(2); // Mail with Public IP address.</span>
<a href="#l9.81"></a><span id="l9.81" class="difflineplus">+  click_link_if_available();</span>
<a href="#l9.82"></a><span id="l9.82">   assert_notification_displayed(mc, kBoxId, kNotificationValue, false); // not shown</span>
<a href="#l9.83"></a><span id="l9.83"> }</span>
<a href="#l9.84"></a><span id="l9.84"> </span>
<a href="#l9.85"></a><span id="l9.85"> /**</span>
<a href="#l9.86"></a><span id="l9.86">  * Test that when viewing a message with a link whose base domain matches but</span>
<a href="#l9.87"></a><span id="l9.87">  * has a different subdomain (e.g. http://subdomain.google.com/ vs</span>
<a href="#l9.88"></a><span id="l9.88" class="difflineminus">- * http://google.com/), we don't get a warning.</span>
<a href="#l9.89"></a><span id="l9.89" class="difflineplus">+ * http://google.com/), we don't get a warning if the link is pressed.</span>
<a href="#l9.90"></a><span id="l9.90">  */</span>
<a href="#l9.91"></a><span id="l9.91"> function test_no_phishing_warning_for_subdomain() {</span>
<a href="#l9.92"></a><span id="l9.92">   be_in_folder(folder);</span>
<a href="#l9.93"></a><span id="l9.93">   select_click_row(3);</span>
<a href="#l9.94"></a><span id="l9.94" class="difflineplus">+  click_link_if_available();</span>
<a href="#l9.95"></a><span id="l9.95">   assert_notification_displayed(mc, kBoxId, kNotificationValue, false); // not shown</span>
<a href="#l9.96"></a><span id="l9.96"> </span>
<a href="#l9.97"></a><span id="l9.97">   select_click_row(4);</span>
<a href="#l9.98"></a><span id="l9.98" class="difflineplus">+  click_link_if_available();</span>
<a href="#l9.99"></a><span id="l9.99">   assert_notification_displayed(mc, kBoxId, kNotificationValue, false); // not shown</span>
<a href="#l9.100"></a><span id="l9.100"> }</span>
<a href="#l9.101"></a><span id="l9.101"> </span>
<a href="#l9.102"></a><span id="l9.102"> /**</span>
<a href="#l9.103"></a><span id="l9.103" class="difflineminus">- * Test that when viewing a message with a link where the text and/or href</span>
<a href="#l9.104"></a><span id="l9.104" class="difflineplus">+ * Test that when clicking a link where the text and/or href</span>
<a href="#l9.105"></a><span id="l9.105">  * has no TLD, we still warn as appropriate.</span>
<a href="#l9.106"></a><span id="l9.106">  */</span>
<a href="#l9.107"></a><span id="l9.107"> function test_phishing_warning_for_local_domain() {</span>
<a href="#l9.108"></a><span id="l9.108">   be_in_folder(folder);</span>
<a href="#l9.109"></a><span id="l9.109">   select_click_row(5);</span>
<a href="#l9.110"></a><span id="l9.110" class="difflineminus">-  assert_notification_displayed(mc, kBoxId, kNotificationValue, true); // shown</span>
<a href="#l9.111"></a><span id="l9.111" class="difflineplus">+</span>
<a href="#l9.112"></a><span id="l9.112" class="difflineplus">+  let dialogAppeared = false;</span>
<a href="#l9.113"></a><span id="l9.113" class="difflineplus">+</span>
<a href="#l9.114"></a><span id="l9.114" class="difflineplus">+  plan_for_modal_dialog(&quot;commonDialog&quot;, function(ctrler) {</span>
<a href="#l9.115"></a><span id="l9.115" class="difflineplus">+    dialogAppeared = true;</span>
<a href="#l9.116"></a><span id="l9.116" class="difflineplus">+  });</span>
<a href="#l9.117"></a><span id="l9.117" class="difflineplus">+</span>
<a href="#l9.118"></a><span id="l9.118" class="difflineplus">+  click_link_if_available();</span>
<a href="#l9.119"></a><span id="l9.119" class="difflineplus">+</span>
<a href="#l9.120"></a><span id="l9.120" class="difflineplus">+  return dialogAppeared;</span>
<a href="#l9.121"></a><span id="l9.121"> }</span>
<a href="#l9.122"></a><span id="l9.122"> </span>
<a href="#l9.123"></a><span id="l9.123"> /**</span>
<a href="#l9.124"></a><span id="l9.124">  * Test that we warn about emails which contain &lt;form&gt;s with action attributes.</span>
<a href="#l9.125"></a><span id="l9.125">  */</span>
<a href="#l9.126"></a><span id="l9.126"> function test_phishing_warning_for_action_form() {</span>
<a href="#l9.127"></a><span id="l9.127">   be_in_folder(folder);</span>
<a href="#l9.128"></a><span id="l9.128">   select_click_row(6);</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

