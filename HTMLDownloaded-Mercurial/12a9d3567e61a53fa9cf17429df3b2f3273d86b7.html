<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 3630:12a9d3567e61a53fa9cf17429df3b2f3273d86b7</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 12a9d3567e61a53fa9cf17429df3b2f3273d86b7" />
<meta property="og:url" content="/comm-central/rev/12a9d3567e61a53fa9cf17429df3b2f3273d86b7" />
<meta property="og:description" content="merge of add-jquery" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 12a9d3567e61a53fa9cf17429df3b2f3273d86b7 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/12a9d3567e61a53fa9cf17429df3b2f3273d86b7">shortlog</a> |
<a href="/comm-central/log/12a9d3567e61a53fa9cf17429df3b2f3273d86b7">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/12a9d3567e61a53fa9cf17429df3b2f3273d86b7">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/12a9d3567e61a53fa9cf17429df3b2f3273d86b7">files</a> |
changeset |
<a href="/comm-central/raw-rev/12a9d3567e61a53fa9cf17429df3b2f3273d86b7">raw</a>  | <a href="/comm-central/archive/12a9d3567e61a53fa9cf17429df3b2f3273d86b7.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
merge of add-jquery
<span class="logtags"><span class="inbranchtag" title="gloda-facet">gloda-facet</span> </span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#68;&#97;&#118;&#105;&#100;&#32;&#65;&#115;&#99;&#104;&#101;&#114;&#32;&#60;&#100;&#97;&#118;&#105;&#100;&#64;&#109;&#111;&#122;&#105;&#108;&#108;&#97;&#109;&#101;&#115;&#115;&#97;&#103;&#105;&#110;&#103;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 01 Sep 2009 18:41:01 -0700</td></tr>
<tr><td>branch</td><td>gloda-facet</td></tr>
<tr>
 <td>changeset 3630</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/12a9d3567e61a53fa9cf17429df3b2f3273d86b7">12a9d3567e61a53fa9cf17429df3b2f3273d86b7</a></td>
</tr>



<tr>
<td>parent 3629</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/3f46a7a6ae24273c0cc6e525433d67f7d4cfd89e">3f46a7a6ae24273c0cc6e525433d67f7d4cfd89e</a> (current diff)
</td>
</tr>
<tr>
<td>parent 3625</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/dd2678994084e8780033d679abdbcdfc70046211">dd2678994084e8780033d679abdbcdfc70046211</a> (<a href="/comm-central/rev/dd2678994084e8780033d679abdbcdfc70046211:12a9d3567e61">diff</a>)
</td>
</tr>

<tr>
<td>child 3631</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/8f8c0454cbb25ed52d336d943e7711f8406bb08e">8f8c0454cbb25ed52d336d943e7711f8406bb08e</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=12a9d3567e61a53fa9cf17429df3b2f3273d86b7">2927</a></td></tr>
<tr><td>push user</td><td>bugmail@asutherland.org</td></tr>
<tr><td>push date</td><td class="date age">Thu, 10 Sep 2009 01:15:56 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@0b161ed73eb6 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=0b161ed73eb66538ade852cb5a4b9b1b2c319a33">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=0b161ed73eb66538ade852cb5a4b9b1b2c319a33&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0b161ed73eb66538ade852cb5a4b9b1b2c319a33&newProject=comm-central&newRevision=b5e0aff84bf4077a47919481912ad0bd11c6a8d8&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0b161ed73eb66538ade852cb5a4b9b1b2c319a33&newProject=comm-central&newRevision=b5e0aff84bf4077a47919481912ad0bd11c6a8d8&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0b161ed73eb66538ade852cb5a4b9b1b2c319a33&newProject=comm-central&newRevision=b5e0aff84bf4077a47919481912ad0bd11c6a8d8&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>






</table></div>

<div class="page_body description">merge of add-jquery</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/12a9d3567e61a53fa9cf17429df3b2f3273d86b7/.hgpatchinfo/gloda-facet.dep">.hgpatchinfo/gloda-facet.dep</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/12a9d3567e61a53fa9cf17429df3b2f3273d86b7/.hgpatchinfo/gloda-facet.dep">file</a> |
<a href="/comm-central/annotate/12a9d3567e61a53fa9cf17429df3b2f3273d86b7/.hgpatchinfo/gloda-facet.dep">annotate</a> |
<a href="/comm-central/diff/12a9d3567e61a53fa9cf17429df3b2f3273d86b7/.hgpatchinfo/gloda-facet.dep">diff</a> |
<a href="/comm-central/comparison/12a9d3567e61a53fa9cf17429df3b2f3273d86b7/.hgpatchinfo/gloda-facet.dep">comparison</a> |
<a href="/comm-central/log/12a9d3567e61a53fa9cf17429df3b2f3273d86b7/.hgpatchinfo/gloda-facet.dep">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/12a9d3567e61a53fa9cf17429df3b2f3273d86b7/mail/base/content/msgMail3PaneWindow.js">mail/base/content/msgMail3PaneWindow.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/12a9d3567e61a53fa9cf17429df3b2f3273d86b7/mail/base/content/msgMail3PaneWindow.js">file</a> |
<a href="/comm-central/annotate/12a9d3567e61a53fa9cf17429df3b2f3273d86b7/mail/base/content/msgMail3PaneWindow.js">annotate</a> |
<a href="/comm-central/diff/12a9d3567e61a53fa9cf17429df3b2f3273d86b7/mail/base/content/msgMail3PaneWindow.js">diff</a> |
<a href="/comm-central/comparison/12a9d3567e61a53fa9cf17429df3b2f3273d86b7/mail/base/content/msgMail3PaneWindow.js">comparison</a> |
<a href="/comm-central/log/12a9d3567e61a53fa9cf17429df3b2f3273d86b7/mail/base/content/msgMail3PaneWindow.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/12a9d3567e61a53fa9cf17429df3b2f3273d86b7/mailnews/db/gloda/modules/indexer.js">mailnews/db/gloda/modules/indexer.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/12a9d3567e61a53fa9cf17429df3b2f3273d86b7/mailnews/db/gloda/modules/indexer.js">file</a> |
<a href="/comm-central/annotate/12a9d3567e61a53fa9cf17429df3b2f3273d86b7/mailnews/db/gloda/modules/indexer.js">annotate</a> |
<a href="/comm-central/diff/12a9d3567e61a53fa9cf17429df3b2f3273d86b7/mailnews/db/gloda/modules/indexer.js">diff</a> |
<a href="/comm-central/comparison/12a9d3567e61a53fa9cf17429df3b2f3273d86b7/mailnews/db/gloda/modules/indexer.js">comparison</a> |
<a href="/comm-central/log/12a9d3567e61a53fa9cf17429df3b2f3273d86b7/mailnews/db/gloda/modules/indexer.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/.hgpatchinfo/add-jquery.dep</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/.hgpatchinfo/add-jquery.dep</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -1,1 +1,1 @@</span>
<a href="#l1.4"></a><span id="l1.4" class="difflineminus">-c6bfb9d50d7ffc546cbbd5b420aa84b06d7b495e</span>
<a href="#l1.5"></a><span id="l1.5">\ No newline at end of file</span>
<a href="#l1.6"></a><span id="l1.6" class="difflineplus">+96b37b501ea5c25ad20e12397bde8bce017f26f5</span>
<a href="#l1.7"></a><span id="l1.7">\ No newline at end of file</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/.hgpatchinfo/add-protovis.dep</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/.hgpatchinfo/add-protovis.dep</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -1,1 +1,1 @@</span>
<a href="#l2.4"></a><span id="l2.4" class="difflineminus">-02903d938d67c49bb1e8dacd634d6a14cc385bbc</span>
<a href="#l2.5"></a><span id="l2.5">\ No newline at end of file</span>
<a href="#l2.6"></a><span id="l2.6" class="difflineplus">+75644ade5a9a533d44e7dca16de13b21f3f70ef6</span>
<a href="#l2.7"></a><span id="l2.7">\ No newline at end of file</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/.hgpatchinfo/gloda-facet.dep</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/.hgpatchinfo/gloda-facet.dep</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -1,1 +1,1 @@</span>
<a href="#l3.4"></a><span id="l3.4" class="difflineminus">-211e1b26229717cb7102594437578442ea80c925</span>
<a href="#l3.5"></a><span id="l3.5">\ No newline at end of file</span>
<a href="#l3.6"></a><span id="l3.6" class="difflineplus">+dd2678994084e8780033d679abdbcdfc70046211</span>
<a href="#l3.7"></a><span id="l3.7">\ No newline at end of file</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/base/content/mailWindowOverlay.xul</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/base/content/mailWindowOverlay.xul</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -532,17 +532,17 @@</span>
<a href="#l4.4"></a><span id="l4.4">     &lt;menuseparator id=&quot;mailContext-sep-open&quot;/&gt;</span>
<a href="#l4.5"></a><span id="l4.5">     &lt;menuitem id=&quot;mailContext-openNewWindow&quot;</span>
<a href="#l4.6"></a><span id="l4.6">               label=&quot;&amp;contextOpenNewWindow.label;&quot;</span>
<a href="#l4.7"></a><span id="l4.7">               accesskey=&quot;&amp;contextOpenNewWindow.accesskey;&quot;</span>
<a href="#l4.8"></a><span id="l4.8">               oncommand=&quot;MsgOpenNewWindowForMessage();&quot;/&gt;</span>
<a href="#l4.9"></a><span id="l4.9">     &lt;menuitem id=&quot;threadPaneContext-openNewTab&quot;</span>
<a href="#l4.10"></a><span id="l4.10">               label=&quot;&amp;contextOpenNewTab.label;&quot;</span>
<a href="#l4.11"></a><span id="l4.11">               accesskey=&quot;&amp;contextOpenNewTab.accesskey;&quot;</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-              oncommand=&quot;ThreadTreeContextMenuNewTab(event);&quot;/&gt;</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+              oncommand=&quot;OpenMessageInNewTab(event);&quot;/&gt;</span>
<a href="#l4.14"></a><span id="l4.14">     &lt;menuseparator id=&quot;mailContext-sep-open2&quot;/&gt;</span>
<a href="#l4.15"></a><span id="l4.15">     &lt;menuitem id=&quot;mailContext-replySender&quot;</span>
<a href="#l4.16"></a><span id="l4.16">               label=&quot;&amp;contextReplySender.label;&quot;</span>
<a href="#l4.17"></a><span id="l4.17">               accesskey=&quot;&amp;contextReplySender.accesskey;&quot;</span>
<a href="#l4.18"></a><span id="l4.18">               oncommand=&quot;MsgReplySender(event);&quot;/&gt;</span>
<a href="#l4.19"></a><span id="l4.19">     &lt;menuitem id=&quot;mailContext-replyNewsgroup&quot;</span>
<a href="#l4.20"></a><span id="l4.20">               label=&quot;&amp;contextReplyNewsgroup.label;&quot;</span>
<a href="#l4.21"></a><span id="l4.21">               accesskey=&quot;&amp;contextReplyNewsgroup.accesskey;&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/base/content/msgHdrViewOverlay.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/base/content/msgHdrViewOverlay.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -252,16 +252,24 @@ function OnLoadMsgHeaderPane()</span>
<a href="#l5.4"></a><span id="l5.4">   // two panels), and then the user upgraded to Tb3, which only has one.</span>
<a href="#l5.5"></a><span id="l5.5">   // Presumably this can also catch cases of extension uninstalls as well.</span>
<a href="#l5.6"></a><span id="l5.6">   let deckElement = document.getElementById('msgHeaderViewDeck')</span>
<a href="#l5.7"></a><span id="l5.7">   if (deckElement.selectedIndex &lt; 0 ||</span>
<a href="#l5.8"></a><span id="l5.8">       deckElement.selectedIndex &gt;= deckElement.childElementCount) {</span>
<a href="#l5.9"></a><span id="l5.9">     deckElement.selectedIndex = 0;</span>
<a href="#l5.10"></a><span id="l5.10">   }</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+  // Only offer openInTab and openInNewWindow if this window supports tabs...</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+  // (i.e. is not a standalone message window), since those actions are likely</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+  // to be significantly less common in that case.</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+  let opensAreHidden = document.getElementById(&quot;tabmail&quot;) ? false : true;</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+  let openInTab = document.getElementById(&quot;otherActionsOpenInNewTab&quot;);</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+  let openInNewWindow = document.getElementById(&quot;otherActionsOpenInNewWindow&quot;);</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+  openInTab.hidden = openInNewWindow.hidden = opensAreHidden;</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+</span>
<a href="#l5.20"></a><span id="l5.20">   // dispatch an event letting any listeners know that we have loaded the message pane</span>
<a href="#l5.21"></a><span id="l5.21">   var event = document.createEvent('Events');</span>
<a href="#l5.22"></a><span id="l5.22">   event.initEvent('messagepane-loaded', false, true);</span>
<a href="#l5.23"></a><span id="l5.23">   var headerViewElement = document.getElementById(&quot;msgHeaderView&quot;);</span>
<a href="#l5.24"></a><span id="l5.24">   headerViewElement.dispatchEvent(event);</span>
<a href="#l5.25"></a><span id="l5.25"> }</span>
<a href="#l5.26"></a><span id="l5.26"> </span>
<a href="#l5.27"></a><span id="l5.27"> function OnUnloadMsgHeaderPane()</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/base/content/msgHdrViewOverlay.xul</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/base/content/msgHdrViewOverlay.xul</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -183,23 +183,36 @@</span>
<a href="#l6.4"></a><span id="l6.4"> </span>
<a href="#l6.5"></a><span id="l6.5">           &lt;!-- perhaps this should be a customizable toolbar too --&gt;</span>
<a href="#l6.6"></a><span id="l6.6">           &lt;vbox id=&quot;otherActionsBox&quot; align=&quot;end&quot;&gt;</span>
<a href="#l6.7"></a><span id="l6.7">             &lt;spacer id=&quot;otherActionsTopSpacer&quot; flex=&quot;1&quot;/&gt;</span>
<a href="#l6.8"></a><span id="l6.8">             &lt;button type=&quot;menu&quot; id=&quot;otherActionsButton&quot;</span>
<a href="#l6.9"></a><span id="l6.9">                     label=&quot;&amp;otherActionsButton.label;&quot;</span>
<a href="#l6.10"></a><span id="l6.10">                     class=&quot;msgHeaderView-button msgHeaderView-flat-button&quot;&gt;</span>
<a href="#l6.11"></a><span id="l6.11">               &lt;menupopup id=&quot;otherActionsPopup&quot;&gt;</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-                &lt;menuitem id=&quot;viewSourceMenuItem&quot;</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+                &lt;menuitem id=&quot;otherActionsOpenInNewWindow&quot;</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+                          label=&quot;&amp;otherActionsOpenInNewWindow.label;&quot;</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+                          accesskey=&quot;&amp;otherActionsOpenInNewWindow.accesskey;&quot;</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+                          oncommand=&quot;MsgOpenNewWindowForMessage();&quot;/&gt;</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+                &lt;menuitem id=&quot;otherActionsOpenInNewTab&quot;</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+                          label=&quot;&amp;otherActionsOpenInNewTab.label;&quot;</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+                          accesskey=&quot;&amp;otherActionsOpenInNewTab.accesskey;&quot;</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+                          oncommand=&quot;OpenMessageInNewTab(event);&quot;/&gt;</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineplus">+                &lt;menuitem id=&quot;viewSourceMenuItem;&quot;</span>
<a href="#l6.22"></a><span id="l6.22">                           label=&quot;&amp;viewSourceMenuItem.label;&quot;</span>
<a href="#l6.23"></a><span id="l6.23">                           accesskey=&quot;&amp;viewSourceMenuItem.accesskey;&quot;</span>
<a href="#l6.24"></a><span id="l6.24">                           oncommand=&quot;ViewPageSource(gFolderDisplay.selectedMessageUris);&quot; /&gt;</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineplus">+                &lt;menuseparator id=&quot;otherActionsSeparator&quot;/&gt;</span>
<a href="#l6.26"></a><span id="l6.26">                 &lt;menuitem id=&quot;saveAsMenuItem&quot; label=&quot;&amp;saveAsMenuItem.label;&quot;</span>
<a href="#l6.27"></a><span id="l6.27">                           accesskey=&quot;&amp;saveAsMenuItem.accesskey;&quot;</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineminus">-                          oncommand=&quot;MsgSaveAsFile();&quot; /&gt;</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineplus">+                          oncommand=&quot;MsgSaveAsFile();&quot;/&gt;</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineplus">+                &lt;menuitem id=&quot;otherActionsPrint&quot;</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+                          label=&quot;&amp;otherActionsPrint.label;&quot;</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+                          accesskey=&quot;&amp;otherActionsPrint.accesskey;&quot;</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+                          oncommand=&quot;PrintEnginePrint();&quot;/&gt;</span>
<a href="#l6.34"></a><span id="l6.34">               &lt;/menupopup&gt;</span>
<a href="#l6.35"></a><span id="l6.35">             &lt;/button&gt;</span>
<a href="#l6.36"></a><span id="l6.36">           &lt;/vbox&gt;</span>
<a href="#l6.37"></a><span id="l6.37">         &lt;/hbox&gt;</span>
<a href="#l6.38"></a><span id="l6.38">       &lt;/vbox&gt;</span>
<a href="#l6.39"></a><span id="l6.39">     &lt;/hbox&gt;</span>
<a href="#l6.40"></a><span id="l6.40">   &lt;/deck&gt;</span>
<a href="#l6.41"></a><span id="l6.41"> &lt;/hbox&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/base/content/msgMail3PaneWindow.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/base/content/msgMail3PaneWindow.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -939,17 +939,17 @@ function FolderPaneOnClick(event)</span>
<a href="#l7.4"></a><span id="l7.4">     }</span>
<a href="#l7.5"></a><span id="l7.5">     else if ((event.originalTarget.localName == &quot;slider&quot;) ||</span>
<a href="#l7.6"></a><span id="l7.6">              (event.originalTarget.localName == &quot;scrollbarbutton&quot;)) {</span>
<a href="#l7.7"></a><span id="l7.7">       event.stopPropagation();</span>
<a href="#l7.8"></a><span id="l7.8">     }</span>
<a href="#l7.9"></a><span id="l7.9">   }</span>
<a href="#l7.10"></a><span id="l7.10"> }</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-function ThreadTreeContextMenuNewTab(event)</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+function OpenMessageInNewTab(event)</span>
<a href="#l7.14"></a><span id="l7.14"> {</span>
<a href="#l7.15"></a><span id="l7.15">   var bgLoad = gPrefBranch.getBoolPref(&quot;mail.tabs.loadInBackground&quot;);</span>
<a href="#l7.16"></a><span id="l7.16">   if (event.shiftKey)</span>
<a href="#l7.17"></a><span id="l7.17">     bgLoad = !bgLoad;</span>
<a href="#l7.18"></a><span id="l7.18"> </span>
<a href="#l7.19"></a><span id="l7.19">   document.getElementById(&quot;tabmail&quot;).openTab(&quot;message&quot;,</span>
<a href="#l7.20"></a><span id="l7.20">       {msgHdr: gFolderDisplay.selectedMessage,</span>
<a href="#l7.21"></a><span id="l7.21">        viewWrapperToClone: gFolderDisplay.view,</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineat">@@ -959,17 +959,17 @@ function ThreadTreeContextMenuNewTab(eve</span>
<a href="#l7.23"></a><span id="l7.23"> function ThreadTreeOnClick(event)</span>
<a href="#l7.24"></a><span id="l7.24"> {</span>
<a href="#l7.25"></a><span id="l7.25">   var threadTree = document.getElementById(&quot;threadTree&quot;);</span>
<a href="#l7.26"></a><span id="l7.26"> </span>
<a href="#l7.27"></a><span id="l7.27">   // Middle click on a message opens the message in a tab</span>
<a href="#l7.28"></a><span id="l7.28">   if (event.button == 1 &amp;&amp; event.originalTarget.localName != &quot;slider&quot; &amp;&amp;</span>
<a href="#l7.29"></a><span id="l7.29">       event.originalTarget.localName != &quot;scrollbarbutton&quot;)</span>
<a href="#l7.30"></a><span id="l7.30">   {</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-    ThreadTreeContextMenuNewTab(event);</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+    OpenMessageInNewTab(event);</span>
<a href="#l7.33"></a><span id="l7.33">     RestoreSelectionWithoutContentLoad(threadTree);</span>
<a href="#l7.34"></a><span id="l7.34">   }</span>
<a href="#l7.35"></a><span id="l7.35"> }</span>
<a href="#l7.36"></a><span id="l7.36"> </span>
<a href="#l7.37"></a><span id="l7.37"> function GetSelectedMsgFolders()</span>
<a href="#l7.38"></a><span id="l7.38"> {</span>
<a href="#l7.39"></a><span id="l7.39">   return gFolderTreeView.getSelectedFolders();</span>
<a href="#l7.40"></a><span id="l7.40"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mail/base/content/specialTabs.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mail/base/content/specialTabs.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -83,55 +83,62 @@ var specialTabs = {</span>
<a href="#l8.4"></a><span id="l8.4">       // to re-use the same tab.</span>
<a href="#l8.5"></a><span id="l8.5">       let regEx = new RegExp(&quot;#.*&quot;);</span>
<a href="#l8.6"></a><span id="l8.6"> </span>
<a href="#l8.7"></a><span id="l8.7">       let contentUrl = aContentPage.replace(regEx, &quot;&quot;);</span>
<a href="#l8.8"></a><span id="l8.8"> </span>
<a href="#l8.9"></a><span id="l8.9">       for (let selectedIndex = 0; selectedIndex &lt; tabInfo.length;</span>
<a href="#l8.10"></a><span id="l8.10">            ++selectedIndex) {</span>
<a href="#l8.11"></a><span id="l8.11">         if (tabInfo[selectedIndex].mode.name == this.name &amp;&amp;</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-            tabInfo[selectedIndex].browser</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-                                  .getAttribute(&quot;src&quot;)</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+            tabInfo[selectedIndex].browser.currentURI.spec</span>
<a href="#l8.15"></a><span id="l8.15">                                   .replace(regEx, &quot;&quot;) == contentUrl) {</span>
<a href="#l8.16"></a><span id="l8.16">           // Ensure we go to the correct location on the page.</span>
<a href="#l8.17"></a><span id="l8.17">           tabInfo[selectedIndex].browser</span>
<a href="#l8.18"></a><span id="l8.18">                                 .setAttribute(&quot;src&quot;, aContentPage);</span>
<a href="#l8.19"></a><span id="l8.19">           return selectedIndex;</span>
<a href="#l8.20"></a><span id="l8.20">         }</span>
<a href="#l8.21"></a><span id="l8.21">       }</span>
<a href="#l8.22"></a><span id="l8.22">       return -1;</span>
<a href="#l8.23"></a><span id="l8.23">     },</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineminus">-    openTab: function onTabOpened(aTab, {contentPage: aContentPage}) {</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineplus">+    openTab: function onTabOpened(aTab, aArgs) {</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineplus">+      if (!&quot;contentPage&quot; in aArgs)</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineplus">+        throw(&quot;contentPage must be specified&quot;);</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineplus">+</span>
<a href="#l8.29"></a><span id="l8.29">       // First clone the page and set up the basics.</span>
<a href="#l8.30"></a><span id="l8.30">       let clone = document.getElementById(&quot;contentTab&quot;).firstChild.cloneNode(true);</span>
<a href="#l8.31"></a><span id="l8.31"> </span>
<a href="#l8.32"></a><span id="l8.32">       clone.setAttribute(&quot;id&quot;, &quot;contentTab&quot; + this.lastBrowserId);</span>
<a href="#l8.33"></a><span id="l8.33">       clone.setAttribute(&quot;collapsed&quot;, false);</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineminus">-      clone.setAttribute(&quot;type&quot;, &quot;content-primary&quot;);</span>
<a href="#l8.35"></a><span id="l8.35"> </span>
<a href="#l8.36"></a><span id="l8.36">       aTab.panel.appendChild(clone);</span>
<a href="#l8.37"></a><span id="l8.37"> </span>
<a href="#l8.38"></a><span id="l8.38">       // Start setting up the browser.</span>
<a href="#l8.39"></a><span id="l8.39">       aTab.browser = aTab.panel.getElementsByTagName(&quot;browser&quot;)[0];</span>
<a href="#l8.40"></a><span id="l8.40"> </span>
<a href="#l8.41"></a><span id="l8.41" class="difflineplus">+      // As we're opening this tab, showTab may not get called, so set</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineplus">+      // the type according to if we're opening in background or not.</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineplus">+      let background = (&quot;background&quot; in aArgs) &amp;&amp; aArgs.background;</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineplus">+      aTab.browser.setAttribute(&quot;type&quot;, background ? &quot;content-targetable&quot; :</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineplus">+                                                     &quot;content-primary&quot;);</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineplus">+</span>
<a href="#l8.47"></a><span id="l8.47">       aTab.browser.setAttribute(&quot;id&quot;, &quot;contentTabBrowser&quot; + this.lastBrowserId);</span>
<a href="#l8.48"></a><span id="l8.48"> </span>
<a href="#l8.49"></a><span id="l8.49">       // Now initialise the find bar.</span>
<a href="#l8.50"></a><span id="l8.50">       aTab.findbar = aTab.panel.getElementsByTagName(&quot;findbar&quot;)[0];</span>
<a href="#l8.51"></a><span id="l8.51">       aTab.findbar.setAttribute(&quot;browserid&quot;,</span>
<a href="#l8.52"></a><span id="l8.52">                                 &quot;contentTabBrowser&quot; + this.lastBrowserId);</span>
<a href="#l8.53"></a><span id="l8.53"> </span>
<a href="#l8.54"></a><span id="l8.54">       // Now set up the listeners.</span>
<a href="#l8.55"></a><span id="l8.55">       this._setUpTitleListener(aTab);</span>
<a href="#l8.56"></a><span id="l8.56">       this._setUpCloseWindowListener(aTab);</span>
<a href="#l8.57"></a><span id="l8.57"> </span>
<a href="#l8.58"></a><span id="l8.58">       // Now start loading the content.</span>
<a href="#l8.59"></a><span id="l8.59">       aTab.title = this.loadingTabString;</span>
<a href="#l8.60"></a><span id="l8.60"> </span>
<a href="#l8.61"></a><span id="l8.61" class="difflineminus">-      aTab.browser.loadURI(aContentPage);</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineplus">+      aTab.browser.loadURI(aArgs.contentPage);</span>
<a href="#l8.63"></a><span id="l8.63"> </span>
<a href="#l8.64"></a><span id="l8.64">       this.lastBrowserId++;</span>
<a href="#l8.65"></a><span id="l8.65">     },</span>
<a href="#l8.66"></a><span id="l8.66">     closeTab: function onTabClosed(aTab) {</span>
<a href="#l8.67"></a><span id="l8.67">       aTab.browser.removeEventListener(&quot;DOMTitleChanged&quot;,</span>
<a href="#l8.68"></a><span id="l8.68">                                        aTab.titleListener, true);</span>
<a href="#l8.69"></a><span id="l8.69">       aTab.browser.removeEventListener(&quot;DOMWindowClose&quot;,</span>
<a href="#l8.70"></a><span id="l8.70">                                        aTab.closeListener, true);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/msgHdrViewOverlay.dtd</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/msgHdrViewOverlay.dtd</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -61,20 +61,26 @@</span>
<a href="#l9.4"></a><span id="l9.4"> &lt;!ENTITY hdrReplyButton.label &quot;reply&quot;&gt;</span>
<a href="#l9.5"></a><span id="l9.5"> &lt;!ENTITY hdrReplyAllButton.label &quot;reply all&quot;&gt;</span>
<a href="#l9.6"></a><span id="l9.6"> &lt;!ENTITY hdrReplyListButton.label &quot;reply list&quot;&gt;</span>
<a href="#l9.7"></a><span id="l9.7"> &lt;!ENTITY hdrForwardButton.label &quot;forward&quot;&gt;</span>
<a href="#l9.8"></a><span id="l9.8"> &lt;!ENTITY hdrJunkButton.label &quot;junk&quot;&gt;</span>
<a href="#l9.9"></a><span id="l9.9"> &lt;!ENTITY trashButton.tooltiptext &quot;delete&quot;&gt;</span>
<a href="#l9.10"></a><span id="l9.10"> </span>
<a href="#l9.11"></a><span id="l9.11"> &lt;!ENTITY otherActionsButton.label &quot;other actions&quot;&gt;</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+&lt;!ENTITY otherActionsOpenInNewWindow.label &quot;open in new window&quot;&gt;</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+&lt;!ENTITY otherActionsOpenInNewWindow.accesskey &quot;w&quot;&gt;</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+&lt;!ENTITY otherActionsOpenInNewTab.label &quot;open in new tab&quot;&gt;</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+&lt;!ENTITY otherActionsOpenInNewTab.accesskey &quot;t&quot;&gt;</span>
<a href="#l9.16"></a><span id="l9.16"> &lt;!ENTITY saveAsMenuItem.label &quot;save as…&quot;&gt;</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineminus">-&lt;!ENTITY saveAsMenuItem.accesskey &quot;S&quot;&gt;</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineminus">-&lt;!ENTITY viewSourceMenuItem.label &quot;view source…&quot;&gt;</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineminus">-&lt;!ENTITY viewSourceMenuItem.accesskey &quot;V&quot;&gt;</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineplus">+&lt;!ENTITY saveAsMenuItem.accesskey &quot;s&quot;&gt;</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineplus">+&lt;!ENTITY viewSourceMenuItem.label &quot;view source&quot;&gt;</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineplus">+&lt;!ENTITY viewSourceMenuItem.accesskey &quot;v&quot;&gt;</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineplus">+&lt;!ENTITY otherActionsPrint.label &quot;print…&quot;&gt;</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineplus">+&lt;!ENTITY otherActionsPrint.accesskey &quot;p&quot;&gt;</span>
<a href="#l9.25"></a><span id="l9.25"> </span>
<a href="#l9.26"></a><span id="l9.26"> &lt;!ENTITY openAttachmentCmd.label    &quot;Open&quot;&gt;</span>
<a href="#l9.27"></a><span id="l9.27"> &lt;!ENTITY openAttachmentCmd.accesskey    &quot;O&quot;&gt;</span>
<a href="#l9.28"></a><span id="l9.28"> &lt;!ENTITY saveAsAttachmentCmd.label    &quot;Save As…&quot;&gt;</span>
<a href="#l9.29"></a><span id="l9.29"> &lt;!ENTITY saveAsAttachmentCmd.accesskey    &quot;A&quot;&gt;</span>
<a href="#l9.30"></a><span id="l9.30"> &lt;!ENTITY detachAttachmentCmd.label    &quot;Detach…&quot;&gt;</span>
<a href="#l9.31"></a><span id="l9.31"> &lt;!ENTITY deleteAttachmentCmd.label    &quot;Delete&quot;&gt;</span>
<a href="#l9.32"></a><span id="l9.32"> &lt;!ENTITY saveAllAttachmentsCmd.label    &quot;Save All…&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1">copy from mail/locales/l10n.ini</span>
<a href="#l10.2"></a><span id="l10.2">copy to mail/locales/l10n-1.9.1.ini</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1">copy from mail/locales/l10n.ini</span>
<a href="#l11.2"></a><span id="l11.2">copy to mail/locales/l10n-central.ini</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineminus">--- a/mail/locales/l10n.ini</span>
<a href="#l11.4"></a><span id="l11.4" class="difflineplus">+++ b/mail/locales/l10n-central.ini</span>
<a href="#l11.5"></a><span id="l11.5" class="difflineat">@@ -12,11 +12,11 @@ dirs = mail</span>
<a href="#l11.6"></a><span id="l11.6"> # RFE: that needs to be supported by compare-locales, too, though</span>
<a href="#l11.7"></a><span id="l11.7"> toolkit = mozilla/toolkit/locales/l10n.ini</span>
<a href="#l11.8"></a><span id="l11.8"> </span>
<a href="#l11.9"></a><span id="l11.9"> [extras]</span>
<a href="#l11.10"></a><span id="l11.10"> dirs = mozilla/extensions/spellcheck</span>
<a href="#l11.11"></a><span id="l11.11"> </span>
<a href="#l11.12"></a><span id="l11.12"> [include_toolkit]</span>
<a href="#l11.13"></a><span id="l11.13"> type = hg</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineminus">-mozilla = releases/mozilla-1.9.1</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+mozilla = mozilla-central</span>
<a href="#l11.16"></a><span id="l11.16"> repo = http://hg.mozilla.org/</span>
<a href="#l11.17"></a><span id="l11.17"> l10n.ini = toolkit/locales/l10n.ini</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1">new file mode 100644</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineminus">--- /dev/null</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineplus">+++ b/mail/test/mozmill/content-tabs/html/whatsnew.html</span>
<a href="#l12.4"></a><span id="l12.4" class="difflineat">@@ -0,0 +1,8 @@</span>
<a href="#l12.5"></a><span id="l12.5" class="difflineplus">+&lt;html&gt;</span>
<a href="#l12.6"></a><span id="l12.6" class="difflineplus">+  &lt;head&gt;</span>
<a href="#l12.7"></a><span id="l12.7" class="difflineplus">+    &lt;title&gt;What's New Content Test&lt;/title&gt; </span>
<a href="#l12.8"></a><span id="l12.8" class="difflineplus">+  &lt;/head&gt;</span>
<a href="#l12.9"></a><span id="l12.9" class="difflineplus">+  &lt;body bgcolor=&quot;#FFFFFF&quot;&gt;</span>
<a href="#l12.10"></a><span id="l12.10" class="difflineplus">+    &lt;h1&gt;What's New Content Test&lt;/h1&gt;</span>
<a href="#l12.11"></a><span id="l12.11" class="difflineplus">+  &lt;/body&gt;</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+&lt;/html&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1">new file mode 100644</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineminus">--- /dev/null</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineplus">+++ b/mail/test/mozmill/content-tabs/test-content-tab.js</span>
<a href="#l13.4"></a><span id="l13.4" class="difflineat">@@ -0,0 +1,115 @@</span>
<a href="#l13.5"></a><span id="l13.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l13.6"></a><span id="l13.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l13.7"></a><span id="l13.7" class="difflineplus">+ *</span>
<a href="#l13.8"></a><span id="l13.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l13.9"></a><span id="l13.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l13.10"></a><span id="l13.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l13.11"></a><span id="l13.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+ *</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineplus">+ * License.</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineplus">+ *</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineplus">+ *</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineplus">+ * Mozilla Messaging.</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineplus">+ *</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineplus">+ *   Mark Banner &lt;mark@standard8.plus.com&gt;</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineplus">+ *</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineplus">+ *</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineplus">+</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineplus">+var MODULE_NAME = 'test-content-tab';</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineplus">+</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineplus">+var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineplus">+var MODULE_REQUIRES = ['window-helpers'];</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineplus">+</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineplus">+var controller = {};</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineplus">+Components.utils.import('resource://mozmill/modules/controller.js', controller)</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineplus">+;</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineplus">+var mozmill = {};</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineplus">+Components.utils.import('resource://mozmill/modules/mozmill.js', mozmill);</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineplus">+var elementslib = {};</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineplus">+Components.utils.import('resource://mozmill/modules/elementslib.js', elementslib);</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineplus">+</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineplus">+var windowHelper;</span>
<a href="#l13.56"></a><span id="l13.56" class="difflineplus">+var mainController = null;</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineplus">+var mc;</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineplus">+</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineplus">+// RELATIVE_ROOT messes with the collector, so we have to bring the path back</span>
<a href="#l13.60"></a><span id="l13.60" class="difflineplus">+// so we get the right path for the resources.</span>
<a href="#l13.61"></a><span id="l13.61" class="difflineplus">+var url = collector.addHttpResource('../content-tabs/html', 'content-tabs');</span>
<a href="#l13.62"></a><span id="l13.62" class="difflineplus">+var whatsUrl = url + &quot;whatsnew.html&quot;;</span>
<a href="#l13.63"></a><span id="l13.63" class="difflineplus">+</span>
<a href="#l13.64"></a><span id="l13.64" class="difflineplus">+var setupModule = function (module) {</span>
<a href="#l13.65"></a><span id="l13.65" class="difflineplus">+  windowHelper = collector.getModule('window-helpers');</span>
<a href="#l13.66"></a><span id="l13.66" class="difflineplus">+  mc = mainController = windowHelper.wait_for_existing_window(&quot;mail:3pane&quot;);</span>
<a href="#l13.67"></a><span id="l13.67" class="difflineplus">+  windowHelper.installInto(module);</span>
<a href="#l13.68"></a><span id="l13.68" class="difflineplus">+  windowHelper.augment_controller(mc);</span>
<a href="#l13.69"></a><span id="l13.69" class="difflineplus">+};</span>
<a href="#l13.70"></a><span id="l13.70" class="difflineplus">+</span>
<a href="#l13.71"></a><span id="l13.71" class="difflineplus">+function test_content_tab_open() {</span>
<a href="#l13.72"></a><span id="l13.72" class="difflineplus">+  let preCount = mc.tabmail.tabContainer.childNodes.length;</span>
<a href="#l13.73"></a><span id="l13.73" class="difflineplus">+</span>
<a href="#l13.74"></a><span id="l13.74" class="difflineplus">+  // Set the pref so that what's new opens a local url</span>
<a href="#l13.75"></a><span id="l13.75" class="difflineplus">+  Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l13.76"></a><span id="l13.76" class="difflineplus">+            .getService(Components.interfaces.nsIPrefBranch)</span>
<a href="#l13.77"></a><span id="l13.77" class="difflineplus">+            .setCharPref(&quot;mailnews.start_page.override_url&quot;,</span>
<a href="#l13.78"></a><span id="l13.78" class="difflineplus">+                         whatsUrl);</span>
<a href="#l13.79"></a><span id="l13.79" class="difflineplus">+</span>
<a href="#l13.80"></a><span id="l13.80" class="difflineplus">+  mc.click(new elementslib.Elem(mc.menus.helpMenu.whatsNew));</span>
<a href="#l13.81"></a><span id="l13.81" class="difflineplus">+</span>
<a href="#l13.82"></a><span id="l13.82" class="difflineplus">+  controller.sleep(0);</span>
<a href="#l13.83"></a><span id="l13.83" class="difflineplus">+  // XXX When bug 508999 is fixed, remove the sleep and use the waitForEval</span>
<a href="#l13.84"></a><span id="l13.84" class="difflineplus">+  // instead.</span>
<a href="#l13.85"></a><span id="l13.85" class="difflineplus">+  // controller.waitForEval(&quot;subject.busy == false&quot;, 1000, 100, newTab);</span>
<a href="#l13.86"></a><span id="l13.86" class="difflineplus">+  controller.sleep(400);</span>
<a href="#l13.87"></a><span id="l13.87" class="difflineplus">+</span>
<a href="#l13.88"></a><span id="l13.88" class="difflineplus">+  if (mc.tabmail.tabContainer.childNodes.length != preCount + 1)</span>
<a href="#l13.89"></a><span id="l13.89" class="difflineplus">+    throw new Error(&quot;The content tab didn't open&quot;);</span>
<a href="#l13.90"></a><span id="l13.90" class="difflineplus">+</span>
<a href="#l13.91"></a><span id="l13.91" class="difflineplus">+  if (mc.tabmail.selectedTab.title != &quot;What's New Content Test&quot;)</span>
<a href="#l13.92"></a><span id="l13.92" class="difflineplus">+    throw new Error(&quot;The content tab has an incorrect title&quot;);</span>
<a href="#l13.93"></a><span id="l13.93" class="difflineplus">+</span>
<a href="#l13.94"></a><span id="l13.94" class="difflineplus">+  // Check that window.content is set up correctly wrt content-primary and</span>
<a href="#l13.95"></a><span id="l13.95" class="difflineplus">+  // content-targetable.</span>
<a href="#l13.96"></a><span id="l13.96" class="difflineplus">+  if (mc.window.content.location != whatsUrl)</span>
<a href="#l13.97"></a><span id="l13.97" class="difflineplus">+    throw new Error(&quot;window.content is not set to the url loaded, incorrect type=\&quot;...\&quot;?&quot;);</span>
<a href="#l13.98"></a><span id="l13.98" class="difflineplus">+}</span>
<a href="#l13.99"></a><span id="l13.99" class="difflineplus">+</span>
<a href="#l13.100"></a><span id="l13.100" class="difflineplus">+function test_content_tab_open_same() {</span>
<a href="#l13.101"></a><span id="l13.101" class="difflineplus">+  let preCount = mc.tabmail.tabContainer.childNodes.length;</span>
<a href="#l13.102"></a><span id="l13.102" class="difflineplus">+</span>
<a href="#l13.103"></a><span id="l13.103" class="difflineplus">+  mc.click(new elementslib.Elem(mc.menus.helpMenu.whatsNew));</span>
<a href="#l13.104"></a><span id="l13.104" class="difflineplus">+</span>
<a href="#l13.105"></a><span id="l13.105" class="difflineplus">+  controller.sleep(0);</span>
<a href="#l13.106"></a><span id="l13.106" class="difflineplus">+</span>
<a href="#l13.107"></a><span id="l13.107" class="difflineplus">+  if (mc.tabmail.tabContainer.childNodes.length != preCount)</span>
<a href="#l13.108"></a><span id="l13.108" class="difflineplus">+    throw new Error(&quot;A new content tab was opened when it shouldn't have been&quot;);</span>
<a href="#l13.109"></a><span id="l13.109" class="difflineplus">+</span>
<a href="#l13.110"></a><span id="l13.110" class="difflineplus">+  // Double-check browser is still the same.</span>
<a href="#l13.111"></a><span id="l13.111" class="difflineplus">+  if (mc.window.content.location != whatsUrl)</span>
<a href="#l13.112"></a><span id="l13.112" class="difflineplus">+    throw new Error(&quot;window.content is not set to the url loaded, incorrect type=\&quot;...\&quot;?&quot;);</span>
<a href="#l13.113"></a><span id="l13.113" class="difflineplus">+}</span>
<a href="#l13.114"></a><span id="l13.114" class="difflineplus">+</span>
<a href="#l13.115"></a><span id="l13.115" class="difflineplus">+// XXX todo</span>
<a href="#l13.116"></a><span id="l13.116" class="difflineplus">+// - Open second tab</span>
<a href="#l13.117"></a><span id="l13.117" class="difflineplus">+// - test find bar</span>
<a href="#l13.118"></a><span id="l13.118" class="difflineplus">+// - window.close within tab</span>
<a href="#l13.119"></a><span id="l13.119" class="difflineplus">+// - zoom?</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mail/test/mozmill/mozmilltests.list</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mail/test/mozmill/mozmilltests.list</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -1,4 +1,5 @@</span>
<a href="#l14.4"></a><span id="l14.4"> folder-display</span>
<a href="#l14.5"></a><span id="l14.5"> junk-commands</span>
<a href="#l14.6"></a><span id="l14.6"> search-window</span>
<a href="#l14.7"></a><span id="l14.7"> content-policy</span>
<a href="#l14.8"></a><span id="l14.8" class="difflineplus">+content-tabs</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/base/content/messengerdnd.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/base/content/messengerdnd.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -62,16 +62,17 @@ function CanDropOnFolderTree(index, orie</span>
<a href="#l15.4"></a><span id="l15.4"> </span>
<a href="#l15.5"></a><span id="l15.5">     var trans = Components.classes[&quot;@mozilla.org/widget/transferable;1&quot;].createInstance(Components.interfaces.nsITransferable);</span>
<a href="#l15.6"></a><span id="l15.6">     if (! trans)</span>
<a href="#l15.7"></a><span id="l15.7">         return false;</span>
<a href="#l15.8"></a><span id="l15.8"> </span>
<a href="#l15.9"></a><span id="l15.9">     trans.addDataFlavor(&quot;text/x-moz-message&quot;);</span>
<a href="#l15.10"></a><span id="l15.10">     trans.addDataFlavor(&quot;text/x-moz-folder&quot;);</span>
<a href="#l15.11"></a><span id="l15.11">     trans.addDataFlavor(&quot;text/x-moz-newsfolder&quot;);</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineplus">+    trans.addDataFlavor(&quot;application/x-moz-file&quot;);</span>
<a href="#l15.13"></a><span id="l15.13">     trans.addDataFlavor(&quot;text/x-moz-url&quot;);</span>
<a href="#l15.14"></a><span id="l15.14">  </span>
<a href="#l15.15"></a><span id="l15.15">     var folderTree = GetFolderTree();</span>
<a href="#l15.16"></a><span id="l15.16">     var targetFolder = GetFolderResource(folderTree, index).QueryInterface(Components.interfaces.nsIMsgFolder);</span>
<a href="#l15.17"></a><span id="l15.17">     var targetUri = targetFolder.URI;</span>
<a href="#l15.18"></a><span id="l15.18">     var targetServer = targetFolder.server;</span>
<a href="#l15.19"></a><span id="l15.19">     var sourceServer, sourceFolder;</span>
<a href="#l15.20"></a><span id="l15.20">    </span>
<a href="#l15.21"></a><span id="l15.21" class="difflineat">@@ -84,16 +85,27 @@ function CanDropOnFolderTree(index, orie</span>
<a href="#l15.22"></a><span id="l15.22">         try</span>
<a href="#l15.23"></a><span id="l15.23">         {</span>
<a href="#l15.24"></a><span id="l15.24">             trans.getAnyTransferData (dataFlavor, dataObj, len );</span>
<a href="#l15.25"></a><span id="l15.25">         }</span>
<a href="#l15.26"></a><span id="l15.26">         catch (ex)</span>
<a href="#l15.27"></a><span id="l15.27">         {</span>
<a href="#l15.28"></a><span id="l15.28">             continue;   //no data so continue;</span>
<a href="#l15.29"></a><span id="l15.29">         }</span>
<a href="#l15.30"></a><span id="l15.30" class="difflineplus">+</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineplus">+        if (dataFlavor.value == &quot;application/x-moz-file&quot; &amp;&amp; dataObj)</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineplus">+        {</span>
<a href="#l15.33"></a><span id="l15.33" class="difflineplus">+          if (orientation != Components.interfaces.nsITreeView.DROP_ON ||</span>
<a href="#l15.34"></a><span id="l15.34" class="difflineplus">+              targetFolder.isServer ||</span>
<a href="#l15.35"></a><span id="l15.35" class="difflineplus">+              !targetFolder.canFileMessages)</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineplus">+            return false;</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineplus">+          if (dataObj.value instanceof Components.interfaces.nsIFile)</span>
<a href="#l15.38"></a><span id="l15.38" class="difflineplus">+            return dataObj.value.isFile();</span>
<a href="#l15.39"></a><span id="l15.39" class="difflineplus">+          return false;</span>
<a href="#l15.40"></a><span id="l15.40" class="difflineplus">+        }</span>
<a href="#l15.41"></a><span id="l15.41">         if (dataObj)</span>
<a href="#l15.42"></a><span id="l15.42">             dataObj = dataObj.value.QueryInterface(Components.interfaces.nsISupportsString);</span>
<a href="#l15.43"></a><span id="l15.43">         if (! dataObj)</span>
<a href="#l15.44"></a><span id="l15.44">             continue;</span>
<a href="#l15.45"></a><span id="l15.45"> </span>
<a href="#l15.46"></a><span id="l15.46">         // pull the URL out of the data object</span>
<a href="#l15.47"></a><span id="l15.47">         var sourceUri = dataObj.data.substring(0, len.value);</span>
<a href="#l15.48"></a><span id="l15.48">         if (! sourceUri)</span>
<a href="#l15.49"></a><span id="l15.49" class="difflineat">@@ -243,32 +255,51 @@ function DropOnFolderTree(row, orientati</span>
<a href="#l15.50"></a><span id="l15.50">     var dragSession = dragService.getCurrentSession();</span>
<a href="#l15.51"></a><span id="l15.51">     if (! dragSession )</span>
<a href="#l15.52"></a><span id="l15.52">         return false;</span>
<a href="#l15.53"></a><span id="l15.53"> </span>
<a href="#l15.54"></a><span id="l15.54">     var trans = Components.classes[&quot;@mozilla.org/widget/transferable;1&quot;].createInstance(Components.interfaces.nsITransferable);</span>
<a href="#l15.55"></a><span id="l15.55">     trans.addDataFlavor(&quot;text/x-moz-message&quot;);</span>
<a href="#l15.56"></a><span id="l15.56">     trans.addDataFlavor(&quot;text/x-moz-folder&quot;);</span>
<a href="#l15.57"></a><span id="l15.57">     trans.addDataFlavor(&quot;text/x-moz-newsfolder&quot;);</span>
<a href="#l15.58"></a><span id="l15.58" class="difflineplus">+    trans.addDataFlavor(&quot;application/x-moz-file&quot;);</span>
<a href="#l15.59"></a><span id="l15.59">     trans.addDataFlavor(&quot;text/x-moz-url&quot;);</span>
<a href="#l15.60"></a><span id="l15.60"> </span>
<a href="#l15.61"></a><span id="l15.61">     var list = Components.classes[&quot;@mozilla.org/array;1&quot;].createInstance(Components.interfaces.nsIMutableArray);</span>
<a href="#l15.62"></a><span id="l15.62" class="difflineplus">+    var cs = Components.classes[&quot;@mozilla.org/messenger/messagecopyservice;1&quot;]</span>
<a href="#l15.63"></a><span id="l15.63" class="difflineplus">+                       .getService(Components.interfaces.nsIMsgCopyService);</span>
<a href="#l15.64"></a><span id="l15.64"> </span>
<a href="#l15.65"></a><span id="l15.65">     var dropMessage;</span>
<a href="#l15.66"></a><span id="l15.66">     var sourceUri;</span>
<a href="#l15.67"></a><span id="l15.67">     var sourceFolder;</span>
<a href="#l15.68"></a><span id="l15.68">     var sourceServer;</span>
<a href="#l15.69"></a><span id="l15.69"> 	</span>
<a href="#l15.70"></a><span id="l15.70">     for (var i = 0; i &lt; dragSession.numDropItems; i++)</span>
<a href="#l15.71"></a><span id="l15.71">     {</span>
<a href="#l15.72"></a><span id="l15.72">         dragSession.getData (trans, i);</span>
<a href="#l15.73"></a><span id="l15.73">         var dataObj = new Object();</span>
<a href="#l15.74"></a><span id="l15.74">         var flavor = new Object();</span>
<a href="#l15.75"></a><span id="l15.75">         var len = new Object();</span>
<a href="#l15.76"></a><span id="l15.76">         trans.getAnyTransferData(flavor, dataObj, len);</span>
<a href="#l15.77"></a><span id="l15.77" class="difflineplus">+        </span>
<a href="#l15.78"></a><span id="l15.78" class="difflineplus">+        // shortcircuit external files and get out</span>
<a href="#l15.79"></a><span id="l15.79" class="difflineplus">+        if (flavor.value == &quot;application/x-moz-file&quot; &amp;&amp; dataObj)</span>
<a href="#l15.80"></a><span id="l15.80" class="difflineplus">+        {</span>
<a href="#l15.81"></a><span id="l15.81" class="difflineplus">+          dataObj = dataObj.value.QueryInterface(Components.interfaces.nsIFile);</span>
<a href="#l15.82"></a><span id="l15.82" class="difflineplus">+          if (!dataObj)</span>
<a href="#l15.83"></a><span id="l15.83" class="difflineplus">+            return false; // don't know how this would ever happen</span>
<a href="#l15.84"></a><span id="l15.84" class="difflineplus">+          if (dataObj.isFile())</span>
<a href="#l15.85"></a><span id="l15.85" class="difflineplus">+          {</span>
<a href="#l15.86"></a><span id="l15.86" class="difflineplus">+            let len = dataObj.leafName.length;</span>
<a href="#l15.87"></a><span id="l15.87" class="difflineplus">+            if (len &gt; 4 &amp;&amp; dataObj.leafName.substr(len - 4).toLowerCase() == &quot;.eml&quot;)</span>
<a href="#l15.88"></a><span id="l15.88" class="difflineplus">+              cs.CopyFileMessage(dataObj, targetFolder, null, false, 1, &quot;&quot;, null, msgWindow);</span>
<a href="#l15.89"></a><span id="l15.89" class="difflineplus">+          }</span>
<a href="#l15.90"></a><span id="l15.90" class="difflineplus">+          continue;</span>
<a href="#l15.91"></a><span id="l15.91" class="difflineplus">+        }</span>
<a href="#l15.92"></a><span id="l15.92" class="difflineplus">+        </span>
<a href="#l15.93"></a><span id="l15.93">         if (dataObj)</span>
<a href="#l15.94"></a><span id="l15.94">             dataObj = dataObj.value.QueryInterface(Components.interfaces.nsISupportsString);</span>
<a href="#l15.95"></a><span id="l15.95">         if (! dataObj)</span>
<a href="#l15.96"></a><span id="l15.96">             continue;</span>
<a href="#l15.97"></a><span id="l15.97"> </span>
<a href="#l15.98"></a><span id="l15.98">         // pull the URL out of the data object</span>
<a href="#l15.99"></a><span id="l15.99">         sourceUri = dataObj.data.substring(0, len.value);</span>
<a href="#l15.100"></a><span id="l15.100">         if (! sourceUri)</span>
<a href="#l15.101"></a><span id="l15.101" class="difflineat">@@ -344,18 +375,16 @@ function DropOnFolderTree(row, orientati</span>
<a href="#l15.102"></a><span id="l15.102">     }</span>
<a href="#l15.103"></a><span id="l15.103"> </span>
<a href="#l15.104"></a><span id="l15.104">     if (list.length &lt; 1)</span>
<a href="#l15.105"></a><span id="l15.105">        return false;</span>
<a href="#l15.106"></a><span id="l15.106"> </span>
<a href="#l15.107"></a><span id="l15.107">     var isSourceNews = false;</span>
<a href="#l15.108"></a><span id="l15.108">     isSourceNews = isNewsURI(sourceUri);</span>
<a href="#l15.109"></a><span id="l15.109"> </span>
<a href="#l15.110"></a><span id="l15.110" class="difflineminus">-    var cs = Components.classes[&quot;@mozilla.org/messenger/messagecopyservice;1&quot;]</span>
<a href="#l15.111"></a><span id="l15.111" class="difflineminus">-                       .getService(Components.interfaces.nsIMsgCopyService);</span>
<a href="#l15.112"></a><span id="l15.112">     if (dropMessage) {</span>
<a href="#l15.113"></a><span id="l15.113">         var sourceMsgHdr = list.queryElementAt(0, Components.interfaces.nsIMsgDBHdr);</span>
<a href="#l15.114"></a><span id="l15.114">         sourceFolder = sourceMsgHdr.folder;</span>
<a href="#l15.115"></a><span id="l15.115">         sourceServer = sourceFolder.server;</span>
<a href="#l15.116"></a><span id="l15.116"> </span>
<a href="#l15.117"></a><span id="l15.117"> </span>
<a href="#l15.118"></a><span id="l15.118">         try {</span>
<a href="#l15.119"></a><span id="l15.119">             if (isSourceNews) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/db/gloda/modules/indexer.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/indexer.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -945,31 +945,28 @@ var GlodaIndexer = {</span>
<a href="#l16.4"></a><span id="l16.4">   /**</span>
<a href="#l16.5"></a><span id="l16.5">    * The iterator we are using to iterate over the headers in</span>
<a href="#l16.6"></a><span id="l16.6">    *  this._indexingDatabase.</span>
<a href="#l16.7"></a><span id="l16.7">    */</span>
<a href="#l16.8"></a><span id="l16.8">   _indexingIterator: null,</span>
<a href="#l16.9"></a><span id="l16.9"> </span>
<a href="#l16.10"></a><span id="l16.10">   /** folder whose entry we are pending on */</span>
<a href="#l16.11"></a><span id="l16.11">   _pendingFolderEntry: null,</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-  /** if we are pending on a folder, do we want an iterator too? */</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineminus">-  _pendingFolderWantsIterator: false,</span>
<a href="#l16.14"></a><span id="l16.14"> </span>
<a href="#l16.15"></a><span id="l16.15">   /**</span>
<a href="#l16.16"></a><span id="l16.16">    * Common logic that we want to deal with the given folder ID.  Besides</span>
<a href="#l16.17"></a><span id="l16.17">    *  cutting down on duplicate code, this ensures that we are listening on</span>
<a href="#l16.18"></a><span id="l16.18">    *  the folder in case it tries to go away when we are using it.</span>
<a href="#l16.19"></a><span id="l16.19">    *</span>
<a href="#l16.20"></a><span id="l16.20">    * @return true when the folder was successfully entered, false when we need</span>
<a href="#l16.21"></a><span id="l16.21">    *     to pend on notification of updating of the folder (due to re-parsing</span>
<a href="#l16.22"></a><span id="l16.22">    *     or what have you).  In the event of an actual problem, an exception</span>
<a href="#l16.23"></a><span id="l16.23">    *     will escape.</span>
<a href="#l16.24"></a><span id="l16.24">    */</span>
<a href="#l16.25"></a><span id="l16.25" class="difflineminus">-  _indexerEnterFolder: function gloda_index_indexerEnterFolder(aFolderID,</span>
<a href="#l16.26"></a><span id="l16.26" class="difflineminus">-                                                               aNeedIterator) {</span>
<a href="#l16.27"></a><span id="l16.27" class="difflineplus">+  _indexerEnterFolder: function gloda_index_indexerEnterFolder(aFolderID) {</span>
<a href="#l16.28"></a><span id="l16.28">     // leave the folder if we haven't explicitly left it.</span>
<a href="#l16.29"></a><span id="l16.29">     if (this._indexingFolder !== null) {</span>
<a href="#l16.30"></a><span id="l16.30">       this._indexerLeaveFolder();</span>
<a href="#l16.31"></a><span id="l16.31">     }</span>
<a href="#l16.32"></a><span id="l16.32"> </span>
<a href="#l16.33"></a><span id="l16.33">     this._indexingGlodaFolder = GlodaDatastore._mapFolderID(aFolderID);</span>
<a href="#l16.34"></a><span id="l16.34">     this._indexingFolder = this._indexingGlodaFolder.getXPCOMFolder(</span>
<a href="#l16.35"></a><span id="l16.35">                              this._indexingGlodaFolder.kActivityIndexing);</span>
<a href="#l16.36"></a><span id="l16.36" class="difflineat">@@ -995,39 +992,36 @@ var GlodaIndexer = {</span>
<a href="#l16.37"></a><span id="l16.37">       //  might get flung around, it won't make it out to us, and will instead</span>
<a href="#l16.38"></a><span id="l16.38">       //  be permuted into an NS_ERROR_NOT_INITIALIZED.)</span>
<a href="#l16.39"></a><span id="l16.39">       catch (e if ((e.result == Cr.NS_ERROR_NOT_INITIALIZED) ||</span>
<a href="#l16.40"></a><span id="l16.40">                    (e.result == NS_MSG_ERROR_FOLDER_SUMMARY_OUT_OF_DATE))) {</span>
<a href="#l16.41"></a><span id="l16.41">         // this means that we need to pend on the update; the listener for</span>
<a href="#l16.42"></a><span id="l16.42">         //  FolderLoaded events will call _indexerCompletePendingFolderEntry.</span>
<a href="#l16.43"></a><span id="l16.43">         this._log.debug(&quot;Pending on folder load...&quot;);</span>
<a href="#l16.44"></a><span id="l16.44">         this._pendingFolderEntry = this._indexingFolder;</span>
<a href="#l16.45"></a><span id="l16.45" class="difflineminus">-        this._pendingFolderWantsIterator = aNeedIterator;</span>
<a href="#l16.46"></a><span id="l16.46">         return this.kWorkAsync;</span>
<a href="#l16.47"></a><span id="l16.47">       }</span>
<a href="#l16.48"></a><span id="l16.48">       // we get an nsIMsgDatabase out of this (unsurprisingly) which</span>
<a href="#l16.49"></a><span id="l16.49">       //  explicitly inherits from nsIDBChangeAnnouncer, which has the</span>
<a href="#l16.50"></a><span id="l16.50">       //  AddListener call we want.</span>
<a href="#l16.51"></a><span id="l16.51">       if (this._indexingDatabase == null)</span>
<a href="#l16.52"></a><span id="l16.52">         this._indexingDatabase = this._indexingFolder.msgDatabase;</span>
<a href="#l16.53"></a><span id="l16.53" class="difflineminus">-      if (aNeedIterator)</span>
<a href="#l16.54"></a><span id="l16.54" class="difflineminus">-        this._indexerGetIterator();</span>
<a href="#l16.55"></a><span id="l16.55">       this._indexingDatabase.AddListener(this._databaseAnnouncerListener);</span>
<a href="#l16.56"></a><span id="l16.56">     }</span>
<a href="#l16.57"></a><span id="l16.57">     catch (ex) {</span>
<a href="#l16.58"></a><span id="l16.58">       this._log.error(&quot;Problem entering folder: &quot; +</span>
<a href="#l16.59"></a><span id="l16.59">                       (this._indexingFolder ?</span>
<a href="#l16.60"></a><span id="l16.60">                          this._indexingFolder.prettiestName : &quot;unknown&quot;) +</span>
<a href="#l16.61"></a><span id="l16.61">                       &quot;, skipping. Error was: &quot; + ex.fileName + &quot;:&quot; +</span>
<a href="#l16.62"></a><span id="l16.62">                       ex.lineNumber + &quot;: &quot; + ex);</span>
<a href="#l16.63"></a><span id="l16.63">       this._indexingGlodaFolder.indexing = false;</span>
<a href="#l16.64"></a><span id="l16.64">       this._indexingFolder = null;</span>
<a href="#l16.65"></a><span id="l16.65">       this._indexingGlodaFolder = null;</span>
<a href="#l16.66"></a><span id="l16.66">       this._indexingDatabase = null;</span>
<a href="#l16.67"></a><span id="l16.67" class="difflineminus">-      this._indexingIterator = null;</span>
<a href="#l16.68"></a><span id="l16.68" class="difflineplus">+      this._indexingEnumerator = null;</span>
<a href="#l16.69"></a><span id="l16.69"> </span>
<a href="#l16.70"></a><span id="l16.70">       // re-throw, we just wanted to make sure this junk is cleaned up and</span>
<a href="#l16.71"></a><span id="l16.71">       //  get localized error logging...</span>
<a href="#l16.72"></a><span id="l16.72">       throw ex;</span>
<a href="#l16.73"></a><span id="l16.73">     }</span>
<a href="#l16.74"></a><span id="l16.74"> </span>
<a href="#l16.75"></a><span id="l16.75">     return this.kWorkSync;</span>
<a href="#l16.76"></a><span id="l16.76">   },</span>
<a href="#l16.77"></a><span id="l16.77" class="difflineat">@@ -1036,48 +1030,125 @@ var GlodaIndexer = {</span>
<a href="#l16.78"></a><span id="l16.78">    * If the folder was still parsing/updating when we tried to enter, then this</span>
<a href="#l16.79"></a><span id="l16.79">    *  handler will get called by the listener who got the FolderLoaded message.</span>
<a href="#l16.80"></a><span id="l16.80">    * All we need to do is get the database reference, register a listener on</span>
<a href="#l16.81"></a><span id="l16.81">    *  the db, and retrieve an iterator if desired.</span>
<a href="#l16.82"></a><span id="l16.82">    */</span>
<a href="#l16.83"></a><span id="l16.83">   _indexerCompletePendingFolderEntry:</span>
<a href="#l16.84"></a><span id="l16.84">       function gloda_indexer_indexerCompletePendingFolderEntry() {</span>
<a href="#l16.85"></a><span id="l16.85">     this._indexingDatabase = this._indexingFolder.msgDatabase;</span>
<a href="#l16.86"></a><span id="l16.86" class="difflineminus">-    if (this._pendingFolderWantsIterator)</span>
<a href="#l16.87"></a><span id="l16.87" class="difflineminus">-      this._indexerGetIterator();</span>
<a href="#l16.88"></a><span id="l16.88">     this._indexingDatabase.AddListener(this._databaseAnnouncerListener);</span>
<a href="#l16.89"></a><span id="l16.89">     this._log.debug(&quot;...Folder Loaded!&quot;);</span>
<a href="#l16.90"></a><span id="l16.90"> </span>
<a href="#l16.91"></a><span id="l16.91">     // the load is no longer pending; we certainly don't want more notifications</span>
<a href="#l16.92"></a><span id="l16.92">     this._pendingFolderEntry = null;</span>
<a href="#l16.93"></a><span id="l16.93">     // indexerEnterFolder returned kWorkAsync, which means we need to notify</span>
<a href="#l16.94"></a><span id="l16.94">     //  the callback driver to get things going again.</span>
<a href="#l16.95"></a><span id="l16.95">     this.callbackDriver();</span>
<a href="#l16.96"></a><span id="l16.96">   },</span>
<a href="#l16.97"></a><span id="l16.97"> </span>
<a href="#l16.98"></a><span id="l16.98" class="difflineminus">-  _indexerGetIterator: function gloda_indexer_indexerGetIterator() {</span>
<a href="#l16.99"></a><span id="l16.99" class="difflineminus">-    this._indexingIterator = fixIterator(</span>
<a href="#l16.100"></a><span id="l16.100" class="difflineminus">-                               this._indexingDatabase.EnumerateMessages(),</span>
<a href="#l16.101"></a><span id="l16.101" class="difflineminus">-                               Ci.nsIMsgDBHdr);</span>
<a href="#l16.102"></a><span id="l16.102" class="difflineplus">+  /**</span>
<a href="#l16.103"></a><span id="l16.103" class="difflineplus">+   *  @param  aGetAll  should we get all messages</span>
<a href="#l16.104"></a><span id="l16.104" class="difflineplus">+   *                    (or only those we need to index)?</span>
<a href="#l16.105"></a><span id="l16.105" class="difflineplus">+   */</span>
<a href="#l16.106"></a><span id="l16.106" class="difflineplus">+  _indexerGetEnumerator: function gloda_indexer_indexerGetEnumerator(aGetAll) {</span>
<a href="#l16.107"></a><span id="l16.107" class="difflineplus">+    if (aGetAll) {</span>
<a href="#l16.108"></a><span id="l16.108" class="difflineplus">+      this._indexingEnumerator = this._indexingDatabase.EnumerateMessages();</span>
<a href="#l16.109"></a><span id="l16.109" class="difflineplus">+    }</span>
<a href="#l16.110"></a><span id="l16.110" class="difflineplus">+</span>
<a href="#l16.111"></a><span id="l16.111" class="difflineplus">+    else {</span>
<a href="#l16.112"></a><span id="l16.112" class="difflineplus">+      // We need to create search terms for messages to index. Messages should</span>
<a href="#l16.113"></a><span id="l16.113" class="difflineplus">+      //  be indexed if they're indexable (local or offline and not expunged)</span>
<a href="#l16.114"></a><span id="l16.114" class="difflineplus">+      //  and either haven't been indexed or are dirty.</span>
<a href="#l16.115"></a><span id="l16.115" class="difflineplus">+      // The basic search expression is:</span>
<a href="#l16.116"></a><span id="l16.116" class="difflineplus">+      //  ((GLODA_MESSAGE_ID_PROPERTY Is 0) || (GLODA_DIRTY_PROPERTY Isnt 0))</span>
<a href="#l16.117"></a><span id="l16.117" class="difflineplus">+      // If the folder !isLocal we add the terms:</span>
<a href="#l16.118"></a><span id="l16.118" class="difflineplus">+      //  &amp;&amp; (Status Is nsMsgMessageFlags.Offline)</span>
<a href="#l16.119"></a><span id="l16.119" class="difflineplus">+      //  &amp;&amp; (Status Isnt nsMsgMessageFlags.Expunged)</span>
<a href="#l16.120"></a><span id="l16.120" class="difflineplus">+</span>
<a href="#l16.121"></a><span id="l16.121" class="difflineplus">+      let searchSession = Cc[&quot;@mozilla.org/messenger/searchSession;1&quot;]</span>
<a href="#l16.122"></a><span id="l16.122" class="difflineplus">+                            .createInstance(Ci.nsIMsgSearchSession);</span>
<a href="#l16.123"></a><span id="l16.123" class="difflineplus">+      let searchTerms = Cc[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l16.124"></a><span id="l16.124" class="difflineplus">+                         .createInstance(Ci.nsIMutableArray);</span>
<a href="#l16.125"></a><span id="l16.125" class="difflineplus">+      let isLocal = this._indexingFolder instanceof Ci.nsIMsgLocalMailFolder;</span>
<a href="#l16.126"></a><span id="l16.126" class="difflineplus">+</span>
<a href="#l16.127"></a><span id="l16.127" class="difflineplus">+      searchSession.addScopeTerm(Ci.nsMsgSearchScope.offlineMail,</span>
<a href="#l16.128"></a><span id="l16.128" class="difflineplus">+                                 this._indexingFolder);</span>
<a href="#l16.129"></a><span id="l16.129" class="difflineplus">+      let nsMsgSearchAttrib = Ci.nsMsgSearchAttrib;</span>
<a href="#l16.130"></a><span id="l16.130" class="difflineplus">+      let nsMsgSearchOp = Ci.nsMsgSearchOp;</span>
<a href="#l16.131"></a><span id="l16.131" class="difflineplus">+</span>
<a href="#l16.132"></a><span id="l16.132" class="difflineplus">+      // first term: (GLODA_MESSAGE_ID_PROPERTY Is 0</span>
<a href="#l16.133"></a><span id="l16.133" class="difflineplus">+      let searchTerm = searchSession.createTerm();</span>
<a href="#l16.134"></a><span id="l16.134" class="difflineplus">+      searchTerm.booleanAnd = false; // actually don't care here</span>
<a href="#l16.135"></a><span id="l16.135" class="difflineplus">+      searchTerm.beginsGrouping = true;</span>
<a href="#l16.136"></a><span id="l16.136" class="difflineplus">+      searchTerm.attrib = nsMsgSearchAttrib.Uint32HdrProperty;</span>
<a href="#l16.137"></a><span id="l16.137" class="difflineplus">+      searchTerm.op = nsMsgSearchOp.Is;</span>
<a href="#l16.138"></a><span id="l16.138" class="difflineplus">+      value = searchTerm.value;</span>
<a href="#l16.139"></a><span id="l16.139" class="difflineplus">+      value.attrib = searchTerm.attrib;</span>
<a href="#l16.140"></a><span id="l16.140" class="difflineplus">+      value.status = 0;</span>
<a href="#l16.141"></a><span id="l16.141" class="difflineplus">+      searchTerm.value = value;</span>
<a href="#l16.142"></a><span id="l16.142" class="difflineplus">+      searchTerm.hdrProperty = GLODA_MESSAGE_ID_PROPERTY;</span>
<a href="#l16.143"></a><span id="l16.143" class="difflineplus">+      searchTerms.appendElement(searchTerm, false);</span>
<a href="#l16.144"></a><span id="l16.144" class="difflineplus">+</span>
<a href="#l16.145"></a><span id="l16.145" class="difflineplus">+      //  second term: || GLODA_DIRTY_PROPERTY Isnt 0 )</span>
<a href="#l16.146"></a><span id="l16.146" class="difflineplus">+      searchTerm = searchSession.createTerm();</span>
<a href="#l16.147"></a><span id="l16.147" class="difflineplus">+      searchTerm.booleanAnd = false;</span>
<a href="#l16.148"></a><span id="l16.148" class="difflineplus">+      searchTerm.endsGrouping = true;</span>
<a href="#l16.149"></a><span id="l16.149" class="difflineplus">+      searchTerm.attrib = nsMsgSearchAttrib.Uint32HdrProperty;</span>
<a href="#l16.150"></a><span id="l16.150" class="difflineplus">+      searchTerm.op = nsMsgSearchOp.Isnt;</span>
<a href="#l16.151"></a><span id="l16.151" class="difflineplus">+      value = searchTerm.value;</span>
<a href="#l16.152"></a><span id="l16.152" class="difflineplus">+      value.attrib = searchTerm.attrib;</span>
<a href="#l16.153"></a><span id="l16.153" class="difflineplus">+      value.status = 0;</span>
<a href="#l16.154"></a><span id="l16.154" class="difflineplus">+      searchTerm.value = value;</span>
<a href="#l16.155"></a><span id="l16.155" class="difflineplus">+      searchTerm.hdrProperty = GLODA_DIRTY_PROPERTY;</span>
<a href="#l16.156"></a><span id="l16.156" class="difflineplus">+      searchTerms.appendElement(searchTerm, false);</span>
<a href="#l16.157"></a><span id="l16.157" class="difflineplus">+</span>
<a href="#l16.158"></a><span id="l16.158" class="difflineplus">+      if (!isLocal)</span>
<a href="#l16.159"></a><span id="l16.159" class="difflineplus">+      {</span>
<a href="#l16.160"></a><span id="l16.160" class="difflineplus">+        //  third term: &amp;&amp; Status Is nsMsgMessageFlags.Offline</span>
<a href="#l16.161"></a><span id="l16.161" class="difflineplus">+        searchTerm = searchSession.createTerm();</span>
<a href="#l16.162"></a><span id="l16.162" class="difflineplus">+        searchTerm.booleanAnd = true;</span>
<a href="#l16.163"></a><span id="l16.163" class="difflineplus">+        searchTerm.attrib = nsMsgSearchAttrib.MsgStatus;</span>
<a href="#l16.164"></a><span id="l16.164" class="difflineplus">+        searchTerm.op = nsMsgSearchOp.Is;</span>
<a href="#l16.165"></a><span id="l16.165" class="difflineplus">+        value = searchTerm.value;</span>
<a href="#l16.166"></a><span id="l16.166" class="difflineplus">+        value.attrib = searchTerm.attrib;</span>
<a href="#l16.167"></a><span id="l16.167" class="difflineplus">+        value.status = Ci.nsMsgMessageFlags.Offline;</span>
<a href="#l16.168"></a><span id="l16.168" class="difflineplus">+        searchTerm.value = value;</span>
<a href="#l16.169"></a><span id="l16.169" class="difflineplus">+        searchTerms.appendElement(searchTerm, false);</span>
<a href="#l16.170"></a><span id="l16.170" class="difflineplus">+</span>
<a href="#l16.171"></a><span id="l16.171" class="difflineplus">+        // fourth term: &amp;&amp; Status Isnt nsMsgMessageFlags.Expunged</span>
<a href="#l16.172"></a><span id="l16.172" class="difflineplus">+        searchTerm = searchSession.createTerm();</span>
<a href="#l16.173"></a><span id="l16.173" class="difflineplus">+        searchTerm.booleanAnd = true;</span>
<a href="#l16.174"></a><span id="l16.174" class="difflineplus">+        searchTerm.attrib = nsMsgSearchAttrib.MsgStatus;</span>
<a href="#l16.175"></a><span id="l16.175" class="difflineplus">+        searchTerm.op = nsMsgSearchOp.Isnt;</span>
<a href="#l16.176"></a><span id="l16.176" class="difflineplus">+        value = searchTerm.value;</span>
<a href="#l16.177"></a><span id="l16.177" class="difflineplus">+        value.attrib = searchTerm.attrib;</span>
<a href="#l16.178"></a><span id="l16.178" class="difflineplus">+        value.status = Ci.nsMsgMessageFlags.Expunged;</span>
<a href="#l16.179"></a><span id="l16.179" class="difflineplus">+        searchTerm.value = value;</span>
<a href="#l16.180"></a><span id="l16.180" class="difflineplus">+        searchTerms.appendElement(searchTerm, false);</span>
<a href="#l16.181"></a><span id="l16.181" class="difflineplus">+      }</span>
<a href="#l16.182"></a><span id="l16.182" class="difflineplus">+</span>
<a href="#l16.183"></a><span id="l16.183" class="difflineplus">+      this._indexingEnumerator = this._indexingDatabase.getFilterEnumerator(searchTerms);</span>
<a href="#l16.184"></a><span id="l16.184" class="difflineplus">+    }</span>
<a href="#l16.185"></a><span id="l16.185">   },</span>
<a href="#l16.186"></a><span id="l16.186"> </span>
<a href="#l16.187"></a><span id="l16.187">   _indexerLeaveFolder: function gloda_index_indexerLeaveFolder(aExpected) {</span>
<a href="#l16.188"></a><span id="l16.188">     if (this._indexingFolder !== null) {</span>
<a href="#l16.189"></a><span id="l16.189">       if (this._indexingDatabase) {</span>
<a href="#l16.190"></a><span id="l16.190">         this._indexingDatabase.Commit(Ci.nsMsgDBCommitType.kLargeCommit);</span>
<a href="#l16.191"></a><span id="l16.191">         // remove our listener!</span>
<a href="#l16.192"></a><span id="l16.192">         this._indexingDatabase.RemoveListener(this._databaseAnnouncerListener);</span>
<a href="#l16.193"></a><span id="l16.193">       }</span>
<a href="#l16.194"></a><span id="l16.194">       // let the gloda folder know we are done indexing</span>
<a href="#l16.195"></a><span id="l16.195">       this._indexingGlodaFolder.indexing = false;</span>
<a href="#l16.196"></a><span id="l16.196">       // null everyone out</span>
<a href="#l16.197"></a><span id="l16.197">       this._indexingFolder = null;</span>
<a href="#l16.198"></a><span id="l16.198">       this._indexingGlodaFolder = null;</span>
<a href="#l16.199"></a><span id="l16.199">       this._indexingDatabase = null;</span>
<a href="#l16.200"></a><span id="l16.200" class="difflineminus">-      this._indexingIterator = null;</span>
<a href="#l16.201"></a><span id="l16.201" class="difflineplus">+      this._indexingEnumerator = null;</span>
<a href="#l16.202"></a><span id="l16.202">     }</span>
<a href="#l16.203"></a><span id="l16.203">   },</span>
<a href="#l16.204"></a><span id="l16.204"> </span>
<a href="#l16.205"></a><span id="l16.205">   /**</span>
<a href="#l16.206"></a><span id="l16.206">    * Event fed to us by our nsIFolderListener when a folder is loaded.  We use</span>
<a href="#l16.207"></a><span id="l16.207">    *  this event to two ends:</span>
<a href="#l16.208"></a><span id="l16.208">    *</span>
<a href="#l16.209"></a><span id="l16.209">    * - Know when a folder we were trying to open to index is actually ready to</span>
<a href="#l16.210"></a><span id="l16.210" class="difflineat">@@ -1646,17 +1717,17 @@ var GlodaIndexer = {</span>
<a href="#l16.211"></a><span id="l16.211">     yield this.kWorkDone;</span>
<a href="#l16.212"></a><span id="l16.212">   },</span>
<a href="#l16.213"></a><span id="l16.213"> </span>
<a href="#l16.214"></a><span id="l16.214">   /**</span>
<a href="#l16.215"></a><span id="l16.215">    * Index the contents of a folder.</span>
<a href="#l16.216"></a><span id="l16.216">    */</span>
<a href="#l16.217"></a><span id="l16.217">   _worker_folderIndex: function gloda_worker_folderIndex(aJob) {</span>
<a href="#l16.218"></a><span id="l16.218">     let logDebug = this._log.level &lt;= Log4Moz.Level.Debug;</span>
<a href="#l16.219"></a><span id="l16.219" class="difflineminus">-    yield this._indexerEnterFolder(aJob.id, true);</span>
<a href="#l16.220"></a><span id="l16.220" class="difflineplus">+    yield this._indexerEnterFolder(aJob.id);</span>
<a href="#l16.221"></a><span id="l16.221"> </span>
<a href="#l16.222"></a><span id="l16.222">     if (!this.shouldIndexFolder(this._indexingFolder))</span>
<a href="#l16.223"></a><span id="l16.223">       yield this.kWorkDone;</span>
<a href="#l16.224"></a><span id="l16.224"> </span>
<a href="#l16.225"></a><span id="l16.225">     // Make sure listeners get notified about this job.</span>
<a href="#l16.226"></a><span id="l16.226">     this._notifyListeners();</span>
<a href="#l16.227"></a><span id="l16.227"> </span>
<a href="#l16.228"></a><span id="l16.228">     // there is of course a cost to all this header investigation even if we</span>
<a href="#l16.229"></a><span id="l16.229" class="difflineat">@@ -1675,98 +1746,81 @@ var GlodaIndexer = {</span>
<a href="#l16.230"></a><span id="l16.230">     //  dirty property.  Once we have done this, we can downgrade the folder's</span>
<a href="#l16.231"></a><span id="l16.231">     //  dirty status to plain dirty.  We do this rather than trying to process</span>
<a href="#l16.232"></a><span id="l16.232">     //  everyone in one go in a filthy context because if we have to terminate</span>
<a href="#l16.233"></a><span id="l16.233">     //  indexing before we quit, we don't want to have to re-index messages next</span>
<a href="#l16.234"></a><span id="l16.234">     //  time.  (This could even lead to never completing indexing in a</span>
<a href="#l16.235"></a><span id="l16.235">     //  pathological situation.)</span>
<a href="#l16.236"></a><span id="l16.236">     let glodaFolder = GlodaDatastore._mapFolder(this._indexingFolder);</span>
<a href="#l16.237"></a><span id="l16.237">     if (glodaFolder.dirtyStatus == glodaFolder.kFolderFilthy) {</span>
<a href="#l16.238"></a><span id="l16.238" class="difflineplus">+      this._indexerGetEnumerator(true);</span>
<a href="#l16.239"></a><span id="l16.239">       let count = 0;</span>
<a href="#l16.240"></a><span id="l16.240" class="difflineminus">-      for (let msgHdr in this._indexingIterator) {</span>
<a href="#l16.241"></a><span id="l16.241" class="difflineplus">+      for (let msgHdr in fixIterator(this._indexingEnumerator,</span>
<a href="#l16.242"></a><span id="l16.242" class="difflineplus">+                                     Ci.nsIMsgDBHdr)) {</span>
<a href="#l16.243"></a><span id="l16.243">         // we still need to avoid locking up the UI, pause periodically...</span>
<a href="#l16.244"></a><span id="l16.244">         if (++count % HEADER_CHECK_BLOCK_SIZE == 0)</span>
<a href="#l16.245"></a><span id="l16.245">           yield this.kWorkSync;</span>
<a href="#l16.246"></a><span id="l16.246"> </span>
<a href="#l16.247"></a><span id="l16.247">         let glodaMessageId = msgHdr.getUint32Property(</span>
<a href="#l16.248"></a><span id="l16.248">           GLODA_MESSAGE_ID_PROPERTY);</span>
<a href="#l16.249"></a><span id="l16.249">         // if it has a gloda message id, we need to mark it filthy</span>
<a href="#l16.250"></a><span id="l16.250">         if (glodaMessageId != 0)</span>
<a href="#l16.251"></a><span id="l16.251">           msgHdr.setUint32Property(GLODA_DIRTY_PROPERTY, this.kMessageFilthy);</span>
<a href="#l16.252"></a><span id="l16.252">         // if it doesn't have a gloda message id, we will definitely index it,</span>
<a href="#l16.253"></a><span id="l16.253">         //  so no action is required.</span>
<a href="#l16.254"></a><span id="l16.254">       }</span>
<a href="#l16.255"></a><span id="l16.255">       // this will automatically persist to the database</span>
<a href="#l16.256"></a><span id="l16.256">       glodaFolder.dirtyStatus = glodaFolder.kFolderDirty;</span>
<a href="#l16.257"></a><span id="l16.257" class="difflineminus">-</span>
<a href="#l16.258"></a><span id="l16.258" class="difflineminus">-      // We used up the iterator, get a new one.</span>
<a href="#l16.259"></a><span id="l16.259" class="difflineminus">-      this._indexerGetIterator();</span>
<a href="#l16.260"></a><span id="l16.260">     }</span>
<a href="#l16.261"></a><span id="l16.261"> </span>
<a href="#l16.262"></a><span id="l16.262" class="difflineminus">-    // Whether or not the given message should be indexed.  Messages should</span>
<a href="#l16.263"></a><span id="l16.263" class="difflineminus">-    // be indexed if they're indexable (local or offline and not expunged)</span>
<a href="#l16.264"></a><span id="l16.264" class="difflineminus">-    // and either haven't been indexed or are dirty.</span>
<a href="#l16.265"></a><span id="l16.265" class="difflineminus">-    let shouldIndexMessage = function(msgHdr) {</span>
<a href="#l16.266"></a><span id="l16.266" class="difflineminus">-      if ((!isLocal &amp;&amp;</span>
<a href="#l16.267"></a><span id="l16.267" class="difflineminus">-           !(msgHdr.flags &amp; Components.interfaces.nsMsgMessageFlags.Offline)) ||</span>
<a href="#l16.268"></a><span id="l16.268" class="difflineminus">-          (msgHdr.flags &amp; Components.interfaces.nsMsgMessageFlags.Expunged))</span>
<a href="#l16.269"></a><span id="l16.269" class="difflineminus">-        return false;</span>
<a href="#l16.270"></a><span id="l16.270" class="difflineminus">-</span>
<a href="#l16.271"></a><span id="l16.271" class="difflineminus">-      // returns 0 when missing, which means this message hasn't been indexed</span>
<a href="#l16.272"></a><span id="l16.272" class="difflineminus">-      if (msgHdr.getUint32Property(GLODA_MESSAGE_ID_PROPERTY) == 0)</span>
<a href="#l16.273"></a><span id="l16.273" class="difflineminus">-        return true;</span>
<a href="#l16.274"></a><span id="l16.274" class="difflineminus">-</span>
<a href="#l16.275"></a><span id="l16.275" class="difflineminus">-      // returns 0 when missing, which means this message is clean</span>
<a href="#l16.276"></a><span id="l16.276" class="difflineminus">-      return (msgHdr.getUint32Property(GLODA_DIRTY_PROPERTY) != 0);</span>
<a href="#l16.277"></a><span id="l16.277" class="difflineminus">-    };</span>
<a href="#l16.278"></a><span id="l16.278" class="difflineminus">-</span>
<a href="#l16.279"></a><span id="l16.279">     // Pass 1: count the number of messages to index.</span>
<a href="#l16.280"></a><span id="l16.280">     //  We do this in order to be able to report to the user what we're doing.</span>
<a href="#l16.281"></a><span id="l16.281" class="difflineminus">-    // To avoid traversing the entire folder again in the second pass, we could</span>
<a href="#l16.282"></a><span id="l16.282" class="difflineminus">-    //  cache headers that need indexing here, which would work fine for sparse</span>
<a href="#l16.283"></a><span id="l16.283" class="difflineminus">-    //  indexing but might eat too much memory for dense indexing.  Perhaps we</span>
<a href="#l16.284"></a><span id="l16.284" class="difflineminus">-    //  could employ a hybrid approach where we cache up to a certain number</span>
<a href="#l16.285"></a><span id="l16.285" class="difflineminus">-    //  of headers before falling back to full traversal in the second pass.</span>
<a href="#l16.286"></a><span id="l16.286">     // TODO: give up after reaching a certain number of messages in folders</span>
<a href="#l16.287"></a><span id="l16.287">     //  with ridiculous numbers of messages and make the interface just say</span>
<a href="#l16.288"></a><span id="l16.288">     //  something like &quot;over N messages to go.&quot;</span>
<a href="#l16.289"></a><span id="l16.289" class="difflineminus">-    let count = 0;</span>
<a href="#l16.290"></a><span id="l16.290" class="difflineplus">+</span>
<a href="#l16.291"></a><span id="l16.291" class="difflineplus">+    this._indexerGetEnumerator(false);</span>
<a href="#l16.292"></a><span id="l16.292">     let numMessagesToIndex = 0;</span>
<a href="#l16.293"></a><span id="l16.293" class="difflineminus">-    for (let msgHdr in this._indexingIterator) {</span>
<a href="#l16.294"></a><span id="l16.294" class="difflineminus">-      // we still need to avoid locking up the UI, pause periodically...</span>
<a href="#l16.295"></a><span id="l16.295" class="difflineminus">-      if (++count % HEADER_CHECK_BLOCK_SIZE == 0)</span>
<a href="#l16.296"></a><span id="l16.296" class="difflineminus">-        yield this.kWorkSync;</span>
<a href="#l16.297"></a><span id="l16.297" class="difflineminus">-</span>
<a href="#l16.298"></a><span id="l16.298" class="difflineminus">-      if (shouldIndexMessage(msgHdr))</span>
<a href="#l16.299"></a><span id="l16.299" class="difflineminus">-        ++numMessagesToIndex;</span>
<a href="#l16.300"></a><span id="l16.300" class="difflineplus">+    let numMessagesOut = {};</span>
<a href="#l16.301"></a><span id="l16.301" class="difflineplus">+    // Keep going until we run out of headers.</span>
<a href="#l16.302"></a><span id="l16.302" class="difflineplus">+    while (this._indexingFolder.msgDatabase.nextMatchingHdrs(</span>
<a href="#l16.303"></a><span id="l16.303" class="difflineplus">+             this._indexingEnumerator,</span>
<a href="#l16.304"></a><span id="l16.304" class="difflineplus">+             HEADER_CHECK_BLOCK_SIZE * 8, // this way is much faster, do more</span>
<a href="#l16.305"></a><span id="l16.305" class="difflineplus">+             0, // moot, we don't return headers</span>
<a href="#l16.306"></a><span id="l16.306" class="difflineplus">+             null, // don't return headers, we just want the count</span>
<a href="#l16.307"></a><span id="l16.307" class="difflineplus">+             numMessagesOut)) {</span>
<a href="#l16.308"></a><span id="l16.308" class="difflineplus">+      numMessagesToIndex += numMessagesOut.value;</span>
<a href="#l16.309"></a><span id="l16.309" class="difflineplus">+      yield this.kWorkSync;</span>
<a href="#l16.310"></a><span id="l16.310">     }</span>
<a href="#l16.311"></a><span id="l16.311" class="difflineplus">+    numMessagesToIndex += numMessagesOut.value;</span>
<a href="#l16.312"></a><span id="l16.312"> </span>
<a href="#l16.313"></a><span id="l16.313">     aJob.goal = numMessagesToIndex;</span>
<a href="#l16.314"></a><span id="l16.314"> </span>
<a href="#l16.315"></a><span id="l16.315">     if (numMessagesToIndex &gt; 0) {</span>
<a href="#l16.316"></a><span id="l16.316">       // We used up the iterator, get a new one.</span>
<a href="#l16.317"></a><span id="l16.317" class="difflineminus">-      this._indexerGetIterator();</span>
<a href="#l16.318"></a><span id="l16.318" class="difflineplus">+      this._indexerGetEnumerator(false);</span>
<a href="#l16.319"></a><span id="l16.319"> </span>
<a href="#l16.320"></a><span id="l16.320">       // Pass 2: index the messages.</span>
<a href="#l16.321"></a><span id="l16.321">       let count = 0;</span>
<a href="#l16.322"></a><span id="l16.322" class="difflineminus">-      for (let msgHdr in this._indexingIterator) {</span>
<a href="#l16.323"></a><span id="l16.323" class="difflineplus">+      for (let msgHdr in fixIterator(this._indexingEnumerator,</span>
<a href="#l16.324"></a><span id="l16.324" class="difflineplus">+                                     Ci.nsIMsgDBHdr)) {</span>
<a href="#l16.325"></a><span id="l16.325">         // per above, we want to periodically release control while doing all</span>
<a href="#l16.326"></a><span id="l16.326">         // this header traversal/investigation.</span>
<a href="#l16.327"></a><span id="l16.327" class="difflineplus">+        // XXX not clear that this is really needed, since search has its own</span>
<a href="#l16.328"></a><span id="l16.328" class="difflineplus">+        // method to yield to UI periodically.</span>
<a href="#l16.329"></a><span id="l16.329">         if (++count % HEADER_CHECK_BLOCK_SIZE == 0)</span>
<a href="#l16.330"></a><span id="l16.330">           yield this.kWorkSync;</span>
<a href="#l16.331"></a><span id="l16.331"> </span>
<a href="#l16.332"></a><span id="l16.332" class="difflineminus">-        if (shouldIndexMessage(msgHdr)) {</span>
<a href="#l16.333"></a><span id="l16.333" class="difflineminus">-          ++aJob.offset;</span>
<a href="#l16.334"></a><span id="l16.334" class="difflineminus">-          if (logDebug)</span>
<a href="#l16.335"></a><span id="l16.335" class="difflineminus">-            this._log.debug(&quot;&gt;&gt;&gt;  _indexMessage&quot;);</span>
<a href="#l16.336"></a><span id="l16.336" class="difflineminus">-          yield this._callbackHandle.pushAndGo(this._indexMessage(msgHdr,</span>
<a href="#l16.337"></a><span id="l16.337" class="difflineminus">-              this._callbackHandle));</span>
<a href="#l16.338"></a><span id="l16.338" class="difflineminus">-          if (logDebug)</span>
<a href="#l16.339"></a><span id="l16.339" class="difflineminus">-            this._log.debug(&quot;&lt;&lt;&lt;  _indexMessage&quot;);</span>
<a href="#l16.340"></a><span id="l16.340" class="difflineminus">-        }</span>
<a href="#l16.341"></a><span id="l16.341" class="difflineplus">+        ++aJob.offset;</span>
<a href="#l16.342"></a><span id="l16.342" class="difflineplus">+        if (logDebug)</span>
<a href="#l16.343"></a><span id="l16.343" class="difflineplus">+          this._log.debug(&quot;&gt;&gt;&gt;  _indexMessage&quot;);</span>
<a href="#l16.344"></a><span id="l16.344" class="difflineplus">+        yield this._callbackHandle.pushAndGo(this._indexMessage(msgHdr,</span>
<a href="#l16.345"></a><span id="l16.345" class="difflineplus">+            this._callbackHandle));</span>
<a href="#l16.346"></a><span id="l16.346" class="difflineplus">+        if (logDebug)</span>
<a href="#l16.347"></a><span id="l16.347" class="difflineplus">+          this._log.debug(&quot;&lt;&lt;&lt;  _indexMessage&quot;);</span>
<a href="#l16.348"></a><span id="l16.348">       }</span>
<a href="#l16.349"></a><span id="l16.349">     }</span>
<a href="#l16.350"></a><span id="l16.350"> </span>
<a href="#l16.351"></a><span id="l16.351">     glodaFolder.dirtyStatus = glodaFolder.kFolderClean;</span>
<a href="#l16.352"></a><span id="l16.352"> </span>
<a href="#l16.353"></a><span id="l16.353">     // by definition, it's not likely we'll visit this folder again anytime soon</span>
<a href="#l16.354"></a><span id="l16.354">     this._indexerLeaveFolder();</span>
<a href="#l16.355"></a><span id="l16.355"> </span>
<a href="#l16.356"></a><span id="l16.356" class="difflineat">@@ -1786,17 +1840,17 @@ var GlodaIndexer = {</span>
<a href="#l16.357"></a><span id="l16.357">     for (; aJob.offset &lt; aJob.items.length; aJob.offset++) {</span>
<a href="#l16.358"></a><span id="l16.358">       let item = aJob.items[aJob.offset];</span>
<a href="#l16.359"></a><span id="l16.359">       // item is either [folder ID, message key] or</span>
<a href="#l16.360"></a><span id="l16.360">       //                [folder ID, message ID]</span>
<a href="#l16.361"></a><span id="l16.361"> </span>
<a href="#l16.362"></a><span id="l16.362">       // get in the folder</span>
<a href="#l16.363"></a><span id="l16.363">       if (!this._indexingGlodaFolder ||</span>
<a href="#l16.364"></a><span id="l16.364">           this._indexingGlodaFolder.id != item[0]) {</span>
<a href="#l16.365"></a><span id="l16.365" class="difflineminus">-        yield this._indexerEnterFolder(item[0], false);</span>
<a href="#l16.366"></a><span id="l16.366" class="difflineplus">+        yield this._indexerEnterFolder(item[0]);</span>
<a href="#l16.367"></a><span id="l16.367"> </span>
<a href="#l16.368"></a><span id="l16.368">         // stay out of folders we should not be in!</span>
<a href="#l16.369"></a><span id="l16.369">         if (!this.shouldIndexFolder(this._indexingFolder))</span>
<a href="#l16.370"></a><span id="l16.370">           continue;</span>
<a href="#l16.371"></a><span id="l16.371"> </span>
<a href="#l16.372"></a><span id="l16.372">         folderIsLocal =</span>
<a href="#l16.373"></a><span id="l16.373">           this._indexingFolder instanceof Ci.nsIMsgLocalMailFolder;</span>
<a href="#l16.374"></a><span id="l16.374">       }</span>
<a href="#l16.375"></a><span id="l16.375" class="difflineat">@@ -2344,16 +2398,18 @@ var GlodaIndexer = {</span>
<a href="#l16.376"></a><span id="l16.376">         this.indexer._indexingJobGoal++;</span>
<a href="#l16.377"></a><span id="l16.377">       }</span>
<a href="#l16.378"></a><span id="l16.378">       // only queue the message if we haven't overflowed our event-driven budget</span>
<a href="#l16.379"></a><span id="l16.379">       if (this.indexer._pendingAddJob.items.length &lt;</span>
<a href="#l16.380"></a><span id="l16.380">           this.indexer._indexMaxEventQueueMessages)</span>
<a href="#l16.381"></a><span id="l16.381">         this.indexer._pendingAddJob.items.push(</span>
<a href="#l16.382"></a><span id="l16.382">           [GlodaDatastore._mapFolder(msgFolder).id,</span>
<a href="#l16.383"></a><span id="l16.383">            aMsgHdr.messageKey]);</span>
<a href="#l16.384"></a><span id="l16.384" class="difflineplus">+      else</span>
<a href="#l16.385"></a><span id="l16.385" class="difflineplus">+        this.indexer.indexingSweepNeeded = true;</span>
<a href="#l16.386"></a><span id="l16.386">       this.indexer.indexing = true;</span>
<a href="#l16.387"></a><span id="l16.387">     },</span>
<a href="#l16.388"></a><span id="l16.388"> </span>
<a href="#l16.389"></a><span id="l16.389">     OnItemAdded: function gloda_indexer_OnItemAdded(aParentItem, aItem) {</span>
<a href="#l16.390"></a><span id="l16.390">     },</span>
<a href="#l16.391"></a><span id="l16.391">     OnItemRemoved: function gloda_indexer_OnItemRemoved(aParentItem, aItem) {</span>
<a href="#l16.392"></a><span id="l16.392">     },</span>
<a href="#l16.393"></a><span id="l16.393">     OnItemPropertyChanged: function gloda_indexer_OnItemPropertyChanged(</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/suite/browser/public/nsIBookmarksService.idl</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/suite/browser/public/nsIBookmarksService.idl</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -38,20 +38,22 @@</span>
<a href="#l17.4"></a><span id="l17.4">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l17.5"></a><span id="l17.5"> </span>
<a href="#l17.6"></a><span id="l17.6"> /**</span>
<a href="#l17.7"></a><span id="l17.7">  * The Browser Bookmarks service</span>
<a href="#l17.8"></a><span id="l17.8">  */</span>
<a href="#l17.9"></a><span id="l17.9"> </span>
<a href="#l17.10"></a><span id="l17.10"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l17.11"></a><span id="l17.11"> </span>
<a href="#l17.12"></a><span id="l17.12" class="difflineplus">+interface nsIRDFNode;</span>
<a href="#l17.13"></a><span id="l17.13"> interface nsIRDFResource;</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineplus">+interface nsITransaction;</span>
<a href="#l17.15"></a><span id="l17.15"> interface nsITransactionManager;</span>
<a href="#l17.16"></a><span id="l17.16"> </span>
<a href="#l17.17"></a><span id="l17.17" class="difflineminus">-[scriptable, uuid(4342a6ac-1b43-4121-b606-4bdf62de71ff)]</span>
<a href="#l17.18"></a><span id="l17.18" class="difflineplus">+[scriptable, uuid(b3b8d09d-71b1-4654-b807-9288c2f16300)]</span>
<a href="#l17.19"></a><span id="l17.19"> interface nsIBookmarksService : nsISupports</span>
<a href="#l17.20"></a><span id="l17.20"> {</span>
<a href="#l17.21"></a><span id="l17.21">     const unsigned long BOOKMARK_DEFAULT_TYPE   = 0;</span>
<a href="#l17.22"></a><span id="l17.22">     const unsigned long BOOKMARK_SEARCH_TYPE    = 1;</span>
<a href="#l17.23"></a><span id="l17.23">     const unsigned long BOOKMARK_FIND_TYPE      = 2;</span>
<a href="#l17.24"></a><span id="l17.24"> </span>
<a href="#l17.25"></a><span id="l17.25">     const long SORT_DESCENDING = -1;</span>
<a href="#l17.26"></a><span id="l17.26">     const long SORT_ASCENDING = 1;</span>
<a href="#l17.27"></a><span id="l17.27" class="difflineat">@@ -100,16 +102,21 @@ interface nsIBookmarksService : nsISuppo</span>
<a href="#l17.28"></a><span id="l17.28">     </span>
<a href="#l17.29"></a><span id="l17.29">     AString getLastCharset(in AUTF8String aURL); </span>
<a href="#l17.30"></a><span id="l17.30"> </span>
<a href="#l17.31"></a><span id="l17.31">     string resolveKeyword(in wstring aName);</span>
<a href="#l17.32"></a><span id="l17.32">     </span>
<a href="#l17.33"></a><span id="l17.33">     void importSystemBookmarks(in nsIRDFResource aParentFolder);</span>
<a href="#l17.34"></a><span id="l17.34"> </span>
<a href="#l17.35"></a><span id="l17.35">     readonly attribute nsITransactionManager transactionManager;</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineplus">+</span>
<a href="#l17.37"></a><span id="l17.37" class="difflineplus">+    nsITransaction createTransaction(in nsIRDFResource parent,</span>
<a href="#l17.38"></a><span id="l17.38" class="difflineplus">+                                     in nsIRDFNode item,</span>
<a href="#l17.39"></a><span id="l17.39" class="difflineplus">+                                     in unsigned long index,</span>
<a href="#l17.40"></a><span id="l17.40" class="difflineplus">+                                     in boolean remove);</span>
<a href="#l17.41"></a><span id="l17.41"> };</span>
<a href="#l17.42"></a><span id="l17.42"> </span>
<a href="#l17.43"></a><span id="l17.43"> %{C++</span>
<a href="#l17.44"></a><span id="l17.44"> </span>
<a href="#l17.45"></a><span id="l17.45"> // {E638D760-8687-11d2-B530-000000000000}</span>
<a href="#l17.46"></a><span id="l17.46"> #define NS_BOOKMARKS_SERVICE_CID \</span>
<a href="#l17.47"></a><span id="l17.47"> { 0xe638d760, 0x8687, 0x11d2, { 0xb5, 0x30, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0 } }</span>
<a href="#l17.48"></a><span id="l17.48"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/suite/browser/src/nsBookmarksService.cpp</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/suite/browser/src/nsBookmarksService.cpp</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -1617,16 +1617,117 @@ ElementArray::Clear()</span>
<a href="#l18.4"></a><span id="l18.4">     while (--index &gt;= 0)</span>
<a href="#l18.5"></a><span id="l18.5">     {</span>
<a href="#l18.6"></a><span id="l18.6">         ElementInfo* elementInfo = ElementAt(index);</span>
<a href="#l18.7"></a><span id="l18.7">         delete elementInfo;</span>
<a href="#l18.8"></a><span id="l18.8">     }</span>
<a href="#l18.9"></a><span id="l18.9">     nsAutoVoidArray::Clear();</span>
<a href="#l18.10"></a><span id="l18.10"> }</span>
<a href="#l18.11"></a><span id="l18.11"> </span>
<a href="#l18.12"></a><span id="l18.12" class="difflineplus">+/**</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+ * The bookmark transaction knows how to assert and unassert arcs</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineplus">+ */</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineplus">+class BookmarkTransaction: public nsITransaction,</span>
<a href="#l18.16"></a><span id="l18.16" class="difflineplus">+                           public nsIInterfaceRequestor</span>
<a href="#l18.17"></a><span id="l18.17" class="difflineplus">+{</span>
<a href="#l18.18"></a><span id="l18.18" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l18.19"></a><span id="l18.19" class="difflineplus">+  NS_DECL_NSITRANSACTION</span>
<a href="#l18.20"></a><span id="l18.20" class="difflineplus">+  NS_DECL_NSIINTERFACEREQUESTOR</span>
<a href="#l18.21"></a><span id="l18.21" class="difflineplus">+</span>
<a href="#l18.22"></a><span id="l18.22" class="difflineplus">+private:</span>
<a href="#l18.23"></a><span id="l18.23" class="difflineplus">+  nsBookmarksService* mBookmarksService;</span>
<a href="#l18.24"></a><span id="l18.24" class="difflineplus">+  nsCOMPtr&lt;nsIRDFResource&gt; mParent;</span>
<a href="#l18.25"></a><span id="l18.25" class="difflineplus">+  nsCOMPtr&lt;nsIRDFNode&gt; mItem;</span>
<a href="#l18.26"></a><span id="l18.26" class="difflineplus">+  PRUint32 mIndex;</span>
<a href="#l18.27"></a><span id="l18.27" class="difflineplus">+  PRBool mRemove;</span>
<a href="#l18.28"></a><span id="l18.28" class="difflineplus">+  nsresult performTransaction(PRBool aRemove, PRBool aRenumber);</span>
<a href="#l18.29"></a><span id="l18.29" class="difflineplus">+</span>
<a href="#l18.30"></a><span id="l18.30" class="difflineplus">+public:</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineplus">+  BookmarkTransaction(nsBookmarksService* aBookmarksService,</span>
<a href="#l18.32"></a><span id="l18.32" class="difflineplus">+                      nsIRDFResource* aParent, nsIRDFNode* aItem,</span>
<a href="#l18.33"></a><span id="l18.33" class="difflineplus">+                      PRUint32 aIndex, PRBool aRemove)</span>
<a href="#l18.34"></a><span id="l18.34" class="difflineplus">+    : mBookmarksService(aBookmarksService),</span>
<a href="#l18.35"></a><span id="l18.35" class="difflineplus">+      mParent(aParent),</span>
<a href="#l18.36"></a><span id="l18.36" class="difflineplus">+      mItem(aItem),</span>
<a href="#l18.37"></a><span id="l18.37" class="difflineplus">+      mIndex(aIndex),</span>
<a href="#l18.38"></a><span id="l18.38" class="difflineplus">+      mRemove(aRemove) {}</span>
<a href="#l18.39"></a><span id="l18.39" class="difflineplus">+};</span>
<a href="#l18.40"></a><span id="l18.40" class="difflineplus">+</span>
<a href="#l18.41"></a><span id="l18.41" class="difflineplus">+NS_IMPL_ISUPPORTS2(BookmarkTransaction, nsITransaction, nsIInterfaceRequestor)</span>
<a href="#l18.42"></a><span id="l18.42" class="difflineplus">+</span>
<a href="#l18.43"></a><span id="l18.43" class="difflineplus">+nsresult</span>
<a href="#l18.44"></a><span id="l18.44" class="difflineplus">+BookmarkTransaction::performTransaction(PRBool aRemove, PRBool aRenumber)</span>
<a href="#l18.45"></a><span id="l18.45" class="difflineplus">+{</span>
<a href="#l18.46"></a><span id="l18.46" class="difflineplus">+  nsresult rv;</span>
<a href="#l18.47"></a><span id="l18.47" class="difflineplus">+  nsCOMPtr&lt;nsIRDFContainer&gt; container(do_CreateInstance(&quot;@mozilla.org/rdf/container;1&quot;, &amp;rv));</span>
<a href="#l18.48"></a><span id="l18.48" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l18.49"></a><span id="l18.49" class="difflineplus">+    return rv;</span>
<a href="#l18.50"></a><span id="l18.50" class="difflineplus">+</span>
<a href="#l18.51"></a><span id="l18.51" class="difflineplus">+  rv = container-&gt;Init(mBookmarksService, mParent);</span>
<a href="#l18.52"></a><span id="l18.52" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l18.53"></a><span id="l18.53" class="difflineplus">+    return rv;</span>
<a href="#l18.54"></a><span id="l18.54" class="difflineplus">+</span>
<a href="#l18.55"></a><span id="l18.55" class="difflineplus">+  if (!aRemove)</span>
<a href="#l18.56"></a><span id="l18.56" class="difflineplus">+    return container-&gt;InsertElementAt(mItem, mIndex, aRenumber);</span>
<a href="#l18.57"></a><span id="l18.57" class="difflineplus">+</span>
<a href="#l18.58"></a><span id="l18.58" class="difflineplus">+  // We don't renumber the container when deleting bookmarks.</span>
<a href="#l18.59"></a><span id="l18.59" class="difflineplus">+  // This makes it easy to undo the transaction by restoring the same index.</span>
<a href="#l18.60"></a><span id="l18.60" class="difflineplus">+  return container-&gt;RemoveElement(mItem, PR_FALSE);</span>
<a href="#l18.61"></a><span id="l18.61" class="difflineplus">+}</span>
<a href="#l18.62"></a><span id="l18.62" class="difflineplus">+</span>
<a href="#l18.63"></a><span id="l18.63" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l18.64"></a><span id="l18.64" class="difflineplus">+BookmarkTransaction::DoTransaction()</span>
<a href="#l18.65"></a><span id="l18.65" class="difflineplus">+{</span>
<a href="#l18.66"></a><span id="l18.66" class="difflineplus">+  return performTransaction(mRemove, PR_TRUE);</span>
<a href="#l18.67"></a><span id="l18.67" class="difflineplus">+}</span>
<a href="#l18.68"></a><span id="l18.68" class="difflineplus">+</span>
<a href="#l18.69"></a><span id="l18.69" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l18.70"></a><span id="l18.70" class="difflineplus">+BookmarkTransaction::UndoTransaction()</span>
<a href="#l18.71"></a><span id="l18.71" class="difflineplus">+{</span>
<a href="#l18.72"></a><span id="l18.72" class="difflineplus">+  // We don't renumber the container when undoing transactions.</span>
<a href="#l18.73"></a><span id="l18.73" class="difflineplus">+  // This makes it easy to redo the transaction by restoring the same index.</span>
<a href="#l18.74"></a><span id="l18.74" class="difflineplus">+  return performTransaction(!mRemove, PR_FALSE);</span>
<a href="#l18.75"></a><span id="l18.75" class="difflineplus">+}</span>
<a href="#l18.76"></a><span id="l18.76" class="difflineplus">+</span>
<a href="#l18.77"></a><span id="l18.77" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l18.78"></a><span id="l18.78" class="difflineplus">+BookmarkTransaction::RedoTransaction()</span>
<a href="#l18.79"></a><span id="l18.79" class="difflineplus">+{</span>
<a href="#l18.80"></a><span id="l18.80" class="difflineplus">+  // We don't renumber the container when redoing transactions.</span>
<a href="#l18.81"></a><span id="l18.81" class="difflineplus">+  // This makes it easy to undo the transaction by restoring the same index.</span>
<a href="#l18.82"></a><span id="l18.82" class="difflineplus">+  return performTransaction(mRemove, PR_FALSE);</span>
<a href="#l18.83"></a><span id="l18.83" class="difflineplus">+}</span>
<a href="#l18.84"></a><span id="l18.84" class="difflineplus">+</span>
<a href="#l18.85"></a><span id="l18.85" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l18.86"></a><span id="l18.86" class="difflineplus">+BookmarkTransaction::GetIsTransient(PRBool *aIsTransient)</span>
<a href="#l18.87"></a><span id="l18.87" class="difflineplus">+{</span>
<a href="#l18.88"></a><span id="l18.88" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aIsTransient);</span>
<a href="#l18.89"></a><span id="l18.89" class="difflineplus">+  *aIsTransient = PR_FALSE;</span>
<a href="#l18.90"></a><span id="l18.90" class="difflineplus">+  return NS_OK;</span>
<a href="#l18.91"></a><span id="l18.91" class="difflineplus">+}</span>
<a href="#l18.92"></a><span id="l18.92" class="difflineplus">+</span>
<a href="#l18.93"></a><span id="l18.93" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l18.94"></a><span id="l18.94" class="difflineplus">+BookmarkTransaction::Merge(nsITransaction* aTransaction, PRBool* aResult)</span>
<a href="#l18.95"></a><span id="l18.95" class="difflineplus">+{</span>
<a href="#l18.96"></a><span id="l18.96" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l18.97"></a><span id="l18.97" class="difflineplus">+  *aResult = PR_FALSE;</span>
<a href="#l18.98"></a><span id="l18.98" class="difflineplus">+  return NS_OK;</span>
<a href="#l18.99"></a><span id="l18.99" class="difflineplus">+}</span>
<a href="#l18.100"></a><span id="l18.100" class="difflineplus">+</span>
<a href="#l18.101"></a><span id="l18.101" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l18.102"></a><span id="l18.102" class="difflineplus">+BookmarkTransaction::GetInterface(REFNSIID aIID, void** aResult)</span>
<a href="#l18.103"></a><span id="l18.103" class="difflineplus">+{</span>
<a href="#l18.104"></a><span id="l18.104" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l18.105"></a><span id="l18.105" class="difflineplus">+  nsISupports *result = nsnull;</span>
<a href="#l18.106"></a><span id="l18.106" class="difflineplus">+  if (aIID.Equals(NS_GET_IID(nsIRDFNode))) {</span>
<a href="#l18.107"></a><span id="l18.107" class="difflineplus">+    NS_ADDREF(result = mItem);</span>
<a href="#l18.108"></a><span id="l18.108" class="difflineplus">+    *aResult = result;</span>
<a href="#l18.109"></a><span id="l18.109" class="difflineplus">+    return NS_OK;</span>
<a href="#l18.110"></a><span id="l18.110" class="difflineplus">+  }</span>
<a href="#l18.111"></a><span id="l18.111" class="difflineplus">+  return NS_NOINTERFACE;</span>
<a href="#l18.112"></a><span id="l18.112" class="difflineplus">+}</span>
<a href="#l18.113"></a><span id="l18.113"> </span>
<a href="#l18.114"></a><span id="l18.114"> ////////////////////////////////////////////////////////////////////////</span>
<a href="#l18.115"></a><span id="l18.115"> // nsBookmarksService implementation</span>
<a href="#l18.116"></a><span id="l18.116"> </span>
<a href="#l18.117"></a><span id="l18.117"> nsBookmarksService::nsBookmarksService() :</span>
<a href="#l18.118"></a><span id="l18.118">     mUpdateBatchNest(0),</span>
<a href="#l18.119"></a><span id="l18.119">     mDirty(PR_FALSE)</span>
<a href="#l18.120"></a><span id="l18.120"> </span>
<a href="#l18.121"></a><span id="l18.121" class="difflineat">@@ -3974,16 +4075,33 @@ nsBookmarksService::GetTransactionManage</span>
<a href="#l18.122"></a><span id="l18.122"> {</span>
<a href="#l18.123"></a><span id="l18.123">     NS_ENSURE_ARG_POINTER(aTransactionManager);</span>
<a href="#l18.124"></a><span id="l18.124"> </span>
<a href="#l18.125"></a><span id="l18.125">     NS_ADDREF(*aTransactionManager = mTransactionManager);</span>
<a href="#l18.126"></a><span id="l18.126"> </span>
<a href="#l18.127"></a><span id="l18.127">     return NS_OK;</span>
<a href="#l18.128"></a><span id="l18.128"> }</span>
<a href="#l18.129"></a><span id="l18.129"> </span>
<a href="#l18.130"></a><span id="l18.130" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l18.131"></a><span id="l18.131" class="difflineplus">+nsBookmarksService::CreateTransaction(nsIRDFResource* aParent,</span>
<a href="#l18.132"></a><span id="l18.132" class="difflineplus">+                                      nsIRDFNode* aItem,</span>
<a href="#l18.133"></a><span id="l18.133" class="difflineplus">+                                      PRUint32 aIndex,</span>
<a href="#l18.134"></a><span id="l18.134" class="difflineplus">+                                      PRBool aRemove,</span>
<a href="#l18.135"></a><span id="l18.135" class="difflineplus">+                                      nsITransaction** aTransaction)</span>
<a href="#l18.136"></a><span id="l18.136" class="difflineplus">+{</span>
<a href="#l18.137"></a><span id="l18.137" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aTransaction);</span>
<a href="#l18.138"></a><span id="l18.138" class="difflineplus">+  NS_ENSURE_ARG(aItem);</span>
<a href="#l18.139"></a><span id="l18.139" class="difflineplus">+  *aTransaction = new BookmarkTransaction(this, aParent, aItem, aIndex, aRemove);</span>
<a href="#l18.140"></a><span id="l18.140" class="difflineplus">+  if (!*aTransaction)</span>
<a href="#l18.141"></a><span id="l18.141" class="difflineplus">+    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l18.142"></a><span id="l18.142" class="difflineplus">+</span>
<a href="#l18.143"></a><span id="l18.143" class="difflineplus">+  NS_ADDREF(*aTransaction);</span>
<a href="#l18.144"></a><span id="l18.144" class="difflineplus">+  return NS_OK;</span>
<a href="#l18.145"></a><span id="l18.145" class="difflineplus">+}</span>
<a href="#l18.146"></a><span id="l18.146" class="difflineplus">+</span>
<a href="#l18.147"></a><span id="l18.147"> ////////////////////////////////////////////////////////////////////////</span>
<a href="#l18.148"></a><span id="l18.148"> // nsIRDFDataSource</span>
<a href="#l18.149"></a><span id="l18.149"> </span>
<a href="#l18.150"></a><span id="l18.150"> NS_IMETHODIMP</span>
<a href="#l18.151"></a><span id="l18.151"> nsBookmarksService::GetURI(char* *aURI)</span>
<a href="#l18.152"></a><span id="l18.152"> {</span>
<a href="#l18.153"></a><span id="l18.153">     *aURI = NS_strdup(&quot;rdf:bookmarks&quot;);</span>
<a href="#l18.154"></a><span id="l18.154">     if (! *aURI)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/suite/common/bookmarks/bookmarks.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/suite/common/bookmarks/bookmarks.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -121,18 +121,16 @@ function initServices()</span>
<a href="#l19.4"></a><span id="l19.4">   } catch (e) {}</span>
<a href="#l19.5"></a><span id="l19.5"> }</span>
<a href="#l19.6"></a><span id="l19.6"> </span>
<a href="#l19.7"></a><span id="l19.7"> function initBMService()</span>
<a href="#l19.8"></a><span id="l19.8"> {</span>
<a href="#l19.9"></a><span id="l19.9">   kBMSVCIID = Components.interfaces.nsIBookmarksService;</span>
<a href="#l19.10"></a><span id="l19.10">   BMDS  = RDF.GetDataSource(&quot;rdf:bookmarks&quot;);</span>
<a href="#l19.11"></a><span id="l19.11">   BMSVC = BMDS.QueryInterface(kBMSVCIID);</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-  BookmarkTransaction.prototype.RDFC = RDFC;</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineminus">-  BookmarkTransaction.prototype.BMDS = BMDS;</span>
<a href="#l19.14"></a><span id="l19.14"> }</span>
<a href="#l19.15"></a><span id="l19.15"> </span>
<a href="#l19.16"></a><span id="l19.16"> /**</span>
<a href="#l19.17"></a><span id="l19.17">  * XXX - 04/16/01</span>
<a href="#l19.18"></a><span id="l19.18">  *  ACK! massive command name collision problems are causing big issues</span>
<a href="#l19.19"></a><span id="l19.19">  *  in getting this stuff to work in the Navigator window. For sanity's </span>
<a href="#l19.20"></a><span id="l19.20">  *  sake, we need to rename all the commands to be of the form cmd_bm_*</span>
<a href="#l19.21"></a><span id="l19.21">  *  otherwise there'll continue to be problems. For now, we're just </span>
<a href="#l19.22"></a><span id="l19.22" class="difflineat">@@ -670,37 +668,35 @@ var BookmarksCommand = {</span>
<a href="#l19.23"></a><span id="l19.23">         fileName = kFilePicker.file.path;</span>
<a href="#l19.24"></a><span id="l19.24">         if (!fileName) return;</span>
<a href="#l19.25"></a><span id="l19.25">       }</span>
<a href="#l19.26"></a><span id="l19.26">       else return;</span>
<a href="#l19.27"></a><span id="l19.27">     }</span>
<a href="#l19.28"></a><span id="l19.28">     catch (e) {</span>
<a href="#l19.29"></a><span id="l19.29">       return;</span>
<a href="#l19.30"></a><span id="l19.30">     }</span>
<a href="#l19.31"></a><span id="l19.31" class="difflineminus">-    rTarget = RDF.GetResource(&quot;NC:BookmarksRoot&quot;);</span>
<a href="#l19.32"></a><span id="l19.32" class="difflineplus">+    var rTarget = BookmarksUtils.getNewBookmarkFolder();</span>
<a href="#l19.33"></a><span id="l19.33">     RDFC.Init(BMDS, rTarget);</span>
<a href="#l19.34"></a><span id="l19.34" class="difflineminus">-    var countBefore = parseInt(BookmarksUtils.getProperty(rTarget, RDF_NS+&quot;nextVal&quot;));</span>
<a href="#l19.35"></a><span id="l19.35" class="difflineplus">+    var index = RDFC.GetCount();</span>
<a href="#l19.36"></a><span id="l19.36">     var args = [{ property: NC_NS+&quot;URL&quot;, literal: fileName}];</span>
<a href="#l19.37"></a><span id="l19.37">     this.doBookmarksCommand(rTarget, NC_NS_CMD+&quot;import&quot;, args);</span>
<a href="#l19.38"></a><span id="l19.38" class="difflineminus">-    var countAfter = parseInt(BookmarksUtils.getProperty(rTarget, RDF_NS+&quot;nextVal&quot;));</span>
<a href="#l19.39"></a><span id="l19.39" class="difflineplus">+    RDFC.Init(BMDS, rTarget); // changing the selection clobbers RDFC</span>
<a href="#l19.40"></a><span id="l19.40" class="difflineplus">+    var count = RDFC.GetCount();</span>
<a href="#l19.41"></a><span id="l19.41" class="difflineplus">+    if (index == count)</span>
<a href="#l19.42"></a><span id="l19.42" class="difflineplus">+      return;</span>
<a href="#l19.43"></a><span id="l19.43"> </span>
<a href="#l19.44"></a><span id="l19.44" class="difflineminus">-    var transaction = new BookmarkImportTransaction(&quot;import&quot;);</span>
<a href="#l19.45"></a><span id="l19.45" class="difflineminus">-    for (var index = countBefore; index &lt; countAfter; index++) {</span>
<a href="#l19.46"></a><span id="l19.46" class="difflineminus">-      var nChildArc = RDFCU.IndexToOrdinalResource(index);</span>
<a href="#l19.47"></a><span id="l19.47" class="difflineminus">-      var rChild    = BMDS.GetTarget(rTarget, nChildArc, true);</span>
<a href="#l19.48"></a><span id="l19.48" class="difflineminus">-      transaction.item   .push(rChild);</span>
<a href="#l19.49"></a><span id="l19.49" class="difflineminus">-      transaction.parent .push(rTarget);</span>
<a href="#l19.50"></a><span id="l19.50" class="difflineminus">-      transaction.index  .push(index);</span>
<a href="#l19.51"></a><span id="l19.51" class="difflineminus">-      transaction.isValid.push(true);</span>
<a href="#l19.52"></a><span id="l19.52" class="difflineplus">+    var txmgr = BMSVC.transactionManager;</span>
<a href="#l19.53"></a><span id="l19.53" class="difflineplus">+    txmgr.beginBatch();</span>
<a href="#l19.54"></a><span id="l19.54" class="difflineplus">+    while (++index &lt;= count) {</span>
<a href="#l19.55"></a><span id="l19.55" class="difflineplus">+      var rChild = RDFC.RemoveElementAt(index, true);</span>
<a href="#l19.56"></a><span id="l19.56" class="difflineplus">+      var txn = BMSVC.createTransaction(rTarget, rChild, index, false);</span>
<a href="#l19.57"></a><span id="l19.57" class="difflineplus">+      txmgr.doTransaction(txn);</span>
<a href="#l19.58"></a><span id="l19.58">     }</span>
<a href="#l19.59"></a><span id="l19.59" class="difflineminus">-    var isCancelled = !BookmarksUtils.any(transaction.isValid);</span>
<a href="#l19.60"></a><span id="l19.60" class="difflineminus">-    if (!isCancelled) {</span>
<a href="#l19.61"></a><span id="l19.61" class="difflineminus">-      BMSVC.transactionManager.doTransaction(transaction);</span>
<a href="#l19.62"></a><span id="l19.62" class="difflineminus">-      BookmarksUtils.flushDataSource();</span>
<a href="#l19.63"></a><span id="l19.63" class="difflineminus">-    }    </span>
<a href="#l19.64"></a><span id="l19.64" class="difflineplus">+    txmgr.endBatch();</span>
<a href="#l19.65"></a><span id="l19.65" class="difflineplus">+    BookmarksUtils.flushDataSource();</span>
<a href="#l19.66"></a><span id="l19.66">   },</span>
<a href="#l19.67"></a><span id="l19.67"> </span>
<a href="#l19.68"></a><span id="l19.68">   exportBookmarks: function ()</span>
<a href="#l19.69"></a><span id="l19.69">   {</span>
<a href="#l19.70"></a><span id="l19.70">     try {</span>
<a href="#l19.71"></a><span id="l19.71">       const kFilePickerContractID = &quot;@mozilla.org/filepicker;1&quot;;</span>
<a href="#l19.72"></a><span id="l19.72">       const kFilePickerIID = Components.interfaces.nsIFilePicker;</span>
<a href="#l19.73"></a><span id="l19.73">       const kFilePicker = Components.classes[kFilePickerContractID].createInstance(kFilePickerIID);</span>
<a href="#l19.74"></a><span id="l19.74" class="difflineat">@@ -1313,39 +1309,38 @@ var BookmarksUtils = {</span>
<a href="#l19.75"></a><span id="l19.75">         return true;</span>
<a href="#l19.76"></a><span id="l19.76">     }</span>
<a href="#l19.77"></a><span id="l19.77">     return false;</span>
<a href="#l19.78"></a><span id="l19.78">   },</span>
<a href="#l19.79"></a><span id="l19.79"> </span>
<a href="#l19.80"></a><span id="l19.80">   /////////////////////////////////////////////////////////////////////////////</span>
<a href="#l19.81"></a><span id="l19.81">   removeSelection: function (aAction, aSelection)</span>
<a href="#l19.82"></a><span id="l19.82">   {</span>
<a href="#l19.83"></a><span id="l19.83" class="difflineminus">-    var transaction     = new BookmarkRemoveTransaction(aAction);</span>
<a href="#l19.84"></a><span id="l19.84" class="difflineminus">-    transaction.item    = new Array(aSelection.length);</span>
<a href="#l19.85"></a><span id="l19.85" class="difflineminus">-    transaction.parent  = new Array(aSelection.length);</span>
<a href="#l19.86"></a><span id="l19.86" class="difflineminus">-    transaction.index   = new Array(aSelection.length);</span>
<a href="#l19.87"></a><span id="l19.87" class="difflineminus">-    transaction.isValid = BookmarksUtils.isSelectionValidForDeletion(aSelection);</span>
<a href="#l19.88"></a><span id="l19.88" class="difflineplus">+    var isValid = BookmarksUtils.isSelectionValidForDeletion(aSelection);</span>
<a href="#l19.89"></a><span id="l19.89" class="difflineplus">+    if (SOUND &amp;&amp; !BookmarksUtils.all(isValid))</span>
<a href="#l19.90"></a><span id="l19.90" class="difflineplus">+      SOUND.beep();</span>
<a href="#l19.91"></a><span id="l19.91" class="difflineplus">+    if (!BookmarksUtils.any(isValid))</span>
<a href="#l19.92"></a><span id="l19.92" class="difflineplus">+      return false;</span>
<a href="#l19.93"></a><span id="l19.93" class="difflineplus">+</span>
<a href="#l19.94"></a><span id="l19.94" class="difflineplus">+    var txmgr = BMSVC.transactionManager;</span>
<a href="#l19.95"></a><span id="l19.95" class="difflineplus">+    txmgr.beginBatch();</span>
<a href="#l19.96"></a><span id="l19.96">     for (var i = 0; i &lt; aSelection.length; ++i) {</span>
<a href="#l19.97"></a><span id="l19.97" class="difflineminus">-      transaction.item  [i] = aSelection.item  [i];</span>
<a href="#l19.98"></a><span id="l19.98" class="difflineminus">-      transaction.parent[i] = aSelection.parent[i];</span>
<a href="#l19.99"></a><span id="l19.99" class="difflineminus">-      if (transaction.isValid[i]) {</span>
<a href="#l19.100"></a><span id="l19.100" class="difflineplus">+      if (isValid[i]) {</span>
<a href="#l19.101"></a><span id="l19.101">         RDFC.Init(BMDS, aSelection.parent[i]);</span>
<a href="#l19.102"></a><span id="l19.102" class="difflineminus">-        transaction.index[i]  = RDFC.IndexOf(aSelection.item[i]);</span>
<a href="#l19.103"></a><span id="l19.103" class="difflineplus">+        var index = RDFC.IndexOf(aSelection.item[i]);</span>
<a href="#l19.104"></a><span id="l19.104" class="difflineplus">+        var txn = BMSVC.createTransaction(aSelection.parent[i], aSelection.item[i], index, true);</span>
<a href="#l19.105"></a><span id="l19.105" class="difflineplus">+        txmgr.doTransaction(txn);</span>
<a href="#l19.106"></a><span id="l19.106">       }</span>
<a href="#l19.107"></a><span id="l19.107">     }</span>
<a href="#l19.108"></a><span id="l19.108" class="difflineminus">-    if (SOUND &amp;&amp; aAction != &quot;move&quot; &amp;&amp; !BookmarksUtils.all(transaction.isValid))</span>
<a href="#l19.109"></a><span id="l19.109" class="difflineminus">-      SOUND.beep();</span>
<a href="#l19.110"></a><span id="l19.110" class="difflineminus">-    var isCancelled = !BookmarksUtils.any(transaction.isValid);</span>
<a href="#l19.111"></a><span id="l19.111" class="difflineminus">-    if (!isCancelled) {</span>
<a href="#l19.112"></a><span id="l19.112" class="difflineminus">-      BMSVC.transactionManager.doTransaction(transaction);</span>
<a href="#l19.113"></a><span id="l19.113" class="difflineminus">-      if (aAction != &quot;move&quot;)</span>
<a href="#l19.114"></a><span id="l19.114" class="difflineminus">-        BookmarksUtils.notifyBookmarksChanged();</span>
<a href="#l19.115"></a><span id="l19.115" class="difflineminus">-        BookmarksUtils.flushDataSource();</span>
<a href="#l19.116"></a><span id="l19.116" class="difflineplus">+    txmgr.endBatch();</span>
<a href="#l19.117"></a><span id="l19.117" class="difflineplus">+    if (aAction != &quot;move&quot;) {</span>
<a href="#l19.118"></a><span id="l19.118" class="difflineplus">+      BookmarksUtils.notifyBookmarksChanged();</span>
<a href="#l19.119"></a><span id="l19.119" class="difflineplus">+      BookmarksUtils.flushDataSource();</span>
<a href="#l19.120"></a><span id="l19.120">     }</span>
<a href="#l19.121"></a><span id="l19.121" class="difflineminus">-    return !isCancelled;</span>
<a href="#l19.122"></a><span id="l19.122" class="difflineplus">+    return true;</span>
<a href="#l19.123"></a><span id="l19.123">   },</span>
<a href="#l19.124"></a><span id="l19.124">       // If the current bookmark is the IE Favorites folder, we have a little</span>
<a href="#l19.125"></a><span id="l19.125">       // extra work to do - set the pref |browser.bookmarks.import_system_favorites|</span>
<a href="#l19.126"></a><span id="l19.126">       // to ensure that we don't re-import next time. </span>
<a href="#l19.127"></a><span id="l19.127">       //if (aSelection[count].getAttribute(&quot;type&quot;) == (NC_NS + &quot;IEFavoriteFolder&quot;)) {</span>
<a href="#l19.128"></a><span id="l19.128">       //  const kPrefSvcContractID = &quot;@mozilla.org/preferences-service;1&quot;;</span>
<a href="#l19.129"></a><span id="l19.129">       //  const kPrefSvcIID = Components.interfaces.nsIPrefBranch;</span>
<a href="#l19.130"></a><span id="l19.130">       //  const kPrefSvc = Components.classes[kPrefSvcContractID].getService(kPrefSvcIID);</span>
<a href="#l19.131"></a><span id="l19.131" class="difflineat">@@ -1356,60 +1351,61 @@ var BookmarksUtils = {</span>
<a href="#l19.132"></a><span id="l19.132">   {</span>
<a href="#l19.133"></a><span id="l19.133">     Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l19.134"></a><span id="l19.134">               .getService(Components.interfaces.nsIObserverService)</span>
<a href="#l19.135"></a><span id="l19.135">               .notifyObservers(null, &quot;bookmarks-changed&quot;, &quot;&quot;);</span>
<a href="#l19.136"></a><span id="l19.136">   },</span>
<a href="#l19.137"></a><span id="l19.137"> </span>
<a href="#l19.138"></a><span id="l19.138">   insertSelection: function (aAction, aSelection, aTarget)</span>
<a href="#l19.139"></a><span id="l19.139">   {</span>
<a href="#l19.140"></a><span id="l19.140" class="difflineminus">-    var transaction     = new BookmarkInsertTransaction(aAction);</span>
<a href="#l19.141"></a><span id="l19.141" class="difflineminus">-    transaction.item    = new Array(aSelection.length);</span>
<a href="#l19.142"></a><span id="l19.142" class="difflineminus">-    transaction.parent  = new Array(aSelection.length);</span>
<a href="#l19.143"></a><span id="l19.143" class="difflineminus">-    transaction.index   = new Array(aSelection.length);</span>
<a href="#l19.144"></a><span id="l19.144" class="difflineminus">-    if (aAction != &quot;move&quot;)</span>
<a href="#l19.145"></a><span id="l19.145" class="difflineminus">-      transaction.isValid = BookmarksUtils.isSelectionValidForInsertion(aSelection, aTarget, aAction);</span>
<a href="#l19.146"></a><span id="l19.146" class="difflineminus">-    else // isValid has already been determined in moveSelection</span>
<a href="#l19.147"></a><span id="l19.147" class="difflineminus">-      transaction.isValid = aSelection.isValid;</span>
<a href="#l19.148"></a><span id="l19.148" class="difflineplus">+    var isValid = BookmarksUtils.isSelectionValidForInsertion(aSelection, aTarget, aAction);</span>
<a href="#l19.149"></a><span id="l19.149" class="difflineplus">+    if (SOUND &amp;&amp; !BookmarksUtils.all(isValid))</span>
<a href="#l19.150"></a><span id="l19.150" class="difflineplus">+      SOUND.beep();</span>
<a href="#l19.151"></a><span id="l19.151" class="difflineplus">+    if (!BookmarksUtils.any(isValid))</span>
<a href="#l19.152"></a><span id="l19.152" class="difflineplus">+      return false;</span>
<a href="#l19.153"></a><span id="l19.153" class="difflineplus">+</span>
<a href="#l19.154"></a><span id="l19.154" class="difflineplus">+    var txmgr = BMSVC.transactionManager;</span>
<a href="#l19.155"></a><span id="l19.155" class="difflineplus">+    txmgr.beginBatch();</span>
<a href="#l19.156"></a><span id="l19.156">     var index = aTarget.index;</span>
<a href="#l19.157"></a><span id="l19.157" class="difflineminus">-    for (var i=0; i&lt;aSelection.length; ++i) {</span>
<a href="#l19.158"></a><span id="l19.158" class="difflineminus">-      var rSource = aSelection.item[i];</span>
<a href="#l19.159"></a><span id="l19.159" class="difflineminus">-      </span>
<a href="#l19.160"></a><span id="l19.160" class="difflineminus">-      if (transaction.isValid[i]) {</span>
<a href="#l19.161"></a><span id="l19.161" class="difflineminus">-        if (BMSVC.isBookmarkedResource(rSource))</span>
<a href="#l19.162"></a><span id="l19.162" class="difflineminus">-          rSource = BMSVC.cloneResource(rSource);</span>
<a href="#l19.163"></a><span id="l19.163" class="difflineminus">-        transaction.item  [i] = rSource;</span>
<a href="#l19.164"></a><span id="l19.164" class="difflineminus">-        transaction.parent[i] = aTarget.parent;</span>
<a href="#l19.165"></a><span id="l19.165" class="difflineminus">-        transaction.index [i] = index++;</span>
<a href="#l19.166"></a><span id="l19.166" class="difflineminus">-      } else {</span>
<a href="#l19.167"></a><span id="l19.167" class="difflineminus">-        transaction.item  [i] = rSource;</span>
<a href="#l19.168"></a><span id="l19.168" class="difflineminus">-        transaction.parent[i] = aSelection.parent[i];</span>
<a href="#l19.169"></a><span id="l19.169" class="difflineminus">-      } </span>
<a href="#l19.170"></a><span id="l19.170" class="difflineplus">+    for (var i = 0; i &lt; aSelection.length; ++i) {</span>
<a href="#l19.171"></a><span id="l19.171" class="difflineplus">+      if (isValid[i]) {</span>
<a href="#l19.172"></a><span id="l19.172" class="difflineplus">+        var txn = BMSVC.createTransaction(aTarget.parent, aSelection.item[i], index++, false);</span>
<a href="#l19.173"></a><span id="l19.173" class="difflineplus">+        txmgr.doTransaction(txn);</span>
<a href="#l19.174"></a><span id="l19.174" class="difflineplus">+      }</span>
<a href="#l19.175"></a><span id="l19.175">     }</span>
<a href="#l19.176"></a><span id="l19.176" class="difflineminus">-    if (SOUND &amp;&amp; !BookmarksUtils.all(transaction.isValid))</span>
<a href="#l19.177"></a><span id="l19.177" class="difflineminus">-      SOUND.beep();</span>
<a href="#l19.178"></a><span id="l19.178" class="difflineminus">-    var isCancelled = !BookmarksUtils.any(transaction.isValid);</span>
<a href="#l19.179"></a><span id="l19.179" class="difflineminus">-    if (!isCancelled) {</span>
<a href="#l19.180"></a><span id="l19.180" class="difflineminus">-      BMSVC.transactionManager.doTransaction(transaction);</span>
<a href="#l19.181"></a><span id="l19.181" class="difflineminus">-      BookmarksUtils.notifyBookmarksChanged();</span>
<a href="#l19.182"></a><span id="l19.182" class="difflineminus">-      BookmarksUtils.flushDataSource();</span>
<a href="#l19.183"></a><span id="l19.183" class="difflineminus">-    }</span>
<a href="#l19.184"></a><span id="l19.184" class="difflineminus">-    return !isCancelled;</span>
<a href="#l19.185"></a><span id="l19.185" class="difflineplus">+    txmgr.endBatch();</span>
<a href="#l19.186"></a><span id="l19.186" class="difflineplus">+    BookmarksUtils.notifyBookmarksChanged();</span>
<a href="#l19.187"></a><span id="l19.187" class="difflineplus">+    BookmarksUtils.flushDataSource();</span>
<a href="#l19.188"></a><span id="l19.188" class="difflineplus">+    return true;</span>
<a href="#l19.189"></a><span id="l19.189">   },</span>
<a href="#l19.190"></a><span id="l19.190"> </span>
<a href="#l19.191"></a><span id="l19.191">   moveSelection: function (aAction, aSelection, aTarget)</span>
<a href="#l19.192"></a><span id="l19.192">   {</span>
<a href="#l19.193"></a><span id="l19.193" class="difflineminus">-    aSelection.isValid = BookmarksUtils.isSelectionValidForInsertion(aSelection, aTarget, &quot;move&quot;);</span>
<a href="#l19.194"></a><span id="l19.194" class="difflineminus">-    var transaction = new BookmarkMoveTransaction(aAction, aSelection, aTarget);</span>
<a href="#l19.195"></a><span id="l19.195" class="difflineminus">-    var isCancelled = !BookmarksUtils.any(transaction.isValid);</span>
<a href="#l19.196"></a><span id="l19.196" class="difflineminus">-    if (!isCancelled) {</span>
<a href="#l19.197"></a><span id="l19.197" class="difflineminus">-      BMSVC.transactionManager.doTransaction(transaction);</span>
<a href="#l19.198"></a><span id="l19.198" class="difflineminus">-    } else if (SOUND)</span>
<a href="#l19.199"></a><span id="l19.199" class="difflineplus">+    var isValid = BookmarksUtils.isSelectionValidForInsertion(aSelection, aTarget, aAction);</span>
<a href="#l19.200"></a><span id="l19.200" class="difflineplus">+    if (SOUND &amp;&amp; !BookmarksUtils.all(isValid))</span>
<a href="#l19.201"></a><span id="l19.201">       SOUND.beep();</span>
<a href="#l19.202"></a><span id="l19.202" class="difflineminus">-    return !isCancelled;</span>
<a href="#l19.203"></a><span id="l19.203" class="difflineplus">+    if (!BookmarksUtils.any(isValid))</span>
<a href="#l19.204"></a><span id="l19.204" class="difflineplus">+      return false;</span>
<a href="#l19.205"></a><span id="l19.205" class="difflineplus">+</span>
<a href="#l19.206"></a><span id="l19.206" class="difflineplus">+    var txmgr = BMSVC.transactionManager;</span>
<a href="#l19.207"></a><span id="l19.207" class="difflineplus">+    txmgr.beginBatch();</span>
<a href="#l19.208"></a><span id="l19.208" class="difflineplus">+    var index = aTarget.index;</span>
<a href="#l19.209"></a><span id="l19.209" class="difflineplus">+    for (var i = 0; i &lt; aSelection.length; ++i) {</span>
<a href="#l19.210"></a><span id="l19.210" class="difflineplus">+      if (isValid[i]) {</span>
<a href="#l19.211"></a><span id="l19.211" class="difflineplus">+        RDFC.Init(BMDS, aSelection.parent[i]);</span>
<a href="#l19.212"></a><span id="l19.212" class="difflineplus">+        var deleteIndex = RDFC.IndexOf(aSelection.item[i]);</span>
<a href="#l19.213"></a><span id="l19.213" class="difflineplus">+        var deleteTxn = BMSVC.createTransaction(aSelection.parent[i], aSelection.item[i], deleteIndex, true);</span>
<a href="#l19.214"></a><span id="l19.214" class="difflineplus">+        txmgr.doTransaction(deleteTxn);</span>
<a href="#l19.215"></a><span id="l19.215" class="difflineplus">+        var insertTxn = BMSVC.createTransaction(aTarget.parent, aSelection.item[i], index++, false);</span>
<a href="#l19.216"></a><span id="l19.216" class="difflineplus">+        txmgr.doTransaction(insertTxn);</span>
<a href="#l19.217"></a><span id="l19.217" class="difflineplus">+      }</span>
<a href="#l19.218"></a><span id="l19.218" class="difflineplus">+    }</span>
<a href="#l19.219"></a><span id="l19.219" class="difflineplus">+    txmgr.endBatch();</span>
<a href="#l19.220"></a><span id="l19.220" class="difflineplus">+    BookmarksUtils.flushDataSource();</span>
<a href="#l19.221"></a><span id="l19.221" class="difflineplus">+    return true;</span>
<a href="#l19.222"></a><span id="l19.222">   }, </span>
<a href="#l19.223"></a><span id="l19.223"> </span>
<a href="#l19.224"></a><span id="l19.224">   getXferDataFromSelection: function (aSelection)</span>
<a href="#l19.225"></a><span id="l19.225">   {</span>
<a href="#l19.226"></a><span id="l19.226">     if (aSelection.length == 0)</span>
<a href="#l19.227"></a><span id="l19.227">       return null;</span>
<a href="#l19.228"></a><span id="l19.228">     var dataSet = new TransferDataSet();</span>
<a href="#l19.229"></a><span id="l19.229">     var data, item, itemUrl, itemName, parent, name;</span>
<a href="#l19.230"></a><span id="l19.230" class="difflineat">@@ -1646,204 +1642,8 @@ var BookmarksUtils = {</span>
<a href="#l19.231"></a><span id="l19.231">     if (!target)</span>
<a href="#l19.232"></a><span id="l19.232">       return;</span>
<a href="#l19.233"></a><span id="l19.233"> </span>
<a href="#l19.234"></a><span id="l19.234">     var rSource   = RDF.GetResource(aEvent.target.id);</span>
<a href="#l19.235"></a><span id="l19.235">     var selection = BookmarksUtils.getSelectionFromResource(rSource);</span>
<a href="#l19.236"></a><span id="l19.236">     BookmarksCommand.openBookmark(selection, target, aDS, aEvent)</span>
<a href="#l19.237"></a><span id="l19.237">   }</span>
<a href="#l19.238"></a><span id="l19.238"> }</span>
<a href="#l19.239"></a><span id="l19.239" class="difflineminus">-</span>
<a href="#l19.240"></a><span id="l19.240" class="difflineminus">-</span>
<a href="#l19.241"></a><span id="l19.241" class="difflineminus">-function BookmarkTransaction()</span>
<a href="#l19.242"></a><span id="l19.242" class="difflineminus">-{</span>
<a href="#l19.243"></a><span id="l19.243" class="difflineminus">-}</span>
<a href="#l19.244"></a><span id="l19.244" class="difflineminus">-</span>
<a href="#l19.245"></a><span id="l19.245" class="difflineminus">-BookmarkTransaction.prototype = {</span>
<a href="#l19.246"></a><span id="l19.246" class="difflineminus">-  BATCH_LIMIT : 8,</span>
<a href="#l19.247"></a><span id="l19.247" class="difflineminus">-  RDFC        : null,</span>
<a href="#l19.248"></a><span id="l19.248" class="difflineminus">-  BMDS        : null,</span>
<a href="#l19.249"></a><span id="l19.249" class="difflineminus">-</span>
<a href="#l19.250"></a><span id="l19.250" class="difflineminus">-  beginUpdateBatch: function()</span>
<a href="#l19.251"></a><span id="l19.251" class="difflineminus">-  {</span>
<a href="#l19.252"></a><span id="l19.252" class="difflineminus">-    if (this.item.length &gt; this.BATCH_LIMIT) {</span>
<a href="#l19.253"></a><span id="l19.253" class="difflineminus">-      this.BMDS.beginUpdateBatch();</span>
<a href="#l19.254"></a><span id="l19.254" class="difflineminus">-    }</span>
<a href="#l19.255"></a><span id="l19.255" class="difflineminus">-  },</span>
<a href="#l19.256"></a><span id="l19.256" class="difflineminus">-</span>
<a href="#l19.257"></a><span id="l19.257" class="difflineminus">-  endUpdateBatch: function()</span>
<a href="#l19.258"></a><span id="l19.258" class="difflineminus">-  {</span>
<a href="#l19.259"></a><span id="l19.259" class="difflineminus">-    if (this.item.length &gt; this.BATCH_LIMIT) {</span>
<a href="#l19.260"></a><span id="l19.260" class="difflineminus">-      this.BMDS.endUpdateBatch();</span>
<a href="#l19.261"></a><span id="l19.261" class="difflineminus">-    }</span>
<a href="#l19.262"></a><span id="l19.262" class="difflineminus">-  },</span>
<a href="#l19.263"></a><span id="l19.263" class="difflineminus">-</span>
<a href="#l19.264"></a><span id="l19.264" class="difflineminus">-  // nsITransaction method stubs</span>
<a href="#l19.265"></a><span id="l19.265" class="difflineminus">-  doTransaction: function() {},</span>
<a href="#l19.266"></a><span id="l19.266" class="difflineminus">-  undoTransaction: function() {},</span>
<a href="#l19.267"></a><span id="l19.267" class="difflineminus">-  redoTransaction: function() { this.doTransaction(); },</span>
<a href="#l19.268"></a><span id="l19.268" class="difflineminus">-  get isTransient() { return false; },</span>
<a href="#l19.269"></a><span id="l19.269" class="difflineminus">-  merge: function(aTransaction) { return false; },</span>
<a href="#l19.270"></a><span id="l19.270" class="difflineminus">-</span>
<a href="#l19.271"></a><span id="l19.271" class="difflineminus">-  // debugging helper</span>
<a href="#l19.272"></a><span id="l19.272" class="difflineminus">-  get wrappedJSObject() { return this; }</span>
<a href="#l19.273"></a><span id="l19.273" class="difflineminus">-}</span>
<a href="#l19.274"></a><span id="l19.274" class="difflineminus">-</span>
<a href="#l19.275"></a><span id="l19.275" class="difflineminus">-function BookmarkInsertTransaction (aAction)</span>
<a href="#l19.276"></a><span id="l19.276" class="difflineminus">-{</span>
<a href="#l19.277"></a><span id="l19.277" class="difflineminus">-  this.type    = &quot;insert&quot;;</span>
<a href="#l19.278"></a><span id="l19.278" class="difflineminus">-  this.action  = aAction;</span>
<a href="#l19.279"></a><span id="l19.279" class="difflineminus">-  this.item    = null;</span>
<a href="#l19.280"></a><span id="l19.280" class="difflineminus">-  this.parent  = null;</span>
<a href="#l19.281"></a><span id="l19.281" class="difflineminus">-  this.index   = null;</span>
<a href="#l19.282"></a><span id="l19.282" class="difflineminus">-  this.isValid = null;</span>
<a href="#l19.283"></a><span id="l19.283" class="difflineminus">-}</span>
<a href="#l19.284"></a><span id="l19.284" class="difflineminus">-</span>
<a href="#l19.285"></a><span id="l19.285" class="difflineminus">-BookmarkInsertTransaction.prototype =</span>
<a href="#l19.286"></a><span id="l19.286" class="difflineminus">-{</span>
<a href="#l19.287"></a><span id="l19.287" class="difflineminus">-  __proto__: BookmarkTransaction.prototype,</span>
<a href="#l19.288"></a><span id="l19.288" class="difflineminus">-</span>
<a href="#l19.289"></a><span id="l19.289" class="difflineminus">-  doTransaction: function ()</span>
<a href="#l19.290"></a><span id="l19.290" class="difflineminus">-  {</span>
<a href="#l19.291"></a><span id="l19.291" class="difflineminus">-    this.beginUpdateBatch();</span>
<a href="#l19.292"></a><span id="l19.292" class="difflineminus">-    for (var i=0; i&lt;this.item.length; ++i) {</span>
<a href="#l19.293"></a><span id="l19.293" class="difflineminus">-      if (this.isValid[i]) {</span>
<a href="#l19.294"></a><span id="l19.294" class="difflineminus">-        this.RDFC.Init(this.BMDS, this.parent[i]);</span>
<a href="#l19.295"></a><span id="l19.295" class="difflineminus">-        this.RDFC.InsertElementAt(this.item[i], this.index[i], true);</span>
<a href="#l19.296"></a><span id="l19.296" class="difflineminus">-      }</span>
<a href="#l19.297"></a><span id="l19.297" class="difflineminus">-    }</span>
<a href="#l19.298"></a><span id="l19.298" class="difflineminus">-    this.endUpdateBatch();</span>
<a href="#l19.299"></a><span id="l19.299" class="difflineminus">-  },</span>
<a href="#l19.300"></a><span id="l19.300" class="difflineminus">-</span>
<a href="#l19.301"></a><span id="l19.301" class="difflineminus">-  undoTransaction: function ()</span>
<a href="#l19.302"></a><span id="l19.302" class="difflineminus">-  {</span>
<a href="#l19.303"></a><span id="l19.303" class="difflineminus">-    this.beginUpdateBatch();</span>
<a href="#l19.304"></a><span id="l19.304" class="difflineminus">-    // XXXvarga Can't use |RDFC| here because it's being &quot;reused&quot; elsewhere.</span>
<a href="#l19.305"></a><span id="l19.305" class="difflineminus">-    var container = Components.classes[kRDFCContractID].createInstance(kRDFCIID);</span>
<a href="#l19.306"></a><span id="l19.306" class="difflineminus">-    for (var i=this.item.length-1; i&gt;=0; i--) {</span>
<a href="#l19.307"></a><span id="l19.307" class="difflineminus">-      if (this.isValid[i]) {</span>
<a href="#l19.308"></a><span id="l19.308" class="difflineminus">-        container.Init(this.BMDS, this.parent[i]);</span>
<a href="#l19.309"></a><span id="l19.309" class="difflineminus">-        container.RemoveElementAt(this.index[i], true);</span>
<a href="#l19.310"></a><span id="l19.310" class="difflineminus">-      }</span>
<a href="#l19.311"></a><span id="l19.311" class="difflineminus">-    }</span>
<a href="#l19.312"></a><span id="l19.312" class="difflineminus">-    this.endUpdateBatch();</span>
<a href="#l19.313"></a><span id="l19.313" class="difflineminus">-  }</span>
<a href="#l19.314"></a><span id="l19.314" class="difflineminus">-</span>
<a href="#l19.315"></a><span id="l19.315" class="difflineminus">-}</span>
<a href="#l19.316"></a><span id="l19.316" class="difflineminus">-</span>
<a href="#l19.317"></a><span id="l19.317" class="difflineminus">-function BookmarkRemoveTransaction (aAction)</span>
<a href="#l19.318"></a><span id="l19.318" class="difflineminus">-{</span>
<a href="#l19.319"></a><span id="l19.319" class="difflineminus">-  this.type    = &quot;remove&quot;;</span>
<a href="#l19.320"></a><span id="l19.320" class="difflineminus">-  this.action  = aAction;</span>
<a href="#l19.321"></a><span id="l19.321" class="difflineminus">-  this.item    = null;</span>
<a href="#l19.322"></a><span id="l19.322" class="difflineminus">-  this.parent  = null;</span>
<a href="#l19.323"></a><span id="l19.323" class="difflineminus">-  this.index   = null;</span>
<a href="#l19.324"></a><span id="l19.324" class="difflineminus">-  this.isValid = null;</span>
<a href="#l19.325"></a><span id="l19.325" class="difflineminus">-}</span>
<a href="#l19.326"></a><span id="l19.326" class="difflineminus">-</span>
<a href="#l19.327"></a><span id="l19.327" class="difflineminus">-BookmarkRemoveTransaction.prototype =</span>
<a href="#l19.328"></a><span id="l19.328" class="difflineminus">-{</span>
<a href="#l19.329"></a><span id="l19.329" class="difflineminus">-  __proto__: BookmarkTransaction.prototype,</span>
<a href="#l19.330"></a><span id="l19.330" class="difflineminus">-</span>
<a href="#l19.331"></a><span id="l19.331" class="difflineminus">-  doTransaction: function ()</span>
<a href="#l19.332"></a><span id="l19.332" class="difflineminus">-  {</span>
<a href="#l19.333"></a><span id="l19.333" class="difflineminus">-    this.beginUpdateBatch();</span>
<a href="#l19.334"></a><span id="l19.334" class="difflineminus">-    for (var i=0; i&lt;this.item.length; ++i) {</span>
<a href="#l19.335"></a><span id="l19.335" class="difflineminus">-      if (this.isValid[i]) {</span>
<a href="#l19.336"></a><span id="l19.336" class="difflineminus">-        this.RDFC.Init(this.BMDS, this.parent[i]);</span>
<a href="#l19.337"></a><span id="l19.337" class="difflineminus">-        this.RDFC.RemoveElementAt(this.index[i], false);</span>
<a href="#l19.338"></a><span id="l19.338" class="difflineminus">-      }</span>
<a href="#l19.339"></a><span id="l19.339" class="difflineminus">-    }</span>
<a href="#l19.340"></a><span id="l19.340" class="difflineminus">-    this.endUpdateBatch();</span>
<a href="#l19.341"></a><span id="l19.341" class="difflineminus">-  },</span>
<a href="#l19.342"></a><span id="l19.342" class="difflineminus">-</span>
<a href="#l19.343"></a><span id="l19.343" class="difflineminus">-  undoTransaction: function ()</span>
<a href="#l19.344"></a><span id="l19.344" class="difflineminus">-  {</span>
<a href="#l19.345"></a><span id="l19.345" class="difflineminus">-    this.beginUpdateBatch();</span>
<a href="#l19.346"></a><span id="l19.346" class="difflineminus">-    for (var i=this.item.length-1; i&gt;=0; i--) {</span>
<a href="#l19.347"></a><span id="l19.347" class="difflineminus">-      if (this.isValid[i]) {</span>
<a href="#l19.348"></a><span id="l19.348" class="difflineminus">-        this.RDFC.Init(this.BMDS, this.parent[i]);</span>
<a href="#l19.349"></a><span id="l19.349" class="difflineminus">-        this.RDFC.InsertElementAt(this.item[i], this.index[i], false);</span>
<a href="#l19.350"></a><span id="l19.350" class="difflineminus">-      }</span>
<a href="#l19.351"></a><span id="l19.351" class="difflineminus">-    }</span>
<a href="#l19.352"></a><span id="l19.352" class="difflineminus">-    this.endUpdateBatch();</span>
<a href="#l19.353"></a><span id="l19.353" class="difflineminus">-  }</span>
<a href="#l19.354"></a><span id="l19.354" class="difflineminus">-</span>
<a href="#l19.355"></a><span id="l19.355" class="difflineminus">-}</span>
<a href="#l19.356"></a><span id="l19.356" class="difflineminus">-</span>
<a href="#l19.357"></a><span id="l19.357" class="difflineminus">-function BookmarkMoveTransaction (aAction, aSelection, aTarget)</span>
<a href="#l19.358"></a><span id="l19.358" class="difflineminus">-{</span>
<a href="#l19.359"></a><span id="l19.359" class="difflineminus">-  this.type      = &quot;move&quot;;</span>
<a href="#l19.360"></a><span id="l19.360" class="difflineminus">-  this.action    = aAction;</span>
<a href="#l19.361"></a><span id="l19.361" class="difflineminus">-  this.selection = aSelection;</span>
<a href="#l19.362"></a><span id="l19.362" class="difflineminus">-  this.target    = aTarget;</span>
<a href="#l19.363"></a><span id="l19.363" class="difflineminus">-  this.isValid   = aSelection.isValid;</span>
<a href="#l19.364"></a><span id="l19.364" class="difflineminus">-}</span>
<a href="#l19.365"></a><span id="l19.365" class="difflineminus">-</span>
<a href="#l19.366"></a><span id="l19.366" class="difflineminus">-BookmarkMoveTransaction.prototype =</span>
<a href="#l19.367"></a><span id="l19.367" class="difflineminus">-{</span>
<a href="#l19.368"></a><span id="l19.368" class="difflineminus">-  __proto__: BookmarkTransaction.prototype,</span>
<a href="#l19.369"></a><span id="l19.369" class="difflineminus">-</span>
<a href="#l19.370"></a><span id="l19.370" class="difflineminus">-  beginUpdateBatch: function()</span>
<a href="#l19.371"></a><span id="l19.371" class="difflineminus">-  {</span>
<a href="#l19.372"></a><span id="l19.372" class="difflineminus">-    if (this.selection.length &gt; this.BATCH_LIMIT) {</span>
<a href="#l19.373"></a><span id="l19.373" class="difflineminus">-      this.BMDS.beginUpdateBatch();</span>
<a href="#l19.374"></a><span id="l19.374" class="difflineminus">-    }</span>
<a href="#l19.375"></a><span id="l19.375" class="difflineminus">-  },</span>
<a href="#l19.376"></a><span id="l19.376" class="difflineminus">-</span>
<a href="#l19.377"></a><span id="l19.377" class="difflineminus">-  endUpdateBatch: function()</span>
<a href="#l19.378"></a><span id="l19.378" class="difflineminus">-  {</span>
<a href="#l19.379"></a><span id="l19.379" class="difflineminus">-    if (this.selection.length &gt; this.BATCH_LIMIT) {</span>
<a href="#l19.380"></a><span id="l19.380" class="difflineminus">-      this.BMDS.endUpdateBatch();</span>
<a href="#l19.381"></a><span id="l19.381" class="difflineminus">-    }</span>
<a href="#l19.382"></a><span id="l19.382" class="difflineminus">-  },</span>
<a href="#l19.383"></a><span id="l19.383" class="difflineminus">-</span>
<a href="#l19.384"></a><span id="l19.384" class="difflineminus">-  doTransaction: function ()</span>
<a href="#l19.385"></a><span id="l19.385" class="difflineminus">-  {</span>
<a href="#l19.386"></a><span id="l19.386" class="difflineminus">-    this.beginUpdateBatch();</span>
<a href="#l19.387"></a><span id="l19.387" class="difflineminus">-    BookmarksUtils.removeSelection(&quot;move&quot;, this.selection);</span>
<a href="#l19.388"></a><span id="l19.388" class="difflineminus">-    BookmarksUtils.insertSelection(&quot;move&quot;, this.selection, this.target);</span>
<a href="#l19.389"></a><span id="l19.389" class="difflineminus">-    this.endUpdateBatch();</span>
<a href="#l19.390"></a><span id="l19.390" class="difflineminus">-  },</span>
<a href="#l19.391"></a><span id="l19.391" class="difflineminus">-</span>
<a href="#l19.392"></a><span id="l19.392" class="difflineminus">-  redoTransaction     : function () {}</span>
<a href="#l19.393"></a><span id="l19.393" class="difflineminus">-</span>
<a href="#l19.394"></a><span id="l19.394" class="difflineminus">-}</span>
<a href="#l19.395"></a><span id="l19.395" class="difflineminus">-</span>
<a href="#l19.396"></a><span id="l19.396" class="difflineminus">-function BookmarkImportTransaction (aAction)</span>
<a href="#l19.397"></a><span id="l19.397" class="difflineminus">-{</span>
<a href="#l19.398"></a><span id="l19.398" class="difflineminus">-  this.type    = &quot;import&quot;;</span>
<a href="#l19.399"></a><span id="l19.399" class="difflineminus">-  this.action  = aAction;</span>
<a href="#l19.400"></a><span id="l19.400" class="difflineminus">-  this.item    = [];</span>
<a href="#l19.401"></a><span id="l19.401" class="difflineminus">-  this.parent  = [];</span>
<a href="#l19.402"></a><span id="l19.402" class="difflineminus">-  this.index   = [];</span>
<a href="#l19.403"></a><span id="l19.403" class="difflineminus">-  this.isValid = [];</span>
<a href="#l19.404"></a><span id="l19.404" class="difflineminus">-}</span>
<a href="#l19.405"></a><span id="l19.405" class="difflineminus">-</span>
<a href="#l19.406"></a><span id="l19.406" class="difflineminus">-BookmarkImportTransaction.prototype =</span>
<a href="#l19.407"></a><span id="l19.407" class="difflineminus">-{</span>
<a href="#l19.408"></a><span id="l19.408" class="difflineminus">-  __proto__: BookmarkTransaction.prototype,</span>
<a href="#l19.409"></a><span id="l19.409" class="difflineminus">-</span>
<a href="#l19.410"></a><span id="l19.410" class="difflineminus">-  undoTransaction: function ()</span>
<a href="#l19.411"></a><span id="l19.411" class="difflineminus">-  {</span>
<a href="#l19.412"></a><span id="l19.412" class="difflineminus">-    this.beginUpdateBatch();</span>
<a href="#l19.413"></a><span id="l19.413" class="difflineminus">-    for (var i=this.item.length-1; i&gt;=0; i--) {</span>
<a href="#l19.414"></a><span id="l19.414" class="difflineminus">-      if (this.isValid[i]) {</span>
<a href="#l19.415"></a><span id="l19.415" class="difflineminus">-        this.RDFC.Init(this.BMDS, this.parent[i]);</span>
<a href="#l19.416"></a><span id="l19.416" class="difflineminus">-        this.RDFC.RemoveElementAt(this.index[i], true);</span>
<a href="#l19.417"></a><span id="l19.417" class="difflineminus">-      }</span>
<a href="#l19.418"></a><span id="l19.418" class="difflineminus">-    }</span>
<a href="#l19.419"></a><span id="l19.419" class="difflineminus">-    this.endUpdateBatch();</span>
<a href="#l19.420"></a><span id="l19.420" class="difflineminus">-  },</span>
<a href="#l19.421"></a><span id="l19.421" class="difflineminus">-   </span>
<a href="#l19.422"></a><span id="l19.422" class="difflineminus">-  redoTransaction: function ()</span>
<a href="#l19.423"></a><span id="l19.423" class="difflineminus">-  {</span>
<a href="#l19.424"></a><span id="l19.424" class="difflineminus">-    this.beginUpdateBatch();</span>
<a href="#l19.425"></a><span id="l19.425" class="difflineminus">-    for (var i=0; i&lt;this.item.length; ++i) {</span>
<a href="#l19.426"></a><span id="l19.426" class="difflineminus">-      if (this.isValid[i]) {</span>
<a href="#l19.427"></a><span id="l19.427" class="difflineminus">-        this.RDFC.Init(this.BMDS, this.parent[i]);</span>
<a href="#l19.428"></a><span id="l19.428" class="difflineminus">-        this.RDFC.InsertElementAt(this.item[i], this.index[i], true);</span>
<a href="#l19.429"></a><span id="l19.429" class="difflineminus">-      }</span>
<a href="#l19.430"></a><span id="l19.430" class="difflineminus">-    }</span>
<a href="#l19.431"></a><span id="l19.431" class="difflineminus">-    this.endUpdateBatch();</span>
<a href="#l19.432"></a><span id="l19.432" class="difflineminus">-  }</span>
<a href="#l19.433"></a><span id="l19.433" class="difflineminus">-</span>
<a href="#l19.434"></a><span id="l19.434" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/suite/common/bookmarks/bookmarksTree.xml</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/suite/common/bookmarks/bookmarksTree.xml</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -359,38 +359,31 @@</span>
<a href="#l20.4"></a><span id="l20.4">             }</span>
<a href="#l20.5"></a><span id="l20.5"> </span>
<a href="#l20.6"></a><span id="l20.6">             selection.selectEventsSuppressed = false;</span>
<a href="#l20.7"></a><span id="l20.7">           }</span>
<a href="#l20.8"></a><span id="l20.8">         ]]&gt;&lt;/body&gt;</span>
<a href="#l20.9"></a><span id="l20.9">       &lt;/method&gt;</span>
<a href="#l20.10"></a><span id="l20.10"> </span>
<a href="#l20.11"></a><span id="l20.11">       &lt;field name=&quot;_itemToBeToggled&quot;&gt;  []&lt;/field&gt;</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-      &lt;field name=&quot;_parentToBeToggled&quot;&gt;[]&lt;/field&gt;</span>
<a href="#l20.13"></a><span id="l20.13">       &lt;method name=&quot;preUpdateTreeSelection&quot;&gt;</span>
<a href="#l20.14"></a><span id="l20.14">         &lt;parameter name=&quot;aTxn&quot;/&gt;</span>
<a href="#l20.15"></a><span id="l20.15">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l20.16"></a><span id="l20.16" class="difflineminus">-          aTxn = aTxn.wrappedJSObject;</span>
<a href="#l20.17"></a><span id="l20.17" class="difflineminus">-          var type = aTxn.type;</span>
<a href="#l20.18"></a><span id="l20.18" class="difflineminus">-          // Skip transactions that aggregates nested &quot;insert&quot; or &quot;remove&quot; transactions.</span>
<a href="#l20.19"></a><span id="l20.19" class="difflineminus">-          if (type != &quot;insert&quot; &amp;&amp; type != &quot;remove&quot;)</span>
<a href="#l20.20"></a><span id="l20.20" class="difflineminus">-            return;</span>
<a href="#l20.21"></a><span id="l20.21" class="difflineminus">-          for (var i=0; i&lt;aTxn.item.length; ++i) {</span>
<a href="#l20.22"></a><span id="l20.22" class="difflineminus">-            this._itemToBeToggled  .push(aTxn.item  [i]);</span>
<a href="#l20.23"></a><span id="l20.23" class="difflineminus">-            this._parentToBeToggled.push(aTxn.parent[i]);</span>
<a href="#l20.24"></a><span id="l20.24" class="difflineminus">-          }</span>
<a href="#l20.25"></a><span id="l20.25" class="difflineplus">+          // aTxn could be null, or possibly some third-party transaction?</span>
<a href="#l20.26"></a><span id="l20.26" class="difflineplus">+          if (aTxn instanceof Components.interfaces.nsIInterfaceRequestor)</span>
<a href="#l20.27"></a><span id="l20.27" class="difflineplus">+            this._itemToBeToggled.push(aTxn.getInterface(Components.interfaces.nsIRDFNode));</span>
<a href="#l20.28"></a><span id="l20.28">         ]]&gt;&lt;/body&gt;</span>
<a href="#l20.29"></a><span id="l20.29">       &lt;/method&gt;</span>
<a href="#l20.30"></a><span id="l20.30"> </span>
<a href="#l20.31"></a><span id="l20.31">       &lt;method name=&quot;updateTreeSelection&quot;&gt;</span>
<a href="#l20.32"></a><span id="l20.32">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l20.33"></a><span id="l20.33">           this.treeBoxObject.view.selection.selectEventsSuppressed = true;</span>
<a href="#l20.34"></a><span id="l20.34">           this.treeBoxObject.view.selection.clearSelection();</span>
<a href="#l20.35"></a><span id="l20.35">           for (var i=0; i&lt;this._itemToBeToggled.length; ++i) {</span>
<a href="#l20.36"></a><span id="l20.36" class="difflineminus">-            index = this.treeBuilder.getIndexOfResource(this._itemToBeToggled[i]);</span>
<a href="#l20.37"></a><span id="l20.37" class="difflineplus">+            var index = this.treeBuilder.getIndexOfResource(this._itemToBeToggled[i]);</span>
<a href="#l20.38"></a><span id="l20.38">             if (index &gt;=0)</span>
<a href="#l20.39"></a><span id="l20.39">               this.treeBoxObject.view.selection.toggleSelect(index);</span>
<a href="#l20.40"></a><span id="l20.40">           }</span>
<a href="#l20.41"></a><span id="l20.41">           this.treeBoxObject.view.selection.selectEventsSuppressed = false;</span>
<a href="#l20.42"></a><span id="l20.42">         ]]&gt;&lt;/body&gt;</span>
<a href="#l20.43"></a><span id="l20.43">       &lt;/method&gt;</span>
<a href="#l20.44"></a><span id="l20.44"> </span>
<a href="#l20.45"></a><span id="l20.45">       &lt;method name=&quot;createTreeContextMenu&quot;&gt;</span>
<a href="#l20.46"></a><span id="l20.46" class="difflineat">@@ -686,35 +679,32 @@</span>
<a href="#l20.47"></a><span id="l20.47">       &lt;!-- nsITransactionManager listener --&gt;</span>
<a href="#l20.48"></a><span id="l20.48">       &lt;field name=&quot;transactionListener&quot;&gt;&lt;![CDATA[</span>
<a href="#l20.49"></a><span id="l20.49">       ({</span>
<a href="#l20.50"></a><span id="l20.50"> </span>
<a href="#l20.51"></a><span id="l20.51">         mOuter: this,</span>
<a href="#l20.52"></a><span id="l20.52"> </span>
<a href="#l20.53"></a><span id="l20.53">         willDo: function (aTxmgr, aTxn) {</span>
<a href="#l20.54"></a><span id="l20.54">           this.mOuter._itemToBeToggled   = [];</span>
<a href="#l20.55"></a><span id="l20.55" class="difflineminus">-          this.mOuter._parentToBeToggled = [];</span>
<a href="#l20.56"></a><span id="l20.56">         },</span>
<a href="#l20.57"></a><span id="l20.57"> </span>
<a href="#l20.58"></a><span id="l20.58">         didDo: function (aTxmgr, aTxn) {</span>
<a href="#l20.59"></a><span id="l20.59">           this.mOuter.preUpdateTreeSelection(aTxn);</span>
<a href="#l20.60"></a><span id="l20.60">         },</span>
<a href="#l20.61"></a><span id="l20.61"> </span>
<a href="#l20.62"></a><span id="l20.62">         willUndo: function (aTxmgr, aTxn) {</span>
<a href="#l20.63"></a><span id="l20.63">           this.mOuter._itemToBeToggled   = [];</span>
<a href="#l20.64"></a><span id="l20.64" class="difflineminus">-          this.mOuter._parentToBeToggled = [];</span>
<a href="#l20.65"></a><span id="l20.65">         },</span>
<a href="#l20.66"></a><span id="l20.66"> </span>
<a href="#l20.67"></a><span id="l20.67">         didUndo: function (aTxmgr, aTxn) {</span>
<a href="#l20.68"></a><span id="l20.68">           this.mOuter.preUpdateTreeSelection(aTxn);</span>
<a href="#l20.69"></a><span id="l20.69">         },</span>
<a href="#l20.70"></a><span id="l20.70"> </span>
<a href="#l20.71"></a><span id="l20.71">         willRedo: function (aTxmgr, aTxn) {</span>
<a href="#l20.72"></a><span id="l20.72">           this.mOuter._itemToBeToggled   = [];</span>
<a href="#l20.73"></a><span id="l20.73" class="difflineminus">-          this.mOuter._parentToBeToggled = [];</span>
<a href="#l20.74"></a><span id="l20.74">         },</span>
<a href="#l20.75"></a><span id="l20.75"> </span>
<a href="#l20.76"></a><span id="l20.76">         didRedo: function (aTxmgr, aTxn) {</span>
<a href="#l20.77"></a><span id="l20.77">           this.mOuter.preUpdateTreeSelection(aTxn);</span>
<a href="#l20.78"></a><span id="l20.78">         },</span>
<a href="#l20.79"></a><span id="l20.79"> </span>
<a href="#l20.80"></a><span id="l20.80">         didMerge       : function (aTxmgr, aTxn) {},</span>
<a href="#l20.81"></a><span id="l20.81">         didBeginBatch  : function (aTxmgr, aTxn) {},</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/suite/common/history/controller.js</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/suite/common/history/controller.js</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -101,30 +101,38 @@ PlacesController.prototype = {</span>
<a href="#l21.4"></a><span id="l21.4">             return true;</span>
<a href="#l21.5"></a><span id="l21.5">         }</span>
<a href="#l21.6"></a><span id="l21.6">       }</span>
<a href="#l21.7"></a><span id="l21.7">       return false;</span>
<a href="#l21.8"></a><span id="l21.8">     case &quot;placesCmd_open&quot;:</span>
<a href="#l21.9"></a><span id="l21.9">       var selectedNode = this._view.selectedNode;</span>
<a href="#l21.10"></a><span id="l21.10">       return selectedNode &amp;&amp; PlacesUtils.nodeIsURI(selectedNode);</span>
<a href="#l21.11"></a><span id="l21.11">     case &quot;placesCmd_delete:hostname&quot;:</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-      gDeleteByHostname.accessKey = PlacesUIUtils.getString(&quot;delete.hostname.accesskey&quot;);</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+      gDeleteByHostname.setAttribute(&quot;accesskey&quot;,</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineplus">+                                     PlacesUIUtils.getString(&quot;delete.hostname.accesskey&quot;));</span>
<a href="#l21.15"></a><span id="l21.15">       if (gLastHostname) {</span>
<a href="#l21.16"></a><span id="l21.16" class="difflineminus">-        gDeleteByHostname.label = PlacesUIUtils.getFormattedString(&quot;delete.hostname.true&quot;, [gLastHostname]);</span>
<a href="#l21.17"></a><span id="l21.17" class="difflineplus">+        gDeleteByHostname.setAttribute(&quot;label&quot;,</span>
<a href="#l21.18"></a><span id="l21.18" class="difflineplus">+                                       PlacesUIUtils.getFormattedString(&quot;delete.hostname.true&quot;,</span>
<a href="#l21.19"></a><span id="l21.19" class="difflineplus">+                                                                        [gLastHostname]));</span>
<a href="#l21.20"></a><span id="l21.20">         return true;</span>
<a href="#l21.21"></a><span id="l21.21">       }</span>
<a href="#l21.22"></a><span id="l21.22" class="difflineminus">-      gDeleteByHostname.label = PlacesUIUtils.getString(&quot;delete.hostname.false&quot;);</span>
<a href="#l21.23"></a><span id="l21.23" class="difflineplus">+      gDeleteByHostname.setAttribute(&quot;label&quot;,</span>
<a href="#l21.24"></a><span id="l21.24" class="difflineplus">+                                     PlacesUIUtils.getString(&quot;delete.hostname.false&quot;));</span>
<a href="#l21.25"></a><span id="l21.25">       return false;</span>
<a href="#l21.26"></a><span id="l21.26">     case &quot;placesCmd_delete:domain&quot;:</span>
<a href="#l21.27"></a><span id="l21.27" class="difflineminus">-      gDeleteByDomain.accessKey = PlacesUIUtils.getString(&quot;delete.domain.accesskey&quot;);</span>
<a href="#l21.28"></a><span id="l21.28" class="difflineplus">+      gDeleteByDomain.setAttribute(&quot;accesskey&quot;,</span>
<a href="#l21.29"></a><span id="l21.29" class="difflineplus">+                                   PlacesUIUtils.getString(&quot;delete.domain.accesskey&quot;));</span>
<a href="#l21.30"></a><span id="l21.30">       if (gLastDomain) {</span>
<a href="#l21.31"></a><span id="l21.31" class="difflineminus">-        gDeleteByDomain.label = PlacesUIUtils.getFormattedString(&quot;delete.domain.true&quot;, [gLastDomain]);</span>
<a href="#l21.32"></a><span id="l21.32" class="difflineplus">+        gDeleteByDomain.setAttribute(&quot;label&quot;,</span>
<a href="#l21.33"></a><span id="l21.33" class="difflineplus">+                                     PlacesUIUtils.getFormattedString(&quot;delete.domain.true&quot;,</span>
<a href="#l21.34"></a><span id="l21.34" class="difflineplus">+                                                                      [gLastDomain]));</span>
<a href="#l21.35"></a><span id="l21.35">         return true;</span>
<a href="#l21.36"></a><span id="l21.36">       }</span>
<a href="#l21.37"></a><span id="l21.37" class="difflineminus">-      gDeleteByDomain.label = PlacesUIUtils.getString(&quot;delete.domain.false&quot;);</span>
<a href="#l21.38"></a><span id="l21.38" class="difflineplus">+      gDeleteByDomain.setAttribute(&quot;label&quot;,</span>
<a href="#l21.39"></a><span id="l21.39" class="difflineplus">+                                   PlacesUIUtils.getString(&quot;delete.domain.false&quot;));</span>
<a href="#l21.40"></a><span id="l21.40">       return false;</span>
<a href="#l21.41"></a><span id="l21.41">     default:</span>
<a href="#l21.42"></a><span id="l21.42">       return false;</span>
<a href="#l21.43"></a><span id="l21.43">     }</span>
<a href="#l21.44"></a><span id="l21.44">   },</span>
<a href="#l21.45"></a><span id="l21.45"> </span>
<a href="#l21.46"></a><span id="l21.46">   doCommand: function PC_doCommand(aCommand) {</span>
<a href="#l21.47"></a><span id="l21.47">     switch (aCommand) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/suite/common/history/history-panel.xul</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/suite/common/history/history-panel.xul</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -78,16 +78,17 @@</span>
<a href="#l22.4"></a><span id="l22.4">     &lt;/toolbarbutton&gt;</span>
<a href="#l22.5"></a><span id="l22.5">   &lt;/hbox&gt;</span>
<a href="#l22.6"></a><span id="l22.6"> </span>
<a href="#l22.7"></a><span id="l22.7">   &lt;tree id=&quot;historyTree&quot;</span>
<a href="#l22.8"></a><span id="l22.8">         class=&quot;sidebar-placesTree plain&quot;</span>
<a href="#l22.9"></a><span id="l22.9">         flex=&quot;1&quot;</span>
<a href="#l22.10"></a><span id="l22.10">         type=&quot;places&quot;</span>
<a href="#l22.11"></a><span id="l22.11">         context=&quot;placesContext&quot;</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineplus">+        onselect=&quot;historyOnSelect();&quot;</span>
<a href="#l22.13"></a><span id="l22.13">         onkeypress=&quot;SidebarUtils.handleTreeKeyPress(event);&quot;</span>
<a href="#l22.14"></a><span id="l22.14">         onclick=&quot;SidebarUtils.handleTreeClick(this, event, true);&quot;</span>
<a href="#l22.15"></a><span id="l22.15">         onmousemove=&quot;SidebarUtils.handleTreeMouseMove(event);&quot;</span>
<a href="#l22.16"></a><span id="l22.16">         onmouseout=&quot;SidebarUtils.clearURLFromStatusBar();&quot;&gt;</span>
<a href="#l22.17"></a><span id="l22.17">     &lt;treecols context=&quot;&quot;&gt;</span>
<a href="#l22.18"></a><span id="l22.18">       &lt;treecol label=&quot;&amp;col.title.label;&quot; id=&quot;Name&quot; flex=&quot;4&quot;</span>
<a href="#l22.19"></a><span id="l22.19">                persist=&quot;width hidden ordinal sortActive sortDirection&quot;/&gt;</span>
<a href="#l22.20"></a><span id="l22.20">       &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/suite/common/history/history.js</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/suite/common/history/history.js</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -49,18 +49,18 @@ var gETLDService;</span>
<a href="#l23.4"></a><span id="l23.4"> var gDeleteByHostname;</span>
<a href="#l23.5"></a><span id="l23.5"> var gDeleteByDomain;</span>
<a href="#l23.6"></a><span id="l23.6"> var gHistoryStatus;</span>
<a href="#l23.7"></a><span id="l23.7"> var gHistoryGrouping = &quot;day&quot;;</span>
<a href="#l23.8"></a><span id="l23.8"> </span>
<a href="#l23.9"></a><span id="l23.9"> function HistoryCommonInit()</span>
<a href="#l23.10"></a><span id="l23.10"> {</span>
<a href="#l23.11"></a><span id="l23.11">   gHistoryTree = document.getElementById(&quot;historyTree&quot;);</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-  gDeleteByHostname = document.getElementById(&quot;menu_deleteByHostname&quot;);</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineminus">-  gDeleteByDomain = document.getElementById(&quot;menu_deleteByDomain&quot;);</span>
<a href="#l23.14"></a><span id="l23.14" class="difflineplus">+  gDeleteByHostname = document.getElementById(&quot;placesCmd_delete:hostname&quot;);</span>
<a href="#l23.15"></a><span id="l23.15" class="difflineplus">+  gDeleteByDomain = document.getElementById(&quot;placesCmd_delete:domain&quot;);</span>
<a href="#l23.16"></a><span id="l23.16">   gHistoryStatus = document.getElementById(&quot;statusbar-display&quot;);</span>
<a href="#l23.17"></a><span id="l23.17">   gSearchBox = document.getElementById(&quot;search-box&quot;);</span>
<a href="#l23.18"></a><span id="l23.18"> </span>
<a href="#l23.19"></a><span id="l23.19">   gPrefService = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l23.20"></a><span id="l23.20">                            .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l23.21"></a><span id="l23.21">   PREF = gPrefService;    // need this for bookmarks.js</span>
<a href="#l23.22"></a><span id="l23.22"> </span>
<a href="#l23.23"></a><span id="l23.23">   try {</span>
<a href="#l23.24"></a><span id="l23.24" class="difflineat">@@ -112,17 +112,18 @@ function historyOnSelect()</span>
<a href="#l23.25"></a><span id="l23.25">           gETLDService =</span>
<a href="#l23.26"></a><span id="l23.26">             Components.classes[&quot;@mozilla.org/network/effective-tld-service;1&quot;]</span>
<a href="#l23.27"></a><span id="l23.27">                       .getService(Components.interfaces.nsIEffectiveTLDService);</span>
<a href="#l23.28"></a><span id="l23.28">         gLastDomain = gETLDService.getBaseDomainFromHost(gLastHostname);</span>
<a href="#l23.29"></a><span id="l23.29">       } catch (e) {}</span>
<a href="#l23.30"></a><span id="l23.30">     }</span>
<a href="#l23.31"></a><span id="l23.31">   }</span>
<a href="#l23.32"></a><span id="l23.32"> </span>
<a href="#l23.33"></a><span id="l23.33" class="difflineminus">-  gHistoryStatus.label = url;</span>
<a href="#l23.34"></a><span id="l23.34" class="difflineplus">+  if (gHistoryStatus)</span>
<a href="#l23.35"></a><span id="l23.35" class="difflineplus">+    gHistoryStatus.label = url;</span>
<a href="#l23.36"></a><span id="l23.36"> </span>
<a href="#l23.37"></a><span id="l23.37">   updateHistoryCommands();</span>
<a href="#l23.38"></a><span id="l23.38"> }</span>
<a href="#l23.39"></a><span id="l23.39"> </span>
<a href="#l23.40"></a><span id="l23.40"> function UpdateViewColumns(aMenuItem)</span>
<a href="#l23.41"></a><span id="l23.41"> {</span>
<a href="#l23.42"></a><span id="l23.42">   while (aMenuItem) {</span>
<a href="#l23.43"></a><span id="l23.43">     // Each menuitem should be checked if its column is not hidden.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/suite/common/history/history.xul</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/suite/common/history/history.xul</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -75,20 +75,17 @@</span>
<a href="#l24.4"></a><span id="l24.4">              oncommand=&quot;focusElement(gSearchBox);&quot;/&gt;</span>
<a href="#l24.5"></a><span id="l24.5">   &lt;/commandset&gt;</span>
<a href="#l24.6"></a><span id="l24.6">   &lt;commandset id=&quot;selectEditMenuItems&quot;&gt;</span>
<a href="#l24.7"></a><span id="l24.7">     &lt;command id=&quot;cmd_cut&quot;/&gt;</span>
<a href="#l24.8"></a><span id="l24.8">     &lt;command id=&quot;cmd_copy&quot;/&gt;</span>
<a href="#l24.9"></a><span id="l24.9">     &lt;command id=&quot;cmd_delete&quot;/&gt;</span>
<a href="#l24.10"></a><span id="l24.10">     &lt;command id=&quot;cmd_selectAll&quot;/&gt;</span>
<a href="#l24.11"></a><span id="l24.11">   &lt;/commandset&gt;</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-  &lt;commandset id=&quot;placesCommands&quot;&gt;</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineminus">-    &lt;command id=&quot;placesCmd_delete:hostname&quot; oncommand=&quot;goDoCommand('placesCmd_delete:hostname');&quot;/&gt;</span>
<a href="#l24.14"></a><span id="l24.14" class="difflineminus">-    &lt;command id=&quot;placesCmd_delete:domain&quot; oncommand=&quot;goDoCommand('placesCmd_delete:domain');&quot;/&gt;</span>
<a href="#l24.15"></a><span id="l24.15" class="difflineminus">-  &lt;/commandset&gt;</span>
<a href="#l24.16"></a><span id="l24.16" class="difflineplus">+  &lt;commandset id=&quot;placesCommands&quot;/&gt;</span>
<a href="#l24.17"></a><span id="l24.17"> </span>
<a href="#l24.18"></a><span id="l24.18">   &lt;broadcaster id=&quot;Communicator:WorkMode&quot;/&gt;</span>
<a href="#l24.19"></a><span id="l24.19"> </span>
<a href="#l24.20"></a><span id="l24.20">   &lt;keyset id=&quot;tasksKeys&quot;&gt;</span>
<a href="#l24.21"></a><span id="l24.21">     &lt;!-- File Menu --&gt;</span>
<a href="#l24.22"></a><span id="l24.22">     &lt;key id=&quot;key_close&quot;/&gt;</span>
<a href="#l24.23"></a><span id="l24.23">     &lt;key id=&quot;key_quit&quot;/&gt;</span>
<a href="#l24.24"></a><span id="l24.24">     &lt;!-- Edit Menu --&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/suite/common/history/placesOverlay.xul</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/suite/common/history/placesOverlay.xul</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -73,16 +73,20 @@</span>
<a href="#l25.4"></a><span id="l25.4">               events=&quot;focus,sort&quot;</span>
<a href="#l25.5"></a><span id="l25.5">               oncommandupdate=&quot;updateHistoryCommands(this.firstChild);&quot;&gt;</span>
<a href="#l25.6"></a><span id="l25.6">     &lt;command id=&quot;placesCmd_open&quot;</span>
<a href="#l25.7"></a><span id="l25.7">              oncommand=&quot;goDoCommand('placesCmd_open');&quot;/&gt;</span>
<a href="#l25.8"></a><span id="l25.8">     &lt;command id=&quot;placesCmd_open:window&quot;</span>
<a href="#l25.9"></a><span id="l25.9">              oncommand=&quot;goDoCommand('placesCmd_open:window');&quot;/&gt;</span>
<a href="#l25.10"></a><span id="l25.10">     &lt;command id=&quot;placesCmd_open:tab&quot;</span>
<a href="#l25.11"></a><span id="l25.11">              oncommand=&quot;goDoCommand('placesCmd_open:tab');&quot;/&gt;</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineplus">+    &lt;command id=&quot;placesCmd_delete:hostname&quot;</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineplus">+             oncommand=&quot;goDoCommand('placesCmd_delete:hostname');&quot;/&gt;</span>
<a href="#l25.14"></a><span id="l25.14" class="difflineplus">+    &lt;command id=&quot;placesCmd_delete:domain&quot;</span>
<a href="#l25.15"></a><span id="l25.15" class="difflineplus">+             oncommand=&quot;goDoCommand('placesCmd_delete:domain');&quot;/&gt;</span>
<a href="#l25.16"></a><span id="l25.16">   &lt;/commandset&gt;</span>
<a href="#l25.17"></a><span id="l25.17"> </span>
<a href="#l25.18"></a><span id="l25.18">   &lt;popup id=&quot;placesContext&quot;</span>
<a href="#l25.19"></a><span id="l25.19">          onpopupshowing=&quot;this._view = PlacesUIUtils.getViewForNode(document.popupNode);</span>
<a href="#l25.20"></a><span id="l25.20">                          return this._view.buildContextMenu(this);&quot;</span>
<a href="#l25.21"></a><span id="l25.21">          onpopuphiding=&quot;this._view.destroyContextMenu();&quot;&gt;</span>
<a href="#l25.22"></a><span id="l25.22">     &lt;menuitem id=&quot;placesContext_open&quot;</span>
<a href="#l25.23"></a><span id="l25.23">               command=&quot;placesCmd_open&quot;</span>
<a href="#l25.24"></a><span id="l25.24" class="difflineat">@@ -120,16 +124,22 @@</span>
<a href="#l25.25"></a><span id="l25.25">               accesskey=&quot;&amp;copyCmd.accesskey;&quot;</span>
<a href="#l25.26"></a><span id="l25.26">               selection=&quot;any&quot;/&gt;</span>
<a href="#l25.27"></a><span id="l25.27">     &lt;menuseparator id=&quot;placesContext_editSeparator&quot;/&gt;</span>
<a href="#l25.28"></a><span id="l25.28">     &lt;menuitem id=&quot;placesContext_delete&quot;</span>
<a href="#l25.29"></a><span id="l25.29">               command=&quot;cmd_delete&quot;</span>
<a href="#l25.30"></a><span id="l25.30">               label=&quot;&amp;deleteCmd.label;&quot;</span>
<a href="#l25.31"></a><span id="l25.31">               accesskey=&quot;&amp;deleteCmd.accesskey;&quot;</span>
<a href="#l25.32"></a><span id="l25.32">               selection=&quot;link|host|day&quot;/&gt;</span>
<a href="#l25.33"></a><span id="l25.33" class="difflineplus">+    &lt;menuitem id=&quot;placesContext_deleteByHostname&quot;</span>
<a href="#l25.34"></a><span id="l25.34" class="difflineplus">+              command=&quot;placesCmd_delete:hostname&quot;</span>
<a href="#l25.35"></a><span id="l25.35" class="difflineplus">+              selection=&quot;link|host&quot;/&gt;</span>
<a href="#l25.36"></a><span id="l25.36" class="difflineplus">+    &lt;menuitem id=&quot;placesContext_deleteByDomain&quot;</span>
<a href="#l25.37"></a><span id="l25.37" class="difflineplus">+              command=&quot;placesCmd_delete:domain&quot;</span>
<a href="#l25.38"></a><span id="l25.38" class="difflineplus">+              selection=&quot;link|host&quot;/&gt;</span>
<a href="#l25.39"></a><span id="l25.39">     &lt;menuitem id=&quot;placesContext_selectAll&quot;</span>
<a href="#l25.40"></a><span id="l25.40">               command=&quot;cmd_selectAll&quot;</span>
<a href="#l25.41"></a><span id="l25.41">               label=&quot;&amp;selectAllCmd.label;&quot;</span>
<a href="#l25.42"></a><span id="l25.42">               accesskey=&quot;&amp;selectAllCmd.accesskey;&quot;</span>
<a href="#l25.43"></a><span id="l25.43">               selection=&quot;any&quot;/&gt;</span>
<a href="#l25.44"></a><span id="l25.44">   &lt;/popup&gt;</span>
<a href="#l25.45"></a><span id="l25.45"> </span>
<a href="#l25.46"></a><span id="l25.46">   &lt;menupopup id=&quot;viewPopup&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/suite/mailnews/mailWidgets.xml</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/suite/mailnews/mailWidgets.xml</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -1682,18 +1682,17 @@</span>
<a href="#l26.4"></a><span id="l26.4">           })</span>
<a href="#l26.5"></a><span id="l26.5">         ]]&gt;</span>
<a href="#l26.6"></a><span id="l26.6">       &lt;/field&gt;</span>
<a href="#l26.7"></a><span id="l26.7">       &lt;method name=&quot;setInitialSelection&quot;&gt;</span>
<a href="#l26.8"></a><span id="l26.8">         &lt;body&gt;</span>
<a href="#l26.9"></a><span id="l26.9">           &lt;![CDATA[</span>
<a href="#l26.10"></a><span id="l26.10">             var view = this.tree.view;</span>
<a href="#l26.11"></a><span id="l26.11"> </span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-            if (!view.selection.currentColumn)</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineminus">-              view.selection.currentColumn = this.tree.columns.getFirstColumn();</span>
<a href="#l26.14"></a><span id="l26.14" class="difflineplus">+            view.selection.currentColumn = this.tree.columns.getFirstColumn();</span>
<a href="#l26.15"></a><span id="l26.15"> </span>
<a href="#l26.16"></a><span id="l26.16">             view.selection.selectEventsSuppressed = true;</span>
<a href="#l26.17"></a><span id="l26.17">             for (var i = 0; i &lt; view.rowCount; i++) {</span>
<a href="#l26.18"></a><span id="l26.18">               if (view.isContainer(i)) {</span>
<a href="#l26.19"></a><span id="l26.19">                 if (view.isContainerEmpty(i) == view.isContainerOpen(i))</span>
<a href="#l26.20"></a><span id="l26.20">                   view.toggleOpenState(i);</span>
<a href="#l26.21"></a><span id="l26.21">                 if (view.isContainerOpen(i)) {</span>
<a href="#l26.22"></a><span id="l26.22">                   if (i + 1 == view.rowCount ||</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/suite/mailnews/mailWindowOverlay.xul</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/suite/mailnews/mailWindowOverlay.xul</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -1155,17 +1155,17 @@</span>
<a href="#l27.4"></a><span id="l27.4">                     checked=&quot;true&quot;</span>
<a href="#l27.5"></a><span id="l27.5">                     label=&quot;&amp;showMessengerToolbarCmd.label;&quot;</span>
<a href="#l27.6"></a><span id="l27.6">                     accesskey=&quot;&amp;showMessengerToolbarCmd.accesskey;&quot;</span>
<a href="#l27.7"></a><span id="l27.7">                     oncommand=&quot;goToggleToolbar('msgToolbar', 'menu_showMessengerToolbar')&quot;/&gt;</span>
<a href="#l27.8"></a><span id="l27.8">           &lt;menuitem id=&quot;menu_showLocationToolbar&quot;</span>
<a href="#l27.9"></a><span id="l27.9">                     type=&quot;checkbox&quot;</span>
<a href="#l27.10"></a><span id="l27.10">                     label=&quot;&amp;showLocationToolbarCmd.label;&quot;</span>
<a href="#l27.11"></a><span id="l27.11">                     accesskey=&quot;&amp;showLocationToolbarCmd.accesskey;&quot;</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-                    oncommand=&quot;goToggleLocationToolbar('true');&quot;</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineplus">+                    oncommand=&quot;goToggleToolbar('msgLocationToolbar', 'menu_showLocationToolbar');&quot;</span>
<a href="#l27.14"></a><span id="l27.14">                     observes=&quot;mailHideMenus&quot;</span>
<a href="#l27.15"></a><span id="l27.15">                     checked=&quot;false&quot; persist=&quot;checked&quot;/&gt;</span>
<a href="#l27.16"></a><span id="l27.16">           &lt;menuitem id=&quot;menu_showSearchToolbar&quot;</span>
<a href="#l27.17"></a><span id="l27.17">                     type=&quot;checkbox&quot;</span>
<a href="#l27.18"></a><span id="l27.18">                     checked=&quot;true&quot;</span>
<a href="#l27.19"></a><span id="l27.19">                     label=&quot;&amp;showSearchToolbarCmd.label;&quot;</span>
<a href="#l27.20"></a><span id="l27.20">                     accesskey=&quot;&amp;showSearchToolbarCmd.accesskey;&quot;</span>
<a href="#l27.21"></a><span id="l27.21">                     oncommand=&quot;goToggleToolbar('searchBox', 'menu_showSearchToolbar'); SearchBarToggled();&quot;</span>
<a href="#l27.22"></a><span id="l27.22" class="difflineat">@@ -2289,18 +2289,18 @@</span>
<a href="#l27.23"></a><span id="l27.23">                 oncommand=&quot;goClickThrobber('messenger.throbber.url')&quot;</span>
<a href="#l27.24"></a><span id="l27.24">                 tooltiptext=&quot;&amp;throbber.tooltip;&quot;/&gt;</span>
<a href="#l27.25"></a><span id="l27.25">     &lt;/toolbaritem&gt;</span>
<a href="#l27.26"></a><span id="l27.26">   &lt;/toolbarpalette&gt;</span>
<a href="#l27.27"></a><span id="l27.27"> </span>
<a href="#l27.28"></a><span id="l27.28"> &lt;/toolbox&gt;</span>
<a href="#l27.29"></a><span id="l27.29"> </span>
<a href="#l27.30"></a><span id="l27.30"> &lt;toolbar id=&quot;msgLocationToolbar&quot;</span>
<a href="#l27.31"></a><span id="l27.31" class="difflineminus">-         persist=&quot;collapsed&quot;</span>
<a href="#l27.32"></a><span id="l27.32" class="difflineminus">-         collapsed=&quot;true&quot;</span>
<a href="#l27.33"></a><span id="l27.33" class="difflineplus">+         persist=&quot;hidden&quot;</span>
<a href="#l27.34"></a><span id="l27.34" class="difflineplus">+         hidden=&quot;true&quot;</span>
<a href="#l27.35"></a><span id="l27.35">          grippytooltiptext=&quot;&amp;locationToolbar.tooltip;&quot;</span>
<a href="#l27.36"></a><span id="l27.36">          nowindowdrag=&quot;true&quot;&gt;</span>
<a href="#l27.37"></a><span id="l27.37">   &lt;hbox align=&quot;center&quot; context=&quot;folderPaneContext&quot;&gt;</span>
<a href="#l27.38"></a><span id="l27.38">     &lt;image id=&quot;locationIcon&quot; class=&quot;folderMenuItem&quot;/&gt;</span>
<a href="#l27.39"></a><span id="l27.39">     &lt;menulist id=&quot;locationFolders&quot; class=&quot;folderMenuItem&quot;</span>
<a href="#l27.40"></a><span id="l27.40">               label=&quot; &quot; crop=&quot;center&quot;&gt;</span>
<a href="#l27.41"></a><span id="l27.41">       &lt;menupopup id=&quot;locationPopup&quot; height=&quot;400&quot;</span>
<a href="#l27.42"></a><span id="l27.42">                  oncommand=&quot;OnLocationTreeSelect(this);&quot;/&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/suite/mailnews/msgMail3PaneWindow.js</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/suite/mailnews/msgMail3PaneWindow.js</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -1035,22 +1035,21 @@ function UpdateAttachmentCol(aFirstTimeF</span>
<a href="#l28.4"></a><span id="l28.4">   if (aFirstTimeFlag)</span>
<a href="#l28.5"></a><span id="l28.5">     attachmentCol.addEventListener(&quot;DOMAttrModified&quot;, OnAttachmentColAttrModified, false);</span>
<a href="#l28.6"></a><span id="l28.6">   else</span>
<a href="#l28.7"></a><span id="l28.7">     threadTree.treeBoxObject.clearStyleAndImageCaches();</span>
<a href="#l28.8"></a><span id="l28.8"> }</span>
<a href="#l28.9"></a><span id="l28.9"> </span>
<a href="#l28.10"></a><span id="l28.10"> function OnLocationToolbarAttrModified(event)</span>
<a href="#l28.11"></a><span id="l28.11"> {</span>
<a href="#l28.12"></a><span id="l28.12" class="difflineminus">-    if (!/collapsed/.test(event.attrName))</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineplus">+    if (!/collapsed|hidden/.test(event.attrName))</span>
<a href="#l28.14"></a><span id="l28.14">         return;</span>
<a href="#l28.15"></a><span id="l28.15">     var searchBox = document.getElementById(&quot;searchBox&quot;);</span>
<a href="#l28.16"></a><span id="l28.16">     var desiredParent = document.getElementById(&quot;msgLocationToolbar&quot;);</span>
<a href="#l28.17"></a><span id="l28.17" class="difflineminus">-    if (desiredParent.getAttribute(&quot;collapsed&quot;) == &quot;true&quot; ||</span>
<a href="#l28.18"></a><span id="l28.18" class="difflineminus">-        desiredParent.getAttribute(&quot;moz-collapsed&quot;) == &quot;true&quot;)</span>
<a href="#l28.19"></a><span id="l28.19" class="difflineplus">+    if (desiredParent.hidden || desiredParent.collapsed)</span>
<a href="#l28.20"></a><span id="l28.20">         desiredParent = document.getElementById(&quot;searchBoxHolder&quot;);</span>
<a href="#l28.21"></a><span id="l28.21">     if (searchBox.parentNode != desiredParent)</span>
<a href="#l28.22"></a><span id="l28.22">         desiredParent.appendChild(searchBox);</span>
<a href="#l28.23"></a><span id="l28.23"> }</span>
<a href="#l28.24"></a><span id="l28.24"> </span>
<a href="#l28.25"></a><span id="l28.25"> function OnLoadLocationTree()</span>
<a href="#l28.26"></a><span id="l28.26"> {</span>
<a href="#l28.27"></a><span id="l28.27">     var locationTree = document.getElementById('locationPopup').tree;</span>
<a href="#l28.28"></a><span id="l28.28" class="difflineat">@@ -1090,26 +1089,16 @@ function UpdateLocationBar(resource)</span>
<a href="#l28.29"></a><span id="l28.29">         var name = names[i];</span>
<a href="#l28.30"></a><span id="l28.30">         var value = GetFolderAttribute(tree, resource, name);</span>
<a href="#l28.31"></a><span id="l28.31">         folders.setAttribute(name, value);</span>
<a href="#l28.32"></a><span id="l28.32">         icon.setAttribute(name, value);</span>
<a href="#l28.33"></a><span id="l28.33">     }</span>
<a href="#l28.34"></a><span id="l28.34">     folders.setAttribute('uri', resource.Value);</span>
<a href="#l28.35"></a><span id="l28.35"> }</span>
<a href="#l28.36"></a><span id="l28.36"> </span>
<a href="#l28.37"></a><span id="l28.37" class="difflineminus">-function goToggleLocationToolbar(toggle)</span>
<a href="#l28.38"></a><span id="l28.38" class="difflineminus">-{</span>
<a href="#l28.39"></a><span id="l28.39" class="difflineminus">-    // XXX hidden doesn't work, use collapsed instead</span>
<a href="#l28.40"></a><span id="l28.40" class="difflineminus">-    var menu = document.getElementById(&quot;menu_showLocationToolbar&quot;);</span>
<a href="#l28.41"></a><span id="l28.41" class="difflineminus">-    var toolbar = document.getElementById(&quot;msgLocationToolbar&quot;);</span>
<a href="#l28.42"></a><span id="l28.42" class="difflineminus">-    var checked = toolbar.collapsed;</span>
<a href="#l28.43"></a><span id="l28.43" class="difflineminus">-    menu.setAttribute('checked', checked);</span>
<a href="#l28.44"></a><span id="l28.44" class="difflineminus">-    toolbar.setAttribute('collapsed', !checked);</span>
<a href="#l28.45"></a><span id="l28.45" class="difflineminus">-}</span>
<a href="#l28.46"></a><span id="l28.46" class="difflineminus">-</span>
<a href="#l28.47"></a><span id="l28.47"> function GetFolderDatasource()</span>
<a href="#l28.48"></a><span id="l28.48"> {</span>
<a href="#l28.49"></a><span id="l28.49">   return GetFolderTree().database;</span>
<a href="#l28.50"></a><span id="l28.50"> }</span>
<a href="#l28.51"></a><span id="l28.51"> </span>
<a href="#l28.52"></a><span id="l28.52"> /* Functions for accessing particular parts of the window*/</span>
<a href="#l28.53"></a><span id="l28.53"> function GetFolderTree()</span>
<a href="#l28.54"></a><span id="l28.54"> {</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

