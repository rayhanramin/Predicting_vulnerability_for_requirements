<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 24193:7287778fe124b1e2192abc3cea6b4b1f19ecadfa</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 7287778fe124b1e2192abc3cea6b4b1f19ecadfa" />
<meta property="og:url" content="/comm-central/rev/7287778fe124b1e2192abc3cea6b4b1f19ecadfa" />
<meta property="og:description" content="Bug 1448808 - Implement legacy overlay loader for WebExtensions. r=darktrojan" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 7287778fe124b1e2192abc3cea6b4b1f19ecadfa 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/7287778fe124b1e2192abc3cea6b4b1f19ecadfa">shortlog</a> |
<a href="/comm-central/log/7287778fe124b1e2192abc3cea6b4b1f19ecadfa">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/7287778fe124b1e2192abc3cea6b4b1f19ecadfa">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/7287778fe124b1e2192abc3cea6b4b1f19ecadfa">files</a> |
changeset |
<a href="/comm-central/raw-rev/7287778fe124b1e2192abc3cea6b4b1f19ecadfa">raw</a>  | <a href="/comm-central/archive/7287778fe124b1e2192abc3cea6b4b1f19ecadfa.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1448808">Bug 1448808</a> - Implement legacy overlay loader for WebExtensions. r=darktrojan
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#80;&#104;&#105;&#108;&#105;&#112;&#112;&#32;&#75;&#101;&#119;&#105;&#115;&#99;&#104;&#32;&#60;&#109;&#111;&#122;&#105;&#108;&#108;&#97;&#64;&#107;&#101;&#119;&#105;&#115;&#46;&#99;&#104;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 20 Apr 2018 22:29:47 +0200</td></tr>

<tr>
 <td>changeset 24193</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/7287778fe124b1e2192abc3cea6b4b1f19ecadfa">7287778fe124b1e2192abc3cea6b4b1f19ecadfa</a></td>
</tr>



<tr>
<td>parent 24192</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/594a5cf482d73dc5f4ae0a9868433570ebf6b23d">594a5cf482d73dc5f4ae0a9868433570ebf6b23d</a>
</td>
</tr>

<tr>
<td>child 24194</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/509c442a3700e156c7391b659560425335019904">509c442a3700e156c7391b659560425335019904</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=7287778fe124b1e2192abc3cea6b4b1f19ecadfa">14580</a></td></tr>
<tr><td>push user</td><td>geoff@darktrojan.net</td></tr>
<tr><td>push date</td><td class="date age">Mon, 02 Jul 2018 23:55:52 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@7287778fe124 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=7287778fe124b1e2192abc3cea6b4b1f19ecadfa">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=7287778fe124b1e2192abc3cea6b4b1f19ecadfa&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=7287778fe124b1e2192abc3cea6b4b1f19ecadfa&newProject=comm-central&newRevision=7287778fe124b1e2192abc3cea6b4b1f19ecadfa&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=7287778fe124b1e2192abc3cea6b4b1f19ecadfa&newProject=comm-central&newRevision=7287778fe124b1e2192abc3cea6b4b1f19ecadfa&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=7287778fe124b1e2192abc3cea6b4b1f19ecadfa&newProject=comm-central&newRevision=7287778fe124b1e2192abc3cea6b4b1f19ecadfa&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28darktrojan%29&revcount=50">darktrojan</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1448808">1448808</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1448808">Bug 1448808</a> - Implement legacy overlay loader for WebExtensions. r=darktrojan

MozReview-Commit-ID: 5Ke6q3bZK8Z</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/.eslintrc.js">common/.eslintrc.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/.eslintrc.js">file</a> |
<a href="/comm-central/annotate/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/.eslintrc.js">annotate</a> |
<a href="/comm-central/diff/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/.eslintrc.js">diff</a> |
<a href="/comm-central/comparison/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/.eslintrc.js">comparison</a> |
<a href="/comm-central/log/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/.eslintrc.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/moz.build">common/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/moz.build">file</a> |
<a href="/comm-central/annotate/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/moz.build">annotate</a> |
<a href="/comm-central/diff/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/moz.build">diff</a> |
<a href="/comm-central/comparison/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/moz.build">comparison</a> |
<a href="/comm-central/log/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/moz.build">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/public/moz.build">common/public/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/public/moz.build">file</a> |
<a href="/comm-central/annotate/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/public/moz.build">annotate</a> |
<a href="/comm-central/diff/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/public/moz.build">diff</a> |
<a href="/comm-central/comparison/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/public/moz.build">comparison</a> |
<a href="/comm-central/log/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/public/moz.build">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/public/nsCommonBaseCID.h">common/public/nsCommonBaseCID.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/public/nsCommonBaseCID.h">file</a> |
<a href="/comm-central/annotate/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/public/nsCommonBaseCID.h">annotate</a> |
<a href="/comm-central/diff/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/public/nsCommonBaseCID.h">diff</a> |
<a href="/comm-central/comparison/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/public/nsCommonBaseCID.h">comparison</a> |
<a href="/comm-central/log/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/public/nsCommonBaseCID.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/public/nsIComponentManagerExtra.idl">common/public/nsIComponentManagerExtra.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/public/nsIComponentManagerExtra.idl">file</a> |
<a href="/comm-central/annotate/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/public/nsIComponentManagerExtra.idl">annotate</a> |
<a href="/comm-central/diff/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/public/nsIComponentManagerExtra.idl">diff</a> |
<a href="/comm-central/comparison/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/public/nsIComponentManagerExtra.idl">comparison</a> |
<a href="/comm-central/log/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/public/nsIComponentManagerExtra.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/src/ChromeManifest.jsm">common/src/ChromeManifest.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/src/ChromeManifest.jsm">file</a> |
<a href="/comm-central/annotate/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/src/ChromeManifest.jsm">annotate</a> |
<a href="/comm-central/diff/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/src/ChromeManifest.jsm">diff</a> |
<a href="/comm-central/comparison/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/src/ChromeManifest.jsm">comparison</a> |
<a href="/comm-central/log/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/src/ChromeManifest.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/src/Overlays.jsm">common/src/Overlays.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/src/Overlays.jsm">file</a> |
<a href="/comm-central/annotate/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/src/Overlays.jsm">annotate</a> |
<a href="/comm-central/diff/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/src/Overlays.jsm">diff</a> |
<a href="/comm-central/comparison/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/src/Overlays.jsm">comparison</a> |
<a href="/comm-central/log/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/src/Overlays.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/src/extensionSupport.jsm">common/src/extensionSupport.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/src/extensionSupport.jsm">file</a> |
<a href="/comm-central/annotate/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/src/extensionSupport.jsm">annotate</a> |
<a href="/comm-central/diff/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/src/extensionSupport.jsm">diff</a> |
<a href="/comm-central/comparison/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/src/extensionSupport.jsm">comparison</a> |
<a href="/comm-central/log/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/src/extensionSupport.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/src/moz.build">common/src/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/src/moz.build">file</a> |
<a href="/comm-central/annotate/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/src/moz.build">annotate</a> |
<a href="/comm-central/diff/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/src/moz.build">diff</a> |
<a href="/comm-central/comparison/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/src/moz.build">comparison</a> |
<a href="/comm-central/log/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/src/moz.build">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/src/nsCommonModule.cpp">common/src/nsCommonModule.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/src/nsCommonModule.cpp">file</a> |
<a href="/comm-central/annotate/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/src/nsCommonModule.cpp">annotate</a> |
<a href="/comm-central/diff/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/src/nsCommonModule.cpp">diff</a> |
<a href="/comm-central/comparison/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/src/nsCommonModule.cpp">comparison</a> |
<a href="/comm-central/log/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/src/nsCommonModule.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/src/nsComponentManagerExtra.cpp">common/src/nsComponentManagerExtra.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/src/nsComponentManagerExtra.cpp">file</a> |
<a href="/comm-central/annotate/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/src/nsComponentManagerExtra.cpp">annotate</a> |
<a href="/comm-central/diff/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/src/nsComponentManagerExtra.cpp">diff</a> |
<a href="/comm-central/comparison/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/src/nsComponentManagerExtra.cpp">comparison</a> |
<a href="/comm-central/log/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/src/nsComponentManagerExtra.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/src/nsComponentManagerExtra.h">common/src/nsComponentManagerExtra.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/src/nsComponentManagerExtra.h">file</a> |
<a href="/comm-central/annotate/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/src/nsComponentManagerExtra.h">annotate</a> |
<a href="/comm-central/diff/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/src/nsComponentManagerExtra.h">diff</a> |
<a href="/comm-central/comparison/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/src/nsComponentManagerExtra.h">comparison</a> |
<a href="/comm-central/log/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/common/src/nsComponentManagerExtra.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/mail/base/content/extensions.xml">mail/base/content/extensions.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/mail/base/content/extensions.xml">file</a> |
<a href="/comm-central/annotate/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/mail/base/content/extensions.xml">annotate</a> |
<a href="/comm-central/diff/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/mail/base/content/extensions.xml">diff</a> |
<a href="/comm-central/comparison/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/mail/base/content/extensions.xml">comparison</a> |
<a href="/comm-central/log/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/mail/base/content/extensions.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/mail/base/content/extensionsOverlay.css">mail/base/content/extensionsOverlay.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/mail/base/content/extensionsOverlay.css">file</a> |
<a href="/comm-central/annotate/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/mail/base/content/extensionsOverlay.css">annotate</a> |
<a href="/comm-central/diff/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/mail/base/content/extensionsOverlay.css">diff</a> |
<a href="/comm-central/comparison/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/mail/base/content/extensionsOverlay.css">comparison</a> |
<a href="/comm-central/log/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/mail/base/content/extensionsOverlay.css">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/mail/base/jar.mn">mail/base/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/mail/base/jar.mn">file</a> |
<a href="/comm-central/annotate/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/mail/base/jar.mn">annotate</a> |
<a href="/comm-central/diff/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/mail/base/jar.mn">diff</a> |
<a href="/comm-central/comparison/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/mail/base/jar.mn">comparison</a> |
<a href="/comm-central/log/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/mail/base/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/mail/components/extensions/ext-mail.json">mail/components/extensions/ext-mail.json</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/mail/components/extensions/ext-mail.json">file</a> |
<a href="/comm-central/annotate/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/mail/components/extensions/ext-mail.json">annotate</a> |
<a href="/comm-central/diff/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/mail/components/extensions/ext-mail.json">diff</a> |
<a href="/comm-central/comparison/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/mail/components/extensions/ext-mail.json">comparison</a> |
<a href="/comm-central/log/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/mail/components/extensions/ext-mail.json">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/mail/components/extensions/jar.mn">mail/components/extensions/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/mail/components/extensions/jar.mn">file</a> |
<a href="/comm-central/annotate/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/mail/components/extensions/jar.mn">annotate</a> |
<a href="/comm-central/diff/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/mail/components/extensions/jar.mn">diff</a> |
<a href="/comm-central/comparison/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/mail/components/extensions/jar.mn">comparison</a> |
<a href="/comm-central/log/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/mail/components/extensions/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/mail/components/extensions/parent/ext-legacy.js">mail/components/extensions/parent/ext-legacy.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/mail/components/extensions/parent/ext-legacy.js">file</a> |
<a href="/comm-central/annotate/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/mail/components/extensions/parent/ext-legacy.js">annotate</a> |
<a href="/comm-central/diff/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/mail/components/extensions/parent/ext-legacy.js">diff</a> |
<a href="/comm-central/comparison/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/mail/components/extensions/parent/ext-legacy.js">comparison</a> |
<a href="/comm-central/log/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/mail/components/extensions/parent/ext-legacy.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/mail/components/extensions/schemas/legacy.json">mail/components/extensions/schemas/legacy.json</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/mail/components/extensions/schemas/legacy.json">file</a> |
<a href="/comm-central/annotate/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/mail/components/extensions/schemas/legacy.json">annotate</a> |
<a href="/comm-central/diff/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/mail/components/extensions/schemas/legacy.json">diff</a> |
<a href="/comm-central/comparison/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/mail/components/extensions/schemas/legacy.json">comparison</a> |
<a href="/comm-central/log/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/mail/components/extensions/schemas/legacy.json">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/mail/locales/en-US/chrome/messenger/extensionsOverlay.properties">mail/locales/en-US/chrome/messenger/extensionsOverlay.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/mail/locales/en-US/chrome/messenger/extensionsOverlay.properties">file</a> |
<a href="/comm-central/annotate/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/mail/locales/en-US/chrome/messenger/extensionsOverlay.properties">annotate</a> |
<a href="/comm-central/diff/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/mail/locales/en-US/chrome/messenger/extensionsOverlay.properties">diff</a> |
<a href="/comm-central/comparison/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/mail/locales/en-US/chrome/messenger/extensionsOverlay.properties">comparison</a> |
<a href="/comm-central/log/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/mail/locales/en-US/chrome/messenger/extensionsOverlay.properties">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/mail/moz.build">mail/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/mail/moz.build">file</a> |
<a href="/comm-central/annotate/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/mail/moz.build">annotate</a> |
<a href="/comm-central/diff/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/mail/moz.build">diff</a> |
<a href="/comm-central/comparison/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/mail/moz.build">comparison</a> |
<a href="/comm-central/log/7287778fe124b1e2192abc3cea6b4b1f19ecadfa/mail/moz.build">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/common/.eslintrc.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/common/.eslintrc.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -1,10 +1,15 @@</span>
<a href="#l1.4"></a><span id="l1.4"> &quot;use strict&quot;;</span>
<a href="#l1.5"></a><span id="l1.5"> </span>
<a href="#l1.6"></a><span id="l1.6"> module.exports = {</span>
<a href="#l1.7"></a><span id="l1.7">   &quot;rules&quot;: {</span>
<a href="#l1.8"></a><span id="l1.8">     // Don't Disallow Undeclared Variables (for now).</span>
<a href="#l1.9"></a><span id="l1.9">     // The linter does not see many globals from imported files</span>
<a href="#l1.10"></a><span id="l1.10">     // and .xul linked .js files, so there are too many false positives.</span>
<a href="#l1.11"></a><span id="l1.11">     &quot;no-undef&quot;: &quot;off&quot;,</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+    // Require spaces around operators, except for a|0.</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+    // Disabled for now given eslint doesn't support default args yet</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+    // &quot;space-infix-ops&quot;: [2, { &quot;int32Hint&quot;: true }],</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+    &quot;space-infix-ops&quot;: 0,</span>
<a href="#l1.17"></a><span id="l1.17">   },</span>
<a href="#l1.18"></a><span id="l1.18"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1">new file mode 100644</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineminus">--- /dev/null</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineplus">+++ b/common/moz.build</span>
<a href="#l2.4"></a><span id="l2.4" class="difflineat">@@ -0,0 +1,9 @@</span>
<a href="#l2.5"></a><span id="l2.5" class="difflineplus">+# vim: set filetype=python:</span>
<a href="#l2.6"></a><span id="l2.6" class="difflineplus">+# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l2.7"></a><span id="l2.7" class="difflineplus">+# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l2.8"></a><span id="l2.8" class="difflineplus">+# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l2.9"></a><span id="l2.9" class="difflineplus">+</span>
<a href="#l2.10"></a><span id="l2.10" class="difflineplus">+DIRS += [</span>
<a href="#l2.11"></a><span id="l2.11" class="difflineplus">+    'public',</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+    'src'</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1">new file mode 100644</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineminus">--- /dev/null</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineplus">+++ b/common/public/moz.build</span>
<a href="#l3.4"></a><span id="l3.4" class="difflineat">@@ -0,0 +1,14 @@</span>
<a href="#l3.5"></a><span id="l3.5" class="difflineplus">+# vim: set filetype=python:</span>
<a href="#l3.6"></a><span id="l3.6" class="difflineplus">+# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l3.7"></a><span id="l3.7" class="difflineplus">+# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l3.8"></a><span id="l3.8" class="difflineplus">+# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l3.9"></a><span id="l3.9" class="difflineplus">+</span>
<a href="#l3.10"></a><span id="l3.10" class="difflineplus">+XPIDL_SOURCES += [</span>
<a href="#l3.11"></a><span id="l3.11" class="difflineplus">+    'nsIComponentManagerExtra.idl'</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+]</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+XPIDL_MODULE = 'msgcommonbase'</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+EXPORTS += [</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+    'nsCommonBaseCID.h'</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1">new file mode 100644</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineminus">--- /dev/null</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineplus">+++ b/common/public/nsCommonBaseCID.h</span>
<a href="#l4.4"></a><span id="l4.4" class="difflineat">@@ -0,0 +1,21 @@</span>
<a href="#l4.5"></a><span id="l4.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l4.6"></a><span id="l4.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l4.7"></a><span id="l4.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l4.8"></a><span id="l4.8" class="difflineplus">+</span>
<a href="#l4.9"></a><span id="l4.9" class="difflineplus">+#ifndef nsgCommonBaseCID_h__</span>
<a href="#l4.10"></a><span id="l4.10" class="difflineplus">+#define nsgCommonBaseCID_h__</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineplus">+</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+#include &quot;nsISupports.h&quot;</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+#include &quot;nsIFactory.h&quot;</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+#include &quot;nsIComponentManager.h&quot;</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+// nsComponentManagerExtra</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+#define NS_COMPONENTMANAGEREXTRA_CONTRACTID \</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+  &quot;@mozilla.org/component-manager-extra;1&quot;</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+#define NS_COMPONENTMANAGEREXTRA_CID \</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+{ /* b4359b53-3060-46ff-ad42-e67eea6ccf59 */ \</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+ 0xb4359b53, 0x3060, 0x46ff, \</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+ {0xad, 0x42, 0xe6, 0x7e, 0xea, 0x6c, 0xcf, 0x59}}</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+#endif // nsCommonBaseCID_h__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1">new file mode 100644</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineminus">--- /dev/null</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineplus">+++ b/common/public/nsIComponentManagerExtra.idl</span>
<a href="#l5.4"></a><span id="l5.4" class="difflineat">@@ -0,0 +1,22 @@</span>
<a href="#l5.5"></a><span id="l5.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l5.6"></a><span id="l5.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l5.7"></a><span id="l5.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l5.8"></a><span id="l5.8" class="difflineplus">+</span>
<a href="#l5.9"></a><span id="l5.9" class="difflineplus">+#include &quot;nsISupports.idl&quot;</span>
<a href="#l5.10"></a><span id="l5.10" class="difflineplus">+</span>
<a href="#l5.11"></a><span id="l5.11" class="difflineplus">+interface nsIFile;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+/**</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+ * Some additional methods in the same style as nsIComponentManager</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+ */</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+[scriptable, uuid(fe5948c1-458a-464f-9251-310f8535a34c)]</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+interface nsIComponentManagerExtra : nsISupports</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+{</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+    /**</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+     * Register an extension manifest. This is either the path to the unpacked extension folder, or</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineplus">+     * the path to the xpi file.</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineplus">+     *</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineplus">+     * @param {nsIFile} aLocation       The file pointing to the extension root</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineplus">+     */</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineplus">+    void addLegacyExtensionManifestLocation(in nsIFile aLocation);</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1">new file mode 100644</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineminus">--- /dev/null</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineplus">+++ b/common/src/ChromeManifest.jsm</span>
<a href="#l6.4"></a><span id="l6.4" class="difflineat">@@ -0,0 +1,326 @@</span>
<a href="#l6.5"></a><span id="l6.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l6.6"></a><span id="l6.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l6.7"></a><span id="l6.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l6.8"></a><span id="l6.8" class="difflineplus">+</span>
<a href="#l6.9"></a><span id="l6.9" class="difflineplus">+this.EXPORTED_SYMBOLS = [&quot;ChromeManifest&quot;];</span>
<a href="#l6.10"></a><span id="l6.10" class="difflineplus">+</span>
<a href="#l6.11"></a><span id="l6.11" class="difflineplus">+/**</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+ * A parser for chrome.manifest files. Implements a subset of</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+ * https://developer.mozilla.org/en-US/docs/Mozilla/Chrome_Registration</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+ */</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+class ChromeManifest {</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+  /**</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+   * Constucts the chrome.manifest parser</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+   *</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+   * @param {Function} loader           An asynchronous function that will load further files, e.g.</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineplus">+   *                                      those included via the |manifest| instruction. The</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+   *                                      function will take the file as an argument and should</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineplus">+   *                                      resolve with the string contents of that file</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineplus">+   * @param {Object} options            Object describing the current system. The keys are manifest</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineplus">+   *                                      instructions</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineplus">+   */</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineplus">+  constructor(loader, options) {</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineplus">+    this.loader = loader;</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineplus">+    this.options = options;</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineplus">+</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+    this.overlay = new DefaultMap(() =&gt; []);</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+    this.locales = new DefaultMap(() =&gt; new Map());</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+    this.style = new DefaultMap(() =&gt; new Set());</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+    this.category = new DefaultMap(() =&gt; new Map());</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineplus">+    this.component = new Map();</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineplus">+    this.contract = new Map();</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineplus">+</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineplus">+    this.content = new Map();</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineplus">+    this.skin = new Map();</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineplus">+    this.resource = new Map();</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineplus">+    this.override = new Map();</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineplus">+</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineplus">+  }</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineplus">+</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineplus">+</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineplus">+  /**</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineplus">+   * Parse the given file.</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineplus">+   *</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineplus">+   * @param {String} filename           The filename to load</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineplus">+   * @param {String} base               The relative directory this file is expected to be in.</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineplus">+   * @return {Promise}                  Resolved when loading completes</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineplus">+   */</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineplus">+  async parse(filename=&quot;chrome.manifest&quot;, base=&quot;&quot;) {</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineplus">+    await this.parseString(await this.loader(filename), base);</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineplus">+  }</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineplus">+</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineplus">+  /**</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineplus">+   * Parse the given string.</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineplus">+   *</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineplus">+   * @param {String} data               The file data to load</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineplus">+   * @param {String} base               The relative directory this file is expected to be in.</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineplus">+   * @return {Promise}                  Resolved when loading completes</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineplus">+   */</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineplus">+  async parseString(data, base=&quot;&quot;) {</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineplus">+    let lines = data.split(&quot;\n&quot;);</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineplus">+    let extraManifests = [];</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineplus">+    for (let line of lines) {</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineplus">+      let parts = line.split(/\s+/);</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineplus">+      let directive = parts.shift();</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineplus">+      switch (directive) {</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineplus">+        case &quot;manifest&quot;:</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineplus">+          extraManifests.push(this._parseManifest(base, ...parts));</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineplus">+          break;</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineplus">+        case &quot;component&quot;: this._parseComponent(...parts); break;</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineplus">+        case &quot;contract&quot;: this._parseContract(...parts); break;</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineplus">+</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineplus">+        case &quot;category&quot;: this._parseCategory(...parts); break;</span>
<a href="#l6.79"></a><span id="l6.79" class="difflineplus">+        case &quot;content&quot;: this._parseContent(...parts); break;</span>
<a href="#l6.80"></a><span id="l6.80" class="difflineplus">+        case &quot;locale&quot;: this._parseLocale(...parts); break;</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineplus">+        case &quot;skin&quot;: this._parseSkin(...parts); break;</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineplus">+        case &quot;resource&quot;: this._parseResource(...parts); break;</span>
<a href="#l6.83"></a><span id="l6.83" class="difflineplus">+</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineplus">+        case &quot;overlay&quot;: this._parseOverlay(...parts); break;</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineplus">+        case &quot;style&quot;: this._parseStyle(...parts); break;</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineplus">+        case &quot;override&quot;: this._parseOverride(...parts); break;</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineplus">+      }</span>
<a href="#l6.88"></a><span id="l6.88" class="difflineplus">+    }</span>
<a href="#l6.89"></a><span id="l6.89" class="difflineplus">+</span>
<a href="#l6.90"></a><span id="l6.90" class="difflineplus">+    await Promise.all(extraManifests);</span>
<a href="#l6.91"></a><span id="l6.91" class="difflineplus">+  }</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineplus">+</span>
<a href="#l6.93"></a><span id="l6.93" class="difflineplus">+  /**</span>
<a href="#l6.94"></a><span id="l6.94" class="difflineplus">+   * Ensure the flags provided for the instruction match our options</span>
<a href="#l6.95"></a><span id="l6.95" class="difflineplus">+   *</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineplus">+   * @param {String[]} flags        An array of raw flag values in the form key=value.</span>
<a href="#l6.97"></a><span id="l6.97" class="difflineplus">+   * @return {Boolean}              True, if the flags match the options provided in the constructor</span>
<a href="#l6.98"></a><span id="l6.98" class="difflineplus">+   */</span>
<a href="#l6.99"></a><span id="l6.99" class="difflineplus">+  _parseFlags(flags) {</span>
<a href="#l6.100"></a><span id="l6.100" class="difflineplus">+    let matchString = (a, sign, b) =&gt; {</span>
<a href="#l6.101"></a><span id="l6.101" class="difflineplus">+      if (sign != &quot;=&quot;) {</span>
<a href="#l6.102"></a><span id="l6.102" class="difflineplus">+        console.warn(`Invalid sign ${sign} in ${a}${sign}${b}, dropping manifest instruction`);</span>
<a href="#l6.103"></a><span id="l6.103" class="difflineplus">+        return false;</span>
<a href="#l6.104"></a><span id="l6.104" class="difflineplus">+      }</span>
<a href="#l6.105"></a><span id="l6.105" class="difflineplus">+      return a == b;</span>
<a href="#l6.106"></a><span id="l6.106" class="difflineplus">+    };</span>
<a href="#l6.107"></a><span id="l6.107" class="difflineplus">+</span>
<a href="#l6.108"></a><span id="l6.108" class="difflineplus">+    let matchVersion = (a, sign, b) =&gt; {</span>
<a href="#l6.109"></a><span id="l6.109" class="difflineplus">+      switch (sign) {</span>
<a href="#l6.110"></a><span id="l6.110" class="difflineplus">+        case &quot;=&quot;: return Services.vc.compare(a, b) == 0;</span>
<a href="#l6.111"></a><span id="l6.111" class="difflineplus">+        case &quot;&gt;&quot;: return Services.vc.compare(a, b) &gt; 0;</span>
<a href="#l6.112"></a><span id="l6.112" class="difflineplus">+        case &quot;&lt;&quot;: return Services.vc.compare(a, b) &lt; 0;</span>
<a href="#l6.113"></a><span id="l6.113" class="difflineplus">+        case &quot;&gt;=&quot;: return Services.vc.compare(a, b) &gt;= 0;</span>
<a href="#l6.114"></a><span id="l6.114" class="difflineplus">+        case &quot;&lt;=&quot;: return Services.vc.compare(a, b) &lt;= 0;</span>
<a href="#l6.115"></a><span id="l6.115" class="difflineplus">+        default:</span>
<a href="#l6.116"></a><span id="l6.116" class="difflineplus">+          console.warn(`Invalid sign ${sign} in ${a}${sign}${b}, dropping manifest instruction`);</span>
<a href="#l6.117"></a><span id="l6.117" class="difflineplus">+          return false;</span>
<a href="#l6.118"></a><span id="l6.118" class="difflineplus">+      }</span>
<a href="#l6.119"></a><span id="l6.119" class="difflineplus">+    };</span>
<a href="#l6.120"></a><span id="l6.120" class="difflineplus">+</span>
<a href="#l6.121"></a><span id="l6.121" class="difflineplus">+    let flagMatches = (key, typeMatch) =&gt; {</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineplus">+      return !flagdata.has(key) || flagdata.get(key).some(val =&gt; typeMatch(this.options[key], ...val));</span>
<a href="#l6.123"></a><span id="l6.123" class="difflineplus">+    };</span>
<a href="#l6.124"></a><span id="l6.124" class="difflineplus">+</span>
<a href="#l6.125"></a><span id="l6.125" class="difflineplus">+    let flagdata = new DefaultMap(() =&gt; []);</span>
<a href="#l6.126"></a><span id="l6.126" class="difflineplus">+</span>
<a href="#l6.127"></a><span id="l6.127" class="difflineplus">+    for (let flag of flags) {</span>
<a href="#l6.128"></a><span id="l6.128" class="difflineplus">+      let match = flag.match(/(\w+)(&gt;=|&lt;=|&lt;|&gt;|=)(.*)/);</span>
<a href="#l6.129"></a><span id="l6.129" class="difflineplus">+      if (match) {</span>
<a href="#l6.130"></a><span id="l6.130" class="difflineplus">+        flagdata.get(match[1]).push([match[2], match[3]]);</span>
<a href="#l6.131"></a><span id="l6.131" class="difflineplus">+      } else {</span>
<a href="#l6.132"></a><span id="l6.132" class="difflineplus">+        console.warn(`Invalid flag ${flag}, dropping manifest instruction`);</span>
<a href="#l6.133"></a><span id="l6.133" class="difflineplus">+      }</span>
<a href="#l6.134"></a><span id="l6.134" class="difflineplus">+    }</span>
<a href="#l6.135"></a><span id="l6.135" class="difflineplus">+</span>
<a href="#l6.136"></a><span id="l6.136" class="difflineplus">+    return flagMatches(&quot;application&quot;, matchString) &amp;&amp;</span>
<a href="#l6.137"></a><span id="l6.137" class="difflineplus">+           flagMatches(&quot;appversion&quot;, matchVersion) &amp;&amp;</span>
<a href="#l6.138"></a><span id="l6.138" class="difflineplus">+           flagMatches(&quot;platformversion&quot;, matchVersion) &amp;&amp;</span>
<a href="#l6.139"></a><span id="l6.139" class="difflineplus">+           flagMatches(&quot;os&quot;, matchString) &amp;&amp;</span>
<a href="#l6.140"></a><span id="l6.140" class="difflineplus">+           flagMatches(&quot;osversion&quot;, matchVersion) &amp;&amp;</span>
<a href="#l6.141"></a><span id="l6.141" class="difflineplus">+           flagMatches(&quot;abi&quot;, matchString);</span>
<a href="#l6.142"></a><span id="l6.142" class="difflineplus">+  }</span>
<a href="#l6.143"></a><span id="l6.143" class="difflineplus">+</span>
<a href="#l6.144"></a><span id="l6.144" class="difflineplus">+  /**</span>
<a href="#l6.145"></a><span id="l6.145" class="difflineplus">+   * Parse the manifest instruction, to load other files</span>
<a href="#l6.146"></a><span id="l6.146" class="difflineplus">+   *</span>
<a href="#l6.147"></a><span id="l6.147" class="difflineplus">+   * @param {String} base       The base directory the manifest file is in</span>
<a href="#l6.148"></a><span id="l6.148" class="difflineplus">+   * @param {String} filename   The file and path to load</span>
<a href="#l6.149"></a><span id="l6.149" class="difflineplus">+   * @param {...String} flags   The flags for this instruction</span>
<a href="#l6.150"></a><span id="l6.150" class="difflineplus">+   * @return {Promise}          Promise resolved when the manifest is loaded</span>
<a href="#l6.151"></a><span id="l6.151" class="difflineplus">+   */</span>
<a href="#l6.152"></a><span id="l6.152" class="difflineplus">+  async _parseManifest(base, filename, ...flags) {</span>
<a href="#l6.153"></a><span id="l6.153" class="difflineplus">+    if (this._parseFlags(flags)) {</span>
<a href="#l6.154"></a><span id="l6.154" class="difflineplus">+      let dirparts = filename.split(&quot;/&quot;);</span>
<a href="#l6.155"></a><span id="l6.155" class="difflineplus">+      dirparts.pop();</span>
<a href="#l6.156"></a><span id="l6.156" class="difflineplus">+</span>
<a href="#l6.157"></a><span id="l6.157" class="difflineplus">+      try {</span>
<a href="#l6.158"></a><span id="l6.158" class="difflineplus">+        await this.parse(filename, base + &quot;/&quot; + dirparts.join(&quot;/&quot;));</span>
<a href="#l6.159"></a><span id="l6.159" class="difflineplus">+      } catch (e) {</span>
<a href="#l6.160"></a><span id="l6.160" class="difflineplus">+        console.log(`Could not read manifest '${base}/${filename}'.`);</span>
<a href="#l6.161"></a><span id="l6.161" class="difflineplus">+      }</span>
<a href="#l6.162"></a><span id="l6.162" class="difflineplus">+    }</span>
<a href="#l6.163"></a><span id="l6.163" class="difflineplus">+    return null;</span>
<a href="#l6.164"></a><span id="l6.164" class="difflineplus">+  }</span>
<a href="#l6.165"></a><span id="l6.165" class="difflineplus">+</span>
<a href="#l6.166"></a><span id="l6.166" class="difflineplus">+  /**</span>
<a href="#l6.167"></a><span id="l6.167" class="difflineplus">+   * Parse the component instruction, to load xpcom components</span>
<a href="#l6.168"></a><span id="l6.168" class="difflineplus">+   *</span>
<a href="#l6.169"></a><span id="l6.169" class="difflineplus">+   * @param {String} classid        The xpcom class id to load</span>
<a href="#l6.170"></a><span id="l6.170" class="difflineplus">+   * @param {String} loction        The file location of this component</span>
<a href="#l6.171"></a><span id="l6.171" class="difflineplus">+   * @param {...String} flags       The flags for this instruction</span>
<a href="#l6.172"></a><span id="l6.172" class="difflineplus">+   */</span>
<a href="#l6.173"></a><span id="l6.173" class="difflineplus">+  _parseComponent(classid, location, ...flags) {</span>
<a href="#l6.174"></a><span id="l6.174" class="difflineplus">+    if (this._parseFlags(flags)) {</span>
<a href="#l6.175"></a><span id="l6.175" class="difflineplus">+      this.component.set(classid, location);</span>
<a href="#l6.176"></a><span id="l6.176" class="difflineplus">+    }</span>
<a href="#l6.177"></a><span id="l6.177" class="difflineplus">+  }</span>
<a href="#l6.178"></a><span id="l6.178" class="difflineplus">+</span>
<a href="#l6.179"></a><span id="l6.179" class="difflineplus">+  /**</span>
<a href="#l6.180"></a><span id="l6.180" class="difflineplus">+   * Parse the contract instruction, to load xpcom contract ids</span>
<a href="#l6.181"></a><span id="l6.181" class="difflineplus">+   *</span>
<a href="#l6.182"></a><span id="l6.182" class="difflineplus">+   * @param {String} contractid     The xpcom contract id to load</span>
<a href="#l6.183"></a><span id="l6.183" class="difflineplus">+   * @param {String} location       The file location of this component</span>
<a href="#l6.184"></a><span id="l6.184" class="difflineplus">+   * @param {...String} flags       The flags for this instruction</span>
<a href="#l6.185"></a><span id="l6.185" class="difflineplus">+   */</span>
<a href="#l6.186"></a><span id="l6.186" class="difflineplus">+  _parseContract(contractid, location, ...flags) {</span>
<a href="#l6.187"></a><span id="l6.187" class="difflineplus">+    if (this._parseFlags(flags)) {</span>
<a href="#l6.188"></a><span id="l6.188" class="difflineplus">+      this.contract.set(contractid, location);</span>
<a href="#l6.189"></a><span id="l6.189" class="difflineplus">+    }</span>
<a href="#l6.190"></a><span id="l6.190" class="difflineplus">+  }</span>
<a href="#l6.191"></a><span id="l6.191" class="difflineplus">+</span>
<a href="#l6.192"></a><span id="l6.192" class="difflineplus">+  /**</span>
<a href="#l6.193"></a><span id="l6.193" class="difflineplus">+   * Parse the category instruction, to set up xpcom categories</span>
<a href="#l6.194"></a><span id="l6.194" class="difflineplus">+   *</span>
<a href="#l6.195"></a><span id="l6.195" class="difflineplus">+   * @param {String} category       The name of the category</span>
<a href="#l6.196"></a><span id="l6.196" class="difflineplus">+   * @param {String} entryName      The category entry name</span>
<a href="#l6.197"></a><span id="l6.197" class="difflineplus">+   * @param {String} value          The category entry value</span>
<a href="#l6.198"></a><span id="l6.198" class="difflineplus">+   * @param {...String} flags       The flags for this instruction</span>
<a href="#l6.199"></a><span id="l6.199" class="difflineplus">+   */</span>
<a href="#l6.200"></a><span id="l6.200" class="difflineplus">+  _parseCategory(category, entryName, value, ...flags) {</span>
<a href="#l6.201"></a><span id="l6.201" class="difflineplus">+    if (this._parseFlags(flags)) {</span>
<a href="#l6.202"></a><span id="l6.202" class="difflineplus">+      this.category.get(category).set(entryName, value);</span>
<a href="#l6.203"></a><span id="l6.203" class="difflineplus">+    }</span>
<a href="#l6.204"></a><span id="l6.204" class="difflineplus">+  }</span>
<a href="#l6.205"></a><span id="l6.205" class="difflineplus">+</span>
<a href="#l6.206"></a><span id="l6.206" class="difflineplus">+  /**</span>
<a href="#l6.207"></a><span id="l6.207" class="difflineplus">+   * Parse the content instruction, to set chrome content locations</span>
<a href="#l6.208"></a><span id="l6.208" class="difflineplus">+   *</span>
<a href="#l6.209"></a><span id="l6.209" class="difflineplus">+   * @param {String} shortname      The content short name, e.g. chrome://shortname/content/</span>
<a href="#l6.210"></a><span id="l6.210" class="difflineplus">+   * @param {String} location       The location for this content registration</span>
<a href="#l6.211"></a><span id="l6.211" class="difflineplus">+   * @param {...String} flags       The flags for this instruction</span>
<a href="#l6.212"></a><span id="l6.212" class="difflineplus">+   */</span>
<a href="#l6.213"></a><span id="l6.213" class="difflineplus">+  _parseContent(shortname, location, ...flags) {</span>
<a href="#l6.214"></a><span id="l6.214" class="difflineplus">+    if (this._parseFlags(flags)) {</span>
<a href="#l6.215"></a><span id="l6.215" class="difflineplus">+      this.content.set(shortname, location);</span>
<a href="#l6.216"></a><span id="l6.216" class="difflineplus">+    }</span>
<a href="#l6.217"></a><span id="l6.217" class="difflineplus">+  }</span>
<a href="#l6.218"></a><span id="l6.218" class="difflineplus">+</span>
<a href="#l6.219"></a><span id="l6.219" class="difflineplus">+  /**</span>
<a href="#l6.220"></a><span id="l6.220" class="difflineplus">+   * Parse the locale instruction, to set chrome locale locations</span>
<a href="#l6.221"></a><span id="l6.221" class="difflineplus">+   *</span>
<a href="#l6.222"></a><span id="l6.222" class="difflineplus">+   * @param {String} shortname      The locale short name, e.g. chrome://shortname/locale/</span>
<a href="#l6.223"></a><span id="l6.223" class="difflineplus">+   * @param {String} location       The location for this locale registration</span>
<a href="#l6.224"></a><span id="l6.224" class="difflineplus">+   * @param {...String} flags       The flags for this instruction</span>
<a href="#l6.225"></a><span id="l6.225" class="difflineplus">+   */</span>
<a href="#l6.226"></a><span id="l6.226" class="difflineplus">+  _parseLocale(shortname, locale, location, ...flags) {</span>
<a href="#l6.227"></a><span id="l6.227" class="difflineplus">+    if (this._parseFlags(flags)) {</span>
<a href="#l6.228"></a><span id="l6.228" class="difflineplus">+      this.locales.get(shortname).set(locale, location);</span>
<a href="#l6.229"></a><span id="l6.229" class="difflineplus">+    }</span>
<a href="#l6.230"></a><span id="l6.230" class="difflineplus">+  }</span>
<a href="#l6.231"></a><span id="l6.231" class="difflineplus">+</span>
<a href="#l6.232"></a><span id="l6.232" class="difflineplus">+  /**</span>
<a href="#l6.233"></a><span id="l6.233" class="difflineplus">+   * Parse the skin instruction, to set chrome skin locations</span>
<a href="#l6.234"></a><span id="l6.234" class="difflineplus">+   *</span>
<a href="#l6.235"></a><span id="l6.235" class="difflineplus">+   * @param {String} shortname      The skin short name, e.g. chrome://shortname/skin/</span>
<a href="#l6.236"></a><span id="l6.236" class="difflineplus">+   * @param {String} location       The location for this skin registration</span>
<a href="#l6.237"></a><span id="l6.237" class="difflineplus">+   * @param {...String} flags       The flags for this instruction</span>
<a href="#l6.238"></a><span id="l6.238" class="difflineplus">+   */</span>
<a href="#l6.239"></a><span id="l6.239" class="difflineplus">+  _parseSkin(packagename, skinname, location, ...flags) {</span>
<a href="#l6.240"></a><span id="l6.240" class="difflineplus">+    if (this._parseFlags(flags)) {</span>
<a href="#l6.241"></a><span id="l6.241" class="difflineplus">+      this.skin.set(packagename, location);</span>
<a href="#l6.242"></a><span id="l6.242" class="difflineplus">+    }</span>
<a href="#l6.243"></a><span id="l6.243" class="difflineplus">+  }</span>
<a href="#l6.244"></a><span id="l6.244" class="difflineplus">+</span>
<a href="#l6.245"></a><span id="l6.245" class="difflineplus">+  /**</span>
<a href="#l6.246"></a><span id="l6.246" class="difflineplus">+   * Parse the resource instruction, to set up resource uri subtitutions</span>
<a href="#l6.247"></a><span id="l6.247" class="difflineplus">+   *</span>
<a href="#l6.248"></a><span id="l6.248" class="difflineplus">+   * @param {String} packagename    The resource package name, e.g. resource://packagename/</span>
<a href="#l6.249"></a><span id="l6.249" class="difflineplus">+   * @param {String} url            The location for this content registration</span>
<a href="#l6.250"></a><span id="l6.250" class="difflineplus">+   * @param {...String} flags       The flags for this instruction</span>
<a href="#l6.251"></a><span id="l6.251" class="difflineplus">+   */</span>
<a href="#l6.252"></a><span id="l6.252" class="difflineplus">+  _parseResource(packagename, location, ...flags) {</span>
<a href="#l6.253"></a><span id="l6.253" class="difflineplus">+    if (this._parseFlags(flags)) {</span>
<a href="#l6.254"></a><span id="l6.254" class="difflineplus">+      this.resource.set(packagename, location);</span>
<a href="#l6.255"></a><span id="l6.255" class="difflineplus">+    }</span>
<a href="#l6.256"></a><span id="l6.256" class="difflineplus">+  }</span>
<a href="#l6.257"></a><span id="l6.257" class="difflineplus">+</span>
<a href="#l6.258"></a><span id="l6.258" class="difflineplus">+  /**</span>
<a href="#l6.259"></a><span id="l6.259" class="difflineplus">+   * Parse the overlay instruction, to set up xul overlays</span>
<a href="#l6.260"></a><span id="l6.260" class="difflineplus">+   *</span>
<a href="#l6.261"></a><span id="l6.261" class="difflineplus">+   * @param {String} targetUrl      The chrome target url</span>
<a href="#l6.262"></a><span id="l6.262" class="difflineplus">+   * @param {String} overlayUrl     The url of the xul overlay</span>
<a href="#l6.263"></a><span id="l6.263" class="difflineplus">+   * @param {...String} flags       The flags for this instruction</span>
<a href="#l6.264"></a><span id="l6.264" class="difflineplus">+   */</span>
<a href="#l6.265"></a><span id="l6.265" class="difflineplus">+  _parseOverlay(targetUrl, overlayUrl, ...flags) {</span>
<a href="#l6.266"></a><span id="l6.266" class="difflineplus">+    if (this._parseFlags(flags)) {</span>
<a href="#l6.267"></a><span id="l6.267" class="difflineplus">+      this.overlay.get(targetUrl).push(overlayUrl);</span>
<a href="#l6.268"></a><span id="l6.268" class="difflineplus">+    }</span>
<a href="#l6.269"></a><span id="l6.269" class="difflineplus">+  }</span>
<a href="#l6.270"></a><span id="l6.270" class="difflineplus">+</span>
<a href="#l6.271"></a><span id="l6.271" class="difflineplus">+  /**</span>
<a href="#l6.272"></a><span id="l6.272" class="difflineplus">+   * Parse the style instruction, to add stylesheets into chrome windows</span>
<a href="#l6.273"></a><span id="l6.273" class="difflineplus">+   *</span>
<a href="#l6.274"></a><span id="l6.274" class="difflineplus">+   * @param {String} uri            The uri of the chrome window</span>
<a href="#l6.275"></a><span id="l6.275" class="difflineplus">+   * @param {String} sheet          The uri of the css sheet</span>
<a href="#l6.276"></a><span id="l6.276" class="difflineplus">+   * @param {...String} flags       The flags for this instruction</span>
<a href="#l6.277"></a><span id="l6.277" class="difflineplus">+   */</span>
<a href="#l6.278"></a><span id="l6.278" class="difflineplus">+  _parseStyle(uri, sheet, ...flags) {</span>
<a href="#l6.279"></a><span id="l6.279" class="difflineplus">+    if (this._parseFlags(flags)) {</span>
<a href="#l6.280"></a><span id="l6.280" class="difflineplus">+      this.style.get(uri).add(sheet);</span>
<a href="#l6.281"></a><span id="l6.281" class="difflineplus">+    }</span>
<a href="#l6.282"></a><span id="l6.282" class="difflineplus">+  }</span>
<a href="#l6.283"></a><span id="l6.283" class="difflineplus">+</span>
<a href="#l6.284"></a><span id="l6.284" class="difflineplus">+  /**</span>
<a href="#l6.285"></a><span id="l6.285" class="difflineplus">+   * Parse the override instruction, to set chrome uri overrides</span>
<a href="#l6.286"></a><span id="l6.286" class="difflineplus">+   *</span>
<a href="#l6.287"></a><span id="l6.287" class="difflineplus">+   * @param {String} uri            The uri being overridden</span>
<a href="#l6.288"></a><span id="l6.288" class="difflineplus">+   * @param {String} newuri         The replacement uri for the original location</span>
<a href="#l6.289"></a><span id="l6.289" class="difflineplus">+   * @param {...String} flags       The flags for this instruction</span>
<a href="#l6.290"></a><span id="l6.290" class="difflineplus">+   */</span>
<a href="#l6.291"></a><span id="l6.291" class="difflineplus">+  _parseOverride(uri, newuri, ...flags) {</span>
<a href="#l6.292"></a><span id="l6.292" class="difflineplus">+    if (this._parseFlags(flags)) {</span>
<a href="#l6.293"></a><span id="l6.293" class="difflineplus">+      this.override.set(uri, newuri);</span>
<a href="#l6.294"></a><span id="l6.294" class="difflineplus">+    }</span>
<a href="#l6.295"></a><span id="l6.295" class="difflineplus">+  }</span>
<a href="#l6.296"></a><span id="l6.296" class="difflineplus">+}</span>
<a href="#l6.297"></a><span id="l6.297" class="difflineplus">+</span>
<a href="#l6.298"></a><span id="l6.298" class="difflineplus">+/**</span>
<a href="#l6.299"></a><span id="l6.299" class="difflineplus">+ * A default map, which assumes a default value on get() if the key doesn't exist</span>
<a href="#l6.300"></a><span id="l6.300" class="difflineplus">+ */</span>
<a href="#l6.301"></a><span id="l6.301" class="difflineplus">+class DefaultMap extends Map {</span>
<a href="#l6.302"></a><span id="l6.302" class="difflineplus">+  /**</span>
<a href="#l6.303"></a><span id="l6.303" class="difflineplus">+   * Constructs the default map</span>
<a href="#l6.304"></a><span id="l6.304" class="difflineplus">+   *</span>
<a href="#l6.305"></a><span id="l6.305" class="difflineplus">+   * @param {Function} _default     A function that returns the default value for this map</span>
<a href="#l6.306"></a><span id="l6.306" class="difflineplus">+   * @param {*} iterable            An iterable to initialize the map with</span>
<a href="#l6.307"></a><span id="l6.307" class="difflineplus">+   */</span>
<a href="#l6.308"></a><span id="l6.308" class="difflineplus">+  constructor(_default, iterable) {</span>
<a href="#l6.309"></a><span id="l6.309" class="difflineplus">+    super(iterable);</span>
<a href="#l6.310"></a><span id="l6.310" class="difflineplus">+    this._default = _default;</span>
<a href="#l6.311"></a><span id="l6.311" class="difflineplus">+</span>
<a href="#l6.312"></a><span id="l6.312" class="difflineplus">+  }</span>
<a href="#l6.313"></a><span id="l6.313" class="difflineplus">+</span>
<a href="#l6.314"></a><span id="l6.314" class="difflineplus">+  /**</span>
<a href="#l6.315"></a><span id="l6.315" class="difflineplus">+   * Get the given key, creating if necessary</span>
<a href="#l6.316"></a><span id="l6.316" class="difflineplus">+   *</span>
<a href="#l6.317"></a><span id="l6.317" class="difflineplus">+   * @param {String} key            The key of the map to get</span>
<a href="#l6.318"></a><span id="l6.318" class="difflineplus">+   * @param {Boolean} create        True, if the key should be created in case it doesn't exist.</span>
<a href="#l6.319"></a><span id="l6.319" class="difflineplus">+   */</span>
<a href="#l6.320"></a><span id="l6.320" class="difflineplus">+  get(key, create=true) {</span>
<a href="#l6.321"></a><span id="l6.321" class="difflineplus">+    if (this.has(key)) {</span>
<a href="#l6.322"></a><span id="l6.322" class="difflineplus">+      return super.get(key);</span>
<a href="#l6.323"></a><span id="l6.323" class="difflineplus">+    } else if (create) {</span>
<a href="#l6.324"></a><span id="l6.324" class="difflineplus">+      this.set(key, this._default());</span>
<a href="#l6.325"></a><span id="l6.325" class="difflineplus">+      return super.get(key);</span>
<a href="#l6.326"></a><span id="l6.326" class="difflineplus">+    }</span>
<a href="#l6.327"></a><span id="l6.327" class="difflineplus">+</span>
<a href="#l6.328"></a><span id="l6.328" class="difflineplus">+    return this._default();</span>
<a href="#l6.329"></a><span id="l6.329" class="difflineplus">+  }</span>
<a href="#l6.330"></a><span id="l6.330" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1">new file mode 100644</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineminus">--- /dev/null</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineplus">+++ b/common/src/Overlays.jsm</span>
<a href="#l7.4"></a><span id="l7.4" class="difflineat">@@ -0,0 +1,429 @@</span>
<a href="#l7.5"></a><span id="l7.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l7.6"></a><span id="l7.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l7.7"></a><span id="l7.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l7.8"></a><span id="l7.8" class="difflineplus">+</span>
<a href="#l7.9"></a><span id="l7.9" class="difflineplus">+/**</span>
<a href="#l7.10"></a><span id="l7.10" class="difflineplus">+ * Load overlays in a similar way as XUL did for legacy XUL add-ons.</span>
<a href="#l7.11"></a><span id="l7.11" class="difflineplus">+ */</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+this.EXPORTED_SYMBOLS = [&quot;Overlays&quot;];</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+ChromeUtils.import(&quot;resource://gre/modules/Console.jsm&quot;);</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+ChromeUtils.defineModuleGetter(this, &quot;Services&quot;, &quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+ChromeUtils.defineModuleGetter(this, &quot;setTimeout&quot;, &quot;resource://gre/modules/Timer.jsm&quot;);</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+Cu.importGlobalProperties([&quot;XMLHttpRequest&quot;]);</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineplus">+</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineplus">+let oconsole = new ConsoleAPI({</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineplus">+  prefix: &quot;Overlays.jsm&quot;,</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineplus">+  consoleID: &quot;overlays-jsm&quot;,</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineplus">+  maxLogLevel: &quot;all&quot; // &quot;warn&quot;</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineplus">+});</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineplus">+</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineplus">+/**</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineplus">+ * The overlays class, providing support for loading overlays like they used to work. This class</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineplus">+ * should likely be called through its static method Overlays.load()</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+ */</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+class Overlays {</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+  /**</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+   * Load overlays for the given window using the overlay provider, which can for example be a</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+   * ChromeManifest object.</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+   *</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineplus">+   * @param {ChromeManifest} overlayProvider        The overlay provider that contains information</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineplus">+   *                                                  about styles and overlays.</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+   * @param {DOMWindow} window                      The window to load into</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineplus">+   */</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineplus">+  static load(overlayProvider, window) {</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineplus">+    let instance = new Overlays(overlayProvider, window);</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+    let location = window.location.protocol + &quot;//&quot; +</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineplus">+        window.location.host + window.location.pathname;</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineplus">+</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineplus">+    let urls = overlayProvider.overlay.get(location, false);</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineplus">+    instance.load(urls);</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineplus">+  }</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineplus">+</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineplus">+  /**</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineplus">+   * Constructs the overlays instance. This class should be called via Overlays.load() instead.</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineplus">+   *</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineplus">+   * @param {ChromeManifest} overlayProvider        The overlay provider that contains information</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineplus">+   *                                                  about styles and overlays.</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineplus">+   * @param {DOMWindow} window                      The window to load into</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineplus">+   */</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineplus">+  constructor(overlayProvider, window) {</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineplus">+    this.window = window;</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineplus">+    this.overlayProvider = overlayProvider;</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineplus">+  }</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineplus">+</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineplus">+  /**</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineplus">+   * A shorthand to this.window.document</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineplus">+   */</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineplus">+  get document() {</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineplus">+    return this.window.document;</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineplus">+  }</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineplus">+</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineplus">+  /**</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineplus">+   * Loads the given urls into the window, recursively loading further overlays as provided by the</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineplus">+   * overlayProvider.</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineplus">+   *</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineplus">+   * @param {String[]} urls                         The urls to load</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineplus">+   */</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineplus">+  load(urls) {</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineplus">+    let unloadedOverlays = urls;</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineplus">+    let forwardReferences = [];</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineplus">+    let unloadedScripts = [];</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineplus">+    let unloadedSheets = [];</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineplus">+</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineplus">+    while (unloadedOverlays.length) {</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineplus">+      let url = unloadedOverlays.shift();</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineplus">+      let xhr = this.fetchOverlay(url);</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineplus">+      let doc = xhr.responseXML;</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineplus">+</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineplus">+      // clean the document a bit</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineplus">+      let emptyNodes = doc.evaluate(&quot;//text()[normalize-space(.) = '']&quot;, doc, null, 7, null);</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineplus">+      for (let i = 0, len = emptyNodes.snapshotLength; i &lt; len; ++i) {</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineplus">+        let node = emptyNodes.snapshotItem(i);</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineplus">+        node.remove();</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineplus">+      }</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineplus">+</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineplus">+      let commentNodes = doc.evaluate(&quot;//comment()&quot;, doc, null, 7, null);</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineplus">+      for (let i = 0, len = commentNodes.snapshotLength; i &lt; len; ++i) {</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineplus">+        let node = commentNodes.snapshotItem(i);</span>
<a href="#l7.97"></a><span id="l7.97" class="difflineplus">+        node.remove();</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineplus">+      }</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineplus">+</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineplus">+      // Load css styles from the registry</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineplus">+      for (let sheet of this.overlayProvider.style.get(url, false)) {</span>
<a href="#l7.102"></a><span id="l7.102" class="difflineplus">+        unloadedSheets.push(sheet);</span>
<a href="#l7.103"></a><span id="l7.103" class="difflineplus">+      }</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineplus">+</span>
<a href="#l7.105"></a><span id="l7.105" class="difflineplus">+      // Load css processing instructions from the overlay</span>
<a href="#l7.106"></a><span id="l7.106" class="difflineplus">+      let stylesheets = doc.evaluate(&quot;/processing-instruction('xml-stylesheet')&quot;, doc, null, 7, null);</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineplus">+      for (let i = 0, len = stylesheets.snapshotLength; i &lt; len; ++i) {</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineplus">+        let node = stylesheets.snapshotItem(i);</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineplus">+        let match = node.nodeValue.match(/href=[&quot;']([^&quot;']*)[&quot;']/);</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineplus">+        if (match) {</span>
<a href="#l7.111"></a><span id="l7.111" class="difflineplus">+          unloadedSheets.push(match[1]);</span>
<a href="#l7.112"></a><span id="l7.112" class="difflineplus">+        }</span>
<a href="#l7.113"></a><span id="l7.113" class="difflineplus">+      }</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineplus">+</span>
<a href="#l7.115"></a><span id="l7.115" class="difflineplus">+      // Prepare loading further nested xul overlays from the overlay</span>
<a href="#l7.116"></a><span id="l7.116" class="difflineplus">+      let xuloverlays = doc.evaluate(&quot;/processing-instruction('xul-overlay')&quot;, doc, null, 7, null);</span>
<a href="#l7.117"></a><span id="l7.117" class="difflineplus">+      for (let i = 0, len = xuloverlays.snapshotLength; i &lt; len; ++i) {</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineplus">+        let node = xuloverlays.snapshotItem(i);</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineplus">+        let match = node.nodeValue.match(/href=[&quot;']([^&quot;']*)[&quot;']/);</span>
<a href="#l7.120"></a><span id="l7.120" class="difflineplus">+        if (match) {</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineplus">+          unloadedOverlays.push(match[1]);</span>
<a href="#l7.122"></a><span id="l7.122" class="difflineplus">+        }</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineplus">+      }</span>
<a href="#l7.124"></a><span id="l7.124" class="difflineplus">+</span>
<a href="#l7.125"></a><span id="l7.125" class="difflineplus">+      // Prepare loading further nested xul overlays from the registry</span>
<a href="#l7.126"></a><span id="l7.126" class="difflineplus">+      for (let overlayUrl of this.overlayProvider.overlay.get(url, false)) {</span>
<a href="#l7.127"></a><span id="l7.127" class="difflineplus">+        unloadedOverlays.push(overlayUrl);</span>
<a href="#l7.128"></a><span id="l7.128" class="difflineplus">+      }</span>
<a href="#l7.129"></a><span id="l7.129" class="difflineplus">+</span>
<a href="#l7.130"></a><span id="l7.130" class="difflineplus">+      // Run through all overlay nodes on the first level (hookup nodes). Scripts will be deferred</span>
<a href="#l7.131"></a><span id="l7.131" class="difflineplus">+      // until later for simplicity (c++ code seems to process them earlier?).</span>
<a href="#l7.132"></a><span id="l7.132" class="difflineplus">+      for (let node of doc.documentElement.children) {</span>
<a href="#l7.133"></a><span id="l7.133" class="difflineplus">+        if (node.localName == &quot;script&quot;) {</span>
<a href="#l7.134"></a><span id="l7.134" class="difflineplus">+          unloadedScripts.push(node);</span>
<a href="#l7.135"></a><span id="l7.135" class="difflineplus">+        } else {</span>
<a href="#l7.136"></a><span id="l7.136" class="difflineplus">+          forwardReferences.push(node);</span>
<a href="#l7.137"></a><span id="l7.137" class="difflineplus">+        }</span>
<a href="#l7.138"></a><span id="l7.138" class="difflineplus">+      }</span>
<a href="#l7.139"></a><span id="l7.139" class="difflineplus">+    }</span>
<a href="#l7.140"></a><span id="l7.140" class="difflineplus">+</span>
<a href="#l7.141"></a><span id="l7.141" class="difflineplus">+    // At this point, all (recursive) overlays are loaded. Unloaded scripts and sheets are ready and</span>
<a href="#l7.142"></a><span id="l7.142" class="difflineplus">+    // in order, and forward references are good to process.</span>
<a href="#l7.143"></a><span id="l7.143" class="difflineplus">+    let previous = 0;</span>
<a href="#l7.144"></a><span id="l7.144" class="difflineplus">+    while (forwardReferences.length &amp;&amp; forwardReferences.length != previous) {</span>
<a href="#l7.145"></a><span id="l7.145" class="difflineplus">+      previous = forwardReferences.length;</span>
<a href="#l7.146"></a><span id="l7.146" class="difflineplus">+      let unresolved = [];</span>
<a href="#l7.147"></a><span id="l7.147" class="difflineplus">+</span>
<a href="#l7.148"></a><span id="l7.148" class="difflineplus">+      for (let ref of forwardReferences) {</span>
<a href="#l7.149"></a><span id="l7.149" class="difflineplus">+        if (!this._resolveForwardReference(ref)) {</span>
<a href="#l7.150"></a><span id="l7.150" class="difflineplus">+          unresolved.push(ref);</span>
<a href="#l7.151"></a><span id="l7.151" class="difflineplus">+        }</span>
<a href="#l7.152"></a><span id="l7.152" class="difflineplus">+      }</span>
<a href="#l7.153"></a><span id="l7.153" class="difflineplus">+</span>
<a href="#l7.154"></a><span id="l7.154" class="difflineplus">+      forwardReferences = unresolved;</span>
<a href="#l7.155"></a><span id="l7.155" class="difflineplus">+    }</span>
<a href="#l7.156"></a><span id="l7.156" class="difflineplus">+</span>
<a href="#l7.157"></a><span id="l7.157" class="difflineplus">+    if (forwardReferences.length) {</span>
<a href="#l7.158"></a><span id="l7.158" class="difflineplus">+      oconsole.warn(`Could not resolve ${forwardReferences.length} references`, forwardReferences);</span>
<a href="#l7.159"></a><span id="l7.159" class="difflineplus">+    }</span>
<a href="#l7.160"></a><span id="l7.160" class="difflineplus">+</span>
<a href="#l7.161"></a><span id="l7.161" class="difflineplus">+    // Loading the sheets now to avoid race conditions with xbl bindings</span>
<a href="#l7.162"></a><span id="l7.162" class="difflineplus">+    for (let sheet of unloadedSheets) {</span>
<a href="#l7.163"></a><span id="l7.163" class="difflineplus">+      this.loadCSS(sheet);</span>
<a href="#l7.164"></a><span id="l7.164" class="difflineplus">+    }</span>
<a href="#l7.165"></a><span id="l7.165" class="difflineplus">+</span>
<a href="#l7.166"></a><span id="l7.166" class="difflineplus">+    // We've resolved all the forward references we can, we can now go ahead and load the scripts</span>
<a href="#l7.167"></a><span id="l7.167" class="difflineplus">+    let deferredLoad = [];</span>
<a href="#l7.168"></a><span id="l7.168" class="difflineplus">+    for (let script of unloadedScripts) {</span>
<a href="#l7.169"></a><span id="l7.169" class="difflineplus">+      deferredLoad.push(...this.loadScript(script));</span>
<a href="#l7.170"></a><span id="l7.170" class="difflineplus">+    }</span>
<a href="#l7.171"></a><span id="l7.171" class="difflineplus">+</span>
<a href="#l7.172"></a><span id="l7.172" class="difflineplus">+    if (this.window.document.readyState == &quot;complete&quot;) {</span>
<a href="#l7.173"></a><span id="l7.173" class="difflineplus">+      // Now here is where it gets a little tricky. The subscript loader is synchronous, but the</span>
<a href="#l7.174"></a><span id="l7.174" class="difflineplus">+      // script itself may have some asynchronous side-effects (xbl bindings attached). Throwing in a</span>
<a href="#l7.175"></a><span id="l7.175" class="difflineplus">+      // 1500ms timeout before we fire the load handlers seems to help, even though it is an ugly hack.</span>
<a href="#l7.176"></a><span id="l7.176" class="difflineplus">+      setTimeout(() =&gt; {</span>
<a href="#l7.177"></a><span id="l7.177" class="difflineplus">+        // Now execute load handlers since we are done loading scripts</span>
<a href="#l7.178"></a><span id="l7.178" class="difflineplus">+        let bubbles = [];</span>
<a href="#l7.179"></a><span id="l7.179" class="difflineplus">+        for (let { listener, useCapture } of deferredLoad) {</span>
<a href="#l7.180"></a><span id="l7.180" class="difflineplus">+          if (useCapture) {</span>
<a href="#l7.181"></a><span id="l7.181" class="difflineplus">+            this._fireEventListener(listener);</span>
<a href="#l7.182"></a><span id="l7.182" class="difflineplus">+          } else {</span>
<a href="#l7.183"></a><span id="l7.183" class="difflineplus">+            bubbles.push(listener);</span>
<a href="#l7.184"></a><span id="l7.184" class="difflineplus">+          }</span>
<a href="#l7.185"></a><span id="l7.185" class="difflineplus">+        }</span>
<a href="#l7.186"></a><span id="l7.186" class="difflineplus">+</span>
<a href="#l7.187"></a><span id="l7.187" class="difflineplus">+        for (let listener of bubbles) {</span>
<a href="#l7.188"></a><span id="l7.188" class="difflineplus">+          this._fireEventListener(listener);</span>
<a href="#l7.189"></a><span id="l7.189" class="difflineplus">+        }</span>
<a href="#l7.190"></a><span id="l7.190" class="difflineplus">+      }, 1500);</span>
<a href="#l7.191"></a><span id="l7.191" class="difflineplus">+    } else {</span>
<a href="#l7.192"></a><span id="l7.192" class="difflineplus">+      // Window load is not yet complete, just add the listener normally</span>
<a href="#l7.193"></a><span id="l7.193" class="difflineplus">+      for (let { listener, useCapture } of deferredLoad) {</span>
<a href="#l7.194"></a><span id="l7.194" class="difflineplus">+        this.window.addEventListener(&quot;load&quot;, listener, useCapture);</span>
<a href="#l7.195"></a><span id="l7.195" class="difflineplus">+      }</span>
<a href="#l7.196"></a><span id="l7.196" class="difflineplus">+    }</span>
<a href="#l7.197"></a><span id="l7.197" class="difflineplus">+  }</span>
<a href="#l7.198"></a><span id="l7.198" class="difflineplus">+</span>
<a href="#l7.199"></a><span id="l7.199" class="difflineplus">+  /**</span>
<a href="#l7.200"></a><span id="l7.200" class="difflineplus">+   * Fires a &quot;load&quot; event for the given listener, using the current window</span>
<a href="#l7.201"></a><span id="l7.201" class="difflineplus">+   *</span>
<a href="#l7.202"></a><span id="l7.202" class="difflineplus">+   * @param {EventListener|Function} listener       The event listener to call</span>
<a href="#l7.203"></a><span id="l7.203" class="difflineplus">+   */</span>
<a href="#l7.204"></a><span id="l7.204" class="difflineplus">+  _fireEventListener(listener) {</span>
<a href="#l7.205"></a><span id="l7.205" class="difflineplus">+    let fakeEvent = new this.window.UIEvent(&quot;load&quot;, { view: this.window });</span>
<a href="#l7.206"></a><span id="l7.206" class="difflineplus">+    if (typeof listener == &quot;function&quot;) {</span>
<a href="#l7.207"></a><span id="l7.207" class="difflineplus">+      listener(fakeEvent);</span>
<a href="#l7.208"></a><span id="l7.208" class="difflineplus">+    } else if (listener &amp;&amp; typeof listener == &quot;object&quot;) {</span>
<a href="#l7.209"></a><span id="l7.209" class="difflineplus">+      listener.handleEvent(fakeEvent);</span>
<a href="#l7.210"></a><span id="l7.210" class="difflineplus">+    } else {</span>
<a href="#l7.211"></a><span id="l7.211" class="difflineplus">+      oconsole.error(&quot;Unknown listener type&quot;, listener);</span>
<a href="#l7.212"></a><span id="l7.212" class="difflineplus">+    }</span>
<a href="#l7.213"></a><span id="l7.213" class="difflineplus">+  }</span>
<a href="#l7.214"></a><span id="l7.214" class="difflineplus">+</span>
<a href="#l7.215"></a><span id="l7.215" class="difflineplus">+  /**</span>
<a href="#l7.216"></a><span id="l7.216" class="difflineplus">+   * Resolves forward references for the given node. If the node exists in the target document, it</span>
<a href="#l7.217"></a><span id="l7.217" class="difflineplus">+   * is merged in with the target node. If the node has no id it is inserted at documentElement</span>
<a href="#l7.218"></a><span id="l7.218" class="difflineplus">+   * level.</span>
<a href="#l7.219"></a><span id="l7.219" class="difflineplus">+   *</span>
<a href="#l7.220"></a><span id="l7.220" class="difflineplus">+   * @param {Element} node          The DOM Element to resolve in the target document.</span>
<a href="#l7.221"></a><span id="l7.221" class="difflineplus">+   * @return {Boolean}              True, if the node was merged/inserted, false otherwise</span>
<a href="#l7.222"></a><span id="l7.222" class="difflineplus">+   */</span>
<a href="#l7.223"></a><span id="l7.223" class="difflineplus">+  _resolveForwardReference(node) {</span>
<a href="#l7.224"></a><span id="l7.224" class="difflineplus">+    if (node.id &amp;&amp; node.localName == &quot;toolbarpalette&quot;) {</span>
<a href="#l7.225"></a><span id="l7.225" class="difflineplus">+      let palette = this.document.getElementById(node.id);</span>
<a href="#l7.226"></a><span id="l7.226" class="difflineplus">+      if (!palette) {</span>
<a href="#l7.227"></a><span id="l7.227" class="difflineplus">+        // These vanish from the document but still exist via the palette property</span>
<a href="#l7.228"></a><span id="l7.228" class="difflineplus">+        let boxes = [...this.document.getElementsByTagName(&quot;toolbox&quot;)];</span>
<a href="#l7.229"></a><span id="l7.229" class="difflineplus">+        let box = boxes.find(box =&gt; box.palette &amp;&amp; box.palette.id == node.id);</span>
<a href="#l7.230"></a><span id="l7.230" class="difflineplus">+        palette = box ? box.palette : null;</span>
<a href="#l7.231"></a><span id="l7.231" class="difflineplus">+      }</span>
<a href="#l7.232"></a><span id="l7.232" class="difflineplus">+</span>
<a href="#l7.233"></a><span id="l7.233" class="difflineplus">+      if (!palette) {</span>
<a href="#l7.234"></a><span id="l7.234" class="difflineplus">+        oconsole.debug(`The palette for ${node.id} could not be found, deferring to later`);</span>
<a href="#l7.235"></a><span id="l7.235" class="difflineplus">+        return false;</span>
<a href="#l7.236"></a><span id="l7.236" class="difflineplus">+      }</span>
<a href="#l7.237"></a><span id="l7.237" class="difflineplus">+</span>
<a href="#l7.238"></a><span id="l7.238" class="difflineplus">+      this._mergeElement(palette, node);</span>
<a href="#l7.239"></a><span id="l7.239" class="difflineplus">+    } else if (node.id) {</span>
<a href="#l7.240"></a><span id="l7.240" class="difflineplus">+      let target = this.document.getElementById(node.id);</span>
<a href="#l7.241"></a><span id="l7.241" class="difflineplus">+      if (!target) {</span>
<a href="#l7.242"></a><span id="l7.242" class="difflineplus">+        oconsole.debug(`The node ${node.id} could not be found, deferring to later`);</span>
<a href="#l7.243"></a><span id="l7.243" class="difflineplus">+        return false;</span>
<a href="#l7.244"></a><span id="l7.244" class="difflineplus">+      }</span>
<a href="#l7.245"></a><span id="l7.245" class="difflineplus">+</span>
<a href="#l7.246"></a><span id="l7.246" class="difflineplus">+      this._mergeElement(target, node);</span>
<a href="#l7.247"></a><span id="l7.247" class="difflineplus">+    } else {</span>
<a href="#l7.248"></a><span id="l7.248" class="difflineplus">+       this._insertElement(this.document.documentElement, node);</span>
<a href="#l7.249"></a><span id="l7.249" class="difflineplus">+    }</span>
<a href="#l7.250"></a><span id="l7.250" class="difflineplus">+    return true;</span>
<a href="#l7.251"></a><span id="l7.251" class="difflineplus">+  }</span>
<a href="#l7.252"></a><span id="l7.252" class="difflineplus">+</span>
<a href="#l7.253"></a><span id="l7.253" class="difflineplus">+  /**</span>
<a href="#l7.254"></a><span id="l7.254" class="difflineplus">+   * Insert the node in the given parent, observing the insertbefore/insertafter/position attributes</span>
<a href="#l7.255"></a><span id="l7.255" class="difflineplus">+   *</span>
<a href="#l7.256"></a><span id="l7.256" class="difflineplus">+   * @param {Element} parent        The parent element to insert the node into.</span>
<a href="#l7.257"></a><span id="l7.257" class="difflineplus">+   * @param {Element} node          The node to insert.</span>
<a href="#l7.258"></a><span id="l7.258" class="difflineplus">+   */</span>
<a href="#l7.259"></a><span id="l7.259" class="difflineplus">+  _insertElement(parent, node) {</span>
<a href="#l7.260"></a><span id="l7.260" class="difflineplus">+    let wasInserted = false;</span>
<a href="#l7.261"></a><span id="l7.261" class="difflineplus">+    let pos = node.getAttribute(&quot;insertafter&quot;);</span>
<a href="#l7.262"></a><span id="l7.262" class="difflineplus">+    let after = true;</span>
<a href="#l7.263"></a><span id="l7.263" class="difflineplus">+</span>
<a href="#l7.264"></a><span id="l7.264" class="difflineplus">+    if (!pos) {</span>
<a href="#l7.265"></a><span id="l7.265" class="difflineplus">+      pos = node.getAttribute(&quot;insertbefore&quot;);</span>
<a href="#l7.266"></a><span id="l7.266" class="difflineplus">+      after = false;</span>
<a href="#l7.267"></a><span id="l7.267" class="difflineplus">+    }</span>
<a href="#l7.268"></a><span id="l7.268" class="difflineplus">+</span>
<a href="#l7.269"></a><span id="l7.269" class="difflineplus">+    if (pos) {</span>
<a href="#l7.270"></a><span id="l7.270" class="difflineplus">+      for (let id of pos.split(&quot;,&quot;)) {</span>
<a href="#l7.271"></a><span id="l7.271" class="difflineplus">+        let targetchild = this.document.getElementById(id);</span>
<a href="#l7.272"></a><span id="l7.272" class="difflineplus">+        if (targetchild &amp;&amp; targetchild.parentNode == parent) {</span>
<a href="#l7.273"></a><span id="l7.273" class="difflineplus">+          parent.insertBefore(node, after ? targetchild.nextSibling : targetchild);</span>
<a href="#l7.274"></a><span id="l7.274" class="difflineplus">+          wasInserted = true;</span>
<a href="#l7.275"></a><span id="l7.275" class="difflineplus">+          // Not breaking here to match original behavior</span>
<a href="#l7.276"></a><span id="l7.276" class="difflineplus">+        }</span>
<a href="#l7.277"></a><span id="l7.277" class="difflineplus">+      }</span>
<a href="#l7.278"></a><span id="l7.278" class="difflineplus">+    }</span>
<a href="#l7.279"></a><span id="l7.279" class="difflineplus">+</span>
<a href="#l7.280"></a><span id="l7.280" class="difflineplus">+    if (!wasInserted) {</span>
<a href="#l7.281"></a><span id="l7.281" class="difflineplus">+      // position is 1-based</span>
<a href="#l7.282"></a><span id="l7.282" class="difflineplus">+      let position = parseInt(node.getAttribute(&quot;position&quot;), 10);</span>
<a href="#l7.283"></a><span id="l7.283" class="difflineplus">+      if (position &gt; 0 &amp;&amp; (position - 1) &lt;= parent.childNodes.length) {</span>
<a href="#l7.284"></a><span id="l7.284" class="difflineplus">+        parent.insertBefore(node, parent.childNodes[position - 1]);</span>
<a href="#l7.285"></a><span id="l7.285" class="difflineplus">+        wasInserted = true;</span>
<a href="#l7.286"></a><span id="l7.286" class="difflineplus">+      }</span>
<a href="#l7.287"></a><span id="l7.287" class="difflineplus">+    }</span>
<a href="#l7.288"></a><span id="l7.288" class="difflineplus">+</span>
<a href="#l7.289"></a><span id="l7.289" class="difflineplus">+    if (!wasInserted) {</span>
<a href="#l7.290"></a><span id="l7.290" class="difflineplus">+      parent.appendChild(node);</span>
<a href="#l7.291"></a><span id="l7.291" class="difflineplus">+    }</span>
<a href="#l7.292"></a><span id="l7.292" class="difflineplus">+  }</span>
<a href="#l7.293"></a><span id="l7.293" class="difflineplus">+</span>
<a href="#l7.294"></a><span id="l7.294" class="difflineplus">+  /**</span>
<a href="#l7.295"></a><span id="l7.295" class="difflineplus">+   * Merge the node into the target, adhering to the removeelement attribute, merging further</span>
<a href="#l7.296"></a><span id="l7.296" class="difflineplus">+   * attributes into the target node, and merging children as appropriate for xul nodes. If a child</span>
<a href="#l7.297"></a><span id="l7.297" class="difflineplus">+   * has an id, it will be searched in the target document and recursively merged.</span>
<a href="#l7.298"></a><span id="l7.298" class="difflineplus">+   *</span>
<a href="#l7.299"></a><span id="l7.299" class="difflineplus">+   * @param {Element} target        The node to merge into</span>
<a href="#l7.300"></a><span id="l7.300" class="difflineplus">+   * @param {Element} node          The node that is being merged</span>
<a href="#l7.301"></a><span id="l7.301" class="difflineplus">+   */</span>
<a href="#l7.302"></a><span id="l7.302" class="difflineplus">+  _mergeElement(target, node) {</span>
<a href="#l7.303"></a><span id="l7.303" class="difflineplus">+    for (let attribute of node.attributes) {</span>
<a href="#l7.304"></a><span id="l7.304" class="difflineplus">+      if (attribute.name == &quot;id&quot;) {</span>
<a href="#l7.305"></a><span id="l7.305" class="difflineplus">+        continue;</span>
<a href="#l7.306"></a><span id="l7.306" class="difflineplus">+      }</span>
<a href="#l7.307"></a><span id="l7.307" class="difflineplus">+</span>
<a href="#l7.308"></a><span id="l7.308" class="difflineplus">+      if (attribute.name == &quot;removeelement&quot; &amp;&amp; attribute.value == &quot;true&quot;) {</span>
<a href="#l7.309"></a><span id="l7.309" class="difflineplus">+        target.remove();</span>
<a href="#l7.310"></a><span id="l7.310" class="difflineplus">+        return;</span>
<a href="#l7.311"></a><span id="l7.311" class="difflineplus">+      }</span>
<a href="#l7.312"></a><span id="l7.312" class="difflineplus">+</span>
<a href="#l7.313"></a><span id="l7.313" class="difflineplus">+      target.setAttributeNS(attribute.namespaceURI, attribute.name, attribute.value);</span>
<a href="#l7.314"></a><span id="l7.314" class="difflineplus">+    }</span>
<a href="#l7.315"></a><span id="l7.315" class="difflineplus">+</span>
<a href="#l7.316"></a><span id="l7.316" class="difflineplus">+    for (let i = 0, len = node.childElementCount; i &lt; len; i++) {</span>
<a href="#l7.317"></a><span id="l7.317" class="difflineplus">+      let child = node.firstElementChild;</span>
<a href="#l7.318"></a><span id="l7.318" class="difflineplus">+      child.remove();</span>
<a href="#l7.319"></a><span id="l7.319" class="difflineplus">+</span>
<a href="#l7.320"></a><span id="l7.320" class="difflineplus">+      let elementInDocument = child.id ? this.document.getElementById(child.id) : null;</span>
<a href="#l7.321"></a><span id="l7.321" class="difflineplus">+      let parentId = elementInDocument ? elementInDocument.parentNode.id : null;</span>
<a href="#l7.322"></a><span id="l7.322" class="difflineplus">+</span>
<a href="#l7.323"></a><span id="l7.323" class="difflineplus">+      if (parentId &amp;&amp; parentId == target.id) {</span>
<a href="#l7.324"></a><span id="l7.324" class="difflineplus">+        this._mergeElement(elementInDocument, child);</span>
<a href="#l7.325"></a><span id="l7.325" class="difflineplus">+      } else {</span>
<a href="#l7.326"></a><span id="l7.326" class="difflineplus">+        this._insertElement(target, child);</span>
<a href="#l7.327"></a><span id="l7.327" class="difflineplus">+      }</span>
<a href="#l7.328"></a><span id="l7.328" class="difflineplus">+    }</span>
<a href="#l7.329"></a><span id="l7.329" class="difflineplus">+  }</span>
<a href="#l7.330"></a><span id="l7.330" class="difflineplus">+</span>
<a href="#l7.331"></a><span id="l7.331" class="difflineplus">+  /**</span>
<a href="#l7.332"></a><span id="l7.332" class="difflineplus">+   * Fetches the overlay from the given chrome:// or resource:// URL. This happen synchronously so</span>
<a href="#l7.333"></a><span id="l7.333" class="difflineplus">+   * we have a chance to complete before the load event.</span>
<a href="#l7.334"></a><span id="l7.334" class="difflineplus">+   *</span>
<a href="#l7.335"></a><span id="l7.335" class="difflineplus">+   * @param {String} srcUrl                         The URL to load</span>
<a href="#l7.336"></a><span id="l7.336" class="difflineplus">+   * @return {XMLHttpRequest}                       The completed XHR.</span>
<a href="#l7.337"></a><span id="l7.337" class="difflineplus">+   */</span>
<a href="#l7.338"></a><span id="l7.338" class="difflineplus">+  fetchOverlay(srcUrl) {</span>
<a href="#l7.339"></a><span id="l7.339" class="difflineplus">+    if (!srcUrl.startsWith(&quot;chrome://&quot;) &amp;&amp; !srcUrl.startsWith(&quot;resource://&quot;)) {</span>
<a href="#l7.340"></a><span id="l7.340" class="difflineplus">+      throw &quot;May only load overlays from chrome:// or resource:// uris&quot;;</span>
<a href="#l7.341"></a><span id="l7.341" class="difflineplus">+    }</span>
<a href="#l7.342"></a><span id="l7.342" class="difflineplus">+</span>
<a href="#l7.343"></a><span id="l7.343" class="difflineplus">+    let xhr = new XMLHttpRequest();</span>
<a href="#l7.344"></a><span id="l7.344" class="difflineplus">+    xhr.overrideMimeType(&quot;application/xml&quot;);</span>
<a href="#l7.345"></a><span id="l7.345" class="difflineplus">+    xhr.open(&quot;GET&quot;, srcUrl, false);</span>
<a href="#l7.346"></a><span id="l7.346" class="difflineplus">+</span>
<a href="#l7.347"></a><span id="l7.347" class="difflineplus">+    // Elevate the request, so DTDs will work. Should not be a security issue since we</span>
<a href="#l7.348"></a><span id="l7.348" class="difflineplus">+    // only load chrome, resource and file URLs, and that is our privileged chrome package.</span>
<a href="#l7.349"></a><span id="l7.349" class="difflineplus">+    try {</span>
<a href="#l7.350"></a><span id="l7.350" class="difflineplus">+      xhr.channel.owner = Services.scriptSecurityManager.getSystemPrincipal();</span>
<a href="#l7.351"></a><span id="l7.351" class="difflineplus">+    } catch (ex) {</span>
<a href="#l7.352"></a><span id="l7.352" class="difflineplus">+      oconsole.error(&quot;Failed to set system principal while fetching overlay &quot; + srcUrl);</span>
<a href="#l7.353"></a><span id="l7.353" class="difflineplus">+      xhr.close();</span>
<a href="#l7.354"></a><span id="l7.354" class="difflineplus">+      throw &quot;Failed to set system principal&quot;;</span>
<a href="#l7.355"></a><span id="l7.355" class="difflineplus">+    }</span>
<a href="#l7.356"></a><span id="l7.356" class="difflineplus">+</span>
<a href="#l7.357"></a><span id="l7.357" class="difflineplus">+    xhr.send(null);</span>
<a href="#l7.358"></a><span id="l7.358" class="difflineplus">+    return xhr;</span>
<a href="#l7.359"></a><span id="l7.359" class="difflineplus">+  }</span>
<a href="#l7.360"></a><span id="l7.360" class="difflineplus">+</span>
<a href="#l7.361"></a><span id="l7.361" class="difflineplus">+  /**</span>
<a href="#l7.362"></a><span id="l7.362" class="difflineplus">+   * Loads scripts described by the given script node. The node can either have a src attribute, or</span>
<a href="#l7.363"></a><span id="l7.363" class="difflineplus">+   * be an inline script with textContent.</span>
<a href="#l7.364"></a><span id="l7.364" class="difflineplus">+   *</span>
<a href="#l7.365"></a><span id="l7.365" class="difflineplus">+   * @param {Element} node                          The &lt;script&gt; element to load the script from</span>
<a href="#l7.366"></a><span id="l7.366" class="difflineplus">+   * @return {Object[]}                             An object with listener and useCapture,</span>
<a href="#l7.367"></a><span id="l7.367" class="difflineplus">+   *                                                  describing load handlers the script creates</span>
<a href="#l7.368"></a><span id="l7.368" class="difflineplus">+   *                                                  when first run.</span>
<a href="#l7.369"></a><span id="l7.369" class="difflineplus">+   */</span>
<a href="#l7.370"></a><span id="l7.370" class="difflineplus">+  loadScript(node) {</span>
<a href="#l7.371"></a><span id="l7.371" class="difflineplus">+    let deferredLoad = [];</span>
<a href="#l7.372"></a><span id="l7.372" class="difflineplus">+</span>
<a href="#l7.373"></a><span id="l7.373" class="difflineplus">+    let oldAddEventListener = this.window.addEventListener;</span>
<a href="#l7.374"></a><span id="l7.374" class="difflineplus">+    this.window.addEventListener = function(type, listener, useCapture, ...args) {</span>
<a href="#l7.375"></a><span id="l7.375" class="difflineplus">+      if (type == &quot;load&quot;) {</span>
<a href="#l7.376"></a><span id="l7.376" class="difflineplus">+        if (typeof useCapture == &quot;object&quot;) {</span>
<a href="#l7.377"></a><span id="l7.377" class="difflineplus">+          useCapture = useCapture.capture;</span>
<a href="#l7.378"></a><span id="l7.378" class="difflineplus">+        }</span>
<a href="#l7.379"></a><span id="l7.379" class="difflineplus">+</span>
<a href="#l7.380"></a><span id="l7.380" class="difflineplus">+        if (typeof useCapture == &quot;undefined&quot;) {</span>
<a href="#l7.381"></a><span id="l7.381" class="difflineplus">+          useCapture = true;</span>
<a href="#l7.382"></a><span id="l7.382" class="difflineplus">+        }</span>
<a href="#l7.383"></a><span id="l7.383" class="difflineplus">+        deferredLoad.push({ listener, useCapture });</span>
<a href="#l7.384"></a><span id="l7.384" class="difflineplus">+        return null;</span>
<a href="#l7.385"></a><span id="l7.385" class="difflineplus">+      }</span>
<a href="#l7.386"></a><span id="l7.386" class="difflineplus">+      return oldAddEventListener.call(this, type, listener, useCapture, ...args);</span>
<a href="#l7.387"></a><span id="l7.387" class="difflineplus">+    };</span>
<a href="#l7.388"></a><span id="l7.388" class="difflineplus">+</span>
<a href="#l7.389"></a><span id="l7.389" class="difflineplus">+    if (node.hasAttribute(&quot;src&quot;)) {</span>
<a href="#l7.390"></a><span id="l7.390" class="difflineplus">+      let url = node.getAttribute(&quot;src&quot;);</span>
<a href="#l7.391"></a><span id="l7.391" class="difflineplus">+      oconsole.debug(`Loading script ${url} into ${this.window.location}`);</span>
<a href="#l7.392"></a><span id="l7.392" class="difflineplus">+      try {</span>
<a href="#l7.393"></a><span id="l7.393" class="difflineplus">+        Services.scriptloader.loadSubScript(url, this.window);</span>
<a href="#l7.394"></a><span id="l7.394" class="difflineplus">+      } catch (ex) {</span>
<a href="#l7.395"></a><span id="l7.395" class="difflineplus">+        oconsole.error(`Error loading script ${url} into ${this.window.location}`, ex.message);</span>
<a href="#l7.396"></a><span id="l7.396" class="difflineplus">+      }</span>
<a href="#l7.397"></a><span id="l7.397" class="difflineplus">+    } else if (node.textContent) {</span>
<a href="#l7.398"></a><span id="l7.398" class="difflineplus">+      oconsole.debug(`Loading eval'd script into ${this.window.location}`);</span>
<a href="#l7.399"></a><span id="l7.399" class="difflineplus">+      try {</span>
<a href="#l7.400"></a><span id="l7.400" class="difflineplus">+        // It would be great if we could have script errors show the right url, but for now</span>
<a href="#l7.401"></a><span id="l7.401" class="difflineplus">+        // window.eval will have to do.</span>
<a href="#l7.402"></a><span id="l7.402" class="difflineplus">+        this.window.eval(node.textContent);</span>
<a href="#l7.403"></a><span id="l7.403" class="difflineplus">+      } catch (ex) {</span>
<a href="#l7.404"></a><span id="l7.404" class="difflineplus">+        oconsole.error(`Error loading eval script from ${node.baseURI} into ` +</span>
<a href="#l7.405"></a><span id="l7.405" class="difflineplus">+                       this.window.location, ex.message);</span>
<a href="#l7.406"></a><span id="l7.406" class="difflineplus">+      }</span>
<a href="#l7.407"></a><span id="l7.407" class="difflineplus">+    }</span>
<a href="#l7.408"></a><span id="l7.408" class="difflineplus">+</span>
<a href="#l7.409"></a><span id="l7.409" class="difflineplus">+    this.window.addEventListener = oldAddEventListener;</span>
<a href="#l7.410"></a><span id="l7.410" class="difflineplus">+</span>
<a href="#l7.411"></a><span id="l7.411" class="difflineplus">+    // This works because we only care about immediately executed addEventListener calls and</span>
<a href="#l7.412"></a><span id="l7.412" class="difflineplus">+    // loadSubScript is synchronous. Everyone else should be checking readyState anyway.</span>
<a href="#l7.413"></a><span id="l7.413" class="difflineplus">+    return deferredLoad;</span>
<a href="#l7.414"></a><span id="l7.414" class="difflineplus">+  }</span>
<a href="#l7.415"></a><span id="l7.415" class="difflineplus">+</span>
<a href="#l7.416"></a><span id="l7.416" class="difflineplus">+  /**</span>
<a href="#l7.417"></a><span id="l7.417" class="difflineplus">+   * Load the CSS stylesheet from the given url</span>
<a href="#l7.418"></a><span id="l7.418" class="difflineplus">+   *</span>
<a href="#l7.419"></a><span id="l7.419" class="difflineplus">+   * @param {String} url        The url to load from</span>
<a href="#l7.420"></a><span id="l7.420" class="difflineplus">+   */</span>
<a href="#l7.421"></a><span id="l7.421" class="difflineplus">+  loadCSS(url) {</span>
<a href="#l7.422"></a><span id="l7.422" class="difflineplus">+    oconsole.debug(`Loading ${url} into ${this.window.location}`);</span>
<a href="#l7.423"></a><span id="l7.423" class="difflineplus">+</span>
<a href="#l7.424"></a><span id="l7.424" class="difflineplus">+    // domWindowUtils.loadSheetUsingURIString doesn't record the sheet in document.styleSheets,</span>
<a href="#l7.425"></a><span id="l7.425" class="difflineplus">+    // adding a html link element seems to do so.</span>
<a href="#l7.426"></a><span id="l7.426" class="difflineplus">+    let link = this.document.createElementNS(&quot;http://www.w3.org/1999/xhtml&quot;, &quot;link&quot;);</span>
<a href="#l7.427"></a><span id="l7.427" class="difflineplus">+    link.setAttribute(&quot;rel&quot;, &quot;stylesheet&quot;);</span>
<a href="#l7.428"></a><span id="l7.428" class="difflineplus">+    link.setAttribute(&quot;type&quot;, &quot;text/css&quot;);</span>
<a href="#l7.429"></a><span id="l7.429" class="difflineplus">+    link.setAttribute(&quot;href&quot;, url);</span>
<a href="#l7.430"></a><span id="l7.430" class="difflineplus">+</span>
<a href="#l7.431"></a><span id="l7.431" class="difflineplus">+    this.document.documentElement.appendChild(link);</span>
<a href="#l7.432"></a><span id="l7.432" class="difflineplus">+  }</span>
<a href="#l7.433"></a><span id="l7.433" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/common/src/extensionSupport.jsm</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/common/src/extensionSupport.jsm</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -1,16 +1,15 @@</span>
<a href="#l8.4"></a><span id="l8.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l8.5"></a><span id="l8.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l8.6"></a><span id="l8.6">  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l8.7"></a><span id="l8.7"> </span>
<a href="#l8.8"></a><span id="l8.8"> /**</span>
<a href="#l8.9"></a><span id="l8.9">  * Helper functions for use by entensions that should ease them plug</span>
<a href="#l8.10"></a><span id="l8.10">  * into the application.</span>
<a href="#l8.11"></a><span id="l8.11" class="difflineminus">- *</span>
<a href="#l8.12"></a><span id="l8.12">  */</span>
<a href="#l8.13"></a><span id="l8.13"> </span>
<a href="#l8.14"></a><span id="l8.14"> this.EXPORTED_SYMBOLS = [ &quot;extensionDefaults&quot;, &quot;ExtensionSupport&quot; ];</span>
<a href="#l8.15"></a><span id="l8.15"> </span>
<a href="#l8.16"></a><span id="l8.16"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l8.17"></a><span id="l8.17"> // ChromeUtils.import(&quot;resource://gre/modules/Deprecated.jsm&quot;) - needed for warning.</span>
<a href="#l8.18"></a><span id="l8.18"> ChromeUtils.import(&quot;resource://gre/modules/NetUtil.jsm&quot;);</span>
<a href="#l8.19"></a><span id="l8.19"> </span>
<a href="#l8.20"></a><span id="l8.20" class="difflineat">@@ -20,90 +19,98 @@ ChromeUtils.import(&quot;resource:///modules/</span>
<a href="#l8.21"></a><span id="l8.21"> var extensionHooks = new Map();</span>
<a href="#l8.22"></a><span id="l8.22"> var openWindowList;</span>
<a href="#l8.23"></a><span id="l8.23"> </span>
<a href="#l8.24"></a><span id="l8.24"> /**</span>
<a href="#l8.25"></a><span id="l8.25">  * Reads preferences from addon provided locations (defaults/preferences/*.js)</span>
<a href="#l8.26"></a><span id="l8.26">  * and stores them in the default preferences branch.</span>
<a href="#l8.27"></a><span id="l8.27">  */</span>
<a href="#l8.28"></a><span id="l8.28"> function extensionDefaults() {</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineplus">+  // Fetch enabled non-bootstrapped add-ons.</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineplus">+  let enabledAddons = Services.dirsvc.get(&quot;XREExtDL&quot;, Ci.nsISimpleEnumerator);</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineplus">+  for (let addonFile of fixIterator(enabledAddons, Ci.nsIFile)) {</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+    loadAddonPrefs(addonFile);</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+  }</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+}</span>
<a href="#l8.35"></a><span id="l8.35"> </span>
<a href="#l8.36"></a><span id="l8.36" class="difflineminus">-  function setPref(preferDefault, name, value) {</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineminus">-    let branch = Services.prefs.getBranch(&quot;&quot;);</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineminus">-    if (preferDefault) {</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineminus">-      let defaultBranch = Services.prefs.getDefaultBranch(&quot;&quot;);</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineminus">-      if (defaultBranch.getPrefType(name) == Ci.nsIPrefBranch.PREF_INVALID) {</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineminus">-        // Only use the default branch if it doesn't already have the pref set.</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineminus">-        // If there is already a pref with this value on the default branch, the</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineminus">-        // extension wants to override a built-in value.</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineminus">-        branch = defaultBranch;</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineminus">-      } else if (defaultBranch.prefHasUserValue(name)) {</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineminus">-        // If a pref already has a user-set value it proper type</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineminus">-        // will be returned (not PREF_INVALID). In that case keep the user's</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineminus">-        // value and overwrite the default.</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineminus">-        branch = defaultBranch;</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineplus">+var ExtensionSupport = {</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+  loadAddonPrefs(addonFile) {</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineplus">+    function setPref(preferDefault, name, value) {</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineplus">+      let branch = Services.prefs.getBranch(&quot;&quot;);</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineplus">+      if (preferDefault) {</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineplus">+        let defaultBranch = Services.prefs.getDefaultBranch(&quot;&quot;);</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineplus">+        if (defaultBranch.getPrefType(name) == Ci.nsIPrefBranch.PREF_INVALID) {</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineplus">+          // Only use the default branch if it doesn't already have the pref set.</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineplus">+          // If there is already a pref with this value on the default branch, the</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineplus">+          // extension wants to override a built-in value.</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineplus">+          branch = defaultBranch;</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineplus">+        } else if (defaultBranch.prefHasUserValue(name)) {</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineplus">+          // If a pref already has a user-set value it proper type</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineplus">+          // will be returned (not PREF_INVALID). In that case keep the user's</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineplus">+          // value and overwrite the default.</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineplus">+          branch = defaultBranch;</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineplus">+        }</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineplus">+      }</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineplus">+</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineplus">+      if (typeof value == &quot;boolean&quot;) {</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineplus">+        branch.setBoolPref(name, value);</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineplus">+      } else if (typeof value == &quot;string&quot;) {</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineplus">+        if (value.startsWith(&quot;chrome://&quot;) &amp;&amp; value.endsWith(&quot;.properties&quot;)) {</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineplus">+          let valueLocal = Cc[&quot;@mozilla.org/pref-localizedstring;1&quot;]</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineplus">+                           .createInstance(Ci.nsIPrefLocalizedString);</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineplus">+          valueLocal.data = value;</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineplus">+          branch.setComplexValue(name, Ci.nsIPrefLocalizedString, valueLocal);</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineplus">+        } else {</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineplus">+          branch.setStringPref(name, value);</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineplus">+        }</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineplus">+      } else if (typeof value == &quot;number&quot; &amp;&amp; Number.isInteger(value)) {</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineplus">+        branch.setIntPref(name, value);</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineplus">+      } else if (typeof value == &quot;number&quot; &amp;&amp; Number.isFloat(value)) {</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineplus">+        // Floats are set as char prefs, then retrieved using getFloatPref</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineplus">+        branch.setCharPref(name, value);</span>
<a href="#l8.85"></a><span id="l8.85">       }</span>
<a href="#l8.86"></a><span id="l8.86">     }</span>
<a href="#l8.87"></a><span id="l8.87"> </span>
<a href="#l8.88"></a><span id="l8.88" class="difflineminus">-    if (typeof value == &quot;boolean&quot;) {</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineminus">-      branch.setBoolPref(name, value);</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineminus">-    } else if (typeof value == &quot;string&quot;) {</span>
<a href="#l8.91"></a><span id="l8.91" class="difflineminus">-      if (value.startsWith(&quot;chrome://&quot;) &amp;&amp; value.endsWith(&quot;.properties&quot;)) {</span>
<a href="#l8.92"></a><span id="l8.92" class="difflineminus">-        let valueLocal = Cc[&quot;@mozilla.org/pref-localizedstring;1&quot;]</span>
<a href="#l8.93"></a><span id="l8.93" class="difflineminus">-                         .createInstance(Ci.nsIPrefLocalizedString);</span>
<a href="#l8.94"></a><span id="l8.94" class="difflineminus">-        valueLocal.data = value;</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineminus">-        branch.setComplexValue(name, Ci.nsIPrefLocalizedString, valueLocal);</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineminus">-      } else {</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineminus">-        branch.setStringPref(name, value);</span>
<a href="#l8.98"></a><span id="l8.98" class="difflineminus">-      }</span>
<a href="#l8.99"></a><span id="l8.99" class="difflineminus">-    } else if (typeof value == &quot;number&quot; &amp;&amp; Number.isInteger(value)) {</span>
<a href="#l8.100"></a><span id="l8.100" class="difflineminus">-      branch.setIntPref(name, value);</span>
<a href="#l8.101"></a><span id="l8.101" class="difflineminus">-    } else if (typeof value == &quot;number&quot; &amp;&amp; Number.isFloat(value)) {</span>
<a href="#l8.102"></a><span id="l8.102" class="difflineminus">-      // Floats are set as char prefs, then retrieved using getFloatPref</span>
<a href="#l8.103"></a><span id="l8.103" class="difflineminus">-      branch.setCharPref(name, value);</span>
<a href="#l8.104"></a><span id="l8.104" class="difflineminus">-    }</span>
<a href="#l8.105"></a><span id="l8.105" class="difflineminus">-  }</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineminus">-</span>
<a href="#l8.107"></a><span id="l8.107" class="difflineminus">-  function walkExtensionPrefs(prefFile) {</span>
<a href="#l8.108"></a><span id="l8.108" class="difflineminus">-    let foundPrefStrings = [];</span>
<a href="#l8.109"></a><span id="l8.109" class="difflineminus">-    if (!prefFile.exists())</span>
<a href="#l8.110"></a><span id="l8.110" class="difflineminus">-      return [];</span>
<a href="#l8.111"></a><span id="l8.111" class="difflineminus">-</span>
<a href="#l8.112"></a><span id="l8.112" class="difflineminus">-    if (prefFile.isDirectory()) {</span>
<a href="#l8.113"></a><span id="l8.113" class="difflineminus">-      prefFile.append(&quot;defaults&quot;);</span>
<a href="#l8.114"></a><span id="l8.114" class="difflineminus">-      prefFile.append(&quot;preferences&quot;);</span>
<a href="#l8.115"></a><span id="l8.115" class="difflineminus">-      if (!prefFile.exists() || !prefFile.isDirectory())</span>
<a href="#l8.116"></a><span id="l8.116" class="difflineplus">+    function walkExtensionPrefs(extensionRoot) {</span>
<a href="#l8.117"></a><span id="l8.117" class="difflineplus">+      let prefFile = extensionRoot.clone();</span>
<a href="#l8.118"></a><span id="l8.118" class="difflineplus">+      let foundPrefStrings = [];</span>
<a href="#l8.119"></a><span id="l8.119" class="difflineplus">+      if (!prefFile.exists())</span>
<a href="#l8.120"></a><span id="l8.120">         return [];</span>
<a href="#l8.121"></a><span id="l8.121"> </span>
<a href="#l8.122"></a><span id="l8.122" class="difflineminus">-      for (let file of fixIterator(prefFile.directoryEntries, Ci.nsIFile)) {</span>
<a href="#l8.123"></a><span id="l8.123" class="difflineminus">-        if (file.isFile() &amp;&amp; file.leafName.toLowerCase().endsWith(&quot;.js&quot;)) {</span>
<a href="#l8.124"></a><span id="l8.124" class="difflineminus">-          foundPrefStrings.push(IOUtils.loadFileToString(file));</span>
<a href="#l8.125"></a><span id="l8.125" class="difflineplus">+      if (prefFile.isDirectory()) {</span>
<a href="#l8.126"></a><span id="l8.126" class="difflineplus">+        prefFile.append(&quot;defaults&quot;);</span>
<a href="#l8.127"></a><span id="l8.127" class="difflineplus">+        prefFile.append(&quot;preferences&quot;);</span>
<a href="#l8.128"></a><span id="l8.128" class="difflineplus">+        if (!prefFile.exists() || !prefFile.isDirectory())</span>
<a href="#l8.129"></a><span id="l8.129" class="difflineplus">+          return [];</span>
<a href="#l8.130"></a><span id="l8.130" class="difflineplus">+</span>
<a href="#l8.131"></a><span id="l8.131" class="difflineplus">+        for (let file of fixIterator(prefFile.directoryEntries, Ci.nsIFile)) {</span>
<a href="#l8.132"></a><span id="l8.132" class="difflineplus">+          if (file.isFile() &amp;&amp; file.leafName.toLowerCase().endsWith(&quot;.js&quot;)) {</span>
<a href="#l8.133"></a><span id="l8.133" class="difflineplus">+            foundPrefStrings.push(IOUtils.loadFileToString(file));</span>
<a href="#l8.134"></a><span id="l8.134" class="difflineplus">+          }</span>
<a href="#l8.135"></a><span id="l8.135" class="difflineplus">+        }</span>
<a href="#l8.136"></a><span id="l8.136" class="difflineplus">+      } else if (prefFile.isFile() &amp;&amp; prefFile.leafName.endsWith(&quot;xpi&quot;)) {</span>
<a href="#l8.137"></a><span id="l8.137" class="difflineplus">+        let zipReader = Cc[&quot;@mozilla.org/libjar/zip-reader;1&quot;]</span>
<a href="#l8.138"></a><span id="l8.138" class="difflineplus">+                          .createInstance(Ci.nsIZipReader);</span>
<a href="#l8.139"></a><span id="l8.139" class="difflineplus">+        zipReader.open(prefFile);</span>
<a href="#l8.140"></a><span id="l8.140" class="difflineplus">+        let entries = zipReader.findEntries(&quot;defaults/preferences/*.js&quot;);</span>
<a href="#l8.141"></a><span id="l8.141" class="difflineplus">+</span>
<a href="#l8.142"></a><span id="l8.142" class="difflineplus">+        while (entries.hasMore()) {</span>
<a href="#l8.143"></a><span id="l8.143" class="difflineplus">+          let entryName = entries.getNext();</span>
<a href="#l8.144"></a><span id="l8.144" class="difflineplus">+          let stream = zipReader.getInputStream(entryName);</span>
<a href="#l8.145"></a><span id="l8.145" class="difflineplus">+          let entrySize = zipReader.getEntry(entryName).realSize;</span>
<a href="#l8.146"></a><span id="l8.146" class="difflineplus">+          if (entrySize &gt; 0) {</span>
<a href="#l8.147"></a><span id="l8.147" class="difflineplus">+            let content = NetUtil.readInputStreamToString(stream, entrySize, { charset: &quot;utf-8&quot;, replacement: &quot;?&quot; });</span>
<a href="#l8.148"></a><span id="l8.148" class="difflineplus">+            foundPrefStrings.push(content);</span>
<a href="#l8.149"></a><span id="l8.149" class="difflineplus">+          }</span>
<a href="#l8.150"></a><span id="l8.150">         }</span>
<a href="#l8.151"></a><span id="l8.151">       }</span>
<a href="#l8.152"></a><span id="l8.152" class="difflineminus">-    } else if (prefFile.isFile() &amp;&amp; prefFile.leafName.endsWith(&quot;xpi&quot;)) {</span>
<a href="#l8.153"></a><span id="l8.153" class="difflineminus">-      let zipReader = Cc[&quot;@mozilla.org/libjar/zip-reader;1&quot;]</span>
<a href="#l8.154"></a><span id="l8.154" class="difflineminus">-                        .createInstance(Ci.nsIZipReader);</span>
<a href="#l8.155"></a><span id="l8.155" class="difflineminus">-      zipReader.open(prefFile);</span>
<a href="#l8.156"></a><span id="l8.156" class="difflineminus">-      let entries = zipReader.findEntries(&quot;defaults/preferences/*.js&quot;);</span>
<a href="#l8.157"></a><span id="l8.157"> </span>
<a href="#l8.158"></a><span id="l8.158" class="difflineminus">-      while (entries.hasMore()) {</span>
<a href="#l8.159"></a><span id="l8.159" class="difflineminus">-        let entryName = entries.getNext();</span>
<a href="#l8.160"></a><span id="l8.160" class="difflineminus">-        let stream = zipReader.getInputStream(entryName);</span>
<a href="#l8.161"></a><span id="l8.161" class="difflineminus">-        let entrySize = zipReader.getEntry(entryName).realSize;</span>
<a href="#l8.162"></a><span id="l8.162" class="difflineminus">-        if (entrySize &gt; 0) {</span>
<a href="#l8.163"></a><span id="l8.163" class="difflineminus">-          let content = NetUtil.readInputStreamToString(stream, entrySize, { charset: &quot;utf-8&quot;, replacement: &quot;?&quot; });</span>
<a href="#l8.164"></a><span id="l8.164" class="difflineminus">-          foundPrefStrings.push(content);</span>
<a href="#l8.165"></a><span id="l8.165" class="difflineminus">-        }</span>
<a href="#l8.166"></a><span id="l8.166" class="difflineminus">-      }</span>
<a href="#l8.167"></a><span id="l8.167" class="difflineplus">+      return foundPrefStrings;</span>
<a href="#l8.168"></a><span id="l8.168">     }</span>
<a href="#l8.169"></a><span id="l8.169"> </span>
<a href="#l8.170"></a><span id="l8.170" class="difflineminus">-    return foundPrefStrings;</span>
<a href="#l8.171"></a><span id="l8.171" class="difflineminus">-  }</span>
<a href="#l8.172"></a><span id="l8.172" class="difflineminus">-</span>
<a href="#l8.173"></a><span id="l8.173" class="difflineminus">-  function loadAddonPrefs(addonFile) {</span>
<a href="#l8.174"></a><span id="l8.174">     let sandbox = new Cu.Sandbox(null);</span>
<a href="#l8.175"></a><span id="l8.175">     sandbox.pref = setPref.bind(undefined, true);</span>
<a href="#l8.176"></a><span id="l8.176">     sandbox.user_pref = setPref.bind(undefined, false);</span>
<a href="#l8.177"></a><span id="l8.177"> </span>
<a href="#l8.178"></a><span id="l8.178">     let prefDataStrings = walkExtensionPrefs(addonFile);</span>
<a href="#l8.179"></a><span id="l8.179">     for (let prefDataString of prefDataStrings) {</span>
<a href="#l8.180"></a><span id="l8.180">       try {</span>
<a href="#l8.181"></a><span id="l8.181">         Cu.evalInSandbox(prefDataString, sandbox);</span>
<a href="#l8.182"></a><span id="l8.182" class="difflineat">@@ -114,26 +121,18 @@ function extensionDefaults() {</span>
<a href="#l8.183"></a><span id="l8.183"> </span>
<a href="#l8.184"></a><span id="l8.184">     /*</span>
<a href="#l8.185"></a><span id="l8.185">     TODO: decide whether we need to warn the user/make addon authors to migrate away from these pref files.</span>
<a href="#l8.186"></a><span id="l8.186">     if (prefDataStrings.length &gt; 0) {</span>
<a href="#l8.187"></a><span id="l8.187">       Deprecated.warning(addon.defaultLocale.name + &quot; uses defaults/preferences/*.js files to load prefs&quot;,</span>
<a href="#l8.188"></a><span id="l8.188">                          &quot;https://bugzilla.mozilla.org/show_bug.cgi?id=1414398&quot;);</span>
<a href="#l8.189"></a><span id="l8.189">     }</span>
<a href="#l8.190"></a><span id="l8.190">     */</span>
<a href="#l8.191"></a><span id="l8.191" class="difflineminus">-  }</span>
<a href="#l8.192"></a><span id="l8.192" class="difflineplus">+  },</span>
<a href="#l8.193"></a><span id="l8.193"> </span>
<a href="#l8.194"></a><span id="l8.194" class="difflineminus">-  // Fetch enabled non-bootstrapped add-ons.</span>
<a href="#l8.195"></a><span id="l8.195" class="difflineminus">-  let enabledAddons = Services.dirsvc.get(&quot;XREExtDL&quot;, Ci.nsISimpleEnumerator);</span>
<a href="#l8.196"></a><span id="l8.196" class="difflineminus">-  for (let addonFile of fixIterator(enabledAddons, Ci.nsIFile)) {</span>
<a href="#l8.197"></a><span id="l8.197" class="difflineminus">-    loadAddonPrefs(addonFile);</span>
<a href="#l8.198"></a><span id="l8.198" class="difflineminus">-  }</span>
<a href="#l8.199"></a><span id="l8.199" class="difflineminus">-}</span>
<a href="#l8.200"></a><span id="l8.200" class="difflineminus">-</span>
<a href="#l8.201"></a><span id="l8.201" class="difflineminus">-var ExtensionSupport = {</span>
<a href="#l8.202"></a><span id="l8.202">   /**</span>
<a href="#l8.203"></a><span id="l8.203">    * Register listening for windows getting opened that will run the specified callback function</span>
<a href="#l8.204"></a><span id="l8.204">    * when a matching window is loaded.</span>
<a href="#l8.205"></a><span id="l8.205">    *</span>
<a href="#l8.206"></a><span id="l8.206">    * @param aID {String}  Some identification of the caller, usually the extension ID.</span>
<a href="#l8.207"></a><span id="l8.207">    * @param aExtensionHook {Object}  The object describing the hook the caller wants to register.</span>
<a href="#l8.208"></a><span id="l8.208">    *        Members of the object can be (all optional, but one callback must be supplied):</span>
<a href="#l8.209"></a><span id="l8.209">    *        chromeURLs {Array}         An array of strings of document URLs on which</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/common/src/moz.build</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/common/src/moz.build</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -1,8 +1,17 @@</span>
<a href="#l9.4"></a><span id="l9.4"> # vim: set filetype=python:</span>
<a href="#l9.5"></a><span id="l9.5"> # This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l9.6"></a><span id="l9.6"> # License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l9.7"></a><span id="l9.7"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l9.8"></a><span id="l9.8"> </span>
<a href="#l9.9"></a><span id="l9.9"> EXTRA_JS_MODULES += [</span>
<a href="#l9.10"></a><span id="l9.10" class="difflineplus">+    'ChromeManifest.jsm',</span>
<a href="#l9.11"></a><span id="l9.11">     'extensionSupport.jsm',</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+    'Overlays.jsm'</span>
<a href="#l9.13"></a><span id="l9.13"> ]</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+SOURCES += [</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+    'nsCommonModule.cpp',</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+    'nsComponentManagerExtra.cpp'</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+]</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineplus">+</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineplus">+FINAL_LIBRARY = 'xul'</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1">new file mode 100644</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineminus">--- /dev/null</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineplus">+++ b/common/src/nsCommonModule.cpp</span>
<a href="#l10.4"></a><span id="l10.4" class="difflineat">@@ -0,0 +1,28 @@</span>
<a href="#l10.5"></a><span id="l10.5" class="difflineplus">+#include &quot;mozilla/ModuleUtils.h&quot;</span>
<a href="#l10.6"></a><span id="l10.6" class="difflineplus">+#include &quot;nsCommonBaseCID.h&quot;</span>
<a href="#l10.7"></a><span id="l10.7" class="difflineplus">+#include &quot;nsComponentManagerExtra.h&quot;</span>
<a href="#l10.8"></a><span id="l10.8" class="difflineplus">+</span>
<a href="#l10.9"></a><span id="l10.9" class="difflineplus">+NS_GENERIC_FACTORY_CONSTRUCTOR(nsComponentManagerExtra)</span>
<a href="#l10.10"></a><span id="l10.10" class="difflineplus">+NS_DEFINE_NAMED_CID(NS_COMPONENTMANAGEREXTRA_CID);</span>
<a href="#l10.11"></a><span id="l10.11" class="difflineplus">+</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+const mozilla::Module::CIDEntry kCommonCIDs[] = {</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+  { &amp;kNS_COMPONENTMANAGEREXTRA_CID, false, nullptr, nsComponentManagerExtraConstructor },</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+  { nullptr }</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+};</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+const mozilla::Module::ContractIDEntry kCommonContracts[] = {</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineplus">+  { NS_COMPONENTMANAGEREXTRA_CONTRACTID, &amp;kNS_COMPONENTMANAGEREXTRA_CID },</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineplus">+  { nullptr }</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineplus">+};</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineplus">+</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineplus">+static const mozilla::Module kCommonModule = {</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineplus">+  mozilla::Module::kVersion,</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineplus">+  kCommonCIDs,</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineplus">+  kCommonContracts,</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineplus">+  nullptr,</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineplus">+  nullptr,</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineplus">+  nullptr,</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineplus">+  nullptr</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineplus">+};</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineplus">+</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineplus">+NSMODULE_DEFN(nsCommonModule) = &amp;kCommonModule;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1">new file mode 100644</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineminus">--- /dev/null</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineplus">+++ b/common/src/nsComponentManagerExtra.cpp</span>
<a href="#l11.4"></a><span id="l11.4" class="difflineat">@@ -0,0 +1,46 @@</span>
<a href="#l11.5"></a><span id="l11.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l11.6"></a><span id="l11.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l11.7"></a><span id="l11.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l11.8"></a><span id="l11.8" class="difflineplus">+</span>
<a href="#l11.9"></a><span id="l11.9" class="difflineplus">+#include &quot;nsIServiceManager.h&quot;</span>
<a href="#l11.10"></a><span id="l11.10" class="difflineplus">+#include &quot;nsCommonBaseCID.h&quot;</span>
<a href="#l11.11"></a><span id="l11.11" class="difflineplus">+#include &quot;nsComponentManagerExtra.h&quot;</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+#include &quot;mozilla/Services.h&quot;</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+#include &quot;nsXULAppAPI.h&quot;</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+static already_AddRefed&lt;nsIFile&gt;</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineplus">+CloneAndAppend(nsIFile* aBase, const nsACString&amp; aAppend)</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineplus">+{</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; f;</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineplus">+  aBase-&gt;Clone(getter_AddRefs(f));</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineplus">+  if (!f) {</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineplus">+    return nullptr;</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineplus">+  }</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineplus">+</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineplus">+  f-&gt;AppendNative(aAppend);</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineplus">+  return f.forget();</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineplus">+}</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineplus">+</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineplus">+NS_IMPL_ISUPPORTS(nsComponentManagerExtra,</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineplus">+                  nsIComponentManagerExtra)</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineplus">+</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineplus">+NS_IMETHODIMP nsComponentManagerExtra::AddLegacyExtensionManifestLocation(nsIFile *aLocation)</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineplus">+{</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineplus">+  nsString path;</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineplus">+  nsresult rv = aLocation-&gt;GetPath(path);</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineplus">+    return rv;</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineplus">+  }</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineplus">+</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineplus">+  if (Substring(path, path.Length() - 4).EqualsLiteral(&quot;.xpi&quot;)) {</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineplus">+    return XRE_AddJarManifestLocation(NS_EXTENSION_LOCATION, aLocation);</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineplus">+  }</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineplus">+</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; manifest =</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineplus">+    CloneAndAppend(aLocation, NS_LITERAL_CSTRING(&quot;chrome.manifest&quot;));</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineplus">+  return XRE_AddManifestLocation(NS_EXTENSION_LOCATION, manifest);</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineplus">+}</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineplus">+</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineplus">+nsComponentManagerExtra::~nsComponentManagerExtra()</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineplus">+{</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1">new file mode 100644</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineminus">--- /dev/null</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineplus">+++ b/common/src/nsComponentManagerExtra.h</span>
<a href="#l12.4"></a><span id="l12.4" class="difflineat">@@ -0,0 +1,20 @@</span>
<a href="#l12.5"></a><span id="l12.5" class="difflineplus">+</span>
<a href="#l12.6"></a><span id="l12.6" class="difflineplus">+#ifndef nsComponentManagerExtra_h__</span>
<a href="#l12.7"></a><span id="l12.7" class="difflineplus">+#define nsComponentManagerExtra_h__</span>
<a href="#l12.8"></a><span id="l12.8" class="difflineplus">+</span>
<a href="#l12.9"></a><span id="l12.9" class="difflineplus">+#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l12.10"></a><span id="l12.10" class="difflineplus">+#include &quot;nsIComponentManagerExtra.h&quot;</span>
<a href="#l12.11"></a><span id="l12.11" class="difflineplus">+#include &quot;nsLiteralString.h&quot;</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+class nsComponentManagerExtra : public nsIComponentManagerExtra</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+{</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+public:</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineplus">+</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineplus">+  NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineplus">+  NS_DECL_NSICOMPONENTMANAGEREXTRA</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineplus">+</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineplus">+private:</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineplus">+  virtual ~nsComponentManagerExtra();</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineplus">+};</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineplus">+</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineplus">+#endif // nsComponentManagerExtra_h__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1">new file mode 100644</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineminus">--- /dev/null</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineplus">+++ b/mail/base/content/extensions.xml</span>
<a href="#l13.4"></a><span id="l13.4" class="difflineat">@@ -0,0 +1,54 @@</span>
<a href="#l13.5"></a><span id="l13.5" class="difflineplus">+&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<a href="#l13.6"></a><span id="l13.6" class="difflineplus">+</span>
<a href="#l13.7"></a><span id="l13.7" class="difflineplus">+&lt;!DOCTYPE bindings&gt;</span>
<a href="#l13.8"></a><span id="l13.8" class="difflineplus">+</span>
<a href="#l13.9"></a><span id="l13.9" class="difflineplus">+&lt;bindings id=&quot;thunderbird-addon-bindings&quot;</span>
<a href="#l13.10"></a><span id="l13.10" class="difflineplus">+          xmlns=&quot;http://www.mozilla.org/xbl&quot;</span>
<a href="#l13.11"></a><span id="l13.11" class="difflineplus">+          xmlns:xul=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+          xmlns:xbl=&quot;http://www.mozilla.org/xbl&quot;&gt;</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+  &lt;binding id=&quot;thunderbird-addon-generic&quot;</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+           extends=&quot;chrome://mozapps/content/extensions/extensions.xml#addon-generic&quot;&gt;</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+    &lt;implementation&gt;</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineplus">+      &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineplus">+        ChromeUtils.import(&quot;resource://gre/modules/ExtensionParent.jsm&quot;);</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineplus">+        ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineplus">+        this._updateState = this._updateState.bind(this);</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineplus">+        ExtensionParent.apiManager.on(&quot;startup&quot;, this._updateState);</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineplus">+        ExtensionParent.apiManager.on(&quot;shutdown&quot;, this._updateState);</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineplus">+</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineplus">+        this._bundle = Services.strings.createBundle(&quot;chrome://messenger/locale/extensionsOverlay.properties&quot;);</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineplus">+      ]]&gt;&lt;/constructor&gt;</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineplus">+      &lt;destructor&gt;&lt;![CDATA[</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineplus">+        ExtensionParent.apiManager.off(&quot;startup&quot;, this._updateState);</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineplus">+        ExtensionParent.apiManager.off(&quot;shutdown&quot;, this._updateState);</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineplus">+      ]]&gt;&lt;/destructor&gt;</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineplus">+      &lt;property name=&quot;webextension&quot;&gt;</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineplus">+        &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineplus">+          if (!this._webextension) {</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineplus">+            this._webextension = ExtensionParent.GlobalManager.getExtension(this.mAddon.id);</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineplus">+          }</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineplus">+          return this._webextension;</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineplus">+        ]]&gt;&lt;/getter&gt;</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineplus">+      &lt;/property&gt;</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineplus">+      &lt;method name=&quot;_updateState&quot;&gt;</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineplus">+        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineplus">+          this.__proto__.__proto__._updateState.call(this);</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineplus">+          let id = this.mAddon.id;</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineplus">+          let webex = this.webextension;</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineplus">+</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineplus">+          if (webex &amp;&amp; webex.manifest.legacy &amp;&amp; (</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineplus">+                (webex.startupReason != &quot;APP_STARTUP&quot; &amp;&amp; !webex.legacyLoaded) ||</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineplus">+                (this.mAddon.userDisabled &amp;&amp; webex.legacyLoaded)</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineplus">+              )) {</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineplus">+            this.setAttribute(&quot;notification&quot;, &quot;warning&quot;);</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineplus">+            this._warning.textContent = this._bundle.GetStringFromName(&quot;warnLegacyRestart&quot;);</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineplus">+            this._warningBtn.label = this._bundle.GetStringFromName(&quot;warnLegacyRestartButton&quot;);</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineplus">+            this._warningBtn.setAttribute(&quot;oncommand&quot;, &quot;BrowserUtils.restartApplication()&quot;);</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineplus">+            this._warningBtn.hidden = false;</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineplus">+            this._warningLink.hidden = true;</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineplus">+          }</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineplus">+        ]]&gt;&lt;/body&gt;</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineplus">+      &lt;/method&gt;</span>
<a href="#l13.56"></a><span id="l13.56" class="difflineplus">+    &lt;/implementation&gt;</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineplus">+  &lt;/binding&gt;</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineplus">+&lt;/bindings&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mail/base/content/extensionsOverlay.css</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mail/base/content/extensionsOverlay.css</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -6,8 +6,12 @@</span>
<a href="#l14.4"></a><span id="l14.4"> </span>
<a href="#l14.5"></a><span id="l14.5"> .legacy-warning {</span>
<a href="#l14.6"></a><span id="l14.6">   display: none;</span>
<a href="#l14.7"></a><span id="l14.7"> }</span>
<a href="#l14.8"></a><span id="l14.8"> </span>
<a href="#l14.9"></a><span id="l14.9"> #nav-header {</span>
<a href="#l14.10"></a><span id="l14.10">   height: 50px;</span>
<a href="#l14.11"></a><span id="l14.11"> }</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineplus">+</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+.addon[status=&quot;installed&quot;] {</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+  -moz-binding: url(&quot;chrome://messenger/content/extensions.xml#thunderbird-addon-generic&quot;);</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mail/base/jar.mn</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mail/base/jar.mn</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -6,16 +6,17 @@ messenger.jar:</span>
<a href="#l15.4"></a><span id="l15.4"> % override chrome://global/content/nsDragAndDrop.js chrome://messenger/content/nsDragAndDrop.js</span>
<a href="#l15.5"></a><span id="l15.5"> % override chrome://messagebody/skin/messageBody.css chrome://messenger/skin/messageBody.css</span>
<a href="#l15.6"></a><span id="l15.6"> #ifndef MOZILLA_OFFICIAL</span>
<a href="#l15.7"></a><span id="l15.7"> % override chrome://browser/content/browser-development-helpers.js chrome://messenger/content/browser-development-helpers.js</span>
<a href="#l15.8"></a><span id="l15.8">   content/messenger/browser-development-helpers.js (../../common/src/browser-development-helpers.js)</span>
<a href="#l15.9"></a><span id="l15.9"> #endif</span>
<a href="#l15.10"></a><span id="l15.10">     content/messenger/mailWindow.js                 (content/mailWindow.js)</span>
<a href="#l15.11"></a><span id="l15.11">     content/messenger/messageDisplay.js             (content/messageDisplay.js)</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineplus">+    content/messenger/extensions.xml                (content/extensions.xml)</span>
<a href="#l15.13"></a><span id="l15.13">     content/messenger/extensionsOverlay.css         (content/extensionsOverlay.css)</span>
<a href="#l15.14"></a><span id="l15.14">     content/messenger/folderDisplay.js              (content/folderDisplay.js)</span>
<a href="#l15.15"></a><span id="l15.15">     content/messenger/mailWindowOverlay.js          (content/mailWindowOverlay.js)</span>
<a href="#l15.16"></a><span id="l15.16">     content/messenger/mail-compacttheme.js          (content/mail-compacttheme.js)</span>
<a href="#l15.17"></a><span id="l15.17"> *   content/messenger/mailOverlay.xul               (content/mailOverlay.xul)</span>
<a href="#l15.18"></a><span id="l15.18"> *   content/messenger/messageWindow.xul             (content/messageWindow.xul)</span>
<a href="#l15.19"></a><span id="l15.19">     content/messenger/messageWindow.js              (content/messageWindow.js)</span>
<a href="#l15.20"></a><span id="l15.20">     content/messenger/mailContextMenus.js           (content/mailContextMenus.js)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mail/components/extensions/ext-mail.json</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mail/components/extensions/ext-mail.json</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -1,9 +1,15 @@</span>
<a href="#l16.4"></a><span id="l16.4"> {</span>
<a href="#l16.5"></a><span id="l16.5" class="difflineplus">+  &quot;legacy&quot;: {</span>
<a href="#l16.6"></a><span id="l16.6" class="difflineplus">+    &quot;url&quot;: &quot;chrome://messenger/content/parent/ext-legacy.js&quot;,</span>
<a href="#l16.7"></a><span id="l16.7" class="difflineplus">+    &quot;schema&quot;: &quot;chrome://messenger/content/schemas/legacy.json&quot;,</span>
<a href="#l16.8"></a><span id="l16.8" class="difflineplus">+    &quot;scopes&quot;: [&quot;addon_parent&quot;],</span>
<a href="#l16.9"></a><span id="l16.9" class="difflineplus">+    &quot;manifest&quot;: [&quot;legacy&quot;]</span>
<a href="#l16.10"></a><span id="l16.10" class="difflineplus">+  },</span>
<a href="#l16.11"></a><span id="l16.11">   &quot;tabs&quot;: {</span>
<a href="#l16.12"></a><span id="l16.12">     &quot;url&quot;: &quot;chrome://messenger/content/parent/ext-tabs.js&quot;,</span>
<a href="#l16.13"></a><span id="l16.13">     &quot;schema&quot;: &quot;chrome://messenger/content/schemas/tabs.json&quot;,</span>
<a href="#l16.14"></a><span id="l16.14">     &quot;scopes&quot;: [&quot;addon_parent&quot;],</span>
<a href="#l16.15"></a><span id="l16.15">     &quot;paths&quot;: [</span>
<a href="#l16.16"></a><span id="l16.16">       [&quot;tabs&quot;]</span>
<a href="#l16.17"></a><span id="l16.17">     ]</span>
<a href="#l16.18"></a><span id="l16.18">   },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mail/components/extensions/jar.mn</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mail/components/extensions/jar.mn</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -1,16 +1,18 @@</span>
<a href="#l17.4"></a><span id="l17.4"> # This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l17.5"></a><span id="l17.5"> # License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l17.6"></a><span id="l17.6"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l17.7"></a><span id="l17.7"> </span>
<a href="#l17.8"></a><span id="l17.8"> messenger.jar:</span>
<a href="#l17.9"></a><span id="l17.9">     content/messenger/ext-mail.json                (ext-mail.json)</span>
<a href="#l17.10"></a><span id="l17.10"> </span>
<a href="#l17.11"></a><span id="l17.11" class="difflineplus">+    content/messenger/parent/ext-legacy.js         (parent/ext-legacy.js)</span>
<a href="#l17.12"></a><span id="l17.12">     content/messenger/parent/ext-mail.js           (parent/ext-mail.js)</span>
<a href="#l17.13"></a><span id="l17.13">     content/messenger/parent/ext-tabs.js           (parent/ext-tabs.js)</span>
<a href="#l17.14"></a><span id="l17.14">     content/messenger/parent/ext-windows.js        (parent/ext-windows.js)</span>
<a href="#l17.15"></a><span id="l17.15"> </span>
<a href="#l17.16"></a><span id="l17.16">     content/messenger/child/ext-tabs.js            (child/ext-tabs.js)</span>
<a href="#l17.17"></a><span id="l17.17">     content/messenger/child/ext-mail.js            (child/ext-mail.js)</span>
<a href="#l17.18"></a><span id="l17.18"> </span>
<a href="#l17.19"></a><span id="l17.19" class="difflineplus">+    content/messenger/schemas/legacy.json   (schemas/legacy.json)</span>
<a href="#l17.20"></a><span id="l17.20">     content/messenger/schemas/tabs.json     (schemas/tabs.json)</span>
<a href="#l17.21"></a><span id="l17.21">     content/messenger/schemas/windows.json  (schemas/windows.json)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1">new file mode 100644</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineminus">--- /dev/null</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineplus">+++ b/mail/components/extensions/parent/ext-legacy.js</span>
<a href="#l18.4"></a><span id="l18.4" class="difflineat">@@ -0,0 +1,114 @@</span>
<a href="#l18.5"></a><span id="l18.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l18.6"></a><span id="l18.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l18.7"></a><span id="l18.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l18.8"></a><span id="l18.8" class="difflineplus">+</span>
<a href="#l18.9"></a><span id="l18.9" class="difflineplus">+ChromeUtils.defineModuleGetter(this, &quot;ChromeManifest&quot;, &quot;resource:///modules/ChromeManifest.jsm&quot;);</span>
<a href="#l18.10"></a><span id="l18.10" class="difflineplus">+ChromeUtils.defineModuleGetter(this, &quot;ExtensionSupport&quot;, &quot;resource:///modules/extensionSupport.jsm&quot;);</span>
<a href="#l18.11"></a><span id="l18.11" class="difflineplus">+ChromeUtils.defineModuleGetter(this, &quot;Overlays&quot;, &quot;resource:///modules/Overlays.jsm&quot;);</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineplus">+</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+Cu.importGlobalProperties([&quot;fetch&quot;]);</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineplus">+</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineplus">+var { ExtensionError } = ExtensionUtils;</span>
<a href="#l18.16"></a><span id="l18.16" class="difflineplus">+</span>
<a href="#l18.17"></a><span id="l18.17" class="difflineplus">+var loadedOnce = new Set();</span>
<a href="#l18.18"></a><span id="l18.18" class="difflineplus">+</span>
<a href="#l18.19"></a><span id="l18.19" class="difflineplus">+this.legacy = class extends ExtensionAPI {</span>
<a href="#l18.20"></a><span id="l18.20" class="difflineplus">+  async onManifestEntry(entryName) {</span>
<a href="#l18.21"></a><span id="l18.21" class="difflineplus">+    if (this.extension.manifest.legacy) {</span>
<a href="#l18.22"></a><span id="l18.22" class="difflineplus">+      await this.register();</span>
<a href="#l18.23"></a><span id="l18.23" class="difflineplus">+    }</span>
<a href="#l18.24"></a><span id="l18.24" class="difflineplus">+  }</span>
<a href="#l18.25"></a><span id="l18.25" class="difflineplus">+</span>
<a href="#l18.26"></a><span id="l18.26" class="difflineplus">+  async register() {</span>
<a href="#l18.27"></a><span id="l18.27" class="difflineplus">+    if (this.extension.startupReason != &quot;APP_STARTUP&quot;) {</span>
<a href="#l18.28"></a><span id="l18.28" class="difflineplus">+      console.log(`Legacy WebExtension ${this.extension.id} loading for other reason than startup (${this.extension.startupReason}), refusing to load immediately`);</span>
<a href="#l18.29"></a><span id="l18.29" class="difflineplus">+      return;</span>
<a href="#l18.30"></a><span id="l18.30" class="difflineplus">+    }</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineplus">+</span>
<a href="#l18.32"></a><span id="l18.32" class="difflineplus">+    this.extension.legacyLoaded = true;</span>
<a href="#l18.33"></a><span id="l18.33" class="difflineplus">+</span>
<a href="#l18.34"></a><span id="l18.34" class="difflineplus">+    if (loadedOnce.has(this.extension.id)) {</span>
<a href="#l18.35"></a><span id="l18.35" class="difflineplus">+      console.log(`Legacy WebExtension ${this.extension.id} has already been loaded in this run, refusing to do so again. Please restart`);</span>
<a href="#l18.36"></a><span id="l18.36" class="difflineplus">+      return;</span>
<a href="#l18.37"></a><span id="l18.37" class="difflineplus">+    }</span>
<a href="#l18.38"></a><span id="l18.38" class="difflineplus">+    loadedOnce.add(this.extension.id);</span>
<a href="#l18.39"></a><span id="l18.39" class="difflineplus">+</span>
<a href="#l18.40"></a><span id="l18.40" class="difflineplus">+</span>
<a href="#l18.41"></a><span id="l18.41" class="difflineplus">+    let extensionRoot;</span>
<a href="#l18.42"></a><span id="l18.42" class="difflineplus">+    if (this.extension.rootURI instanceof Ci.nsIJARURI) {</span>
<a href="#l18.43"></a><span id="l18.43" class="difflineplus">+      extensionRoot = this.extension.rootURI.JARFile.QueryInterface(Ci.nsIFileURL).file;</span>
<a href="#l18.44"></a><span id="l18.44" class="difflineplus">+      console.log(&quot;Loading packed extension from&quot;, extensionRoot.path);</span>
<a href="#l18.45"></a><span id="l18.45" class="difflineplus">+    } else {</span>
<a href="#l18.46"></a><span id="l18.46" class="difflineplus">+      extensionRoot = this.extension.rootURI.QueryInterface(Ci.nsIFileURL).file;</span>
<a href="#l18.47"></a><span id="l18.47" class="difflineplus">+      console.log(&quot;Loading unpacked extension from&quot;, extensionRoot.path);</span>
<a href="#l18.48"></a><span id="l18.48" class="difflineplus">+    }</span>
<a href="#l18.49"></a><span id="l18.49" class="difflineplus">+</span>
<a href="#l18.50"></a><span id="l18.50" class="difflineplus">+    // Have Gecko do as much loading as is still possible</span>
<a href="#l18.51"></a><span id="l18.51" class="difflineplus">+    try {</span>
<a href="#l18.52"></a><span id="l18.52" class="difflineplus">+      Cc[&quot;@mozilla.org/component-manager-extra;1&quot;]</span>
<a href="#l18.53"></a><span id="l18.53" class="difflineplus">+        .getService(Ci.nsIComponentManagerExtra)</span>
<a href="#l18.54"></a><span id="l18.54" class="difflineplus">+        .addLegacyExtensionManifestLocation(extensionRoot);</span>
<a href="#l18.55"></a><span id="l18.55" class="difflineplus">+    } catch (e) {</span>
<a href="#l18.56"></a><span id="l18.56" class="difflineplus">+      throw new ExtensionError(e.message, e.fileName, e.lineNumber);</span>
<a href="#l18.57"></a><span id="l18.57" class="difflineplus">+    }</span>
<a href="#l18.58"></a><span id="l18.58" class="difflineplus">+</span>
<a href="#l18.59"></a><span id="l18.59" class="difflineplus">+    // Load chrome.manifest</span>
<a href="#l18.60"></a><span id="l18.60" class="difflineplus">+    let appinfo = Services.appinfo;</span>
<a href="#l18.61"></a><span id="l18.61" class="difflineplus">+    let options = {</span>
<a href="#l18.62"></a><span id="l18.62" class="difflineplus">+      application: appinfo.ID,</span>
<a href="#l18.63"></a><span id="l18.63" class="difflineplus">+      appversion: appinfo.version,</span>
<a href="#l18.64"></a><span id="l18.64" class="difflineplus">+      platformversion: appinfo.platformVersion,</span>
<a href="#l18.65"></a><span id="l18.65" class="difflineplus">+      os: appinfo.OS,</span>
<a href="#l18.66"></a><span id="l18.66" class="difflineplus">+      osversion: Services.sysinfo.getProperty(&quot;version&quot;),</span>
<a href="#l18.67"></a><span id="l18.67" class="difflineplus">+      abi: appinfo.XPCOMABI</span>
<a href="#l18.68"></a><span id="l18.68" class="difflineplus">+    };</span>
<a href="#l18.69"></a><span id="l18.69" class="difflineplus">+    let loader = async (filename) =&gt; {</span>
<a href="#l18.70"></a><span id="l18.70" class="difflineplus">+      let url = this.extension.getURL(filename);</span>
<a href="#l18.71"></a><span id="l18.71" class="difflineplus">+      return fetch(url).then(response =&gt; response.text());</span>
<a href="#l18.72"></a><span id="l18.72" class="difflineplus">+    };</span>
<a href="#l18.73"></a><span id="l18.73" class="difflineplus">+    let chromeManifest = new ChromeManifest(loader, options);</span>
<a href="#l18.74"></a><span id="l18.74" class="difflineplus">+    await chromeManifest.parse(&quot;chrome.manifest&quot;);</span>
<a href="#l18.75"></a><span id="l18.75" class="difflineplus">+</span>
<a href="#l18.76"></a><span id="l18.76" class="difflineplus">+    // Load preference files</span>
<a href="#l18.77"></a><span id="l18.77" class="difflineplus">+    console.log(&quot;Loading add-on preferences from &quot;, extensionRoot.path);</span>
<a href="#l18.78"></a><span id="l18.78" class="difflineplus">+    ExtensionSupport.loadAddonPrefs(extensionRoot);</span>
<a href="#l18.79"></a><span id="l18.79" class="difflineplus">+</span>
<a href="#l18.80"></a><span id="l18.80" class="difflineplus">+    // Fire profile-after-change notifications, because we are past that event by now</span>
<a href="#l18.81"></a><span id="l18.81" class="difflineplus">+    console.log(&quot;Firing profile-after-change listeners for&quot;, this.extension.id);</span>
<a href="#l18.82"></a><span id="l18.82" class="difflineplus">+    let profileAfterChange = chromeManifest.category.get(&quot;profile-after-change&quot;);</span>
<a href="#l18.83"></a><span id="l18.83" class="difflineplus">+    for (let contractid of profileAfterChange.values()) {</span>
<a href="#l18.84"></a><span id="l18.84" class="difflineplus">+      let service = contractid.startsWith(&quot;service,&quot;);</span>
<a href="#l18.85"></a><span id="l18.85" class="difflineplus">+      let instance;</span>
<a href="#l18.86"></a><span id="l18.86" class="difflineplus">+      try {</span>
<a href="#l18.87"></a><span id="l18.87" class="difflineplus">+        if (service) {</span>
<a href="#l18.88"></a><span id="l18.88" class="difflineplus">+          instance = Components.classes[contractid.substr(8)].getService(Ci.nsIObserver);</span>
<a href="#l18.89"></a><span id="l18.89" class="difflineplus">+        } else {</span>
<a href="#l18.90"></a><span id="l18.90" class="difflineplus">+          instance = Components.classes[contractid].createInstance(Ci.nsIObserver);</span>
<a href="#l18.91"></a><span id="l18.91" class="difflineplus">+        }</span>
<a href="#l18.92"></a><span id="l18.92" class="difflineplus">+</span>
<a href="#l18.93"></a><span id="l18.93" class="difflineplus">+        instance.observe(null, &quot;profile-after-change&quot;, null);</span>
<a href="#l18.94"></a><span id="l18.94" class="difflineplus">+      } catch (e) {</span>
<a href="#l18.95"></a><span id="l18.95" class="difflineplus">+        console.error(&quot;Error firing profile-after-change listener for&quot;, contractid);</span>
<a href="#l18.96"></a><span id="l18.96" class="difflineplus">+      }</span>
<a href="#l18.97"></a><span id="l18.97" class="difflineplus">+    }</span>
<a href="#l18.98"></a><span id="l18.98" class="difflineplus">+</span>
<a href="#l18.99"></a><span id="l18.99" class="difflineplus">+    // Load overlays for each window</span>
<a href="#l18.100"></a><span id="l18.100" class="difflineplus">+    console.log(&quot;Loading legacy overlays for&quot;, this.extension.id);</span>
<a href="#l18.101"></a><span id="l18.101" class="difflineplus">+    let chromeManifestLoad = Overlays.load.bind(null, chromeManifest);</span>
<a href="#l18.102"></a><span id="l18.102" class="difflineplus">+    let targets = [...chromeManifest.overlay.keys()];</span>
<a href="#l18.103"></a><span id="l18.103" class="difflineplus">+    for (let target of targets) {</span>
<a href="#l18.104"></a><span id="l18.104" class="difflineplus">+      ExtensionSupport.registerWindowListener(this.extension.id + &quot;-&quot; + target, {</span>
<a href="#l18.105"></a><span id="l18.105" class="difflineplus">+        chromeURLs: [target],</span>
<a href="#l18.106"></a><span id="l18.106" class="difflineplus">+        onLoadWindow: chromeManifestLoad</span>
<a href="#l18.107"></a><span id="l18.107" class="difflineplus">+      });</span>
<a href="#l18.108"></a><span id="l18.108" class="difflineplus">+    }</span>
<a href="#l18.109"></a><span id="l18.109" class="difflineplus">+</span>
<a href="#l18.110"></a><span id="l18.110" class="difflineplus">+    this.extension.callOnClose({</span>
<a href="#l18.111"></a><span id="l18.111" class="difflineplus">+      close: () =&gt; {</span>
<a href="#l18.112"></a><span id="l18.112" class="difflineplus">+        for (let target of targets) {</span>
<a href="#l18.113"></a><span id="l18.113" class="difflineplus">+          ExtensionSupport.unregisterWindowListener(this.extension.id + &quot;-&quot; + target);</span>
<a href="#l18.114"></a><span id="l18.114" class="difflineplus">+        }</span>
<a href="#l18.115"></a><span id="l18.115" class="difflineplus">+      }</span>
<a href="#l18.116"></a><span id="l18.116" class="difflineplus">+    });</span>
<a href="#l18.117"></a><span id="l18.117" class="difflineplus">+  }</span>
<a href="#l18.118"></a><span id="l18.118" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1">new file mode 100644</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineminus">--- /dev/null</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineplus">+++ b/mail/components/extensions/schemas/legacy.json</span>
<a href="#l19.4"></a><span id="l19.4" class="difflineat">@@ -0,0 +1,16 @@</span>
<a href="#l19.5"></a><span id="l19.5" class="difflineplus">+[</span>
<a href="#l19.6"></a><span id="l19.6" class="difflineplus">+  {</span>
<a href="#l19.7"></a><span id="l19.7" class="difflineplus">+    &quot;namespace&quot;: &quot;manifest&quot;,</span>
<a href="#l19.8"></a><span id="l19.8" class="difflineplus">+    &quot;types&quot;: [</span>
<a href="#l19.9"></a><span id="l19.9" class="difflineplus">+      {</span>
<a href="#l19.10"></a><span id="l19.10" class="difflineplus">+        &quot;$extend&quot;: &quot;WebExtensionManifest&quot;,</span>
<a href="#l19.11"></a><span id="l19.11" class="difflineplus">+        &quot;properties&quot;: {</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineplus">+          &quot;legacy&quot;: {</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+            &quot;type&quot;: &quot;boolean&quot;,</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineplus">+            &quot;optional&quot;: true</span>
<a href="#l19.15"></a><span id="l19.15" class="difflineplus">+          }</span>
<a href="#l19.16"></a><span id="l19.16" class="difflineplus">+        }</span>
<a href="#l19.17"></a><span id="l19.17" class="difflineplus">+      }</span>
<a href="#l19.18"></a><span id="l19.18" class="difflineplus">+    ]</span>
<a href="#l19.19"></a><span id="l19.19" class="difflineplus">+  }</span>
<a href="#l19.20"></a><span id="l19.20" class="difflineplus">+]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/extensionsOverlay.properties</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/extensionsOverlay.properties</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -1,6 +1,9 @@</span>
<a href="#l20.4"></a><span id="l20.4"> # This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l20.5"></a><span id="l20.5"> # License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l20.6"></a><span id="l20.6"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l20.7"></a><span id="l20.7"> </span>
<a href="#l20.8"></a><span id="l20.8"> cmdBackTooltip=Go back one page</span>
<a href="#l20.9"></a><span id="l20.9"> cmdForwardTooltip=Go forward one page</span>
<a href="#l20.10"></a><span id="l20.10" class="difflineplus">+</span>
<a href="#l20.11"></a><span id="l20.11" class="difflineplus">+warnLegacyRestart=This is a legacy add-on, a restart is required to continue.</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineplus">+warnLegacyRestartButton=Restart</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mail/moz.build</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mail/moz.build</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -7,17 +7,17 @@ CONFIGURE_SUBST_FILES += ['installer/Mak</span>
<a href="#l21.4"></a><span id="l21.4"> </span>
<a href="#l21.5"></a><span id="l21.5"> # app is always last as it packages up the built files on mac.</span>
<a href="#l21.6"></a><span id="l21.6"> DIRS += [</span>
<a href="#l21.7"></a><span id="l21.7">     'base',</span>
<a href="#l21.8"></a><span id="l21.8">     'locales',</span>
<a href="#l21.9"></a><span id="l21.9">     'extensions',</span>
<a href="#l21.10"></a><span id="l21.10">     'themes',</span>
<a href="#l21.11"></a><span id="l21.11">     'app',</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-    '../common/src',</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+    '../common',</span>
<a href="#l21.14"></a><span id="l21.14"> ]</span>
<a href="#l21.15"></a><span id="l21.15"> </span>
<a href="#l21.16"></a><span id="l21.16"> if CONFIG['MAKENSISU']:</span>
<a href="#l21.17"></a><span id="l21.17">     DIRS += ['installer/windows']</span>
<a href="#l21.18"></a><span id="l21.18"> </span>
<a href="#l21.19"></a><span id="l21.19"> if CONFIG['MOZ_BUNDLED_FONTS']:</span>
<a href="#l21.20"></a><span id="l21.20">     DIRS += ['/%s/browser/fonts' % CONFIG['mozreltopsrcdir']]</span>
<a href="#l21.21"></a><span id="l21.21"> </span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:31Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

