<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 7747:ccb90765df6984275f318cffadf206c16f3364dd</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ ccb90765df6984275f318cffadf206c16f3364dd" />
<meta property="og:url" content="/comm-central/rev/ccb90765df6984275f318cffadf206c16f3364dd" />
<meta property="og:description" content="Bug 555536 - alert on new message does not appear as specified in preferences; r=Standard8 sr=dbienvenu ui-r=bwinton" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / ccb90765df6984275f318cffadf206c16f3364dd 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/ccb90765df6984275f318cffadf206c16f3364dd">shortlog</a> |
<a href="/comm-central/log/ccb90765df6984275f318cffadf206c16f3364dd">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/ccb90765df6984275f318cffadf206c16f3364dd">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/ccb90765df6984275f318cffadf206c16f3364dd">files</a> |
changeset |
<a href="/comm-central/raw-rev/ccb90765df6984275f318cffadf206c16f3364dd">raw</a>  | <a href="/comm-central/archive/ccb90765df6984275f318cffadf206c16f3364dd.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=555536">Bug 555536</a> - alert on new message does not appear as specified in preferences; r=Standard8 sr=dbienvenu ui-r=bwinton
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#77;&#105;&#107;&#101;&#32;&#67;&#111;&#110;&#108;&#101;&#121;&#32;&#60;&#109;&#99;&#111;&#110;&#108;&#101;&#121;&#64;&#109;&#111;&#122;&#105;&#108;&#108;&#97;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 10 May 2011 12:53:08 +0100</td></tr>

<tr>
 <td>changeset 7747</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/ccb90765df6984275f318cffadf206c16f3364dd">ccb90765df6984275f318cffadf206c16f3364dd</a></td>
</tr>



<tr>
<td>parent 7746</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/2693feb6095add068516f315bd7b09e85b31730b">2693feb6095add068516f315bd7b09e85b31730b</a>
</td>
</tr>

<tr>
<td>child 7748</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/a2eb410f6e5178e5e804290b8de950107ea3e754">a2eb410f6e5178e5e804290b8de950107ea3e754</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=ccb90765df6984275f318cffadf206c16f3364dd">5947</a></td></tr>
<tr><td>push user</td><td>bugzilla@standard8.plus.com</td></tr>
<tr><td>push date</td><td class="date age">Tue, 10 May 2011 11:54:57 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@a2eb410f6e51 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=a2eb410f6e5178e5e804290b8de950107ea3e754">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=a2eb410f6e5178e5e804290b8de950107ea3e754&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a2eb410f6e5178e5e804290b8de950107ea3e754&newProject=comm-central&newRevision=ccb90765df6984275f318cffadf206c16f3364dd&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a2eb410f6e5178e5e804290b8de950107ea3e754&newProject=comm-central&newRevision=ccb90765df6984275f318cffadf206c16f3364dd&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a2eb410f6e5178e5e804290b8de950107ea3e754&newProject=comm-central&newRevision=ccb90765df6984275f318cffadf206c16f3364dd&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28Standard8%29&revcount=50">Standard8</a>, <a href="/comm-central/log?rev=reviewer%28dbienvenu%29&revcount=50">dbienvenu</a>, <a href="/comm-central/log?rev=reviewer%28bwinton%29&revcount=50">bwinton</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=555536">555536</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=555536">Bug 555536</a> - alert on new message does not appear as specified in preferences; r=Standard8 sr=dbienvenu ui-r=bwinton</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ccb90765df6984275f318cffadf206c16f3364dd/mail/app/profile/all-thunderbird.js">mail/app/profile/all-thunderbird.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ccb90765df6984275f318cffadf206c16f3364dd/mail/app/profile/all-thunderbird.js">file</a> |
<a href="/comm-central/annotate/ccb90765df6984275f318cffadf206c16f3364dd/mail/app/profile/all-thunderbird.js">annotate</a> |
<a href="/comm-central/diff/ccb90765df6984275f318cffadf206c16f3364dd/mail/app/profile/all-thunderbird.js">diff</a> |
<a href="/comm-central/comparison/ccb90765df6984275f318cffadf206c16f3364dd/mail/app/profile/all-thunderbird.js">comparison</a> |
<a href="/comm-central/log/ccb90765df6984275f318cffadf206c16f3364dd/mail/app/profile/all-thunderbird.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ccb90765df6984275f318cffadf206c16f3364dd/mail/base/content/newmailalert.js">mail/base/content/newmailalert.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ccb90765df6984275f318cffadf206c16f3364dd/mail/base/content/newmailalert.js">file</a> |
<a href="/comm-central/annotate/ccb90765df6984275f318cffadf206c16f3364dd/mail/base/content/newmailalert.js">annotate</a> |
<a href="/comm-central/diff/ccb90765df6984275f318cffadf206c16f3364dd/mail/base/content/newmailalert.js">diff</a> |
<a href="/comm-central/comparison/ccb90765df6984275f318cffadf206c16f3364dd/mail/base/content/newmailalert.js">comparison</a> |
<a href="/comm-central/log/ccb90765df6984275f318cffadf206c16f3364dd/mail/base/content/newmailalert.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ccb90765df6984275f318cffadf206c16f3364dd/mail/locales/en-US/chrome/messenger/messenger.properties">mail/locales/en-US/chrome/messenger/messenger.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ccb90765df6984275f318cffadf206c16f3364dd/mail/locales/en-US/chrome/messenger/messenger.properties">file</a> |
<a href="/comm-central/annotate/ccb90765df6984275f318cffadf206c16f3364dd/mail/locales/en-US/chrome/messenger/messenger.properties">annotate</a> |
<a href="/comm-central/diff/ccb90765df6984275f318cffadf206c16f3364dd/mail/locales/en-US/chrome/messenger/messenger.properties">diff</a> |
<a href="/comm-central/comparison/ccb90765df6984275f318cffadf206c16f3364dd/mail/locales/en-US/chrome/messenger/messenger.properties">comparison</a> |
<a href="/comm-central/log/ccb90765df6984275f318cffadf206c16f3364dd/mail/locales/en-US/chrome/messenger/messenger.properties">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ccb90765df6984275f318cffadf206c16f3364dd/mail/test/mozmill/mozmilltests.list">mail/test/mozmill/mozmilltests.list</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ccb90765df6984275f318cffadf206c16f3364dd/mail/test/mozmill/mozmilltests.list">file</a> |
<a href="/comm-central/annotate/ccb90765df6984275f318cffadf206c16f3364dd/mail/test/mozmill/mozmilltests.list">annotate</a> |
<a href="/comm-central/diff/ccb90765df6984275f318cffadf206c16f3364dd/mail/test/mozmill/mozmilltests.list">diff</a> |
<a href="/comm-central/comparison/ccb90765df6984275f318cffadf206c16f3364dd/mail/test/mozmill/mozmilltests.list">comparison</a> |
<a href="/comm-central/log/ccb90765df6984275f318cffadf206c16f3364dd/mail/test/mozmill/mozmilltests.list">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ccb90765df6984275f318cffadf206c16f3364dd/mail/test/mozmill/notification/test-notification.js">mail/test/mozmill/notification/test-notification.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ccb90765df6984275f318cffadf206c16f3364dd/mail/test/mozmill/notification/test-notification.js">file</a> |
<a href="/comm-central/annotate/ccb90765df6984275f318cffadf206c16f3364dd/mail/test/mozmill/notification/test-notification.js">annotate</a> |
<a href="/comm-central/diff/ccb90765df6984275f318cffadf206c16f3364dd/mail/test/mozmill/notification/test-notification.js">diff</a> |
<a href="/comm-central/comparison/ccb90765df6984275f318cffadf206c16f3364dd/mail/test/mozmill/notification/test-notification.js">comparison</a> |
<a href="/comm-central/log/ccb90765df6984275f318cffadf206c16f3364dd/mail/test/mozmill/notification/test-notification.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ccb90765df6984275f318cffadf206c16f3364dd/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">mail/test/mozmill/shared-modules/test-folder-display-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ccb90765df6984275f318cffadf206c16f3364dd/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">file</a> |
<a href="/comm-central/annotate/ccb90765df6984275f318cffadf206c16f3364dd/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">annotate</a> |
<a href="/comm-central/diff/ccb90765df6984275f318cffadf206c16f3364dd/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">diff</a> |
<a href="/comm-central/comparison/ccb90765df6984275f318cffadf206c16f3364dd/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">comparison</a> |
<a href="/comm-central/log/ccb90765df6984275f318cffadf206c16f3364dd/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ccb90765df6984275f318cffadf206c16f3364dd/mailnews/base/src/nsMessengerUnixIntegration.cpp">mailnews/base/src/nsMessengerUnixIntegration.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ccb90765df6984275f318cffadf206c16f3364dd/mailnews/base/src/nsMessengerUnixIntegration.cpp">file</a> |
<a href="/comm-central/annotate/ccb90765df6984275f318cffadf206c16f3364dd/mailnews/base/src/nsMessengerUnixIntegration.cpp">annotate</a> |
<a href="/comm-central/diff/ccb90765df6984275f318cffadf206c16f3364dd/mailnews/base/src/nsMessengerUnixIntegration.cpp">diff</a> |
<a href="/comm-central/comparison/ccb90765df6984275f318cffadf206c16f3364dd/mailnews/base/src/nsMessengerUnixIntegration.cpp">comparison</a> |
<a href="/comm-central/log/ccb90765df6984275f318cffadf206c16f3364dd/mailnews/base/src/nsMessengerUnixIntegration.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ccb90765df6984275f318cffadf206c16f3364dd/mailnews/base/src/nsMessengerUnixIntegration.h">mailnews/base/src/nsMessengerUnixIntegration.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ccb90765df6984275f318cffadf206c16f3364dd/mailnews/base/src/nsMessengerUnixIntegration.h">file</a> |
<a href="/comm-central/annotate/ccb90765df6984275f318cffadf206c16f3364dd/mailnews/base/src/nsMessengerUnixIntegration.h">annotate</a> |
<a href="/comm-central/diff/ccb90765df6984275f318cffadf206c16f3364dd/mailnews/base/src/nsMessengerUnixIntegration.h">diff</a> |
<a href="/comm-central/comparison/ccb90765df6984275f318cffadf206c16f3364dd/mailnews/base/src/nsMessengerUnixIntegration.h">comparison</a> |
<a href="/comm-central/log/ccb90765df6984275f318cffadf206c16f3364dd/mailnews/base/src/nsMessengerUnixIntegration.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ccb90765df6984275f318cffadf206c16f3364dd/mailnews/base/util/nsMsgDBFolder.cpp">mailnews/base/util/nsMsgDBFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ccb90765df6984275f318cffadf206c16f3364dd/mailnews/base/util/nsMsgDBFolder.cpp">file</a> |
<a href="/comm-central/annotate/ccb90765df6984275f318cffadf206c16f3364dd/mailnews/base/util/nsMsgDBFolder.cpp">annotate</a> |
<a href="/comm-central/diff/ccb90765df6984275f318cffadf206c16f3364dd/mailnews/base/util/nsMsgDBFolder.cpp">diff</a> |
<a href="/comm-central/comparison/ccb90765df6984275f318cffadf206c16f3364dd/mailnews/base/util/nsMsgDBFolder.cpp">comparison</a> |
<a href="/comm-central/log/ccb90765df6984275f318cffadf206c16f3364dd/mailnews/base/util/nsMsgDBFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ccb90765df6984275f318cffadf206c16f3364dd/mailnews/test/resources/messageInjection.js">mailnews/test/resources/messageInjection.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ccb90765df6984275f318cffadf206c16f3364dd/mailnews/test/resources/messageInjection.js">file</a> |
<a href="/comm-central/annotate/ccb90765df6984275f318cffadf206c16f3364dd/mailnews/test/resources/messageInjection.js">annotate</a> |
<a href="/comm-central/diff/ccb90765df6984275f318cffadf206c16f3364dd/mailnews/test/resources/messageInjection.js">diff</a> |
<a href="/comm-central/comparison/ccb90765df6984275f318cffadf206c16f3364dd/mailnews/test/resources/messageInjection.js">comparison</a> |
<a href="/comm-central/log/ccb90765df6984275f318cffadf206c16f3364dd/mailnews/test/resources/messageInjection.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/app/profile/all-thunderbird.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/app/profile/all-thunderbird.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -178,16 +178,17 @@ pref(&quot;xpinstall.whitelist.add&quot;, &quot;addons.</span>
<a href="#l1.4"></a><span id="l1.4"> pref(&quot;xpinstall.whitelist.add.36&quot;, &quot;getpersonas.com&quot;);</span>
<a href="#l1.5"></a><span id="l1.5"> </span>
<a href="#l1.6"></a><span id="l1.6"> pref(&quot;mail.shell.checkDefaultClient&quot;, true);</span>
<a href="#l1.7"></a><span id="l1.7"> pref(&quot;mail.spellcheck.inline&quot;, true);</span>
<a href="#l1.8"></a><span id="l1.8"> </span>
<a href="#l1.9"></a><span id="l1.9"> pref(&quot;mail.biff.alert.show_preview&quot;, true);</span>
<a href="#l1.10"></a><span id="l1.10"> pref(&quot;mail.biff.alert.show_subject&quot;, true);</span>
<a href="#l1.11"></a><span id="l1.11"> pref(&quot;mail.biff.alert.show_sender&quot;,  true);</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+pref(&quot;mail.biff.alert.preview_length&quot;, 40);</span>
<a href="#l1.13"></a><span id="l1.13"> </span>
<a href="#l1.14"></a><span id="l1.14"> pref(&quot;mail.folder.views.version&quot;, 0);</span>
<a href="#l1.15"></a><span id="l1.15"> </span>
<a href="#l1.16"></a><span id="l1.16"> // target folder URI used for the last move or copy</span>
<a href="#l1.17"></a><span id="l1.17"> pref(&quot;mail.last_msg_movecopy_target_uri&quot;, &quot;&quot;);</span>
<a href="#l1.18"></a><span id="l1.18"> // last move or copy operation was a move</span>
<a href="#l1.19"></a><span id="l1.19"> pref(&quot;mail.last_msg_movecopy_was_move&quot;, true);</span>
<a href="#l1.20"></a><span id="l1.20"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/base/content/newmailalert.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/base/content/newmailalert.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -71,17 +71,17 @@ function prefillAlertInfo()</span>
<a href="#l2.4"></a><span id="l2.4">                     .QueryInterface(Components.interfaces.nsIWeakReference)</span>
<a href="#l2.5"></a><span id="l2.5">                     .QueryReferent(Components.interfaces.nsIMsgFolder);</span>
<a href="#l2.6"></a><span id="l2.6">   else</span>
<a href="#l2.7"></a><span id="l2.7">    return;</span>
<a href="#l2.8"></a><span id="l2.8"> </span>
<a href="#l2.9"></a><span id="l2.9">   // generate an account label string based on the root folder</span>
<a href="#l2.10"></a><span id="l2.10">   var label = document.getElementById('alertTitle');</span>
<a href="#l2.11"></a><span id="l2.11">   var totalNumNewMessages = rootFolder.getNumNewMessages(true);</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-  label.value = document.getElementById('bundle_messenger').getFormattedString(totalNumNewMessages == 1 ? &quot;newBiffNotification_message&quot; : &quot;newBiffNotification_messages&quot;, </span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+  label.value = document.getElementById('bundle_messenger').getFormattedString(totalNumNewMessages == 1 ? &quot;newMailNotification_message&quot; : &quot;newMailNotification_messages&quot;, </span>
<a href="#l2.14"></a><span id="l2.14">                                                                                      [rootFolder.prettiestName, totalNumNewMessages]);</span>
<a href="#l2.15"></a><span id="l2.15"> </span>
<a href="#l2.16"></a><span id="l2.16">   // this is really the root folder and we have to walk through the list to find the real folder that has new mail in it...:(</span>
<a href="#l2.17"></a><span id="l2.17">   var allFolders = Components.classes[&quot;@mozilla.org/supports-array;1&quot;].createInstance(Components.interfaces.nsISupportsArray);</span>
<a href="#l2.18"></a><span id="l2.18">   rootFolder.ListDescendents(allFolders);</span>
<a href="#l2.19"></a><span id="l2.19">   var numFolders = allFolders.Count();</span>
<a href="#l2.20"></a><span id="l2.20">   var folderSummaryInfoEl = document.getElementById('folderSummaryInfo');</span>
<a href="#l2.21"></a><span id="l2.21">   folderSummaryInfoEl.mMaxMsgHdrsInPopup = gNumNewMsgsToShowInAlert;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/messenger.properties</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/messenger.properties</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -387,19 +387,25 @@ 104=Connection to server %S timed out.</span>
<a href="#l3.4"></a><span id="l3.4"> </span>
<a href="#l3.5"></a><span id="l3.5"> recipientSearchCriteria=Subject or Recipient contains:</span>
<a href="#l3.6"></a><span id="l3.6"> fromSearchCriteria=Subject or From contains:</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8"> # LOCALIZATION NOTE(biffNotification): %1$S is the number of new messages  </span>
<a href="#l3.9"></a><span id="l3.9"> biffNotification_message=has %1$S new message</span>
<a href="#l3.10"></a><span id="l3.10"> biffNotification_messages=has %1$S new messages</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-# LOCALIZATION NOTE(biffNotification): %1$S is the name of the account %2$S is the number of new messages  </span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-newBiffNotification_message=%1$S has %2$S new message</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-newBiffNotification_messages=%1$S has %2$S new messages</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+# LOCALIZATION NOTE(newMailNotification_message): %1$S is the name of the account %2$S is the number of new messages  </span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+newMailNotification_message=%1$S received %2$S new message</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+# LOCALIZATION NOTE(newMailNotification_messages): %1$S is the name of the account %2$S is the number of new messages  </span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+newMailNotification_messages=%1$S received %2$S new messages</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+# LOCALIZATION NOTE(newMailNotification_messagetitle): %1$S is subject of new message and %2$S is sender of new message.</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+# This is UNIX only</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+newMailNotification_messagetitle=%1$S from %2$S</span>
<a href="#l3.24"></a><span id="l3.24"> </span>
<a href="#l3.25"></a><span id="l3.25"> # LOCALIZATION NOTE(macBiffNotification is Mac only):</span>
<a href="#l3.26"></a><span id="l3.26"> #  %1$S is the number of new messages</span>
<a href="#l3.27"></a><span id="l3.27"> #  %2$S is a list of names and/or email addresses separated by biffNotification_separator</span>
<a href="#l3.28"></a><span id="l3.28"> #  %3$S is the number of new messages not displayed in the biff alert</span>
<a href="#l3.29"></a><span id="l3.29"> macBiffNotification_message=%1$S new message from %2$S.</span>
<a href="#l3.30"></a><span id="l3.30"> macBiffNotification_messages=%1$S new messages from %2$S.</span>
<a href="#l3.31"></a><span id="l3.31"> macBiffNotification_messages_extra=%1$S new messages from %2$S and %3$S more.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/test/mozmill/mozmilltests.list</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/test/mozmill/mozmilltests.list</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -9,13 +9,14 @@ folder-pane</span>
<a href="#l4.4"></a><span id="l4.4"> folder-tree-modes</span>
<a href="#l4.5"></a><span id="l4.5"> folder-widget</span>
<a href="#l4.6"></a><span id="l4.6"> instrumentation</span>
<a href="#l4.7"></a><span id="l4.7"> junk-commands</span>
<a href="#l4.8"></a><span id="l4.8"> message-header</span>
<a href="#l4.9"></a><span id="l4.9"> message-window</span>
<a href="#l4.10"></a><span id="l4.10"> migration</span>
<a href="#l4.11"></a><span id="l4.11"> migration-from-tb2</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+notification</span>
<a href="#l4.13"></a><span id="l4.13"> pref-window</span>
<a href="#l4.14"></a><span id="l4.14"> quick-filter-bar</span>
<a href="#l4.15"></a><span id="l4.15"> search-window</span>
<a href="#l4.16"></a><span id="l4.16"> session-store</span>
<a href="#l4.17"></a><span id="l4.17"> tabmail</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1">new file mode 100644</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineminus">--- /dev/null</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineplus">+++ b/mail/test/mozmill/notification/test-notification.js</span>
<a href="#l5.4"></a><span id="l5.4" class="difflineat">@@ -0,0 +1,518 @@</span>
<a href="#l5.5"></a><span id="l5.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l5.6"></a><span id="l5.6" class="difflineplus">+ *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l5.7"></a><span id="l5.7" class="difflineplus">+ *</span>
<a href="#l5.8"></a><span id="l5.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l5.9"></a><span id="l5.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l5.10"></a><span id="l5.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l5.11"></a><span id="l5.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+ *</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+ * License.</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+ *</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+ * The Original Code is Thunderbird Mail Client.</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+ *</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineplus">+ * the Mozilla Foundation.</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2011</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineplus">+ *</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineplus">+ *   Mike Conley &lt;mconley@mozilla.com&gt;</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineplus">+ *</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineplus">+ *</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineplus">+</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineplus">+var MODULE_NAME = 'test-notifications';</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineplus">+</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineplus">+var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineplus">+var MODULE_REQUIRES = ['folder-display-helpers', 'window-helpers'];</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineplus">+</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineplus">+Cu.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineplus">+Cu.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineplus">+Cu.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineplus">+</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineplus">+// Our global folder variables...</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineplus">+var gFolder = null;</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineplus">+var gFolder2 = null;</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineplus">+</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineplus">+// An object to keep track of the boolean preferences we change, so that</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineplus">+// we can put them back.</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineplus">+var gOrigBoolPrefs = {};</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineplus">+</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineplus">+// Used by make_gradually_newer_sets_in_folders</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineplus">+var gMsgMinutes = 9000;</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineplus">+</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineplus">+// We'll use this mock alerts service to capture notification events</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineplus">+var gMockAlertsService = {</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineplus">+  _doFail: false,</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineplus">+</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineplus">+  QueryInterface: XPCOMUtils.generateQI([Ci.nsIAlertsService]),</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineplus">+</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineplus">+  showAlertNotification: function(imageUrl, title, text, textClickable, cookie,</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineplus">+                                  alertListener, name) {</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineplus">+    // Setting the _doFail flag allows us to revert to the newmailalert.xul</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineplus">+    // notification</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineplus">+    if (this._doFail) {</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineplus">+      throw Components.results.NS_ERROR_FAILURE;</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineplus">+    }</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineplus">+    this._didNotify = true;</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineplus">+    this._imageUrl = imageUrl;</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineplus">+    this._title = title;</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineplus">+    this._text = text;</span>
<a href="#l5.79"></a><span id="l5.79" class="difflineplus">+    this._textClickable = textClickable;</span>
<a href="#l5.80"></a><span id="l5.80" class="difflineplus">+    this._cookie = cookie;</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineplus">+    this._alertListener = alertListener;</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineplus">+    this._name = name;</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineplus">+</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineplus">+    this._alertListener.observe(null, &quot;alertfinished&quot;, this._cookie);</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineplus">+  },</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineplus">+</span>
<a href="#l5.87"></a><span id="l5.87" class="difflineplus">+  _didNotify: false,</span>
<a href="#l5.88"></a><span id="l5.88" class="difflineplus">+  _imageUrl: null,</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineplus">+  _title: null,</span>
<a href="#l5.90"></a><span id="l5.90" class="difflineplus">+  _text: null,</span>
<a href="#l5.91"></a><span id="l5.91" class="difflineplus">+  _textClickable: null,</span>
<a href="#l5.92"></a><span id="l5.92" class="difflineplus">+  _cookie: null,</span>
<a href="#l5.93"></a><span id="l5.93" class="difflineplus">+  _alertListener: null,</span>
<a href="#l5.94"></a><span id="l5.94" class="difflineplus">+  _name: null,</span>
<a href="#l5.95"></a><span id="l5.95" class="difflineplus">+</span>
<a href="#l5.96"></a><span id="l5.96" class="difflineplus">+  _reset: function() {</span>
<a href="#l5.97"></a><span id="l5.97" class="difflineplus">+    // Tell any listeners that we're through</span>
<a href="#l5.98"></a><span id="l5.98" class="difflineplus">+    if (this._alertListener)</span>
<a href="#l5.99"></a><span id="l5.99" class="difflineplus">+      this._alertListener.observe(null, &quot;alertfinished&quot;, this._cookie);</span>
<a href="#l5.100"></a><span id="l5.100" class="difflineplus">+</span>
<a href="#l5.101"></a><span id="l5.101" class="difflineplus">+    this._didNotify = false;</span>
<a href="#l5.102"></a><span id="l5.102" class="difflineplus">+    this._imageUrl = null;</span>
<a href="#l5.103"></a><span id="l5.103" class="difflineplus">+    this._title = null;</span>
<a href="#l5.104"></a><span id="l5.104" class="difflineplus">+    this._text = null;</span>
<a href="#l5.105"></a><span id="l5.105" class="difflineplus">+    this._textClickable = null;</span>
<a href="#l5.106"></a><span id="l5.106" class="difflineplus">+    this._cookie = null;</span>
<a href="#l5.107"></a><span id="l5.107" class="difflineplus">+    this._alertListener = null;</span>
<a href="#l5.108"></a><span id="l5.108" class="difflineplus">+    this._name = null;</span>
<a href="#l5.109"></a><span id="l5.109" class="difflineplus">+  }</span>
<a href="#l5.110"></a><span id="l5.110" class="difflineplus">+};</span>
<a href="#l5.111"></a><span id="l5.111" class="difflineplus">+</span>
<a href="#l5.112"></a><span id="l5.112" class="difflineplus">+var gMockAlertsServiceFactory = {</span>
<a href="#l5.113"></a><span id="l5.113" class="difflineplus">+  createInstance: function(aOuter, aIID) {</span>
<a href="#l5.114"></a><span id="l5.114" class="difflineplus">+    if (aOuter != null)</span>
<a href="#l5.115"></a><span id="l5.115" class="difflineplus">+      throw Cr.NS_ERROR_NO_AGGREGATION;</span>
<a href="#l5.116"></a><span id="l5.116" class="difflineplus">+</span>
<a href="#l5.117"></a><span id="l5.117" class="difflineplus">+    if (!aIID.equals(Ci.nsIAlertsService))</span>
<a href="#l5.118"></a><span id="l5.118" class="difflineplus">+      throw Cr.NS_ERROR_NO_INTERFACE;</span>
<a href="#l5.119"></a><span id="l5.119" class="difflineplus">+</span>
<a href="#l5.120"></a><span id="l5.120" class="difflineplus">+    return gMockAlertsService;</span>
<a href="#l5.121"></a><span id="l5.121" class="difflineplus">+  }</span>
<a href="#l5.122"></a><span id="l5.122" class="difflineplus">+};</span>
<a href="#l5.123"></a><span id="l5.123" class="difflineplus">+</span>
<a href="#l5.124"></a><span id="l5.124" class="difflineplus">+function setupModule(module) {</span>
<a href="#l5.125"></a><span id="l5.125" class="difflineplus">+  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l5.126"></a><span id="l5.126" class="difflineplus">+  fdh.installInto(module);</span>
<a href="#l5.127"></a><span id="l5.127" class="difflineplus">+</span>
<a href="#l5.128"></a><span id="l5.128" class="difflineplus">+  let wh = collector.getModule('window-helpers');</span>
<a href="#l5.129"></a><span id="l5.129" class="difflineplus">+  wh.installInto(module);</span>
<a href="#l5.130"></a><span id="l5.130" class="difflineplus">+</span>
<a href="#l5.131"></a><span id="l5.131" class="difflineplus">+  // Register the mock alerts service</span>
<a href="#l5.132"></a><span id="l5.132" class="difflineplus">+  Components.manager.QueryInterface(Ci.nsIComponentRegistrar)</span>
<a href="#l5.133"></a><span id="l5.133" class="difflineplus">+            .registerFactory(Components</span>
<a href="#l5.134"></a><span id="l5.134" class="difflineplus">+                             .ID(&quot;{1bda6c33-b089-43df-a8fd-111907d6385a}&quot;),</span>
<a href="#l5.135"></a><span id="l5.135" class="difflineplus">+                             &quot;Mock Alerts Service&quot;,</span>
<a href="#l5.136"></a><span id="l5.136" class="difflineplus">+                             &quot;@mozilla.org/system-alerts-service;1&quot;,</span>
<a href="#l5.137"></a><span id="l5.137" class="difflineplus">+                             gMockAlertsServiceFactory);</span>
<a href="#l5.138"></a><span id="l5.138" class="difflineplus">+</span>
<a href="#l5.139"></a><span id="l5.139" class="difflineplus">+  // Ensure we have enabled new mail notifications</span>
<a href="#l5.140"></a><span id="l5.140" class="difflineplus">+  remember_and_set_bool_pref(&quot;mail.biff.show_alert&quot;, true);</span>
<a href="#l5.141"></a><span id="l5.141" class="difflineplus">+</span>
<a href="#l5.142"></a><span id="l5.142" class="difflineplus">+  MailServices.accounts.localFoldersServer.performingBiff = true;</span>
<a href="#l5.143"></a><span id="l5.143" class="difflineplus">+</span>
<a href="#l5.144"></a><span id="l5.144" class="difflineplus">+  // Create a second identity to check cross-account</span>
<a href="#l5.145"></a><span id="l5.145" class="difflineplus">+  // notifications.</span>
<a href="#l5.146"></a><span id="l5.146" class="difflineplus">+  var identity2 = MailServices.accounts.createIdentity();</span>
<a href="#l5.147"></a><span id="l5.147" class="difflineplus">+  identity2.email = &quot;new-account@invalid.com&quot;;</span>
<a href="#l5.148"></a><span id="l5.148" class="difflineplus">+</span>
<a href="#l5.149"></a><span id="l5.149" class="difflineplus">+  var server = MailServices.accounts</span>
<a href="#l5.150"></a><span id="l5.150" class="difflineplus">+                           .createIncomingServer(&quot;nobody&quot;,</span>
<a href="#l5.151"></a><span id="l5.151" class="difflineplus">+                                                 &quot;Test Local Folders&quot;, &quot;pop3&quot;);</span>
<a href="#l5.152"></a><span id="l5.152" class="difflineplus">+</span>
<a href="#l5.153"></a><span id="l5.153" class="difflineplus">+  server.performingBiff = true;</span>
<a href="#l5.154"></a><span id="l5.154" class="difflineplus">+</span>
<a href="#l5.155"></a><span id="l5.155" class="difflineplus">+  // Create the target folders</span>
<a href="#l5.156"></a><span id="l5.156" class="difflineplus">+  gFolder = create_folder(&quot;My Folder&quot;);</span>
<a href="#l5.157"></a><span id="l5.157" class="difflineplus">+  gFolder2 = server.rootFolder.addSubfolder(&quot;Another Folder&quot;);</span>
<a href="#l5.158"></a><span id="l5.158" class="difflineplus">+</span>
<a href="#l5.159"></a><span id="l5.159" class="difflineplus">+  var account = MailServices.accounts.createAccount();</span>
<a href="#l5.160"></a><span id="l5.160" class="difflineplus">+  account.incomingServer = server;</span>
<a href="#l5.161"></a><span id="l5.161" class="difflineplus">+  account.addIdentity(identity2);</span>
<a href="#l5.162"></a><span id="l5.162" class="difflineplus">+}</span>
<a href="#l5.163"></a><span id="l5.163" class="difflineplus">+</span>
<a href="#l5.164"></a><span id="l5.164" class="difflineplus">+function teardownModule(module) {</span>
<a href="#l5.165"></a><span id="l5.165" class="difflineplus">+  put_bool_prefs_back();</span>
<a href="#l5.166"></a><span id="l5.166" class="difflineplus">+}</span>
<a href="#l5.167"></a><span id="l5.167" class="difflineplus">+</span>
<a href="#l5.168"></a><span id="l5.168" class="difflineplus">+function setupTest(test) {</span>
<a href="#l5.169"></a><span id="l5.169" class="difflineplus">+</span>
<a href="#l5.170"></a><span id="l5.170" class="difflineplus">+  gFolder.markAllMessagesRead(null);</span>
<a href="#l5.171"></a><span id="l5.171" class="difflineplus">+  gMockAlertsService._reset();</span>
<a href="#l5.172"></a><span id="l5.172" class="difflineplus">+  gMockAlertsService._doFail = false;</span>
<a href="#l5.173"></a><span id="l5.173" class="difflineplus">+  gFolder.biffState = Ci.nsIMsgFolder.nsMsgBiffState_NoMail;</span>
<a href="#l5.174"></a><span id="l5.174" class="difflineplus">+  gFolder2.biffState = Ci.nsIMsgFolder.nsMsgBiffState_NoMail;</span>
<a href="#l5.175"></a><span id="l5.175" class="difflineplus">+</span>
<a href="#l5.176"></a><span id="l5.176" class="difflineplus">+  remember_and_set_bool_pref(&quot;mail.biff.alert.show_subject&quot;, true);</span>
<a href="#l5.177"></a><span id="l5.177" class="difflineplus">+  remember_and_set_bool_pref(&quot;mail.biff.alert.show_sender&quot;, true);</span>
<a href="#l5.178"></a><span id="l5.178" class="difflineplus">+  remember_and_set_bool_pref(&quot;mail.biff.alert.show_preview&quot;, true);</span>
<a href="#l5.179"></a><span id="l5.179" class="difflineplus">+}</span>
<a href="#l5.180"></a><span id="l5.180" class="difflineplus">+</span>
<a href="#l5.181"></a><span id="l5.181" class="difflineplus">+function put_bool_prefs_back() {</span>
<a href="#l5.182"></a><span id="l5.182" class="difflineplus">+  for (let prefString in gOrigBoolPrefs) {</span>
<a href="#l5.183"></a><span id="l5.183" class="difflineplus">+    Services.prefs.setBoolPref(prefString, gOrigBoolPrefs[prefString]);</span>
<a href="#l5.184"></a><span id="l5.184" class="difflineplus">+  }</span>
<a href="#l5.185"></a><span id="l5.185" class="difflineplus">+}</span>
<a href="#l5.186"></a><span id="l5.186" class="difflineplus">+</span>
<a href="#l5.187"></a><span id="l5.187" class="difflineplus">+function remember_and_set_bool_pref(aPrefString, aBoolValue) {</span>
<a href="#l5.188"></a><span id="l5.188" class="difflineplus">+  if (!gOrigBoolPrefs[aPrefString])</span>
<a href="#l5.189"></a><span id="l5.189" class="difflineplus">+    gOrigBoolPrefs[aPrefString] = Services.prefs.getBoolPref(aPrefString);</span>
<a href="#l5.190"></a><span id="l5.190" class="difflineplus">+</span>
<a href="#l5.191"></a><span id="l5.191" class="difflineplus">+  Services.prefs.setBoolPref(aPrefString, true);</span>
<a href="#l5.192"></a><span id="l5.192" class="difflineplus">+}</span>
<a href="#l5.193"></a><span id="l5.193" class="difflineplus">+</span>
<a href="#l5.194"></a><span id="l5.194" class="difflineplus">+/* This function wraps up make_new_sets_in_folder, and takes the</span>
<a href="#l5.195"></a><span id="l5.195" class="difflineplus">+ * same arguments.  The point of this function is to ensure that</span>
<a href="#l5.196"></a><span id="l5.196" class="difflineplus">+ * each sent message is slightly newer than the last.  In this</span>
<a href="#l5.197"></a><span id="l5.197" class="difflineplus">+ * case, each new message set will be sent one minute further</span>
<a href="#l5.198"></a><span id="l5.198" class="difflineplus">+ * into the future than the last message set.</span>
<a href="#l5.199"></a><span id="l5.199" class="difflineplus">+ */</span>
<a href="#l5.200"></a><span id="l5.200" class="difflineplus">+function make_gradually_newer_sets_in_folder(aFolder, aArgs)</span>
<a href="#l5.201"></a><span id="l5.201" class="difflineplus">+{</span>
<a href="#l5.202"></a><span id="l5.202" class="difflineplus">+  gMsgMinutes -= 1;</span>
<a href="#l5.203"></a><span id="l5.203" class="difflineplus">+  if (!aArgs.age) {</span>
<a href="#l5.204"></a><span id="l5.204" class="difflineplus">+    for each (let arg in aArgs)</span>
<a href="#l5.205"></a><span id="l5.205" class="difflineplus">+      arg.age = {minutes: gMsgMinutes};</span>
<a href="#l5.206"></a><span id="l5.206" class="difflineplus">+  }</span>
<a href="#l5.207"></a><span id="l5.207" class="difflineplus">+  make_new_sets_in_folder(aFolder, aArgs);</span>
<a href="#l5.208"></a><span id="l5.208" class="difflineplus">+}</span>
<a href="#l5.209"></a><span id="l5.209" class="difflineplus">+</span>
<a href="#l5.210"></a><span id="l5.210" class="difflineplus">+/**</span>
<a href="#l5.211"></a><span id="l5.211" class="difflineplus">+ * Test that we revert to newmailalert.xul if there is no system</span>
<a href="#l5.212"></a><span id="l5.212" class="difflineplus">+ * notification service present.</span>
<a href="#l5.213"></a><span id="l5.213" class="difflineplus">+ */</span>
<a href="#l5.214"></a><span id="l5.214" class="difflineplus">+function test_revert_to_newmailalert() {</span>
<a href="#l5.215"></a><span id="l5.215" class="difflineplus">+  // Set up the gMockAlertsService so that it fails</span>
<a href="#l5.216"></a><span id="l5.216" class="difflineplus">+  // to send a notification.</span>
<a href="#l5.217"></a><span id="l5.217" class="difflineplus">+  gMockAlertsService._doFail = true;</span>
<a href="#l5.218"></a><span id="l5.218" class="difflineplus">+</span>
<a href="#l5.219"></a><span id="l5.219" class="difflineplus">+  // We expect the newmailalert.xul window...</span>
<a href="#l5.220"></a><span id="l5.220" class="difflineplus">+  plan_for_new_window(&quot;alert:alert&quot;);</span>
<a href="#l5.221"></a><span id="l5.221" class="difflineplus">+  make_gradually_newer_sets_in_folder(gFolder, [{count: 2}]);</span>
<a href="#l5.222"></a><span id="l5.222" class="difflineplus">+  let controller = wait_for_new_window(&quot;alert:alert&quot;);</span>
<a href="#l5.223"></a><span id="l5.223" class="difflineplus">+  plan_for_window_close(controller);</span>
<a href="#l5.224"></a><span id="l5.224" class="difflineplus">+  wait_for_window_close();</span>
<a href="#l5.225"></a><span id="l5.225" class="difflineplus">+}</span>
<a href="#l5.226"></a><span id="l5.226" class="difflineplus">+test_revert_to_newmailalert.EXCLUDED_PLATFORMS = ['winnt', 'darwin'];</span>
<a href="#l5.227"></a><span id="l5.227" class="difflineplus">+</span>
<a href="#l5.228"></a><span id="l5.228" class="difflineplus">+/**</span>
<a href="#l5.229"></a><span id="l5.229" class="difflineplus">+ * Test that receiving new mail causes a notification to appear</span>
<a href="#l5.230"></a><span id="l5.230" class="difflineplus">+ */</span>
<a href="#l5.231"></a><span id="l5.231" class="difflineplus">+function test_new_mail_received_causes_notification() {</span>
<a href="#l5.232"></a><span id="l5.232" class="difflineplus">+  make_gradually_newer_sets_in_folder(gFolder, [{count: 1}]);</span>
<a href="#l5.233"></a><span id="l5.233" class="difflineplus">+  assert_true(gMockAlertsService._didNotify,</span>
<a href="#l5.234"></a><span id="l5.234" class="difflineplus">+              &quot;Did not show alert notification.&quot;);</span>
<a href="#l5.235"></a><span id="l5.235" class="difflineplus">+}</span>
<a href="#l5.236"></a><span id="l5.236" class="difflineplus">+test_new_mail_received_causes_notification.EXCLUDED_PLATFORMS = ['winnt', 'darwin'];</span>
<a href="#l5.237"></a><span id="l5.237" class="difflineplus">+</span>
<a href="#l5.238"></a><span id="l5.238" class="difflineplus">+/**</span>
<a href="#l5.239"></a><span id="l5.239" class="difflineplus">+ * Test that if notification shows, we don't show newmailalert.xul</span>
<a href="#l5.240"></a><span id="l5.240" class="difflineplus">+ */</span>
<a href="#l5.241"></a><span id="l5.241" class="difflineplus">+function test_dont_show_newmailalert() {</span>
<a href="#l5.242"></a><span id="l5.242" class="difflineplus">+  make_gradually_newer_sets_in_folder(gFolder, [{count: 1}]);</span>
<a href="#l5.243"></a><span id="l5.243" class="difflineplus">+</span>
<a href="#l5.244"></a><span id="l5.244" class="difflineplus">+  // Wait for newmailalert.xul to show</span>
<a href="#l5.245"></a><span id="l5.245" class="difflineplus">+  plan_for_new_window(&quot;alert:alert&quot;);</span>
<a href="#l5.246"></a><span id="l5.246" class="difflineplus">+  try {</span>
<a href="#l5.247"></a><span id="l5.247" class="difflineplus">+    let controller = wait_for_new_window(&quot;alert:alert&quot;);</span>
<a href="#l5.248"></a><span id="l5.248" class="difflineplus">+    throw Error(&quot;Opened newmailalert.xul when we shouldn't have.&quot;);</span>
<a href="#l5.249"></a><span id="l5.249" class="difflineplus">+  } catch(e) {</span>
<a href="#l5.250"></a><span id="l5.250" class="difflineplus">+    // Correct behaviour - the window didn't show.</span>
<a href="#l5.251"></a><span id="l5.251" class="difflineplus">+  }</span>
<a href="#l5.252"></a><span id="l5.252" class="difflineplus">+}</span>
<a href="#l5.253"></a><span id="l5.253" class="difflineplus">+test_new_mail_received_causes_notification.EXCLUDED_PLATFORMS = ['winnt', 'darwin'];</span>
<a href="#l5.254"></a><span id="l5.254" class="difflineplus">+</span>
<a href="#l5.255"></a><span id="l5.255" class="difflineplus">+/**</span>
<a href="#l5.256"></a><span id="l5.256" class="difflineplus">+ * Test that we notify, showing the oldest new, unread message received</span>
<a href="#l5.257"></a><span id="l5.257" class="difflineplus">+ * since the last notification.</span>
<a href="#l5.258"></a><span id="l5.258" class="difflineplus">+ */</span>
<a href="#l5.259"></a><span id="l5.259" class="difflineplus">+function test_show_oldest_new_unread_since_last_notification() {</span>
<a href="#l5.260"></a><span id="l5.260" class="difflineplus">+  let notifyFirst = &quot;This should notify first&quot;;</span>
<a href="#l5.261"></a><span id="l5.261" class="difflineplus">+  assert_false(gMockAlertsService._didNotify, &quot;Should not have notified yet.&quot;);</span>
<a href="#l5.262"></a><span id="l5.262" class="difflineplus">+  make_gradually_newer_sets_in_folder(gFolder,</span>
<a href="#l5.263"></a><span id="l5.263" class="difflineplus">+                                      [{count: 1,</span>
<a href="#l5.264"></a><span id="l5.264" class="difflineplus">+                                        body: {body: notifyFirst}}])</span>
<a href="#l5.265"></a><span id="l5.265" class="difflineplus">+  assert_true(gMockAlertsService._didNotify, &quot;Should have notified.&quot;);</span>
<a href="#l5.266"></a><span id="l5.266" class="difflineplus">+  assert_true(gMockAlertsService._text.search(notifyFirst) &gt; 0,</span>
<a href="#l5.267"></a><span id="l5.267" class="difflineplus">+              &quot;Should have notified for the first message&quot;);</span>
<a href="#l5.268"></a><span id="l5.268" class="difflineplus">+</span>
<a href="#l5.269"></a><span id="l5.269" class="difflineplus">+  be_in_folder(gFolder);</span>
<a href="#l5.270"></a><span id="l5.270" class="difflineplus">+  gFolder.biffState = Ci.nsIMsgFolder.nsMsgBiffState_NoMail;</span>
<a href="#l5.271"></a><span id="l5.271" class="difflineplus">+  gMockAlertsService._reset();</span>
<a href="#l5.272"></a><span id="l5.272" class="difflineplus">+</span>
<a href="#l5.273"></a><span id="l5.273" class="difflineplus">+  let notifySecond = &quot;This should notify second&quot;;</span>
<a href="#l5.274"></a><span id="l5.274" class="difflineplus">+  assert_false(gMockAlertsService._didNotify, &quot;Should not have notified yet.&quot;);</span>
<a href="#l5.275"></a><span id="l5.275" class="difflineplus">+  make_gradually_newer_sets_in_folder(gFolder,</span>
<a href="#l5.276"></a><span id="l5.276" class="difflineplus">+                                      [{count: 1,</span>
<a href="#l5.277"></a><span id="l5.277" class="difflineplus">+                                        body: {body: notifySecond}}]);</span>
<a href="#l5.278"></a><span id="l5.278" class="difflineplus">+  assert_true(gMockAlertsService._didNotify, &quot;Should have notified.&quot;);</span>
<a href="#l5.279"></a><span id="l5.279" class="difflineplus">+  assert_true(gMockAlertsService._text.search(notifySecond) &gt; 0,</span>
<a href="#l5.280"></a><span id="l5.280" class="difflineplus">+              &quot;Should have notified for the second message&quot;);</span>
<a href="#l5.281"></a><span id="l5.281" class="difflineplus">+}</span>
<a href="#l5.282"></a><span id="l5.282" class="difflineplus">+test_show_oldest_new_unread_since_last_notification.EXCLUDED_PLATFORMS = ['winnt', 'darwin'];</span>
<a href="#l5.283"></a><span id="l5.283" class="difflineplus">+</span>
<a href="#l5.284"></a><span id="l5.284" class="difflineplus">+/**</span>
<a href="#l5.285"></a><span id="l5.285" class="difflineplus">+ * Test that notifications work across different accounts.</span>
<a href="#l5.286"></a><span id="l5.286" class="difflineplus">+ */</span>
<a href="#l5.287"></a><span id="l5.287" class="difflineplus">+function test_notification_works_across_accounts() {</span>
<a href="#l5.288"></a><span id="l5.288" class="difflineplus">+  // Cause a notification in the first folder</span>
<a href="#l5.289"></a><span id="l5.289" class="difflineplus">+  make_gradually_newer_sets_in_folder(gFolder, [{count: 1}]);</span>
<a href="#l5.290"></a><span id="l5.290" class="difflineplus">+  assert_true(gMockAlertsService._didNotify, &quot;Should have notified.&quot;);</span>
<a href="#l5.291"></a><span id="l5.291" class="difflineplus">+</span>
<a href="#l5.292"></a><span id="l5.292" class="difflineplus">+  gMockAlertsService._reset();</span>
<a href="#l5.293"></a><span id="l5.293" class="difflineplus">+  // We'll set the time for these messages to be slightly furthur</span>
<a href="#l5.294"></a><span id="l5.294" class="difflineplus">+  // into the past.  That way, test_notification_independent_across_accounts</span>
<a href="#l5.295"></a><span id="l5.295" class="difflineplus">+  // has an opportunity to send slightly newer messages that are older than</span>
<a href="#l5.296"></a><span id="l5.296" class="difflineplus">+  // the messages sent to gFolder.</span>
<a href="#l5.297"></a><span id="l5.297" class="difflineplus">+  make_gradually_newer_sets_in_folder(gFolder2,</span>
<a href="#l5.298"></a><span id="l5.298" class="difflineplus">+                                      [{count: 2,</span>
<a href="#l5.299"></a><span id="l5.299" class="difflineplus">+                                        age: {minutes: gMsgMinutes + 20}</span>
<a href="#l5.300"></a><span id="l5.300" class="difflineplus">+                                       }]);</span>
<a href="#l5.301"></a><span id="l5.301" class="difflineplus">+  assert_true(gMockAlertsService._didNotify, &quot;Should have notified.&quot;);</span>
<a href="#l5.302"></a><span id="l5.302" class="difflineplus">+}</span>
<a href="#l5.303"></a><span id="l5.303" class="difflineplus">+test_notification_works_across_accounts.EXCLUDED_PLATFORMS = ['winnt', 'darwin'];</span>
<a href="#l5.304"></a><span id="l5.304" class="difflineplus">+</span>
<a href="#l5.305"></a><span id="l5.305" class="difflineplus">+/* Test that notification timestamps are independent from account</span>
<a href="#l5.306"></a><span id="l5.306" class="difflineplus">+ * to account.  This is for the scenario where we have two accounts, and</span>
<a href="#l5.307"></a><span id="l5.307" class="difflineplus">+ * one has notified while the other is still updating.  When the second</span>
<a href="#l5.308"></a><span id="l5.308" class="difflineplus">+ * account completes, if it has new mail, it should notify, even if second</span>
<a href="#l5.309"></a><span id="l5.309" class="difflineplus">+ * account's newest mail is older than the first account's newest mail.</span>
<a href="#l5.310"></a><span id="l5.310" class="difflineplus">+ */</span>
<a href="#l5.311"></a><span id="l5.311" class="difflineplus">+function test_notifications_independent_across_accounts() {</span>
<a href="#l5.312"></a><span id="l5.312" class="difflineplus">+  make_gradually_newer_sets_in_folder(gFolder, [{count: 1}]);</span>
<a href="#l5.313"></a><span id="l5.313" class="difflineplus">+  assert_true(gMockAlertsService._didNotify, &quot;Should have notified.&quot;);</span>
<a href="#l5.314"></a><span id="l5.314" class="difflineplus">+</span>
<a href="#l5.315"></a><span id="l5.315" class="difflineplus">+  gMockAlertsService._reset();</span>
<a href="#l5.316"></a><span id="l5.316" class="difflineplus">+  // Next, let's make some mail arrive in the second folder, but</span>
<a href="#l5.317"></a><span id="l5.317" class="difflineplus">+  // let's have that mail be slightly older than the mail that</span>
<a href="#l5.318"></a><span id="l5.318" class="difflineplus">+  // landed in the first folder.  We should still notify.</span>
<a href="#l5.319"></a><span id="l5.319" class="difflineplus">+  make_gradually_newer_sets_in_folder(gFolder2,</span>
<a href="#l5.320"></a><span id="l5.320" class="difflineplus">+                                      [{count: 2,</span>
<a href="#l5.321"></a><span id="l5.321" class="difflineplus">+                                        age: {minutes: gMsgMinutes + 10}</span>
<a href="#l5.322"></a><span id="l5.322" class="difflineplus">+                                       }]);</span>
<a href="#l5.323"></a><span id="l5.323" class="difflineplus">+  assert_true(gMockAlertsService._didNotify, &quot;Should have notified.&quot;);</span>
<a href="#l5.324"></a><span id="l5.324" class="difflineplus">+}</span>
<a href="#l5.325"></a><span id="l5.325" class="difflineplus">+test_notifications_independent_across_accounts.EXCLUDED_PLATFORMS = ['winnt', 'darwin'];</span>
<a href="#l5.326"></a><span id="l5.326" class="difflineplus">+</span>
<a href="#l5.327"></a><span id="l5.327" class="difflineplus">+/**</span>
<a href="#l5.328"></a><span id="l5.328" class="difflineplus">+ * Test that we can show the message subject in the notification.</span>
<a href="#l5.329"></a><span id="l5.329" class="difflineplus">+ */</span>
<a href="#l5.330"></a><span id="l5.330" class="difflineplus">+function test_show_subject() {</span>
<a href="#l5.331"></a><span id="l5.331" class="difflineplus">+  let subject = &quot;This should be displayed&quot;;</span>
<a href="#l5.332"></a><span id="l5.332" class="difflineplus">+  make_gradually_newer_sets_in_folder(gFolder,</span>
<a href="#l5.333"></a><span id="l5.333" class="difflineplus">+                                      [{count: 1,</span>
<a href="#l5.334"></a><span id="l5.334" class="difflineplus">+                                        subject: subject</span>
<a href="#l5.335"></a><span id="l5.335" class="difflineplus">+                                       }]);</span>
<a href="#l5.336"></a><span id="l5.336" class="difflineplus">+  assert_true(gMockAlertsService._didNotify, &quot;Should have notified&quot;);</span>
<a href="#l5.337"></a><span id="l5.337" class="difflineplus">+  assert_true(gMockAlertsService._text.search(subject) != -1,</span>
<a href="#l5.338"></a><span id="l5.338" class="difflineplus">+              &quot;Should have displayed the subject&quot;);</span>
<a href="#l5.339"></a><span id="l5.339" class="difflineplus">+}</span>
<a href="#l5.340"></a><span id="l5.340" class="difflineplus">+test_show_subject.EXCLUDED_PLATFORMS = ['winnt', 'darwin'];</span>
<a href="#l5.341"></a><span id="l5.341" class="difflineplus">+</span>
<a href="#l5.342"></a><span id="l5.342" class="difflineplus">+/**</span>
<a href="#l5.343"></a><span id="l5.343" class="difflineplus">+ * Test that we can hide the message subject in the notification.</span>
<a href="#l5.344"></a><span id="l5.344" class="difflineplus">+ */</span>
<a href="#l5.345"></a><span id="l5.345" class="difflineplus">+function test_hide_subject() {</span>
<a href="#l5.346"></a><span id="l5.346" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mail.biff.alert.show_subject&quot;, false);</span>
<a href="#l5.347"></a><span id="l5.347" class="difflineplus">+  let subject = &quot;This should not be displayed&quot;;</span>
<a href="#l5.348"></a><span id="l5.348" class="difflineplus">+  make_gradually_newer_sets_in_folder(gFolder,</span>
<a href="#l5.349"></a><span id="l5.349" class="difflineplus">+                                      [{count: 1,</span>
<a href="#l5.350"></a><span id="l5.350" class="difflineplus">+                                        subject: subject</span>
<a href="#l5.351"></a><span id="l5.351" class="difflineplus">+                                       }]);</span>
<a href="#l5.352"></a><span id="l5.352" class="difflineplus">+  assert_true(gMockAlertsService._didNotify, &quot;Should have notified&quot;);</span>
<a href="#l5.353"></a><span id="l5.353" class="difflineplus">+  assert_equals(gMockAlertsService._text.search(subject), -1,</span>
<a href="#l5.354"></a><span id="l5.354" class="difflineplus">+                &quot;Should not have displayed the subject&quot;);</span>
<a href="#l5.355"></a><span id="l5.355" class="difflineplus">+}</span>
<a href="#l5.356"></a><span id="l5.356" class="difflineplus">+test_hide_subject.EXCLUDED_PLATFORMS = ['winnt', 'darwin'];</span>
<a href="#l5.357"></a><span id="l5.357" class="difflineplus">+</span>
<a href="#l5.358"></a><span id="l5.358" class="difflineplus">+/**</span>
<a href="#l5.359"></a><span id="l5.359" class="difflineplus">+ * Test that we can show just the message sender in the notification.</span>
<a href="#l5.360"></a><span id="l5.360" class="difflineplus">+ */</span>
<a href="#l5.361"></a><span id="l5.361" class="difflineplus">+function test_show_only_subject() {</span>
<a href="#l5.362"></a><span id="l5.362" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mail.biff.alert.show_preview&quot;, false);</span>
<a href="#l5.363"></a><span id="l5.363" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mail.biff.alert.show_sender&quot;, false);</span>
<a href="#l5.364"></a><span id="l5.364" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mail.biff.alert.show_subject&quot;, true);</span>
<a href="#l5.365"></a><span id="l5.365" class="difflineplus">+</span>
<a href="#l5.366"></a><span id="l5.366" class="difflineplus">+  let sender = [&quot;John Cleese&quot;, &quot;john@cleese.net&quot;];</span>
<a href="#l5.367"></a><span id="l5.367" class="difflineplus">+  let subject = &quot;This should not be displayed&quot;;</span>
<a href="#l5.368"></a><span id="l5.368" class="difflineplus">+  let messageBody = &quot;My message preview&quot;;</span>
<a href="#l5.369"></a><span id="l5.369" class="difflineplus">+</span>
<a href="#l5.370"></a><span id="l5.370" class="difflineplus">+  make_gradually_newer_sets_in_folder(gFolder,</span>
<a href="#l5.371"></a><span id="l5.371" class="difflineplus">+                                      [{count: 1,</span>
<a href="#l5.372"></a><span id="l5.372" class="difflineplus">+                                        from: sender,</span>
<a href="#l5.373"></a><span id="l5.373" class="difflineplus">+                                        subject: subject,</span>
<a href="#l5.374"></a><span id="l5.374" class="difflineplus">+                                        body: {body: messageBody}}]);</span>
<a href="#l5.375"></a><span id="l5.375" class="difflineplus">+  assert_true(gMockAlertsService._didNotify, &quot;Should have notified&quot;);</span>
<a href="#l5.376"></a><span id="l5.376" class="difflineplus">+  assert_true(gMockAlertsService._text.search(subject) != -1,</span>
<a href="#l5.377"></a><span id="l5.377" class="difflineplus">+              &quot;Should have displayed the subject&quot;);</span>
<a href="#l5.378"></a><span id="l5.378" class="difflineplus">+  assert_equals(gMockAlertsService._text.search(messageBody), -1,</span>
<a href="#l5.379"></a><span id="l5.379" class="difflineplus">+                &quot;Should not have displayed the preview&quot;);</span>
<a href="#l5.380"></a><span id="l5.380" class="difflineplus">+  assert_equals(gMockAlertsService._text.search(sender[0]), -1,</span>
<a href="#l5.381"></a><span id="l5.381" class="difflineplus">+                &quot;Should not have displayed the sender&quot;);</span>
<a href="#l5.382"></a><span id="l5.382" class="difflineplus">+</span>
<a href="#l5.383"></a><span id="l5.383" class="difflineplus">+}</span>
<a href="#l5.384"></a><span id="l5.384" class="difflineplus">+test_show_only_subject.EXCLUDED_PLATFORMS = ['winnt', 'darwin'];</span>
<a href="#l5.385"></a><span id="l5.385" class="difflineplus">+</span>
<a href="#l5.386"></a><span id="l5.386" class="difflineplus">+</span>
<a href="#l5.387"></a><span id="l5.387" class="difflineplus">+/**</span>
<a href="#l5.388"></a><span id="l5.388" class="difflineplus">+ * Test that we can show the message sender in the notification.</span>
<a href="#l5.389"></a><span id="l5.389" class="difflineplus">+ */</span>
<a href="#l5.390"></a><span id="l5.390" class="difflineplus">+function test_show_sender() {</span>
<a href="#l5.391"></a><span id="l5.391" class="difflineplus">+  let sender = [&quot;John Cleese&quot;, &quot;john@cleese.net&quot;];</span>
<a href="#l5.392"></a><span id="l5.392" class="difflineplus">+  make_gradually_newer_sets_in_folder(gFolder,</span>
<a href="#l5.393"></a><span id="l5.393" class="difflineplus">+                                      [{count: 1,</span>
<a href="#l5.394"></a><span id="l5.394" class="difflineplus">+                                        from: sender}]);</span>
<a href="#l5.395"></a><span id="l5.395" class="difflineplus">+  assert_true(gMockAlertsService._didNotify, &quot;Should have notified&quot;);</span>
<a href="#l5.396"></a><span id="l5.396" class="difflineplus">+  assert_true(gMockAlertsService._text.search(sender[0]) != -1,</span>
<a href="#l5.397"></a><span id="l5.397" class="difflineplus">+              &quot;Should have displayed the sender&quot;);</span>
<a href="#l5.398"></a><span id="l5.398" class="difflineplus">+}</span>
<a href="#l5.399"></a><span id="l5.399" class="difflineplus">+test_show_sender.EXCLUDED_PLATFORMS = ['winnt', 'darwin'];</span>
<a href="#l5.400"></a><span id="l5.400" class="difflineplus">+</span>
<a href="#l5.401"></a><span id="l5.401" class="difflineplus">+/**</span>
<a href="#l5.402"></a><span id="l5.402" class="difflineplus">+ * Test that we can hide the message sender in the notification.</span>
<a href="#l5.403"></a><span id="l5.403" class="difflineplus">+ */</span>
<a href="#l5.404"></a><span id="l5.404" class="difflineplus">+function test_hide_sender() {</span>
<a href="#l5.405"></a><span id="l5.405" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mail.biff.alert.show_sender&quot;, false);</span>
<a href="#l5.406"></a><span id="l5.406" class="difflineplus">+  let sender = [&quot;John Cleese&quot;, &quot;john@cleese.net&quot;];</span>
<a href="#l5.407"></a><span id="l5.407" class="difflineplus">+  make_gradually_newer_sets_in_folder(gFolder,</span>
<a href="#l5.408"></a><span id="l5.408" class="difflineplus">+                                      [{count: 1,</span>
<a href="#l5.409"></a><span id="l5.409" class="difflineplus">+                                        from: sender}]);</span>
<a href="#l5.410"></a><span id="l5.410" class="difflineplus">+  assert_true(gMockAlertsService._didNotify, &quot;Should have notified&quot;);</span>
<a href="#l5.411"></a><span id="l5.411" class="difflineplus">+  assert_equals(gMockAlertsService._text.search(sender[0]), -1,</span>
<a href="#l5.412"></a><span id="l5.412" class="difflineplus">+                &quot;Should not have displayed the sender&quot;);</span>
<a href="#l5.413"></a><span id="l5.413" class="difflineplus">+}</span>
<a href="#l5.414"></a><span id="l5.414" class="difflineplus">+test_hide_sender.EXCLUDED_PLATFORMS = ['winnt', 'darwin'];</span>
<a href="#l5.415"></a><span id="l5.415" class="difflineplus">+</span>
<a href="#l5.416"></a><span id="l5.416" class="difflineplus">+/**</span>
<a href="#l5.417"></a><span id="l5.417" class="difflineplus">+ * Test that we can show just the message sender in the notification.</span>
<a href="#l5.418"></a><span id="l5.418" class="difflineplus">+ */</span>
<a href="#l5.419"></a><span id="l5.419" class="difflineplus">+function test_show_only_sender() {</span>
<a href="#l5.420"></a><span id="l5.420" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mail.biff.alert.show_preview&quot;, false);</span>
<a href="#l5.421"></a><span id="l5.421" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mail.biff.alert.show_sender&quot;, true);</span>
<a href="#l5.422"></a><span id="l5.422" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mail.biff.alert.show_subject&quot;, false);</span>
<a href="#l5.423"></a><span id="l5.423" class="difflineplus">+</span>
<a href="#l5.424"></a><span id="l5.424" class="difflineplus">+  let sender = [&quot;John Cleese&quot;, &quot;john@cleese.net&quot;];</span>
<a href="#l5.425"></a><span id="l5.425" class="difflineplus">+  let subject = &quot;This should not be displayed&quot;;</span>
<a href="#l5.426"></a><span id="l5.426" class="difflineplus">+  let messageBody = &quot;My message preview&quot;;</span>
<a href="#l5.427"></a><span id="l5.427" class="difflineplus">+</span>
<a href="#l5.428"></a><span id="l5.428" class="difflineplus">+  make_gradually_newer_sets_in_folder(gFolder,</span>
<a href="#l5.429"></a><span id="l5.429" class="difflineplus">+                                      [{count: 1,</span>
<a href="#l5.430"></a><span id="l5.430" class="difflineplus">+                                        from: sender,</span>
<a href="#l5.431"></a><span id="l5.431" class="difflineplus">+                                        subject: subject,</span>
<a href="#l5.432"></a><span id="l5.432" class="difflineplus">+                                        body: {body: messageBody}}]);</span>
<a href="#l5.433"></a><span id="l5.433" class="difflineplus">+  assert_true(gMockAlertsService._didNotify, &quot;Should have notified&quot;);</span>
<a href="#l5.434"></a><span id="l5.434" class="difflineplus">+  assert_true(gMockAlertsService._text.search(sender[0]) != -1,</span>
<a href="#l5.435"></a><span id="l5.435" class="difflineplus">+              &quot;Should have displayed the sender&quot;);</span>
<a href="#l5.436"></a><span id="l5.436" class="difflineplus">+  assert_equals(gMockAlertsService._text.search(messageBody), -1,</span>
<a href="#l5.437"></a><span id="l5.437" class="difflineplus">+                &quot;Should not have displayed the preview&quot;);</span>
<a href="#l5.438"></a><span id="l5.438" class="difflineplus">+  assert_equals(gMockAlertsService._text.search(subject), -1,</span>
<a href="#l5.439"></a><span id="l5.439" class="difflineplus">+                &quot;Should not have displayed the subject&quot;);</span>
<a href="#l5.440"></a><span id="l5.440" class="difflineplus">+</span>
<a href="#l5.441"></a><span id="l5.441" class="difflineplus">+}</span>
<a href="#l5.442"></a><span id="l5.442" class="difflineplus">+test_show_only_sender.EXCLUDED_PLATFORMS = ['winnt', 'darwin'];</span>
<a href="#l5.443"></a><span id="l5.443" class="difflineplus">+</span>
<a href="#l5.444"></a><span id="l5.444" class="difflineplus">+/**</span>
<a href="#l5.445"></a><span id="l5.445" class="difflineplus">+ * Test that we can show the message preview in the notification.</span>
<a href="#l5.446"></a><span id="l5.446" class="difflineplus">+ */</span>
<a href="#l5.447"></a><span id="l5.447" class="difflineplus">+function test_show_preview() {</span>
<a href="#l5.448"></a><span id="l5.448" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mail.biff.alert.show_preview&quot;, true);</span>
<a href="#l5.449"></a><span id="l5.449" class="difflineplus">+  let messageBody = &quot;My message preview&quot;;</span>
<a href="#l5.450"></a><span id="l5.450" class="difflineplus">+  make_gradually_newer_sets_in_folder(gFolder,</span>
<a href="#l5.451"></a><span id="l5.451" class="difflineplus">+                                      [{count: 1,</span>
<a href="#l5.452"></a><span id="l5.452" class="difflineplus">+                                        body: {body: messageBody}}]);</span>
<a href="#l5.453"></a><span id="l5.453" class="difflineplus">+  assert_true(gMockAlertsService._didNotify, &quot;Should have notified&quot;);</span>
<a href="#l5.454"></a><span id="l5.454" class="difflineplus">+  assert_true(gMockAlertsService._text.search(messageBody) != -1,</span>
<a href="#l5.455"></a><span id="l5.455" class="difflineplus">+              &quot;Should have displayed the preview&quot;);</span>
<a href="#l5.456"></a><span id="l5.456" class="difflineplus">+}</span>
<a href="#l5.457"></a><span id="l5.457" class="difflineplus">+test_show_preview.EXCLUDED_PLATFORMS = ['winnt', 'darwin'];</span>
<a href="#l5.458"></a><span id="l5.458" class="difflineplus">+</span>
<a href="#l5.459"></a><span id="l5.459" class="difflineplus">+/**</span>
<a href="#l5.460"></a><span id="l5.460" class="difflineplus">+ * Test that we can hide the message preview in the notification.</span>
<a href="#l5.461"></a><span id="l5.461" class="difflineplus">+ */</span>
<a href="#l5.462"></a><span id="l5.462" class="difflineplus">+function test_hide_preview() {</span>
<a href="#l5.463"></a><span id="l5.463" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mail.biff.alert.show_preview&quot;, false);</span>
<a href="#l5.464"></a><span id="l5.464" class="difflineplus">+  let messageBody = &quot;My message preview&quot;;</span>
<a href="#l5.465"></a><span id="l5.465" class="difflineplus">+  make_gradually_newer_sets_in_folder(gFolder,</span>
<a href="#l5.466"></a><span id="l5.466" class="difflineplus">+                                      [{count: 1,</span>
<a href="#l5.467"></a><span id="l5.467" class="difflineplus">+                                        body: {body: messageBody}}]);</span>
<a href="#l5.468"></a><span id="l5.468" class="difflineplus">+  assert_true(gMockAlertsService._didNotify, &quot;Should have notified&quot;);</span>
<a href="#l5.469"></a><span id="l5.469" class="difflineplus">+  assert_equals(gMockAlertsService._text.search(messageBody), -1,</span>
<a href="#l5.470"></a><span id="l5.470" class="difflineplus">+                &quot;Should not have displayed the preview&quot;);</span>
<a href="#l5.471"></a><span id="l5.471" class="difflineplus">+}</span>
<a href="#l5.472"></a><span id="l5.472" class="difflineplus">+test_hide_preview.EXCLUDED_PLATFORMS = ['winnt', 'darwin'];</span>
<a href="#l5.473"></a><span id="l5.473" class="difflineplus">+</span>
<a href="#l5.474"></a><span id="l5.474" class="difflineplus">+/**</span>
<a href="#l5.475"></a><span id="l5.475" class="difflineplus">+ * Test that we can show justthe message preview in the notification.</span>
<a href="#l5.476"></a><span id="l5.476" class="difflineplus">+ */</span>
<a href="#l5.477"></a><span id="l5.477" class="difflineplus">+function test_show_only_preview() {</span>
<a href="#l5.478"></a><span id="l5.478" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mail.biff.alert.show_preview&quot;, true);</span>
<a href="#l5.479"></a><span id="l5.479" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mail.biff.alert.show_sender&quot;, false);</span>
<a href="#l5.480"></a><span id="l5.480" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mail.biff.alert.show_subject&quot;, false);</span>
<a href="#l5.481"></a><span id="l5.481" class="difflineplus">+</span>
<a href="#l5.482"></a><span id="l5.482" class="difflineplus">+  let sender = [&quot;John Cleese&quot;, &quot;john@cleese.net&quot;];</span>
<a href="#l5.483"></a><span id="l5.483" class="difflineplus">+  let subject = &quot;This should not be displayed&quot;;</span>
<a href="#l5.484"></a><span id="l5.484" class="difflineplus">+  let messageBody = &quot;My message preview&quot;;</span>
<a href="#l5.485"></a><span id="l5.485" class="difflineplus">+  make_gradually_newer_sets_in_folder(gFolder,</span>
<a href="#l5.486"></a><span id="l5.486" class="difflineplus">+                                      [{count: 1,</span>
<a href="#l5.487"></a><span id="l5.487" class="difflineplus">+                                        from: sender,</span>
<a href="#l5.488"></a><span id="l5.488" class="difflineplus">+                                        subject: subject,</span>
<a href="#l5.489"></a><span id="l5.489" class="difflineplus">+                                        body: {body: messageBody}}]);</span>
<a href="#l5.490"></a><span id="l5.490" class="difflineplus">+  assert_true(gMockAlertsService._didNotify, &quot;Should have notified&quot;);</span>
<a href="#l5.491"></a><span id="l5.491" class="difflineplus">+  assert_true(gMockAlertsService._text.search(messageBody) != -1,</span>
<a href="#l5.492"></a><span id="l5.492" class="difflineplus">+              &quot;Should have displayed the preview: &quot; + gMockAlertsService._text);</span>
<a href="#l5.493"></a><span id="l5.493" class="difflineplus">+  assert_equals(gMockAlertsService._text.search(sender[0]), -1,</span>
<a href="#l5.494"></a><span id="l5.494" class="difflineplus">+                &quot;Should not have displayed the sender&quot;);</span>
<a href="#l5.495"></a><span id="l5.495" class="difflineplus">+  assert_equals(gMockAlertsService._text.search(subject), -1,</span>
<a href="#l5.496"></a><span id="l5.496" class="difflineplus">+                &quot;Should not have displayed the subject&quot;);</span>
<a href="#l5.497"></a><span id="l5.497" class="difflineplus">+}</span>
<a href="#l5.498"></a><span id="l5.498" class="difflineplus">+test_show_only_preview.EXCLUDED_PLATFORMS = ['winnt', 'darwin'];</span>
<a href="#l5.499"></a><span id="l5.499" class="difflineplus">+</span>
<a href="#l5.500"></a><span id="l5.500" class="difflineplus">+/**</span>
<a href="#l5.501"></a><span id="l5.501" class="difflineplus">+ * Test that we can receive notifications even when the biff state of</span>
<a href="#l5.502"></a><span id="l5.502" class="difflineplus">+ * the folder has not been changed.</span>
<a href="#l5.503"></a><span id="l5.503" class="difflineplus">+ */</span>
<a href="#l5.504"></a><span id="l5.504" class="difflineplus">+function test_still_notify_with_unchanged_biff() {</span>
<a href="#l5.505"></a><span id="l5.505" class="difflineplus">+</span>
<a href="#l5.506"></a><span id="l5.506" class="difflineplus">+  // For now, we'll make sure that if we receive 10 pieces</span>
<a href="#l5.507"></a><span id="l5.507" class="difflineplus">+  // of email, one after the other, we'll be notified for all</span>
<a href="#l5.508"></a><span id="l5.508" class="difflineplus">+  // (assuming of course that the notifications have a chance</span>
<a href="#l5.509"></a><span id="l5.509" class="difflineplus">+  // to close in between arrivals - we don't want a queue of</span>
<a href="#l5.510"></a><span id="l5.510" class="difflineplus">+  // notifications to go through).</span>
<a href="#l5.511"></a><span id="l5.511" class="difflineplus">+  const HOW_MUCH_MAIL = 10;</span>
<a href="#l5.512"></a><span id="l5.512" class="difflineplus">+</span>
<a href="#l5.513"></a><span id="l5.513" class="difflineplus">+  assert_false(gMockAlertsService._didNotify, &quot;Should have notified.&quot;);</span>
<a href="#l5.514"></a><span id="l5.514" class="difflineplus">+</span>
<a href="#l5.515"></a><span id="l5.515" class="difflineplus">+  for (let i = 0; i &lt; HOW_MUCH_MAIL; i++) {</span>
<a href="#l5.516"></a><span id="l5.516" class="difflineplus">+    make_gradually_newer_sets_in_folder(gFolder, [{count: 1}]);</span>
<a href="#l5.517"></a><span id="l5.517" class="difflineplus">+    assert_true(gMockAlertsService._didNotify, &quot;Should have notified.&quot;);</span>
<a href="#l5.518"></a><span id="l5.518" class="difflineplus">+    gMockAlertsService._reset();</span>
<a href="#l5.519"></a><span id="l5.519" class="difflineplus">+  }</span>
<a href="#l5.520"></a><span id="l5.520" class="difflineplus">+}</span>
<a href="#l5.521"></a><span id="l5.521" class="difflineplus">+test_still_notify_with_unchanged_biff.EXCLUDED_PLATFORMS = ['winnt', 'darwin'];</span>
<a href="#l5.522"></a><span id="l5.522" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-folder-display-helpers.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-folder-display-helpers.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -2756,8 +2756,14 @@ function assert_not_equals(a, b, comment</span>
<a href="#l6.4"></a><span id="l6.4">   assert_true(a != b, comment + &quot;: '&quot;+ a + &quot;' == '&quot; + b + &quot;'.&quot;);</span>
<a href="#l6.5"></a><span id="l6.5"> }</span>
<a href="#l6.6"></a><span id="l6.6"> </span>
<a href="#l6.7"></a><span id="l6.7"> // something less sucky than do_check_true</span>
<a href="#l6.8"></a><span id="l6.8"> function assert_true(aBeTrue, aWhy) {</span>
<a href="#l6.9"></a><span id="l6.9">   if (!aBeTrue)</span>
<a href="#l6.10"></a><span id="l6.10">     throw new Error(aWhy);</span>
<a href="#l6.11"></a><span id="l6.11"> }</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+// something less sucky than do_check_false</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+function assert_false(aBeTrue, aWhy) {</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+  if (aBeTrue)</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+    throw new Error(aWhy);</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/base/src/nsMessengerUnixIntegration.cpp</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/base/src/nsMessengerUnixIntegration.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -63,27 +63,40 @@</span>
<a href="#l7.4"></a><span id="l7.4"> #include &quot;nsIMessengerWindowService.h&quot;</span>
<a href="#l7.5"></a><span id="l7.5"> #include &quot;prprf.h&quot;</span>
<a href="#l7.6"></a><span id="l7.6"> #include &quot;nsIWeakReference.h&quot;</span>
<a href="#l7.7"></a><span id="l7.7"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l7.8"></a><span id="l7.8"> #include &quot;nsIAlertsService.h&quot;</span>
<a href="#l7.9"></a><span id="l7.9"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l7.10"></a><span id="l7.10"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l7.11"></a><span id="l7.11"> #include &quot;nsISupportsPrimitives.h&quot;</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+#include &quot;nsIMsgDatabase.h&quot;</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+#include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+#include &quot;nsIMsgHeaderParser.h&quot;</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+#include &quot;nsAutoPtr.h&quot;</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+#include &quot;prmem.h&quot;</span>
<a href="#l7.17"></a><span id="l7.17"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l7.18"></a><span id="l7.18"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l7.19"></a><span id="l7.19"> #include &quot;nsIWeakReferenceUtils.h&quot;</span>
<a href="#l7.20"></a><span id="l7.20"> </span>
<a href="#l7.21"></a><span id="l7.21"> #include &quot;nsNativeCharsetUtils.h&quot;</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineminus">-#include &quot;nsToolkitCompsCID.h&quot; </span>
<a href="#l7.23"></a><span id="l7.23" class="difflineplus">+#include &quot;nsToolkitCompsCID.h&quot;</span>
<a href="#l7.24"></a><span id="l7.24"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineplus">+#include &quot;msgCore.h&quot;</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineplus">+#include &quot;nsCOMArray.h&quot;</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineplus">+#include &quot;nsIMutableArray.h&quot;</span>
<a href="#l7.28"></a><span id="l7.28"> </span>
<a href="#l7.29"></a><span id="l7.29"> #define ALERT_CHROME_URL &quot;chrome://messenger/content/newmailalert.xul&quot;</span>
<a href="#l7.30"></a><span id="l7.30"> #define NEW_MAIL_ALERT_ICON &quot;chrome://messenger/skin/icons/new-mail-alert.png&quot;</span>
<a href="#l7.31"></a><span id="l7.31"> #define SHOW_ALERT_PREF &quot;mail.biff.show_alert&quot;</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+#define SHOW_ALERT_PREVIEW_LENGTH &quot;mail.biff.alert.preview_length&quot;</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+#define SHOW_ALERT_PREVIEW_LENGTH_DEFAULT 40</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+#define SHOW_ALERT_PREVIEW &quot;mail.biff.alert.show_preview&quot;</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+#define SHOW_ALERT_SENDER  &quot;mail.biff.alert.show_sender&quot;</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+#define SHOW_ALERT_SUBJECT &quot;mail.biff.alert.show_subject&quot;</span>
<a href="#l7.37"></a><span id="l7.37"> </span>
<a href="#l7.38"></a><span id="l7.38"> static void openMailWindow(const nsACString&amp; aFolderUri)</span>
<a href="#l7.39"></a><span id="l7.39"> {</span>
<a href="#l7.40"></a><span id="l7.40">   nsresult rv;</span>
<a href="#l7.41"></a><span id="l7.41">   nsCOMPtr&lt;nsIMsgMailSession&gt; mailSession ( do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv));</span>
<a href="#l7.42"></a><span id="l7.42">   if (NS_FAILED(rv))</span>
<a href="#l7.43"></a><span id="l7.43">     return;</span>
<a href="#l7.44"></a><span id="l7.44"> </span>
<a href="#l7.45"></a><span id="l7.45" class="difflineat">@@ -93,17 +106,17 @@ static void openMailWindow(const nsACStr</span>
<a href="#l7.46"></a><span id="l7.46">   {</span>
<a href="#l7.47"></a><span id="l7.47">     if (!aFolderUri.IsEmpty())</span>
<a href="#l7.48"></a><span id="l7.48">     {</span>
<a href="#l7.49"></a><span id="l7.49">       nsCOMPtr&lt;nsIMsgWindowCommands&gt; windowCommands;</span>
<a href="#l7.50"></a><span id="l7.50">       topMostMsgWindow-&gt;GetWindowCommands(getter_AddRefs(windowCommands));</span>
<a href="#l7.51"></a><span id="l7.51">       if (windowCommands)</span>
<a href="#l7.52"></a><span id="l7.52">         windowCommands-&gt;SelectFolder(aFolderUri);</span>
<a href="#l7.53"></a><span id="l7.53">     }</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineminus">-    </span>
<a href="#l7.55"></a><span id="l7.55" class="difflineplus">+</span>
<a href="#l7.56"></a><span id="l7.56">     nsCOMPtr&lt;nsIDOMWindowInternal&gt; domWindow;</span>
<a href="#l7.57"></a><span id="l7.57">     topMostMsgWindow-&gt;GetDomWindow(getter_AddRefs(domWindow));</span>
<a href="#l7.58"></a><span id="l7.58">     domWindow-&gt;Focus();</span>
<a href="#l7.59"></a><span id="l7.59">   }</span>
<a href="#l7.60"></a><span id="l7.60">   else</span>
<a href="#l7.61"></a><span id="l7.61">   {</span>
<a href="#l7.62"></a><span id="l7.62">     // the user doesn't have a mail window open already so open one for them...</span>
<a href="#l7.63"></a><span id="l7.63">     nsCOMPtr&lt;nsIMessengerWindowService&gt; messengerWindowService =</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineat">@@ -115,21 +128,24 @@ static void openMailWindow(const nsACStr</span>
<a href="#l7.65"></a><span id="l7.65">       messengerWindowService-&gt;OpenMessengerWindowWithUri(</span>
<a href="#l7.66"></a><span id="l7.66">                                 &quot;mail:3pane&quot;, nsCString(aFolderUri).get(), nsMsgKey_None);</span>
<a href="#l7.67"></a><span id="l7.67">   }</span>
<a href="#l7.68"></a><span id="l7.68"> }</span>
<a href="#l7.69"></a><span id="l7.69"> </span>
<a href="#l7.70"></a><span id="l7.70"> nsMessengerUnixIntegration::nsMessengerUnixIntegration()</span>
<a href="#l7.71"></a><span id="l7.71"> {</span>
<a href="#l7.72"></a><span id="l7.72">   mBiffStateAtom = MsgGetAtom(&quot;BiffState&quot;);</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineplus">+  mNewMailReceivedAtom = MsgGetAtom(&quot;NewMailReceived&quot;);</span>
<a href="#l7.74"></a><span id="l7.74">   mAlertInProgress = PR_FALSE;</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineplus">+  mLastMRUTimes.Init();</span>
<a href="#l7.76"></a><span id="l7.76">   NS_NewISupportsArray(getter_AddRefs(mFoldersWithNewMail));</span>
<a href="#l7.77"></a><span id="l7.77"> }</span>
<a href="#l7.78"></a><span id="l7.78"> </span>
<a href="#l7.79"></a><span id="l7.79" class="difflineminus">-NS_IMPL_ISUPPORTS3(nsMessengerUnixIntegration, nsIFolderListener, nsIObserver, nsIMessengerOSIntegration)</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineplus">+NS_IMPL_ISUPPORTS4(nsMessengerUnixIntegration, nsIFolderListener, nsIObserver,</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineplus">+                   nsIMessengerOSIntegration, nsIUrlListener)</span>
<a href="#l7.82"></a><span id="l7.82"> </span>
<a href="#l7.83"></a><span id="l7.83"> nsresult</span>
<a href="#l7.84"></a><span id="l7.84"> nsMessengerUnixIntegration::Init()</span>
<a href="#l7.85"></a><span id="l7.85"> {</span>
<a href="#l7.86"></a><span id="l7.86">   nsresult rv;</span>
<a href="#l7.87"></a><span id="l7.87"> </span>
<a href="#l7.88"></a><span id="l7.88">   nsCOMPtr&lt;nsIMsgMailSession&gt; mailSession = do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l7.89"></a><span id="l7.89">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineat">@@ -161,49 +177,275 @@ nsresult nsMessengerUnixIntegration::Get</span>
<a href="#l7.91"></a><span id="l7.91">   nsCOMPtr&lt;nsIStringBundleService&gt; bundleService = do_GetService(NS_STRINGBUNDLE_CONTRACTID, &amp;rv);</span>
<a href="#l7.92"></a><span id="l7.92">   nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l7.93"></a><span id="l7.93">   if (bundleService &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l7.94"></a><span id="l7.94">     bundleService-&gt;CreateBundle(&quot;chrome://messenger/locale/messenger.properties&quot;, getter_AddRefs(bundle));</span>
<a href="#l7.95"></a><span id="l7.95">   bundle.swap(*aBundle);</span>
<a href="#l7.96"></a><span id="l7.96">   return rv;</span>
<a href="#l7.97"></a><span id="l7.97"> }</span>
<a href="#l7.98"></a><span id="l7.98"> </span>
<a href="#l7.99"></a><span id="l7.99" class="difflineplus">+#ifdef MOZ_THUNDERBIRD</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineplus">+PRBool</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineplus">+nsMessengerUnixIntegration::BuildNotificationTitle(nsIMsgFolder *aFolder, nsIStringBundle *aBundle, nsString &amp;aTitle)</span>
<a href="#l7.102"></a><span id="l7.102" class="difflineplus">+{</span>
<a href="#l7.103"></a><span id="l7.103" class="difflineplus">+  nsString accountName;</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineplus">+  aFolder-&gt;GetPrettiestName(accountName);</span>
<a href="#l7.105"></a><span id="l7.105" class="difflineplus">+</span>
<a href="#l7.106"></a><span id="l7.106" class="difflineplus">+  PRInt32 numNewMessages = 0;</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineplus">+  aFolder-&gt;GetNumNewMessages(PR_TRUE, &amp;numNewMessages);</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineplus">+</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineplus">+  if (!numNewMessages)</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineplus">+    return PR_FALSE;</span>
<a href="#l7.111"></a><span id="l7.111" class="difflineplus">+</span>
<a href="#l7.112"></a><span id="l7.112" class="difflineplus">+  nsAutoString numNewMsgsText;</span>
<a href="#l7.113"></a><span id="l7.113" class="difflineplus">+  numNewMsgsText.AppendInt(numNewMessages);</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineplus">+</span>
<a href="#l7.115"></a><span id="l7.115" class="difflineplus">+  const PRUnichar *formatStrings[] =</span>
<a href="#l7.116"></a><span id="l7.116" class="difflineplus">+  {</span>
<a href="#l7.117"></a><span id="l7.117" class="difflineplus">+    accountName.get(), numNewMsgsText.get()</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineplus">+  };</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineplus">+</span>
<a href="#l7.120"></a><span id="l7.120" class="difflineplus">+  aBundle-&gt;FormatStringFromName(numNewMessages == 1 ?</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineplus">+                                  NS_LITERAL_STRING(&quot;newMailNotification_message&quot;).get() :</span>
<a href="#l7.122"></a><span id="l7.122" class="difflineplus">+                                  NS_LITERAL_STRING(&quot;newMailNotification_messages&quot;).get(),</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineplus">+                                formatStrings, 2, getter_Copies(aTitle));</span>
<a href="#l7.124"></a><span id="l7.124" class="difflineplus">+  return PR_TRUE;</span>
<a href="#l7.125"></a><span id="l7.125" class="difflineplus">+}</span>
<a href="#l7.126"></a><span id="l7.126" class="difflineplus">+</span>
<a href="#l7.127"></a><span id="l7.127" class="difflineplus">+/* This comparator lets us sort an nsCOMArray of nsIMsgDBHdr's by</span>
<a href="#l7.128"></a><span id="l7.128" class="difflineplus">+ * their dateInSeconds attributes in ascending order.</span>
<a href="#l7.129"></a><span id="l7.129" class="difflineplus">+ */</span>
<a href="#l7.130"></a><span id="l7.130" class="difflineplus">+static int</span>
<a href="#l7.131"></a><span id="l7.131" class="difflineplus">+nsMsgDbHdrTimestampComparator(nsIMsgDBHdr *aElement1,</span>
<a href="#l7.132"></a><span id="l7.132" class="difflineplus">+                              nsIMsgDBHdr *aElement2,</span>
<a href="#l7.133"></a><span id="l7.133" class="difflineplus">+                              void *aData)</span>
<a href="#l7.134"></a><span id="l7.134" class="difflineplus">+{</span>
<a href="#l7.135"></a><span id="l7.135" class="difflineplus">+  PRUint32 aElement1Timestamp;</span>
<a href="#l7.136"></a><span id="l7.136" class="difflineplus">+  nsresult rv = aElement1-&gt;GetDateInSeconds(&amp;aElement1Timestamp);</span>
<a href="#l7.137"></a><span id="l7.137" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l7.138"></a><span id="l7.138" class="difflineplus">+    return 0;</span>
<a href="#l7.139"></a><span id="l7.139" class="difflineplus">+</span>
<a href="#l7.140"></a><span id="l7.140" class="difflineplus">+  PRUint32 aElement2Timestamp;</span>
<a href="#l7.141"></a><span id="l7.141" class="difflineplus">+  rv = aElement2-&gt;GetDateInSeconds(&amp;aElement2Timestamp);</span>
<a href="#l7.142"></a><span id="l7.142" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l7.143"></a><span id="l7.143" class="difflineplus">+    return 0;</span>
<a href="#l7.144"></a><span id="l7.144" class="difflineplus">+</span>
<a href="#l7.145"></a><span id="l7.145" class="difflineplus">+  return aElement1Timestamp - aElement2Timestamp;</span>
<a href="#l7.146"></a><span id="l7.146" class="difflineplus">+}</span>
<a href="#l7.147"></a><span id="l7.147" class="difflineplus">+</span>
<a href="#l7.148"></a><span id="l7.148" class="difflineplus">+</span>
<a href="#l7.149"></a><span id="l7.149" class="difflineplus">+PRBool</span>
<a href="#l7.150"></a><span id="l7.150" class="difflineplus">+nsMessengerUnixIntegration::BuildNotificationBody(nsIMsgDBHdr *aHdr,</span>
<a href="#l7.151"></a><span id="l7.151" class="difflineplus">+                                                  nsIStringBundle *aBundle,</span>
<a href="#l7.152"></a><span id="l7.152" class="difflineplus">+                                                  nsString &amp;aBody)</span>
<a href="#l7.153"></a><span id="l7.153" class="difflineplus">+{</span>
<a href="#l7.154"></a><span id="l7.154" class="difflineplus">+  nsAutoString alertBody;</span>
<a href="#l7.155"></a><span id="l7.155" class="difflineplus">+</span>
<a href="#l7.156"></a><span id="l7.156" class="difflineplus">+  PRBool showPreview = PR_TRUE;</span>
<a href="#l7.157"></a><span id="l7.157" class="difflineplus">+  PRBool showSubject = PR_TRUE;</span>
<a href="#l7.158"></a><span id="l7.158" class="difflineplus">+  PRBool showSender = PR_TRUE;</span>
<a href="#l7.159"></a><span id="l7.159" class="difflineplus">+  PRInt32 previewLength = SHOW_ALERT_PREVIEW_LENGTH_DEFAULT;</span>
<a href="#l7.160"></a><span id="l7.160" class="difflineplus">+</span>
<a href="#l7.161"></a><span id="l7.161" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l7.162"></a><span id="l7.162" class="difflineplus">+  if (!prefBranch)</span>
<a href="#l7.163"></a><span id="l7.163" class="difflineplus">+    return PR_FALSE;</span>
<a href="#l7.164"></a><span id="l7.164" class="difflineplus">+</span>
<a href="#l7.165"></a><span id="l7.165" class="difflineplus">+  prefBranch-&gt;GetBoolPref(SHOW_ALERT_PREVIEW, &amp;showPreview);</span>
<a href="#l7.166"></a><span id="l7.166" class="difflineplus">+  prefBranch-&gt;GetBoolPref(SHOW_ALERT_SENDER, &amp;showSender);</span>
<a href="#l7.167"></a><span id="l7.167" class="difflineplus">+  prefBranch-&gt;GetBoolPref(SHOW_ALERT_SUBJECT, &amp;showSubject);</span>
<a href="#l7.168"></a><span id="l7.168" class="difflineplus">+  prefBranch-&gt;GetIntPref(SHOW_ALERT_PREVIEW_LENGTH, &amp;previewLength);</span>
<a href="#l7.169"></a><span id="l7.169" class="difflineplus">+</span>
<a href="#l7.170"></a><span id="l7.170" class="difflineplus">+  nsCOMPtr&lt;nsIMsgHeaderParser&gt; parser = do_GetService(NS_MAILNEWS_MIME_HEADER_PARSER_CONTRACTID);</span>
<a href="#l7.171"></a><span id="l7.171" class="difflineplus">+  if (!parser)</span>
<a href="#l7.172"></a><span id="l7.172" class="difflineplus">+    return PR_FALSE;</span>
<a href="#l7.173"></a><span id="l7.173" class="difflineplus">+</span>
<a href="#l7.174"></a><span id="l7.174" class="difflineplus">+  nsCString utf8previewString;</span>
<a href="#l7.175"></a><span id="l7.175" class="difflineplus">+  if (showPreview &amp;&amp;</span>
<a href="#l7.176"></a><span id="l7.176" class="difflineplus">+      NS_FAILED(aHdr-&gt;GetStringProperty(&quot;preview&quot;, getter_Copies(utf8previewString))))</span>
<a href="#l7.177"></a><span id="l7.177" class="difflineplus">+    return PR_FALSE;</span>
<a href="#l7.178"></a><span id="l7.178" class="difflineplus">+</span>
<a href="#l7.179"></a><span id="l7.179" class="difflineplus">+  // need listener that mailbox is remote such as IMAP</span>
<a href="#l7.180"></a><span id="l7.180" class="difflineplus">+  // to generate preview message</span>
<a href="#l7.181"></a><span id="l7.181" class="difflineplus">+  nsString previewString;</span>
<a href="#l7.182"></a><span id="l7.182" class="difflineplus">+  CopyUTF8toUTF16(utf8previewString, previewString);</span>
<a href="#l7.183"></a><span id="l7.183" class="difflineplus">+</span>
<a href="#l7.184"></a><span id="l7.184" class="difflineplus">+  nsString subject;</span>
<a href="#l7.185"></a><span id="l7.185" class="difflineplus">+  if (showSubject &amp;&amp; NS_FAILED(aHdr-&gt;GetMime2DecodedSubject(subject)))</span>
<a href="#l7.186"></a><span id="l7.186" class="difflineplus">+    return PR_FALSE;</span>
<a href="#l7.187"></a><span id="l7.187" class="difflineplus">+</span>
<a href="#l7.188"></a><span id="l7.188" class="difflineplus">+  nsString author;</span>
<a href="#l7.189"></a><span id="l7.189" class="difflineplus">+  if (showSender)</span>
<a href="#l7.190"></a><span id="l7.190" class="difflineplus">+  {</span>
<a href="#l7.191"></a><span id="l7.191" class="difflineplus">+    if (NS_FAILED(aHdr-&gt;GetMime2DecodedAuthor(author)))</span>
<a href="#l7.192"></a><span id="l7.192" class="difflineplus">+      return PR_FALSE;</span>
<a href="#l7.193"></a><span id="l7.193" class="difflineplus">+</span>
<a href="#l7.194"></a><span id="l7.194" class="difflineplus">+    PRUnichar **emails;</span>
<a href="#l7.195"></a><span id="l7.195" class="difflineplus">+    PRUnichar **names;</span>
<a href="#l7.196"></a><span id="l7.196" class="difflineplus">+    PRUnichar **fullnames;</span>
<a href="#l7.197"></a><span id="l7.197" class="difflineplus">+    PRUint32 num;</span>
<a href="#l7.198"></a><span id="l7.198" class="difflineplus">+    if (NS_FAILED(parser-&gt;ParseHeadersWithArray(author.get(),</span>
<a href="#l7.199"></a><span id="l7.199" class="difflineplus">+            &amp;emails,</span>
<a href="#l7.200"></a><span id="l7.200" class="difflineplus">+            &amp;names,</span>
<a href="#l7.201"></a><span id="l7.201" class="difflineplus">+            &amp;fullnames, &amp;num)))</span>
<a href="#l7.202"></a><span id="l7.202" class="difflineplus">+      return PR_FALSE;</span>
<a href="#l7.203"></a><span id="l7.203" class="difflineplus">+</span>
<a href="#l7.204"></a><span id="l7.204" class="difflineplus">+    author.Assign(names[0] ? names[0] : emails[0]);</span>
<a href="#l7.205"></a><span id="l7.205" class="difflineplus">+</span>
<a href="#l7.206"></a><span id="l7.206" class="difflineplus">+    NS_FREE_XPCOM_ALLOCATED_POINTER_ARRAY(num, emails);</span>
<a href="#l7.207"></a><span id="l7.207" class="difflineplus">+    NS_FREE_XPCOM_ALLOCATED_POINTER_ARRAY(num, names);</span>
<a href="#l7.208"></a><span id="l7.208" class="difflineplus">+    NS_FREE_XPCOM_ALLOCATED_POINTER_ARRAY(num, fullnames);</span>
<a href="#l7.209"></a><span id="l7.209" class="difflineplus">+  }</span>
<a href="#l7.210"></a><span id="l7.210" class="difflineplus">+</span>
<a href="#l7.211"></a><span id="l7.211" class="difflineplus">+  if (showSubject &amp;&amp; showSender)</span>
<a href="#l7.212"></a><span id="l7.212" class="difflineplus">+  {</span>
<a href="#l7.213"></a><span id="l7.213" class="difflineplus">+    nsString msgTitle;</span>
<a href="#l7.214"></a><span id="l7.214" class="difflineplus">+    const PRUnichar *formatStrings[] =</span>
<a href="#l7.215"></a><span id="l7.215" class="difflineplus">+    {</span>
<a href="#l7.216"></a><span id="l7.216" class="difflineplus">+      subject.get(), author.get()</span>
<a href="#l7.217"></a><span id="l7.217" class="difflineplus">+    };</span>
<a href="#l7.218"></a><span id="l7.218" class="difflineplus">+    aBundle-&gt;FormatStringFromName(NS_LITERAL_STRING(&quot;newMailNotification_messagetitle&quot;).get(),</span>
<a href="#l7.219"></a><span id="l7.219" class="difflineplus">+        formatStrings, 2, getter_Copies(msgTitle));</span>
<a href="#l7.220"></a><span id="l7.220" class="difflineplus">+    alertBody.Append(msgTitle);</span>
<a href="#l7.221"></a><span id="l7.221" class="difflineplus">+  }</span>
<a href="#l7.222"></a><span id="l7.222" class="difflineplus">+  else if (showSubject)</span>
<a href="#l7.223"></a><span id="l7.223" class="difflineplus">+    alertBody.Append(subject);</span>
<a href="#l7.224"></a><span id="l7.224" class="difflineplus">+  else if (showSender)</span>
<a href="#l7.225"></a><span id="l7.225" class="difflineplus">+    alertBody.Append(author);</span>
<a href="#l7.226"></a><span id="l7.226" class="difflineplus">+</span>
<a href="#l7.227"></a><span id="l7.227" class="difflineplus">+  if (showPreview &amp;&amp; (showSubject || showSender))</span>
<a href="#l7.228"></a><span id="l7.228" class="difflineplus">+  {</span>
<a href="#l7.229"></a><span id="l7.229" class="difflineplus">+    alertBody.AppendLiteral(&quot;\n&quot;);</span>
<a href="#l7.230"></a><span id="l7.230" class="difflineplus">+  }</span>
<a href="#l7.231"></a><span id="l7.231" class="difflineplus">+</span>
<a href="#l7.232"></a><span id="l7.232" class="difflineplus">+  if (showPreview)</span>
<a href="#l7.233"></a><span id="l7.233" class="difflineplus">+    alertBody.Append(StringHead(previewString, previewLength));</span>
<a href="#l7.234"></a><span id="l7.234" class="difflineplus">+</span>
<a href="#l7.235"></a><span id="l7.235" class="difflineplus">+  if (alertBody.IsEmpty())</span>
<a href="#l7.236"></a><span id="l7.236" class="difflineplus">+    return PR_FALSE;</span>
<a href="#l7.237"></a><span id="l7.237" class="difflineplus">+</span>
<a href="#l7.238"></a><span id="l7.238" class="difflineplus">+  aBody.Assign(alertBody);</span>
<a href="#l7.239"></a><span id="l7.239" class="difflineplus">+  return PR_TRUE;</span>
<a href="#l7.240"></a><span id="l7.240" class="difflineplus">+}</span>
<a href="#l7.241"></a><span id="l7.241" class="difflineplus">+#endif</span>
<a href="#l7.242"></a><span id="l7.242" class="difflineplus">+</span>
<a href="#l7.243"></a><span id="l7.243"> nsresult nsMessengerUnixIntegration::ShowAlertMessage(const nsAString&amp; aAlertTitle, const nsAString&amp; aAlertText, const nsACString&amp; aFolderURI)</span>
<a href="#l7.244"></a><span id="l7.244"> {</span>
<a href="#l7.245"></a><span id="l7.245">   nsresult rv;</span>
<a href="#l7.246"></a><span id="l7.246" class="difflineminus">-  </span>
<a href="#l7.247"></a><span id="l7.247">   // if we are already in the process of showing an alert, don't try to show another....</span>
<a href="#l7.248"></a><span id="l7.248" class="difflineminus">-  if (mAlertInProgress) </span>
<a href="#l7.249"></a><span id="l7.249" class="difflineminus">-    return NS_OK; </span>
<a href="#l7.250"></a><span id="l7.250" class="difflineplus">+  if (mAlertInProgress)</span>
<a href="#l7.251"></a><span id="l7.251" class="difflineplus">+    return NS_OK;</span>
<a href="#l7.252"></a><span id="l7.252"> </span>
<a href="#l7.253"></a><span id="l7.253">   nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l7.254"></a><span id="l7.254">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.255"></a><span id="l7.255" class="difflineminus">-</span>
<a href="#l7.256"></a><span id="l7.256">   PRBool showAlert = PR_TRUE;</span>
<a href="#l7.257"></a><span id="l7.257">   prefBranch-&gt;GetBoolPref(SHOW_ALERT_PREF, &amp;showAlert);</span>
<a href="#l7.258"></a><span id="l7.258" class="difflineminus">-  </span>
<a href="#l7.259"></a><span id="l7.259" class="difflineplus">+</span>
<a href="#l7.260"></a><span id="l7.260">   if (showAlert)</span>
<a href="#l7.261"></a><span id="l7.261">   {</span>
<a href="#l7.262"></a><span id="l7.262" class="difflineplus">+#ifdef MOZ_THUNDERBIRD</span>
<a href="#l7.263"></a><span id="l7.263" class="difflineplus">+    nsCOMPtr&lt;nsIAlertsService&gt; alertsService(do_GetService(NS_SYSTEMALERTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l7.264"></a><span id="l7.264" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l7.265"></a><span id="l7.265" class="difflineplus">+      mAlertInProgress = PR_TRUE;</span>
<a href="#l7.266"></a><span id="l7.266" class="difflineplus">+      rv = alertsService-&gt;ShowAlertNotification(NS_LITERAL_STRING(NEW_MAIL_ALERT_ICON),</span>
<a href="#l7.267"></a><span id="l7.267" class="difflineplus">+                                                aAlertTitle,</span>
<a href="#l7.268"></a><span id="l7.268" class="difflineplus">+                                                aAlertText,</span>
<a href="#l7.269"></a><span id="l7.269" class="difflineplus">+                                                PR_FALSE,</span>
<a href="#l7.270"></a><span id="l7.270" class="difflineplus">+                                                NS_ConvertASCIItoUTF16(aFolderURI),</span>
<a href="#l7.271"></a><span id="l7.271" class="difflineplus">+                                                this,</span>
<a href="#l7.272"></a><span id="l7.272" class="difflineplus">+                                                EmptyString());</span>
<a href="#l7.273"></a><span id="l7.273" class="difflineplus">+      if (NS_SUCCEEDED(rv))</span>
<a href="#l7.274"></a><span id="l7.274" class="difflineplus">+        return rv;</span>
<a href="#l7.275"></a><span id="l7.275" class="difflineplus">+    }</span>
<a href="#l7.276"></a><span id="l7.276" class="difflineplus">+    AlertFinished();</span>
<a href="#l7.277"></a><span id="l7.277" class="difflineplus">+    ShowNewAlertNotification(PR_FALSE);</span>
<a href="#l7.278"></a><span id="l7.278" class="difflineplus">+</span>
<a href="#l7.279"></a><span id="l7.279" class="difflineplus">+#else</span>
<a href="#l7.280"></a><span id="l7.280">     nsCOMPtr&lt;nsIAlertsService&gt; alertsService (do_GetService(NS_ALERTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l7.281"></a><span id="l7.281">     if (NS_SUCCEEDED(rv))</span>
<a href="#l7.282"></a><span id="l7.282">     {</span>
<a href="#l7.283"></a><span id="l7.283">       rv = alertsService-&gt;ShowAlertNotification(NS_LITERAL_STRING(NEW_MAIL_ALERT_ICON), aAlertTitle,</span>
<a href="#l7.284"></a><span id="l7.284" class="difflineminus">-                                                aAlertText, PR_TRUE, </span>
<a href="#l7.285"></a><span id="l7.285" class="difflineplus">+                                                aAlertText, PR_TRUE,</span>
<a href="#l7.286"></a><span id="l7.286">                                                 NS_ConvertASCIItoUTF16(aFolderURI), this,</span>
<a href="#l7.287"></a><span id="l7.287" class="difflineminus">-                                                EmptyString()); </span>
<a href="#l7.288"></a><span id="l7.288" class="difflineplus">+                                                EmptyString());</span>
<a href="#l7.289"></a><span id="l7.289">       mAlertInProgress = PR_TRUE;</span>
<a href="#l7.290"></a><span id="l7.290">     }</span>
<a href="#l7.291"></a><span id="l7.291" class="difflineplus">+#endif</span>
<a href="#l7.292"></a><span id="l7.292">   }</span>
<a href="#l7.293"></a><span id="l7.293"> </span>
<a href="#l7.294"></a><span id="l7.294">   if (!showAlert || NS_FAILED(rv)) // go straight to showing the system tray icon.</span>
<a href="#l7.295"></a><span id="l7.295">     AlertFinished();</span>
<a href="#l7.296"></a><span id="l7.296"> </span>
<a href="#l7.297"></a><span id="l7.297">   return rv;</span>
<a href="#l7.298"></a><span id="l7.298"> }</span>
<a href="#l7.299"></a><span id="l7.299"> </span>
<a href="#l7.300"></a><span id="l7.300" class="difflineplus">+#ifdef MOZ_THUNDERBIRD</span>
<a href="#l7.301"></a><span id="l7.301" class="difflineplus">+// Opening Thunderbird's new mail alert notification window for not supporting libnotify</span>
<a href="#l7.302"></a><span id="l7.302" class="difflineplus">+// aUserInitiated --&gt; true if we are opening the alert notification in response to a user action</span>
<a href="#l7.303"></a><span id="l7.303" class="difflineplus">+//                    like clicking on the biff icon</span>
<a href="#l7.304"></a><span id="l7.304" class="difflineplus">+nsresult nsMessengerUnixIntegration::ShowNewAlertNotification(PRBool aUserInitiated)</span>
<a href="#l7.305"></a><span id="l7.305" class="difflineplus">+{</span>
<a href="#l7.306"></a><span id="l7.306" class="difflineplus">+</span>
<a href="#l7.307"></a><span id="l7.307" class="difflineplus">+  nsresult rv;</span>
<a href="#l7.308"></a><span id="l7.308" class="difflineplus">+</span>
<a href="#l7.309"></a><span id="l7.309" class="difflineplus">+  // if we are already in the process of showing an alert, don't try to show another....</span>
<a href="#l7.310"></a><span id="l7.310" class="difflineplus">+  if (mAlertInProgress)</span>
<a href="#l7.311"></a><span id="l7.311" class="difflineplus">+    return NS_OK;</span>
<a href="#l7.312"></a><span id="l7.312" class="difflineplus">+</span>
<a href="#l7.313"></a><span id="l7.313" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l7.314"></a><span id="l7.314" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.315"></a><span id="l7.315" class="difflineplus">+</span>
<a href="#l7.316"></a><span id="l7.316" class="difflineplus">+  PRBool showAlert = PR_TRUE;</span>
<a href="#l7.317"></a><span id="l7.317" class="difflineplus">+  prefBranch-&gt;GetBoolPref(SHOW_ALERT_PREF, &amp;showAlert);</span>
<a href="#l7.318"></a><span id="l7.318" class="difflineplus">+</span>
<a href="#l7.319"></a><span id="l7.319" class="difflineplus">+  if (showAlert)</span>
<a href="#l7.320"></a><span id="l7.320" class="difflineplus">+  {</span>
<a href="#l7.321"></a><span id="l7.321" class="difflineplus">+    nsCOMPtr&lt;nsIMutableArray&gt; argsArray = do_CreateInstance(NS_ARRAY_CONTRACTID);</span>
<a href="#l7.322"></a><span id="l7.322" class="difflineplus">+    if (!argsArray)</span>
<a href="#l7.323"></a><span id="l7.323" class="difflineplus">+      return NS_ERROR_FAILURE;</span>
<a href="#l7.324"></a><span id="l7.324" class="difflineplus">+</span>
<a href="#l7.325"></a><span id="l7.325" class="difflineplus">+    // pass in the array of folders with unread messages</span>
<a href="#l7.326"></a><span id="l7.326" class="difflineplus">+    nsCOMPtr&lt;nsISupportsInterfacePointer&gt; ifptr = do_CreateInstance(NS_SUPPORTS_INTERFACE_POINTER_CONTRACTID, &amp;rv);</span>
<a href="#l7.327"></a><span id="l7.327" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.328"></a><span id="l7.328" class="difflineplus">+    ifptr-&gt;SetData(mFoldersWithNewMail);</span>
<a href="#l7.329"></a><span id="l7.329" class="difflineplus">+    ifptr-&gt;SetDataIID(&amp;NS_GET_IID(nsISupportsArray));</span>
<a href="#l7.330"></a><span id="l7.330" class="difflineplus">+    argsArray-&gt;AppendElement(ifptr, PR_FALSE);</span>
<a href="#l7.331"></a><span id="l7.331" class="difflineplus">+</span>
<a href="#l7.332"></a><span id="l7.332" class="difflineplus">+    // pass in the observer</span>
<a href="#l7.333"></a><span id="l7.333" class="difflineplus">+    ifptr = do_CreateInstance(NS_SUPPORTS_INTERFACE_POINTER_CONTRACTID, &amp;rv);</span>
<a href="#l7.334"></a><span id="l7.334" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.335"></a><span id="l7.335" class="difflineplus">+    nsCOMPtr &lt;nsISupports&gt; supports = do_QueryInterface(static_cast&lt;nsIMessengerOSIntegration*&gt;(this));</span>
<a href="#l7.336"></a><span id="l7.336" class="difflineplus">+    ifptr-&gt;SetData(supports);</span>
<a href="#l7.337"></a><span id="l7.337" class="difflineplus">+    ifptr-&gt;SetDataIID(&amp;NS_GET_IID(nsIObserver));</span>
<a href="#l7.338"></a><span id="l7.338" class="difflineplus">+    argsArray-&gt;AppendElement(ifptr, PR_FALSE);</span>
<a href="#l7.339"></a><span id="l7.339" class="difflineplus">+</span>
<a href="#l7.340"></a><span id="l7.340" class="difflineplus">+    // pass in the animation flag</span>
<a href="#l7.341"></a><span id="l7.341" class="difflineplus">+    nsCOMPtr&lt;nsISupportsPRBool&gt; scriptableUserInitiated (do_CreateInstance(NS_SUPPORTS_PRBOOL_CONTRACTID, &amp;rv));</span>
<a href="#l7.342"></a><span id="l7.342" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.343"></a><span id="l7.343" class="difflineplus">+    scriptableUserInitiated-&gt;SetData(aUserInitiated);</span>
<a href="#l7.344"></a><span id="l7.344" class="difflineplus">+    argsArray-&gt;AppendElement(scriptableUserInitiated, PR_FALSE);</span>
<a href="#l7.345"></a><span id="l7.345" class="difflineplus">+</span>
<a href="#l7.346"></a><span id="l7.346" class="difflineplus">+    nsCOMPtr&lt;nsIWindowWatcher&gt; wwatch(do_GetService(NS_WINDOWWATCHER_CONTRACTID));</span>
<a href="#l7.347"></a><span id="l7.347" class="difflineplus">+    nsCOMPtr&lt;nsIDOMWindow&gt; newWindow;</span>
<a href="#l7.348"></a><span id="l7.348" class="difflineplus">+</span>
<a href="#l7.349"></a><span id="l7.349" class="difflineplus">+    rv = wwatch-&gt;OpenWindow(0, ALERT_CHROME_URL, &quot;_blank&quot;,</span>
<a href="#l7.350"></a><span id="l7.350" class="difflineplus">+                            &quot;chrome,dialog=yes,titlebar=no,popup=yes&quot;, argsArray,</span>
<a href="#l7.351"></a><span id="l7.351" class="difflineplus">+                            getter_AddRefs(newWindow));</span>
<a href="#l7.352"></a><span id="l7.352" class="difflineplus">+</span>
<a href="#l7.353"></a><span id="l7.353" class="difflineplus">+    mAlertInProgress = PR_TRUE;</span>
<a href="#l7.354"></a><span id="l7.354" class="difflineplus">+  }</span>
<a href="#l7.355"></a><span id="l7.355" class="difflineplus">+</span>
<a href="#l7.356"></a><span id="l7.356" class="difflineplus">+  // if the user has turned off the mail alert, or openWindow generated an error,</span>
<a href="#l7.357"></a><span id="l7.357" class="difflineplus">+  // then go straight to the system tray.</span>
<a href="#l7.358"></a><span id="l7.358" class="difflineplus">+  if (!showAlert || NS_FAILED(rv))</span>
<a href="#l7.359"></a><span id="l7.359" class="difflineplus">+    AlertFinished();</span>
<a href="#l7.360"></a><span id="l7.360" class="difflineplus">+</span>
<a href="#l7.361"></a><span id="l7.361" class="difflineplus">+  return rv;</span>
<a href="#l7.362"></a><span id="l7.362" class="difflineplus">+}</span>
<a href="#l7.363"></a><span id="l7.363" class="difflineplus">+#endif</span>
<a href="#l7.364"></a><span id="l7.364" class="difflineplus">+</span>
<a href="#l7.365"></a><span id="l7.365"> nsresult nsMessengerUnixIntegration::AlertFinished()</span>
<a href="#l7.366"></a><span id="l7.366"> {</span>
<a href="#l7.367"></a><span id="l7.367">   mAlertInProgress = PR_FALSE;</span>
<a href="#l7.368"></a><span id="l7.368">   return NS_OK;</span>
<a href="#l7.369"></a><span id="l7.369"> }</span>
<a href="#l7.370"></a><span id="l7.370"> </span>
<a href="#l7.371"></a><span id="l7.371"> nsresult nsMessengerUnixIntegration::AlertClicked()</span>
<a href="#l7.372"></a><span id="l7.372"> {</span>
<a href="#l7.373"></a><span id="l7.373" class="difflineat">@@ -213,115 +455,249 @@ nsresult nsMessengerUnixIntegration::Ale</span>
<a href="#l7.374"></a><span id="l7.374">   return NS_OK;</span>
<a href="#l7.375"></a><span id="l7.375"> }</span>
<a href="#l7.376"></a><span id="l7.376"> </span>
<a href="#l7.377"></a><span id="l7.377"> NS_IMETHODIMP</span>
<a href="#l7.378"></a><span id="l7.378"> nsMessengerUnixIntegration::Observe(nsISupports* aSubject, const char* aTopic, const PRUnichar* aData)</span>
<a href="#l7.379"></a><span id="l7.379"> {</span>
<a href="#l7.380"></a><span id="l7.380">   if (strcmp(aTopic, &quot;alertfinished&quot;) == 0)</span>
<a href="#l7.381"></a><span id="l7.381">     return AlertFinished();</span>
<a href="#l7.382"></a><span id="l7.382" class="difflineminus">-</span>
<a href="#l7.383"></a><span id="l7.383">   if (strcmp(aTopic, &quot;alertclickcallback&quot;) == 0)</span>
<a href="#l7.384"></a><span id="l7.384">     return AlertClicked();</span>
<a href="#l7.385"></a><span id="l7.385"> </span>
<a href="#l7.386"></a><span id="l7.386">   return NS_OK;</span>
<a href="#l7.387"></a><span id="l7.387"> }</span>
<a href="#l7.388"></a><span id="l7.388"> </span>
<a href="#l7.389"></a><span id="l7.389"> void nsMessengerUnixIntegration::FillToolTipInfo()</span>
<a href="#l7.390"></a><span id="l7.390"> {</span>
<a href="#l7.391"></a><span id="l7.391" class="difflineminus">-  nsCOMPtr&lt;nsIWeakReference&gt; weakReference = do_QueryElementAt(mFoldersWithNewMail, 0);</span>
<a href="#l7.392"></a><span id="l7.392" class="difflineminus">-  nsCOMPtr&lt;nsIMsgFolder&gt; folder = do_QueryReferent(weakReference);</span>
<a href="#l7.393"></a><span id="l7.393" class="difflineminus">-  if (folder)</span>
<a href="#l7.394"></a><span id="l7.394" class="difflineplus">+  nsresult rv;</span>
<a href="#l7.395"></a><span id="l7.395" class="difflineplus">+  nsCString folderUri;</span>
<a href="#l7.396"></a><span id="l7.396" class="difflineplus">+  GetFirstFolderWithNewMail(folderUri);</span>
<a href="#l7.397"></a><span id="l7.397" class="difflineplus">+</span>
<a href="#l7.398"></a><span id="l7.398" class="difflineplus">+  PRUint32 count = 0;</span>
<a href="#l7.399"></a><span id="l7.399" class="difflineplus">+  if (NS_FAILED(mFoldersWithNewMail-&gt;Count(&amp;count)))</span>
<a href="#l7.400"></a><span id="l7.400" class="difflineplus">+    return;</span>
<a href="#l7.401"></a><span id="l7.401" class="difflineplus">+</span>
<a href="#l7.402"></a><span id="l7.402" class="difflineplus">+  nsCOMPtr&lt;nsIWeakReference&gt; weakReference;</span>
<a href="#l7.403"></a><span id="l7.403" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; folder = nsnull;</span>
<a href="#l7.404"></a><span id="l7.404" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; folderWithNewMail = nsnull;</span>
<a href="#l7.405"></a><span id="l7.405" class="difflineplus">+</span>
<a href="#l7.406"></a><span id="l7.406" class="difflineplus">+  PRUint32 i;</span>
<a href="#l7.407"></a><span id="l7.407" class="difflineplus">+  for (i = 0; i &lt; count &amp;&amp; !folderWithNewMail; i++)</span>
<a href="#l7.408"></a><span id="l7.408" class="difflineplus">+  {</span>
<a href="#l7.409"></a><span id="l7.409" class="difflineplus">+    weakReference = do_QueryElementAt(mFoldersWithNewMail, i);</span>
<a href="#l7.410"></a><span id="l7.410" class="difflineplus">+    folder = do_QueryReferent(weakReference);</span>
<a href="#l7.411"></a><span id="l7.411" class="difflineplus">+    folder-&gt;GetChildWithURI(folderUri, PR_TRUE, PR_TRUE,</span>
<a href="#l7.412"></a><span id="l7.412" class="difflineplus">+                            getter_AddRefs(folderWithNewMail));</span>
<a href="#l7.413"></a><span id="l7.413" class="difflineplus">+  }</span>
<a href="#l7.414"></a><span id="l7.414" class="difflineplus">+</span>
<a href="#l7.415"></a><span id="l7.415" class="difflineplus">+  if (folder &amp;&amp; folderWithNewMail)</span>
<a href="#l7.416"></a><span id="l7.416">   {</span>
<a href="#l7.417"></a><span id="l7.417" class="difflineplus">+#ifdef MOZ_THUNDERBIRD</span>
<a href="#l7.418"></a><span id="l7.418" class="difflineplus">+    nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l7.419"></a><span id="l7.419" class="difflineplus">+    GetStringBundle(getter_AddRefs(bundle));</span>
<a href="#l7.420"></a><span id="l7.420" class="difflineplus">+</span>
<a href="#l7.421"></a><span id="l7.421" class="difflineplus">+    if (!bundle)</span>
<a href="#l7.422"></a><span id="l7.422" class="difflineplus">+      return;</span>
<a href="#l7.423"></a><span id="l7.423" class="difflineplus">+</span>
<a href="#l7.424"></a><span id="l7.424" class="difflineplus">+    // Create the notification title</span>
<a href="#l7.425"></a><span id="l7.425" class="difflineplus">+    nsString alertTitle;</span>
<a href="#l7.426"></a><span id="l7.426" class="difflineplus">+    if (NS_FAILED(BuildNotificationTitle(folder, bundle, alertTitle)))</span>
<a href="#l7.427"></a><span id="l7.427" class="difflineplus">+      return;</span>
<a href="#l7.428"></a><span id="l7.428" class="difflineplus">+</span>
<a href="#l7.429"></a><span id="l7.429" class="difflineplus">+    // Let's get the new mail for this folder</span>
<a href="#l7.430"></a><span id="l7.430" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l7.431"></a><span id="l7.431" class="difflineplus">+    if (NS_FAILED(folderWithNewMail-&gt;GetMsgDatabase(getter_AddRefs(db))))</span>
<a href="#l7.432"></a><span id="l7.432" class="difflineplus">+      return;</span>
<a href="#l7.433"></a><span id="l7.433" class="difflineplus">+</span>
<a href="#l7.434"></a><span id="l7.434" class="difflineplus">+    PRUint32 numNewKeys = 0;</span>
<a href="#l7.435"></a><span id="l7.435" class="difflineplus">+    PRUint32 *newMessageKeys;</span>
<a href="#l7.436"></a><span id="l7.436" class="difflineplus">+    db-&gt;GetNewList(&amp;numNewKeys, &amp;newMessageKeys);</span>
<a href="#l7.437"></a><span id="l7.437" class="difflineplus">+</span>
<a href="#l7.438"></a><span id="l7.438" class="difflineplus">+    // If we had new messages, we *should* have new keys, but we'll</span>
<a href="#l7.439"></a><span id="l7.439" class="difflineplus">+    // check just in case.</span>
<a href="#l7.440"></a><span id="l7.440" class="difflineplus">+    if (numNewKeys &lt;= 0) {</span>
<a href="#l7.441"></a><span id="l7.441" class="difflineplus">+      NS_Free(newMessageKeys);</span>
<a href="#l7.442"></a><span id="l7.442" class="difflineplus">+      return;</span>
<a href="#l7.443"></a><span id="l7.443" class="difflineplus">+    }</span>
<a href="#l7.444"></a><span id="l7.444" class="difflineplus">+</span>
<a href="#l7.445"></a><span id="l7.445" class="difflineplus">+    // Find the rootFolder that folder belongs to, and find out</span>
<a href="#l7.446"></a><span id="l7.446" class="difflineplus">+    // what MRUTime it maps to.  Assign this to lastMRUTime.</span>
<a href="#l7.447"></a><span id="l7.447" class="difflineplus">+    PRUint32 lastMRUTime = 0;</span>
<a href="#l7.448"></a><span id="l7.448" class="difflineplus">+    if (NS_FAILED(GetMRUTimestampForFolder(folder, &amp;lastMRUTime)))</span>
<a href="#l7.449"></a><span id="l7.449" class="difflineplus">+      lastMRUTime = 0;</span>
<a href="#l7.450"></a><span id="l7.450" class="difflineplus">+</span>
<a href="#l7.451"></a><span id="l7.451" class="difflineplus">+    // Next, add the new message headers to an nsCOMArray.  We</span>
<a href="#l7.452"></a><span id="l7.452" class="difflineplus">+    // only add message headers that are newer than lastMRUTime.</span>
<a href="#l7.453"></a><span id="l7.453" class="difflineplus">+    nsCOMArray&lt;nsIMsgDBHdr&gt; newMsgHdrs;</span>
<a href="#l7.454"></a><span id="l7.454" class="difflineplus">+    for (int i = 0; i &lt; numNewKeys; ++i) {</span>
<a href="#l7.455"></a><span id="l7.455" class="difflineplus">+      nsCOMPtr&lt;nsIMsgDBHdr&gt; hdr;</span>
<a href="#l7.456"></a><span id="l7.456" class="difflineplus">+      if (NS_FAILED(db-&gt;GetMsgHdrForKey(newMessageKeys[i], getter_AddRefs(hdr))))</span>
<a href="#l7.457"></a><span id="l7.457" class="difflineplus">+        continue;</span>
<a href="#l7.458"></a><span id="l7.458" class="difflineplus">+</span>
<a href="#l7.459"></a><span id="l7.459" class="difflineplus">+      PRUint32 dateInSeconds = 0;</span>
<a href="#l7.460"></a><span id="l7.460" class="difflineplus">+      hdr-&gt;GetDateInSeconds(&amp;dateInSeconds);</span>
<a href="#l7.461"></a><span id="l7.461" class="difflineplus">+</span>
<a href="#l7.462"></a><span id="l7.462" class="difflineplus">+      if (dateInSeconds &gt; lastMRUTime)</span>
<a href="#l7.463"></a><span id="l7.463" class="difflineplus">+        newMsgHdrs.AppendObject(hdr);</span>
<a href="#l7.464"></a><span id="l7.464" class="difflineplus">+    }</span>
<a href="#l7.465"></a><span id="l7.465" class="difflineplus">+</span>
<a href="#l7.466"></a><span id="l7.466" class="difflineplus">+    // If we didn't happen to add any message headers, free</span>
<a href="#l7.467"></a><span id="l7.467" class="difflineplus">+    // up newMessageKeys and bail out.</span>
<a href="#l7.468"></a><span id="l7.468" class="difflineplus">+    if (!newMsgHdrs.Count())</span>
<a href="#l7.469"></a><span id="l7.469" class="difflineplus">+    {</span>
<a href="#l7.470"></a><span id="l7.470" class="difflineplus">+      NS_Free(newMessageKeys);</span>
<a href="#l7.471"></a><span id="l7.471" class="difflineplus">+      return;</span>
<a href="#l7.472"></a><span id="l7.472" class="difflineplus">+    }</span>
<a href="#l7.473"></a><span id="l7.473" class="difflineplus">+</span>
<a href="#l7.474"></a><span id="l7.474" class="difflineplus">+    // Sort the message headers by dateInSeconds, in ascending</span>
<a href="#l7.475"></a><span id="l7.475" class="difflineplus">+    // order</span>
<a href="#l7.476"></a><span id="l7.476" class="difflineplus">+    newMsgHdrs.Sort(nsMsgDbHdrTimestampComparator, nsnull);</span>
<a href="#l7.477"></a><span id="l7.477" class="difflineplus">+</span>
<a href="#l7.478"></a><span id="l7.478" class="difflineplus">+    PRBool asyncResult = PR_FALSE;</span>
<a href="#l7.479"></a><span id="l7.479" class="difflineplus">+    rv = folderWithNewMail-&gt;FetchMsgPreviewText(newMessageKeys,</span>
<a href="#l7.480"></a><span id="l7.480" class="difflineplus">+                                                numNewKeys,</span>
<a href="#l7.481"></a><span id="l7.481" class="difflineplus">+                                                PR_FALSE, this,</span>
<a href="#l7.482"></a><span id="l7.482" class="difflineplus">+                                                &amp;asyncResult);</span>
<a href="#l7.483"></a><span id="l7.483" class="difflineplus">+</span>
<a href="#l7.484"></a><span id="l7.484" class="difflineplus">+    // At this point, we don't need newMessageKeys any more,</span>
<a href="#l7.485"></a><span id="l7.485" class="difflineplus">+    // so let's free it.</span>
<a href="#l7.486"></a><span id="l7.486" class="difflineplus">+    NS_Free(newMessageKeys);</span>
<a href="#l7.487"></a><span id="l7.487" class="difflineplus">+</span>
<a href="#l7.488"></a><span id="l7.488" class="difflineplus">+    // If we're still waiting on getting the message previews,</span>
<a href="#l7.489"></a><span id="l7.489" class="difflineplus">+    // bail early.  We'll come back later when the async operation</span>
<a href="#l7.490"></a><span id="l7.490" class="difflineplus">+    // finishes.</span>
<a href="#l7.491"></a><span id="l7.491" class="difflineplus">+    if (NS_FAILED(rv) || asyncResult)</span>
<a href="#l7.492"></a><span id="l7.492" class="difflineplus">+      return;</span>
<a href="#l7.493"></a><span id="l7.493" class="difflineplus">+</span>
<a href="#l7.494"></a><span id="l7.494" class="difflineplus">+    nsString alertBody;</span>
<a href="#l7.495"></a><span id="l7.495" class="difflineplus">+</span>
<a href="#l7.496"></a><span id="l7.496" class="difflineplus">+    // Build the body text of the notification.</span>
<a href="#l7.497"></a><span id="l7.497" class="difflineplus">+    if (NS_FAILED(BuildNotificationBody(newMsgHdrs[0], bundle, alertBody)))</span>
<a href="#l7.498"></a><span id="l7.498" class="difflineplus">+      return;</span>
<a href="#l7.499"></a><span id="l7.499" class="difflineplus">+</span>
<a href="#l7.500"></a><span id="l7.500" class="difflineplus">+    // Show the notification</span>
<a href="#l7.501"></a><span id="l7.501" class="difflineplus">+    ShowAlertMessage(alertTitle, alertBody, EmptyCString());</span>
<a href="#l7.502"></a><span id="l7.502" class="difflineplus">+</span>
<a href="#l7.503"></a><span id="l7.503" class="difflineplus">+    // Find the last, and therefore newest message header</span>
<a href="#l7.504"></a><span id="l7.504" class="difflineplus">+    // in our nsCOMArray</span>
<a href="#l7.505"></a><span id="l7.505" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDBHdr&gt; lastMsgHdr = newMsgHdrs[newMsgHdrs.Count() - 1];</span>
<a href="#l7.506"></a><span id="l7.506" class="difflineplus">+</span>
<a href="#l7.507"></a><span id="l7.507" class="difflineplus">+    PRUint32 dateInSeconds = 0;</span>
<a href="#l7.508"></a><span id="l7.508" class="difflineplus">+    if (NS_FAILED(lastMsgHdr-&gt;GetDateInSeconds(&amp;dateInSeconds)))</span>
<a href="#l7.509"></a><span id="l7.509" class="difflineplus">+      return;</span>
<a href="#l7.510"></a><span id="l7.510" class="difflineplus">+</span>
<a href="#l7.511"></a><span id="l7.511" class="difflineplus">+    // Write the newest message timestamp to the appropriate</span>
<a href="#l7.512"></a><span id="l7.512" class="difflineplus">+    // mapping in our hashtable of MRUTime's.</span>
<a href="#l7.513"></a><span id="l7.513" class="difflineplus">+    PutMRUTimestampForFolder(folder, dateInSeconds);</span>
<a href="#l7.514"></a><span id="l7.514" class="difflineplus">+#else</span>
<a href="#l7.515"></a><span id="l7.515">     nsString accountName;</span>
<a href="#l7.516"></a><span id="l7.516">     folder-&gt;GetPrettiestName(accountName);</span>
<a href="#l7.517"></a><span id="l7.517"> </span>
<a href="#l7.518"></a><span id="l7.518" class="difflineminus">-    nsCOMPtr&lt;nsIStringBundle&gt; bundle; </span>
<a href="#l7.519"></a><span id="l7.519" class="difflineplus">+    nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l7.520"></a><span id="l7.520">     GetStringBundle(getter_AddRefs(bundle));</span>
<a href="#l7.521"></a><span id="l7.521">     if (bundle)</span>
<a href="#l7.522"></a><span id="l7.522" class="difflineminus">-    { </span>
<a href="#l7.523"></a><span id="l7.523" class="difflineminus">-      PRInt32 numNewMessages = 0;   </span>
<a href="#l7.524"></a><span id="l7.524" class="difflineplus">+    {</span>
<a href="#l7.525"></a><span id="l7.525" class="difflineplus">+      PRInt32 numNewMessages = 0;</span>
<a href="#l7.526"></a><span id="l7.526">       folder-&gt;GetNumNewMessages(PR_TRUE, &amp;numNewMessages);</span>
<a href="#l7.527"></a><span id="l7.527" class="difflineminus">-      nsAutoString numNewMsgsText;     </span>
<a href="#l7.528"></a><span id="l7.528" class="difflineplus">+      nsAutoString numNewMsgsText;</span>
<a href="#l7.529"></a><span id="l7.529">       numNewMsgsText.AppendInt(numNewMessages);</span>
<a href="#l7.530"></a><span id="l7.530"> </span>
<a href="#l7.531"></a><span id="l7.531">       const PRUnichar *formatStrings[] =</span>
<a href="#l7.532"></a><span id="l7.532">       {</span>
<a href="#l7.533"></a><span id="l7.533" class="difflineminus">-        numNewMsgsText.get(),       </span>
<a href="#l7.534"></a><span id="l7.534" class="difflineplus">+        numNewMsgsText.get(),</span>
<a href="#l7.535"></a><span id="l7.535">       };</span>
<a href="#l7.536"></a><span id="l7.536" class="difflineminus">-     </span>
<a href="#l7.537"></a><span id="l7.537" class="difflineminus">-      nsString finalText; </span>
<a href="#l7.538"></a><span id="l7.538" class="difflineplus">+</span>
<a href="#l7.539"></a><span id="l7.539" class="difflineplus">+      nsString finalText;</span>
<a href="#l7.540"></a><span id="l7.540">       if (numNewMessages == 1)</span>
<a href="#l7.541"></a><span id="l7.541">         bundle-&gt;FormatStringFromName(NS_LITERAL_STRING(&quot;biffNotification_message&quot;).get(), formatStrings, 1, getter_Copies(finalText));</span>
<a href="#l7.542"></a><span id="l7.542">       else</span>
<a href="#l7.543"></a><span id="l7.543">         bundle-&gt;FormatStringFromName(NS_LITERAL_STRING(&quot;biffNotification_messages&quot;).get(), formatStrings, 1, getter_Copies(finalText));</span>
<a href="#l7.544"></a><span id="l7.544"> </span>
<a href="#l7.545"></a><span id="l7.545">       ShowAlertMessage(accountName, finalText, EmptyCString());</span>
<a href="#l7.546"></a><span id="l7.546">     } // if we got a bundle</span>
<a href="#l7.547"></a><span id="l7.547" class="difflineplus">+#endif</span>
<a href="#l7.548"></a><span id="l7.548">   } // if we got a folder</span>
<a href="#l7.549"></a><span id="l7.549"> }</span>
<a href="#l7.550"></a><span id="l7.550"> </span>
<a href="#l7.551"></a><span id="l7.551"> // get the first top level folder which we know has new mail, then enumerate over all the subfolders</span>
<a href="#l7.552"></a><span id="l7.552"> // looking for the first real folder with new mail. Return the folderURI for that folder.</span>
<a href="#l7.553"></a><span id="l7.553"> nsresult nsMessengerUnixIntegration::GetFirstFolderWithNewMail(nsACString&amp; aFolderURI)</span>
<a href="#l7.554"></a><span id="l7.554"> {</span>
<a href="#l7.555"></a><span id="l7.555">   nsresult rv;</span>
<a href="#l7.556"></a><span id="l7.556" class="difflineminus">-  NS_ENSURE_TRUE(mFoldersWithNewMail, NS_ERROR_FAILURE); </span>
<a href="#l7.557"></a><span id="l7.557" class="difflineplus">+  NS_ENSURE_TRUE(mFoldersWithNewMail, NS_ERROR_FAILURE);</span>
<a href="#l7.558"></a><span id="l7.558"> </span>
<a href="#l7.559"></a><span id="l7.559">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l7.560"></a><span id="l7.560">   nsCOMPtr&lt;nsIWeakReference&gt; weakReference;</span>
<a href="#l7.561"></a><span id="l7.561" class="difflineminus">-  PRInt32 numNewMessages = 0;</span>
<a href="#l7.562"></a><span id="l7.562"> </span>
<a href="#l7.563"></a><span id="l7.563">   PRUint32 count = 0;</span>
<a href="#l7.564"></a><span id="l7.564">   mFoldersWithNewMail-&gt;Count(&amp;count);</span>
<a href="#l7.565"></a><span id="l7.565"> </span>
<a href="#l7.566"></a><span id="l7.566">   if (!count)  // kick out if we don't have any folders with new mail</span>
<a href="#l7.567"></a><span id="l7.567">     return NS_OK;</span>
<a href="#l7.568"></a><span id="l7.568"> </span>
<a href="#l7.569"></a><span id="l7.569" class="difflineminus">-  weakReference = do_QueryElementAt(mFoldersWithNewMail, 0);</span>
<a href="#l7.570"></a><span id="l7.570" class="difflineminus">-  folder = do_QueryReferent(weakReference);</span>
<a href="#l7.571"></a><span id="l7.571" class="difflineminus">-  </span>
<a href="#l7.572"></a><span id="l7.572" class="difflineminus">-  if (folder)</span>
<a href="#l7.573"></a><span id="l7.573" class="difflineplus">+  PRUint32 i;</span>
<a href="#l7.574"></a><span id="l7.574" class="difflineplus">+  for(i = 0; i &lt; count; i++)</span>
<a href="#l7.575"></a><span id="l7.575">   {</span>
<a href="#l7.576"></a><span id="l7.576" class="difflineplus">+    weakReference = do_QueryElementAt(mFoldersWithNewMail, i);</span>
<a href="#l7.577"></a><span id="l7.577" class="difflineplus">+    folder = do_QueryReferent(weakReference);</span>
<a href="#l7.578"></a><span id="l7.578" class="difflineplus">+</span>
<a href="#l7.579"></a><span id="l7.579" class="difflineplus">+    // We only want to find folders which haven't been notified</span>
<a href="#l7.580"></a><span id="l7.580" class="difflineplus">+    // yet.  This is specific to Thunderbird.  In Seamonkey, we</span>
<a href="#l7.581"></a><span id="l7.581" class="difflineplus">+    // just return 0, and we don't care about timestamps anymore.</span>
<a href="#l7.582"></a><span id="l7.582" class="difflineplus">+    PRUint32 lastMRUTime = 0;</span>
<a href="#l7.583"></a><span id="l7.583" class="difflineplus">+    rv = GetMRUTimestampForFolder(folder, &amp;lastMRUTime);</span>
<a href="#l7.584"></a><span id="l7.584" class="difflineplus">+    if (NS_FAILED(rv))</span>
<a href="#l7.585"></a><span id="l7.585" class="difflineplus">+      lastMRUTime = 0;</span>
<a href="#l7.586"></a><span id="l7.586" class="difflineplus">+</span>
<a href="#l7.587"></a><span id="l7.587" class="difflineplus">+    if (!folder)</span>
<a href="#l7.588"></a><span id="l7.588" class="difflineplus">+      continue;</span>
<a href="#l7.589"></a><span id="l7.589" class="difflineplus">+    // enumerate over the folders under this root folder till we find one with new mail....</span>
<a href="#l7.590"></a><span id="l7.590">     nsCOMPtr&lt;nsIMsgFolder&gt; msgFolder;</span>
<a href="#l7.591"></a><span id="l7.591" class="difflineminus">-    // enumerate over the folders under this root folder till we find one with new mail....</span>
<a href="#l7.592"></a><span id="l7.592">     nsCOMPtr&lt;nsISupportsArray&gt; allFolders;</span>
<a href="#l7.593"></a><span id="l7.593">     NS_NewISupportsArray(getter_AddRefs(allFolders));</span>
<a href="#l7.594"></a><span id="l7.594">     rv = folder-&gt;ListDescendents(allFolders);</span>
<a href="#l7.595"></a><span id="l7.595">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.596"></a><span id="l7.596"> </span>
<a href="#l7.597"></a><span id="l7.597" class="difflineminus">-    nsCOMPtr&lt;nsIEnumerator&gt; enumerator;</span>
<a href="#l7.598"></a><span id="l7.598" class="difflineminus">-    allFolders-&gt;Enumerate(getter_AddRefs(enumerator));</span>
<a href="#l7.599"></a><span id="l7.599" class="difflineminus">-    if (enumerator)</span>
<a href="#l7.600"></a><span id="l7.600" class="difflineplus">+    PRUint32 subfolderCount = 0;</span>
<a href="#l7.601"></a><span id="l7.601" class="difflineplus">+    allFolders-&gt;Count(&amp;subfolderCount);</span>
<a href="#l7.602"></a><span id="l7.602" class="difflineplus">+    PRUint32 j;</span>
<a href="#l7.603"></a><span id="l7.603" class="difflineplus">+    for (j = 0; j &lt; subfolderCount; j++)</span>
<a href="#l7.604"></a><span id="l7.604">     {</span>
<a href="#l7.605"></a><span id="l7.605" class="difflineminus">-      nsCOMPtr&lt;nsISupports&gt; supports;</span>
<a href="#l7.606"></a><span id="l7.606" class="difflineminus">-      nsresult more = enumerator-&gt;First();</span>
<a href="#l7.607"></a><span id="l7.607" class="difflineminus">-      while (NS_SUCCEEDED(more))</span>
<a href="#l7.608"></a><span id="l7.608" class="difflineplus">+      nsCOMPtr&lt;nsIMsgFolder&gt; msgFolder = do_QueryElementAt(allFolders, j);</span>
<a href="#l7.609"></a><span id="l7.609" class="difflineplus">+</span>
<a href="#l7.610"></a><span id="l7.610" class="difflineplus">+      if (!msgFolder)</span>
<a href="#l7.611"></a><span id="l7.611" class="difflineplus">+        continue;</span>
<a href="#l7.612"></a><span id="l7.612" class="difflineplus">+</span>
<a href="#l7.613"></a><span id="l7.613" class="difflineplus">+      nsCString folderURI;</span>
<a href="#l7.614"></a><span id="l7.614" class="difflineplus">+      msgFolder-&gt;GetURI(folderURI);</span>
<a href="#l7.615"></a><span id="l7.615" class="difflineplus">+      PRBool hasNew = PR_FALSE;</span>
<a href="#l7.616"></a><span id="l7.616" class="difflineplus">+      rv = msgFolder-&gt;GetHasNewMessages(&amp;hasNew);</span>
<a href="#l7.617"></a><span id="l7.617" class="difflineplus">+</span>
<a href="#l7.618"></a><span id="l7.618" class="difflineplus">+      if (NS_FAILED(rv))</span>
<a href="#l7.619"></a><span id="l7.619" class="difflineplus">+        continue;</span>
<a href="#l7.620"></a><span id="l7.620" class="difflineplus">+</span>
<a href="#l7.621"></a><span id="l7.621" class="difflineplus">+      // Grab the MRUTime property from the folder</span>
<a href="#l7.622"></a><span id="l7.622" class="difflineplus">+      nsCString dateStr;</span>
<a href="#l7.623"></a><span id="l7.623" class="difflineplus">+      msgFolder-&gt;GetStringProperty(MRU_TIME_PROPERTY, dateStr);</span>
<a href="#l7.624"></a><span id="l7.624" class="difflineplus">+      PRUint32 MRUTime = (PRUint32) dateStr.ToInteger(&amp;rv, 10);</span>
<a href="#l7.625"></a><span id="l7.625" class="difflineplus">+      if (NS_FAILED(rv))</span>
<a href="#l7.626"></a><span id="l7.626" class="difflineplus">+        MRUTime = 0;</span>
<a href="#l7.627"></a><span id="l7.627" class="difflineplus">+</span>
<a href="#l7.628"></a><span id="l7.628" class="difflineplus">+      if (hasNew &amp;&amp; MRUTime &gt; lastMRUTime)</span>
<a href="#l7.629"></a><span id="l7.629">       {</span>
<a href="#l7.630"></a><span id="l7.630" class="difflineminus">-        rv = enumerator-&gt;CurrentItem(getter_AddRefs(supports));</span>
<a href="#l7.631"></a><span id="l7.631" class="difflineminus">-        if (supports)</span>
<a href="#l7.632"></a><span id="l7.632" class="difflineminus">-        {</span>
<a href="#l7.633"></a><span id="l7.633" class="difflineminus">-          msgFolder = do_QueryInterface(supports, &amp;rv);</span>
<a href="#l7.634"></a><span id="l7.634" class="difflineminus">-          if (msgFolder)</span>
<a href="#l7.635"></a><span id="l7.635" class="difflineminus">-          {</span>
<a href="#l7.636"></a><span id="l7.636" class="difflineminus">-            numNewMessages = 0;   </span>
<a href="#l7.637"></a><span id="l7.637" class="difflineminus">-            msgFolder-&gt;GetNumNewMessages(PR_FALSE, &amp;numNewMessages);</span>
<a href="#l7.638"></a><span id="l7.638" class="difflineminus">-            if (numNewMessages)</span>
<a href="#l7.639"></a><span id="l7.639" class="difflineminus">-              break; // kick out of the while loop</span>
<a href="#l7.640"></a><span id="l7.640" class="difflineminus">-            more = enumerator-&gt;Next();</span>
<a href="#l7.641"></a><span id="l7.641" class="difflineminus">-          }</span>
<a href="#l7.642"></a><span id="l7.642" class="difflineminus">-        } // if we have a folder</span>
<a href="#l7.643"></a><span id="l7.643" class="difflineminus">-      }  // if we have more potential folders to enumerate</span>
<a href="#l7.644"></a><span id="l7.644" class="difflineminus">-    }  // if enumerator</span>
<a href="#l7.645"></a><span id="l7.645" class="difflineminus">-    </span>
<a href="#l7.646"></a><span id="l7.646" class="difflineminus">-    if (msgFolder)</span>
<a href="#l7.647"></a><span id="l7.647" class="difflineminus">-      msgFolder-&gt;GetURI(aFolderURI);</span>
<a href="#l7.648"></a><span id="l7.648" class="difflineplus">+        rv = msgFolder-&gt;GetURI(aFolderURI);</span>
<a href="#l7.649"></a><span id="l7.649" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.650"></a><span id="l7.650" class="difflineplus">+        return NS_OK;</span>
<a href="#l7.651"></a><span id="l7.651" class="difflineplus">+      }</span>
<a href="#l7.652"></a><span id="l7.652" class="difflineplus">+    }  // if we have more potential folders to enumerate</span>
<a href="#l7.653"></a><span id="l7.653">   }</span>
<a href="#l7.654"></a><span id="l7.654"> </span>
<a href="#l7.655"></a><span id="l7.655" class="difflineminus">-  return NS_OK;</span>
<a href="#l7.656"></a><span id="l7.656" class="difflineplus">+  // If we got here, then something when pretty wrong.</span>
<a href="#l7.657"></a><span id="l7.657" class="difflineplus">+  return NS_ERROR_FAILURE;</span>
<a href="#l7.658"></a><span id="l7.658"> }</span>
<a href="#l7.659"></a><span id="l7.659"> </span>
<a href="#l7.660"></a><span id="l7.660"> NS_IMETHODIMP</span>
<a href="#l7.661"></a><span id="l7.661"> nsMessengerUnixIntegration::OnItemPropertyFlagChanged(nsIMsgDBHdr *item, nsIAtom *property, PRUint32 oldFlag, PRUint32 newFlag)</span>
<a href="#l7.662"></a><span id="l7.662"> {</span>
<a href="#l7.663"></a><span id="l7.663">   return NS_OK;</span>
<a href="#l7.664"></a><span id="l7.664"> }</span>
<a href="#l7.665"></a><span id="l7.665"> </span>
<a href="#l7.666"></a><span id="l7.666" class="difflineat">@@ -344,40 +720,98 @@ NS_IMETHODIMP</span>
<a href="#l7.667"></a><span id="l7.667"> nsMessengerUnixIntegration::OnItemEvent(nsIMsgFolder *, nsIAtom *)</span>
<a href="#l7.668"></a><span id="l7.668"> {</span>
<a href="#l7.669"></a><span id="l7.669">   return NS_OK;</span>
<a href="#l7.670"></a><span id="l7.670"> }</span>
<a href="#l7.671"></a><span id="l7.671"> </span>
<a href="#l7.672"></a><span id="l7.672"> NS_IMETHODIMP</span>
<a href="#l7.673"></a><span id="l7.673"> nsMessengerUnixIntegration::OnItemIntPropertyChanged(nsIMsgFolder *aItem, nsIAtom *aProperty, PRInt32 aOldValue, PRInt32 aNewValue)</span>
<a href="#l7.674"></a><span id="l7.674"> {</span>
<a href="#l7.675"></a><span id="l7.675" class="difflineminus">-  // if we got new mail show a icon in the system tray</span>
<a href="#l7.676"></a><span id="l7.676" class="difflineplus">+  nsCString atomName;</span>
<a href="#l7.677"></a><span id="l7.677" class="difflineplus">+  // if we got new mail show an icon in the system tray</span>
<a href="#l7.678"></a><span id="l7.678">   if (mBiffStateAtom == aProperty &amp;&amp; mFoldersWithNewMail)</span>
<a href="#l7.679"></a><span id="l7.679">   {</span>
<a href="#l7.680"></a><span id="l7.680" class="difflineminus">-</span>
<a href="#l7.681"></a><span id="l7.681">     nsCOMPtr&lt;nsIWeakReference&gt; weakFolder = do_GetWeakReference(aItem);</span>
<a href="#l7.682"></a><span id="l7.682">     PRInt32 indexInNewArray = mFoldersWithNewMail-&gt;IndexOf(weakFolder);</span>
<a href="#l7.683"></a><span id="l7.683"> </span>
<a href="#l7.684"></a><span id="l7.684" class="difflineminus">-    if (aNewValue == nsIMsgFolder::nsMsgBiffState_NewMail) </span>
<a href="#l7.685"></a><span id="l7.685" class="difflineplus">+    if (aNewValue == nsIMsgFolder::nsMsgBiffState_NewMail)</span>
<a href="#l7.686"></a><span id="l7.686">     {</span>
<a href="#l7.687"></a><span id="l7.687">       // only show a system tray icon iff we are performing biff</span>
<a href="#l7.688"></a><span id="l7.688">       // (as opposed to the user getting new mail)</span>
<a href="#l7.689"></a><span id="l7.689">       PRBool performingBiff = PR_FALSE;</span>
<a href="#l7.690"></a><span id="l7.690">       nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l7.691"></a><span id="l7.691">       aItem-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l7.692"></a><span id="l7.692">       if (server)</span>
<a href="#l7.693"></a><span id="l7.693">         server-&gt;GetPerformingBiff(&amp;performingBiff);</span>
<a href="#l7.694"></a><span id="l7.694" class="difflineminus">-      if (!performingBiff) </span>
<a href="#l7.695"></a><span id="l7.695" class="difflineplus">+      if (!performingBiff)</span>
<a href="#l7.696"></a><span id="l7.696">         return NS_OK; // kick out right now...</span>
<a href="#l7.697"></a><span id="l7.697"> </span>
<a href="#l7.698"></a><span id="l7.698">       if (indexInNewArray == -1)</span>
<a href="#l7.699"></a><span id="l7.699">         mFoldersWithNewMail-&gt;AppendElement(weakFolder);</span>
<a href="#l7.700"></a><span id="l7.700">       // now regenerate the tooltip</span>
<a href="#l7.701"></a><span id="l7.701" class="difflineminus">-      FillToolTipInfo();    </span>
<a href="#l7.702"></a><span id="l7.702" class="difflineplus">+      FillToolTipInfo();</span>
<a href="#l7.703"></a><span id="l7.703">     }</span>
<a href="#l7.704"></a><span id="l7.704">     else if (aNewValue == nsIMsgFolder::nsMsgBiffState_NoMail)</span>
<a href="#l7.705"></a><span id="l7.705">     {</span>
<a href="#l7.706"></a><span id="l7.706" class="difflineminus">-      if (indexInNewArray != -1)</span>
<a href="#l7.707"></a><span id="l7.707" class="difflineplus">+      if (indexInNewArray != -1) {</span>
<a href="#l7.708"></a><span id="l7.708">         mFoldersWithNewMail-&gt;RemoveElementAt(indexInNewArray);</span>
<a href="#l7.709"></a><span id="l7.709" class="difflineplus">+      }</span>
<a href="#l7.710"></a><span id="l7.710">     }</span>
<a href="#l7.711"></a><span id="l7.711">   } // if the biff property changed</span>
<a href="#l7.712"></a><span id="l7.712" class="difflineplus">+  else if (mNewMailReceivedAtom == aProperty)</span>
<a href="#l7.713"></a><span id="l7.713" class="difflineplus">+  {</span>
<a href="#l7.714"></a><span id="l7.714" class="difflineplus">+    FillToolTipInfo();</span>
<a href="#l7.715"></a><span id="l7.715" class="difflineplus">+  }</span>
<a href="#l7.716"></a><span id="l7.716" class="difflineplus">+</span>
<a href="#l7.717"></a><span id="l7.717" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.718"></a><span id="l7.718" class="difflineplus">+}</span>
<a href="#l7.719"></a><span id="l7.719" class="difflineplus">+</span>
<a href="#l7.720"></a><span id="l7.720" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l7.721"></a><span id="l7.721" class="difflineplus">+nsMessengerUnixIntegration::OnStartRunningUrl(nsIURI *aUrl)</span>
<a href="#l7.722"></a><span id="l7.722" class="difflineplus">+{</span>
<a href="#l7.723"></a><span id="l7.723" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.724"></a><span id="l7.724" class="difflineplus">+}</span>
<a href="#l7.725"></a><span id="l7.725" class="difflineplus">+</span>
<a href="#l7.726"></a><span id="l7.726" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l7.727"></a><span id="l7.727" class="difflineplus">+nsMessengerUnixIntegration::OnStopRunningUrl(nsIURI *aUrl, nsresult aExitCode)</span>
<a href="#l7.728"></a><span id="l7.728" class="difflineplus">+{</span>
<a href="#l7.729"></a><span id="l7.729" class="difflineplus">+#ifdef MOZ_THUNDERBIRD</span>
<a href="#l7.730"></a><span id="l7.730" class="difflineplus">+  if (NS_SUCCEEDED(aExitCode))</span>
<a href="#l7.731"></a><span id="l7.731" class="difflineplus">+    // preview fetch is done.</span>
<a href="#l7.732"></a><span id="l7.732" class="difflineplus">+    FillToolTipInfo();</span>
<a href="#l7.733"></a><span id="l7.733" class="difflineplus">+#endif</span>
<a href="#l7.734"></a><span id="l7.734">   return NS_OK;</span>
<a href="#l7.735"></a><span id="l7.735"> }</span>
<a href="#l7.736"></a><span id="l7.736" class="difflineplus">+</span>
<a href="#l7.737"></a><span id="l7.737" class="difflineplus">+nsresult</span>
<a href="#l7.738"></a><span id="l7.738" class="difflineplus">+nsMessengerUnixIntegration::GetMRUTimestampForFolder(nsIMsgFolder *aFolder,</span>
<a href="#l7.739"></a><span id="l7.739" class="difflineplus">+                                                     PRUint32 *aLastMRUTime)</span>
<a href="#l7.740"></a><span id="l7.740" class="difflineplus">+{</span>
<a href="#l7.741"></a><span id="l7.741" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder = nsnull;</span>
<a href="#l7.742"></a><span id="l7.742" class="difflineplus">+  nsresult rv = aFolder-&gt;GetRootFolder(getter_AddRefs(rootFolder));</span>
<a href="#l7.743"></a><span id="l7.743" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.744"></a><span id="l7.744" class="difflineplus">+</span>
<a href="#l7.745"></a><span id="l7.745" class="difflineplus">+  nsCString rootFolderURI;</span>
<a href="#l7.746"></a><span id="l7.746" class="difflineplus">+  rootFolder-&gt;GetURI(rootFolderURI);</span>
<a href="#l7.747"></a><span id="l7.747" class="difflineplus">+  if (!mLastMRUTimes.Get(rootFolderURI, aLastMRUTime))</span>
<a href="#l7.748"></a><span id="l7.748" class="difflineplus">+    aLastMRUTime = 0;</span>
<a href="#l7.749"></a><span id="l7.749" class="difflineplus">+</span>
<a href="#l7.750"></a><span id="l7.750" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.751"></a><span id="l7.751" class="difflineplus">+}</span>
<a href="#l7.752"></a><span id="l7.752" class="difflineplus">+</span>
<a href="#l7.753"></a><span id="l7.753" class="difflineplus">+#ifdef MOZ_THUNDERBIRD</span>
<a href="#l7.754"></a><span id="l7.754" class="difflineplus">+nsresult</span>
<a href="#l7.755"></a><span id="l7.755" class="difflineplus">+nsMessengerUnixIntegration::PutMRUTimestampForFolder(nsIMsgFolder *aFolder,</span>
<a href="#l7.756"></a><span id="l7.756" class="difflineplus">+                                                     PRUint32 aLastMRUTime)</span>
<a href="#l7.757"></a><span id="l7.757" class="difflineplus">+{</span>
<a href="#l7.758"></a><span id="l7.758" class="difflineplus">+  nsresult rv;</span>
<a href="#l7.759"></a><span id="l7.759" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder = nsnull;</span>
<a href="#l7.760"></a><span id="l7.760" class="difflineplus">+  rv = aFolder-&gt;GetRootFolder(getter_AddRefs(rootFolder));</span>
<a href="#l7.761"></a><span id="l7.761" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.762"></a><span id="l7.762" class="difflineplus">+</span>
<a href="#l7.763"></a><span id="l7.763" class="difflineplus">+  nsCString rootFolderURI;</span>
<a href="#l7.764"></a><span id="l7.764" class="difflineplus">+  rootFolder-&gt;GetURI(rootFolderURI);</span>
<a href="#l7.765"></a><span id="l7.765" class="difflineplus">+  mLastMRUTimes.Put(rootFolderURI, aLastMRUTime);</span>
<a href="#l7.766"></a><span id="l7.766" class="difflineplus">+</span>
<a href="#l7.767"></a><span id="l7.767" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.768"></a><span id="l7.768" class="difflineplus">+}</span>
<a href="#l7.769"></a><span id="l7.769" class="difflineplus">+#endif</span>
<a href="#l7.770"></a><span id="l7.770" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/base/src/nsMessengerUnixIntegration.h</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/base/src/nsMessengerUnixIntegration.h</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -38,46 +38,60 @@</span>
<a href="#l8.4"></a><span id="l8.4">  *</span>
<a href="#l8.5"></a><span id="l8.5">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l8.6"></a><span id="l8.6"> </span>
<a href="#l8.7"></a><span id="l8.7"> #ifndef __nsMessengerUnixIntegration_h</span>
<a href="#l8.8"></a><span id="l8.8"> #define __nsMessengerUnixIntegration_h</span>
<a href="#l8.9"></a><span id="l8.9"> </span>
<a href="#l8.10"></a><span id="l8.10"> #include &quot;nsIMessengerOSIntegration.h&quot;</span>
<a href="#l8.11"></a><span id="l8.11"> #include &quot;nsIFolderListener.h&quot;</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+#include &quot;nsIUrlListener.h&quot;</span>
<a href="#l8.13"></a><span id="l8.13"> #include &quot;nsISupportsArray.h&quot;</span>
<a href="#l8.14"></a><span id="l8.14"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l8.15"></a><span id="l8.15"> #include &quot;nsIObserver.h&quot;</span>
<a href="#l8.16"></a><span id="l8.16"> #include &quot;nsIAtom.h&quot;</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+#include &quot;nsDataHashtable.h&quot;</span>
<a href="#l8.18"></a><span id="l8.18"> </span>
<a href="#l8.19"></a><span id="l8.19"> #define NS_MESSENGERUNIXINTEGRATION_CID \</span>
<a href="#l8.20"></a><span id="l8.20">   {0xf62f3d3a, 0x1dd1, 0x11b2, \</span>
<a href="#l8.21"></a><span id="l8.21">     {0xa5, 0x16, 0xef, 0xad, 0xb1, 0x31, 0x61, 0x5c}}</span>
<a href="#l8.22"></a><span id="l8.22"> </span>
<a href="#l8.23"></a><span id="l8.23" class="difflineminus">-class nsIStringBundle; </span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+class nsIStringBundle;</span>
<a href="#l8.25"></a><span id="l8.25"> </span>
<a href="#l8.26"></a><span id="l8.26"> class nsMessengerUnixIntegration : public nsIFolderListener,</span>
<a href="#l8.27"></a><span id="l8.27">                                    public nsIObserver,</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineplus">+                                   public nsIUrlListener,</span>
<a href="#l8.29"></a><span id="l8.29">                                    public nsIMessengerOSIntegration</span>
<a href="#l8.30"></a><span id="l8.30"> {</span>
<a href="#l8.31"></a><span id="l8.31"> public:</span>
<a href="#l8.32"></a><span id="l8.32">   nsMessengerUnixIntegration();</span>
<a href="#l8.33"></a><span id="l8.33">   virtual nsresult Init();</span>
<a href="#l8.34"></a><span id="l8.34"> </span>
<a href="#l8.35"></a><span id="l8.35">   NS_DECL_ISUPPORTS</span>
<a href="#l8.36"></a><span id="l8.36">   NS_DECL_NSIMESSENGEROSINTEGRATION</span>
<a href="#l8.37"></a><span id="l8.37">   NS_DECL_NSIFOLDERLISTENER</span>
<a href="#l8.38"></a><span id="l8.38">   NS_DECL_NSIOBSERVER</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineplus">+  NS_DECL_NSIURLLISTENER</span>
<a href="#l8.40"></a><span id="l8.40"> </span>
<a href="#l8.41"></a><span id="l8.41"> private:</span>
<a href="#l8.42"></a><span id="l8.42">   nsresult ShowAlertMessage(const nsAString&amp; aAlertTitle, const nsAString&amp; aAlertText, const nsACString&amp; aFolderURI);</span>
<a href="#l8.43"></a><span id="l8.43">   nsresult GetFirstFolderWithNewMail(nsACString&amp; aFolderURI);</span>
<a href="#l8.44"></a><span id="l8.44">   nsresult GetStringBundle(nsIStringBundle **aBundle);</span>
<a href="#l8.45"></a><span id="l8.45">   nsresult AlertFinished();</span>
<a href="#l8.46"></a><span id="l8.46">   nsresult AlertClicked();</span>
<a href="#l8.47"></a><span id="l8.47">   void FillToolTipInfo();</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineplus">+  nsresult GetMRUTimestampForFolder(nsIMsgFolder *aFolder, PRUint32 *aLastMRUTime);</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineplus">+</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineplus">+#ifdef MOZ_THUNDERBIRD</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+  PRBool BuildNotificationBody(nsIMsgDBHdr *aHdr, nsIStringBundle *Bundle, nsString &amp;aBody);</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineplus">+  PRBool BuildNotificationTitle(nsIMsgFolder *aFolder, nsIStringBundle *aBundle, nsString &amp;aTitle);</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineplus">+  nsresult ShowNewAlertNotification(PRBool aUserInitiated);</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineplus">+  nsresult PutMRUTimestampForFolder(nsIMsgFolder *aFolder, PRUint32 aLastMRUTime);</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineplus">+#endif</span>
<a href="#l8.56"></a><span id="l8.56"> </span>
<a href="#l8.57"></a><span id="l8.57">   nsCOMPtr&lt;nsISupportsArray&gt; mFoldersWithNewMail;  // keep track of all the root folders with pending new mail</span>
<a href="#l8.58"></a><span id="l8.58">   nsCOMPtr&lt;nsIAtom&gt; mBiffStateAtom;</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineplus">+  nsCOMPtr&lt;nsIAtom&gt; mNewMailReceivedAtom;</span>
<a href="#l8.60"></a><span id="l8.60">   PRBool mAlertInProgress;</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineplus">+  nsDataHashtable&lt;nsCStringHashKey, PRUint32&gt; mLastMRUTimes; // We keep track of the last time we did a new mail notification for each account</span>
<a href="#l8.62"></a><span id="l8.62"> };</span>
<a href="#l8.63"></a><span id="l8.63"> </span>
<a href="#l8.64"></a><span id="l8.64"> #endif // __nsMessengerUnixIntegration_h</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -4580,16 +4580,18 @@ NS_IMETHODIMP nsMsgDBFolder::SetBiffStat</span>
<a href="#l9.4"></a><span id="l9.4">     }</span>
<a href="#l9.5"></a><span id="l9.5">     if (server)</span>
<a href="#l9.6"></a><span id="l9.6">       server-&gt;SetBiffState(aBiffState);</span>
<a href="#l9.7"></a><span id="l9.7"> </span>
<a href="#l9.8"></a><span id="l9.8">     NotifyIntPropertyChanged(kBiffStateAtom, oldBiffState, aBiffState);</span>
<a href="#l9.9"></a><span id="l9.9">   }</span>
<a href="#l9.10"></a><span id="l9.10">   else if (aBiffState == oldBiffState &amp;&amp; aBiffState == nsMsgBiffState_NewMail)</span>
<a href="#l9.11"></a><span id="l9.11">   {</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+    // The folder has been updated, so update the MRUTime</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+    SetMRUTime();</span>
<a href="#l9.14"></a><span id="l9.14">     // biff is already set, but notify that there is additional new mail for the folder</span>
<a href="#l9.15"></a><span id="l9.15">     NotifyIntPropertyChanged(kNewMailReceivedAtom, 0, mNumNewBiffMessages);</span>
<a href="#l9.16"></a><span id="l9.16">   }</span>
<a href="#l9.17"></a><span id="l9.17">   else if (aBiffState == nsMsgBiffState_NoMail)</span>
<a href="#l9.18"></a><span id="l9.18">   {</span>
<a href="#l9.19"></a><span id="l9.19">     // even if the old biff state equals the new biff state, it is still possible that we've never</span>
<a href="#l9.20"></a><span id="l9.20">     // cleared the number of new messages for this particular folder. This happens when the new mail state</span>
<a href="#l9.21"></a><span id="l9.21">     // got cleared by viewing a new message in folder that is different from this one. Biff state is stored per server</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/test/resources/messageInjection.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/test/resources/messageInjection.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -15,16 +15,17 @@</span>
<a href="#l10.4"></a><span id="l10.4">  *</span>
<a href="#l10.5"></a><span id="l10.5">  * The Initial Developer of the Original Code is</span>
<a href="#l10.6"></a><span id="l10.6">  * the Mozilla Foundation.</span>
<a href="#l10.7"></a><span id="l10.7">  * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l10.8"></a><span id="l10.8">  * the Initial Developer. All Rights Reserved.</span>
<a href="#l10.9"></a><span id="l10.9">  *</span>
<a href="#l10.10"></a><span id="l10.10">  * Contributor(s):</span>
<a href="#l10.11"></a><span id="l10.11">  *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+ *   Mike Conley &lt;mconley@mozilla.com&gt;</span>
<a href="#l10.13"></a><span id="l10.13">  *</span>
<a href="#l10.14"></a><span id="l10.14">  * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l10.15"></a><span id="l10.15">  * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l10.16"></a><span id="l10.16">  * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l10.17"></a><span id="l10.17">  * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l10.18"></a><span id="l10.18">  * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l10.19"></a><span id="l10.19">  * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l10.20"></a><span id="l10.20">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineat">@@ -713,34 +714,44 @@ function add_sets_to_folders(aMsgFolders</span>
<a href="#l10.22"></a><span id="l10.22">       if (!folderBatch.messages.length)</span>
<a href="#l10.23"></a><span id="l10.23">         continue;</span>
<a href="#l10.24"></a><span id="l10.24"> </span>
<a href="#l10.25"></a><span id="l10.25">       let folder = folderBatch.folder;</span>
<a href="#l10.26"></a><span id="l10.26">       folder.gettingNewMessages = true;</span>
<a href="#l10.27"></a><span id="l10.27">       let messageStrings = [synMsg.toMboxString() for each</span>
<a href="#l10.28"></a><span id="l10.28">                             ([, synMsg] in Iterator(folderBatch.messages))];</span>
<a href="#l10.29"></a><span id="l10.29">       folder.addMessageBatch(messageStrings.length, messageStrings);</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineplus">+</span>
<a href="#l10.31"></a><span id="l10.31">       for each (let [, synMsg] in Iterator(folderBatch.messages)) {</span>
<a href="#l10.32"></a><span id="l10.32">         // if we need to mark the message as junk grab the header and do so</span>
<a href="#l10.33"></a><span id="l10.33">         // (The message set can mark the whole set as junk, but not just</span>
<a href="#l10.34"></a><span id="l10.34">         //  specific messages.)</span>
<a href="#l10.35"></a><span id="l10.35">         if (synMsg.metaState.junk) {</span>
<a href="#l10.36"></a><span id="l10.36">           let msgHdr = messageSet.getMsgHdr(iPerSet);</span>
<a href="#l10.37"></a><span id="l10.37">           msgHdr.setStringProperty(&quot;junkscore&quot;, &quot;100&quot;);</span>
<a href="#l10.38"></a><span id="l10.38">         }</span>
<a href="#l10.39"></a><span id="l10.39">         if (synMsg.metaState.read) {</span>
<a href="#l10.40"></a><span id="l10.40">           // XXX this will generate an event; I'm not sure if we should be</span>
<a href="#l10.41"></a><span id="l10.41">           //  trying to avoid that or not.  This case is really only added</span>
<a href="#l10.42"></a><span id="l10.42">           //  for IMAP where this makes more sense.</span>
<a href="#l10.43"></a><span id="l10.43">           let msgHdr = messageSet.getMsgHdr(iPerSet);</span>
<a href="#l10.44"></a><span id="l10.44">           msgHdr.markRead(true);</span>
<a href="#l10.45"></a><span id="l10.45">         }</span>
<a href="#l10.46"></a><span id="l10.46">       }</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineplus">+      if (folderBatch.messages.length)</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineplus">+      {</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineplus">+        let lastMRUTime = Math.floor(Number(folderBatch.messages[0].date)</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineplus">+                                     / 1000);</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineplus">+        folder.setStringProperty(&quot;MRUTime&quot;, lastMRUTime);</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineplus">+      }</span>
<a href="#l10.53"></a><span id="l10.53">       folder.gettingNewMessages = false;</span>
<a href="#l10.54"></a><span id="l10.54">       folder.hasNewMessages = true;</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineplus">+      folder.setNumNewMessages(folder.getNumNewMessages(false)</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineplus">+                               + messageStrings.length);</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineplus">+      folder.biffState = Ci.nsIMsgFolder.nsMsgBiffState_NewMail;</span>
<a href="#l10.58"></a><span id="l10.58">     }</span>
<a href="#l10.59"></a><span id="l10.59"> </span>
<a href="#l10.60"></a><span id="l10.60">     // make sure that junk filtering gets a turn</span>
<a href="#l10.61"></a><span id="l10.61">     // XXX we probably need to be doing more in terms of filters here,</span>
<a href="#l10.62"></a><span id="l10.62">     //  although since filters really want to be run on the inbox, there</span>
<a href="#l10.63"></a><span id="l10.63">     //  are separate potential semantic issues involved.</span>
<a href="#l10.64"></a><span id="l10.64">     for each (let [, folder] in Iterator(aMsgFolders)) {</span>
<a href="#l10.65"></a><span id="l10.65">       folder.callFilterPlugins(null);</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

