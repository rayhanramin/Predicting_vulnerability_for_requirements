<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 15846:642cfedbc63779a059ff31e210acbb6a93b4f5ba</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 642cfedbc63779a059ff31e210acbb6a93b4f5ba" />
<meta property="og:url" content="/comm-central/rev/642cfedbc63779a059ff31e210acbb6a93b4f5ba" />
<meta property="og:description" content="Bug 970118 - Refactor nsIMsgCompose::checkAndPopulateRecipients to reflect how it is actually used, r=Neil." />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 642cfedbc63779a059ff31e210acbb6a93b4f5ba 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/642cfedbc63779a059ff31e210acbb6a93b4f5ba">shortlog</a> |
<a href="/comm-central/log/642cfedbc63779a059ff31e210acbb6a93b4f5ba">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/642cfedbc63779a059ff31e210acbb6a93b4f5ba">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/642cfedbc63779a059ff31e210acbb6a93b4f5ba">files</a> |
changeset |
<a href="/comm-central/raw-rev/642cfedbc63779a059ff31e210acbb6a93b4f5ba">raw</a>  | <a href="/comm-central/archive/642cfedbc63779a059ff31e210acbb6a93b4f5ba.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=970118">Bug 970118</a> - Refactor nsIMsgCompose::checkAndPopulateRecipients to reflect how it is actually used, r=Neil.
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#111;&#115;&#104;&#117;&#97;&#32;&#67;&#114;&#97;&#110;&#109;&#101;&#114;&#32;&#60;&#80;&#105;&#100;&#103;&#101;&#111;&#116;&#49;&#56;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 04 Mar 2014 10:15:49 -0600</td></tr>

<tr>
 <td>changeset 15846</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/642cfedbc63779a059ff31e210acbb6a93b4f5ba">642cfedbc63779a059ff31e210acbb6a93b4f5ba</a></td>
</tr>



<tr>
<td>parent 15845</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/7cbc6089254963926175c48ced16be8fa2885568">7cbc6089254963926175c48ced16be8fa2885568</a>
</td>
</tr>

<tr>
<td>child 15847</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/2b77b610f13432ceb3ab80bdcf2c837c7d177569">2b77b610f13432ceb3ab80bdcf2c837c7d177569</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=642cfedbc63779a059ff31e210acbb6a93b4f5ba">9928</a></td></tr>
<tr><td>push user</td><td>Pidgeot18@gmail.com</td></tr>
<tr><td>push date</td><td class="date age">Tue, 04 Mar 2014 16:16:11 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@642cfedbc637 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=642cfedbc63779a059ff31e210acbb6a93b4f5ba">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=642cfedbc63779a059ff31e210acbb6a93b4f5ba&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=642cfedbc63779a059ff31e210acbb6a93b4f5ba&newProject=comm-central&newRevision=642cfedbc63779a059ff31e210acbb6a93b4f5ba&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=642cfedbc63779a059ff31e210acbb6a93b4f5ba&newProject=comm-central&newRevision=642cfedbc63779a059ff31e210acbb6a93b4f5ba&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=642cfedbc63779a059ff31e210acbb6a93b4f5ba&newProject=comm-central&newRevision=642cfedbc63779a059ff31e210acbb6a93b4f5ba&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28Neil%29&revcount=50">Neil</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=970118">970118</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=970118">Bug 970118</a> - Refactor nsIMsgCompose::checkAndPopulateRecipients to reflect how it is actually used, r=Neil.

And SeaMonkey is still a CLOSED TREE.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/642cfedbc63779a059ff31e210acbb6a93b4f5ba/mail/components/compose/content/MsgComposeCommands.js">mail/components/compose/content/MsgComposeCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/642cfedbc63779a059ff31e210acbb6a93b4f5ba/mail/components/compose/content/MsgComposeCommands.js">file</a> |
<a href="/comm-central/annotate/642cfedbc63779a059ff31e210acbb6a93b4f5ba/mail/components/compose/content/MsgComposeCommands.js">annotate</a> |
<a href="/comm-central/diff/642cfedbc63779a059ff31e210acbb6a93b4f5ba/mail/components/compose/content/MsgComposeCommands.js">diff</a> |
<a href="/comm-central/comparison/642cfedbc63779a059ff31e210acbb6a93b4f5ba/mail/components/compose/content/MsgComposeCommands.js">comparison</a> |
<a href="/comm-central/log/642cfedbc63779a059ff31e210acbb6a93b4f5ba/mail/components/compose/content/MsgComposeCommands.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/642cfedbc63779a059ff31e210acbb6a93b4f5ba/mailnews/compose/public/nsIMsgCompose.idl">mailnews/compose/public/nsIMsgCompose.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/642cfedbc63779a059ff31e210acbb6a93b4f5ba/mailnews/compose/public/nsIMsgCompose.idl">file</a> |
<a href="/comm-central/annotate/642cfedbc63779a059ff31e210acbb6a93b4f5ba/mailnews/compose/public/nsIMsgCompose.idl">annotate</a> |
<a href="/comm-central/diff/642cfedbc63779a059ff31e210acbb6a93b4f5ba/mailnews/compose/public/nsIMsgCompose.idl">diff</a> |
<a href="/comm-central/comparison/642cfedbc63779a059ff31e210acbb6a93b4f5ba/mailnews/compose/public/nsIMsgCompose.idl">comparison</a> |
<a href="/comm-central/log/642cfedbc63779a059ff31e210acbb6a93b4f5ba/mailnews/compose/public/nsIMsgCompose.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/642cfedbc63779a059ff31e210acbb6a93b4f5ba/mailnews/compose/src/nsMsgCompFields.cpp">mailnews/compose/src/nsMsgCompFields.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/642cfedbc63779a059ff31e210acbb6a93b4f5ba/mailnews/compose/src/nsMsgCompFields.cpp">file</a> |
<a href="/comm-central/annotate/642cfedbc63779a059ff31e210acbb6a93b4f5ba/mailnews/compose/src/nsMsgCompFields.cpp">annotate</a> |
<a href="/comm-central/diff/642cfedbc63779a059ff31e210acbb6a93b4f5ba/mailnews/compose/src/nsMsgCompFields.cpp">diff</a> |
<a href="/comm-central/comparison/642cfedbc63779a059ff31e210acbb6a93b4f5ba/mailnews/compose/src/nsMsgCompFields.cpp">comparison</a> |
<a href="/comm-central/log/642cfedbc63779a059ff31e210acbb6a93b4f5ba/mailnews/compose/src/nsMsgCompFields.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/642cfedbc63779a059ff31e210acbb6a93b4f5ba/mailnews/compose/src/nsMsgCompFields.h">mailnews/compose/src/nsMsgCompFields.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/642cfedbc63779a059ff31e210acbb6a93b4f5ba/mailnews/compose/src/nsMsgCompFields.h">file</a> |
<a href="/comm-central/annotate/642cfedbc63779a059ff31e210acbb6a93b4f5ba/mailnews/compose/src/nsMsgCompFields.h">annotate</a> |
<a href="/comm-central/diff/642cfedbc63779a059ff31e210acbb6a93b4f5ba/mailnews/compose/src/nsMsgCompFields.h">diff</a> |
<a href="/comm-central/comparison/642cfedbc63779a059ff31e210acbb6a93b4f5ba/mailnews/compose/src/nsMsgCompFields.h">comparison</a> |
<a href="/comm-central/log/642cfedbc63779a059ff31e210acbb6a93b4f5ba/mailnews/compose/src/nsMsgCompFields.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/642cfedbc63779a059ff31e210acbb6a93b4f5ba/mailnews/compose/src/nsMsgCompose.cpp">mailnews/compose/src/nsMsgCompose.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/642cfedbc63779a059ff31e210acbb6a93b4f5ba/mailnews/compose/src/nsMsgCompose.cpp">file</a> |
<a href="/comm-central/annotate/642cfedbc63779a059ff31e210acbb6a93b4f5ba/mailnews/compose/src/nsMsgCompose.cpp">annotate</a> |
<a href="/comm-central/diff/642cfedbc63779a059ff31e210acbb6a93b4f5ba/mailnews/compose/src/nsMsgCompose.cpp">diff</a> |
<a href="/comm-central/comparison/642cfedbc63779a059ff31e210acbb6a93b4f5ba/mailnews/compose/src/nsMsgCompose.cpp">comparison</a> |
<a href="/comm-central/log/642cfedbc63779a059ff31e210acbb6a93b4f5ba/mailnews/compose/src/nsMsgCompose.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/642cfedbc63779a059ff31e210acbb6a93b4f5ba/mailnews/compose/src/nsMsgCompose.h">mailnews/compose/src/nsMsgCompose.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/642cfedbc63779a059ff31e210acbb6a93b4f5ba/mailnews/compose/src/nsMsgCompose.h">file</a> |
<a href="/comm-central/annotate/642cfedbc63779a059ff31e210acbb6a93b4f5ba/mailnews/compose/src/nsMsgCompose.h">annotate</a> |
<a href="/comm-central/diff/642cfedbc63779a059ff31e210acbb6a93b4f5ba/mailnews/compose/src/nsMsgCompose.h">diff</a> |
<a href="/comm-central/comparison/642cfedbc63779a059ff31e210acbb6a93b4f5ba/mailnews/compose/src/nsMsgCompose.h">comparison</a> |
<a href="/comm-central/log/642cfedbc63779a059ff31e210acbb6a93b4f5ba/mailnews/compose/src/nsMsgCompose.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/642cfedbc63779a059ff31e210acbb6a93b4f5ba/mailnews/compose/test/unit/test_nsMsgCompose1.js">mailnews/compose/test/unit/test_nsMsgCompose1.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/642cfedbc63779a059ff31e210acbb6a93b4f5ba/mailnews/compose/test/unit/test_nsMsgCompose1.js">file</a> |
<a href="/comm-central/annotate/642cfedbc63779a059ff31e210acbb6a93b4f5ba/mailnews/compose/test/unit/test_nsMsgCompose1.js">annotate</a> |
<a href="/comm-central/diff/642cfedbc63779a059ff31e210acbb6a93b4f5ba/mailnews/compose/test/unit/test_nsMsgCompose1.js">diff</a> |
<a href="/comm-central/comparison/642cfedbc63779a059ff31e210acbb6a93b4f5ba/mailnews/compose/test/unit/test_nsMsgCompose1.js">comparison</a> |
<a href="/comm-central/log/642cfedbc63779a059ff31e210acbb6a93b4f5ba/mailnews/compose/test/unit/test_nsMsgCompose1.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/642cfedbc63779a059ff31e210acbb6a93b4f5ba/mailnews/compose/test/unit/test_nsMsgCompose3.js">mailnews/compose/test/unit/test_nsMsgCompose3.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/642cfedbc63779a059ff31e210acbb6a93b4f5ba/mailnews/compose/test/unit/test_nsMsgCompose3.js">file</a> |
<a href="/comm-central/annotate/642cfedbc63779a059ff31e210acbb6a93b4f5ba/mailnews/compose/test/unit/test_nsMsgCompose3.js">annotate</a> |
<a href="/comm-central/diff/642cfedbc63779a059ff31e210acbb6a93b4f5ba/mailnews/compose/test/unit/test_nsMsgCompose3.js">diff</a> |
<a href="/comm-central/comparison/642cfedbc63779a059ff31e210acbb6a93b4f5ba/mailnews/compose/test/unit/test_nsMsgCompose3.js">comparison</a> |
<a href="/comm-central/log/642cfedbc63779a059ff31e210acbb6a93b4f5ba/mailnews/compose/test/unit/test_nsMsgCompose3.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/642cfedbc63779a059ff31e210acbb6a93b4f5ba/mailnews/compose/test/unit/test_nsMsgCompose4.js">mailnews/compose/test/unit/test_nsMsgCompose4.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/642cfedbc63779a059ff31e210acbb6a93b4f5ba/mailnews/compose/test/unit/test_nsMsgCompose4.js">file</a> |
<a href="/comm-central/annotate/642cfedbc63779a059ff31e210acbb6a93b4f5ba/mailnews/compose/test/unit/test_nsMsgCompose4.js">annotate</a> |
<a href="/comm-central/diff/642cfedbc63779a059ff31e210acbb6a93b4f5ba/mailnews/compose/test/unit/test_nsMsgCompose4.js">diff</a> |
<a href="/comm-central/comparison/642cfedbc63779a059ff31e210acbb6a93b4f5ba/mailnews/compose/test/unit/test_nsMsgCompose4.js">comparison</a> |
<a href="/comm-central/log/642cfedbc63779a059ff31e210acbb6a93b4f5ba/mailnews/compose/test/unit/test_nsMsgCompose4.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/642cfedbc63779a059ff31e210acbb6a93b4f5ba/mailnews/compose/test/unit/xpcshell.ini">mailnews/compose/test/unit/xpcshell.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/642cfedbc63779a059ff31e210acbb6a93b4f5ba/mailnews/compose/test/unit/xpcshell.ini">file</a> |
<a href="/comm-central/annotate/642cfedbc63779a059ff31e210acbb6a93b4f5ba/mailnews/compose/test/unit/xpcshell.ini">annotate</a> |
<a href="/comm-central/diff/642cfedbc63779a059ff31e210acbb6a93b4f5ba/mailnews/compose/test/unit/xpcshell.ini">diff</a> |
<a href="/comm-central/comparison/642cfedbc63779a059ff31e210acbb6a93b4f5ba/mailnews/compose/test/unit/xpcshell.ini">comparison</a> |
<a href="/comm-central/log/642cfedbc63779a059ff31e210acbb6a93b4f5ba/mailnews/compose/test/unit/xpcshell.ini">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/642cfedbc63779a059ff31e210acbb6a93b4f5ba/suite/mailnews/compose/MsgComposeCommands.js">suite/mailnews/compose/MsgComposeCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/642cfedbc63779a059ff31e210acbb6a93b4f5ba/suite/mailnews/compose/MsgComposeCommands.js">file</a> |
<a href="/comm-central/annotate/642cfedbc63779a059ff31e210acbb6a93b4f5ba/suite/mailnews/compose/MsgComposeCommands.js">annotate</a> |
<a href="/comm-central/diff/642cfedbc63779a059ff31e210acbb6a93b4f5ba/suite/mailnews/compose/MsgComposeCommands.js">diff</a> |
<a href="/comm-central/comparison/642cfedbc63779a059ff31e210acbb6a93b4f5ba/suite/mailnews/compose/MsgComposeCommands.js">comparison</a> |
<a href="/comm-central/log/642cfedbc63779a059ff31e210acbb6a93b4f5ba/suite/mailnews/compose/MsgComposeCommands.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/components/compose/content/MsgComposeCommands.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/components/compose/content/MsgComposeCommands.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -3873,87 +3873,31 @@ nsAttachmentOpener.prototype =</span>
<a href="#l1.4"></a><span id="l1.4">  * Check what to do with HTML message according to what preference we have</span>
<a href="#l1.5"></a><span id="l1.5">  * stored for the recipients.</span>
<a href="#l1.6"></a><span id="l1.6">  *</span>
<a href="#l1.7"></a><span id="l1.7">  * @param convertible  An nsIMsgCompConvertible constant describing</span>
<a href="#l1.8"></a><span id="l1.8">  *                     message convertibility to plain text.</span>
<a href="#l1.9"></a><span id="l1.9">  */</span>
<a href="#l1.10"></a><span id="l1.10"> function DetermineHTMLAction(convertible)</span>
<a href="#l1.11"></a><span id="l1.11"> {</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-    if (!gMsgCompose.composeHTML)</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-        return nsIMsgCompSendFormat.PlainText;</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineminus">-    if (gSendFormat == nsIMsgCompSendFormat.AskUser)</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineminus">-    {</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineminus">-        //Well, before we ask, see if we can figure out what to do for ourselves</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineminus">-        var preferFormat;</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineminus">-</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineminus">-        //Check the address book for the HTML property for each recipient</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineminus">-        let noHtmlRecipients = getNonHtmlRecipients();</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineminus">-        if (!noHtmlRecipients) {</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineminus">-          var msgCompFields = gMsgCompose.compFields;</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineminus">-          noHtmlRecipients = msgCompFields.to + &quot;,&quot; + msgCompFields.cc + &quot;,&quot; + msgCompFields.bcc;</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineminus">-          preferFormat = nsIAbPreferMailFormat.unknown;</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineminus">-        }</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineminus">-        // dump(&quot;DetermineHTMLAction: preferFormat = &quot; + preferFormat + &quot;, noHtmlRecipients are &quot; + noHtmlRecipients + &quot;\n&quot;);</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineminus">-</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineminus">-        //Check newsgroups now...</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineminus">-        let noHtmlnewsgroups = gMsgCompose.compFields.newsgroups;</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineminus">-        if (noHtmlRecipients || noHtmlnewsgroups)</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineminus">-        {</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineminus">-            if (convertible == nsIMsgCompConvertible.Plain)</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineminus">-              return nsIMsgCompSendFormat.PlainText;</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineminus">-</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineminus">-            if (!noHtmlnewsgroups)</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineminus">-            {</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineminus">-                switch (preferFormat)</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineminus">-                {</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineminus">-                  case nsIAbPreferMailFormat.plaintext :</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineminus">-                    return nsIMsgCompSendFormat.PlainText;</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineminus">-</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineminus">-                  default :</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineminus">-                    //See if a preference has been set to tell us what to do. Note that we do not honor that</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineminus">-                    //preference for newsgroups. Only for e-mail addresses.</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineminus">-                    var action = getPref(&quot;mail.default_html_action&quot;);</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineminus">-                    switch (action)</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineminus">-                    {</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineminus">-                        case nsIMsgCompSendFormat.PlainText    :</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineminus">-                        case nsIMsgCompSendFormat.HTML         :</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineminus">-                        case nsIMsgCompSendFormat.Both         :</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineminus">-                            return action;</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineminus">-                    }</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineminus">-                }</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineminus">-            }</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineminus">-            return nsIMsgCompSendFormat.AskUser;</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineminus">-        }</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineminus">-</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineminus">-        return nsIMsgCompSendFormat.HTML;</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineminus">-    }</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineminus">-</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineminus">-    return gSendFormat;</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineplus">+  if (!gMsgCompose.composeHTML)</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineplus">+    return nsIMsgCompSendFormat.PlainText;</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineplus">+</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineplus">+  if (gSendFormat == nsIMsgCompSendFormat.AskUser)</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineplus">+    return gMsgCompose.determineHTMLAction(convertible);</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineplus">+</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineplus">+  return gSendFormat;</span>
<a href="#l1.71"></a><span id="l1.71"> }</span>
<a href="#l1.72"></a><span id="l1.72"> </span>
<a href="#l1.73"></a><span id="l1.73"> /**</span>
<a href="#l1.74"></a><span id="l1.74">  * Expands mailinglists found in the recipient fields.</span>
<a href="#l1.75"></a><span id="l1.75">  */</span>
<a href="#l1.76"></a><span id="l1.76"> function expandRecipients()</span>
<a href="#l1.77"></a><span id="l1.77"> {</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineminus">-  let dummyObj = new Object();</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineminus">-  gMsgCompose.checkAndPopulateRecipients(true, false, dummyObj);</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineminus">-}</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineminus">-</span>
<a href="#l1.82"></a><span id="l1.82" class="difflineminus">-/**</span>
<a href="#l1.83"></a><span id="l1.83" class="difflineminus">- * Returns recipients that prefer to get messages in plain text.</span>
<a href="#l1.84"></a><span id="l1.84" class="difflineminus">- */</span>
<a href="#l1.85"></a><span id="l1.85" class="difflineminus">-function getNonHtmlRecipients()</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineminus">-{</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineminus">-  let recipients = new Object();</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineminus">-  gMsgCompose.checkAndPopulateRecipients(true, true, recipients);</span>
<a href="#l1.89"></a><span id="l1.89" class="difflineminus">-  return recipients.value;</span>
<a href="#l1.90"></a><span id="l1.90" class="difflineplus">+  gMsgCompose.expandMailingLists();</span>
<a href="#l1.91"></a><span id="l1.91"> }</span>
<a href="#l1.92"></a><span id="l1.92"> </span>
<a href="#l1.93"></a><span id="l1.93"> function DetermineConvertibility()</span>
<a href="#l1.94"></a><span id="l1.94"> {</span>
<a href="#l1.95"></a><span id="l1.95">     if (!gMsgCompose.composeHTML)</span>
<a href="#l1.96"></a><span id="l1.96">         return nsIMsgCompConvertible.Plain;</span>
<a href="#l1.97"></a><span id="l1.97"> </span>
<a href="#l1.98"></a><span id="l1.98">     try {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/compose/public/nsIMsgCompose.idl</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/compose/public/nsIMsgCompose.idl</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -94,17 +94,17 @@ native nsString(nsString);</span>
<a href="#l2.4"></a><span id="l2.4"> </span>
<a href="#l2.5"></a><span id="l2.5"> /* recycling listener interface */</span>
<a href="#l2.6"></a><span id="l2.6"> [scriptable, uuid(0b28cc56-1dd2-11b2-bbe4-99e6a314f8ba)]</span>
<a href="#l2.7"></a><span id="l2.7"> interface nsIMsgComposeRecyclingListener : nsISupports {</span>
<a href="#l2.8"></a><span id="l2.8">   void onClose();</span>
<a href="#l2.9"></a><span id="l2.9">   void onReopen(in nsIMsgComposeParams params);</span>
<a href="#l2.10"></a><span id="l2.10"> };</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-[scriptable, uuid(6d04ec94-0277-45f0-b71a-08606ad24916)]</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+[scriptable, uuid(3408e025-e74c-4610-9c96-c4b8627ec678)]</span>
<a href="#l2.14"></a><span id="l2.14"> interface nsIMsgCompose : nsIMsgSendListener {</span>
<a href="#l2.15"></a><span id="l2.15"> </span>
<a href="#l2.16"></a><span id="l2.16">   /**</span>
<a href="#l2.17"></a><span id="l2.17">    * Initializes the msg compose object.</span>
<a href="#l2.18"></a><span id="l2.18">    *</span>
<a href="#l2.19"></a><span id="l2.19">    * @param aParams   An nsIMsgComposeParams object containing the initial</span>
<a href="#l2.20"></a><span id="l2.20">    *                  details for the compose.</span>
<a href="#l2.21"></a><span id="l2.21">    * @param aWindow   The optional window associated with this compose object.</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineat">@@ -140,33 +140,32 @@ interface nsIMsgCompose : nsIMsgSendList</span>
<a href="#l2.23"></a><span id="l2.23">     AttachmentPrettyName will return only the leafName if the it's a file URL.</span>
<a href="#l2.24"></a><span id="l2.24">     It will also convert the filename to Unicode assuming it's in  the file system </span>
<a href="#l2.25"></a><span id="l2.25">     charset. In case of URL, |charset| parameter will be used in the conversion.</span>
<a href="#l2.26"></a><span id="l2.26">     This UI utility function should probably go into it's own class</span>
<a href="#l2.27"></a><span id="l2.27">   */</span>
<a href="#l2.28"></a><span id="l2.28">   AUTF8String AttachmentPrettyName(in AUTF8String url, in string charset);</span>
<a href="#l2.29"></a><span id="l2.29"> </span>
<a href="#l2.30"></a><span id="l2.30">   /**</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-   * checkAndPopulateRecipients can perform several tasks (see params), the</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">-   * main task is to determine the lowest common format preferred by recipients.</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+   * Expand all mailing lists in the relevant compose fields to include the</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+   * members of their output. This method will additionally update the</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+   * popularity field of cards in the addressing header.</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+   */</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+  void expandMailingLists();</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+  /**</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+   * Returns how we should send this message in terms of HTML, plaintext, or</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+   * both. Note that this method should not be called until after mailing lists</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+   * have been expanded if correct results are desired.</span>
<a href="#l2.43"></a><span id="l2.43">    *</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineminus">-   * @param aPopulateMailList        If true, this function will populate</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineminus">-   *                                 mailing lists present in the compose field.</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineminus">-   * @param aReturnNonHTMLRecipients If true, will build a list of the non</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineminus">-   *                                 HTML receipients.</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineminus">-   * @param aNonHTMLRecipients       This will contain any non-HTML recipients,</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineminus">-   *                                 if aReturnNonHTMLRecipients is true</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineminus">-   *                                 (comma-separated).</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineminus">-   * @return                         The lowest common format preferred by</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineminus">-   *                                 recipients (unknown, plaintext or html).</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineminus">-   *                                 See nsIAbPreferMailFormat.</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineplus">+   * @param aConvertible The convertability of the body (from</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+   *                     nsIMsgCompConvertible).</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineplus">+   * @return             The HTML action to use (from nsIMsgCompSendFormat).</span>
<a href="#l2.57"></a><span id="l2.57">    */</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineminus">-  unsigned long checkAndPopulateRecipients(in boolean aPopulateMailList,</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineminus">-                                           in boolean aReturnNonHTMLRecipients,</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineminus">-                                           out AString aNonHTMLRecipients);</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineplus">+  long determineHTMLAction(in long aConvertible);</span>
<a href="#l2.62"></a><span id="l2.62"> </span>
<a href="#l2.63"></a><span id="l2.63">   /* bodyConvertible: The level of &quot;convertibility&quot; to plaintext</span>
<a href="#l2.64"></a><span id="l2.64">    * @return a value from nsIMsgCompConvertible.</span>
<a href="#l2.65"></a><span id="l2.65">   */</span>
<a href="#l2.66"></a><span id="l2.66">   long bodyConvertible();</span>
<a href="#l2.67"></a><span id="l2.67"> </span>
<a href="#l2.68"></a><span id="l2.68">   /**</span>
<a href="#l2.69"></a><span id="l2.69">    * The identity currently selected for the message compose object. When set</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgCompFields.cpp</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgCompFields.cpp</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -539,22 +539,19 @@ nsresult nsMsgCompFields::SplitRecipient</span>
<a href="#l3.4"></a><span id="l3.4"> {</span>
<a href="#l3.5"></a><span id="l3.5">   nsTArray&lt;nsString&gt; names, addresses;</span>
<a href="#l3.6"></a><span id="l3.6">   ExtractAllAddresses(EncodedHeader(NS_ConvertUTF16toUTF8(recipients)), names,</span>
<a href="#l3.7"></a><span id="l3.7">     addresses);</span>
<a href="#l3.8"></a><span id="l3.8"> </span>
<a href="#l3.9"></a><span id="l3.9">   uint32_t numAddresses = names.Length();</span>
<a href="#l3.10"></a><span id="l3.10">   for (uint32_t i = 0; i &lt; numAddresses; ++i)</span>
<a href="#l3.11"></a><span id="l3.11">   {</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-    nsString fullAddress;</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-    MakeMimeAddress(names[i], addresses[i], fullAddress);</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-</span>
<a href="#l3.15"></a><span id="l3.15">     nsMsgRecipient msgRecipient;</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineminus">-    msgRecipient.mAddress = fullAddress;</span>
<a href="#l3.17"></a><span id="l3.17">     msgRecipient.mEmail = addresses[i];</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+    msgRecipient.mName = names[i];</span>
<a href="#l3.19"></a><span id="l3.19">     aResult.AppendElement(msgRecipient);</span>
<a href="#l3.20"></a><span id="l3.20">   }</span>
<a href="#l3.21"></a><span id="l3.21"> </span>
<a href="#l3.22"></a><span id="l3.22">   return NS_OK;</span>
<a href="#l3.23"></a><span id="l3.23"> }</span>
<a href="#l3.24"></a><span id="l3.24"> </span>
<a href="#l3.25"></a><span id="l3.25"> NS_IMETHODIMP nsMsgCompFields::ConvertBodyToPlainText()</span>
<a href="#l3.26"></a><span id="l3.26"> {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgCompFields.h</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgCompFields.h</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -4,40 +4,28 @@</span>
<a href="#l4.4"></a><span id="l4.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l4.5"></a><span id="l4.5"> </span>
<a href="#l4.6"></a><span id="l4.6"> #ifndef _MsgCompFields_H_</span>
<a href="#l4.7"></a><span id="l4.7"> #define _MsgCompFields_H_</span>
<a href="#l4.8"></a><span id="l4.8"> </span>
<a href="#l4.9"></a><span id="l4.9"> #include &quot;nsIMsgCompFields.h&quot;</span>
<a href="#l4.10"></a><span id="l4.10"> #include &quot;msgCore.h&quot;</span>
<a href="#l4.11"></a><span id="l4.11"> #include &quot;nsIAbCard.h&quot;</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+#include &quot;nsIAbDirectory.h&quot;</span>
<a href="#l4.13"></a><span id="l4.13"> #include &quot;nsTArray.h&quot;</span>
<a href="#l4.14"></a><span id="l4.14"> #include &quot;nsCOMArray.h&quot;</span>
<a href="#l4.15"></a><span id="l4.15"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l4.16"></a><span id="l4.16"> #include &quot;nsStringGlue.h&quot;</span>
<a href="#l4.17"></a><span id="l4.17"> </span>
<a href="#l4.18"></a><span id="l4.18"> struct nsMsgRecipient</span>
<a href="#l4.19"></a><span id="l4.19"> {</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineminus">-  nsMsgRecipient() : mPreferFormat(nsIAbPreferMailFormat::unknown),</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineminus">-                     mProcessed(false) {}</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineminus">-</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineminus">-  nsMsgRecipient(const nsMsgRecipient &amp;other)</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineminus">-  {</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineminus">-    mAddress = other.mAddress;</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineminus">-    mEmail = other.mEmail;</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineminus">-    mPreferFormat = other.mPreferFormat;</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineminus">-    mProcessed = other.mProcessed;</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineminus">-  }</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineminus">-</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">-  ~nsMsgRecipient() {}</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineminus">-</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineminus">-  nsString mAddress;</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+  nsString mName;</span>
<a href="#l4.35"></a><span id="l4.35">   nsString mEmail;</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineminus">-  uint32_t mPreferFormat;</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineminus">-  uint32_t mProcessed;</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+  nsCOMPtr&lt;nsIAbCard&gt; mCard;</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+  nsCOMPtr&lt;nsIAbDirectory&gt; mDirectory;</span>
<a href="#l4.40"></a><span id="l4.40"> };</span>
<a href="#l4.41"></a><span id="l4.41"> </span>
<a href="#l4.42"></a><span id="l4.42"> /* Note that all the &quot;Get&quot; methods never return NULL (except in case of serious</span>
<a href="#l4.43"></a><span id="l4.43">    error, like an illegal parameter); rather, they return &quot;&quot; if things were set</span>
<a href="#l4.44"></a><span id="l4.44">    to NULL.  This makes it real handy for the callers. */</span>
<a href="#l4.45"></a><span id="l4.45"> </span>
<a href="#l4.46"></a><span id="l4.46"> class nsMsgCompFields : public nsIMsgCompFields {</span>
<a href="#l4.47"></a><span id="l4.47"> public:</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgCompose.cpp</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgCompose.cpp</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -4632,52 +4632,33 @@ nsresult nsMsgCompose::BuildMailListArra</span>
<a href="#l5.4"></a><span id="l5.4">       }</span>
<a href="#l5.5"></a><span id="l5.5">     }</span>
<a href="#l5.6"></a><span id="l5.6">   }</span>
<a href="#l5.7"></a><span id="l5.7">   return rv;</span>
<a href="#l5.8"></a><span id="l5.8"> }</span>
<a href="#l5.9"></a><span id="l5.9"> </span>
<a href="#l5.10"></a><span id="l5.10"> struct nsMsgMailListComparator</span>
<a href="#l5.11"></a><span id="l5.11"> {</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-  bool Equals(const nsMsgMailList&amp; mailList, const nsString&amp; name) const {</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-    return mailList.mFullName.Equals(name, nsCaseInsensitiveStringComparator());</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+  bool Equals(const nsMsgMailList &amp;mailList,</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+              const nsMsgRecipient &amp;recipient) const {</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+    if (mailList.mName.Equals(recipient.mName,</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+        nsCaseInsensitiveStringComparator()))</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+      return true;</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+    return mailList.mDescription.Equals(</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+      recipient.mEmail.IsEmpty() ? recipient.mName : recipient.mEmail,</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineplus">+      nsCaseInsensitiveStringComparator());</span>
<a href="#l5.22"></a><span id="l5.22">   }</span>
<a href="#l5.23"></a><span id="l5.23"> };</span>
<a href="#l5.24"></a><span id="l5.24"> </span>
<a href="#l5.25"></a><span id="l5.25" class="difflineminus">-nsresult nsMsgCompose::GetMailListAddresses(nsString&amp; name, nsTArray&lt;nsMsgMailList&gt;&amp; mailListArray, nsIMutableArray** addressesArray)</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineplus">+nsresult</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineplus">+nsMsgCompose::LookupAddressBook(RecipientsArray &amp;recipientsList)</span>
<a href="#l5.28"></a><span id="l5.28"> {</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineminus">-  uint32_t index = mailListArray.IndexOf(name, 0, nsMsgMailListComparator());</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineminus">-  if (index != mailListArray.NoIndex &amp;&amp;</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineminus">-      mailListArray[index].mDirectory)</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineminus">-    return mailListArray[index].mDirectory-&gt;GetAddressLists(addressesArray);</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineminus">-</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineminus">-  return NS_ERROR_FAILURE;</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineminus">-}</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineminus">-</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineminus">-</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineminus">-// 3 = To, Cc, Bcc</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineminus">-#define MAX_OF_RECIPIENT_ARRAY    3</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineminus">-</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineminus">-nsMsgCompose::CheckAndPopulateRecipients(bool aPopulateMailList,</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineminus">-                                         bool aReturnNonHTMLRecipients,</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineminus">-                                         nsAString &amp;aNonHTMLRecipients,</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineminus">-                                         uint32_t *aResult)</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineminus">-{</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineminus">-</span>
<a href="#l5.49"></a><span id="l5.49">   nsresult rv = NS_OK;</span>
<a href="#l5.50"></a><span id="l5.50"> </span>
<a href="#l5.51"></a><span id="l5.51" class="difflineminus">-  aNonHTMLRecipients.Truncate();</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineminus">-</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineminus">-  if (aResult)</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineminus">-    *aResult = nsIAbPreferMailFormat::unknown;</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineminus">-</span>
<a href="#l5.56"></a><span id="l5.56">   // First, build some arrays with the original recipients.</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineminus">-  nsTArray&lt;nsMsgRecipient&gt; recipientsList[MAX_OF_RECIPIENT_ARRAY];</span>
<a href="#l5.58"></a><span id="l5.58"> </span>
<a href="#l5.59"></a><span id="l5.59">   nsAutoString originalRecipients[MAX_OF_RECIPIENT_ARRAY];</span>
<a href="#l5.60"></a><span id="l5.60">   m_compFields-&gt;GetTo(originalRecipients[0]);</span>
<a href="#l5.61"></a><span id="l5.61">   m_compFields-&gt;GetCc(originalRecipients[1]);</span>
<a href="#l5.62"></a><span id="l5.62">   m_compFields-&gt;GetBcc(originalRecipients[2]);</span>
<a href="#l5.63"></a><span id="l5.63"> </span>
<a href="#l5.64"></a><span id="l5.64">   uint32_t i, j, k;</span>
<a href="#l5.65"></a><span id="l5.65"> </span>
<a href="#l5.66"></a><span id="l5.66" class="difflineat">@@ -4690,17 +4671,16 @@ nsMsgCompose::CheckAndPopulateRecipients</span>
<a href="#l5.67"></a><span id="l5.67">                                          recipientsList[i]);</span>
<a href="#l5.68"></a><span id="l5.68">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.69"></a><span id="l5.69">   }</span>
<a href="#l5.70"></a><span id="l5.70"> </span>
<a href="#l5.71"></a><span id="l5.71">   // Then look them up in the Addressbooks</span>
<a href="#l5.72"></a><span id="l5.72">   bool stillNeedToSearch = true;</span>
<a href="#l5.73"></a><span id="l5.73">   nsCOMPtr&lt;nsIAbDirectory&gt; abDirectory;</span>
<a href="#l5.74"></a><span id="l5.74">   nsCOMPtr&lt;nsIAbCard&gt; existingCard;</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; mailListAddresses;</span>
<a href="#l5.76"></a><span id="l5.76">   nsTArray&lt;nsMsgMailList&gt; mailListArray;</span>
<a href="#l5.77"></a><span id="l5.77"> </span>
<a href="#l5.78"></a><span id="l5.78">   nsCOMArray&lt;nsIAbDirectory&gt; addrbookDirArray;</span>
<a href="#l5.79"></a><span id="l5.79">   rv = GetABDirectories(NS_LITERAL_CSTRING(kAllDirectoryRoot),</span>
<a href="#l5.80"></a><span id="l5.80">                         addrbookDirArray);</span>
<a href="#l5.81"></a><span id="l5.81">   if (NS_SUCCEEDED(rv))</span>
<a href="#l5.82"></a><span id="l5.82">   {</span>
<a href="#l5.83"></a><span id="l5.83">     nsString dirPath;</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineat">@@ -4711,16 +4691,18 @@ nsMsgCompose::CheckAndPopulateRecipients</span>
<a href="#l5.85"></a><span id="l5.85">       // Avoid recursive mailing lists</span>
<a href="#l5.86"></a><span id="l5.86">       if (abDirectory &amp;&amp; (addrbookDirArray[k] == abDirectory))</span>
<a href="#l5.87"></a><span id="l5.87">       {</span>
<a href="#l5.88"></a><span id="l5.88">         stillNeedToSearch = false;</span>
<a href="#l5.89"></a><span id="l5.89">         break;</span>
<a href="#l5.90"></a><span id="l5.90">       }</span>
<a href="#l5.91"></a><span id="l5.91"> </span>
<a href="#l5.92"></a><span id="l5.92">       abDirectory = addrbookDirArray[k];</span>
<a href="#l5.93"></a><span id="l5.93" class="difflineplus">+      if (!abDirectory)</span>
<a href="#l5.94"></a><span id="l5.94" class="difflineplus">+        continue;</span>
<a href="#l5.95"></a><span id="l5.95"> </span>
<a href="#l5.96"></a><span id="l5.96">       bool supportsMailingLists;</span>
<a href="#l5.97"></a><span id="l5.97">       rv = abDirectory-&gt;GetSupportsMailingLists(&amp;supportsMailingLists);</span>
<a href="#l5.98"></a><span id="l5.98">       if (NS_FAILED(rv) || !supportsMailingLists)</span>
<a href="#l5.99"></a><span id="l5.99">         continue;</span>
<a href="#l5.100"></a><span id="l5.100"> </span>
<a href="#l5.101"></a><span id="l5.101">       // Ensure the existing list is empty before filling it</span>
<a href="#l5.102"></a><span id="l5.102">       mailListArray.Clear();</span>
<a href="#l5.103"></a><span id="l5.103" class="difflineat">@@ -4732,280 +4714,303 @@ nsMsgCompose::CheckAndPopulateRecipients</span>
<a href="#l5.104"></a><span id="l5.104"> </span>
<a href="#l5.105"></a><span id="l5.105">       stillNeedToSearch = false;</span>
<a href="#l5.106"></a><span id="l5.106">       for (i = 0; i &lt; MAX_OF_RECIPIENT_ARRAY; i ++)</span>
<a href="#l5.107"></a><span id="l5.107">       {</span>
<a href="#l5.108"></a><span id="l5.108">         // Note: We check this each time to allow for length changes.</span>
<a href="#l5.109"></a><span id="l5.109">         for (j = 0; j &lt; recipientsList[i].Length(); ++j)</span>
<a href="#l5.110"></a><span id="l5.110">         {</span>
<a href="#l5.111"></a><span id="l5.111">           nsMsgRecipient &amp;recipient = recipientsList[i][j];</span>
<a href="#l5.112"></a><span id="l5.112" class="difflineminus">-          if (!recipient.mProcessed)</span>
<a href="#l5.113"></a><span id="l5.113" class="difflineplus">+          if (!recipient.mDirectory)</span>
<a href="#l5.114"></a><span id="l5.114">           {</span>
<a href="#l5.115"></a><span id="l5.115">             // First check if it's a mailing list</span>
<a href="#l5.116"></a><span id="l5.116" class="difflineminus">-            if (NS_SUCCEEDED(GetMailListAddresses(recipient.mAddress,</span>
<a href="#l5.117"></a><span id="l5.117" class="difflineminus">-                                                  mailListArray,</span>
<a href="#l5.118"></a><span id="l5.118" class="difflineminus">-                                                  getter_AddRefs(mailListAddresses))))</span>
<a href="#l5.119"></a><span id="l5.119" class="difflineplus">+            uint32_t index = mailListArray.IndexOf(recipient, 0,</span>
<a href="#l5.120"></a><span id="l5.120" class="difflineplus">+              nsMsgMailListComparator());</span>
<a href="#l5.121"></a><span id="l5.121" class="difflineplus">+            if (index != mailListArray.NoIndex &amp;&amp;</span>
<a href="#l5.122"></a><span id="l5.122" class="difflineplus">+                mailListArray[index].mDirectory)</span>
<a href="#l5.123"></a><span id="l5.123">             {</span>
<a href="#l5.124"></a><span id="l5.124" class="difflineminus">-              // It is, so populate it if we are required to do so.</span>
<a href="#l5.125"></a><span id="l5.125" class="difflineminus">-              if (aPopulateMailList)</span>
<a href="#l5.126"></a><span id="l5.126" class="difflineminus">-              {</span>
<a href="#l5.127"></a><span id="l5.127" class="difflineminus">-                  uint32_t nbrAddresses = 0;</span>
<a href="#l5.128"></a><span id="l5.128" class="difflineminus">-                  for (mailListAddresses-&gt;GetLength(&amp;nbrAddresses); nbrAddresses &gt; 0; nbrAddresses --)</span>
<a href="#l5.129"></a><span id="l5.129" class="difflineminus">-                  {</span>
<a href="#l5.130"></a><span id="l5.130" class="difflineminus">-                    existingCard = do_QueryElementAt(mailListAddresses,</span>
<a href="#l5.131"></a><span id="l5.131" class="difflineminus">-                                                     nbrAddresses - 1, &amp;rv);</span>
<a href="#l5.132"></a><span id="l5.132" class="difflineminus">-                    if (NS_FAILED(rv))</span>
<a href="#l5.133"></a><span id="l5.133" class="difflineminus">-                      return rv;</span>
<a href="#l5.134"></a><span id="l5.134" class="difflineminus">-</span>
<a href="#l5.135"></a><span id="l5.135" class="difflineminus">-                    nsMsgRecipient newRecipient;</span>
<a href="#l5.136"></a><span id="l5.136" class="difflineminus">-                    nsAutoString pDisplayName;</span>
<a href="#l5.137"></a><span id="l5.137" class="difflineminus">-</span>
<a href="#l5.138"></a><span id="l5.138" class="difflineminus">-                    bool bIsMailList;</span>
<a href="#l5.139"></a><span id="l5.139" class="difflineminus">-                    rv = existingCard-&gt;GetIsMailList(&amp;bIsMailList);</span>
<a href="#l5.140"></a><span id="l5.140" class="difflineminus">-                    if (NS_FAILED(rv))</span>
<a href="#l5.141"></a><span id="l5.141" class="difflineminus">-                      return rv;</span>
<a href="#l5.142"></a><span id="l5.142" class="difflineminus">-</span>
<a href="#l5.143"></a><span id="l5.143" class="difflineminus">-                    rv = existingCard-&gt;GetDisplayName(pDisplayName);</span>
<a href="#l5.144"></a><span id="l5.144" class="difflineminus">-                    if (NS_FAILED(rv))</span>
<a href="#l5.145"></a><span id="l5.145" class="difflineminus">-                      return rv;</span>
<a href="#l5.146"></a><span id="l5.146" class="difflineminus">-</span>
<a href="#l5.147"></a><span id="l5.147" class="difflineminus">-                    if (bIsMailList)</span>
<a href="#l5.148"></a><span id="l5.148" class="difflineminus">-                      rv = existingCard-&gt;GetPropertyAsAString(kNotesProperty, newRecipient.mEmail);</span>
<a href="#l5.149"></a><span id="l5.149" class="difflineminus">-                    else</span>
<a href="#l5.150"></a><span id="l5.150" class="difflineminus">-                      rv = existingCard-&gt;GetPrimaryEmail(newRecipient.mEmail);</span>
<a href="#l5.151"></a><span id="l5.151" class="difflineminus">-</span>
<a href="#l5.152"></a><span id="l5.152" class="difflineminus">-                    if (NS_FAILED(rv))</span>
<a href="#l5.153"></a><span id="l5.153" class="difflineminus">-                      return rv;</span>
<a href="#l5.154"></a><span id="l5.154" class="difflineminus">-</span>
<a href="#l5.155"></a><span id="l5.155" class="difflineminus">-                    MakeMimeAddress(pDisplayName, newRecipient.mEmail,</span>
<a href="#l5.156"></a><span id="l5.156" class="difflineminus">-                                    newRecipient.mAddress);</span>
<a href="#l5.157"></a><span id="l5.157" class="difflineminus">-</span>
<a href="#l5.158"></a><span id="l5.158" class="difflineminus">-                    if (newRecipient.mAddress.IsEmpty())</span>
<a href="#l5.159"></a><span id="l5.159" class="difflineminus">-                    {</span>
<a href="#l5.160"></a><span id="l5.160" class="difflineminus">-                      // oops, parser problem! I will try to do my best...</span>
<a href="#l5.161"></a><span id="l5.161" class="difflineminus">-                      newRecipient.mAddress = pDisplayName;</span>
<a href="#l5.162"></a><span id="l5.162" class="difflineminus">-                      newRecipient.mAddress.AppendLiteral(&quot; &lt;&quot;);</span>
<a href="#l5.163"></a><span id="l5.163" class="difflineminus">-                      if (bIsMailList)</span>
<a href="#l5.164"></a><span id="l5.164" class="difflineminus">-                      {</span>
<a href="#l5.165"></a><span id="l5.165" class="difflineminus">-                        if (!newRecipient.mEmail.IsEmpty())</span>
<a href="#l5.166"></a><span id="l5.166" class="difflineminus">-                          newRecipient.mAddress += newRecipient.mEmail;</span>
<a href="#l5.167"></a><span id="l5.167" class="difflineminus">-                        else</span>
<a href="#l5.168"></a><span id="l5.168" class="difflineminus">-                          newRecipient.mAddress += pDisplayName;</span>
<a href="#l5.169"></a><span id="l5.169" class="difflineminus">-                      }</span>
<a href="#l5.170"></a><span id="l5.170" class="difflineminus">-                      else</span>
<a href="#l5.171"></a><span id="l5.171" class="difflineminus">-                        newRecipient.mAddress += newRecipient.mEmail;</span>
<a href="#l5.172"></a><span id="l5.172" class="difflineminus">-                      newRecipient.mAddress.Append(char16_t('&gt;'));</span>
<a href="#l5.173"></a><span id="l5.173" class="difflineminus">-                    }</span>
<a href="#l5.174"></a><span id="l5.174" class="difflineminus">-</span>
<a href="#l5.175"></a><span id="l5.175" class="difflineminus">-                    if (newRecipient.mAddress.IsEmpty())</span>
<a href="#l5.176"></a><span id="l5.176" class="difflineminus">-                      continue;</span>
<a href="#l5.177"></a><span id="l5.177" class="difflineminus">-</span>
<a href="#l5.178"></a><span id="l5.178" class="difflineminus">-                    // Now we need to insert the new address into the list of</span>
<a href="#l5.179"></a><span id="l5.179" class="difflineminus">-                    // recipient</span>
<a href="#l5.180"></a><span id="l5.180" class="difflineminus">-                    if (bIsMailList)</span>
<a href="#l5.181"></a><span id="l5.181" class="difflineminus">-                    {</span>
<a href="#l5.182"></a><span id="l5.182" class="difflineminus">-                      stillNeedToSearch = true;</span>
<a href="#l5.183"></a><span id="l5.183" class="difflineminus">-                    }</span>
<a href="#l5.184"></a><span id="l5.184" class="difflineminus">-                    else</span>
<a href="#l5.185"></a><span id="l5.185" class="difflineminus">-                    {</span>
<a href="#l5.186"></a><span id="l5.186" class="difflineminus">-                      newRecipient.mPreferFormat = nsIAbPreferMailFormat::unknown;</span>
<a href="#l5.187"></a><span id="l5.187" class="difflineminus">-                      rv = existingCard-&gt;GetPropertyAsUint32(</span>
<a href="#l5.188"></a><span id="l5.188" class="difflineminus">-                          kPreferMailFormatProperty, &amp;newRecipient.mPreferFormat);</span>
<a href="#l5.189"></a><span id="l5.189" class="difflineminus">-                      if (NS_SUCCEEDED(rv))</span>
<a href="#l5.190"></a><span id="l5.190" class="difflineminus">-                        newRecipient.mProcessed = true;</span>
<a href="#l5.191"></a><span id="l5.191" class="difflineminus">-                    }</span>
<a href="#l5.192"></a><span id="l5.192" class="difflineminus">-                    rv = recipientsList[i].InsertElementAt(j + 1, newRecipient) ? NS_OK : NS_ERROR_FAILURE;</span>
<a href="#l5.193"></a><span id="l5.193" class="difflineminus">-                    if (NS_FAILED(rv))</span>
<a href="#l5.194"></a><span id="l5.194" class="difflineminus">-                      return rv;</span>
<a href="#l5.195"></a><span id="l5.195" class="difflineminus">-                  }</span>
<a href="#l5.196"></a><span id="l5.196" class="difflineminus">-                  recipientsList[i].RemoveElementAt(j);</span>
<a href="#l5.197"></a><span id="l5.197" class="difflineminus">-                 --j;</span>
<a href="#l5.198"></a><span id="l5.198" class="difflineminus">-              }</span>
<a href="#l5.199"></a><span id="l5.199" class="difflineminus">-              else</span>
<a href="#l5.200"></a><span id="l5.200" class="difflineminus">-                recipient.mProcessed = true;</span>
<a href="#l5.201"></a><span id="l5.201" class="difflineminus">-</span>
<a href="#l5.202"></a><span id="l5.202" class="difflineminus">-              continue;</span>
<a href="#l5.203"></a><span id="l5.203" class="difflineminus">-            }</span>
<a href="#l5.204"></a><span id="l5.204" class="difflineminus">-</span>
<a href="#l5.205"></a><span id="l5.205" class="difflineminus">-            if (!abDirectory)</span>
<a href="#l5.206"></a><span id="l5.206" class="difflineminus">-            {</span>
<a href="#l5.207"></a><span id="l5.207" class="difflineminus">-              stillNeedToSearch = true;</span>
<a href="#l5.208"></a><span id="l5.208" class="difflineplus">+              recipient.mDirectory = mailListArray[index].mDirectory;</span>
<a href="#l5.209"></a><span id="l5.209">               continue;</span>
<a href="#l5.210"></a><span id="l5.210">             }</span>
<a href="#l5.211"></a><span id="l5.211"> </span>
<a href="#l5.212"></a><span id="l5.212">             // find a card that contains this e-mail address</span>
<a href="#l5.213"></a><span id="l5.213">             rv = abDirectory-&gt;CardForEmailAddress(NS_ConvertUTF16toUTF8(recipient.mEmail),</span>
<a href="#l5.214"></a><span id="l5.214">                                                   getter_AddRefs(existingCard));</span>
<a href="#l5.215"></a><span id="l5.215"> </span>
<a href="#l5.216"></a><span id="l5.216">             if (NS_SUCCEEDED(rv) &amp;&amp; existingCard)</span>
<a href="#l5.217"></a><span id="l5.217">             {</span>
<a href="#l5.218"></a><span id="l5.218" class="difflineminus">-              recipient.mPreferFormat = nsIAbPreferMailFormat::unknown;</span>
<a href="#l5.219"></a><span id="l5.219" class="difflineminus">-              rv = existingCard-&gt;GetPropertyAsUint32(kPreferMailFormatProperty,</span>
<a href="#l5.220"></a><span id="l5.220" class="difflineminus">-                                                     &amp;recipient.mPreferFormat);</span>
<a href="#l5.221"></a><span id="l5.221" class="difflineminus">-              if (NS_SUCCEEDED(rv))</span>
<a href="#l5.222"></a><span id="l5.222" class="difflineminus">-                recipient.mProcessed = true;</span>
<a href="#l5.223"></a><span id="l5.223" class="difflineminus">-</span>
<a href="#l5.224"></a><span id="l5.224" class="difflineminus">-              bool readOnly;</span>
<a href="#l5.225"></a><span id="l5.225" class="difflineminus">-              rv = abDirectory-&gt;GetReadOnly(&amp;readOnly);</span>
<a href="#l5.226"></a><span id="l5.226" class="difflineminus">-              NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l5.227"></a><span id="l5.227" class="difflineminus">-</span>
<a href="#l5.228"></a><span id="l5.228" class="difflineminus">-              // bump the popularity index for this card since we are about to send e-mail to it</span>
<a href="#l5.229"></a><span id="l5.229" class="difflineminus">-              uint32_t popularityIndex = 0;</span>
<a href="#l5.230"></a><span id="l5.230" class="difflineminus">-              if (!readOnly)</span>
<a href="#l5.231"></a><span id="l5.231" class="difflineminus">-              {</span>
<a href="#l5.232"></a><span id="l5.232" class="difflineminus">-                if (NS_FAILED(existingCard-&gt;GetPropertyAsUint32(</span>
<a href="#l5.233"></a><span id="l5.233" class="difflineminus">-                      kPopularityIndexProperty, &amp;popularityIndex)))</span>
<a href="#l5.234"></a><span id="l5.234" class="difflineminus">-                {</span>
<a href="#l5.235"></a><span id="l5.235" class="difflineminus">-                  // TB 2 wrote the popularity value as hex, so if we get here,</span>
<a href="#l5.236"></a><span id="l5.236" class="difflineminus">-                  // then we've probably got a hex value. We'll convert it back</span>
<a href="#l5.237"></a><span id="l5.237" class="difflineminus">-                  // to decimal, as that's the best we can do.</span>
<a href="#l5.238"></a><span id="l5.238" class="difflineminus">-</span>
<a href="#l5.239"></a><span id="l5.239" class="difflineminus">-                  nsCString hexPopularity;</span>
<a href="#l5.240"></a><span id="l5.240" class="difflineminus">-                  if (NS_SUCCEEDED(existingCard-&gt;GetPropertyAsAUTF8String(kPopularityIndexProperty, hexPopularity)))</span>
<a href="#l5.241"></a><span id="l5.241" class="difflineminus">-                  {</span>
<a href="#l5.242"></a><span id="l5.242" class="difflineminus">-                    nsresult errorCode = NS_OK;</span>
<a href="#l5.243"></a><span id="l5.243" class="difflineminus">-                    popularityIndex = hexPopularity.ToInteger(&amp;errorCode, 16);</span>
<a href="#l5.244"></a><span id="l5.244" class="difflineminus">-                    if (NS_FAILED(errorCode))</span>
<a href="#l5.245"></a><span id="l5.245" class="difflineminus">-                      // We failed, just set it to zero.</span>
<a href="#l5.246"></a><span id="l5.246" class="difflineminus">-                      popularityIndex = 0;</span>
<a href="#l5.247"></a><span id="l5.247" class="difflineminus">-                  }</span>
<a href="#l5.248"></a><span id="l5.248" class="difflineminus">-                  else</span>
<a href="#l5.249"></a><span id="l5.249" class="difflineminus">-                    // We couldn't get it as a string either, so just reset to</span>
<a href="#l5.250"></a><span id="l5.250" class="difflineminus">-                    // zero.</span>
<a href="#l5.251"></a><span id="l5.251" class="difflineminus">-                    popularityIndex = 0;</span>
<a href="#l5.252"></a><span id="l5.252" class="difflineminus">-                }</span>
<a href="#l5.253"></a><span id="l5.253" class="difflineminus">-</span>
<a href="#l5.254"></a><span id="l5.254" class="difflineminus">-                existingCard-&gt;SetPropertyAsUint32(kPopularityIndexProperty,</span>
<a href="#l5.255"></a><span id="l5.255" class="difflineminus">-                                                  ++popularityIndex);</span>
<a href="#l5.256"></a><span id="l5.256" class="difflineminus">-                abDirectory-&gt;ModifyCard(existingCard);</span>
<a href="#l5.257"></a><span id="l5.257" class="difflineminus">-              }</span>
<a href="#l5.258"></a><span id="l5.258" class="difflineplus">+              recipient.mCard = existingCard;</span>
<a href="#l5.259"></a><span id="l5.259" class="difflineplus">+              recipient.mDirectory = abDirectory;</span>
<a href="#l5.260"></a><span id="l5.260">             }</span>
<a href="#l5.261"></a><span id="l5.261">             else</span>
<a href="#l5.262"></a><span id="l5.262">               stillNeedToSearch = true;</span>
<a href="#l5.263"></a><span id="l5.263">           }</span>
<a href="#l5.264"></a><span id="l5.264">         }</span>
<a href="#l5.265"></a><span id="l5.265">       }</span>
<a href="#l5.266"></a><span id="l5.266">     }</span>
<a href="#l5.267"></a><span id="l5.267">   }</span>
<a href="#l5.268"></a><span id="l5.268"> </span>
<a href="#l5.269"></a><span id="l5.269" class="difflineplus">+  return rv;</span>
<a href="#l5.270"></a><span id="l5.270" class="difflineplus">+}</span>
<a href="#l5.271"></a><span id="l5.271" class="difflineplus">+</span>
<a href="#l5.272"></a><span id="l5.272" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l5.273"></a><span id="l5.273" class="difflineplus">+nsMsgCompose::ExpandMailingLists()</span>
<a href="#l5.274"></a><span id="l5.274" class="difflineplus">+{</span>
<a href="#l5.275"></a><span id="l5.275" class="difflineplus">+  RecipientsArray recipientsList;</span>
<a href="#l5.276"></a><span id="l5.276" class="difflineplus">+  nsresult rv = LookupAddressBook(recipientsList);</span>
<a href="#l5.277"></a><span id="l5.277" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.278"></a><span id="l5.278" class="difflineplus">+</span>
<a href="#l5.279"></a><span id="l5.279" class="difflineplus">+  // Reset the final headers with the expanded mailing lists.</span>
<a href="#l5.280"></a><span id="l5.280" class="difflineplus">+  nsAutoString recipientsStr;</span>
<a href="#l5.281"></a><span id="l5.281" class="difflineplus">+</span>
<a href="#l5.282"></a><span id="l5.282" class="difflineplus">+  for (int i = 0; i &lt; MAX_OF_RECIPIENT_ARRAY; ++i)</span>
<a href="#l5.283"></a><span id="l5.283" class="difflineplus">+  {</span>
<a href="#l5.284"></a><span id="l5.284" class="difflineplus">+    uint32_t nbrRecipients = recipientsList[i].Length();</span>
<a href="#l5.285"></a><span id="l5.285" class="difflineplus">+    if (nbrRecipients == 0)</span>
<a href="#l5.286"></a><span id="l5.286" class="difflineplus">+      continue;</span>
<a href="#l5.287"></a><span id="l5.287" class="difflineplus">+    recipientsStr.Truncate();</span>
<a href="#l5.288"></a><span id="l5.288" class="difflineplus">+</span>
<a href="#l5.289"></a><span id="l5.289" class="difflineplus">+    // Note: We check this each time to allow for length changes.</span>
<a href="#l5.290"></a><span id="l5.290" class="difflineplus">+    for (uint32_t j = 0; j &lt; recipientsList[i].Length(); ++j)</span>
<a href="#l5.291"></a><span id="l5.291" class="difflineplus">+    {</span>
<a href="#l5.292"></a><span id="l5.292" class="difflineplus">+      nsMsgRecipient &amp;recipient = recipientsList[i][j];</span>
<a href="#l5.293"></a><span id="l5.293" class="difflineplus">+</span>
<a href="#l5.294"></a><span id="l5.294" class="difflineplus">+      // First check if it's a mailing list</span>
<a href="#l5.295"></a><span id="l5.295" class="difflineplus">+      if (recipient.mDirectory &amp;&amp; !recipient.mCard)</span>
<a href="#l5.296"></a><span id="l5.296" class="difflineplus">+      {</span>
<a href="#l5.297"></a><span id="l5.297" class="difflineplus">+        // Grab a ref to the directory--we're appending to the nsTArray, which</span>
<a href="#l5.298"></a><span id="l5.298" class="difflineplus">+        // can invalidate the reference to recipient underneath us.</span>
<a href="#l5.299"></a><span id="l5.299" class="difflineplus">+        nsCOMPtr&lt;nsIAbDirectory&gt; directory(recipient.mDirectory);</span>
<a href="#l5.300"></a><span id="l5.300" class="difflineplus">+        nsCOMPtr&lt;nsIMutableArray&gt; mailListAddresses;</span>
<a href="#l5.301"></a><span id="l5.301" class="difflineplus">+        rv = directory-&gt;GetAddressLists(</span>
<a href="#l5.302"></a><span id="l5.302" class="difflineplus">+          getter_AddRefs(mailListAddresses));</span>
<a href="#l5.303"></a><span id="l5.303" class="difflineplus">+        if (NS_FAILED(rv))</span>
<a href="#l5.304"></a><span id="l5.304" class="difflineplus">+          continue;</span>
<a href="#l5.305"></a><span id="l5.305" class="difflineplus">+</span>
<a href="#l5.306"></a><span id="l5.306" class="difflineplus">+        uint32_t nbrAddresses = 0;</span>
<a href="#l5.307"></a><span id="l5.307" class="difflineplus">+        for (mailListAddresses-&gt;GetLength(&amp;nbrAddresses); nbrAddresses &gt; 0;</span>
<a href="#l5.308"></a><span id="l5.308" class="difflineplus">+            nbrAddresses--)</span>
<a href="#l5.309"></a><span id="l5.309" class="difflineplus">+        {</span>
<a href="#l5.310"></a><span id="l5.310" class="difflineplus">+          nsCOMPtr&lt;nsIAbCard&gt; existingCard(do_QueryElementAt(mailListAddresses,</span>
<a href="#l5.311"></a><span id="l5.311" class="difflineplus">+                                           nbrAddresses - 1, &amp;rv));</span>
<a href="#l5.312"></a><span id="l5.312" class="difflineplus">+          NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.313"></a><span id="l5.313" class="difflineplus">+</span>
<a href="#l5.314"></a><span id="l5.314" class="difflineplus">+          nsMsgRecipient newRecipient;</span>
<a href="#l5.315"></a><span id="l5.315" class="difflineplus">+          bool bIsMailList;</span>
<a href="#l5.316"></a><span id="l5.316" class="difflineplus">+          rv = existingCard-&gt;GetIsMailList(&amp;bIsMailList);</span>
<a href="#l5.317"></a><span id="l5.317" class="difflineplus">+          NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.318"></a><span id="l5.318" class="difflineplus">+</span>
<a href="#l5.319"></a><span id="l5.319" class="difflineplus">+          NS_ASSERTION(!bIsMailList,</span>
<a href="#l5.320"></a><span id="l5.320" class="difflineplus">+             &quot;Bug 40301 means we don't support this feature.&quot;);</span>
<a href="#l5.321"></a><span id="l5.321" class="difflineplus">+</span>
<a href="#l5.322"></a><span id="l5.322" class="difflineplus">+          rv = existingCard-&gt;GetDisplayName(newRecipient.mName);</span>
<a href="#l5.323"></a><span id="l5.323" class="difflineplus">+          NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.324"></a><span id="l5.324" class="difflineplus">+          rv = existingCard-&gt;GetPrimaryEmail(newRecipient.mEmail);</span>
<a href="#l5.325"></a><span id="l5.325" class="difflineplus">+          NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.326"></a><span id="l5.326" class="difflineplus">+</span>
<a href="#l5.327"></a><span id="l5.327" class="difflineplus">+          if (newRecipient.mName.IsEmpty() &amp;&amp; newRecipient.mEmail.IsEmpty())</span>
<a href="#l5.328"></a><span id="l5.328" class="difflineplus">+            continue;</span>
<a href="#l5.329"></a><span id="l5.329" class="difflineplus">+</span>
<a href="#l5.330"></a><span id="l5.330" class="difflineplus">+          // Now we need to insert the new address into the list of recipients.</span>
<a href="#l5.331"></a><span id="l5.331" class="difflineplus">+          newRecipient.mCard = existingCard;</span>
<a href="#l5.332"></a><span id="l5.332" class="difflineplus">+          newRecipient.mDirectory = directory;</span>
<a href="#l5.333"></a><span id="l5.333" class="difflineplus">+          recipientsList[i].InsertElementAt(j + 1, newRecipient);</span>
<a href="#l5.334"></a><span id="l5.334" class="difflineplus">+        }</span>
<a href="#l5.335"></a><span id="l5.335" class="difflineplus">+</span>
<a href="#l5.336"></a><span id="l5.336" class="difflineplus">+        // Remove the mailing list and process the cards we just exposed.</span>
<a href="#l5.337"></a><span id="l5.337" class="difflineplus">+        recipientsList[i].RemoveElementAt(j);</span>
<a href="#l5.338"></a><span id="l5.338" class="difflineplus">+        --j;</span>
<a href="#l5.339"></a><span id="l5.339" class="difflineplus">+        continue;</span>
<a href="#l5.340"></a><span id="l5.340" class="difflineplus">+      }</span>
<a href="#l5.341"></a><span id="l5.341" class="difflineplus">+</span>
<a href="#l5.342"></a><span id="l5.342" class="difflineplus">+      if (!recipientsStr.IsEmpty())</span>
<a href="#l5.343"></a><span id="l5.343" class="difflineplus">+        recipientsStr.Append(char16_t(','));</span>
<a href="#l5.344"></a><span id="l5.344" class="difflineplus">+      nsAutoString address;</span>
<a href="#l5.345"></a><span id="l5.345" class="difflineplus">+      MakeMimeAddress(recipient.mName, recipient.mEmail, address);</span>
<a href="#l5.346"></a><span id="l5.346" class="difflineplus">+      recipientsStr.Append(address);</span>
<a href="#l5.347"></a><span id="l5.347" class="difflineplus">+</span>
<a href="#l5.348"></a><span id="l5.348" class="difflineplus">+      if (recipient.mCard)</span>
<a href="#l5.349"></a><span id="l5.349" class="difflineplus">+      {</span>
<a href="#l5.350"></a><span id="l5.350" class="difflineplus">+        bool readOnly;</span>
<a href="#l5.351"></a><span id="l5.351" class="difflineplus">+        rv = recipient.mDirectory-&gt;GetReadOnly(&amp;readOnly);</span>
<a href="#l5.352"></a><span id="l5.352" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.353"></a><span id="l5.353" class="difflineplus">+</span>
<a href="#l5.354"></a><span id="l5.354" class="difflineplus">+        // Bump the popularity index for this card since we are about to send</span>
<a href="#l5.355"></a><span id="l5.355" class="difflineplus">+        // e-mail to it.</span>
<a href="#l5.356"></a><span id="l5.356" class="difflineplus">+        if (!readOnly)</span>
<a href="#l5.357"></a><span id="l5.357" class="difflineplus">+        {</span>
<a href="#l5.358"></a><span id="l5.358" class="difflineplus">+          uint32_t popularityIndex = 0;</span>
<a href="#l5.359"></a><span id="l5.359" class="difflineplus">+          if (NS_FAILED(recipient.mCard-&gt;GetPropertyAsUint32(</span>
<a href="#l5.360"></a><span id="l5.360" class="difflineplus">+                kPopularityIndexProperty, &amp;popularityIndex)))</span>
<a href="#l5.361"></a><span id="l5.361" class="difflineplus">+          {</span>
<a href="#l5.362"></a><span id="l5.362" class="difflineplus">+            // TB 2 wrote the popularity value as hex, so if we get here,</span>
<a href="#l5.363"></a><span id="l5.363" class="difflineplus">+            // then we've probably got a hex value. We'll convert it back</span>
<a href="#l5.364"></a><span id="l5.364" class="difflineplus">+            // to decimal, as that's the best we can do.</span>
<a href="#l5.365"></a><span id="l5.365" class="difflineplus">+</span>
<a href="#l5.366"></a><span id="l5.366" class="difflineplus">+            nsCString hexPopularity;</span>
<a href="#l5.367"></a><span id="l5.367" class="difflineplus">+            if (NS_SUCCEEDED(recipient.mCard-&gt;GetPropertyAsAUTF8String(</span>
<a href="#l5.368"></a><span id="l5.368" class="difflineplus">+                kPopularityIndexProperty, hexPopularity)))</span>
<a href="#l5.369"></a><span id="l5.369" class="difflineplus">+            {</span>
<a href="#l5.370"></a><span id="l5.370" class="difflineplus">+              nsresult errorCode = NS_OK;</span>
<a href="#l5.371"></a><span id="l5.371" class="difflineplus">+              popularityIndex = hexPopularity.ToInteger(&amp;errorCode, 16);</span>
<a href="#l5.372"></a><span id="l5.372" class="difflineplus">+              if (NS_FAILED(errorCode))</span>
<a href="#l5.373"></a><span id="l5.373" class="difflineplus">+                // We failed, just set it to zero.</span>
<a href="#l5.374"></a><span id="l5.374" class="difflineplus">+                popularityIndex = 0;</span>
<a href="#l5.375"></a><span id="l5.375" class="difflineplus">+            }</span>
<a href="#l5.376"></a><span id="l5.376" class="difflineplus">+            else</span>
<a href="#l5.377"></a><span id="l5.377" class="difflineplus">+              // We couldn't get it as a string either, so just reset to zero.</span>
<a href="#l5.378"></a><span id="l5.378" class="difflineplus">+              popularityIndex = 0;</span>
<a href="#l5.379"></a><span id="l5.379" class="difflineplus">+          }</span>
<a href="#l5.380"></a><span id="l5.380" class="difflineplus">+</span>
<a href="#l5.381"></a><span id="l5.381" class="difflineplus">+          recipient.mCard-&gt;SetPropertyAsUint32(kPopularityIndexProperty,</span>
<a href="#l5.382"></a><span id="l5.382" class="difflineplus">+                                               ++popularityIndex);</span>
<a href="#l5.383"></a><span id="l5.383" class="difflineplus">+          recipient.mDirectory-&gt;ModifyCard(recipient.mCard);</span>
<a href="#l5.384"></a><span id="l5.384" class="difflineplus">+        }</span>
<a href="#l5.385"></a><span id="l5.385" class="difflineplus">+      }</span>
<a href="#l5.386"></a><span id="l5.386" class="difflineplus">+    }</span>
<a href="#l5.387"></a><span id="l5.387" class="difflineplus">+</span>
<a href="#l5.388"></a><span id="l5.388" class="difflineplus">+    switch (i)</span>
<a href="#l5.389"></a><span id="l5.389" class="difflineplus">+    {</span>
<a href="#l5.390"></a><span id="l5.390" class="difflineplus">+    case 0: m_compFields-&gt;SetTo(recipientsStr);  break;</span>
<a href="#l5.391"></a><span id="l5.391" class="difflineplus">+    case 1: m_compFields-&gt;SetCc(recipientsStr);  break;</span>
<a href="#l5.392"></a><span id="l5.392" class="difflineplus">+    case 2: m_compFields-&gt;SetBcc(recipientsStr); break;</span>
<a href="#l5.393"></a><span id="l5.393" class="difflineplus">+    }</span>
<a href="#l5.394"></a><span id="l5.394" class="difflineplus">+  }</span>
<a href="#l5.395"></a><span id="l5.395" class="difflineplus">+</span>
<a href="#l5.396"></a><span id="l5.396" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.397"></a><span id="l5.397" class="difflineplus">+}</span>
<a href="#l5.398"></a><span id="l5.398" class="difflineplus">+</span>
<a href="#l5.399"></a><span id="l5.399" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l5.400"></a><span id="l5.400" class="difflineplus">+nsMsgCompose::DetermineHTMLAction(int32_t aConvertible, int32_t *result)</span>
<a href="#l5.401"></a><span id="l5.401" class="difflineplus">+{</span>
<a href="#l5.402"></a><span id="l5.402" class="difflineplus">+  NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l5.403"></a><span id="l5.403" class="difflineplus">+</span>
<a href="#l5.404"></a><span id="l5.404" class="difflineplus">+  nsAutoString newsgroups;</span>
<a href="#l5.405"></a><span id="l5.405" class="difflineplus">+  m_compFields-&gt;GetNewsgroups(newsgroups);</span>
<a href="#l5.406"></a><span id="l5.406" class="difflineplus">+</span>
<a href="#l5.407"></a><span id="l5.407" class="difflineplus">+  // Right now, we don't have logic for newsgroups for intelligent send</span>
<a href="#l5.408"></a><span id="l5.408" class="difflineplus">+  // preferences. Therefore, bail out early and save us a lot of work if there</span>
<a href="#l5.409"></a><span id="l5.409" class="difflineplus">+  // are newsgroups.</span>
<a href="#l5.410"></a><span id="l5.410" class="difflineplus">+  if (!newsgroups.IsEmpty())</span>
<a href="#l5.411"></a><span id="l5.411" class="difflineplus">+  {</span>
<a href="#l5.412"></a><span id="l5.412" class="difflineplus">+    *result = nsIMsgCompSendFormat::AskUser;</span>
<a href="#l5.413"></a><span id="l5.413" class="difflineplus">+    return NS_OK;</span>
<a href="#l5.414"></a><span id="l5.414" class="difflineplus">+  }</span>
<a href="#l5.415"></a><span id="l5.415" class="difflineplus">+</span>
<a href="#l5.416"></a><span id="l5.416" class="difflineplus">+  RecipientsArray recipientsList;</span>
<a href="#l5.417"></a><span id="l5.417" class="difflineplus">+  nsresult rv = LookupAddressBook(recipientsList);</span>
<a href="#l5.418"></a><span id="l5.418" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.419"></a><span id="l5.419" class="difflineplus">+</span>
<a href="#l5.420"></a><span id="l5.420">   // Finally return the list of non HTML recipient if requested and/or rebuilt</span>
<a href="#l5.421"></a><span id="l5.421">   // the recipient field. Also, check for domain preference when preferFormat</span>
<a href="#l5.422"></a><span id="l5.422">   // is unknown</span>
<a href="#l5.423"></a><span id="l5.423" class="difflineminus">-  nsAutoString recipientsStr;</span>
<a href="#l5.424"></a><span id="l5.424" class="difflineminus">-  nsAutoString nonHtmlRecipientsStr;</span>
<a href="#l5.425"></a><span id="l5.425">   nsString plaintextDomains;</span>
<a href="#l5.426"></a><span id="l5.426">   nsString htmlDomains;</span>
<a href="#l5.427"></a><span id="l5.427"> </span>
<a href="#l5.428"></a><span id="l5.428" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch (do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l5.429"></a><span id="l5.429" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l5.430"></a><span id="l5.430">   if (prefBranch)</span>
<a href="#l5.431"></a><span id="l5.431">   {</span>
<a href="#l5.432"></a><span id="l5.432">     NS_GetUnicharPreferenceWithDefault(prefBranch, &quot;mailnews.plaintext_domains&quot;,</span>
<a href="#l5.433"></a><span id="l5.433">                                        EmptyString(), plaintextDomains);</span>
<a href="#l5.434"></a><span id="l5.434">     NS_GetUnicharPreferenceWithDefault(prefBranch, &quot;mailnews.html_domains&quot;,</span>
<a href="#l5.435"></a><span id="l5.435">                                        EmptyString(), htmlDomains);</span>
<a href="#l5.436"></a><span id="l5.436">   }</span>
<a href="#l5.437"></a><span id="l5.437"> </span>
<a href="#l5.438"></a><span id="l5.438" class="difflineminus">-  bool atLeastOneRecipientPrefersUnknown = false;</span>
<a href="#l5.439"></a><span id="l5.439" class="difflineminus">-  bool atLeastOneRecipientPrefersPlainText = false;</span>
<a href="#l5.440"></a><span id="l5.440" class="difflineminus">-  bool atLeastOneRecipientPrefersHTML = false;</span>
<a href="#l5.441"></a><span id="l5.441" class="difflineminus">-</span>
<a href="#l5.442"></a><span id="l5.442" class="difflineminus">-  for (i = 0; i &lt; MAX_OF_RECIPIENT_ARRAY; ++i)</span>
<a href="#l5.443"></a><span id="l5.443" class="difflineplus">+  // If allHtml is true, then everyone has specifically requested to receive</span>
<a href="#l5.444"></a><span id="l5.444" class="difflineplus">+  // HTML according to the address book.</span>
<a href="#l5.445"></a><span id="l5.445" class="difflineplus">+  bool allHtml = true;</span>
<a href="#l5.446"></a><span id="l5.446" class="difflineplus">+  bool allPlain = true;</span>
<a href="#l5.447"></a><span id="l5.447" class="difflineplus">+</span>
<a href="#l5.448"></a><span id="l5.448" class="difflineplus">+  // Exit the loop early if allHtml and allPlain both decay to false to save us</span>
<a href="#l5.449"></a><span id="l5.449" class="difflineplus">+  // some work.</span>
<a href="#l5.450"></a><span id="l5.450" class="difflineplus">+  for (int i = 0; i &lt; MAX_OF_RECIPIENT_ARRAY &amp;&amp; (allHtml || allPlain); ++i)</span>
<a href="#l5.451"></a><span id="l5.451">   {</span>
<a href="#l5.452"></a><span id="l5.452">     uint32_t nbrRecipients = recipientsList[i].Length();</span>
<a href="#l5.453"></a><span id="l5.453" class="difflineminus">-    if (nbrRecipients == 0)</span>
<a href="#l5.454"></a><span id="l5.454" class="difflineminus">-      continue;</span>
<a href="#l5.455"></a><span id="l5.455" class="difflineminus">-    recipientsStr.Truncate();</span>
<a href="#l5.456"></a><span id="l5.456" class="difflineminus">-</span>
<a href="#l5.457"></a><span id="l5.457" class="difflineminus">-    for (j = 0; j &lt; nbrRecipients; ++j)</span>
<a href="#l5.458"></a><span id="l5.458" class="difflineplus">+    for (uint32_t j = 0; j &lt; nbrRecipients &amp;&amp; (allHtml || allPlain); ++j)</span>
<a href="#l5.459"></a><span id="l5.459">     {</span>
<a href="#l5.460"></a><span id="l5.460">       nsMsgRecipient &amp;recipient = recipientsList[i][j];</span>
<a href="#l5.461"></a><span id="l5.461" class="difflineplus">+      uint32_t preferFormat = nsIAbPreferMailFormat::unknown;</span>
<a href="#l5.462"></a><span id="l5.462" class="difflineplus">+      if (recipient.mCard)</span>
<a href="#l5.463"></a><span id="l5.463" class="difflineplus">+      {</span>
<a href="#l5.464"></a><span id="l5.464" class="difflineplus">+        recipient.mCard-&gt;GetPropertyAsUint32(kPreferMailFormatProperty,</span>
<a href="#l5.465"></a><span id="l5.465" class="difflineplus">+          &amp;preferFormat);</span>
<a href="#l5.466"></a><span id="l5.466" class="difflineplus">+      }</span>
<a href="#l5.467"></a><span id="l5.467"> </span>
<a href="#l5.468"></a><span id="l5.468">       // if we don't have a prefer format for a recipient, check the domain in</span>
<a href="#l5.469"></a><span id="l5.469">       // case we have a format defined for it</span>
<a href="#l5.470"></a><span id="l5.470" class="difflineminus">-      if (recipient.mPreferFormat == nsIAbPreferMailFormat::unknown &amp;&amp;</span>
<a href="#l5.471"></a><span id="l5.471" class="difflineplus">+      if (preferFormat == nsIAbPreferMailFormat::unknown &amp;&amp;</span>
<a href="#l5.472"></a><span id="l5.472">           (!plaintextDomains.IsEmpty() || !htmlDomains.IsEmpty()))</span>
<a href="#l5.473"></a><span id="l5.473">       {</span>
<a href="#l5.474"></a><span id="l5.474">         int32_t atPos = recipient.mEmail.FindChar('@');</span>
<a href="#l5.475"></a><span id="l5.475">         if (atPos &lt; 0)</span>
<a href="#l5.476"></a><span id="l5.476">           continue;</span>
<a href="#l5.477"></a><span id="l5.477"> </span>
<a href="#l5.478"></a><span id="l5.478">         nsDependentSubstring emailDomain = Substring(recipient.mEmail,</span>
<a href="#l5.479"></a><span id="l5.479">                                                      atPos + 1);</span>
<a href="#l5.480"></a><span id="l5.480">         if (IsInDomainList(emailDomain, plaintextDomains))</span>
<a href="#l5.481"></a><span id="l5.481" class="difflineminus">-          recipient.mPreferFormat = nsIAbPreferMailFormat::plaintext;</span>
<a href="#l5.482"></a><span id="l5.482" class="difflineplus">+          preferFormat = nsIAbPreferMailFormat::plaintext;</span>
<a href="#l5.483"></a><span id="l5.483">         else if (IsInDomainList(emailDomain, htmlDomains))</span>
<a href="#l5.484"></a><span id="l5.484" class="difflineminus">-          recipient.mPreferFormat = nsIAbPreferMailFormat::html;</span>
<a href="#l5.485"></a><span id="l5.485" class="difflineplus">+          preferFormat = nsIAbPreferMailFormat::html;</span>
<a href="#l5.486"></a><span id="l5.486">       }</span>
<a href="#l5.487"></a><span id="l5.487"> </span>
<a href="#l5.488"></a><span id="l5.488" class="difflineminus">-      switch (recipient.mPreferFormat)</span>
<a href="#l5.489"></a><span id="l5.489" class="difflineplus">+      switch (preferFormat)</span>
<a href="#l5.490"></a><span id="l5.490">       {</span>
<a href="#l5.491"></a><span id="l5.491">       case nsIAbPreferMailFormat::html:</span>
<a href="#l5.492"></a><span id="l5.492" class="difflineminus">-        atLeastOneRecipientPrefersHTML = true;</span>
<a href="#l5.493"></a><span id="l5.493" class="difflineplus">+        allPlain = false;</span>
<a href="#l5.494"></a><span id="l5.494">         break;</span>
<a href="#l5.495"></a><span id="l5.495"> </span>
<a href="#l5.496"></a><span id="l5.496">       case nsIAbPreferMailFormat::plaintext:</span>
<a href="#l5.497"></a><span id="l5.497" class="difflineminus">-        atLeastOneRecipientPrefersPlainText = true;</span>
<a href="#l5.498"></a><span id="l5.498" class="difflineplus">+        allHtml = false;</span>
<a href="#l5.499"></a><span id="l5.499">         break;</span>
<a href="#l5.500"></a><span id="l5.500"> </span>
<a href="#l5.501"></a><span id="l5.501">       default: // nsIAbPreferMailFormat::unknown</span>
<a href="#l5.502"></a><span id="l5.502" class="difflineminus">-        atLeastOneRecipientPrefersUnknown = true;</span>
<a href="#l5.503"></a><span id="l5.503" class="difflineplus">+        allHtml = false;</span>
<a href="#l5.504"></a><span id="l5.504" class="difflineplus">+        allPlain = false;</span>
<a href="#l5.505"></a><span id="l5.505">         break;</span>
<a href="#l5.506"></a><span id="l5.506">       }</span>
<a href="#l5.507"></a><span id="l5.507" class="difflineminus">-</span>
<a href="#l5.508"></a><span id="l5.508" class="difflineminus">-      if (aPopulateMailList)</span>
<a href="#l5.509"></a><span id="l5.509" class="difflineminus">-      {</span>
<a href="#l5.510"></a><span id="l5.510" class="difflineminus">-        if (!recipientsStr.IsEmpty())</span>
<a href="#l5.511"></a><span id="l5.511" class="difflineminus">-          recipientsStr.Append(char16_t(','));</span>
<a href="#l5.512"></a><span id="l5.512" class="difflineminus">-        recipientsStr.Append(recipient.mAddress);</span>
<a href="#l5.513"></a><span id="l5.513" class="difflineminus">-      }</span>
<a href="#l5.514"></a><span id="l5.514" class="difflineminus">-</span>
<a href="#l5.515"></a><span id="l5.515" class="difflineminus">-      // Add recipients to the nonHtmlRecipient list if they haven't</span>
<a href="#l5.516"></a><span id="l5.516" class="difflineminus">-      // explicitly allowed it.</span>
<a href="#l5.517"></a><span id="l5.517" class="difflineminus">-      if (aReturnNonHTMLRecipients &amp;&amp;</span>
<a href="#l5.518"></a><span id="l5.518" class="difflineminus">-          recipient.mPreferFormat != nsIAbPreferMailFormat::html)</span>
<a href="#l5.519"></a><span id="l5.519" class="difflineminus">-      {</span>
<a href="#l5.520"></a><span id="l5.520" class="difflineminus">-        if (!nonHtmlRecipientsStr.IsEmpty())</span>
<a href="#l5.521"></a><span id="l5.521" class="difflineminus">-          nonHtmlRecipientsStr.Append(char16_t(','));</span>
<a href="#l5.522"></a><span id="l5.522" class="difflineminus">-        nonHtmlRecipientsStr.Append(recipient.mEmail);</span>
<a href="#l5.523"></a><span id="l5.523" class="difflineminus">-      }</span>
<a href="#l5.524"></a><span id="l5.524" class="difflineminus">-    }</span>
<a href="#l5.525"></a><span id="l5.525" class="difflineminus">-</span>
<a href="#l5.526"></a><span id="l5.526" class="difflineminus">-    if (aPopulateMailList)</span>
<a href="#l5.527"></a><span id="l5.527" class="difflineminus">-    {</span>
<a href="#l5.528"></a><span id="l5.528" class="difflineminus">-      switch (i)</span>
<a href="#l5.529"></a><span id="l5.529" class="difflineminus">-      {</span>
<a href="#l5.530"></a><span id="l5.530" class="difflineminus">-      case 0 : m_compFields-&gt;SetTo(recipientsStr);  break;</span>
<a href="#l5.531"></a><span id="l5.531" class="difflineminus">-      case 1 : m_compFields-&gt;SetCc(recipientsStr);  break;</span>
<a href="#l5.532"></a><span id="l5.532" class="difflineminus">-      case 2 : m_compFields-&gt;SetBcc(recipientsStr); break;</span>
<a href="#l5.533"></a><span id="l5.533" class="difflineminus">-      }</span>
<a href="#l5.534"></a><span id="l5.534">     }</span>
<a href="#l5.535"></a><span id="l5.535">   }</span>
<a href="#l5.536"></a><span id="l5.536"> </span>
<a href="#l5.537"></a><span id="l5.537" class="difflineminus">-  if (aReturnNonHTMLRecipients)</span>
<a href="#l5.538"></a><span id="l5.538" class="difflineminus">-    aNonHTMLRecipients = nonHtmlRecipientsStr;</span>
<a href="#l5.539"></a><span id="l5.539" class="difflineminus">-</span>
<a href="#l5.540"></a><span id="l5.540" class="difflineminus">-  if (atLeastOneRecipientPrefersUnknown)</span>
<a href="#l5.541"></a><span id="l5.541" class="difflineminus">-    *aResult = nsIAbPreferMailFormat::unknown;</span>
<a href="#l5.542"></a><span id="l5.542" class="difflineminus">-  else if (atLeastOneRecipientPrefersHTML)</span>
<a href="#l5.543"></a><span id="l5.543" class="difflineplus">+  // If everyone supports HTML, then return HTML.</span>
<a href="#l5.544"></a><span id="l5.544" class="difflineplus">+  if (allHtml)</span>
<a href="#l5.545"></a><span id="l5.545" class="difflineplus">+  {</span>
<a href="#l5.546"></a><span id="l5.546" class="difflineplus">+    *result = nsIMsgCompSendFormat::HTML;</span>
<a href="#l5.547"></a><span id="l5.547" class="difflineplus">+    return NS_OK;</span>
<a href="#l5.548"></a><span id="l5.548" class="difflineplus">+  }</span>
<a href="#l5.549"></a><span id="l5.549" class="difflineplus">+</span>
<a href="#l5.550"></a><span id="l5.550" class="difflineplus">+  // If we can guarantee that converting to plaintext is not lossy, send the</span>
<a href="#l5.551"></a><span id="l5.551" class="difflineplus">+  // email as plaintext. Also send it if everyone prefers plaintext.</span>
<a href="#l5.552"></a><span id="l5.552" class="difflineplus">+  if (aConvertible == nsIMsgCompConvertible::Plain || allPlain)</span>
<a href="#l5.553"></a><span id="l5.553">   {</span>
<a href="#l5.554"></a><span id="l5.554" class="difflineminus">-    // if we have at least one recipient that prefers html</span>
<a href="#l5.555"></a><span id="l5.555" class="difflineminus">-    // and at least one that recipients that prefers plain text</span>
<a href="#l5.556"></a><span id="l5.556" class="difflineminus">-    // we need to return unknown, so that we can prompt the user</span>
<a href="#l5.557"></a><span id="l5.557" class="difflineminus">-    if (atLeastOneRecipientPrefersPlainText)</span>
<a href="#l5.558"></a><span id="l5.558" class="difflineminus">-      *aResult = nsIAbPreferMailFormat::unknown;</span>
<a href="#l5.559"></a><span id="l5.559" class="difflineminus">-    else</span>
<a href="#l5.560"></a><span id="l5.560" class="difflineminus">-      *aResult = nsIAbPreferMailFormat::html;</span>
<a href="#l5.561"></a><span id="l5.561" class="difflineplus">+    *result = nsIMsgCompSendFormat::PlainText;</span>
<a href="#l5.562"></a><span id="l5.562" class="difflineplus">+    return NS_OK;</span>
<a href="#l5.563"></a><span id="l5.563">   }</span>
<a href="#l5.564"></a><span id="l5.564" class="difflineminus">-  else</span>
<a href="#l5.565"></a><span id="l5.565" class="difflineplus">+</span>
<a href="#l5.566"></a><span id="l5.566" class="difflineplus">+  // Otherwise, check the preference to see what action we should default to.</span>
<a href="#l5.567"></a><span id="l5.567" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; prefService(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l5.568"></a><span id="l5.568" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.569"></a><span id="l5.569" class="difflineplus">+</span>
<a href="#l5.570"></a><span id="l5.570" class="difflineplus">+  int32_t action = nsIMsgCompSendFormat::AskUser;</span>
<a href="#l5.571"></a><span id="l5.571" class="difflineplus">+  rv = prefService-&gt;GetIntPref(&quot;mail.default_html_action&quot;, &amp;action);</span>
<a href="#l5.572"></a><span id="l5.572" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.573"></a><span id="l5.573" class="difflineplus">+</span>
<a href="#l5.574"></a><span id="l5.574" class="difflineplus">+  // If the action is a known action, return that value. Otherwise, ask the</span>
<a href="#l5.575"></a><span id="l5.575" class="difflineplus">+  // user. Note that the preference defaults to 0, which is not a valid value</span>
<a href="#l5.576"></a><span id="l5.576" class="difflineplus">+  // for the enum.</span>
<a href="#l5.577"></a><span id="l5.577" class="difflineplus">+  if (action == nsIMsgCompSendFormat::PlainText ||</span>
<a href="#l5.578"></a><span id="l5.578" class="difflineplus">+      action == nsIMsgCompSendFormat::HTML ||</span>
<a href="#l5.579"></a><span id="l5.579" class="difflineplus">+      action == nsIMsgCompSendFormat::Both)</span>
<a href="#l5.580"></a><span id="l5.580">   {</span>
<a href="#l5.581"></a><span id="l5.581" class="difflineminus">-    NS_ASSERTION(atLeastOneRecipientPrefersPlainText, &quot;at least one should prefer plain text&quot;);</span>
<a href="#l5.582"></a><span id="l5.582" class="difflineminus">-    *aResult = nsIAbPreferMailFormat::plaintext;</span>
<a href="#l5.583"></a><span id="l5.583" class="difflineplus">+    *result = action;</span>
<a href="#l5.584"></a><span id="l5.584" class="difflineplus">+    return NS_OK;</span>
<a href="#l5.585"></a><span id="l5.585">   }</span>
<a href="#l5.586"></a><span id="l5.586"> </span>
<a href="#l5.587"></a><span id="l5.587" class="difflineminus">-  return rv;</span>
<a href="#l5.588"></a><span id="l5.588" class="difflineplus">+  // At this point, ask the user.</span>
<a href="#l5.589"></a><span id="l5.589" class="difflineplus">+  *result = nsIMsgCompSendFormat::AskUser;</span>
<a href="#l5.590"></a><span id="l5.590" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.591"></a><span id="l5.591"> }</span>
<a href="#l5.592"></a><span id="l5.592"> </span>
<a href="#l5.593"></a><span id="l5.593"> /* Decides which tags trigger which convertible mode, i.e. here is the logic</span>
<a href="#l5.594"></a><span id="l5.594">    for BodyConvertible */</span>
<a href="#l5.595"></a><span id="l5.595"> // Helper function. Parameters are not checked.</span>
<a href="#l5.596"></a><span id="l5.596"> nsresult nsMsgCompose::TagConvertible(nsIDOMNode *node,  int32_t *_retval)</span>
<a href="#l5.597"></a><span id="l5.597"> {</span>
<a href="#l5.598"></a><span id="l5.598">     nsresult rv;</span>
<a href="#l5.599"></a><span id="l5.599" class="difflineat">@@ -5425,30 +5430,16 @@ NS_IMETHODIMP nsMsgCompose::CheckCharset</span>
<a href="#l5.600"></a><span id="l5.600">   }</span>
<a href="#l5.601"></a><span id="l5.601"> </span>
<a href="#l5.602"></a><span id="l5.602">   return NS_OK;</span>
<a href="#l5.603"></a><span id="l5.603"> }</span>
<a href="#l5.604"></a><span id="l5.604"> </span>
<a href="#l5.605"></a><span id="l5.605"> nsMsgMailList::nsMsgMailList(nsIAbDirectory* directory) :</span>
<a href="#l5.606"></a><span id="l5.606">   mDirectory(directory)</span>
<a href="#l5.607"></a><span id="l5.607"> {</span>
<a href="#l5.608"></a><span id="l5.608" class="difflineminus">-  nsString listName, listDescription;</span>
<a href="#l5.609"></a><span id="l5.609" class="difflineminus">-  mDirectory-&gt;GetDirName(listName);</span>
<a href="#l5.610"></a><span id="l5.610" class="difflineminus">-  mDirectory-&gt;GetDescription(listDescription);</span>
<a href="#l5.611"></a><span id="l5.611" class="difflineminus">-</span>
<a href="#l5.612"></a><span id="l5.612" class="difflineminus">-  MakeDisplayAddress(listName,</span>
<a href="#l5.613"></a><span id="l5.613" class="difflineminus">-                     listDescription.IsEmpty() ? listName : listDescription,</span>
<a href="#l5.614"></a><span id="l5.614" class="difflineminus">-                     mFullName);</span>
<a href="#l5.615"></a><span id="l5.615" class="difflineminus">-</span>
<a href="#l5.616"></a><span id="l5.616" class="difflineminus">-  if (mFullName.IsEmpty())</span>
<a href="#l5.617"></a><span id="l5.617" class="difflineminus">-  {</span>
<a href="#l5.618"></a><span id="l5.618" class="difflineminus">-      //oops, parser problem! I will try to do my best...</span>
<a href="#l5.619"></a><span id="l5.619" class="difflineminus">-      mFullName = listName;</span>
<a href="#l5.620"></a><span id="l5.620" class="difflineminus">-      mFullName.AppendLiteral(&quot; &lt;&quot;);</span>
<a href="#l5.621"></a><span id="l5.621" class="difflineminus">-      if (listDescription.IsEmpty())</span>
<a href="#l5.622"></a><span id="l5.622" class="difflineminus">-        mFullName += listName;</span>
<a href="#l5.623"></a><span id="l5.623" class="difflineminus">-      else</span>
<a href="#l5.624"></a><span id="l5.624" class="difflineminus">-        mFullName += listDescription;</span>
<a href="#l5.625"></a><span id="l5.625" class="difflineminus">-      mFullName.Append(char16_t('&gt;'));</span>
<a href="#l5.626"></a><span id="l5.626" class="difflineminus">-  }</span>
<a href="#l5.627"></a><span id="l5.627" class="difflineplus">+  mDirectory-&gt;GetDirName(mName);</span>
<a href="#l5.628"></a><span id="l5.628" class="difflineplus">+  mDirectory-&gt;GetDescription(mDescription);</span>
<a href="#l5.629"></a><span id="l5.629" class="difflineplus">+</span>
<a href="#l5.630"></a><span id="l5.630" class="difflineplus">+  if (mDescription.IsEmpty())</span>
<a href="#l5.631"></a><span id="l5.631" class="difflineplus">+    mDescription = mName;</span>
<a href="#l5.632"></a><span id="l5.632"> </span>
<a href="#l5.633"></a><span id="l5.633">   mDirectory = directory;</span>
<a href="#l5.634"></a><span id="l5.634"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgCompose.h</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgCompose.h</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -79,22 +79,27 @@ private:</span>
<a href="#l6.4"></a><span id="l6.4">  private:</span>
<a href="#l6.5"></a><span id="l6.5">   nsresult _SendMsg(MSG_DeliverMode deliverMode, nsIMsgIdentity *identity, const char *accountKey);</span>
<a href="#l6.6"></a><span id="l6.6">   nsresult CreateMessage(const char * originalMsgURI, MSG_ComposeType type, nsIMsgCompFields* compFields);</span>
<a href="#l6.7"></a><span id="l6.7">   void CleanUpRecipients(nsString&amp; recipients);</span>
<a href="#l6.8"></a><span id="l6.8">   nsresult GetABDirectories(const nsACString&amp; aDirUri,</span>
<a href="#l6.9"></a><span id="l6.9">                             nsCOMArray&lt;nsIAbDirectory&gt; &amp;aDirArray);</span>
<a href="#l6.10"></a><span id="l6.10">   nsresult BuildMailListArray(nsIAbDirectory* parentDir,</span>
<a href="#l6.11"></a><span id="l6.11">                               nsTArray&lt;nsMsgMailList&gt;&amp; array);</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-  nsresult GetMailListAddresses(nsString&amp; name,</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-                                nsTArray&lt;nsMsgMailList&gt;&amp; mailListArray,</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-                                nsIMutableArray** addresses);</span>
<a href="#l6.15"></a><span id="l6.15">   nsresult TagConvertible(nsIDOMNode *node,  int32_t *_retval);</span>
<a href="#l6.16"></a><span id="l6.16">   nsresult _BodyConvertible(nsIDOMNode *node, int32_t *_retval);</span>
<a href="#l6.17"></a><span id="l6.17"> </span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+// 3 = To, Cc, Bcc</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+#define MAX_OF_RECIPIENT_ARRAY 3</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+  typedef nsTArray&lt;nsMsgRecipient&gt; RecipientsArray[MAX_OF_RECIPIENT_ARRAY];</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineplus">+  /**</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+   * This method parses the compose fields and associates email addresses with</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineplus">+   * the relevant cards from the address books.</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineplus">+   */</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineplus">+  nsresult LookupAddressBook(RecipientsArray &amp;recipientList);</span>
<a href="#l6.26"></a><span id="l6.26">   bool IsLastWindow();</span>
<a href="#l6.27"></a><span id="l6.27">  </span>
<a href="#l6.28"></a><span id="l6.28">        // Helper function. Parameters are not checked.</span>
<a href="#l6.29"></a><span id="l6.29">   bool                                      mConvertStructs;    // for TagConvertible</span>
<a href="#l6.30"></a><span id="l6.30">   </span>
<a href="#l6.31"></a><span id="l6.31"> 	nsCOMPtr&lt;nsIEditor&gt;                       m_editor;</span>
<a href="#l6.32"></a><span id="l6.32"> 	nsIDOMWindow                              *m_window;</span>
<a href="#l6.33"></a><span id="l6.33">   nsCOMPtr&lt;nsIDocShell&gt;                     mDocShell;</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineat">@@ -214,13 +219,14 @@ private:</span>
<a href="#l6.35"></a><span id="l6.35"> </span>
<a href="#l6.36"></a><span id="l6.36"> /******************************************************************************</span>
<a href="#l6.37"></a><span id="l6.37">  * nsMsgMailList</span>
<a href="#l6.38"></a><span id="l6.38">  ******************************************************************************/</span>
<a href="#l6.39"></a><span id="l6.39"> struct nsMsgMailList</span>
<a href="#l6.40"></a><span id="l6.40"> {</span>
<a href="#l6.41"></a><span id="l6.41">   explicit nsMsgMailList(nsIAbDirectory* directory);</span>
<a href="#l6.42"></a><span id="l6.42"> </span>
<a href="#l6.43"></a><span id="l6.43" class="difflineminus">-  nsString mFullName;  /* full email address (name + email) */</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineplus">+  nsString mName;</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineplus">+  nsString mDescription;</span>
<a href="#l6.46"></a><span id="l6.46">   nsCOMPtr&lt;nsIAbDirectory&gt; mDirectory;</span>
<a href="#l6.47"></a><span id="l6.47"> };</span>
<a href="#l6.48"></a><span id="l6.48"> </span>
<a href="#l6.49"></a><span id="l6.49"> #endif /* _nsMsgCompose_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_nsMsgCompose1.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_nsMsgCompose1.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -1,34 +1,29 @@</span>
<a href="#l7.4"></a><span id="l7.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l7.5"></a><span id="l7.5"> </span>
<a href="#l7.6"></a><span id="l7.6"> /**</span>
<a href="#l7.7"></a><span id="l7.7" class="difflineminus">- * Tests nsMsgCompose checkAndPopulateRecipients.</span>
<a href="#l7.8"></a><span id="l7.8" class="difflineplus">+ * Tests nsMsgCompose expandMailingLists.</span>
<a href="#l7.9"></a><span id="l7.9">  */</span>
<a href="#l7.10"></a><span id="l7.10"> </span>
<a href="#l7.11"></a><span id="l7.11"> const MsgComposeContractID = &quot;@mozilla.org/messengercompose/compose;1&quot;;</span>
<a href="#l7.12"></a><span id="l7.12"> const MsgComposeParamsContractID = &quot;@mozilla.org/messengercompose/composeparams;1&quot;;</span>
<a href="#l7.13"></a><span id="l7.13"> const MsgComposeFieldsContractID = &quot;@mozilla.org/messengercompose/composefields;1&quot;;</span>
<a href="#l7.14"></a><span id="l7.14"> const nsIMsgCompose = Components.interfaces.nsIMsgCompose;</span>
<a href="#l7.15"></a><span id="l7.15"> const nsIMsgComposeParams = Components.interfaces.nsIMsgComposeParams;</span>
<a href="#l7.16"></a><span id="l7.16"> const nsIMsgCompFields = Components.interfaces.nsIMsgCompFields;</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineminus">-const nsIAbPreferMailFormat = Components.interfaces.nsIAbPreferMailFormat;</span>
<a href="#l7.18"></a><span id="l7.18"> </span>
<a href="#l7.19"></a><span id="l7.19"> Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l7.20"></a><span id="l7.20"> </span>
<a href="#l7.21"></a><span id="l7.21"> /**</span>
<a href="#l7.22"></a><span id="l7.22">  * Helper to check population worked as expected.</span>
<a href="#l7.23"></a><span id="l7.23">  * @param aTo - text in the To field</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineminus">- * @param aNonHTMLRecipients - comma separated string of recipients that are</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineminus">- *                             expected to prefer HTML</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineminus">- * @param aPreferMailOut - |nsIAbPreferMailFormat| lowest common peferred</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineminus">- *                         format - unknown, plaintext or html</span>
<a href="#l7.28"></a><span id="l7.28">  * @param aCheckTo - the expected To addresses (after possible ist population)</span>
<a href="#l7.29"></a><span id="l7.29">  */</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineminus">-function checkPopulate(aTo, aNonHTMLRecipients, aPreferMailOut, aCheckTo)</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineplus">+function checkPopulate(aTo, aCheckTo)</span>
<a href="#l7.32"></a><span id="l7.32"> {</span>
<a href="#l7.33"></a><span id="l7.33">   var msgCompose = Components.classes[MsgComposeContractID]</span>
<a href="#l7.34"></a><span id="l7.34">                              .createInstance(nsIMsgCompose);</span>
<a href="#l7.35"></a><span id="l7.35"> </span>
<a href="#l7.36"></a><span id="l7.36">   // Set up some basic fields for compose.</span>
<a href="#l7.37"></a><span id="l7.37">   var fields = Components.classes[MsgComposeFieldsContractID]</span>
<a href="#l7.38"></a><span id="l7.38">                          .createInstance(nsIMsgCompFields);</span>
<a href="#l7.39"></a><span id="l7.39"> </span>
<a href="#l7.40"></a><span id="l7.40" class="difflineat">@@ -37,25 +32,18 @@ function checkPopulate(aTo, aNonHTMLReci</span>
<a href="#l7.41"></a><span id="l7.41">   // Set up some params</span>
<a href="#l7.42"></a><span id="l7.42">   var params = Components.classes[MsgComposeParamsContractID]</span>
<a href="#l7.43"></a><span id="l7.43">                          .createInstance(nsIMsgComposeParams);</span>
<a href="#l7.44"></a><span id="l7.44"> </span>
<a href="#l7.45"></a><span id="l7.45">   params.composeFields = fields;</span>
<a href="#l7.46"></a><span id="l7.46"> </span>
<a href="#l7.47"></a><span id="l7.47">   msgCompose.initialize(params);</span>
<a href="#l7.48"></a><span id="l7.48"> </span>
<a href="#l7.49"></a><span id="l7.49" class="difflineminus">-  var nonHTMLRecipients = new Object();</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineminus">-</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineminus">-  do_check_eq(msgCompose.checkAndPopulateRecipients(true, true,</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineminus">-                                                    nonHTMLRecipients),</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineminus">-              aPreferMailOut);</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineminus">-</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineplus">+  msgCompose.expandMailingLists();</span>
<a href="#l7.56"></a><span id="l7.56">   do_check_eq(fields.to, aCheckTo);</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineminus">-</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineminus">-  do_check_eq(nonHTMLRecipients.value, aNonHTMLRecipients);</span>
<a href="#l7.59"></a><span id="l7.59"> }</span>
<a href="#l7.60"></a><span id="l7.60"> </span>
<a href="#l7.61"></a><span id="l7.61"> function run_test() {</span>
<a href="#l7.62"></a><span id="l7.62">   // Test setup - copy the data files into place</span>
<a href="#l7.63"></a><span id="l7.63">   var testAB = do_get_file(&quot;../../../data/abLists1.mab&quot;);</span>
<a href="#l7.64"></a><span id="l7.64"> </span>
<a href="#l7.65"></a><span id="l7.65">   // Copy the file to the profile directory for a PAB</span>
<a href="#l7.66"></a><span id="l7.66">   testAB.copyTo(do_get_profile(), kPABData.fileName);</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineat">@@ -72,17 +60,17 @@ function run_test() {</span>
<a href="#l7.68"></a><span id="l7.68">                              .createInstance(nsIMsgCompose);</span>
<a href="#l7.69"></a><span id="l7.69"> </span>
<a href="#l7.70"></a><span id="l7.70">   // Set up some params</span>
<a href="#l7.71"></a><span id="l7.71">   var params = Components.classes[MsgComposeParamsContractID]</span>
<a href="#l7.72"></a><span id="l7.72">                          .createInstance(nsIMsgComposeParams);</span>
<a href="#l7.73"></a><span id="l7.73"> </span>
<a href="#l7.74"></a><span id="l7.74">   msgCompose.initialize(params);</span>
<a href="#l7.75"></a><span id="l7.75"> </span>
<a href="#l7.76"></a><span id="l7.76" class="difflineminus">-  // Test - checkAndPopulateRecipients basic functionality.</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineplus">+  // Test - expandMailingLists basic functionality.</span>
<a href="#l7.78"></a><span id="l7.78"> </span>
<a href="#l7.79"></a><span id="l7.79">   // Re-initialize</span>
<a href="#l7.80"></a><span id="l7.80">   msgCompose = Components.classes[MsgComposeContractID]</span>
<a href="#l7.81"></a><span id="l7.81">                          .createInstance(nsIMsgCompose);</span>
<a href="#l7.82"></a><span id="l7.82"> </span>
<a href="#l7.83"></a><span id="l7.83">   // Set up some basic fields for compose.</span>
<a href="#l7.84"></a><span id="l7.84">   var fields = Components.classes[MsgComposeFieldsContractID]</span>
<a href="#l7.85"></a><span id="l7.85">                          .createInstance(nsIMsgCompFields);</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineat">@@ -96,93 +84,61 @@ function run_test() {</span>
<a href="#l7.87"></a><span id="l7.87">   // Set up some params</span>
<a href="#l7.88"></a><span id="l7.88">   params = Components.classes[MsgComposeParamsContractID]</span>
<a href="#l7.89"></a><span id="l7.89">                      .createInstance(nsIMsgComposeParams);</span>
<a href="#l7.90"></a><span id="l7.90"> </span>
<a href="#l7.91"></a><span id="l7.91">   params.composeFields = fields;</span>
<a href="#l7.92"></a><span id="l7.92"> </span>
<a href="#l7.93"></a><span id="l7.93">   msgCompose.initialize(params);</span>
<a href="#l7.94"></a><span id="l7.94"> </span>
<a href="#l7.95"></a><span id="l7.95" class="difflineminus">-  var nonHTMLRecipients = new Object();</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineminus">-</span>
<a href="#l7.97"></a><span id="l7.97" class="difflineminus">-  do_check_eq(msgCompose.checkAndPopulateRecipients(true, false,</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineminus">-                                                    nonHTMLRecipients),</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineminus">-              nsIAbPreferMailFormat.unknown);</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineminus">-</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineminus">-  do_check_eq(nonHTMLRecipients.value, &quot;&quot;);</span>
<a href="#l7.102"></a><span id="l7.102" class="difflineminus">-</span>
<a href="#l7.103"></a><span id="l7.103" class="difflineminus">-  do_check_eq(msgCompose.checkAndPopulateRecipients(true, true,</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineminus">-                                                      nonHTMLRecipients),</span>
<a href="#l7.105"></a><span id="l7.105" class="difflineminus">-              nsIAbPreferMailFormat.unknown);</span>
<a href="#l7.106"></a><span id="l7.106" class="difflineminus">-</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineminus">-  do_check_eq(nonHTMLRecipients.value, &quot;test2@foo1.invalid,test3@foo1.invalid,test4@foo1.invalid&quot;);</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineminus">-</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineplus">+  msgCompose.expandMailingLists();</span>
<a href="#l7.110"></a><span id="l7.110">   do_check_eq(fields.to, &quot;test2@foo1.invalid&quot;);</span>
<a href="#l7.111"></a><span id="l7.111">   do_check_eq(fields.cc, &quot;test3@foo1.invalid&quot;);</span>
<a href="#l7.112"></a><span id="l7.112">   do_check_eq(fields.bcc, &quot;test4@foo1.invalid&quot;);</span>
<a href="#l7.113"></a><span id="l7.113"> </span>
<a href="#l7.114"></a><span id="l7.114" class="difflineminus">-  // Test - checkAndPopulateRecipients with plain text.</span>
<a href="#l7.115"></a><span id="l7.115" class="difflineplus">+  // Test - expandMailingLists with plain text.</span>
<a href="#l7.116"></a><span id="l7.116"> </span>
<a href="#l7.117"></a><span id="l7.117" class="difflineminus">-  checkPopulate(&quot;test4@foo.invalid&quot;, &quot;test4@foo.invalid&quot;,</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineminus">-                nsIAbPreferMailFormat.plaintext, &quot;test4@foo.invalid&quot;);</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineplus">+  checkPopulate(&quot;test4@foo.invalid&quot;, &quot;test4@foo.invalid&quot;);</span>
<a href="#l7.120"></a><span id="l7.120"> </span>
<a href="#l7.121"></a><span id="l7.121" class="difflineminus">-  // Test - checkAndPopulateRecipients with html.</span>
<a href="#l7.122"></a><span id="l7.122" class="difflineplus">+  // Test - expandMailingLists with html.</span>
<a href="#l7.123"></a><span id="l7.123"> </span>
<a href="#l7.124"></a><span id="l7.124" class="difflineminus">-  checkPopulate(&quot;test5@foo.invalid&quot;, &quot;&quot;, nsIAbPreferMailFormat.html,</span>
<a href="#l7.125"></a><span id="l7.125" class="difflineminus">-                &quot;test5@foo.invalid&quot;);</span>
<a href="#l7.126"></a><span id="l7.126" class="difflineplus">+  checkPopulate(&quot;test5@foo.invalid&quot;, &quot;test5@foo.invalid&quot;);</span>
<a href="#l7.127"></a><span id="l7.127"> </span>
<a href="#l7.128"></a><span id="l7.128" class="difflineminus">-  // Test - checkAndPopulateRecipients with a list of three items.</span>
<a href="#l7.129"></a><span id="l7.129" class="difflineplus">+  // Test - expandMailingLists with a list of three items.</span>
<a href="#l7.130"></a><span id="l7.130"> </span>
<a href="#l7.131"></a><span id="l7.131">   checkPopulate(&quot;TestList1 &lt;TestList1&gt;&quot;,</span>
<a href="#l7.132"></a><span id="l7.132" class="difflineminus">-                &quot;test1@foo.invalid,test2@foo.invalid,test3@foo.invalid&quot;,</span>
<a href="#l7.133"></a><span id="l7.133" class="difflineminus">-                nsIAbPreferMailFormat.unknown,</span>
<a href="#l7.134"></a><span id="l7.134">                 &quot;test1@foo.invalid,test2@foo.invalid,test3@foo.invalid&quot;);</span>
<a href="#l7.135"></a><span id="l7.135"> </span>
<a href="#l7.136"></a><span id="l7.136" class="difflineminus">-  // Test - checkAndPopulateRecipients with a list of one item.</span>
<a href="#l7.137"></a><span id="l7.137" class="difflineplus">+  // Test - expandMailingLists with a list of one item.</span>
<a href="#l7.138"></a><span id="l7.138"> </span>
<a href="#l7.139"></a><span id="l7.139" class="difflineminus">-  checkPopulate(&quot;TestList2 &lt;TestList2&gt;&quot;, &quot;test4@foo.invalid&quot;,</span>
<a href="#l7.140"></a><span id="l7.140" class="difflineminus">-                nsIAbPreferMailFormat.plaintext, &quot;test4@foo.invalid&quot;);</span>
<a href="#l7.141"></a><span id="l7.141" class="difflineplus">+  checkPopulate(&quot;TestList2 &lt;TestList2&gt;&quot;, &quot;test4@foo.invalid&quot;);</span>
<a href="#l7.142"></a><span id="l7.142"> </span>
<a href="#l7.143"></a><span id="l7.143" class="difflineminus">-  checkPopulate(&quot;TestList3 &lt;TestList3&gt;&quot;, &quot;&quot;,</span>
<a href="#l7.144"></a><span id="l7.144" class="difflineminus">-                nsIAbPreferMailFormat.html, &quot;test5@foo.invalid&quot;);</span>
<a href="#l7.145"></a><span id="l7.145" class="difflineplus">+  checkPopulate(&quot;TestList3 &lt;TestList3&gt;&quot;, &quot;test5@foo.invalid&quot;);</span>
<a href="#l7.146"></a><span id="l7.146"> </span>
<a href="#l7.147"></a><span id="l7.147" class="difflineminus">-  // Test checkAndPopulateRecipients w/ mailnews.html_domains set.</span>
<a href="#l7.148"></a><span id="l7.148" class="difflineplus">+  // Test expandMailingLists w/ mailnews.html_domains set.</span>
<a href="#l7.149"></a><span id="l7.149">   Services.prefs.setCharPref(&quot;mailnews.html_domains&quot;, &quot;foo.invalid,bar.invalid&quot;);</span>
<a href="#l7.150"></a><span id="l7.150">   checkPopulate(&quot;htmlformat@foo.invalid,unknownformat@nonfoo.invalid&quot;,</span>
<a href="#l7.151"></a><span id="l7.151" class="difflineminus">-                &quot;unknownformat@nonfoo.invalid&quot;,</span>
<a href="#l7.152"></a><span id="l7.152" class="difflineminus">-                nsIAbPreferMailFormat.unknown,</span>
<a href="#l7.153"></a><span id="l7.153">                 &quot;htmlformat@foo.invalid,unknownformat@nonfoo.invalid&quot;);</span>
<a href="#l7.154"></a><span id="l7.154">   Services.prefs.clearUserPref(&quot;mailnews.html_domains&quot;);</span>
<a href="#l7.155"></a><span id="l7.155"> </span>
<a href="#l7.156"></a><span id="l7.156" class="difflineminus">-  // Test checkAndPopulateRecipients w/ mailnews.plaintext_domains set.</span>
<a href="#l7.157"></a><span id="l7.157" class="difflineplus">+  // Test expandMailingLists w/ mailnews.plaintext_domains set.</span>
<a href="#l7.158"></a><span id="l7.158">   Services.prefs.setCharPref(&quot;mailnews.plaintext_domains&quot;, &quot;foo.invalid,bar.invalid&quot;);</span>
<a href="#l7.159"></a><span id="l7.159">   checkPopulate(&quot;plainformat@foo.invalid,unknownformat@nonfoo.invalid&quot;,</span>
<a href="#l7.160"></a><span id="l7.160" class="difflineminus">-                &quot;plainformat@foo.invalid,unknownformat@nonfoo.invalid&quot;,</span>
<a href="#l7.161"></a><span id="l7.161" class="difflineminus">-                nsIAbPreferMailFormat.unknown,</span>
<a href="#l7.162"></a><span id="l7.162">                 &quot;plainformat@foo.invalid,unknownformat@nonfoo.invalid&quot;);</span>
<a href="#l7.163"></a><span id="l7.163">   checkPopulate(&quot;plainformat@foo.invalid,plainformat@cc.bar.invalid&quot;,</span>
<a href="#l7.164"></a><span id="l7.164" class="difflineminus">-                &quot;plainformat@foo.invalid,plainformat@cc.bar.invalid&quot;,</span>
<a href="#l7.165"></a><span id="l7.165" class="difflineminus">-                nsIAbPreferMailFormat.plaintext,</span>
<a href="#l7.166"></a><span id="l7.166">                 &quot;plainformat@foo.invalid,plainformat@cc.bar.invalid&quot;);</span>
<a href="#l7.167"></a><span id="l7.167">   Services.prefs.clearUserPref(&quot;mailnews.plaintext_domains&quot;);</span>
<a href="#l7.168"></a><span id="l7.168"> </span>
<a href="#l7.169"></a><span id="l7.169" class="difflineminus">-  // Test - checkAndPopulateRecipients with items from multiple address books.</span>
<a href="#l7.170"></a><span id="l7.170" class="difflineplus">+  // Test - expandMailingLists with items from multiple address books.</span>
<a href="#l7.171"></a><span id="l7.171"> </span>
<a href="#l7.172"></a><span id="l7.172">   checkPopulate(&quot;TestList1 &lt;TestList1&gt;, test3@com.invalid&quot;,</span>
<a href="#l7.173"></a><span id="l7.173" class="difflineminus">-                &quot;test1@foo.invalid,test2@foo.invalid,test3@foo.invalid,test3@com.invalid&quot;,</span>
<a href="#l7.174"></a><span id="l7.174" class="difflineminus">-                nsIAbPreferMailFormat.unknown,</span>
<a href="#l7.175"></a><span id="l7.175">                 &quot;test1@foo.invalid,test2@foo.invalid,test3@foo.invalid,test3@com.invalid&quot;);</span>
<a href="#l7.176"></a><span id="l7.176"> </span>
<a href="#l7.177"></a><span id="l7.177">   checkPopulate(&quot;TestList2 &lt;TestList2&gt;, ListTest2 &lt;ListTest2&gt;&quot;,</span>
<a href="#l7.178"></a><span id="l7.178" class="difflineminus">-                &quot;test4@foo.invalid,test4@com.invalid&quot;,</span>
<a href="#l7.179"></a><span id="l7.179" class="difflineminus">-                nsIAbPreferMailFormat.plaintext,</span>
<a href="#l7.180"></a><span id="l7.180">                 &quot;test4@foo.invalid,test4@com.invalid&quot;);</span>
<a href="#l7.181"></a><span id="l7.181"> </span>
<a href="#l7.182"></a><span id="l7.182">   checkPopulate(&quot;TestList3 &lt;TestList3&gt;, ListTest1 &lt;ListTest1&gt;&quot;,</span>
<a href="#l7.183"></a><span id="l7.183" class="difflineminus">-                &quot;test1@com.invalid,test2@com.invalid,test3@com.invalid&quot;,</span>
<a href="#l7.184"></a><span id="l7.184" class="difflineminus">-                nsIAbPreferMailFormat.unknown,</span>
<a href="#l7.185"></a><span id="l7.185">                 &quot;test5@foo.invalid,test1@com.invalid,test2@com.invalid,test3@com.invalid&quot;);</span>
<a href="#l7.186"></a><span id="l7.186">                 </span>
<a href="#l7.187"></a><span id="l7.187">   // test bug 254519 rfc 2047 encoding</span>
<a href="#l7.188"></a><span id="l7.188" class="difflineminus">-  checkPopulate(&quot;=?iso-8859-1?Q?Sure=F6name=2C_Forename__Dr=2E?= &lt;pb@bieringer.invalid&gt;&quot;, &quot;pb@bieringer.invalid&quot;,</span>
<a href="#l7.189"></a><span id="l7.189" class="difflineminus">-                nsIAbPreferMailFormat.unknown,</span>
<a href="#l7.190"></a><span id="l7.190" class="difflineplus">+  checkPopulate(&quot;=?iso-8859-1?Q?Sure=F6name=2C_Forename__Dr=2E?= &lt;pb@bieringer.invalid&gt;&quot;,</span>
<a href="#l7.191"></a><span id="l7.191">                 &quot;\&quot;Sure\u00F6name, Forename  Dr.\&quot; &lt;pb@bieringer.invalid&gt;&quot;);</span>
<a href="#l7.192"></a><span id="l7.192"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_nsMsgCompose3.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_nsMsgCompose3.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -1,12 +1,12 @@</span>
<a href="#l8.4"></a><span id="l8.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l8.5"></a><span id="l8.5"> /*</span>
<a href="#l8.6"></a><span id="l8.6">  * Test suite for increasing the popularity of contacts via</span>
<a href="#l8.7"></a><span id="l8.7" class="difflineminus">- * checkAndPopulateRecipients.</span>
<a href="#l8.8"></a><span id="l8.8" class="difflineplus">+ * expandMailingLists.</span>
<a href="#l8.9"></a><span id="l8.9">  */</span>
<a href="#l8.10"></a><span id="l8.10"> </span>
<a href="#l8.11"></a><span id="l8.11"> Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l8.12"></a><span id="l8.12"> </span>
<a href="#l8.13"></a><span id="l8.13"> const MsgComposeContractID = &quot;@mozilla.org/messengercompose/compose;1&quot;;</span>
<a href="#l8.14"></a><span id="l8.14"> const MsgComposeParamsContractID = &quot;@mozilla.org/messengercompose/composeparams;1&quot;;</span>
<a href="#l8.15"></a><span id="l8.15"> const MsgComposeFieldsContractID = &quot;@mozilla.org/messengercompose/composefields;1&quot;;</span>
<a href="#l8.16"></a><span id="l8.16"> </span>
<a href="#l8.17"></a><span id="l8.17" class="difflineat">@@ -29,42 +29,36 @@ const TESTS = [</span>
<a href="#l8.18"></a><span id="l8.18">   },</span>
<a href="#l8.19"></a><span id="l8.19">   {</span>
<a href="#l8.20"></a><span id="l8.20">     email: &quot;em@test.invalid&quot;,</span>
<a href="#l8.21"></a><span id="l8.21">     prePopularity: &quot;11&quot;,</span>
<a href="#l8.22"></a><span id="l8.22">     postPopularity: &quot;12&quot;</span>
<a href="#l8.23"></a><span id="l8.23">   }</span>
<a href="#l8.24"></a><span id="l8.24"> ];</span>
<a href="#l8.25"></a><span id="l8.25"> </span>
<a href="#l8.26"></a><span id="l8.26" class="difflineminus">-function checkPopulate(aTo, aNonHTMLRecipients, aPreferMailOut, aCheckTo)</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineplus">+function checkPopulate(aTo, aCheckTo)</span>
<a href="#l8.28"></a><span id="l8.28"> {</span>
<a href="#l8.29"></a><span id="l8.29">   let msgCompose = Cc[MsgComposeContractID].createInstance(Ci.nsIMsgCompose);</span>
<a href="#l8.30"></a><span id="l8.30"> </span>
<a href="#l8.31"></a><span id="l8.31">   // Set up some basic fields for compose.</span>
<a href="#l8.32"></a><span id="l8.32">   let fields = Cc[MsgComposeFieldsContractID].createInstance(Ci.nsIMsgCompFields);</span>
<a href="#l8.33"></a><span id="l8.33"> </span>
<a href="#l8.34"></a><span id="l8.34">   fields.to = aTo;</span>
<a href="#l8.35"></a><span id="l8.35"> </span>
<a href="#l8.36"></a><span id="l8.36">   // Set up some params</span>
<a href="#l8.37"></a><span id="l8.37">   let params = Cc[MsgComposeParamsContractID]</span>
<a href="#l8.38"></a><span id="l8.38">                  .createInstance(Ci.nsIMsgComposeParams);</span>
<a href="#l8.39"></a><span id="l8.39"> </span>
<a href="#l8.40"></a><span id="l8.40">   params.composeFields = fields;</span>
<a href="#l8.41"></a><span id="l8.41"> </span>
<a href="#l8.42"></a><span id="l8.42">   msgCompose.initialize(params);</span>
<a href="#l8.43"></a><span id="l8.43"> </span>
<a href="#l8.44"></a><span id="l8.44" class="difflineminus">-  let nonHTMLRecipients = new Object();</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineminus">-</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineminus">-  do_check_eq(msgCompose.checkAndPopulateRecipients(true, true,</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineminus">-                                                    nonHTMLRecipients),</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineminus">-              aPreferMailOut);</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineplus">+  do_check_eq(msgCompose.expandMailingLists());</span>
<a href="#l8.50"></a><span id="l8.50"> </span>
<a href="#l8.51"></a><span id="l8.51">   do_check_eq(fields.to, aCheckTo);</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineminus">-</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineminus">-  do_check_eq(nonHTMLRecipients.value, aNonHTMLRecipients);</span>
<a href="#l8.54"></a><span id="l8.54"> }</span>
<a href="#l8.55"></a><span id="l8.55"> </span>
<a href="#l8.56"></a><span id="l8.56"> function run_test() {</span>
<a href="#l8.57"></a><span id="l8.57">   // Test setup - copy the data files into place</span>
<a href="#l8.58"></a><span id="l8.58">   let testAB = do_get_file(&quot;../../../data/tb2hexpopularity.mab&quot;);</span>
<a href="#l8.59"></a><span id="l8.59"> </span>
<a href="#l8.60"></a><span id="l8.60">   // Copy the file to the profile directory for a PAB</span>
<a href="#l8.61"></a><span id="l8.61">   testAB.copyTo(do_get_profile(), kPABData.fileName);</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineat">@@ -76,18 +70,17 @@ function run_test() {</span>
<a href="#l8.63"></a><span id="l8.63">     let card = AB.cardForEmailAddress(TESTS[i].email);</span>
<a href="#l8.64"></a><span id="l8.64">     do_check_true(!!card);</span>
<a href="#l8.65"></a><span id="l8.65"> </span>
<a href="#l8.66"></a><span id="l8.66">     // Thunderbird 2 stored its popularityIndexes as hex, hence when we read it</span>
<a href="#l8.67"></a><span id="l8.67">     // now we're going to get a hex value. The AB has a value of &quot;a&quot;.</span>
<a href="#l8.68"></a><span id="l8.68">     do_check_eq(card.getProperty(&quot;PopularityIndex&quot;, -1), TESTS[i].prePopularity);</span>
<a href="#l8.69"></a><span id="l8.69"> </span>
<a href="#l8.70"></a><span id="l8.70">     // Call the check populate function.</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineminus">-    checkPopulate(TESTS[i].email, TESTS[i].email,</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineminus">-                  Ci.nsIAbPreferMailFormat.unknown, TESTS[i].email);</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineplus">+    checkPopulate(TESTS[i].email, TESTS[i].email);</span>
<a href="#l8.74"></a><span id="l8.74"> </span>
<a href="#l8.75"></a><span id="l8.75">     // Now we've run check populate, check the popularityIndex has increased.</span>
<a href="#l8.76"></a><span id="l8.76">     card = AB.cardForEmailAddress(TESTS[i].email);</span>
<a href="#l8.77"></a><span id="l8.77">     do_check_true(!!card);</span>
<a href="#l8.78"></a><span id="l8.78"> </span>
<a href="#l8.79"></a><span id="l8.79">     // Thunderbird 2 stored its popularityIndexes as hex, hence when we read it</span>
<a href="#l8.80"></a><span id="l8.80">     // now we're going to get a hex value. The AB has a value of &quot;a&quot;.</span>
<a href="#l8.81"></a><span id="l8.81">     do_check_eq(card.getProperty(&quot;PopularityIndex&quot;, -1), TESTS[i].postPopularity);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1">copy from mailnews/compose/test/unit/test_nsMsgCompose1.js</span>
<a href="#l9.2"></a><span id="l9.2">copy to mailnews/compose/test/unit/test_nsMsgCompose4.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineminus">--- a/mailnews/compose/test/unit/test_nsMsgCompose1.js</span>
<a href="#l9.4"></a><span id="l9.4" class="difflineplus">+++ b/mailnews/compose/test/unit/test_nsMsgCompose4.js</span>
<a href="#l9.5"></a><span id="l9.5" class="difflineat">@@ -1,61 +1,54 @@</span>
<a href="#l9.6"></a><span id="l9.6" class="difflineminus">-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l9.7"></a><span id="l9.7" class="difflineminus">-</span>
<a href="#l9.8"></a><span id="l9.8"> /**</span>
<a href="#l9.9"></a><span id="l9.9" class="difflineminus">- * Tests nsMsgCompose checkAndPopulateRecipients.</span>
<a href="#l9.10"></a><span id="l9.10" class="difflineplus">+ * Tests nsMsgCompose determineHTMLAction.</span>
<a href="#l9.11"></a><span id="l9.11">  */</span>
<a href="#l9.12"></a><span id="l9.12"> </span>
<a href="#l9.13"></a><span id="l9.13"> const MsgComposeContractID = &quot;@mozilla.org/messengercompose/compose;1&quot;;</span>
<a href="#l9.14"></a><span id="l9.14"> const MsgComposeParamsContractID = &quot;@mozilla.org/messengercompose/composeparams;1&quot;;</span>
<a href="#l9.15"></a><span id="l9.15"> const MsgComposeFieldsContractID = &quot;@mozilla.org/messengercompose/composefields;1&quot;;</span>
<a href="#l9.16"></a><span id="l9.16"> const nsIMsgCompose = Components.interfaces.nsIMsgCompose;</span>
<a href="#l9.17"></a><span id="l9.17"> const nsIMsgComposeParams = Components.interfaces.nsIMsgComposeParams;</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+const nsIMsgCompConvertible = Components.interfaces.nsIMsgCompConvertible;</span>
<a href="#l9.19"></a><span id="l9.19"> const nsIMsgCompFields = Components.interfaces.nsIMsgCompFields;</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineminus">-const nsIAbPreferMailFormat = Components.interfaces.nsIAbPreferMailFormat;</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineplus">+const SendFormat = Components.interfaces.nsIMsgCompSendFormat;</span>
<a href="#l9.22"></a><span id="l9.22"> </span>
<a href="#l9.23"></a><span id="l9.23"> Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l9.24"></a><span id="l9.24"> </span>
<a href="#l9.25"></a><span id="l9.25"> /**</span>
<a href="#l9.26"></a><span id="l9.26">  * Helper to check population worked as expected.</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineminus">- * @param aTo - text in the To field</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineminus">- * @param aNonHTMLRecipients - comma separated string of recipients that are</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineminus">- *                             expected to prefer HTML</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineminus">- * @param aPreferMailOut - |nsIAbPreferMailFormat| lowest common peferred</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineminus">- *                         format - unknown, plaintext or html</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineminus">- * @param aCheckTo - the expected To addresses (after possible ist population)</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineplus">+ * @param aTo          text in the To field</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineplus">+ * @param aNewsgroups  text for the Newsgroups field</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineplus">+ * @param aSendFormat  |nsIMsgCompSendFormat| format to send</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineplus">+ * @param aConvertible |nsIMsgCompConvertible| parameter to check (defaults to</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineplus">+ *                     nsIMsgCompConvertible.No if undefined)</span>
<a href="#l9.38"></a><span id="l9.38">  */</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineminus">-function checkPopulate(aTo, aNonHTMLRecipients, aPreferMailOut, aCheckTo)</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineplus">+function checkPopulate(aTo, aNewsgroups, aSendFormat,</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineplus">+                       aConvertible=nsIMsgCompConvertible.No)</span>
<a href="#l9.42"></a><span id="l9.42"> {</span>
<a href="#l9.43"></a><span id="l9.43">   var msgCompose = Components.classes[MsgComposeContractID]</span>
<a href="#l9.44"></a><span id="l9.44">                              .createInstance(nsIMsgCompose);</span>
<a href="#l9.45"></a><span id="l9.45"> </span>
<a href="#l9.46"></a><span id="l9.46">   // Set up some basic fields for compose.</span>
<a href="#l9.47"></a><span id="l9.47">   var fields = Components.classes[MsgComposeFieldsContractID]</span>
<a href="#l9.48"></a><span id="l9.48">                          .createInstance(nsIMsgCompFields);</span>
<a href="#l9.49"></a><span id="l9.49"> </span>
<a href="#l9.50"></a><span id="l9.50">   fields.to = aTo;</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineplus">+  fields.newsgroups = aNewsgroups;</span>
<a href="#l9.52"></a><span id="l9.52"> </span>
<a href="#l9.53"></a><span id="l9.53">   // Set up some params</span>
<a href="#l9.54"></a><span id="l9.54">   var params = Components.classes[MsgComposeParamsContractID]</span>
<a href="#l9.55"></a><span id="l9.55">                          .createInstance(nsIMsgComposeParams);</span>
<a href="#l9.56"></a><span id="l9.56"> </span>
<a href="#l9.57"></a><span id="l9.57">   params.composeFields = fields;</span>
<a href="#l9.58"></a><span id="l9.58"> </span>
<a href="#l9.59"></a><span id="l9.59">   msgCompose.initialize(params);</span>
<a href="#l9.60"></a><span id="l9.60"> </span>
<a href="#l9.61"></a><span id="l9.61" class="difflineminus">-  var nonHTMLRecipients = new Object();</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineminus">-</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineminus">-  do_check_eq(msgCompose.checkAndPopulateRecipients(true, true,</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineminus">-                                                    nonHTMLRecipients),</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineminus">-              aPreferMailOut);</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineminus">-</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineminus">-  do_check_eq(fields.to, aCheckTo);</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineminus">-</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineminus">-  do_check_eq(nonHTMLRecipients.value, aNonHTMLRecipients);</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineplus">+  msgCompose.expandMailingLists();</span>
<a href="#l9.71"></a><span id="l9.71" class="difflineplus">+  do_check_eq(msgCompose.determineHTMLAction(aConvertible), aSendFormat);</span>
<a href="#l9.72"></a><span id="l9.72"> }</span>
<a href="#l9.73"></a><span id="l9.73"> </span>
<a href="#l9.74"></a><span id="l9.74"> function run_test() {</span>
<a href="#l9.75"></a><span id="l9.75">   // Test setup - copy the data files into place</span>
<a href="#l9.76"></a><span id="l9.76">   var testAB = do_get_file(&quot;../../../data/abLists1.mab&quot;);</span>
<a href="#l9.77"></a><span id="l9.77"> </span>
<a href="#l9.78"></a><span id="l9.78">   // Copy the file to the profile directory for a PAB</span>
<a href="#l9.79"></a><span id="l9.79">   testAB.copyTo(do_get_profile(), kPABData.fileName);</span>
<a href="#l9.80"></a><span id="l9.80" class="difflineat">@@ -72,17 +65,17 @@ function run_test() {</span>
<a href="#l9.81"></a><span id="l9.81">                              .createInstance(nsIMsgCompose);</span>
<a href="#l9.82"></a><span id="l9.82"> </span>
<a href="#l9.83"></a><span id="l9.83">   // Set up some params</span>
<a href="#l9.84"></a><span id="l9.84">   var params = Components.classes[MsgComposeParamsContractID]</span>
<a href="#l9.85"></a><span id="l9.85">                          .createInstance(nsIMsgComposeParams);</span>
<a href="#l9.86"></a><span id="l9.86"> </span>
<a href="#l9.87"></a><span id="l9.87">   msgCompose.initialize(params);</span>
<a href="#l9.88"></a><span id="l9.88"> </span>
<a href="#l9.89"></a><span id="l9.89" class="difflineminus">-  // Test - checkAndPopulateRecipients basic functionality.</span>
<a href="#l9.90"></a><span id="l9.90" class="difflineplus">+  // Test - determineHTMLAction basic functionality.</span>
<a href="#l9.91"></a><span id="l9.91"> </span>
<a href="#l9.92"></a><span id="l9.92">   // Re-initialize</span>
<a href="#l9.93"></a><span id="l9.93">   msgCompose = Components.classes[MsgComposeContractID]</span>
<a href="#l9.94"></a><span id="l9.94">                          .createInstance(nsIMsgCompose);</span>
<a href="#l9.95"></a><span id="l9.95"> </span>
<a href="#l9.96"></a><span id="l9.96">   // Set up some basic fields for compose.</span>
<a href="#l9.97"></a><span id="l9.97">   var fields = Components.classes[MsgComposeFieldsContractID]</span>
<a href="#l9.98"></a><span id="l9.98">                          .createInstance(nsIMsgCompFields);</span>
<a href="#l9.99"></a><span id="l9.99" class="difflineat">@@ -98,91 +91,70 @@ function run_test() {</span>
<a href="#l9.100"></a><span id="l9.100">                      .createInstance(nsIMsgComposeParams);</span>
<a href="#l9.101"></a><span id="l9.101"> </span>
<a href="#l9.102"></a><span id="l9.102">   params.composeFields = fields;</span>
<a href="#l9.103"></a><span id="l9.103"> </span>
<a href="#l9.104"></a><span id="l9.104">   msgCompose.initialize(params);</span>
<a href="#l9.105"></a><span id="l9.105"> </span>
<a href="#l9.106"></a><span id="l9.106">   var nonHTMLRecipients = new Object();</span>
<a href="#l9.107"></a><span id="l9.107"> </span>
<a href="#l9.108"></a><span id="l9.108" class="difflineminus">-  do_check_eq(msgCompose.checkAndPopulateRecipients(true, false,</span>
<a href="#l9.109"></a><span id="l9.109" class="difflineminus">-                                                    nonHTMLRecipients),</span>
<a href="#l9.110"></a><span id="l9.110" class="difflineminus">-              nsIAbPreferMailFormat.unknown);</span>
<a href="#l9.111"></a><span id="l9.111" class="difflineminus">-</span>
<a href="#l9.112"></a><span id="l9.112" class="difflineminus">-  do_check_eq(nonHTMLRecipients.value, &quot;&quot;);</span>
<a href="#l9.113"></a><span id="l9.113" class="difflineminus">-</span>
<a href="#l9.114"></a><span id="l9.114" class="difflineminus">-  do_check_eq(msgCompose.checkAndPopulateRecipients(true, true,</span>
<a href="#l9.115"></a><span id="l9.115" class="difflineminus">-                                                      nonHTMLRecipients),</span>
<a href="#l9.116"></a><span id="l9.116" class="difflineminus">-              nsIAbPreferMailFormat.unknown);</span>
<a href="#l9.117"></a><span id="l9.117" class="difflineminus">-</span>
<a href="#l9.118"></a><span id="l9.118" class="difflineminus">-  do_check_eq(nonHTMLRecipients.value, &quot;test2@foo1.invalid,test3@foo1.invalid,test4@foo1.invalid&quot;);</span>
<a href="#l9.119"></a><span id="l9.119" class="difflineplus">+  Services.prefs.setIntPref(&quot;mail.default_html_action&quot;, SendFormat.AskUser);</span>
<a href="#l9.120"></a><span id="l9.120" class="difflineplus">+  do_check_eq(msgCompose.determineHTMLAction(nsIMsgCompConvertible.No),</span>
<a href="#l9.121"></a><span id="l9.121" class="difflineplus">+              SendFormat.AskUser);</span>
<a href="#l9.122"></a><span id="l9.122"> </span>
<a href="#l9.123"></a><span id="l9.123">   do_check_eq(fields.to, &quot;test2@foo1.invalid&quot;);</span>
<a href="#l9.124"></a><span id="l9.124">   do_check_eq(fields.cc, &quot;test3@foo1.invalid&quot;);</span>
<a href="#l9.125"></a><span id="l9.125">   do_check_eq(fields.bcc, &quot;test4@foo1.invalid&quot;);</span>
<a href="#l9.126"></a><span id="l9.126"> </span>
<a href="#l9.127"></a><span id="l9.127" class="difflineminus">-  // Test - checkAndPopulateRecipients with plain text.</span>
<a href="#l9.128"></a><span id="l9.128" class="difflineplus">+  // Test - determineHTMLAction with plain text.</span>
<a href="#l9.129"></a><span id="l9.129"> </span>
<a href="#l9.130"></a><span id="l9.130" class="difflineminus">-  checkPopulate(&quot;test4@foo.invalid&quot;, &quot;test4@foo.invalid&quot;,</span>
<a href="#l9.131"></a><span id="l9.131" class="difflineminus">-                nsIAbPreferMailFormat.plaintext, &quot;test4@foo.invalid&quot;);</span>
<a href="#l9.132"></a><span id="l9.132" class="difflineplus">+  checkPopulate(&quot;test4@foo.invalid&quot;, &quot;&quot;, SendFormat.PlainText);</span>
<a href="#l9.133"></a><span id="l9.133"> </span>
<a href="#l9.134"></a><span id="l9.134" class="difflineminus">-  // Test - checkAndPopulateRecipients with html.</span>
<a href="#l9.135"></a><span id="l9.135" class="difflineplus">+  // Test - determineHTMLAction with html.</span>
<a href="#l9.136"></a><span id="l9.136"> </span>
<a href="#l9.137"></a><span id="l9.137" class="difflineminus">-  checkPopulate(&quot;test5@foo.invalid&quot;, &quot;&quot;, nsIAbPreferMailFormat.html,</span>
<a href="#l9.138"></a><span id="l9.138" class="difflineminus">-                &quot;test5@foo.invalid&quot;);</span>
<a href="#l9.139"></a><span id="l9.139" class="difflineplus">+  checkPopulate(&quot;test5@foo.invalid&quot;, &quot;&quot;, SendFormat.HTML);</span>
<a href="#l9.140"></a><span id="l9.140"> </span>
<a href="#l9.141"></a><span id="l9.141" class="difflineminus">-  // Test - checkAndPopulateRecipients with a list of three items.</span>
<a href="#l9.142"></a><span id="l9.142" class="difflineplus">+  // Test - determineHTMLAction with a list of three items.</span>
<a href="#l9.143"></a><span id="l9.143"> </span>
<a href="#l9.144"></a><span id="l9.144" class="difflineminus">-  checkPopulate(&quot;TestList1 &lt;TestList1&gt;&quot;,</span>
<a href="#l9.145"></a><span id="l9.145" class="difflineminus">-                &quot;test1@foo.invalid,test2@foo.invalid,test3@foo.invalid&quot;,</span>
<a href="#l9.146"></a><span id="l9.146" class="difflineminus">-                nsIAbPreferMailFormat.unknown,</span>
<a href="#l9.147"></a><span id="l9.147" class="difflineminus">-                &quot;test1@foo.invalid,test2@foo.invalid,test3@foo.invalid&quot;);</span>
<a href="#l9.148"></a><span id="l9.148" class="difflineplus">+  checkPopulate(&quot;TestList1 &lt;TestList1&gt;&quot;, &quot;&quot;, SendFormat.AskUser);</span>
<a href="#l9.149"></a><span id="l9.149" class="difflineplus">+  checkPopulate(&quot;TestList1 &lt;TestList1&gt;&quot;, &quot;&quot;, SendFormat.PlainText,</span>
<a href="#l9.150"></a><span id="l9.150" class="difflineplus">+    nsIMsgCompConvertible.Plain);</span>
<a href="#l9.151"></a><span id="l9.151"> </span>
<a href="#l9.152"></a><span id="l9.152" class="difflineminus">-  // Test - checkAndPopulateRecipients with a list of one item.</span>
<a href="#l9.153"></a><span id="l9.153" class="difflineminus">-</span>
<a href="#l9.154"></a><span id="l9.154" class="difflineminus">-  checkPopulate(&quot;TestList2 &lt;TestList2&gt;&quot;, &quot;test4@foo.invalid&quot;,</span>
<a href="#l9.155"></a><span id="l9.155" class="difflineminus">-                nsIAbPreferMailFormat.plaintext, &quot;test4@foo.invalid&quot;);</span>
<a href="#l9.156"></a><span id="l9.156" class="difflineplus">+  // Test - determineHTMLAction with a list of one item.</span>
<a href="#l9.157"></a><span id="l9.157"> </span>
<a href="#l9.158"></a><span id="l9.158" class="difflineminus">-  checkPopulate(&quot;TestList3 &lt;TestList3&gt;&quot;, &quot;&quot;,</span>
<a href="#l9.159"></a><span id="l9.159" class="difflineminus">-                nsIAbPreferMailFormat.html, &quot;test5@foo.invalid&quot;);</span>
<a href="#l9.160"></a><span id="l9.160" class="difflineplus">+  checkPopulate(&quot;TestList2 &lt;TestList2&gt;&quot;, &quot;&quot;, SendFormat.PlainText);</span>
<a href="#l9.161"></a><span id="l9.161"> </span>
<a href="#l9.162"></a><span id="l9.162" class="difflineminus">-  // Test checkAndPopulateRecipients w/ mailnews.html_domains set.</span>
<a href="#l9.163"></a><span id="l9.163" class="difflineplus">+  checkPopulate(&quot;TestList3 &lt;TestList3&gt;&quot;, &quot;&quot;, SendFormat.HTML);</span>
<a href="#l9.164"></a><span id="l9.164" class="difflineplus">+</span>
<a href="#l9.165"></a><span id="l9.165" class="difflineplus">+  // Test determineHTMLAction w/ mailnews.html_domains set.</span>
<a href="#l9.166"></a><span id="l9.166">   Services.prefs.setCharPref(&quot;mailnews.html_domains&quot;, &quot;foo.invalid,bar.invalid&quot;);</span>
<a href="#l9.167"></a><span id="l9.167" class="difflineminus">-  checkPopulate(&quot;htmlformat@foo.invalid,unknownformat@nonfoo.invalid&quot;,</span>
<a href="#l9.168"></a><span id="l9.168" class="difflineminus">-                &quot;unknownformat@nonfoo.invalid&quot;,</span>
<a href="#l9.169"></a><span id="l9.169" class="difflineminus">-                nsIAbPreferMailFormat.unknown,</span>
<a href="#l9.170"></a><span id="l9.170" class="difflineminus">-                &quot;htmlformat@foo.invalid,unknownformat@nonfoo.invalid&quot;);</span>
<a href="#l9.171"></a><span id="l9.171" class="difflineplus">+  checkPopulate(&quot;htmlformat@foo.invalid,unknownformat@nonfoo.invalid&quot;, &quot;&quot;,</span>
<a href="#l9.172"></a><span id="l9.172" class="difflineplus">+                SendFormat.AskUser);</span>
<a href="#l9.173"></a><span id="l9.173">   Services.prefs.clearUserPref(&quot;mailnews.html_domains&quot;);</span>
<a href="#l9.174"></a><span id="l9.174"> </span>
<a href="#l9.175"></a><span id="l9.175" class="difflineminus">-  // Test checkAndPopulateRecipients w/ mailnews.plaintext_domains set.</span>
<a href="#l9.176"></a><span id="l9.176" class="difflineplus">+  // Test determineHTMLAction w/ mailnews.plaintext_domains set.</span>
<a href="#l9.177"></a><span id="l9.177">   Services.prefs.setCharPref(&quot;mailnews.plaintext_domains&quot;, &quot;foo.invalid,bar.invalid&quot;);</span>
<a href="#l9.178"></a><span id="l9.178" class="difflineminus">-  checkPopulate(&quot;plainformat@foo.invalid,unknownformat@nonfoo.invalid&quot;,</span>
<a href="#l9.179"></a><span id="l9.179" class="difflineminus">-                &quot;plainformat@foo.invalid,unknownformat@nonfoo.invalid&quot;,</span>
<a href="#l9.180"></a><span id="l9.180" class="difflineminus">-                nsIAbPreferMailFormat.unknown,</span>
<a href="#l9.181"></a><span id="l9.181" class="difflineminus">-                &quot;plainformat@foo.invalid,unknownformat@nonfoo.invalid&quot;);</span>
<a href="#l9.182"></a><span id="l9.182" class="difflineminus">-  checkPopulate(&quot;plainformat@foo.invalid,plainformat@cc.bar.invalid&quot;,</span>
<a href="#l9.183"></a><span id="l9.183" class="difflineminus">-                &quot;plainformat@foo.invalid,plainformat@cc.bar.invalid&quot;,</span>
<a href="#l9.184"></a><span id="l9.184" class="difflineminus">-                nsIAbPreferMailFormat.plaintext,</span>
<a href="#l9.185"></a><span id="l9.185" class="difflineminus">-                &quot;plainformat@foo.invalid,plainformat@cc.bar.invalid&quot;);</span>
<a href="#l9.186"></a><span id="l9.186" class="difflineplus">+  checkPopulate(&quot;plainformat@foo.invalid,unknownformat@nonfoo.invalid&quot;, &quot;&quot;,</span>
<a href="#l9.187"></a><span id="l9.187" class="difflineplus">+                SendFormat.AskUser);</span>
<a href="#l9.188"></a><span id="l9.188" class="difflineplus">+  checkPopulate(&quot;plainformat@foo.invalid,plainformat@cc.bar.invalid&quot;, &quot;&quot;,</span>
<a href="#l9.189"></a><span id="l9.189" class="difflineplus">+                SendFormat.PlainText);</span>
<a href="#l9.190"></a><span id="l9.190">   Services.prefs.clearUserPref(&quot;mailnews.plaintext_domains&quot;);</span>
<a href="#l9.191"></a><span id="l9.191"> </span>
<a href="#l9.192"></a><span id="l9.192" class="difflineminus">-  // Test - checkAndPopulateRecipients with items from multiple address books.</span>
<a href="#l9.193"></a><span id="l9.193" class="difflineplus">+  // Test - determineHTMLAction with items from multiple address books.</span>
<a href="#l9.194"></a><span id="l9.194"> </span>
<a href="#l9.195"></a><span id="l9.195" class="difflineminus">-  checkPopulate(&quot;TestList1 &lt;TestList1&gt;, test3@com.invalid&quot;,</span>
<a href="#l9.196"></a><span id="l9.196" class="difflineminus">-                &quot;test1@foo.invalid,test2@foo.invalid,test3@foo.invalid,test3@com.invalid&quot;,</span>
<a href="#l9.197"></a><span id="l9.197" class="difflineminus">-                nsIAbPreferMailFormat.unknown,</span>
<a href="#l9.198"></a><span id="l9.198" class="difflineminus">-                &quot;test1@foo.invalid,test2@foo.invalid,test3@foo.invalid,test3@com.invalid&quot;);</span>
<a href="#l9.199"></a><span id="l9.199" class="difflineplus">+  checkPopulate(&quot;TestList1 &lt;TestList1&gt;, test3@com.invalid&quot;, &quot;&quot;,</span>
<a href="#l9.200"></a><span id="l9.200" class="difflineplus">+                SendFormat.AskUser);</span>
<a href="#l9.201"></a><span id="l9.201"> </span>
<a href="#l9.202"></a><span id="l9.202" class="difflineminus">-  checkPopulate(&quot;TestList2 &lt;TestList2&gt;, ListTest2 &lt;ListTest2&gt;&quot;,</span>
<a href="#l9.203"></a><span id="l9.203" class="difflineminus">-                &quot;test4@foo.invalid,test4@com.invalid&quot;,</span>
<a href="#l9.204"></a><span id="l9.204" class="difflineminus">-                nsIAbPreferMailFormat.plaintext,</span>
<a href="#l9.205"></a><span id="l9.205" class="difflineminus">-                &quot;test4@foo.invalid,test4@com.invalid&quot;);</span>
<a href="#l9.206"></a><span id="l9.206" class="difflineplus">+  checkPopulate(&quot;TestList2 &lt;TestList2&gt;, ListTest2 &lt;ListTest2&gt;&quot;, &quot;&quot;,</span>
<a href="#l9.207"></a><span id="l9.207" class="difflineplus">+                SendFormat.PlainText);</span>
<a href="#l9.208"></a><span id="l9.208"> </span>
<a href="#l9.209"></a><span id="l9.209" class="difflineminus">-  checkPopulate(&quot;TestList3 &lt;TestList3&gt;, ListTest1 &lt;ListTest1&gt;&quot;,</span>
<a href="#l9.210"></a><span id="l9.210" class="difflineminus">-                &quot;test1@com.invalid,test2@com.invalid,test3@com.invalid&quot;,</span>
<a href="#l9.211"></a><span id="l9.211" class="difflineminus">-                nsIAbPreferMailFormat.unknown,</span>
<a href="#l9.212"></a><span id="l9.212" class="difflineminus">-                &quot;test5@foo.invalid,test1@com.invalid,test2@com.invalid,test3@com.invalid&quot;);</span>
<a href="#l9.213"></a><span id="l9.213" class="difflineplus">+  checkPopulate(&quot;TestList3 &lt;TestList3&gt;, ListTest1 &lt;ListTest1&gt;&quot;, &quot;&quot;,</span>
<a href="#l9.214"></a><span id="l9.214" class="difflineplus">+                SendFormat.AskUser);</span>
<a href="#l9.215"></a><span id="l9.215">                 </span>
<a href="#l9.216"></a><span id="l9.216">   // test bug 254519 rfc 2047 encoding</span>
<a href="#l9.217"></a><span id="l9.217" class="difflineminus">-  checkPopulate(&quot;=?iso-8859-1?Q?Sure=F6name=2C_Forename__Dr=2E?= &lt;pb@bieringer.invalid&gt;&quot;, &quot;pb@bieringer.invalid&quot;,</span>
<a href="#l9.218"></a><span id="l9.218" class="difflineminus">-                nsIAbPreferMailFormat.unknown,</span>
<a href="#l9.219"></a><span id="l9.219" class="difflineminus">-                &quot;\&quot;Sure\u00F6name, Forename  Dr.\&quot; &lt;pb@bieringer.invalid&gt;&quot;);</span>
<a href="#l9.220"></a><span id="l9.220" class="difflineplus">+  checkPopulate(&quot;=?iso-8859-1?Q?Sure=F6name=2C_Forename__Dr=2E?= &lt;pb@bieringer.invalid&gt;&quot;, &quot;&quot;,</span>
<a href="#l9.221"></a><span id="l9.221" class="difflineplus">+                SendFormat.AskUser);</span>
<a href="#l9.222"></a><span id="l9.222" class="difflineplus">+</span>
<a href="#l9.223"></a><span id="l9.223" class="difflineplus">+  // Try some fields with newsgroups</span>
<a href="#l9.224"></a><span id="l9.224" class="difflineplus">+  checkPopulate(&quot;test4@foo.invalid&quot;, &quot;mozilla.test&quot;, SendFormat.AskUser);</span>
<a href="#l9.225"></a><span id="l9.225" class="difflineplus">+  checkPopulate(&quot;test5@foo.invalid&quot;, &quot;mozilla.test&quot;, SendFormat.AskUser);</span>
<a href="#l9.226"></a><span id="l9.226" class="difflineplus">+  checkPopulate(&quot;&quot;, &quot;mozilla.test&quot;, SendFormat.AskUser);</span>
<a href="#l9.227"></a><span id="l9.227"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/compose/test/unit/xpcshell.ini</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/compose/test/unit/xpcshell.ini</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -9,16 +9,17 @@ support-files = data/*</span>
<a href="#l10.4"></a><span id="l10.4"> [test_bug155172.js]</span>
<a href="#l10.5"></a><span id="l10.5"> [test_bug235432.js]</span>
<a href="#l10.6"></a><span id="l10.6"> [test_bug474774.js]</span>
<a href="#l10.7"></a><span id="l10.7"> [test_detectAttachmentCharset.js]</span>
<a href="#l10.8"></a><span id="l10.8"> [test_mailtoURL.js]</span>
<a href="#l10.9"></a><span id="l10.9"> [test_nsMsgCompose1.js]</span>
<a href="#l10.10"></a><span id="l10.10"> [test_nsMsgCompose2.js]</span>
<a href="#l10.11"></a><span id="l10.11"> [test_nsMsgCompose3.js]</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+[test_nsMsgCompose4.js]</span>
<a href="#l10.13"></a><span id="l10.13"> [test_nsSmtpService1.js]</span>
<a href="#l10.14"></a><span id="l10.14"> [test_saveDraft.js]</span>
<a href="#l10.15"></a><span id="l10.15"> [test_sendBackground.js]</span>
<a href="#l10.16"></a><span id="l10.16"> [test_sendMailAddressIDN.js]</span>
<a href="#l10.17"></a><span id="l10.17"> [test_sendMailMessage.js]</span>
<a href="#l10.18"></a><span id="l10.18"> [test_sendMessageFile.js]</span>
<a href="#l10.19"></a><span id="l10.19"> [test_sendMessageLater.js]</span>
<a href="#l10.20"></a><span id="l10.20"> [test_sendMessageLater2.js]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/suite/mailnews/compose/MsgComposeCommands.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/suite/mailnews/compose/MsgComposeCommands.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -2360,92 +2360,33 @@ function OpenSelectedAttachment()</span>
<a href="#l11.4"></a><span id="l11.4">         } catch (e) {}</span>
<a href="#l11.5"></a><span id="l11.5">       }</span>
<a href="#l11.6"></a><span id="l11.6">     }</span>
<a href="#l11.7"></a><span id="l11.7">   } // if one attachment selected</span>
<a href="#l11.8"></a><span id="l11.8"> }</span>
<a href="#l11.9"></a><span id="l11.9"> </span>
<a href="#l11.10"></a><span id="l11.10"> function DetermineHTMLAction(convertible)</span>
<a href="#l11.11"></a><span id="l11.11"> {</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-    var obj;</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-    if (! gMsgCompose.composeHTML)</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineminus">-    {</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineminus">-        try {</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineminus">-          obj = new Object;</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineminus">-          gMsgCompose.checkAndPopulateRecipients(true, false, obj);</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineminus">-        } catch(ex) {</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineminus">-          dump(&quot;gMsgCompose.checkAndPopulateRecipients failed: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineminus">-        }</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineminus">-        return nsIMsgCompSendFormat.PlainText;</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineminus">-    }</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineminus">-</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineminus">-    if (gSendFormat == nsIMsgCompSendFormat.AskUser)</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineminus">-    {</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineminus">-        //Well, before we ask, see if we can figure out what to do for ourselves</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineminus">-</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineminus">-        var noHtmlRecipients;</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineminus">-        var noHtmlnewsgroups;</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineminus">-        var preferFormat;</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineminus">-</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineminus">-        //Check the address book for the HTML property for each recipient</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineminus">-        try {</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineminus">-          obj = new Object;</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineminus">-          preferFormat = gMsgCompose.checkAndPopulateRecipients(true, true, obj);</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineminus">-          noHtmlRecipients = obj.value;</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineminus">-        } catch(ex) {</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineminus">-          dump(&quot;gMsgCompose.checkAndPopulateRecipients failed: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineminus">-          var msgCompFields = gMsgCompose.compFields;</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineminus">-          noHtmlRecipients = msgCompFields.to + &quot;,&quot; + msgCompFields.cc + &quot;,&quot; + msgCompFields.bcc;</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineminus">-          preferFormat = nsIAbPreferMailFormat.unknown;</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineminus">-        }</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineminus">-</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineminus">-        //Check newsgroups now...</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineminus">-        noHtmlnewsgroups = gMsgCompose.compFields.newsgroups;</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineminus">-</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineminus">-        if (noHtmlRecipients != &quot;&quot; || noHtmlnewsgroups != &quot;&quot;)</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineminus">-        {</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineminus">-            if (convertible == nsIMsgCompConvertible.Plain)</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineminus">-              return nsIMsgCompSendFormat.PlainText;</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineminus">-</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineminus">-            if (noHtmlnewsgroups == &quot;&quot;)</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineminus">-            {</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineminus">-                switch (preferFormat)</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineminus">-                {</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineminus">-                  case nsIAbPreferMailFormat.plaintext :</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineminus">-                    return nsIMsgCompSendFormat.PlainText;</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineminus">-</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineminus">-                  default :</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineminus">-                    //See if a preference has been set to tell us what to do. Note that we do not honor that</span>
<a href="#l11.61"></a><span id="l11.61" class="difflineminus">-                    //preference for newsgroups. Only for e-mail addresses.</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineminus">-                    var action = getPref(&quot;mail.default_html_action&quot;);</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineminus">-                    switch (action)</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineminus">-                    {</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineminus">-                        case nsIMsgCompSendFormat.PlainText    :</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineminus">-                        case nsIMsgCompSendFormat.HTML         :</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineminus">-                        case nsIMsgCompSendFormat.Both         :</span>
<a href="#l11.68"></a><span id="l11.68" class="difflineminus">-                            return action;</span>
<a href="#l11.69"></a><span id="l11.69" class="difflineminus">-                    }</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineminus">-                }</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineminus">-            }</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineminus">-            return nsIMsgCompSendFormat.AskUser;</span>
<a href="#l11.73"></a><span id="l11.73" class="difflineminus">-        }</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineminus">-        else</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineminus">-            return nsIMsgCompSendFormat.HTML;</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineminus">-    }</span>
<a href="#l11.77"></a><span id="l11.77" class="difflineminus">-    else</span>
<a href="#l11.78"></a><span id="l11.78" class="difflineminus">-    {</span>
<a href="#l11.79"></a><span id="l11.79" class="difflineminus">-      try {</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineminus">-        obj = new Object;</span>
<a href="#l11.81"></a><span id="l11.81" class="difflineminus">-        gMsgCompose.checkAndPopulateRecipients(true, false, obj);</span>
<a href="#l11.82"></a><span id="l11.82" class="difflineminus">-      } catch(ex) {</span>
<a href="#l11.83"></a><span id="l11.83" class="difflineminus">-        dump(&quot;gMsgCompose.checkAndPopulateRecipients failed: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l11.84"></a><span id="l11.84" class="difflineminus">-      }</span>
<a href="#l11.85"></a><span id="l11.85" class="difflineminus">-    }</span>
<a href="#l11.86"></a><span id="l11.86" class="difflineminus">-</span>
<a href="#l11.87"></a><span id="l11.87" class="difflineminus">-    return gSendFormat;</span>
<a href="#l11.88"></a><span id="l11.88" class="difflineplus">+  try {</span>
<a href="#l11.89"></a><span id="l11.89" class="difflineplus">+    gMsgCompose.expandMailingLists();</span>
<a href="#l11.90"></a><span id="l11.90" class="difflineplus">+  } catch(ex) {</span>
<a href="#l11.91"></a><span id="l11.91" class="difflineplus">+    dump(&quot;gMsgCompose.expandMailingLists failed: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l11.92"></a><span id="l11.92" class="difflineplus">+  }</span>
<a href="#l11.93"></a><span id="l11.93" class="difflineplus">+</span>
<a href="#l11.94"></a><span id="l11.94" class="difflineplus">+  if (!gMsgCompose.composeHTML)</span>
<a href="#l11.95"></a><span id="l11.95" class="difflineplus">+  {</span>
<a href="#l11.96"></a><span id="l11.96" class="difflineplus">+    return nsIMsgCompSendFormat.PlainText;</span>
<a href="#l11.97"></a><span id="l11.97" class="difflineplus">+  }</span>
<a href="#l11.98"></a><span id="l11.98" class="difflineplus">+</span>
<a href="#l11.99"></a><span id="l11.99" class="difflineplus">+  if (gSendFormat == nsIMsgCompSendFormat.AskUser)</span>
<a href="#l11.100"></a><span id="l11.100" class="difflineplus">+  {</span>
<a href="#l11.101"></a><span id="l11.101" class="difflineplus">+    return gMsgCompose.determineHTMLAction(convertible);</span>
<a href="#l11.102"></a><span id="l11.102" class="difflineplus">+  }</span>
<a href="#l11.103"></a><span id="l11.103" class="difflineplus">+</span>
<a href="#l11.104"></a><span id="l11.104" class="difflineplus">+  return gSendFormat;</span>
<a href="#l11.105"></a><span id="l11.105"> }</span>
<a href="#l11.106"></a><span id="l11.106"> </span>
<a href="#l11.107"></a><span id="l11.107"> function DetermineConvertibility()</span>
<a href="#l11.108"></a><span id="l11.108"> {</span>
<a href="#l11.109"></a><span id="l11.109">     if (!gMsgCompose.composeHTML)</span>
<a href="#l11.110"></a><span id="l11.110">         return nsIMsgCompConvertible.Plain;</span>
<a href="#l11.111"></a><span id="l11.111"> </span>
<a href="#l11.112"></a><span id="l11.112">     try {</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

