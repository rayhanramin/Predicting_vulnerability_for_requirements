<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 21460:8ac8055cd42c05612a26558e684b9aa763ff36c2</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 8ac8055cd42c05612a26558e684b9aa763ff36c2" />
<meta property="og:url" content="/comm-central/rev/8ac8055cd42c05612a26558e684b9aa763ff36c2" />
<meta property="og:description" content="Bug 1348762 Improve status bar progress messages when downloading messages, headers, and flags via IMAP. ui-r=thomasd, r=aceman,jorgk DONTBUILD" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 8ac8055cd42c05612a26558e684b9aa763ff36c2 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/8ac8055cd42c05612a26558e684b9aa763ff36c2">shortlog</a> |
<a href="/comm-central/log/8ac8055cd42c05612a26558e684b9aa763ff36c2">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/8ac8055cd42c05612a26558e684b9aa763ff36c2">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/8ac8055cd42c05612a26558e684b9aa763ff36c2">files</a> |
changeset |
<a href="/comm-central/raw-rev/8ac8055cd42c05612a26558e684b9aa763ff36c2">raw</a>  | <a href="/comm-central/archive/8ac8055cd42c05612a26558e684b9aa763ff36c2.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1348762">Bug 1348762</a> Improve status bar progress messages when downloading messages, headers, and flags via IMAP. ui-r=thomasd, r=aceman,jorgk DONTBUILD
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#71;&#101;&#110;&#101;&#32;&#83;&#109;&#105;&#116;&#104;&#32;&#60;&#103;&#100;&#115;&#64;&#99;&#104;&#97;&#114;&#116;&#101;&#114;&#116;&#110;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 21 Apr 2017 21:33:31 -0400</td></tr>

<tr>
 <td>changeset 21460</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/8ac8055cd42c05612a26558e684b9aa763ff36c2">8ac8055cd42c05612a26558e684b9aa763ff36c2</a></td>
</tr>



<tr>
<td>parent 21459</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/0e469cfeb978ddc6a9e6114b4da3ecedd870ff14">0e469cfeb978ddc6a9e6114b4da3ecedd870ff14</a>
</td>
</tr>

<tr>
<td>child 21461</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/5d397e30bb9a29fdf4a13417da202398239f1d7e">5d397e30bb9a29fdf4a13417da202398239f1d7e</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=8ac8055cd42c05612a26558e684b9aa763ff36c2">13062</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Sat, 22 Apr 2017 22:11:37 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@8ac8055cd42c [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=8ac8055cd42c05612a26558e684b9aa763ff36c2">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=8ac8055cd42c05612a26558e684b9aa763ff36c2&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=8ac8055cd42c05612a26558e684b9aa763ff36c2&newProject=comm-central&newRevision=8ac8055cd42c05612a26558e684b9aa763ff36c2&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=8ac8055cd42c05612a26558e684b9aa763ff36c2&newProject=comm-central&newRevision=8ac8055cd42c05612a26558e684b9aa763ff36c2&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=8ac8055cd42c05612a26558e684b9aa763ff36c2&newProject=comm-central&newRevision=8ac8055cd42c05612a26558e684b9aa763ff36c2&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28thomasd%29&revcount=50">thomasd</a>, <a href="/comm-central/log?rev=reviewer%28aceman%29&revcount=50">aceman</a>, <a href="/comm-central/log?rev=reviewer%28jorgk%29&revcount=50">jorgk</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1348762">1348762</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1348762">Bug 1348762</a> Improve status bar progress messages when downloading messages, headers, and flags via IMAP. ui-r=thomasd, r=aceman,jorgk DONTBUILD</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8ac8055cd42c05612a26558e684b9aa763ff36c2/mail/components/activity/modules/autosync.js">mail/components/activity/modules/autosync.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8ac8055cd42c05612a26558e684b9aa763ff36c2/mail/components/activity/modules/autosync.js">file</a> |
<a href="/comm-central/annotate/8ac8055cd42c05612a26558e684b9aa763ff36c2/mail/components/activity/modules/autosync.js">annotate</a> |
<a href="/comm-central/diff/8ac8055cd42c05612a26558e684b9aa763ff36c2/mail/components/activity/modules/autosync.js">diff</a> |
<a href="/comm-central/comparison/8ac8055cd42c05612a26558e684b9aa763ff36c2/mail/components/activity/modules/autosync.js">comparison</a> |
<a href="/comm-central/log/8ac8055cd42c05612a26558e684b9aa763ff36c2/mail/components/activity/modules/autosync.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8ac8055cd42c05612a26558e684b9aa763ff36c2/mail/locales/en-US/chrome/messenger/activity.properties">mail/locales/en-US/chrome/messenger/activity.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8ac8055cd42c05612a26558e684b9aa763ff36c2/mail/locales/en-US/chrome/messenger/activity.properties">file</a> |
<a href="/comm-central/annotate/8ac8055cd42c05612a26558e684b9aa763ff36c2/mail/locales/en-US/chrome/messenger/activity.properties">annotate</a> |
<a href="/comm-central/diff/8ac8055cd42c05612a26558e684b9aa763ff36c2/mail/locales/en-US/chrome/messenger/activity.properties">diff</a> |
<a href="/comm-central/comparison/8ac8055cd42c05612a26558e684b9aa763ff36c2/mail/locales/en-US/chrome/messenger/activity.properties">comparison</a> |
<a href="/comm-central/log/8ac8055cd42c05612a26558e684b9aa763ff36c2/mail/locales/en-US/chrome/messenger/activity.properties">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8ac8055cd42c05612a26558e684b9aa763ff36c2/mail/locales/en-US/chrome/messenger/imapMsgs.properties">mail/locales/en-US/chrome/messenger/imapMsgs.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8ac8055cd42c05612a26558e684b9aa763ff36c2/mail/locales/en-US/chrome/messenger/imapMsgs.properties">file</a> |
<a href="/comm-central/annotate/8ac8055cd42c05612a26558e684b9aa763ff36c2/mail/locales/en-US/chrome/messenger/imapMsgs.properties">annotate</a> |
<a href="/comm-central/diff/8ac8055cd42c05612a26558e684b9aa763ff36c2/mail/locales/en-US/chrome/messenger/imapMsgs.properties">diff</a> |
<a href="/comm-central/comparison/8ac8055cd42c05612a26558e684b9aa763ff36c2/mail/locales/en-US/chrome/messenger/imapMsgs.properties">comparison</a> |
<a href="/comm-central/log/8ac8055cd42c05612a26558e684b9aa763ff36c2/mail/locales/en-US/chrome/messenger/imapMsgs.properties">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8ac8055cd42c05612a26558e684b9aa763ff36c2/mailnews/imap/src/nsImapProtocol.cpp">mailnews/imap/src/nsImapProtocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8ac8055cd42c05612a26558e684b9aa763ff36c2/mailnews/imap/src/nsImapProtocol.cpp">file</a> |
<a href="/comm-central/annotate/8ac8055cd42c05612a26558e684b9aa763ff36c2/mailnews/imap/src/nsImapProtocol.cpp">annotate</a> |
<a href="/comm-central/diff/8ac8055cd42c05612a26558e684b9aa763ff36c2/mailnews/imap/src/nsImapProtocol.cpp">diff</a> |
<a href="/comm-central/comparison/8ac8055cd42c05612a26558e684b9aa763ff36c2/mailnews/imap/src/nsImapProtocol.cpp">comparison</a> |
<a href="/comm-central/log/8ac8055cd42c05612a26558e684b9aa763ff36c2/mailnews/imap/src/nsImapProtocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8ac8055cd42c05612a26558e684b9aa763ff36c2/mailnews/imap/src/nsImapProtocol.h">mailnews/imap/src/nsImapProtocol.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8ac8055cd42c05612a26558e684b9aa763ff36c2/mailnews/imap/src/nsImapProtocol.h">file</a> |
<a href="/comm-central/annotate/8ac8055cd42c05612a26558e684b9aa763ff36c2/mailnews/imap/src/nsImapProtocol.h">annotate</a> |
<a href="/comm-central/diff/8ac8055cd42c05612a26558e684b9aa763ff36c2/mailnews/imap/src/nsImapProtocol.h">diff</a> |
<a href="/comm-central/comparison/8ac8055cd42c05612a26558e684b9aa763ff36c2/mailnews/imap/src/nsImapProtocol.h">comparison</a> |
<a href="/comm-central/log/8ac8055cd42c05612a26558e684b9aa763ff36c2/mailnews/imap/src/nsImapProtocol.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8ac8055cd42c05612a26558e684b9aa763ff36c2/suite/locales/en-US/chrome/mailnews/imapMsgs.properties">suite/locales/en-US/chrome/mailnews/imapMsgs.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8ac8055cd42c05612a26558e684b9aa763ff36c2/suite/locales/en-US/chrome/mailnews/imapMsgs.properties">file</a> |
<a href="/comm-central/annotate/8ac8055cd42c05612a26558e684b9aa763ff36c2/suite/locales/en-US/chrome/mailnews/imapMsgs.properties">annotate</a> |
<a href="/comm-central/diff/8ac8055cd42c05612a26558e684b9aa763ff36c2/suite/locales/en-US/chrome/mailnews/imapMsgs.properties">diff</a> |
<a href="/comm-central/comparison/8ac8055cd42c05612a26558e684b9aa763ff36c2/suite/locales/en-US/chrome/mailnews/imapMsgs.properties">comparison</a> |
<a href="/comm-central/log/8ac8055cd42c05612a26558e684b9aa763ff36c2/suite/locales/en-US/chrome/mailnews/imapMsgs.properties">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/components/activity/modules/autosync.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/components/activity/modules/autosync.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -277,20 +277,21 @@ var autosyncModule =</span>
<a href="#l1.4"></a><span id="l1.4"> </span>
<a href="#l1.5"></a><span id="l1.5">           syncItem.totalDownloaded += numOfMessages;</span>
<a href="#l1.6"></a><span id="l1.6"> </span>
<a href="#l1.7"></a><span id="l1.7">           process.state = Components.interfaces.nsIActivityProcess.STATE_INPROGRESS;</span>
<a href="#l1.8"></a><span id="l1.8">           let percent = (syncItem.totalDownloaded/syncItem.pendingMsgCount)*100;</span>
<a href="#l1.9"></a><span id="l1.9">           if (percent &gt; syncItem.percentComplete)</span>
<a href="#l1.10"></a><span id="l1.10">             syncItem.percentComplete = percent;</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-          let msg = this.bundle.formatStringFromName(&quot;autosyncProcessProgress&quot;,</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+          let msg = this.bundle.formatStringFromName(&quot;autosyncProcessProgress2&quot;,</span>
<a href="#l1.14"></a><span id="l1.14">                                                  [syncItem.totalDownloaded,</span>
<a href="#l1.15"></a><span id="l1.15">                                                   syncItem.pendingMsgCount,</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineminus">-                                                  folder.prettiestName], 3);</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+                                                  folder.prettiestName,</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+                                                  folder.server.prettyName], 4);</span>
<a href="#l1.19"></a><span id="l1.19"> </span>
<a href="#l1.20"></a><span id="l1.20">           process.setProgress(msg, numOfMessages, totalPending);</span>
<a href="#l1.21"></a><span id="l1.21"> </span>
<a href="#l1.22"></a><span id="l1.22">           let serverInfo = this._syncInfoPerServer.get(syncItem.syncFolder.server);</span>
<a href="#l1.23"></a><span id="l1.23">           serverInfo.totalDownloads += numOfMessages;</span>
<a href="#l1.24"></a><span id="l1.24">           this._syncInfoPerServer.set(syncItem.syncFolder.server, serverInfo);</span>
<a href="#l1.25"></a><span id="l1.25">         }</span>
<a href="#l1.26"></a><span id="l1.26">       }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/activity.properties</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/activity.properties</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -23,21 +23,23 @@ sentMessage=Sent Message</span>
<a href="#l2.4"></a><span id="l2.4"> sentMessageWithSubject=Sent Message: %S</span>
<a href="#l2.5"></a><span id="l2.5"> failedToSendMessage=Failed to send message</span>
<a href="#l2.6"></a><span id="l2.6"> failedToCopyMessage=Failed to copy message</span>
<a href="#l2.7"></a><span id="l2.7"> # LOCALIZATION NOTE (failedToSendMessageWithSubject): %S will be replaced by the subject of the message being sent.</span>
<a href="#l2.8"></a><span id="l2.8"> failedToSendMessageWithSubject=Failed to send message: %S</span>
<a href="#l2.9"></a><span id="l2.9"> # LOCALIZATION NOTE (failedToCopyMessageWithSubject): %S will be replaced by the subject of the message being sent.</span>
<a href="#l2.10"></a><span id="l2.10"> failedToCopyMessageWithSubject=Failed to copy message: %S</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-# LOCALIZATION NOTE (autosyncProcessProgress): Do not translate the word &quot;%1$S&quot;, &quot;%2$S&quot; and &quot;%3$S&quot; below.</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+# LOCALIZATION NOTE (autosyncProcessProgress2): Do not translate the word &quot;%1$S&quot;, &quot;%2$S&quot;, &quot;%3$S&quot; and &quot;%4$S&quot; below.</span>
<a href="#l2.14"></a><span id="l2.14"> # Place the word %1$S in your translation where the number of the message being downloaded should appear.</span>
<a href="#l2.15"></a><span id="l2.15"> # Place the word %2$S in your translation where the total number of pending messages should appear.</span>
<a href="#l2.16"></a><span id="l2.16"> # Place the word %3$S in your translation where the name of the folder being processed should appear.</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineminus">-autosyncProcessProgress=Downloading %1$S of %2$S in %3$S</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+# Place the word %4$S in your translation where the name of account being processed should appear.</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+# EXAMPLE: Ted's account: Downloading message 334 of 1008 in Inbox…</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+autosyncProcessProgress2=%4$S: Downloading message %1$S of %2$S in %3$S…</span>
<a href="#l2.21"></a><span id="l2.21"> # LOCALIZATION NOTE (autosyncProcessDisplayText): %S will be replaced by the folder name</span>
<a href="#l2.22"></a><span id="l2.22"> autosyncProcessDisplayText=Bringing folder %S up to date</span>
<a href="#l2.23"></a><span id="l2.23"> # LOCALIZATION NOTE (autosyncEventDisplayText): %S will be replaced by the account name</span>
<a href="#l2.24"></a><span id="l2.24"> autosyncEventDisplayText=%S is up to date</span>
<a href="#l2.25"></a><span id="l2.25"> # LOCALIZATION NOTE (autosyncEventStatusText): %S will be replaced by total number of downloaded messages</span>
<a href="#l2.26"></a><span id="l2.26"> autosyncEventStatusText=Total number of messages downloaded: %S</span>
<a href="#l2.27"></a><span id="l2.27"> autosyncEventStatusTextNoMsgs=No messages downloaded</span>
<a href="#l2.28"></a><span id="l2.28"> # LOCALIZATION NOTE (autosyncContextDisplayText): %S will be replaced by the account name</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/imapMsgs.properties</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/imapMsgs.properties</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -70,25 +70,31 @@ imapDownloadingMessage=Downloading message…</span>
<a href="#l3.4"></a><span id="l3.4"> imapGettingACLForFolder=Getting folder ACL…</span>
<a href="#l3.5"></a><span id="l3.5"> </span>
<a href="#l3.6"></a><span id="l3.6"> imapGettingServerInfo=Getting Server Configuration Info…</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8"> imapGettingMailboxInfo=Getting Mailbox Configuration Info…</span>
<a href="#l3.9"></a><span id="l3.9"> </span>
<a href="#l3.10"></a><span id="l3.10"> imapEmptyMimePart=This body part will be downloaded on demand.</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-# LOCALIZATION NOTE (imapReceivingMessageHeaders2): Do not translate the word &quot;%S&quot; or &quot;%lu&quot; below.</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-# Place the word %S in your translation where the name of the server should appear.</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-# Place the word %lu where the number of headers should appear.</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-imapReceivingMessageHeaders2=%S Downloading message header %lu of %lu…</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+# LOCALIZATION NOTE (imapReceivingMessageHeaders3): Do not translate the word &quot;%1$S&quot;, &quot;%2$S&quot;, and &quot;%3$S&quot; below.</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+# Place the word %1$S in your translation where the number of headers being downloaded should appear.</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+# Place the word %2$S in your translation where the total number of pending headers should appear.</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+# Place the word %3$S in your translation where the name of the folder being processed should appear.</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+# Note: The account name and colon is automatically encoded first in the displayed string.</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+# Example: &quot;Joe's Account: Downloading message header 100 of 1000 in Drafts…&quot;</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+imapReceivingMessageHeaders3=Downloading message header %1$S of %2$S in %3$S…</span>
<a href="#l3.23"></a><span id="l3.23"> </span>
<a href="#l3.24"></a><span id="l3.24" class="difflineminus">-# LOCALIZATION NOTE (imapReceivingMessageFlags2): Do not translate the word &quot;%S&quot; or &quot;%lu&quot; below.</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineminus">-# Place the word %S in your translation where the name of the server should appear.</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineminus">-# Place the word %lu where the number of flags should appear.</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineminus">-imapReceivingMessageFlags2=%S Downloading message flag %lu of %lu…</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+# LOCALIZATION NOTE (imapReceivingMessageFlags3): Do not translate the word &quot;%1$S&quot;, &quot;%2$S&quot;, and &quot;%3$S&quot; below.</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineplus">+# Place the word %1$S in your translation where the number of the flags being downloaded should appear.</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+# Place the word %2$S in your translation where the total number of pending flags should appear.</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+# Place the word %3$S in your translation where the name of the folder being processed should appear.</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+# Note: The account name and colon is automatically encoded first in the displayed string.</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+# Example: &quot;Jim's Account: Downloading message flag 100 of 1000 in INBOX…&quot;</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+imapReceivingMessageFlags3=Downloading message flag %1$S of %2$S in %3$S…</span>
<a href="#l3.35"></a><span id="l3.35"> </span>
<a href="#l3.36"></a><span id="l3.36"> imapDeletingMessages=Deleting messages…</span>
<a href="#l3.37"></a><span id="l3.37"> </span>
<a href="#l3.38"></a><span id="l3.38"> imapDeletingMessage=Deleting message…</span>
<a href="#l3.39"></a><span id="l3.39"> </span>
<a href="#l3.40"></a><span id="l3.40"> # LOCALIZATION NOTE (imapMovingMessages): Do not translate the word &quot;%S&quot; below.</span>
<a href="#l3.41"></a><span id="l3.41"> # Place the word %S in your translation where the name of the folder should appear.</span>
<a href="#l3.42"></a><span id="l3.42"> imapMovingMessages=Moving messages to %S…</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineat">@@ -100,20 +106,23 @@ imapMovingMessage=Moving message to %S…</span>
<a href="#l3.44"></a><span id="l3.44"> # LOCALIZATION NOTE (imapCopyingMessages): Do not translate the word &quot;%S&quot; below.</span>
<a href="#l3.45"></a><span id="l3.45"> # Place the word %S in your translation where the name of the folder should appear.</span>
<a href="#l3.46"></a><span id="l3.46"> imapCopyingMessages=Copying messages to %S…</span>
<a href="#l3.47"></a><span id="l3.47"> </span>
<a href="#l3.48"></a><span id="l3.48"> # LOCALIZATION NOTE (imapCopyingMessage): Do not translate the word &quot;%S&quot; below.</span>
<a href="#l3.49"></a><span id="l3.49"> # Place the word %S in your translation where the name of the folder should appear.</span>
<a href="#l3.50"></a><span id="l3.50"> imapCopyingMessage=Copying message to %S…</span>
<a href="#l3.51"></a><span id="l3.51"> </span>
<a href="#l3.52"></a><span id="l3.52" class="difflineminus">-# LOCALIZATION NOTE (imapFolderReceivingMessageOf2): Do not translate the word &quot;%S&quot; or &quot;%lu&quot; below.</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineminus">-# Place the word %S in your translation where the name of the folder should appear.</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineminus">-# Place the word %lu where the number of headers should appear.</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineminus">-imapFolderReceivingMessageOf2=%S - Downloading message %lu of %lu…</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineplus">+# LOCALIZATION NOTE (imapFolderReceivingMessageOf3): Do not translate the word &quot;%1$S&quot;, &quot;%2$S&quot;, and &quot;%3$S&quot; below.</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineplus">+# Place the word %1$S in your translation where the number of messages being downloaded should appear.</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineplus">+# Place the word %2$S in your translation where the total number of pending messages should appear.</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineplus">+# Place the word %3$S in your translation where the name of the folder being processed should appear.</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineplus">+# Note: The account name and colon is automatically encoded first in the displayed string.</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+# Example: &quot;Juan's Account: Downloading message 100 of 1000 in Sent…&quot;</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineplus">+imapFolderReceivingMessageOf3=Downloading message %1$S of %2$S in %3$S…</span>
<a href="#l3.63"></a><span id="l3.63"> </span>
<a href="#l3.64"></a><span id="l3.64"> # LOCALIZATION NOTE (imapDiscoveringMailbox): Do not translate the word &quot;%S&quot; below.</span>
<a href="#l3.65"></a><span id="l3.65"> # Place the word %S in your translation where the name of the folder should appear.</span>
<a href="#l3.66"></a><span id="l3.66"> imapDiscoveringMailbox=Found folder: %S</span>
<a href="#l3.67"></a><span id="l3.67"> </span>
<a href="#l3.68"></a><span id="l3.68"> # LOCALIZATION NOTE (imapEnterServerPasswordPrompt): Do not translate the words %1$S and %2$S below.</span>
<a href="#l3.69"></a><span id="l3.69"> # Place the word %1$S in your translation where the username should appear.</span>
<a href="#l3.70"></a><span id="l3.70"> # Place the word %2$S in your translation where the servername should appear.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/imap/src/nsImapProtocol.cpp</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapProtocol.cpp</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -28,17 +28,16 @@</span>
<a href="#l4.4"></a><span id="l4.4"> #include &quot;nsIImapService.h&quot;</span>
<a href="#l4.5"></a><span id="l4.5"> #include &quot;nsISocketTransportService.h&quot;</span>
<a href="#l4.6"></a><span id="l4.6"> #include &quot;nsIStreamListenerTee.h&quot;</span>
<a href="#l4.7"></a><span id="l4.7"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l4.8"></a><span id="l4.8"> #include &quot;nsIDBFolderInfo.h&quot;</span>
<a href="#l4.9"></a><span id="l4.9"> #include &quot;nsIPipe.h&quot;</span>
<a href="#l4.10"></a><span id="l4.10"> #include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l4.11"></a><span id="l4.11"> #include &quot;nsMsgMessageFlags.h&quot;</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-#include &quot;nsImapStringBundle.h&quot;</span>
<a href="#l4.13"></a><span id="l4.13"> #include &quot;nsICopyMsgStreamListener.h&quot;</span>
<a href="#l4.14"></a><span id="l4.14"> #include &quot;nsTextFormatter.h&quot;</span>
<a href="#l4.15"></a><span id="l4.15"> #include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l4.16"></a><span id="l4.16"> #include &quot;nsMsgI18N.h&quot;</span>
<a href="#l4.17"></a><span id="l4.17"> #include &lt;algorithm&gt;</span>
<a href="#l4.18"></a><span id="l4.18"> // for the memory cache...</span>
<a href="#l4.19"></a><span id="l4.19"> #include &quot;nsICacheEntry.h&quot;</span>
<a href="#l4.20"></a><span id="l4.20"> #include &quot;nsICacheStorage.h&quot;</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineat">@@ -483,16 +482,19 @@ nsImapProtocol::nsImapProtocol() : nsMsg</span>
<a href="#l4.22"></a><span id="l4.22">   // m_dataOutputBuf is used by Send Data</span>
<a href="#l4.23"></a><span id="l4.23">   m_dataOutputBuf = (char *) PR_CALLOC(sizeof(char) * OUTPUT_BUFFER_SIZE);</span>
<a href="#l4.24"></a><span id="l4.24">   m_allocatedSize = OUTPUT_BUFFER_SIZE;</span>
<a href="#l4.25"></a><span id="l4.25"> </span>
<a href="#l4.26"></a><span id="l4.26">   // used to buffer incoming data by ReadNextLine</span>
<a href="#l4.27"></a><span id="l4.27">   m_inputStreamBuffer = new nsMsgLineStreamBuffer(OUTPUT_BUFFER_SIZE, true /* allocate new lines */, false /* leave CRLFs on the returned string */);</span>
<a href="#l4.28"></a><span id="l4.28">   m_currentBiffState = nsIMsgFolder::nsMsgBiffState_Unknown;</span>
<a href="#l4.29"></a><span id="l4.29">   m_progressStringName.Truncate();</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+  m_stringIndex = IMAP_EMPTY_STRING_INDEX;</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+  m_progressExpectedNumber = 0;</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+  memset(m_progressCurrentNumber, 0, sizeof m_progressCurrentNumber);</span>
<a href="#l4.33"></a><span id="l4.33"> </span>
<a href="#l4.34"></a><span id="l4.34">   // since these are embedded in the nsImapProtocol object, but passed</span>
<a href="#l4.35"></a><span id="l4.35">   // through proxied xpcom methods, just AddRef them here.</span>
<a href="#l4.36"></a><span id="l4.36">   m_hdrDownloadCache = new nsMsgImapHdrXferInfo();</span>
<a href="#l4.37"></a><span id="l4.37">   m_downloadLineCache = new nsMsgImapLineDownloadCache();</span>
<a href="#l4.38"></a><span id="l4.38"> </span>
<a href="#l4.39"></a><span id="l4.39">   // subscription</span>
<a href="#l4.40"></a><span id="l4.40">   m_autoSubscribe = true;</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineat">@@ -543,21 +545,20 @@ nsImapProtocol::Initialize(nsIImapHostSe</span>
<a href="#l4.42"></a><span id="l4.42">   aServer-&gt;GetUseCompressDeflate(&amp;m_useCompressDeflate);</span>
<a href="#l4.43"></a><span id="l4.43">   NS_ADDREF(m_flagState);</span>
<a href="#l4.44"></a><span id="l4.44"> </span>
<a href="#l4.45"></a><span id="l4.45">   m_hostSessionList = aHostSessionList; // no ref count...host session list has life time &gt; connection</span>
<a href="#l4.46"></a><span id="l4.46">   m_parser.SetHostSessionList(aHostSessionList);</span>
<a href="#l4.47"></a><span id="l4.47">   m_parser.SetFlagState(m_flagState);</span>
<a href="#l4.48"></a><span id="l4.48"> </span>
<a href="#l4.49"></a><span id="l4.49">   // Initialize the empty mime part string on the main thread.</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineminus">-  nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineminus">-  rv = IMAPGetStringBundle(getter_AddRefs(bundle));</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineplus">+  rv = IMAPGetStringBundle(getter_AddRefs(m_bundle));</span>
<a href="#l4.53"></a><span id="l4.53">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.54"></a><span id="l4.54"> </span>
<a href="#l4.55"></a><span id="l4.55" class="difflineminus">-  rv = bundle-&gt;GetStringFromName(u&quot;imapEmptyMimePart&quot;,</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineplus">+  rv = m_bundle-&gt;GetStringFromName(u&quot;imapEmptyMimePart&quot;,</span>
<a href="#l4.57"></a><span id="l4.57">     getter_Copies(m_emptyMimePartString));</span>
<a href="#l4.58"></a><span id="l4.58">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.59"></a><span id="l4.59"> </span>
<a href="#l4.60"></a><span id="l4.60">   // Now initialize the thread for the connection</span>
<a href="#l4.61"></a><span id="l4.61">   if (m_thread == nullptr)</span>
<a href="#l4.62"></a><span id="l4.62">   {</span>
<a href="#l4.63"></a><span id="l4.63">     nsresult rv = NS_NewThread(getter_AddRefs(m_iThread), this);</span>
<a href="#l4.64"></a><span id="l4.64">     if (NS_FAILED(rv))</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineat">@@ -2520,18 +2521,20 @@ void nsImapProtocol::ProcessSelectedStat</span>
<a href="#l4.66"></a><span id="l4.66">         SelectMailbox(mailboxName.get());</span>
<a href="#l4.67"></a><span id="l4.67">         selectIssued = true;</span>
<a href="#l4.68"></a><span id="l4.68">       }</span>
<a href="#l4.69"></a><span id="l4.69">       else if (moreHeadersToDownload &amp;&amp; m_imapMailFolderSink) // we need to fetch older headers</span>
<a href="#l4.70"></a><span id="l4.70">       {</span>
<a href="#l4.71"></a><span id="l4.71">         nsMsgKey *msgIdList = nullptr;</span>
<a href="#l4.72"></a><span id="l4.72">         uint32_t msgCount = 0;</span>
<a href="#l4.73"></a><span id="l4.73">         bool more;</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineminus">-        m_imapMailFolderSink-&gt;GetMsgHdrsToDownload(&amp;more, &amp;m_progressCount,</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineminus">-                                                   &amp;msgCount, &amp;msgIdList);</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineplus">+        m_imapMailFolderSink-&gt;GetMsgHdrsToDownload(&amp;more,</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineplus">+                                                   &amp;m_progressExpectedNumber,</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineplus">+                                                   &amp;msgCount,</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineplus">+                                                   &amp;msgIdList);</span>
<a href="#l4.80"></a><span id="l4.80">         if (msgIdList)</span>
<a href="#l4.81"></a><span id="l4.81">         {</span>
<a href="#l4.82"></a><span id="l4.82">           FolderHeaderDump(msgIdList, msgCount);</span>
<a href="#l4.83"></a><span id="l4.83">           NS_Free(msgIdList);</span>
<a href="#l4.84"></a><span id="l4.84">           m_runningUrl-&gt;SetMoreHeadersToDownload(more);</span>
<a href="#l4.85"></a><span id="l4.85">           // We're going to be re-running this url.</span>
<a href="#l4.86"></a><span id="l4.86">           if (more)</span>
<a href="#l4.87"></a><span id="l4.87">             m_runningUrl-&gt;SetRerunningUrl(true);</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineat">@@ -2632,31 +2635,31 @@ void nsImapProtocol::ProcessSelectedStat</span>
<a href="#l4.89"></a><span id="l4.89">         {</span>
<a href="#l4.90"></a><span id="l4.90">           nsCString messageIdString;</span>
<a href="#l4.91"></a><span id="l4.91">           m_runningUrl-&gt;GetListOfMessageIds(messageIdString);</span>
<a href="#l4.92"></a><span id="l4.92">           // we don't want to send the flags back in a group</span>
<a href="#l4.93"></a><span id="l4.93">           if (HandlingMultipleMessages(messageIdString) || m_imapAction == nsIImapUrl::nsImapMsgDownloadForOffline</span>
<a href="#l4.94"></a><span id="l4.94">              || m_imapAction == nsIImapUrl::nsImapMsgPreview)</span>
<a href="#l4.95"></a><span id="l4.95">           {</span>
<a href="#l4.96"></a><span id="l4.96">             // multiple messages, fetch them all</span>
<a href="#l4.97"></a><span id="l4.97" class="difflineminus">-            SetProgressString(&quot;imapFolderReceivingMessageOf2&quot;);</span>
<a href="#l4.98"></a><span id="l4.98" class="difflineminus">-</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineminus">-            m_progressIndex = 0;</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineminus">-            m_progressCount = CountMessagesInIdString(messageIdString.get());</span>
<a href="#l4.101"></a><span id="l4.101" class="difflineplus">+            SetProgressString(IMAP_MESSAGES_STRING_INDEX);</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineplus">+</span>
<a href="#l4.103"></a><span id="l4.103" class="difflineplus">+            m_progressCurrentNumber[m_stringIndex] = 0;</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineplus">+            m_progressExpectedNumber = CountMessagesInIdString(messageIdString.get());</span>
<a href="#l4.105"></a><span id="l4.105"> </span>
<a href="#l4.106"></a><span id="l4.106">             // we need to set this so we'll get the msg from the memory cache.</span>
<a href="#l4.107"></a><span id="l4.107">             if (m_imapAction == nsIImapUrl::nsImapMsgFetchPeek)</span>
<a href="#l4.108"></a><span id="l4.108">               SetContentModified(IMAP_CONTENT_NOT_MODIFIED);</span>
<a href="#l4.109"></a><span id="l4.109"> </span>
<a href="#l4.110"></a><span id="l4.110">             FetchMessage(messageIdString,</span>
<a href="#l4.111"></a><span id="l4.111">               (m_imapAction == nsIImapUrl::nsImapMsgPreview)</span>
<a href="#l4.112"></a><span id="l4.112">               ? kBodyStart : kEveryThingRFC822Peek);</span>
<a href="#l4.113"></a><span id="l4.113">             if (m_imapAction == nsIImapUrl::nsImapMsgPreview)</span>
<a href="#l4.114"></a><span id="l4.114">               HeaderFetchCompleted();</span>
<a href="#l4.115"></a><span id="l4.115" class="difflineminus">-            SetProgressString(nullptr);</span>
<a href="#l4.116"></a><span id="l4.116" class="difflineplus">+            SetProgressString(IMAP_EMPTY_STRING_INDEX);</span>
<a href="#l4.117"></a><span id="l4.117">           }</span>
<a href="#l4.118"></a><span id="l4.118">           else</span>
<a href="#l4.119"></a><span id="l4.119">           {</span>
<a href="#l4.120"></a><span id="l4.120">             // A single message ID</span>
<a href="#l4.121"></a><span id="l4.121">             nsIMAPeFetchFields whatToFetch = kEveryThingRFC822;</span>
<a href="#l4.122"></a><span id="l4.122">             if(m_imapAction == nsIImapUrl::nsImapMsgFetchPeek)</span>
<a href="#l4.123"></a><span id="l4.123">               whatToFetch = kEveryThingRFC822Peek;</span>
<a href="#l4.124"></a><span id="l4.124"> </span>
<a href="#l4.125"></a><span id="l4.125" class="difflineat">@@ -3061,23 +3064,23 @@ void nsImapProtocol::ProcessSelectedStat</span>
<a href="#l4.126"></a><span id="l4.126">         break;</span>
<a href="#l4.127"></a><span id="l4.127">       case nsIImapUrl::nsImapOnlineToOfflineCopy:</span>
<a href="#l4.128"></a><span id="l4.128">       case nsIImapUrl::nsImapOnlineToOfflineMove:</span>
<a href="#l4.129"></a><span id="l4.129">         {</span>
<a href="#l4.130"></a><span id="l4.130">           nsCString messageIdString;</span>
<a href="#l4.131"></a><span id="l4.131">           nsresult rv = m_runningUrl-&gt;GetListOfMessageIds(messageIdString);</span>
<a href="#l4.132"></a><span id="l4.132">           if (NS_SUCCEEDED(rv))</span>
<a href="#l4.133"></a><span id="l4.133">           {</span>
<a href="#l4.134"></a><span id="l4.134" class="difflineminus">-            SetProgressString(&quot;imapFolderReceivingMessageOf2&quot;);</span>
<a href="#l4.135"></a><span id="l4.135" class="difflineminus">-            m_progressIndex = 0;</span>
<a href="#l4.136"></a><span id="l4.136" class="difflineminus">-            m_progressCount = CountMessagesInIdString(messageIdString.get());</span>
<a href="#l4.137"></a><span id="l4.137" class="difflineplus">+            SetProgressString(IMAP_MESSAGES_STRING_INDEX);</span>
<a href="#l4.138"></a><span id="l4.138" class="difflineplus">+            m_progressCurrentNumber[m_stringIndex] = 0;</span>
<a href="#l4.139"></a><span id="l4.139" class="difflineplus">+            m_progressExpectedNumber = CountMessagesInIdString(messageIdString.get());</span>
<a href="#l4.140"></a><span id="l4.140"> </span>
<a href="#l4.141"></a><span id="l4.141">             FetchMessage(messageIdString, kEveryThingRFC822Peek);</span>
<a href="#l4.142"></a><span id="l4.142"> </span>
<a href="#l4.143"></a><span id="l4.143" class="difflineminus">-            SetProgressString(nullptr);</span>
<a href="#l4.144"></a><span id="l4.144" class="difflineplus">+            SetProgressString(IMAP_EMPTY_STRING_INDEX);</span>
<a href="#l4.145"></a><span id="l4.145">             if (m_imapMailFolderSink)</span>
<a href="#l4.146"></a><span id="l4.146">             {</span>
<a href="#l4.147"></a><span id="l4.147">               ImapOnlineCopyState copyStatus;</span>
<a href="#l4.148"></a><span id="l4.148">               copyStatus = GetServerStateParser().LastCommandSuccessful() ?</span>
<a href="#l4.149"></a><span id="l4.149">                 ImapOnlineCopyStateType::kSuccessfulCopy : ImapOnlineCopyStateType::kFailedCopy;</span>
<a href="#l4.150"></a><span id="l4.150"> </span>
<a href="#l4.151"></a><span id="l4.151">               m_imapMailFolderSink-&gt;OnlineCopyCompleted(this, copyStatus);</span>
<a href="#l4.152"></a><span id="l4.152">               if (GetServerStateParser().LastCommandSuccessful() &amp;&amp;</span>
<a href="#l4.153"></a><span id="l4.153" class="difflineat">@@ -4242,19 +4245,21 @@ void nsImapProtocol::ProcessMailboxUpdat</span>
<a href="#l4.154"></a><span id="l4.154">       new_spec-&gt;mBoxFlags |= kJustExpunged;</span>
<a href="#l4.155"></a><span id="l4.155">     m_waitForBodyIdsMonitor.Enter();</span>
<a href="#l4.156"></a><span id="l4.156">     entered_waitForBodyIdsMonitor = true;</span>
<a href="#l4.157"></a><span id="l4.157"> </span>
<a href="#l4.158"></a><span id="l4.158">     if (m_imapMailFolderSink)</span>
<a href="#l4.159"></a><span id="l4.159">     {</span>
<a href="#l4.160"></a><span id="l4.160">       bool more;</span>
<a href="#l4.161"></a><span id="l4.161">       m_imapMailFolderSink-&gt;UpdateImapMailboxInfo(this, new_spec);</span>
<a href="#l4.162"></a><span id="l4.162" class="difflineminus">-      m_imapMailFolderSink-&gt;GetMsgHdrsToDownload(&amp;more, &amp;m_progressCount,</span>
<a href="#l4.163"></a><span id="l4.163" class="difflineplus">+      m_imapMailFolderSink-&gt;GetMsgHdrsToDownload(&amp;more, &amp;m_progressExpectedNumber,</span>
<a href="#l4.164"></a><span id="l4.164">                                                  &amp;msgCount, &amp;msgIdList);</span>
<a href="#l4.165"></a><span id="l4.165" class="difflineminus">-      m_progressIndex = 0;</span>
<a href="#l4.166"></a><span id="l4.166" class="difflineplus">+      // Assert that either it's empty string OR it must be header string.</span>
<a href="#l4.167"></a><span id="l4.167" class="difflineplus">+      MOZ_ASSERT((m_stringIndex == IMAP_EMPTY_STRING_INDEX) || (m_stringIndex == IMAP_HEADERS_STRING_INDEX));</span>
<a href="#l4.168"></a><span id="l4.168" class="difflineplus">+      m_progressCurrentNumber[m_stringIndex] = 0;</span>
<a href="#l4.169"></a><span id="l4.169">       m_runningUrl-&gt;SetMoreHeadersToDownload(more);</span>
<a href="#l4.170"></a><span id="l4.170">       // We're going to be re-running this url if there are more headers.</span>
<a href="#l4.171"></a><span id="l4.171">       if (more)</span>
<a href="#l4.172"></a><span id="l4.172">         m_runningUrl-&gt;SetRerunningUrl(true);</span>
<a href="#l4.173"></a><span id="l4.173">     }</span>
<a href="#l4.174"></a><span id="l4.174">   }</span>
<a href="#l4.175"></a><span id="l4.175">   else if (!new_spec)</span>
<a href="#l4.176"></a><span id="l4.176">     HandleMemoryFailure();</span>
<a href="#l4.177"></a><span id="l4.177" class="difflineat">@@ -4282,18 +4287,20 @@ void nsImapProtocol::ProcessMailboxUpdat</span>
<a href="#l4.178"></a><span id="l4.178">     WaitForPotentialListOfBodysToFetch(&amp;msgIdList, msgCount);</span>
<a href="#l4.179"></a><span id="l4.179">     if ( msgCount &amp;&amp; GetServerStateParser().LastCommandSuccessful())</span>
<a href="#l4.180"></a><span id="l4.180">     {</span>
<a href="#l4.181"></a><span id="l4.181">       // Tell the url that it should store the msg fetch results offline,</span>
<a href="#l4.182"></a><span id="l4.182">       // while we're dumping the messages, and then restore the setting.</span>
<a href="#l4.183"></a><span id="l4.183">       bool wasStoringOffline;</span>
<a href="#l4.184"></a><span id="l4.184">       m_runningUrl-&gt;GetStoreResultsOffline(&amp;wasStoringOffline);</span>
<a href="#l4.185"></a><span id="l4.185">       m_runningUrl-&gt;SetStoreResultsOffline(true);</span>
<a href="#l4.186"></a><span id="l4.186" class="difflineminus">-      m_progressIndex = 0;</span>
<a href="#l4.187"></a><span id="l4.187" class="difflineminus">-      m_progressCount = msgCount;</span>
<a href="#l4.188"></a><span id="l4.188" class="difflineplus">+      // Assert that either it's empty string OR it must be message string.</span>
<a href="#l4.189"></a><span id="l4.189" class="difflineplus">+      MOZ_ASSERT((m_stringIndex == IMAP_EMPTY_STRING_INDEX) || (m_stringIndex == IMAP_MESSAGES_STRING_INDEX));</span>
<a href="#l4.190"></a><span id="l4.190" class="difflineplus">+      m_progressCurrentNumber[m_stringIndex] = 0;</span>
<a href="#l4.191"></a><span id="l4.191" class="difflineplus">+      m_progressExpectedNumber = msgCount;</span>
<a href="#l4.192"></a><span id="l4.192">       FolderMsgDump(msgIdList, msgCount, kEveryThingRFC822Peek);</span>
<a href="#l4.193"></a><span id="l4.193">       m_runningUrl-&gt;SetStoreResultsOffline(wasStoringOffline);</span>
<a href="#l4.194"></a><span id="l4.194">     }</span>
<a href="#l4.195"></a><span id="l4.195">   }</span>
<a href="#l4.196"></a><span id="l4.196">   if (!GetServerStateParser().LastCommandSuccessful())</span>
<a href="#l4.197"></a><span id="l4.197">     GetServerStateParser().ResetFlagInfo();</span>
<a href="#l4.198"></a><span id="l4.198"> </span>
<a href="#l4.199"></a><span id="l4.199">   NS_IF_RELEASE(new_spec);</span>
<a href="#l4.200"></a><span id="l4.200" class="difflineat">@@ -4304,29 +4311,29 @@ void nsImapProtocol::FolderHeaderDump(ui</span>
<a href="#l4.201"></a><span id="l4.201">   FolderMsgDump(msgUids, msgCount, kHeadersRFC822andUid);</span>
<a href="#l4.202"></a><span id="l4.202"> }</span>
<a href="#l4.203"></a><span id="l4.203"> </span>
<a href="#l4.204"></a><span id="l4.204"> void nsImapProtocol::FolderMsgDump(uint32_t *msgUids, uint32_t msgCount, nsIMAPeFetchFields fields)</span>
<a href="#l4.205"></a><span id="l4.205"> {</span>
<a href="#l4.206"></a><span id="l4.206">   // lets worry about this progress stuff later.</span>
<a href="#l4.207"></a><span id="l4.207">   switch (fields) {</span>
<a href="#l4.208"></a><span id="l4.208">   case kHeadersRFC822andUid:</span>
<a href="#l4.209"></a><span id="l4.209" class="difflineminus">-    SetProgressString(&quot;imapReceivingMessageHeaders2&quot;);</span>
<a href="#l4.210"></a><span id="l4.210" class="difflineplus">+    SetProgressString(IMAP_HEADERS_STRING_INDEX);</span>
<a href="#l4.211"></a><span id="l4.211">     break;</span>
<a href="#l4.212"></a><span id="l4.212">   case kFlags:</span>
<a href="#l4.213"></a><span id="l4.213" class="difflineminus">-    SetProgressString(&quot;imapReceivingMessageFlags2&quot;);</span>
<a href="#l4.214"></a><span id="l4.214" class="difflineplus">+    SetProgressString(IMAP_FLAGS_STRING_INDEX);</span>
<a href="#l4.215"></a><span id="l4.215">     break;</span>
<a href="#l4.216"></a><span id="l4.216">   default:</span>
<a href="#l4.217"></a><span id="l4.217" class="difflineminus">-    SetProgressString(&quot;imapFolderReceivingMessageOf2&quot;);</span>
<a href="#l4.218"></a><span id="l4.218" class="difflineplus">+    SetProgressString(IMAP_MESSAGES_STRING_INDEX);</span>
<a href="#l4.219"></a><span id="l4.219">     break;</span>
<a href="#l4.220"></a><span id="l4.220">   }</span>
<a href="#l4.221"></a><span id="l4.221"> </span>
<a href="#l4.222"></a><span id="l4.222">   FolderMsgDumpLoop(msgUids, msgCount, fields);</span>
<a href="#l4.223"></a><span id="l4.223"> </span>
<a href="#l4.224"></a><span id="l4.224" class="difflineminus">-  SetProgressString(nullptr);</span>
<a href="#l4.225"></a><span id="l4.225" class="difflineplus">+  SetProgressString(IMAP_EMPTY_STRING_INDEX);</span>
<a href="#l4.226"></a><span id="l4.226"> }</span>
<a href="#l4.227"></a><span id="l4.227"> </span>
<a href="#l4.228"></a><span id="l4.228"> void nsImapProtocol::WaitForPotentialListOfBodysToFetch(uint32_t **msgIdList, uint32_t &amp;msgCount)</span>
<a href="#l4.229"></a><span id="l4.229"> {</span>
<a href="#l4.230"></a><span id="l4.230">   PRIntervalTime sleepTime = kImapSleepTime;</span>
<a href="#l4.231"></a><span id="l4.231"> </span>
<a href="#l4.232"></a><span id="l4.232">   ReentrantMonitorAutoEnter fetchListMon(m_fetchBodyListMonitor);</span>
<a href="#l4.233"></a><span id="l4.233">   while(!m_fetchBodyListIsNew &amp;&amp; !DeathSignalReceived())</span>
<a href="#l4.234"></a><span id="l4.234" class="difflineat">@@ -5169,44 +5176,70 @@ nsImapProtocol::AlertUserEventFromServer</span>
<a href="#l4.235"></a><span id="l4.235"> </span>
<a href="#l4.236"></a><span id="l4.236"> void nsImapProtocol::ResetProgressInfo()</span>
<a href="#l4.237"></a><span id="l4.237"> {</span>
<a href="#l4.238"></a><span id="l4.238">   m_lastProgressTime = 0;</span>
<a href="#l4.239"></a><span id="l4.239">   m_lastPercent = -1;</span>
<a href="#l4.240"></a><span id="l4.240">   m_lastProgressStringName.Truncate();</span>
<a href="#l4.241"></a><span id="l4.241"> }</span>
<a href="#l4.242"></a><span id="l4.242"> </span>
<a href="#l4.243"></a><span id="l4.243" class="difflineminus">-void nsImapProtocol::SetProgressString(const char * stringName)</span>
<a href="#l4.244"></a><span id="l4.244" class="difflineminus">-{</span>
<a href="#l4.245"></a><span id="l4.245" class="difflineminus">-  m_progressStringName.Assign(stringName);</span>
<a href="#l4.246"></a><span id="l4.246" class="difflineminus">-  if (!m_progressStringName.IsEmpty() &amp;&amp; m_imapServerSink)</span>
<a href="#l4.247"></a><span id="l4.247" class="difflineminus">-    m_imapServerSink-&gt;GetImapStringByName(stringName,</span>
<a href="#l4.248"></a><span id="l4.248" class="difflineminus">-                                          m_progressString);</span>
<a href="#l4.249"></a><span id="l4.249" class="difflineplus">+void nsImapProtocol::SetProgressString(uint32_t aStringIndex)</span>
<a href="#l4.250"></a><span id="l4.250" class="difflineplus">+{</span>
<a href="#l4.251"></a><span id="l4.251" class="difflineplus">+  m_stringIndex = aStringIndex;</span>
<a href="#l4.252"></a><span id="l4.252" class="difflineplus">+  MOZ_ASSERT(m_stringIndex &lt;= IMAP_EMPTY_STRING_INDEX);</span>
<a href="#l4.253"></a><span id="l4.253" class="difflineplus">+  switch (m_stringIndex)</span>
<a href="#l4.254"></a><span id="l4.254" class="difflineplus">+  {</span>
<a href="#l4.255"></a><span id="l4.255" class="difflineplus">+    case IMAP_HEADERS_STRING_INDEX:</span>
<a href="#l4.256"></a><span id="l4.256" class="difflineplus">+      m_progressStringName = u&quot;imapReceivingMessageHeaders3&quot;;</span>
<a href="#l4.257"></a><span id="l4.257" class="difflineplus">+      break;</span>
<a href="#l4.258"></a><span id="l4.258" class="difflineplus">+    case IMAP_MESSAGES_STRING_INDEX:</span>
<a href="#l4.259"></a><span id="l4.259" class="difflineplus">+      m_progressStringName = u&quot;imapFolderReceivingMessageOf3&quot;;</span>
<a href="#l4.260"></a><span id="l4.260" class="difflineplus">+      break;</span>
<a href="#l4.261"></a><span id="l4.261" class="difflineplus">+    case IMAP_FLAGS_STRING_INDEX:</span>
<a href="#l4.262"></a><span id="l4.262" class="difflineplus">+      m_progressStringName = u&quot;imapReceivingMessageFlags3&quot;;</span>
<a href="#l4.263"></a><span id="l4.263" class="difflineplus">+      break;</span>
<a href="#l4.264"></a><span id="l4.264" class="difflineplus">+    case IMAP_EMPTY_STRING_INDEX:</span>
<a href="#l4.265"></a><span id="l4.265" class="difflineplus">+    default:</span>
<a href="#l4.266"></a><span id="l4.266" class="difflineplus">+      break;</span>
<a href="#l4.267"></a><span id="l4.267" class="difflineplus">+  }</span>
<a href="#l4.268"></a><span id="l4.268"> }</span>
<a href="#l4.269"></a><span id="l4.269"> </span>
<a href="#l4.270"></a><span id="l4.270"> void</span>
<a href="#l4.271"></a><span id="l4.271"> nsImapProtocol::ShowProgress()</span>
<a href="#l4.272"></a><span id="l4.272"> {</span>
<a href="#l4.273"></a><span id="l4.273" class="difflineminus">-  if (!m_progressString.IsEmpty() &amp;&amp; !m_progressStringName.IsEmpty())</span>
<a href="#l4.274"></a><span id="l4.274" class="difflineminus">-  {</span>
<a href="#l4.275"></a><span id="l4.275" class="difflineminus">-    char16_t *progressString = NULL;</span>
<a href="#l4.276"></a><span id="l4.276" class="difflineplus">+  if (m_imapServerSink &amp;&amp; (m_stringIndex != IMAP_EMPTY_STRING_INDEX))</span>
<a href="#l4.277"></a><span id="l4.277" class="difflineplus">+  {</span>
<a href="#l4.278"></a><span id="l4.278" class="difflineplus">+    nsString progressString;</span>
<a href="#l4.279"></a><span id="l4.279">     const char *mailboxName = GetServerStateParser().GetSelectedMailboxName();</span>
<a href="#l4.280"></a><span id="l4.280">     nsString unicodeMailboxName;</span>
<a href="#l4.281"></a><span id="l4.281">     nsresult rv = CopyMUTF7toUTF16(nsDependentCString(mailboxName),</span>
<a href="#l4.282"></a><span id="l4.282">                                    unicodeMailboxName);</span>
<a href="#l4.283"></a><span id="l4.283" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l4.284"></a><span id="l4.284" class="difflineminus">-    {</span>
<a href="#l4.285"></a><span id="l4.285" class="difflineminus">-      // ### should convert mailboxName to char16_t and change %s to %S in msg text</span>
<a href="#l4.286"></a><span id="l4.286" class="difflineminus">-      progressString = nsTextFormatter::smprintf(m_progressString.get(),</span>
<a href="#l4.287"></a><span id="l4.287" class="difflineminus">-                                unicodeMailboxName.get(), ++m_progressIndex, m_progressCount);</span>
<a href="#l4.288"></a><span id="l4.288" class="difflineminus">-      if (progressString)</span>
<a href="#l4.289"></a><span id="l4.289" class="difflineminus">-      {</span>
<a href="#l4.290"></a><span id="l4.290" class="difflineminus">-        PercentProgressUpdateEvent(progressString, m_progressIndex, m_progressCount);</span>
<a href="#l4.291"></a><span id="l4.291" class="difflineminus">-        nsTextFormatter::smprintf_free(progressString);</span>
<a href="#l4.292"></a><span id="l4.292" class="difflineminus">-      }</span>
<a href="#l4.293"></a><span id="l4.293" class="difflineplus">+    NS_ENSURE_SUCCESS_VOID(rv);</span>
<a href="#l4.294"></a><span id="l4.294" class="difflineplus">+</span>
<a href="#l4.295"></a><span id="l4.295" class="difflineplus">+    int32_t progressCurrentNumber = ++m_progressCurrentNumber[m_stringIndex];</span>
<a href="#l4.296"></a><span id="l4.296" class="difflineplus">+    nsAutoString progressCurrentNumberString;</span>
<a href="#l4.297"></a><span id="l4.297" class="difflineplus">+    progressCurrentNumberString.AppendInt(progressCurrentNumber);</span>
<a href="#l4.298"></a><span id="l4.298" class="difflineplus">+</span>
<a href="#l4.299"></a><span id="l4.299" class="difflineplus">+    nsAutoString progressExpectedNumberString;</span>
<a href="#l4.300"></a><span id="l4.300" class="difflineplus">+    progressExpectedNumberString.AppendInt(m_progressExpectedNumber);</span>
<a href="#l4.301"></a><span id="l4.301" class="difflineplus">+</span>
<a href="#l4.302"></a><span id="l4.302" class="difflineplus">+    const char16_t *formatStrings[] = {</span>
<a href="#l4.303"></a><span id="l4.303" class="difflineplus">+      progressCurrentNumberString.get(),</span>
<a href="#l4.304"></a><span id="l4.304" class="difflineplus">+      progressExpectedNumberString.get(),</span>
<a href="#l4.305"></a><span id="l4.305" class="difflineplus">+      unicodeMailboxName.get()</span>
<a href="#l4.306"></a><span id="l4.306" class="difflineplus">+    };</span>
<a href="#l4.307"></a><span id="l4.307" class="difflineplus">+</span>
<a href="#l4.308"></a><span id="l4.308" class="difflineplus">+    rv = m_bundle-&gt;FormatStringFromName(</span>
<a href="#l4.309"></a><span id="l4.309" class="difflineplus">+                    m_progressStringName.get(),</span>
<a href="#l4.310"></a><span id="l4.310" class="difflineplus">+                    formatStrings, 3, getter_Copies(progressString));</span>
<a href="#l4.311"></a><span id="l4.311" class="difflineplus">+</span>
<a href="#l4.312"></a><span id="l4.312" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; !progressString.IsEmpty())</span>
<a href="#l4.313"></a><span id="l4.313" class="difflineplus">+    {</span>
<a href="#l4.314"></a><span id="l4.314" class="difflineplus">+      PercentProgressUpdateEvent(progressString.get(), progressCurrentNumber,</span>
<a href="#l4.315"></a><span id="l4.315" class="difflineplus">+                                m_progressExpectedNumber);</span>
<a href="#l4.316"></a><span id="l4.316">     }</span>
<a href="#l4.317"></a><span id="l4.317">   }</span>
<a href="#l4.318"></a><span id="l4.318"> }</span>
<a href="#l4.319"></a><span id="l4.319"> </span>
<a href="#l4.320"></a><span id="l4.320"> void</span>
<a href="#l4.321"></a><span id="l4.321"> nsImapProtocol::ProgressEventFunctionUsingName(const char* aMsgName)</span>
<a href="#l4.322"></a><span id="l4.322"> {</span>
<a href="#l4.323"></a><span id="l4.323">   if (m_imapMailFolderSink &amp;&amp; !m_lastProgressStringName.Equals(aMsgName))</span>
<a href="#l4.324"></a><span id="l4.324" class="difflineat">@@ -5226,17 +5259,17 @@ nsImapProtocol::ProgressEventFunctionUsi</span>
<a href="#l4.325"></a><span id="l4.325">     nsString unicodeStr;</span>
<a href="#l4.326"></a><span id="l4.326">     nsresult rv = CopyMUTF7toUTF16(nsDependentCString(aExtraInfo), unicodeStr);</span>
<a href="#l4.327"></a><span id="l4.327">     if (NS_SUCCEEDED(rv))</span>
<a href="#l4.328"></a><span id="l4.328">       m_imapMailFolderSink-&gt;ProgressStatusString(this, aMsgName, unicodeStr.get());</span>
<a href="#l4.329"></a><span id="l4.329">   }</span>
<a href="#l4.330"></a><span id="l4.330"> }</span>
<a href="#l4.331"></a><span id="l4.331"> </span>
<a href="#l4.332"></a><span id="l4.332"> void</span>
<a href="#l4.333"></a><span id="l4.333" class="difflineminus">-nsImapProtocol::PercentProgressUpdateEvent(char16_t *message, int64_t currentProgress, int64_t maxProgress)</span>
<a href="#l4.334"></a><span id="l4.334" class="difflineplus">+nsImapProtocol::PercentProgressUpdateEvent(const char16_t *message, int64_t currentProgress, int64_t maxProgress)</span>
<a href="#l4.335"></a><span id="l4.335"> {</span>
<a href="#l4.336"></a><span id="l4.336">   int64_t nowMS = 0;</span>
<a href="#l4.337"></a><span id="l4.337">   int32_t percent = (100 * currentProgress) / maxProgress;</span>
<a href="#l4.338"></a><span id="l4.338">   if (percent == m_lastPercent)</span>
<a href="#l4.339"></a><span id="l4.339">     return; // hasn't changed, right? So just return. Do we need to clear this anywhere?</span>
<a href="#l4.340"></a><span id="l4.340"> </span>
<a href="#l4.341"></a><span id="l4.341">   if (percent &lt; 100)  // always need to do 100%</span>
<a href="#l4.342"></a><span id="l4.342">   {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/imap/src/nsImapProtocol.h</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapProtocol.h</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -53,16 +53,17 @@</span>
<a href="#l5.4"></a><span id="l5.4"> #include &quot;nsAutoPtr.h&quot;</span>
<a href="#l5.5"></a><span id="l5.5"> #include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l5.6"></a><span id="l5.6"> #include &quot;nsIMsgAsyncPrompter.h&quot;</span>
<a href="#l5.7"></a><span id="l5.7"> #include &quot;mozilla/ReentrantMonitor.h&quot;</span>
<a href="#l5.8"></a><span id="l5.8"> #include &quot;nsSyncRunnableHelpers.h&quot;</span>
<a href="#l5.9"></a><span id="l5.9"> #include &quot;nsICacheEntryOpenCallback.h&quot;</span>
<a href="#l5.10"></a><span id="l5.10"> #include &quot;nsIProtocolProxyCallback.h&quot;</span>
<a href="#l5.11"></a><span id="l5.11"> #include &quot;nsICancelable.h&quot;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+#include &quot;nsImapStringBundle.h&quot;</span>
<a href="#l5.13"></a><span id="l5.13"> </span>
<a href="#l5.14"></a><span id="l5.14"> class nsIMAPMessagePartIDArray;</span>
<a href="#l5.15"></a><span id="l5.15"> class nsIMsgIncomingServer;</span>
<a href="#l5.16"></a><span id="l5.16"> class nsIPrefBranch;</span>
<a href="#l5.17"></a><span id="l5.17"> class nsIMAPMailboxInfo;</span>
<a href="#l5.18"></a><span id="l5.18"> </span>
<a href="#l5.19"></a><span id="l5.19"> #define kDownLoadCacheSize 16000 // was 1536 - try making it bigger</span>
<a href="#l5.20"></a><span id="l5.20"> </span>
<a href="#l5.21"></a><span id="l5.21" class="difflineat">@@ -121,16 +122,25 @@ private:</span>
<a href="#l5.22"></a><span id="l5.22"> </span>
<a href="#l5.23"></a><span id="l5.23"> #define IMAP_RECEIVED_GREETING        0x00000001  /* should we pause for the next read */</span>
<a href="#l5.24"></a><span id="l5.24"> #define  IMAP_CONNECTION_IS_OPEN        0x00000004  /* is the connection currently open? */</span>
<a href="#l5.25"></a><span id="l5.25"> #define IMAP_WAITING_FOR_DATA         0x00000008</span>
<a href="#l5.26"></a><span id="l5.26"> #define IMAP_CLEAN_UP_URL_STATE       0x00000010 // processing clean up url state</span>
<a href="#l5.27"></a><span id="l5.27"> #define IMAP_ISSUED_LANGUAGE_REQUEST  0x00000020 // make sure we only issue the language request once per connection...</span>
<a href="#l5.28"></a><span id="l5.28"> #define IMAP_ISSUED_COMPRESS_REQUEST  0x00000040 // make sure we only request compression once</span>
<a href="#l5.29"></a><span id="l5.29"> </span>
<a href="#l5.30"></a><span id="l5.30" class="difflineplus">+// There are 3 types of progress strings for items downloaded from IMAP servers.</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+// An index is needed to keep track of the current count of the number of each</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+// item type downloaded. The IMAP_EMPTY_STRING_INDEX means no string displayed.</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineplus">+#define IMAP_NUMBER_OF_PROGRESS_STRINGS 4</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineplus">+#define IMAP_HEADERS_STRING_INDEX       0</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineplus">+#define IMAP_FLAGS_STRING_INDEX         1</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+#define IMAP_MESSAGES_STRING_INDEX      2</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineplus">+#define IMAP_EMPTY_STRING_INDEX         3</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineplus">+</span>
<a href="#l5.39"></a><span id="l5.39"> class nsImapProtocol : public nsIImapProtocol,</span>
<a href="#l5.40"></a><span id="l5.40">                        public nsIRunnable,</span>
<a href="#l5.41"></a><span id="l5.41">                        public nsIInputStreamCallback,</span>
<a href="#l5.42"></a><span id="l5.42">                        public nsSupportsWeakReference,</span>
<a href="#l5.43"></a><span id="l5.43">                        public nsMsgProtocol,</span>
<a href="#l5.44"></a><span id="l5.44">                        public nsIImapProtocolSink,</span>
<a href="#l5.45"></a><span id="l5.45">                        public nsIMsgAsyncPromptListener,</span>
<a href="#l5.46"></a><span id="l5.46">                        public nsIProtocolProxyCallback</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineat">@@ -241,17 +251,17 @@ public:</span>
<a href="#l5.48"></a><span id="l5.48">   void DiscoverMailboxSpec(nsImapMailboxSpec * adoptedBoxSpec);</span>
<a href="#l5.49"></a><span id="l5.49">   void AlertUserEventUsingName(const char* aMessageId);</span>
<a href="#l5.50"></a><span id="l5.50">   void AlertUserEvent(const char * message);</span>
<a href="#l5.51"></a><span id="l5.51">   void AlertUserEventFromServer(const char * aServerEvent);</span>
<a href="#l5.52"></a><span id="l5.52"> </span>
<a href="#l5.53"></a><span id="l5.53">   void ProgressEventFunctionUsingName(const char* aMsgId);</span>
<a href="#l5.54"></a><span id="l5.54">   void ProgressEventFunctionUsingNameWithString(const char* aMsgName, const char *</span>
<a href="#l5.55"></a><span id="l5.55">     aExtraInfo);</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineminus">-  void PercentProgressUpdateEvent(char16_t *message, int64_t currentProgress, int64_t maxProgress);</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineplus">+  void PercentProgressUpdateEvent(const char16_t *message, int64_t currentProgress, int64_t maxProgress);</span>
<a href="#l5.58"></a><span id="l5.58">   void ShowProgress();</span>
<a href="#l5.59"></a><span id="l5.59"> </span>
<a href="#l5.60"></a><span id="l5.60">   // utility function calls made by the server</span>
<a href="#l5.61"></a><span id="l5.61"> </span>
<a href="#l5.62"></a><span id="l5.62">   void Copy(const char * messageList, const char *destinationMailbox,</span>
<a href="#l5.63"></a><span id="l5.63">     bool idsAreUid);</span>
<a href="#l5.64"></a><span id="l5.64">   void Search(const char * searchCriteria,  bool useUID,</span>
<a href="#l5.65"></a><span id="l5.65">     bool notifyHit = true);</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineat">@@ -627,25 +637,26 @@ private:</span>
<a href="#l5.67"></a><span id="l5.67"> </span>
<a href="#l5.68"></a><span id="l5.68">   nsCString m_logonHost;</span>
<a href="#l5.69"></a><span id="l5.69">   nsCString m_logonCookie;</span>
<a href="#l5.70"></a><span id="l5.70">   int16_t m_logonPort;</span>
<a href="#l5.71"></a><span id="l5.71">   </span>
<a href="#l5.72"></a><span id="l5.72">   nsString mAcceptLanguages;</span>
<a href="#l5.73"></a><span id="l5.73">   </span>
<a href="#l5.74"></a><span id="l5.74">   // progress stuff</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineminus">-  void SetProgressString(const char* stringName);</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineplus">+  void SetProgressString(uint32_t aStringIndex);</span>
<a href="#l5.77"></a><span id="l5.77">   </span>
<a href="#l5.78"></a><span id="l5.78" class="difflineminus">-  nsString m_progressString;</span>
<a href="#l5.79"></a><span id="l5.79" class="difflineminus">-  nsCString     m_progressStringName;</span>
<a href="#l5.80"></a><span id="l5.80" class="difflineminus">-  int32_t       m_progressIndex;</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineminus">-  int32_t       m_progressCount;</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineplus">+  nsString      m_progressStringName;</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineplus">+  uint32_t      m_stringIndex;</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineplus">+  int32_t       m_progressCurrentNumber[IMAP_NUMBER_OF_PROGRESS_STRINGS];</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineplus">+  int32_t       m_progressExpectedNumber;</span>
<a href="#l5.86"></a><span id="l5.86">   nsCString     m_lastProgressStringName;</span>
<a href="#l5.87"></a><span id="l5.87">   int32_t       m_lastPercent;</span>
<a href="#l5.88"></a><span id="l5.88">   int64_t       m_lastProgressTime;</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineplus">+  nsCOMPtr&lt;nsIStringBundle&gt; m_bundle;</span>
<a href="#l5.90"></a><span id="l5.90"> </span>
<a href="#l5.91"></a><span id="l5.91">   bool m_notifySearchHit;</span>
<a href="#l5.92"></a><span id="l5.92">   bool m_checkForNewMailDownloadsHeaders;</span>
<a href="#l5.93"></a><span id="l5.93">   bool m_needNoop;</span>
<a href="#l5.94"></a><span id="l5.94">   bool m_idle;</span>
<a href="#l5.95"></a><span id="l5.95">   bool m_useIdle;</span>
<a href="#l5.96"></a><span id="l5.96">   int32_t m_noopCount;</span>
<a href="#l5.97"></a><span id="l5.97">   bool    m_autoSubscribe, m_autoUnsubscribe, m_autoSubscribeOnOpen;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/suite/locales/en-US/chrome/mailnews/imapMsgs.properties</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/suite/locales/en-US/chrome/mailnews/imapMsgs.properties</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -75,25 +75,31 @@ imapGettingACLForFolder=Getting folder ACL…</span>
<a href="#l6.4"></a><span id="l6.4"> imapGettingServerInfo=Getting Server Configuration Info…</span>
<a href="#l6.5"></a><span id="l6.5"> </span>
<a href="#l6.6"></a><span id="l6.6"> # Status - getting mailbox info</span>
<a href="#l6.7"></a><span id="l6.7"> imapGettingMailboxInfo=Getting Mailbox Configuration Info…</span>
<a href="#l6.8"></a><span id="l6.8"> </span>
<a href="#l6.9"></a><span id="l6.9"> # Status - empty mime part</span>
<a href="#l6.10"></a><span id="l6.10"> imapEmptyMimePart=This body part will be downloaded on demand.</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-# LOCALIZATION NOTE (imapReceivingMessageHeaders2): Do not translate the word &quot;%S&quot; or &quot;%lu&quot; below.</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-# Place the word %S in your translation where the name of the server should appear.</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-# Place the word %lu where the number of headers should appear.</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineminus">-imapReceivingMessageHeaders2=%S Downloading message header %lu of %lu…</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+# LOCALIZATION NOTE (imapReceivingMessageHeaders3): Do not translate the word &quot;%1$S&quot;, &quot;%2$S&quot;, and &quot;%3$S&quot; below.</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+# Place the word %1$S in your translation where the number of headers being downloaded should appear.</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+# Place the word %2$S in your translation where the total number of pending headers should appear.</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+# Place the word %3$S in your translation where the name of the folder being processed should appear.</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+# Note: The account name and colon is automatically encoded first in the displayed string.</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineplus">+# Example: &quot;Joe's Account: Downloading message header 100 of 1000 in Drafts…&quot;</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+imapReceivingMessageHeaders3=Downloading message header %1$S of %2$S in %3$S…</span>
<a href="#l6.23"></a><span id="l6.23"> </span>
<a href="#l6.24"></a><span id="l6.24" class="difflineminus">-# LOCALIZATION NOTE (imapReceivingMessageFlags2): Do not translate the word &quot;%S&quot; or &quot;%lu&quot; below.</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineminus">-# Place the word %S in your translation where the name of the server should appear.</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineminus">-# Place the word %lu where the number of flags should appear.</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineminus">-imapReceivingMessageFlags2=%S Downloading message flag %lu of %lu…</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineplus">+# LOCALIZATION NOTE (imapReceivingMessageFlags3): Do not translate the word &quot;%1$S&quot;, &quot;%2$S&quot;, and &quot;%3$S&quot; below.</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineplus">+# Place the word %1$S in your translation where the number of the flags being downloaded should appear.</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineplus">+# Place the word %2$S in your translation where the total number of pending flags should appear.</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+# Place the word %3$S in your translation where the name of the folder being processed should appear.</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+# Note: The account name and colon is automatically encoded first in the displayed string.</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+# Example: &quot;Jim's Account: Downloading message flag 100 of 1000 in INBOX…&quot;</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+imapReceivingMessageFlags3=Downloading message flag %1$S of %2$S in %3$S…</span>
<a href="#l6.35"></a><span id="l6.35"> </span>
<a href="#l6.36"></a><span id="l6.36"> imapDeletingMessages=Deleting messages…</span>
<a href="#l6.37"></a><span id="l6.37"> </span>
<a href="#l6.38"></a><span id="l6.38"> imapDeletingMessage=Deleting message…</span>
<a href="#l6.39"></a><span id="l6.39"> </span>
<a href="#l6.40"></a><span id="l6.40"> # LOCALIZATION NOTE (imapMovingMessages): Do not translate the word &quot;%S&quot; below.</span>
<a href="#l6.41"></a><span id="l6.41"> # Place the word %S in your translation where the name of the folder should appear.</span>
<a href="#l6.42"></a><span id="l6.42"> imapMovingMessages=Moving messages to %S…</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineat">@@ -105,20 +111,23 @@ imapMovingMessage=Moving message to %S…</span>
<a href="#l6.44"></a><span id="l6.44"> # LOCALIZATION NOTE (imapCopyingMessages): Do not translate the word &quot;%S&quot; below.</span>
<a href="#l6.45"></a><span id="l6.45"> # Place the word %S in your translation where the name of the folder should appear.</span>
<a href="#l6.46"></a><span id="l6.46"> imapCopyingMessages=Copying messages to %S…</span>
<a href="#l6.47"></a><span id="l6.47"> </span>
<a href="#l6.48"></a><span id="l6.48"> # LOCALIZATION NOTE (imapCopyingMessage): Do not translate the word &quot;%S&quot; below.</span>
<a href="#l6.49"></a><span id="l6.49"> # Place the word %S in your translation where the name of the folder should appear.</span>
<a href="#l6.50"></a><span id="l6.50"> imapCopyingMessage=Copying message to %S…</span>
<a href="#l6.51"></a><span id="l6.51"> </span>
<a href="#l6.52"></a><span id="l6.52" class="difflineminus">-# LOCALIZATION NOTE (imapFolderReceivingMessageOf2): Do not translate the word &quot;%S&quot; or &quot;%lu&quot; below.</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineminus">-# Place the word %S in your translation where the name of the folder should appear.</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineminus">-# Place the word %lu where the number of headers should appear.</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineminus">-imapFolderReceivingMessageOf2=%S - Downloading message %lu of %lu…</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineplus">+# LOCALIZATION NOTE (imapFolderReceivingMessageOf3): Do not translate the word &quot;%1$S&quot;, &quot;%2$S&quot;, and &quot;%3$S&quot; below.</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineplus">+# Place the word %1$S in your translation where the number of messages being downloaded should appear.</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineplus">+# Place the word %2$S in your translation where the total number of pending messages should appear.</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineplus">+# Place the word %3$S in your translation where the name of the folder being processed should appear.</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineplus">+# Note: The account name and colon is automatically encoded first in the displayed string.</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineplus">+# Example: &quot;Juan's Account: Downloading message 100 of 1000 in Sent…&quot;</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineplus">+imapFolderReceivingMessageOf3=Downloading message %1$S of %2$S in %3$S…</span>
<a href="#l6.63"></a><span id="l6.63"> </span>
<a href="#l6.64"></a><span id="l6.64"> # LOCALIZATION NOTE (imapDiscoveringMailbox): Do not translate the word &quot;%S&quot; below.</span>
<a href="#l6.65"></a><span id="l6.65"> # Place the word %S in your translation where the name of the folder should appear.</span>
<a href="#l6.66"></a><span id="l6.66"> imapDiscoveringMailbox=Found folder: %S</span>
<a href="#l6.67"></a><span id="l6.67"> </span>
<a href="#l6.68"></a><span id="l6.68"> # LOCALIZATION NOTE (imapEnterServerPasswordPrompt): Do not translate the words %1$S and %2$S below.</span>
<a href="#l6.69"></a><span id="l6.69"> # Place the word %1$S in your translation where the username should appear.</span>
<a href="#l6.70"></a><span id="l6.70"> # Place the word %2$S in your translation where the servername should appear.</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

