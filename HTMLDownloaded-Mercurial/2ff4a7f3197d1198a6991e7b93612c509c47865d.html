<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 19091:2ff4a7f3197d1198a6991e7b93612c509c47865d</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 2ff4a7f3197d1198a6991e7b93612c509c47865d" />
<meta property="og:url" content="/comm-central/rev/2ff4a7f3197d1198a6991e7b93612c509c47865d" />
<meta property="og:description" content="Bug 1243498 - Remove Eudora import. r=mkmelin" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 2ff4a7f3197d1198a6991e7b93612c509c47865d 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/2ff4a7f3197d1198a6991e7b93612c509c47865d">shortlog</a> |
<a href="/comm-central/log/2ff4a7f3197d1198a6991e7b93612c509c47865d">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/2ff4a7f3197d1198a6991e7b93612c509c47865d">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/2ff4a7f3197d1198a6991e7b93612c509c47865d">files</a> |
changeset |
<a href="/comm-central/raw-rev/2ff4a7f3197d1198a6991e7b93612c509c47865d">raw</a>  | <a href="/comm-central/archive/2ff4a7f3197d1198a6991e7b93612c509c47865d.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1243498">Bug 1243498</a> - Remove Eudora import. r=mkmelin
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#111;&#114;&#103;&#32;&#75;</td></tr>
<tr><td></td><td class="date age">Sat, 26 Mar 2016 18:02:34 +0100</td></tr>

<tr>
 <td>changeset 19091</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/2ff4a7f3197d1198a6991e7b93612c509c47865d">2ff4a7f3197d1198a6991e7b93612c509c47865d</a></td>
</tr>



<tr>
<td>parent 19090</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/16b7ef1fb00264bab3b31ef97b9e46c38a700206">16b7ef1fb00264bab3b31ef97b9e46c38a700206</a>
</td>
</tr>

<tr>
<td>child 19092</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/dd691b216fc1632955db2577f6db2aa05ff8f81a">dd691b216fc1632955db2577f6db2aa05ff8f81a</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=2ff4a7f3197d1198a6991e7b93612c509c47865d">11733</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Sat, 26 Mar 2016 18:23:55 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@a6c06327a4b9 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=a6c06327a4b9cb35173b4a06e49ff37321db830a">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=a6c06327a4b9cb35173b4a06e49ff37321db830a&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a6c06327a4b9cb35173b4a06e49ff37321db830a&newProject=comm-central&newRevision=2ff4a7f3197d1198a6991e7b93612c509c47865d&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a6c06327a4b9cb35173b4a06e49ff37321db830a&newProject=comm-central&newRevision=2ff4a7f3197d1198a6991e7b93612c509c47865d&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a6c06327a4b9cb35173b4a06e49ff37321db830a&newProject=comm-central&newRevision=2ff4a7f3197d1198a6991e7b93612c509c47865d&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mkmelin%29&revcount=50">mkmelin</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1243498">1243498</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1243498">Bug 1243498</a> - Remove Eudora import. r=mkmelin</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mail/app/profile/all-thunderbird.js">mail/app/profile/all-thunderbird.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2ff4a7f3197d1198a6991e7b93612c509c47865d/mail/app/profile/all-thunderbird.js">file</a> |
<a href="/comm-central/annotate/2ff4a7f3197d1198a6991e7b93612c509c47865d/mail/app/profile/all-thunderbird.js">annotate</a> |
<a href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mail/app/profile/all-thunderbird.js">diff</a> |
<a href="/comm-central/comparison/2ff4a7f3197d1198a6991e7b93612c509c47865d/mail/app/profile/all-thunderbird.js">comparison</a> |
<a href="/comm-central/log/2ff4a7f3197d1198a6991e7b93612c509c47865d/mail/app/profile/all-thunderbird.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mail/components/build/nsMailComps.cpp">mail/components/build/nsMailComps.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2ff4a7f3197d1198a6991e7b93612c509c47865d/mail/components/build/nsMailComps.cpp">file</a> |
<a href="/comm-central/annotate/2ff4a7f3197d1198a6991e7b93612c509c47865d/mail/components/build/nsMailComps.cpp">annotate</a> |
<a href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mail/components/build/nsMailComps.cpp">diff</a> |
<a href="/comm-central/comparison/2ff4a7f3197d1198a6991e7b93612c509c47865d/mail/components/build/nsMailComps.cpp">comparison</a> |
<a href="/comm-central/log/2ff4a7f3197d1198a6991e7b93612c509c47865d/mail/components/build/nsMailComps.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mail/components/migration/content/migration.xul">mail/components/migration/content/migration.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2ff4a7f3197d1198a6991e7b93612c509c47865d/mail/components/migration/content/migration.xul">file</a> |
<a href="/comm-central/annotate/2ff4a7f3197d1198a6991e7b93612c509c47865d/mail/components/migration/content/migration.xul">annotate</a> |
<a href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mail/components/migration/content/migration.xul">diff</a> |
<a href="/comm-central/comparison/2ff4a7f3197d1198a6991e7b93612c509c47865d/mail/components/migration/content/migration.xul">comparison</a> |
<a href="/comm-central/log/2ff4a7f3197d1198a6991e7b93612c509c47865d/mail/components/migration/content/migration.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mail/components/migration/public/nsMailMigrationCID.h">mail/components/migration/public/nsMailMigrationCID.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2ff4a7f3197d1198a6991e7b93612c509c47865d/mail/components/migration/public/nsMailMigrationCID.h">file</a> |
<a href="/comm-central/annotate/2ff4a7f3197d1198a6991e7b93612c509c47865d/mail/components/migration/public/nsMailMigrationCID.h">annotate</a> |
<a href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mail/components/migration/public/nsMailMigrationCID.h">diff</a> |
<a href="/comm-central/comparison/2ff4a7f3197d1198a6991e7b93612c509c47865d/mail/components/migration/public/nsMailMigrationCID.h">comparison</a> |
<a href="/comm-central/log/2ff4a7f3197d1198a6991e7b93612c509c47865d/mail/components/migration/public/nsMailMigrationCID.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mail/components/migration/src/moz.build">mail/components/migration/src/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2ff4a7f3197d1198a6991e7b93612c509c47865d/mail/components/migration/src/moz.build">file</a> |
<a href="/comm-central/annotate/2ff4a7f3197d1198a6991e7b93612c509c47865d/mail/components/migration/src/moz.build">annotate</a> |
<a href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mail/components/migration/src/moz.build">diff</a> |
<a href="/comm-central/comparison/2ff4a7f3197d1198a6991e7b93612c509c47865d/mail/components/migration/src/moz.build">comparison</a> |
<a href="/comm-central/log/2ff4a7f3197d1198a6991e7b93612c509c47865d/mail/components/migration/src/moz.build">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mail/components/migration/src/nsEudoraProfileMigrator.cpp">mail/components/migration/src/nsEudoraProfileMigrator.cpp</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mail/components/migration/src/nsEudoraProfileMigrator.cpp">diff</a> |
<a href="/comm-central/comparison/2ff4a7f3197d1198a6991e7b93612c509c47865d/mail/components/migration/src/nsEudoraProfileMigrator.cpp">comparison</a> |
<a href="/comm-central/log/2ff4a7f3197d1198a6991e7b93612c509c47865d/mail/components/migration/src/nsEudoraProfileMigrator.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mail/components/migration/src/nsEudoraProfileMigrator.h">mail/components/migration/src/nsEudoraProfileMigrator.h</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mail/components/migration/src/nsEudoraProfileMigrator.h">diff</a> |
<a href="/comm-central/comparison/2ff4a7f3197d1198a6991e7b93612c509c47865d/mail/components/migration/src/nsEudoraProfileMigrator.h">comparison</a> |
<a href="/comm-central/log/2ff4a7f3197d1198a6991e7b93612c509c47865d/mail/components/migration/src/nsEudoraProfileMigrator.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mail/components/migration/src/nsProfileMigrator.cpp">mail/components/migration/src/nsProfileMigrator.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2ff4a7f3197d1198a6991e7b93612c509c47865d/mail/components/migration/src/nsProfileMigrator.cpp">file</a> |
<a href="/comm-central/annotate/2ff4a7f3197d1198a6991e7b93612c509c47865d/mail/components/migration/src/nsProfileMigrator.cpp">annotate</a> |
<a href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mail/components/migration/src/nsProfileMigrator.cpp">diff</a> |
<a href="/comm-central/comparison/2ff4a7f3197d1198a6991e7b93612c509c47865d/mail/components/migration/src/nsProfileMigrator.cpp">comparison</a> |
<a href="/comm-central/log/2ff4a7f3197d1198a6991e7b93612c509c47865d/mail/components/migration/src/nsProfileMigrator.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mail/locales/en-US/chrome/messenger/eudoraImportMsgs.properties">mail/locales/en-US/chrome/messenger/eudoraImportMsgs.properties</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mail/locales/en-US/chrome/messenger/eudoraImportMsgs.properties">diff</a> |
<a href="/comm-central/comparison/2ff4a7f3197d1198a6991e7b93612c509c47865d/mail/locales/en-US/chrome/messenger/eudoraImportMsgs.properties">comparison</a> |
<a href="/comm-central/log/2ff4a7f3197d1198a6991e7b93612c509c47865d/mail/locales/en-US/chrome/messenger/eudoraImportMsgs.properties">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mail/locales/en-US/chrome/messenger/migration/migration.dtd">mail/locales/en-US/chrome/messenger/migration/migration.dtd</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2ff4a7f3197d1198a6991e7b93612c509c47865d/mail/locales/en-US/chrome/messenger/migration/migration.dtd">file</a> |
<a href="/comm-central/annotate/2ff4a7f3197d1198a6991e7b93612c509c47865d/mail/locales/en-US/chrome/messenger/migration/migration.dtd">annotate</a> |
<a href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mail/locales/en-US/chrome/messenger/migration/migration.dtd">diff</a> |
<a href="/comm-central/comparison/2ff4a7f3197d1198a6991e7b93612c509c47865d/mail/locales/en-US/chrome/messenger/migration/migration.dtd">comparison</a> |
<a href="/comm-central/log/2ff4a7f3197d1198a6991e7b93612c509c47865d/mail/locales/en-US/chrome/messenger/migration/migration.dtd">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mail/locales/en-US/chrome/messenger/migration/migration.properties">mail/locales/en-US/chrome/messenger/migration/migration.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2ff4a7f3197d1198a6991e7b93612c509c47865d/mail/locales/en-US/chrome/messenger/migration/migration.properties">file</a> |
<a href="/comm-central/annotate/2ff4a7f3197d1198a6991e7b93612c509c47865d/mail/locales/en-US/chrome/messenger/migration/migration.properties">annotate</a> |
<a href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mail/locales/en-US/chrome/messenger/migration/migration.properties">diff</a> |
<a href="/comm-central/comparison/2ff4a7f3197d1198a6991e7b93612c509c47865d/mail/locales/en-US/chrome/messenger/migration/migration.properties">comparison</a> |
<a href="/comm-central/log/2ff4a7f3197d1198a6991e7b93612c509c47865d/mail/locales/en-US/chrome/messenger/migration/migration.properties">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mail/locales/jar.mn">mail/locales/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2ff4a7f3197d1198a6991e7b93612c509c47865d/mail/locales/jar.mn">file</a> |
<a href="/comm-central/annotate/2ff4a7f3197d1198a6991e7b93612c509c47865d/mail/locales/jar.mn">annotate</a> |
<a href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mail/locales/jar.mn">diff</a> |
<a href="/comm-central/comparison/2ff4a7f3197d1198a6991e7b93612c509c47865d/mail/locales/jar.mn">comparison</a> |
<a href="/comm-central/log/2ff4a7f3197d1198a6991e7b93612c509c47865d/mail/locales/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/compose/public/nsIMsgSend.idl">mailnews/compose/public/nsIMsgSend.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/compose/public/nsIMsgSend.idl">file</a> |
<a href="/comm-central/annotate/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/compose/public/nsIMsgSend.idl">annotate</a> |
<a href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/compose/public/nsIMsgSend.idl">diff</a> |
<a href="/comm-central/comparison/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/compose/public/nsIMsgSend.idl">comparison</a> |
<a href="/comm-central/log/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/compose/public/nsIMsgSend.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/compose/src/nsMsgSend.cpp">mailnews/compose/src/nsMsgSend.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/compose/src/nsMsgSend.cpp">file</a> |
<a href="/comm-central/annotate/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/compose/src/nsMsgSend.cpp">annotate</a> |
<a href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/compose/src/nsMsgSend.cpp">diff</a> |
<a href="/comm-central/comparison/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/compose/src/nsMsgSend.cpp">comparison</a> |
<a href="/comm-central/log/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/compose/src/nsMsgSend.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/build/moz.build">mailnews/import/build/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/build/moz.build">file</a> |
<a href="/comm-central/annotate/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/build/moz.build">annotate</a> |
<a href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/build/moz.build">diff</a> |
<a href="/comm-central/comparison/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/build/moz.build">comparison</a> |
<a href="/comm-central/log/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/build/moz.build">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/build/nsImportModule.cpp">mailnews/import/build/nsImportModule.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/build/nsImportModule.cpp">file</a> |
<a href="/comm-central/annotate/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/build/nsImportModule.cpp">annotate</a> |
<a href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/build/nsImportModule.cpp">diff</a> |
<a href="/comm-central/comparison/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/build/nsImportModule.cpp">comparison</a> |
<a href="/comm-central/log/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/build/nsImportModule.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/content/importDialog.js">mailnews/import/content/importDialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/content/importDialog.js">file</a> |
<a href="/comm-central/annotate/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/content/importDialog.js">annotate</a> |
<a href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/content/importDialog.js">diff</a> |
<a href="/comm-central/comparison/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/content/importDialog.js">comparison</a> |
<a href="/comm-central/log/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/content/importDialog.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/EudoraDebugLog.h">mailnews/import/eudora/src/EudoraDebugLog.h</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/EudoraDebugLog.h">diff</a> |
<a href="/comm-central/comparison/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/EudoraDebugLog.h">comparison</a> |
<a href="/comm-central/log/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/EudoraDebugLog.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/moz.build">mailnews/import/eudora/src/moz.build</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/moz.build">diff</a> |
<a href="/comm-central/comparison/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/moz.build">comparison</a> |
<a href="/comm-central/log/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/moz.build">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraAddress.cpp">mailnews/import/eudora/src/nsEudoraAddress.cpp</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraAddress.cpp">diff</a> |
<a href="/comm-central/comparison/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraAddress.cpp">comparison</a> |
<a href="/comm-central/log/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraAddress.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraAddress.h">mailnews/import/eudora/src/nsEudoraAddress.h</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraAddress.h">diff</a> |
<a href="/comm-central/comparison/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraAddress.h">comparison</a> |
<a href="/comm-central/log/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraAddress.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraCompose.cpp">mailnews/import/eudora/src/nsEudoraCompose.cpp</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraCompose.cpp">diff</a> |
<a href="/comm-central/comparison/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraCompose.cpp">comparison</a> |
<a href="/comm-central/log/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraCompose.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraCompose.h">mailnews/import/eudora/src/nsEudoraCompose.h</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraCompose.h">diff</a> |
<a href="/comm-central/comparison/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraCompose.h">comparison</a> |
<a href="/comm-central/log/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraCompose.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraEditor.cpp">mailnews/import/eudora/src/nsEudoraEditor.cpp</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraEditor.cpp">diff</a> |
<a href="/comm-central/comparison/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraEditor.cpp">comparison</a> |
<a href="/comm-central/log/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraEditor.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraEditor.h">mailnews/import/eudora/src/nsEudoraEditor.h</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraEditor.h">diff</a> |
<a href="/comm-central/comparison/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraEditor.h">comparison</a> |
<a href="/comm-central/log/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraEditor.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraFilters.cpp">mailnews/import/eudora/src/nsEudoraFilters.cpp</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraFilters.cpp">diff</a> |
<a href="/comm-central/comparison/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraFilters.cpp">comparison</a> |
<a href="/comm-central/log/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraFilters.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraFilters.h">mailnews/import/eudora/src/nsEudoraFilters.h</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraFilters.h">diff</a> |
<a href="/comm-central/comparison/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraFilters.h">comparison</a> |
<a href="/comm-central/log/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraFilters.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraImport.cpp">mailnews/import/eudora/src/nsEudoraImport.cpp</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraImport.cpp">diff</a> |
<a href="/comm-central/comparison/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraImport.cpp">comparison</a> |
<a href="/comm-central/log/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraImport.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraImport.h">mailnews/import/eudora/src/nsEudoraImport.h</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraImport.h">diff</a> |
<a href="/comm-central/comparison/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraImport.h">comparison</a> |
<a href="/comm-central/log/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraImport.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraMac.cpp">mailnews/import/eudora/src/nsEudoraMac.cpp</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraMac.cpp">diff</a> |
<a href="/comm-central/comparison/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraMac.cpp">comparison</a> |
<a href="/comm-central/log/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraMac.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraMac.h">mailnews/import/eudora/src/nsEudoraMac.h</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraMac.h">diff</a> |
<a href="/comm-central/comparison/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraMac.h">comparison</a> |
<a href="/comm-central/log/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraMac.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraMailbox.cpp">mailnews/import/eudora/src/nsEudoraMailbox.cpp</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraMailbox.cpp">diff</a> |
<a href="/comm-central/comparison/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraMailbox.cpp">comparison</a> |
<a href="/comm-central/log/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraMailbox.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraMailbox.h">mailnews/import/eudora/src/nsEudoraMailbox.h</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraMailbox.h">diff</a> |
<a href="/comm-central/comparison/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraMailbox.h">comparison</a> |
<a href="/comm-central/log/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraMailbox.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraSettings.cpp">mailnews/import/eudora/src/nsEudoraSettings.cpp</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraSettings.cpp">diff</a> |
<a href="/comm-central/comparison/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraSettings.cpp">comparison</a> |
<a href="/comm-central/log/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraSettings.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraSettings.h">mailnews/import/eudora/src/nsEudoraSettings.h</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraSettings.h">diff</a> |
<a href="/comm-central/comparison/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraSettings.h">comparison</a> |
<a href="/comm-central/log/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraSettings.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraStringBundle.cpp">mailnews/import/eudora/src/nsEudoraStringBundle.cpp</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraStringBundle.cpp">diff</a> |
<a href="/comm-central/comparison/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraStringBundle.cpp">comparison</a> |
<a href="/comm-central/log/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraStringBundle.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraStringBundle.h">mailnews/import/eudora/src/nsEudoraStringBundle.h</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraStringBundle.h">diff</a> |
<a href="/comm-central/comparison/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraStringBundle.h">comparison</a> |
<a href="/comm-central/log/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraStringBundle.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraWin32.cpp">mailnews/import/eudora/src/nsEudoraWin32.cpp</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraWin32.cpp">diff</a> |
<a href="/comm-central/comparison/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraWin32.cpp">comparison</a> |
<a href="/comm-central/log/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraWin32.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraWin32.h">mailnews/import/eudora/src/nsEudoraWin32.h</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraWin32.h">diff</a> |
<a href="/comm-central/comparison/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraWin32.h">comparison</a> |
<a href="/comm-central/log/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/eudora/src/nsEudoraWin32.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/public/nsIImportAddressBooks.idl">mailnews/import/public/nsIImportAddressBooks.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/public/nsIImportAddressBooks.idl">file</a> |
<a href="/comm-central/annotate/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/public/nsIImportAddressBooks.idl">annotate</a> |
<a href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/public/nsIImportAddressBooks.idl">diff</a> |
<a href="/comm-central/comparison/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/public/nsIImportAddressBooks.idl">comparison</a> |
<a href="/comm-central/log/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/public/nsIImportAddressBooks.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/test/unit/resources/import_helper.js">mailnews/import/test/unit/resources/import_helper.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/test/unit/resources/import_helper.js">file</a> |
<a href="/comm-central/annotate/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/test/unit/resources/import_helper.js">annotate</a> |
<a href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/test/unit/resources/import_helper.js">diff</a> |
<a href="/comm-central/comparison/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/test/unit/resources/import_helper.js">comparison</a> |
<a href="/comm-central/log/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/import/test/unit/resources/import_helper.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/moz.build">mailnews/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/moz.build">file</a> |
<a href="/comm-central/annotate/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/moz.build">annotate</a> |
<a href="/comm-central/diff/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/moz.build">diff</a> |
<a href="/comm-central/comparison/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/moz.build">comparison</a> |
<a href="/comm-central/log/2ff4a7f3197d1198a6991e7b93612c509c47865d/mailnews/moz.build">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/app/profile/all-thunderbird.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/app/profile/all-thunderbird.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -438,17 +438,17 @@ pref(&quot;browser.helperApps.deleteTempFileO</span>
<a href="#l1.4"></a><span id="l1.4"> #endif</span>
<a href="#l1.5"></a><span id="l1.5"> </span>
<a href="#l1.6"></a><span id="l1.6"> pref(&quot;spellchecker.dictionary&quot;, &quot;&quot;);</span>
<a href="#l1.7"></a><span id="l1.7"> // Dictionary download preference</span>
<a href="#l1.8"></a><span id="l1.8"> pref(&quot;spellchecker.dictionaries.download.url&quot;, &quot;https://addons.mozilla.org/%LOCALE%/%APP%/dictionaries/&quot;);</span>
<a href="#l1.9"></a><span id="l1.9"> </span>
<a href="#l1.10"></a><span id="l1.10"> // profile.force.migration can be used to bypass the migration wizard, forcing migration from a particular</span>
<a href="#l1.11"></a><span id="l1.11"> // mail application without any user intervention. Possible values are:</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-// seamonkey (mozilla suite), eudora, oexpress, outlook.</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+// seamonkey (mozilla suite), oexpress, outlook.</span>
<a href="#l1.14"></a><span id="l1.14"> pref(&quot;profile.force.migration&quot;, &quot;&quot;);</span>
<a href="#l1.15"></a><span id="l1.15"> </span>
<a href="#l1.16"></a><span id="l1.16"> // prefs to control the mail alert notification</span>
<a href="#l1.17"></a><span id="l1.17"> pref(&quot;alerts.slideIncrementTime&quot;, 50);</span>
<a href="#l1.18"></a><span id="l1.18"> pref(&quot;alerts.totalOpenTime&quot;, 10000);</span>
<a href="#l1.19"></a><span id="l1.19"> </span>
<a href="#l1.20"></a><span id="l1.20"> // analyze urls in mail messages for scams</span>
<a href="#l1.21"></a><span id="l1.21"> pref(&quot;mail.phishing.detection.enabled&quot;, true);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/components/build/nsMailComps.cpp</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/components/build/nsMailComps.cpp</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -22,20 +22,16 @@ NS_GENERIC_FACTORY_CONSTRUCTOR(nsOEProfi</span>
<a href="#l2.4"></a><span id="l2.4"> </span>
<a href="#l2.5"></a><span id="l2.5"> #include &quot;nsOutlookProfileMigrator.h&quot;</span>
<a href="#l2.6"></a><span id="l2.6"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsOutlookProfileMigrator)</span>
<a href="#l2.7"></a><span id="l2.7"> </span>
<a href="#l2.8"></a><span id="l2.8"> #include &quot;nsMailWinIntegration.h&quot;</span>
<a href="#l2.9"></a><span id="l2.9"> NS_GENERIC_FACTORY_CONSTRUCTOR_INIT(nsWindowsShellService, Init)</span>
<a href="#l2.10"></a><span id="l2.10"> #endif</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-#if defined(XP_WIN32) || defined(XP_MACOSX)</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-#include &quot;nsEudoraProfileMigrator.h&quot;</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-NS_GENERIC_FACTORY_CONSTRUCTOR(nsEudoraProfileMigrator)</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineminus">-#endif</span>
<a href="#l2.16"></a><span id="l2.16"> #ifdef MOZ_WIDGET_GTK</span>
<a href="#l2.17"></a><span id="l2.17"> #include &quot;nsMailGNOMEIntegration.h&quot;</span>
<a href="#l2.18"></a><span id="l2.18"> NS_GENERIC_FACTORY_CONSTRUCTOR_INIT(nsMailGNOMEIntegration, Init)</span>
<a href="#l2.19"></a><span id="l2.19"> #endif</span>
<a href="#l2.20"></a><span id="l2.20"> #ifdef XP_MACOSX</span>
<a href="#l2.21"></a><span id="l2.21"> #include &quot;nsMailMacIntegration.h&quot;</span>
<a href="#l2.22"></a><span id="l2.22"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsMailMacIntegration)</span>
<a href="#l2.23"></a><span id="l2.23"> #endif</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineat">@@ -51,20 +47,16 @@ NS_DEFINE_NAMED_CID(NS_SEAMONKEYPROFILEM</span>
<a href="#l2.25"></a><span id="l2.25"> </span>
<a href="#l2.26"></a><span id="l2.26"> #ifdef XP_WIN32</span>
<a href="#l2.27"></a><span id="l2.27"> NS_DEFINE_NAMED_CID(NS_OEXPRESSPROFILEMIGRATOR_CID);</span>
<a href="#l2.28"></a><span id="l2.28"> NS_DEFINE_NAMED_CID(NS_OUTLOOKPROFILEMIGRATOR_CID);</span>
<a href="#l2.29"></a><span id="l2.29"> NS_DEFINE_NAMED_CID(NS_MAILWININTEGRATION_CID);</span>
<a href="#l2.30"></a><span id="l2.30"> NS_DEFINE_NAMED_CID(NS_MAILWINSEARCHHELPER_CID);</span>
<a href="#l2.31"></a><span id="l2.31"> #endif // !XP_WIN32</span>
<a href="#l2.32"></a><span id="l2.32"> </span>
<a href="#l2.33"></a><span id="l2.33" class="difflineminus">-#if defined (XP_WIN32) || defined (XP_MACOSX)</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineminus">-NS_DEFINE_NAMED_CID(NS_EUDORAPROFILEMIGRATOR_CID);</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineminus">-#endif</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineminus">-</span>
<a href="#l2.37"></a><span id="l2.37"> #ifdef MOZ_WIDGET_GTK</span>
<a href="#l2.38"></a><span id="l2.38"> NS_DEFINE_NAMED_CID(NS_MAILGNOMEINTEGRATION_CID);</span>
<a href="#l2.39"></a><span id="l2.39"> #endif</span>
<a href="#l2.40"></a><span id="l2.40"> </span>
<a href="#l2.41"></a><span id="l2.41"> #ifdef XP_MACOSX</span>
<a href="#l2.42"></a><span id="l2.42"> NS_DEFINE_NAMED_CID(NS_MAILMACINTEGRATION_CID);</span>
<a href="#l2.43"></a><span id="l2.43"> #endif</span>
<a href="#l2.44"></a><span id="l2.44"> </span>
<a href="#l2.45"></a><span id="l2.45" class="difflineat">@@ -73,19 +65,16 @@ const mozilla::Module::CIDEntry kMailCID</span>
<a href="#l2.46"></a><span id="l2.46">   { &amp;kNS_THUNDERBIRD_PROFILEIMPORT_CID, false, NULL, nsProfileMigratorConstructor },</span>
<a href="#l2.47"></a><span id="l2.47">   { &amp;kNS_SEAMONKEYPROFILEMIGRATOR_CID, false, NULL, nsSeamonkeyProfileMigratorConstructor },</span>
<a href="#l2.48"></a><span id="l2.48"> #ifdef XP_WIN32</span>
<a href="#l2.49"></a><span id="l2.49">   { &amp;kNS_OEXPRESSPROFILEMIGRATOR_CID, false, NULL, nsOEProfileMigratorConstructor },</span>
<a href="#l2.50"></a><span id="l2.50">   { &amp;kNS_OUTLOOKPROFILEMIGRATOR_CID, false, NULL, nsOutlookProfileMigratorConstructor },</span>
<a href="#l2.51"></a><span id="l2.51">   { &amp;kNS_MAILWININTEGRATION_CID, false, NULL, nsWindowsShellServiceConstructor },</span>
<a href="#l2.52"></a><span id="l2.52">   { &amp;kNS_MAILWINSEARCHHELPER_CID, false, NULL, nsMailWinSearchHelperConstructor },</span>
<a href="#l2.53"></a><span id="l2.53"> #endif // !XP_WIN32</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineminus">-#if defined (XP_WIN32) || defined (XP_MACOSX)</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineminus">-  { &amp;kNS_EUDORAPROFILEMIGRATOR_CID, false, NULL, nsEudoraProfileMigratorConstructor },</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineminus">-#endif</span>
<a href="#l2.57"></a><span id="l2.57"> #ifdef MOZ_WIDGET_GTK</span>
<a href="#l2.58"></a><span id="l2.58">   { &amp;kNS_MAILGNOMEINTEGRATION_CID, false, NULL, nsMailGNOMEIntegrationConstructor },</span>
<a href="#l2.59"></a><span id="l2.59"> #endif</span>
<a href="#l2.60"></a><span id="l2.60"> #ifdef XP_MACOSX</span>
<a href="#l2.61"></a><span id="l2.61">   { &amp;kNS_MAILMACINTEGRATION_CID, false, NULL, nsMailMacIntegrationConstructor },</span>
<a href="#l2.62"></a><span id="l2.62"> #endif</span>
<a href="#l2.63"></a><span id="l2.63">   { NULL }</span>
<a href="#l2.64"></a><span id="l2.64"> };</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineat">@@ -95,19 +84,16 @@ const mozilla::Module::ContractIDEntry k</span>
<a href="#l2.66"></a><span id="l2.66">   { NS_PROFILEMIGRATOR_CONTRACTID, &amp;kNS_THUNDERBIRD_PROFILEIMPORT_CID },</span>
<a href="#l2.67"></a><span id="l2.67">   { NS_MAILPROFILEMIGRATOR_CONTRACTID_PREFIX &quot;seamonkey&quot;, &amp;kNS_SEAMONKEYPROFILEMIGRATOR_CID },</span>
<a href="#l2.68"></a><span id="l2.68"> #ifdef XP_WIN32</span>
<a href="#l2.69"></a><span id="l2.69">   { NS_MAILPROFILEMIGRATOR_CONTRACTID_PREFIX &quot;oexpress&quot;, &amp;kNS_OEXPRESSPROFILEMIGRATOR_CID },</span>
<a href="#l2.70"></a><span id="l2.70">   { NS_MAILPROFILEMIGRATOR_CONTRACTID_PREFIX &quot;outlook&quot;, &amp;kNS_OUTLOOKPROFILEMIGRATOR_CID },</span>
<a href="#l2.71"></a><span id="l2.71">   { &quot;@mozilla.org/mail/shell-service;1&quot;, &amp;kNS_MAILWININTEGRATION_CID },</span>
<a href="#l2.72"></a><span id="l2.72">   { &quot;@mozilla.org/mail/windows-search-helper;1&quot;, &amp;kNS_MAILWINSEARCHHELPER_CID },</span>
<a href="#l2.73"></a><span id="l2.73"> #endif // !XP_WIN32</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineminus">-#if defined (XP_WIN32) || defined (XP_MACOSX)</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineminus">-  { NS_MAILPROFILEMIGRATOR_CONTRACTID_PREFIX &quot;eudora&quot;, &amp;kNS_EUDORAPROFILEMIGRATOR_CID },</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineminus">-#endif</span>
<a href="#l2.77"></a><span id="l2.77"> #ifdef MOZ_WIDGET_GTK</span>
<a href="#l2.78"></a><span id="l2.78">   { &quot;@mozilla.org/mail/shell-service;1&quot;, &amp;kNS_MAILGNOMEINTEGRATION_CID },</span>
<a href="#l2.79"></a><span id="l2.79"> #endif</span>
<a href="#l2.80"></a><span id="l2.80"> #ifdef XP_MACOSX</span>
<a href="#l2.81"></a><span id="l2.81">   { &quot;@mozilla.org/mail/shell-service;1&quot;, &amp;kNS_MAILMACINTEGRATION_CID },</span>
<a href="#l2.82"></a><span id="l2.82"> #endif</span>
<a href="#l2.83"></a><span id="l2.83">   { NULL }</span>
<a href="#l2.84"></a><span id="l2.84"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/components/migration/content/migration.xul</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/components/migration/content/migration.xul</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -35,28 +35,16 @@</span>
<a href="#l3.4"></a><span id="l3.4">              accesskey=&quot;&amp;importFromSeamonkey3.accesskey;&quot;/&gt;</span>
<a href="#l3.5"></a><span id="l3.5"> </span>
<a href="#l3.6"></a><span id="l3.6"> #ifdef XP_WIN</span>
<a href="#l3.7"></a><span id="l3.7">       &lt;radio id=&quot;oexpress&quot;  label=&quot;&amp;importFromOExpress.label;&quot;  accesskey=&quot;&amp;importFromOExpress.accesskey;&quot;/&gt;</span>
<a href="#l3.8"></a><span id="l3.8">       &lt;radio id=&quot;outlook&quot;   label=&quot;&amp;importFromOutlook.label;&quot;   accesskey=&quot;&amp;importFromOutlook.accesskey;&quot;</span>
<a href="#l3.9"></a><span id="l3.9">                             tooltiptext=&quot;Currently disabled due to bug 1175055&quot; disabled=&quot;true&quot;/&gt;</span>
<a href="#l3.10"></a><span id="l3.10"> #endif</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-#ifdef XP_UNIX</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-#ifdef XP_MACOSX</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-      &lt;radio id=&quot;eudora&quot;    label=&quot;&amp;importFromEudora.label;&quot;    accesskey=&quot;&amp;importFromEudora.accesskey;&quot;</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-                            tooltiptext=&quot;Currently disabled due to bug 1175055&quot; disabled=&quot;true&quot;/&gt;</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineminus">-#endif</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineminus">-#endif</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineminus">-</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineminus">-#ifdef XP_WIN</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineminus">-      &lt;radio id=&quot;eudora&quot;    label=&quot;&amp;importFromEudora.label;&quot;    accesskey=&quot;&amp;importFromEudora.accesskey;&quot;</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineminus">-                            tooltiptext=&quot;Currently disabled due to bug 1175055&quot; disabled=&quot;true&quot;/&gt;</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineminus">-#endif</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineminus">-</span>
<a href="#l3.24"></a><span id="l3.24">       &lt;radio id=&quot;nothing&quot;   label=&quot;&amp;importFromNothing.label;&quot;   accesskey=&quot;&amp;importFromNothing.accesskey;&quot; hidden=&quot;true&quot;/&gt;</span>
<a href="#l3.25"></a><span id="l3.25">     &lt;/radiogroup&gt;</span>
<a href="#l3.26"></a><span id="l3.26">   &lt;/wizardpage&gt;</span>
<a href="#l3.27"></a><span id="l3.27"> </span>
<a href="#l3.28"></a><span id="l3.28">   &lt;wizardpage id=&quot;selectProfile&quot; pageid=&quot;selectProfile&quot; label=&quot;&amp;selectProfile.title;&quot;</span>
<a href="#l3.29"></a><span id="l3.29">               next=&quot;importItems&quot;</span>
<a href="#l3.30"></a><span id="l3.30">               onpageshow=&quot;return MigrationWizard.onSelectProfilePageShow();&quot;</span>
<a href="#l3.31"></a><span id="l3.31">               onpagerewound=&quot;return MigrationWizard.onSelectProfilePageRewound();&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/components/migration/public/nsMailMigrationCID.h</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/components/migration/public/nsMailMigrationCID.h</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -7,11 +7,8 @@</span>
<a href="#l4.4"></a><span id="l4.4"> #define NS_SEAMONKEYPROFILEMIGRATOR_CID \</span>
<a href="#l4.5"></a><span id="l4.5"> { 0x62c6e1f9, 0x3dc3, 0x4b68, { 0x9c, 0x39, 0xad, 0x2f, 0x6d, 0x47, 0x1a, 0xc0 } }</span>
<a href="#l4.6"></a><span id="l4.6"> </span>
<a href="#l4.7"></a><span id="l4.7"> #define NS_OEXPRESSPROFILEMIGRATOR_CID \</span>
<a href="#l4.8"></a><span id="l4.8"> { 0xbc1db696, 0x7065, 0x46ad, { 0x87, 0x8f, 0xfd, 0x77, 0x41, 0x4e, 0x69, 0xef } }</span>
<a href="#l4.9"></a><span id="l4.9"> </span>
<a href="#l4.10"></a><span id="l4.10"> #define NS_OUTLOOKPROFILEMIGRATOR_CID \</span>
<a href="#l4.11"></a><span id="l4.11"> { 0x910b6453, 0x719, 0x41e8, { 0xa4, 0xc9, 0x3, 0x19, 0xbb, 0x34, 0xc8, 0xff } }</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-#define NS_EUDORAPROFILEMIGRATOR_CID \</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-{ 0x91622bdc, 0x3c73, 0x4474, { 0x85, 0x4, 0xac, 0xda, 0x4f, 0x1e, 0xd0, 0x68 } }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/components/migration/src/moz.build</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/components/migration/src/moz.build</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -7,22 +7,20 @@ SOURCES += [</span>
<a href="#l5.4"></a><span id="l5.4">     'nsMailProfileMigratorUtils.cpp',</span>
<a href="#l5.5"></a><span id="l5.5">     'nsNetscapeProfileMigratorBase.cpp',</span>
<a href="#l5.6"></a><span id="l5.6">     'nsProfileMigrator.cpp',</span>
<a href="#l5.7"></a><span id="l5.7">     'nsSeamonkeyProfileMigrator.cpp',</span>
<a href="#l5.8"></a><span id="l5.8"> ]</span>
<a href="#l5.9"></a><span id="l5.9"> </span>
<a href="#l5.10"></a><span id="l5.10"> if CONFIG['OS_ARCH'] == 'WINNT':</span>
<a href="#l5.11"></a><span id="l5.11">     SOURCES += [</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-        'nsEudoraProfileMigrator.cpp',</span>
<a href="#l5.13"></a><span id="l5.13">         'nsOEProfileMigrator.cpp',</span>
<a href="#l5.14"></a><span id="l5.14">         'nsOutlookProfileMigrator.cpp',</span>
<a href="#l5.15"></a><span id="l5.15">         'nsProfileMigratorBase.cpp',</span>
<a href="#l5.16"></a><span id="l5.16">     ]</span>
<a href="#l5.17"></a><span id="l5.17"> </span>
<a href="#l5.18"></a><span id="l5.18"> if CONFIG['MOZ_WIDGET_TOOLKIT'] == 'cocoa':</span>
<a href="#l5.19"></a><span id="l5.19">     SOURCES += [</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineminus">-        'nsEudoraProfileMigrator.cpp',</span>
<a href="#l5.21"></a><span id="l5.21">         'nsProfileMigratorBase.cpp',</span>
<a href="#l5.22"></a><span id="l5.22">     ]</span>
<a href="#l5.23"></a><span id="l5.23"> </span>
<a href="#l5.24"></a><span id="l5.24"> FINAL_LIBRARY = 'mailcomps'</span>
<a href="#l5.25"></a><span id="l5.25"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1">deleted file mode 100644</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineminus">--- a/mail/components/migration/src/nsEudoraProfileMigrator.cpp</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineplus">+++ /dev/null</span>
<a href="#l6.4"></a><span id="l6.4" class="difflineat">@@ -1,139 +0,0 @@</span>
<a href="#l6.5"></a><span id="l6.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l6.6"></a><span id="l6.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l6.7"></a><span id="l6.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l6.8"></a><span id="l6.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l6.9"></a><span id="l6.9" class="difflineminus">-</span>
<a href="#l6.10"></a><span id="l6.10" class="difflineminus">-#include &quot;nsMailProfileMigratorUtils.h&quot;</span>
<a href="#l6.11"></a><span id="l6.11" class="difflineminus">-#include &quot;nsDirectoryServiceDefs.h&quot;</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-#include &quot;nsIObserverService.h&quot;</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-#include &quot;nsIPrefLocalizedString.h&quot;</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-#include &quot;nsIPrefService.h&quot;</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineminus">-#include &quot;nsIServiceManager.h&quot;</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineminus">-#include &quot;nsISupportsPrimitives.h&quot;</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineminus">-#include &quot;nsNetCID.h&quot;</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineminus">-#include &quot;nsNetUtil.h&quot;</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineminus">-#include &quot;nsEudoraProfileMigrator.h&quot;</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineminus">-#include &quot;nsIProfileMigrator.h&quot;</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineminus">-#include &quot;nsIImportSettings.h&quot;</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineminus">-#include &quot;nsIFile.h&quot;</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineminus">-</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineminus">-</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineminus">-NS_IMPL_ISUPPORTS(nsEudoraProfileMigrator, nsIMailProfileMigrator, nsITimerCallback)</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineminus">-</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineminus">-</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineminus">-nsEudoraProfileMigrator::nsEudoraProfileMigrator()</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineminus">-{</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineminus">-  mProcessingMailFolders = false;</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-  // get the import service</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineminus">-  mImportModule = do_CreateInstance(&quot;@mozilla.org/import/import-eudora;1&quot;);</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineminus">-}</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineminus">-</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineminus">-nsEudoraProfileMigrator::~nsEudoraProfileMigrator()</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineminus">-{</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineminus">-}</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineminus">-</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineminus">-nsresult nsEudoraProfileMigrator::ContinueImport()</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineminus">-{</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineminus">-  return Notify(nullptr);</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineminus">-}</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineminus">-</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineminus">-///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineminus">-// nsITimerCallback</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineminus">-</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineminus">-nsEudoraProfileMigrator::Notify(nsITimer *timer)</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineminus">-{</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineminus">-  int32_t progress;</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineminus">-  mGenericImporter-&gt;GetProgress(&amp;progress);</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineminus">-</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineminus">-  nsAutoString index;</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineminus">-  index.AppendInt( progress );</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineminus">-  NOTIFY_OBSERVERS(MIGRATION_PROGRESS, index.get());</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineminus">-</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineminus">-  if (progress == 100) // are we done yet?</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineminus">-  {</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineminus">-    if (mProcessingMailFolders)</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineminus">-      return FinishCopyingMailFolders();</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineminus">-    else</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineminus">-      return FinishCopyingAddressBookData();</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineminus">-  }</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineminus">-  else</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineminus">-  {</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineminus">-    // fire a timer to handle the next one.</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineminus">-    mFileIOTimer = do_CreateInstance(&quot;@mozilla.org/timer;1&quot;);</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineminus">-    if (mFileIOTimer)</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineminus">-      mFileIOTimer-&gt;InitWithCallback(static_cast&lt;nsITimerCallback *&gt;(this), 100, nsITimer::TYPE_ONE_SHOT);</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineminus">-  }</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineminus">-  return NS_OK;</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineminus">-}</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineminus">-</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineminus">-///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineminus">-// nsIMailProfileMigrator</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineminus">-</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineminus">-nsEudoraProfileMigrator::Migrate(uint16_t aItems, nsIProfileStartup* aStartup, const char16_t* aProfile)</span>
<a href="#l6.79"></a><span id="l6.79" class="difflineminus">-{</span>
<a href="#l6.80"></a><span id="l6.80" class="difflineminus">-  nsresult rv = NS_OK;</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineminus">-</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineminus">-  if (aStartup)</span>
<a href="#l6.83"></a><span id="l6.83" class="difflineminus">-  {</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineminus">-    rv = aStartup-&gt;DoStartup();</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineminus">-  }</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineminus">-</span>
<a href="#l6.88"></a><span id="l6.88" class="difflineminus">-  NOTIFY_OBSERVERS(MIGRATION_STARTED, nullptr);</span>
<a href="#l6.89"></a><span id="l6.89" class="difflineminus">-  rv = ImportSettings(mImportModule);</span>
<a href="#l6.90"></a><span id="l6.90" class="difflineminus">-</span>
<a href="#l6.91"></a><span id="l6.91" class="difflineminus">-  // now import address books</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineminus">-  // this routine will asynchronously import address book data and it will then kick off</span>
<a href="#l6.93"></a><span id="l6.93" class="difflineminus">-  // the final migration step, copying the mail folders over.</span>
<a href="#l6.94"></a><span id="l6.94" class="difflineminus">-  rv = ImportAddressBook(mImportModule);</span>
<a href="#l6.95"></a><span id="l6.95" class="difflineminus">-</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineminus">-  // don't broadcast an on end migration here. We aren't done until our asynch import process says we are done.</span>
<a href="#l6.97"></a><span id="l6.97" class="difflineminus">-  return rv;</span>
<a href="#l6.98"></a><span id="l6.98" class="difflineminus">-}</span>
<a href="#l6.99"></a><span id="l6.99" class="difflineminus">-</span>
<a href="#l6.100"></a><span id="l6.100" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l6.101"></a><span id="l6.101" class="difflineminus">-nsEudoraProfileMigrator::GetMigrateData(const char16_t* aProfile,</span>
<a href="#l6.102"></a><span id="l6.102" class="difflineminus">-                                           bool aReplace,</span>
<a href="#l6.103"></a><span id="l6.103" class="difflineminus">-                                           uint16_t* aResult)</span>
<a href="#l6.104"></a><span id="l6.104" class="difflineminus">-{</span>
<a href="#l6.105"></a><span id="l6.105" class="difflineminus">-  // There's no harm in assuming everything is available.</span>
<a href="#l6.106"></a><span id="l6.106" class="difflineminus">-  *aResult = nsIMailProfileMigrator::ACCOUNT_SETTINGS | nsIMailProfileMigrator::ADDRESSBOOK_DATA |</span>
<a href="#l6.107"></a><span id="l6.107" class="difflineminus">-             nsIMailProfileMigrator::MAILDATA | nsIMailProfileMigrator::FILTERS;</span>
<a href="#l6.108"></a><span id="l6.108" class="difflineminus">-  return NS_OK;</span>
<a href="#l6.109"></a><span id="l6.109" class="difflineminus">-}</span>
<a href="#l6.110"></a><span id="l6.110" class="difflineminus">-</span>
<a href="#l6.111"></a><span id="l6.111" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l6.112"></a><span id="l6.112" class="difflineminus">-nsEudoraProfileMigrator::GetSourceExists(bool* aResult)</span>
<a href="#l6.113"></a><span id="l6.113" class="difflineminus">-{</span>
<a href="#l6.114"></a><span id="l6.114" class="difflineminus">-  *aResult = false;</span>
<a href="#l6.115"></a><span id="l6.115" class="difflineminus">-</span>
<a href="#l6.116"></a><span id="l6.116" class="difflineminus">-  nsCOMPtr&lt;nsISupports&gt; supports;</span>
<a href="#l6.117"></a><span id="l6.117" class="difflineminus">-  mImportModule-&gt;GetImportInterface(NS_IMPORT_SETTINGS_STR, getter_AddRefs(supports));</span>
<a href="#l6.118"></a><span id="l6.118" class="difflineminus">-  nsCOMPtr&lt;nsIImportSettings&gt; importSettings = do_QueryInterface(supports);</span>
<a href="#l6.119"></a><span id="l6.119" class="difflineminus">-</span>
<a href="#l6.120"></a><span id="l6.120" class="difflineminus">-  if (importSettings)</span>
<a href="#l6.121"></a><span id="l6.121" class="difflineminus">-  {</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineminus">-    nsString description;</span>
<a href="#l6.123"></a><span id="l6.123" class="difflineminus">-    nsCOMPtr&lt;nsIFile&gt; location;</span>
<a href="#l6.124"></a><span id="l6.124" class="difflineminus">-    importSettings-&gt;AutoLocate(getter_Copies(description), getter_AddRefs(location), aResult);</span>
<a href="#l6.125"></a><span id="l6.125" class="difflineminus">-  }</span>
<a href="#l6.126"></a><span id="l6.126" class="difflineminus">-</span>
<a href="#l6.127"></a><span id="l6.127" class="difflineminus">-  return NS_OK;</span>
<a href="#l6.128"></a><span id="l6.128" class="difflineminus">-}</span>
<a href="#l6.129"></a><span id="l6.129" class="difflineminus">-</span>
<a href="#l6.130"></a><span id="l6.130" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l6.131"></a><span id="l6.131" class="difflineminus">-nsEudoraProfileMigrator::GetSourceHasMultipleProfiles(bool* aResult)</span>
<a href="#l6.132"></a><span id="l6.132" class="difflineminus">-{</span>
<a href="#l6.133"></a><span id="l6.133" class="difflineminus">-  *aResult = false;</span>
<a href="#l6.134"></a><span id="l6.134" class="difflineminus">-  return NS_OK;</span>
<a href="#l6.135"></a><span id="l6.135" class="difflineminus">-}</span>
<a href="#l6.136"></a><span id="l6.136" class="difflineminus">-</span>
<a href="#l6.137"></a><span id="l6.137" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l6.138"></a><span id="l6.138" class="difflineminus">-nsEudoraProfileMigrator::GetSourceProfiles(nsIArray** aResult)</span>
<a href="#l6.139"></a><span id="l6.139" class="difflineminus">-{</span>
<a href="#l6.140"></a><span id="l6.140" class="difflineminus">-  *aResult = nullptr;</span>
<a href="#l6.141"></a><span id="l6.141" class="difflineminus">-  return NS_OK;</span>
<a href="#l6.142"></a><span id="l6.142" class="difflineminus">-}</span>
<a href="#l6.143"></a><span id="l6.143" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1">deleted file mode 100644</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineminus">--- a/mail/components/migration/src/nsEudoraProfileMigrator.h</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineplus">+++ /dev/null</span>
<a href="#l7.4"></a><span id="l7.4" class="difflineat">@@ -1,39 +0,0 @@</span>
<a href="#l7.5"></a><span id="l7.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l7.6"></a><span id="l7.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l7.7"></a><span id="l7.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l7.8"></a><span id="l7.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l7.9"></a><span id="l7.9" class="difflineminus">-</span>
<a href="#l7.10"></a><span id="l7.10" class="difflineminus">-#ifndef eudoraprofilemigrator___h___</span>
<a href="#l7.11"></a><span id="l7.11" class="difflineminus">-#define eudoraprofilemigrator___h___</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-#include &quot;nsIMailProfileMigrator.h&quot;</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">-#include &quot;nsIFile.h&quot;</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineminus">-#include &quot;nsIObserverService.h&quot;</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineminus">-#include &quot;nsITimer.h&quot;</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineminus">-#include &quot;nsIImportGeneric.h&quot;</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineminus">-#include &quot;nsIImportModule.h&quot;</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineminus">-#include &quot;nsIMsgAccount.h&quot;</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineminus">-#include &quot;nsProfileMigratorBase.h&quot;</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineminus">-</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineminus">-class nsIFile;</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineminus">-class nsIPrefBranch;</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineminus">-class nsIPrefService;</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineminus">-</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineminus">-class nsEudoraProfileMigrator : public nsIMailProfileMigrator,</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineminus">-                            public nsITimerCallback,</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineminus">-                            public nsProfileMigratorBase</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineminus">-{</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineminus">-public:</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-  NS_DECL_NSIMAILPROFILEMIGRATOR</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineminus">-  NS_DECL_ISUPPORTS</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineminus">-  NS_DECL_NSITIMERCALLBACK</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineminus">-</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineminus">-  nsEudoraProfileMigrator();</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineminus">-</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineminus">-  virtual nsresult ContinueImport();</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineminus">-</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineminus">-private:</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineminus">-  virtual ~nsEudoraProfileMigrator();</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineminus">-};</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineminus">-</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineminus">-#endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mail/components/migration/src/nsProfileMigrator.cpp</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mail/components/migration/src/nsProfileMigrator.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -108,17 +108,16 @@ nsProfileMigrator::GetDefaultMailMigrato</span>
<a href="#l8.4"></a><span id="l8.4">     return NS_OK;</span>
<a href="#l8.5"></a><span id="l8.5">   }</span>
<a href="#l8.6"></a><span id="l8.6"> </span>
<a href="#l8.7"></a><span id="l8.7">   #define MAX_SOURCE_LENGTH 10</span>
<a href="#l8.8"></a><span id="l8.8">   const char sources[][MAX_SOURCE_LENGTH] = {</span>
<a href="#l8.9"></a><span id="l8.9">     &quot;seamonkey&quot;,</span>
<a href="#l8.10"></a><span id="l8.10">     &quot;oexpress&quot;,</span>
<a href="#l8.11"></a><span id="l8.11">     &quot;outlook&quot;,</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-    &quot;eudora&quot;,</span>
<a href="#l8.13"></a><span id="l8.13">     &quot;&quot;</span>
<a href="#l8.14"></a><span id="l8.14">   };</span>
<a href="#l8.15"></a><span id="l8.15">   for (uint32_t i = 0; sources[i][0]; ++i)</span>
<a href="#l8.16"></a><span id="l8.16">   {</span>
<a href="#l8.17"></a><span id="l8.17">     migratorID = migratorPrefix;</span>
<a href="#l8.18"></a><span id="l8.18">     migratorID.Append(sources[i]);</span>
<a href="#l8.19"></a><span id="l8.19">     mailMigrator = do_CreateInstance(migratorID.get());</span>
<a href="#l8.20"></a><span id="l8.20">     if (!mailMigrator)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1">deleted file mode 100644</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/eudoraImportMsgs.properties</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineplus">+++ /dev/null</span>
<a href="#l9.4"></a><span id="l9.4" class="difflineat">@@ -1,193 +0,0 @@</span>
<a href="#l9.5"></a><span id="l9.5" class="difflineminus">-# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l9.6"></a><span id="l9.6" class="difflineminus">-# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l9.7"></a><span id="l9.7" class="difflineminus">-# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l9.8"></a><span id="l9.8" class="difflineminus">-</span>
<a href="#l9.9"></a><span id="l9.9" class="difflineminus">-#</span>
<a href="#l9.10"></a><span id="l9.10" class="difflineminus">-# The following are used by the outlook express import code to display status/error </span>
<a href="#l9.11"></a><span id="l9.11" class="difflineminus">-# and informational messages</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-#</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineminus">-# Short name of import module</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineminus">-## @name EUDORAIMPORT_NAME</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineminus">-## @loc None</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineminus">-2000=Eudora</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineminus">-</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineminus">-# Description of import module</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineminus">-## @name EUDORAIMPORT_DESCRIPTION</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineminus">-## @loc None</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineminus">-2029=Eudora mail, address books, and settings</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineminus">-</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineminus">-# Success message</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineminus">-## @name EUDORAIMPORT_MAILBOX_SUCCESS</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineminus">-## @loc None</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineminus">-# LOCALIZATION NOTE (2002): In the following sentence,</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineminus">-# the %S represents a string to be inserted at runtime (the name of the Mailbox), </span>
<a href="#l9.29"></a><span id="l9.29" class="difflineminus">-# and the %d is a number (the number of messages imported). Do not translate %d or %S, but</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineminus">-# instead insert them in your text at the appropriate places.</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineminus">-2002=Mailbox %S, imported %d messages</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineminus">-</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineminus">-# Error message</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineminus">-## @name EUDORAIMPORT_MAILBOX_BADSOURCEFILE</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineminus">-## @loc None</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineminus">-# LOCALIZATION NOTE (2004): In the following sentence, do not translate the &quot;%S&quot;. Instead,</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineminus">-# place it in your sentence where you wish to display the name of the mailbox.</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineminus">-2004=Error accessing file for mailbox %S.</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineminus">-</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineminus">-# Error message</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineminus">-## @name EUDORAIMPORT_MAILBOX_CONVERTERROR</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineminus">-## @loc None</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineminus">-# LOCALIZATION NOTE (2005): In the following sentence, do not translate the &quot;%S&quot;. Instead,</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineminus">-# place it in your sentence where you wish to display the name of the mailbox.</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineminus">-2005=Error importing mailbox %S, all messages may not be imported from this mailbox.</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineminus">-</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineminus">-# Description</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineminus">-## @name EUDORAIMPORT_ACCOUNTNAME</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineminus">-## @loc None</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineminus">-# LOCALIZATION NOTE (2006): Do not translate &quot;Eudora&quot; below.</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineminus">-2006=Eudora Settings</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineminus">-</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineminus">-# Description</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineminus">-## @name EUDORAIMPORT_NICKNAMES_NAME</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineminus">-## @loc None</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineminus">-# LOCALIZATION NOTE (2007): Do not translate &quot;Eudora&quot; below.</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineminus">-2007=Eudora Nicknames</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineminus">-</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineminus">-# Description</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineminus">-## @name EUDORAIMPORT_ADDRESS_SUCCESS</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineminus">-## @loc None</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineminus">-# LOCALIZATION NOTE (2008): In the following sentence, do not translate the &quot;%S&quot;. Instead,</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineminus">-# place it in your sentence where you wish to display the name of the address book.</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineminus">-2008=Imported address book %S</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineminus">-</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineminus">-# Error message</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineminus">-## @name EUDORAIMPORT_ADDRESS_BADPARAM</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineminus">-## @loc None</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineminus">-2009=Bad parameter passed to import address book.</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineminus">-</span>
<a href="#l9.71"></a><span id="l9.71" class="difflineminus">-# Error message</span>
<a href="#l9.72"></a><span id="l9.72" class="difflineminus">-## @name EUDORAIMPORT_ADDRESS_BADSOURCEFILE</span>
<a href="#l9.73"></a><span id="l9.73" class="difflineminus">-## @loc None</span>
<a href="#l9.74"></a><span id="l9.74" class="difflineminus">-# LOCALIZATION NOTE (2010): In the following sentence, do not translate the &quot;%S&quot;. Instead,</span>
<a href="#l9.75"></a><span id="l9.75" class="difflineminus">-# place it in your sentence where you wish to display the name of the address book.</span>
<a href="#l9.76"></a><span id="l9.76" class="difflineminus">-2010=Error accessing file for address book %S.</span>
<a href="#l9.77"></a><span id="l9.77" class="difflineminus">-</span>
<a href="#l9.78"></a><span id="l9.78" class="difflineminus">-# Error message</span>
<a href="#l9.79"></a><span id="l9.79" class="difflineminus">-## @name EUDORAIMPORT_ADDRESS_CONVERTERROR</span>
<a href="#l9.80"></a><span id="l9.80" class="difflineminus">-## @loc None</span>
<a href="#l9.81"></a><span id="l9.81" class="difflineminus">-# LOCALIZATION NOTE (2011): In the following sentence, do not translate the &quot;%S&quot;. Instead,</span>
<a href="#l9.82"></a><span id="l9.82" class="difflineminus">-# place it in your sentence where you wish to display the name of the address book.</span>
<a href="#l9.83"></a><span id="l9.83" class="difflineminus">-2011=Error importing address book %S, all addresses may not have been imported.</span>
<a href="#l9.84"></a><span id="l9.84" class="difflineminus">-</span>
<a href="#l9.85"></a><span id="l9.85" class="difflineminus">-# Description</span>
<a href="#l9.86"></a><span id="l9.86" class="difflineminus">-## @name EUDORAIMPORT_ADDRESS_LABEL_HOMEMOBILE</span>
<a href="#l9.87"></a><span id="l9.87" class="difflineminus">-## @loc None</span>
<a href="#l9.88"></a><span id="l9.88" class="difflineminus">-# LOCALIZATION NOTE (2012): In the following sentence, do not translate the &quot;%S&quot;. Instead,</span>
<a href="#l9.89"></a><span id="l9.89" class="difflineminus">-# place it in your sentence where you wish to display the mobile phone number.</span>
<a href="#l9.90"></a><span id="l9.90" class="difflineminus">-</span>
<a href="#l9.91"></a><span id="l9.91" class="difflineminus">-2012=Personal Mobile: %S</span>
<a href="#l9.92"></a><span id="l9.92" class="difflineminus">-</span>
<a href="#l9.93"></a><span id="l9.93" class="difflineminus">-# Description</span>
<a href="#l9.94"></a><span id="l9.94" class="difflineminus">-## @name EUDORAIMPORT_ADDRESS_LABEL_WORKMOBILE</span>
<a href="#l9.95"></a><span id="l9.95" class="difflineminus">-## @loc None</span>
<a href="#l9.96"></a><span id="l9.96" class="difflineminus">-# LOCALIZATION NOTE (2013): In the following sentence, do not translate the &quot;%S&quot;. Instead,</span>
<a href="#l9.97"></a><span id="l9.97" class="difflineminus">-# place it in your sentence where you wish to display the mobile phone number.</span>
<a href="#l9.98"></a><span id="l9.98" class="difflineminus">-</span>
<a href="#l9.99"></a><span id="l9.99" class="difflineminus">-2013=Work Mobile: %S</span>
<a href="#l9.100"></a><span id="l9.100" class="difflineminus">-</span>
<a href="#l9.101"></a><span id="l9.101" class="difflineminus">-# Description</span>
<a href="#l9.102"></a><span id="l9.102" class="difflineminus">-## @name EUDORAIMPORT_ADDRESS_LABEL_HOMEFAX</span>
<a href="#l9.103"></a><span id="l9.103" class="difflineminus">-## @loc None</span>
<a href="#l9.104"></a><span id="l9.104" class="difflineminus">-# LOCALIZATION NOTE (2014): In the following sentence, do not translate the &quot;%S&quot;. Instead,</span>
<a href="#l9.105"></a><span id="l9.105" class="difflineminus">-# place it in your sentence where you wish to display the fax phone number.</span>
<a href="#l9.106"></a><span id="l9.106" class="difflineminus">- </span>
<a href="#l9.107"></a><span id="l9.107" class="difflineminus">-2014=Home Fax: %S</span>
<a href="#l9.108"></a><span id="l9.108" class="difflineminus">- </span>
<a href="#l9.109"></a><span id="l9.109" class="difflineminus">-# Description</span>
<a href="#l9.110"></a><span id="l9.110" class="difflineminus">-## @name EUDORAIMPORT_ADDRESS_LABEL_WORKFAX</span>
<a href="#l9.111"></a><span id="l9.111" class="difflineminus">-## @loc None</span>
<a href="#l9.112"></a><span id="l9.112" class="difflineminus">-# LOCALIZATION NOTE (2015): In the following sentence, do not translate the &quot;%S&quot;. Instead,</span>
<a href="#l9.113"></a><span id="l9.113" class="difflineminus">-# place it in your sentence where you wish to display the fax phone number.</span>
<a href="#l9.114"></a><span id="l9.114" class="difflineminus">-</span>
<a href="#l9.115"></a><span id="l9.115" class="difflineminus">-2015=Work Fax: %S</span>
<a href="#l9.116"></a><span id="l9.116" class="difflineminus">-</span>
<a href="#l9.117"></a><span id="l9.117" class="difflineminus">-# Description</span>
<a href="#l9.118"></a><span id="l9.118" class="difflineminus">-## @name EUDORAIMPORT_ADDRESS_LABEL_OTHEREMAIL</span>
<a href="#l9.119"></a><span id="l9.119" class="difflineminus">-## @loc None</span>
<a href="#l9.120"></a><span id="l9.120" class="difflineminus">-</span>
<a href="#l9.121"></a><span id="l9.121" class="difflineminus">-2016=Other Email:</span>
<a href="#l9.122"></a><span id="l9.122" class="difflineminus">-</span>
<a href="#l9.123"></a><span id="l9.123" class="difflineminus">-# Description</span>
<a href="#l9.124"></a><span id="l9.124" class="difflineminus">-## @name EUDORAIMPORT_ADDRESS_LABEL_OTHERPHONE</span>
<a href="#l9.125"></a><span id="l9.125" class="difflineminus">-## @loc None</span>
<a href="#l9.126"></a><span id="l9.126" class="difflineminus">-</span>
<a href="#l9.127"></a><span id="l9.127" class="difflineminus">-2017=Other Phone:</span>
<a href="#l9.128"></a><span id="l9.128" class="difflineminus">-</span>
<a href="#l9.129"></a><span id="l9.129" class="difflineminus">-# Description</span>
<a href="#l9.130"></a><span id="l9.130" class="difflineminus">-## @name EUDORAIMPORT_ADDRESS_LABEL_OTHERWEB</span>
<a href="#l9.131"></a><span id="l9.131" class="difflineminus">-## @loc None</span>
<a href="#l9.132"></a><span id="l9.132" class="difflineminus">-</span>
<a href="#l9.133"></a><span id="l9.133" class="difflineminus">-2018=Other Web:</span>
<a href="#l9.134"></a><span id="l9.134" class="difflineminus">-</span>
<a href="#l9.135"></a><span id="l9.135" class="difflineminus">-# Description</span>
<a href="#l9.136"></a><span id="l9.136" class="difflineminus">-## @name EUDORAIMPORT_FILTERS_WARN_OUTGOING</span>
<a href="#l9.137"></a><span id="l9.137" class="difflineminus">-## @loc None</span>
<a href="#l9.138"></a><span id="l9.138" class="difflineminus">-# LOCALIZATION NOTE (2019): This warning is displayed when one of Eudora's outgoing</span>
<a href="#l9.139"></a><span id="l9.139" class="difflineminus">-# filters is attempted to be imported.  Outgoing filters are ones which are</span>
<a href="#l9.140"></a><span id="l9.140" class="difflineminus">-# processed when a message is being sent, and are not supported.</span>
<a href="#l9.141"></a><span id="l9.141" class="difflineminus">-</span>
<a href="#l9.142"></a><span id="l9.142" class="difflineminus">-2019=can't import outgoing filter context</span>
<a href="#l9.143"></a><span id="l9.143" class="difflineminus">-</span>
<a href="#l9.144"></a><span id="l9.144" class="difflineminus">-# Description</span>
<a href="#l9.145"></a><span id="l9.145" class="difflineminus">-## @name EUDORAIMPORT_FILTERS_WARN_ACTION</span>
<a href="#l9.146"></a><span id="l9.146" class="difflineminus">-## @loc None</span>
<a href="#l9.147"></a><span id="l9.147" class="difflineminus">-# LOCALIZATION NOTE (2020): This warning is displayed if the action cannot be imported.</span>
<a href="#l9.148"></a><span id="l9.148" class="difflineminus">-# The &quot;action&quot; is what is done to the message if the filter matches, e.g. transfer to</span>
<a href="#l9.149"></a><span id="l9.149" class="difflineminus">-# a mailbox, change the priority.  The %S will be replaced with the name of the action.</span>
<a href="#l9.150"></a><span id="l9.150" class="difflineminus">-</span>
<a href="#l9.151"></a><span id="l9.151" class="difflineminus">-2020=can't import action &quot;%S&quot;</span>
<a href="#l9.152"></a><span id="l9.152" class="difflineminus">-</span>
<a href="#l9.153"></a><span id="l9.153" class="difflineminus">-# Description</span>
<a href="#l9.154"></a><span id="l9.154" class="difflineminus">-## @name EUDORAIMPORT_FILTERS_WARN_VERB</span>
<a href="#l9.155"></a><span id="l9.155" class="difflineminus">-## @loc None</span>
<a href="#l9.156"></a><span id="l9.156" class="difflineminus">-# LOCALIZATION NOTE (2021): This warning is displayed if the verb cannot be imported.</span>
<a href="#l9.157"></a><span id="l9.157" class="difflineminus">-# The &quot;verb&quot; is how filters match the header to the text, e.g. &quot;contains&quot;, &quot;is&quot;,</span>
<a href="#l9.158"></a><span id="l9.158" class="difflineminus">-# &quot;begins with&quot;.  The %s will be replaced with the name of the verb.</span>
<a href="#l9.159"></a><span id="l9.159" class="difflineminus">-</span>
<a href="#l9.160"></a><span id="l9.160" class="difflineminus">-2021=can't import the &quot;%s&quot; verb</span>
<a href="#l9.161"></a><span id="l9.161" class="difflineminus">-</span>
<a href="#l9.162"></a><span id="l9.162" class="difflineminus">-# Description</span>
<a href="#l9.163"></a><span id="l9.163" class="difflineminus">-## @name EUDORAIMPORT_FILTERS_WARN_EMPTY_HEADER</span>
<a href="#l9.164"></a><span id="l9.164" class="difflineminus">-## @loc None</span>
<a href="#l9.165"></a><span id="l9.165" class="difflineminus">-# LOCALIZATION NOTE (2027): This warning is displayed when the name of the header to be</span>
<a href="#l9.166"></a><span id="l9.166" class="difflineminus">-# filtered against cannot be found.</span>
<a href="#l9.167"></a><span id="l9.167" class="difflineminus">-</span>
<a href="#l9.168"></a><span id="l9.168" class="difflineminus">-2027=header name not found</span>
<a href="#l9.169"></a><span id="l9.169" class="difflineminus">-</span>
<a href="#l9.170"></a><span id="l9.170" class="difflineminus">-# Description</span>
<a href="#l9.171"></a><span id="l9.171" class="difflineminus">-## @name EUDORAIMPORT_FILTERS_WARN_NEGATE_VERB</span>
<a href="#l9.172"></a><span id="l9.172" class="difflineminus">-## @loc None</span>
<a href="#l9.173"></a><span id="l9.173" class="difflineminus">-# LOCALIZATION NOTE (2023): This warning is displayed when a filter term needs to be</span>
<a href="#l9.174"></a><span id="l9.174" class="difflineminus">-# negated, but the negative comparison is not supported, e.g. the &quot;starts with&quot; verb has</span>
<a href="#l9.175"></a><span id="l9.175" class="difflineminus">-# no corresponding &quot;doesn't start with&quot; verb.  The %S will be replaced with the name of</span>
<a href="#l9.176"></a><span id="l9.176" class="difflineminus">-# the verb.</span>
<a href="#l9.177"></a><span id="l9.177" class="difflineminus">-</span>
<a href="#l9.178"></a><span id="l9.178" class="difflineminus">-2023=can't negate the &quot;%S&quot; verb</span>
<a href="#l9.179"></a><span id="l9.179" class="difflineminus">-</span>
<a href="#l9.180"></a><span id="l9.180" class="difflineminus">-# Description</span>
<a href="#l9.181"></a><span id="l9.181" class="difflineminus">-## @name EUDORAIMPORT_FILTERS_WARN_META_HEADER</span>
<a href="#l9.182"></a><span id="l9.182" class="difflineminus">-## @loc None</span>
<a href="#l9.183"></a><span id="l9.183" class="difflineminus">-# LOCALIZATION NOTE (2028): This warning is displayed when one of Eudora's pseudo-headers</span>
<a href="#l9.184"></a><span id="l9.184" class="difflineminus">-# cannot be supported.  Pseudo-headers are things that can match mutiple headers, e.g.</span>
<a href="#l9.185"></a><span id="l9.185" class="difflineminus">-# &quot;Any Header&quot;, or non-header info, e.g. &quot;Junk Score&quot;.  The %S will be replaced with</span>
<a href="#l9.186"></a><span id="l9.186" class="difflineminus">-# the name of the pseudo-header.</span>
<a href="#l9.187"></a><span id="l9.187" class="difflineminus">-</span>
<a href="#l9.188"></a><span id="l9.188" class="difflineminus">-2028=can't import the %S pseudo-header</span>
<a href="#l9.189"></a><span id="l9.189" class="difflineminus">-</span>
<a href="#l9.190"></a><span id="l9.190" class="difflineminus">-# Description</span>
<a href="#l9.191"></a><span id="l9.191" class="difflineminus">-## @name EUDORAIMPORT_FILTERS_WARN_MAILBOX_MISSING</span>
<a href="#l9.192"></a><span id="l9.192" class="difflineminus">-## @loc None</span>
<a href="#l9.193"></a><span id="l9.193" class="difflineminus">-# LOCALIZATION NOTE (2025): This warning is displayed when a filter has an action to</span>
<a href="#l9.194"></a><span id="l9.194" class="difflineminus">-# transfer the message to a mailbox, but the named mailbox doesn't exist.  The %S will</span>
<a href="#l9.195"></a><span id="l9.195" class="difflineminus">-# be replaced with the name of the mailbox.</span>
<a href="#l9.196"></a><span id="l9.196" class="difflineminus">-</span>
<a href="#l9.197"></a><span id="l9.197" class="difflineminus">-2025=can't find the mailbox &quot;%S&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/migration/migration.dtd</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/migration/migration.dtd</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -11,18 +11,16 @@</span>
<a href="#l10.4"></a><span id="l10.4"> &lt;!ENTITY importFromNothing.label        &quot;Don't import anything&quot;&gt;</span>
<a href="#l10.5"></a><span id="l10.5"> &lt;!ENTITY importFromNothing.accesskey    &quot;D&quot;&gt;</span>
<a href="#l10.6"></a><span id="l10.6"> &lt;!ENTITY importFromSeamonkey3.label     &quot;SeaMonkey 2 or later&quot;&gt;</span>
<a href="#l10.7"></a><span id="l10.7"> &lt;!ENTITY importFromSeamonkey3.accesskey &quot;S&quot;&gt;</span>
<a href="#l10.8"></a><span id="l10.8"> &lt;!ENTITY importFromOExpress.label       &quot;Outlook Express&quot;&gt;</span>
<a href="#l10.9"></a><span id="l10.9"> &lt;!ENTITY importFromOExpress.accesskey   &quot;u&quot;&gt;</span>
<a href="#l10.10"></a><span id="l10.10"> &lt;!ENTITY importFromOutlook.label        &quot;Outlook&quot;&gt;</span>
<a href="#l10.11"></a><span id="l10.11"> &lt;!ENTITY importFromOutlook.accesskey    &quot;O&quot;&gt;</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-&lt;!ENTITY importFromEudora.label         &quot;Eudora&quot;&gt;</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-&lt;!ENTITY importFromEudora.accesskey     &quot;E&quot;&gt;</span>
<a href="#l10.14"></a><span id="l10.14"> </span>
<a href="#l10.15"></a><span id="l10.15"> &lt;!ENTITY importSource.title             &quot;Import Settings and Mail Folders&quot;&gt;</span>
<a href="#l10.16"></a><span id="l10.16"> &lt;!ENTITY importItems.title              &quot;Items to Import&quot;&gt;</span>
<a href="#l10.17"></a><span id="l10.17"> &lt;!ENTITY importItems.label              &quot;Select which items to import:&quot;&gt;</span>
<a href="#l10.18"></a><span id="l10.18"> </span>
<a href="#l10.19"></a><span id="l10.19"> &lt;!ENTITY migrating.title                &quot;Importing&quot;&gt;</span>
<a href="#l10.20"></a><span id="l10.20"> &lt;!ENTITY migrating.label                &quot;The following items are currently being imported&quot;&gt;</span>
<a href="#l10.21"></a><span id="l10.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/migration/migration.properties</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/migration/migration.properties</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -5,29 +5,24 @@</span>
<a href="#l11.4"></a><span id="l11.4"> profileName_format=%S %S</span>
<a href="#l11.5"></a><span id="l11.5"> </span>
<a href="#l11.6"></a><span id="l11.6"> # Import Sources</span>
<a href="#l11.7"></a><span id="l11.7"> 1_seamonkey=Preferences</span>
<a href="#l11.8"></a><span id="l11.8"> </span>
<a href="#l11.9"></a><span id="l11.9"> 2_seamonkey=Account Settings</span>
<a href="#l11.10"></a><span id="l11.10"> 2_oexpress=Account Settings</span>
<a href="#l11.11"></a><span id="l11.11"> 2_outlook=Account Settings</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-2_eudora=Account Settings</span>
<a href="#l11.13"></a><span id="l11.13"> </span>
<a href="#l11.14"></a><span id="l11.14"> 4_seamonkey=Address Books</span>
<a href="#l11.15"></a><span id="l11.15"> 4_oexpress=Address Book</span>
<a href="#l11.16"></a><span id="l11.16"> 4_outlook=Address Book</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineminus">-4_eudora=Address Books</span>
<a href="#l11.18"></a><span id="l11.18"> </span>
<a href="#l11.19"></a><span id="l11.19"> 8_seamonkey=Junk Mail Training</span>
<a href="#l11.20"></a><span id="l11.20"> </span>
<a href="#l11.21"></a><span id="l11.21"> 16_seamonkey=Saved Passwords</span>
<a href="#l11.22"></a><span id="l11.22"> </span>
<a href="#l11.23"></a><span id="l11.23"> 32_seamonkey=Other Data</span>
<a href="#l11.24"></a><span id="l11.24"> </span>
<a href="#l11.25"></a><span id="l11.25"> 64_seamonkey=Newsgroup Folders</span>
<a href="#l11.26"></a><span id="l11.26"> </span>
<a href="#l11.27"></a><span id="l11.27"> 128_seamonkey=Mail Folders</span>
<a href="#l11.28"></a><span id="l11.28"> 128_oexpress=Mail Folders</span>
<a href="#l11.29"></a><span id="l11.29"> 128_outlook=Mail Folders</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineminus">-128_eudora=Mail Folders</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineminus">-</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineminus">-256_eudora=Filters</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mail/locales/jar.mn</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mail/locales/jar.mn</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -97,17 +97,16 @@</span>
<a href="#l12.4"></a><span id="l12.4">   locale/@AB_CD@/messenger/mailViewList.dtd                             (%chrome/messenger/mailViewList.dtd)</span>
<a href="#l12.5"></a><span id="l12.5">   locale/@AB_CD@/messenger/offlineStartup.properties                    (%chrome/messenger/offlineStartup.properties)</span>
<a href="#l12.6"></a><span id="l12.6">   locale/@AB_CD@/messenger/importMsgs.properties                        (%chrome/messenger/importMsgs.properties)</span>
<a href="#l12.7"></a><span id="l12.7">   locale/@AB_CD@/messenger/importDialog.dtd                             (%chrome/messenger/importDialog.dtd)</span>
<a href="#l12.8"></a><span id="l12.8">   locale/@AB_CD@/messenger/fieldMapImport.dtd                           (%chrome/messenger/fieldMapImport.dtd)</span>
<a href="#l12.9"></a><span id="l12.9">   locale/@AB_CD@/messenger/textImportMsgs.properties                    (%chrome/messenger/textImportMsgs.properties)</span>
<a href="#l12.10"></a><span id="l12.10">   locale/@AB_CD@/messenger/vCardImportMsgs.properties                   (%chrome/messenger/vCardImportMsgs.properties)</span>
<a href="#l12.11"></a><span id="l12.11">   locale/@AB_CD@/messenger/appleMailImportMsgs.properties               (%chrome/messenger/appleMailImportMsgs.properties)</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-  locale/@AB_CD@/messenger/eudoraImportMsgs.properties                  (%chrome/messenger/eudoraImportMsgs.properties)</span>
<a href="#l12.13"></a><span id="l12.13">   locale/@AB_CD@/messenger/oeImportMsgs.properties                      (%chrome/messenger/oeImportMsgs.properties)</span>
<a href="#l12.14"></a><span id="l12.14">   locale/@AB_CD@/messenger/wmImportMsgs.properties                      (%chrome/messenger/wmImportMsgs.properties)</span>
<a href="#l12.15"></a><span id="l12.15">   locale/@AB_CD@/messenger/outlookImportMsgs.properties                 (%chrome/messenger/outlookImportMsgs.properties)</span>
<a href="#l12.16"></a><span id="l12.16">   locale/@AB_CD@/messenger/shutdownWindow.properties                    (%chrome/messenger/shutdownWindow.properties)</span>
<a href="#l12.17"></a><span id="l12.17">   locale/@AB_CD@/messenger/configEditorOverlay.dtd                      (%chrome/messenger/configEditorOverlay.dtd)</span>
<a href="#l12.18"></a><span id="l12.18">   locale/@AB_CD@/messenger/gloda.properties                             (%chrome/messenger/gloda.properties)</span>
<a href="#l12.19"></a><span id="l12.19">   locale/@AB_CD@/messenger/glodaComplete.properties                     (%chrome/messenger/glodaComplete.properties)</span>
<a href="#l12.20"></a><span id="l12.20">   locale/@AB_CD@/messenger/templateUtils.properties                     (%chrome/messenger/templateUtils.properties)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/compose/public/nsIMsgSend.idl</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/compose/public/nsIMsgSend.idl</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -126,17 +126,17 @@ interface nsIMsgAttachedFile : nsISuppor</span>
<a href="#l13.4"></a><span id="l13.4">   attribute unsigned long unprintableCount;</span>
<a href="#l13.5"></a><span id="l13.5">   attribute unsigned long highbitCount;</span>
<a href="#l13.6"></a><span id="l13.6">   attribute unsigned long ctlCount;</span>
<a href="#l13.7"></a><span id="l13.7">   attribute unsigned long nullCount;</span>
<a href="#l13.8"></a><span id="l13.8">   attribute unsigned long maxLineLength;</span>
<a href="#l13.9"></a><span id="l13.9"> };</span>
<a href="#l13.10"></a><span id="l13.10"> </span>
<a href="#l13.11"></a><span id="l13.11"> /**</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">- * This interface is used by Eudora and Outlook import to shuttle embedded</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+ * This interface is used by Outlook import to shuttle embedded</span>
<a href="#l13.14"></a><span id="l13.14">  * image information over to nsIMsgSend's createRFC822Message method via</span>
<a href="#l13.15"></a><span id="l13.15">  * the aEmbbeddedObjects parameter.</span>
<a href="#l13.16"></a><span id="l13.16">  */</span>
<a href="#l13.17"></a><span id="l13.17"> [scriptable, uuid(5d2c6554-b4c8-4d68-b864-50e0df929707)]</span>
<a href="#l13.18"></a><span id="l13.18"> interface nsIMsgEmbeddedImageData : nsISupports</span>
<a href="#l13.19"></a><span id="l13.19"> {</span>
<a href="#l13.20"></a><span id="l13.20">   attribute nsIURI uri;</span>
<a href="#l13.21"></a><span id="l13.21">   attribute ACString cid;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgSend.cpp</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgSend.cpp</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -1495,17 +1495,17 @@ nsMsgComposeAndSend::GetMultipartRelated</span>
<a href="#l14.4"></a><span id="l14.4">         // to process this element.</span>
<a href="#l14.5"></a><span id="l14.5">         //</span>
<a href="#l14.6"></a><span id="l14.6">         node = do_QueryElementAt(mEmbeddedObjectList, i, &amp;rv);</span>
<a href="#l14.7"></a><span id="l14.7">         bool acceptObject = false;</span>
<a href="#l14.8"></a><span id="l14.8">         if (node)</span>
<a href="#l14.9"></a><span id="l14.9">         {</span>
<a href="#l14.10"></a><span id="l14.10">           rv = GetEmbeddedObjectInfo(node, attachment, &amp;acceptObject);</span>
<a href="#l14.11"></a><span id="l14.11">         }</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-        else // outlook/eudora import case</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+        else // outlook import case</span>
<a href="#l14.14"></a><span id="l14.14">         {</span>
<a href="#l14.15"></a><span id="l14.15">           nsCOMPtr&lt;nsIMsgEmbeddedImageData&gt; imageData =</span>
<a href="#l14.16"></a><span id="l14.16">             do_QueryElementAt(mEmbeddedObjectList, i, &amp;rv);</span>
<a href="#l14.17"></a><span id="l14.17">           if (!imageData)</span>
<a href="#l14.18"></a><span id="l14.18">             continue;</span>
<a href="#l14.19"></a><span id="l14.19">           acceptObject = true;</span>
<a href="#l14.20"></a><span id="l14.20">         }</span>
<a href="#l14.21"></a><span id="l14.21">         if (NS_SUCCEEDED(rv) &amp;&amp; acceptObject)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/import/build/moz.build</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/import/build/moz.build</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -34,24 +34,22 @@ LOCAL_INCLUDES += [</span>
<a href="#l15.4"></a><span id="l15.4">     '../src',</span>
<a href="#l15.5"></a><span id="l15.5">     '../text/src',</span>
<a href="#l15.6"></a><span id="l15.6">     '../vcard/src',</span>
<a href="#l15.7"></a><span id="l15.7"> ]</span>
<a href="#l15.8"></a><span id="l15.8"> </span>
<a href="#l15.9"></a><span id="l15.9"> if CONFIG['MOZ_WIDGET_TOOLKIT'] == 'cocoa':</span>
<a href="#l15.10"></a><span id="l15.10">     LOCAL_INCLUDES += [</span>
<a href="#l15.11"></a><span id="l15.11">         '../applemail/src',</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-        '../eudora/src',</span>
<a href="#l15.13"></a><span id="l15.13">     ]</span>
<a href="#l15.14"></a><span id="l15.14">     OS_LIBS += CONFIG['TK_LIBS']</span>
<a href="#l15.15"></a><span id="l15.15">     OS_LIBS += ['-framework Cocoa']</span>
<a href="#l15.16"></a><span id="l15.16"> </span>
<a href="#l15.17"></a><span id="l15.17"> if CONFIG['OS_ARCH'] == 'WINNT':</span>
<a href="#l15.18"></a><span id="l15.18">     LOCAL_INCLUDES += [</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineminus">-        '../eudora/src',</span>
<a href="#l15.20"></a><span id="l15.20">     ]</span>
<a href="#l15.21"></a><span id="l15.21">     if not CONFIG['GNU_CC']:</span>
<a href="#l15.22"></a><span id="l15.22">         LOCAL_INCLUDES += [</span>
<a href="#l15.23"></a><span id="l15.23">             '../oexpress',</span>
<a href="#l15.24"></a><span id="l15.24">             '../outlook/src',</span>
<a href="#l15.25"></a><span id="l15.25">             '../winlivemail',</span>
<a href="#l15.26"></a><span id="l15.26">         ]</span>
<a href="#l15.27"></a><span id="l15.27">     if CONFIG['MOZ_MAPI_SUPPORT']:</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/import/build/nsImportModule.cpp</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/import/build/nsImportModule.cpp</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -28,26 +28,16 @@ NS_DEFINE_NAMED_CID(NS_TEXTIMPORT_CID);</span>
<a href="#l16.4"></a><span id="l16.4"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l16.5"></a><span id="l16.5"> // vCard import Include Files</span>
<a href="#l16.6"></a><span id="l16.6"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l16.7"></a><span id="l16.7"> #include &quot;nsVCardImport.h&quot;</span>
<a href="#l16.8"></a><span id="l16.8"> </span>
<a href="#l16.9"></a><span id="l16.9"> NS_DEFINE_NAMED_CID(NS_VCARDIMPORT_CID);</span>
<a href="#l16.10"></a><span id="l16.10"> </span>
<a href="#l16.11"></a><span id="l16.11"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-// eudora import Include Files</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineminus">-////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineminus">-#if defined(XP_WIN) || defined(XP_MACOSX)</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineminus">-#include &quot;nsEudoraImport.h&quot;</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineminus">-#include &quot;nsEudoraStringBundle.h&quot;</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineminus">-</span>
<a href="#l16.18"></a><span id="l16.18" class="difflineminus">-NS_DEFINE_NAMED_CID(NS_EUDORAIMPORT_CID);</span>
<a href="#l16.19"></a><span id="l16.19" class="difflineminus">-#endif</span>
<a href="#l16.20"></a><span id="l16.20" class="difflineminus">-</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineminus">-////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l16.22"></a><span id="l16.22"> // Apple Mail import Include Files</span>
<a href="#l16.23"></a><span id="l16.23"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l16.24"></a><span id="l16.24"> #if defined(XP_MACOSX)</span>
<a href="#l16.25"></a><span id="l16.25"> #include &quot;nsAppleMailImport.h&quot;</span>
<a href="#l16.26"></a><span id="l16.26"> </span>
<a href="#l16.27"></a><span id="l16.27"> NS_DEFINE_NAMED_CID(NS_APPLEMAILIMPORT_CID);</span>
<a href="#l16.28"></a><span id="l16.28"> NS_DEFINE_NAMED_CID(NS_APPLEMAILIMPL_CID);</span>
<a href="#l16.29"></a><span id="l16.29"> #endif</span>
<a href="#l16.30"></a><span id="l16.30" class="difflineat">@@ -84,23 +74,16 @@ NS_GENERIC_FACTORY_CONSTRUCTOR(nsIImport</span>
<a href="#l16.31"></a><span id="l16.31"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsTextImport)</span>
<a href="#l16.32"></a><span id="l16.32"> </span>
<a href="#l16.33"></a><span id="l16.33"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l16.34"></a><span id="l16.34"> // vcard import factories</span>
<a href="#l16.35"></a><span id="l16.35"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l16.36"></a><span id="l16.36"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsVCardImport)</span>
<a href="#l16.37"></a><span id="l16.37"> </span>
<a href="#l16.38"></a><span id="l16.38"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l16.39"></a><span id="l16.39" class="difflineminus">-// eudora import factories</span>
<a href="#l16.40"></a><span id="l16.40" class="difflineminus">-////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l16.41"></a><span id="l16.41" class="difflineminus">-#if defined(XP_WIN) || defined(XP_MACOSX)</span>
<a href="#l16.42"></a><span id="l16.42" class="difflineminus">-NS_GENERIC_FACTORY_CONSTRUCTOR(nsEudoraImport)</span>
<a href="#l16.43"></a><span id="l16.43" class="difflineminus">-#endif</span>
<a href="#l16.44"></a><span id="l16.44" class="difflineminus">-</span>
<a href="#l16.45"></a><span id="l16.45" class="difflineminus">-////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l16.46"></a><span id="l16.46"> // apple mail import factories</span>
<a href="#l16.47"></a><span id="l16.47"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l16.48"></a><span id="l16.48"> #if defined(XP_MACOSX)</span>
<a href="#l16.49"></a><span id="l16.49"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAppleMailImportModule)</span>
<a href="#l16.50"></a><span id="l16.50"> NS_GENERIC_FACTORY_CONSTRUCTOR_INIT(nsAppleMailImportMail, Initialize)</span>
<a href="#l16.51"></a><span id="l16.51"> #endif</span>
<a href="#l16.52"></a><span id="l16.52"> </span>
<a href="#l16.53"></a><span id="l16.53"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l16.54"></a><span id="l16.54" class="difflineat">@@ -114,19 +97,16 @@ NS_GENERIC_FACTORY_CONSTRUCTOR(nsOutlook</span>
<a href="#l16.55"></a><span id="l16.55"> #endif</span>
<a href="#l16.56"></a><span id="l16.56"> #endif // XP_WIN</span>
<a href="#l16.57"></a><span id="l16.57"> </span>
<a href="#l16.58"></a><span id="l16.58"> static const mozilla::Module::CategoryEntry kMailNewsImportCategories[] = {</span>
<a href="#l16.59"></a><span id="l16.59">   // XXX These CIDs should match the explicit CIDs defined in the header files,</span>
<a href="#l16.60"></a><span id="l16.60">   // or be changed so that they are contract IDs (with appropriate code updates)</span>
<a href="#l16.61"></a><span id="l16.61">   { &quot;mailnewsimport&quot;, &quot;{A5991D01-ADA7-11d3-A9C2-00A0CC26DA63}&quot;, NS_IMPORT_ADDRESS_STR },</span>
<a href="#l16.62"></a><span id="l16.62">   { &quot;mailnewsimport&quot;, &quot;{0eb034a3-964a-4e2f-92eb-cc55d9ae9dd2}&quot;, NS_IMPORT_ADDRESS_STR },</span>
<a href="#l16.63"></a><span id="l16.63" class="difflineminus">-#if defined(XP_WIN) || defined(XP_MACOSX)</span>
<a href="#l16.64"></a><span id="l16.64" class="difflineminus">-  { &quot;mailnewsimport&quot;, &quot;{c8448da0-8f83-11d3-a206-00a0cc26da63}&quot;, kEudoraSupportsString },</span>
<a href="#l16.65"></a><span id="l16.65" class="difflineminus">-#endif</span>
<a href="#l16.66"></a><span id="l16.66"> #ifdef XP_WIN</span>
<a href="#l16.67"></a><span id="l16.67">   { &quot;mailnewsimport&quot;, &quot;{42bc82bc-8e9f-4597-8b6e-e529daaf3af1}&quot;, kWMSupportsString },</span>
<a href="#l16.68"></a><span id="l16.68">   { &quot;mailnewsimport&quot;, &quot;{be0bc880-1742-11d3-a206-00a0cc26da63}&quot;, kOESupportsString },</span>
<a href="#l16.69"></a><span id="l16.69"> #ifdef MOZ_MAPI_SUPPORT</span>
<a href="#l16.70"></a><span id="l16.70">   { &quot;mailnewsimport&quot;, &quot;{1DB469A0-8B00-11d3-A206-00A0CC26DA63}&quot;, kOutlookSupportsString },</span>
<a href="#l16.71"></a><span id="l16.71"> #endif</span>
<a href="#l16.72"></a><span id="l16.72"> #endif</span>
<a href="#l16.73"></a><span id="l16.73"> #if defined(XP_MACOSX)</span>
<a href="#l16.74"></a><span id="l16.74" class="difflineat">@@ -135,19 +115,16 @@ static const mozilla::Module::CategoryEn</span>
<a href="#l16.75"></a><span id="l16.75">   { NULL }</span>
<a href="#l16.76"></a><span id="l16.76"> };</span>
<a href="#l16.77"></a><span id="l16.77"> </span>
<a href="#l16.78"></a><span id="l16.78"> const mozilla::Module::CIDEntry kMailNewsImportCIDs[] = {</span>
<a href="#l16.79"></a><span id="l16.79">   { &amp;kNS_IMPORTSERVICE_CID, false, NULL, nsImportServiceConstructor },</span>
<a href="#l16.80"></a><span id="l16.80">   { &amp;kNS_IMPORTMIMEENCODE_CID, false, NULL, nsIImportMimeEncodeImplConstructor },</span>
<a href="#l16.81"></a><span id="l16.81">   { &amp;kNS_TEXTIMPORT_CID, false, NULL, nsTextImportConstructor },</span>
<a href="#l16.82"></a><span id="l16.82">   { &amp;kNS_VCARDIMPORT_CID, false, NULL, nsVCardImportConstructor },</span>
<a href="#l16.83"></a><span id="l16.83" class="difflineminus">-#if defined(XP_WIN) || defined(XP_MACOSX)</span>
<a href="#l16.84"></a><span id="l16.84" class="difflineminus">-  { &amp;kNS_EUDORAIMPORT_CID, false, NULL, nsEudoraImportConstructor },</span>
<a href="#l16.85"></a><span id="l16.85" class="difflineminus">-#endif</span>
<a href="#l16.86"></a><span id="l16.86"> #if defined(XP_MACOSX)</span>
<a href="#l16.87"></a><span id="l16.87">   { &amp;kNS_APPLEMAILIMPORT_CID, false, NULL, nsAppleMailImportModuleConstructor },</span>
<a href="#l16.88"></a><span id="l16.88">   { &amp;kNS_APPLEMAILIMPL_CID, false, NULL, nsAppleMailImportMailConstructor },</span>
<a href="#l16.89"></a><span id="l16.89"> #endif</span>
<a href="#l16.90"></a><span id="l16.90"> </span>
<a href="#l16.91"></a><span id="l16.91"> #ifdef XP_WIN</span>
<a href="#l16.92"></a><span id="l16.92">   { &amp;kNS_OEIMPORT_CID, false, NULL, nsOEImportConstructor },</span>
<a href="#l16.93"></a><span id="l16.93">   { &amp;kNS_WMIMPORT_CID, false, NULL, nsWMImportConstructor },</span>
<a href="#l16.94"></a><span id="l16.94" class="difflineat">@@ -158,19 +135,16 @@ const mozilla::Module::CIDEntry kMailNew</span>
<a href="#l16.95"></a><span id="l16.95">   { NULL }</span>
<a href="#l16.96"></a><span id="l16.96"> };</span>
<a href="#l16.97"></a><span id="l16.97"> </span>
<a href="#l16.98"></a><span id="l16.98"> const mozilla::Module::ContractIDEntry kMailNewsImportContracts[] = {</span>
<a href="#l16.99"></a><span id="l16.99">   { NS_IMPORTSERVICE_CONTRACTID, &amp;kNS_IMPORTSERVICE_CID },</span>
<a href="#l16.100"></a><span id="l16.100">   { &quot;@mozilla.org/import/import-mimeencode;1&quot;, &amp;kNS_IMPORTMIMEENCODE_CID },</span>
<a href="#l16.101"></a><span id="l16.101">   { &quot;@mozilla.org/import/import-text;1&quot;, &amp;kNS_TEXTIMPORT_CID },</span>
<a href="#l16.102"></a><span id="l16.102">   { &quot;@mozilla.org/import/import-vcard;1&quot;, &amp;kNS_VCARDIMPORT_CID },</span>
<a href="#l16.103"></a><span id="l16.103" class="difflineminus">-#if defined(XP_WIN) || defined(XP_MACOSX)</span>
<a href="#l16.104"></a><span id="l16.104" class="difflineminus">-  { &quot;@mozilla.org/import/import-eudora;1&quot;, &amp;kNS_EUDORAIMPORT_CID },</span>
<a href="#l16.105"></a><span id="l16.105" class="difflineminus">-#endif</span>
<a href="#l16.106"></a><span id="l16.106"> #if defined(XP_MACOSX)</span>
<a href="#l16.107"></a><span id="l16.107">   { &quot;@mozilla.org/import/import-applemail;1&quot;, &amp;kNS_APPLEMAILIMPORT_CID },</span>
<a href="#l16.108"></a><span id="l16.108">   { NS_APPLEMAILIMPL_CONTRACTID, &amp;kNS_APPLEMAILIMPL_CID },</span>
<a href="#l16.109"></a><span id="l16.109"> #endif</span>
<a href="#l16.110"></a><span id="l16.110"> </span>
<a href="#l16.111"></a><span id="l16.111"> #ifdef XP_WIN</span>
<a href="#l16.112"></a><span id="l16.112">   { &quot;@mozilla.org/import/import-oe;1&quot;, &amp;kNS_OEIMPORT_CID },</span>
<a href="#l16.113"></a><span id="l16.113">   { &quot;@mozilla.org/import/import-wm;1&quot;, &amp;kNS_WMIMPORT_CID },</span>
<a href="#l16.114"></a><span id="l16.114" class="difflineat">@@ -179,20 +153,16 @@ const mozilla::Module::ContractIDEntry k</span>
<a href="#l16.115"></a><span id="l16.115"> #endif</span>
<a href="#l16.116"></a><span id="l16.116"> #endif</span>
<a href="#l16.117"></a><span id="l16.117">   { NULL }</span>
<a href="#l16.118"></a><span id="l16.118"> };</span>
<a href="#l16.119"></a><span id="l16.119"> </span>
<a href="#l16.120"></a><span id="l16.120"> </span>
<a href="#l16.121"></a><span id="l16.121"> static void importModuleDtor()</span>
<a href="#l16.122"></a><span id="l16.122"> {</span>
<a href="#l16.123"></a><span id="l16.123" class="difflineminus">-#if defined(XP_WIN) || defined(XP_MACOSX)</span>
<a href="#l16.124"></a><span id="l16.124" class="difflineminus">-    nsEudoraStringBundle::Cleanup();</span>
<a href="#l16.125"></a><span id="l16.125" class="difflineminus">-#endif</span>
<a href="#l16.126"></a><span id="l16.126" class="difflineminus">-</span>
<a href="#l16.127"></a><span id="l16.127"> #ifdef XP_WIN</span>
<a href="#l16.128"></a><span id="l16.128"> </span>
<a href="#l16.129"></a><span id="l16.129">     nsOEStringBundle::Cleanup();</span>
<a href="#l16.130"></a><span id="l16.130">     nsWMStringBundle::Cleanup();</span>
<a href="#l16.131"></a><span id="l16.131"> #ifdef MOZ_MAPI_SUPPORT</span>
<a href="#l16.132"></a><span id="l16.132">     nsOutlookStringBundle::Cleanup();</span>
<a href="#l16.133"></a><span id="l16.133"> #endif</span>
<a href="#l16.134"></a><span id="l16.134"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/import/content/importDialog.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/import/content/importDialog.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -384,18 +384,18 @@ function ListModules() {</span>
<a href="#l17.4"></a><span id="l17.4"> </span>
<a href="#l17.5"></a><span id="l17.5"> function AddModuleToList(moduleName, index)</span>
<a href="#l17.6"></a><span id="l17.6"> {</span>
<a href="#l17.7"></a><span id="l17.7">   var body = document.getElementById(&quot;moduleList&quot;);</span>
<a href="#l17.8"></a><span id="l17.8"> </span>
<a href="#l17.9"></a><span id="l17.9">   var item = document.createElement('listitem');</span>
<a href="#l17.10"></a><span id="l17.10">   item.setAttribute('label', moduleName);</span>
<a href="#l17.11"></a><span id="l17.11"> </span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-  // Temporarily skip Eudora and Outlook Import which are busted (Bug 1175055).</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineminus">-  if (moduleName == &quot;Eudora&quot; || moduleName == &quot;Outlook&quot;) {</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineplus">+  // Temporarily skip Outlook Import which are busted (Bug 1175055).</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineplus">+  if (moduleName == &quot;Outlook&quot;) {</span>
<a href="#l17.16"></a><span id="l17.16">     item.setAttribute('list-index', -1);</span>
<a href="#l17.17"></a><span id="l17.17">     item.setAttribute('disabled', true);</span>
<a href="#l17.18"></a><span id="l17.18">     item.setAttribute('tooltiptext', &quot;Currently disabled due to bug 1175055&quot;);</span>
<a href="#l17.19"></a><span id="l17.19">   } else {</span>
<a href="#l17.20"></a><span id="l17.20">     item.setAttribute('list-index', index);</span>
<a href="#l17.21"></a><span id="l17.21">   }</span>
<a href="#l17.22"></a><span id="l17.22">   body.appendChild(item);</span>
<a href="#l17.23"></a><span id="l17.23"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1">deleted file mode 100644</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineminus">--- a/mailnews/import/eudora/src/EudoraDebugLog.h</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineplus">+++ /dev/null</span>
<a href="#l18.4"></a><span id="l18.4" class="difflineat">@@ -1,25 +0,0 @@</span>
<a href="#l18.5"></a><span id="l18.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l18.6"></a><span id="l18.6" class="difflineminus">- *</span>
<a href="#l18.7"></a><span id="l18.7" class="difflineminus">- * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l18.8"></a><span id="l18.8" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l18.9"></a><span id="l18.9" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l18.10"></a><span id="l18.10" class="difflineminus">-</span>
<a href="#l18.11"></a><span id="l18.11" class="difflineminus">-#ifndef EudoraDebugLog_h___</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-#define EudoraDebugLog_h___</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineminus">-</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineminus">-#ifdef NS_DEBUG</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineminus">-#define IMPORT_DEBUG  1</span>
<a href="#l18.16"></a><span id="l18.16" class="difflineminus">-#endif</span>
<a href="#l18.17"></a><span id="l18.17" class="difflineminus">-</span>
<a href="#l18.18"></a><span id="l18.18" class="difflineminus">-// Use PR_LOG for logging.</span>
<a href="#l18.19"></a><span id="l18.19" class="difflineminus">-#include &quot;mozilla/Logging.h&quot;</span>
<a href="#l18.20"></a><span id="l18.20" class="difflineminus">-extern PRLogModuleInfo *EUDORALOGMODULE;  // Logging module</span>
<a href="#l18.21"></a><span id="l18.21" class="difflineminus">-</span>
<a href="#l18.22"></a><span id="l18.22" class="difflineminus">-#define IMPORT_LOG0(x)          MOZ_LOG(EUDORALOGMODULE, mozilla::LogLevel::Debug, (x))</span>
<a href="#l18.23"></a><span id="l18.23" class="difflineminus">-#define IMPORT_LOG1(x, y)       MOZ_LOG(EUDORALOGMODULE, mozilla::LogLevel::Debug, (x, y))</span>
<a href="#l18.24"></a><span id="l18.24" class="difflineminus">-#define IMPORT_LOG2(x, y, z)    MOZ_LOG(EUDORALOGMODULE, mozilla::LogLevel::Debug, (x, y, z))</span>
<a href="#l18.25"></a><span id="l18.25" class="difflineminus">-#define IMPORT_LOG3(a, b, c, d) MOZ_LOG(EUDORALOGMODULE, mozilla::LogLevel::Debug, (a, b, c, d))</span>
<a href="#l18.26"></a><span id="l18.26" class="difflineminus">-</span>
<a href="#l18.27"></a><span id="l18.27" class="difflineminus">-</span>
<a href="#l18.28"></a><span id="l18.28" class="difflineminus">-</span>
<a href="#l18.29"></a><span id="l18.29" class="difflineminus">-#endif /* EudoraDebugLog_h___ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1">deleted file mode 100644</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineminus">--- a/mailnews/import/eudora/src/moz.build</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineplus">+++ /dev/null</span>
<a href="#l19.4"></a><span id="l19.4" class="difflineat">@@ -1,28 +0,0 @@</span>
<a href="#l19.5"></a><span id="l19.5" class="difflineminus">-# vim: set filetype=python:</span>
<a href="#l19.6"></a><span id="l19.6" class="difflineminus">-# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l19.7"></a><span id="l19.7" class="difflineminus">-# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l19.8"></a><span id="l19.8" class="difflineminus">-# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l19.9"></a><span id="l19.9" class="difflineminus">-</span>
<a href="#l19.10"></a><span id="l19.10" class="difflineminus">-SOURCES += [</span>
<a href="#l19.11"></a><span id="l19.11" class="difflineminus">-    'nsEudoraAddress.cpp',</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-    'nsEudoraCompose.cpp',</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineminus">-    'nsEudoraEditor.cpp',</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineminus">-    'nsEudoraFilters.cpp',</span>
<a href="#l19.15"></a><span id="l19.15" class="difflineminus">-    'nsEudoraImport.cpp',</span>
<a href="#l19.16"></a><span id="l19.16" class="difflineminus">-    'nsEudoraMailbox.cpp',</span>
<a href="#l19.17"></a><span id="l19.17" class="difflineminus">-    'nsEudoraSettings.cpp',</span>
<a href="#l19.18"></a><span id="l19.18" class="difflineminus">-    'nsEudoraStringBundle.cpp',</span>
<a href="#l19.19"></a><span id="l19.19" class="difflineminus">-]</span>
<a href="#l19.20"></a><span id="l19.20" class="difflineminus">-</span>
<a href="#l19.21"></a><span id="l19.21" class="difflineminus">-if CONFIG['OS_ARCH'] == 'WINNT':</span>
<a href="#l19.22"></a><span id="l19.22" class="difflineminus">-    SOURCES += ['nsEudoraWin32.cpp']</span>
<a href="#l19.23"></a><span id="l19.23" class="difflineminus">-</span>
<a href="#l19.24"></a><span id="l19.24" class="difflineminus">-if CONFIG['MOZ_WIDGET_TOOLKIT'] == 'cocoa':</span>
<a href="#l19.25"></a><span id="l19.25" class="difflineminus">-    SOURCES += ['nsEudoraMac.cpp']</span>
<a href="#l19.26"></a><span id="l19.26" class="difflineminus">-</span>
<a href="#l19.27"></a><span id="l19.27" class="difflineminus">-FINAL_LIBRARY = 'import'</span>
<a href="#l19.28"></a><span id="l19.28" class="difflineminus">-</span>
<a href="#l19.29"></a><span id="l19.29" class="difflineminus">-LOCAL_INCLUDES += [</span>
<a href="#l19.30"></a><span id="l19.30" class="difflineminus">-    '../../src'</span>
<a href="#l19.31"></a><span id="l19.31" class="difflineminus">-]</span>
<a href="#l19.32"></a><span id="l19.32" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1">deleted file mode 100644</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineminus">--- a/mailnews/import/eudora/src/nsEudoraAddress.cpp</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineplus">+++ /dev/null</span>
<a href="#l20.4"></a><span id="l20.4" class="difflineat">@@ -1,1110 +0,0 @@</span>
<a href="#l20.5"></a><span id="l20.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-</span>
<a href="#l20.6"></a><span id="l20.6" class="difflineminus">- *</span>
<a href="#l20.7"></a><span id="l20.7" class="difflineminus">- * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l20.8"></a><span id="l20.8" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l20.9"></a><span id="l20.9" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l20.10"></a><span id="l20.10" class="difflineminus">-</span>
<a href="#l20.11"></a><span id="l20.11" class="difflineminus">-#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-#include &quot;nsEudoraAddress.h&quot;</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineminus">-</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineminus">-#include &quot;nsIAddrDatabase.h&quot;</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineminus">-#include &quot;mdb.h&quot;</span>
<a href="#l20.16"></a><span id="l20.16" class="difflineminus">-#include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l20.17"></a><span id="l20.17" class="difflineminus">-#include &quot;nsIAbCard.h&quot;</span>
<a href="#l20.18"></a><span id="l20.18" class="difflineminus">-#include &quot;nsIServiceManager.h&quot;</span>
<a href="#l20.19"></a><span id="l20.19" class="difflineminus">-#include &quot;nsEudoraImport.h&quot;</span>
<a href="#l20.20"></a><span id="l20.20" class="difflineminus">-#include &quot;nsEudoraCompose.h&quot;</span>
<a href="#l20.21"></a><span id="l20.21" class="difflineminus">-#include &quot;nsMsgUtils.h&quot;</span>
<a href="#l20.22"></a><span id="l20.22" class="difflineminus">-#include &quot;nsTextFormatter.h&quot;</span>
<a href="#l20.23"></a><span id="l20.23" class="difflineminus">-#include &quot;nsEudoraStringBundle.h&quot;</span>
<a href="#l20.24"></a><span id="l20.24" class="difflineminus">-#include &quot;nsIStringBundle.h&quot;</span>
<a href="#l20.25"></a><span id="l20.25" class="difflineminus">-#include &quot;nsNetUtil.h&quot;</span>
<a href="#l20.26"></a><span id="l20.26" class="difflineminus">-#include &quot;nsILineInputStream.h&quot;</span>
<a href="#l20.27"></a><span id="l20.27" class="difflineminus">-#include &quot;EudoraDebugLog.h&quot;</span>
<a href="#l20.28"></a><span id="l20.28" class="difflineminus">-</span>
<a href="#l20.29"></a><span id="l20.29" class="difflineminus">-#define  kWhitespace  &quot; \t\b\r\n&quot;</span>
<a href="#l20.30"></a><span id="l20.30" class="difflineminus">-</span>
<a href="#l20.31"></a><span id="l20.31" class="difflineminus">-#define ADD_FIELD_TO_DB_ROW(pdb, func, dbRow, val, uniStr)    \</span>
<a href="#l20.32"></a><span id="l20.32" class="difflineminus">-  if (!val.IsEmpty())                                         \</span>
<a href="#l20.33"></a><span id="l20.33" class="difflineminus">-  {                                                           \</span>
<a href="#l20.34"></a><span id="l20.34" class="difflineminus">-        NS_CopyNativeToUnicode(val, uniStr);                  \</span>
<a href="#l20.35"></a><span id="l20.35" class="difflineminus">-        pdb-&gt;func(dbRow, NS_ConvertUTF16toUTF8(uniStr).get());\</span>
<a href="#l20.36"></a><span id="l20.36" class="difflineminus">-  }</span>
<a href="#l20.37"></a><span id="l20.37" class="difflineminus">-</span>
<a href="#l20.38"></a><span id="l20.38" class="difflineminus">-</span>
<a href="#l20.39"></a><span id="l20.39" class="difflineminus">-// If we get a line longer than 16K it's just toooooo bad!</span>
<a href="#l20.40"></a><span id="l20.40" class="difflineminus">-#define kEudoraAddressBufferSz  (16 * 1024)</span>
<a href="#l20.41"></a><span id="l20.41" class="difflineminus">-</span>
<a href="#l20.42"></a><span id="l20.42" class="difflineminus">-</span>
<a href="#l20.43"></a><span id="l20.43" class="difflineminus">-#ifdef IMPORT_DEBUG</span>
<a href="#l20.44"></a><span id="l20.44" class="difflineminus">-void DumpAliasArray(nsTArray&lt;CAliasEntry*&gt;&amp; a);</span>
<a href="#l20.45"></a><span id="l20.45" class="difflineminus">-#endif</span>
<a href="#l20.46"></a><span id="l20.46" class="difflineminus">-</span>
<a href="#l20.47"></a><span id="l20.47" class="difflineminus">-class CAliasData {</span>
<a href="#l20.48"></a><span id="l20.48" class="difflineminus">-public:</span>
<a href="#l20.49"></a><span id="l20.49" class="difflineminus">-  CAliasData() {}</span>
<a href="#l20.50"></a><span id="l20.50" class="difflineminus">-  ~CAliasData() {}</span>
<a href="#l20.51"></a><span id="l20.51" class="difflineminus">-</span>
<a href="#l20.52"></a><span id="l20.52" class="difflineminus">-  bool Process(const char *pLine, int32_t len);</span>
<a href="#l20.53"></a><span id="l20.53" class="difflineminus">-</span>
<a href="#l20.54"></a><span id="l20.54" class="difflineminus">-public:</span>
<a href="#l20.55"></a><span id="l20.55" class="difflineminus">-    nsCString   m_fullEntry;</span>
<a href="#l20.56"></a><span id="l20.56" class="difflineminus">-    nsCString   m_nickName;</span>
<a href="#l20.57"></a><span id="l20.57" class="difflineminus">-    nsCString   m_realName;</span>
<a href="#l20.58"></a><span id="l20.58" class="difflineminus">-    nsCString   m_email;</span>
<a href="#l20.59"></a><span id="l20.59" class="difflineminus">-};</span>
<a href="#l20.60"></a><span id="l20.60" class="difflineminus">-</span>
<a href="#l20.61"></a><span id="l20.61" class="difflineminus">-class CAliasEntry {</span>
<a href="#l20.62"></a><span id="l20.62" class="difflineminus">-public:</span>
<a href="#l20.63"></a><span id="l20.63" class="difflineminus">-  CAliasEntry(nsCString&amp; name) { m_name = name;}</span>
<a href="#l20.64"></a><span id="l20.64" class="difflineminus">-  ~CAliasEntry() { EmptyList();}</span>
<a href="#l20.65"></a><span id="l20.65" class="difflineminus">-</span>
<a href="#l20.66"></a><span id="l20.66" class="difflineminus">-  void EmptyList(void) {</span>
<a href="#l20.67"></a><span id="l20.67" class="difflineminus">-    CAliasData *pData;</span>
<a href="#l20.68"></a><span id="l20.68" class="difflineminus">-    for (size_t i = 0; i &lt; m_list.Length(); i++) {</span>
<a href="#l20.69"></a><span id="l20.69" class="difflineminus">-      pData = m_list.ElementAt(i);</span>
<a href="#l20.70"></a><span id="l20.70" class="difflineminus">-      delete pData;</span>
<a href="#l20.71"></a><span id="l20.71" class="difflineminus">-    }</span>
<a href="#l20.72"></a><span id="l20.72" class="difflineminus">-    m_list.Clear();</span>
<a href="#l20.73"></a><span id="l20.73" class="difflineminus">-  }</span>
<a href="#l20.74"></a><span id="l20.74" class="difflineminus">-</span>
<a href="#l20.75"></a><span id="l20.75" class="difflineminus">-public:</span>
<a href="#l20.76"></a><span id="l20.76" class="difflineminus">-  nsCString  m_name;</span>
<a href="#l20.77"></a><span id="l20.77" class="difflineminus">-  nsTArray&lt;CAliasData*&gt;  m_list;</span>
<a href="#l20.78"></a><span id="l20.78" class="difflineminus">-  nsCString  m_notes;</span>
<a href="#l20.79"></a><span id="l20.79" class="difflineminus">-};</span>
<a href="#l20.80"></a><span id="l20.80" class="difflineminus">-</span>
<a href="#l20.81"></a><span id="l20.81" class="difflineminus">-nsEudoraAddress::nsEudoraAddress()</span>
<a href="#l20.82"></a><span id="l20.82" class="difflineminus">-{</span>
<a href="#l20.83"></a><span id="l20.83" class="difflineminus">-}</span>
<a href="#l20.84"></a><span id="l20.84" class="difflineminus">-</span>
<a href="#l20.85"></a><span id="l20.85" class="difflineminus">-nsEudoraAddress::~nsEudoraAddress()</span>
<a href="#l20.86"></a><span id="l20.86" class="difflineminus">-{</span>
<a href="#l20.87"></a><span id="l20.87" class="difflineminus">-  EmptyAliases();</span>
<a href="#l20.88"></a><span id="l20.88" class="difflineminus">-}</span>
<a href="#l20.89"></a><span id="l20.89" class="difflineminus">-</span>
<a href="#l20.90"></a><span id="l20.90" class="difflineminus">-</span>
<a href="#l20.91"></a><span id="l20.91" class="difflineminus">-nsresult nsEudoraAddress::ImportAddresses(uint32_t *pBytes, bool *pAbort,</span>
<a href="#l20.92"></a><span id="l20.92" class="difflineminus">-                                          const char16_t *pName, nsIFile *pSrc,</span>
<a href="#l20.93"></a><span id="l20.93" class="difflineminus">-                                          nsIAddrDatabase *pDb, nsString&amp; errors)</span>
<a href="#l20.94"></a><span id="l20.94" class="difflineminus">-{</span>
<a href="#l20.95"></a><span id="l20.95" class="difflineminus">-  // Open the source file for reading, read each line and process it!</span>
<a href="#l20.96"></a><span id="l20.96" class="difflineminus">-</span>
<a href="#l20.97"></a><span id="l20.97" class="difflineminus">-  EmptyAliases();</span>
<a href="#l20.98"></a><span id="l20.98" class="difflineminus">-  nsCOMPtr&lt;nsIInputStream&gt; inputStream;</span>
<a href="#l20.99"></a><span id="l20.99" class="difflineminus">-  nsresult rv = NS_NewLocalFileInputStream(getter_AddRefs(inputStream), pSrc);</span>
<a href="#l20.100"></a><span id="l20.100" class="difflineminus">-  if (NS_FAILED(rv)) {</span>
<a href="#l20.101"></a><span id="l20.101" class="difflineminus">-    IMPORT_LOG0(&quot;*** Error opening address file for reading\n&quot;);</span>
<a href="#l20.102"></a><span id="l20.102" class="difflineminus">-    return rv;</span>
<a href="#l20.103"></a><span id="l20.103" class="difflineminus">-  }</span>
<a href="#l20.104"></a><span id="l20.104" class="difflineminus">-</span>
<a href="#l20.105"></a><span id="l20.105" class="difflineminus">-  uint64_t bytesLeft = 0;</span>
<a href="#l20.106"></a><span id="l20.106" class="difflineminus">-</span>
<a href="#l20.107"></a><span id="l20.107" class="difflineminus">-  rv = inputStream-&gt;Available(&amp;bytesLeft);</span>
<a href="#l20.108"></a><span id="l20.108" class="difflineminus">-  if (NS_FAILED(rv)) {</span>
<a href="#l20.109"></a><span id="l20.109" class="difflineminus">-    IMPORT_LOG0(&quot;*** Error checking address file for eof\n&quot;);</span>
<a href="#l20.110"></a><span id="l20.110" class="difflineminus">-    inputStream-&gt;Close();</span>
<a href="#l20.111"></a><span id="l20.111" class="difflineminus">-    return rv;</span>
<a href="#l20.112"></a><span id="l20.112" class="difflineminus">-  }</span>
<a href="#l20.113"></a><span id="l20.113" class="difflineminus">-</span>
<a href="#l20.114"></a><span id="l20.114" class="difflineminus">-  nsCOMPtr&lt;nsILineInputStream&gt; lineStream(do_QueryInterface(inputStream, &amp;rv));</span>
<a href="#l20.115"></a><span id="l20.115" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.116"></a><span id="l20.116" class="difflineminus">-</span>
<a href="#l20.117"></a><span id="l20.117" class="difflineminus">-  bool more = true;</span>
<a href="#l20.118"></a><span id="l20.118" class="difflineminus">-</span>
<a href="#l20.119"></a><span id="l20.119" class="difflineminus">-  while ((!(*pAbort) &amp;&amp; more &amp;&amp; NS_SUCCEEDED(rv)))</span>
<a href="#l20.120"></a><span id="l20.120" class="difflineminus">-  {</span>
<a href="#l20.121"></a><span id="l20.121" class="difflineminus">-    nsCString line;</span>
<a href="#l20.122"></a><span id="l20.122" class="difflineminus">-    rv = lineStream-&gt;ReadLine(line, &amp;more);</span>
<a href="#l20.123"></a><span id="l20.123" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l20.124"></a><span id="l20.124" class="difflineminus">-    {</span>
<a href="#l20.125"></a><span id="l20.125" class="difflineminus">-      int32_t  len = line.Length();</span>
<a href="#l20.126"></a><span id="l20.126" class="difflineminus">-      ProcessLine(line.get(), len, errors);</span>
<a href="#l20.127"></a><span id="l20.127" class="difflineminus">-      if (pBytes)</span>
<a href="#l20.128"></a><span id="l20.128" class="difflineminus">-        *pBytes += (len / 2);</span>
<a href="#l20.129"></a><span id="l20.129" class="difflineminus">-    }</span>
<a href="#l20.130"></a><span id="l20.130" class="difflineminus">-  }</span>
<a href="#l20.131"></a><span id="l20.131" class="difflineminus">-  rv = inputStream-&gt;Close();</span>
<a href="#l20.132"></a><span id="l20.132" class="difflineminus">-</span>
<a href="#l20.133"></a><span id="l20.133" class="difflineminus">-  if (more)</span>
<a href="#l20.134"></a><span id="l20.134" class="difflineminus">-  {</span>
<a href="#l20.135"></a><span id="l20.135" class="difflineminus">-    IMPORT_LOG0(&quot;*** Error reading the address book, didn't reach the end\n&quot;);</span>
<a href="#l20.136"></a><span id="l20.136" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l20.137"></a><span id="l20.137" class="difflineminus">-  }</span>
<a href="#l20.138"></a><span id="l20.138" class="difflineminus">-  // Run through the alias array and make address book entries...</span>
<a href="#l20.139"></a><span id="l20.139" class="difflineminus">-#ifdef IMPORT_DEBUG</span>
<a href="#l20.140"></a><span id="l20.140" class="difflineminus">-  DumpAliasArray(m_alias);</span>
<a href="#l20.141"></a><span id="l20.141" class="difflineminus">-#endif</span>
<a href="#l20.142"></a><span id="l20.142" class="difflineminus">-</span>
<a href="#l20.143"></a><span id="l20.143" class="difflineminus">-  BuildABCards(pBytes, pDb);</span>
<a href="#l20.144"></a><span id="l20.144" class="difflineminus">-</span>
<a href="#l20.145"></a><span id="l20.145" class="difflineminus">-  return pDb-&gt;Commit(nsAddrDBCommitType::kLargeCommit);</span>
<a href="#l20.146"></a><span id="l20.146" class="difflineminus">-  }</span>
<a href="#l20.147"></a><span id="l20.147" class="difflineminus">-</span>
<a href="#l20.148"></a><span id="l20.148" class="difflineminus">-</span>
<a href="#l20.149"></a><span id="l20.149" class="difflineminus">-int32_t nsEudoraAddress::CountWhiteSpace(const char *pLine, int32_t len)</span>
<a href="#l20.150"></a><span id="l20.150" class="difflineminus">-{</span>
<a href="#l20.151"></a><span id="l20.151" class="difflineminus">-  int32_t    cnt = 0;</span>
<a href="#l20.152"></a><span id="l20.152" class="difflineminus">-  while (len &amp;&amp; ((*pLine == ' ') || (*pLine == '\t'))) {</span>
<a href="#l20.153"></a><span id="l20.153" class="difflineminus">-    len--;</span>
<a href="#l20.154"></a><span id="l20.154" class="difflineminus">-    pLine++;</span>
<a href="#l20.155"></a><span id="l20.155" class="difflineminus">-    cnt++;</span>
<a href="#l20.156"></a><span id="l20.156" class="difflineminus">-  }</span>
<a href="#l20.157"></a><span id="l20.157" class="difflineminus">-</span>
<a href="#l20.158"></a><span id="l20.158" class="difflineminus">-  return cnt;</span>
<a href="#l20.159"></a><span id="l20.159" class="difflineminus">-}</span>
<a href="#l20.160"></a><span id="l20.160" class="difflineminus">-</span>
<a href="#l20.161"></a><span id="l20.161" class="difflineminus">-void nsEudoraAddress::EmptyAliases(void)</span>
<a href="#l20.162"></a><span id="l20.162" class="difflineminus">-{</span>
<a href="#l20.163"></a><span id="l20.163" class="difflineminus">-  CAliasEntry *pData;</span>
<a href="#l20.164"></a><span id="l20.164" class="difflineminus">-  for (size_t i = 0; i &lt; m_alias.Length(); i++) {</span>
<a href="#l20.165"></a><span id="l20.165" class="difflineminus">-    pData = m_alias.ElementAt(i);</span>
<a href="#l20.166"></a><span id="l20.166" class="difflineminus">-    delete pData;</span>
<a href="#l20.167"></a><span id="l20.167" class="difflineminus">-  }</span>
<a href="#l20.168"></a><span id="l20.168" class="difflineminus">-  m_alias.Clear();</span>
<a href="#l20.169"></a><span id="l20.169" class="difflineminus">-}</span>
<a href="#l20.170"></a><span id="l20.170" class="difflineminus">-</span>
<a href="#l20.171"></a><span id="l20.171" class="difflineminus">-void nsEudoraAddress::ProcessLine(const char *pLine, int32_t len, nsString&amp; errors)</span>
<a href="#l20.172"></a><span id="l20.172" class="difflineminus">-{</span>
<a href="#l20.173"></a><span id="l20.173" class="difflineminus">-  if (len &lt; 6)</span>
<a href="#l20.174"></a><span id="l20.174" class="difflineminus">-    return;</span>
<a href="#l20.175"></a><span id="l20.175" class="difflineminus">-</span>
<a href="#l20.176"></a><span id="l20.176" class="difflineminus">-  int32_t  cnt;</span>
<a href="#l20.177"></a><span id="l20.177" class="difflineminus">-  CAliasEntry  *pEntry;</span>
<a href="#l20.178"></a><span id="l20.178" class="difflineminus">-</span>
<a href="#l20.179"></a><span id="l20.179" class="difflineminus">-  if (!strncmp(pLine, &quot;alias&quot;, 5)) {</span>
<a href="#l20.180"></a><span id="l20.180" class="difflineminus">-    pLine += 5;</span>
<a href="#l20.181"></a><span id="l20.181" class="difflineminus">-    len -= 5;</span>
<a href="#l20.182"></a><span id="l20.182" class="difflineminus">-    cnt = CountWhiteSpace(pLine, len);</span>
<a href="#l20.183"></a><span id="l20.183" class="difflineminus">-    if (cnt) {</span>
<a href="#l20.184"></a><span id="l20.184" class="difflineminus">-      pLine += cnt;</span>
<a href="#l20.185"></a><span id="l20.185" class="difflineminus">-      len -= cnt;</span>
<a href="#l20.186"></a><span id="l20.186" class="difflineminus">-      if ((pEntry = ProcessAlias(pLine, len, errors)) != nullptr)</span>
<a href="#l20.187"></a><span id="l20.187" class="difflineminus">-        m_alias.AppendElement(pEntry);</span>
<a href="#l20.188"></a><span id="l20.188" class="difflineminus">-    }</span>
<a href="#l20.189"></a><span id="l20.189" class="difflineminus">-  }</span>
<a href="#l20.190"></a><span id="l20.190" class="difflineminus">-  else if (!strncmp(pLine, &quot;note&quot;, 4)) {</span>
<a href="#l20.191"></a><span id="l20.191" class="difflineminus">-    pLine += 4;</span>
<a href="#l20.192"></a><span id="l20.192" class="difflineminus">-    len -= 4;</span>
<a href="#l20.193"></a><span id="l20.193" class="difflineminus">-    cnt = CountWhiteSpace(pLine, len);</span>
<a href="#l20.194"></a><span id="l20.194" class="difflineminus">-    if (cnt) {</span>
<a href="#l20.195"></a><span id="l20.195" class="difflineminus">-      pLine += cnt;</span>
<a href="#l20.196"></a><span id="l20.196" class="difflineminus">-      len -= cnt;</span>
<a href="#l20.197"></a><span id="l20.197" class="difflineminus">-      ProcessNote(pLine, len, errors);</span>
<a href="#l20.198"></a><span id="l20.198" class="difflineminus">-    }</span>
<a href="#l20.199"></a><span id="l20.199" class="difflineminus">-  }</span>
<a href="#l20.200"></a><span id="l20.200" class="difflineminus">-</span>
<a href="#l20.201"></a><span id="l20.201" class="difflineminus">-  // as far as I know everything must be on one line</span>
<a href="#l20.202"></a><span id="l20.202" class="difflineminus">-  // if not, then I need to add a state variable.</span>
<a href="#l20.203"></a><span id="l20.203" class="difflineminus">-}</span>
<a href="#l20.204"></a><span id="l20.204" class="difflineminus">-</span>
<a href="#l20.205"></a><span id="l20.205" class="difflineminus">-int32_t nsEudoraAddress::GetAliasName(const char *pLine, int32_t len, nsCString&amp; name)</span>
<a href="#l20.206"></a><span id="l20.206" class="difflineminus">-{</span>
<a href="#l20.207"></a><span id="l20.207" class="difflineminus">-  name.Truncate();</span>
<a href="#l20.208"></a><span id="l20.208" class="difflineminus">-  if (!len)</span>
<a href="#l20.209"></a><span id="l20.209" class="difflineminus">-    return 0;</span>
<a href="#l20.210"></a><span id="l20.210" class="difflineminus">-  const char *pStart = pLine;</span>
<a href="#l20.211"></a><span id="l20.211" class="difflineminus">-  char  end[2] = {' ', '\t'};</span>
<a href="#l20.212"></a><span id="l20.212" class="difflineminus">-  if (*pLine == '&quot;') {</span>
<a href="#l20.213"></a><span id="l20.213" class="difflineminus">-    pLine++;</span>
<a href="#l20.214"></a><span id="l20.214" class="difflineminus">-    pStart++;</span>
<a href="#l20.215"></a><span id="l20.215" class="difflineminus">-    len--;</span>
<a href="#l20.216"></a><span id="l20.216" class="difflineminus">-    end[0] = '&quot;';</span>
<a href="#l20.217"></a><span id="l20.217" class="difflineminus">-    end[1] = 0;</span>
<a href="#l20.218"></a><span id="l20.218" class="difflineminus">-  }</span>
<a href="#l20.219"></a><span id="l20.219" class="difflineminus">-</span>
<a href="#l20.220"></a><span id="l20.220" class="difflineminus">-  int32_t cnt = 0;</span>
<a href="#l20.221"></a><span id="l20.221" class="difflineminus">-  while (len) {</span>
<a href="#l20.222"></a><span id="l20.222" class="difflineminus">-    if ((*pLine == end[0]) || (*pLine == end[1]))</span>
<a href="#l20.223"></a><span id="l20.223" class="difflineminus">-      break;</span>
<a href="#l20.224"></a><span id="l20.224" class="difflineminus">-    len--;</span>
<a href="#l20.225"></a><span id="l20.225" class="difflineminus">-    pLine++;</span>
<a href="#l20.226"></a><span id="l20.226" class="difflineminus">-    cnt++;</span>
<a href="#l20.227"></a><span id="l20.227" class="difflineminus">-  }</span>
<a href="#l20.228"></a><span id="l20.228" class="difflineminus">-</span>
<a href="#l20.229"></a><span id="l20.229" class="difflineminus">-  if (cnt)</span>
<a href="#l20.230"></a><span id="l20.230" class="difflineminus">-    name.Append(pStart, cnt);</span>
<a href="#l20.231"></a><span id="l20.231" class="difflineminus">-</span>
<a href="#l20.232"></a><span id="l20.232" class="difflineminus">-  if (end[0] == '&quot;') {</span>
<a href="#l20.233"></a><span id="l20.233" class="difflineminus">-    cnt++;</span>
<a href="#l20.234"></a><span id="l20.234" class="difflineminus">-    if (len &amp;&amp; (*pLine == '&quot;')) {</span>
<a href="#l20.235"></a><span id="l20.235" class="difflineminus">-      cnt++;</span>
<a href="#l20.236"></a><span id="l20.236" class="difflineminus">-      pLine++;</span>
<a href="#l20.237"></a><span id="l20.237" class="difflineminus">-      len--;</span>
<a href="#l20.238"></a><span id="l20.238" class="difflineminus">-    }</span>
<a href="#l20.239"></a><span id="l20.239" class="difflineminus">-  }</span>
<a href="#l20.240"></a><span id="l20.240" class="difflineminus">-</span>
<a href="#l20.241"></a><span id="l20.241" class="difflineminus">-  cnt += CountWhiteSpace(pLine, len);</span>
<a href="#l20.242"></a><span id="l20.242" class="difflineminus">-</span>
<a href="#l20.243"></a><span id="l20.243" class="difflineminus">-  return cnt;</span>
<a href="#l20.244"></a><span id="l20.244" class="difflineminus">-}</span>
<a href="#l20.245"></a><span id="l20.245" class="difflineminus">-</span>
<a href="#l20.246"></a><span id="l20.246" class="difflineminus">-</span>
<a href="#l20.247"></a><span id="l20.247" class="difflineminus">-CAliasEntry *nsEudoraAddress::ProcessAlias(const char *pLine, int32_t len, nsString&amp; errors)</span>
<a href="#l20.248"></a><span id="l20.248" class="difflineminus">-{</span>
<a href="#l20.249"></a><span id="l20.249" class="difflineminus">-  nsCString  name;</span>
<a href="#l20.250"></a><span id="l20.250" class="difflineminus">-  int32_t    cnt = GetAliasName(pLine, len, name);</span>
<a href="#l20.251"></a><span id="l20.251" class="difflineminus">-  pLine += cnt;</span>
<a href="#l20.252"></a><span id="l20.252" class="difflineminus">-  len -= cnt;</span>
<a href="#l20.253"></a><span id="l20.253" class="difflineminus">-</span>
<a href="#l20.254"></a><span id="l20.254" class="difflineminus">-  // we have 3 known forms of addresses in Eudora</span>
<a href="#l20.255"></a><span id="l20.255" class="difflineminus">-  // 1) real name &lt;email@address&gt;</span>
<a href="#l20.256"></a><span id="l20.256" class="difflineminus">-  // 2) email@address</span>
<a href="#l20.257"></a><span id="l20.257" class="difflineminus">-  // 3) &lt;email@address&gt;</span>
<a href="#l20.258"></a><span id="l20.258" class="difflineminus">-  // 4) real name email@address</span>
<a href="#l20.259"></a><span id="l20.259" class="difflineminus">-  // 5) &lt;email@address&gt; (Real name)</span>
<a href="#l20.260"></a><span id="l20.260" class="difflineminus">-</span>
<a href="#l20.261"></a><span id="l20.261" class="difflineminus">-  CAliasEntry *pEntry = new CAliasEntry(name);</span>
<a href="#l20.262"></a><span id="l20.262" class="difflineminus">-  if (!cnt || !len)</span>
<a href="#l20.263"></a><span id="l20.263" class="difflineminus">-    return pEntry;</span>
<a href="#l20.264"></a><span id="l20.264" class="difflineminus">-</span>
<a href="#l20.265"></a><span id="l20.265" class="difflineminus">-  // Theoretically, an alias is just an RFC822 email adress, but it may contain</span>
<a href="#l20.266"></a><span id="l20.266" class="difflineminus">-  // an alias to another alias as the email!  I general, it appears close</span>
<a href="#l20.267"></a><span id="l20.267" class="difflineminus">-  // but unfortunately not exact so we can't use the nsIMsgHeaderParser to do</span>
<a href="#l20.268"></a><span id="l20.268" class="difflineminus">-  // the work for us!</span>
<a href="#l20.269"></a><span id="l20.269" class="difflineminus">-</span>
<a href="#l20.270"></a><span id="l20.270" class="difflineminus">-  // Very big bummer!</span>
<a href="#l20.271"></a><span id="l20.271" class="difflineminus">-</span>
<a href="#l20.272"></a><span id="l20.272" class="difflineminus">-  const char *pStart;</span>
<a href="#l20.273"></a><span id="l20.273" class="difflineminus">-  int32_t    tLen;</span>
<a href="#l20.274"></a><span id="l20.274" class="difflineminus">-  nsCString  alias;</span>
<a href="#l20.275"></a><span id="l20.275" class="difflineminus">-</span>
<a href="#l20.276"></a><span id="l20.276" class="difflineminus">-  while (len) {</span>
<a href="#l20.277"></a><span id="l20.277" class="difflineminus">-    pStart = pLine;</span>
<a href="#l20.278"></a><span id="l20.278" class="difflineminus">-    cnt = 0;</span>
<a href="#l20.279"></a><span id="l20.279" class="difflineminus">-    while (len &amp;&amp; (*pLine != ',')) {</span>
<a href="#l20.280"></a><span id="l20.280" class="difflineminus">-      if (*pLine == '&quot;') {</span>
<a href="#l20.281"></a><span id="l20.281" class="difflineminus">-        tLen = CountQuote(pLine, len);</span>
<a href="#l20.282"></a><span id="l20.282" class="difflineminus">-        pLine += tLen;</span>
<a href="#l20.283"></a><span id="l20.283" class="difflineminus">-        len -= tLen;</span>
<a href="#l20.284"></a><span id="l20.284" class="difflineminus">-        cnt += tLen;</span>
<a href="#l20.285"></a><span id="l20.285" class="difflineminus">-      }</span>
<a href="#l20.286"></a><span id="l20.286" class="difflineminus">-      else if (*pLine == '(') {</span>
<a href="#l20.287"></a><span id="l20.287" class="difflineminus">-        tLen = CountComment(pLine, len);</span>
<a href="#l20.288"></a><span id="l20.288" class="difflineminus">-        pLine += tLen;</span>
<a href="#l20.289"></a><span id="l20.289" class="difflineminus">-        len -= tLen;</span>
<a href="#l20.290"></a><span id="l20.290" class="difflineminus">-        cnt += tLen;</span>
<a href="#l20.291"></a><span id="l20.291" class="difflineminus">-      }</span>
<a href="#l20.292"></a><span id="l20.292" class="difflineminus">-      else if (*pLine == '&lt;') {</span>
<a href="#l20.293"></a><span id="l20.293" class="difflineminus">-        tLen = CountAngle(pLine, len);</span>
<a href="#l20.294"></a><span id="l20.294" class="difflineminus">-        pLine += tLen;</span>
<a href="#l20.295"></a><span id="l20.295" class="difflineminus">-        len -= tLen;</span>
<a href="#l20.296"></a><span id="l20.296" class="difflineminus">-        cnt += tLen;</span>
<a href="#l20.297"></a><span id="l20.297" class="difflineminus">-      }</span>
<a href="#l20.298"></a><span id="l20.298" class="difflineminus">-      else {</span>
<a href="#l20.299"></a><span id="l20.299" class="difflineminus">-        cnt++;</span>
<a href="#l20.300"></a><span id="l20.300" class="difflineminus">-        pLine++;</span>
<a href="#l20.301"></a><span id="l20.301" class="difflineminus">-        len--;</span>
<a href="#l20.302"></a><span id="l20.302" class="difflineminus">-      }</span>
<a href="#l20.303"></a><span id="l20.303" class="difflineminus">-    }</span>
<a href="#l20.304"></a><span id="l20.304" class="difflineminus">-    if (cnt) {</span>
<a href="#l20.305"></a><span id="l20.305" class="difflineminus">-      CAliasData *pData = new CAliasData();</span>
<a href="#l20.306"></a><span id="l20.306" class="difflineminus">-      if (pData-&gt;Process(pStart, cnt))</span>
<a href="#l20.307"></a><span id="l20.307" class="difflineminus">-        pEntry-&gt;m_list.AppendElement(pData);</span>
<a href="#l20.308"></a><span id="l20.308" class="difflineminus">-      else</span>
<a href="#l20.309"></a><span id="l20.309" class="difflineminus">-        delete pData;</span>
<a href="#l20.310"></a><span id="l20.310" class="difflineminus">-    }</span>
<a href="#l20.311"></a><span id="l20.311" class="difflineminus">-</span>
<a href="#l20.312"></a><span id="l20.312" class="difflineminus">-    if (len &amp;&amp; (*pLine == ',')) {</span>
<a href="#l20.313"></a><span id="l20.313" class="difflineminus">-      pLine++;</span>
<a href="#l20.314"></a><span id="l20.314" class="difflineminus">-      len--;</span>
<a href="#l20.315"></a><span id="l20.315" class="difflineminus">-    }</span>
<a href="#l20.316"></a><span id="l20.316" class="difflineminus">-  }</span>
<a href="#l20.317"></a><span id="l20.317" class="difflineminus">-</span>
<a href="#l20.318"></a><span id="l20.318" class="difflineminus">-  // Always return the entry even if there's no other attribute associated with the contact.</span>
<a href="#l20.319"></a><span id="l20.319" class="difflineminus">-  return pEntry;</span>
<a href="#l20.320"></a><span id="l20.320" class="difflineminus">-}</span>
<a href="#l20.321"></a><span id="l20.321" class="difflineminus">-</span>
<a href="#l20.322"></a><span id="l20.322" class="difflineminus">-</span>
<a href="#l20.323"></a><span id="l20.323" class="difflineminus">-void nsEudoraAddress::ProcessNote(const char *pLine, int32_t len, nsString&amp; errors)</span>
<a href="#l20.324"></a><span id="l20.324" class="difflineminus">-{</span>
<a href="#l20.325"></a><span id="l20.325" class="difflineminus">-  nsCString  name;</span>
<a href="#l20.326"></a><span id="l20.326" class="difflineminus">-  int32_t    cnt = GetAliasName(pLine, len, name);</span>
<a href="#l20.327"></a><span id="l20.327" class="difflineminus">-  pLine += cnt;</span>
<a href="#l20.328"></a><span id="l20.328" class="difflineminus">-  len -= cnt;</span>
<a href="#l20.329"></a><span id="l20.329" class="difflineminus">-  if (!cnt || !len)</span>
<a href="#l20.330"></a><span id="l20.330" class="difflineminus">-    return;</span>
<a href="#l20.331"></a><span id="l20.331" class="difflineminus">-</span>
<a href="#l20.332"></a><span id="l20.332" class="difflineminus">-  // Find the alias for this note and store the note data there!</span>
<a href="#l20.333"></a><span id="l20.333" class="difflineminus">-  CAliasEntry *pEntry = nullptr;</span>
<a href="#l20.334"></a><span id="l20.334" class="difflineminus">-  int32_t  idx = FindAlias(name);</span>
<a href="#l20.335"></a><span id="l20.335" class="difflineminus">-  if (idx == -1)</span>
<a href="#l20.336"></a><span id="l20.336" class="difflineminus">-    return;</span>
<a href="#l20.337"></a><span id="l20.337" class="difflineminus">-</span>
<a href="#l20.338"></a><span id="l20.338" class="difflineminus">-  pEntry = m_alias.ElementAt(idx);</span>
<a href="#l20.339"></a><span id="l20.339" class="difflineminus">-  pEntry-&gt;m_notes.Append(pLine, len);</span>
<a href="#l20.340"></a><span id="l20.340" class="difflineminus">-  pEntry-&gt;m_notes.Trim(kWhitespace);</span>
<a href="#l20.341"></a><span id="l20.341" class="difflineminus">-}</span>
<a href="#l20.342"></a><span id="l20.342" class="difflineminus">-</span>
<a href="#l20.343"></a><span id="l20.343" class="difflineminus">-</span>
<a href="#l20.344"></a><span id="l20.344" class="difflineminus">-</span>
<a href="#l20.345"></a><span id="l20.345" class="difflineminus">-int32_t nsEudoraAddress::CountQuote(const char *pLine, int32_t len)</span>
<a href="#l20.346"></a><span id="l20.346" class="difflineminus">-{</span>
<a href="#l20.347"></a><span id="l20.347" class="difflineminus">-  if (!len)</span>
<a href="#l20.348"></a><span id="l20.348" class="difflineminus">-    return 0;</span>
<a href="#l20.349"></a><span id="l20.349" class="difflineminus">-</span>
<a href="#l20.350"></a><span id="l20.350" class="difflineminus">-  int32_t cnt = 1;</span>
<a href="#l20.351"></a><span id="l20.351" class="difflineminus">-  pLine++;</span>
<a href="#l20.352"></a><span id="l20.352" class="difflineminus">-  len--;</span>
<a href="#l20.353"></a><span id="l20.353" class="difflineminus">-</span>
<a href="#l20.354"></a><span id="l20.354" class="difflineminus">-  while (len &amp;&amp; (*pLine != '&quot;')) {</span>
<a href="#l20.355"></a><span id="l20.355" class="difflineminus">-    cnt++;</span>
<a href="#l20.356"></a><span id="l20.356" class="difflineminus">-    len--;</span>
<a href="#l20.357"></a><span id="l20.357" class="difflineminus">-    pLine++;</span>
<a href="#l20.358"></a><span id="l20.358" class="difflineminus">-  }</span>
<a href="#l20.359"></a><span id="l20.359" class="difflineminus">-</span>
<a href="#l20.360"></a><span id="l20.360" class="difflineminus">-  if (len)</span>
<a href="#l20.361"></a><span id="l20.361" class="difflineminus">-    cnt++;</span>
<a href="#l20.362"></a><span id="l20.362" class="difflineminus">-  return cnt;</span>
<a href="#l20.363"></a><span id="l20.363" class="difflineminus">-}</span>
<a href="#l20.364"></a><span id="l20.364" class="difflineminus">-</span>
<a href="#l20.365"></a><span id="l20.365" class="difflineminus">-</span>
<a href="#l20.366"></a><span id="l20.366" class="difflineminus">-int32_t nsEudoraAddress::CountAngle(const char *pLine, int32_t len)</span>
<a href="#l20.367"></a><span id="l20.367" class="difflineminus">-{</span>
<a href="#l20.368"></a><span id="l20.368" class="difflineminus">-  if (!len)</span>
<a href="#l20.369"></a><span id="l20.369" class="difflineminus">-    return 0;</span>
<a href="#l20.370"></a><span id="l20.370" class="difflineminus">-</span>
<a href="#l20.371"></a><span id="l20.371" class="difflineminus">-  int32_t cnt = 1;</span>
<a href="#l20.372"></a><span id="l20.372" class="difflineminus">-  pLine++;</span>
<a href="#l20.373"></a><span id="l20.373" class="difflineminus">-  len--;</span>
<a href="#l20.374"></a><span id="l20.374" class="difflineminus">-</span>
<a href="#l20.375"></a><span id="l20.375" class="difflineminus">-  while (len &amp;&amp; (*pLine != '&gt;')) {</span>
<a href="#l20.376"></a><span id="l20.376" class="difflineminus">-    cnt++;</span>
<a href="#l20.377"></a><span id="l20.377" class="difflineminus">-    len--;</span>
<a href="#l20.378"></a><span id="l20.378" class="difflineminus">-    pLine++;</span>
<a href="#l20.379"></a><span id="l20.379" class="difflineminus">-  }</span>
<a href="#l20.380"></a><span id="l20.380" class="difflineminus">-</span>
<a href="#l20.381"></a><span id="l20.381" class="difflineminus">-  if (len)</span>
<a href="#l20.382"></a><span id="l20.382" class="difflineminus">-    cnt++;</span>
<a href="#l20.383"></a><span id="l20.383" class="difflineminus">-  return cnt;</span>
<a href="#l20.384"></a><span id="l20.384" class="difflineminus">-}</span>
<a href="#l20.385"></a><span id="l20.385" class="difflineminus">-</span>
<a href="#l20.386"></a><span id="l20.386" class="difflineminus">-int32_t nsEudoraAddress::CountComment(const char *pLine, int32_t len)</span>
<a href="#l20.387"></a><span id="l20.387" class="difflineminus">-{</span>
<a href="#l20.388"></a><span id="l20.388" class="difflineminus">-  if (!len)</span>
<a href="#l20.389"></a><span id="l20.389" class="difflineminus">-    return 0;</span>
<a href="#l20.390"></a><span id="l20.390" class="difflineminus">-</span>
<a href="#l20.391"></a><span id="l20.391" class="difflineminus">-  int32_t  cCnt;</span>
<a href="#l20.392"></a><span id="l20.392" class="difflineminus">-  int32_t cnt = 1;</span>
<a href="#l20.393"></a><span id="l20.393" class="difflineminus">-  pLine++;</span>
<a href="#l20.394"></a><span id="l20.394" class="difflineminus">-  len--;</span>
<a href="#l20.395"></a><span id="l20.395" class="difflineminus">-</span>
<a href="#l20.396"></a><span id="l20.396" class="difflineminus">-  while (len &amp;&amp; (*pLine != ')')) {</span>
<a href="#l20.397"></a><span id="l20.397" class="difflineminus">-    if (*pLine == '(') {</span>
<a href="#l20.398"></a><span id="l20.398" class="difflineminus">-      cCnt = CountComment(pLine, len);</span>
<a href="#l20.399"></a><span id="l20.399" class="difflineminus">-      cnt += cCnt;</span>
<a href="#l20.400"></a><span id="l20.400" class="difflineminus">-      pLine += cCnt;</span>
<a href="#l20.401"></a><span id="l20.401" class="difflineminus">-      len -= cCnt;</span>
<a href="#l20.402"></a><span id="l20.402" class="difflineminus">-    }</span>
<a href="#l20.403"></a><span id="l20.403" class="difflineminus">-    else {</span>
<a href="#l20.404"></a><span id="l20.404" class="difflineminus">-      cnt++;</span>
<a href="#l20.405"></a><span id="l20.405" class="difflineminus">-      len--;</span>
<a href="#l20.406"></a><span id="l20.406" class="difflineminus">-      pLine++;</span>
<a href="#l20.407"></a><span id="l20.407" class="difflineminus">-    }</span>
<a href="#l20.408"></a><span id="l20.408" class="difflineminus">-  }</span>
<a href="#l20.409"></a><span id="l20.409" class="difflineminus">-</span>
<a href="#l20.410"></a><span id="l20.410" class="difflineminus">-  if (len)</span>
<a href="#l20.411"></a><span id="l20.411" class="difflineminus">-    cnt++;</span>
<a href="#l20.412"></a><span id="l20.412" class="difflineminus">-  return cnt;</span>
<a href="#l20.413"></a><span id="l20.413" class="difflineminus">-}</span>
<a href="#l20.414"></a><span id="l20.414" class="difflineminus">-</span>
<a href="#l20.415"></a><span id="l20.415" class="difflineminus">-/*</span>
<a href="#l20.416"></a><span id="l20.416" class="difflineminus">-  nsCString  m_nickName;</span>
<a href="#l20.417"></a><span id="l20.417" class="difflineminus">-  nsCString  m_realName;</span>
<a href="#l20.418"></a><span id="l20.418" class="difflineminus">-  nsCString  m_email;</span>
<a href="#l20.419"></a><span id="l20.419" class="difflineminus">-*/</span>
<a href="#l20.420"></a><span id="l20.420" class="difflineminus">-</span>
<a href="#l20.421"></a><span id="l20.421" class="difflineminus">-bool CAliasData::Process(const char *pLine, int32_t len)</span>
<a href="#l20.422"></a><span id="l20.422" class="difflineminus">-{</span>
<a href="#l20.423"></a><span id="l20.423" class="difflineminus">-  // Extract any comments first!</span>
<a href="#l20.424"></a><span id="l20.424" class="difflineminus">-  nsCString  str;</span>
<a href="#l20.425"></a><span id="l20.425" class="difflineminus">-</span>
<a href="#l20.426"></a><span id="l20.426" class="difflineminus">-  const char *pStart = pLine;</span>
<a href="#l20.427"></a><span id="l20.427" class="difflineminus">-  int32_t    tCnt = 0;</span>
<a href="#l20.428"></a><span id="l20.428" class="difflineminus">-  int32_t    cnt = 0;</span>
<a href="#l20.429"></a><span id="l20.429" class="difflineminus">-  int32_t    max = len;</span>
<a href="#l20.430"></a><span id="l20.430" class="difflineminus">-  bool      endCollect = false;</span>
<a href="#l20.431"></a><span id="l20.431" class="difflineminus">-</span>
<a href="#l20.432"></a><span id="l20.432" class="difflineminus">-    // Keep track of the full entry without any processing for potential alias</span>
<a href="#l20.433"></a><span id="l20.433" class="difflineminus">-    // nickname resolution. Previously alias resolution was done with m_email,</span>
<a href="#l20.434"></a><span id="l20.434" class="difflineminus">-    // but unfortunately that doesn't work for nicknames with spaces.</span>
<a href="#l20.435"></a><span id="l20.435" class="difflineminus">-    // For example for the nickname &quot;Joe Smith&quot;, &quot;Smith&quot; was being interpreted</span>
<a href="#l20.436"></a><span id="l20.436" class="difflineminus">-    // as the potential email address and placed in m_email, but routines like</span>
<a href="#l20.437"></a><span id="l20.437" class="difflineminus">-    // ResolveAlias were failing because &quot;Smith&quot; is not the full nickname.</span>
<a href="#l20.438"></a><span id="l20.438" class="difflineminus">-    // Now we just stash the full entry for nickname resolution before processing</span>
<a href="#l20.439"></a><span id="l20.439" class="difflineminus">-    // the line as a potential entry in its own right.</span>
<a href="#l20.440"></a><span id="l20.440" class="difflineminus">-    m_fullEntry.Append(pLine, len);</span>
<a href="#l20.441"></a><span id="l20.441" class="difflineminus">-</span>
<a href="#l20.442"></a><span id="l20.442" class="difflineminus">-  while (max) {</span>
<a href="#l20.443"></a><span id="l20.443" class="difflineminus">-    if (*pLine == '&quot;') {</span>
<a href="#l20.444"></a><span id="l20.444" class="difflineminus">-      if (tCnt &amp;&amp; !endCollect) {</span>
<a href="#l20.445"></a><span id="l20.445" class="difflineminus">-        str.Trim(kWhitespace);</span>
<a href="#l20.446"></a><span id="l20.446" class="difflineminus">-        if (!str.IsEmpty())</span>
<a href="#l20.447"></a><span id="l20.447" class="difflineminus">-          str.Append(&quot; &quot;, 1);</span>
<a href="#l20.448"></a><span id="l20.448" class="difflineminus">-        str.Append(pStart, tCnt);</span>
<a href="#l20.449"></a><span id="l20.449" class="difflineminus">-      }</span>
<a href="#l20.450"></a><span id="l20.450" class="difflineminus">-      cnt = nsEudoraAddress::CountQuote(pLine, max);</span>
<a href="#l20.451"></a><span id="l20.451" class="difflineminus">-      if ((cnt &gt; 2) &amp;&amp; m_realName.IsEmpty()) {</span>
<a href="#l20.452"></a><span id="l20.452" class="difflineminus">-        m_realName.Append(pLine + 1, cnt - 2);</span>
<a href="#l20.453"></a><span id="l20.453" class="difflineminus">-      }</span>
<a href="#l20.454"></a><span id="l20.454" class="difflineminus">-      pLine += cnt;</span>
<a href="#l20.455"></a><span id="l20.455" class="difflineminus">-      max -= cnt;</span>
<a href="#l20.456"></a><span id="l20.456" class="difflineminus">-      pStart = pLine;</span>
<a href="#l20.457"></a><span id="l20.457" class="difflineminus">-      tCnt = 0;</span>
<a href="#l20.458"></a><span id="l20.458" class="difflineminus">-    }</span>
<a href="#l20.459"></a><span id="l20.459" class="difflineminus">-    else if (*pLine == '&lt;') {</span>
<a href="#l20.460"></a><span id="l20.460" class="difflineminus">-      if (tCnt &amp;&amp; !endCollect) {</span>
<a href="#l20.461"></a><span id="l20.461" class="difflineminus">-        str.Trim(kWhitespace);</span>
<a href="#l20.462"></a><span id="l20.462" class="difflineminus">-        if (!str.IsEmpty())</span>
<a href="#l20.463"></a><span id="l20.463" class="difflineminus">-          str.Append(&quot; &quot;, 1);</span>
<a href="#l20.464"></a><span id="l20.464" class="difflineminus">-        str.Append(pStart, tCnt);</span>
<a href="#l20.465"></a><span id="l20.465" class="difflineminus">-      }</span>
<a href="#l20.466"></a><span id="l20.466" class="difflineminus">-      cnt = nsEudoraAddress::CountAngle(pLine, max);</span>
<a href="#l20.467"></a><span id="l20.467" class="difflineminus">-      if ((cnt &gt; 2) &amp;&amp; m_email.IsEmpty()) {</span>
<a href="#l20.468"></a><span id="l20.468" class="difflineminus">-        m_email.Append(pLine + 1, cnt - 2);</span>
<a href="#l20.469"></a><span id="l20.469" class="difflineminus">-      }</span>
<a href="#l20.470"></a><span id="l20.470" class="difflineminus">-      pLine += cnt;</span>
<a href="#l20.471"></a><span id="l20.471" class="difflineminus">-      max -= cnt;</span>
<a href="#l20.472"></a><span id="l20.472" class="difflineminus">-      pStart = pLine;</span>
<a href="#l20.473"></a><span id="l20.473" class="difflineminus">-      tCnt = 0;</span>
<a href="#l20.474"></a><span id="l20.474" class="difflineminus">-      endCollect = true;</span>
<a href="#l20.475"></a><span id="l20.475" class="difflineminus">-    }</span>
<a href="#l20.476"></a><span id="l20.476" class="difflineminus">-    else if (*pLine == '(') {</span>
<a href="#l20.477"></a><span id="l20.477" class="difflineminus">-      if (tCnt &amp;&amp; !endCollect) {</span>
<a href="#l20.478"></a><span id="l20.478" class="difflineminus">-        str.Trim(kWhitespace);</span>
<a href="#l20.479"></a><span id="l20.479" class="difflineminus">-        if (!str.IsEmpty())</span>
<a href="#l20.480"></a><span id="l20.480" class="difflineminus">-          str.Append(&quot; &quot;, 1);</span>
<a href="#l20.481"></a><span id="l20.481" class="difflineminus">-        str.Append(pStart, tCnt);</span>
<a href="#l20.482"></a><span id="l20.482" class="difflineminus">-      }</span>
<a href="#l20.483"></a><span id="l20.483" class="difflineminus">-      cnt = nsEudoraAddress::CountComment(pLine, max);</span>
<a href="#l20.484"></a><span id="l20.484" class="difflineminus">-      if (cnt &gt; 2) {</span>
<a href="#l20.485"></a><span id="l20.485" class="difflineminus">-        if (!m_realName.IsEmpty() &amp;&amp; m_nickName.IsEmpty())</span>
<a href="#l20.486"></a><span id="l20.486" class="difflineminus">-          m_nickName = m_realName;</span>
<a href="#l20.487"></a><span id="l20.487" class="difflineminus">-        m_realName.Truncate();</span>
<a href="#l20.488"></a><span id="l20.488" class="difflineminus">-        m_realName.Append(pLine + 1, cnt - 2);</span>
<a href="#l20.489"></a><span id="l20.489" class="difflineminus">-      }</span>
<a href="#l20.490"></a><span id="l20.490" class="difflineminus">-      pLine += cnt;</span>
<a href="#l20.491"></a><span id="l20.491" class="difflineminus">-      max -= cnt;</span>
<a href="#l20.492"></a><span id="l20.492" class="difflineminus">-      pStart = pLine;</span>
<a href="#l20.493"></a><span id="l20.493" class="difflineminus">-      tCnt = 0;</span>
<a href="#l20.494"></a><span id="l20.494" class="difflineminus">-    }</span>
<a href="#l20.495"></a><span id="l20.495" class="difflineminus">-    else {</span>
<a href="#l20.496"></a><span id="l20.496" class="difflineminus">-      tCnt++;</span>
<a href="#l20.497"></a><span id="l20.497" class="difflineminus">-      pLine++;</span>
<a href="#l20.498"></a><span id="l20.498" class="difflineminus">-      max--;</span>
<a href="#l20.499"></a><span id="l20.499" class="difflineminus">-    }</span>
<a href="#l20.500"></a><span id="l20.500" class="difflineminus">-  }</span>
<a href="#l20.501"></a><span id="l20.501" class="difflineminus">-</span>
<a href="#l20.502"></a><span id="l20.502" class="difflineminus">-  if (tCnt) {</span>
<a href="#l20.503"></a><span id="l20.503" class="difflineminus">-    str.Trim(kWhitespace);</span>
<a href="#l20.504"></a><span id="l20.504" class="difflineminus">-    if (!str.IsEmpty())</span>
<a href="#l20.505"></a><span id="l20.505" class="difflineminus">-      str.Append(&quot; &quot;, 1);</span>
<a href="#l20.506"></a><span id="l20.506" class="difflineminus">-    str.Append(pStart, tCnt);</span>
<a href="#l20.507"></a><span id="l20.507" class="difflineminus">-  }</span>
<a href="#l20.508"></a><span id="l20.508" class="difflineminus">-</span>
<a href="#l20.509"></a><span id="l20.509" class="difflineminus">-  str.Trim(kWhitespace);</span>
<a href="#l20.510"></a><span id="l20.510" class="difflineminus">-</span>
<a href="#l20.511"></a><span id="l20.511" class="difflineminus">-  if (!m_realName.IsEmpty() &amp;&amp; !m_email.IsEmpty())</span>
<a href="#l20.512"></a><span id="l20.512" class="difflineminus">-    return true;</span>
<a href="#l20.513"></a><span id="l20.513" class="difflineminus">-</span>
<a href="#l20.514"></a><span id="l20.514" class="difflineminus">-  // now we should have a string with any remaining non-delimitted text</span>
<a href="#l20.515"></a><span id="l20.515" class="difflineminus">-  // we assume that the last token is the email</span>
<a href="#l20.516"></a><span id="l20.516" class="difflineminus">-  // anything before that is realName</span>
<a href="#l20.517"></a><span id="l20.517" class="difflineminus">-  if (!m_email.IsEmpty()) {</span>
<a href="#l20.518"></a><span id="l20.518" class="difflineminus">-    m_realName = str;</span>
<a href="#l20.519"></a><span id="l20.519" class="difflineminus">-    return true;</span>
<a href="#l20.520"></a><span id="l20.520" class="difflineminus">-  }</span>
<a href="#l20.521"></a><span id="l20.521" class="difflineminus">-</span>
<a href="#l20.522"></a><span id="l20.522" class="difflineminus">-  tCnt = str.RFindChar(' ');</span>
<a href="#l20.523"></a><span id="l20.523" class="difflineminus">-  if (tCnt == -1) {</span>
<a href="#l20.524"></a><span id="l20.524" class="difflineminus">-    if (!str.IsEmpty()) {</span>
<a href="#l20.525"></a><span id="l20.525" class="difflineminus">-      m_email = str;</span>
<a href="#l20.526"></a><span id="l20.526" class="difflineminus">-      return true;</span>
<a href="#l20.527"></a><span id="l20.527" class="difflineminus">-    }</span>
<a href="#l20.528"></a><span id="l20.528" class="difflineminus">-    return false;</span>
<a href="#l20.529"></a><span id="l20.529" class="difflineminus">-  }</span>
<a href="#l20.530"></a><span id="l20.530" class="difflineminus">-</span>
<a href="#l20.531"></a><span id="l20.531" class="difflineminus">-  m_email = Substring(str, tCnt + 1);</span>
<a href="#l20.532"></a><span id="l20.532" class="difflineminus">-  m_realName = StringHead(str, tCnt);</span>
<a href="#l20.533"></a><span id="l20.533" class="difflineminus">-  m_realName.Trim(kWhitespace);</span>
<a href="#l20.534"></a><span id="l20.534" class="difflineminus">-  m_email.Trim(kWhitespace);</span>
<a href="#l20.535"></a><span id="l20.535" class="difflineminus">-</span>
<a href="#l20.536"></a><span id="l20.536" class="difflineminus">-  return !m_email.IsEmpty();</span>
<a href="#l20.537"></a><span id="l20.537" class="difflineminus">-}</span>
<a href="#l20.538"></a><span id="l20.538" class="difflineminus">-</span>
<a href="#l20.539"></a><span id="l20.539" class="difflineminus">-#ifdef IMPORT_DEBUG</span>
<a href="#l20.540"></a><span id="l20.540" class="difflineminus">-void DumpAliasArray(nsTArray&lt;CAliasEntry*&gt;&amp; a)</span>
<a href="#l20.541"></a><span id="l20.541" class="difflineminus">-{</span>
<a href="#l20.542"></a><span id="l20.542" class="difflineminus">-  CAliasEntry *pEntry;</span>
<a href="#l20.543"></a><span id="l20.543" class="difflineminus">-  CAliasData *pData;</span>
<a href="#l20.544"></a><span id="l20.544" class="difflineminus">-</span>
<a href="#l20.545"></a><span id="l20.545" class="difflineminus">-  int32_t cnt = a.Length();</span>
<a href="#l20.546"></a><span id="l20.546" class="difflineminus">-  IMPORT_LOG1(&quot;Alias list size: %ld\n&quot;, cnt);</span>
<a href="#l20.547"></a><span id="l20.547" class="difflineminus">-  for (int32_t i = 0; i &lt; cnt; i++) {</span>
<a href="#l20.548"></a><span id="l20.548" class="difflineminus">-    pEntry = a.ElementAt(i);</span>
<a href="#l20.549"></a><span id="l20.549" class="difflineminus">-    IMPORT_LOG1(&quot;\tAlias: %s\n&quot;, pEntry-&gt;m_name.get());</span>
<a href="#l20.550"></a><span id="l20.550" class="difflineminus">-    if (pEntry-&gt;m_list.Length() &gt; 1) {</span>
<a href="#l20.551"></a><span id="l20.551" class="difflineminus">-      IMPORT_LOG1(&quot;\tList count #%ld\n&quot;, pEntry-&gt;m_list.Length());</span>
<a href="#l20.552"></a><span id="l20.552" class="difflineminus">-      for (int32_t j = 0; j &lt; pEntry-&gt;m_list.Length(); j++) {</span>
<a href="#l20.553"></a><span id="l20.553" class="difflineminus">-        pData = pEntry-&gt;m_list.ElementAt(j);</span>
<a href="#l20.554"></a><span id="l20.554" class="difflineminus">-        IMPORT_LOG0(&quot;\t\t--------\n&quot;);</span>
<a href="#l20.555"></a><span id="l20.555" class="difflineminus">-        IMPORT_LOG1(&quot;\t\temail: %s\n&quot;, pData-&gt;m_email.get());</span>
<a href="#l20.556"></a><span id="l20.556" class="difflineminus">-        IMPORT_LOG1(&quot;\t\trealName: %s\n&quot;, pData-&gt;m_realName.get());</span>
<a href="#l20.557"></a><span id="l20.557" class="difflineminus">-        IMPORT_LOG1(&quot;\t\tnickName: %s\n&quot;, pData-&gt;m_nickName.get());</span>
<a href="#l20.558"></a><span id="l20.558" class="difflineminus">-      }</span>
<a href="#l20.559"></a><span id="l20.559" class="difflineminus">-    }</span>
<a href="#l20.560"></a><span id="l20.560" class="difflineminus">-    else if (pEntry-&gt;m_list.Length()) {</span>
<a href="#l20.561"></a><span id="l20.561" class="difflineminus">-      pData = pEntry-&gt;m_list.ElementAt(0);</span>
<a href="#l20.562"></a><span id="l20.562" class="difflineminus">-      IMPORT_LOG1(&quot;\t\temail: %s\n&quot;, pData-&gt;m_email.get());</span>
<a href="#l20.563"></a><span id="l20.563" class="difflineminus">-      IMPORT_LOG1(&quot;\t\trealName: %s\n&quot;, pData-&gt;m_realName.get());</span>
<a href="#l20.564"></a><span id="l20.564" class="difflineminus">-      IMPORT_LOG1(&quot;\t\tnickName: %s\n&quot;, pData-&gt;m_nickName.get());</span>
<a href="#l20.565"></a><span id="l20.565" class="difflineminus">-    }</span>
<a href="#l20.566"></a><span id="l20.566" class="difflineminus">-  }</span>
<a href="#l20.567"></a><span id="l20.567" class="difflineminus">-}</span>
<a href="#l20.568"></a><span id="l20.568" class="difflineminus">-#endif</span>
<a href="#l20.569"></a><span id="l20.569" class="difflineminus">-</span>
<a href="#l20.570"></a><span id="l20.570" class="difflineminus">-CAliasEntry *nsEudoraAddress::ResolveAlias(nsCString&amp; name)</span>
<a href="#l20.571"></a><span id="l20.571" class="difflineminus">-{</span>
<a href="#l20.572"></a><span id="l20.572" class="difflineminus">-  int32_t  max = m_alias.Length();</span>
<a href="#l20.573"></a><span id="l20.573" class="difflineminus">-  CAliasEntry *pEntry;</span>
<a href="#l20.574"></a><span id="l20.574" class="difflineminus">-  for (int32_t i = 0; i &lt; max; i++) {</span>
<a href="#l20.575"></a><span id="l20.575" class="difflineminus">-    pEntry = m_alias.ElementAt(i);</span>
<a href="#l20.576"></a><span id="l20.576" class="difflineminus">-    if (name.Equals(pEntry-&gt;m_name, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l20.577"></a><span id="l20.577" class="difflineminus">-      return pEntry;</span>
<a href="#l20.578"></a><span id="l20.578" class="difflineminus">-  }</span>
<a href="#l20.579"></a><span id="l20.579" class="difflineminus">-</span>
<a href="#l20.580"></a><span id="l20.580" class="difflineminus">-  return nullptr;</span>
<a href="#l20.581"></a><span id="l20.581" class="difflineminus">-}</span>
<a href="#l20.582"></a><span id="l20.582" class="difflineminus">-</span>
<a href="#l20.583"></a><span id="l20.583" class="difflineminus">-void nsEudoraAddress::ResolveEntries(nsCString&amp; name, nsTArray&lt;CAliasData*&gt;&amp; list,</span>
<a href="#l20.584"></a><span id="l20.584" class="difflineminus">-                                     nsTArray&lt;CAliasData*&gt;&amp; result, bool addResolvedEntries,</span>
<a href="#l20.585"></a><span id="l20.585" class="difflineminus">-                                     bool wasResolved, int32_t&amp; numResolved)</span>
<a href="#l20.586"></a><span id="l20.586" class="difflineminus">-{</span>
<a href="#l20.587"></a><span id="l20.587" class="difflineminus">-    /* a safe-guard against recursive entries */</span>
<a href="#l20.588"></a><span id="l20.588" class="difflineminus">-    if (result.Length() &gt; m_alias.Length())</span>
<a href="#l20.589"></a><span id="l20.589" class="difflineminus">-        return;</span>
<a href="#l20.590"></a><span id="l20.590" class="difflineminus">-</span>
<a href="#l20.591"></a><span id="l20.591" class="difflineminus">-    int32_t         max = list.Length();</span>
<a href="#l20.592"></a><span id="l20.592" class="difflineminus">-    int32_t         i;</span>
<a href="#l20.593"></a><span id="l20.593" class="difflineminus">-    CAliasData *    pData;</span>
<a href="#l20.594"></a><span id="l20.594" class="difflineminus">-    CAliasEntry *   pEntry;</span>
<a href="#l20.595"></a><span id="l20.595" class="difflineminus">-    for (i = 0; i &lt; max; i++) {</span>
<a href="#l20.596"></a><span id="l20.596" class="difflineminus">-        pData = list.ElementAt(i);</span>
<a href="#l20.597"></a><span id="l20.597" class="difflineminus">-        // resolve the email to an existing alias!</span>
<a href="#l20.598"></a><span id="l20.598" class="difflineminus">-        if (!name.Equals(pData-&gt;m_email, nsCaseInsensitiveCStringComparator()) &amp;&amp;</span>
<a href="#l20.599"></a><span id="l20.599" class="difflineminus">-             ((pEntry = ResolveAlias(pData-&gt;m_fullEntry)) != nullptr)) {</span>
<a href="#l20.600"></a><span id="l20.600" class="difflineminus">-            // This new entry has all of the entries for this puppie.</span>
<a href="#l20.601"></a><span id="l20.601" class="difflineminus">-            // Resolve all of it's entries!</span>
<a href="#l20.602"></a><span id="l20.602" class="difflineminus">-            numResolved++;  // Track the number of entries resolved</span>
<a href="#l20.603"></a><span id="l20.603" class="difflineminus">-</span>
<a href="#l20.604"></a><span id="l20.604" class="difflineminus">-            // We pass in true for the 5th parameter so that we know that we're</span>
<a href="#l20.605"></a><span id="l20.605" class="difflineminus">-            // calling ourselves recursively.</span>
<a href="#l20.606"></a><span id="l20.606" class="difflineminus">-            ResolveEntries(pEntry-&gt;m_name,</span>
<a href="#l20.607"></a><span id="l20.607" class="difflineminus">-                           pEntry-&gt;m_list,</span>
<a href="#l20.608"></a><span id="l20.608" class="difflineminus">-                           result,</span>
<a href="#l20.609"></a><span id="l20.609" class="difflineminus">-                           addResolvedEntries,</span>
<a href="#l20.610"></a><span id="l20.610" class="difflineminus">-                           true,</span>
<a href="#l20.611"></a><span id="l20.611" class="difflineminus">-                           numResolved);</span>
<a href="#l20.612"></a><span id="l20.612" class="difflineminus">-        }</span>
<a href="#l20.613"></a><span id="l20.613" class="difflineminus">-        else if (addResolvedEntries || !wasResolved) {</span>
<a href="#l20.614"></a><span id="l20.614" class="difflineminus">-            // This is either an ordinary entry (i.e. just contains the info) or we were told</span>
<a href="#l20.615"></a><span id="l20.615" class="difflineminus">-            // to add resolved alias entries.</span>
<a href="#l20.616"></a><span id="l20.616" class="difflineminus">-            result.AppendElement(pData);</span>
<a href="#l20.617"></a><span id="l20.617" class="difflineminus">-        }</span>
<a href="#l20.618"></a><span id="l20.618" class="difflineminus">-    }</span>
<a href="#l20.619"></a><span id="l20.619" class="difflineminus">-}</span>
<a href="#l20.620"></a><span id="l20.620" class="difflineminus">-</span>
<a href="#l20.621"></a><span id="l20.621" class="difflineminus">-int32_t nsEudoraAddress::FindAlias(nsCString&amp; name)</span>
<a href="#l20.622"></a><span id="l20.622" class="difflineminus">-{</span>
<a href="#l20.623"></a><span id="l20.623" class="difflineminus">-  CAliasEntry *  pEntry;</span>
<a href="#l20.624"></a><span id="l20.624" class="difflineminus">-  int32_t      max = m_alias.Length();</span>
<a href="#l20.625"></a><span id="l20.625" class="difflineminus">-  int32_t      i;</span>
<a href="#l20.626"></a><span id="l20.626" class="difflineminus">-</span>
<a href="#l20.627"></a><span id="l20.627" class="difflineminus">-  for (i = 0; i &lt; max; i++) {</span>
<a href="#l20.628"></a><span id="l20.628" class="difflineminus">-    pEntry = m_alias.ElementAt(i);</span>
<a href="#l20.629"></a><span id="l20.629" class="difflineminus">-    if (pEntry-&gt;m_name == name)</span>
<a href="#l20.630"></a><span id="l20.630" class="difflineminus">-      return i;</span>
<a href="#l20.631"></a><span id="l20.631" class="difflineminus">-  }</span>
<a href="#l20.632"></a><span id="l20.632" class="difflineminus">-</span>
<a href="#l20.633"></a><span id="l20.633" class="difflineminus">-  return -1;</span>
<a href="#l20.634"></a><span id="l20.634" class="difflineminus">-}</span>
<a href="#l20.635"></a><span id="l20.635" class="difflineminus">-</span>
<a href="#l20.636"></a><span id="l20.636" class="difflineminus">-void nsEudoraAddress::BuildABCards(uint32_t *pBytes, nsIAddrDatabase *pDb)</span>
<a href="#l20.637"></a><span id="l20.637" class="difflineminus">-{</span>
<a href="#l20.638"></a><span id="l20.638" class="difflineminus">-  CAliasEntry *  pEntry;</span>
<a href="#l20.639"></a><span id="l20.639" class="difflineminus">-  int32_t      max = m_alias.Length();</span>
<a href="#l20.640"></a><span id="l20.640" class="difflineminus">-  int32_t      i;</span>
<a href="#l20.641"></a><span id="l20.641" class="difflineminus">-  nsTArray&lt;CAliasData*&gt;    emailList;</span>
<a href="#l20.642"></a><span id="l20.642" class="difflineminus">-  nsTArray&lt;CAliasData*&gt; membersArray; // Remember group members.</span>
<a href="#l20.643"></a><span id="l20.643" class="difflineminus">-  nsTArray&lt;CAliasEntry*&gt; groupsArray; // Remember groups.</span>
<a href="#l20.644"></a><span id="l20.644" class="difflineminus">-</span>
<a href="#l20.645"></a><span id="l20.645" class="difflineminus">-  // First off, run through the list and build person cards - groups/lists have to be done later</span>
<a href="#l20.646"></a><span id="l20.646" class="difflineminus">-  for (i = 0; i &lt; max; i++) {</span>
<a href="#l20.647"></a><span id="l20.647" class="difflineminus">-    int32_t   numResolved = 0;</span>
<a href="#l20.648"></a><span id="l20.648" class="difflineminus">-    pEntry = m_alias.ElementAt(i);</span>
<a href="#l20.649"></a><span id="l20.649" class="difflineminus">-</span>
<a href="#l20.650"></a><span id="l20.650" class="difflineminus">-    // false for 4th parameter tells ResolveEntries not to add resolved entries (avoids</span>
<a href="#l20.651"></a><span id="l20.651" class="difflineminus">-    // duplicates as mailing lists are being resolved to other cards - the other cards that</span>
<a href="#l20.652"></a><span id="l20.652" class="difflineminus">-    // are found have already been added and don't need to be added again).</span>
<a href="#l20.653"></a><span id="l20.653" class="difflineminus">-    //</span>
<a href="#l20.654"></a><span id="l20.654" class="difflineminus">-    // false for 5th parameter tells ResolveEntries that we're calling it - it's not being</span>
<a href="#l20.655"></a><span id="l20.655" class="difflineminus">-    // called recursively by itself.</span>
<a href="#l20.656"></a><span id="l20.656" class="difflineminus">-    ResolveEntries(pEntry-&gt;m_name, pEntry-&gt;m_list, emailList, false, false, numResolved);</span>
<a href="#l20.657"></a><span id="l20.657" class="difflineminus">-</span>
<a href="#l20.658"></a><span id="l20.658" class="difflineminus">-    // Treat it as a group if there's more than one email address or if we</span>
<a href="#l20.659"></a><span id="l20.659" class="difflineminus">-    // needed to resolve one or more aliases. We treat single aliases to</span>
<a href="#l20.660"></a><span id="l20.660" class="difflineminus">-    // other aliases as a mailing list because there's no better equivalent.</span>
<a href="#l20.661"></a><span id="l20.661" class="difflineminus">-    if ((emailList.Length() &gt; 1) || (numResolved &gt; 0))</span>
<a href="#l20.662"></a><span id="l20.662" class="difflineminus">-    {</span>
<a href="#l20.663"></a><span id="l20.663" class="difflineminus">-      // Remember group members uniquely and add them to db later.</span>
<a href="#l20.664"></a><span id="l20.664" class="difflineminus">-      RememberGroupMembers(membersArray, emailList);</span>
<a href="#l20.665"></a><span id="l20.665" class="difflineminus">-      // Remember groups and add them to db later.</span>
<a href="#l20.666"></a><span id="l20.666" class="difflineminus">-      groupsArray.AppendElement(pEntry);</span>
<a href="#l20.667"></a><span id="l20.667" class="difflineminus">-    }</span>
<a href="#l20.668"></a><span id="l20.668" class="difflineminus">-    else</span>
<a href="#l20.669"></a><span id="l20.669" class="difflineminus">-      AddSingleCard(pEntry, emailList, pDb);</span>
<a href="#l20.670"></a><span id="l20.670" class="difflineminus">-</span>
<a href="#l20.671"></a><span id="l20.671" class="difflineminus">-    emailList.Clear();</span>
<a href="#l20.672"></a><span id="l20.672" class="difflineminus">-</span>
<a href="#l20.673"></a><span id="l20.673" class="difflineminus">-    if (pBytes) {</span>
<a href="#l20.674"></a><span id="l20.674" class="difflineminus">-      // This isn't exact but it will get us close enough</span>
<a href="#l20.675"></a><span id="l20.675" class="difflineminus">-      *pBytes += (pEntry-&gt;m_name.Length() + pEntry-&gt;m_notes.Length() + 10);</span>
<a href="#l20.676"></a><span id="l20.676" class="difflineminus">-    }</span>
<a href="#l20.677"></a><span id="l20.677" class="difflineminus">-  }</span>
<a href="#l20.678"></a><span id="l20.678" class="difflineminus">-</span>
<a href="#l20.679"></a><span id="l20.679" class="difflineminus">-  // Make sure group members exists before adding groups.</span>
<a href="#l20.680"></a><span id="l20.680" class="difflineminus">-  nsresult rv = AddGroupMembersAsCards(membersArray, pDb);</span>
<a href="#l20.681"></a><span id="l20.681" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l20.682"></a><span id="l20.682" class="difflineminus">-    return;</span>
<a href="#l20.683"></a><span id="l20.683" class="difflineminus">-</span>
<a href="#l20.684"></a><span id="l20.684" class="difflineminus">-  // Now add the lists/groups (now that all cards have been added).</span>
<a href="#l20.685"></a><span id="l20.685" class="difflineminus">-  max = groupsArray.Length();</span>
<a href="#l20.686"></a><span id="l20.686" class="difflineminus">-  for (i = 0; i &lt; max; i++)</span>
<a href="#l20.687"></a><span id="l20.687" class="difflineminus">-  {</span>
<a href="#l20.688"></a><span id="l20.688" class="difflineminus">-    int32_t   numResolved = 0;</span>
<a href="#l20.689"></a><span id="l20.689" class="difflineminus">-    pEntry = groupsArray.ElementAt(i);</span>
<a href="#l20.690"></a><span id="l20.690" class="difflineminus">-</span>
<a href="#l20.691"></a><span id="l20.691" class="difflineminus">-    // false for 4th parameter tells ResolveEntries to add resolved entries so that we</span>
<a href="#l20.692"></a><span id="l20.692" class="difflineminus">-    // can create the mailing list with references to all entries correctly.</span>
<a href="#l20.693"></a><span id="l20.693" class="difflineminus">-    //</span>
<a href="#l20.694"></a><span id="l20.694" class="difflineminus">-    // false for 5th parameter tells ResolveEntries that we're calling it - it's not being</span>
<a href="#l20.695"></a><span id="l20.695" class="difflineminus">-    // called recursively by itself.</span>
<a href="#l20.696"></a><span id="l20.696" class="difflineminus">-    ResolveEntries(pEntry-&gt;m_name, pEntry-&gt;m_list, emailList, true, false, numResolved);</span>
<a href="#l20.697"></a><span id="l20.697" class="difflineminus">-    AddSingleList(pEntry, emailList, pDb);</span>
<a href="#l20.698"></a><span id="l20.698" class="difflineminus">-    emailList.Clear();</span>
<a href="#l20.699"></a><span id="l20.699" class="difflineminus">-  }</span>
<a href="#l20.700"></a><span id="l20.700" class="difflineminus">-}</span>
<a href="#l20.701"></a><span id="l20.701" class="difflineminus">-</span>
<a href="#l20.702"></a><span id="l20.702" class="difflineminus">-void nsEudoraAddress::ExtractNoteField(nsCString&amp; note, nsCString&amp; value, const char *pFieldName)</span>
<a href="#l20.703"></a><span id="l20.703" class="difflineminus">-{</span>
<a href="#l20.704"></a><span id="l20.704" class="difflineminus">-  value.Truncate();</span>
<a href="#l20.705"></a><span id="l20.705" class="difflineminus">-  nsCString field(&quot;&lt;&quot;);</span>
<a href="#l20.706"></a><span id="l20.706" class="difflineminus">-  field.Append(pFieldName);</span>
<a href="#l20.707"></a><span id="l20.707" class="difflineminus">-  field.Append(':');</span>
<a href="#l20.708"></a><span id="l20.708" class="difflineminus">-</span>
<a href="#l20.709"></a><span id="l20.709" class="difflineminus">-/*</span>
<a href="#l20.710"></a><span id="l20.710" class="difflineminus">-    this is a bit of a cheat, but there's no reason it won't work</span>
<a href="#l20.711"></a><span id="l20.711" class="difflineminus">-    fine for us, even better than Eudora in some cases!</span>
<a href="#l20.712"></a><span id="l20.712" class="difflineminus">-*/</span>
<a href="#l20.713"></a><span id="l20.713" class="difflineminus">-</span>
<a href="#l20.714"></a><span id="l20.714" class="difflineminus">-  int32_t idx = note.Find(field);</span>
<a href="#l20.715"></a><span id="l20.715" class="difflineminus">-  if (idx != -1) {</span>
<a href="#l20.716"></a><span id="l20.716" class="difflineminus">-    idx += field.Length();</span>
<a href="#l20.717"></a><span id="l20.717" class="difflineminus">-    int32_t endIdx = note.FindChar('&gt;', idx);</span>
<a href="#l20.718"></a><span id="l20.718" class="difflineminus">-    if (endIdx == -1)</span>
<a href="#l20.719"></a><span id="l20.719" class="difflineminus">-      endIdx = note.Length() - 1;</span>
<a href="#l20.720"></a><span id="l20.720" class="difflineminus">-    value = Substring(note, idx, endIdx - idx);</span>
<a href="#l20.721"></a><span id="l20.721" class="difflineminus">-    idx -= field.Length();</span>
<a href="#l20.722"></a><span id="l20.722" class="difflineminus">-    note.Cut(idx, endIdx + 1);</span>
<a href="#l20.723"></a><span id="l20.723" class="difflineminus">-  }</span>
<a href="#l20.724"></a><span id="l20.724" class="difflineminus">-}</span>
<a href="#l20.725"></a><span id="l20.725" class="difflineminus">-</span>
<a href="#l20.726"></a><span id="l20.726" class="difflineminus">-void nsEudoraAddress::FormatExtraDataInNoteField(int32_t labelStringID, nsCString&amp; extraData, nsString&amp; noteUTF16)</span>
<a href="#l20.727"></a><span id="l20.727" class="difflineminus">-{</span>
<a href="#l20.728"></a><span id="l20.728" class="difflineminus">-  nsAutoString    label;</span>
<a href="#l20.729"></a><span id="l20.729" class="difflineminus">-  nsEudoraStringBundle::GetStringByID(labelStringID, label);</span>
<a href="#l20.730"></a><span id="l20.730" class="difflineminus">-</span>
<a href="#l20.731"></a><span id="l20.731" class="difflineminus">-  noteUTF16.Append(label);</span>
<a href="#l20.732"></a><span id="l20.732" class="difflineminus">-  noteUTF16.AppendLiteral(&quot;\n&quot;);</span>
<a href="#l20.733"></a><span id="l20.733" class="difflineminus">-  noteUTF16.Append(NS_ConvertASCIItoUTF16(extraData));</span>
<a href="#l20.734"></a><span id="l20.734" class="difflineminus">-  noteUTF16.AppendLiteral(&quot;\n\n&quot;);</span>
<a href="#l20.735"></a><span id="l20.735" class="difflineminus">-}</span>
<a href="#l20.736"></a><span id="l20.736" class="difflineminus">-</span>
<a href="#l20.737"></a><span id="l20.737" class="difflineminus">-void nsEudoraAddress::SanitizeValue(nsCString&amp; val)</span>
<a href="#l20.738"></a><span id="l20.738" class="difflineminus">-{</span>
<a href="#l20.739"></a><span id="l20.739" class="difflineminus">-  MsgReplaceSubstring(val, &quot;\n&quot;, &quot;, &quot;);</span>
<a href="#l20.740"></a><span id="l20.740" class="difflineminus">-  MsgReplaceChar(val, '\r', ',');</span>
<a href="#l20.741"></a><span id="l20.741" class="difflineminus">-}</span>
<a href="#l20.742"></a><span id="l20.742" class="difflineminus">-</span>
<a href="#l20.743"></a><span id="l20.743" class="difflineminus">-void nsEudoraAddress::SplitString(nsCString&amp; val1, nsCString&amp; val2)</span>
<a href="#l20.744"></a><span id="l20.744" class="difflineminus">-{</span>
<a href="#l20.745"></a><span id="l20.745" class="difflineminus">-  nsCString  temp;</span>
<a href="#l20.746"></a><span id="l20.746" class="difflineminus">-</span>
<a href="#l20.747"></a><span id="l20.747" class="difflineminus">-  // Find the last line if there is more than one!</span>
<a href="#l20.748"></a><span id="l20.748" class="difflineminus">-  int32_t idx = val1.RFind(&quot;\x0D\x0A&quot;);</span>
<a href="#l20.749"></a><span id="l20.749" class="difflineminus">-  int32_t  cnt = 2;</span>
<a href="#l20.750"></a><span id="l20.750" class="difflineminus">-  if (idx == -1) {</span>
<a href="#l20.751"></a><span id="l20.751" class="difflineminus">-    cnt = 1;</span>
<a href="#l20.752"></a><span id="l20.752" class="difflineminus">-    idx = val1.RFindChar(13);</span>
<a href="#l20.753"></a><span id="l20.753" class="difflineminus">-  }</span>
<a href="#l20.754"></a><span id="l20.754" class="difflineminus">-  if (idx == -1)</span>
<a href="#l20.755"></a><span id="l20.755" class="difflineminus">-    idx= val1.RFindChar(10);</span>
<a href="#l20.756"></a><span id="l20.756" class="difflineminus">-  if (idx != -1) {</span>
<a href="#l20.757"></a><span id="l20.757" class="difflineminus">-    val2 = Substring(val1, idx + cnt);</span>
<a href="#l20.758"></a><span id="l20.758" class="difflineminus">-    val1.SetLength(idx);</span>
<a href="#l20.759"></a><span id="l20.759" class="difflineminus">-    SanitizeValue(val1);</span>
<a href="#l20.760"></a><span id="l20.760" class="difflineminus">-  }</span>
<a href="#l20.761"></a><span id="l20.761" class="difflineminus">-}</span>
<a href="#l20.762"></a><span id="l20.762" class="difflineminus">-</span>
<a href="#l20.763"></a><span id="l20.763" class="difflineminus">-void nsEudoraAddress::AddSingleCard(CAliasEntry *pEntry, nsTArray&lt;CAliasData*&gt; &amp;emailList, nsIAddrDatabase *pDb)</span>
<a href="#l20.764"></a><span id="l20.764" class="difflineminus">-{</span>
<a href="#l20.765"></a><span id="l20.765" class="difflineminus">-  // We always have a nickname and everything else is optional.</span>
<a href="#l20.766"></a><span id="l20.766" class="difflineminus">-  // Map both home and work related fields to our address card. Eudora</span>
<a href="#l20.767"></a><span id="l20.767" class="difflineminus">-  // fields that can't be mapped will be left in the 'note' field!</span>
<a href="#l20.768"></a><span id="l20.768" class="difflineminus">-  nsIMdbRow* newRow = nullptr;</span>
<a href="#l20.769"></a><span id="l20.769" class="difflineminus">-  pDb-&gt;GetNewRow(&amp;newRow);</span>
<a href="#l20.770"></a><span id="l20.770" class="difflineminus">-  if (!newRow)</span>
<a href="#l20.771"></a><span id="l20.771" class="difflineminus">-    return;</span>
<a href="#l20.772"></a><span id="l20.772" class="difflineminus">-</span>
<a href="#l20.773"></a><span id="l20.773" class="difflineminus">-  nsCString                   displayName, name, firstName, lastName;</span>
<a href="#l20.774"></a><span id="l20.774" class="difflineminus">-  nsCString                   fax, secondaryFax, phone, mobile, secondaryMobile, webLink;</span>
<a href="#l20.775"></a><span id="l20.775" class="difflineminus">-  nsCString                   address, address2, city, state, zip, country;</span>
<a href="#l20.776"></a><span id="l20.776" class="difflineminus">-  nsCString                   phoneWK, webLinkWK, title, company;</span>
<a href="#l20.777"></a><span id="l20.777" class="difflineminus">-  nsCString                   addressWK, address2WK, cityWK, stateWK, zipWK, countryWK;</span>
<a href="#l20.778"></a><span id="l20.778" class="difflineminus">-  nsCString                   primaryLocation, otherPhone, otherWeb;</span>
<a href="#l20.779"></a><span id="l20.779" class="difflineminus">-  nsCString                   additionalEmail, stillMoreEmail;</span>
<a href="#l20.780"></a><span id="l20.780" class="difflineminus">-  nsCString                   note(pEntry-&gt;m_notes);</span>
<a href="#l20.781"></a><span id="l20.781" class="difflineminus">-  nsString                    noteUTF16;</span>
<a href="#l20.782"></a><span id="l20.782" class="difflineminus">-  bool                        isSecondaryMobileWorkNumber = true;</span>
<a href="#l20.783"></a><span id="l20.783" class="difflineminus">-  bool                        isSecondaryFaxWorkNumber = true;</span>
<a href="#l20.784"></a><span id="l20.784" class="difflineminus">-</span>
<a href="#l20.785"></a><span id="l20.785" class="difflineminus">-  if (!note.IsEmpty())</span>
<a href="#l20.786"></a><span id="l20.786" class="difflineminus">-  {</span>
<a href="#l20.787"></a><span id="l20.787" class="difflineminus">-    ExtractNoteField(note, fax, &quot;fax&quot;);</span>
<a href="#l20.788"></a><span id="l20.788" class="difflineminus">-    ExtractNoteField(note, secondaryFax, &quot;fax2&quot;);</span>
<a href="#l20.789"></a><span id="l20.789" class="difflineminus">-    ExtractNoteField(note, phone, &quot;phone&quot;);</span>
<a href="#l20.790"></a><span id="l20.790" class="difflineminus">-    ExtractNoteField(note, mobile, &quot;mobile&quot;);</span>
<a href="#l20.791"></a><span id="l20.791" class="difflineminus">-    ExtractNoteField(note, secondaryMobile, &quot;mobile2&quot;);</span>
<a href="#l20.792"></a><span id="l20.792" class="difflineminus">-    ExtractNoteField(note, address, &quot;address&quot;);</span>
<a href="#l20.793"></a><span id="l20.793" class="difflineminus">-    ExtractNoteField(note, city, &quot;city&quot;);</span>
<a href="#l20.794"></a><span id="l20.794" class="difflineminus">-    ExtractNoteField(note, state, &quot;state&quot;);</span>
<a href="#l20.795"></a><span id="l20.795" class="difflineminus">-    ExtractNoteField(note, zip, &quot;zip&quot;);</span>
<a href="#l20.796"></a><span id="l20.796" class="difflineminus">-    ExtractNoteField(note, country, &quot;country&quot;);</span>
<a href="#l20.797"></a><span id="l20.797" class="difflineminus">-    ExtractNoteField(note, name, &quot;name&quot;);</span>
<a href="#l20.798"></a><span id="l20.798" class="difflineminus">-    ExtractNoteField(note, firstName, &quot;first&quot;);</span>
<a href="#l20.799"></a><span id="l20.799" class="difflineminus">-    ExtractNoteField(note, lastName, &quot;last&quot;);</span>
<a href="#l20.800"></a><span id="l20.800" class="difflineminus">-    ExtractNoteField(note, webLink, &quot;web&quot;);</span>
<a href="#l20.801"></a><span id="l20.801" class="difflineminus">-</span>
<a href="#l20.802"></a><span id="l20.802" class="difflineminus">-    ExtractNoteField(note, addressWK, &quot;address2&quot;);</span>
<a href="#l20.803"></a><span id="l20.803" class="difflineminus">-    ExtractNoteField(note, cityWK, &quot;city2&quot;);</span>
<a href="#l20.804"></a><span id="l20.804" class="difflineminus">-    ExtractNoteField(note, stateWK, &quot;state2&quot;);</span>
<a href="#l20.805"></a><span id="l20.805" class="difflineminus">-    ExtractNoteField(note, zipWK, &quot;zip2&quot;);</span>
<a href="#l20.806"></a><span id="l20.806" class="difflineminus">-    ExtractNoteField(note, countryWK, &quot;country2&quot;);</span>
<a href="#l20.807"></a><span id="l20.807" class="difflineminus">-    ExtractNoteField(note, phoneWK, &quot;phone2&quot;);</span>
<a href="#l20.808"></a><span id="l20.808" class="difflineminus">-    ExtractNoteField(note, title, &quot;title&quot;);</span>
<a href="#l20.809"></a><span id="l20.809" class="difflineminus">-    ExtractNoteField(note, company, &quot;company&quot;);</span>
<a href="#l20.810"></a><span id="l20.810" class="difflineminus">-    ExtractNoteField(note, webLinkWK, &quot;web2&quot;);</span>
<a href="#l20.811"></a><span id="l20.811" class="difflineminus">-</span>
<a href="#l20.812"></a><span id="l20.812" class="difflineminus">-    ExtractNoteField(note, primaryLocation, &quot;primary&quot;);</span>
<a href="#l20.813"></a><span id="l20.813" class="difflineminus">-    ExtractNoteField(note, additionalEmail, &quot;otheremail&quot;);</span>
<a href="#l20.814"></a><span id="l20.814" class="difflineminus">-    ExtractNoteField(note, otherPhone, &quot;otherphone&quot;);</span>
<a href="#l20.815"></a><span id="l20.815" class="difflineminus">-    ExtractNoteField(note, otherWeb, &quot;otherweb&quot;);</span>
<a href="#l20.816"></a><span id="l20.816" class="difflineminus">-</span>
<a href="#l20.817"></a><span id="l20.817" class="difflineminus">-    // Is there any &quot;extra&quot; data that we may want to format nicely and place</span>
<a href="#l20.818"></a><span id="l20.818" class="difflineminus">-    // in the notes field?</span>
<a href="#l20.819"></a><span id="l20.819" class="difflineminus">-    if (!additionalEmail.IsEmpty() || !otherPhone.IsEmpty() || !otherWeb.IsEmpty())</span>
<a href="#l20.820"></a><span id="l20.820" class="difflineminus">-    {</span>
<a href="#l20.821"></a><span id="l20.821" class="difflineminus">-      nsCString     otherNotes(note);</span>
<a href="#l20.822"></a><span id="l20.822" class="difflineminus">-</span>
<a href="#l20.823"></a><span id="l20.823" class="difflineminus">-      if (!additionalEmail.IsEmpty())</span>
<a href="#l20.824"></a><span id="l20.824" class="difflineminus">-      {</span>
<a href="#l20.825"></a><span id="l20.825" class="difflineminus">-        // Reconstitute line breaks for additional email</span>
<a href="#l20.826"></a><span id="l20.826" class="difflineminus">-        MsgReplaceSubstring(additionalEmail, &quot;\x03&quot;, &quot;\n&quot;);</span>
<a href="#l20.827"></a><span id="l20.827" class="difflineminus">-</span>
<a href="#l20.828"></a><span id="l20.828" class="difflineminus">-        // Try to figure out if there are multiple email addresses in additionalEmail</span>
<a href="#l20.829"></a><span id="l20.829" class="difflineminus">-        int32_t     idx = MsgFindCharInSet(additionalEmail, &quot;\t\r\n,; &quot;);</span>
<a href="#l20.830"></a><span id="l20.830" class="difflineminus">-</span>
<a href="#l20.831"></a><span id="l20.831" class="difflineminus">-        if (idx != -1)</span>
<a href="#l20.832"></a><span id="l20.832" class="difflineminus">-        {</span>
<a href="#l20.833"></a><span id="l20.833" class="difflineminus">-          // We found a character that indicates that there's more than one email address here.</span>
<a href="#l20.834"></a><span id="l20.834" class="difflineminus">-          // Separate out the addresses after the first one.</span>
<a href="#l20.835"></a><span id="l20.835" class="difflineminus">-          stillMoreEmail = Substring(additionalEmail, idx + 1);</span>
<a href="#l20.836"></a><span id="l20.836" class="difflineminus">-          stillMoreEmail.Trim(kWhitespace);</span>
<a href="#l20.837"></a><span id="l20.837" class="difflineminus">-</span>
<a href="#l20.838"></a><span id="l20.838" class="difflineminus">-          // Separate out the first address.</span>
<a href="#l20.839"></a><span id="l20.839" class="difflineminus">-          additionalEmail.SetLength(idx);</span>
<a href="#l20.840"></a><span id="l20.840" class="difflineminus">-        }</span>
<a href="#l20.841"></a><span id="l20.841" class="difflineminus">-</span>
<a href="#l20.842"></a><span id="l20.842" class="difflineminus">-        // If there were more than one additional email addresses store all the extra</span>
<a href="#l20.843"></a><span id="l20.843" class="difflineminus">-        // ones in the notes field, labeled nicely.</span>
<a href="#l20.844"></a><span id="l20.844" class="difflineminus">-        if (!stillMoreEmail.IsEmpty())</span>
<a href="#l20.845"></a><span id="l20.845" class="difflineminus">-          FormatExtraDataInNoteField(EUDORAIMPORT_ADDRESS_LABEL_OTHEREMAIL, stillMoreEmail, noteUTF16);</span>
<a href="#l20.846"></a><span id="l20.846" class="difflineminus">-      }</span>
<a href="#l20.847"></a><span id="l20.847" class="difflineminus">-</span>
<a href="#l20.848"></a><span id="l20.848" class="difflineminus">-      if (!otherPhone.IsEmpty())</span>
<a href="#l20.849"></a><span id="l20.849" class="difflineminus">-      {</span>
<a href="#l20.850"></a><span id="l20.850" class="difflineminus">-        // Reconstitute line breaks for other phone numbers</span>
<a href="#l20.851"></a><span id="l20.851" class="difflineminus">-        MsgReplaceSubstring(otherPhone, &quot;\x03&quot;, &quot;\n&quot;);</span>
<a href="#l20.852"></a><span id="l20.852" class="difflineminus">-</span>
<a href="#l20.853"></a><span id="l20.853" class="difflineminus">-        // Store other phone numbers in the notes field, labeled nicely</span>
<a href="#l20.854"></a><span id="l20.854" class="difflineminus">-        FormatExtraDataInNoteField(EUDORAIMPORT_ADDRESS_LABEL_OTHERPHONE, otherPhone, noteUTF16);</span>
<a href="#l20.855"></a><span id="l20.855" class="difflineminus">-      }</span>
<a href="#l20.856"></a><span id="l20.856" class="difflineminus">-</span>
<a href="#l20.857"></a><span id="l20.857" class="difflineminus">-      if (!otherWeb.IsEmpty())</span>
<a href="#l20.858"></a><span id="l20.858" class="difflineminus">-      {</span>
<a href="#l20.859"></a><span id="l20.859" class="difflineminus">-        // Reconstitute line breaks for other web sites</span>
<a href="#l20.860"></a><span id="l20.860" class="difflineminus">-        MsgReplaceSubstring(otherWeb, &quot;\x03&quot;, &quot;\n&quot;);</span>
<a href="#l20.861"></a><span id="l20.861" class="difflineminus">-</span>
<a href="#l20.862"></a><span id="l20.862" class="difflineminus">-        // Store other web sites in the notes field, labeled nicely</span>
<a href="#l20.863"></a><span id="l20.863" class="difflineminus">-        FormatExtraDataInNoteField(EUDORAIMPORT_ADDRESS_LABEL_OTHERWEB, otherWeb, noteUTF16);</span>
<a href="#l20.864"></a><span id="l20.864" class="difflineminus">-      }</span>
<a href="#l20.865"></a><span id="l20.865" class="difflineminus">-</span>
<a href="#l20.866"></a><span id="l20.866" class="difflineminus">-      noteUTF16.Append(NS_ConvertASCIItoUTF16(note));</span>
<a href="#l20.867"></a><span id="l20.867" class="difflineminus">-    }</span>
<a href="#l20.868"></a><span id="l20.868" class="difflineminus">-  }</span>
<a href="#l20.869"></a><span id="l20.869" class="difflineminus">-</span>
<a href="#l20.870"></a><span id="l20.870" class="difflineminus">-  CAliasData *pData = emailList.Length() ? emailList.ElementAt(0) : nullptr;</span>
<a href="#l20.871"></a><span id="l20.871" class="difflineminus">-</span>
<a href="#l20.872"></a><span id="l20.872" class="difflineminus">-  if (pData &amp;&amp; !pData-&gt;m_realName.IsEmpty())</span>
<a href="#l20.873"></a><span id="l20.873" class="difflineminus">-    displayName = pData-&gt;m_realName;</span>
<a href="#l20.874"></a><span id="l20.874" class="difflineminus">-  else if (!name.IsEmpty())</span>
<a href="#l20.875"></a><span id="l20.875" class="difflineminus">-    displayName = name;</span>
<a href="#l20.876"></a><span id="l20.876" class="difflineminus">-  else</span>
<a href="#l20.877"></a><span id="l20.877" class="difflineminus">-    displayName = pEntry-&gt;m_name;</span>
<a href="#l20.878"></a><span id="l20.878" class="difflineminus">-</span>
<a href="#l20.879"></a><span id="l20.879" class="difflineminus">-  MsgReplaceSubstring(address, &quot;\x03&quot;, &quot;\n&quot;);</span>
<a href="#l20.880"></a><span id="l20.880" class="difflineminus">-  SplitString(address, address2);</span>
<a href="#l20.881"></a><span id="l20.881" class="difflineminus">-  MsgReplaceSubstring(note, &quot;\x03&quot;, &quot;\n&quot;);</span>
<a href="#l20.882"></a><span id="l20.882" class="difflineminus">-  MsgReplaceSubstring(fax, &quot;\x03&quot;, &quot; &quot;);</span>
<a href="#l20.883"></a><span id="l20.883" class="difflineminus">-  MsgReplaceSubstring(secondaryFax, &quot;\x03&quot;, &quot; &quot;);</span>
<a href="#l20.884"></a><span id="l20.884" class="difflineminus">-  MsgReplaceSubstring(phone, &quot;\x03&quot;, &quot; &quot;);</span>
<a href="#l20.885"></a><span id="l20.885" class="difflineminus">-  MsgReplaceSubstring(name, &quot;\x03&quot;, &quot; &quot;);</span>
<a href="#l20.886"></a><span id="l20.886" class="difflineminus">-  MsgReplaceSubstring(city, &quot;\x03&quot;, &quot; &quot;);</span>
<a href="#l20.887"></a><span id="l20.887" class="difflineminus">-  MsgReplaceSubstring(state, &quot;\x03&quot;, &quot; &quot;);</span>
<a href="#l20.888"></a><span id="l20.888" class="difflineminus">-  MsgReplaceSubstring(zip, &quot;\x03&quot;, &quot; &quot;);</span>
<a href="#l20.889"></a><span id="l20.889" class="difflineminus">-  MsgReplaceSubstring(country, &quot;\x03&quot;, &quot; &quot;);</span>
<a href="#l20.890"></a><span id="l20.890" class="difflineminus">-</span>
<a href="#l20.891"></a><span id="l20.891" class="difflineminus">-  MsgReplaceSubstring(addressWK, &quot;\x03&quot;, &quot;\n&quot;);</span>
<a href="#l20.892"></a><span id="l20.892" class="difflineminus">-  SplitString(addressWK, address2WK);</span>
<a href="#l20.893"></a><span id="l20.893" class="difflineminus">-  MsgReplaceSubstring(phoneWK, &quot;\x03&quot;, &quot; &quot;);</span>
<a href="#l20.894"></a><span id="l20.894" class="difflineminus">-  MsgReplaceSubstring(cityWK, &quot;\x03&quot;, &quot; &quot;);</span>
<a href="#l20.895"></a><span id="l20.895" class="difflineminus">-  MsgReplaceSubstring(stateWK, &quot;\x03&quot;, &quot; &quot;);</span>
<a href="#l20.896"></a><span id="l20.896" class="difflineminus">-  MsgReplaceSubstring(zipWK, &quot;\x03&quot;, &quot; &quot;);</span>
<a href="#l20.897"></a><span id="l20.897" class="difflineminus">-  MsgReplaceSubstring(countryWK, &quot;\x03&quot;, &quot; &quot;);</span>
<a href="#l20.898"></a><span id="l20.898" class="difflineminus">-  MsgReplaceSubstring(title, &quot;\x03&quot;, &quot; &quot;);</span>
<a href="#l20.899"></a><span id="l20.899" class="difflineminus">-  MsgReplaceSubstring(company, &quot;\x03&quot;, &quot; &quot;);</span>
<a href="#l20.900"></a><span id="l20.900" class="difflineminus">-</span>
<a href="#l20.901"></a><span id="l20.901" class="difflineminus">-  if (newRow)</span>
<a href="#l20.902"></a><span id="l20.902" class="difflineminus">-  {</span>
<a href="#l20.903"></a><span id="l20.903" class="difflineminus">-    nsAutoString uniStr;</span>
<a href="#l20.904"></a><span id="l20.904" class="difflineminus">-</span>
<a href="#l20.905"></a><span id="l20.905" class="difflineminus">-    // Home related fields.</span>
<a href="#l20.906"></a><span id="l20.906" class="difflineminus">-    ADD_FIELD_TO_DB_ROW(pDb, AddDisplayName, newRow, displayName, uniStr);</span>
<a href="#l20.907"></a><span id="l20.907" class="difflineminus">-    ADD_FIELD_TO_DB_ROW(pDb, AddNickName, newRow, pEntry-&gt;m_name, uniStr);</span>
<a href="#l20.908"></a><span id="l20.908" class="difflineminus">-    if (pData)</span>
<a href="#l20.909"></a><span id="l20.909" class="difflineminus">-      ADD_FIELD_TO_DB_ROW(pDb, AddPrimaryEmail, newRow, pData-&gt;m_email, uniStr);</span>
<a href="#l20.910"></a><span id="l20.910" class="difflineminus">-    ADD_FIELD_TO_DB_ROW(pDb, AddFirstName, newRow, firstName, uniStr);</span>
<a href="#l20.911"></a><span id="l20.911" class="difflineminus">-    ADD_FIELD_TO_DB_ROW(pDb, AddLastName, newRow, lastName, uniStr);</span>
<a href="#l20.912"></a><span id="l20.912" class="difflineminus">-    ADD_FIELD_TO_DB_ROW(pDb, AddWebPage2, newRow, webLink, uniStr);</span>
<a href="#l20.913"></a><span id="l20.913" class="difflineminus">-    ADD_FIELD_TO_DB_ROW(pDb, AddHomePhone, newRow, phone, uniStr);</span>
<a href="#l20.914"></a><span id="l20.914" class="difflineminus">-    ADD_FIELD_TO_DB_ROW(pDb, AddHomeAddress, newRow, address, uniStr);</span>
<a href="#l20.915"></a><span id="l20.915" class="difflineminus">-    ADD_FIELD_TO_DB_ROW(pDb, AddHomeAddress2, newRow, address2, uniStr);</span>
<a href="#l20.916"></a><span id="l20.916" class="difflineminus">-    ADD_FIELD_TO_DB_ROW(pDb, AddHomeCity, newRow, city, uniStr);</span>
<a href="#l20.917"></a><span id="l20.917" class="difflineminus">-    ADD_FIELD_TO_DB_ROW(pDb, AddHomeZipCode, newRow, zip, uniStr);</span>
<a href="#l20.918"></a><span id="l20.918" class="difflineminus">-    ADD_FIELD_TO_DB_ROW(pDb, AddHomeState, newRow, state, uniStr);</span>
<a href="#l20.919"></a><span id="l20.919" class="difflineminus">-    ADD_FIELD_TO_DB_ROW(pDb, AddHomeCountry, newRow, country, uniStr);</span>
<a href="#l20.920"></a><span id="l20.920" class="difflineminus">-</span>
<a href="#l20.921"></a><span id="l20.921" class="difflineminus">-    // Work related fields.</span>
<a href="#l20.922"></a><span id="l20.922" class="difflineminus">-    ADD_FIELD_TO_DB_ROW(pDb, AddJobTitle, newRow, title, uniStr);</span>
<a href="#l20.923"></a><span id="l20.923" class="difflineminus">-    ADD_FIELD_TO_DB_ROW(pDb, AddCompany, newRow, company, uniStr);</span>
<a href="#l20.924"></a><span id="l20.924" class="difflineminus">-    ADD_FIELD_TO_DB_ROW(pDb, AddWebPage1, newRow, webLinkWK, uniStr);</span>
<a href="#l20.925"></a><span id="l20.925" class="difflineminus">-    ADD_FIELD_TO_DB_ROW(pDb, AddWorkPhone, newRow, phoneWK, uniStr);</span>
<a href="#l20.926"></a><span id="l20.926" class="difflineminus">-    ADD_FIELD_TO_DB_ROW(pDb, AddWorkAddress, newRow, addressWK, uniStr);</span>
<a href="#l20.927"></a><span id="l20.927" class="difflineminus">-    ADD_FIELD_TO_DB_ROW(pDb, AddWorkAddress2, newRow, address2WK, uniStr);</span>
<a href="#l20.928"></a><span id="l20.928" class="difflineminus">-    ADD_FIELD_TO_DB_ROW(pDb, AddWorkCity, newRow, cityWK, uniStr);</span>
<a href="#l20.929"></a><span id="l20.929" class="difflineminus">-    ADD_FIELD_TO_DB_ROW(pDb, AddWorkZipCode, newRow, zipWK, uniStr);</span>
<a href="#l20.930"></a><span id="l20.930" class="difflineminus">-    ADD_FIELD_TO_DB_ROW(pDb, AddWorkState, newRow, stateWK, uniStr);</span>
<a href="#l20.931"></a><span id="l20.931" class="difflineminus">-    ADD_FIELD_TO_DB_ROW(pDb, AddWorkCountry, newRow, countryWK, uniStr);</span>
<a href="#l20.932"></a><span id="l20.932" class="difflineminus">-</span>
<a href="#l20.933"></a><span id="l20.933" class="difflineminus">-    if ((primaryLocation.IsEmpty() || primaryLocation.LowerCaseEqualsLiteral(&quot;home&quot;)) &amp;&amp;</span>
<a href="#l20.934"></a><span id="l20.934" class="difflineminus">-         !mobile.IsEmpty())</span>
<a href="#l20.935"></a><span id="l20.935" class="difflineminus">-    {</span>
<a href="#l20.936"></a><span id="l20.936" class="difflineminus">-      // Primary location field is either specified to be &quot;home&quot; or is not</span>
<a href="#l20.937"></a><span id="l20.937" class="difflineminus">-      // specified and there is a home mobile number, so use that as the mobile number.</span>
<a href="#l20.938"></a><span id="l20.938" class="difflineminus">-      ADD_FIELD_TO_DB_ROW(pDb, AddCellularNumber, newRow, mobile, uniStr);</span>
<a href="#l20.939"></a><span id="l20.939" class="difflineminus">-</span>
<a href="#l20.940"></a><span id="l20.940" class="difflineminus">-      isSecondaryMobileWorkNumber = true;</span>
<a href="#l20.941"></a><span id="l20.941" class="difflineminus">-    }</span>
<a href="#l20.942"></a><span id="l20.942" class="difflineminus">-    else</span>
<a href="#l20.943"></a><span id="l20.943" class="difflineminus">-    {</span>
<a href="#l20.944"></a><span id="l20.944" class="difflineminus">-      // Primary location field is either specified to be &quot;work&quot; or there is no</span>
<a href="#l20.945"></a><span id="l20.945" class="difflineminus">-      // home mobile number, so use work mobile number.</span>
<a href="#l20.946"></a><span id="l20.946" class="difflineminus">-      ADD_FIELD_TO_DB_ROW(pDb, AddCellularNumber, newRow, secondaryMobile, uniStr);</span>
<a href="#l20.947"></a><span id="l20.947" class="difflineminus">-</span>
<a href="#l20.948"></a><span id="l20.948" class="difflineminus">-      // Home mobile number (if any) is the secondary mobile number</span>
<a href="#l20.949"></a><span id="l20.949" class="difflineminus">-      secondaryMobile = mobile;</span>
<a href="#l20.950"></a><span id="l20.950" class="difflineminus">-      isSecondaryMobileWorkNumber = false;</span>
<a href="#l20.951"></a><span id="l20.951" class="difflineminus">-    }</span>
<a href="#l20.952"></a><span id="l20.952" class="difflineminus">-</span>
<a href="#l20.953"></a><span id="l20.953" class="difflineminus">-    if ((primaryLocation.IsEmpty() || primaryLocation.LowerCaseEqualsLiteral(&quot;home&quot;)) &amp;&amp;</span>
<a href="#l20.954"></a><span id="l20.954" class="difflineminus">-         !fax.IsEmpty())</span>
<a href="#l20.955"></a><span id="l20.955" class="difflineminus">-    {</span>
<a href="#l20.956"></a><span id="l20.956" class="difflineminus">-      // Primary location field is either specified to be &quot;home&quot; or is not</span>
<a href="#l20.957"></a><span id="l20.957" class="difflineminus">-      // specified and there is a home fax number, so use that as the fax number.</span>
<a href="#l20.958"></a><span id="l20.958" class="difflineminus">-      ADD_FIELD_TO_DB_ROW(pDb, AddFaxNumber, newRow, fax, uniStr);</span>
<a href="#l20.959"></a><span id="l20.959" class="difflineminus">-</span>
<a href="#l20.960"></a><span id="l20.960" class="difflineminus">-      isSecondaryFaxWorkNumber = true;</span>
<a href="#l20.961"></a><span id="l20.961" class="difflineminus">-    }</span>
<a href="#l20.962"></a><span id="l20.962" class="difflineminus">-    else</span>
<a href="#l20.963"></a><span id="l20.963" class="difflineminus">-    {</span>
<a href="#l20.964"></a><span id="l20.964" class="difflineminus">-      // Primary location field is either specified to be &quot;work&quot; or there is no</span>
<a href="#l20.965"></a><span id="l20.965" class="difflineminus">-      // home fax number, so use work fax number.</span>
<a href="#l20.966"></a><span id="l20.966" class="difflineminus">-      ADD_FIELD_TO_DB_ROW(pDb, AddFaxNumber, newRow, secondaryFax, uniStr);</span>
<a href="#l20.967"></a><span id="l20.967" class="difflineminus">-</span>
<a href="#l20.968"></a><span id="l20.968" class="difflineminus">-      // Home fax number (if any) is the secondary fax number</span>
<a href="#l20.969"></a><span id="l20.969" class="difflineminus">-      secondaryFax = fax;</span>
<a href="#l20.970"></a><span id="l20.970" class="difflineminus">-      isSecondaryFaxWorkNumber = false;</span>
<a href="#l20.971"></a><span id="l20.971" class="difflineminus">-    }</span>
<a href="#l20.972"></a><span id="l20.972" class="difflineminus">-</span>
<a href="#l20.973"></a><span id="l20.973" class="difflineminus">-    ADD_FIELD_TO_DB_ROW(pDb, Add2ndEmail, newRow, additionalEmail, uniStr);</span>
<a href="#l20.974"></a><span id="l20.974" class="difflineminus">-</span>
<a href="#l20.975"></a><span id="l20.975" class="difflineminus">-    // Extra info fields</span>
<a href="#l20.976"></a><span id="l20.976" class="difflineminus">-    int32_t         stringID;</span>
<a href="#l20.977"></a><span id="l20.977" class="difflineminus">-    nsString        pFormat;</span>
<a href="#l20.978"></a><span id="l20.978" class="difflineminus">-    nsString        pCustomData;</span>
<a href="#l20.979"></a><span id="l20.979" class="difflineminus">-</span>
<a href="#l20.980"></a><span id="l20.980" class="difflineminus">-    // Add second mobile number, if any, to the Custom 1 field</span>
<a href="#l20.981"></a><span id="l20.981" class="difflineminus">-    if (!secondaryMobile.IsEmpty())</span>
<a href="#l20.982"></a><span id="l20.982" class="difflineminus">-    {</span>
<a href="#l20.983"></a><span id="l20.983" class="difflineminus">-      stringID = isSecondaryMobileWorkNumber ?</span>
<a href="#l20.984"></a><span id="l20.984" class="difflineminus">-                 EUDORAIMPORT_ADDRESS_LABEL_WORKMOBILE : EUDORAIMPORT_ADDRESS_LABEL_HOMEMOBILE;</span>
<a href="#l20.985"></a><span id="l20.985" class="difflineminus">-      pFormat.Adopt(nsEudoraStringBundle::GetStringByID(stringID));</span>
<a href="#l20.986"></a><span id="l20.986" class="difflineminus">-      pCustomData.Adopt(nsTextFormatter::smprintf(pFormat.get(), NS_ConvertASCIItoUTF16(secondaryMobile).get()));</span>
<a href="#l20.987"></a><span id="l20.987" class="difflineminus">-      pDb-&gt;AddCustom1(newRow, NS_ConvertUTF16toUTF8(pCustomData).get());</span>
<a href="#l20.988"></a><span id="l20.988" class="difflineminus">-    }</span>
<a href="#l20.989"></a><span id="l20.989" class="difflineminus">-</span>
<a href="#l20.990"></a><span id="l20.990" class="difflineminus">-    // Add second fax number, if any, to the Custom 2 field</span>
<a href="#l20.991"></a><span id="l20.991" class="difflineminus">-    if (!secondaryFax.IsEmpty())</span>
<a href="#l20.992"></a><span id="l20.992" class="difflineminus">-    {</span>
<a href="#l20.993"></a><span id="l20.993" class="difflineminus">-      stringID = isSecondaryFaxWorkNumber ?</span>
<a href="#l20.994"></a><span id="l20.994" class="difflineminus">-                 EUDORAIMPORT_ADDRESS_LABEL_WORKFAX : EUDORAIMPORT_ADDRESS_LABEL_HOMEFAX;</span>
<a href="#l20.995"></a><span id="l20.995" class="difflineminus">-      pFormat.Adopt(nsEudoraStringBundle::GetStringByID(stringID));</span>
<a href="#l20.996"></a><span id="l20.996" class="difflineminus">-      pCustomData.Adopt(nsTextFormatter::smprintf(pFormat.get(), NS_ConvertASCIItoUTF16(secondaryFax).get()));</span>
<a href="#l20.997"></a><span id="l20.997" class="difflineminus">-      pDb-&gt;AddCustom2(newRow, NS_ConvertUTF16toUTF8(pCustomData).get());</span>
<a href="#l20.998"></a><span id="l20.998" class="difflineminus">-    }</span>
<a href="#l20.999"></a><span id="l20.999" class="difflineminus">-</span>
<a href="#l20.1000"></a><span id="l20.1000" class="difflineminus">-    // Lastly, note field.</span>
<a href="#l20.1001"></a><span id="l20.1001" class="difflineminus">-    pDb-&gt;AddNotes(newRow, NS_ConvertUTF16toUTF8(noteUTF16).get());</span>
<a href="#l20.1002"></a><span id="l20.1002" class="difflineminus">-</span>
<a href="#l20.1003"></a><span id="l20.1003" class="difflineminus">-    pDb-&gt;AddCardRowToDB(newRow);</span>
<a href="#l20.1004"></a><span id="l20.1004" class="difflineminus">-</span>
<a href="#l20.1005"></a><span id="l20.1005" class="difflineminus">-    IMPORT_LOG1(&quot;Added card to db: %s\n&quot;, displayName.get());</span>
<a href="#l20.1006"></a><span id="l20.1006" class="difflineminus">-  }</span>
<a href="#l20.1007"></a><span id="l20.1007" class="difflineminus">-}</span>
<a href="#l20.1008"></a><span id="l20.1008" class="difflineminus">-</span>
<a href="#l20.1009"></a><span id="l20.1009" class="difflineminus">-//</span>
<a href="#l20.1010"></a><span id="l20.1010" class="difflineminus">-// Since there is no way to check if a card for a given email address already exists,</span>
<a href="#l20.1011"></a><span id="l20.1011" class="difflineminus">-// elements in 'membersArray' are make unique. So for each email address in 'emailList'</span>
<a href="#l20.1012"></a><span id="l20.1012" class="difflineminus">-// we check it in 'membersArray' and if it's not there then we add it to 'membersArray'.</span>
<a href="#l20.1013"></a><span id="l20.1013" class="difflineminus">-//</span>
<a href="#l20.1014"></a><span id="l20.1014" class="difflineminus">-void nsEudoraAddress::RememberGroupMembers(nsTArray&lt;CAliasData*&gt; &amp;membersArray, nsTArray&lt;CAliasData*&gt; &amp;emailList)</span>
<a href="#l20.1015"></a><span id="l20.1015" class="difflineminus">-{</span>
<a href="#l20.1016"></a><span id="l20.1016" class="difflineminus">-  int32_t cnt = emailList.Length();</span>
<a href="#l20.1017"></a><span id="l20.1017" class="difflineminus">-  CAliasData *pData;</span>
<a href="#l20.1018"></a><span id="l20.1018" class="difflineminus">-</span>
<a href="#l20.1019"></a><span id="l20.1019" class="difflineminus">-  for (int32_t i = 0; i &lt; cnt; i++)</span>
<a href="#l20.1020"></a><span id="l20.1020" class="difflineminus">-  {</span>
<a href="#l20.1021"></a><span id="l20.1021" class="difflineminus">-    pData = emailList.ElementAt(i);</span>
<a href="#l20.1022"></a><span id="l20.1022" class="difflineminus">-    if (!pData)</span>
<a href="#l20.1023"></a><span id="l20.1023" class="difflineminus">-      continue;</span>
<a href="#l20.1024"></a><span id="l20.1024" class="difflineminus">-</span>
<a href="#l20.1025"></a><span id="l20.1025" class="difflineminus">-    int32_t memberCnt = membersArray.Length();</span>
<a href="#l20.1026"></a><span id="l20.1026" class="difflineminus">-    int32_t j = 0;</span>
<a href="#l20.1027"></a><span id="l20.1027" class="difflineminus">-    for (j = 0; j &lt; memberCnt; j++)</span>
<a href="#l20.1028"></a><span id="l20.1028" class="difflineminus">-    {</span>
<a href="#l20.1029"></a><span id="l20.1029" class="difflineminus">-      if (pData == membersArray.ElementAt(j))</span>
<a href="#l20.1030"></a><span id="l20.1030" class="difflineminus">-        break;</span>
<a href="#l20.1031"></a><span id="l20.1031" class="difflineminus">-    }</span>
<a href="#l20.1032"></a><span id="l20.1032" class="difflineminus">-    if (j &gt;= memberCnt)</span>
<a href="#l20.1033"></a><span id="l20.1033" class="difflineminus">-      membersArray.AppendElement(pData); // add to member list</span>
<a href="#l20.1034"></a><span id="l20.1034" class="difflineminus">-  }</span>
<a href="#l20.1035"></a><span id="l20.1035" class="difflineminus">-}</span>
<a href="#l20.1036"></a><span id="l20.1036" class="difflineminus">-</span>
<a href="#l20.1037"></a><span id="l20.1037" class="difflineminus">-nsresult nsEudoraAddress::AddGroupMembersAsCards(nsTArray&lt;CAliasData*&gt; &amp;membersArray, nsIAddrDatabase *pDb)</span>
<a href="#l20.1038"></a><span id="l20.1038" class="difflineminus">-{</span>
<a href="#l20.1039"></a><span id="l20.1039" class="difflineminus">-  int32_t max = membersArray.Length();</span>
<a href="#l20.1040"></a><span id="l20.1040" class="difflineminus">-  CAliasData *pData;</span>
<a href="#l20.1041"></a><span id="l20.1041" class="difflineminus">-  nsresult rv = NS_OK;</span>
<a href="#l20.1042"></a><span id="l20.1042" class="difflineminus">-  nsCOMPtr &lt;nsIMdbRow&gt; newRow;</span>
<a href="#l20.1043"></a><span id="l20.1043" class="difflineminus">-  nsAutoString uniStr;</span>
<a href="#l20.1044"></a><span id="l20.1044" class="difflineminus">-  nsAutoCString  displayName;</span>
<a href="#l20.1045"></a><span id="l20.1045" class="difflineminus">-</span>
<a href="#l20.1046"></a><span id="l20.1046" class="difflineminus">-  for (int32_t i = 0; i &lt; max; i++)</span>
<a href="#l20.1047"></a><span id="l20.1047" class="difflineminus">-  {</span>
<a href="#l20.1048"></a><span id="l20.1048" class="difflineminus">-    pData = membersArray.ElementAt(i);</span>
<a href="#l20.1049"></a><span id="l20.1049" class="difflineminus">-</span>
<a href="#l20.1050"></a><span id="l20.1050" class="difflineminus">-    if (!pData || (pData-&gt;m_email.IsEmpty()))</span>
<a href="#l20.1051"></a><span id="l20.1051" class="difflineminus">-      continue;</span>
<a href="#l20.1052"></a><span id="l20.1052" class="difflineminus">-</span>
<a href="#l20.1053"></a><span id="l20.1053" class="difflineminus">-    rv = pDb-&gt;GetNewRow(getter_AddRefs(newRow));</span>
<a href="#l20.1054"></a><span id="l20.1054" class="difflineminus">-    if (NS_FAILED(rv) || !newRow)</span>
<a href="#l20.1055"></a><span id="l20.1055" class="difflineminus">-      return rv;</span>
<a href="#l20.1056"></a><span id="l20.1056" class="difflineminus">-</span>
<a href="#l20.1057"></a><span id="l20.1057" class="difflineminus">-    if (!pData-&gt;m_realName.IsEmpty())</span>
<a href="#l20.1058"></a><span id="l20.1058" class="difflineminus">-      displayName = pData-&gt;m_realName;</span>
<a href="#l20.1059"></a><span id="l20.1059" class="difflineminus">-    else if (!pData-&gt;m_nickName.IsEmpty())</span>
<a href="#l20.1060"></a><span id="l20.1060" class="difflineminus">-      displayName = pData-&gt;m_nickName;</span>
<a href="#l20.1061"></a><span id="l20.1061" class="difflineminus">-    else</span>
<a href="#l20.1062"></a><span id="l20.1062" class="difflineminus">-      displayName.Truncate();</span>
<a href="#l20.1063"></a><span id="l20.1063" class="difflineminus">-</span>
<a href="#l20.1064"></a><span id="l20.1064" class="difflineminus">-    ADD_FIELD_TO_DB_ROW(pDb, AddDisplayName, newRow, displayName, uniStr);</span>
<a href="#l20.1065"></a><span id="l20.1065" class="difflineminus">-    ADD_FIELD_TO_DB_ROW(pDb, AddPrimaryEmail, newRow, pData-&gt;m_email, uniStr);</span>
<a href="#l20.1066"></a><span id="l20.1066" class="difflineminus">-    rv = pDb-&gt;AddCardRowToDB(newRow);</span>
<a href="#l20.1067"></a><span id="l20.1067" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.1068"></a><span id="l20.1068" class="difflineminus">-  }</span>
<a href="#l20.1069"></a><span id="l20.1069" class="difflineminus">-  return rv;</span>
<a href="#l20.1070"></a><span id="l20.1070" class="difflineminus">-}</span>
<a href="#l20.1071"></a><span id="l20.1071" class="difflineminus">-</span>
<a href="#l20.1072"></a><span id="l20.1072" class="difflineminus">-nsresult nsEudoraAddress::AddSingleList(CAliasEntry *pEntry, nsTArray&lt;CAliasData*&gt; &amp;emailList, nsIAddrDatabase *pDb)</span>
<a href="#l20.1073"></a><span id="l20.1073" class="difflineminus">-{</span>
<a href="#l20.1074"></a><span id="l20.1074" class="difflineminus">-  // Create a list.</span>
<a href="#l20.1075"></a><span id="l20.1075" class="difflineminus">-  nsCOMPtr &lt;nsIMdbRow&gt; newRow;</span>
<a href="#l20.1076"></a><span id="l20.1076" class="difflineminus">-  nsresult rv = pDb-&gt;GetNewListRow(getter_AddRefs(newRow));</span>
<a href="#l20.1077"></a><span id="l20.1077" class="difflineminus">-  if (NS_FAILED(rv) || !newRow)</span>
<a href="#l20.1078"></a><span id="l20.1078" class="difflineminus">-      return rv;</span>
<a href="#l20.1079"></a><span id="l20.1079" class="difflineminus">-</span>
<a href="#l20.1080"></a><span id="l20.1080" class="difflineminus">-  // Extract name from notes, if any</span>
<a href="#l20.1081"></a><span id="l20.1081" class="difflineminus">-  nsCString     name;</span>
<a href="#l20.1082"></a><span id="l20.1082" class="difflineminus">-</span>
<a href="#l20.1083"></a><span id="l20.1083" class="difflineminus">-  if (!pEntry-&gt;m_notes.IsEmpty())</span>
<a href="#l20.1084"></a><span id="l20.1084" class="difflineminus">-  {</span>
<a href="#l20.1085"></a><span id="l20.1085" class="difflineminus">-    nsCString     note(pEntry-&gt;m_notes);</span>
<a href="#l20.1086"></a><span id="l20.1086" class="difflineminus">-    ExtractNoteField(note, name, &quot;name&quot;);</span>
<a href="#l20.1087"></a><span id="l20.1087" class="difflineminus">-  }</span>
<a href="#l20.1088"></a><span id="l20.1088" class="difflineminus">-</span>
<a href="#l20.1089"></a><span id="l20.1089" class="difflineminus">-  // If we got a name from the notes, use that for the name otherwise use the</span>
<a href="#l20.1090"></a><span id="l20.1090" class="difflineminus">-  // name in pEntry (which is the Eudora nickname).</span>
<a href="#l20.1091"></a><span id="l20.1091" class="difflineminus">-  rv = pDb-&gt;AddListName(newRow, name.IsEmpty() ? pEntry-&gt;m_name.get() : name.get());</span>
<a href="#l20.1092"></a><span id="l20.1092" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.1093"></a><span id="l20.1093" class="difflineminus">-</span>
<a href="#l20.1094"></a><span id="l20.1094" class="difflineminus">-  // Add the name in pEntry as the list nickname, because it was the Eudora nickname</span>
<a href="#l20.1095"></a><span id="l20.1095" class="difflineminus">-  rv = pDb-&gt;AddListNickName(newRow, pEntry-&gt;m_name.get());</span>
<a href="#l20.1096"></a><span id="l20.1096" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.1097"></a><span id="l20.1097" class="difflineminus">-</span>
<a href="#l20.1098"></a><span id="l20.1098" class="difflineminus">-  // Now add the members.</span>
<a href="#l20.1099"></a><span id="l20.1099" class="difflineminus">-  int32_t max = emailList.Length();</span>
<a href="#l20.1100"></a><span id="l20.1100" class="difflineminus">-  for (int32_t i = 0; i &lt; max; i++)</span>
<a href="#l20.1101"></a><span id="l20.1101" class="difflineminus">-  {</span>
<a href="#l20.1102"></a><span id="l20.1102" class="difflineminus">-    CAliasData *pData = emailList.ElementAt(i);</span>
<a href="#l20.1103"></a><span id="l20.1103" class="difflineminus">-    nsAutoCString ldifValue(&quot;mail&quot;);</span>
<a href="#l20.1104"></a><span id="l20.1104" class="difflineminus">-    ldifValue.Append(pData-&gt;m_email);</span>
<a href="#l20.1105"></a><span id="l20.1105" class="difflineminus">-    rv = pDb-&gt;AddLdifListMember(newRow, ldifValue.get());</span>
<a href="#l20.1106"></a><span id="l20.1106" class="difflineminus">-  }</span>
<a href="#l20.1107"></a><span id="l20.1107" class="difflineminus">-</span>
<a href="#l20.1108"></a><span id="l20.1108" class="difflineminus">-  rv = pDb-&gt;AddCardRowToDB(newRow);</span>
<a href="#l20.1109"></a><span id="l20.1109" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.1110"></a><span id="l20.1110" class="difflineminus">-</span>
<a href="#l20.1111"></a><span id="l20.1111" class="difflineminus">-  rv = pDb-&gt;AddListDirNode(newRow);</span>
<a href="#l20.1112"></a><span id="l20.1112" class="difflineminus">-  return rv;</span>
<a href="#l20.1113"></a><span id="l20.1113" class="difflineminus">-}</span>
<a href="#l20.1114"></a><span id="l20.1114" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1">deleted file mode 100644</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineminus">--- a/mailnews/import/eudora/src/nsEudoraAddress.h</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineplus">+++ /dev/null</span>
<a href="#l21.4"></a><span id="l21.4" class="difflineat">@@ -1,76 +0,0 @@</span>
<a href="#l21.5"></a><span id="l21.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-</span>
<a href="#l21.6"></a><span id="l21.6" class="difflineminus">- *</span>
<a href="#l21.7"></a><span id="l21.7" class="difflineminus">- * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l21.8"></a><span id="l21.8" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l21.9"></a><span id="l21.9" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l21.10"></a><span id="l21.10" class="difflineminus">-</span>
<a href="#l21.11"></a><span id="l21.11" class="difflineminus">-#ifndef nsEudoraAddress_h__</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-#define nsEudoraAddress_h__</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineminus">-</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineminus">-#include &quot;nscore.h&quot;</span>
<a href="#l21.15"></a><span id="l21.15" class="difflineminus">-#include &quot;nsStringGlue.h&quot;</span>
<a href="#l21.16"></a><span id="l21.16" class="difflineminus">-#include &quot;nsTArray.h&quot;</span>
<a href="#l21.17"></a><span id="l21.17" class="difflineminus">-#include &quot;nsIFile.h&quot;</span>
<a href="#l21.18"></a><span id="l21.18" class="difflineminus">-#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l21.19"></a><span id="l21.19" class="difflineminus">-#include &quot;nsIImportService.h&quot;</span>
<a href="#l21.20"></a><span id="l21.20" class="difflineminus">-</span>
<a href="#l21.21"></a><span id="l21.21" class="difflineminus">-</span>
<a href="#l21.22"></a><span id="l21.22" class="difflineminus">-class nsIAddrDatabase;</span>
<a href="#l21.23"></a><span id="l21.23" class="difflineminus">-class CAliasEntry;</span>
<a href="#l21.24"></a><span id="l21.24" class="difflineminus">-class CAliasData;</span>
<a href="#l21.25"></a><span id="l21.25" class="difflineminus">-class nsIStringBundle;</span>
<a href="#l21.26"></a><span id="l21.26" class="difflineminus">-class nsIMutableArray;</span>
<a href="#l21.27"></a><span id="l21.27" class="difflineminus">-</span>
<a href="#l21.28"></a><span id="l21.28" class="difflineminus">-/////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l21.29"></a><span id="l21.29" class="difflineminus">-/////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l21.30"></a><span id="l21.30" class="difflineminus">-/////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l21.31"></a><span id="l21.31" class="difflineminus">-</span>
<a href="#l21.32"></a><span id="l21.32" class="difflineminus">-class nsEudoraAddress {</span>
<a href="#l21.33"></a><span id="l21.33" class="difflineminus">-public:</span>
<a href="#l21.34"></a><span id="l21.34" class="difflineminus">-  nsEudoraAddress();</span>
<a href="#l21.35"></a><span id="l21.35" class="difflineminus">-  virtual ~nsEudoraAddress();</span>
<a href="#l21.36"></a><span id="l21.36" class="difflineminus">-</span>
<a href="#l21.37"></a><span id="l21.37" class="difflineminus">-  // Things that must be overridden because they are platform specific.</span>
<a href="#l21.38"></a><span id="l21.38" class="difflineminus">-    // retrieve the mail folder</span>
<a href="#l21.39"></a><span id="l21.39" class="difflineminus">-  virtual bool      FindAddressFolder(nsIFile **pFolder) { return false;}</span>
<a href="#l21.40"></a><span id="l21.40" class="difflineminus">-    // get the list of mailboxes</span>
<a href="#l21.41"></a><span id="l21.41" class="difflineminus">-  virtual nsresult  FindAddressBooks(nsIFile *pRoot, nsIMutableArray *pArray) { return NS_ERROR_FAILURE;}</span>
<a href="#l21.42"></a><span id="l21.42" class="difflineminus">-</span>
<a href="#l21.43"></a><span id="l21.43" class="difflineminus">-  // Non-platform specific common stuff</span>
<a href="#l21.44"></a><span id="l21.44" class="difflineminus">-    // import a mailbox</span>
<a href="#l21.45"></a><span id="l21.45" class="difflineminus">-  nsresult ImportAddresses(uint32_t *pBytes, bool *pAbort, const char16_t *pName, nsIFile *pSrc, nsIAddrDatabase *pDb, nsString&amp; errors);</span>
<a href="#l21.46"></a><span id="l21.46" class="difflineminus">-</span>
<a href="#l21.47"></a><span id="l21.47" class="difflineminus">-</span>
<a href="#l21.48"></a><span id="l21.48" class="difflineminus">-private:</span>
<a href="#l21.49"></a><span id="l21.49" class="difflineminus">-  void       EmptyAliases(void);</span>
<a href="#l21.50"></a><span id="l21.50" class="difflineminus">-  void      ProcessLine(const char *pLine, int32_t len, nsString&amp; errors);</span>
<a href="#l21.51"></a><span id="l21.51" class="difflineminus">-  int32_t     CountWhiteSpace(const char *pLine, int32_t len);</span>
<a href="#l21.52"></a><span id="l21.52" class="difflineminus">-  CAliasEntry  *  ProcessAlias(const char *pLine, int32_t len, nsString&amp; errors);</span>
<a href="#l21.53"></a><span id="l21.53" class="difflineminus">-  void      ProcessNote(const char *pLine, int32_t len, nsString&amp; errors);</span>
<a href="#l21.54"></a><span id="l21.54" class="difflineminus">-  int32_t      GetAliasName(const char *pLine, int32_t len, nsCString&amp; name);</span>
<a href="#l21.55"></a><span id="l21.55" class="difflineminus">-  CAliasEntry *  ResolveAlias(nsCString&amp; name);</span>
<a href="#l21.56"></a><span id="l21.56" class="difflineminus">-  void       ResolveEntries(nsCString&amp; name, nsTArray&lt;CAliasData*&gt;&amp; list, nsTArray&lt;CAliasData*&gt;&amp; result, bool addResolvedEntries, bool wasResolved, int32_t&amp; numResolved);</span>
<a href="#l21.57"></a><span id="l21.57" class="difflineminus">-  void      BuildABCards(uint32_t *pBytes, nsIAddrDatabase *pDb);</span>
<a href="#l21.58"></a><span id="l21.58" class="difflineminus">-  void      AddSingleCard(CAliasEntry *pEntry, nsTArray&lt;CAliasData*&gt; &amp;emailList, nsIAddrDatabase *pDb);</span>
<a href="#l21.59"></a><span id="l21.59" class="difflineminus">-  nsresult  AddSingleList(CAliasEntry *pEntry, nsTArray&lt;CAliasData*&gt; &amp;emailList, nsIAddrDatabase *pDb);</span>
<a href="#l21.60"></a><span id="l21.60" class="difflineminus">-  nsresult  AddGroupMembersAsCards(nsTArray&lt;CAliasData*&gt; &amp;membersArray, nsIAddrDatabase *pDb);</span>
<a href="#l21.61"></a><span id="l21.61" class="difflineminus">-  void      RememberGroupMembers(nsTArray&lt;CAliasData*&gt; &amp;membersArray, nsTArray&lt;CAliasData*&gt; &amp;emailList);</span>
<a href="#l21.62"></a><span id="l21.62" class="difflineminus">-  int32_t      FindAlias(nsCString&amp; name);</span>
<a href="#l21.63"></a><span id="l21.63" class="difflineminus">-  void      ExtractNoteField(nsCString&amp; note, nsCString&amp; field, const char *pFieldName);</span>
<a href="#l21.64"></a><span id="l21.64" class="difflineminus">-  void FormatExtraDataInNoteField(int32_t labelStringID, nsCString&amp; extraData, nsString&amp; noteUTF16);</span>
<a href="#l21.65"></a><span id="l21.65" class="difflineminus">-  void      SanitizeValue(nsCString&amp; val);</span>
<a href="#l21.66"></a><span id="l21.66" class="difflineminus">-  void      SplitString(nsCString&amp; val1, nsCString&amp; val2);</span>
<a href="#l21.67"></a><span id="l21.67" class="difflineminus">-</span>
<a href="#l21.68"></a><span id="l21.68" class="difflineminus">-public:</span>
<a href="#l21.69"></a><span id="l21.69" class="difflineminus">-  static int32_t     CountQuote(const char *pLine, int32_t len);</span>
<a href="#l21.70"></a><span id="l21.70" class="difflineminus">-  static int32_t     CountComment(const char *pLine, int32_t len);</span>
<a href="#l21.71"></a><span id="l21.71" class="difflineminus">-  static int32_t     CountAngle(const char *pLine, int32_t len);</span>
<a href="#l21.72"></a><span id="l21.72" class="difflineminus">-</span>
<a href="#l21.73"></a><span id="l21.73" class="difflineminus">-private:</span>
<a href="#l21.74"></a><span id="l21.74" class="difflineminus">-  nsTArray&lt;CAliasEntry*&gt;  m_alias;</span>
<a href="#l21.75"></a><span id="l21.75" class="difflineminus">-};</span>
<a href="#l21.76"></a><span id="l21.76" class="difflineminus">-</span>
<a href="#l21.77"></a><span id="l21.77" class="difflineminus">-</span>
<a href="#l21.78"></a><span id="l21.78" class="difflineminus">-</span>
<a href="#l21.79"></a><span id="l21.79" class="difflineminus">-#endif /* nsEudoraAddress_h__ */</span>
<a href="#l21.80"></a><span id="l21.80" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1">deleted file mode 100644</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineminus">--- a/mailnews/import/eudora/src/nsEudoraCompose.cpp</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineplus">+++ /dev/null</span>
<a href="#l22.4"></a><span id="l22.4" class="difflineat">@@ -1,1088 +0,0 @@</span>
<a href="#l22.5"></a><span id="l22.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-</span>
<a href="#l22.6"></a><span id="l22.6" class="difflineminus">- *</span>
<a href="#l22.7"></a><span id="l22.7" class="difflineminus">- * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l22.8"></a><span id="l22.8" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l22.9"></a><span id="l22.9" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l22.10"></a><span id="l22.10" class="difflineminus">-</span>
<a href="#l22.11"></a><span id="l22.11" class="difflineminus">-#include &quot;nscore.h&quot;</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-#include &quot;prthread.h&quot;</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineminus">-#include &quot;nsStringGlue.h&quot;</span>
<a href="#l22.14"></a><span id="l22.14" class="difflineminus">-#include &quot;nsMsgUtils.h&quot;</span>
<a href="#l22.15"></a><span id="l22.15" class="difflineminus">-#include &quot;nsUnicharUtils.h&quot;</span>
<a href="#l22.16"></a><span id="l22.16" class="difflineminus">-#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l22.17"></a><span id="l22.17" class="difflineminus">-#include &quot;nsIComponentManager.h&quot;</span>
<a href="#l22.18"></a><span id="l22.18" class="difflineminus">-#include &quot;nsIServiceManager.h&quot;</span>
<a href="#l22.19"></a><span id="l22.19" class="difflineminus">-#include &quot;nsIIOService.h&quot;</span>
<a href="#l22.20"></a><span id="l22.20" class="difflineminus">-#include &quot;nsIURI.h&quot;</span>
<a href="#l22.21"></a><span id="l22.21" class="difflineminus">-#include &quot;nsIOutputStream.h&quot;</span>
<a href="#l22.22"></a><span id="l22.22" class="difflineminus">-#include &quot;nsThreadUtils.h&quot;</span>
<a href="#l22.23"></a><span id="l22.23" class="difflineminus">-</span>
<a href="#l22.24"></a><span id="l22.24" class="difflineminus">-#include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l22.25"></a><span id="l22.25" class="difflineminus">-#include &quot;nsMsgCompCID.h&quot;</span>
<a href="#l22.26"></a><span id="l22.26" class="difflineminus">-</span>
<a href="#l22.27"></a><span id="l22.27" class="difflineminus">-#include &quot;nsIMsgCompose.h&quot;</span>
<a href="#l22.28"></a><span id="l22.28" class="difflineminus">-#include &quot;nsIMsgCompFields.h&quot;</span>
<a href="#l22.29"></a><span id="l22.29" class="difflineminus">-#include &quot;nsIMsgSend.h&quot;</span>
<a href="#l22.30"></a><span id="l22.30" class="difflineminus">-#include &quot;nsIMsgAccountManager.h&quot;</span>
<a href="#l22.31"></a><span id="l22.31" class="difflineminus">-#include &quot;nsMsgI18N.h&quot;</span>
<a href="#l22.32"></a><span id="l22.32" class="difflineminus">-</span>
<a href="#l22.33"></a><span id="l22.33" class="difflineminus">-#include &quot;nsNetCID.h&quot;</span>
<a href="#l22.34"></a><span id="l22.34" class="difflineminus">-</span>
<a href="#l22.35"></a><span id="l22.35" class="difflineminus">-#include &quot;nsEudoraCompose.h&quot;</span>
<a href="#l22.36"></a><span id="l22.36" class="difflineminus">-#include &quot;nsEudoraEditor.h&quot;</span>
<a href="#l22.37"></a><span id="l22.37" class="difflineminus">-</span>
<a href="#l22.38"></a><span id="l22.38" class="difflineminus">-#include &quot;EudoraDebugLog.h&quot;</span>
<a href="#l22.39"></a><span id="l22.39" class="difflineminus">-</span>
<a href="#l22.40"></a><span id="l22.40" class="difflineminus">-#include &quot;nsMimeTypes.h&quot;</span>
<a href="#l22.41"></a><span id="l22.41" class="difflineminus">-#include &quot;nsCRT.h&quot;</span>
<a href="#l22.42"></a><span id="l22.42" class="difflineminus">-#include &quot;nsNetUtil.h&quot;</span>
<a href="#l22.43"></a><span id="l22.43" class="difflineminus">-#include &quot;nsAutoPtr.h&quot;</span>
<a href="#l22.44"></a><span id="l22.44" class="difflineminus">-#include &quot;nsIMutableArray.h&quot;</span>
<a href="#l22.45"></a><span id="l22.45" class="difflineminus">-</span>
<a href="#l22.46"></a><span id="l22.46" class="difflineminus">-static NS_DEFINE_CID(kMsgSendCID, NS_MSGSEND_CID);</span>
<a href="#l22.47"></a><span id="l22.47" class="difflineminus">-static NS_DEFINE_CID(kMsgCompFieldsCID, NS_MSGCOMPFIELDS_CID);</span>
<a href="#l22.48"></a><span id="l22.48" class="difflineminus">-</span>
<a href="#l22.49"></a><span id="l22.49" class="difflineminus">-// We need to do some calculations to set these numbers to something reasonable!</span>
<a href="#l22.50"></a><span id="l22.50" class="difflineminus">-// Unless of course, CreateAndSendMessage will NEVER EVER leave us in the lurch</span>
<a href="#l22.51"></a><span id="l22.51" class="difflineminus">-#define kHungCount 100000</span>
<a href="#l22.52"></a><span id="l22.52" class="difflineminus">-#define kHungAbortCount 1000</span>
<a href="#l22.53"></a><span id="l22.53" class="difflineminus">-</span>
<a href="#l22.54"></a><span id="l22.54" class="difflineminus">-// Define maximum possible length for content type sanity check</span>
<a href="#l22.55"></a><span id="l22.55" class="difflineminus">-#define kContentTypeLengthSanityCheck 32</span>
<a href="#l22.56"></a><span id="l22.56" class="difflineminus">-</span>
<a href="#l22.57"></a><span id="l22.57" class="difflineminus">-</span>
<a href="#l22.58"></a><span id="l22.58" class="difflineminus">-#ifdef IMPORT_DEBUG</span>
<a href="#l22.59"></a><span id="l22.59" class="difflineminus">-static char *p_test_headers =</span>
<a href="#l22.60"></a><span id="l22.60" class="difflineminus">-&quot;Received: from netppl.invalid (IDENT:monitor@get.freebsd.because.microsoftsucks.invalid [209.3.31.115])\n\</span>
<a href="#l22.61"></a><span id="l22.61" class="difflineminus">- by mail4.sirius.invalid (8.9.1/8.9.1) with SMTP id PAA27232;\n\</span>
<a href="#l22.62"></a><span id="l22.62" class="difflineminus">- Mon, 17 May 1999 15:27:43 -0700 (PDT)\n\</span>
<a href="#l22.63"></a><span id="l22.63" class="difflineminus">-Message-ID: &lt;ikGD3jRTsKklU.Ggm2HmE2A1Jsqd0p@netppl.invalid&gt;\n\</span>
<a href="#l22.64"></a><span id="l22.64" class="difflineminus">-From: \&quot;adsales@qualityservice.invalid\&quot; &lt;adsales@qualityservice.invalid&gt;\n\</span>
<a href="#l22.65"></a><span id="l22.65" class="difflineminus">-Subject: Re: Your College Diploma (36822)\n\</span>
<a href="#l22.66"></a><span id="l22.66" class="difflineminus">-Date: Mon, 17 May 1999 15:09:29 -0400 (EDT)\n\</span>
<a href="#l22.67"></a><span id="l22.67" class="difflineminus">-MIME-Version: 1.0\n\</span>
<a href="#l22.68"></a><span id="l22.68" class="difflineminus">-Content-Type: TEXT/PLAIN; charset=\&quot;US-ASCII\&quot;\n\</span>
<a href="#l22.69"></a><span id="l22.69" class="difflineminus">-Content-Transfer-Encoding: 7bit\n\</span>
<a href="#l22.70"></a><span id="l22.70" class="difflineminus">-X-UIDL: 19990517.152941\n\</span>
<a href="#l22.71"></a><span id="l22.71" class="difflineminus">-Status: RO&quot;;</span>
<a href="#l22.72"></a><span id="l22.72" class="difflineminus">-</span>
<a href="#l22.73"></a><span id="l22.73" class="difflineminus">-static char *p_test_body =</span>
<a href="#l22.74"></a><span id="l22.74" class="difflineminus">-&quot;Hello world?\n\</span>
<a href="#l22.75"></a><span id="l22.75" class="difflineminus">-&quot;;</span>
<a href="#l22.76"></a><span id="l22.76" class="difflineminus">-#else</span>
<a href="#l22.77"></a><span id="l22.77" class="difflineminus">-#define p_test_headers nullptr</span>
<a href="#l22.78"></a><span id="l22.78" class="difflineminus">-#define p_test_body nullptr</span>
<a href="#l22.79"></a><span id="l22.79" class="difflineminus">-#endif</span>
<a href="#l22.80"></a><span id="l22.80" class="difflineminus">-</span>
<a href="#l22.81"></a><span id="l22.81" class="difflineminus">-</span>
<a href="#l22.82"></a><span id="l22.82" class="difflineminus">-#define kWhitespace &quot;\b\t\r\n &quot;</span>
<a href="#l22.83"></a><span id="l22.83" class="difflineminus">-</span>
<a href="#l22.84"></a><span id="l22.84" class="difflineminus">-// The identity that we use in SendTheMessage is now a static. Previously the</span>
<a href="#l22.85"></a><span id="l22.85" class="difflineminus">-// identity was being created and destroyed for every Eudora message imported.</span>
<a href="#l22.86"></a><span id="l22.86" class="difflineminus">-// Now we create the identity when needed and keep it around until ReleaseIdentity</span>
<a href="#l22.87"></a><span id="l22.87" class="difflineminus">-// is called (after Eudora email importing is complete - currently called in</span>
<a href="#l22.88"></a><span id="l22.88" class="difflineminus">-// ~ImportEudoraMailImpl).</span>
<a href="#l22.89"></a><span id="l22.89" class="difflineminus">-//</span>
<a href="#l22.90"></a><span id="l22.90" class="difflineminus">-// This change was identified via profiling and has sped up importing email</span>
<a href="#l22.91"></a><span id="l22.91" class="difflineminus">-// from Eudora over 5x on my computer (test importing of my email went from</span>
<a href="#l22.92"></a><span id="l22.92" class="difflineminus">-// 6.5 hours to less than 1.2 hours). Importing from Eudora is still slow</span>
<a href="#l22.93"></a><span id="l22.93" class="difflineminus">-// in my opinion, but bearably slow now.</span>
<a href="#l22.94"></a><span id="l22.94" class="difflineminus">-nsIMsgIdentity * nsEudoraCompose::s_pIdentity = nullptr;</span>
<a href="#l22.95"></a><span id="l22.95" class="difflineminus">-</span>
<a href="#l22.96"></a><span id="l22.96" class="difflineminus">-</span>
<a href="#l22.97"></a><span id="l22.97" class="difflineminus">-// First off, a listener</span>
<a href="#l22.98"></a><span id="l22.98" class="difflineminus">-class EudoraSendListener : public nsIMsgSendListener</span>
<a href="#l22.99"></a><span id="l22.99" class="difflineminus">-{</span>
<a href="#l22.100"></a><span id="l22.100" class="difflineminus">-public:</span>
<a href="#l22.101"></a><span id="l22.101" class="difflineminus">-  EudoraSendListener() {</span>
<a href="#l22.102"></a><span id="l22.102" class="difflineminus">-    m_done = false;</span>
<a href="#l22.103"></a><span id="l22.103" class="difflineminus">-  }</span>
<a href="#l22.104"></a><span id="l22.104" class="difflineminus">-</span>
<a href="#l22.105"></a><span id="l22.105" class="difflineminus">-  // nsISupports interface</span>
<a href="#l22.106"></a><span id="l22.106" class="difflineminus">-  NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l22.107"></a><span id="l22.107" class="difflineminus">-</span>
<a href="#l22.108"></a><span id="l22.108" class="difflineminus">-  /* void OnStartSending (in string aMsgID, in uint32_t aMsgSize); */</span>
<a href="#l22.109"></a><span id="l22.109" class="difflineminus">-  NS_IMETHOD OnStartSending(const char *aMsgID, uint32_t aMsgSize) {return NS_OK;}</span>
<a href="#l22.110"></a><span id="l22.110" class="difflineminus">-</span>
<a href="#l22.111"></a><span id="l22.111" class="difflineminus">-  /* void OnProgress (in string aMsgID, in uint32_t aProgress, in uint32_t aProgressMax); */</span>
<a href="#l22.112"></a><span id="l22.112" class="difflineminus">-  NS_IMETHOD OnProgress(const char *aMsgID, uint32_t aProgress, uint32_t aProgressMax) {return NS_OK;}</span>
<a href="#l22.113"></a><span id="l22.113" class="difflineminus">-</span>
<a href="#l22.114"></a><span id="l22.114" class="difflineminus">-  /* void OnStatus (in string aMsgID, in wstring aMsg); */</span>
<a href="#l22.115"></a><span id="l22.115" class="difflineminus">-  NS_IMETHOD OnStatus(const char *aMsgID, const char16_t *aMsg) {return NS_OK;}</span>
<a href="#l22.116"></a><span id="l22.116" class="difflineminus">-</span>
<a href="#l22.117"></a><span id="l22.117" class="difflineminus">-  /* void OnStopSending (in string aMsgID, in nsresult aStatus, in wstring aMsg, in nsIFile returnFile); */</span>
<a href="#l22.118"></a><span id="l22.118" class="difflineminus">-  NS_IMETHOD OnStopSending(const char *aMsgID, nsresult aStatus, const char16_t *aMsg,</span>
<a href="#l22.119"></a><span id="l22.119" class="difflineminus">-               nsIFile *returnFile) {</span>
<a href="#l22.120"></a><span id="l22.120" class="difflineminus">-    m_done = true;</span>
<a href="#l22.121"></a><span id="l22.121" class="difflineminus">-    m_location = returnFile;</span>
<a href="#l22.122"></a><span id="l22.122" class="difflineminus">-    return NS_OK;</span>
<a href="#l22.123"></a><span id="l22.123" class="difflineminus">-  }</span>
<a href="#l22.124"></a><span id="l22.124" class="difflineminus">-</span>
<a href="#l22.125"></a><span id="l22.125" class="difflineminus">-    /* void OnSendNotPerformed */</span>
<a href="#l22.126"></a><span id="l22.126" class="difflineminus">-    NS_IMETHOD OnSendNotPerformed(const char *aMsgID, nsresult aStatus) {return NS_OK;}</span>
<a href="#l22.127"></a><span id="l22.127" class="difflineminus">-</span>
<a href="#l22.128"></a><span id="l22.128" class="difflineminus">-  /* void OnGetDraftFolderURI (); */</span>
<a href="#l22.129"></a><span id="l22.129" class="difflineminus">-  NS_IMETHOD OnGetDraftFolderURI(const char *aFolderURI) {return NS_OK;}</span>
<a href="#l22.130"></a><span id="l22.130" class="difflineminus">-</span>
<a href="#l22.131"></a><span id="l22.131" class="difflineminus">-  static nsresult CreateSendListener(nsIMsgSendListener **ppListener);</span>
<a href="#l22.132"></a><span id="l22.132" class="difflineminus">-</span>
<a href="#l22.133"></a><span id="l22.133" class="difflineminus">-  void Reset() { m_done = false;  m_location = nullptr;}</span>
<a href="#l22.134"></a><span id="l22.134" class="difflineminus">-</span>
<a href="#l22.135"></a><span id="l22.135" class="difflineminus">-public:</span>
<a href="#l22.136"></a><span id="l22.136" class="difflineminus">-  bool m_done;</span>
<a href="#l22.137"></a><span id="l22.137" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; m_location;</span>
<a href="#l22.138"></a><span id="l22.138" class="difflineminus">-</span>
<a href="#l22.139"></a><span id="l22.139" class="difflineminus">-private:</span>
<a href="#l22.140"></a><span id="l22.140" class="difflineminus">-  virtual ~EudoraSendListener() {}</span>
<a href="#l22.141"></a><span id="l22.141" class="difflineminus">-};</span>
<a href="#l22.142"></a><span id="l22.142" class="difflineminus">-</span>
<a href="#l22.143"></a><span id="l22.143" class="difflineminus">-</span>
<a href="#l22.144"></a><span id="l22.144" class="difflineminus">-NS_IMPL_ISUPPORTS(EudoraSendListener, nsIMsgSendListener)</span>
<a href="#l22.145"></a><span id="l22.145" class="difflineminus">-</span>
<a href="#l22.146"></a><span id="l22.146" class="difflineminus">-nsresult EudoraSendListener::CreateSendListener(nsIMsgSendListener **ppListener)</span>
<a href="#l22.147"></a><span id="l22.147" class="difflineminus">-{</span>
<a href="#l22.148"></a><span id="l22.148" class="difflineminus">-  NS_ENSURE_ARG_POINTER(ppListener);</span>
<a href="#l22.149"></a><span id="l22.149" class="difflineminus">-  *ppListener = new EudoraSendListener();</span>
<a href="#l22.150"></a><span id="l22.150" class="difflineminus">-  NS_ENSURE_TRUE(*ppListener, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l22.151"></a><span id="l22.151" class="difflineminus">-  NS_ADDREF(*ppListener);</span>
<a href="#l22.152"></a><span id="l22.152" class="difflineminus">-  return NS_OK;</span>
<a href="#l22.153"></a><span id="l22.153" class="difflineminus">-}</span>
<a href="#l22.154"></a><span id="l22.154" class="difflineminus">-</span>
<a href="#l22.155"></a><span id="l22.155" class="difflineminus">-</span>
<a href="#l22.156"></a><span id="l22.156" class="difflineminus">-/////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l22.157"></a><span id="l22.157" class="difflineminus">-/////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l22.158"></a><span id="l22.158" class="difflineminus">-/////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l22.159"></a><span id="l22.159" class="difflineminus">-/////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l22.160"></a><span id="l22.160" class="difflineminus">-</span>
<a href="#l22.161"></a><span id="l22.161" class="difflineminus">-</span>
<a href="#l22.162"></a><span id="l22.162" class="difflineminus">-</span>
<a href="#l22.163"></a><span id="l22.163" class="difflineminus">-nsEudoraCompose::nsEudoraCompose()</span>
<a href="#l22.164"></a><span id="l22.164" class="difflineminus">-{</span>
<a href="#l22.165"></a><span id="l22.165" class="difflineminus">-  m_pAttachments = nullptr;</span>
<a href="#l22.166"></a><span id="l22.166" class="difflineminus">-  m_pListener = nullptr;</span>
<a href="#l22.167"></a><span id="l22.167" class="difflineminus">-  m_pMsgFields = nullptr;</span>
<a href="#l22.168"></a><span id="l22.168" class="difflineminus">-  m_pHeaders = p_test_headers;</span>
<a href="#l22.169"></a><span id="l22.169" class="difflineminus">-  if (m_pHeaders)</span>
<a href="#l22.170"></a><span id="l22.170" class="difflineminus">-    m_headerLen = strlen(m_pHeaders);</span>
<a href="#l22.171"></a><span id="l22.171" class="difflineminus">-  else</span>
<a href="#l22.172"></a><span id="l22.172" class="difflineminus">-    m_headerLen = 0;</span>
<a href="#l22.173"></a><span id="l22.173" class="difflineminus">-  m_pBody = p_test_body;</span>
<a href="#l22.174"></a><span id="l22.174" class="difflineminus">-  if (m_pBody)</span>
<a href="#l22.175"></a><span id="l22.175" class="difflineminus">-    m_bodyLen = strlen(m_pBody);</span>
<a href="#l22.176"></a><span id="l22.176" class="difflineminus">-  else</span>
<a href="#l22.177"></a><span id="l22.177" class="difflineminus">-    m_bodyLen = 0;</span>
<a href="#l22.178"></a><span id="l22.178" class="difflineminus">-</span>
<a href="#l22.179"></a><span id="l22.179" class="difflineminus">-  m_readHeaders.m_convertCRs = true;</span>
<a href="#l22.180"></a><span id="l22.180" class="difflineminus">-}</span>
<a href="#l22.181"></a><span id="l22.181" class="difflineminus">-</span>
<a href="#l22.182"></a><span id="l22.182" class="difflineminus">-</span>
<a href="#l22.183"></a><span id="l22.183" class="difflineminus">-nsEudoraCompose::~nsEudoraCompose()</span>
<a href="#l22.184"></a><span id="l22.184" class="difflineminus">-{</span>
<a href="#l22.185"></a><span id="l22.185" class="difflineminus">-  NS_IF_RELEASE(m_pListener);</span>
<a href="#l22.186"></a><span id="l22.186" class="difflineminus">-  NS_IF_RELEASE(m_pMsgFields);</span>
<a href="#l22.187"></a><span id="l22.187" class="difflineminus">-}</span>
<a href="#l22.188"></a><span id="l22.188" class="difflineminus">-</span>
<a href="#l22.189"></a><span id="l22.189" class="difflineminus">-nsresult nsEudoraCompose::CreateIdentity(void)</span>
<a href="#l22.190"></a><span id="l22.190" class="difflineminus">-{</span>
<a href="#l22.191"></a><span id="l22.191" class="difflineminus">-  if (s_pIdentity)</span>
<a href="#l22.192"></a><span id="l22.192" class="difflineminus">-    return NS_OK;</span>
<a href="#l22.193"></a><span id="l22.193" class="difflineminus">-</span>
<a href="#l22.194"></a><span id="l22.194" class="difflineminus">-  // Should only create identity from main thread</span>
<a href="#l22.195"></a><span id="l22.195" class="difflineminus">-  NS_ENSURE_TRUE(NS_IsMainThread(), NS_ERROR_FAILURE);</span>
<a href="#l22.196"></a><span id="l22.196" class="difflineminus">-  nsresult rv;</span>
<a href="#l22.197"></a><span id="l22.197" class="difflineminus">-  nsCOMPtr&lt;nsIMsgAccountManager&gt; accMgr(do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv));</span>
<a href="#l22.198"></a><span id="l22.198" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.199"></a><span id="l22.199" class="difflineminus">-</span>
<a href="#l22.200"></a><span id="l22.200" class="difflineminus">-  rv = accMgr-&gt;CreateIdentity(&amp;s_pIdentity);</span>
<a href="#l22.201"></a><span id="l22.201" class="difflineminus">-  nsString name(NS_LITERAL_STRING(&quot;Import Identity&quot;));</span>
<a href="#l22.202"></a><span id="l22.202" class="difflineminus">-  if (s_pIdentity) {</span>
<a href="#l22.203"></a><span id="l22.203" class="difflineminus">-    s_pIdentity-&gt;SetFullName(name);</span>
<a href="#l22.204"></a><span id="l22.204" class="difflineminus">-    s_pIdentity-&gt;SetIdentityName(name);</span>
<a href="#l22.205"></a><span id="l22.205" class="difflineminus">-    s_pIdentity-&gt;SetEmail(NS_LITERAL_CSTRING(&quot;import@import.service&quot;));</span>
<a href="#l22.206"></a><span id="l22.206" class="difflineminus">-</span>
<a href="#l22.207"></a><span id="l22.207" class="difflineminus">-    // SetDoFcc to false to save time when CreateAndSendMessage operates.</span>
<a href="#l22.208"></a><span id="l22.208" class="difflineminus">-    // Profiling revealed that GetFolderURIFromUserPrefs was taking up a significant chunk</span>
<a href="#l22.209"></a><span id="l22.209" class="difflineminus">-    // of time during the operation of CreateAndSendMessage. By calling SetDoFcc(false),</span>
<a href="#l22.210"></a><span id="l22.210" class="difflineminus">-    // we skip Fcc handling code inside of InitCompositionFields (called indirectly during</span>
<a href="#l22.211"></a><span id="l22.211" class="difflineminus">-    // CreateAndSendMessage operation). There's no point in any Fcc code firing since the</span>
<a href="#l22.212"></a><span id="l22.212" class="difflineminus">-    // message will never actually be sent anyway.</span>
<a href="#l22.213"></a><span id="l22.213" class="difflineminus">-    s_pIdentity-&gt;SetDoFcc(false);</span>
<a href="#l22.214"></a><span id="l22.214" class="difflineminus">-  }</span>
<a href="#l22.215"></a><span id="l22.215" class="difflineminus">-  return rv;</span>
<a href="#l22.216"></a><span id="l22.216" class="difflineminus">-}</span>
<a href="#l22.217"></a><span id="l22.217" class="difflineminus">-</span>
<a href="#l22.218"></a><span id="l22.218" class="difflineminus">-void nsEudoraCompose::ReleaseIdentity(void)</span>
<a href="#l22.219"></a><span id="l22.219" class="difflineminus">-{</span>
<a href="#l22.220"></a><span id="l22.220" class="difflineminus">-  if (s_pIdentity) {</span>
<a href="#l22.221"></a><span id="l22.221" class="difflineminus">-    nsresult rv = s_pIdentity-&gt;ClearAllValues();</span>
<a href="#l22.222"></a><span id="l22.222" class="difflineminus">-    NS_ASSERTION(NS_SUCCEEDED(rv),&quot;failed to clear values&quot;);</span>
<a href="#l22.223"></a><span id="l22.223" class="difflineminus">-    if (NS_FAILED(rv)) return;</span>
<a href="#l22.224"></a><span id="l22.224" class="difflineminus">-</span>
<a href="#l22.225"></a><span id="l22.225" class="difflineminus">-    NS_RELEASE(s_pIdentity);</span>
<a href="#l22.226"></a><span id="l22.226" class="difflineminus">-  }</span>
<a href="#l22.227"></a><span id="l22.227" class="difflineminus">-}</span>
<a href="#l22.228"></a><span id="l22.228" class="difflineminus">-</span>
<a href="#l22.229"></a><span id="l22.229" class="difflineminus">-</span>
<a href="#l22.230"></a><span id="l22.230" class="difflineminus">-nsresult nsEudoraCompose::CreateComponents(void)</span>
<a href="#l22.231"></a><span id="l22.231" class="difflineminus">-{</span>
<a href="#l22.232"></a><span id="l22.232" class="difflineminus">-  nsresult  rv = NS_OK;</span>
<a href="#l22.233"></a><span id="l22.233" class="difflineminus">-</span>
<a href="#l22.234"></a><span id="l22.234" class="difflineminus">-  if (!m_pIOService) {</span>
<a href="#l22.235"></a><span id="l22.235" class="difflineminus">-    IMPORT_LOG0(&quot;Creating nsIOService\n&quot;);</span>
<a href="#l22.236"></a><span id="l22.236" class="difflineminus">-    </span>
<a href="#l22.237"></a><span id="l22.237" class="difflineminus">-    m_pIOService = do_GetService(NS_IOSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l22.238"></a><span id="l22.238" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.239"></a><span id="l22.239" class="difflineminus">-  }</span>
<a href="#l22.240"></a><span id="l22.240" class="difflineminus">-</span>
<a href="#l22.241"></a><span id="l22.241" class="difflineminus">-  NS_IF_RELEASE(m_pMsgFields);</span>
<a href="#l22.242"></a><span id="l22.242" class="difflineminus">-  if (!m_pListener &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l22.243"></a><span id="l22.243" class="difflineminus">-    rv = EudoraSendListener::CreateSendListener(&amp;m_pListener);</span>
<a href="#l22.244"></a><span id="l22.244" class="difflineminus">-</span>
<a href="#l22.245"></a><span id="l22.245" class="difflineminus">-  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l22.246"></a><span id="l22.246" class="difflineminus">-      rv = CallCreateInstance(kMsgCompFieldsCID, &amp;m_pMsgFields);</span>
<a href="#l22.247"></a><span id="l22.247" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; m_pMsgFields) {</span>
<a href="#l22.248"></a><span id="l22.248" class="difflineminus">-      // IMPORT_LOG0(&quot;nsOutlookCompose - CreateComponents succeeded\n&quot;);</span>
<a href="#l22.249"></a><span id="l22.249" class="difflineminus">-      m_pMsgFields-&gt;SetForcePlainText(false);</span>
<a href="#l22.250"></a><span id="l22.250" class="difflineminus">-      return NS_OK;</span>
<a href="#l22.251"></a><span id="l22.251" class="difflineminus">-    }</span>
<a href="#l22.252"></a><span id="l22.252" class="difflineminus">-  }</span>
<a href="#l22.253"></a><span id="l22.253" class="difflineminus">-</span>
<a href="#l22.254"></a><span id="l22.254" class="difflineminus">-  return NS_ERROR_FAILURE;</span>
<a href="#l22.255"></a><span id="l22.255" class="difflineminus">-}</span>
<a href="#l22.256"></a><span id="l22.256" class="difflineminus">-</span>
<a href="#l22.257"></a><span id="l22.257" class="difflineminus">-void nsEudoraCompose::GetNthHeader(const char *pData,</span>
<a href="#l22.258"></a><span id="l22.258" class="difflineminus">-                                   int32_t dataLen,</span>
<a href="#l22.259"></a><span id="l22.259" class="difflineminus">-                                   int32_t n,</span>
<a href="#l22.260"></a><span id="l22.260" class="difflineminus">-                                   nsCString&amp; header,</span>
<a href="#l22.261"></a><span id="l22.261" class="difflineminus">-                                   nsCString&amp; val,</span>
<a href="#l22.262"></a><span id="l22.262" class="difflineminus">-                                   bool unwrap)</span>
<a href="#l22.263"></a><span id="l22.263" class="difflineminus">-{</span>
<a href="#l22.264"></a><span id="l22.264" class="difflineminus">-  header.Truncate();</span>
<a href="#l22.265"></a><span id="l22.265" class="difflineminus">-  val.Truncate();</span>
<a href="#l22.266"></a><span id="l22.266" class="difflineminus">-  if (!pData)</span>
<a href="#l22.267"></a><span id="l22.267" class="difflineminus">-    return;</span>
<a href="#l22.268"></a><span id="l22.268" class="difflineminus">-</span>
<a href="#l22.269"></a><span id="l22.269" class="difflineminus">-  int32_t index = 0;</span>
<a href="#l22.270"></a><span id="l22.270" class="difflineminus">-  int32_t len;</span>
<a href="#l22.271"></a><span id="l22.271" class="difflineminus">-  int32_t start = 0;</span>
<a href="#l22.272"></a><span id="l22.272" class="difflineminus">-  const char *pChar = pData;</span>
<a href="#l22.273"></a><span id="l22.273" class="difflineminus">-  const char *pStart;</span>
<a href="#l22.274"></a><span id="l22.274" class="difflineminus">-  if (n == 0) {</span>
<a href="#l22.275"></a><span id="l22.275" class="difflineminus">-    pStart = pChar;</span>
<a href="#l22.276"></a><span id="l22.276" class="difflineminus">-    len = 0;</span>
<a href="#l22.277"></a><span id="l22.277" class="difflineminus">-    while ((start &lt; dataLen) &amp;&amp; (*pChar != ':')) {</span>
<a href="#l22.278"></a><span id="l22.278" class="difflineminus">-      start++;</span>
<a href="#l22.279"></a><span id="l22.279" class="difflineminus">-      len++;</span>
<a href="#l22.280"></a><span id="l22.280" class="difflineminus">-      pChar++;</span>
<a href="#l22.281"></a><span id="l22.281" class="difflineminus">-    }</span>
<a href="#l22.282"></a><span id="l22.282" class="difflineminus">-    header.Append(pStart, len);</span>
<a href="#l22.283"></a><span id="l22.283" class="difflineminus">-    header.Trim(kWhitespace);</span>
<a href="#l22.284"></a><span id="l22.284" class="difflineminus">-    start++;</span>
<a href="#l22.285"></a><span id="l22.285" class="difflineminus">-    pChar++;</span>
<a href="#l22.286"></a><span id="l22.286" class="difflineminus">-  }</span>
<a href="#l22.287"></a><span id="l22.287" class="difflineminus">-  else {</span>
<a href="#l22.288"></a><span id="l22.288" class="difflineminus">-    while (start &lt; dataLen) {</span>
<a href="#l22.289"></a><span id="l22.289" class="difflineminus">-      if ((*pChar != ' ') &amp;&amp; (*pChar != '\t')) {</span>
<a href="#l22.290"></a><span id="l22.290" class="difflineminus">-        if (n == index) {</span>
<a href="#l22.291"></a><span id="l22.291" class="difflineminus">-          pStart = pChar;</span>
<a href="#l22.292"></a><span id="l22.292" class="difflineminus">-          len = 0;</span>
<a href="#l22.293"></a><span id="l22.293" class="difflineminus">-          while ((start &lt; dataLen) &amp;&amp; (*pChar != ':')) {</span>
<a href="#l22.294"></a><span id="l22.294" class="difflineminus">-            start++;</span>
<a href="#l22.295"></a><span id="l22.295" class="difflineminus">-            len++;</span>
<a href="#l22.296"></a><span id="l22.296" class="difflineminus">-            pChar++;</span>
<a href="#l22.297"></a><span id="l22.297" class="difflineminus">-          }</span>
<a href="#l22.298"></a><span id="l22.298" class="difflineminus">-          header.Append(pStart, len);</span>
<a href="#l22.299"></a><span id="l22.299" class="difflineminus">-          header.Trim(kWhitespace);</span>
<a href="#l22.300"></a><span id="l22.300" class="difflineminus">-          start++;</span>
<a href="#l22.301"></a><span id="l22.301" class="difflineminus">-          pChar++;</span>
<a href="#l22.302"></a><span id="l22.302" class="difflineminus">-          break;</span>
<a href="#l22.303"></a><span id="l22.303" class="difflineminus">-        }</span>
<a href="#l22.304"></a><span id="l22.304" class="difflineminus">-        else</span>
<a href="#l22.305"></a><span id="l22.305" class="difflineminus">-          index++;</span>
<a href="#l22.306"></a><span id="l22.306" class="difflineminus">-      }</span>
<a href="#l22.307"></a><span id="l22.307" class="difflineminus">-</span>
<a href="#l22.308"></a><span id="l22.308" class="difflineminus">-      // Skip to next end of line.</span>
<a href="#l22.309"></a><span id="l22.309" class="difflineminus">-      while ((start &lt; dataLen) &amp;&amp;</span>
<a href="#l22.310"></a><span id="l22.310" class="difflineminus">-             (*pChar != nsCRT::CR) &amp;&amp; (*pChar != nsCRT::LF)) {</span>
<a href="#l22.311"></a><span id="l22.311" class="difflineminus">-        start++;</span>
<a href="#l22.312"></a><span id="l22.312" class="difflineminus">-        pChar++;</span>
<a href="#l22.313"></a><span id="l22.313" class="difflineminus">-      }</span>
<a href="#l22.314"></a><span id="l22.314" class="difflineminus">-      // Skip over end of line(s).</span>
<a href="#l22.315"></a><span id="l22.315" class="difflineminus">-      while ((start &lt; dataLen) &amp;&amp;</span>
<a href="#l22.316"></a><span id="l22.316" class="difflineminus">-             ((*pChar == nsCRT::CR) || (*pChar == nsCRT::LF))) {</span>
<a href="#l22.317"></a><span id="l22.317" class="difflineminus">-        start++;</span>
<a href="#l22.318"></a><span id="l22.318" class="difflineminus">-        pChar++;</span>
<a href="#l22.319"></a><span id="l22.319" class="difflineminus">-      }</span>
<a href="#l22.320"></a><span id="l22.320" class="difflineminus">-    }</span>
<a href="#l22.321"></a><span id="l22.321" class="difflineminus">-  }</span>
<a href="#l22.322"></a><span id="l22.322" class="difflineminus">-</span>
<a href="#l22.323"></a><span id="l22.323" class="difflineminus">-  if (start &gt;= dataLen)</span>
<a href="#l22.324"></a><span id="l22.324" class="difflineminus">-    return;</span>
<a href="#l22.325"></a><span id="l22.325" class="difflineminus">-</span>
<a href="#l22.326"></a><span id="l22.326" class="difflineminus">-  int32_t lineEnd;</span>
<a href="#l22.327"></a><span id="l22.327" class="difflineminus">-  int32_t end = start;</span>
<a href="#l22.328"></a><span id="l22.328" class="difflineminus">-  while (end &lt; dataLen) {</span>
<a href="#l22.329"></a><span id="l22.329" class="difflineminus">-    // Skip to next end of line.</span>
<a href="#l22.330"></a><span id="l22.330" class="difflineminus">-    while ((end &lt; dataLen) &amp;&amp; (*pChar != nsCRT::CR) &amp;&amp; (*pChar != nsCRT::LF)) {</span>
<a href="#l22.331"></a><span id="l22.331" class="difflineminus">-      end++;</span>
<a href="#l22.332"></a><span id="l22.332" class="difflineminus">-      pChar++;</span>
<a href="#l22.333"></a><span id="l22.333" class="difflineminus">-    }</span>
<a href="#l22.334"></a><span id="l22.334" class="difflineminus">-</span>
<a href="#l22.335"></a><span id="l22.335" class="difflineminus">-    if (end &gt; start) {</span>
<a href="#l22.336"></a><span id="l22.336" class="difflineminus">-      val.Append(pData + start, end - start);</span>
<a href="#l22.337"></a><span id="l22.337" class="difflineminus">-    }</span>
<a href="#l22.338"></a><span id="l22.338" class="difflineminus">-</span>
<a href="#l22.339"></a><span id="l22.339" class="difflineminus">-    lineEnd = end;</span>
<a href="#l22.340"></a><span id="l22.340" class="difflineminus">-    pStart = pChar;</span>
<a href="#l22.341"></a><span id="l22.341" class="difflineminus">-</span>
<a href="#l22.342"></a><span id="l22.342" class="difflineminus">-    // Skip over end of line(s).</span>
<a href="#l22.343"></a><span id="l22.343" class="difflineminus">-    while ((end &lt; dataLen) &amp;&amp;</span>
<a href="#l22.344"></a><span id="l22.344" class="difflineminus">-           ((*pChar == nsCRT::CR) || (*pChar == nsCRT::LF))) {</span>
<a href="#l22.345"></a><span id="l22.345" class="difflineminus">-      end++;</span>
<a href="#l22.346"></a><span id="l22.346" class="difflineminus">-      pChar++;</span>
<a href="#l22.347"></a><span id="l22.347" class="difflineminus">-    }</span>
<a href="#l22.348"></a><span id="l22.348" class="difflineminus">-</span>
<a href="#l22.349"></a><span id="l22.349" class="difflineminus">-    start = end;</span>
<a href="#l22.350"></a><span id="l22.350" class="difflineminus">-</span>
<a href="#l22.351"></a><span id="l22.351" class="difflineminus">-    // Skip over space(s) and tab(s).</span>
<a href="#l22.352"></a><span id="l22.352" class="difflineminus">-    while ((end &lt; dataLen) &amp;&amp; ((*pChar == ' ') || (*pChar == '\t'))) {</span>
<a href="#l22.353"></a><span id="l22.353" class="difflineminus">-      end++;</span>
<a href="#l22.354"></a><span id="l22.354" class="difflineminus">-      pChar++;</span>
<a href="#l22.355"></a><span id="l22.355" class="difflineminus">-    }</span>
<a href="#l22.356"></a><span id="l22.356" class="difflineminus">-</span>
<a href="#l22.357"></a><span id="l22.357" class="difflineminus">-    if (start == end)</span>
<a href="#l22.358"></a><span id="l22.358" class="difflineminus">-      break;</span>
<a href="#l22.359"></a><span id="l22.359" class="difflineminus">-</span>
<a href="#l22.360"></a><span id="l22.360" class="difflineminus">-    if (unwrap)</span>
<a href="#l22.361"></a><span id="l22.361" class="difflineminus">-      val.Append(' ');</span>
<a href="#l22.362"></a><span id="l22.362" class="difflineminus">-    else {</span>
<a href="#l22.363"></a><span id="l22.363" class="difflineminus">-      val.Append(pStart, end - lineEnd);</span>
<a href="#l22.364"></a><span id="l22.364" class="difflineminus">-    }</span>
<a href="#l22.365"></a><span id="l22.365" class="difflineminus">-</span>
<a href="#l22.366"></a><span id="l22.366" class="difflineminus">-    start = end;</span>
<a href="#l22.367"></a><span id="l22.367" class="difflineminus">-  }</span>
<a href="#l22.368"></a><span id="l22.368" class="difflineminus">-</span>
<a href="#l22.369"></a><span id="l22.369" class="difflineminus">-  val.Trim(kWhitespace);</span>
<a href="#l22.370"></a><span id="l22.370" class="difflineminus">-}</span>
<a href="#l22.371"></a><span id="l22.371" class="difflineminus">-</span>
<a href="#l22.372"></a><span id="l22.372" class="difflineminus">-</span>
<a href="#l22.373"></a><span id="l22.373" class="difflineminus">-void nsEudoraCompose::GetHeaderValue(const char *pData,</span>
<a href="#l22.374"></a><span id="l22.374" class="difflineminus">-                                     int32_t dataLen,</span>
<a href="#l22.375"></a><span id="l22.375" class="difflineminus">-                                     const char *pHeader,</span>
<a href="#l22.376"></a><span id="l22.376" class="difflineminus">-                                     nsCString&amp; val,</span>
<a href="#l22.377"></a><span id="l22.377" class="difflineminus">-                                     bool unwrap)</span>
<a href="#l22.378"></a><span id="l22.378" class="difflineminus">-{</span>
<a href="#l22.379"></a><span id="l22.379" class="difflineminus">-  val.Truncate();</span>
<a href="#l22.380"></a><span id="l22.380" class="difflineminus">-  if (!pData)</span>
<a href="#l22.381"></a><span id="l22.381" class="difflineminus">-    return;</span>
<a href="#l22.382"></a><span id="l22.382" class="difflineminus">-</span>
<a href="#l22.383"></a><span id="l22.383" class="difflineminus">-  int32_t  start = 0;</span>
<a href="#l22.384"></a><span id="l22.384" class="difflineminus">-  int32_t len = strlen(pHeader);</span>
<a href="#l22.385"></a><span id="l22.385" class="difflineminus">-  const char *pChar = pData;</span>
<a href="#l22.386"></a><span id="l22.386" class="difflineminus">-  if (!PL_strncasecmp(pHeader, pData, len)) {</span>
<a href="#l22.387"></a><span id="l22.387" class="difflineminus">-    start = len;</span>
<a href="#l22.388"></a><span id="l22.388" class="difflineminus">-  }</span>
<a href="#l22.389"></a><span id="l22.389" class="difflineminus">-  else {</span>
<a href="#l22.390"></a><span id="l22.390" class="difflineminus">-    while (start &lt; dataLen) {</span>
<a href="#l22.391"></a><span id="l22.391" class="difflineminus">-      // Skip to next end of line.</span>
<a href="#l22.392"></a><span id="l22.392" class="difflineminus">-      while ((start &lt; dataLen) &amp;&amp;</span>
<a href="#l22.393"></a><span id="l22.393" class="difflineminus">-             (*pChar != nsCRT::CR) &amp;&amp; (*pChar != nsCRT::LF)) {</span>
<a href="#l22.394"></a><span id="l22.394" class="difflineminus">-        start++;</span>
<a href="#l22.395"></a><span id="l22.395" class="difflineminus">-        pChar++;</span>
<a href="#l22.396"></a><span id="l22.396" class="difflineminus">-      }</span>
<a href="#l22.397"></a><span id="l22.397" class="difflineminus">-      // Skip over end of line(s).</span>
<a href="#l22.398"></a><span id="l22.398" class="difflineminus">-      while ((start &lt; dataLen) &amp;&amp;</span>
<a href="#l22.399"></a><span id="l22.399" class="difflineminus">-             ((*pChar == nsCRT::CR) || (*pChar == nsCRT::LF))) {</span>
<a href="#l22.400"></a><span id="l22.400" class="difflineminus">-        start++;</span>
<a href="#l22.401"></a><span id="l22.401" class="difflineminus">-        pChar++;</span>
<a href="#l22.402"></a><span id="l22.402" class="difflineminus">-      }</span>
<a href="#l22.403"></a><span id="l22.403" class="difflineminus">-</span>
<a href="#l22.404"></a><span id="l22.404" class="difflineminus">-      if ((start &lt; dataLen) &amp;&amp; !PL_strncasecmp(pChar, pHeader, len))</span>
<a href="#l22.405"></a><span id="l22.405" class="difflineminus">-        break;</span>
<a href="#l22.406"></a><span id="l22.406" class="difflineminus">-    }</span>
<a href="#l22.407"></a><span id="l22.407" class="difflineminus">-    if (start &lt; dataLen)</span>
<a href="#l22.408"></a><span id="l22.408" class="difflineminus">-      start += len;</span>
<a href="#l22.409"></a><span id="l22.409" class="difflineminus">-  }</span>
<a href="#l22.410"></a><span id="l22.410" class="difflineminus">-</span>
<a href="#l22.411"></a><span id="l22.411" class="difflineminus">-  if (start &gt;= dataLen)</span>
<a href="#l22.412"></a><span id="l22.412" class="difflineminus">-    return;</span>
<a href="#l22.413"></a><span id="l22.413" class="difflineminus">-</span>
<a href="#l22.414"></a><span id="l22.414" class="difflineminus">-  int32_t end = start;</span>
<a href="#l22.415"></a><span id="l22.415" class="difflineminus">-  int32_t lineEnd;</span>
<a href="#l22.416"></a><span id="l22.416" class="difflineminus">-  const char * pStart;</span>
<a href="#l22.417"></a><span id="l22.417" class="difflineminus">-</span>
<a href="#l22.418"></a><span id="l22.418" class="difflineminus">-  pChar = pData + start;</span>
<a href="#l22.419"></a><span id="l22.419" class="difflineminus">-</span>
<a href="#l22.420"></a><span id="l22.420" class="difflineminus">-  while (end &lt; dataLen) {</span>
<a href="#l22.421"></a><span id="l22.421" class="difflineminus">-    // Skip to next end of line.</span>
<a href="#l22.422"></a><span id="l22.422" class="difflineminus">-    while ((end &lt; dataLen) &amp;&amp; (*pChar != nsCRT::CR) &amp;&amp; (*pChar != nsCRT::LF)) {</span>
<a href="#l22.423"></a><span id="l22.423" class="difflineminus">-      end++;</span>
<a href="#l22.424"></a><span id="l22.424" class="difflineminus">-      pChar++;</span>
<a href="#l22.425"></a><span id="l22.425" class="difflineminus">-    }</span>
<a href="#l22.426"></a><span id="l22.426" class="difflineminus">-</span>
<a href="#l22.427"></a><span id="l22.427" class="difflineminus">-    if (end &gt; start)</span>
<a href="#l22.428"></a><span id="l22.428" class="difflineminus">-      val.Append(pData + start, end - start);</span>
<a href="#l22.429"></a><span id="l22.429" class="difflineminus">-</span>
<a href="#l22.430"></a><span id="l22.430" class="difflineminus">-    lineEnd = end;</span>
<a href="#l22.431"></a><span id="l22.431" class="difflineminus">-    pStart = pChar;</span>
<a href="#l22.432"></a><span id="l22.432" class="difflineminus">-</span>
<a href="#l22.433"></a><span id="l22.433" class="difflineminus">-    // Skip over the end of line(s).</span>
<a href="#l22.434"></a><span id="l22.434" class="difflineminus">-    while ((end &lt; dataLen) &amp;&amp;</span>
<a href="#l22.435"></a><span id="l22.435" class="difflineminus">-           ((*pChar == nsCRT::CR) || (*pChar == nsCRT::LF))) {</span>
<a href="#l22.436"></a><span id="l22.436" class="difflineminus">-      end++;</span>
<a href="#l22.437"></a><span id="l22.437" class="difflineminus">-      pChar++;</span>
<a href="#l22.438"></a><span id="l22.438" class="difflineminus">-    }</span>
<a href="#l22.439"></a><span id="l22.439" class="difflineminus">-</span>
<a href="#l22.440"></a><span id="l22.440" class="difflineminus">-    start = end;</span>
<a href="#l22.441"></a><span id="l22.441" class="difflineminus">-</span>
<a href="#l22.442"></a><span id="l22.442" class="difflineminus">-    // Skip over space(s) and tab(s).</span>
<a href="#l22.443"></a><span id="l22.443" class="difflineminus">-    while ((end &lt; dataLen) &amp;&amp; ((*pChar == ' ') || (*pChar == '\t'))) {</span>
<a href="#l22.444"></a><span id="l22.444" class="difflineminus">-      end++;</span>
<a href="#l22.445"></a><span id="l22.445" class="difflineminus">-      pChar++;</span>
<a href="#l22.446"></a><span id="l22.446" class="difflineminus">-    }</span>
<a href="#l22.447"></a><span id="l22.447" class="difflineminus">-</span>
<a href="#l22.448"></a><span id="l22.448" class="difflineminus">-    if (start == end)</span>
<a href="#l22.449"></a><span id="l22.449" class="difflineminus">-      break;</span>
<a href="#l22.450"></a><span id="l22.450" class="difflineminus">-</span>
<a href="#l22.451"></a><span id="l22.451" class="difflineminus">-    if (unwrap)</span>
<a href="#l22.452"></a><span id="l22.452" class="difflineminus">-      val.Append(' ');</span>
<a href="#l22.453"></a><span id="l22.453" class="difflineminus">-    else {</span>
<a href="#l22.454"></a><span id="l22.454" class="difflineminus">-      val.Append(pStart, end - lineEnd);</span>
<a href="#l22.455"></a><span id="l22.455" class="difflineminus">-    }</span>
<a href="#l22.456"></a><span id="l22.456" class="difflineminus">-</span>
<a href="#l22.457"></a><span id="l22.457" class="difflineminus">-    start = end;</span>
<a href="#l22.458"></a><span id="l22.458" class="difflineminus">-  }</span>
<a href="#l22.459"></a><span id="l22.459" class="difflineminus">-</span>
<a href="#l22.460"></a><span id="l22.460" class="difflineminus">-  val.Trim(kWhitespace);</span>
<a href="#l22.461"></a><span id="l22.461" class="difflineminus">-}</span>
<a href="#l22.462"></a><span id="l22.462" class="difflineminus">-</span>
<a href="#l22.463"></a><span id="l22.463" class="difflineminus">-</span>
<a href="#l22.464"></a><span id="l22.464" class="difflineminus">-void nsEudoraCompose::ExtractCharset(nsString&amp; str)</span>
<a href="#l22.465"></a><span id="l22.465" class="difflineminus">-{</span>
<a href="#l22.466"></a><span id="l22.466" class="difflineminus">-  int32_t idx = MsgFind(str, &quot;charset=&quot;, true, 0);</span>
<a href="#l22.467"></a><span id="l22.467" class="difflineminus">-  if (idx != -1) {</span>
<a href="#l22.468"></a><span id="l22.468" class="difflineminus">-    str.Cut(0, idx + 8);</span>
<a href="#l22.469"></a><span id="l22.469" class="difflineminus">-    idx = str.FindChar(';');</span>
<a href="#l22.470"></a><span id="l22.470" class="difflineminus">-    if (idx != -1)</span>
<a href="#l22.471"></a><span id="l22.471" class="difflineminus">-      str.SetLength(idx);</span>
<a href="#l22.472"></a><span id="l22.472" class="difflineminus">-    str.Trim(kWhitespace);</span>
<a href="#l22.473"></a><span id="l22.473" class="difflineminus">-    if ((str.CharAt(0) == '&quot;') &amp;&amp; (str.Length() &gt; 2)) {</span>
<a href="#l22.474"></a><span id="l22.474" class="difflineminus">-      str.SetLength(str.Length() - 1);</span>
<a href="#l22.475"></a><span id="l22.475" class="difflineminus">-      str.Cut(0, 1);</span>
<a href="#l22.476"></a><span id="l22.476" class="difflineminus">-      str.Trim(kWhitespace);</span>
<a href="#l22.477"></a><span id="l22.477" class="difflineminus">-    }</span>
<a href="#l22.478"></a><span id="l22.478" class="difflineminus">-  }</span>
<a href="#l22.479"></a><span id="l22.479" class="difflineminus">-  else</span>
<a href="#l22.480"></a><span id="l22.480" class="difflineminus">-    str.Truncate();</span>
<a href="#l22.481"></a><span id="l22.481" class="difflineminus">-}</span>
<a href="#l22.482"></a><span id="l22.482" class="difflineminus">-</span>
<a href="#l22.483"></a><span id="l22.483" class="difflineminus">-void nsEudoraCompose::ExtractType(nsString&amp; str)</span>
<a href="#l22.484"></a><span id="l22.484" class="difflineminus">-{</span>
<a href="#l22.485"></a><span id="l22.485" class="difflineminus">-  nsString tStr;</span>
<a href="#l22.486"></a><span id="l22.486" class="difflineminus">-  int32_t idx = str.FindChar(';');</span>
<a href="#l22.487"></a><span id="l22.487" class="difflineminus">-  if (idx != -1)</span>
<a href="#l22.488"></a><span id="l22.488" class="difflineminus">-    str.SetLength(idx);</span>
<a href="#l22.489"></a><span id="l22.489" class="difflineminus">-</span>
<a href="#l22.490"></a><span id="l22.490" class="difflineminus">-  str.Trim(kWhitespace);</span>
<a href="#l22.491"></a><span id="l22.491" class="difflineminus">-</span>
<a href="#l22.492"></a><span id="l22.492" class="difflineminus">-  if ((str.CharAt(0) == '&quot;') &amp;&amp; (str.Length() &gt; 2)) {</span>
<a href="#l22.493"></a><span id="l22.493" class="difflineminus">-    str.SetLength(str.Length() - 1);</span>
<a href="#l22.494"></a><span id="l22.494" class="difflineminus">-    str.Cut(0, 1);</span>
<a href="#l22.495"></a><span id="l22.495" class="difflineminus">-    str.Trim(kWhitespace);</span>
<a href="#l22.496"></a><span id="l22.496" class="difflineminus">-  }</span>
<a href="#l22.497"></a><span id="l22.497" class="difflineminus">-</span>
<a href="#l22.498"></a><span id="l22.498" class="difflineminus">-  // if multipart then ignore it since no outlook message body is ever</span>
<a href="#l22.499"></a><span id="l22.499" class="difflineminus">-  // valid multipart!</span>
<a href="#l22.500"></a><span id="l22.500" class="difflineminus">-  if (StringBeginsWith(str, NS_LITERAL_STRING(&quot;multipart/&quot;), nsCaseInsensitiveStringComparator()))</span>
<a href="#l22.501"></a><span id="l22.501" class="difflineminus">-    str.Truncate();</span>
<a href="#l22.502"></a><span id="l22.502" class="difflineminus">-}</span>
<a href="#l22.503"></a><span id="l22.503" class="difflineminus">-</span>
<a href="#l22.504"></a><span id="l22.504" class="difflineminus">-nsresult nsEudoraCompose::GetLocalAttachments(nsIArray **aArray)</span>
<a href="#l22.505"></a><span id="l22.505" class="difflineminus">-{</span>
<a href="#l22.506"></a><span id="l22.506" class="difflineminus">-  /*</span>
<a href="#l22.507"></a><span id="l22.507" class="difflineminus">-  nsIURI      *url = nullptr;</span>
<a href="#l22.508"></a><span id="l22.508" class="difflineminus">-  */</span>
<a href="#l22.509"></a><span id="l22.509" class="difflineminus">-  nsresult rv;</span>
<a href="#l22.510"></a><span id="l22.510" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; attachments (do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l22.511"></a><span id="l22.511" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.512"></a><span id="l22.512" class="difflineminus">-  NS_IF_ADDREF(*aArray = attachments);</span>
<a href="#l22.513"></a><span id="l22.513" class="difflineminus">-  int32_t count = 0;</span>
<a href="#l22.514"></a><span id="l22.514" class="difflineminus">-  if (m_pAttachments)</span>
<a href="#l22.515"></a><span id="l22.515" class="difflineminus">-    count = m_pAttachments-&gt;Length();</span>
<a href="#l22.516"></a><span id="l22.516" class="difflineminus">-  if (!count)</span>
<a href="#l22.517"></a><span id="l22.517" class="difflineminus">-    return NS_OK;</span>
<a href="#l22.518"></a><span id="l22.518" class="difflineminus">-</span>
<a href="#l22.519"></a><span id="l22.519" class="difflineminus">-  nsCString urlStr;</span>
<a href="#l22.520"></a><span id="l22.520" class="difflineminus">-  ImportAttachment * pAttach;</span>
<a href="#l22.521"></a><span id="l22.521" class="difflineminus">-</span>
<a href="#l22.522"></a><span id="l22.522" class="difflineminus">-  for (int32_t i = 0; i &lt; count; i++) {</span>
<a href="#l22.523"></a><span id="l22.523" class="difflineminus">-    nsCOMPtr&lt;nsIMsgAttachedFile&gt; a(do_CreateInstance(NS_MSGATTACHEDFILE_CONTRACTID, &amp;rv));</span>
<a href="#l22.524"></a><span id="l22.524" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.525"></a><span id="l22.525" class="difflineminus">-    // nsMsgNewURL(&amp;url, &quot;file://C:/boxster.jpg&quot;);</span>
<a href="#l22.526"></a><span id="l22.526" class="difflineminus">-    // a[i].orig_url = url;</span>
<a href="#l22.527"></a><span id="l22.527" class="difflineminus">-</span>
<a href="#l22.528"></a><span id="l22.528" class="difflineminus">-    pAttach = m_pAttachments-&gt;ElementAt(i);</span>
<a href="#l22.529"></a><span id="l22.529" class="difflineminus">-    nsCOMPtr&lt;nsIFile&gt; tmpFile = do_QueryInterface(pAttach-&gt;pAttachment);</span>
<a href="#l22.530"></a><span id="l22.530" class="difflineminus">-    a-&gt;SetTmpFile(tmpFile);</span>
<a href="#l22.531"></a><span id="l22.531" class="difflineminus">-    urlStr.Adopt(0);</span>
<a href="#l22.532"></a><span id="l22.532" class="difflineminus">-</span>
<a href="#l22.533"></a><span id="l22.533" class="difflineminus">-    nsCOMPtr &lt;nsIURI&gt; uri;</span>
<a href="#l22.534"></a><span id="l22.534" class="difflineminus">-    nsresult rv = NS_NewFileURI(getter_AddRefs(uri), pAttach-&gt;pAttachment);</span>
<a href="#l22.535"></a><span id="l22.535" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.536"></a><span id="l22.536" class="difflineminus">-    uri-&gt;GetSpec(urlStr);</span>
<a href="#l22.537"></a><span id="l22.537" class="difflineminus">-    if (urlStr.IsEmpty())</span>
<a href="#l22.538"></a><span id="l22.538" class="difflineminus">-      return NS_ERROR_FAILURE;</span>
<a href="#l22.539"></a><span id="l22.539" class="difflineminus">-</span>
<a href="#l22.540"></a><span id="l22.540" class="difflineminus">-    nsCOMPtr&lt;nsIURI&gt; origUrl;</span>
<a href="#l22.541"></a><span id="l22.541" class="difflineminus">-    rv = m_pIOService-&gt;NewURI(urlStr, nullptr, nullptr, getter_AddRefs(origUrl));</span>
<a href="#l22.542"></a><span id="l22.542" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.543"></a><span id="l22.543" class="difflineminus">-    a-&gt;SetOrigUrl(origUrl);</span>
<a href="#l22.544"></a><span id="l22.544" class="difflineminus">-    a-&gt;SetType(nsDependentCString(pAttach-&gt;mimeType));</span>
<a href="#l22.545"></a><span id="l22.545" class="difflineminus">-    a-&gt;SetRealName(nsDependentCString(pAttach-&gt;description));</span>
<a href="#l22.546"></a><span id="l22.546" class="difflineminus">-    a-&gt;SetEncoding(NS_LITERAL_CSTRING(ENCODING_BINARY));</span>
<a href="#l22.547"></a><span id="l22.547" class="difflineminus">-    attachments-&gt;AppendElement(a, false);</span>
<a href="#l22.548"></a><span id="l22.548" class="difflineminus">-  }</span>
<a href="#l22.549"></a><span id="l22.549" class="difflineminus">-  return NS_OK;</span>
<a href="#l22.550"></a><span id="l22.550" class="difflineminus">-}</span>
<a href="#l22.551"></a><span id="l22.551" class="difflineminus">-</span>
<a href="#l22.552"></a><span id="l22.552" class="difflineminus">-// Test a message send????</span>
<a href="#l22.553"></a><span id="l22.553" class="difflineminus">-nsresult nsEudoraCompose::SendTheMessage(nsIFile *pMailImportLocation, nsIFile **pMsg)</span>
<a href="#l22.554"></a><span id="l22.554" class="difflineminus">-{</span>
<a href="#l22.555"></a><span id="l22.555" class="difflineminus">-  nsresult rv = CreateComponents();</span>
<a href="#l22.556"></a><span id="l22.556" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l22.557"></a><span id="l22.557" class="difflineminus">-    return rv;</span>
<a href="#l22.558"></a><span id="l22.558" class="difflineminus">-</span>
<a href="#l22.559"></a><span id="l22.559" class="difflineminus">-  // IMPORT_LOG0(&quot;Outlook Compose created necessary components\n&quot;);</span>
<a href="#l22.560"></a><span id="l22.560" class="difflineminus">-</span>
<a href="#l22.561"></a><span id="l22.561" class="difflineminus">-  nsString bodyType;</span>
<a href="#l22.562"></a><span id="l22.562" class="difflineminus">-  nsString charSet;</span>
<a href="#l22.563"></a><span id="l22.563" class="difflineminus">-  nsString headerVal;</span>
<a href="#l22.564"></a><span id="l22.564" class="difflineminus">-  GetHeaderValue(m_pHeaders, m_headerLen, &quot;From:&quot;, headerVal);</span>
<a href="#l22.565"></a><span id="l22.565" class="difflineminus">-  if (!headerVal.IsEmpty())</span>
<a href="#l22.566"></a><span id="l22.566" class="difflineminus">-    m_pMsgFields-&gt;SetFrom(headerVal);</span>
<a href="#l22.567"></a><span id="l22.567" class="difflineminus">-  GetHeaderValue(m_pHeaders, m_headerLen, &quot;To:&quot;, headerVal);</span>
<a href="#l22.568"></a><span id="l22.568" class="difflineminus">-  if (!headerVal.IsEmpty())</span>
<a href="#l22.569"></a><span id="l22.569" class="difflineminus">-    m_pMsgFields-&gt;SetTo(headerVal);</span>
<a href="#l22.570"></a><span id="l22.570" class="difflineminus">-  GetHeaderValue(m_pHeaders, m_headerLen, &quot;Subject:&quot;, headerVal);</span>
<a href="#l22.571"></a><span id="l22.571" class="difflineminus">-  if (!headerVal.IsEmpty())</span>
<a href="#l22.572"></a><span id="l22.572" class="difflineminus">-    m_pMsgFields-&gt;SetSubject(headerVal);</span>
<a href="#l22.573"></a><span id="l22.573" class="difflineminus">-  GetHeaderValue(m_pHeaders, m_headerLen, &quot;Content-type:&quot;, headerVal);</span>
<a href="#l22.574"></a><span id="l22.574" class="difflineminus">-  bodyType = headerVal;</span>
<a href="#l22.575"></a><span id="l22.575" class="difflineminus">-  ExtractType(bodyType);</span>
<a href="#l22.576"></a><span id="l22.576" class="difflineminus">-  ExtractCharset(headerVal);</span>
<a href="#l22.577"></a><span id="l22.577" class="difflineminus">-  // Use platform charset as default if the msg doesn't specify one</span>
<a href="#l22.578"></a><span id="l22.578" class="difflineminus">-  // (ie, no 'charset' param in the Content-Type: header). As the last</span>
<a href="#l22.579"></a><span id="l22.579" class="difflineminus">-  // resort we'll use the mail default charset.</span>
<a href="#l22.580"></a><span id="l22.580" class="difflineminus">-  // (ie, no 'charset' param in the Content-Type: header) or if the</span>
<a href="#l22.581"></a><span id="l22.581" class="difflineminus">-  // charset parameter fails a length sanity check.</span>
<a href="#l22.582"></a><span id="l22.582" class="difflineminus">-  // As the last resort we'll use the mail default charset.</span>
<a href="#l22.583"></a><span id="l22.583" class="difflineminus">-  if (headerVal.IsEmpty() || (headerVal.Length() &gt; kContentTypeLengthSanityCheck))</span>
<a href="#l22.584"></a><span id="l22.584" class="difflineminus">-  {</span>
<a href="#l22.585"></a><span id="l22.585" class="difflineminus">-    headerVal.AssignASCII(nsMsgI18NFileSystemCharset());</span>
<a href="#l22.586"></a><span id="l22.586" class="difflineminus">-    if (headerVal.IsEmpty())</span>
<a href="#l22.587"></a><span id="l22.587" class="difflineminus">-    { // last resort</span>
<a href="#l22.588"></a><span id="l22.588" class="difflineminus">-      if (m_defCharset.IsEmpty())</span>
<a href="#l22.589"></a><span id="l22.589" class="difflineminus">-      {</span>
<a href="#l22.590"></a><span id="l22.590" class="difflineminus">-        nsString defaultCharset;</span>
<a href="#l22.591"></a><span id="l22.591" class="difflineminus">-        NS_GetLocalizedUnicharPreferenceWithDefault(nullptr, &quot;mailnews.view_default_charset&quot;,</span>
<a href="#l22.592"></a><span id="l22.592" class="difflineminus">-                                                    NS_LITERAL_STRING(&quot;ISO-8859-1&quot;), defaultCharset);</span>
<a href="#l22.593"></a><span id="l22.593" class="difflineminus">-        m_defCharset = defaultCharset;</span>
<a href="#l22.594"></a><span id="l22.594" class="difflineminus">-      }</span>
<a href="#l22.595"></a><span id="l22.595" class="difflineminus">-      headerVal = m_defCharset;</span>
<a href="#l22.596"></a><span id="l22.596" class="difflineminus">-    }</span>
<a href="#l22.597"></a><span id="l22.597" class="difflineminus">-  }</span>
<a href="#l22.598"></a><span id="l22.598" class="difflineminus">-  m_pMsgFields-&gt;SetCharacterSet(NS_LossyConvertUTF16toASCII(headerVal).get());</span>
<a href="#l22.599"></a><span id="l22.599" class="difflineminus">-  charSet = headerVal;</span>
<a href="#l22.600"></a><span id="l22.600" class="difflineminus">-  GetHeaderValue(m_pHeaders, m_headerLen, &quot;CC:&quot;, headerVal);</span>
<a href="#l22.601"></a><span id="l22.601" class="difflineminus">-  if (!headerVal.IsEmpty())</span>
<a href="#l22.602"></a><span id="l22.602" class="difflineminus">-    m_pMsgFields-&gt;SetCc(headerVal);</span>
<a href="#l22.603"></a><span id="l22.603" class="difflineminus">-  GetHeaderValue(m_pHeaders, m_headerLen, &quot;Message-ID:&quot;, headerVal);</span>
<a href="#l22.604"></a><span id="l22.604" class="difflineminus">-  if (!headerVal.IsEmpty())</span>
<a href="#l22.605"></a><span id="l22.605" class="difflineminus">-    m_pMsgFields-&gt;SetMessageId(NS_LossyConvertUTF16toASCII(headerVal).get());</span>
<a href="#l22.606"></a><span id="l22.606" class="difflineminus">-  GetHeaderValue(m_pHeaders, m_headerLen, &quot;Reply-To:&quot;, headerVal);</span>
<a href="#l22.607"></a><span id="l22.607" class="difflineminus">-  if (!headerVal.IsEmpty())</span>
<a href="#l22.608"></a><span id="l22.608" class="difflineminus">-    m_pMsgFields-&gt;SetReplyTo(headerVal);</span>
<a href="#l22.609"></a><span id="l22.609" class="difflineminus">-</span>
<a href="#l22.610"></a><span id="l22.610" class="difflineminus">-  // what about all of the other headers?!?!?!?!?!?!</span>
<a href="#l22.611"></a><span id="l22.611" class="difflineminus">-  char *pMimeType;</span>
<a href="#l22.612"></a><span id="l22.612" class="difflineminus">-  if (!bodyType.IsEmpty())</span>
<a href="#l22.613"></a><span id="l22.613" class="difflineminus">-    pMimeType = ToNewCString(NS_LossyConvertUTF16toASCII(bodyType));</span>
<a href="#l22.614"></a><span id="l22.614" class="difflineminus">-  else</span>
<a href="#l22.615"></a><span id="l22.615" class="difflineminus">-    pMimeType = ToNewCString(m_bodyType);</span>
<a href="#l22.616"></a><span id="l22.616" class="difflineminus">-</span>
<a href="#l22.617"></a><span id="l22.617" class="difflineminus">-  nsCOMPtr&lt;nsIArray&gt; pAttach;</span>
<a href="#l22.618"></a><span id="l22.618" class="difflineminus">-  GetLocalAttachments(getter_AddRefs(pAttach));</span>
<a href="#l22.619"></a><span id="l22.619" class="difflineminus">-  nsEudoraEditor eudoraEditor(m_pBody, pMailImportLocation);</span>
<a href="#l22.620"></a><span id="l22.620" class="difflineminus">-  nsCOMPtr&lt;nsIArray&gt; embeddedObjects;</span>
<a href="#l22.621"></a><span id="l22.621" class="difflineminus">-  if (eudoraEditor.HasEmbeddedContent())</span>
<a href="#l22.622"></a><span id="l22.622" class="difflineminus">-    eudoraEditor.GetEmbeddedObjects(getter_AddRefs(embeddedObjects));</span>
<a href="#l22.623"></a><span id="l22.623" class="difflineminus">-</span>
<a href="#l22.624"></a><span id="l22.624" class="difflineminus">-  nsString uniBody;</span>
<a href="#l22.625"></a><span id="l22.625" class="difflineminus">-  NS_CopyNativeToUnicode(nsDependentCString(m_pBody), uniBody);</span>
<a href="#l22.626"></a><span id="l22.626" class="difflineminus">-</span>
<a href="#l22.627"></a><span id="l22.627" class="difflineminus">-  /*</span>
<a href="#l22.628"></a><span id="l22.628" class="difflineminus">-    l10n - I have the body of the message in the system charset,</span>
<a href="#l22.629"></a><span id="l22.629" class="difflineminus">-    I need to &quot;encode&quot; it to be the charset for the message</span>
<a href="#l22.630"></a><span id="l22.630" class="difflineminus">-    *UNLESS* of course, I don't know what the charset of the message</span>
<a href="#l22.631"></a><span id="l22.631" class="difflineminus">-    should be?  How do I determine what the charset should</span>
<a href="#l22.632"></a><span id="l22.632" class="difflineminus">-    be if it doesn't exist?</span>
<a href="#l22.633"></a><span id="l22.633" class="difflineminus">-</span>
<a href="#l22.634"></a><span id="l22.634" class="difflineminus">-  */</span>
<a href="#l22.635"></a><span id="l22.635" class="difflineminus">-</span>
<a href="#l22.636"></a><span id="l22.636" class="difflineminus">-  nsCString body;</span>
<a href="#l22.637"></a><span id="l22.637" class="difflineminus">-</span>
<a href="#l22.638"></a><span id="l22.638" class="difflineminus">-  rv = nsMsgI18NConvertFromUnicode(NS_LossyConvertUTF16toASCII(charSet).get(),</span>
<a href="#l22.639"></a><span id="l22.639" class="difflineminus">-                                    uniBody, body);</span>
<a href="#l22.640"></a><span id="l22.640" class="difflineminus">-  if (NS_FAILED(rv) &amp;&amp; !charSet.Equals(m_defCharset)) {</span>
<a href="#l22.641"></a><span id="l22.641" class="difflineminus">-    // in this case, if we did not use the default compose</span>
<a href="#l22.642"></a><span id="l22.642" class="difflineminus">-    // charset, then try that.</span>
<a href="#l22.643"></a><span id="l22.643" class="difflineminus">-    body.Truncate();</span>
<a href="#l22.644"></a><span id="l22.644" class="difflineminus">-    rv = nsMsgI18NConvertFromUnicode(NS_LossyConvertUTF16toASCII(charSet).get(),</span>
<a href="#l22.645"></a><span id="l22.645" class="difflineminus">-                                     uniBody, body);</span>
<a href="#l22.646"></a><span id="l22.646" class="difflineminus">-  }</span>
<a href="#l22.647"></a><span id="l22.647" class="difflineminus">-  uniBody.Truncate();</span>
<a href="#l22.648"></a><span id="l22.648" class="difflineminus">-</span>
<a href="#l22.649"></a><span id="l22.649" class="difflineminus">-</span>
<a href="#l22.650"></a><span id="l22.650" class="difflineminus">-  // See if it's a draft msg (ie, no From: or no To: AND no Cc: AND no Bcc:).</span>
<a href="#l22.651"></a><span id="l22.651" class="difflineminus">-  // Eudora saves sent and draft msgs in Out folder (ie, mixed) and it does</span>
<a href="#l22.652"></a><span id="l22.652" class="difflineminus">-  // store Bcc: header in the msg itself.</span>
<a href="#l22.653"></a><span id="l22.653" class="difflineminus">-  nsAutoString from, to, cc, bcc;</span>
<a href="#l22.654"></a><span id="l22.654" class="difflineminus">-  rv = m_pMsgFields-&gt;GetFrom(from);</span>
<a href="#l22.655"></a><span id="l22.655" class="difflineminus">-  rv = m_pMsgFields-&gt;GetTo(to);</span>
<a href="#l22.656"></a><span id="l22.656" class="difflineminus">-  rv = m_pMsgFields-&gt;GetCc(cc);</span>
<a href="#l22.657"></a><span id="l22.657" class="difflineminus">-  rv = m_pMsgFields-&gt;GetBcc(bcc);</span>
<a href="#l22.658"></a><span id="l22.658" class="difflineminus">-  bool createAsDraft = from.IsEmpty() || (to.IsEmpty() &amp;&amp; cc.IsEmpty() &amp;&amp; bcc.IsEmpty());</span>
<a href="#l22.659"></a><span id="l22.659" class="difflineminus">-</span>
<a href="#l22.660"></a><span id="l22.660" class="difflineminus">-  nsCOMPtr&lt;nsIImportService&gt; impService(do_GetService(NS_IMPORTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l22.661"></a><span id="l22.661" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.662"></a><span id="l22.662" class="difflineminus">-</span>
<a href="#l22.663"></a><span id="l22.663" class="difflineminus">-  rv = impService-&gt;CreateRFC822Message(</span>
<a href="#l22.664"></a><span id="l22.664" class="difflineminus">-                        s_pIdentity,                  // dummy identity</span>
<a href="#l22.665"></a><span id="l22.665" class="difflineminus">-                        m_pMsgFields,                 // message fields</span>
<a href="#l22.666"></a><span id="l22.666" class="difflineminus">-                        pMimeType,                    // body type</span>
<a href="#l22.667"></a><span id="l22.667" class="difflineminus">-                        body,                         // body pointer</span>
<a href="#l22.668"></a><span id="l22.668" class="difflineminus">-                        createAsDraft,</span>
<a href="#l22.669"></a><span id="l22.669" class="difflineminus">-                        pAttach,                      // local attachments</span>
<a href="#l22.670"></a><span id="l22.670" class="difflineminus">-                        embeddedObjects,</span>
<a href="#l22.671"></a><span id="l22.671" class="difflineminus">-                        m_pListener);                 // listener</span>
<a href="#l22.672"></a><span id="l22.672" class="difflineminus">-</span>
<a href="#l22.673"></a><span id="l22.673" class="difflineminus">-  EudoraSendListener *pListen = (EudoraSendListener *)m_pListener;</span>
<a href="#l22.674"></a><span id="l22.674" class="difflineminus">-  if (NS_FAILED(rv)) {</span>
<a href="#l22.675"></a><span id="l22.675" class="difflineminus">-    IMPORT_LOG1(&quot;*** Error, CreateAndSendMessage FAILED: 0x%lx\n&quot;, rv);</span>
<a href="#l22.676"></a><span id="l22.676" class="difflineminus">-    // IMPORT_LOG1(&quot;Headers: %80s\n&quot;, m_pHeaders);</span>
<a href="#l22.677"></a><span id="l22.677" class="difflineminus">-  }</span>
<a href="#l22.678"></a><span id="l22.678" class="difflineminus">-  else {</span>
<a href="#l22.679"></a><span id="l22.679" class="difflineminus">-    // wait for the listener to get done!</span>
<a href="#l22.680"></a><span id="l22.680" class="difflineminus">-    int32_t abortCnt = 0;</span>
<a href="#l22.681"></a><span id="l22.681" class="difflineminus">-    int32_t cnt = 0;</span>
<a href="#l22.682"></a><span id="l22.682" class="difflineminus">-    int32_t sleepCnt = 1;</span>
<a href="#l22.683"></a><span id="l22.683" class="difflineminus">-    while (!pListen-&gt;m_done &amp;&amp; (abortCnt &lt; kHungAbortCount)) {</span>
<a href="#l22.684"></a><span id="l22.684" class="difflineminus">-      PR_Sleep(sleepCnt);</span>
<a href="#l22.685"></a><span id="l22.685" class="difflineminus">-      cnt++;</span>
<a href="#l22.686"></a><span id="l22.686" class="difflineminus">-      if (cnt &gt; kHungCount) {</span>
<a href="#l22.687"></a><span id="l22.687" class="difflineminus">-        abortCnt++;</span>
<a href="#l22.688"></a><span id="l22.688" class="difflineminus">-        sleepCnt *= 2;</span>
<a href="#l22.689"></a><span id="l22.689" class="difflineminus">-        cnt = 0;</span>
<a href="#l22.690"></a><span id="l22.690" class="difflineminus">-      }</span>
<a href="#l22.691"></a><span id="l22.691" class="difflineminus">-    }</span>
<a href="#l22.692"></a><span id="l22.692" class="difflineminus">-</span>
<a href="#l22.693"></a><span id="l22.693" class="difflineminus">-    if (abortCnt &gt;= kHungAbortCount) {</span>
<a href="#l22.694"></a><span id="l22.694" class="difflineminus">-      IMPORT_LOG0(&quot;**** Create and send message hung\n&quot;);</span>
<a href="#l22.695"></a><span id="l22.695" class="difflineminus">-      IMPORT_LOG1(&quot;Headers: %s\n&quot;, m_pHeaders);</span>
<a href="#l22.696"></a><span id="l22.696" class="difflineminus">-      IMPORT_LOG1(&quot;Body: %s\n&quot;, m_pBody);</span>
<a href="#l22.697"></a><span id="l22.697" class="difflineminus">-      rv = NS_ERROR_FAILURE;</span>
<a href="#l22.698"></a><span id="l22.698" class="difflineminus">-    }</span>
<a href="#l22.699"></a><span id="l22.699" class="difflineminus">-</span>
<a href="#l22.700"></a><span id="l22.700" class="difflineminus">-  }</span>
<a href="#l22.701"></a><span id="l22.701" class="difflineminus">-</span>
<a href="#l22.702"></a><span id="l22.702" class="difflineminus">-  if (pMimeType)</span>
<a href="#l22.703"></a><span id="l22.703" class="difflineminus">-    NS_Free(pMimeType);</span>
<a href="#l22.704"></a><span id="l22.704" class="difflineminus">-</span>
<a href="#l22.705"></a><span id="l22.705" class="difflineminus">-  if (pListen-&gt;m_location) {</span>
<a href="#l22.706"></a><span id="l22.706" class="difflineminus">-    pListen-&gt;m_location-&gt;Clone(pMsg);</span>
<a href="#l22.707"></a><span id="l22.707" class="difflineminus">-    rv = NS_OK;</span>
<a href="#l22.708"></a><span id="l22.708" class="difflineminus">-  }</span>
<a href="#l22.709"></a><span id="l22.709" class="difflineminus">-  else {</span>
<a href="#l22.710"></a><span id="l22.710" class="difflineminus">-    rv = NS_ERROR_FAILURE;</span>
<a href="#l22.711"></a><span id="l22.711" class="difflineminus">-    IMPORT_LOG0(&quot;*** Error, Outlook compose unsuccessful\n&quot;);</span>
<a href="#l22.712"></a><span id="l22.712" class="difflineminus">-  }</span>
<a href="#l22.713"></a><span id="l22.713" class="difflineminus">-</span>
<a href="#l22.714"></a><span id="l22.714" class="difflineminus">-  pListen-&gt;Reset();</span>
<a href="#l22.715"></a><span id="l22.715" class="difflineminus">-</span>
<a href="#l22.716"></a><span id="l22.716" class="difflineminus">-  return rv;</span>
<a href="#l22.717"></a><span id="l22.717" class="difflineminus">-}</span>
<a href="#l22.718"></a><span id="l22.718" class="difflineminus">-</span>
<a href="#l22.719"></a><span id="l22.719" class="difflineminus">-</span>
<a href="#l22.720"></a><span id="l22.720" class="difflineminus">-bool SimpleBufferTonyRCopiedOnce::SpecialMemCpy(int32_t offset, const char *pData, int32_t len, int32_t *pWritten)</span>
<a href="#l22.721"></a><span id="l22.721" class="difflineminus">-{</span>
<a href="#l22.722"></a><span id="l22.722" class="difflineminus">-  // Arg!!!!!  Mozilla can't handle plain CRs in any mail messages.  Particularly a</span>
<a href="#l22.723"></a><span id="l22.723" class="difflineminus">-  // problem with Eudora since it doesn't give a rats a**</span>
<a href="#l22.724"></a><span id="l22.724" class="difflineminus">-  *pWritten = len;</span>
<a href="#l22.725"></a><span id="l22.725" class="difflineminus">-  int32_t  sz = offset + len;</span>
<a href="#l22.726"></a><span id="l22.726" class="difflineminus">-  if (offset) {</span>
<a href="#l22.727"></a><span id="l22.727" class="difflineminus">-    if ((m_pBuffer[offset - 1] == nsCRT::CR) &amp;&amp; (*pData != nsCRT::LF)) {</span>
<a href="#l22.728"></a><span id="l22.728" class="difflineminus">-      sz++;</span>
<a href="#l22.729"></a><span id="l22.729" class="difflineminus">-      if (!Grow(sz))</span>
<a href="#l22.730"></a><span id="l22.730" class="difflineminus">-        return false;</span>
<a href="#l22.731"></a><span id="l22.731" class="difflineminus">-      m_pBuffer[offset] = nsCRT::LF;</span>
<a href="#l22.732"></a><span id="l22.732" class="difflineminus">-      offset++;</span>
<a href="#l22.733"></a><span id="l22.733" class="difflineminus">-      (*pWritten)++;</span>
<a href="#l22.734"></a><span id="l22.734" class="difflineminus">-    }</span>
<a href="#l22.735"></a><span id="l22.735" class="difflineminus">-  }</span>
<a href="#l22.736"></a><span id="l22.736" class="difflineminus">-  while (len &gt; 0) {</span>
<a href="#l22.737"></a><span id="l22.737" class="difflineminus">-    if ((*pData == nsCRT::CR) &amp;&amp; (*(pData + 1) != nsCRT::LF)) {</span>
<a href="#l22.738"></a><span id="l22.738" class="difflineminus">-      sz++;</span>
<a href="#l22.739"></a><span id="l22.739" class="difflineminus">-      if (!Grow(sz))</span>
<a href="#l22.740"></a><span id="l22.740" class="difflineminus">-        return false;</span>
<a href="#l22.741"></a><span id="l22.741" class="difflineminus">-      m_pBuffer[offset] = nsCRT::CR;</span>
<a href="#l22.742"></a><span id="l22.742" class="difflineminus">-      offset++;</span>
<a href="#l22.743"></a><span id="l22.743" class="difflineminus">-      m_pBuffer[offset] = nsCRT::LF;</span>
<a href="#l22.744"></a><span id="l22.744" class="difflineminus">-      (*pWritten)++;</span>
<a href="#l22.745"></a><span id="l22.745" class="difflineminus">-    }</span>
<a href="#l22.746"></a><span id="l22.746" class="difflineminus">-    else {</span>
<a href="#l22.747"></a><span id="l22.747" class="difflineminus">-      m_pBuffer[offset] = *pData;</span>
<a href="#l22.748"></a><span id="l22.748" class="difflineminus">-    }</span>
<a href="#l22.749"></a><span id="l22.749" class="difflineminus">-    offset++;</span>
<a href="#l22.750"></a><span id="l22.750" class="difflineminus">-    pData++;</span>
<a href="#l22.751"></a><span id="l22.751" class="difflineminus">-    len--;</span>
<a href="#l22.752"></a><span id="l22.752" class="difflineminus">-  }</span>
<a href="#l22.753"></a><span id="l22.753" class="difflineminus">-</span>
<a href="#l22.754"></a><span id="l22.754" class="difflineminus">-  return true;</span>
<a href="#l22.755"></a><span id="l22.755" class="difflineminus">-}</span>
<a href="#l22.756"></a><span id="l22.756" class="difflineminus">-</span>
<a href="#l22.757"></a><span id="l22.757" class="difflineminus">-nsresult nsEudoraCompose::ReadHeaders(ReadFileState *pState, SimpleBufferTonyRCopiedOnce&amp; copy, SimpleBufferTonyRCopiedOnce&amp; header)</span>
<a href="#l22.758"></a><span id="l22.758" class="difflineminus">-{</span>
<a href="#l22.759"></a><span id="l22.759" class="difflineminus">-  // This should be the headers...</span>
<a href="#l22.760"></a><span id="l22.760" class="difflineminus">-  header.m_writeOffset = 0;</span>
<a href="#l22.761"></a><span id="l22.761" class="difflineminus">-</span>
<a href="#l22.762"></a><span id="l22.762" class="difflineminus">-  nsresult rv;</span>
<a href="#l22.763"></a><span id="l22.763" class="difflineminus">-  int32_t lineLen;</span>
<a href="#l22.764"></a><span id="l22.764" class="difflineminus">-  int32_t endLen = -1;</span>
<a href="#l22.765"></a><span id="l22.765" class="difflineminus">-  int8_t endBuffer = 0;</span>
<a href="#l22.766"></a><span id="l22.766" class="difflineminus">-</span>
<a href="#l22.767"></a><span id="l22.767" class="difflineminus">-  while ((endLen = IsEndHeaders(copy)) == -1) {</span>
<a href="#l22.768"></a><span id="l22.768" class="difflineminus">-    while ((lineLen = FindNextEndLine(copy)) == -1) {</span>
<a href="#l22.769"></a><span id="l22.769" class="difflineminus">-      copy.m_writeOffset = copy.m_bytesInBuf;</span>
<a href="#l22.770"></a><span id="l22.770" class="difflineminus">-      if (!header.Write(copy.m_pBuffer, copy.m_writeOffset)) {</span>
<a href="#l22.771"></a><span id="l22.771" class="difflineminus">-        IMPORT_LOG0(&quot;*** ERROR, writing headers\n&quot;);</span>
<a href="#l22.772"></a><span id="l22.772" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l22.773"></a><span id="l22.773" class="difflineminus">-      }</span>
<a href="#l22.774"></a><span id="l22.774" class="difflineminus">-      if (NS_FAILED(rv = FillMailBuffer(pState, copy))) {</span>
<a href="#l22.775"></a><span id="l22.775" class="difflineminus">-        IMPORT_LOG0(&quot;*** Error reading message headers\n&quot;);</span>
<a href="#l22.776"></a><span id="l22.776" class="difflineminus">-        return rv;</span>
<a href="#l22.777"></a><span id="l22.777" class="difflineminus">-      }</span>
<a href="#l22.778"></a><span id="l22.778" class="difflineminus">-      if (!copy.m_bytesInBuf) {</span>
<a href="#l22.779"></a><span id="l22.779" class="difflineminus">-        IMPORT_LOG0(&quot;*** Error, end of file while reading headers\n&quot;);</span>
<a href="#l22.780"></a><span id="l22.780" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l22.781"></a><span id="l22.781" class="difflineminus">-      }</span>
<a href="#l22.782"></a><span id="l22.782" class="difflineminus">-    }</span>
<a href="#l22.783"></a><span id="l22.783" class="difflineminus">-    copy.m_writeOffset += lineLen;</span>
<a href="#l22.784"></a><span id="l22.784" class="difflineminus">-    if ((copy.m_writeOffset + 4) &gt;= copy.m_bytesInBuf) {</span>
<a href="#l22.785"></a><span id="l22.785" class="difflineminus">-      if (!header.Write(copy.m_pBuffer, copy.m_writeOffset)) {</span>
<a href="#l22.786"></a><span id="l22.786" class="difflineminus">-        IMPORT_LOG0(&quot;*** ERROR, writing headers 2\n&quot;);</span>
<a href="#l22.787"></a><span id="l22.787" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l22.788"></a><span id="l22.788" class="difflineminus">-      }</span>
<a href="#l22.789"></a><span id="l22.789" class="difflineminus">-      if (NS_FAILED(rv = FillMailBuffer(pState, copy))) {</span>
<a href="#l22.790"></a><span id="l22.790" class="difflineminus">-        IMPORT_LOG0(&quot;*** Error reading message headers 2\n&quot;);</span>
<a href="#l22.791"></a><span id="l22.791" class="difflineminus">-        return rv;</span>
<a href="#l22.792"></a><span id="l22.792" class="difflineminus">-      }</span>
<a href="#l22.793"></a><span id="l22.793" class="difflineminus">-    }</span>
<a href="#l22.794"></a><span id="l22.794" class="difflineminus">-  }</span>
<a href="#l22.795"></a><span id="l22.795" class="difflineminus">-</span>
<a href="#l22.796"></a><span id="l22.796" class="difflineminus">-  if (!header.Write(copy.m_pBuffer, copy.m_writeOffset)) {</span>
<a href="#l22.797"></a><span id="l22.797" class="difflineminus">-    IMPORT_LOG0(&quot;*** Error writing final headers\n&quot;);</span>
<a href="#l22.798"></a><span id="l22.798" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l22.799"></a><span id="l22.799" class="difflineminus">-  }</span>
<a href="#l22.800"></a><span id="l22.800" class="difflineminus">-  if (!header.Write((const char *)&amp;endBuffer, 1)) {</span>
<a href="#l22.801"></a><span id="l22.801" class="difflineminus">-    IMPORT_LOG0(&quot;*** Error writing header trailing null\n&quot;);</span>
<a href="#l22.802"></a><span id="l22.802" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l22.803"></a><span id="l22.803" class="difflineminus">-  }</span>
<a href="#l22.804"></a><span id="l22.804" class="difflineminus">-</span>
<a href="#l22.805"></a><span id="l22.805" class="difflineminus">-  copy.m_writeOffset += endLen;</span>
<a href="#l22.806"></a><span id="l22.806" class="difflineminus">-</span>
<a href="#l22.807"></a><span id="l22.807" class="difflineminus">-  return NS_OK;</span>
<a href="#l22.808"></a><span id="l22.808" class="difflineminus">-}</span>
<a href="#l22.809"></a><span id="l22.809" class="difflineminus">-</span>
<a href="#l22.810"></a><span id="l22.810" class="difflineminus">-int32_t nsEudoraCompose::FindNextEndLine(SimpleBufferTonyRCopiedOnce&amp; data)</span>
<a href="#l22.811"></a><span id="l22.811" class="difflineminus">-{</span>
<a href="#l22.812"></a><span id="l22.812" class="difflineminus">-  int32_t len = data.m_bytesInBuf - data.m_writeOffset;</span>
<a href="#l22.813"></a><span id="l22.813" class="difflineminus">-  if (!len)</span>
<a href="#l22.814"></a><span id="l22.814" class="difflineminus">-    return -1;</span>
<a href="#l22.815"></a><span id="l22.815" class="difflineminus">-</span>
<a href="#l22.816"></a><span id="l22.816" class="difflineminus">-  int32_t count = 0;</span>
<a href="#l22.817"></a><span id="l22.817" class="difflineminus">-  const char *pData = data.m_pBuffer + data.m_writeOffset;</span>
<a href="#l22.818"></a><span id="l22.818" class="difflineminus">-  // Skip over end of line(s).</span>
<a href="#l22.819"></a><span id="l22.819" class="difflineminus">-  while ((count &lt; len) &amp;&amp; ((*pData == nsCRT::CR) || (*pData == nsCRT::LF))) {</span>
<a href="#l22.820"></a><span id="l22.820" class="difflineminus">-    pData++;</span>
<a href="#l22.821"></a><span id="l22.821" class="difflineminus">-    count++;</span>
<a href="#l22.822"></a><span id="l22.822" class="difflineminus">-  }</span>
<a href="#l22.823"></a><span id="l22.823" class="difflineminus">-  // Skip to next end of line.</span>
<a href="#l22.824"></a><span id="l22.824" class="difflineminus">-  while ((count &lt; len) &amp;&amp; (*pData != nsCRT::CR) &amp;&amp; (*pData != nsCRT::LF)) {</span>
<a href="#l22.825"></a><span id="l22.825" class="difflineminus">-    pData++;</span>
<a href="#l22.826"></a><span id="l22.826" class="difflineminus">-    count++;</span>
<a href="#l22.827"></a><span id="l22.827" class="difflineminus">-  }</span>
<a href="#l22.828"></a><span id="l22.828" class="difflineminus">-</span>
<a href="#l22.829"></a><span id="l22.829" class="difflineminus">-  return (count &lt; len) ? count : -1;</span>
<a href="#l22.830"></a><span id="l22.830" class="difflineminus">-}</span>
<a href="#l22.831"></a><span id="l22.831" class="difflineminus">-</span>
<a href="#l22.832"></a><span id="l22.832" class="difflineminus">-int32_t nsEudoraCompose::IsEndHeaders(SimpleBufferTonyRCopiedOnce&amp; data)</span>
<a href="#l22.833"></a><span id="l22.833" class="difflineminus">-{</span>
<a href="#l22.834"></a><span id="l22.834" class="difflineminus">-  int32_t len = data.m_bytesInBuf - data.m_writeOffset;</span>
<a href="#l22.835"></a><span id="l22.835" class="difflineminus">-  if (len &lt; 2)</span>
<a href="#l22.836"></a><span id="l22.836" class="difflineminus">-    return -1;</span>
<a href="#l22.837"></a><span id="l22.837" class="difflineminus">-</span>
<a href="#l22.838"></a><span id="l22.838" class="difflineminus">-  const char *pChar = data.m_pBuffer + data.m_writeOffset;</span>
<a href="#l22.839"></a><span id="l22.839" class="difflineminus">-  // Double nsCRT::CR.</span>
<a href="#l22.840"></a><span id="l22.840" class="difflineminus">-  if ((*pChar == nsCRT::CR) &amp;&amp; (*(pChar + 1) == nsCRT::CR))</span>
<a href="#l22.841"></a><span id="l22.841" class="difflineminus">-    return 2;</span>
<a href="#l22.842"></a><span id="l22.842" class="difflineminus">-</span>
<a href="#l22.843"></a><span id="l22.843" class="difflineminus">-  if (len &lt; 4)</span>
<a href="#l22.844"></a><span id="l22.844" class="difflineminus">-    return -1;</span>
<a href="#l22.845"></a><span id="l22.845" class="difflineminus">-</span>
<a href="#l22.846"></a><span id="l22.846" class="difflineminus">-  // Double (nsCRT::CR + nsCRT::LF).</span>
<a href="#l22.847"></a><span id="l22.847" class="difflineminus">-  if ((*pChar == nsCRT::CR) &amp;&amp; (*(pChar + 1) == nsCRT::LF) &amp;&amp;</span>
<a href="#l22.848"></a><span id="l22.848" class="difflineminus">-      (*(pChar + 2) == nsCRT::CR) &amp;&amp; (*(pChar + 3) == nsCRT::LF))</span>
<a href="#l22.849"></a><span id="l22.849" class="difflineminus">-    return 4;</span>
<a href="#l22.850"></a><span id="l22.850" class="difflineminus">-</span>
<a href="#l22.851"></a><span id="l22.851" class="difflineminus">-  return -1;</span>
<a href="#l22.852"></a><span id="l22.852" class="difflineminus">-}</span>
<a href="#l22.853"></a><span id="l22.853" class="difflineminus">-</span>
<a href="#l22.854"></a><span id="l22.854" class="difflineminus">-</span>
<a href="#l22.855"></a><span id="l22.855" class="difflineminus">-nsresult nsEudoraCompose::CopyComposedMessage(nsCString&amp; fromLine,</span>
<a href="#l22.856"></a><span id="l22.856" class="difflineminus">-                                              nsIFile *pSrc,</span>
<a href="#l22.857"></a><span id="l22.857" class="difflineminus">-                                              nsIOutputStream *pDst,</span>
<a href="#l22.858"></a><span id="l22.858" class="difflineminus">-                                              SimpleBufferTonyRCopiedOnce&amp; copy)</span>
<a href="#l22.859"></a><span id="l22.859" class="difflineminus">-{</span>
<a href="#l22.860"></a><span id="l22.860" class="difflineminus">-  copy.m_bytesInBuf = 0;</span>
<a href="#l22.861"></a><span id="l22.861" class="difflineminus">-  copy.m_writeOffset = 0;</span>
<a href="#l22.862"></a><span id="l22.862" class="difflineminus">-  ReadFileState  state;</span>
<a href="#l22.863"></a><span id="l22.863" class="difflineminus">-  state.pFile = pSrc;</span>
<a href="#l22.864"></a><span id="l22.864" class="difflineminus">-  state.offset = 0;</span>
<a href="#l22.865"></a><span id="l22.865" class="difflineminus">-  state.size = 0;</span>
<a href="#l22.866"></a><span id="l22.866" class="difflineminus">-</span>
<a href="#l22.867"></a><span id="l22.867" class="difflineminus">-  pSrc-&gt;GetFileSize(&amp;state.size);</span>
<a href="#l22.868"></a><span id="l22.868" class="difflineminus">-  if (!state.size) {</span>
<a href="#l22.869"></a><span id="l22.869" class="difflineminus">-    IMPORT_LOG0(&quot;*** Error, unexpected zero file size for composed message\n&quot;);</span>
<a href="#l22.870"></a><span id="l22.870" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l22.871"></a><span id="l22.871" class="difflineminus">-  }</span>
<a href="#l22.872"></a><span id="l22.872" class="difflineminus">-</span>
<a href="#l22.873"></a><span id="l22.873" class="difflineminus">-        nsresult rv = NS_NewLocalFileInputStream(getter_AddRefs(state.pInputStream), pSrc);</span>
<a href="#l22.874"></a><span id="l22.874" class="difflineminus">-</span>
<a href="#l22.875"></a><span id="l22.875" class="difflineminus">-  if (NS_FAILED(rv)) {</span>
<a href="#l22.876"></a><span id="l22.876" class="difflineminus">-    IMPORT_LOG0(&quot;*** Error, unable to open composed message file\n&quot;);</span>
<a href="#l22.877"></a><span id="l22.877" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l22.878"></a><span id="l22.878" class="difflineminus">-  }</span>
<a href="#l22.879"></a><span id="l22.879" class="difflineminus">-</span>
<a href="#l22.880"></a><span id="l22.880" class="difflineminus">-  uint32_t written;</span>
<a href="#l22.881"></a><span id="l22.881" class="difflineminus">-  rv = pDst-&gt;Write(fromLine.get(), fromLine.Length(), &amp;written);</span>
<a href="#l22.882"></a><span id="l22.882" class="difflineminus">-</span>
<a href="#l22.883"></a><span id="l22.883" class="difflineminus">-  // well, isn't this a hoot!</span>
<a href="#l22.884"></a><span id="l22.884" class="difflineminus">-  // Read the headers from the new message, get the ones we like</span>
<a href="#l22.885"></a><span id="l22.885" class="difflineminus">-  // and write out only the headers we want from the new message,</span>
<a href="#l22.886"></a><span id="l22.886" class="difflineminus">-  // along with all of the other headers from the &quot;old&quot; message!</span>
<a href="#l22.887"></a><span id="l22.887" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l22.888"></a><span id="l22.888" class="difflineminus">-    rv = FillMailBuffer(&amp;state, copy);</span>
<a href="#l22.889"></a><span id="l22.889" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l22.890"></a><span id="l22.890" class="difflineminus">-    rv = ReadHeaders(&amp;state, copy, m_readHeaders);</span>
<a href="#l22.891"></a><span id="l22.891" class="difflineminus">-</span>
<a href="#l22.892"></a><span id="l22.892" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l22.893"></a><span id="l22.893" class="difflineminus">-    rv = WriteHeaders(pDst, m_readHeaders);</span>
<a href="#l22.894"></a><span id="l22.894" class="difflineminus">-</span>
<a href="#l22.895"></a><span id="l22.895" class="difflineminus">-  // We need to go ahead and write out the rest of the copy buffer</span>
<a href="#l22.896"></a><span id="l22.896" class="difflineminus">-  // so that the following will properly copy the rest of the body</span>
<a href="#l22.897"></a><span id="l22.897" class="difflineminus">-  char lastChar = 0;</span>
<a href="#l22.898"></a><span id="l22.898" class="difflineminus">-</span>
<a href="#l22.899"></a><span id="l22.899" class="difflineminus">-  rv = EscapeFromSpaceLine(pDst, copy.m_pBuffer + copy.m_writeOffset, copy.m_pBuffer+copy.m_bytesInBuf);</span>
<a href="#l22.900"></a><span id="l22.900" class="difflineminus">-  if (copy.m_bytesInBuf)</span>
<a href="#l22.901"></a><span id="l22.901" class="difflineminus">-    lastChar = copy.m_pBuffer[copy.m_bytesInBuf - 1];</span>
<a href="#l22.902"></a><span id="l22.902" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l22.903"></a><span id="l22.903" class="difflineminus">-    copy.m_writeOffset = copy.m_bytesInBuf;</span>
<a href="#l22.904"></a><span id="l22.904" class="difflineminus">-</span>
<a href="#l22.905"></a><span id="l22.905" class="difflineminus">-  while ((state.offset &lt; state.size) &amp;&amp; NS_SUCCEEDED(rv)) {</span>
<a href="#l22.906"></a><span id="l22.906" class="difflineminus">-    rv = FillMailBuffer(&amp;state, copy);</span>
<a href="#l22.907"></a><span id="l22.907" class="difflineminus">-    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l22.908"></a><span id="l22.908" class="difflineminus">-      rv = EscapeFromSpaceLine(pDst, copy.m_pBuffer + copy.m_writeOffset, copy.m_pBuffer+copy.m_bytesInBuf);</span>
<a href="#l22.909"></a><span id="l22.909" class="difflineminus">-      lastChar = copy.m_pBuffer[copy.m_bytesInBuf - 1];</span>
<a href="#l22.910"></a><span id="l22.910" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l22.911"></a><span id="l22.911" class="difflineminus">-        copy.m_writeOffset = copy.m_bytesInBuf;</span>
<a href="#l22.912"></a><span id="l22.912" class="difflineminus">-      else</span>
<a href="#l22.913"></a><span id="l22.913" class="difflineminus">-        IMPORT_LOG0(&quot;*** Error writing to destination mailbox\n&quot;);</span>
<a href="#l22.914"></a><span id="l22.914" class="difflineminus">-    }</span>
<a href="#l22.915"></a><span id="l22.915" class="difflineminus">-  }</span>
<a href="#l22.916"></a><span id="l22.916" class="difflineminus">-</span>
<a href="#l22.917"></a><span id="l22.917" class="difflineminus">-  state.pInputStream-&gt;Close();</span>
<a href="#l22.918"></a><span id="l22.918" class="difflineminus">-</span>
<a href="#l22.919"></a><span id="l22.919" class="difflineminus">-  if ((lastChar != nsCRT::LF) &amp;&amp; NS_SUCCEEDED(rv)) {</span>
<a href="#l22.920"></a><span id="l22.920" class="difflineminus">-    rv = pDst-&gt;Write(&quot;\x0D\x0A&quot;, 2, &amp;written);</span>
<a href="#l22.921"></a><span id="l22.921" class="difflineminus">-    if (written != 2)</span>
<a href="#l22.922"></a><span id="l22.922" class="difflineminus">-      rv = NS_ERROR_FAILURE;</span>
<a href="#l22.923"></a><span id="l22.923" class="difflineminus">-  }</span>
<a href="#l22.924"></a><span id="l22.924" class="difflineminus">-</span>
<a href="#l22.925"></a><span id="l22.925" class="difflineminus">-  return rv;</span>
<a href="#l22.926"></a><span id="l22.926" class="difflineminus">-}</span>
<a href="#l22.927"></a><span id="l22.927" class="difflineminus">-</span>
<a href="#l22.928"></a><span id="l22.928" class="difflineminus">-nsresult nsEudoraCompose::FillMailBuffer(ReadFileState *pState, SimpleBufferTonyRCopiedOnce&amp; read)</span>
<a href="#l22.929"></a><span id="l22.929" class="difflineminus">-{</span>
<a href="#l22.930"></a><span id="l22.930" class="difflineminus">-  if (read.m_writeOffset &gt;= read.m_bytesInBuf) {</span>
<a href="#l22.931"></a><span id="l22.931" class="difflineminus">-    read.m_writeOffset = 0;</span>
<a href="#l22.932"></a><span id="l22.932" class="difflineminus">-    read.m_bytesInBuf = 0;</span>
<a href="#l22.933"></a><span id="l22.933" class="difflineminus">-  }</span>
<a href="#l22.934"></a><span id="l22.934" class="difflineminus">-  else if (read.m_writeOffset) {</span>
<a href="#l22.935"></a><span id="l22.935" class="difflineminus">-    memcpy(read.m_pBuffer, read.m_pBuffer + read.m_writeOffset, read.m_bytesInBuf - read.m_writeOffset);</span>
<a href="#l22.936"></a><span id="l22.936" class="difflineminus">-    read.m_bytesInBuf -= read.m_writeOffset;</span>
<a href="#l22.937"></a><span id="l22.937" class="difflineminus">-    read.m_writeOffset = 0;</span>
<a href="#l22.938"></a><span id="l22.938" class="difflineminus">-  }</span>
<a href="#l22.939"></a><span id="l22.939" class="difflineminus">-</span>
<a href="#l22.940"></a><span id="l22.940" class="difflineminus">-  uint32_t count = read.m_size - read.m_bytesInBuf;</span>
<a href="#l22.941"></a><span id="l22.941" class="difflineminus">-  if ((count + pState-&gt;offset) &gt; pState-&gt;size)</span>
<a href="#l22.942"></a><span id="l22.942" class="difflineminus">-    count = pState-&gt;size - pState-&gt;offset;</span>
<a href="#l22.943"></a><span id="l22.943" class="difflineminus">-  if (count) {</span>
<a href="#l22.944"></a><span id="l22.944" class="difflineminus">-    uint32_t bytesRead = 0;</span>
<a href="#l22.945"></a><span id="l22.945" class="difflineminus">-    char * pBuffer = read.m_pBuffer + read.m_bytesInBuf;</span>
<a href="#l22.946"></a><span id="l22.946" class="difflineminus">-    nsresult rv = pState-&gt;pInputStream-&gt;Read(pBuffer, count, &amp;bytesRead);</span>
<a href="#l22.947"></a><span id="l22.947" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l22.948"></a><span id="l22.948" class="difflineminus">-      return rv;</span>
<a href="#l22.949"></a><span id="l22.949" class="difflineminus">-    if (bytesRead != count)</span>
<a href="#l22.950"></a><span id="l22.950" class="difflineminus">-      return NS_ERROR_FAILURE;</span>
<a href="#l22.951"></a><span id="l22.951" class="difflineminus">-    read.m_bytesInBuf += bytesRead;</span>
<a href="#l22.952"></a><span id="l22.952" class="difflineminus">-    pState-&gt;offset += bytesRead;</span>
<a href="#l22.953"></a><span id="l22.953" class="difflineminus">-  }</span>
<a href="#l22.954"></a><span id="l22.954" class="difflineminus">-</span>
<a href="#l22.955"></a><span id="l22.955" class="difflineminus">-  return NS_OK;</span>
<a href="#l22.956"></a><span id="l22.956" class="difflineminus">-}</span>
<a href="#l22.957"></a><span id="l22.957" class="difflineminus">-</span>
<a href="#l22.958"></a><span id="l22.958" class="difflineminus">-</span>
<a href="#l22.959"></a><span id="l22.959" class="difflineminus">-#define kMaxSpecialHeaders 3</span>
<a href="#l22.960"></a><span id="l22.960" class="difflineminus">-static const char *gSpecialHeaders[kMaxSpecialHeaders] = {</span>
<a href="#l22.961"></a><span id="l22.961" class="difflineminus">-  &quot;Content-type&quot;,</span>
<a href="#l22.962"></a><span id="l22.962" class="difflineminus">-  &quot;MIME-Version&quot;,</span>
<a href="#l22.963"></a><span id="l22.963" class="difflineminus">-  &quot;Content-transfer-encoding&quot;</span>
<a href="#l22.964"></a><span id="l22.964" class="difflineminus">-};</span>
<a href="#l22.965"></a><span id="l22.965" class="difflineminus">-// consider &quot;X-Accept-Language&quot;?</span>
<a href="#l22.966"></a><span id="l22.966" class="difflineminus">-</span>
<a href="#l22.967"></a><span id="l22.967" class="difflineminus">-#define kMaxReplaceHeaders 5</span>
<a href="#l22.968"></a><span id="l22.968" class="difflineminus">-static const char *gReplaceHeaders[kMaxReplaceHeaders] = {</span>
<a href="#l22.969"></a><span id="l22.969" class="difflineminus">-  &quot;From&quot;,</span>
<a href="#l22.970"></a><span id="l22.970" class="difflineminus">-  &quot;To&quot;,</span>
<a href="#l22.971"></a><span id="l22.971" class="difflineminus">-  &quot;Subject&quot;,</span>
<a href="#l22.972"></a><span id="l22.972" class="difflineminus">-  &quot;Reply-to&quot;,</span>
<a href="#l22.973"></a><span id="l22.973" class="difflineminus">-  &quot;cc&quot;</span>
<a href="#l22.974"></a><span id="l22.974" class="difflineminus">-};</span>
<a href="#l22.975"></a><span id="l22.975" class="difflineminus">-</span>
<a href="#l22.976"></a><span id="l22.976" class="difflineminus">-bool nsEudoraCompose::IsReplaceHeader(const char *pHeader)</span>
<a href="#l22.977"></a><span id="l22.977" class="difflineminus">-{</span>
<a href="#l22.978"></a><span id="l22.978" class="difflineminus">-  for (int i = 0; i &lt; kMaxReplaceHeaders; i++) {</span>
<a href="#l22.979"></a><span id="l22.979" class="difflineminus">-    if (!PL_strcasecmp(pHeader, gReplaceHeaders[i]))</span>
<a href="#l22.980"></a><span id="l22.980" class="difflineminus">-      return true;</span>
<a href="#l22.981"></a><span id="l22.981" class="difflineminus">-  }</span>
<a href="#l22.982"></a><span id="l22.982" class="difflineminus">-</span>
<a href="#l22.983"></a><span id="l22.983" class="difflineminus">-  return false;</span>
<a href="#l22.984"></a><span id="l22.984" class="difflineminus">-}</span>
<a href="#l22.985"></a><span id="l22.985" class="difflineminus">-</span>
<a href="#l22.986"></a><span id="l22.986" class="difflineminus">-int32_t nsEudoraCompose::IsSpecialHeader(const char *pHeader)</span>
<a href="#l22.987"></a><span id="l22.987" class="difflineminus">-{</span>
<a href="#l22.988"></a><span id="l22.988" class="difflineminus">-  for (int i = 0; i &lt; kMaxSpecialHeaders; i++) {</span>
<a href="#l22.989"></a><span id="l22.989" class="difflineminus">-    if (!PL_strcasecmp(pHeader, gSpecialHeaders[i]))</span>
<a href="#l22.990"></a><span id="l22.990" class="difflineminus">-      return (int32_t) i;</span>
<a href="#l22.991"></a><span id="l22.991" class="difflineminus">-  }</span>
<a href="#l22.992"></a><span id="l22.992" class="difflineminus">-</span>
<a href="#l22.993"></a><span id="l22.993" class="difflineminus">-  return -1;</span>
<a href="#l22.994"></a><span id="l22.994" class="difflineminus">-}</span>
<a href="#l22.995"></a><span id="l22.995" class="difflineminus">-</span>
<a href="#l22.996"></a><span id="l22.996" class="difflineminus">-</span>
<a href="#l22.997"></a><span id="l22.997" class="difflineminus">-nsresult nsEudoraCompose::WriteHeaders(nsIOutputStream *pDst, SimpleBufferTonyRCopiedOnce&amp; newHeaders)</span>
<a href="#l22.998"></a><span id="l22.998" class="difflineminus">-{</span>
<a href="#l22.999"></a><span id="l22.999" class="difflineminus">-  // Well, ain't this a peach?</span>
<a href="#l22.1000"></a><span id="l22.1000" class="difflineminus">-  // This is rather disgusting but there really isn't much to be done about it....</span>
<a href="#l22.1001"></a><span id="l22.1001" class="difflineminus">-</span>
<a href="#l22.1002"></a><span id="l22.1002" class="difflineminus">-  // 1. For each &quot;old&quot; header, replace it with the new one if we want,</span>
<a href="#l22.1003"></a><span id="l22.1003" class="difflineminus">-  // then right it out.</span>
<a href="#l22.1004"></a><span id="l22.1004" class="difflineminus">-  // 2. Then if we haven't written the &quot;important&quot; new headers, write them out</span>
<a href="#l22.1005"></a><span id="l22.1005" class="difflineminus">-  // 3. Terminate the headers with an extra eol.</span>
<a href="#l22.1006"></a><span id="l22.1006" class="difflineminus">-</span>
<a href="#l22.1007"></a><span id="l22.1007" class="difflineminus">-  int32_t n = 0;</span>
<a href="#l22.1008"></a><span id="l22.1008" class="difflineminus">-  nsCString header;</span>
<a href="#l22.1009"></a><span id="l22.1009" class="difflineminus">-  nsCString val;</span>
<a href="#l22.1010"></a><span id="l22.1010" class="difflineminus">-  nsCString replaceVal;</span>
<a href="#l22.1011"></a><span id="l22.1011" class="difflineminus">-  uint32_t written;</span>
<a href="#l22.1012"></a><span id="l22.1012" class="difflineminus">-  nsresult rv = NS_OK; // it's ok if we don't have the first header on the predefined lists.</span>
<a href="#l22.1013"></a><span id="l22.1013" class="difflineminus">-  int32_t specialHeader;</span>
<a href="#l22.1014"></a><span id="l22.1014" class="difflineminus">-  bool specials[kMaxSpecialHeaders];</span>
<a href="#l22.1015"></a><span id="l22.1015" class="difflineminus">-  bool      hasDateHeader = false;</span>
<a href="#l22.1016"></a><span id="l22.1016" class="difflineminus">-  int i;</span>
<a href="#l22.1017"></a><span id="l22.1017" class="difflineminus">-</span>
<a href="#l22.1018"></a><span id="l22.1018" class="difflineminus">-  for (i = 0; i &lt; kMaxSpecialHeaders; i++)</span>
<a href="#l22.1019"></a><span id="l22.1019" class="difflineminus">-    specials[i] = false;</span>
<a href="#l22.1020"></a><span id="l22.1020" class="difflineminus">-</span>
<a href="#l22.1021"></a><span id="l22.1021" class="difflineminus">-  // m_pHeaders - contains headers from a Eudora msg.</span>
<a href="#l22.1022"></a><span id="l22.1022" class="difflineminus">-  // newHeaders - contains headers from a mozilla msg (more headers here).</span>
<a href="#l22.1023"></a><span id="l22.1023" class="difflineminus">-  do {</span>
<a href="#l22.1024"></a><span id="l22.1024" class="difflineminus">-    GetNthHeader(m_pHeaders, m_headerLen, n, header, val, false);</span>
<a href="#l22.1025"></a><span id="l22.1025" class="difflineminus">-    // GetNthHeader(newHeaders.m_pBuffer, newHeaders.m_writeOffset, n, header, val, false);</span>
<a href="#l22.1026"></a><span id="l22.1026" class="difflineminus">-    if (!header.IsEmpty()) {</span>
<a href="#l22.1027"></a><span id="l22.1027" class="difflineminus">-      if ((specialHeader = IsSpecialHeader(header.get())) != -1) {</span>
<a href="#l22.1028"></a><span id="l22.1028" class="difflineminus">-        header.Append(':');</span>
<a href="#l22.1029"></a><span id="l22.1029" class="difflineminus">-        GetHeaderValue(newHeaders.m_pBuffer, newHeaders.m_writeOffset - 1,</span>
<a href="#l22.1030"></a><span id="l22.1030" class="difflineminus">-                       header.get(), val, false);</span>
<a href="#l22.1031"></a><span id="l22.1031" class="difflineminus">-        header.SetLength(header.Length() - 1);</span>
<a href="#l22.1032"></a><span id="l22.1032" class="difflineminus">-        specials[specialHeader] = true;</span>
<a href="#l22.1033"></a><span id="l22.1033" class="difflineminus">-      }</span>
<a href="#l22.1034"></a><span id="l22.1034" class="difflineminus">-      else if (IsReplaceHeader(header.get())) {</span>
<a href="#l22.1035"></a><span id="l22.1035" class="difflineminus">-        replaceVal.Truncate();</span>
<a href="#l22.1036"></a><span id="l22.1036" class="difflineminus">-        header.Append(':');</span>
<a href="#l22.1037"></a><span id="l22.1037" class="difflineminus">-        GetHeaderValue(newHeaders.m_pBuffer, newHeaders.m_writeOffset - 1,</span>
<a href="#l22.1038"></a><span id="l22.1038" class="difflineminus">-                       header.get(), replaceVal, false);</span>
<a href="#l22.1039"></a><span id="l22.1039" class="difflineminus">-        header.SetLength(header.Length() - 1);</span>
<a href="#l22.1040"></a><span id="l22.1040" class="difflineminus">-        if (!replaceVal.IsEmpty())</span>
<a href="#l22.1041"></a><span id="l22.1041" class="difflineminus">-          val = replaceVal;</span>
<a href="#l22.1042"></a><span id="l22.1042" class="difflineminus">-      }</span>
<a href="#l22.1043"></a><span id="l22.1043" class="difflineminus">-      if (!val.IsEmpty()) {</span>
<a href="#l22.1044"></a><span id="l22.1044" class="difflineminus">-        // See if we're writing out a Date: header.</span>
<a href="#l22.1045"></a><span id="l22.1045" class="difflineminus">-        if (header.LowerCaseEqualsLiteral(&quot;date&quot;))</span>
<a href="#l22.1046"></a><span id="l22.1046" class="difflineminus">-          hasDateHeader = true;</span>
<a href="#l22.1047"></a><span id="l22.1047" class="difflineminus">-        rv = pDst-&gt;Write(header.get(), header.Length(), &amp;written);</span>
<a href="#l22.1048"></a><span id="l22.1048" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l22.1049"></a><span id="l22.1049" class="difflineminus">-          rv = pDst-&gt;Write(&quot;: &quot;, 2, &amp;written);</span>
<a href="#l22.1050"></a><span id="l22.1050" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l22.1051"></a><span id="l22.1051" class="difflineminus">-          rv = pDst-&gt;Write(val.get(), val.Length(), &amp;written);</span>
<a href="#l22.1052"></a><span id="l22.1052" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l22.1053"></a><span id="l22.1053" class="difflineminus">-          rv = pDst-&gt;Write(&quot;\x0D\x0A&quot;, 2, &amp;written);</span>
<a href="#l22.1054"></a><span id="l22.1054" class="difflineminus">-</span>
<a href="#l22.1055"></a><span id="l22.1055" class="difflineminus">-      }</span>
<a href="#l22.1056"></a><span id="l22.1056" class="difflineminus">-    }</span>
<a href="#l22.1057"></a><span id="l22.1057" class="difflineminus">-    n++;</span>
<a href="#l22.1058"></a><span id="l22.1058" class="difflineminus">-  } while (NS_SUCCEEDED(rv) &amp;&amp; !header.IsEmpty());</span>
<a href="#l22.1059"></a><span id="l22.1059" class="difflineminus">-</span>
<a href="#l22.1060"></a><span id="l22.1060" class="difflineminus">-  // If we don't have Date: header so far then use the default one (taken from Eudora &quot;From &quot; line).</span>
<a href="#l22.1061"></a><span id="l22.1061" class="difflineminus">-  if (!hasDateHeader)</span>
<a href="#l22.1062"></a><span id="l22.1062" class="difflineminus">-  {</span>
<a href="#l22.1063"></a><span id="l22.1063" class="difflineminus">-    rv = pDst-&gt;Write(m_defaultDate.get(), m_defaultDate.Length(), &amp;written);</span>
<a href="#l22.1064"></a><span id="l22.1064" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l22.1065"></a><span id="l22.1065" class="difflineminus">-      rv = pDst-&gt;Write(&quot;\x0D\x0A&quot;, 2, &amp;written);</span>
<a href="#l22.1066"></a><span id="l22.1066" class="difflineminus">-  }</span>
<a href="#l22.1067"></a><span id="l22.1067" class="difflineminus">-</span>
<a href="#l22.1068"></a><span id="l22.1068" class="difflineminus">-  for (i = 0; (i &lt; kMaxSpecialHeaders) &amp;&amp; NS_SUCCEEDED(rv); i++) {</span>
<a href="#l22.1069"></a><span id="l22.1069" class="difflineminus">-    if (!specials[i]) {</span>
<a href="#l22.1070"></a><span id="l22.1070" class="difflineminus">-      header = gSpecialHeaders[i];</span>
<a href="#l22.1071"></a><span id="l22.1071" class="difflineminus">-      header.Append(':');</span>
<a href="#l22.1072"></a><span id="l22.1072" class="difflineminus">-      GetHeaderValue(newHeaders.m_pBuffer, newHeaders.m_writeOffset - 1,</span>
<a href="#l22.1073"></a><span id="l22.1073" class="difflineminus">-                     header.get(), val, false);</span>
<a href="#l22.1074"></a><span id="l22.1074" class="difflineminus">-      header.SetLength(header.Length() - 1);</span>
<a href="#l22.1075"></a><span id="l22.1075" class="difflineminus">-      if (!val.IsEmpty()) {</span>
<a href="#l22.1076"></a><span id="l22.1076" class="difflineminus">-        rv = pDst-&gt;Write(header.get(), header.Length(), &amp;written);</span>
<a href="#l22.1077"></a><span id="l22.1077" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l22.1078"></a><span id="l22.1078" class="difflineminus">-          rv = pDst-&gt;Write(&quot;: &quot;, 2, &amp;written);</span>
<a href="#l22.1079"></a><span id="l22.1079" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l22.1080"></a><span id="l22.1080" class="difflineminus">-          rv = pDst-&gt;Write(val.get(), val.Length(), &amp;written);</span>
<a href="#l22.1081"></a><span id="l22.1081" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l22.1082"></a><span id="l22.1082" class="difflineminus">-          rv = pDst-&gt;Write(&quot;\x0D\x0A&quot;, 2, &amp;written);</span>
<a href="#l22.1083"></a><span id="l22.1083" class="difflineminus">-      }</span>
<a href="#l22.1084"></a><span id="l22.1084" class="difflineminus">-    }</span>
<a href="#l22.1085"></a><span id="l22.1085" class="difflineminus">-  }</span>
<a href="#l22.1086"></a><span id="l22.1086" class="difflineminus">-</span>
<a href="#l22.1087"></a><span id="l22.1087" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l22.1088"></a><span id="l22.1088" class="difflineminus">-    rv = pDst-&gt;Write(&quot;\x0D\x0A&quot;, 2, &amp;written);</span>
<a href="#l22.1089"></a><span id="l22.1089" class="difflineminus">-  return rv;</span>
<a href="#l22.1090"></a><span id="l22.1090" class="difflineminus">-}</span>
<a href="#l22.1091"></a><span id="l22.1091" class="difflineminus">-</span>
<a href="#l22.1092"></a><span id="l22.1092" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1">deleted file mode 100644</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineminus">--- a/mailnews/import/eudora/src/nsEudoraCompose.h</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineplus">+++ /dev/null</span>
<a href="#l23.4"></a><span id="l23.4" class="difflineat">@@ -1,171 +0,0 @@</span>
<a href="#l23.5"></a><span id="l23.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-</span>
<a href="#l23.6"></a><span id="l23.6" class="difflineminus">- *</span>
<a href="#l23.7"></a><span id="l23.7" class="difflineminus">- * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l23.8"></a><span id="l23.8" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l23.9"></a><span id="l23.9" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l23.10"></a><span id="l23.10" class="difflineminus">-</span>
<a href="#l23.11"></a><span id="l23.11" class="difflineminus">-#ifndef nsEudoraCompose_h__</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-#define nsEudoraCompose_h__</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineminus">-</span>
<a href="#l23.14"></a><span id="l23.14" class="difflineminus">-#include &quot;nscore.h&quot;</span>
<a href="#l23.15"></a><span id="l23.15" class="difflineminus">-#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l23.16"></a><span id="l23.16" class="difflineminus">-#include &quot;nsStringGlue.h&quot;</span>
<a href="#l23.17"></a><span id="l23.17" class="difflineminus">-#include &quot;nsMsgUtils.h&quot;</span>
<a href="#l23.18"></a><span id="l23.18" class="difflineminus">-#include &quot;nsIFile.h&quot;</span>
<a href="#l23.19"></a><span id="l23.19" class="difflineminus">-#include &quot;nsIInputStream.h&quot;</span>
<a href="#l23.20"></a><span id="l23.20" class="difflineminus">-#include &quot;nsTArray.h&quot;</span>
<a href="#l23.21"></a><span id="l23.21" class="difflineminus">-#include &quot;nsIImportService.h&quot;</span>
<a href="#l23.22"></a><span id="l23.22" class="difflineminus">-</span>
<a href="#l23.23"></a><span id="l23.23" class="difflineminus">-#ifdef MOZILLA_INTERNAL_API</span>
<a href="#l23.24"></a><span id="l23.24" class="difflineminus">-#include &quot;nsNativeCharsetUtils.h&quot;</span>
<a href="#l23.25"></a><span id="l23.25" class="difflineminus">-#else</span>
<a href="#l23.26"></a><span id="l23.26" class="difflineminus">-#include &quot;nsMsgI18N.h&quot;</span>
<a href="#l23.27"></a><span id="l23.27" class="difflineminus">-#define NS_CopyNativeToUnicode(source, dest) \</span>
<a href="#l23.28"></a><span id="l23.28" class="difflineminus">-        nsMsgI18NConvertToUnicode(nsMsgI18NFileSystemCharset(), source, dest)</span>
<a href="#l23.29"></a><span id="l23.29" class="difflineminus">-#endif</span>
<a href="#l23.30"></a><span id="l23.30" class="difflineminus">-</span>
<a href="#l23.31"></a><span id="l23.31" class="difflineminus">-class nsIMsgSend;</span>
<a href="#l23.32"></a><span id="l23.32" class="difflineminus">-class nsIMsgCompFields;</span>
<a href="#l23.33"></a><span id="l23.33" class="difflineminus">-class nsIMsgIdentity;</span>
<a href="#l23.34"></a><span id="l23.34" class="difflineminus">-class nsIMsgSendListener;</span>
<a href="#l23.35"></a><span id="l23.35" class="difflineminus">-class nsIIOService;</span>
<a href="#l23.36"></a><span id="l23.36" class="difflineminus">-</span>
<a href="#l23.37"></a><span id="l23.37" class="difflineminus">-#include &quot;nsIMsgSend.h&quot;</span>
<a href="#l23.38"></a><span id="l23.38" class="difflineminus">-</span>
<a href="#l23.39"></a><span id="l23.39" class="difflineminus">-</span>
<a href="#l23.40"></a><span id="l23.40" class="difflineminus">-typedef class {</span>
<a href="#l23.41"></a><span id="l23.41" class="difflineminus">-public:</span>
<a href="#l23.42"></a><span id="l23.42" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt;  pAttachment;</span>
<a href="#l23.43"></a><span id="l23.43" class="difflineminus">-  char *      mimeType;</span>
<a href="#l23.44"></a><span id="l23.44" class="difflineminus">-  char *      description;</span>
<a href="#l23.45"></a><span id="l23.45" class="difflineminus">-} ImportAttachment;</span>
<a href="#l23.46"></a><span id="l23.46" class="difflineminus">-</span>
<a href="#l23.47"></a><span id="l23.47" class="difflineminus">-typedef class {</span>
<a href="#l23.48"></a><span id="l23.48" class="difflineminus">-public:</span>
<a href="#l23.49"></a><span id="l23.49" class="difflineminus">-  uint32_t    offset;</span>
<a href="#l23.50"></a><span id="l23.50" class="difflineminus">-  int64_t    size;</span>
<a href="#l23.51"></a><span id="l23.51" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt;  pFile;</span>
<a href="#l23.52"></a><span id="l23.52" class="difflineminus">-        nsCOMPtr &lt;nsIInputStream&gt; pInputStream;</span>
<a href="#l23.53"></a><span id="l23.53" class="difflineminus">-} ReadFileState;</span>
<a href="#l23.54"></a><span id="l23.54" class="difflineminus">-</span>
<a href="#l23.55"></a><span id="l23.55" class="difflineminus">-class SimpleBufferTonyRCopiedOnce {</span>
<a href="#l23.56"></a><span id="l23.56" class="difflineminus">-public:</span>
<a href="#l23.57"></a><span id="l23.57" class="difflineminus">-  SimpleBufferTonyRCopiedOnce() {m_pBuffer = nullptr; m_size = 0; m_growBy = 4096; m_writeOffset = 0;</span>
<a href="#l23.58"></a><span id="l23.58" class="difflineminus">-          m_bytesInBuf = 0; m_convertCRs = false;}</span>
<a href="#l23.59"></a><span id="l23.59" class="difflineminus">-  ~SimpleBufferTonyRCopiedOnce() { if (m_pBuffer) delete [] m_pBuffer;}</span>
<a href="#l23.60"></a><span id="l23.60" class="difflineminus">-</span>
<a href="#l23.61"></a><span id="l23.61" class="difflineminus">-  bool Allocate(int32_t sz) {</span>
<a href="#l23.62"></a><span id="l23.62" class="difflineminus">-    if (m_pBuffer)</span>
<a href="#l23.63"></a><span id="l23.63" class="difflineminus">-      delete [] m_pBuffer;</span>
<a href="#l23.64"></a><span id="l23.64" class="difflineminus">-    m_pBuffer = new char[sz];</span>
<a href="#l23.65"></a><span id="l23.65" class="difflineminus">-    if (m_pBuffer) {</span>
<a href="#l23.66"></a><span id="l23.66" class="difflineminus">-      m_size = sz;</span>
<a href="#l23.67"></a><span id="l23.67" class="difflineminus">-      return true;</span>
<a href="#l23.68"></a><span id="l23.68" class="difflineminus">-    }</span>
<a href="#l23.69"></a><span id="l23.69" class="difflineminus">-    m_size = 0;</span>
<a href="#l23.70"></a><span id="l23.70" class="difflineminus">-    return false;</span>
<a href="#l23.71"></a><span id="l23.71" class="difflineminus">-  }</span>
<a href="#l23.72"></a><span id="l23.72" class="difflineminus">-</span>
<a href="#l23.73"></a><span id="l23.73" class="difflineminus">-  bool Grow(int32_t newSize) { if (newSize &gt; m_size) return ReAllocate(newSize); else return true;}</span>
<a href="#l23.74"></a><span id="l23.74" class="difflineminus">-  bool ReAllocate(int32_t newSize) {</span>
<a href="#l23.75"></a><span id="l23.75" class="difflineminus">-    if (newSize &lt;= m_size) return true;</span>
<a href="#l23.76"></a><span id="l23.76" class="difflineminus">-    char *pOldBuffer = m_pBuffer;</span>
<a href="#l23.77"></a><span id="l23.77" class="difflineminus">-    int32_t  oldSize = m_size;</span>
<a href="#l23.78"></a><span id="l23.78" class="difflineminus">-    m_pBuffer = nullptr;</span>
<a href="#l23.79"></a><span id="l23.79" class="difflineminus">-    while (m_size &lt; newSize) m_size += m_growBy;</span>
<a href="#l23.80"></a><span id="l23.80" class="difflineminus">-    if (Allocate(m_size)) {</span>
<a href="#l23.81"></a><span id="l23.81" class="difflineminus">-      if (pOldBuffer) { memcpy(m_pBuffer, pOldBuffer, oldSize); delete [] pOldBuffer;}</span>
<a href="#l23.82"></a><span id="l23.82" class="difflineminus">-      return true;</span>
<a href="#l23.83"></a><span id="l23.83" class="difflineminus">-    }</span>
<a href="#l23.84"></a><span id="l23.84" class="difflineminus">-    else { m_pBuffer = pOldBuffer; m_size = oldSize; return false;}</span>
<a href="#l23.85"></a><span id="l23.85" class="difflineminus">-  }</span>
<a href="#l23.86"></a><span id="l23.86" class="difflineminus">-</span>
<a href="#l23.87"></a><span id="l23.87" class="difflineminus">-  bool Write(int32_t offset, const char *pData, int32_t len, int32_t *pWritten) {</span>
<a href="#l23.88"></a><span id="l23.88" class="difflineminus">-    *pWritten = len;</span>
<a href="#l23.89"></a><span id="l23.89" class="difflineminus">-    if (!len) return true;</span>
<a href="#l23.90"></a><span id="l23.90" class="difflineminus">-    if (!Grow(offset + len)) return false;</span>
<a href="#l23.91"></a><span id="l23.91" class="difflineminus">-    if (m_convertCRs)</span>
<a href="#l23.92"></a><span id="l23.92" class="difflineminus">-      return SpecialMemCpy(offset, pData, len, pWritten);</span>
<a href="#l23.93"></a><span id="l23.93" class="difflineminus">-    memcpy(m_pBuffer + offset, pData, len);</span>
<a href="#l23.94"></a><span id="l23.94" class="difflineminus">-    return true;</span>
<a href="#l23.95"></a><span id="l23.95" class="difflineminus">-  }</span>
<a href="#l23.96"></a><span id="l23.96" class="difflineminus">-</span>
<a href="#l23.97"></a><span id="l23.97" class="difflineminus">-  bool Write(const char *pData, int32_t len) {</span>
<a href="#l23.98"></a><span id="l23.98" class="difflineminus">-    int32_t written;</span>
<a href="#l23.99"></a><span id="l23.99" class="difflineminus">-    if (Write(m_writeOffset, pData, len, &amp;written)) { m_writeOffset += written; return true;}</span>
<a href="#l23.100"></a><span id="l23.100" class="difflineminus">-    else return false;</span>
<a href="#l23.101"></a><span id="l23.101" class="difflineminus">-  }</span>
<a href="#l23.102"></a><span id="l23.102" class="difflineminus">-</span>
<a href="#l23.103"></a><span id="l23.103" class="difflineminus">-  bool    SpecialMemCpy(int32_t offset, const char *pData, int32_t len, int32_t *pWritten);</span>
<a href="#l23.104"></a><span id="l23.104" class="difflineminus">-</span>
<a href="#l23.105"></a><span id="l23.105" class="difflineminus">-  bool    m_convertCRs;</span>
<a href="#l23.106"></a><span id="l23.106" class="difflineminus">-  char *  m_pBuffer;</span>
<a href="#l23.107"></a><span id="l23.107" class="difflineminus">-  uint32_t  m_bytesInBuf;  // used when reading into this buffer</span>
<a href="#l23.108"></a><span id="l23.108" class="difflineminus">-  int32_t  m_size;      // allocated size of buffer</span>
<a href="#l23.109"></a><span id="l23.109" class="difflineminus">-  int32_t  m_growBy;    // duh</span>
<a href="#l23.110"></a><span id="l23.110" class="difflineminus">-  uint32_t m_writeOffset;  // used when writing into and reading from the buffer</span>
<a href="#l23.111"></a><span id="l23.111" class="difflineminus">-};</span>
<a href="#l23.112"></a><span id="l23.112" class="difflineminus">-</span>
<a href="#l23.113"></a><span id="l23.113" class="difflineminus">-</span>
<a href="#l23.114"></a><span id="l23.114" class="difflineminus">-</span>
<a href="#l23.115"></a><span id="l23.115" class="difflineminus">-class nsEudoraCompose {</span>
<a href="#l23.116"></a><span id="l23.116" class="difflineminus">-public:</span>
<a href="#l23.117"></a><span id="l23.117" class="difflineminus">-  nsEudoraCompose();</span>
<a href="#l23.118"></a><span id="l23.118" class="difflineminus">-  ~nsEudoraCompose();</span>
<a href="#l23.119"></a><span id="l23.119" class="difflineminus">-</span>
<a href="#l23.120"></a><span id="l23.120" class="difflineminus">-  nsresult  SendTheMessage(nsIFile *pMailImportLocation, nsIFile **pMsg);</span>
<a href="#l23.121"></a><span id="l23.121" class="difflineminus">-</span>
<a href="#l23.122"></a><span id="l23.122" class="difflineminus">-  void    SetBody(const char *pBody, int32_t len, nsCString &amp;bodyType) { m_pBody = pBody; m_bodyLen = len; m_bodyType = bodyType;}</span>
<a href="#l23.123"></a><span id="l23.123" class="difflineminus">-  void    SetHeaders(const char *pHeaders, int32_t len) { m_pHeaders = pHeaders; m_headerLen = len;}</span>
<a href="#l23.124"></a><span id="l23.124" class="difflineminus">-  void    SetAttachments(nsTArray&lt;ImportAttachment*&gt; *pAttachments) { m_pAttachments = pAttachments;}</span>
<a href="#l23.125"></a><span id="l23.125" class="difflineminus">-  void    SetDefaultDate(nsCString date) { m_defaultDate = date;}</span>
<a href="#l23.126"></a><span id="l23.126" class="difflineminus">-</span>
<a href="#l23.127"></a><span id="l23.127" class="difflineminus">-  nsresult  CopyComposedMessage(nsCString&amp; fromLine, nsIFile *pSrc, nsIOutputStream *pDst, SimpleBufferTonyRCopiedOnce&amp; copy);</span>
<a href="#l23.128"></a><span id="l23.128" class="difflineminus">-</span>
<a href="#l23.129"></a><span id="l23.129" class="difflineminus">-  static nsresult  FillMailBuffer(ReadFileState *pState, SimpleBufferTonyRCopiedOnce&amp; read);</span>
<a href="#l23.130"></a><span id="l23.130" class="difflineminus">-  static nsresult CreateIdentity(void);</span>
<a href="#l23.131"></a><span id="l23.131" class="difflineminus">-  static void    ReleaseIdentity(void);</span>
<a href="#l23.132"></a><span id="l23.132" class="difflineminus">-</span>
<a href="#l23.133"></a><span id="l23.133" class="difflineminus">-private:</span>
<a href="#l23.134"></a><span id="l23.134" class="difflineminus">-  nsresult  CreateComponents(void);</span>
<a href="#l23.135"></a><span id="l23.135" class="difflineminus">-</span>
<a href="#l23.136"></a><span id="l23.136" class="difflineminus">-  void    GetNthHeader(const char *pData, int32_t dataLen, int32_t n, nsCString&amp; header, nsCString&amp; val, bool unwrap);</span>
<a href="#l23.137"></a><span id="l23.137" class="difflineminus">-  void    GetHeaderValue(const char *pData, int32_t dataLen, const char *pHeader, nsCString&amp; val, bool unwrap = true);</span>
<a href="#l23.138"></a><span id="l23.138" class="difflineminus">-  void    GetHeaderValue(const char *pData, int32_t dataLen, const char *pHeader, nsString&amp; val) {</span>
<a href="#l23.139"></a><span id="l23.139" class="difflineminus">-    val.Truncate();</span>
<a href="#l23.140"></a><span id="l23.140" class="difflineminus">-    nsCString  hVal;</span>
<a href="#l23.141"></a><span id="l23.141" class="difflineminus">-    GetHeaderValue(pData, dataLen, pHeader, hVal, true);</span>
<a href="#l23.142"></a><span id="l23.142" class="difflineminus">-    NS_CopyNativeToUnicode(hVal, val);</span>
<a href="#l23.143"></a><span id="l23.143" class="difflineminus">-  }</span>
<a href="#l23.144"></a><span id="l23.144" class="difflineminus">-  void    ExtractCharset(nsString&amp; str);</span>
<a href="#l23.145"></a><span id="l23.145" class="difflineminus">-  void    ExtractType(nsString&amp; str);</span>
<a href="#l23.146"></a><span id="l23.146" class="difflineminus">-</span>
<a href="#l23.147"></a><span id="l23.147" class="difflineminus">-  nsresult GetLocalAttachments(nsIArray **aArray);</span>
<a href="#l23.148"></a><span id="l23.148" class="difflineminus">-</span>
<a href="#l23.149"></a><span id="l23.149" class="difflineminus">-  nsresult  ReadHeaders(ReadFileState *pState, SimpleBufferTonyRCopiedOnce&amp; copy, SimpleBufferTonyRCopiedOnce&amp; header);</span>
<a href="#l23.150"></a><span id="l23.150" class="difflineminus">-  int32_t    FindNextEndLine(SimpleBufferTonyRCopiedOnce&amp; data);</span>
<a href="#l23.151"></a><span id="l23.151" class="difflineminus">-  int32_t    IsEndHeaders(SimpleBufferTonyRCopiedOnce&amp; data);</span>
<a href="#l23.152"></a><span id="l23.152" class="difflineminus">-  int32_t    IsSpecialHeader(const char *pHeader);</span>
<a href="#l23.153"></a><span id="l23.153" class="difflineminus">-  nsresult  WriteHeaders(nsIOutputStream *pDst, SimpleBufferTonyRCopiedOnce&amp; newHeaders);</span>
<a href="#l23.154"></a><span id="l23.154" class="difflineminus">-  bool      IsReplaceHeader(const char *pHeader);</span>
<a href="#l23.155"></a><span id="l23.155" class="difflineminus">-</span>
<a href="#l23.156"></a><span id="l23.156" class="difflineminus">-private:</span>
<a href="#l23.157"></a><span id="l23.157" class="difflineminus">-  static nsIMsgIdentity *    s_pIdentity;</span>
<a href="#l23.158"></a><span id="l23.158" class="difflineminus">-</span>
<a href="#l23.159"></a><span id="l23.159" class="difflineminus">-  nsTArray&lt;ImportAttachment*&gt; *  m_pAttachments;</span>
<a href="#l23.160"></a><span id="l23.160" class="difflineminus">-  nsIMsgSendListener *  m_pListener;</span>
<a href="#l23.161"></a><span id="l23.161" class="difflineminus">-  nsIMsgCompFields *    m_pMsgFields;</span>
<a href="#l23.162"></a><span id="l23.162" class="difflineminus">-  nsCOMPtr&lt;nsIIOService&gt; m_pIOService;</span>
<a href="#l23.163"></a><span id="l23.163" class="difflineminus">-  int32_t          m_headerLen;</span>
<a href="#l23.164"></a><span id="l23.164" class="difflineminus">-  const char *      m_pHeaders;</span>
<a href="#l23.165"></a><span id="l23.165" class="difflineminus">-  int32_t          m_bodyLen;</span>
<a href="#l23.166"></a><span id="l23.166" class="difflineminus">-  const char *      m_pBody;</span>
<a href="#l23.167"></a><span id="l23.167" class="difflineminus">-  nsCString        m_bodyType;</span>
<a href="#l23.168"></a><span id="l23.168" class="difflineminus">-  nsString        m_defCharset;</span>
<a href="#l23.169"></a><span id="l23.169" class="difflineminus">-  SimpleBufferTonyRCopiedOnce      m_readHeaders;</span>
<a href="#l23.170"></a><span id="l23.170" class="difflineminus">-  nsCOMPtr&lt;nsIImportService&gt;  m_pImportService;</span>
<a href="#l23.171"></a><span id="l23.171" class="difflineminus">-  nsCString       m_defaultDate;  // Use this if no Date: header in msgs</span>
<a href="#l23.172"></a><span id="l23.172" class="difflineminus">-};</span>
<a href="#l23.173"></a><span id="l23.173" class="difflineminus">-</span>
<a href="#l23.174"></a><span id="l23.174" class="difflineminus">-</span>
<a href="#l23.175"></a><span id="l23.175" class="difflineminus">-#endif /* nsEudoraCompose_h__ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1">deleted file mode 100644</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineminus">--- a/mailnews/import/eudora/src/nsEudoraEditor.cpp</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineplus">+++ /dev/null</span>
<a href="#l24.4"></a><span id="l24.4" class="difflineat">@@ -1,287 +0,0 @@</span>
<a href="#l24.5"></a><span id="l24.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l24.6"></a><span id="l24.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l24.7"></a><span id="l24.7" class="difflineminus">-* License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l24.8"></a><span id="l24.8" class="difflineminus">-* file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l24.9"></a><span id="l24.9" class="difflineminus">-</span>
<a href="#l24.10"></a><span id="l24.10" class="difflineminus">-</span>
<a href="#l24.11"></a><span id="l24.11" class="difflineminus">-#include &quot;nsEudoraEditor.h&quot;</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-#include &quot;nsIArray.h&quot;</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineminus">-#include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l24.14"></a><span id="l24.14" class="difflineminus">-#include &quot;nsStringGlue.h&quot;</span>
<a href="#l24.15"></a><span id="l24.15" class="difflineminus">-#include &quot;nsMsgUtils.h&quot;</span>
<a href="#l24.16"></a><span id="l24.16" class="difflineminus">-#include &quot;nsNetUtil.h&quot;</span>
<a href="#l24.17"></a><span id="l24.17" class="difflineminus">-#include &quot;nsImportEmbeddedImageData.h&quot;</span>
<a href="#l24.18"></a><span id="l24.18" class="difflineminus">-</span>
<a href="#l24.19"></a><span id="l24.19" class="difflineminus">-static char *     sEudoraEmbeddedContentLines[] = {</span>
<a href="#l24.20"></a><span id="l24.20" class="difflineminus">-  &quot;Embedded Content: &quot;,</span>
<a href="#l24.21"></a><span id="l24.21" class="difflineminus">-  &quot;\0&quot;  //  Explicit terminating string</span>
<a href="#l24.22"></a><span id="l24.22" class="difflineminus">-};</span>
<a href="#l24.23"></a><span id="l24.23" class="difflineminus">-</span>
<a href="#l24.24"></a><span id="l24.24" class="difflineminus">-// Lightly adapted from code in Windows Eudora that hashes the img src cid.</span>
<a href="#l24.25"></a><span id="l24.25" class="difflineminus">-static uint32_t EudoraHashString(const char* pszStr)</span>
<a href="#l24.26"></a><span id="l24.26" class="difflineminus">-{</span>
<a href="#l24.27"></a><span id="l24.27" class="difflineminus">-  uint32_t        ulSum = 0;</span>
<a href="#l24.28"></a><span id="l24.28" class="difflineminus">-  const uint32_t  kKRHashPrime = 2147483629;</span>
<a href="#l24.29"></a><span id="l24.29" class="difflineminus">-</span>
<a href="#l24.30"></a><span id="l24.30" class="difflineminus">-  // algorithm: KRHash---derived from Karp &amp; Rabin, Harvard Center for Research</span>
<a href="#l24.31"></a><span id="l24.31" class="difflineminus">-  // in Computing Technology Tech. Report TR-31-81. The constant prime number,</span>
<a href="#l24.32"></a><span id="l24.32" class="difflineminus">-  // kKRHashPrime, happens to be the largest prime number that will fit in</span>
<a href="#l24.33"></a><span id="l24.33" class="difflineminus">-  // 31 bits, except for 2^31-1 itself.</span>
<a href="#l24.34"></a><span id="l24.34" class="difflineminus">-</span>
<a href="#l24.35"></a><span id="l24.35" class="difflineminus">-  for (; *pszStr; pszStr++)</span>
<a href="#l24.36"></a><span id="l24.36" class="difflineminus">-  {</span>
<a href="#l24.37"></a><span id="l24.37" class="difflineminus">-    for (int32_t nBit = 0x80; nBit != 0; nBit &gt;&gt;= 1)</span>
<a href="#l24.38"></a><span id="l24.38" class="difflineminus">-    {</span>
<a href="#l24.39"></a><span id="l24.39" class="difflineminus">-      ulSum += ulSum;</span>
<a href="#l24.40"></a><span id="l24.40" class="difflineminus">-      if (ulSum &gt;= kKRHashPrime)</span>
<a href="#l24.41"></a><span id="l24.41" class="difflineminus">-        ulSum -= kKRHashPrime;</span>
<a href="#l24.42"></a><span id="l24.42" class="difflineminus">-      if ((*pszStr) &amp; nBit)</span>
<a href="#l24.43"></a><span id="l24.43" class="difflineminus">-        ++ulSum;</span>
<a href="#l24.44"></a><span id="l24.44" class="difflineminus">-      if (ulSum&gt;= kKRHashPrime)</span>
<a href="#l24.45"></a><span id="l24.45" class="difflineminus">-        ulSum -= kKRHashPrime;</span>
<a href="#l24.46"></a><span id="l24.46" class="difflineminus">-    }</span>
<a href="#l24.47"></a><span id="l24.47" class="difflineminus">-  }</span>
<a href="#l24.48"></a><span id="l24.48" class="difflineminus">-</span>
<a href="#l24.49"></a><span id="l24.49" class="difflineminus">-  return ulSum + 1;</span>
<a href="#l24.50"></a><span id="l24.50" class="difflineminus">-}</span>
<a href="#l24.51"></a><span id="l24.51" class="difflineminus">-</span>
<a href="#l24.52"></a><span id="l24.52" class="difflineminus">-</span>
<a href="#l24.53"></a><span id="l24.53" class="difflineminus">-nsEudoraEditor::nsEudoraEditor(const char * pBody, nsIFile * pMailImportLocation)</span>
<a href="#l24.54"></a><span id="l24.54" class="difflineminus">-  : m_body(pBody)</span>
<a href="#l24.55"></a><span id="l24.55" class="difflineminus">-{</span>
<a href="#l24.56"></a><span id="l24.56" class="difflineminus">-  m_pMailImportLocation = pMailImportLocation;</span>
<a href="#l24.57"></a><span id="l24.57" class="difflineminus">-}</span>
<a href="#l24.58"></a><span id="l24.58" class="difflineminus">-</span>
<a href="#l24.59"></a><span id="l24.59" class="difflineminus">-</span>
<a href="#l24.60"></a><span id="l24.60" class="difflineminus">-nsEudoraEditor::~nsEudoraEditor()</span>
<a href="#l24.61"></a><span id="l24.61" class="difflineminus">-{</span>
<a href="#l24.62"></a><span id="l24.62" class="difflineminus">-}</span>
<a href="#l24.63"></a><span id="l24.63" class="difflineminus">-</span>
<a href="#l24.64"></a><span id="l24.64" class="difflineminus">-nsresult nsEudoraEditor::GetEmbeddedObjects(nsIArray ** aNodeList)</span>
<a href="#l24.65"></a><span id="l24.65" class="difflineminus">-{</span>
<a href="#l24.66"></a><span id="l24.66" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aNodeList);</span>
<a href="#l24.67"></a><span id="l24.67" class="difflineminus">-</span>
<a href="#l24.68"></a><span id="l24.68" class="difflineminus">-  // Check to see if we were already called</span>
<a href="#l24.69"></a><span id="l24.69" class="difflineminus">-  if (m_EmbeddedObjectList != nullptr)</span>
<a href="#l24.70"></a><span id="l24.70" class="difflineminus">-  {</span>
<a href="#l24.71"></a><span id="l24.71" class="difflineminus">-    *aNodeList = m_EmbeddedObjectList;</span>
<a href="#l24.72"></a><span id="l24.72" class="difflineminus">-    return NS_OK;</span>
<a href="#l24.73"></a><span id="l24.73" class="difflineminus">-  }</span>
<a href="#l24.74"></a><span id="l24.74" class="difflineminus">-</span>
<a href="#l24.75"></a><span id="l24.75" class="difflineminus">-  // Create array in m_EmbeddedObjectList</span>
<a href="#l24.76"></a><span id="l24.76" class="difflineminus">-  nsresult rv;</span>
<a href="#l24.77"></a><span id="l24.77" class="difflineminus">-  m_EmbeddedObjectList = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l24.78"></a><span id="l24.78" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.79"></a><span id="l24.79" class="difflineminus">-</span>
<a href="#l24.80"></a><span id="l24.80" class="difflineminus">-  // Return m_EmbeddedObjectList in aNodeList and increment ref count - caller</span>
<a href="#l24.81"></a><span id="l24.81" class="difflineminus">-  // assumes that we incremented the ref count.</span>
<a href="#l24.82"></a><span id="l24.82" class="difflineminus">-  NS_IF_ADDREF(*aNodeList = m_EmbeddedObjectList);</span>
<a href="#l24.83"></a><span id="l24.83" class="difflineminus">-</span>
<a href="#l24.84"></a><span id="l24.84" class="difflineminus">-  // Create the embedded folder spec</span>
<a href="#l24.85"></a><span id="l24.85" class="difflineminus">-  nsCOMPtr&lt;nsIFile&gt;   embeddedFolderSpec;</span>
<a href="#l24.86"></a><span id="l24.86" class="difflineminus">-  // Create the embedded image spec</span>
<a href="#l24.87"></a><span id="l24.87" class="difflineminus">-  nsCOMPtr&lt;nsIFile&gt;   embeddedImageSpec;</span>
<a href="#l24.88"></a><span id="l24.88" class="difflineminus">-</span>
<a href="#l24.89"></a><span id="l24.89" class="difflineminus">-  // Fill in the details for the embedded folder spec - &quot;Embedded&quot; folder</span>
<a href="#l24.90"></a><span id="l24.90" class="difflineminus">-  // inside of the mail folder. We don't bother to check to see if the embedded</span>
<a href="#l24.91"></a><span id="l24.91" class="difflineminus">-  // folder exists, because it seems to me that would only save time in the</span>
<a href="#l24.92"></a><span id="l24.92" class="difflineminus">-  // unexpected case where it doesn't exist. Keep in mind that we will be checking</span>
<a href="#l24.93"></a><span id="l24.93" class="difflineminus">-  // for the existence of any embedded images anyway - if the folder doesn't</span>
<a href="#l24.94"></a><span id="l24.94" class="difflineminus">-  // exist that check will fail.</span>
<a href="#l24.95"></a><span id="l24.95" class="difflineminus">-  rv = m_pMailImportLocation-&gt;Clone(getter_AddRefs(embeddedFolderSpec));</span>
<a href="#l24.96"></a><span id="l24.96" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.97"></a><span id="l24.97" class="difflineminus">-  embeddedFolderSpec-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;Embedded&quot;));</span>
<a href="#l24.98"></a><span id="l24.98" class="difflineminus">-</span>
<a href="#l24.99"></a><span id="l24.99" class="difflineminus">-  // Look for the start of the last closing tag so that we only search for</span>
<a href="#l24.100"></a><span id="l24.100" class="difflineminus">-  // valid &quot;Embedded Content&quot; lines. (In practice this is not super important,</span>
<a href="#l24.101"></a><span id="l24.101" class="difflineminus">-  // but there were some proof of concept exploits at one point where &quot;Embedded</span>
<a href="#l24.102"></a><span id="l24.102" class="difflineminus">-  // Content&quot; lines were faked in the body of messages).</span>
<a href="#l24.103"></a><span id="l24.103" class="difflineminus">-  int32_t     startLastClosingTag = m_body.RFind(&quot;&lt;/&quot;);</span>
<a href="#l24.104"></a><span id="l24.104" class="difflineminus">-  if (startLastClosingTag == kNotFound)</span>
<a href="#l24.105"></a><span id="l24.105" class="difflineminus">-    startLastClosingTag = 0;</span>
<a href="#l24.106"></a><span id="l24.106" class="difflineminus">-  bool        foundEmbeddedContentLines = false;</span>
<a href="#l24.107"></a><span id="l24.107" class="difflineminus">-</span>
<a href="#l24.108"></a><span id="l24.108" class="difflineminus">-  // Search for various translations of &quot;Embedded Content&quot; - as of this writing only</span>
<a href="#l24.109"></a><span id="l24.109" class="difflineminus">-  // one that I know of, but then again I didn't realize that Eudora translators had</span>
<a href="#l24.110"></a><span id="l24.110" class="difflineminus">-  // ever translated &quot;Attachment Converted&quot; as suggested by other Eudora importing code.</span>
<a href="#l24.111"></a><span id="l24.111" class="difflineminus">-  for (int32_t i = 0; *sEudoraEmbeddedContentLines[i] != '\0'; i++)</span>
<a href="#l24.112"></a><span id="l24.112" class="difflineminus">-  {</span>
<a href="#l24.113"></a><span id="l24.113" class="difflineminus">-    // Search for &quot;Embedded Content: &quot; lines starting after last closing tag (if any)</span>
<a href="#l24.114"></a><span id="l24.114" class="difflineminus">-    int32_t   startEmbeddedContentLine = startLastClosingTag;</span>
<a href="#l24.115"></a><span id="l24.115" class="difflineminus">-    int32_t   lenEmbeddedContentTag = strlen(sEudoraEmbeddedContentLines[i]);</span>
<a href="#l24.116"></a><span id="l24.116" class="difflineminus">-</span>
<a href="#l24.117"></a><span id="l24.117" class="difflineminus">-    while ((startEmbeddedContentLine = m_body.Find(sEudoraEmbeddedContentLines[i],</span>
<a href="#l24.118"></a><span id="l24.118" class="difflineminus">-                                                   true,</span>
<a href="#l24.119"></a><span id="l24.119" class="difflineminus">-                                                   startEmbeddedContentLine+1)) != kNotFound)</span>
<a href="#l24.120"></a><span id="l24.120" class="difflineminus">-    {</span>
<a href="#l24.121"></a><span id="l24.121" class="difflineminus">-      // Found this translation of &quot;Embedded Content&quot; - remember that so that we don't</span>
<a href="#l24.122"></a><span id="l24.122" class="difflineminus">-      // bother looking for any other translations.</span>
<a href="#l24.123"></a><span id="l24.123" class="difflineminus">-      foundEmbeddedContentLines = true;</span>
<a href="#l24.124"></a><span id="l24.124" class="difflineminus">-</span>
<a href="#l24.125"></a><span id="l24.125" class="difflineminus">-      // Extract the file name from the embedded content line</span>
<a href="#l24.126"></a><span id="l24.126" class="difflineminus">-      int32_t   startFileName = startEmbeddedContentLine + lenEmbeddedContentTag;</span>
<a href="#l24.127"></a><span id="l24.127" class="difflineminus">-      int32_t   endFileName = m_body.Find(&quot;:&quot;, false, startFileName);</span>
<a href="#l24.128"></a><span id="l24.128" class="difflineminus">-</span>
<a href="#l24.129"></a><span id="l24.129" class="difflineminus">-      // Create the file spec for the embedded image</span>
<a href="#l24.130"></a><span id="l24.130" class="difflineminus">-      embeddedFolderSpec-&gt;Clone(getter_AddRefs(embeddedImageSpec));</span>
<a href="#l24.131"></a><span id="l24.131" class="difflineminus">-      embeddedImageSpec-&gt;Append(Substring(m_body, startFileName, endFileName - startFileName));</span>
<a href="#l24.132"></a><span id="l24.132" class="difflineminus">-</span>
<a href="#l24.133"></a><span id="l24.133" class="difflineminus">-      // Verify that the embedded image spec exists and is a file</span>
<a href="#l24.134"></a><span id="l24.134" class="difflineminus">-      bool      isFile = false;</span>
<a href="#l24.135"></a><span id="l24.135" class="difflineminus">-      bool      exists = false;</span>
<a href="#l24.136"></a><span id="l24.136" class="difflineminus">-      if (NS_FAILED(embeddedImageSpec-&gt;Exists(&amp;exists)) || NS_FAILED(embeddedImageSpec-&gt;IsFile(&amp;isFile)))</span>
<a href="#l24.137"></a><span id="l24.137" class="difflineminus">-        continue;</span>
<a href="#l24.138"></a><span id="l24.138" class="difflineminus">-      if (!exists || !isFile)</span>
<a href="#l24.139"></a><span id="l24.139" class="difflineminus">-        continue;</span>
<a href="#l24.140"></a><span id="l24.140" class="difflineminus">-</span>
<a href="#l24.141"></a><span id="l24.141" class="difflineminus">-      // Extract CID hash from the embedded content line</span>
<a href="#l24.142"></a><span id="l24.142" class="difflineminus">-      int32_t     cidHashValue;</span>
<a href="#l24.143"></a><span id="l24.143" class="difflineminus">-      int32_t     startCIDHash = m_body.Find(&quot;,&quot;, false, endFileName);</span>
<a href="#l24.144"></a><span id="l24.144" class="difflineminus">-      if (startCIDHash != kNotFound)</span>
<a href="#l24.145"></a><span id="l24.145" class="difflineminus">-      {</span>
<a href="#l24.146"></a><span id="l24.146" class="difflineminus">-        startCIDHash++;</span>
<a href="#l24.147"></a><span id="l24.147" class="difflineminus">-        int32_t   endCIDHash = m_body.Find(&quot;,&quot;, false, startCIDHash);</span>
<a href="#l24.148"></a><span id="l24.148" class="difflineminus">-</span>
<a href="#l24.149"></a><span id="l24.149" class="difflineminus">-        if (endCIDHash != kNotFound)</span>
<a href="#l24.150"></a><span id="l24.150" class="difflineminus">-        {</span>
<a href="#l24.151"></a><span id="l24.151" class="difflineminus">-          nsString    cidHash;</span>
<a href="#l24.152"></a><span id="l24.152" class="difflineminus">-          cidHash.Assign(Substring(m_body, startCIDHash, endCIDHash - startCIDHash));</span>
<a href="#l24.153"></a><span id="l24.153" class="difflineminus">-</span>
<a href="#l24.154"></a><span id="l24.154" class="difflineminus">-          if (!cidHash.IsEmpty())</span>
<a href="#l24.155"></a><span id="l24.155" class="difflineminus">-          {</span>
<a href="#l24.156"></a><span id="l24.156" class="difflineminus">-            // Convert CID hash string to numeric value</span>
<a href="#l24.157"></a><span id="l24.157" class="difflineminus">-            nsresult aErrorCode;</span>
<a href="#l24.158"></a><span id="l24.158" class="difflineminus">-            cidHashValue = cidHash.ToInteger(&amp;aErrorCode, 16);</span>
<a href="#l24.159"></a><span id="l24.159" class="difflineminus">-          }</span>
<a href="#l24.160"></a><span id="l24.160" class="difflineminus">-        }</span>
<a href="#l24.161"></a><span id="l24.161" class="difflineminus">-      }</span>
<a href="#l24.162"></a><span id="l24.162" class="difflineminus">-</span>
<a href="#l24.163"></a><span id="l24.163" class="difflineminus">-      // Get the URL for the embedded image</span>
<a href="#l24.164"></a><span id="l24.164" class="difflineminus">-      nsCString     embeddedImageURL;</span>
<a href="#l24.165"></a><span id="l24.165" class="difflineminus">-      rv = NS_GetURLSpecFromFile(embeddedImageSpec, embeddedImageURL);</span>
<a href="#l24.166"></a><span id="l24.166" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.167"></a><span id="l24.167" class="difflineminus">-</span>
<a href="#l24.168"></a><span id="l24.168" class="difflineminus">-      NS_ConvertASCIItoUTF16 srcUrl(embeddedImageURL);</span>
<a href="#l24.169"></a><span id="l24.169" class="difflineminus">-      nsString cid;</span>
<a href="#l24.170"></a><span id="l24.170" class="difflineminus">-      // We're going to remember the original cid in the image element,</span>
<a href="#l24.171"></a><span id="l24.171" class="difflineminus">-      // which the send code will retrieve as the kMozCIDAttrName property.</span>
<a href="#l24.172"></a><span id="l24.172" class="difflineminus">-      GetEmbeddedImageCID(cidHashValue, srcUrl, cid);</span>
<a href="#l24.173"></a><span id="l24.173" class="difflineminus">-      nsCOMPtr&lt;nsIURI&gt; embeddedFileURI;</span>
<a href="#l24.174"></a><span id="l24.174" class="difflineminus">-      NS_NewFileURI(getter_AddRefs(embeddedFileURI), embeddedImageSpec);</span>
<a href="#l24.175"></a><span id="l24.175" class="difflineminus">-</span>
<a href="#l24.176"></a><span id="l24.176" class="difflineminus">-      // Create the embedded image node</span>
<a href="#l24.177"></a><span id="l24.177" class="difflineminus">-      nsImportEmbeddedImageData *imageData =</span>
<a href="#l24.178"></a><span id="l24.178" class="difflineminus">-        new nsImportEmbeddedImageData(embeddedFileURI, NS_LossyConvertUTF16toASCII(cid));</span>
<a href="#l24.179"></a><span id="l24.179" class="difflineminus">-</span>
<a href="#l24.180"></a><span id="l24.180" class="difflineminus">-      // Append the embedded image node to the list</span>
<a href="#l24.181"></a><span id="l24.181" class="difflineminus">-      m_EmbeddedObjectList-&gt;AppendElement(imageData, false);</span>
<a href="#l24.182"></a><span id="l24.182" class="difflineminus">-</span>
<a href="#l24.183"></a><span id="l24.183" class="difflineminus">-      int32_t   endEmbeddedContentLine = m_body.Find(&quot;\r\n&quot;, true, startEmbeddedContentLine+1);</span>
<a href="#l24.184"></a><span id="l24.184" class="difflineminus">-      if (endEmbeddedContentLine != kNotFound)</span>
<a href="#l24.185"></a><span id="l24.185" class="difflineminus">-      {</span>
<a href="#l24.186"></a><span id="l24.186" class="difflineminus">-        // We recognized the &quot;Embedded Content&quot; line correctly and found the associated image.</span>
<a href="#l24.187"></a><span id="l24.187" class="difflineminus">-        // Remove the Eudora specific line about it now.</span>
<a href="#l24.188"></a><span id="l24.188" class="difflineminus">-        m_body.Cut(startEmbeddedContentLine, endEmbeddedContentLine - startEmbeddedContentLine + 2);</span>
<a href="#l24.189"></a><span id="l24.189" class="difflineminus">-</span>
<a href="#l24.190"></a><span id="l24.190" class="difflineminus">-        // Backup by one to correct where we start looking for the next line</span>
<a href="#l24.191"></a><span id="l24.191" class="difflineminus">-        startEmbeddedContentLine--;</span>
<a href="#l24.192"></a><span id="l24.192" class="difflineminus">-      }</span>
<a href="#l24.193"></a><span id="l24.193" class="difflineminus">-    }</span>
<a href="#l24.194"></a><span id="l24.194" class="difflineminus">-</span>
<a href="#l24.195"></a><span id="l24.195" class="difflineminus">-    // Assume at most one translation for &quot;Embedded Content: &quot; in a given message</span>
<a href="#l24.196"></a><span id="l24.196" class="difflineminus">-    if (foundEmbeddedContentLines)</span>
<a href="#l24.197"></a><span id="l24.197" class="difflineminus">-      break;</span>
<a href="#l24.198"></a><span id="l24.198" class="difflineminus">-  }</span>
<a href="#l24.199"></a><span id="l24.199" class="difflineminus">-</span>
<a href="#l24.200"></a><span id="l24.200" class="difflineminus">-  return NS_OK;</span>
<a href="#l24.201"></a><span id="l24.201" class="difflineminus">-}</span>
<a href="#l24.202"></a><span id="l24.202" class="difflineminus">-</span>
<a href="#l24.203"></a><span id="l24.203" class="difflineminus">-bool nsEudoraEditor::GetEmbeddedImageCID(uint32_t aCIDHash, const nsAString &amp; aOldRef, nsString &amp;aCID)</span>
<a href="#l24.204"></a><span id="l24.204" class="difflineminus">-{</span>
<a href="#l24.205"></a><span id="l24.205" class="difflineminus">-  bool      foundMatch = false;</span>
<a href="#l24.206"></a><span id="l24.206" class="difflineminus">-  int32_t   startImageTag = 0;</span>
<a href="#l24.207"></a><span id="l24.207" class="difflineminus">-  int32_t   closeImageTag = 0;</span>
<a href="#l24.208"></a><span id="l24.208" class="difflineminus">-</span>
<a href="#l24.209"></a><span id="l24.209" class="difflineminus">-  while ((startImageTag = m_body.Find(&quot;&lt;img&quot;, true, closeImageTag)) != kNotFound)</span>
<a href="#l24.210"></a><span id="l24.210" class="difflineminus">-  {</span>
<a href="#l24.211"></a><span id="l24.211" class="difflineminus">-    closeImageTag = m_body.Find(&quot;&gt;&quot;, false, startImageTag);</span>
<a href="#l24.212"></a><span id="l24.212" class="difflineminus">-</span>
<a href="#l24.213"></a><span id="l24.213" class="difflineminus">-    // We should always find a close tag, bail if we don't</span>
<a href="#l24.214"></a><span id="l24.214" class="difflineminus">-    if (closeImageTag == kNotFound)</span>
<a href="#l24.215"></a><span id="l24.215" class="difflineminus">-      break;</span>
<a href="#l24.216"></a><span id="l24.216" class="difflineminus">-</span>
<a href="#l24.217"></a><span id="l24.217" class="difflineminus">-    // Find the source attribute and make sure it's for our image tag</span>
<a href="#l24.218"></a><span id="l24.218" class="difflineminus">-    int32_t   startSrcValue = m_body.Find(&quot;src&quot;, true, startImageTag);</span>
<a href="#l24.219"></a><span id="l24.219" class="difflineminus">-    if ((startSrcValue == kNotFound) || (startSrcValue &gt; closeImageTag))</span>
<a href="#l24.220"></a><span id="l24.220" class="difflineminus">-      continue;</span>
<a href="#l24.221"></a><span id="l24.221" class="difflineminus">-</span>
<a href="#l24.222"></a><span id="l24.222" class="difflineminus">-    // Move past the src</span>
<a href="#l24.223"></a><span id="l24.223" class="difflineminus">-    startSrcValue += 3;</span>
<a href="#l24.224"></a><span id="l24.224" class="difflineminus">-</span>
<a href="#l24.225"></a><span id="l24.225" class="difflineminus">-    // Move past any whitespace</span>
<a href="#l24.226"></a><span id="l24.226" class="difflineminus">-    while (isspace(m_body.CharAt(startSrcValue)))</span>
<a href="#l24.227"></a><span id="l24.227" class="difflineminus">-      ++startSrcValue;</span>
<a href="#l24.228"></a><span id="l24.228" class="difflineminus">-</span>
<a href="#l24.229"></a><span id="l24.229" class="difflineminus">-    // We should find an = now</span>
<a href="#l24.230"></a><span id="l24.230" class="difflineminus">-    if (m_body.CharAt(startSrcValue) != '=')</span>
<a href="#l24.231"></a><span id="l24.231" class="difflineminus">-      continue;</span>
<a href="#l24.232"></a><span id="l24.232" class="difflineminus">-</span>
<a href="#l24.233"></a><span id="l24.233" class="difflineminus">-    // Move past =</span>
<a href="#l24.234"></a><span id="l24.234" class="difflineminus">-    ++startSrcValue;</span>
<a href="#l24.235"></a><span id="l24.235" class="difflineminus">-</span>
<a href="#l24.236"></a><span id="l24.236" class="difflineminus">-    // Move past any whitespace</span>
<a href="#l24.237"></a><span id="l24.237" class="difflineminus">-    while (isspace(m_body.CharAt(startSrcValue)))</span>
<a href="#l24.238"></a><span id="l24.238" class="difflineminus">-      ++startSrcValue;</span>
<a href="#l24.239"></a><span id="l24.239" class="difflineminus">-</span>
<a href="#l24.240"></a><span id="l24.240" class="difflineminus">-    // Get the quote char and verify that it's valid</span>
<a href="#l24.241"></a><span id="l24.241" class="difflineminus">-    char    quoteChar = static_cast &lt;char&gt; (m_body.CharAt(startSrcValue));</span>
<a href="#l24.242"></a><span id="l24.242" class="difflineminus">-    if ((quoteChar != '&quot;') &amp;&amp; (quoteChar != '\''))</span>
<a href="#l24.243"></a><span id="l24.243" class="difflineminus">-      continue;</span>
<a href="#l24.244"></a><span id="l24.244" class="difflineminus">-</span>
<a href="#l24.245"></a><span id="l24.245" class="difflineminus">-    // Move past the quote</span>
<a href="#l24.246"></a><span id="l24.246" class="difflineminus">-    ++startSrcValue;</span>
<a href="#l24.247"></a><span id="l24.247" class="difflineminus">-</span>
<a href="#l24.248"></a><span id="l24.248" class="difflineminus">-    int32_t   endSrcValue = m_body.FindChar(quoteChar, startSrcValue);</span>
<a href="#l24.249"></a><span id="l24.249" class="difflineminus">-    int32_t   srcLength = endSrcValue - startSrcValue;</span>
<a href="#l24.250"></a><span id="l24.250" class="difflineminus">-</span>
<a href="#l24.251"></a><span id="l24.251" class="difflineminus">-    nsString  srcValue;</span>
<a href="#l24.252"></a><span id="l24.252" class="difflineminus">-    aCID.Assign(Substring(m_body, startSrcValue, srcLength));</span>
<a href="#l24.253"></a><span id="l24.253" class="difflineminus">-</span>
<a href="#l24.254"></a><span id="l24.254" class="difflineminus">-    if (aCIDHash != 0)</span>
<a href="#l24.255"></a><span id="l24.255" class="difflineminus">-    {</span>
<a href="#l24.256"></a><span id="l24.256" class="difflineminus">-      // Verify source value starts with &quot;cid:&quot;</span>
<a href="#l24.257"></a><span id="l24.257" class="difflineminus">-      if (!StringBeginsWith(aCID, NS_LITERAL_STRING(&quot;cid:&quot;), nsCaseInsensitiveStringComparator()))</span>
<a href="#l24.258"></a><span id="l24.258" class="difflineminus">-        continue;</span>
<a href="#l24.259"></a><span id="l24.259" class="difflineminus">-</span>
<a href="#l24.260"></a><span id="l24.260" class="difflineminus">-      // Remove &quot;cid:&quot; from the start</span>
<a href="#l24.261"></a><span id="l24.261" class="difflineminus">-      aCID.Cut(0, 4);</span>
<a href="#l24.262"></a><span id="l24.262" class="difflineminus">-</span>
<a href="#l24.263"></a><span id="l24.263" class="difflineminus">-      uint32_t  hashValue = EudoraHashString(NS_LossyConvertUTF16toASCII(aCID).get());</span>
<a href="#l24.264"></a><span id="l24.264" class="difflineminus">-      foundMatch = (hashValue == aCIDHash);</span>
<a href="#l24.265"></a><span id="l24.265" class="difflineminus">-    }</span>
<a href="#l24.266"></a><span id="l24.266" class="difflineminus">-    else</span>
<a href="#l24.267"></a><span id="l24.267" class="difflineminus">-    {</span>
<a href="#l24.268"></a><span id="l24.268" class="difflineminus">-      foundMatch = aCID.Equals(aOldRef);</span>
<a href="#l24.269"></a><span id="l24.269" class="difflineminus">-    }</span>
<a href="#l24.270"></a><span id="l24.270" class="difflineminus">-  }</span>
<a href="#l24.271"></a><span id="l24.271" class="difflineminus">-</span>
<a href="#l24.272"></a><span id="l24.272" class="difflineminus">-  return foundMatch;</span>
<a href="#l24.273"></a><span id="l24.273" class="difflineminus">-}</span>
<a href="#l24.274"></a><span id="l24.274" class="difflineminus">-</span>
<a href="#l24.275"></a><span id="l24.275" class="difflineminus">-</span>
<a href="#l24.276"></a><span id="l24.276" class="difflineminus">-bool nsEudoraEditor::HasEmbeddedContent()</span>
<a href="#l24.277"></a><span id="l24.277" class="difflineminus">-{</span>
<a href="#l24.278"></a><span id="l24.278" class="difflineminus">-  // Simple quick test to see if there's any embedded content lines</span>
<a href="#l24.279"></a><span id="l24.279" class="difflineminus">-  bool     bHasEmbeddedContent = false;</span>
<a href="#l24.280"></a><span id="l24.280" class="difflineminus">-</span>
<a href="#l24.281"></a><span id="l24.281" class="difflineminus">-  for (int32_t i = 0; *sEudoraEmbeddedContentLines[i] != '\0'; i++)</span>
<a href="#l24.282"></a><span id="l24.282" class="difflineminus">-  {</span>
<a href="#l24.283"></a><span id="l24.283" class="difflineminus">-    bHasEmbeddedContent = (m_body.Find(sEudoraEmbeddedContentLines[i], true, 0) != kNotFound);</span>
<a href="#l24.284"></a><span id="l24.284" class="difflineminus">-</span>
<a href="#l24.285"></a><span id="l24.285" class="difflineminus">-    if (bHasEmbeddedContent)</span>
<a href="#l24.286"></a><span id="l24.286" class="difflineminus">-      break;</span>
<a href="#l24.287"></a><span id="l24.287" class="difflineminus">-  }</span>
<a href="#l24.288"></a><span id="l24.288" class="difflineminus">-</span>
<a href="#l24.289"></a><span id="l24.289" class="difflineminus">-  return bHasEmbeddedContent;</span>
<a href="#l24.290"></a><span id="l24.290" class="difflineminus">-}</span>
<a href="#l24.291"></a><span id="l24.291" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1">deleted file mode 100644</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineminus">--- a/mailnews/import/eudora/src/nsEudoraEditor.h</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineplus">+++ /dev/null</span>
<a href="#l25.4"></a><span id="l25.4" class="difflineat">@@ -1,30 +0,0 @@</span>
<a href="#l25.5"></a><span id="l25.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l25.6"></a><span id="l25.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l25.7"></a><span id="l25.7" class="difflineminus">-* License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l25.8"></a><span id="l25.8" class="difflineminus">-* file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l25.9"></a><span id="l25.9" class="difflineminus">-</span>
<a href="#l25.10"></a><span id="l25.10" class="difflineminus">-#include &quot;nscore.h&quot;</span>
<a href="#l25.11"></a><span id="l25.11" class="difflineminus">-#include &quot;nsIEditor.h&quot;</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-#include &quot;nsIEditorMailSupport.h&quot;</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineminus">-#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l25.14"></a><span id="l25.14" class="difflineminus">-#include &quot;nsStringGlue.h&quot;</span>
<a href="#l25.15"></a><span id="l25.15" class="difflineminus">-#include &quot;nsIFile.h&quot;</span>
<a href="#l25.16"></a><span id="l25.16" class="difflineminus">-#include &quot;nsIMutableArray.h&quot;</span>
<a href="#l25.17"></a><span id="l25.17" class="difflineminus">-</span>
<a href="#l25.18"></a><span id="l25.18" class="difflineminus">-</span>
<a href="#l25.19"></a><span id="l25.19" class="difflineminus">-class nsEudoraEditor</span>
<a href="#l25.20"></a><span id="l25.20" class="difflineminus">-{</span>
<a href="#l25.21"></a><span id="l25.21" class="difflineminus">-  public:</span>
<a href="#l25.22"></a><span id="l25.22" class="difflineminus">-    nsEudoraEditor(const char * pBody, nsIFile * pMailImportLocation);</span>
<a href="#l25.23"></a><span id="l25.23" class="difflineminus">-    ~nsEudoraEditor();</span>
<a href="#l25.24"></a><span id="l25.24" class="difflineminus">-</span>
<a href="#l25.25"></a><span id="l25.25" class="difflineminus">-    bool GetEmbeddedImageCID(uint32_t aCIDHash, const nsAString &amp; aOldRef, nsString &amp;aCID);</span>
<a href="#l25.26"></a><span id="l25.26" class="difflineminus">-    bool HasEmbeddedContent();</span>
<a href="#l25.27"></a><span id="l25.27" class="difflineminus">-    nsresult GetEmbeddedObjects(nsIArray ** aNodeList);</span>
<a href="#l25.28"></a><span id="l25.28" class="difflineminus">-    nsresult GetBody(nsAString &amp; _retval) {_retval = m_body; return NS_OK;}</span>
<a href="#l25.29"></a><span id="l25.29" class="difflineminus">-  protected:</span>
<a href="#l25.30"></a><span id="l25.30" class="difflineminus">-    NS_ConvertASCIItoUTF16      m_body;</span>
<a href="#l25.31"></a><span id="l25.31" class="difflineminus">-    nsCOMPtr &lt;nsIFile&gt;          m_pMailImportLocation;</span>
<a href="#l25.32"></a><span id="l25.32" class="difflineminus">-    nsCOMPtr&lt;nsIMutableArray&gt;   m_EmbeddedObjectList; // Initialized when GetEmbeddedObjects is called</span>
<a href="#l25.33"></a><span id="l25.33" class="difflineminus">-};</span>
<a href="#l25.34"></a><span id="l25.34" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1">deleted file mode 100644</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineminus">--- a/mailnews/import/eudora/src/nsEudoraFilters.cpp</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineplus">+++ /dev/null</span>
<a href="#l26.4"></a><span id="l26.4" class="difflineat">@@ -1,924 +0,0 @@</span>
<a href="#l26.5"></a><span id="l26.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l26.6"></a><span id="l26.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l26.7"></a><span id="l26.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l26.8"></a><span id="l26.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l26.9"></a><span id="l26.9" class="difflineminus">-</span>
<a href="#l26.10"></a><span id="l26.10" class="difflineminus">-/*</span>
<a href="#l26.11"></a><span id="l26.11" class="difflineminus">-  Eudora filters</span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-*/</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineminus">-</span>
<a href="#l26.14"></a><span id="l26.14" class="difflineminus">-#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l26.15"></a><span id="l26.15" class="difflineminus">-#include &quot;nscore.h&quot;</span>
<a href="#l26.16"></a><span id="l26.16" class="difflineminus">-#include &quot;nsCRTGlue.h&quot;</span>
<a href="#l26.17"></a><span id="l26.17" class="difflineminus">-#include &quot;nspr.h&quot;</span>
<a href="#l26.18"></a><span id="l26.18" class="difflineminus">-#include &quot;plstr.h&quot;</span>
<a href="#l26.19"></a><span id="l26.19" class="difflineminus">-#include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l26.20"></a><span id="l26.20" class="difflineminus">-#include &quot;nsMsgUtils.h&quot;</span>
<a href="#l26.21"></a><span id="l26.21" class="difflineminus">-#include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l26.22"></a><span id="l26.22" class="difflineminus">-#include &quot;nsIPrefService.h&quot;</span>
<a href="#l26.23"></a><span id="l26.23" class="difflineminus">-#include &quot;nsIMsgFilterList.h&quot;</span>
<a href="#l26.24"></a><span id="l26.24" class="difflineminus">-#include &quot;nsIMsgSearchTerm.h&quot;</span>
<a href="#l26.25"></a><span id="l26.25" class="difflineminus">-#include &quot;nsIMsgAccountManager.h&quot;</span>
<a href="#l26.26"></a><span id="l26.26" class="difflineminus">-#include &quot;nsIStringBundle.h&quot;</span>
<a href="#l26.27"></a><span id="l26.27" class="difflineminus">-#include &quot;mozilla/Services.h&quot;</span>
<a href="#l26.28"></a><span id="l26.28" class="difflineminus">-#include &quot;nsIMsgFilter.h&quot;</span>
<a href="#l26.29"></a><span id="l26.29" class="difflineminus">-#include &quot;nsEudoraFilters.h&quot;</span>
<a href="#l26.30"></a><span id="l26.30" class="difflineminus">-#include &quot;nsEudoraStringBundle.h&quot;</span>
<a href="#l26.31"></a><span id="l26.31" class="difflineminus">-#include &quot;nsIArray.h&quot;</span>
<a href="#l26.32"></a><span id="l26.32" class="difflineminus">-#include &quot;nsArrayUtils.h&quot;</span>
<a href="#l26.33"></a><span id="l26.33" class="difflineminus">-#include &quot;nsNetUtil.h&quot;</span>
<a href="#l26.34"></a><span id="l26.34" class="difflineminus">-#include &quot;nsILineInputStream.h&quot;</span>
<a href="#l26.35"></a><span id="l26.35" class="difflineminus">-#include &quot;EudoraDebugLog.h&quot;</span>
<a href="#l26.36"></a><span id="l26.36" class="difflineminus">-</span>
<a href="#l26.37"></a><span id="l26.37" class="difflineminus">-#if defined(XP_WIN)</span>
<a href="#l26.38"></a><span id="l26.38" class="difflineminus">-#include &quot;nsEudoraWin32.h&quot;</span>
<a href="#l26.39"></a><span id="l26.39" class="difflineminus">-#endif</span>
<a href="#l26.40"></a><span id="l26.40" class="difflineminus">-#ifdef XP_MACOSX</span>
<a href="#l26.41"></a><span id="l26.41" class="difflineminus">-#include &quot;nsEudoraMac.h&quot;</span>
<a href="#l26.42"></a><span id="l26.42" class="difflineminus">-#endif</span>
<a href="#l26.43"></a><span id="l26.43" class="difflineminus">-</span>
<a href="#l26.44"></a><span id="l26.44" class="difflineminus">-</span>
<a href="#l26.45"></a><span id="l26.45" class="difflineminus">-</span>
<a href="#l26.46"></a><span id="l26.46" class="difflineminus">-////////////////////////////////////////////////////////////////////////</span>
<a href="#l26.47"></a><span id="l26.47" class="difflineminus">-nsresult nsEudoraFilters::Create(nsIImportFilters** aImport)</span>
<a href="#l26.48"></a><span id="l26.48" class="difflineminus">-{</span>
<a href="#l26.49"></a><span id="l26.49" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aImport);</span>
<a href="#l26.50"></a><span id="l26.50" class="difflineminus">-  *aImport = new nsEudoraFilters();</span>
<a href="#l26.51"></a><span id="l26.51" class="difflineminus">-  NS_IF_ADDREF(*aImport);</span>
<a href="#l26.52"></a><span id="l26.52" class="difflineminus">-</span>
<a href="#l26.53"></a><span id="l26.53" class="difflineminus">-  return *aImport? NS_OK : NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l26.54"></a><span id="l26.54" class="difflineminus">-}</span>
<a href="#l26.55"></a><span id="l26.55" class="difflineminus">-</span>
<a href="#l26.56"></a><span id="l26.56" class="difflineminus">-nsEudoraFilters::nsEudoraFilters()</span>
<a href="#l26.57"></a><span id="l26.57" class="difflineminus">-{</span>
<a href="#l26.58"></a><span id="l26.58" class="difflineminus">-}</span>
<a href="#l26.59"></a><span id="l26.59" class="difflineminus">-</span>
<a href="#l26.60"></a><span id="l26.60" class="difflineminus">-nsEudoraFilters::~nsEudoraFilters()</span>
<a href="#l26.61"></a><span id="l26.61" class="difflineminus">-{</span>
<a href="#l26.62"></a><span id="l26.62" class="difflineminus">-}</span>
<a href="#l26.63"></a><span id="l26.63" class="difflineminus">-</span>
<a href="#l26.64"></a><span id="l26.64" class="difflineminus">-NS_IMPL_ISUPPORTS(nsEudoraFilters, nsIImportFilters)</span>
<a href="#l26.65"></a><span id="l26.65" class="difflineminus">-</span>
<a href="#l26.66"></a><span id="l26.66" class="difflineminus">-NS_IMETHODIMP nsEudoraFilters::AutoLocate(char16_t **aDescription, nsIFile **aLocation, bool *_retval)</span>
<a href="#l26.67"></a><span id="l26.67" class="difflineminus">-{</span>
<a href="#l26.68"></a><span id="l26.68" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aDescription);</span>
<a href="#l26.69"></a><span id="l26.69" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aLocation);</span>
<a href="#l26.70"></a><span id="l26.70" class="difflineminus">-  NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l26.71"></a><span id="l26.71" class="difflineminus">-</span>
<a href="#l26.72"></a><span id="l26.72" class="difflineminus">-  *aDescription = nullptr;</span>
<a href="#l26.73"></a><span id="l26.73" class="difflineminus">-  *_retval = false;</span>
<a href="#l26.74"></a><span id="l26.74" class="difflineminus">-</span>
<a href="#l26.75"></a><span id="l26.75" class="difflineminus">-  nsresult rv;</span>
<a href="#l26.76"></a><span id="l26.76" class="difflineminus">-  m_pLocation =  do_CreateInstance (NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l26.77"></a><span id="l26.77" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.78"></a><span id="l26.78" class="difflineminus">-</span>
<a href="#l26.79"></a><span id="l26.79" class="difflineminus">-  *aDescription = nsEudoraStringBundle::GetStringByID(EUDORAIMPORT_NAME);</span>
<a href="#l26.80"></a><span id="l26.80" class="difflineminus">-</span>
<a href="#l26.81"></a><span id="l26.81" class="difflineminus">-#if defined(XP_WIN)</span>
<a href="#l26.82"></a><span id="l26.82" class="difflineminus">-  *_retval = nsEudoraWin32::FindFiltersFile(getter_AddRefs(m_pLocation));</span>
<a href="#l26.83"></a><span id="l26.83" class="difflineminus">-#endif</span>
<a href="#l26.84"></a><span id="l26.84" class="difflineminus">-#ifdef XP_MACOSX</span>
<a href="#l26.85"></a><span id="l26.85" class="difflineminus">-  *_retval = nsEudoraMac::FindFiltersFile(getter_AddRefs(m_pLocation));</span>
<a href="#l26.86"></a><span id="l26.86" class="difflineminus">-#endif</span>
<a href="#l26.87"></a><span id="l26.87" class="difflineminus">-</span>
<a href="#l26.88"></a><span id="l26.88" class="difflineminus">-  NS_IF_ADDREF(*aLocation = m_pLocation);</span>
<a href="#l26.89"></a><span id="l26.89" class="difflineminus">-  return NS_OK;</span>
<a href="#l26.90"></a><span id="l26.90" class="difflineminus">-}</span>
<a href="#l26.91"></a><span id="l26.91" class="difflineminus">-</span>
<a href="#l26.92"></a><span id="l26.92" class="difflineminus">-NS_IMETHODIMP nsEudoraFilters::SetLocation(nsIFile *aLocation)</span>
<a href="#l26.93"></a><span id="l26.93" class="difflineminus">-{</span>
<a href="#l26.94"></a><span id="l26.94" class="difflineminus">-  m_pLocation = aLocation;</span>
<a href="#l26.95"></a><span id="l26.95" class="difflineminus">-</span>
<a href="#l26.96"></a><span id="l26.96" class="difflineminus">-  return NS_OK;</span>
<a href="#l26.97"></a><span id="l26.97" class="difflineminus">-}</span>
<a href="#l26.98"></a><span id="l26.98" class="difflineminus">-</span>
<a href="#l26.99"></a><span id="l26.99" class="difflineminus">-NS_IMETHODIMP nsEudoraFilters::Import(char16_t **aError, bool *_retval)</span>
<a href="#l26.100"></a><span id="l26.100" class="difflineminus">-{</span>
<a href="#l26.101"></a><span id="l26.101" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aError);</span>
<a href="#l26.102"></a><span id="l26.102" class="difflineminus">-  NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l26.103"></a><span id="l26.103" class="difflineminus">-  nsresult rv;</span>
<a href="#l26.104"></a><span id="l26.104" class="difflineminus">-</span>
<a href="#l26.105"></a><span id="l26.105" class="difflineminus">-  *_retval = false;</span>
<a href="#l26.106"></a><span id="l26.106" class="difflineminus">-  *aError = nullptr;</span>
<a href="#l26.107"></a><span id="l26.107" class="difflineminus">-</span>
<a href="#l26.108"></a><span id="l26.108" class="difflineminus">-  // Get the settings file if it doesn't exist</span>
<a href="#l26.109"></a><span id="l26.109" class="difflineminus">-  if (!m_pLocation)</span>
<a href="#l26.110"></a><span id="l26.110" class="difflineminus">-  {</span>
<a href="#l26.111"></a><span id="l26.111" class="difflineminus">-    m_pLocation =  do_CreateInstance (NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l26.112"></a><span id="l26.112" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.113"></a><span id="l26.113" class="difflineminus">-#if defined(XP_WIN)</span>
<a href="#l26.114"></a><span id="l26.114" class="difflineminus">-    if (!nsEudoraWin32::FindFiltersFile(getter_AddRefs(m_pLocation)))</span>
<a href="#l26.115"></a><span id="l26.115" class="difflineminus">-      m_pLocation = nullptr;</span>
<a href="#l26.116"></a><span id="l26.116" class="difflineminus">-#endif</span>
<a href="#l26.117"></a><span id="l26.117" class="difflineminus">-#ifdef XP_MACOSX</span>
<a href="#l26.118"></a><span id="l26.118" class="difflineminus">-    if (!nsEudoraMac::FindFiltersFile(getter_AddRefs(m_pLocation)))</span>
<a href="#l26.119"></a><span id="l26.119" class="difflineminus">-      m_pLocation = nullptr;</span>
<a href="#l26.120"></a><span id="l26.120" class="difflineminus">-#endif</span>
<a href="#l26.121"></a><span id="l26.121" class="difflineminus">-  }</span>
<a href="#l26.122"></a><span id="l26.122" class="difflineminus">-</span>
<a href="#l26.123"></a><span id="l26.123" class="difflineminus">-  if (!m_pLocation)</span>
<a href="#l26.124"></a><span id="l26.124" class="difflineminus">-  {</span>
<a href="#l26.125"></a><span id="l26.125" class="difflineminus">-    IMPORT_LOG0(&quot;*** Error, unable to locate filters file for import.\n&quot;);</span>
<a href="#l26.126"></a><span id="l26.126" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l26.127"></a><span id="l26.127" class="difflineminus">-  }</span>
<a href="#l26.128"></a><span id="l26.128" class="difflineminus">-</span>
<a href="#l26.129"></a><span id="l26.129" class="difflineminus">-  // Now perform actual importing task</span>
<a href="#l26.130"></a><span id="l26.130" class="difflineminus">-  *_retval = RealImport();</span>
<a href="#l26.131"></a><span id="l26.131" class="difflineminus">-  *aError = ToNewUnicode(m_errorLog);</span>
<a href="#l26.132"></a><span id="l26.132" class="difflineminus">-</span>
<a href="#l26.133"></a><span id="l26.133" class="difflineminus">-  if (*_retval)</span>
<a href="#l26.134"></a><span id="l26.134" class="difflineminus">-    IMPORT_LOG0(&quot;Successful import of eudora filters\n&quot;);</span>
<a href="#l26.135"></a><span id="l26.135" class="difflineminus">-  else</span>
<a href="#l26.136"></a><span id="l26.136" class="difflineminus">-    IMPORT_LOG0(&quot;*** Error, Unsuccessful import of eudora filters\n&quot;);</span>
<a href="#l26.137"></a><span id="l26.137" class="difflineminus">-</span>
<a href="#l26.138"></a><span id="l26.138" class="difflineminus">-  return NS_OK;</span>
<a href="#l26.139"></a><span id="l26.139" class="difflineminus">-}</span>
<a href="#l26.140"></a><span id="l26.140" class="difflineminus">-</span>
<a href="#l26.141"></a><span id="l26.141" class="difflineminus">-bool nsEudoraFilters::RealImport()</span>
<a href="#l26.142"></a><span id="l26.142" class="difflineminus">-{</span>
<a href="#l26.143"></a><span id="l26.143" class="difflineminus">-  nsresult rv;</span>
<a href="#l26.144"></a><span id="l26.144" class="difflineminus">-</span>
<a href="#l26.145"></a><span id="l26.145" class="difflineminus">-  rv = Init();</span>
<a href="#l26.146"></a><span id="l26.146" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l26.147"></a><span id="l26.147" class="difflineminus">-  {</span>
<a href="#l26.148"></a><span id="l26.148" class="difflineminus">-    IMPORT_LOG0(&quot;*** Error initializing filter import process\n&quot;);</span>
<a href="#l26.149"></a><span id="l26.149" class="difflineminus">-    return false;</span>
<a href="#l26.150"></a><span id="l26.150" class="difflineminus">-  }</span>
<a href="#l26.151"></a><span id="l26.151" class="difflineminus">-</span>
<a href="#l26.152"></a><span id="l26.152" class="difflineminus">-  nsCOMPtr &lt;nsIInputStream&gt; inputStream;</span>
<a href="#l26.153"></a><span id="l26.153" class="difflineminus">-  rv = NS_NewLocalFileInputStream(getter_AddRefs(inputStream), m_pLocation);</span>
<a href="#l26.154"></a><span id="l26.154" class="difflineminus">-</span>
<a href="#l26.155"></a><span id="l26.155" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l26.156"></a><span id="l26.156" class="difflineminus">-  {</span>
<a href="#l26.157"></a><span id="l26.157" class="difflineminus">-    IMPORT_LOG0(&quot;*** Error opening filters file for reading\n&quot;);</span>
<a href="#l26.158"></a><span id="l26.158" class="difflineminus">-    return false;</span>
<a href="#l26.159"></a><span id="l26.159" class="difflineminus">-  }</span>
<a href="#l26.160"></a><span id="l26.160" class="difflineminus">-</span>
<a href="#l26.161"></a><span id="l26.161" class="difflineminus">-  rv = LoadServers();</span>
<a href="#l26.162"></a><span id="l26.162" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l26.163"></a><span id="l26.163" class="difflineminus">-  {</span>
<a href="#l26.164"></a><span id="l26.164" class="difflineminus">-    IMPORT_LOG0(&quot;*** Error loading servers with filters\n&quot;);</span>
<a href="#l26.165"></a><span id="l26.165" class="difflineminus">-    return false;</span>
<a href="#l26.166"></a><span id="l26.166" class="difflineminus">-  }</span>
<a href="#l26.167"></a><span id="l26.167" class="difflineminus">-</span>
<a href="#l26.168"></a><span id="l26.168" class="difflineminus">-  nsCOMPtr&lt;nsILineInputStream&gt; lineStream(do_QueryInterface(inputStream, &amp;rv));</span>
<a href="#l26.169"></a><span id="l26.169" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l26.170"></a><span id="l26.170" class="difflineminus">-</span>
<a href="#l26.171"></a><span id="l26.171" class="difflineminus">-  nsCString     line;</span>
<a href="#l26.172"></a><span id="l26.172" class="difflineminus">-  bool          more = true;</span>
<a href="#l26.173"></a><span id="l26.173" class="difflineminus">-  nsAutoCString header;</span>
<a href="#l26.174"></a><span id="l26.174" class="difflineminus">-  nsAutoCString verb;</span>
<a href="#l26.175"></a><span id="l26.175" class="difflineminus">-  nsAutoString  name;</span>
<a href="#l26.176"></a><span id="l26.176" class="difflineminus">-</span>
<a href="#l26.177"></a><span id="l26.177" class="difflineminus">-  // Windows Eudora filters files have a version header as a first line - just skip it</span>
<a href="#l26.178"></a><span id="l26.178" class="difflineminus">-#if defined(XP_WIN)</span>
<a href="#l26.179"></a><span id="l26.179" class="difflineminus">-  rv = lineStream-&gt;ReadLine(line, &amp;more);</span>
<a href="#l26.180"></a><span id="l26.180" class="difflineminus">-#endif</span>
<a href="#l26.181"></a><span id="l26.181" class="difflineminus">-</span>
<a href="#l26.182"></a><span id="l26.182" class="difflineminus">-  while (more &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l26.183"></a><span id="l26.183" class="difflineminus">-  {</span>
<a href="#l26.184"></a><span id="l26.184" class="difflineminus">-    rv = lineStream-&gt;ReadLine(line, &amp;more);</span>
<a href="#l26.185"></a><span id="l26.185" class="difflineminus">-    const char* pLine = line.get();</span>
<a href="#l26.186"></a><span id="l26.186" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l26.187"></a><span id="l26.187" class="difflineminus">-    {</span>
<a href="#l26.188"></a><span id="l26.188" class="difflineminus">-      // New filters start with a &quot;rule &lt;name&gt;&quot; line</span>
<a href="#l26.189"></a><span id="l26.189" class="difflineminus">-      if (!strncmp(pLine, &quot;rule &quot;, 5))</span>
<a href="#l26.190"></a><span id="l26.190" class="difflineminus">-      {</span>
<a href="#l26.191"></a><span id="l26.191" class="difflineminus">-        rv = FinalizeFilter();</span>
<a href="#l26.192"></a><span id="l26.192" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l26.193"></a><span id="l26.193" class="difflineminus">-        {</span>
<a href="#l26.194"></a><span id="l26.194" class="difflineminus">-          const char* pName = pLine + 5;</span>
<a href="#l26.195"></a><span id="l26.195" class="difflineminus">-          NS_CopyNativeToUnicode(nsCString(pName), name);</span>
<a href="#l26.196"></a><span id="l26.196" class="difflineminus">-          rv = CreateNewFilter(pName);</span>
<a href="#l26.197"></a><span id="l26.197" class="difflineminus">-        }</span>
<a href="#l26.198"></a><span id="l26.198" class="difflineminus">-      }</span>
<a href="#l26.199"></a><span id="l26.199" class="difflineminus">-#ifdef XP_MACOSX</span>
<a href="#l26.200"></a><span id="l26.200" class="difflineminus">-      else if (!strncmp(pLine, &quot;id &quot;, 3))</span>
<a href="#l26.201"></a><span id="l26.201" class="difflineminus">-        ;// ids have no value to us, but we don't want them to produce a warning either</span>
<a href="#l26.202"></a><span id="l26.202" class="difflineminus">-#endif</span>
<a href="#l26.203"></a><span id="l26.203" class="difflineminus">-      else if (!strncmp(pLine, &quot;conjunction &quot;, 12))</span>
<a href="#l26.204"></a><span id="l26.204" class="difflineminus">-      {</span>
<a href="#l26.205"></a><span id="l26.205" class="difflineminus">-        const char* cj = pLine + 12;</span>
<a href="#l26.206"></a><span id="l26.206" class="difflineminus">-        if (!strcmp(cj, &quot;and&quot;))</span>
<a href="#l26.207"></a><span id="l26.207" class="difflineminus">-          m_isAnd = true;</span>
<a href="#l26.208"></a><span id="l26.208" class="difflineminus">-        else if (!strcmp(cj, &quot;unless&quot;))</span>
<a href="#l26.209"></a><span id="l26.209" class="difflineminus">-          m_isUnless = true;</span>
<a href="#l26.210"></a><span id="l26.210" class="difflineminus">-        else if (!strcmp(cj, &quot;ignore&quot;))</span>
<a href="#l26.211"></a><span id="l26.211" class="difflineminus">-          m_ignoreTerm = true;</span>
<a href="#l26.212"></a><span id="l26.212" class="difflineminus">-      }</span>
<a href="#l26.213"></a><span id="l26.213" class="difflineminus">-      else if (!strncmp(pLine, &quot;header &quot;, 7))</span>
<a href="#l26.214"></a><span id="l26.214" class="difflineminus">-        header = (pLine + 7);</span>
<a href="#l26.215"></a><span id="l26.215" class="difflineminus">-      else if (!strncmp(pLine, &quot;verb &quot;, 5))</span>
<a href="#l26.216"></a><span id="l26.216" class="difflineminus">-        verb = (pLine + 5);</span>
<a href="#l26.217"></a><span id="l26.217" class="difflineminus">-      else if (!strncmp(pLine, &quot;value &quot;, 6))</span>
<a href="#l26.218"></a><span id="l26.218" class="difflineminus">-      {</span>
<a href="#l26.219"></a><span id="l26.219" class="difflineminus">-        if (!m_ignoreTerm)</span>
<a href="#l26.220"></a><span id="l26.220" class="difflineminus">-        {</span>
<a href="#l26.221"></a><span id="l26.221" class="difflineminus">-          rv = AddTerm(header.get(), verb.get(), pLine + 6, (m_isAnd || m_isUnless), m_isUnless);</span>
<a href="#l26.222"></a><span id="l26.222" class="difflineminus">-          // For now, ignoring terms that can't be represented in TB filters</span>
<a href="#l26.223"></a><span id="l26.223" class="difflineminus">-          if (rv == NS_ERROR_INVALID_ARG)</span>
<a href="#l26.224"></a><span id="l26.224" class="difflineminus">-          {</span>
<a href="#l26.225"></a><span id="l26.225" class="difflineminus">-            rv = NS_OK;</span>
<a href="#l26.226"></a><span id="l26.226" class="difflineminus">-            m_termNotGroked = true;</span>
<a href="#l26.227"></a><span id="l26.227" class="difflineminus">-          }</span>
<a href="#l26.228"></a><span id="l26.228" class="difflineminus">-        }</span>
<a href="#l26.229"></a><span id="l26.229" class="difflineminus">-      }</span>
<a href="#l26.230"></a><span id="l26.230" class="difflineminus">-      else if (!strcmp(pLine, &quot;incoming&quot;))</span>
<a href="#l26.231"></a><span id="l26.231" class="difflineminus">-        m_isIncoming = true;</span>
<a href="#l26.232"></a><span id="l26.232" class="difflineminus">-      else if (!strncmp(pLine, &quot;transfer &quot;, 9) ||</span>
<a href="#l26.233"></a><span id="l26.233" class="difflineminus">-               !strncmp(pLine, &quot;copy &quot;, 5))</span>
<a href="#l26.234"></a><span id="l26.234" class="difflineminus">-      {</span>
<a href="#l26.235"></a><span id="l26.235" class="difflineminus">-        const char* pMailboxPath = strchr(pLine, ' ') + 1;</span>
<a href="#l26.236"></a><span id="l26.236" class="difflineminus">-        bool isTransfer = (*pLine == 't');</span>
<a href="#l26.237"></a><span id="l26.237" class="difflineminus">-        rv = AddMailboxAction(pMailboxPath, isTransfer);</span>
<a href="#l26.238"></a><span id="l26.238" class="difflineminus">-        if (rv == NS_ERROR_INVALID_ARG)</span>
<a href="#l26.239"></a><span id="l26.239" class="difflineminus">-        {</span>
<a href="#l26.240"></a><span id="l26.240" class="difflineminus">-          nsAutoString unicodeMailboxPath;</span>
<a href="#l26.241"></a><span id="l26.241" class="difflineminus">-          NS_CopyNativeToUnicode(nsCString(pMailboxPath), unicodeMailboxPath);</span>
<a href="#l26.242"></a><span id="l26.242" class="difflineminus">-          m_errorLog += NS_LITERAL_STRING(&quot;- &quot;);</span>
<a href="#l26.243"></a><span id="l26.243" class="difflineminus">-          m_errorLog += name;</span>
<a href="#l26.244"></a><span id="l26.244" class="difflineminus">-          m_errorLog += NS_LITERAL_STRING(&quot;: &quot;);</span>
<a href="#l26.245"></a><span id="l26.245" class="difflineminus">-          m_errorLog += nsEudoraStringBundle::FormatString(EUDORAIMPORT_FILTERS_WARN_MAILBOX_MISSING, unicodeMailboxPath.get());</span>
<a href="#l26.246"></a><span id="l26.246" class="difflineminus">-          m_errorLog += NS_LITERAL_STRING(&quot;\n&quot;);</span>
<a href="#l26.247"></a><span id="l26.247" class="difflineminus">-          rv = NS_OK;</span>
<a href="#l26.248"></a><span id="l26.248" class="difflineminus">-        }</span>
<a href="#l26.249"></a><span id="l26.249" class="difflineminus">-      }</span>
<a href="#l26.250"></a><span id="l26.250" class="difflineminus">-      // Doing strncmp() here because Win Eudora puts a space after &quot;stop&quot; but Mac Eudora doesn't</span>
<a href="#l26.251"></a><span id="l26.251" class="difflineminus">-      else if (!strncmp(pLine, &quot;stop&quot;, 4))</span>
<a href="#l26.252"></a><span id="l26.252" class="difflineminus">-        m_hasStop = true;</span>
<a href="#l26.253"></a><span id="l26.253" class="difflineminus">-      else if (!strncmp(pLine, &quot;forward &quot;, 8))</span>
<a href="#l26.254"></a><span id="l26.254" class="difflineminus">-        rv = AddStringAction(nsMsgFilterAction::Forward, pLine + 8);</span>
<a href="#l26.255"></a><span id="l26.255" class="difflineminus">-      else if (!strncmp(pLine, &quot;reply &quot;, 6))</span>
<a href="#l26.256"></a><span id="l26.256" class="difflineminus">-        rv = AddStringAction(nsMsgFilterAction::Reply, pLine + 6);</span>
<a href="#l26.257"></a><span id="l26.257" class="difflineminus">-      else if (!strncmp(pLine, &quot;priority &quot;, 9))</span>
<a href="#l26.258"></a><span id="l26.258" class="difflineminus">-      {</span>
<a href="#l26.259"></a><span id="l26.259" class="difflineminus">-        // Win Eudora's  priority values are 0 (highest) to 4 (lowest)</span>
<a href="#l26.260"></a><span id="l26.260" class="difflineminus">-        // Mac Eudora's  priority values are 1 (highest) to 5 (lowest)</span>
<a href="#l26.261"></a><span id="l26.261" class="difflineminus">-        // Thunderbird's priority values are 6 (highest) to 2 (lowest)</span>
<a href="#l26.262"></a><span id="l26.262" class="difflineminus">-        int32_t TBPriority = 6 - atoi(pLine + 9);</span>
<a href="#l26.263"></a><span id="l26.263" class="difflineminus">-#ifdef XP_MACOSX</span>
<a href="#l26.264"></a><span id="l26.264" class="difflineminus">-        TBPriority++;</span>
<a href="#l26.265"></a><span id="l26.265" class="difflineminus">-#endif</span>
<a href="#l26.266"></a><span id="l26.266" class="difflineminus">-        rv = AddPriorityAction(TBPriority);</span>
<a href="#l26.267"></a><span id="l26.267" class="difflineminus">-      }</span>
<a href="#l26.268"></a><span id="l26.268" class="difflineminus">-      else if (!strncmp(pLine, &quot;label &quot;, 6))</span>
<a href="#l26.269"></a><span id="l26.269" class="difflineminus">-      {</span>
<a href="#l26.270"></a><span id="l26.270" class="difflineminus">-        nsAutoCString tagName(&quot;$label&quot;);</span>
<a href="#l26.271"></a><span id="l26.271" class="difflineminus">-        tagName += pLine + 6;</span>
<a href="#l26.272"></a><span id="l26.272" class="difflineminus">-        rv = AddStringAction(nsMsgFilterAction::AddTag, tagName.get());</span>
<a href="#l26.273"></a><span id="l26.273" class="difflineminus">-      }</span>
<a href="#l26.274"></a><span id="l26.274" class="difflineminus">-      // Doing strncmp() here because Win Eudora puts a space after &quot;junk&quot; but Mac Eudora doesn't</span>
<a href="#l26.275"></a><span id="l26.275" class="difflineminus">-      else if (!strncmp(pLine, &quot;junk&quot;, 4))</span>
<a href="#l26.276"></a><span id="l26.276" class="difflineminus">-        rv = AddJunkAction(100);</span>
<a href="#l26.277"></a><span id="l26.277" class="difflineminus">-      else if (!strncmp(pLine, &quot;status &quot;, 7))</span>
<a href="#l26.278"></a><span id="l26.278" class="difflineminus">-      {</span>
<a href="#l26.279"></a><span id="l26.279" class="difflineminus">-        // Win Eudora's read status is 1, whereas Mac Eudora's read status is 2</span>
<a href="#l26.280"></a><span id="l26.280" class="difflineminus">-        uint32_t status = atoi(pLine + 7);</span>
<a href="#l26.281"></a><span id="l26.281" class="difflineminus">-#ifdef XP_MACOSX</span>
<a href="#l26.282"></a><span id="l26.282" class="difflineminus">-        status--;</span>
<a href="#l26.283"></a><span id="l26.283" class="difflineminus">-#endif</span>
<a href="#l26.284"></a><span id="l26.284" class="difflineminus">-        if (status == 1)</span>
<a href="#l26.285"></a><span id="l26.285" class="difflineminus">-          rv = AddAction(nsMsgFilterAction::MarkRead);</span>
<a href="#l26.286"></a><span id="l26.286" class="difflineminus">-      }</span>
<a href="#l26.287"></a><span id="l26.287" class="difflineminus">-      else if (!strncmp(pLine, &quot;serverOpt &quot;, 10))</span>
<a href="#l26.288"></a><span id="l26.288" class="difflineminus">-      {</span>
<a href="#l26.289"></a><span id="l26.289" class="difflineminus">-        // Win and Mac Eudora have the two bits swapped in the file</span>
<a href="#l26.290"></a><span id="l26.290" class="difflineminus">-        uint32_t bits = atoi(pLine + 10);</span>
<a href="#l26.291"></a><span id="l26.291" class="difflineminus">-#if defined(XP_WIN)</span>
<a href="#l26.292"></a><span id="l26.292" class="difflineminus">-        bool bFetch  = (bits &amp; 1);</span>
<a href="#l26.293"></a><span id="l26.293" class="difflineminus">-        bool bDelete = (bits &amp; 2);</span>
<a href="#l26.294"></a><span id="l26.294" class="difflineminus">-#endif</span>
<a href="#l26.295"></a><span id="l26.295" class="difflineminus">-#ifdef XP_MACOSX</span>
<a href="#l26.296"></a><span id="l26.296" class="difflineminus">-        bool bFetch  = (bits &amp; 2);</span>
<a href="#l26.297"></a><span id="l26.297" class="difflineminus">-        bool bDelete = (bits &amp; 1);</span>
<a href="#l26.298"></a><span id="l26.298" class="difflineminus">-#endif</span>
<a href="#l26.299"></a><span id="l26.299" class="difflineminus">-        rv = AddAction(bDelete? (nsMsgRuleActionType)nsMsgFilterAction::DeleteFromPop3Server : (nsMsgRuleActionType)nsMsgFilterAction::LeaveOnPop3Server);</span>
<a href="#l26.300"></a><span id="l26.300" class="difflineminus">-        if (NS_SUCCEEDED(rv) &amp;&amp; bFetch)</span>
<a href="#l26.301"></a><span id="l26.301" class="difflineminus">-          rv = AddAction(nsMsgFilterAction::FetchBodyFromPop3Server);</span>
<a href="#l26.302"></a><span id="l26.302" class="difflineminus">-      }</span>
<a href="#l26.303"></a><span id="l26.303" class="difflineminus">-      else if (strcmp(pLine, &quot;manual&quot;) == 0)</span>
<a href="#l26.304"></a><span id="l26.304" class="difflineminus">-        ;// Just ignore manual as TB handles manual in a different way</span>
<a href="#l26.305"></a><span id="l26.305" class="difflineminus">-      else if (strcmp(pLine, &quot;outgoing&quot;) == 0)</span>
<a href="#l26.306"></a><span id="l26.306" class="difflineminus">-      {</span>
<a href="#l26.307"></a><span id="l26.307" class="difflineminus">-        m_errorLog += NS_LITERAL_STRING(&quot;- &quot;);</span>
<a href="#l26.308"></a><span id="l26.308" class="difflineminus">-        m_errorLog += name;</span>
<a href="#l26.309"></a><span id="l26.309" class="difflineminus">-        m_errorLog += NS_LITERAL_STRING(&quot;: &quot;);</span>
<a href="#l26.310"></a><span id="l26.310" class="difflineminus">-        m_errorLog += nsEudoraStringBundle::FormatString(EUDORAIMPORT_FILTERS_WARN_OUTGOING);</span>
<a href="#l26.311"></a><span id="l26.311" class="difflineminus">-        m_errorLog += NS_LITERAL_STRING(&quot;\n&quot;);</span>
<a href="#l26.312"></a><span id="l26.312" class="difflineminus">-      }</span>
<a href="#l26.313"></a><span id="l26.313" class="difflineminus">-      else</span>
<a href="#l26.314"></a><span id="l26.314" class="difflineminus">-      {</span>
<a href="#l26.315"></a><span id="l26.315" class="difflineminus">-        nsAutoString unicodeLine;</span>
<a href="#l26.316"></a><span id="l26.316" class="difflineminus">-        NS_CopyNativeToUnicode(nsCString(pLine), unicodeLine);</span>
<a href="#l26.317"></a><span id="l26.317" class="difflineminus">-        m_errorLog += NS_LITERAL_STRING(&quot;- &quot;);</span>
<a href="#l26.318"></a><span id="l26.318" class="difflineminus">-        m_errorLog += name;</span>
<a href="#l26.319"></a><span id="l26.319" class="difflineminus">-        m_errorLog += NS_LITERAL_STRING(&quot;: &quot;);</span>
<a href="#l26.320"></a><span id="l26.320" class="difflineminus">-        m_errorLog += nsEudoraStringBundle::FormatString(EUDORAIMPORT_FILTERS_WARN_ACTION, unicodeLine.get());</span>
<a href="#l26.321"></a><span id="l26.321" class="difflineminus">-        m_errorLog += NS_LITERAL_STRING(&quot;\n&quot;);</span>
<a href="#l26.322"></a><span id="l26.322" class="difflineminus">-      }</span>
<a href="#l26.323"></a><span id="l26.323" class="difflineminus">-    }</span>
<a href="#l26.324"></a><span id="l26.324" class="difflineminus">-  }</span>
<a href="#l26.325"></a><span id="l26.325" class="difflineminus">-</span>
<a href="#l26.326"></a><span id="l26.326" class="difflineminus">-  // Process the last filter</span>
<a href="#l26.327"></a><span id="l26.327" class="difflineminus">-  if (!more &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l26.328"></a><span id="l26.328" class="difflineminus">-    rv = FinalizeFilter();</span>
<a href="#l26.329"></a><span id="l26.329" class="difflineminus">-</span>
<a href="#l26.330"></a><span id="l26.330" class="difflineminus">-  inputStream-&gt;Close();</span>
<a href="#l26.331"></a><span id="l26.331" class="difflineminus">-</span>
<a href="#l26.332"></a><span id="l26.332" class="difflineminus">-  if (more)</span>
<a href="#l26.333"></a><span id="l26.333" class="difflineminus">-  {</span>
<a href="#l26.334"></a><span id="l26.334" class="difflineminus">-    IMPORT_LOG0(&quot;*** Error reading the filters, didn't reach the end\n&quot;);</span>
<a href="#l26.335"></a><span id="l26.335" class="difflineminus">-    return false;</span>
<a href="#l26.336"></a><span id="l26.336" class="difflineminus">-  }</span>
<a href="#l26.337"></a><span id="l26.337" class="difflineminus">-</span>
<a href="#l26.338"></a><span id="l26.338" class="difflineminus">-  rv = SaveFilters();</span>
<a href="#l26.339"></a><span id="l26.339" class="difflineminus">-</span>
<a href="#l26.340"></a><span id="l26.340" class="difflineminus">-  return NS_SUCCEEDED(rv);</span>
<a href="#l26.341"></a><span id="l26.341" class="difflineminus">-}</span>
<a href="#l26.342"></a><span id="l26.342" class="difflineminus">-</span>
<a href="#l26.343"></a><span id="l26.343" class="difflineminus">-nsresult nsEudoraFilters::Init()</span>
<a href="#l26.344"></a><span id="l26.344" class="difflineminus">-{</span>
<a href="#l26.345"></a><span id="l26.345" class="difflineminus">-  nsresult rv;</span>
<a href="#l26.346"></a><span id="l26.346" class="difflineminus">-</span>
<a href="#l26.347"></a><span id="l26.347" class="difflineminus">-  nsCOMPtr&lt;nsIMsgAccountManager&gt; accMgr = do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l26.348"></a><span id="l26.348" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.349"></a><span id="l26.349" class="difflineminus">-</span>
<a href="#l26.350"></a><span id="l26.350" class="difflineminus">-  nsCOMPtr &lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l26.351"></a><span id="l26.351" class="difflineminus">-  rv = accMgr-&gt;GetLocalFoldersServer(getter_AddRefs(server));</span>
<a href="#l26.352"></a><span id="l26.352" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.353"></a><span id="l26.353" class="difflineminus">-</span>
<a href="#l26.354"></a><span id="l26.354" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFolder&gt; localRootFolder;</span>
<a href="#l26.355"></a><span id="l26.355" class="difflineminus">-  rv = server-&gt;GetRootMsgFolder(getter_AddRefs(localRootFolder));</span>
<a href="#l26.356"></a><span id="l26.356" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.357"></a><span id="l26.357" class="difflineminus">-</span>
<a href="#l26.358"></a><span id="l26.358" class="difflineminus">-  // we need to call GetSubFolders() so that the folders get initialized</span>
<a href="#l26.359"></a><span id="l26.359" class="difflineminus">-  // if they are not initialized yet.</span>
<a href="#l26.360"></a><span id="l26.360" class="difflineminus">-  nsCOMPtr&lt;nsISimpleEnumerator&gt; enumerator;</span>
<a href="#l26.361"></a><span id="l26.361" class="difflineminus">-  rv = localRootFolder-&gt;GetSubFolders(getter_AddRefs(enumerator));</span>
<a href="#l26.362"></a><span id="l26.362" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.363"></a><span id="l26.363" class="difflineminus">-</span>
<a href="#l26.364"></a><span id="l26.364" class="difflineminus">-  // Get the name of the folder where one-off imported mail is placed</span>
<a href="#l26.365"></a><span id="l26.365" class="difflineminus">-  nsAutoString folderName(NS_LITERAL_STRING(&quot;Eudora Import&quot;));</span>
<a href="#l26.366"></a><span id="l26.366" class="difflineminus">-  nsCOMPtr&lt;nsIStringBundleService&gt; bundleService = </span>
<a href="#l26.367"></a><span id="l26.367" class="difflineminus">-    mozilla::services::GetStringBundleService();</span>
<a href="#l26.368"></a><span id="l26.368" class="difflineminus">-  NS_ENSURE_TRUE(bundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l26.369"></a><span id="l26.369" class="difflineminus">-</span>
<a href="#l26.370"></a><span id="l26.370" class="difflineminus">-  nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l26.371"></a><span id="l26.371" class="difflineminus">-  rv = bundleService-&gt;CreateBundle(&quot;chrome://messenger/locale/importMsgs.properties&quot;,</span>
<a href="#l26.372"></a><span id="l26.372" class="difflineminus">-                                   getter_AddRefs(bundle));</span>
<a href="#l26.373"></a><span id="l26.373" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l26.374"></a><span id="l26.374" class="difflineminus">-  {</span>
<a href="#l26.375"></a><span id="l26.375" class="difflineminus">-    nsAutoString Eudora(NS_LITERAL_STRING(&quot;Eudora&quot;));</span>
<a href="#l26.376"></a><span id="l26.376" class="difflineminus">-    const char16_t *moduleName[] = { Eudora.get() };</span>
<a href="#l26.377"></a><span id="l26.377" class="difflineminus">-    rv = bundle-&gt;FormatStringFromName(MOZ_UTF16(&quot;ImportModuleFolderName&quot;),</span>
<a href="#l26.378"></a><span id="l26.378" class="difflineminus">-                                      moduleName, 1, getter_Copies(folderName));</span>
<a href="#l26.379"></a><span id="l26.379" class="difflineminus">-  }</span>
<a href="#l26.380"></a><span id="l26.380" class="difflineminus">-  localRootFolder-&gt;GetChildNamed(folderName, getter_AddRefs(m_pMailboxesRoot));</span>
<a href="#l26.381"></a><span id="l26.381" class="difflineminus">-  if (!m_pMailboxesRoot)</span>
<a href="#l26.382"></a><span id="l26.382" class="difflineminus">-  {</span>
<a href="#l26.383"></a><span id="l26.383" class="difflineminus">-    // If no &quot;Eudora Import&quot; folder then this is a</span>
<a href="#l26.384"></a><span id="l26.384" class="difflineminus">-    // migration which just puts it in the root</span>
<a href="#l26.385"></a><span id="l26.385" class="difflineminus">-    m_pMailboxesRoot = localRootFolder;</span>
<a href="#l26.386"></a><span id="l26.386" class="difflineminus">-  }</span>
<a href="#l26.387"></a><span id="l26.387" class="difflineminus">-</span>
<a href="#l26.388"></a><span id="l26.388" class="difflineminus">-  return rv;</span>
<a href="#l26.389"></a><span id="l26.389" class="difflineminus">-}</span>
<a href="#l26.390"></a><span id="l26.390" class="difflineminus">-</span>
<a href="#l26.391"></a><span id="l26.391" class="difflineminus">-nsresult nsEudoraFilters::LoadServers()</span>
<a href="#l26.392"></a><span id="l26.392" class="difflineminus">-{</span>
<a href="#l26.393"></a><span id="l26.393" class="difflineminus">-  nsresult rv;</span>
<a href="#l26.394"></a><span id="l26.394" class="difflineminus">-</span>
<a href="#l26.395"></a><span id="l26.395" class="difflineminus">-  if (m_pServerArray)</span>
<a href="#l26.396"></a><span id="l26.396" class="difflineminus">-    rv = m_pServerArray-&gt;Clear();</span>
<a href="#l26.397"></a><span id="l26.397" class="difflineminus">-  else</span>
<a href="#l26.398"></a><span id="l26.398" class="difflineminus">-    m_pServerArray = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l26.399"></a><span id="l26.399" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.400"></a><span id="l26.400" class="difflineminus">-</span>
<a href="#l26.401"></a><span id="l26.401" class="difflineminus">-  if (!m_pFilterArray)</span>
<a href="#l26.402"></a><span id="l26.402" class="difflineminus">-    m_pFilterArray = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l26.403"></a><span id="l26.403" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.404"></a><span id="l26.404" class="difflineminus">-</span>
<a href="#l26.405"></a><span id="l26.405" class="difflineminus">-  nsCOMPtr&lt;nsIMsgAccountManager&gt; accountMgr = do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l26.406"></a><span id="l26.406" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.407"></a><span id="l26.407" class="difflineminus">-</span>
<a href="#l26.408"></a><span id="l26.408" class="difflineminus">-  nsCOMPtr&lt;nsIArray&gt; allServers;</span>
<a href="#l26.409"></a><span id="l26.409" class="difflineminus">-  rv = accountMgr-&gt;GetAllServers(getter_AddRefs(allServers));</span>
<a href="#l26.410"></a><span id="l26.410" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.411"></a><span id="l26.411" class="difflineminus">-</span>
<a href="#l26.412"></a><span id="l26.412" class="difflineminus">-  uint32_t numServers;</span>
<a href="#l26.413"></a><span id="l26.413" class="difflineminus">-  rv = allServers-&gt;GetLength(&amp;numServers);</span>
<a href="#l26.414"></a><span id="l26.414" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.415"></a><span id="l26.415" class="difflineminus">-  for (uint32_t serverIndex = 0; serverIndex &lt; numServers; serverIndex++)</span>
<a href="#l26.416"></a><span id="l26.416" class="difflineminus">-  {</span>
<a href="#l26.417"></a><span id="l26.417" class="difflineminus">-    nsCOMPtr&lt;nsIMsgIncomingServer&gt; server = do_QueryElementAt(allServers, serverIndex, &amp;rv);</span>
<a href="#l26.418"></a><span id="l26.418" class="difflineminus">-    if (server &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l26.419"></a><span id="l26.419" class="difflineminus">-    {</span>
<a href="#l26.420"></a><span id="l26.420" class="difflineminus">-      bool canHaveFilters;</span>
<a href="#l26.421"></a><span id="l26.421" class="difflineminus">-      rv = server-&gt;GetCanHaveFilters(&amp;canHaveFilters);</span>
<a href="#l26.422"></a><span id="l26.422" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; canHaveFilters)</span>
<a href="#l26.423"></a><span id="l26.423" class="difflineminus">-      {</span>
<a href="#l26.424"></a><span id="l26.424" class="difflineminus">-        nsAutoCString serverType;</span>
<a href="#l26.425"></a><span id="l26.425" class="difflineminus">-        rv = server-&gt;GetType(serverType);</span>
<a href="#l26.426"></a><span id="l26.426" class="difflineminus">-        if (NS_SUCCEEDED(rv) &amp;&amp; !serverType.IsEmpty())</span>
<a href="#l26.427"></a><span id="l26.427" class="difflineminus">-        {</span>
<a href="#l26.428"></a><span id="l26.428" class="difflineminus">-          // Only get imap accounts and the special &quot;none&quot; (Local Folders) account</span>
<a href="#l26.429"></a><span id="l26.429" class="difflineminus">-          // since all imported Eudora pop3 accounts will go to Local Folders</span>
<a href="#l26.430"></a><span id="l26.430" class="difflineminus">-          if (serverType.Equals(&quot;none&quot;) || serverType.Equals(&quot;imap&quot;))</span>
<a href="#l26.431"></a><span id="l26.431" class="difflineminus">-          {</span>
<a href="#l26.432"></a><span id="l26.432" class="difflineminus">-            // Pre-fetch filters now so that if there's any problem reading up the</span>
<a href="#l26.433"></a><span id="l26.433" class="difflineminus">-            // filter file we know about it in advance and can stop importing</span>
<a href="#l26.434"></a><span id="l26.434" class="difflineminus">-            nsCOMPtr&lt;nsIMsgFilterList&gt; filterList;</span>
<a href="#l26.435"></a><span id="l26.435" class="difflineminus">-            rv = server-&gt;GetFilterList(nullptr, getter_AddRefs(filterList));</span>
<a href="#l26.436"></a><span id="l26.436" class="difflineminus">-            NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.437"></a><span id="l26.437" class="difflineminus">-</span>
<a href="#l26.438"></a><span id="l26.438" class="difflineminus">-            m_pServerArray-&gt;AppendElement(server, false);</span>
<a href="#l26.439"></a><span id="l26.439" class="difflineminus">-          }</span>
<a href="#l26.440"></a><span id="l26.440" class="difflineminus">-        }</span>
<a href="#l26.441"></a><span id="l26.441" class="difflineminus">-      }</span>
<a href="#l26.442"></a><span id="l26.442" class="difflineminus">-    }</span>
<a href="#l26.443"></a><span id="l26.443" class="difflineminus">-  }</span>
<a href="#l26.444"></a><span id="l26.444" class="difflineminus">-</span>
<a href="#l26.445"></a><span id="l26.445" class="difflineminus">-  return NS_OK;</span>
<a href="#l26.446"></a><span id="l26.446" class="difflineminus">-}</span>
<a href="#l26.447"></a><span id="l26.447" class="difflineminus">-</span>
<a href="#l26.448"></a><span id="l26.448" class="difflineminus">-nsresult nsEudoraFilters::SaveFilters()</span>
<a href="#l26.449"></a><span id="l26.449" class="difflineminus">-{</span>
<a href="#l26.450"></a><span id="l26.450" class="difflineminus">-  nsresult rv;</span>
<a href="#l26.451"></a><span id="l26.451" class="difflineminus">-</span>
<a href="#l26.452"></a><span id="l26.452" class="difflineminus">-  uint32_t numServers;</span>
<a href="#l26.453"></a><span id="l26.453" class="difflineminus">-  rv = m_pServerArray-&gt;GetLength(&amp;numServers);</span>
<a href="#l26.454"></a><span id="l26.454" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.455"></a><span id="l26.455" class="difflineminus">-  for (uint32_t serverIndex = 0; serverIndex &lt; numServers; serverIndex++)</span>
<a href="#l26.456"></a><span id="l26.456" class="difflineminus">-  {</span>
<a href="#l26.457"></a><span id="l26.457" class="difflineminus">-    nsCOMPtr&lt;nsIMsgIncomingServer&gt; server = do_QueryElementAt(m_pServerArray, serverIndex, &amp;rv);</span>
<a href="#l26.458"></a><span id="l26.458" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.459"></a><span id="l26.459" class="difflineminus">-</span>
<a href="#l26.460"></a><span id="l26.460" class="difflineminus">-    nsCOMPtr &lt;nsIMsgFilterList&gt; filterList;</span>
<a href="#l26.461"></a><span id="l26.461" class="difflineminus">-    rv = server-&gt;GetFilterList(nullptr, getter_AddRefs(filterList));</span>
<a href="#l26.462"></a><span id="l26.462" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.463"></a><span id="l26.463" class="difflineminus">-</span>
<a href="#l26.464"></a><span id="l26.464" class="difflineminus">-    rv = filterList-&gt;SaveToDefaultFile();</span>
<a href="#l26.465"></a><span id="l26.465" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.466"></a><span id="l26.466" class="difflineminus">-  }</span>
<a href="#l26.467"></a><span id="l26.467" class="difflineminus">-</span>
<a href="#l26.468"></a><span id="l26.468" class="difflineminus">-  return NS_OK;</span>
<a href="#l26.469"></a><span id="l26.469" class="difflineminus">-}</span>
<a href="#l26.470"></a><span id="l26.470" class="difflineminus">-</span>
<a href="#l26.471"></a><span id="l26.471" class="difflineminus">-nsresult nsEudoraFilters::CreateNewFilter(const char* pName)</span>
<a href="#l26.472"></a><span id="l26.472" class="difflineminus">-{</span>
<a href="#l26.473"></a><span id="l26.473" class="difflineminus">-  nsresult rv;</span>
<a href="#l26.474"></a><span id="l26.474" class="difflineminus">-</span>
<a href="#l26.475"></a><span id="l26.475" class="difflineminus">-  rv = m_pFilterArray-&gt;Clear();</span>
<a href="#l26.476"></a><span id="l26.476" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.477"></a><span id="l26.477" class="difflineminus">-</span>
<a href="#l26.478"></a><span id="l26.478" class="difflineminus">-  nsAutoString unicodeName;</span>
<a href="#l26.479"></a><span id="l26.479" class="difflineminus">-  NS_CopyNativeToUnicode(nsCString(pName), unicodeName);</span>
<a href="#l26.480"></a><span id="l26.480" class="difflineminus">-  uint32_t numServers;</span>
<a href="#l26.481"></a><span id="l26.481" class="difflineminus">-  rv = m_pServerArray-&gt;GetLength(&amp;numServers);</span>
<a href="#l26.482"></a><span id="l26.482" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.483"></a><span id="l26.483" class="difflineminus">-  for (uint32_t serverIndex = 0; serverIndex &lt; numServers; serverIndex++)</span>
<a href="#l26.484"></a><span id="l26.484" class="difflineminus">-  {</span>
<a href="#l26.485"></a><span id="l26.485" class="difflineminus">-    nsCOMPtr&lt;nsIMsgIncomingServer&gt; server = do_QueryElementAt(m_pServerArray, serverIndex, &amp;rv);</span>
<a href="#l26.486"></a><span id="l26.486" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.487"></a><span id="l26.487" class="difflineminus">-</span>
<a href="#l26.488"></a><span id="l26.488" class="difflineminus">-    nsCOMPtr &lt;nsIMsgFilterList&gt; filterList;</span>
<a href="#l26.489"></a><span id="l26.489" class="difflineminus">-    rv = server-&gt;GetFilterList(nullptr, getter_AddRefs(filterList));</span>
<a href="#l26.490"></a><span id="l26.490" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.491"></a><span id="l26.491" class="difflineminus">-</span>
<a href="#l26.492"></a><span id="l26.492" class="difflineminus">-    nsCOMPtr&lt;nsIMsgFilter&gt; newFilter;</span>
<a href="#l26.493"></a><span id="l26.493" class="difflineminus">-    rv = filterList-&gt;CreateFilter(unicodeName, getter_AddRefs(newFilter));</span>
<a href="#l26.494"></a><span id="l26.494" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.495"></a><span id="l26.495" class="difflineminus">-</span>
<a href="#l26.496"></a><span id="l26.496" class="difflineminus">-    rv = newFilter-&gt;SetEnabled(false);</span>
<a href="#l26.497"></a><span id="l26.497" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.498"></a><span id="l26.498" class="difflineminus">-</span>
<a href="#l26.499"></a><span id="l26.499" class="difflineminus">-    uint32_t count;</span>
<a href="#l26.500"></a><span id="l26.500" class="difflineminus">-    rv = filterList-&gt;GetFilterCount(&amp;count);</span>
<a href="#l26.501"></a><span id="l26.501" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.502"></a><span id="l26.502" class="difflineminus">-</span>
<a href="#l26.503"></a><span id="l26.503" class="difflineminus">-    rv = filterList-&gt;InsertFilterAt(count, newFilter);</span>
<a href="#l26.504"></a><span id="l26.504" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.505"></a><span id="l26.505" class="difflineminus">-</span>
<a href="#l26.506"></a><span id="l26.506" class="difflineminus">-    m_pFilterArray-&gt;AppendElement(newFilter, false);</span>
<a href="#l26.507"></a><span id="l26.507" class="difflineminus">-  }</span>
<a href="#l26.508"></a><span id="l26.508" class="difflineminus">-</span>
<a href="#l26.509"></a><span id="l26.509" class="difflineminus">-  m_isAnd = false;</span>
<a href="#l26.510"></a><span id="l26.510" class="difflineminus">-  m_isUnless = false;</span>
<a href="#l26.511"></a><span id="l26.511" class="difflineminus">-  m_ignoreTerm = false;</span>
<a href="#l26.512"></a><span id="l26.512" class="difflineminus">-  m_isIncoming = false;</span>
<a href="#l26.513"></a><span id="l26.513" class="difflineminus">-  m_addedAction = false;</span>
<a href="#l26.514"></a><span id="l26.514" class="difflineminus">-  m_hasTransfer = false;</span>
<a href="#l26.515"></a><span id="l26.515" class="difflineminus">-  m_hasStop = false;</span>
<a href="#l26.516"></a><span id="l26.516" class="difflineminus">-  m_termNotGroked = false;</span>
<a href="#l26.517"></a><span id="l26.517" class="difflineminus">-</span>
<a href="#l26.518"></a><span id="l26.518" class="difflineminus">-  return NS_OK;</span>
<a href="#l26.519"></a><span id="l26.519" class="difflineminus">-}</span>
<a href="#l26.520"></a><span id="l26.520" class="difflineminus">-</span>
<a href="#l26.521"></a><span id="l26.521" class="difflineminus">-nsresult nsEudoraFilters::FinalizeFilter()</span>
<a href="#l26.522"></a><span id="l26.522" class="difflineminus">-{</span>
<a href="#l26.523"></a><span id="l26.523" class="difflineminus">-  nsresult rv = NS_OK;</span>
<a href="#l26.524"></a><span id="l26.524" class="difflineminus">-</span>
<a href="#l26.525"></a><span id="l26.525" class="difflineminus">-  // Transfer actions always stop filtering, so only add a stop action when there</span>
<a href="#l26.526"></a><span id="l26.526" class="difflineminus">-  // was no transfer action in order to keep the filter action list cleaner</span>
<a href="#l26.527"></a><span id="l26.527" class="difflineminus">-  if (m_hasStop &amp;&amp; !m_hasTransfer)</span>
<a href="#l26.528"></a><span id="l26.528" class="difflineminus">-    AddAction(nsMsgFilterAction::StopExecution);</span>
<a href="#l26.529"></a><span id="l26.529" class="difflineminus">-</span>
<a href="#l26.530"></a><span id="l26.530" class="difflineminus">-  // TB only does filtering on incoming messages.</span>
<a href="#l26.531"></a><span id="l26.531" class="difflineminus">-  // Also, if you don't provide an action for a filter, TB will provide a default action of moving</span>
<a href="#l26.532"></a><span id="l26.532" class="difflineminus">-  // the message to the first mailbox in the first set of mailboxes.  Not what we want, so</span>
<a href="#l26.533"></a><span id="l26.533" class="difflineminus">-  // we disable the filter (gives the user a chance to add their own actions and enable).</span>
<a href="#l26.534"></a><span id="l26.534" class="difflineminus">-  // Lastly, only enable if all terms were fully understood.</span>
<a href="#l26.535"></a><span id="l26.535" class="difflineminus">-  if (m_isIncoming &amp;&amp; m_addedAction &amp;&amp; !m_termNotGroked)</span>
<a href="#l26.536"></a><span id="l26.536" class="difflineminus">-    rv = EnableFilter(true);</span>
<a href="#l26.537"></a><span id="l26.537" class="difflineminus">-</span>
<a href="#l26.538"></a><span id="l26.538" class="difflineminus">-  return rv;</span>
<a href="#l26.539"></a><span id="l26.539" class="difflineminus">-}</span>
<a href="#l26.540"></a><span id="l26.540" class="difflineminus">-</span>
<a href="#l26.541"></a><span id="l26.541" class="difflineminus">-nsresult nsEudoraFilters::EnableFilter(bool enable)</span>
<a href="#l26.542"></a><span id="l26.542" class="difflineminus">-{</span>
<a href="#l26.543"></a><span id="l26.543" class="difflineminus">-  nsresult rv;</span>
<a href="#l26.544"></a><span id="l26.544" class="difflineminus">-</span>
<a href="#l26.545"></a><span id="l26.545" class="difflineminus">-  uint32_t numFilters;</span>
<a href="#l26.546"></a><span id="l26.546" class="difflineminus">-  rv = m_pFilterArray-&gt;GetLength(&amp;numFilters);</span>
<a href="#l26.547"></a><span id="l26.547" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.548"></a><span id="l26.548" class="difflineminus">-  for (uint32_t filterIndex = 0; filterIndex &lt; numFilters; filterIndex++)</span>
<a href="#l26.549"></a><span id="l26.549" class="difflineminus">-  {</span>
<a href="#l26.550"></a><span id="l26.550" class="difflineminus">-    nsCOMPtr&lt;nsIMsgFilter&gt; filter = do_QueryElementAt(m_pFilterArray, filterIndex, &amp;rv);</span>
<a href="#l26.551"></a><span id="l26.551" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.552"></a><span id="l26.552" class="difflineminus">-</span>
<a href="#l26.553"></a><span id="l26.553" class="difflineminus">-    filter-&gt;SetEnabled(enable);</span>
<a href="#l26.554"></a><span id="l26.554" class="difflineminus">-  }</span>
<a href="#l26.555"></a><span id="l26.555" class="difflineminus">-</span>
<a href="#l26.556"></a><span id="l26.556" class="difflineminus">-  return NS_OK;</span>
<a href="#l26.557"></a><span id="l26.557" class="difflineminus">-}</span>
<a href="#l26.558"></a><span id="l26.558" class="difflineminus">-</span>
<a href="#l26.559"></a><span id="l26.559" class="difflineminus">-// Different character sets on Windows and Mac put left and right double angle quotes in different spots</span>
<a href="#l26.560"></a><span id="l26.560" class="difflineminus">-#if defined(XP_WIN)</span>
<a href="#l26.561"></a><span id="l26.561" class="difflineminus">-#define LDAQ &quot;\xAB&quot;</span>
<a href="#l26.562"></a><span id="l26.562" class="difflineminus">-#define RDAQ &quot;\xBB&quot;</span>
<a href="#l26.563"></a><span id="l26.563" class="difflineminus">-#elif XP_MACOSX</span>
<a href="#l26.564"></a><span id="l26.564" class="difflineminus">-#define LDAQ &quot;\xC7&quot;</span>
<a href="#l26.565"></a><span id="l26.565" class="difflineminus">-#define RDAQ &quot;\xC8&quot;</span>
<a href="#l26.566"></a><span id="l26.566" class="difflineminus">-#endif</span>
<a href="#l26.567"></a><span id="l26.567" class="difflineminus">-</span>
<a href="#l26.568"></a><span id="l26.568" class="difflineminus">-static const char* gStandardHeaders[] =</span>
<a href="#l26.569"></a><span id="l26.569" class="difflineminus">-{</span>
<a href="#l26.570"></a><span id="l26.570" class="difflineminus">-// Eudora string        nsMsgSearchAttribValue</span>
<a href="#l26.571"></a><span id="l26.571" class="difflineminus">-// -------------        ----------------------</span>
<a href="#l26.572"></a><span id="l26.572" class="difflineminus">-    &quot;Subject:&quot;,                // Subject</span>
<a href="#l26.573"></a><span id="l26.573" class="difflineminus">-    &quot;From:&quot;,                   // Sender</span>
<a href="#l26.574"></a><span id="l26.574" class="difflineminus">-    LDAQ &quot;Body&quot; RDAQ,          // Body</span>
<a href="#l26.575"></a><span id="l26.575" class="difflineminus">-    &quot;Date:&quot;,                   // Date</span>
<a href="#l26.576"></a><span id="l26.576" class="difflineminus">-    &quot;X-Priority:&quot;,             // Priority</span>
<a href="#l26.577"></a><span id="l26.577" class="difflineminus">-    &quot;&quot;,                        // MsgStatus</span>
<a href="#l26.578"></a><span id="l26.578" class="difflineminus">-    &quot;To:&quot;,                     // To</span>
<a href="#l26.579"></a><span id="l26.579" class="difflineminus">-    &quot;Cc:&quot;,                     // CC</span>
<a href="#l26.580"></a><span id="l26.580" class="difflineminus">-    LDAQ &quot;Any Recipient&quot; RDAQ, // ToOrCC</span>
<a href="#l26.581"></a><span id="l26.581" class="difflineminus">-    NULL</span>
<a href="#l26.582"></a><span id="l26.582" class="difflineminus">-};</span>
<a href="#l26.583"></a><span id="l26.583" class="difflineminus">-</span>
<a href="#l26.584"></a><span id="l26.584" class="difflineminus">-static int32_t FindHeader(const char* pHeader)</span>
<a href="#l26.585"></a><span id="l26.585" class="difflineminus">-{</span>
<a href="#l26.586"></a><span id="l26.586" class="difflineminus">-  for (int32_t i = 0; gStandardHeaders[i]; i++)</span>
<a href="#l26.587"></a><span id="l26.587" class="difflineminus">-  {</span>
<a href="#l26.588"></a><span id="l26.588" class="difflineminus">-    if (*gStandardHeaders[i] &amp;&amp; !PL_strcasecmp(pHeader, gStandardHeaders[i]))</span>
<a href="#l26.589"></a><span id="l26.589" class="difflineminus">-      return i;</span>
<a href="#l26.590"></a><span id="l26.590" class="difflineminus">-  }</span>
<a href="#l26.591"></a><span id="l26.591" class="difflineminus">-</span>
<a href="#l26.592"></a><span id="l26.592" class="difflineminus">-  return -1;</span>
<a href="#l26.593"></a><span id="l26.593" class="difflineminus">-}</span>
<a href="#l26.594"></a><span id="l26.594" class="difflineminus">-</span>
<a href="#l26.595"></a><span id="l26.595" class="difflineminus">-static const char* gOperators[] =</span>
<a href="#l26.596"></a><span id="l26.596" class="difflineminus">-{</span>
<a href="#l26.597"></a><span id="l26.597" class="difflineminus">-// Eudora string        nsMsgSearchOpValue</span>
<a href="#l26.598"></a><span id="l26.598" class="difflineminus">-// -------------        ------------------</span>
<a href="#l26.599"></a><span id="l26.599" class="difflineminus">-    &quot;contains&quot;,         // Contains</span>
<a href="#l26.600"></a><span id="l26.600" class="difflineminus">-    &quot;!contains&quot;,        // DoesntContain</span>
<a href="#l26.601"></a><span id="l26.601" class="difflineminus">-    &quot;is&quot;,               // Is</span>
<a href="#l26.602"></a><span id="l26.602" class="difflineminus">-    &quot;!is&quot;,              // Isnt</span>
<a href="#l26.603"></a><span id="l26.603" class="difflineminus">-    &quot;&quot;,                 // IsEmpty</span>
<a href="#l26.604"></a><span id="l26.604" class="difflineminus">-    &quot;&quot;,                 // IsBefore</span>
<a href="#l26.605"></a><span id="l26.605" class="difflineminus">-    &quot;&quot;,                 // IsAfter</span>
<a href="#l26.606"></a><span id="l26.606" class="difflineminus">-    &quot;&quot;,                 // IsHigherThan</span>
<a href="#l26.607"></a><span id="l26.607" class="difflineminus">-    &quot;&quot;,                 // IsLowerThan</span>
<a href="#l26.608"></a><span id="l26.608" class="difflineminus">-    &quot;starts&quot;,           // BeginsWith</span>
<a href="#l26.609"></a><span id="l26.609" class="difflineminus">-    &quot;ends&quot;,             // EndsWith</span>
<a href="#l26.610"></a><span id="l26.610" class="difflineminus">-    &quot;&quot;,                 // SoundsLike</span>
<a href="#l26.611"></a><span id="l26.611" class="difflineminus">-    &quot;&quot;,                 // LdapDwim</span>
<a href="#l26.612"></a><span id="l26.612" class="difflineminus">-    &quot;&quot;,                 // IsGreaterThan</span>
<a href="#l26.613"></a><span id="l26.613" class="difflineminus">-    &quot;&quot;,                 // IsLessThan</span>
<a href="#l26.614"></a><span id="l26.614" class="difflineminus">-    &quot;&quot;,                 // NameCompletion</span>
<a href="#l26.615"></a><span id="l26.615" class="difflineminus">-    &quot;intersectsFile&quot;,   // IsInAB</span>
<a href="#l26.616"></a><span id="l26.616" class="difflineminus">-    &quot;disjointFile&quot;,     // IsntInAB</span>
<a href="#l26.617"></a><span id="l26.617" class="difflineminus">-    NULL</span>
<a href="#l26.618"></a><span id="l26.618" class="difflineminus">-};</span>
<a href="#l26.619"></a><span id="l26.619" class="difflineminus">-</span>
<a href="#l26.620"></a><span id="l26.620" class="difflineminus">-static int32_t FindOperator(const char* pOperator)</span>
<a href="#l26.621"></a><span id="l26.621" class="difflineminus">-{</span>
<a href="#l26.622"></a><span id="l26.622" class="difflineminus">-  for (int32_t i = 0; gOperators[i]; i++)</span>
<a href="#l26.623"></a><span id="l26.623" class="difflineminus">-  {</span>
<a href="#l26.624"></a><span id="l26.624" class="difflineminus">-    if (*gOperators[i] &amp;&amp; !strcmp(pOperator, gOperators[i]))</span>
<a href="#l26.625"></a><span id="l26.625" class="difflineminus">-      return i;</span>
<a href="#l26.626"></a><span id="l26.626" class="difflineminus">-  }</span>
<a href="#l26.627"></a><span id="l26.627" class="difflineminus">-</span>
<a href="#l26.628"></a><span id="l26.628" class="difflineminus">-  return -1;</span>
<a href="#l26.629"></a><span id="l26.629" class="difflineminus">-}</span>
<a href="#l26.630"></a><span id="l26.630" class="difflineminus">-</span>
<a href="#l26.631"></a><span id="l26.631" class="difflineminus">-#define MAILNEWS_CUSTOM_HEADERS &quot;mailnews.customHeaders&quot;</span>
<a href="#l26.632"></a><span id="l26.632" class="difflineminus">-</span>
<a href="#l26.633"></a><span id="l26.633" class="difflineminus">-static int32_t AddCustomHeader(const char* pHeader)</span>
<a href="#l26.634"></a><span id="l26.634" class="difflineminus">-{</span>
<a href="#l26.635"></a><span id="l26.635" class="difflineminus">-  nsresult rv;</span>
<a href="#l26.636"></a><span id="l26.636" class="difflineminus">-  int32_t index = -1;</span>
<a href="#l26.637"></a><span id="l26.637" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; pref(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l26.638"></a><span id="l26.638" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, index);</span>
<a href="#l26.639"></a><span id="l26.639" class="difflineminus">-</span>
<a href="#l26.640"></a><span id="l26.640" class="difflineminus">-  nsAutoCString headers;</span>
<a href="#l26.641"></a><span id="l26.641" class="difflineminus">-  pref-&gt;GetCharPref(MAILNEWS_CUSTOM_HEADERS, getter_Copies(headers));</span>
<a href="#l26.642"></a><span id="l26.642" class="difflineminus">-  index = 0;</span>
<a href="#l26.643"></a><span id="l26.643" class="difflineminus">-  if (!headers.IsEmpty())</span>
<a href="#l26.644"></a><span id="l26.644" class="difflineminus">-  {</span>
<a href="#l26.645"></a><span id="l26.645" class="difflineminus">-    char *headersString = ToNewCString(headers);</span>
<a href="#l26.646"></a><span id="l26.646" class="difflineminus">-    nsAutoCString hdrStr;</span>
<a href="#l26.647"></a><span id="l26.647" class="difflineminus">-    hdrStr.Adopt(headersString);</span>
<a href="#l26.648"></a><span id="l26.648" class="difflineminus">-    hdrStr.StripWhitespace();  //remove whitespace before parsing</span>
<a href="#l26.649"></a><span id="l26.649" class="difflineminus">-</span>
<a href="#l26.650"></a><span id="l26.650" class="difflineminus">-    char *newStr = headersString;</span>
<a href="#l26.651"></a><span id="l26.651" class="difflineminus">-    char *token = NS_strtok(&quot;:&quot;, &amp;newStr);</span>
<a href="#l26.652"></a><span id="l26.652" class="difflineminus">-    while (token)</span>
<a href="#l26.653"></a><span id="l26.653" class="difflineminus">-    {</span>
<a href="#l26.654"></a><span id="l26.654" class="difflineminus">-      if (!PL_strcasecmp(token, pHeader))</span>
<a href="#l26.655"></a><span id="l26.655" class="difflineminus">-        return index;</span>
<a href="#l26.656"></a><span id="l26.656" class="difflineminus">-      token = NS_strtok(&quot;:&quot;, &amp;newStr);</span>
<a href="#l26.657"></a><span id="l26.657" class="difflineminus">-      index++;</span>
<a href="#l26.658"></a><span id="l26.658" class="difflineminus">-    }</span>
<a href="#l26.659"></a><span id="l26.659" class="difflineminus">-    headers += &quot;:&quot;;</span>
<a href="#l26.660"></a><span id="l26.660" class="difflineminus">-  }</span>
<a href="#l26.661"></a><span id="l26.661" class="difflineminus">-  headers += pHeader;</span>
<a href="#l26.662"></a><span id="l26.662" class="difflineminus">-  pref-&gt;SetCharPref(MAILNEWS_CUSTOM_HEADERS, headers.get());</span>
<a href="#l26.663"></a><span id="l26.663" class="difflineminus">-</span>
<a href="#l26.664"></a><span id="l26.664" class="difflineminus">-  return index;</span>
<a href="#l26.665"></a><span id="l26.665" class="difflineminus">-}</span>
<a href="#l26.666"></a><span id="l26.666" class="difflineminus">-</span>
<a href="#l26.667"></a><span id="l26.667" class="difflineminus">-nsresult nsEudoraFilters::AddTerm(const char* pHeader, const char* pVerb, const char* pValue, bool booleanAnd, bool negateVerb)</span>
<a href="#l26.668"></a><span id="l26.668" class="difflineminus">-{</span>
<a href="#l26.669"></a><span id="l26.669" class="difflineminus">-  nsresult rv;</span>
<a href="#l26.670"></a><span id="l26.670" class="difflineminus">-</span>
<a href="#l26.671"></a><span id="l26.671" class="difflineminus">-  nsMsgSearchAttribValue attrib = FindHeader(pHeader);</span>
<a href="#l26.672"></a><span id="l26.672" class="difflineminus">-  nsMsgSearchOpValue     op = FindOperator(pVerb);</span>
<a href="#l26.673"></a><span id="l26.673" class="difflineminus">-  nsAutoCString          arbitraryHeader;</span>
<a href="#l26.674"></a><span id="l26.674" class="difflineminus">-  nsAutoString           unicodeHeader, unicodeVerb, unicodeValue;</span>
<a href="#l26.675"></a><span id="l26.675" class="difflineminus">-  nsAutoString           filterTitle;</span>
<a href="#l26.676"></a><span id="l26.676" class="difflineminus">-</span>
<a href="#l26.677"></a><span id="l26.677" class="difflineminus">-  NS_CopyNativeToUnicode(nsCString(pHeader), unicodeHeader);</span>
<a href="#l26.678"></a><span id="l26.678" class="difflineminus">-  NS_CopyNativeToUnicode(nsCString(pVerb), unicodeVerb);</span>
<a href="#l26.679"></a><span id="l26.679" class="difflineminus">-  NS_CopyNativeToUnicode(nsCString(pValue), unicodeValue);</span>
<a href="#l26.680"></a><span id="l26.680" class="difflineminus">-</span>
<a href="#l26.681"></a><span id="l26.681" class="difflineminus">-  filterTitle = NS_LITERAL_STRING(&quot;- &quot;);</span>
<a href="#l26.682"></a><span id="l26.682" class="difflineminus">-  filterTitle += unicodeHeader;</span>
<a href="#l26.683"></a><span id="l26.683" class="difflineminus">-  filterTitle += NS_LITERAL_STRING(&quot; &quot;);</span>
<a href="#l26.684"></a><span id="l26.684" class="difflineminus">-  filterTitle += unicodeVerb;</span>
<a href="#l26.685"></a><span id="l26.685" class="difflineminus">-  filterTitle += NS_LITERAL_STRING(&quot; &quot;);</span>
<a href="#l26.686"></a><span id="l26.686" class="difflineminus">-  filterTitle += unicodeValue;</span>
<a href="#l26.687"></a><span id="l26.687" class="difflineminus">-  filterTitle += NS_LITERAL_STRING(&quot;: &quot;);</span>
<a href="#l26.688"></a><span id="l26.688" class="difflineminus">-</span>
<a href="#l26.689"></a><span id="l26.689" class="difflineminus">-  if (op &lt; 0)</span>
<a href="#l26.690"></a><span id="l26.690" class="difflineminus">-  {</span>
<a href="#l26.691"></a><span id="l26.691" class="difflineminus">-    m_errorLog += filterTitle;</span>
<a href="#l26.692"></a><span id="l26.692" class="difflineminus">-    m_errorLog += nsEudoraStringBundle::FormatString(EUDORAIMPORT_FILTERS_WARN_VERB, pVerb);</span>
<a href="#l26.693"></a><span id="l26.693" class="difflineminus">-    m_errorLog += NS_LITERAL_STRING(&quot;\n&quot;);</span>
<a href="#l26.694"></a><span id="l26.694" class="difflineminus">-    return NS_ERROR_INVALID_ARG;</span>
<a href="#l26.695"></a><span id="l26.695" class="difflineminus">-  }</span>
<a href="#l26.696"></a><span id="l26.696" class="difflineminus">-</span>
<a href="#l26.697"></a><span id="l26.697" class="difflineminus">-  if (!pHeader || !*pHeader)</span>
<a href="#l26.698"></a><span id="l26.698" class="difflineminus">-  {</span>
<a href="#l26.699"></a><span id="l26.699" class="difflineminus">-    m_errorLog += filterTitle;</span>
<a href="#l26.700"></a><span id="l26.700" class="difflineminus">-    m_errorLog += nsEudoraStringBundle::FormatString(EUDORAIMPORT_FILTERS_WARN_EMPTY_HEADER);</span>
<a href="#l26.701"></a><span id="l26.701" class="difflineminus">-    m_errorLog += NS_LITERAL_STRING(&quot;\n&quot;);</span>
<a href="#l26.702"></a><span id="l26.702" class="difflineminus">-    return NS_ERROR_INVALID_ARG;</span>
<a href="#l26.703"></a><span id="l26.703" class="difflineminus">-  }</span>
<a href="#l26.704"></a><span id="l26.704" class="difflineminus">-</span>
<a href="#l26.705"></a><span id="l26.705" class="difflineminus">-  if (negateVerb)</span>
<a href="#l26.706"></a><span id="l26.706" class="difflineminus">-  {</span>
<a href="#l26.707"></a><span id="l26.707" class="difflineminus">-    switch (op)</span>
<a href="#l26.708"></a><span id="l26.708" class="difflineminus">-    {</span>
<a href="#l26.709"></a><span id="l26.709" class="difflineminus">-      case nsMsgSearchOp::Contains:</span>
<a href="#l26.710"></a><span id="l26.710" class="difflineminus">-      case nsMsgSearchOp::Is:</span>
<a href="#l26.711"></a><span id="l26.711" class="difflineminus">-      case nsMsgSearchOp::IsInAB:</span>
<a href="#l26.712"></a><span id="l26.712" class="difflineminus">-        op++;</span>
<a href="#l26.713"></a><span id="l26.713" class="difflineminus">-        break;</span>
<a href="#l26.714"></a><span id="l26.714" class="difflineminus">-      case nsMsgSearchOp::DoesntContain:</span>
<a href="#l26.715"></a><span id="l26.715" class="difflineminus">-      case nsMsgSearchOp::Isnt:</span>
<a href="#l26.716"></a><span id="l26.716" class="difflineminus">-      case nsMsgSearchOp::IsntInAB:</span>
<a href="#l26.717"></a><span id="l26.717" class="difflineminus">-        op--;</span>
<a href="#l26.718"></a><span id="l26.718" class="difflineminus">-        break;</span>
<a href="#l26.719"></a><span id="l26.719" class="difflineminus">-      default:</span>
<a href="#l26.720"></a><span id="l26.720" class="difflineminus">-        m_errorLog += filterTitle;</span>
<a href="#l26.721"></a><span id="l26.721" class="difflineminus">-        m_errorLog += nsEudoraStringBundle::FormatString(EUDORAIMPORT_FILTERS_WARN_NEGATE_VERB, unicodeVerb.get());</span>
<a href="#l26.722"></a><span id="l26.722" class="difflineminus">-        m_errorLog += NS_LITERAL_STRING(&quot;\n&quot;);</span>
<a href="#l26.723"></a><span id="l26.723" class="difflineminus">-        return NS_ERROR_INVALID_ARG;</span>
<a href="#l26.724"></a><span id="l26.724" class="difflineminus">-    }</span>
<a href="#l26.725"></a><span id="l26.725" class="difflineminus">-  }</span>
<a href="#l26.726"></a><span id="l26.726" class="difflineminus">-</span>
<a href="#l26.727"></a><span id="l26.727" class="difflineminus">-  if (attrib &lt; 0)</span>
<a href="#l26.728"></a><span id="l26.728" class="difflineminus">-  {</span>
<a href="#l26.729"></a><span id="l26.729" class="difflineminus">-    // Can't handle other Eudora meta-headers (Any Header, Personality, Junk Score)</span>
<a href="#l26.730"></a><span id="l26.730" class="difflineminus">-    if (*pHeader == *LDAQ)</span>
<a href="#l26.731"></a><span id="l26.731" class="difflineminus">-    {</span>
<a href="#l26.732"></a><span id="l26.732" class="difflineminus">-      m_errorLog += filterTitle;</span>
<a href="#l26.733"></a><span id="l26.733" class="difflineminus">-      m_errorLog += nsEudoraStringBundle::FormatString(EUDORAIMPORT_FILTERS_WARN_META_HEADER, unicodeHeader.get());</span>
<a href="#l26.734"></a><span id="l26.734" class="difflineminus">-      m_errorLog += NS_LITERAL_STRING(&quot;\n&quot;);</span>
<a href="#l26.735"></a><span id="l26.735" class="difflineminus">-      return NS_ERROR_INVALID_ARG;</span>
<a href="#l26.736"></a><span id="l26.736" class="difflineminus">-    }</span>
<a href="#l26.737"></a><span id="l26.737" class="difflineminus">-</span>
<a href="#l26.738"></a><span id="l26.738" class="difflineminus">-    // Arbitrary headers for filters don't like the colon at the end</span>
<a href="#l26.739"></a><span id="l26.739" class="difflineminus">-    arbitraryHeader = pHeader;</span>
<a href="#l26.740"></a><span id="l26.740" class="difflineminus">-    int32_t index = arbitraryHeader.FindChar(':');</span>
<a href="#l26.741"></a><span id="l26.741" class="difflineminus">-    if (index &gt;= 0)</span>
<a href="#l26.742"></a><span id="l26.742" class="difflineminus">-      arbitraryHeader.SetLength(index);</span>
<a href="#l26.743"></a><span id="l26.743" class="difflineminus">-</span>
<a href="#l26.744"></a><span id="l26.744" class="difflineminus">-    int32_t headerIndex = AddCustomHeader(arbitraryHeader.get());</span>
<a href="#l26.745"></a><span id="l26.745" class="difflineminus">-    NS_ENSURE_TRUE(headerIndex &gt;= 0, NS_ERROR_FAILURE);</span>
<a href="#l26.746"></a><span id="l26.746" class="difflineminus">-</span>
<a href="#l26.747"></a><span id="l26.747" class="difflineminus">-    attrib = nsMsgSearchAttrib::OtherHeader + 1 + headerIndex;</span>
<a href="#l26.748"></a><span id="l26.748" class="difflineminus">-  }</span>
<a href="#l26.749"></a><span id="l26.749" class="difflineminus">-</span>
<a href="#l26.750"></a><span id="l26.750" class="difflineminus">-  uint32_t numFilters;</span>
<a href="#l26.751"></a><span id="l26.751" class="difflineminus">-  rv = m_pFilterArray-&gt;GetLength(&amp;numFilters);</span>
<a href="#l26.752"></a><span id="l26.752" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.753"></a><span id="l26.753" class="difflineminus">-  for (uint32_t filterIndex = 0; filterIndex &lt; numFilters; filterIndex++)</span>
<a href="#l26.754"></a><span id="l26.754" class="difflineminus">-  {</span>
<a href="#l26.755"></a><span id="l26.755" class="difflineminus">-    nsCOMPtr&lt;nsIMsgFilter&gt; filter = do_QueryElementAt(m_pFilterArray, filterIndex, &amp;rv);</span>
<a href="#l26.756"></a><span id="l26.756" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.757"></a><span id="l26.757" class="difflineminus">-</span>
<a href="#l26.758"></a><span id="l26.758" class="difflineminus">-    nsCOMPtr&lt;nsISupportsArray&gt; terms;</span>
<a href="#l26.759"></a><span id="l26.759" class="difflineminus">-    rv = filter-&gt;GetSearchTerms(getter_AddRefs(terms));</span>
<a href="#l26.760"></a><span id="l26.760" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.761"></a><span id="l26.761" class="difflineminus">-</span>
<a href="#l26.762"></a><span id="l26.762" class="difflineminus">-    nsCOMPtr&lt;nsIMsgSearchTerm&gt; term;</span>
<a href="#l26.763"></a><span id="l26.763" class="difflineminus">-    if (booleanAnd)</span>
<a href="#l26.764"></a><span id="l26.764" class="difflineminus">-    {</span>
<a href="#l26.765"></a><span id="l26.765" class="difflineminus">-      term = do_QueryElementAt(terms, 0, &amp;rv);</span>
<a href="#l26.766"></a><span id="l26.766" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; term)</span>
<a href="#l26.767"></a><span id="l26.767" class="difflineminus">-      {</span>
<a href="#l26.768"></a><span id="l26.768" class="difflineminus">-        term-&gt;SetBooleanAnd(true);</span>
<a href="#l26.769"></a><span id="l26.769" class="difflineminus">-        term = nullptr;</span>
<a href="#l26.770"></a><span id="l26.770" class="difflineminus">-      }</span>
<a href="#l26.771"></a><span id="l26.771" class="difflineminus">-    }</span>
<a href="#l26.772"></a><span id="l26.772" class="difflineminus">-</span>
<a href="#l26.773"></a><span id="l26.773" class="difflineminus">-    rv = filter-&gt;CreateTerm(getter_AddRefs(term));</span>
<a href="#l26.774"></a><span id="l26.774" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.775"></a><span id="l26.775" class="difflineminus">-</span>
<a href="#l26.776"></a><span id="l26.776" class="difflineminus">-    nsCOMPtr&lt;nsIMsgSearchValue&gt; value;</span>
<a href="#l26.777"></a><span id="l26.777" class="difflineminus">-    rv = term-&gt;GetValue(getter_AddRefs(value));</span>
<a href="#l26.778"></a><span id="l26.778" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.779"></a><span id="l26.779" class="difflineminus">-</span>
<a href="#l26.780"></a><span id="l26.780" class="difflineminus">-    value-&gt;SetAttrib(attrib);</span>
<a href="#l26.781"></a><span id="l26.781" class="difflineminus">-    value-&gt;SetStr(unicodeValue);</span>
<a href="#l26.782"></a><span id="l26.782" class="difflineminus">-    term-&gt;SetAttrib(attrib);</span>
<a href="#l26.783"></a><span id="l26.783" class="difflineminus">-    term-&gt;SetOp(op);</span>
<a href="#l26.784"></a><span id="l26.784" class="difflineminus">-    term-&gt;SetBooleanAnd(booleanAnd);</span>
<a href="#l26.785"></a><span id="l26.785" class="difflineminus">-    if (!arbitraryHeader.IsEmpty())</span>
<a href="#l26.786"></a><span id="l26.786" class="difflineminus">-      term-&gt;SetArbitraryHeader(arbitraryHeader);</span>
<a href="#l26.787"></a><span id="l26.787" class="difflineminus">-    term-&gt;SetValue(value);</span>
<a href="#l26.788"></a><span id="l26.788" class="difflineminus">-    filter-&gt;AppendTerm(term);</span>
<a href="#l26.789"></a><span id="l26.789" class="difflineminus">-  }</span>
<a href="#l26.790"></a><span id="l26.790" class="difflineminus">-</span>
<a href="#l26.791"></a><span id="l26.791" class="difflineminus">-  return NS_OK;</span>
<a href="#l26.792"></a><span id="l26.792" class="difflineminus">-}</span>
<a href="#l26.793"></a><span id="l26.793" class="difflineminus">-</span>
<a href="#l26.794"></a><span id="l26.794" class="difflineminus">-nsresult nsEudoraFilters::AddAction(nsMsgRuleActionType actionType, int32_t junkScore /*= 0*/, nsMsgLabelValue label/*= 0*/,</span>
<a href="#l26.795"></a><span id="l26.795" class="difflineminus">-                                    nsMsgPriorityValue priority/*= 0*/, const char* strValue/*= nullptr*/, const char* targetFolderUri/*= nullptr*/)</span>
<a href="#l26.796"></a><span id="l26.796" class="difflineminus">-{</span>
<a href="#l26.797"></a><span id="l26.797" class="difflineminus">-  nsresult rv;</span>
<a href="#l26.798"></a><span id="l26.798" class="difflineminus">-</span>
<a href="#l26.799"></a><span id="l26.799" class="difflineminus">-  uint32_t numFilters;</span>
<a href="#l26.800"></a><span id="l26.800" class="difflineminus">-  rv = m_pFilterArray-&gt;GetLength(&amp;numFilters);</span>
<a href="#l26.801"></a><span id="l26.801" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.802"></a><span id="l26.802" class="difflineminus">-  for (uint32_t filterIndex = 0; filterIndex &lt; numFilters; filterIndex++)</span>
<a href="#l26.803"></a><span id="l26.803" class="difflineminus">-  {</span>
<a href="#l26.804"></a><span id="l26.804" class="difflineminus">-    nsCOMPtr&lt;nsIMsgFilter&gt; filter = do_QueryElementAt(m_pFilterArray, filterIndex, &amp;rv);</span>
<a href="#l26.805"></a><span id="l26.805" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.806"></a><span id="l26.806" class="difflineminus">-</span>
<a href="#l26.807"></a><span id="l26.807" class="difflineminus">-    nsCOMPtr&lt;nsIMsgRuleAction&gt; action;</span>
<a href="#l26.808"></a><span id="l26.808" class="difflineminus">-    rv = filter-&gt;CreateAction(getter_AddRefs(action));</span>
<a href="#l26.809"></a><span id="l26.809" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.810"></a><span id="l26.810" class="difflineminus">-</span>
<a href="#l26.811"></a><span id="l26.811" class="difflineminus">-    rv = action-&gt;SetType(actionType);</span>
<a href="#l26.812"></a><span id="l26.812" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.813"></a><span id="l26.813" class="difflineminus">-</span>
<a href="#l26.814"></a><span id="l26.814" class="difflineminus">-    switch (actionType)</span>
<a href="#l26.815"></a><span id="l26.815" class="difflineminus">-    {</span>
<a href="#l26.816"></a><span id="l26.816" class="difflineminus">-      case nsMsgFilterAction::MoveToFolder:</span>
<a href="#l26.817"></a><span id="l26.817" class="difflineminus">-      case nsMsgFilterAction::CopyToFolder:</span>
<a href="#l26.818"></a><span id="l26.818" class="difflineminus">-        rv = action-&gt;SetTargetFolderUri(nsAutoCString(targetFolderUri));</span>
<a href="#l26.819"></a><span id="l26.819" class="difflineminus">-        break;</span>
<a href="#l26.820"></a><span id="l26.820" class="difflineminus">-</span>
<a href="#l26.821"></a><span id="l26.821" class="difflineminus">-      case nsMsgFilterAction::ChangePriority:</span>
<a href="#l26.822"></a><span id="l26.822" class="difflineminus">-        rv = action-&gt;SetPriority(priority);</span>
<a href="#l26.823"></a><span id="l26.823" class="difflineminus">-        break;</span>
<a href="#l26.824"></a><span id="l26.824" class="difflineminus">-</span>
<a href="#l26.825"></a><span id="l26.825" class="difflineminus">-      case nsMsgFilterAction::JunkScore:</span>
<a href="#l26.826"></a><span id="l26.826" class="difflineminus">-        rv = action-&gt;SetJunkScore(junkScore);</span>
<a href="#l26.827"></a><span id="l26.827" class="difflineminus">-        break;</span>
<a href="#l26.828"></a><span id="l26.828" class="difflineminus">-</span>
<a href="#l26.829"></a><span id="l26.829" class="difflineminus">-      case nsMsgFilterAction::AddTag:</span>
<a href="#l26.830"></a><span id="l26.830" class="difflineminus">-      case nsMsgFilterAction::Reply:</span>
<a href="#l26.831"></a><span id="l26.831" class="difflineminus">-      case nsMsgFilterAction::Forward:</span>
<a href="#l26.832"></a><span id="l26.832" class="difflineminus">-        rv = action-&gt;SetStrValue(nsAutoCString(strValue));</span>
<a href="#l26.833"></a><span id="l26.833" class="difflineminus">-        break;</span>
<a href="#l26.834"></a><span id="l26.834" class="difflineminus">-</span>
<a href="#l26.835"></a><span id="l26.835" class="difflineminus">-      case nsMsgFilterAction::MarkRead:</span>
<a href="#l26.836"></a><span id="l26.836" class="difflineminus">-      case nsMsgFilterAction::StopExecution:</span>
<a href="#l26.837"></a><span id="l26.837" class="difflineminus">-      case nsMsgFilterAction::DeleteFromPop3Server:</span>
<a href="#l26.838"></a><span id="l26.838" class="difflineminus">-      case nsMsgFilterAction::LeaveOnPop3Server:</span>
<a href="#l26.839"></a><span id="l26.839" class="difflineminus">-      case nsMsgFilterAction::FetchBodyFromPop3Server:</span>
<a href="#l26.840"></a><span id="l26.840" class="difflineminus">-        // No parameters for these</span>
<a href="#l26.841"></a><span id="l26.841" class="difflineminus">-        break;</span>
<a href="#l26.842"></a><span id="l26.842" class="difflineminus">-</span>
<a href="#l26.843"></a><span id="l26.843" class="difflineminus">-      case nsMsgFilterAction::Delete:</span>
<a href="#l26.844"></a><span id="l26.844" class="difflineminus">-      case nsMsgFilterAction::KillThread:</span>
<a href="#l26.845"></a><span id="l26.845" class="difflineminus">-      case nsMsgFilterAction::WatchThread:</span>
<a href="#l26.846"></a><span id="l26.846" class="difflineminus">-      case nsMsgFilterAction::MarkFlagged:</span>
<a href="#l26.847"></a><span id="l26.847" class="difflineminus">-      case nsMsgFilterAction::Label:</span>
<a href="#l26.848"></a><span id="l26.848" class="difflineminus">-      default:</span>
<a href="#l26.849"></a><span id="l26.849" class="difflineminus">-        // Something we don't handle</span>
<a href="#l26.850"></a><span id="l26.850" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l26.851"></a><span id="l26.851" class="difflineminus">-    }</span>
<a href="#l26.852"></a><span id="l26.852" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.853"></a><span id="l26.853" class="difflineminus">-</span>
<a href="#l26.854"></a><span id="l26.854" class="difflineminus">-    rv = filter-&gt;AppendAction(action);</span>
<a href="#l26.855"></a><span id="l26.855" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.856"></a><span id="l26.856" class="difflineminus">-  }</span>
<a href="#l26.857"></a><span id="l26.857" class="difflineminus">-</span>
<a href="#l26.858"></a><span id="l26.858" class="difflineminus">-  m_addedAction = true;</span>
<a href="#l26.859"></a><span id="l26.859" class="difflineminus">-</span>
<a href="#l26.860"></a><span id="l26.860" class="difflineminus">-  return rv;</span>
<a href="#l26.861"></a><span id="l26.861" class="difflineminus">-}</span>
<a href="#l26.862"></a><span id="l26.862" class="difflineminus">-</span>
<a href="#l26.863"></a><span id="l26.863" class="difflineminus">-</span>
<a href="#l26.864"></a><span id="l26.864" class="difflineminus">-nsresult nsEudoraFilters::AddMailboxAction(const char* pMailboxPath, bool isTransfer)</span>
<a href="#l26.865"></a><span id="l26.865" class="difflineminus">-{</span>
<a href="#l26.866"></a><span id="l26.866" class="difflineminus">-  nsresult rv;</span>
<a href="#l26.867"></a><span id="l26.867" class="difflineminus">-  nsCString nameHierarchy;</span>
<a href="#l26.868"></a><span id="l26.868" class="difflineminus">-#if defined(XP_WIN)</span>
<a href="#l26.869"></a><span id="l26.869" class="difflineminus">-  nsCString filePath;</span>
<a href="#l26.870"></a><span id="l26.870" class="difflineminus">-  m_pLocation-&gt;GetNativePath(filePath);</span>
<a href="#l26.871"></a><span id="l26.871" class="difflineminus">-  int32_t index = filePath.RFindChar('\\');</span>
<a href="#l26.872"></a><span id="l26.872" class="difflineminus">-  if (index &gt;= 0)</span>
<a href="#l26.873"></a><span id="l26.873" class="difflineminus">-    filePath.SetLength(index);</span>
<a href="#l26.874"></a><span id="l26.874" class="difflineminus">-  if (!nsEudoraWin32::GetMailboxNameHierarchy(filePath, pMailboxPath,</span>
<a href="#l26.875"></a><span id="l26.875" class="difflineminus">-                                              nameHierarchy))</span>
<a href="#l26.876"></a><span id="l26.876" class="difflineminus">-    return NS_ERROR_INVALID_ARG;</span>
<a href="#l26.877"></a><span id="l26.877" class="difflineminus">-#endif</span>
<a href="#l26.878"></a><span id="l26.878" class="difflineminus">-#ifdef XP_MACOSX</span>
<a href="#l26.879"></a><span id="l26.879" class="difflineminus">-  nameHierarchy = pMailboxPath;</span>
<a href="#l26.880"></a><span id="l26.880" class="difflineminus">-#endif</span>
<a href="#l26.881"></a><span id="l26.881" class="difflineminus">-</span>
<a href="#l26.882"></a><span id="l26.882" class="difflineminus">-  nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l26.883"></a><span id="l26.883" class="difflineminus">-  rv = GetMailboxFolder(nameHierarchy.get(), getter_AddRefs(folder));</span>
<a href="#l26.884"></a><span id="l26.884" class="difflineminus">-</span>
<a href="#l26.885"></a><span id="l26.885" class="difflineminus">-  nsAutoCString folderURI;</span>
<a href="#l26.886"></a><span id="l26.886" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l26.887"></a><span id="l26.887" class="difflineminus">-    rv = folder-&gt;GetURI(folderURI);</span>
<a href="#l26.888"></a><span id="l26.888" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l26.889"></a><span id="l26.889" class="difflineminus">-    return NS_ERROR_INVALID_ARG;</span>
<a href="#l26.890"></a><span id="l26.890" class="difflineminus">-</span>
<a href="#l26.891"></a><span id="l26.891" class="difflineminus">-  rv = AddAction(isTransfer? (nsMsgRuleActionType)nsMsgFilterAction::MoveToFolder : (nsMsgRuleActionType)nsMsgFilterAction::CopyToFolder, 0, 0, 0, nullptr, folderURI.get());</span>
<a href="#l26.892"></a><span id="l26.892" class="difflineminus">-</span>
<a href="#l26.893"></a><span id="l26.893" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; isTransfer)</span>
<a href="#l26.894"></a><span id="l26.894" class="difflineminus">-    m_hasTransfer = true;</span>
<a href="#l26.895"></a><span id="l26.895" class="difflineminus">-</span>
<a href="#l26.896"></a><span id="l26.896" class="difflineminus">-  return rv;</span>
<a href="#l26.897"></a><span id="l26.897" class="difflineminus">-}</span>
<a href="#l26.898"></a><span id="l26.898" class="difflineminus">-</span>
<a href="#l26.899"></a><span id="l26.899" class="difflineminus">-nsresult nsEudoraFilters::GetMailboxFolder(const char* pNameHierarchy, nsIMsgFolder** ppFolder)</span>
<a href="#l26.900"></a><span id="l26.900" class="difflineminus">-{</span>
<a href="#l26.901"></a><span id="l26.901" class="difflineminus">-  NS_ENSURE_ARG_POINTER(ppFolder);</span>
<a href="#l26.902"></a><span id="l26.902" class="difflineminus">-</span>
<a href="#l26.903"></a><span id="l26.903" class="difflineminus">-  nsCOMPtr&lt;nsIMsgFolder&gt; folder(*ppFolder ? *ppFolder : m_pMailboxesRoot.get());</span>
<a href="#l26.904"></a><span id="l26.904" class="difflineminus">-</span>
<a href="#l26.905"></a><span id="l26.905" class="difflineminus">-  // We've already grabbed the pointer on incoming, so now ensure</span>
<a href="#l26.906"></a><span id="l26.906" class="difflineminus">-  // *ppFolder is null on outgoing if there is an error</span>
<a href="#l26.907"></a><span id="l26.907" class="difflineminus">-  *ppFolder = nullptr;</span>
<a href="#l26.908"></a><span id="l26.908" class="difflineminus">-  </span>
<a href="#l26.909"></a><span id="l26.909" class="difflineminus">-  nsAutoCString name(pNameHierarchy + 1);</span>
<a href="#l26.910"></a><span id="l26.910" class="difflineminus">-  int32_t sepIndex = name.FindChar(*pNameHierarchy);</span>
<a href="#l26.911"></a><span id="l26.911" class="difflineminus">-  if (sepIndex &gt;= 0)</span>
<a href="#l26.912"></a><span id="l26.912" class="difflineminus">-    name.SetLength(sepIndex);</span>
<a href="#l26.913"></a><span id="l26.913" class="difflineminus">-</span>
<a href="#l26.914"></a><span id="l26.914" class="difflineminus">-  nsAutoString unicodeName;</span>
<a href="#l26.915"></a><span id="l26.915" class="difflineminus">-  NS_CopyNativeToUnicode(name, unicodeName);</span>
<a href="#l26.916"></a><span id="l26.916" class="difflineminus">-</span>
<a href="#l26.917"></a><span id="l26.917" class="difflineminus">-  nsCOMPtr&lt;nsIMsgFolder&gt; subFolder;</span>
<a href="#l26.918"></a><span id="l26.918" class="difflineminus">-  nsresult rv = folder-&gt;GetChildNamed(unicodeName, getter_AddRefs(subFolder));</span>
<a href="#l26.919"></a><span id="l26.919" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l26.920"></a><span id="l26.920" class="difflineminus">-  {</span>
<a href="#l26.921"></a><span id="l26.921" class="difflineminus">-    *ppFolder = subFolder;</span>
<a href="#l26.922"></a><span id="l26.922" class="difflineminus">-    if (sepIndex &gt;= 0)</span>
<a href="#l26.923"></a><span id="l26.923" class="difflineminus">-      return GetMailboxFolder(pNameHierarchy + sepIndex + 1, ppFolder);</span>
<a href="#l26.924"></a><span id="l26.924" class="difflineminus">-    NS_IF_ADDREF(*ppFolder);</span>
<a href="#l26.925"></a><span id="l26.925" class="difflineminus">-  }</span>
<a href="#l26.926"></a><span id="l26.926" class="difflineminus">-</span>
<a href="#l26.927"></a><span id="l26.927" class="difflineminus">-  return rv;</span>
<a href="#l26.928"></a><span id="l26.928" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1">deleted file mode 100644</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineminus">--- a/mailnews/import/eudora/src/nsEudoraFilters.h</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineplus">+++ /dev/null</span>
<a href="#l27.4"></a><span id="l27.4" class="difflineat">@@ -1,72 +0,0 @@</span>
<a href="#l27.5"></a><span id="l27.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l27.6"></a><span id="l27.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l27.7"></a><span id="l27.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l27.8"></a><span id="l27.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l27.9"></a><span id="l27.9" class="difflineminus">-</span>
<a href="#l27.10"></a><span id="l27.10" class="difflineminus">-#ifndef nsEudoraFilters_h___</span>
<a href="#l27.11"></a><span id="l27.11" class="difflineminus">-#define nsEudoraFilters_h___</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineminus">-#include &quot;nsIImportFilters.h&quot;</span>
<a href="#l27.14"></a><span id="l27.14" class="difflineminus">-#include &quot;nsIFile.h&quot;</span>
<a href="#l27.15"></a><span id="l27.15" class="difflineminus">-#include &quot;nsIMutableArray.h&quot;</span>
<a href="#l27.16"></a><span id="l27.16" class="difflineminus">-#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l27.17"></a><span id="l27.17" class="difflineminus">-#include &quot;nsMsgFilterCore.h&quot;</span>
<a href="#l27.18"></a><span id="l27.18" class="difflineminus">-</span>
<a href="#l27.19"></a><span id="l27.19" class="difflineminus">-class nsIMsgFolder;</span>
<a href="#l27.20"></a><span id="l27.20" class="difflineminus">-</span>
<a href="#l27.21"></a><span id="l27.21" class="difflineminus">-class nsEudoraFilters : public nsIImportFilters {</span>
<a href="#l27.22"></a><span id="l27.22" class="difflineminus">-public:</span>
<a href="#l27.23"></a><span id="l27.23" class="difflineminus">-  nsEudoraFilters();</span>
<a href="#l27.24"></a><span id="l27.24" class="difflineminus">-</span>
<a href="#l27.25"></a><span id="l27.25" class="difflineminus">-  static nsresult Create(nsIImportFilters** aImport);</span>
<a href="#l27.26"></a><span id="l27.26" class="difflineminus">-</span>
<a href="#l27.27"></a><span id="l27.27" class="difflineminus">-  // nsISupports interface</span>
<a href="#l27.28"></a><span id="l27.28" class="difflineminus">-  NS_DECL_ISUPPORTS</span>
<a href="#l27.29"></a><span id="l27.29" class="difflineminus">-</span>
<a href="#l27.30"></a><span id="l27.30" class="difflineminus">-  // nsIImportFilters interface</span>
<a href="#l27.31"></a><span id="l27.31" class="difflineminus">-  NS_DECL_NSIIMPORTFILTERS</span>
<a href="#l27.32"></a><span id="l27.32" class="difflineminus">-</span>
<a href="#l27.33"></a><span id="l27.33" class="difflineminus">-private:</span>
<a href="#l27.34"></a><span id="l27.34" class="difflineminus">-  virtual ~nsEudoraFilters();</span>
<a href="#l27.35"></a><span id="l27.35" class="difflineminus">-  nsCOMPtr&lt;nsIFile&gt; m_pLocation;</span>
<a href="#l27.36"></a><span id="l27.36" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; m_pServerArray;</span>
<a href="#l27.37"></a><span id="l27.37" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; m_pFilterArray;</span>
<a href="#l27.38"></a><span id="l27.38" class="difflineminus">-  nsCOMPtr&lt;nsIMsgFolder&gt; m_pMailboxesRoot;</span>
<a href="#l27.39"></a><span id="l27.39" class="difflineminus">-</span>
<a href="#l27.40"></a><span id="l27.40" class="difflineminus">-  nsString m_errorLog;</span>
<a href="#l27.41"></a><span id="l27.41" class="difflineminus">-</span>
<a href="#l27.42"></a><span id="l27.42" class="difflineminus">-  bool m_isAnd;</span>
<a href="#l27.43"></a><span id="l27.43" class="difflineminus">-  bool m_isUnless;</span>
<a href="#l27.44"></a><span id="l27.44" class="difflineminus">-  bool m_ignoreTerm;</span>
<a href="#l27.45"></a><span id="l27.45" class="difflineminus">-  bool m_isIncoming;</span>
<a href="#l27.46"></a><span id="l27.46" class="difflineminus">-  bool m_addedAction;</span>
<a href="#l27.47"></a><span id="l27.47" class="difflineminus">-  bool m_hasTransfer;</span>
<a href="#l27.48"></a><span id="l27.48" class="difflineminus">-  bool m_hasStop;</span>
<a href="#l27.49"></a><span id="l27.49" class="difflineminus">-  bool m_termNotGroked;</span>
<a href="#l27.50"></a><span id="l27.50" class="difflineminus">-</span>
<a href="#l27.51"></a><span id="l27.51" class="difflineminus">-  bool RealImport();</span>
<a href="#l27.52"></a><span id="l27.52" class="difflineminus">-  nsresult Init();</span>
<a href="#l27.53"></a><span id="l27.53" class="difflineminus">-  nsresult LoadServers();</span>
<a href="#l27.54"></a><span id="l27.54" class="difflineminus">-  nsresult SaveFilters();</span>
<a href="#l27.55"></a><span id="l27.55" class="difflineminus">-  nsresult CreateNewFilter(const char* pName);</span>
<a href="#l27.56"></a><span id="l27.56" class="difflineminus">-  nsresult FinalizeFilter();</span>
<a href="#l27.57"></a><span id="l27.57" class="difflineminus">-  nsresult EnableFilter(bool enable);</span>
<a href="#l27.58"></a><span id="l27.58" class="difflineminus">-  nsresult AddTerm(const char* pHeader, const char* pVerb, const char* pValue, bool addAnd, bool negateVerb);</span>
<a href="#l27.59"></a><span id="l27.59" class="difflineminus">-</span>
<a href="#l27.60"></a><span id="l27.60" class="difflineminus">-  nsresult AddAction(nsMsgRuleActionType actionType, int32_t junkScore = 0, nsMsgLabelValue label = 0,</span>
<a href="#l27.61"></a><span id="l27.61" class="difflineminus">-                     nsMsgPriorityValue priority = 0, const char* strValue = nullptr, const char* targetFolderUri = nullptr);</span>
<a href="#l27.62"></a><span id="l27.62" class="difflineminus">-  nsresult AddJunkAction(int32_t junkScore)</span>
<a href="#l27.63"></a><span id="l27.63" class="difflineminus">-           { return AddAction(nsMsgFilterAction::JunkScore, junkScore); }</span>
<a href="#l27.64"></a><span id="l27.64" class="difflineminus">-  nsresult AddLabelAction(nsMsgLabelValue label)</span>
<a href="#l27.65"></a><span id="l27.65" class="difflineminus">-           { return AddAction(nsMsgFilterAction::Label, 0, label); }</span>
<a href="#l27.66"></a><span id="l27.66" class="difflineminus">-  nsresult AddPriorityAction(nsMsgPriorityValue priority)</span>
<a href="#l27.67"></a><span id="l27.67" class="difflineminus">-           { return AddAction(nsMsgFilterAction::ChangePriority, 0, 0, priority); }</span>
<a href="#l27.68"></a><span id="l27.68" class="difflineminus">-  nsresult AddStringAction(nsMsgRuleActionType actionType, const char* strValue)</span>
<a href="#l27.69"></a><span id="l27.69" class="difflineminus">-           { return AddAction(actionType, 0, 0, 0, strValue); }</span>
<a href="#l27.70"></a><span id="l27.70" class="difflineminus">-  nsresult AddMailboxAction(const char* pMailboxPath, bool isTransfer);</span>
<a href="#l27.71"></a><span id="l27.71" class="difflineminus">-</span>
<a href="#l27.72"></a><span id="l27.72" class="difflineminus">-  nsresult GetMailboxFolder(const char* pNameHierarchy, nsIMsgFolder** ppFolder);</span>
<a href="#l27.73"></a><span id="l27.73" class="difflineminus">-};</span>
<a href="#l27.74"></a><span id="l27.74" class="difflineminus">-</span>
<a href="#l27.75"></a><span id="l27.75" class="difflineminus">-#endif /* nsEudoraFilters_h___ */</span>
<a href="#l27.76"></a><span id="l27.76" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1">deleted file mode 100644</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineminus">--- a/mailnews/import/eudora/src/nsEudoraImport.cpp</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineplus">+++ /dev/null</span>
<a href="#l28.4"></a><span id="l28.4" class="difflineat">@@ -1,765 +0,0 @@</span>
<a href="#l28.5"></a><span id="l28.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l28.6"></a><span id="l28.6" class="difflineminus">- *</span>
<a href="#l28.7"></a><span id="l28.7" class="difflineminus">- * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l28.8"></a><span id="l28.8" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l28.9"></a><span id="l28.9" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l28.10"></a><span id="l28.10" class="difflineminus">-</span>
<a href="#l28.11"></a><span id="l28.11" class="difflineminus">-</span>
<a href="#l28.12"></a><span id="l28.12" class="difflineminus">-/*</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineminus">-</span>
<a href="#l28.14"></a><span id="l28.14" class="difflineminus">-  Eudora import mail and addressbook interfaces</span>
<a href="#l28.15"></a><span id="l28.15" class="difflineminus">-</span>
<a href="#l28.16"></a><span id="l28.16" class="difflineminus">-*/</span>
<a href="#l28.17"></a><span id="l28.17" class="difflineminus">-#include &quot;nscore.h&quot;</span>
<a href="#l28.18"></a><span id="l28.18" class="difflineminus">-#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l28.19"></a><span id="l28.19" class="difflineminus">-#include &quot;nsStringGlue.h&quot;</span>
<a href="#l28.20"></a><span id="l28.20" class="difflineminus">-#include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l28.21"></a><span id="l28.21" class="difflineminus">-#include &quot;nsIImportService.h&quot;</span>
<a href="#l28.22"></a><span id="l28.22" class="difflineminus">-#include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l28.23"></a><span id="l28.23" class="difflineminus">-#include &quot;nsEudoraImport.h&quot;</span>
<a href="#l28.24"></a><span id="l28.24" class="difflineminus">-#include &quot;nsIMemory.h&quot;</span>
<a href="#l28.25"></a><span id="l28.25" class="difflineminus">-#include &quot;nsIMutableArray.h&quot;</span>
<a href="#l28.26"></a><span id="l28.26" class="difflineminus">-#include &quot;nsIImportService.h&quot;</span>
<a href="#l28.27"></a><span id="l28.27" class="difflineminus">-#include &quot;nsIImportMail.h&quot;</span>
<a href="#l28.28"></a><span id="l28.28" class="difflineminus">-#include &quot;nsIImportMailboxDescriptor.h&quot;</span>
<a href="#l28.29"></a><span id="l28.29" class="difflineminus">-#include &quot;nsIImportGeneric.h&quot;</span>
<a href="#l28.30"></a><span id="l28.30" class="difflineminus">-#include &quot;nsIImportAddressBooks.h&quot;</span>
<a href="#l28.31"></a><span id="l28.31" class="difflineminus">-#include &quot;nsIImportABDescriptor.h&quot;</span>
<a href="#l28.32"></a><span id="l28.32" class="difflineminus">-#include &quot;nsIImportSettings.h&quot;</span>
<a href="#l28.33"></a><span id="l28.33" class="difflineminus">-#include &quot;nsIImportFilters.h&quot;</span>
<a href="#l28.34"></a><span id="l28.34" class="difflineminus">-#include &quot;nsIImportFieldMap.h&quot;</span>
<a href="#l28.35"></a><span id="l28.35" class="difflineminus">-#include &quot;nsXPCOM.h&quot;</span>
<a href="#l28.36"></a><span id="l28.36" class="difflineminus">-#include &quot;nsISupportsPrimitives.h&quot;</span>
<a href="#l28.37"></a><span id="l28.37" class="difflineminus">-#include &quot;nsIOutputStream.h&quot;</span>
<a href="#l28.38"></a><span id="l28.38" class="difflineminus">-#include &quot;nsIAddrDatabase.h&quot;</span>
<a href="#l28.39"></a><span id="l28.39" class="difflineminus">-#include &quot;nsTextFormatter.h&quot;</span>
<a href="#l28.40"></a><span id="l28.40" class="difflineminus">-#include &quot;nsEudoraStringBundle.h&quot;</span>
<a href="#l28.41"></a><span id="l28.41" class="difflineminus">-#include &quot;nsIStringBundle.h&quot;</span>
<a href="#l28.42"></a><span id="l28.42" class="difflineminus">-#include &quot;nsEudoraCompose.h&quot;</span>
<a href="#l28.43"></a><span id="l28.43" class="difflineminus">-#include &quot;nsEudoraSettings.h&quot;</span>
<a href="#l28.44"></a><span id="l28.44" class="difflineminus">-#include &quot;nsEudoraFilters.h&quot;</span>
<a href="#l28.45"></a><span id="l28.45" class="difflineminus">-#include &quot;nsUnicharUtils.h&quot;</span>
<a href="#l28.46"></a><span id="l28.46" class="difflineminus">-#include &quot;nsIMsgTagService.h&quot;</span>
<a href="#l28.47"></a><span id="l28.47" class="difflineminus">-#include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l28.48"></a><span id="l28.48" class="difflineminus">-</span>
<a href="#l28.49"></a><span id="l28.49" class="difflineminus">-</span>
<a href="#l28.50"></a><span id="l28.50" class="difflineminus">-#if defined(XP_WIN)</span>
<a href="#l28.51"></a><span id="l28.51" class="difflineminus">-#include &quot;nsEudoraWin32.h&quot;</span>
<a href="#l28.52"></a><span id="l28.52" class="difflineminus">-#endif</span>
<a href="#l28.53"></a><span id="l28.53" class="difflineminus">-#ifdef XP_MACOSX</span>
<a href="#l28.54"></a><span id="l28.54" class="difflineminus">-#include &quot;nsEudoraMac.h&quot;</span>
<a href="#l28.55"></a><span id="l28.55" class="difflineminus">-#endif</span>
<a href="#l28.56"></a><span id="l28.56" class="difflineminus">-</span>
<a href="#l28.57"></a><span id="l28.57" class="difflineminus">-#include &quot;EudoraDebugLog.h&quot;</span>
<a href="#l28.58"></a><span id="l28.58" class="difflineminus">-</span>
<a href="#l28.59"></a><span id="l28.59" class="difflineminus">-static NS_DEFINE_IID(kISupportsIID,      NS_ISUPPORTS_IID);</span>
<a href="#l28.60"></a><span id="l28.60" class="difflineminus">-PRLogModuleInfo *EUDORALOGMODULE = nullptr;</span>
<a href="#l28.61"></a><span id="l28.61" class="difflineminus">-</span>
<a href="#l28.62"></a><span id="l28.62" class="difflineminus">-class ImportEudoraMailImpl : public nsIImportMail</span>
<a href="#l28.63"></a><span id="l28.63" class="difflineminus">-{</span>
<a href="#l28.64"></a><span id="l28.64" class="difflineminus">-public:</span>
<a href="#l28.65"></a><span id="l28.65" class="difflineminus">-  ImportEudoraMailImpl();</span>
<a href="#l28.66"></a><span id="l28.66" class="difflineminus">-</span>
<a href="#l28.67"></a><span id="l28.67" class="difflineminus">-  static nsresult Create(nsIImportMail** aImport);</span>
<a href="#l28.68"></a><span id="l28.68" class="difflineminus">-</span>
<a href="#l28.69"></a><span id="l28.69" class="difflineminus">-  // nsISupports interface</span>
<a href="#l28.70"></a><span id="l28.70" class="difflineminus">-  NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l28.71"></a><span id="l28.71" class="difflineminus">-</span>
<a href="#l28.72"></a><span id="l28.72" class="difflineminus">-  // nsIImportmail interface</span>
<a href="#l28.73"></a><span id="l28.73" class="difflineminus">-</span>
<a href="#l28.74"></a><span id="l28.74" class="difflineminus">-  /* void GetDefaultLocation (out nsIFile location, out boolean found, out boolean userVerify); */</span>
<a href="#l28.75"></a><span id="l28.75" class="difflineminus">-  NS_IMETHOD GetDefaultLocation(nsIFile **location, bool *found, bool *userVerify);</span>
<a href="#l28.76"></a><span id="l28.76" class="difflineminus">-</span>
<a href="#l28.77"></a><span id="l28.77" class="difflineminus">-  /* nsIArray FindMailboxes (in nsIFile location); */</span>
<a href="#l28.78"></a><span id="l28.78" class="difflineminus">-  NS_IMETHOD FindMailboxes(nsIFile *location, nsIArray **_retval);</span>
<a href="#l28.79"></a><span id="l28.79" class="difflineminus">-</span>
<a href="#l28.80"></a><span id="l28.80" class="difflineminus">-  NS_IMETHOD ImportMailbox(nsIImportMailboxDescriptor *source,</span>
<a href="#l28.81"></a><span id="l28.81" class="difflineminus">-                           nsIMsgFolder *dstFolder,</span>
<a href="#l28.82"></a><span id="l28.82" class="difflineminus">-                           char16_t **pErrorLog, char16_t **pSuccessLog,</span>
<a href="#l28.83"></a><span id="l28.83" class="difflineminus">-                           bool *fatalError);</span>
<a href="#l28.84"></a><span id="l28.84" class="difflineminus">-</span>
<a href="#l28.85"></a><span id="l28.85" class="difflineminus">-  /* unsigned long GetImportProgress (); */</span>
<a href="#l28.86"></a><span id="l28.86" class="difflineminus">-  NS_IMETHOD GetImportProgress(uint32_t *_retval);</span>
<a href="#l28.87"></a><span id="l28.87" class="difflineminus">-</span>
<a href="#l28.88"></a><span id="l28.88" class="difflineminus">-  NS_IMETHOD TranslateFolderName(const nsAString &amp; aFolderName, nsAString &amp; _retval);</span>
<a href="#l28.89"></a><span id="l28.89" class="difflineminus">-</span>
<a href="#l28.90"></a><span id="l28.90" class="difflineminus">-public:</span>
<a href="#l28.91"></a><span id="l28.91" class="difflineminus">-  static void  AddLinebreak(nsString *pStream);</span>
<a href="#l28.92"></a><span id="l28.92" class="difflineminus">-  static void  SetLogs(nsString&amp; success, nsString&amp; error, char16_t **pError, char16_t **pSuccess);</span>
<a href="#l28.93"></a><span id="l28.93" class="difflineminus">-  static void ReportError(int32_t errorNum, nsString&amp; name, nsString *pStream);</span>
<a href="#l28.94"></a><span id="l28.94" class="difflineminus">-</span>
<a href="#l28.95"></a><span id="l28.95" class="difflineminus">-</span>
<a href="#l28.96"></a><span id="l28.96" class="difflineminus">-private:</span>
<a href="#l28.97"></a><span id="l28.97" class="difflineminus">-  virtual ~ImportEudoraMailImpl();</span>
<a href="#l28.98"></a><span id="l28.98" class="difflineminus">-  static void  ReportSuccess(nsString&amp; name, int32_t count, nsString *pStream);</span>
<a href="#l28.99"></a><span id="l28.99" class="difflineminus">-</span>
<a href="#l28.100"></a><span id="l28.100" class="difflineminus">-private:</span>
<a href="#l28.101"></a><span id="l28.101" class="difflineminus">-#if defined(XP_WIN)</span>
<a href="#l28.102"></a><span id="l28.102" class="difflineminus">-  nsEudoraWin32  m_eudora;</span>
<a href="#l28.103"></a><span id="l28.103" class="difflineminus">-#endif</span>
<a href="#l28.104"></a><span id="l28.104" class="difflineminus">-#ifdef XP_MACOSX</span>
<a href="#l28.105"></a><span id="l28.105" class="difflineminus">-  nsEudoraMac    m_eudora;</span>
<a href="#l28.106"></a><span id="l28.106" class="difflineminus">-#endif</span>
<a href="#l28.107"></a><span id="l28.107" class="difflineminus">-  uint32_t    m_bytes;</span>
<a href="#l28.108"></a><span id="l28.108" class="difflineminus">-};</span>
<a href="#l28.109"></a><span id="l28.109" class="difflineminus">-</span>
<a href="#l28.110"></a><span id="l28.110" class="difflineminus">-</span>
<a href="#l28.111"></a><span id="l28.111" class="difflineminus">-class ImportEudoraAddressImpl : public nsIImportAddressBooks</span>
<a href="#l28.112"></a><span id="l28.112" class="difflineminus">-{</span>
<a href="#l28.113"></a><span id="l28.113" class="difflineminus">-public:</span>
<a href="#l28.114"></a><span id="l28.114" class="difflineminus">-  ImportEudoraAddressImpl();</span>
<a href="#l28.115"></a><span id="l28.115" class="difflineminus">-</span>
<a href="#l28.116"></a><span id="l28.116" class="difflineminus">-  static nsresult Create(nsIImportAddressBooks** aImport);</span>
<a href="#l28.117"></a><span id="l28.117" class="difflineminus">-</span>
<a href="#l28.118"></a><span id="l28.118" class="difflineminus">-  // nsISupports interface</span>
<a href="#l28.119"></a><span id="l28.119" class="difflineminus">-  NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l28.120"></a><span id="l28.120" class="difflineminus">-</span>
<a href="#l28.121"></a><span id="l28.121" class="difflineminus">-  // nsIImportAddressBooks interface</span>
<a href="#l28.122"></a><span id="l28.122" class="difflineminus">-</span>
<a href="#l28.123"></a><span id="l28.123" class="difflineminus">-  NS_IMETHOD GetSupportsMultiple(bool *_retval) { *_retval = true; return NS_OK;}</span>
<a href="#l28.124"></a><span id="l28.124" class="difflineminus">-</span>
<a href="#l28.125"></a><span id="l28.125" class="difflineminus">-  NS_IMETHOD GetAutoFind(char16_t **description, bool *_retval);</span>
<a href="#l28.126"></a><span id="l28.126" class="difflineminus">-</span>
<a href="#l28.127"></a><span id="l28.127" class="difflineminus">-  NS_IMETHOD GetNeedsFieldMap(nsIFile *location, bool *_retval) { *_retval = false; return NS_OK;}</span>
<a href="#l28.128"></a><span id="l28.128" class="difflineminus">-</span>
<a href="#l28.129"></a><span id="l28.129" class="difflineminus">-  NS_IMETHOD GetDefaultLocation(nsIFile **location, bool *found, bool *userVerify);</span>
<a href="#l28.130"></a><span id="l28.130" class="difflineminus">-</span>
<a href="#l28.131"></a><span id="l28.131" class="difflineminus">-  NS_IMETHOD FindAddressBooks(nsIFile *location, nsIArray **_retval);</span>
<a href="#l28.132"></a><span id="l28.132" class="difflineminus">-</span>
<a href="#l28.133"></a><span id="l28.133" class="difflineminus">-  NS_IMETHOD InitFieldMap(nsIImportFieldMap *fieldMap)</span>
<a href="#l28.134"></a><span id="l28.134" class="difflineminus">-    { return NS_ERROR_FAILURE; }</span>
<a href="#l28.135"></a><span id="l28.135" class="difflineminus">-</span>
<a href="#l28.136"></a><span id="l28.136" class="difflineminus">-  NS_IMETHOD ImportAddressBook(nsIImportABDescriptor *source,</span>
<a href="#l28.137"></a><span id="l28.137" class="difflineminus">-                               nsIAddrDatabase *destination,</span>
<a href="#l28.138"></a><span id="l28.138" class="difflineminus">-                               nsIImportFieldMap *fieldMap,</span>
<a href="#l28.139"></a><span id="l28.139" class="difflineminus">-                               nsISupports *aSupportService,</span>
<a href="#l28.140"></a><span id="l28.140" class="difflineminus">-                               char16_t **errorLog,</span>
<a href="#l28.141"></a><span id="l28.141" class="difflineminus">-                               char16_t **successLog,</span>
<a href="#l28.142"></a><span id="l28.142" class="difflineminus">-                               bool *fatalError);</span>
<a href="#l28.143"></a><span id="l28.143" class="difflineminus">-</span>
<a href="#l28.144"></a><span id="l28.144" class="difflineminus">-  NS_IMETHOD GetImportProgress(uint32_t *_retval);</span>
<a href="#l28.145"></a><span id="l28.145" class="difflineminus">-</span>
<a href="#l28.146"></a><span id="l28.146" class="difflineminus">-  NS_IMETHOD GetSampleData(int32_t index, bool *pFound, char16_t **pStr)</span>
<a href="#l28.147"></a><span id="l28.147" class="difflineminus">-    { return NS_ERROR_FAILURE;}</span>
<a href="#l28.148"></a><span id="l28.148" class="difflineminus">-</span>
<a href="#l28.149"></a><span id="l28.149" class="difflineminus">-  NS_IMETHOD SetSampleLocation(nsIFile *) { return NS_OK; }</span>
<a href="#l28.150"></a><span id="l28.150" class="difflineminus">-</span>
<a href="#l28.151"></a><span id="l28.151" class="difflineminus">-private:</span>
<a href="#l28.152"></a><span id="l28.152" class="difflineminus">-  virtual ~ImportEudoraAddressImpl();</span>
<a href="#l28.153"></a><span id="l28.153" class="difflineminus">-  static void  ReportSuccess(nsString&amp; name, nsString *pStream);</span>
<a href="#l28.154"></a><span id="l28.154" class="difflineminus">-</span>
<a href="#l28.155"></a><span id="l28.155" class="difflineminus">-private:</span>
<a href="#l28.156"></a><span id="l28.156" class="difflineminus">-#if defined(XP_WIN)</span>
<a href="#l28.157"></a><span id="l28.157" class="difflineminus">-  nsEudoraWin32  m_eudora;</span>
<a href="#l28.158"></a><span id="l28.158" class="difflineminus">-#endif</span>
<a href="#l28.159"></a><span id="l28.159" class="difflineminus">-#ifdef XP_MACOSX</span>
<a href="#l28.160"></a><span id="l28.160" class="difflineminus">-  nsEudoraMac    m_eudora;</span>
<a href="#l28.161"></a><span id="l28.161" class="difflineminus">-#endif</span>
<a href="#l28.162"></a><span id="l28.162" class="difflineminus">-  uint32_t    m_bytes;</span>
<a href="#l28.163"></a><span id="l28.163" class="difflineminus">-};</span>
<a href="#l28.164"></a><span id="l28.164" class="difflineminus">-</span>
<a href="#l28.165"></a><span id="l28.165" class="difflineminus">-////////////////////////////////////////////////////////////////////////</span>
<a href="#l28.166"></a><span id="l28.166" class="difflineminus">-////////////////////////////////////////////////////////////////////////</span>
<a href="#l28.167"></a><span id="l28.167" class="difflineminus">-</span>
<a href="#l28.168"></a><span id="l28.168" class="difflineminus">-</span>
<a href="#l28.169"></a><span id="l28.169" class="difflineminus">-nsEudoraImport::nsEudoraImport()</span>
<a href="#l28.170"></a><span id="l28.170" class="difflineminus">-{</span>
<a href="#l28.171"></a><span id="l28.171" class="difflineminus">-  // Init logging module.</span>
<a href="#l28.172"></a><span id="l28.172" class="difflineminus">-  if (!EUDORALOGMODULE)</span>
<a href="#l28.173"></a><span id="l28.173" class="difflineminus">-    EUDORALOGMODULE = PR_NewLogModule(&quot;IMPORT&quot;);</span>
<a href="#l28.174"></a><span id="l28.174" class="difflineminus">-  IMPORT_LOG0(&quot;nsEudoraImport Module Created\n&quot;);</span>
<a href="#l28.175"></a><span id="l28.175" class="difflineminus">-</span>
<a href="#l28.176"></a><span id="l28.176" class="difflineminus">-  nsEudoraStringBundle::GetStringBundle();</span>
<a href="#l28.177"></a><span id="l28.177" class="difflineminus">-}</span>
<a href="#l28.178"></a><span id="l28.178" class="difflineminus">-</span>
<a href="#l28.179"></a><span id="l28.179" class="difflineminus">-</span>
<a href="#l28.180"></a><span id="l28.180" class="difflineminus">-nsEudoraImport::~nsEudoraImport()</span>
<a href="#l28.181"></a><span id="l28.181" class="difflineminus">-{</span>
<a href="#l28.182"></a><span id="l28.182" class="difflineminus">-  IMPORT_LOG0(&quot;nsEudoraImport Module Deleted\n&quot;);</span>
<a href="#l28.183"></a><span id="l28.183" class="difflineminus">-}</span>
<a href="#l28.184"></a><span id="l28.184" class="difflineminus">-</span>
<a href="#l28.185"></a><span id="l28.185" class="difflineminus">-</span>
<a href="#l28.186"></a><span id="l28.186" class="difflineminus">-</span>
<a href="#l28.187"></a><span id="l28.187" class="difflineminus">-NS_IMPL_ISUPPORTS(nsEudoraImport, nsIImportModule)</span>
<a href="#l28.188"></a><span id="l28.188" class="difflineminus">-</span>
<a href="#l28.189"></a><span id="l28.189" class="difflineminus">-</span>
<a href="#l28.190"></a><span id="l28.190" class="difflineminus">-NS_IMETHODIMP nsEudoraImport::GetName(char16_t **name)</span>
<a href="#l28.191"></a><span id="l28.191" class="difflineminus">-{</span>
<a href="#l28.192"></a><span id="l28.192" class="difflineminus">-  NS_PRECONDITION(name != nullptr, &quot;null ptr&quot;);</span>
<a href="#l28.193"></a><span id="l28.193" class="difflineminus">-  if (! name)</span>
<a href="#l28.194"></a><span id="l28.194" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l28.195"></a><span id="l28.195" class="difflineminus">-</span>
<a href="#l28.196"></a><span id="l28.196" class="difflineminus">-  *name = nsEudoraStringBundle::GetStringByID(EUDORAIMPORT_NAME);</span>
<a href="#l28.197"></a><span id="l28.197" class="difflineminus">-</span>
<a href="#l28.198"></a><span id="l28.198" class="difflineminus">-  return NS_OK;</span>
<a href="#l28.199"></a><span id="l28.199" class="difflineminus">-}</span>
<a href="#l28.200"></a><span id="l28.200" class="difflineminus">-</span>
<a href="#l28.201"></a><span id="l28.201" class="difflineminus">-NS_IMETHODIMP nsEudoraImport::GetDescription(char16_t **name)</span>
<a href="#l28.202"></a><span id="l28.202" class="difflineminus">-{</span>
<a href="#l28.203"></a><span id="l28.203" class="difflineminus">-  NS_PRECONDITION(name != nullptr, &quot;null ptr&quot;);</span>
<a href="#l28.204"></a><span id="l28.204" class="difflineminus">-  if (! name)</span>
<a href="#l28.205"></a><span id="l28.205" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l28.206"></a><span id="l28.206" class="difflineminus">-</span>
<a href="#l28.207"></a><span id="l28.207" class="difflineminus">-  *name = nsEudoraStringBundle::GetStringByID(EUDORAIMPORT_DESCRIPTION);</span>
<a href="#l28.208"></a><span id="l28.208" class="difflineminus">-</span>
<a href="#l28.209"></a><span id="l28.209" class="difflineminus">-  return NS_OK;</span>
<a href="#l28.210"></a><span id="l28.210" class="difflineminus">-}</span>
<a href="#l28.211"></a><span id="l28.211" class="difflineminus">-</span>
<a href="#l28.212"></a><span id="l28.212" class="difflineminus">-NS_IMETHODIMP nsEudoraImport::GetSupports(char **supports)</span>
<a href="#l28.213"></a><span id="l28.213" class="difflineminus">-{</span>
<a href="#l28.214"></a><span id="l28.214" class="difflineminus">-  NS_PRECONDITION(supports != nullptr, &quot;null ptr&quot;);</span>
<a href="#l28.215"></a><span id="l28.215" class="difflineminus">-  if (! supports)</span>
<a href="#l28.216"></a><span id="l28.216" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l28.217"></a><span id="l28.217" class="difflineminus">-</span>
<a href="#l28.218"></a><span id="l28.218" class="difflineminus">-  *supports = strdup(kEudoraSupportsString);</span>
<a href="#l28.219"></a><span id="l28.219" class="difflineminus">-  return NS_OK;</span>
<a href="#l28.220"></a><span id="l28.220" class="difflineminus">-}</span>
<a href="#l28.221"></a><span id="l28.221" class="difflineminus">-</span>
<a href="#l28.222"></a><span id="l28.222" class="difflineminus">-NS_IMETHODIMP nsEudoraImport::GetSupportsUpgrade(bool *pUpgrade)</span>
<a href="#l28.223"></a><span id="l28.223" class="difflineminus">-{</span>
<a href="#l28.224"></a><span id="l28.224" class="difflineminus">-  NS_PRECONDITION(pUpgrade != nullptr, &quot;null ptr&quot;);</span>
<a href="#l28.225"></a><span id="l28.225" class="difflineminus">-  if (! pUpgrade)</span>
<a href="#l28.226"></a><span id="l28.226" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l28.227"></a><span id="l28.227" class="difflineminus">-</span>
<a href="#l28.228"></a><span id="l28.228" class="difflineminus">-  *pUpgrade = true;</span>
<a href="#l28.229"></a><span id="l28.229" class="difflineminus">-  return NS_OK;</span>
<a href="#l28.230"></a><span id="l28.230" class="difflineminus">-}</span>
<a href="#l28.231"></a><span id="l28.231" class="difflineminus">-</span>
<a href="#l28.232"></a><span id="l28.232" class="difflineminus">-</span>
<a href="#l28.233"></a><span id="l28.233" class="difflineminus">-NS_IMETHODIMP nsEudoraImport::GetImportInterface(const char *pImportType, nsISupports **ppInterface)</span>
<a href="#l28.234"></a><span id="l28.234" class="difflineminus">-{</span>
<a href="#l28.235"></a><span id="l28.235" class="difflineminus">-  NS_PRECONDITION(pImportType != nullptr, &quot;null ptr&quot;);</span>
<a href="#l28.236"></a><span id="l28.236" class="difflineminus">-  if (! pImportType)</span>
<a href="#l28.237"></a><span id="l28.237" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l28.238"></a><span id="l28.238" class="difflineminus">-  NS_PRECONDITION(ppInterface != nullptr, &quot;null ptr&quot;);</span>
<a href="#l28.239"></a><span id="l28.239" class="difflineminus">-  if (! ppInterface)</span>
<a href="#l28.240"></a><span id="l28.240" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l28.241"></a><span id="l28.241" class="difflineminus">-</span>
<a href="#l28.242"></a><span id="l28.242" class="difflineminus">-  *ppInterface = nullptr;</span>
<a href="#l28.243"></a><span id="l28.243" class="difflineminus">-  nsresult  rv;</span>
<a href="#l28.244"></a><span id="l28.244" class="difflineminus">-  if (!strcmp(pImportType, &quot;mail&quot;))</span>
<a href="#l28.245"></a><span id="l28.245" class="difflineminus">-  {</span>
<a href="#l28.246"></a><span id="l28.246" class="difflineminus">-    // create the nsIImportMail interface and return it!</span>
<a href="#l28.247"></a><span id="l28.247" class="difflineminus">-    nsIImportMail *  pMail = nullptr;</span>
<a href="#l28.248"></a><span id="l28.248" class="difflineminus">-    nsIImportGeneric *pGeneric = nullptr;</span>
<a href="#l28.249"></a><span id="l28.249" class="difflineminus">-    rv = ImportEudoraMailImpl::Create(&amp;pMail);</span>
<a href="#l28.250"></a><span id="l28.250" class="difflineminus">-    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l28.251"></a><span id="l28.251" class="difflineminus">-      nsCOMPtr&lt;nsIImportService&gt; impSvc(do_GetService(NS_IMPORTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l28.252"></a><span id="l28.252" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l28.253"></a><span id="l28.253" class="difflineminus">-      {</span>
<a href="#l28.254"></a><span id="l28.254" class="difflineminus">-        rv = impSvc-&gt;CreateNewGenericMail(&amp;pGeneric);</span>
<a href="#l28.255"></a><span id="l28.255" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l28.256"></a><span id="l28.256" class="difflineminus">-        {</span>
<a href="#l28.257"></a><span id="l28.257" class="difflineminus">-          pGeneric-&gt;SetData(&quot;mailInterface&quot;, pMail);</span>
<a href="#l28.258"></a><span id="l28.258" class="difflineminus">-          nsString name;</span>
<a href="#l28.259"></a><span id="l28.259" class="difflineminus">-          nsEudoraStringBundle::GetStringByID(EUDORAIMPORT_NAME, name);</span>
<a href="#l28.260"></a><span id="l28.260" class="difflineminus">-          nsCOMPtr&lt;nsISupportsString&gt; nameString (do_CreateInstance(NS_SUPPORTS_STRING_CONTRACTID, &amp;rv));</span>
<a href="#l28.261"></a><span id="l28.261" class="difflineminus">-          if (NS_SUCCEEDED(rv))</span>
<a href="#l28.262"></a><span id="l28.262" class="difflineminus">-          {</span>
<a href="#l28.263"></a><span id="l28.263" class="difflineminus">-            nameString-&gt;SetData(name);</span>
<a href="#l28.264"></a><span id="l28.264" class="difflineminus">-            pGeneric-&gt;SetData(&quot;name&quot;, nameString);</span>
<a href="#l28.265"></a><span id="l28.265" class="difflineminus">-            rv = pGeneric-&gt;QueryInterface(kISupportsIID, (void **)ppInterface);</span>
<a href="#l28.266"></a><span id="l28.266" class="difflineminus">-          }</span>
<a href="#l28.267"></a><span id="l28.267" class="difflineminus">-        }</span>
<a href="#l28.268"></a><span id="l28.268" class="difflineminus">-      }</span>
<a href="#l28.269"></a><span id="l28.269" class="difflineminus">-    }</span>
<a href="#l28.270"></a><span id="l28.270" class="difflineminus">-    NS_IF_RELEASE(pMail);</span>
<a href="#l28.271"></a><span id="l28.271" class="difflineminus">-    NS_IF_RELEASE(pGeneric);</span>
<a href="#l28.272"></a><span id="l28.272" class="difflineminus">-    return rv;</span>
<a href="#l28.273"></a><span id="l28.273" class="difflineminus">-  }</span>
<a href="#l28.274"></a><span id="l28.274" class="difflineminus">-</span>
<a href="#l28.275"></a><span id="l28.275" class="difflineminus">-  if (!strcmp(pImportType, &quot;addressbook&quot;))</span>
<a href="#l28.276"></a><span id="l28.276" class="difflineminus">-  {</span>
<a href="#l28.277"></a><span id="l28.277" class="difflineminus">-    // create the nsIImportMail interface and return it!</span>
<a href="#l28.278"></a><span id="l28.278" class="difflineminus">-    nsIImportAddressBooks *  pAddress = nullptr;</span>
<a href="#l28.279"></a><span id="l28.279" class="difflineminus">-    nsIImportGeneric *    pGeneric = nullptr;</span>
<a href="#l28.280"></a><span id="l28.280" class="difflineminus">-    rv = ImportEudoraAddressImpl::Create(&amp;pAddress);</span>
<a href="#l28.281"></a><span id="l28.281" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l28.282"></a><span id="l28.282" class="difflineminus">-    {</span>
<a href="#l28.283"></a><span id="l28.283" class="difflineminus">-      nsCOMPtr&lt;nsIImportService&gt; impSvc(do_GetService(NS_IMPORTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l28.284"></a><span id="l28.284" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l28.285"></a><span id="l28.285" class="difflineminus">-      {</span>
<a href="#l28.286"></a><span id="l28.286" class="difflineminus">-        rv = impSvc-&gt;CreateNewGenericAddressBooks(&amp;pGeneric);</span>
<a href="#l28.287"></a><span id="l28.287" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l28.288"></a><span id="l28.288" class="difflineminus">-        {</span>
<a href="#l28.289"></a><span id="l28.289" class="difflineminus">-          pGeneric-&gt;SetData(&quot;addressInterface&quot;, pAddress);</span>
<a href="#l28.290"></a><span id="l28.290" class="difflineminus">-          rv = pGeneric-&gt;QueryInterface(kISupportsIID, (void **)ppInterface);</span>
<a href="#l28.291"></a><span id="l28.291" class="difflineminus">-        }</span>
<a href="#l28.292"></a><span id="l28.292" class="difflineminus">-      }</span>
<a href="#l28.293"></a><span id="l28.293" class="difflineminus">-    }</span>
<a href="#l28.294"></a><span id="l28.294" class="difflineminus">-    NS_IF_RELEASE(pAddress);</span>
<a href="#l28.295"></a><span id="l28.295" class="difflineminus">-    NS_IF_RELEASE(pGeneric);</span>
<a href="#l28.296"></a><span id="l28.296" class="difflineminus">-    return rv;</span>
<a href="#l28.297"></a><span id="l28.297" class="difflineminus">-  }</span>
<a href="#l28.298"></a><span id="l28.298" class="difflineminus">-</span>
<a href="#l28.299"></a><span id="l28.299" class="difflineminus">-  if (!strcmp(pImportType, &quot;settings&quot;))</span>
<a href="#l28.300"></a><span id="l28.300" class="difflineminus">-  {</span>
<a href="#l28.301"></a><span id="l28.301" class="difflineminus">-    nsIImportSettings *pSettings = nullptr;</span>
<a href="#l28.302"></a><span id="l28.302" class="difflineminus">-    rv = nsEudoraSettings::Create(&amp;pSettings);</span>
<a href="#l28.303"></a><span id="l28.303" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l28.304"></a><span id="l28.304" class="difflineminus">-      pSettings-&gt;QueryInterface(kISupportsIID, (void **)ppInterface);</span>
<a href="#l28.305"></a><span id="l28.305" class="difflineminus">-    NS_IF_RELEASE(pSettings);</span>
<a href="#l28.306"></a><span id="l28.306" class="difflineminus">-    return rv;</span>
<a href="#l28.307"></a><span id="l28.307" class="difflineminus">-  }</span>
<a href="#l28.308"></a><span id="l28.308" class="difflineminus">-</span>
<a href="#l28.309"></a><span id="l28.309" class="difflineminus">-  if (!strcmp(pImportType, &quot;filters&quot;))</span>
<a href="#l28.310"></a><span id="l28.310" class="difflineminus">-  {</span>
<a href="#l28.311"></a><span id="l28.311" class="difflineminus">-    nsIImportFilters *pFilters = nullptr;</span>
<a href="#l28.312"></a><span id="l28.312" class="difflineminus">-    rv = nsEudoraFilters::Create(&amp;pFilters);</span>
<a href="#l28.313"></a><span id="l28.313" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l28.314"></a><span id="l28.314" class="difflineminus">-      pFilters-&gt;QueryInterface(kISupportsIID, (void **)ppInterface);</span>
<a href="#l28.315"></a><span id="l28.315" class="difflineminus">-    NS_IF_RELEASE(pFilters);</span>
<a href="#l28.316"></a><span id="l28.316" class="difflineminus">-    return rv;</span>
<a href="#l28.317"></a><span id="l28.317" class="difflineminus">-  }</span>
<a href="#l28.318"></a><span id="l28.318" class="difflineminus">-</span>
<a href="#l28.319"></a><span id="l28.319" class="difflineminus">-  return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l28.320"></a><span id="l28.320" class="difflineminus">-}</span>
<a href="#l28.321"></a><span id="l28.321" class="difflineminus">-</span>
<a href="#l28.322"></a><span id="l28.322" class="difflineminus">-/////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l28.323"></a><span id="l28.323" class="difflineminus">-nsresult ImportEudoraMailImpl::Create(nsIImportMail** aImport)</span>
<a href="#l28.324"></a><span id="l28.324" class="difflineminus">-{</span>
<a href="#l28.325"></a><span id="l28.325" class="difflineminus">-  NS_PRECONDITION(aImport != nullptr, &quot;null ptr&quot;);</span>
<a href="#l28.326"></a><span id="l28.326" class="difflineminus">-  if (! aImport)</span>
<a href="#l28.327"></a><span id="l28.327" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l28.328"></a><span id="l28.328" class="difflineminus">-</span>
<a href="#l28.329"></a><span id="l28.329" class="difflineminus">-  *aImport = new ImportEudoraMailImpl();</span>
<a href="#l28.330"></a><span id="l28.330" class="difflineminus">-  if (! *aImport)</span>
<a href="#l28.331"></a><span id="l28.331" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l28.332"></a><span id="l28.332" class="difflineminus">-</span>
<a href="#l28.333"></a><span id="l28.333" class="difflineminus">-  NS_ADDREF(*aImport);</span>
<a href="#l28.334"></a><span id="l28.334" class="difflineminus">-  return NS_OK;</span>
<a href="#l28.335"></a><span id="l28.335" class="difflineminus">-}</span>
<a href="#l28.336"></a><span id="l28.336" class="difflineminus">-</span>
<a href="#l28.337"></a><span id="l28.337" class="difflineminus">-ImportEudoraMailImpl::ImportEudoraMailImpl()</span>
<a href="#l28.338"></a><span id="l28.338" class="difflineminus">-{</span>
<a href="#l28.339"></a><span id="l28.339" class="difflineminus">-  nsEudoraCompose::CreateIdentity();</span>
<a href="#l28.340"></a><span id="l28.340" class="difflineminus">-  // Create keys to support the default Eudora label colors.</span>
<a href="#l28.341"></a><span id="l28.341" class="difflineminus">-  // Ideally importing the settings will have already created these,</span>
<a href="#l28.342"></a><span id="l28.342" class="difflineminus">-  // in which case we won't bother (we'll detect that each key already</span>
<a href="#l28.343"></a><span id="l28.343" class="difflineminus">-  // exists). But to be sure we need to create the keys here, at</span>
<a href="#l28.344"></a><span id="l28.344" class="difflineminus">-  // least until the infrastructure is improved in some fashion so</span>
<a href="#l28.345"></a><span id="l28.345" class="difflineminus">-  // that we can rely on settings *always* being imported before mail.</span>
<a href="#l28.346"></a><span id="l28.346" class="difflineminus">-  nsresult            rv;</span>
<a href="#l28.347"></a><span id="l28.347" class="difflineminus">-  nsCOMPtr&lt;nsIMsgTagService&gt;    pTagService = do_GetService(NS_MSGTAGSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l28.348"></a><span id="l28.348" class="difflineminus">-</span>
<a href="#l28.349"></a><span id="l28.349" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l28.350"></a><span id="l28.350" class="difflineminus">-  {</span>
<a href="#l28.351"></a><span id="l28.351" class="difflineminus">-    struct EudoraDefaultLabels</span>
<a href="#l28.352"></a><span id="l28.352" class="difflineminus">-    {</span>
<a href="#l28.353"></a><span id="l28.353" class="difflineminus">-      char *    key;</span>
<a href="#l28.354"></a><span id="l28.354" class="difflineminus">-      nsString  tag;</span>
<a href="#l28.355"></a><span id="l28.355" class="difflineminus">-      char *    color;</span>
<a href="#l28.356"></a><span id="l28.356" class="difflineminus">-    };</span>
<a href="#l28.357"></a><span id="l28.357" class="difflineminus">-</span>
<a href="#l28.358"></a><span id="l28.358" class="difflineminus">-#ifdef XP_MACOSX</span>
<a href="#l28.359"></a><span id="l28.359" class="difflineminus">-    // For now default to no labels on Mac</span>
<a href="#l28.360"></a><span id="l28.360" class="difflineminus">-    #define    kNumEudoraLabels    0</span>
<a href="#l28.361"></a><span id="l28.361" class="difflineminus">-</span>
<a href="#l28.362"></a><span id="l28.362" class="difflineminus">-    // Use one dummy entry for now as a placeholder to keep the Mac code valid,</span>
<a href="#l28.363"></a><span id="l28.363" class="difflineminus">-    // until we enter actual reasonable defaults for Mac builds.</span>
<a href="#l28.364"></a><span id="l28.364" class="difflineminus">-    EudoraDefaultLabels    defaultEudoraLabels[1] =</span>
<a href="#l28.365"></a><span id="l28.365" class="difflineminus">-                    { { &quot;eudoralabel1&quot;, NS_LITERAL_STRING(&quot;Label 1&quot;), &quot;#FF6600&quot; } };</span>
<a href="#l28.366"></a><span id="l28.366" class="difflineminus">-#else</span>
<a href="#l28.367"></a><span id="l28.367" class="difflineminus">-    // These aren't the actual default Windows Eudora colors. Rather they're the closest</span>
<a href="#l28.368"></a><span id="l28.368" class="difflineminus">-    // equivalents that I could find that Thunderbird supports. When importing actual</span>
<a href="#l28.369"></a><span id="l28.369" class="difflineminus">-    // label settings, we'll need to map Eudora colors to ones that are supported.</span>
<a href="#l28.370"></a><span id="l28.370" class="difflineminus">-    #define    kNumEudoraLabels    7</span>
<a href="#l28.371"></a><span id="l28.371" class="difflineminus">-    EudoraDefaultLabels    defaultEudoraLabels[kNumEudoraLabels] =</span>
<a href="#l28.372"></a><span id="l28.372" class="difflineminus">-                    { &quot;eudoralabel1&quot;, NS_LITERAL_STRING(&quot;Label 1&quot;), &quot;#FF6600&quot;,</span>
<a href="#l28.373"></a><span id="l28.373" class="difflineminus">-                      &quot;eudoralabel2&quot;, NS_LITERAL_STRING(&quot;Label 2&quot;), &quot;#FF0000&quot;,</span>
<a href="#l28.374"></a><span id="l28.374" class="difflineminus">-                      &quot;eudoralabel3&quot;, NS_LITERAL_STRING(&quot;Label 3&quot;), &quot;#CC66CC&quot;,</span>
<a href="#l28.375"></a><span id="l28.375" class="difflineminus">-                      &quot;eudoralabel4&quot;, NS_LITERAL_STRING(&quot;Label 4&quot;), &quot;#3366FF&quot;,</span>
<a href="#l28.376"></a><span id="l28.376" class="difflineminus">-                      &quot;eudoralabel5&quot;, NS_LITERAL_STRING(&quot;Label 5&quot;), &quot;#000099&quot;,</span>
<a href="#l28.377"></a><span id="l28.377" class="difflineminus">-                      &quot;eudoralabel6&quot;, NS_LITERAL_STRING(&quot;Label 6&quot;), &quot;#009900&quot;,</span>
<a href="#l28.378"></a><span id="l28.378" class="difflineminus">-                      &quot;eudoralabel7&quot;, NS_LITERAL_STRING(&quot;Label 7&quot;), &quot;#663333&quot; };</span>
<a href="#l28.379"></a><span id="l28.379" class="difflineminus">-#endif</span>
<a href="#l28.380"></a><span id="l28.380" class="difflineminus">-</span>
<a href="#l28.381"></a><span id="l28.381" class="difflineminus">-    nsCString      eudoraKey;</span>
<a href="#l28.382"></a><span id="l28.382" class="difflineminus">-    nsString      eudoraTag;</span>
<a href="#l28.383"></a><span id="l28.383" class="difflineminus">-    nsCString      eudoraColor;</span>
<a href="#l28.384"></a><span id="l28.384" class="difflineminus">-</span>
<a href="#l28.385"></a><span id="l28.385" class="difflineminus">-    for (int16_t i = 0; i &lt; kNumEudoraLabels; i++)</span>
<a href="#l28.386"></a><span id="l28.386" class="difflineminus">-    {</span>
<a href="#l28.387"></a><span id="l28.387" class="difflineminus">-      eudoraKey = defaultEudoraLabels[i].key;</span>
<a href="#l28.388"></a><span id="l28.388" class="difflineminus">-      rv = pTagService-&gt;GetTagForKey(eudoraKey, eudoraTag);</span>
<a href="#l28.389"></a><span id="l28.389" class="difflineminus">-      if (NS_FAILED(rv) || eudoraTag.IsEmpty())</span>
<a href="#l28.390"></a><span id="l28.390" class="difflineminus">-      {</span>
<a href="#l28.391"></a><span id="l28.391" class="difflineminus">-        eudoraColor = defaultEudoraLabels[i].color;</span>
<a href="#l28.392"></a><span id="l28.392" class="difflineminus">-        rv = pTagService-&gt;AddTagForKey(eudoraKey, defaultEudoraLabels[i].tag, eudoraColor, EmptyCString());</span>
<a href="#l28.393"></a><span id="l28.393" class="difflineminus">-      }</span>
<a href="#l28.394"></a><span id="l28.394" class="difflineminus">-    }</span>
<a href="#l28.395"></a><span id="l28.395" class="difflineminus">-  }</span>
<a href="#l28.396"></a><span id="l28.396" class="difflineminus">-}</span>
<a href="#l28.397"></a><span id="l28.397" class="difflineminus">-</span>
<a href="#l28.398"></a><span id="l28.398" class="difflineminus">-</span>
<a href="#l28.399"></a><span id="l28.399" class="difflineminus">-ImportEudoraMailImpl::~ImportEudoraMailImpl()</span>
<a href="#l28.400"></a><span id="l28.400" class="difflineminus">-{</span>
<a href="#l28.401"></a><span id="l28.401" class="difflineminus">-  // We're done importing mail, so nsEudoraCompose no longer needs the identity</span>
<a href="#l28.402"></a><span id="l28.402" class="difflineminus">-  // that it creates when we import any mail.</span>
<a href="#l28.403"></a><span id="l28.403" class="difflineminus">-  nsEudoraCompose::ReleaseIdentity();</span>
<a href="#l28.404"></a><span id="l28.404" class="difflineminus">-}</span>
<a href="#l28.405"></a><span id="l28.405" class="difflineminus">-</span>
<a href="#l28.406"></a><span id="l28.406" class="difflineminus">-</span>
<a href="#l28.407"></a><span id="l28.407" class="difflineminus">-</span>
<a href="#l28.408"></a><span id="l28.408" class="difflineminus">-NS_IMPL_ISUPPORTS(ImportEudoraMailImpl, nsIImportMail)</span>
<a href="#l28.409"></a><span id="l28.409" class="difflineminus">-</span>
<a href="#l28.410"></a><span id="l28.410" class="difflineminus">-NS_IMETHODIMP ImportEudoraMailImpl::GetDefaultLocation(nsIFile **ppLoc, bool *found, bool *userVerify)</span>
<a href="#l28.411"></a><span id="l28.411" class="difflineminus">-{</span>
<a href="#l28.412"></a><span id="l28.412" class="difflineminus">-  NS_PRECONDITION(ppLoc != nullptr, &quot;null ptr&quot;);</span>
<a href="#l28.413"></a><span id="l28.413" class="difflineminus">-  NS_PRECONDITION(found != nullptr, &quot;null ptr&quot;);</span>
<a href="#l28.414"></a><span id="l28.414" class="difflineminus">-  NS_PRECONDITION(userVerify != nullptr, &quot;null ptr&quot;);</span>
<a href="#l28.415"></a><span id="l28.415" class="difflineminus">-  if (!ppLoc || !found || !userVerify)</span>
<a href="#l28.416"></a><span id="l28.416" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l28.417"></a><span id="l28.417" class="difflineminus">-</span>
<a href="#l28.418"></a><span id="l28.418" class="difflineminus">-  *ppLoc = nullptr;</span>
<a href="#l28.419"></a><span id="l28.419" class="difflineminus">-  *found = m_eudora.FindMailFolder(ppLoc);</span>
<a href="#l28.420"></a><span id="l28.420" class="difflineminus">-  *userVerify = true;</span>
<a href="#l28.421"></a><span id="l28.421" class="difflineminus">-</span>
<a href="#l28.422"></a><span id="l28.422" class="difflineminus">-  return NS_OK;</span>
<a href="#l28.423"></a><span id="l28.423" class="difflineminus">-}</span>
<a href="#l28.424"></a><span id="l28.424" class="difflineminus">-</span>
<a href="#l28.425"></a><span id="l28.425" class="difflineminus">-</span>
<a href="#l28.426"></a><span id="l28.426" class="difflineminus">-NS_IMETHODIMP ImportEudoraMailImpl::FindMailboxes(nsIFile *pLoc, nsIArray **ppArray)</span>
<a href="#l28.427"></a><span id="l28.427" class="difflineminus">-{</span>
<a href="#l28.428"></a><span id="l28.428" class="difflineminus">-  NS_PRECONDITION(pLoc != nullptr, &quot;null ptr&quot;);</span>
<a href="#l28.429"></a><span id="l28.429" class="difflineminus">-  NS_PRECONDITION(ppArray != nullptr, &quot;null ptr&quot;);</span>
<a href="#l28.430"></a><span id="l28.430" class="difflineminus">-  if (!pLoc || !ppArray)</span>
<a href="#l28.431"></a><span id="l28.431" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l28.432"></a><span id="l28.432" class="difflineminus">-</span>
<a href="#l28.433"></a><span id="l28.433" class="difflineminus">-  bool exists = false;</span>
<a href="#l28.434"></a><span id="l28.434" class="difflineminus">-  nsresult rv = pLoc-&gt;Exists(&amp;exists);</span>
<a href="#l28.435"></a><span id="l28.435" class="difflineminus">-  if (NS_FAILED(rv) || !exists)</span>
<a href="#l28.436"></a><span id="l28.436" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l28.437"></a><span id="l28.437" class="difflineminus">-</span>
<a href="#l28.438"></a><span id="l28.438" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; array(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l28.439"></a><span id="l28.439" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l28.440"></a><span id="l28.440" class="difflineminus">-  {</span>
<a href="#l28.441"></a><span id="l28.441" class="difflineminus">-    IMPORT_LOG0(&quot;FAILED to allocate the nsIMutableArray\n&quot;);</span>
<a href="#l28.442"></a><span id="l28.442" class="difflineminus">-    return rv;</span>
<a href="#l28.443"></a><span id="l28.443" class="difflineminus">-  }</span>
<a href="#l28.444"></a><span id="l28.444" class="difflineminus">-  rv = m_eudora.FindMailboxes(pLoc, array);</span>
<a href="#l28.445"></a><span id="l28.445" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l28.446"></a><span id="l28.446" class="difflineminus">-    return rv;</span>
<a href="#l28.447"></a><span id="l28.447" class="difflineminus">-</span>
<a href="#l28.448"></a><span id="l28.448" class="difflineminus">-  array.forget(ppArray);</span>
<a href="#l28.449"></a><span id="l28.449" class="difflineminus">-</span>
<a href="#l28.450"></a><span id="l28.450" class="difflineminus">-  return NS_OK;</span>
<a href="#l28.451"></a><span id="l28.451" class="difflineminus">-}</span>
<a href="#l28.452"></a><span id="l28.452" class="difflineminus">-</span>
<a href="#l28.453"></a><span id="l28.453" class="difflineminus">-void ImportEudoraMailImpl::AddLinebreak(nsString *pStream)</span>
<a href="#l28.454"></a><span id="l28.454" class="difflineminus">-{</span>
<a href="#l28.455"></a><span id="l28.455" class="difflineminus">-  if (pStream)</span>
<a href="#l28.456"></a><span id="l28.456" class="difflineminus">-    pStream-&gt;Append(char16_t('\n'));</span>
<a href="#l28.457"></a><span id="l28.457" class="difflineminus">-}</span>
<a href="#l28.458"></a><span id="l28.458" class="difflineminus">-</span>
<a href="#l28.459"></a><span id="l28.459" class="difflineminus">-void ImportEudoraMailImpl::ReportSuccess(nsString&amp; name, int32_t count, nsString *pStream)</span>
<a href="#l28.460"></a><span id="l28.460" class="difflineminus">-{</span>
<a href="#l28.461"></a><span id="l28.461" class="difflineminus">-  if (!pStream)</span>
<a href="#l28.462"></a><span id="l28.462" class="difflineminus">-    return;</span>
<a href="#l28.463"></a><span id="l28.463" class="difflineminus">-  // load the success string</span>
<a href="#l28.464"></a><span id="l28.464" class="difflineminus">-  char16_t *pFmt = nsEudoraStringBundle::GetStringByID(EUDORAIMPORT_MAILBOX_SUCCESS);</span>
<a href="#l28.465"></a><span id="l28.465" class="difflineminus">-  char16_t *pText = nsTextFormatter::smprintf(pFmt, name.get(), count);</span>
<a href="#l28.466"></a><span id="l28.466" class="difflineminus">-  pStream-&gt;Append(pText);</span>
<a href="#l28.467"></a><span id="l28.467" class="difflineminus">-  nsTextFormatter::smprintf_free(pText);</span>
<a href="#l28.468"></a><span id="l28.468" class="difflineminus">-  nsEudoraStringBundle::FreeString(pFmt);</span>
<a href="#l28.469"></a><span id="l28.469" class="difflineminus">-  AddLinebreak(pStream);</span>
<a href="#l28.470"></a><span id="l28.470" class="difflineminus">-}</span>
<a href="#l28.471"></a><span id="l28.471" class="difflineminus">-</span>
<a href="#l28.472"></a><span id="l28.472" class="difflineminus">-void ImportEudoraMailImpl::ReportError(int32_t errorNum, nsString&amp; name, nsString *pStream)</span>
<a href="#l28.473"></a><span id="l28.473" class="difflineminus">-{</span>
<a href="#l28.474"></a><span id="l28.474" class="difflineminus">-  if (!pStream)</span>
<a href="#l28.475"></a><span id="l28.475" class="difflineminus">-    return;</span>
<a href="#l28.476"></a><span id="l28.476" class="difflineminus">-  // load the error string</span>
<a href="#l28.477"></a><span id="l28.477" class="difflineminus">-  char16_t *pFmt = nsEudoraStringBundle::GetStringByID(errorNum);</span>
<a href="#l28.478"></a><span id="l28.478" class="difflineminus">-  char16_t *pText = nsTextFormatter::smprintf(pFmt, name.get());</span>
<a href="#l28.479"></a><span id="l28.479" class="difflineminus">-  pStream-&gt;Append(pText);</span>
<a href="#l28.480"></a><span id="l28.480" class="difflineminus">-  nsTextFormatter::smprintf_free(pText);</span>
<a href="#l28.481"></a><span id="l28.481" class="difflineminus">-  nsEudoraStringBundle::FreeString(pFmt);</span>
<a href="#l28.482"></a><span id="l28.482" class="difflineminus">-  AddLinebreak(pStream);</span>
<a href="#l28.483"></a><span id="l28.483" class="difflineminus">-}</span>
<a href="#l28.484"></a><span id="l28.484" class="difflineminus">-</span>
<a href="#l28.485"></a><span id="l28.485" class="difflineminus">-</span>
<a href="#l28.486"></a><span id="l28.486" class="difflineminus">-void ImportEudoraMailImpl::SetLogs(nsString&amp; success, nsString&amp; error, char16_t **pError, char16_t **pSuccess)</span>
<a href="#l28.487"></a><span id="l28.487" class="difflineminus">-{</span>
<a href="#l28.488"></a><span id="l28.488" class="difflineminus">-  if (pError)</span>
<a href="#l28.489"></a><span id="l28.489" class="difflineminus">-    *pError = ToNewUnicode(error);</span>
<a href="#l28.490"></a><span id="l28.490" class="difflineminus">-  if (pSuccess)</span>
<a href="#l28.491"></a><span id="l28.491" class="difflineminus">-    *pSuccess = ToNewUnicode(success);</span>
<a href="#l28.492"></a><span id="l28.492" class="difflineminus">-}</span>
<a href="#l28.493"></a><span id="l28.493" class="difflineminus">-</span>
<a href="#l28.494"></a><span id="l28.494" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l28.495"></a><span id="l28.495" class="difflineminus">-ImportEudoraMailImpl::ImportMailbox(nsIImportMailboxDescriptor *pSource,</span>
<a href="#l28.496"></a><span id="l28.496" class="difflineminus">-                                    nsIMsgFolder *pDstFolder,</span>
<a href="#l28.497"></a><span id="l28.497" class="difflineminus">-                                    char16_t **pErrorLog,</span>
<a href="#l28.498"></a><span id="l28.498" class="difflineminus">-                                    char16_t **pSuccessLog,</span>
<a href="#l28.499"></a><span id="l28.499" class="difflineminus">-                                    bool *fatalError)</span>
<a href="#l28.500"></a><span id="l28.500" class="difflineminus">-{</span>
<a href="#l28.501"></a><span id="l28.501" class="difflineminus">-  NS_ENSURE_ARG_POINTER(pSource);</span>
<a href="#l28.502"></a><span id="l28.502" class="difflineminus">-  NS_ENSURE_ARG_POINTER(pDstFolder);</span>
<a href="#l28.503"></a><span id="l28.503" class="difflineminus">-  NS_ENSURE_ARG_POINTER(fatalError);</span>
<a href="#l28.504"></a><span id="l28.504" class="difflineminus">-</span>
<a href="#l28.505"></a><span id="l28.505" class="difflineminus">-  nsString  success;</span>
<a href="#l28.506"></a><span id="l28.506" class="difflineminus">-  nsString  error;</span>
<a href="#l28.507"></a><span id="l28.507" class="difflineminus">-  bool      abort = false;</span>
<a href="#l28.508"></a><span id="l28.508" class="difflineminus">-  nsString  name;</span>
<a href="#l28.509"></a><span id="l28.509" class="difflineminus">-  char16_t *  pName;</span>
<a href="#l28.510"></a><span id="l28.510" class="difflineminus">-  if (NS_SUCCEEDED(pSource-&gt;GetDisplayName(&amp;pName)))</span>
<a href="#l28.511"></a><span id="l28.511" class="difflineminus">-  {</span>
<a href="#l28.512"></a><span id="l28.512" class="difflineminus">-    name = pName;</span>
<a href="#l28.513"></a><span id="l28.513" class="difflineminus">-    NS_Free(pName);</span>
<a href="#l28.514"></a><span id="l28.514" class="difflineminus">-  }</span>
<a href="#l28.515"></a><span id="l28.515" class="difflineminus">-</span>
<a href="#l28.516"></a><span id="l28.516" class="difflineminus">-  uint32_t mailSize = 0;</span>
<a href="#l28.517"></a><span id="l28.517" class="difflineminus">-  pSource-&gt;GetSize(&amp;mailSize);</span>
<a href="#l28.518"></a><span id="l28.518" class="difflineminus">-  if (mailSize == 0)</span>
<a href="#l28.519"></a><span id="l28.519" class="difflineminus">-  {</span>
<a href="#l28.520"></a><span id="l28.520" class="difflineminus">-    IMPORT_LOG0(&quot;Mailbox size is 0, skipping mailbox.\n&quot;);</span>
<a href="#l28.521"></a><span id="l28.521" class="difflineminus">-    ReportSuccess(name, 0, &amp;success);</span>
<a href="#l28.522"></a><span id="l28.522" class="difflineminus">-    SetLogs(success, error, pErrorLog, pSuccessLog);</span>
<a href="#l28.523"></a><span id="l28.523" class="difflineminus">-    return NS_OK;</span>
<a href="#l28.524"></a><span id="l28.524" class="difflineminus">-  }</span>
<a href="#l28.525"></a><span id="l28.525" class="difflineminus">-</span>
<a href="#l28.526"></a><span id="l28.526" class="difflineminus">-</span>
<a href="#l28.527"></a><span id="l28.527" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt;  inFile;</span>
<a href="#l28.528"></a><span id="l28.528" class="difflineminus">-  if (NS_FAILED(pSource-&gt;GetFile(getter_AddRefs(inFile))))</span>
<a href="#l28.529"></a><span id="l28.529" class="difflineminus">-  {</span>
<a href="#l28.530"></a><span id="l28.530" class="difflineminus">-    ReportError(EUDORAIMPORT_MAILBOX_BADSOURCEFILE, name, &amp;error);</span>
<a href="#l28.531"></a><span id="l28.531" class="difflineminus">-    SetLogs(success, error, pErrorLog, pSuccessLog);</span>
<a href="#l28.532"></a><span id="l28.532" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l28.533"></a><span id="l28.533" class="difflineminus">-  }</span>
<a href="#l28.534"></a><span id="l28.534" class="difflineminus">-</span>
<a href="#l28.535"></a><span id="l28.535" class="difflineminus">-#ifdef IMPORT_DEBUG</span>
<a href="#l28.536"></a><span id="l28.536" class="difflineminus">-  nsCString pPath;</span>
<a href="#l28.537"></a><span id="l28.537" class="difflineminus">-  inFile-&gt;GetNativePath(pPath);</span>
<a href="#l28.538"></a><span id="l28.538" class="difflineminus">-  IMPORT_LOG1(&quot;Import mailbox: %s\n&quot;, pPath.get());</span>
<a href="#l28.539"></a><span id="l28.539" class="difflineminus">-#endif</span>
<a href="#l28.540"></a><span id="l28.540" class="difflineminus">-</span>
<a href="#l28.541"></a><span id="l28.541" class="difflineminus">-</span>
<a href="#l28.542"></a><span id="l28.542" class="difflineminus">-  int32_t  msgCount = 0;</span>
<a href="#l28.543"></a><span id="l28.543" class="difflineminus">-  nsresult rv = NS_OK;</span>
<a href="#l28.544"></a><span id="l28.544" class="difflineminus">-</span>
<a href="#l28.545"></a><span id="l28.545" class="difflineminus">-  m_bytes = 0;</span>
<a href="#l28.546"></a><span id="l28.546" class="difflineminus">-  rv = m_eudora.ImportMailbox( &amp;m_bytes, &amp;abort, name.get(), inFile, pDstFolder, &amp;msgCount);</span>
<a href="#l28.547"></a><span id="l28.547" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l28.548"></a><span id="l28.548" class="difflineminus">-    ReportSuccess(name, msgCount, &amp;success);</span>
<a href="#l28.549"></a><span id="l28.549" class="difflineminus">-  else</span>
<a href="#l28.550"></a><span id="l28.550" class="difflineminus">-    ReportError(EUDORAIMPORT_MAILBOX_CONVERTERROR, name, &amp;error);</span>
<a href="#l28.551"></a><span id="l28.551" class="difflineminus">-</span>
<a href="#l28.552"></a><span id="l28.552" class="difflineminus">-  SetLogs(success, error, pErrorLog, pSuccessLog);</span>
<a href="#l28.553"></a><span id="l28.553" class="difflineminus">-</span>
<a href="#l28.554"></a><span id="l28.554" class="difflineminus">-  IMPORT_LOG0(&quot;*** Returning from eudora mailbox import\n&quot;);</span>
<a href="#l28.555"></a><span id="l28.555" class="difflineminus">-</span>
<a href="#l28.556"></a><span id="l28.556" class="difflineminus">-  return rv;</span>
<a href="#l28.557"></a><span id="l28.557" class="difflineminus">-}</span>
<a href="#l28.558"></a><span id="l28.558" class="difflineminus">-</span>
<a href="#l28.559"></a><span id="l28.559" class="difflineminus">-</span>
<a href="#l28.560"></a><span id="l28.560" class="difflineminus">-NS_IMETHODIMP ImportEudoraMailImpl::GetImportProgress(uint32_t *pDoneSoFar)</span>
<a href="#l28.561"></a><span id="l28.561" class="difflineminus">-{</span>
<a href="#l28.562"></a><span id="l28.562" class="difflineminus">-  NS_PRECONDITION(pDoneSoFar != nullptr, &quot;null ptr&quot;);</span>
<a href="#l28.563"></a><span id="l28.563" class="difflineminus">-  if (! pDoneSoFar)</span>
<a href="#l28.564"></a><span id="l28.564" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l28.565"></a><span id="l28.565" class="difflineminus">-</span>
<a href="#l28.566"></a><span id="l28.566" class="difflineminus">-  *pDoneSoFar = m_bytes;</span>
<a href="#l28.567"></a><span id="l28.567" class="difflineminus">-  return NS_OK;</span>
<a href="#l28.568"></a><span id="l28.568" class="difflineminus">-}</span>
<a href="#l28.569"></a><span id="l28.569" class="difflineminus">-</span>
<a href="#l28.570"></a><span id="l28.570" class="difflineminus">-</span>
<a href="#l28.571"></a><span id="l28.571" class="difflineminus">-NS_IMETHODIMP ImportEudoraMailImpl::TranslateFolderName(const nsAString &amp; aFolderName, nsAString &amp; _retval)</span>
<a href="#l28.572"></a><span id="l28.572" class="difflineminus">-{</span>
<a href="#l28.573"></a><span id="l28.573" class="difflineminus">-  if (aFolderName.LowerCaseEqualsLiteral(&quot;out&quot;))</span>
<a href="#l28.574"></a><span id="l28.574" class="difflineminus">-    _retval = NS_LITERAL_STRING(kDestSentFolderName);</span>
<a href="#l28.575"></a><span id="l28.575" class="difflineminus">-  else if (aFolderName.LowerCaseEqualsLiteral(&quot;in&quot;))</span>
<a href="#l28.576"></a><span id="l28.576" class="difflineminus">-    _retval = NS_LITERAL_STRING(kDestInboxFolderName);</span>
<a href="#l28.577"></a><span id="l28.577" class="difflineminus">-  else</span>
<a href="#l28.578"></a><span id="l28.578" class="difflineminus">-    _retval = aFolderName;</span>
<a href="#l28.579"></a><span id="l28.579" class="difflineminus">-  return NS_OK;</span>
<a href="#l28.580"></a><span id="l28.580" class="difflineminus">-}</span>
<a href="#l28.581"></a><span id="l28.581" class="difflineminus">-</span>
<a href="#l28.582"></a><span id="l28.582" class="difflineminus">-nsresult ImportEudoraAddressImpl::Create(nsIImportAddressBooks** aImport)</span>
<a href="#l28.583"></a><span id="l28.583" class="difflineminus">-{</span>
<a href="#l28.584"></a><span id="l28.584" class="difflineminus">-  NS_PRECONDITION(aImport != nullptr, &quot;null ptr&quot;);</span>
<a href="#l28.585"></a><span id="l28.585" class="difflineminus">-  if (! aImport)</span>
<a href="#l28.586"></a><span id="l28.586" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l28.587"></a><span id="l28.587" class="difflineminus">-</span>
<a href="#l28.588"></a><span id="l28.588" class="difflineminus">-  *aImport = new ImportEudoraAddressImpl();</span>
<a href="#l28.589"></a><span id="l28.589" class="difflineminus">-  if (! *aImport)</span>
<a href="#l28.590"></a><span id="l28.590" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l28.591"></a><span id="l28.591" class="difflineminus">-</span>
<a href="#l28.592"></a><span id="l28.592" class="difflineminus">-  NS_ADDREF(*aImport);</span>
<a href="#l28.593"></a><span id="l28.593" class="difflineminus">-  return NS_OK;</span>
<a href="#l28.594"></a><span id="l28.594" class="difflineminus">-}</span>
<a href="#l28.595"></a><span id="l28.595" class="difflineminus">-</span>
<a href="#l28.596"></a><span id="l28.596" class="difflineminus">-ImportEudoraAddressImpl::ImportEudoraAddressImpl()</span>
<a href="#l28.597"></a><span id="l28.597" class="difflineminus">-{</span>
<a href="#l28.598"></a><span id="l28.598" class="difflineminus">-}</span>
<a href="#l28.599"></a><span id="l28.599" class="difflineminus">-</span>
<a href="#l28.600"></a><span id="l28.600" class="difflineminus">-</span>
<a href="#l28.601"></a><span id="l28.601" class="difflineminus">-ImportEudoraAddressImpl::~ImportEudoraAddressImpl()</span>
<a href="#l28.602"></a><span id="l28.602" class="difflineminus">-{</span>
<a href="#l28.603"></a><span id="l28.603" class="difflineminus">-}</span>
<a href="#l28.604"></a><span id="l28.604" class="difflineminus">-</span>
<a href="#l28.605"></a><span id="l28.605" class="difflineminus">-</span>
<a href="#l28.606"></a><span id="l28.606" class="difflineminus">-</span>
<a href="#l28.607"></a><span id="l28.607" class="difflineminus">-NS_IMPL_ISUPPORTS(ImportEudoraAddressImpl, nsIImportAddressBooks)</span>
<a href="#l28.608"></a><span id="l28.608" class="difflineminus">-</span>
<a href="#l28.609"></a><span id="l28.609" class="difflineminus">-</span>
<a href="#l28.610"></a><span id="l28.610" class="difflineminus">-NS_IMETHODIMP ImportEudoraAddressImpl::GetAutoFind(char16_t **description, bool *_retval)</span>
<a href="#l28.611"></a><span id="l28.611" class="difflineminus">-{</span>
<a href="#l28.612"></a><span id="l28.612" class="difflineminus">-  NS_PRECONDITION(description != nullptr, &quot;null ptr&quot;);</span>
<a href="#l28.613"></a><span id="l28.613" class="difflineminus">-  NS_PRECONDITION(_retval != nullptr, &quot;null ptr&quot;);</span>
<a href="#l28.614"></a><span id="l28.614" class="difflineminus">-  if (! description || !_retval)</span>
<a href="#l28.615"></a><span id="l28.615" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l28.616"></a><span id="l28.616" class="difflineminus">-</span>
<a href="#l28.617"></a><span id="l28.617" class="difflineminus">-  nsString  str;</span>
<a href="#l28.618"></a><span id="l28.618" class="difflineminus">-  *_retval = false;</span>
<a href="#l28.619"></a><span id="l28.619" class="difflineminus">-  nsEudoraStringBundle::GetStringByID(EUDORAIMPORT_NICKNAMES_NAME, str);</span>
<a href="#l28.620"></a><span id="l28.620" class="difflineminus">-  *description = ToNewUnicode(str);</span>
<a href="#l28.621"></a><span id="l28.621" class="difflineminus">-</span>
<a href="#l28.622"></a><span id="l28.622" class="difflineminus">-  return NS_OK;</span>
<a href="#l28.623"></a><span id="l28.623" class="difflineminus">-}</span>
<a href="#l28.624"></a><span id="l28.624" class="difflineminus">-</span>
<a href="#l28.625"></a><span id="l28.625" class="difflineminus">-</span>
<a href="#l28.626"></a><span id="l28.626" class="difflineminus">-NS_IMETHODIMP ImportEudoraAddressImpl::GetDefaultLocation(nsIFile **ppLoc, bool *found, bool *userVerify)</span>
<a href="#l28.627"></a><span id="l28.627" class="difflineminus">-{</span>
<a href="#l28.628"></a><span id="l28.628" class="difflineminus">-  NS_PRECONDITION(found != nullptr, &quot;null ptr&quot;);</span>
<a href="#l28.629"></a><span id="l28.629" class="difflineminus">-  NS_PRECONDITION(ppLoc != nullptr, &quot;null ptr&quot;);</span>
<a href="#l28.630"></a><span id="l28.630" class="difflineminus">-  NS_PRECONDITION(userVerify != nullptr, &quot;null ptr&quot;);</span>
<a href="#l28.631"></a><span id="l28.631" class="difflineminus">-  if (! found || !userVerify || !ppLoc)</span>
<a href="#l28.632"></a><span id="l28.632" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l28.633"></a><span id="l28.633" class="difflineminus">-</span>
<a href="#l28.634"></a><span id="l28.634" class="difflineminus">-  *ppLoc = nullptr;</span>
<a href="#l28.635"></a><span id="l28.635" class="difflineminus">-  *found = m_eudora.FindAddressFolder(ppLoc);</span>
<a href="#l28.636"></a><span id="l28.636" class="difflineminus">-  *userVerify = true;</span>
<a href="#l28.637"></a><span id="l28.637" class="difflineminus">-</span>
<a href="#l28.638"></a><span id="l28.638" class="difflineminus">-  return NS_OK;</span>
<a href="#l28.639"></a><span id="l28.639" class="difflineminus">-}</span>
<a href="#l28.640"></a><span id="l28.640" class="difflineminus">-</span>
<a href="#l28.641"></a><span id="l28.641" class="difflineminus">-</span>
<a href="#l28.642"></a><span id="l28.642" class="difflineminus">-</span>
<a href="#l28.643"></a><span id="l28.643" class="difflineminus">-NS_IMETHODIMP ImportEudoraAddressImpl::FindAddressBooks(nsIFile *pLoc, nsIArray **ppArray)</span>
<a href="#l28.644"></a><span id="l28.644" class="difflineminus">-{</span>
<a href="#l28.645"></a><span id="l28.645" class="difflineminus">-    NS_PRECONDITION(pLoc != nullptr, &quot;null ptr&quot;);</span>
<a href="#l28.646"></a><span id="l28.646" class="difflineminus">-    NS_PRECONDITION(ppArray != nullptr, &quot;null ptr&quot;);</span>
<a href="#l28.647"></a><span id="l28.647" class="difflineminus">-    if (!pLoc || !ppArray)</span>
<a href="#l28.648"></a><span id="l28.648" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l28.649"></a><span id="l28.649" class="difflineminus">-</span>
<a href="#l28.650"></a><span id="l28.650" class="difflineminus">-  bool exists = false;</span>
<a href="#l28.651"></a><span id="l28.651" class="difflineminus">-  nsresult rv = pLoc-&gt;Exists(&amp;exists);</span>
<a href="#l28.652"></a><span id="l28.652" class="difflineminus">-  if (NS_FAILED(rv) || !exists)</span>
<a href="#l28.653"></a><span id="l28.653" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l28.654"></a><span id="l28.654" class="difflineminus">-</span>
<a href="#l28.655"></a><span id="l28.655" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; array(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l28.656"></a><span id="l28.656" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l28.657"></a><span id="l28.657" class="difflineminus">-  {</span>
<a href="#l28.658"></a><span id="l28.658" class="difflineminus">-    IMPORT_LOG0(&quot;FAILED to allocate the nsIMutableArray\n&quot;);</span>
<a href="#l28.659"></a><span id="l28.659" class="difflineminus">-    return rv;</span>
<a href="#l28.660"></a><span id="l28.660" class="difflineminus">-  }</span>
<a href="#l28.661"></a><span id="l28.661" class="difflineminus">-  rv = m_eudora.FindAddressBooks(pLoc, array);</span>
<a href="#l28.662"></a><span id="l28.662" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l28.663"></a><span id="l28.663" class="difflineminus">-    return rv;</span>
<a href="#l28.664"></a><span id="l28.664" class="difflineminus">-</span>
<a href="#l28.665"></a><span id="l28.665" class="difflineminus">-  array.forget(ppArray);</span>
<a href="#l28.666"></a><span id="l28.666" class="difflineminus">-</span>
<a href="#l28.667"></a><span id="l28.667" class="difflineminus">-  return NS_OK;</span>
<a href="#l28.668"></a><span id="l28.668" class="difflineminus">-}</span>
<a href="#l28.669"></a><span id="l28.669" class="difflineminus">-</span>
<a href="#l28.670"></a><span id="l28.670" class="difflineminus">-</span>
<a href="#l28.671"></a><span id="l28.671" class="difflineminus">-</span>
<a href="#l28.672"></a><span id="l28.672" class="difflineminus">-void ImportEudoraAddressImpl::ReportSuccess(nsString&amp; name, nsString *pStream)</span>
<a href="#l28.673"></a><span id="l28.673" class="difflineminus">-{</span>
<a href="#l28.674"></a><span id="l28.674" class="difflineminus">-  if (!pStream)</span>
<a href="#l28.675"></a><span id="l28.675" class="difflineminus">-    return;</span>
<a href="#l28.676"></a><span id="l28.676" class="difflineminus">-  // load the success string</span>
<a href="#l28.677"></a><span id="l28.677" class="difflineminus">-  char16_t *pFmt = nsEudoraStringBundle::GetStringByID(EUDORAIMPORT_ADDRESS_SUCCESS);</span>
<a href="#l28.678"></a><span id="l28.678" class="difflineminus">-  char16_t *pText = nsTextFormatter::smprintf(pFmt, name.get());</span>
<a href="#l28.679"></a><span id="l28.679" class="difflineminus">-  pStream-&gt;Append(pText);</span>
<a href="#l28.680"></a><span id="l28.680" class="difflineminus">-  nsTextFormatter::smprintf_free(pText);</span>
<a href="#l28.681"></a><span id="l28.681" class="difflineminus">-  nsEudoraStringBundle::FreeString(pFmt);</span>
<a href="#l28.682"></a><span id="l28.682" class="difflineminus">-  ImportEudoraMailImpl::AddLinebreak(pStream);</span>
<a href="#l28.683"></a><span id="l28.683" class="difflineminus">-}</span>
<a href="#l28.684"></a><span id="l28.684" class="difflineminus">-</span>
<a href="#l28.685"></a><span id="l28.685" class="difflineminus">-</span>
<a href="#l28.686"></a><span id="l28.686" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l28.687"></a><span id="l28.687" class="difflineminus">-ImportEudoraAddressImpl::ImportAddressBook(nsIImportABDescriptor *pSource,</span>
<a href="#l28.688"></a><span id="l28.688" class="difflineminus">-                                           nsIAddrDatabase *pDestination,</span>
<a href="#l28.689"></a><span id="l28.689" class="difflineminus">-                                           nsIImportFieldMap *fieldMap,</span>
<a href="#l28.690"></a><span id="l28.690" class="difflineminus">-                                           nsISupports *aSupportService,</span>
<a href="#l28.691"></a><span id="l28.691" class="difflineminus">-                                           char16_t **pErrorLog,</span>
<a href="#l28.692"></a><span id="l28.692" class="difflineminus">-                                           char16_t **pSuccessLog,</span>
<a href="#l28.693"></a><span id="l28.693" class="difflineminus">-                                           bool *fatalError)</span>
<a href="#l28.694"></a><span id="l28.694" class="difflineminus">-{</span>
<a href="#l28.695"></a><span id="l28.695" class="difflineminus">-  NS_PRECONDITION(pSource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l28.696"></a><span id="l28.696" class="difflineminus">-  NS_PRECONDITION(pDestination != nullptr, &quot;null ptr&quot;);</span>
<a href="#l28.697"></a><span id="l28.697" class="difflineminus">-  NS_PRECONDITION(fatalError != nullptr, &quot;null ptr&quot;);</span>
<a href="#l28.698"></a><span id="l28.698" class="difflineminus">-</span>
<a href="#l28.699"></a><span id="l28.699" class="difflineminus">-  nsString success;</span>
<a href="#l28.700"></a><span id="l28.700" class="difflineminus">-  nsString error;</span>
<a href="#l28.701"></a><span id="l28.701" class="difflineminus">-  if (!pSource || !pDestination || !fatalError) {</span>
<a href="#l28.702"></a><span id="l28.702" class="difflineminus">-    IMPORT_LOG0(&quot;*** Bad param passed to eudora address import\n&quot;);</span>
<a href="#l28.703"></a><span id="l28.703" class="difflineminus">-    nsEudoraStringBundle::GetStringByID(EUDORAIMPORT_ADDRESS_BADPARAM, error);</span>
<a href="#l28.704"></a><span id="l28.704" class="difflineminus">-    if (fatalError)</span>
<a href="#l28.705"></a><span id="l28.705" class="difflineminus">-      *fatalError = true;</span>
<a href="#l28.706"></a><span id="l28.706" class="difflineminus">-    ImportEudoraMailImpl::SetLogs(success, error, pErrorLog, pSuccessLog);</span>
<a href="#l28.707"></a><span id="l28.707" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l28.708"></a><span id="l28.708" class="difflineminus">-  }</span>
<a href="#l28.709"></a><span id="l28.709" class="difflineminus">-</span>
<a href="#l28.710"></a><span id="l28.710" class="difflineminus">-  bool abort = false;</span>
<a href="#l28.711"></a><span id="l28.711" class="difflineminus">-  nsString name;</span>
<a href="#l28.712"></a><span id="l28.712" class="difflineminus">-  pSource-&gt;GetPreferredName(name);</span>
<a href="#l28.713"></a><span id="l28.713" class="difflineminus">-</span>
<a href="#l28.714"></a><span id="l28.714" class="difflineminus">-  uint32_t addressSize = 0;</span>
<a href="#l28.715"></a><span id="l28.715" class="difflineminus">-  pSource-&gt;GetSize(&amp;addressSize);</span>
<a href="#l28.716"></a><span id="l28.716" class="difflineminus">-  if (addressSize == 0) {</span>
<a href="#l28.717"></a><span id="l28.717" class="difflineminus">-    IMPORT_LOG0(&quot;Address book size is 0, skipping mailbox.\n&quot;);</span>
<a href="#l28.718"></a><span id="l28.718" class="difflineminus">-    ReportSuccess(name, &amp;success);</span>
<a href="#l28.719"></a><span id="l28.719" class="difflineminus">-    ImportEudoraMailImpl::SetLogs(success, error, pErrorLog, pSuccessLog);</span>
<a href="#l28.720"></a><span id="l28.720" class="difflineminus">-    return NS_OK;</span>
<a href="#l28.721"></a><span id="l28.721" class="difflineminus">-  }</span>
<a href="#l28.722"></a><span id="l28.722" class="difflineminus">-</span>
<a href="#l28.723"></a><span id="l28.723" class="difflineminus">-</span>
<a href="#l28.724"></a><span id="l28.724" class="difflineminus">-  nsCOMPtr&lt;nsIFile&gt; inFile;</span>
<a href="#l28.725"></a><span id="l28.725" class="difflineminus">-  if (NS_FAILED(pSource-&gt;GetAbFile(getter_AddRefs(inFile)))) {</span>
<a href="#l28.726"></a><span id="l28.726" class="difflineminus">-    ImportEudoraMailImpl::ReportError(EUDORAIMPORT_ADDRESS_BADSOURCEFILE, name, &amp;error);</span>
<a href="#l28.727"></a><span id="l28.727" class="difflineminus">-    ImportEudoraMailImpl::SetLogs(success, error, pErrorLog, pSuccessLog);</span>
<a href="#l28.728"></a><span id="l28.728" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l28.729"></a><span id="l28.729" class="difflineminus">-  }</span>
<a href="#l28.730"></a><span id="l28.730" class="difflineminus">-</span>
<a href="#l28.731"></a><span id="l28.731" class="difflineminus">-</span>
<a href="#l28.732"></a><span id="l28.732" class="difflineminus">-#ifdef IMPORT_DEBUG</span>
<a href="#l28.733"></a><span id="l28.733" class="difflineminus">-  nsCString path;</span>
<a href="#l28.734"></a><span id="l28.734" class="difflineminus">-  inFile-&gt;GetNativePath(path);</span>
<a href="#l28.735"></a><span id="l28.735" class="difflineminus">-  IMPORT_LOG1(&quot;Import address book: %s\n&quot;, path.get());</span>
<a href="#l28.736"></a><span id="l28.736" class="difflineminus">-#endif</span>
<a href="#l28.737"></a><span id="l28.737" class="difflineminus">-</span>
<a href="#l28.738"></a><span id="l28.738" class="difflineminus">-</span>
<a href="#l28.739"></a><span id="l28.739" class="difflineminus">-  nsresult rv = NS_OK;</span>
<a href="#l28.740"></a><span id="l28.740" class="difflineminus">-</span>
<a href="#l28.741"></a><span id="l28.741" class="difflineminus">-  m_bytes = 0;</span>
<a href="#l28.742"></a><span id="l28.742" class="difflineminus">-  rv = m_eudora.ImportAddresses(&amp;m_bytes, &amp;abort, name.get(), inFile, pDestination, error);</span>
<a href="#l28.743"></a><span id="l28.743" class="difflineminus">-</span>
<a href="#l28.744"></a><span id="l28.744" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; error.IsEmpty())</span>
<a href="#l28.745"></a><span id="l28.745" class="difflineminus">-    ReportSuccess(name, &amp;success);</span>
<a href="#l28.746"></a><span id="l28.746" class="difflineminus">-  else</span>
<a href="#l28.747"></a><span id="l28.747" class="difflineminus">-    ImportEudoraMailImpl::ReportError(EUDORAIMPORT_ADDRESS_CONVERTERROR, name, &amp;error);</span>
<a href="#l28.748"></a><span id="l28.748" class="difflineminus">-</span>
<a href="#l28.749"></a><span id="l28.749" class="difflineminus">-  ImportEudoraMailImpl::SetLogs(success, error, pErrorLog, pSuccessLog);</span>
<a href="#l28.750"></a><span id="l28.750" class="difflineminus">-</span>
<a href="#l28.751"></a><span id="l28.751" class="difflineminus">-  IMPORT_LOG0(&quot;*** Returning from eudora address import\n&quot;);</span>
<a href="#l28.752"></a><span id="l28.752" class="difflineminus">-</span>
<a href="#l28.753"></a><span id="l28.753" class="difflineminus">-  return rv;</span>
<a href="#l28.754"></a><span id="l28.754" class="difflineminus">-}</span>
<a href="#l28.755"></a><span id="l28.755" class="difflineminus">-</span>
<a href="#l28.756"></a><span id="l28.756" class="difflineminus">-</span>
<a href="#l28.757"></a><span id="l28.757" class="difflineminus">-NS_IMETHODIMP ImportEudoraAddressImpl::GetImportProgress(uint32_t *_retval)</span>
<a href="#l28.758"></a><span id="l28.758" class="difflineminus">-{</span>
<a href="#l28.759"></a><span id="l28.759" class="difflineminus">-  NS_PRECONDITION(_retval != nullptr, &quot;null ptr&quot;);</span>
<a href="#l28.760"></a><span id="l28.760" class="difflineminus">-  if (!_retval)</span>
<a href="#l28.761"></a><span id="l28.761" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l28.762"></a><span id="l28.762" class="difflineminus">-</span>
<a href="#l28.763"></a><span id="l28.763" class="difflineminus">-  *_retval = m_bytes;</span>
<a href="#l28.764"></a><span id="l28.764" class="difflineminus">-</span>
<a href="#l28.765"></a><span id="l28.765" class="difflineminus">-  return NS_OK;</span>
<a href="#l28.766"></a><span id="l28.766" class="difflineminus">-}</span>
<a href="#l28.767"></a><span id="l28.767" class="difflineminus">-</span>
<a href="#l28.768"></a><span id="l28.768" class="difflineminus">-</span>
<a href="#l28.769"></a><span id="l28.769" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1">deleted file mode 100644</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineminus">--- a/mailnews/import/eudora/src/nsEudoraImport.h</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineplus">+++ /dev/null</span>
<a href="#l29.4"></a><span id="l29.4" class="difflineat">@@ -1,44 +0,0 @@</span>
<a href="#l29.5"></a><span id="l29.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l29.6"></a><span id="l29.6" class="difflineminus">- *</span>
<a href="#l29.7"></a><span id="l29.7" class="difflineminus">- * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l29.8"></a><span id="l29.8" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l29.9"></a><span id="l29.9" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l29.10"></a><span id="l29.10" class="difflineminus">-</span>
<a href="#l29.11"></a><span id="l29.11" class="difflineminus">-#ifndef nsEudoraImport_h___</span>
<a href="#l29.12"></a><span id="l29.12" class="difflineminus">-#define nsEudoraImport_h___</span>
<a href="#l29.13"></a><span id="l29.13" class="difflineminus">-</span>
<a href="#l29.14"></a><span id="l29.14" class="difflineminus">-#include &quot;nsIImportModule.h&quot;</span>
<a href="#l29.15"></a><span id="l29.15" class="difflineminus">-#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l29.16"></a><span id="l29.16" class="difflineminus">-</span>
<a href="#l29.17"></a><span id="l29.17" class="difflineminus">-</span>
<a href="#l29.18"></a><span id="l29.18" class="difflineminus">-#define NS_EUDORAIMPORT_CID          \</span>
<a href="#l29.19"></a><span id="l29.19" class="difflineminus">-{ /* c8448da0-8f83-11d3-a206-00a0cc26da63 */      \</span>
<a href="#l29.20"></a><span id="l29.20" class="difflineminus">-  0xc8448da0, 0x8f83, 0x11d3,            \</span>
<a href="#l29.21"></a><span id="l29.21" class="difflineminus">-  {0xa2, 0x6, 0x0, 0xa0, 0xcc, 0x26, 0xda, 0x63 }}</span>
<a href="#l29.22"></a><span id="l29.22" class="difflineminus">-</span>
<a href="#l29.23"></a><span id="l29.23" class="difflineminus">-</span>
<a href="#l29.24"></a><span id="l29.24" class="difflineminus">-</span>
<a href="#l29.25"></a><span id="l29.25" class="difflineminus">-</span>
<a href="#l29.26"></a><span id="l29.26" class="difflineminus">-#define kEudoraSupportsString NS_IMPORT_MAIL_STR &quot;,&quot; NS_IMPORT_ADDRESS_STR &quot;,&quot; NS_IMPORT_SETTINGS_STR &quot;,&quot; NS_IMPORT_FILTERS_STR</span>
<a href="#l29.27"></a><span id="l29.27" class="difflineminus">-</span>
<a href="#l29.28"></a><span id="l29.28" class="difflineminus">-class nsEudoraImport : public nsIImportModule</span>
<a href="#l29.29"></a><span id="l29.29" class="difflineminus">-{</span>
<a href="#l29.30"></a><span id="l29.30" class="difflineminus">-public:</span>
<a href="#l29.31"></a><span id="l29.31" class="difflineminus">-</span>
<a href="#l29.32"></a><span id="l29.32" class="difflineminus">-  nsEudoraImport();</span>
<a href="#l29.33"></a><span id="l29.33" class="difflineminus">-</span>
<a href="#l29.34"></a><span id="l29.34" class="difflineminus">-  NS_DECL_ISUPPORTS</span>
<a href="#l29.35"></a><span id="l29.35" class="difflineminus">-</span>
<a href="#l29.36"></a><span id="l29.36" class="difflineminus">-  ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l29.37"></a><span id="l29.37" class="difflineminus">-  // we suppport the nsIImportModule interface</span>
<a href="#l29.38"></a><span id="l29.38" class="difflineminus">-  ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l29.39"></a><span id="l29.39" class="difflineminus">-</span>
<a href="#l29.40"></a><span id="l29.40" class="difflineminus">-  NS_DECL_NSIIMPORTMODULE</span>
<a href="#l29.41"></a><span id="l29.41" class="difflineminus">-</span>
<a href="#l29.42"></a><span id="l29.42" class="difflineminus">-</span>
<a href="#l29.43"></a><span id="l29.43" class="difflineminus">-protected:</span>
<a href="#l29.44"></a><span id="l29.44" class="difflineminus">-  virtual ~nsEudoraImport();</span>
<a href="#l29.45"></a><span id="l29.45" class="difflineminus">-};</span>
<a href="#l29.46"></a><span id="l29.46" class="difflineminus">-</span>
<a href="#l29.47"></a><span id="l29.47" class="difflineminus">-</span>
<a href="#l29.48"></a><span id="l29.48" class="difflineminus">-#endif /* nsEudoraImport_h___ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1">deleted file mode 100644</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineminus">--- a/mailnews/import/eudora/src/nsEudoraMac.cpp</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineplus">+++ /dev/null</span>
<a href="#l30.4"></a><span id="l30.4" class="difflineat">@@ -1,1221 +0,0 @@</span>
<a href="#l30.5"></a><span id="l30.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l30.6"></a><span id="l30.6" class="difflineminus">- *</span>
<a href="#l30.7"></a><span id="l30.7" class="difflineminus">- * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l30.8"></a><span id="l30.8" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l30.9"></a><span id="l30.9" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l30.10"></a><span id="l30.10" class="difflineminus">-</span>
<a href="#l30.11"></a><span id="l30.11" class="difflineminus">-#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l30.12"></a><span id="l30.12" class="difflineminus">-#include &quot;nsIComponentManager.h&quot;</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineminus">-#include &quot;nsIServiceManager.h&quot;</span>
<a href="#l30.14"></a><span id="l30.14" class="difflineminus">-#include &quot;nsIMsgAccountManager.h&quot;</span>
<a href="#l30.15"></a><span id="l30.15" class="difflineminus">-#include &quot;nsIMsgAccount.h&quot;</span>
<a href="#l30.16"></a><span id="l30.16" class="difflineminus">-#include &quot;nsIMutableArray.h&quot;</span>
<a href="#l30.17"></a><span id="l30.17" class="difflineminus">-#include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l30.18"></a><span id="l30.18" class="difflineminus">-#include &quot;nsMsgCompCID.h&quot;</span>
<a href="#l30.19"></a><span id="l30.19" class="difflineminus">-#include &quot;nsISmtpService.h&quot;</span>
<a href="#l30.20"></a><span id="l30.20" class="difflineminus">-#include &quot;nsISmtpServer.h&quot;</span>
<a href="#l30.21"></a><span id="l30.21" class="difflineminus">-#include &quot;nsEudoraMac.h&quot;</span>
<a href="#l30.22"></a><span id="l30.22" class="difflineminus">-#include &quot;nsIImportService.h&quot;</span>
<a href="#l30.23"></a><span id="l30.23" class="difflineminus">-#include &quot;nsIImportMailboxDescriptor.h&quot;</span>
<a href="#l30.24"></a><span id="l30.24" class="difflineminus">-#include &quot;nsIImportABDescriptor.h&quot;</span>
<a href="#l30.25"></a><span id="l30.25" class="difflineminus">-#include &quot;nsDirectoryServiceDefs.h&quot;</span>
<a href="#l30.26"></a><span id="l30.26" class="difflineminus">-#include &quot;nsEudoraStringBundle.h&quot;</span>
<a href="#l30.27"></a><span id="l30.27" class="difflineminus">-#include &quot;nsEudoraImport.h&quot;</span>
<a href="#l30.28"></a><span id="l30.28" class="difflineminus">-#include &quot;nsIPop3IncomingServer.h&quot;</span>
<a href="#l30.29"></a><span id="l30.29" class="difflineminus">-#include &quot;nsUnicharUtils.h&quot;</span>
<a href="#l30.30"></a><span id="l30.30" class="difflineminus">-#include &quot;nsNetUtil.h&quot;</span>
<a href="#l30.31"></a><span id="l30.31" class="difflineminus">-#include &quot;EudoraDebugLog.h&quot;</span>
<a href="#l30.32"></a><span id="l30.32" class="difflineminus">-</span>
<a href="#l30.33"></a><span id="l30.33" class="difflineminus">-#include &quot;nsILocalFileMac.h&quot;</span>
<a href="#l30.34"></a><span id="l30.34" class="difflineminus">-#include &quot;nsIOutputStream.h&quot;</span>
<a href="#l30.35"></a><span id="l30.35" class="difflineminus">-</span>
<a href="#l30.36"></a><span id="l30.36" class="difflineminus">-static NS_DEFINE_IID(kISupportsIID,      NS_ISUPPORTS_IID);</span>
<a href="#l30.37"></a><span id="l30.37" class="difflineminus">-</span>
<a href="#l30.38"></a><span id="l30.38" class="difflineminus">-static const char *  kWhitespace = &quot;\b\t\r\n &quot;;</span>
<a href="#l30.39"></a><span id="l30.39" class="difflineminus">-</span>
<a href="#l30.40"></a><span id="l30.40" class="difflineminus">-nsEudoraMac::nsEudoraMac()</span>
<a href="#l30.41"></a><span id="l30.41" class="difflineminus">-{</span>
<a href="#l30.42"></a><span id="l30.42" class="difflineminus">-}</span>
<a href="#l30.43"></a><span id="l30.43" class="difflineminus">-</span>
<a href="#l30.44"></a><span id="l30.44" class="difflineminus">-nsEudoraMac::~nsEudoraMac()</span>
<a href="#l30.45"></a><span id="l30.45" class="difflineminus">-{</span>
<a href="#l30.46"></a><span id="l30.46" class="difflineminus">-}</span>
<a href="#l30.47"></a><span id="l30.47" class="difflineminus">-</span>
<a href="#l30.48"></a><span id="l30.48" class="difflineminus">-bool nsEudoraMac::FindMailFolder(nsIFile **pFolder)</span>
<a href="#l30.49"></a><span id="l30.49" class="difflineminus">-{</span>
<a href="#l30.50"></a><span id="l30.50" class="difflineminus">-  return FindEudoraLocation(pFolder);</span>
<a href="#l30.51"></a><span id="l30.51" class="difflineminus">-}</span>
<a href="#l30.52"></a><span id="l30.52" class="difflineminus">-</span>
<a href="#l30.53"></a><span id="l30.53" class="difflineminus">-bool nsEudoraMac::FindEudoraLocation(nsIFile **pFolder, bool findIni, nsIFile *pLookIn)</span>
<a href="#l30.54"></a><span id="l30.54" class="difflineminus">-{</span>
<a href="#l30.55"></a><span id="l30.55" class="difflineminus">-  bool result = false;</span>
<a href="#l30.56"></a><span id="l30.56" class="difflineminus">-  // Modern versions of Eudora make the Eudora Folder in ~/Documents</span>
<a href="#l30.57"></a><span id="l30.57" class="difflineminus">-  // The last versions that ran MacOS Classic made the Eudora folder in the user's documents folder</span>
<a href="#l30.58"></a><span id="l30.58" class="difflineminus">-  // Early versions made the Eudora Folder in the System Folder</span>
<a href="#l30.59"></a><span id="l30.59" class="difflineminus">-  // Eudora searches those three locations, earliest first (System Folder:Eudora Folder), and uses the first Eudora Folder</span>
<a href="#l30.60"></a><span id="l30.60" class="difflineminus">-  // it finds.  However, it's not clear that any version of OSX can actually *find* the Classic &quot;Documents&quot; folder,</span>
<a href="#l30.61"></a><span id="l30.61" class="difflineminus">-  // even if there was one before the machine was updated to OSX.</span>
<a href="#l30.62"></a><span id="l30.62" class="difflineminus">-  // The name &quot;Eudora Folder&quot; should not be localized.  Early localized versions of Eudora did localize the name; later</span>
<a href="#l30.63"></a><span id="l30.63" class="difflineminus">-  // localized versions looked for the localized name and changed it back.  We will therefore not</span>
<a href="#l30.64"></a><span id="l30.64" class="difflineminus">-  // worry about the folder name being localized.  Japan may be an issue, though.</span>
<a href="#l30.65"></a><span id="l30.65" class="difflineminus">-  // SD 11/2006</span>
<a href="#l30.66"></a><span id="l30.66" class="difflineminus">-</span>
<a href="#l30.67"></a><span id="l30.67" class="difflineminus">-  if (!pLookIn)</span>
<a href="#l30.68"></a><span id="l30.68" class="difflineminus">-  {</span>
<a href="#l30.69"></a><span id="l30.69" class="difflineminus">-    result = FindEudoraLocation(pFolder, findIni, NS_OS_SYSTEM_DIR);</span>
<a href="#l30.70"></a><span id="l30.70" class="difflineminus">-    if (!result)</span>
<a href="#l30.71"></a><span id="l30.71" class="difflineminus">-    {</span>
<a href="#l30.72"></a><span id="l30.72" class="difflineminus">-      result = FindEudoraLocation(pFolder, findIni, NS_MAC_DOCUMENTS_DIR);</span>
<a href="#l30.73"></a><span id="l30.73" class="difflineminus">-      if (!result)</span>
<a href="#l30.74"></a><span id="l30.74" class="difflineminus">-        result = FindEudoraLocation(pFolder, findIni, NS_OSX_USER_DOCUMENTS_DIR);</span>
<a href="#l30.75"></a><span id="l30.75" class="difflineminus">-    }</span>
<a href="#l30.76"></a><span id="l30.76" class="difflineminus">-  }</span>
<a href="#l30.77"></a><span id="l30.77" class="difflineminus">-  else</span>
<a href="#l30.78"></a><span id="l30.78" class="difflineminus">-  {</span>
<a href="#l30.79"></a><span id="l30.79" class="difflineminus">-    *pFolder = pLookIn;</span>
<a href="#l30.80"></a><span id="l30.80" class="difflineminus">-    result = VerifyEudoraLocation(pFolder, findIni);</span>
<a href="#l30.81"></a><span id="l30.81" class="difflineminus">-  }</span>
<a href="#l30.82"></a><span id="l30.82" class="difflineminus">-</span>
<a href="#l30.83"></a><span id="l30.83" class="difflineminus">-  return result;</span>
<a href="#l30.84"></a><span id="l30.84" class="difflineminus">-}</span>
<a href="#l30.85"></a><span id="l30.85" class="difflineminus">-</span>
<a href="#l30.86"></a><span id="l30.86" class="difflineminus">-bool nsEudoraMac::FindEudoraLocation(nsIFile **pFolder, bool findIni, const char *specialDirName)</span>
<a href="#l30.87"></a><span id="l30.87" class="difflineminus">-{</span>
<a href="#l30.88"></a><span id="l30.88" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; searchDir;</span>
<a href="#l30.89"></a><span id="l30.89" class="difflineminus">-  nsresult rv = NS_GetSpecialDirectory(specialDirName, getter_AddRefs(searchDir));</span>
<a href="#l30.90"></a><span id="l30.90" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l30.91"></a><span id="l30.91" class="difflineminus">-    return false;</span>
<a href="#l30.92"></a><span id="l30.92" class="difflineminus">-</span>
<a href="#l30.93"></a><span id="l30.93" class="difflineminus">-  // Turn it into a mac file, so we can resolve aliases</span>
<a href="#l30.94"></a><span id="l30.94" class="difflineminus">-  nsCOMPtr&lt;nsILocalFileMac&gt; macFile = do_QueryInterface(searchDir);</span>
<a href="#l30.95"></a><span id="l30.95" class="difflineminus">-  if (!macFile)</span>
<a href="#l30.96"></a><span id="l30.96" class="difflineminus">-    return false;</span>
<a href="#l30.97"></a><span id="l30.97" class="difflineminus">-  macFile-&gt;SetFollowLinks(true);</span>
<a href="#l30.98"></a><span id="l30.98" class="difflineminus">-</span>
<a href="#l30.99"></a><span id="l30.99" class="difflineminus">-  // It's always called &quot;Eudora Folder&quot;, so add that to the path</span>
<a href="#l30.100"></a><span id="l30.100" class="difflineminus">-  macFile-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;Eudora Folder&quot; ));</span>
<a href="#l30.101"></a><span id="l30.101" class="difflineminus">-</span>
<a href="#l30.102"></a><span id="l30.102" class="difflineminus">-  // If it's an alias, the &quot;target&quot; will be the real file.  Fetch this as a string</span>
<a href="#l30.103"></a><span id="l30.103" class="difflineminus">-  // and set is back as the file</span>
<a href="#l30.104"></a><span id="l30.104" class="difflineminus">-  nsCString path;</span>
<a href="#l30.105"></a><span id="l30.105" class="difflineminus">-  macFile-&gt;GetNativeTarget(path);</span>
<a href="#l30.106"></a><span id="l30.106" class="difflineminus">-  macFile-&gt;InitWithNativePath(path);</span>
<a href="#l30.107"></a><span id="l30.107" class="difflineminus">-</span>
<a href="#l30.108"></a><span id="l30.108" class="difflineminus">-  // Resolve any unix-style symlinks (this won't do MacOS aliases, hence the machinations above)</span>
<a href="#l30.109"></a><span id="l30.109" class="difflineminus">-  bool link = false;</span>
<a href="#l30.110"></a><span id="l30.110" class="difflineminus">-  rv = searchDir-&gt;IsSymlink(&amp;link);</span>
<a href="#l30.111"></a><span id="l30.111" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; link)</span>
<a href="#l30.112"></a><span id="l30.112" class="difflineminus">-  {</span>
<a href="#l30.113"></a><span id="l30.113" class="difflineminus">-    rv = macFile-&gt;SetFollowLinks(true);</span>
<a href="#l30.114"></a><span id="l30.114" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l30.115"></a><span id="l30.115" class="difflineminus">-      return false;</span>
<a href="#l30.116"></a><span id="l30.116" class="difflineminus">-  }</span>
<a href="#l30.117"></a><span id="l30.117" class="difflineminus">-</span>
<a href="#l30.118"></a><span id="l30.118" class="difflineminus">-  // Check for existence and directoriness</span>
<a href="#l30.119"></a><span id="l30.119" class="difflineminus">-  bool exists = false;</span>
<a href="#l30.120"></a><span id="l30.120" class="difflineminus">-  rv = searchDir-&gt;Exists(&amp;exists);</span>
<a href="#l30.121"></a><span id="l30.121" class="difflineminus">-  bool isFolder = false;</span>
<a href="#l30.122"></a><span id="l30.122" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; exists)</span>
<a href="#l30.123"></a><span id="l30.123" class="difflineminus">-    rv = searchDir-&gt;IsDirectory(&amp;isFolder);</span>
<a href="#l30.124"></a><span id="l30.124" class="difflineminus">-  if (!exists || !isFolder)</span>
<a href="#l30.125"></a><span id="l30.125" class="difflineminus">-    return false;</span>
<a href="#l30.126"></a><span id="l30.126" class="difflineminus">-</span>
<a href="#l30.127"></a><span id="l30.127" class="difflineminus">-  NS_IF_ADDREF(*pFolder = searchDir);</span>
<a href="#l30.128"></a><span id="l30.128" class="difflineminus">-</span>
<a href="#l30.129"></a><span id="l30.129" class="difflineminus">-  return true;</span>
<a href="#l30.130"></a><span id="l30.130" class="difflineminus">-}</span>
<a href="#l30.131"></a><span id="l30.131" class="difflineminus">-</span>
<a href="#l30.132"></a><span id="l30.132" class="difflineminus">-bool nsEudoraMac::VerifyEudoraLocation(nsIFile **pFolder, bool findIni)</span>
<a href="#l30.133"></a><span id="l30.133" class="difflineminus">-{</span>
<a href="#l30.134"></a><span id="l30.134" class="difflineminus">-  bool result = false;</span>
<a href="#l30.135"></a><span id="l30.135" class="difflineminus">-  bool foundPref = false;</span>
<a href="#l30.136"></a><span id="l30.136" class="difflineminus">-</span>
<a href="#l30.137"></a><span id="l30.137" class="difflineminus">-</span>
<a href="#l30.138"></a><span id="l30.138" class="difflineminus">-  bool hasMore;</span>
<a href="#l30.139"></a><span id="l30.139" class="difflineminus">-  nsCOMPtr&lt;nsISimpleEnumerator&gt; directoryEnumerator;</span>
<a href="#l30.140"></a><span id="l30.140" class="difflineminus">-  nsresult rv = (*pFolder)-&gt;GetDirectoryEntries(getter_AddRefs(directoryEnumerator));</span>
<a href="#l30.141"></a><span id="l30.141" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l30.142"></a><span id="l30.142" class="difflineminus">-</span>
<a href="#l30.143"></a><span id="l30.143" class="difflineminus">-  directoryEnumerator-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l30.144"></a><span id="l30.144" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; prefFile;</span>
<a href="#l30.145"></a><span id="l30.145" class="difflineminus">-</span>
<a href="#l30.146"></a><span id="l30.146" class="difflineminus">-  int count = 0;</span>
<a href="#l30.147"></a><span id="l30.147" class="difflineminus">-  OSType type, creator;</span>
<a href="#l30.148"></a><span id="l30.148" class="difflineminus">-  while (hasMore &amp;&amp; NS_SUCCEEDED(rv) &amp;&amp; count &lt; 2)</span>
<a href="#l30.149"></a><span id="l30.149" class="difflineminus">-  {</span>
<a href="#l30.150"></a><span id="l30.150" class="difflineminus">-    nsCOMPtr&lt;nsISupports&gt; aSupport;</span>
<a href="#l30.151"></a><span id="l30.151" class="difflineminus">-    rv = directoryEnumerator-&gt;GetNext(getter_AddRefs(aSupport));</span>
<a href="#l30.152"></a><span id="l30.152" class="difflineminus">-    nsCOMPtr&lt;nsIFile&gt; entry(do_QueryInterface(aSupport, &amp;rv));</span>
<a href="#l30.153"></a><span id="l30.153" class="difflineminus">-    directoryEnumerator-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l30.154"></a><span id="l30.154" class="difflineminus">-</span>
<a href="#l30.155"></a><span id="l30.155" class="difflineminus">-</span>
<a href="#l30.156"></a><span id="l30.156" class="difflineminus">-    // find a file with TEXT, CSOm that isn't the nicknames file</span>
<a href="#l30.157"></a><span id="l30.157" class="difflineminus">-    // or just cheat and look for more than 1 file?</span>
<a href="#l30.158"></a><span id="l30.158" class="difflineminus">-    {</span>
<a href="#l30.159"></a><span id="l30.159" class="difflineminus">-      nsCOMPtr&lt;nsILocalFileMac&gt; macFile = do_QueryInterface(entry, &amp;rv);</span>
<a href="#l30.160"></a><span id="l30.160" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l30.161"></a><span id="l30.161" class="difflineminus">-      {</span>
<a href="#l30.162"></a><span id="l30.162" class="difflineminus">-        macFile-&gt;GetFileCreator(&amp;creator);</span>
<a href="#l30.163"></a><span id="l30.163" class="difflineminus">-        macFile-&gt;GetFileType(&amp;type);</span>
<a href="#l30.164"></a><span id="l30.164" class="difflineminus">-      }</span>
<a href="#l30.165"></a><span id="l30.165" class="difflineminus">-    }</span>
<a href="#l30.166"></a><span id="l30.166" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l30.167"></a><span id="l30.167" class="difflineminus">-    {</span>
<a href="#l30.168"></a><span id="l30.168" class="difflineminus">-      if ((type == 'TEXT') &amp;&amp; (creator == 'CSOm'))</span>
<a href="#l30.169"></a><span id="l30.169" class="difflineminus">-        count++;</span>
<a href="#l30.170"></a><span id="l30.170" class="difflineminus">-      else if ((type == 'PREF') &amp;&amp; (creator == 'CSOm'))</span>
<a href="#l30.171"></a><span id="l30.171" class="difflineminus">-      {</span>
<a href="#l30.172"></a><span id="l30.172" class="difflineminus">-        if (!foundPref)</span>
<a href="#l30.173"></a><span id="l30.173" class="difflineminus">-        {</span>
<a href="#l30.174"></a><span id="l30.174" class="difflineminus">-          prefFile = entry;</span>
<a href="#l30.175"></a><span id="l30.175" class="difflineminus">-          foundPref = true;</span>
<a href="#l30.176"></a><span id="l30.176" class="difflineminus">-        }</span>
<a href="#l30.177"></a><span id="l30.177" class="difflineminus">-        else</span>
<a href="#l30.178"></a><span id="l30.178" class="difflineminus">-        {</span>
<a href="#l30.179"></a><span id="l30.179" class="difflineminus">-          // does one of them end in &quot;.bkup&quot;?</span>
<a href="#l30.180"></a><span id="l30.180" class="difflineminus">-          nsCString leafName;</span>
<a href="#l30.181"></a><span id="l30.181" class="difflineminus">-          entry-&gt;GetNativeLeafName(leafName);</span>
<a href="#l30.182"></a><span id="l30.182" class="difflineminus">-          bool isBk = false;</span>
<a href="#l30.183"></a><span id="l30.183" class="difflineminus">-          isBk = StringEndsWith(leafName, NS_LITERAL_CSTRING(&quot;.bkup&quot;));</span>
<a href="#l30.184"></a><span id="l30.184" class="difflineminus">-          if (!isBk)</span>
<a href="#l30.185"></a><span id="l30.185" class="difflineminus">-          {</span>
<a href="#l30.186"></a><span id="l30.186" class="difflineminus">-            prefFile-&gt;GetNativeLeafName(leafName);</span>
<a href="#l30.187"></a><span id="l30.187" class="difflineminus">-            isBk = StringEndsWith(leafName, NS_LITERAL_CSTRING(&quot;.bkup&quot;));</span>
<a href="#l30.188"></a><span id="l30.188" class="difflineminus">-            if (isBk)</span>
<a href="#l30.189"></a><span id="l30.189" class="difflineminus">-              prefFile = entry;</span>
<a href="#l30.190"></a><span id="l30.190" class="difflineminus">-            else</span>
<a href="#l30.191"></a><span id="l30.191" class="difflineminus">-            {</span>
<a href="#l30.192"></a><span id="l30.192" class="difflineminus">-              // Neither of the pref files was named .bkup</span>
<a href="#l30.193"></a><span id="l30.193" class="difflineminus">-              // Pick the newest one?</span>
<a href="#l30.194"></a><span id="l30.194" class="difflineminus">-              int64_t modDate1, modDate2;</span>
<a href="#l30.195"></a><span id="l30.195" class="difflineminus">-</span>
<a href="#l30.196"></a><span id="l30.196" class="difflineminus">-              entry-&gt;GetLastModifiedTime(&amp;modDate2);</span>
<a href="#l30.197"></a><span id="l30.197" class="difflineminus">-              prefFile-&gt;GetLastModifiedTime(&amp;modDate1);</span>
<a href="#l30.198"></a><span id="l30.198" class="difflineminus">-              if (modDate2 &gt; modDate1)</span>
<a href="#l30.199"></a><span id="l30.199" class="difflineminus">-                prefFile = entry;</span>
<a href="#l30.200"></a><span id="l30.200" class="difflineminus">-            }</span>
<a href="#l30.201"></a><span id="l30.201" class="difflineminus">-          }</span>
<a href="#l30.202"></a><span id="l30.202" class="difflineminus">-        }</span>
<a href="#l30.203"></a><span id="l30.203" class="difflineminus">-      }</span>
<a href="#l30.204"></a><span id="l30.204" class="difflineminus">-    }</span>
<a href="#l30.205"></a><span id="l30.205" class="difflineminus">-  }</span>
<a href="#l30.206"></a><span id="l30.206" class="difflineminus">-  if (count &gt;= 2)</span>
<a href="#l30.207"></a><span id="l30.207" class="difflineminus">-    result = true;</span>
<a href="#l30.208"></a><span id="l30.208" class="difflineminus">-</span>
<a href="#l30.209"></a><span id="l30.209" class="difflineminus">-  if (!findIni)</span>
<a href="#l30.210"></a><span id="l30.210" class="difflineminus">-    return result;</span>
<a href="#l30.211"></a><span id="l30.211" class="difflineminus">-</span>
<a href="#l30.212"></a><span id="l30.212" class="difflineminus">-  if (!foundPref)</span>
<a href="#l30.213"></a><span id="l30.213" class="difflineminus">-    return false;</span>
<a href="#l30.214"></a><span id="l30.214" class="difflineminus">-</span>
<a href="#l30.215"></a><span id="l30.215" class="difflineminus">-  NS_IF_ADDREF(*pFolder = prefFile);</span>
<a href="#l30.216"></a><span id="l30.216" class="difflineminus">-</span>
<a href="#l30.217"></a><span id="l30.217" class="difflineminus">-  return true;</span>
<a href="#l30.218"></a><span id="l30.218" class="difflineminus">-}</span>
<a href="#l30.219"></a><span id="l30.219" class="difflineminus">-</span>
<a href="#l30.220"></a><span id="l30.220" class="difflineminus">-</span>
<a href="#l30.221"></a><span id="l30.221" class="difflineminus">-nsresult nsEudoraMac::FindMailboxes(nsIFile *pRoot, nsIMutableArray *pArray)</span>
<a href="#l30.222"></a><span id="l30.222" class="difflineminus">-{</span>
<a href="#l30.223"></a><span id="l30.223" class="difflineminus">-  nsresult rv;</span>
<a href="#l30.224"></a><span id="l30.224" class="difflineminus">-  nsCOMPtr&lt;nsIImportService&gt; impSvc(do_GetService(NS_IMPORTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l30.225"></a><span id="l30.225" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l30.226"></a><span id="l30.226" class="difflineminus">-    return rv;</span>
<a href="#l30.227"></a><span id="l30.227" class="difflineminus">-</span>
<a href="#l30.228"></a><span id="l30.228" class="difflineminus">-  m_depth = 0;</span>
<a href="#l30.229"></a><span id="l30.229" class="difflineminus">-  m_mailImportLocation = do_QueryInterface(pRoot);</span>
<a href="#l30.230"></a><span id="l30.230" class="difflineminus">-</span>
<a href="#l30.231"></a><span id="l30.231" class="difflineminus">-  return ScanMailDir(pRoot, pArray, impSvc);</span>
<a href="#l30.232"></a><span id="l30.232" class="difflineminus">-}</span>
<a href="#l30.233"></a><span id="l30.233" class="difflineminus">-</span>
<a href="#l30.234"></a><span id="l30.234" class="difflineminus">-</span>
<a href="#l30.235"></a><span id="l30.235" class="difflineminus">-nsresult nsEudoraMac::ScanMailDir(nsIFile *pFolder, nsIMutableArray *pArray, nsIImportService *pImport)</span>
<a href="#l30.236"></a><span id="l30.236" class="difflineminus">-{</span>
<a href="#l30.237"></a><span id="l30.237" class="difflineminus">-</span>
<a href="#l30.238"></a><span id="l30.238" class="difflineminus">-  // On Windows, we look for a descmap file but on Mac we just iterate</span>
<a href="#l30.239"></a><span id="l30.239" class="difflineminus">-  // the directory</span>
<a href="#l30.240"></a><span id="l30.240" class="difflineminus">-</span>
<a href="#l30.241"></a><span id="l30.241" class="difflineminus">-  m_depth++;</span>
<a href="#l30.242"></a><span id="l30.242" class="difflineminus">-</span>
<a href="#l30.243"></a><span id="l30.243" class="difflineminus">-  nsresult rv = IterateMailDir(pFolder, pArray, pImport);</span>
<a href="#l30.244"></a><span id="l30.244" class="difflineminus">-</span>
<a href="#l30.245"></a><span id="l30.245" class="difflineminus">-  m_depth--;</span>
<a href="#l30.246"></a><span id="l30.246" class="difflineminus">-</span>
<a href="#l30.247"></a><span id="l30.247" class="difflineminus">-  return rv;</span>
<a href="#l30.248"></a><span id="l30.248" class="difflineminus">-}</span>
<a href="#l30.249"></a><span id="l30.249" class="difflineminus">-</span>
<a href="#l30.250"></a><span id="l30.250" class="difflineminus">-nsresult nsEudoraMac::IterateMailDir(nsIFile *pFolder, nsIMutableArray *pArray, nsIImportService *pImport)</span>
<a href="#l30.251"></a><span id="l30.251" class="difflineminus">-{</span>
<a href="#l30.252"></a><span id="l30.252" class="difflineminus">-  bool hasMore;</span>
<a href="#l30.253"></a><span id="l30.253" class="difflineminus">-  nsCOMPtr&lt;nsISimpleEnumerator&gt; directoryEnumerator;</span>
<a href="#l30.254"></a><span id="l30.254" class="difflineminus">-  nsresult rv = pFolder-&gt;GetDirectoryEntries(getter_AddRefs(directoryEnumerator));</span>
<a href="#l30.255"></a><span id="l30.255" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.256"></a><span id="l30.256" class="difflineminus">-</span>
<a href="#l30.257"></a><span id="l30.257" class="difflineminus">-  directoryEnumerator-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l30.258"></a><span id="l30.258" class="difflineminus">-</span>
<a href="#l30.259"></a><span id="l30.259" class="difflineminus">-  while (hasMore &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l30.260"></a><span id="l30.260" class="difflineminus">-  {</span>
<a href="#l30.261"></a><span id="l30.261" class="difflineminus">-    nsCOMPtr&lt;nsISupports&gt; aSupport;</span>
<a href="#l30.262"></a><span id="l30.262" class="difflineminus">-    rv = directoryEnumerator-&gt;GetNext(getter_AddRefs(aSupport));</span>
<a href="#l30.263"></a><span id="l30.263" class="difflineminus">-    nsCOMPtr&lt;nsIFile&gt; entry(do_QueryInterface(aSupport, &amp;rv));</span>
<a href="#l30.264"></a><span id="l30.264" class="difflineminus">-    directoryEnumerator-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l30.265"></a><span id="l30.265" class="difflineminus">-</span>
<a href="#l30.266"></a><span id="l30.266" class="difflineminus">-    bool isFolder;</span>
<a href="#l30.267"></a><span id="l30.267" class="difflineminus">-    bool isFile;</span>
<a href="#l30.268"></a><span id="l30.268" class="difflineminus">-    nsCString fName;</span>
<a href="#l30.269"></a><span id="l30.269" class="difflineminus">-    nsCString ext;</span>
<a href="#l30.270"></a><span id="l30.270" class="difflineminus">-    nsCString name;</span>
<a href="#l30.271"></a><span id="l30.271" class="difflineminus">-    OSType type;</span>
<a href="#l30.272"></a><span id="l30.272" class="difflineminus">-    OSType creator;</span>
<a href="#l30.273"></a><span id="l30.273" class="difflineminus">-</span>
<a href="#l30.274"></a><span id="l30.274" class="difflineminus">-    isFolder = false;</span>
<a href="#l30.275"></a><span id="l30.275" class="difflineminus">-    isFile = false;</span>
<a href="#l30.276"></a><span id="l30.276" class="difflineminus">-    rv = entry-&gt;IsDirectory(&amp;isFolder);</span>
<a href="#l30.277"></a><span id="l30.277" class="difflineminus">-    rv = entry-&gt;IsFile(&amp;isFile);</span>
<a href="#l30.278"></a><span id="l30.278" class="difflineminus">-    rv = entry-&gt;GetNativeLeafName(fName);</span>
<a href="#l30.279"></a><span id="l30.279" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; !fName.IsEmpty())</span>
<a href="#l30.280"></a><span id="l30.280" class="difflineminus">-    {</span>
<a href="#l30.281"></a><span id="l30.281" class="difflineminus">-      if (isFolder)</span>
<a href="#l30.282"></a><span id="l30.282" class="difflineminus">-      {</span>
<a href="#l30.283"></a><span id="l30.283" class="difflineminus">-        if (IsValidMailFolderName(fName))</span>
<a href="#l30.284"></a><span id="l30.284" class="difflineminus">-        {</span>
<a href="#l30.285"></a><span id="l30.285" class="difflineminus">-          rv = FoundMailFolder(entry, fName.get(), pArray, pImport);</span>
<a href="#l30.286"></a><span id="l30.286" class="difflineminus">-          if (NS_SUCCEEDED(rv))</span>
<a href="#l30.287"></a><span id="l30.287" class="difflineminus">-          {</span>
<a href="#l30.288"></a><span id="l30.288" class="difflineminus">-            rv = ScanMailDir(entry, pArray, pImport);</span>
<a href="#l30.289"></a><span id="l30.289" class="difflineminus">-            if (NS_FAILED(rv))</span>
<a href="#l30.290"></a><span id="l30.290" class="difflineminus">-              IMPORT_LOG0(&quot;*** Error scanning mail directory\n&quot;);</span>
<a href="#l30.291"></a><span id="l30.291" class="difflineminus">-          }</span>
<a href="#l30.292"></a><span id="l30.292" class="difflineminus">-        }</span>
<a href="#l30.293"></a><span id="l30.293" class="difflineminus">-      }</span>
<a href="#l30.294"></a><span id="l30.294" class="difflineminus">-      else if (isFile)</span>
<a href="#l30.295"></a><span id="l30.295" class="difflineminus">-      {</span>
<a href="#l30.296"></a><span id="l30.296" class="difflineminus">-        type = 0;</span>
<a href="#l30.297"></a><span id="l30.297" class="difflineminus">-        creator = 0;</span>
<a href="#l30.298"></a><span id="l30.298" class="difflineminus">-        {</span>
<a href="#l30.299"></a><span id="l30.299" class="difflineminus">-          nsCOMPtr&lt;nsILocalFileMac&gt; macFile = do_QueryInterface(entry, &amp;rv);</span>
<a href="#l30.300"></a><span id="l30.300" class="difflineminus">-          if (NS_SUCCEEDED(rv))</span>
<a href="#l30.301"></a><span id="l30.301" class="difflineminus">-          {</span>
<a href="#l30.302"></a><span id="l30.302" class="difflineminus">-            macFile-&gt;GetFileCreator(&amp;creator);</span>
<a href="#l30.303"></a><span id="l30.303" class="difflineminus">-            macFile-&gt;GetFileType(&amp;type);</span>
<a href="#l30.304"></a><span id="l30.304" class="difflineminus">-          }</span>
<a href="#l30.305"></a><span id="l30.305" class="difflineminus">-        }</span>
<a href="#l30.306"></a><span id="l30.306" class="difflineminus">-        if ((type == 'TEXT') &amp;&amp; IsValidMailboxName(fName) &amp;&amp; IsValidMailboxFile(entry))</span>
<a href="#l30.307"></a><span id="l30.307" class="difflineminus">-          rv = FoundMailbox(entry, fName.get(), pArray, pImport);</span>
<a href="#l30.308"></a><span id="l30.308" class="difflineminus">-      }</span>
<a href="#l30.309"></a><span id="l30.309" class="difflineminus">-    }</span>
<a href="#l30.310"></a><span id="l30.310" class="difflineminus">-  }</span>
<a href="#l30.311"></a><span id="l30.311" class="difflineminus">-  return rv;</span>
<a href="#l30.312"></a><span id="l30.312" class="difflineminus">-}</span>
<a href="#l30.313"></a><span id="l30.313" class="difflineminus">-</span>
<a href="#l30.314"></a><span id="l30.314" class="difflineminus">-</span>
<a href="#l30.315"></a><span id="l30.315" class="difflineminus">-nsresult nsEudoraMac::FoundMailbox(nsIFile *mailFile, const char *pName, nsIMutableArray *pArray, nsIImportService *pImport)</span>
<a href="#l30.316"></a><span id="l30.316" class="difflineminus">-{</span>
<a href="#l30.317"></a><span id="l30.317" class="difflineminus">-  nsAutoString              displayName;</span>
<a href="#l30.318"></a><span id="l30.318" class="difflineminus">-  nsCOMPtr&lt;nsIImportMailboxDescriptor&gt;  desc;</span>
<a href="#l30.319"></a><span id="l30.319" class="difflineminus">-  nsISupports *              pInterface;</span>
<a href="#l30.320"></a><span id="l30.320" class="difflineminus">-</span>
<a href="#l30.321"></a><span id="l30.321" class="difflineminus">-  NS_CopyNativeToUnicode(nsDependentCString(pName), displayName);</span>
<a href="#l30.322"></a><span id="l30.322" class="difflineminus">-</span>
<a href="#l30.323"></a><span id="l30.323" class="difflineminus">-#ifdef IMPORT_DEBUG</span>
<a href="#l30.324"></a><span id="l30.324" class="difflineminus">-  nsCString path;</span>
<a href="#l30.325"></a><span id="l30.325" class="difflineminus">-  mailFile-&gt;GetNativePath(path);</span>
<a href="#l30.326"></a><span id="l30.326" class="difflineminus">-  if (!path.IsEmpty())</span>
<a href="#l30.327"></a><span id="l30.327" class="difflineminus">-    IMPORT_LOG2(&quot;Found eudora mailbox, %s: %s\n&quot;, path.get(), pName);</span>
<a href="#l30.328"></a><span id="l30.328" class="difflineminus">-  else</span>
<a href="#l30.329"></a><span id="l30.329" class="difflineminus">-    IMPORT_LOG1(&quot;Found eudora mailbox, %s\n&quot;, pName);</span>
<a href="#l30.330"></a><span id="l30.330" class="difflineminus">-  IMPORT_LOG1(&quot;\tm_depth = %d\n&quot;, (int)m_depth);</span>
<a href="#l30.331"></a><span id="l30.331" class="difflineminus">-#endif</span>
<a href="#l30.332"></a><span id="l30.332" class="difflineminus">-</span>
<a href="#l30.333"></a><span id="l30.333" class="difflineminus">-  nsresult rv = pImport-&gt;CreateNewMailboxDescriptor(getter_AddRefs(desc));</span>
<a href="#l30.334"></a><span id="l30.334" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l30.335"></a><span id="l30.335" class="difflineminus">-  {</span>
<a href="#l30.336"></a><span id="l30.336" class="difflineminus">-    int64_t    sz = 0;</span>
<a href="#l30.337"></a><span id="l30.337" class="difflineminus">-    mailFile-&gt;GetFileSize(&amp;sz);</span>
<a href="#l30.338"></a><span id="l30.338" class="difflineminus">-    desc-&gt;SetDisplayName(displayName.get());</span>
<a href="#l30.339"></a><span id="l30.339" class="difflineminus">-    desc-&gt;SetDepth(m_depth);</span>
<a href="#l30.340"></a><span id="l30.340" class="difflineminus">-    nsCOMPtr &lt;nsIFile&gt; pLocalFile;</span>
<a href="#l30.341"></a><span id="l30.341" class="difflineminus">-    desc-&gt;GetFile(getter_AddRefs(pLocalFile));</span>
<a href="#l30.342"></a><span id="l30.342" class="difflineminus">-    if (pLocalFile)</span>
<a href="#l30.343"></a><span id="l30.343" class="difflineminus">-    {</span>
<a href="#l30.344"></a><span id="l30.344" class="difflineminus">-      pLocalFile-&gt;InitWithFile(mailFile);</span>
<a href="#l30.345"></a><span id="l30.345" class="difflineminus">-    }</span>
<a href="#l30.346"></a><span id="l30.346" class="difflineminus">-    rv = desc-&gt;QueryInterface(kISupportsIID, (void **) &amp;pInterface);</span>
<a href="#l30.347"></a><span id="l30.347" class="difflineminus">-    pArray-&gt;AppendElement(pInterface, false);</span>
<a href="#l30.348"></a><span id="l30.348" class="difflineminus">-    pInterface-&gt;Release();</span>
<a href="#l30.349"></a><span id="l30.349" class="difflineminus">-  }</span>
<a href="#l30.350"></a><span id="l30.350" class="difflineminus">-</span>
<a href="#l30.351"></a><span id="l30.351" class="difflineminus">-  return NS_OK;</span>
<a href="#l30.352"></a><span id="l30.352" class="difflineminus">-}</span>
<a href="#l30.353"></a><span id="l30.353" class="difflineminus">-</span>
<a href="#l30.354"></a><span id="l30.354" class="difflineminus">-</span>
<a href="#l30.355"></a><span id="l30.355" class="difflineminus">-nsresult nsEudoraMac::FoundMailFolder(nsIFile *mailFolder, const char *pName, nsIMutableArray *pArray, nsIImportService *pImport)</span>
<a href="#l30.356"></a><span id="l30.356" class="difflineminus">-{</span>
<a href="#l30.357"></a><span id="l30.357" class="difflineminus">-  nsAutoString          displayName;</span>
<a href="#l30.358"></a><span id="l30.358" class="difflineminus">-  nsCOMPtr&lt;nsIImportMailboxDescriptor&gt;  desc;</span>
<a href="#l30.359"></a><span id="l30.359" class="difflineminus">-  nsISupports *              pInterface;</span>
<a href="#l30.360"></a><span id="l30.360" class="difflineminus">-</span>
<a href="#l30.361"></a><span id="l30.361" class="difflineminus">-  NS_CopyNativeToUnicode(nsDependentCString(pName), displayName);</span>
<a href="#l30.362"></a><span id="l30.362" class="difflineminus">-</span>
<a href="#l30.363"></a><span id="l30.363" class="difflineminus">-#ifdef IMPORT_DEBUG</span>
<a href="#l30.364"></a><span id="l30.364" class="difflineminus">-  nsCString path;</span>
<a href="#l30.365"></a><span id="l30.365" class="difflineminus">-  mailFolder-&gt;GetNativePath(path);</span>
<a href="#l30.366"></a><span id="l30.366" class="difflineminus">-  if (!path.IsEmpty())</span>
<a href="#l30.367"></a><span id="l30.367" class="difflineminus">-    IMPORT_LOG2(&quot;Found eudora folder, %s: %s\n&quot;,path.get(), pName);</span>
<a href="#l30.368"></a><span id="l30.368" class="difflineminus">-  else</span>
<a href="#l30.369"></a><span id="l30.369" class="difflineminus">-    IMPORT_LOG1(&quot;Found eudora folder, %s\n&quot;, pName);</span>
<a href="#l30.370"></a><span id="l30.370" class="difflineminus">-  IMPORT_LOG1(&quot;\tm_depth = %d\n&quot;, (int)m_depth);</span>
<a href="#l30.371"></a><span id="l30.371" class="difflineminus">-#endif</span>
<a href="#l30.372"></a><span id="l30.372" class="difflineminus">-</span>
<a href="#l30.373"></a><span id="l30.373" class="difflineminus">-  nsresult rv = pImport-&gt;CreateNewMailboxDescriptor(getter_AddRefs(desc));</span>
<a href="#l30.374"></a><span id="l30.374" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l30.375"></a><span id="l30.375" class="difflineminus">-  {</span>
<a href="#l30.376"></a><span id="l30.376" class="difflineminus">-    int64_t    sz = 0;</span>
<a href="#l30.377"></a><span id="l30.377" class="difflineminus">-    desc-&gt;SetDisplayName(displayName.get());</span>
<a href="#l30.378"></a><span id="l30.378" class="difflineminus">-    desc-&gt;SetDepth(m_depth);</span>
<a href="#l30.379"></a><span id="l30.379" class="difflineminus">-    desc-&gt;SetSize(sz);</span>
<a href="#l30.380"></a><span id="l30.380" class="difflineminus">-    nsCOMPtr &lt;nsIFile&gt; pFile;</span>
<a href="#l30.381"></a><span id="l30.381" class="difflineminus">-    desc-&gt;GetFile(getter_AddRefs(pFile));</span>
<a href="#l30.382"></a><span id="l30.382" class="difflineminus">-    if (pFile)</span>
<a href="#l30.383"></a><span id="l30.383" class="difflineminus">-      pFile-&gt;InitWithFile(mailFolder);</span>
<a href="#l30.384"></a><span id="l30.384" class="difflineminus">-    rv = desc-&gt;QueryInterface(kISupportsIID, (void **) &amp;pInterface);</span>
<a href="#l30.385"></a><span id="l30.385" class="difflineminus">-    pArray-&gt;AppendElement(pInterface, false);</span>
<a href="#l30.386"></a><span id="l30.386" class="difflineminus">-    pInterface-&gt;Release();</span>
<a href="#l30.387"></a><span id="l30.387" class="difflineminus">-  }</span>
<a href="#l30.388"></a><span id="l30.388" class="difflineminus">-</span>
<a href="#l30.389"></a><span id="l30.389" class="difflineminus">-  return NS_OK;</span>
<a href="#l30.390"></a><span id="l30.390" class="difflineminus">-}</span>
<a href="#l30.391"></a><span id="l30.391" class="difflineminus">-</span>
<a href="#l30.392"></a><span id="l30.392" class="difflineminus">-bool nsEudoraMac::CreateTocFromResource(nsIFile *pMail, nsIFile **pToc)</span>
<a href="#l30.393"></a><span id="l30.393" class="difflineminus">-{</span>
<a href="#l30.394"></a><span id="l30.394" class="difflineminus">-  ResFileRefNum resFile = -1;</span>
<a href="#l30.395"></a><span id="l30.395" class="difflineminus">-</span>
<a href="#l30.396"></a><span id="l30.396" class="difflineminus">-  {</span>
<a href="#l30.397"></a><span id="l30.397" class="difflineminus">-    nsCOMPtr&lt;nsILocalFileMac&gt; macFile = do_QueryInterface(pMail);</span>
<a href="#l30.398"></a><span id="l30.398" class="difflineminus">-</span>
<a href="#l30.399"></a><span id="l30.399" class="difflineminus">-    FSRef fsRef;</span>
<a href="#l30.400"></a><span id="l30.400" class="difflineminus">-    nsresult rv = macFile-&gt;GetFSRef(&amp;fsRef);</span>
<a href="#l30.401"></a><span id="l30.401" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l30.402"></a><span id="l30.402" class="difflineminus">-      return false;</span>
<a href="#l30.403"></a><span id="l30.403" class="difflineminus">-</span>
<a href="#l30.404"></a><span id="l30.404" class="difflineminus">-    resFile = FSOpenResFile(&amp;fsRef, fsRdPerm);</span>
<a href="#l30.405"></a><span id="l30.405" class="difflineminus">-  }</span>
<a href="#l30.406"></a><span id="l30.406" class="difflineminus">-</span>
<a href="#l30.407"></a><span id="l30.407" class="difflineminus">-  if (resFile == -1)</span>
<a href="#l30.408"></a><span id="l30.408" class="difflineminus">-    return false;</span>
<a href="#l30.409"></a><span id="l30.409" class="difflineminus">-  Handle  resH = nil;</span>
<a href="#l30.410"></a><span id="l30.410" class="difflineminus">-  short max = Count1Resources('TOCF');</span>
<a href="#l30.411"></a><span id="l30.411" class="difflineminus">-  if (max)</span>
<a href="#l30.412"></a><span id="l30.412" class="difflineminus">-    resH = Get1IndResource('TOCF', 1);</span>
<a href="#l30.413"></a><span id="l30.413" class="difflineminus">-  bool     result = false;</span>
<a href="#l30.414"></a><span id="l30.414" class="difflineminus">-  if (resH)</span>
<a href="#l30.415"></a><span id="l30.415" class="difflineminus">-  {</span>
<a href="#l30.416"></a><span id="l30.416" class="difflineminus">-    int32_t sz = (int32_t) GetHandleSize(resH);</span>
<a href="#l30.417"></a><span id="l30.417" class="difflineminus">-    if (sz)</span>
<a href="#l30.418"></a><span id="l30.418" class="difflineminus">-    {</span>
<a href="#l30.419"></a><span id="l30.419" class="difflineminus">-      // Create the new TOC file</span>
<a href="#l30.420"></a><span id="l30.420" class="difflineminus">-      nsCOMPtr&lt;nsIFile&gt; tempDir;</span>
<a href="#l30.421"></a><span id="l30.421" class="difflineminus">-      nsresult rv = NS_GetSpecialDirectory(NS_OS_TEMP_DIR, getter_AddRefs(tempDir));</span>
<a href="#l30.422"></a><span id="l30.422" class="difflineminus">-      if (NS_FAILED(rv))</span>
<a href="#l30.423"></a><span id="l30.423" class="difflineminus">-        return false;</span>
<a href="#l30.424"></a><span id="l30.424" class="difflineminus">-</span>
<a href="#l30.425"></a><span id="l30.425" class="difflineminus">-      nsCOMPtr &lt;nsIOutputStream&gt; outputStream;</span>
<a href="#l30.426"></a><span id="l30.426" class="difflineminus">-        rv = tempDir-&gt;Clone(pToc);</span>
<a href="#l30.427"></a><span id="l30.427" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l30.428"></a><span id="l30.428" class="difflineminus">-        rv = (*pToc)-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;temp.toc&quot;));</span>
<a href="#l30.429"></a><span id="l30.429" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l30.430"></a><span id="l30.430" class="difflineminus">-        rv = (*pToc)-&gt;CreateUnique(nsIFile::NORMAL_FILE_TYPE, 00600);</span>
<a href="#l30.431"></a><span id="l30.431" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l30.432"></a><span id="l30.432" class="difflineminus">-        rv = NS_NewLocalFileOutputStream(getter_AddRefs(outputStream), (*pToc));</span>
<a href="#l30.433"></a><span id="l30.433" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l30.434"></a><span id="l30.434" class="difflineminus">-      {</span>
<a href="#l30.435"></a><span id="l30.435" class="difflineminus">-        HLock(resH);</span>
<a href="#l30.436"></a><span id="l30.436" class="difflineminus">-        uint32_t written = 0;</span>
<a href="#l30.437"></a><span id="l30.437" class="difflineminus">-        rv = outputStream-&gt;Write(*resH, sz, &amp;written);</span>
<a href="#l30.438"></a><span id="l30.438" class="difflineminus">-        HUnlock(resH);</span>
<a href="#l30.439"></a><span id="l30.439" class="difflineminus">-        outputStream-&gt;Close();</span>
<a href="#l30.440"></a><span id="l30.440" class="difflineminus">-        if (NS_FAILED(rv) || (written != sz))</span>
<a href="#l30.441"></a><span id="l30.441" class="difflineminus">-          (*pToc)-&gt;Remove(false);</span>
<a href="#l30.442"></a><span id="l30.442" class="difflineminus">-        else</span>
<a href="#l30.443"></a><span id="l30.443" class="difflineminus">-          result = true;</span>
<a href="#l30.444"></a><span id="l30.444" class="difflineminus">-      }</span>
<a href="#l30.445"></a><span id="l30.445" class="difflineminus">-    }</span>
<a href="#l30.446"></a><span id="l30.446" class="difflineminus">-    ReleaseResource(resH);</span>
<a href="#l30.447"></a><span id="l30.447" class="difflineminus">-  }</span>
<a href="#l30.448"></a><span id="l30.448" class="difflineminus">-  CloseResFile(resFile);</span>
<a href="#l30.449"></a><span id="l30.449" class="difflineminus">-</span>
<a href="#l30.450"></a><span id="l30.450" class="difflineminus">-  return result;</span>
<a href="#l30.451"></a><span id="l30.451" class="difflineminus">-}</span>
<a href="#l30.452"></a><span id="l30.452" class="difflineminus">-</span>
<a href="#l30.453"></a><span id="l30.453" class="difflineminus">-</span>
<a href="#l30.454"></a><span id="l30.454" class="difflineminus">-nsresult nsEudoraMac::FindTOCFile(nsIFile *pMailFile, nsIFile **ppTOCFile, bool *pDeleteToc)</span>
<a href="#l30.455"></a><span id="l30.455" class="difflineminus">-{</span>
<a href="#l30.456"></a><span id="l30.456" class="difflineminus">-  nsresult    rv;</span>
<a href="#l30.457"></a><span id="l30.457" class="difflineminus">-</span>
<a href="#l30.458"></a><span id="l30.458" class="difflineminus">-  *pDeleteToc = false;</span>
<a href="#l30.459"></a><span id="l30.459" class="difflineminus">-  *ppTOCFile = nullptr;</span>
<a href="#l30.460"></a><span id="l30.460" class="difflineminus">-  nsCString leaf;</span>
<a href="#l30.461"></a><span id="l30.461" class="difflineminus">-  rv = pMailFile-&gt;GetNativeLeafName(leaf);</span>
<a href="#l30.462"></a><span id="l30.462" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l30.463"></a><span id="l30.463" class="difflineminus">-    return rv;</span>
<a href="#l30.464"></a><span id="l30.464" class="difflineminus">-  rv = pMailFile-&gt;GetParent(ppTOCFile);</span>
<a href="#l30.465"></a><span id="l30.465" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l30.466"></a><span id="l30.466" class="difflineminus">-    return rv;</span>
<a href="#l30.467"></a><span id="l30.467" class="difflineminus">-</span>
<a href="#l30.468"></a><span id="l30.468" class="difflineminus">-  leaf.Append(&quot;.toc&quot;);</span>
<a href="#l30.469"></a><span id="l30.469" class="difflineminus">-</span>
<a href="#l30.470"></a><span id="l30.470" class="difflineminus">-  OSType  type = 0;</span>
<a href="#l30.471"></a><span id="l30.471" class="difflineminus">-  OSType  creator = 0;</span>
<a href="#l30.472"></a><span id="l30.472" class="difflineminus">-  bool    exists = false;</span>
<a href="#l30.473"></a><span id="l30.473" class="difflineminus">-  bool    isFile = false;</span>
<a href="#l30.474"></a><span id="l30.474" class="difflineminus">-  rv = (*ppTOCFile)-&gt;AppendNative(leaf);</span>
<a href="#l30.475"></a><span id="l30.475" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l30.476"></a><span id="l30.476" class="difflineminus">-    rv = (*ppTOCFile)-&gt;Exists(&amp;exists);</span>
<a href="#l30.477"></a><span id="l30.477" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; exists)</span>
<a href="#l30.478"></a><span id="l30.478" class="difflineminus">-    rv = (*ppTOCFile)-&gt;IsFile(&amp;isFile);</span>
<a href="#l30.479"></a><span id="l30.479" class="difflineminus">-  if (isFile)</span>
<a href="#l30.480"></a><span id="l30.480" class="difflineminus">-  {</span>
<a href="#l30.481"></a><span id="l30.481" class="difflineminus">-    nsCOMPtr&lt;nsILocalFileMac&gt; macFile = do_QueryInterface(*ppTOCFile);</span>
<a href="#l30.482"></a><span id="l30.482" class="difflineminus">-    if (macFile)</span>
<a href="#l30.483"></a><span id="l30.483" class="difflineminus">-    {</span>
<a href="#l30.484"></a><span id="l30.484" class="difflineminus">-      macFile-&gt;GetFileCreator(&amp;creator);</span>
<a href="#l30.485"></a><span id="l30.485" class="difflineminus">-      macFile-&gt;GetFileType(&amp;type);</span>
<a href="#l30.486"></a><span id="l30.486" class="difflineminus">-    }</span>
<a href="#l30.487"></a><span id="l30.487" class="difflineminus">-  }</span>
<a href="#l30.488"></a><span id="l30.488" class="difflineminus">-</span>
<a href="#l30.489"></a><span id="l30.489" class="difflineminus">-</span>
<a href="#l30.490"></a><span id="l30.490" class="difflineminus">-  if (exists &amp;&amp; isFile &amp;&amp; (type == 'TOCF') &amp;&amp; (creator == 'CSOm'))</span>
<a href="#l30.491"></a><span id="l30.491" class="difflineminus">-    return NS_OK;</span>
<a href="#l30.492"></a><span id="l30.492" class="difflineminus">-</span>
<a href="#l30.493"></a><span id="l30.493" class="difflineminus">-  // try and create the file from a resource.</span>
<a href="#l30.494"></a><span id="l30.494" class="difflineminus">-  if (CreateTocFromResource(pMailFile, ppTOCFile))</span>
<a href="#l30.495"></a><span id="l30.495" class="difflineminus">-  {</span>
<a href="#l30.496"></a><span id="l30.496" class="difflineminus">-    *pDeleteToc = true;</span>
<a href="#l30.497"></a><span id="l30.497" class="difflineminus">-    return NS_OK;</span>
<a href="#l30.498"></a><span id="l30.498" class="difflineminus">-  }</span>
<a href="#l30.499"></a><span id="l30.499" class="difflineminus">-  return NS_ERROR_FAILURE;</span>
<a href="#l30.500"></a><span id="l30.500" class="difflineminus">-}</span>
<a href="#l30.501"></a><span id="l30.501" class="difflineminus">-</span>
<a href="#l30.502"></a><span id="l30.502" class="difflineminus">-// GetIndString isn't supported on 64-bit Mac OS X</span>
<a href="#l30.503"></a><span id="l30.503" class="difflineminus">-// This code is emulation for GetIndString.</span>
<a href="#l30.504"></a><span id="l30.504" class="difflineminus">-static StringPtr GetStringFromHandle(Handle aResource,</span>
<a href="#l30.505"></a><span id="l30.505" class="difflineminus">-                                     ResourceIndex aId)</span>
<a href="#l30.506"></a><span id="l30.506" class="difflineminus">-{</span>
<a href="#l30.507"></a><span id="l30.507" class="difflineminus">-  if (!aResource)</span>
<a href="#l30.508"></a><span id="l30.508" class="difflineminus">-    return nullptr;</span>
<a href="#l30.509"></a><span id="l30.509" class="difflineminus">-</span>
<a href="#l30.510"></a><span id="l30.510" class="difflineminus">-  uint8_t *data = *(uint8_t**)aResource;</span>
<a href="#l30.511"></a><span id="l30.511" class="difflineminus">-  uint16_t count = *(uint16_t*)data;</span>
<a href="#l30.512"></a><span id="l30.512" class="difflineminus">-#if defined(IS_LITTLE_ENDIAN)</span>
<a href="#l30.513"></a><span id="l30.513" class="difflineminus">-  count = count &lt;&lt; 8 | count &gt;&gt; 8;</span>
<a href="#l30.514"></a><span id="l30.514" class="difflineminus">-#endif</span>
<a href="#l30.515"></a><span id="l30.515" class="difflineminus">-</span>
<a href="#l30.516"></a><span id="l30.516" class="difflineminus">-  // First 2 bytes are the count of string that this resource has.</span>
<a href="#l30.517"></a><span id="l30.517" class="difflineminus">-  if (count &lt; aId)</span>
<a href="#l30.518"></a><span id="l30.518" class="difflineminus">-    return nullptr;</span>
<a href="#l30.519"></a><span id="l30.519" class="difflineminus">-</span>
<a href="#l30.520"></a><span id="l30.520" class="difflineminus">-  // skip count</span>
<a href="#l30.521"></a><span id="l30.521" class="difflineminus">-  data += 2;</span>
<a href="#l30.522"></a><span id="l30.522" class="difflineminus">-</span>
<a href="#l30.523"></a><span id="l30.523" class="difflineminus">-  // looking for data.  data is in order</span>
<a href="#l30.524"></a><span id="l30.524" class="difflineminus">-  while (--aId &gt; 0)</span>
<a href="#l30.525"></a><span id="l30.525" class="difflineminus">-    data = data + (*(uint8_t*)data) + 1;</span>
<a href="#l30.526"></a><span id="l30.526" class="difflineminus">-</span>
<a href="#l30.527"></a><span id="l30.527" class="difflineminus">-  return data;</span>
<a href="#l30.528"></a><span id="l30.528" class="difflineminus">-}</span>
<a href="#l30.529"></a><span id="l30.529" class="difflineminus">-</span>
<a href="#l30.530"></a><span id="l30.530" class="difflineminus">-// Strings returned:</span>
<a href="#l30.531"></a><span id="l30.531" class="difflineminus">-//  1 - smtp server</span>
<a href="#l30.532"></a><span id="l30.532" class="difflineminus">-//  2 - pop account user name</span>
<a href="#l30.533"></a><span id="l30.533" class="difflineminus">-//  3 - the pop server</span>
<a href="#l30.534"></a><span id="l30.534" class="difflineminus">-//  4 - Return address</span>
<a href="#l30.535"></a><span id="l30.535" class="difflineminus">-//  5 - Full name</span>
<a href="#l30.536"></a><span id="l30.536" class="difflineminus">-//  6 - Leave mail on server</span>
<a href="#l30.537"></a><span id="l30.537" class="difflineminus">-#define kNumSettingStrs     6</span>
<a href="#l30.538"></a><span id="l30.538" class="difflineminus">-#define kSmtpServerStr      0</span>
<a href="#l30.539"></a><span id="l30.539" class="difflineminus">-#define kPopAccountNameStr  1</span>
<a href="#l30.540"></a><span id="l30.540" class="difflineminus">-#define kPopServerStr       2</span>
<a href="#l30.541"></a><span id="l30.541" class="difflineminus">-#define kReturnAddressStr   3</span>
<a href="#l30.542"></a><span id="l30.542" class="difflineminus">-#define kFullNameStr        4</span>
<a href="#l30.543"></a><span id="l30.543" class="difflineminus">-#define kLeaveOnServerStr   5</span>
<a href="#l30.544"></a><span id="l30.544" class="difflineminus">-</span>
<a href="#l30.545"></a><span id="l30.545" class="difflineminus">-// resource IDs</span>
<a href="#l30.546"></a><span id="l30.546" class="difflineminus">-#define kSmtpServerID         4</span>
<a href="#l30.547"></a><span id="l30.547" class="difflineminus">-#define kEmailAddressID       3</span>
<a href="#l30.548"></a><span id="l30.548" class="difflineminus">-#define kReturnAddressID      5</span>
<a href="#l30.549"></a><span id="l30.549" class="difflineminus">-#define kFullNameID           77</span>
<a href="#l30.550"></a><span id="l30.550" class="difflineminus">-#define kLeaveMailOnServerID  18</span>
<a href="#l30.551"></a><span id="l30.551" class="difflineminus">-</span>
<a href="#l30.552"></a><span id="l30.552" class="difflineminus">-</span>
<a href="#l30.553"></a><span id="l30.553" class="difflineminus">-bool nsEudoraMac::GetSettingsFromResource(nsIFile *pSettings, short resId, nsCString **pStrs, bool *pIMAP)</span>
<a href="#l30.554"></a><span id="l30.554" class="difflineminus">-{</span>
<a href="#l30.555"></a><span id="l30.555" class="difflineminus">-  nsresult rv;</span>
<a href="#l30.556"></a><span id="l30.556" class="difflineminus">-  *pIMAP = false;</span>
<a href="#l30.557"></a><span id="l30.557" class="difflineminus">-  // Get settings from the resources...</span>
<a href="#l30.558"></a><span id="l30.558" class="difflineminus">-  ResFileRefNum resFile = -1;</span>
<a href="#l30.559"></a><span id="l30.559" class="difflineminus">-  {</span>
<a href="#l30.560"></a><span id="l30.560" class="difflineminus">-    nsCOMPtr&lt;nsILocalFileMac&gt; macFile = do_QueryInterface(pSettings, &amp;rv);</span>
<a href="#l30.561"></a><span id="l30.561" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l30.562"></a><span id="l30.562" class="difflineminus">-      return false;</span>
<a href="#l30.563"></a><span id="l30.563" class="difflineminus">-</span>
<a href="#l30.564"></a><span id="l30.564" class="difflineminus">-    FSRef fsRef;</span>
<a href="#l30.565"></a><span id="l30.565" class="difflineminus">-    rv = macFile-&gt;GetFSRef(&amp;fsRef);</span>
<a href="#l30.566"></a><span id="l30.566" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l30.567"></a><span id="l30.567" class="difflineminus">-      return false;</span>
<a href="#l30.568"></a><span id="l30.568" class="difflineminus">-</span>
<a href="#l30.569"></a><span id="l30.569" class="difflineminus">-    resFile = FSOpenResFile(&amp;fsRef, fsRdPerm);</span>
<a href="#l30.570"></a><span id="l30.570" class="difflineminus">-  }</span>
<a href="#l30.571"></a><span id="l30.571" class="difflineminus">-  if (resFile == -1)</span>
<a href="#l30.572"></a><span id="l30.572" class="difflineminus">-    return false;</span>
<a href="#l30.573"></a><span id="l30.573" class="difflineminus">-</span>
<a href="#l30.574"></a><span id="l30.574" class="difflineminus">-  UseResFile(resFile);</span>
<a href="#l30.575"></a><span id="l30.575" class="difflineminus">-</span>
<a href="#l30.576"></a><span id="l30.576" class="difflineminus">-  // smtp server, STR# 1000, 4</span>
<a href="#l30.577"></a><span id="l30.577" class="difflineminus">-  Handle  resH = Get1Resource('STR#', resId /* 1000 */);</span>
<a href="#l30.578"></a><span id="l30.578" class="difflineminus">-  int    idx;</span>
<a href="#l30.579"></a><span id="l30.579" class="difflineminus">-  if (resH)</span>
<a href="#l30.580"></a><span id="l30.580" class="difflineminus">-  {</span>
<a href="#l30.581"></a><span id="l30.581" class="difflineminus">-    StringPtr  pStr[5];</span>
<a href="#l30.582"></a><span id="l30.582" class="difflineminus">-    StringPtr   theStr;</span>
<a href="#l30.583"></a><span id="l30.583" class="difflineminus">-</span>
<a href="#l30.584"></a><span id="l30.584" class="difflineminus">-    // Cannot use GetIndString due to 64-bit support</span>
<a href="#l30.585"></a><span id="l30.585" class="difflineminus">-    pStr[0] = GetStringFromHandle(resH, kSmtpServerID);</span>
<a href="#l30.586"></a><span id="l30.586" class="difflineminus">-    pStr[1] = GetStringFromHandle(resH, kEmailAddressID);</span>
<a href="#l30.587"></a><span id="l30.587" class="difflineminus">-    pStr[2] = GetStringFromHandle(resH, kReturnAddressID);</span>
<a href="#l30.588"></a><span id="l30.588" class="difflineminus">-    pStr[3] = GetStringFromHandle(resH, kFullNameID);</span>
<a href="#l30.589"></a><span id="l30.589" class="difflineminus">-    pStr[4] = GetStringFromHandle(resH, kLeaveMailOnServerID);</span>
<a href="#l30.590"></a><span id="l30.590" class="difflineminus">-</span>
<a href="#l30.591"></a><span id="l30.591" class="difflineminus">-    theStr = pStr[0];</span>
<a href="#l30.592"></a><span id="l30.592" class="difflineminus">-    if (theStr &amp;&amp; *theStr)</span>
<a href="#l30.593"></a><span id="l30.593" class="difflineminus">-      pStrs[0]-&gt;Append((const char *) (theStr + 1), *theStr);</span>
<a href="#l30.594"></a><span id="l30.594" class="difflineminus">-    theStr = pStr[1];</span>
<a href="#l30.595"></a><span id="l30.595" class="difflineminus">-    if (theStr &amp;&amp; *theStr)</span>
<a href="#l30.596"></a><span id="l30.596" class="difflineminus">-    {</span>
<a href="#l30.597"></a><span id="l30.597" class="difflineminus">-      idx = 1;</span>
<a href="#l30.598"></a><span id="l30.598" class="difflineminus">-      while (idx &lt;= *theStr)</span>
<a href="#l30.599"></a><span id="l30.599" class="difflineminus">-      {</span>
<a href="#l30.600"></a><span id="l30.600" class="difflineminus">-        if (theStr[idx] == '@')</span>
<a href="#l30.601"></a><span id="l30.601" class="difflineminus">-          break;</span>
<a href="#l30.602"></a><span id="l30.602" class="difflineminus">-        else</span>
<a href="#l30.603"></a><span id="l30.603" class="difflineminus">-          idx++;</span>
<a href="#l30.604"></a><span id="l30.604" class="difflineminus">-      }</span>
<a href="#l30.605"></a><span id="l30.605" class="difflineminus">-      if (idx &lt;= *theStr)</span>
<a href="#l30.606"></a><span id="l30.606" class="difflineminus">-      {</span>
<a href="#l30.607"></a><span id="l30.607" class="difflineminus">-        uint8_t  save = *theStr;</span>
<a href="#l30.608"></a><span id="l30.608" class="difflineminus">-        *theStr = idx - 1;</span>
<a href="#l30.609"></a><span id="l30.609" class="difflineminus">-        if (*theStr)</span>
<a href="#l30.610"></a><span id="l30.610" class="difflineminus">-          pStrs[1]-&gt;Append((const char *) (theStr + 1), *theStr);</span>
<a href="#l30.611"></a><span id="l30.611" class="difflineminus">-        *theStr = save;</span>
<a href="#l30.612"></a><span id="l30.612" class="difflineminus">-      }</span>
<a href="#l30.613"></a><span id="l30.613" class="difflineminus">-      else</span>
<a href="#l30.614"></a><span id="l30.614" class="difflineminus">-        idx = 0;</span>
<a href="#l30.615"></a><span id="l30.615" class="difflineminus">-      theStr[idx] = theStr[0] - idx;</span>
<a href="#l30.616"></a><span id="l30.616" class="difflineminus">-      if (theStr[idx])</span>
<a href="#l30.617"></a><span id="l30.617" class="difflineminus">-        pStrs[2]-&gt;Append((const char *) (theStr + idx + 1), *(theStr + idx));</span>
<a href="#l30.618"></a><span id="l30.618" class="difflineminus">-    }</span>
<a href="#l30.619"></a><span id="l30.619" class="difflineminus">-    theStr = pStr[2];</span>
<a href="#l30.620"></a><span id="l30.620" class="difflineminus">-    if (theStr &amp;&amp; *theStr)</span>
<a href="#l30.621"></a><span id="l30.621" class="difflineminus">-      pStrs[3]-&gt;Append((const char *) (theStr + 1), *theStr);</span>
<a href="#l30.622"></a><span id="l30.622" class="difflineminus">-    theStr = pStr[3];</span>
<a href="#l30.623"></a><span id="l30.623" class="difflineminus">-    if (theStr &amp;&amp; *theStr)</span>
<a href="#l30.624"></a><span id="l30.624" class="difflineminus">-      pStrs[4]-&gt;Append((const char *) (theStr + 1), *theStr);</span>
<a href="#l30.625"></a><span id="l30.625" class="difflineminus">-    theStr = pStr[4];</span>
<a href="#l30.626"></a><span id="l30.626" class="difflineminus">-    if (theStr &amp;&amp; *theStr)</span>
<a href="#l30.627"></a><span id="l30.627" class="difflineminus">-    {</span>
<a href="#l30.628"></a><span id="l30.628" class="difflineminus">-      if (theStr[1] == 'y')</span>
<a href="#l30.629"></a><span id="l30.629" class="difflineminus">-        *(pStrs[5]) = &quot;Y&quot;;</span>
<a href="#l30.630"></a><span id="l30.630" class="difflineminus">-      else</span>
<a href="#l30.631"></a><span id="l30.631" class="difflineminus">-        *(pStrs[5]) = &quot;N&quot;;</span>
<a href="#l30.632"></a><span id="l30.632" class="difflineminus">-    }</span>
<a href="#l30.633"></a><span id="l30.633" class="difflineminus">-</span>
<a href="#l30.634"></a><span id="l30.634" class="difflineminus">-    ReleaseResource(resH);</span>
<a href="#l30.635"></a><span id="l30.635" class="difflineminus">-    CloseResFile(resFile);</span>
<a href="#l30.636"></a><span id="l30.636" class="difflineminus">-</span>
<a href="#l30.637"></a><span id="l30.637" class="difflineminus">-    return true;</span>
<a href="#l30.638"></a><span id="l30.638" class="difflineminus">-  }</span>
<a href="#l30.639"></a><span id="l30.639" class="difflineminus">-  else</span>
<a href="#l30.640"></a><span id="l30.640" class="difflineminus">-  {</span>
<a href="#l30.641"></a><span id="l30.641" class="difflineminus">-    CloseResFile(resFile);</span>
<a href="#l30.642"></a><span id="l30.642" class="difflineminus">-    return false;</span>
<a href="#l30.643"></a><span id="l30.643" class="difflineminus">-  }</span>
<a href="#l30.644"></a><span id="l30.644" class="difflineminus">-}</span>
<a href="#l30.645"></a><span id="l30.645" class="difflineminus">-</span>
<a href="#l30.646"></a><span id="l30.646" class="difflineminus">-bool nsEudoraMac::ImportSettings(nsIFile *pIniFile, nsIMsgAccount **localMailAccount)</span>
<a href="#l30.647"></a><span id="l30.647" class="difflineminus">-{</span>
<a href="#l30.648"></a><span id="l30.648" class="difflineminus">-  nsresult  rv;</span>
<a href="#l30.649"></a><span id="l30.649" class="difflineminus">-</span>
<a href="#l30.650"></a><span id="l30.650" class="difflineminus">-  nsCOMPtr&lt;nsIMsgAccountManager&gt; accMgr =</span>
<a href="#l30.651"></a><span id="l30.651" class="difflineminus">-           do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l30.652"></a><span id="l30.652" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l30.653"></a><span id="l30.653" class="difflineminus">-  {</span>
<a href="#l30.654"></a><span id="l30.654" class="difflineminus">-    IMPORT_LOG0(&quot;*** Failed to create a account manager!\n&quot;);</span>
<a href="#l30.655"></a><span id="l30.655" class="difflineminus">-    return false;</span>
<a href="#l30.656"></a><span id="l30.656" class="difflineminus">-  }</span>
<a href="#l30.657"></a><span id="l30.657" class="difflineminus">-</span>
<a href="#l30.658"></a><span id="l30.658" class="difflineminus">-  short  baseResId = 1000;</span>
<a href="#l30.659"></a><span id="l30.659" class="difflineminus">-  nsCString **pStrs = new nsCString *[kNumSettingStrs];</span>
<a href="#l30.660"></a><span id="l30.660" class="difflineminus">-  int    i;</span>
<a href="#l30.661"></a><span id="l30.661" class="difflineminus">-</span>
<a href="#l30.662"></a><span id="l30.662" class="difflineminus">-  for (i = 0; i &lt; kNumSettingStrs; i++)</span>
<a href="#l30.663"></a><span id="l30.663" class="difflineminus">-    pStrs[i] = new nsCString;</span>
<a href="#l30.664"></a><span id="l30.664" class="difflineminus">-</span>
<a href="#l30.665"></a><span id="l30.665" class="difflineminus">-  nsString accName(NS_LITERAL_STRING(&quot;Eudora Settings&quot;));</span>
<a href="#l30.666"></a><span id="l30.666" class="difflineminus">-  nsEudoraStringBundle::GetStringByID(EUDORAIMPORT_ACCOUNTNAME, accName);</span>
<a href="#l30.667"></a><span id="l30.667" class="difflineminus">-</span>
<a href="#l30.668"></a><span id="l30.668" class="difflineminus">-  // This is a little overkill but we're not sure yet how multiple accounts</span>
<a href="#l30.669"></a><span id="l30.669" class="difflineminus">-  // are stored in the Mac preferences, hopefully similar to existing prefs</span>
<a href="#l30.670"></a><span id="l30.670" class="difflineminus">-  // which means the following is a good start!</span>
<a href="#l30.671"></a><span id="l30.671" class="difflineminus">-  bool    isIMAP = false;</span>
<a href="#l30.672"></a><span id="l30.672" class="difflineminus">-</span>
<a href="#l30.673"></a><span id="l30.673" class="difflineminus">-  int        popCount = 0;</span>
<a href="#l30.674"></a><span id="l30.674" class="difflineminus">-  int        accounts = 0;</span>
<a href="#l30.675"></a><span id="l30.675" class="difflineminus">-  nsIMsgAccount *  pAccount;</span>
<a href="#l30.676"></a><span id="l30.676" class="difflineminus">-</span>
<a href="#l30.677"></a><span id="l30.677" class="difflineminus">-  while (baseResId)</span>
<a href="#l30.678"></a><span id="l30.678" class="difflineminus">-  {</span>
<a href="#l30.679"></a><span id="l30.679" class="difflineminus">-    isIMAP = false;</span>
<a href="#l30.680"></a><span id="l30.680" class="difflineminus">-    if (GetSettingsFromResource(pIniFile, baseResId, pStrs, &amp;isIMAP))</span>
<a href="#l30.681"></a><span id="l30.681" class="difflineminus">-    {</span>
<a href="#l30.682"></a><span id="l30.682" class="difflineminus">-      pAccount = nullptr;</span>
<a href="#l30.683"></a><span id="l30.683" class="difflineminus">-      if (!isIMAP)</span>
<a href="#l30.684"></a><span id="l30.684" class="difflineminus">-      {</span>
<a href="#l30.685"></a><span id="l30.685" class="difflineminus">-        // This is a POP account</span>
<a href="#l30.686"></a><span id="l30.686" class="difflineminus">-        if (BuildPOPAccount(accMgr, pStrs, &amp;pAccount, accName))</span>
<a href="#l30.687"></a><span id="l30.687" class="difflineminus">-        {</span>
<a href="#l30.688"></a><span id="l30.688" class="difflineminus">-          accounts++;</span>
<a href="#l30.689"></a><span id="l30.689" class="difflineminus">-          popCount++;</span>
<a href="#l30.690"></a><span id="l30.690" class="difflineminus">-          if (popCount &gt; 1)</span>
<a href="#l30.691"></a><span id="l30.691" class="difflineminus">-          {</span>
<a href="#l30.692"></a><span id="l30.692" class="difflineminus">-            if (localMailAccount &amp;&amp; *localMailAccount)</span>
<a href="#l30.693"></a><span id="l30.693" class="difflineminus">-              NS_RELEASE(*localMailAccount);</span>
<a href="#l30.694"></a><span id="l30.694" class="difflineminus">-          }</span>
<a href="#l30.695"></a><span id="l30.695" class="difflineminus">-          else if (localMailAccount)</span>
<a href="#l30.696"></a><span id="l30.696" class="difflineminus">-          {</span>
<a href="#l30.697"></a><span id="l30.697" class="difflineminus">-            *localMailAccount = pAccount;</span>
<a href="#l30.698"></a><span id="l30.698" class="difflineminus">-            NS_IF_ADDREF(pAccount);</span>
<a href="#l30.699"></a><span id="l30.699" class="difflineminus">-          }</span>
<a href="#l30.700"></a><span id="l30.700" class="difflineminus">-        }</span>
<a href="#l30.701"></a><span id="l30.701" class="difflineminus">-      }</span>
<a href="#l30.702"></a><span id="l30.702" class="difflineminus">-      else</span>
<a href="#l30.703"></a><span id="l30.703" class="difflineminus">-      {</span>
<a href="#l30.704"></a><span id="l30.704" class="difflineminus">-        // This is an IMAP account</span>
<a href="#l30.705"></a><span id="l30.705" class="difflineminus">-        if (BuildIMAPAccount(accMgr, pStrs, &amp;pAccount, accName))</span>
<a href="#l30.706"></a><span id="l30.706" class="difflineminus">-          accounts++;</span>
<a href="#l30.707"></a><span id="l30.707" class="difflineminus">-      }</span>
<a href="#l30.708"></a><span id="l30.708" class="difflineminus">-      if (pAccount &amp;&amp; (baseResId == 1000))</span>
<a href="#l30.709"></a><span id="l30.709" class="difflineminus">-        accMgr-&gt;SetDefaultAccount(pAccount);</span>
<a href="#l30.710"></a><span id="l30.710" class="difflineminus">-</span>
<a href="#l30.711"></a><span id="l30.711" class="difflineminus">-      NS_IF_RELEASE(pAccount);</span>
<a href="#l30.712"></a><span id="l30.712" class="difflineminus">-    }</span>
<a href="#l30.713"></a><span id="l30.713" class="difflineminus">-</span>
<a href="#l30.714"></a><span id="l30.714" class="difflineminus">-    baseResId = 0;</span>
<a href="#l30.715"></a><span id="l30.715" class="difflineminus">-    // Set the next account name???</span>
<a href="#l30.716"></a><span id="l30.716" class="difflineminus">-</span>
<a href="#l30.717"></a><span id="l30.717" class="difflineminus">-    if (baseResId)</span>
<a href="#l30.718"></a><span id="l30.718" class="difflineminus">-    {</span>
<a href="#l30.719"></a><span id="l30.719" class="difflineminus">-      for (i = 0; i &lt; kNumSettingStrs; i++)</span>
<a href="#l30.720"></a><span id="l30.720" class="difflineminus">-        pStrs[i]-&gt;Truncate();</span>
<a href="#l30.721"></a><span id="l30.721" class="difflineminus">-    }</span>
<a href="#l30.722"></a><span id="l30.722" class="difflineminus">-  }</span>
<a href="#l30.723"></a><span id="l30.723" class="difflineminus">-</span>
<a href="#l30.724"></a><span id="l30.724" class="difflineminus">-  // Now save the new acct info to pref file.</span>
<a href="#l30.725"></a><span id="l30.725" class="difflineminus">-  rv = accMgr-&gt;SaveAccountInfo();</span>
<a href="#l30.726"></a><span id="l30.726" class="difflineminus">-  NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Can't save account info to pref file&quot;);</span>
<a href="#l30.727"></a><span id="l30.727" class="difflineminus">-</span>
<a href="#l30.728"></a><span id="l30.728" class="difflineminus">-  for (i = 0; i &lt; kNumSettingStrs; i++)</span>
<a href="#l30.729"></a><span id="l30.729" class="difflineminus">-    delete pStrs[i];</span>
<a href="#l30.730"></a><span id="l30.730" class="difflineminus">-  delete pStrs;</span>
<a href="#l30.731"></a><span id="l30.731" class="difflineminus">-</span>
<a href="#l30.732"></a><span id="l30.732" class="difflineminus">-  return accounts != 0;</span>
<a href="#l30.733"></a><span id="l30.733" class="difflineminus">-}</span>
<a href="#l30.734"></a><span id="l30.734" class="difflineminus">-</span>
<a href="#l30.735"></a><span id="l30.735" class="difflineminus">-bool nsEudoraMac::FindFiltersFile(nsIFile **pFiltersFile)</span>
<a href="#l30.736"></a><span id="l30.736" class="difflineminus">-{</span>
<a href="#l30.737"></a><span id="l30.737" class="difflineminus">-  bool result = FindEudoraLocation(pFiltersFile, false);</span>
<a href="#l30.738"></a><span id="l30.738" class="difflineminus">-</span>
<a href="#l30.739"></a><span id="l30.739" class="difflineminus">-  if (result)</span>
<a href="#l30.740"></a><span id="l30.740" class="difflineminus">-  {</span>
<a href="#l30.741"></a><span id="l30.741" class="difflineminus">-    (*pFiltersFile)-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;Eudora Filters&quot;));</span>
<a href="#l30.742"></a><span id="l30.742" class="difflineminus">-    (*pFiltersFile)-&gt;IsFile(&amp;result);</span>
<a href="#l30.743"></a><span id="l30.743" class="difflineminus">-  }</span>
<a href="#l30.744"></a><span id="l30.744" class="difflineminus">-</span>
<a href="#l30.745"></a><span id="l30.745" class="difflineminus">-  return result;</span>
<a href="#l30.746"></a><span id="l30.746" class="difflineminus">-}</span>
<a href="#l30.747"></a><span id="l30.747" class="difflineminus">-</span>
<a href="#l30.748"></a><span id="l30.748" class="difflineminus">-</span>
<a href="#l30.749"></a><span id="l30.749" class="difflineminus">-</span>
<a href="#l30.750"></a><span id="l30.750" class="difflineminus">-bool nsEudoraMac::BuildPOPAccount(nsIMsgAccountManager *accMgr, nsCString **pStrs, nsIMsgAccount **ppAccount, nsString&amp; accName)</span>
<a href="#l30.751"></a><span id="l30.751" class="difflineminus">-{</span>
<a href="#l30.752"></a><span id="l30.752" class="difflineminus">-  if (ppAccount)</span>
<a href="#l30.753"></a><span id="l30.753" class="difflineminus">-    *ppAccount = nullptr;</span>
<a href="#l30.754"></a><span id="l30.754" class="difflineminus">-</span>
<a href="#l30.755"></a><span id="l30.755" class="difflineminus">-</span>
<a href="#l30.756"></a><span id="l30.756" class="difflineminus">-  if (!pStrs[kPopServerStr]-&gt;Length() || !pStrs[kPopAccountNameStr]-&gt;Length())</span>
<a href="#l30.757"></a><span id="l30.757" class="difflineminus">-    return false;</span>
<a href="#l30.758"></a><span id="l30.758" class="difflineminus">-</span>
<a href="#l30.759"></a><span id="l30.759" class="difflineminus">-  bool    result = false;</span>
<a href="#l30.760"></a><span id="l30.760" class="difflineminus">-</span>
<a href="#l30.761"></a><span id="l30.761" class="difflineminus">-  // I now have a user name/server name pair, find out if it already exists?</span>
<a href="#l30.762"></a><span id="l30.762" class="difflineminus">-  nsCOMPtr&lt;nsIMsgIncomingServer&gt; in;</span>
<a href="#l30.763"></a><span id="l30.763" class="difflineminus">-  nsresult rv = accMgr-&gt;FindServer(*(pStrs[kPopAccountNameStr]), *(pStrs[kPopServerStr]), NS_LITERAL_CSTRING(&quot;pop3&quot;), getter_AddRefs(in));</span>
<a href="#l30.764"></a><span id="l30.764" class="difflineminus">-  if (NS_FAILED(rv) || (in == nullptr))</span>
<a href="#l30.765"></a><span id="l30.765" class="difflineminus">-  {</span>
<a href="#l30.766"></a><span id="l30.766" class="difflineminus">-    // Create the incoming server and an account for it?</span>
<a href="#l30.767"></a><span id="l30.767" class="difflineminus">-    rv = accMgr-&gt;CreateIncomingServer(*(pStrs[kPopAccountNameStr]), *(pStrs[kPopServerStr]), NS_LITERAL_CSTRING(&quot;pop3&quot;), getter_AddRefs(in));</span>
<a href="#l30.768"></a><span id="l30.768" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; in)</span>
<a href="#l30.769"></a><span id="l30.769" class="difflineminus">-    {</span>
<a href="#l30.770"></a><span id="l30.770" class="difflineminus">-      rv = in-&gt;SetType(NS_LITERAL_CSTRING(&quot;pop3&quot;));</span>
<a href="#l30.771"></a><span id="l30.771" class="difflineminus">-      // rv = in-&gt;SetHostName(pStrs[kPopServerStr]-&gt;get());</span>
<a href="#l30.772"></a><span id="l30.772" class="difflineminus">-      // rv = in-&gt;SetUsername(pStrs[kPopAccountNameStr]-&gt;get());</span>
<a href="#l30.773"></a><span id="l30.773" class="difflineminus">-</span>
<a href="#l30.774"></a><span id="l30.774" class="difflineminus">-      IMPORT_LOG2(&quot;Created POP3 server named: %s, userName: %s\n&quot;, pStrs[kPopServerStr]-&gt;get(), pStrs[kPopAccountNameStr]-&gt;get());</span>
<a href="#l30.775"></a><span id="l30.775" class="difflineminus">-      IMPORT_LOG1(&quot;\tSet pretty name to: %S\n&quot;, accName.get());</span>
<a href="#l30.776"></a><span id="l30.776" class="difflineminus">-      rv = in-&gt;SetPrettyName(accName);</span>
<a href="#l30.777"></a><span id="l30.777" class="difflineminus">-</span>
<a href="#l30.778"></a><span id="l30.778" class="difflineminus">-      // We have a server, create an account.</span>
<a href="#l30.779"></a><span id="l30.779" class="difflineminus">-      nsCOMPtr&lt;nsIMsgAccount&gt;  account;</span>
<a href="#l30.780"></a><span id="l30.780" class="difflineminus">-      rv = accMgr-&gt;CreateAccount(getter_AddRefs(account));</span>
<a href="#l30.781"></a><span id="l30.781" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; account)</span>
<a href="#l30.782"></a><span id="l30.782" class="difflineminus">-      {</span>
<a href="#l30.783"></a><span id="l30.783" class="difflineminus">-        rv = account-&gt;SetIncomingServer(in);</span>
<a href="#l30.784"></a><span id="l30.784" class="difflineminus">-</span>
<a href="#l30.785"></a><span id="l30.785" class="difflineminus">-        IMPORT_LOG0(&quot;Created a new account and set the incoming server to the POP3 server.\n&quot;);</span>
<a href="#l30.786"></a><span id="l30.786" class="difflineminus">-</span>
<a href="#l30.787"></a><span id="l30.787" class="difflineminus">-        nsCOMPtr&lt;nsIPop3IncomingServer&gt; pop3Server = do_QueryInterface(in, &amp;rv);</span>
<a href="#l30.788"></a><span id="l30.788" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l30.789"></a><span id="l30.789" class="difflineminus">-        pop3Server-&gt;SetLeaveMessagesOnServer(pStrs[kLeaveOnServerStr]-&gt;First() == 'Y' ? true : false);</span>
<a href="#l30.790"></a><span id="l30.790" class="difflineminus">-</span>
<a href="#l30.791"></a><span id="l30.791" class="difflineminus">-        // Fiddle with the identities</span>
<a href="#l30.792"></a><span id="l30.792" class="difflineminus">-        SetIdentities(accMgr, account, pStrs[kPopAccountNameStr]-&gt;get(), pStrs[kPopServerStr]-&gt;get(), pStrs);</span>
<a href="#l30.793"></a><span id="l30.793" class="difflineminus">-        result = true;</span>
<a href="#l30.794"></a><span id="l30.794" class="difflineminus">-        if (ppAccount)</span>
<a href="#l30.795"></a><span id="l30.795" class="difflineminus">-          account-&gt;QueryInterface(NS_GET_IID(nsIMsgAccount), (void **)ppAccount);</span>
<a href="#l30.796"></a><span id="l30.796" class="difflineminus">-      }</span>
<a href="#l30.797"></a><span id="l30.797" class="difflineminus">-    }</span>
<a href="#l30.798"></a><span id="l30.798" class="difflineminus">-  }</span>
<a href="#l30.799"></a><span id="l30.799" class="difflineminus">-  else</span>
<a href="#l30.800"></a><span id="l30.800" class="difflineminus">-    result = true;</span>
<a href="#l30.801"></a><span id="l30.801" class="difflineminus">-</span>
<a href="#l30.802"></a><span id="l30.802" class="difflineminus">-  return result;</span>
<a href="#l30.803"></a><span id="l30.803" class="difflineminus">-}</span>
<a href="#l30.804"></a><span id="l30.804" class="difflineminus">-</span>
<a href="#l30.805"></a><span id="l30.805" class="difflineminus">-</span>
<a href="#l30.806"></a><span id="l30.806" class="difflineminus">-bool nsEudoraMac::BuildIMAPAccount(nsIMsgAccountManager *accMgr, nsCString **pStrs, nsIMsgAccount **ppAccount, nsString&amp; accName)</span>
<a href="#l30.807"></a><span id="l30.807" class="difflineminus">-{</span>
<a href="#l30.808"></a><span id="l30.808" class="difflineminus">-  if (!pStrs[kPopServerStr]-&gt;Length() || !pStrs[kPopAccountNameStr]-&gt;Length())</span>
<a href="#l30.809"></a><span id="l30.809" class="difflineminus">-    return false;</span>
<a href="#l30.810"></a><span id="l30.810" class="difflineminus">-</span>
<a href="#l30.811"></a><span id="l30.811" class="difflineminus">-  bool result = false;</span>
<a href="#l30.812"></a><span id="l30.812" class="difflineminus">-</span>
<a href="#l30.813"></a><span id="l30.813" class="difflineminus">-  nsCOMPtr&lt;nsIMsgIncomingServer&gt;  in;</span>
<a href="#l30.814"></a><span id="l30.814" class="difflineminus">-  nsresult rv = accMgr-&gt;FindServer(*(pStrs[kPopAccountNameStr]), *(pStrs[kPopServerStr]), NS_LITERAL_CSTRING(&quot;imap&quot;), getter_AddRefs(in));</span>
<a href="#l30.815"></a><span id="l30.815" class="difflineminus">-  if (NS_FAILED(rv) || (in == nullptr))</span>
<a href="#l30.816"></a><span id="l30.816" class="difflineminus">-  {</span>
<a href="#l30.817"></a><span id="l30.817" class="difflineminus">-    // Create the incoming server and an account for it?</span>
<a href="#l30.818"></a><span id="l30.818" class="difflineminus">-    rv = accMgr-&gt;CreateIncomingServer(*(pStrs[kPopAccountNameStr]), *(pStrs[kPopServerStr]), NS_LITERAL_CSTRING(&quot;imap&quot;), getter_AddRefs(in));</span>
<a href="#l30.819"></a><span id="l30.819" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; in)</span>
<a href="#l30.820"></a><span id="l30.820" class="difflineminus">-    {</span>
<a href="#l30.821"></a><span id="l30.821" class="difflineminus">-      rv = in-&gt;SetType(NS_LITERAL_CSTRING(&quot;imap&quot;));</span>
<a href="#l30.822"></a><span id="l30.822" class="difflineminus">-      // rv = in-&gt;SetHostName(pStrs[kPopServerStr]-&gt;get());</span>
<a href="#l30.823"></a><span id="l30.823" class="difflineminus">-      // rv = in-&gt;SetUsername(pStrs[kPopAccountNameStr]-&gt;get());</span>
<a href="#l30.824"></a><span id="l30.824" class="difflineminus">-</span>
<a href="#l30.825"></a><span id="l30.825" class="difflineminus">-      IMPORT_LOG2(&quot;Created IMAP server named: %s, userName: %s\n&quot;, pStrs[kPopServerStr]-&gt;get(), pStrs[kPopAccountNameStr]-&gt;get());</span>
<a href="#l30.826"></a><span id="l30.826" class="difflineminus">-      IMPORT_LOG1(&quot;\tSet pretty name to: %S\n&quot;, accName.get());</span>
<a href="#l30.827"></a><span id="l30.827" class="difflineminus">-      rv = in-&gt;SetPrettyName(accName);</span>
<a href="#l30.828"></a><span id="l30.828" class="difflineminus">-</span>
<a href="#l30.829"></a><span id="l30.829" class="difflineminus">-      // We have a server, create an account.</span>
<a href="#l30.830"></a><span id="l30.830" class="difflineminus">-      nsCOMPtr&lt;nsIMsgAccount&gt;  account;</span>
<a href="#l30.831"></a><span id="l30.831" class="difflineminus">-      rv = accMgr-&gt;CreateAccount(getter_AddRefs(account));</span>
<a href="#l30.832"></a><span id="l30.832" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; account)</span>
<a href="#l30.833"></a><span id="l30.833" class="difflineminus">-      {</span>
<a href="#l30.834"></a><span id="l30.834" class="difflineminus">-        rv = account-&gt;SetIncomingServer(in);</span>
<a href="#l30.835"></a><span id="l30.835" class="difflineminus">-</span>
<a href="#l30.836"></a><span id="l30.836" class="difflineminus">-        IMPORT_LOG0(&quot;Created an account and set the IMAP server as the incoming server\n&quot;);</span>
<a href="#l30.837"></a><span id="l30.837" class="difflineminus">-</span>
<a href="#l30.838"></a><span id="l30.838" class="difflineminus">-        // Fiddle with the identities</span>
<a href="#l30.839"></a><span id="l30.839" class="difflineminus">-        SetIdentities(accMgr, account, pStrs[kPopAccountNameStr]-&gt;get(), pStrs[kPopServerStr]-&gt;get(), pStrs);</span>
<a href="#l30.840"></a><span id="l30.840" class="difflineminus">-        result = true;</span>
<a href="#l30.841"></a><span id="l30.841" class="difflineminus">-        if (ppAccount)</span>
<a href="#l30.842"></a><span id="l30.842" class="difflineminus">-          account-&gt;QueryInterface(NS_GET_IID(nsIMsgAccount), (void **)ppAccount);</span>
<a href="#l30.843"></a><span id="l30.843" class="difflineminus">-      }</span>
<a href="#l30.844"></a><span id="l30.844" class="difflineminus">-    }</span>
<a href="#l30.845"></a><span id="l30.845" class="difflineminus">-  }</span>
<a href="#l30.846"></a><span id="l30.846" class="difflineminus">-  else</span>
<a href="#l30.847"></a><span id="l30.847" class="difflineminus">-    result = true;</span>
<a href="#l30.848"></a><span id="l30.848" class="difflineminus">-</span>
<a href="#l30.849"></a><span id="l30.849" class="difflineminus">-  return result;</span>
<a href="#l30.850"></a><span id="l30.850" class="difflineminus">-}</span>
<a href="#l30.851"></a><span id="l30.851" class="difflineminus">-</span>
<a href="#l30.852"></a><span id="l30.852" class="difflineminus">-</span>
<a href="#l30.853"></a><span id="l30.853" class="difflineminus">-void nsEudoraMac::SetIdentities(nsIMsgAccountManager *accMgr, nsIMsgAccount *acc, const char *userName, const char *serverName, nsCString **pStrs)</span>
<a href="#l30.854"></a><span id="l30.854" class="difflineminus">-{</span>
<a href="#l30.855"></a><span id="l30.855" class="difflineminus">-  nsresult rv;</span>
<a href="#l30.856"></a><span id="l30.856" class="difflineminus">-</span>
<a href="#l30.857"></a><span id="l30.857" class="difflineminus">-  nsCOMPtr&lt;nsIMsgIdentity&gt; id;</span>
<a href="#l30.858"></a><span id="l30.858" class="difflineminus">-  rv = accMgr-&gt;CreateIdentity(getter_AddRefs(id));</span>
<a href="#l30.859"></a><span id="l30.859" class="difflineminus">-  if (id)</span>
<a href="#l30.860"></a><span id="l30.860" class="difflineminus">-  {</span>
<a href="#l30.861"></a><span id="l30.861" class="difflineminus">-    nsAutoString fullName;</span>
<a href="#l30.862"></a><span id="l30.862" class="difflineminus">-    if (pStrs[kFullNameStr]-&gt;Length())</span>
<a href="#l30.863"></a><span id="l30.863" class="difflineminus">-      CopyASCIItoUTF16(pStrs[kFullNameStr]-&gt;get(), fullName);</span>
<a href="#l30.864"></a><span id="l30.864" class="difflineminus">-    id-&gt;SetFullName(fullName);</span>
<a href="#l30.865"></a><span id="l30.865" class="difflineminus">-    id-&gt;SetIdentityName(fullName);</span>
<a href="#l30.866"></a><span id="l30.866" class="difflineminus">-    if (pStrs[kReturnAddressStr]-&gt;Length())</span>
<a href="#l30.867"></a><span id="l30.867" class="difflineminus">-      id-&gt;SetEmail(*(pStrs[kReturnAddressStr]));</span>
<a href="#l30.868"></a><span id="l30.868" class="difflineminus">-    else</span>
<a href="#l30.869"></a><span id="l30.869" class="difflineminus">-    {</span>
<a href="#l30.870"></a><span id="l30.870" class="difflineminus">-      nsAutoCString emailAddress;</span>
<a href="#l30.871"></a><span id="l30.871" class="difflineminus">-      emailAddress = userName;</span>
<a href="#l30.872"></a><span id="l30.872" class="difflineminus">-      emailAddress += &quot;@&quot;;</span>
<a href="#l30.873"></a><span id="l30.873" class="difflineminus">-      emailAddress += serverName;</span>
<a href="#l30.874"></a><span id="l30.874" class="difflineminus">-      id-&gt;SetEmail(emailAddress);</span>
<a href="#l30.875"></a><span id="l30.875" class="difflineminus">-    }</span>
<a href="#l30.876"></a><span id="l30.876" class="difflineminus">-    acc-&gt;AddIdentity(id);</span>
<a href="#l30.877"></a><span id="l30.877" class="difflineminus">-    IMPORT_LOG0(&quot;Created identity and added to the account\n&quot;);</span>
<a href="#l30.878"></a><span id="l30.878" class="difflineminus">-    IMPORT_LOG1(&quot;\tname: %s\n&quot;, pStrs[kFullNameStr]-&gt;get());</span>
<a href="#l30.879"></a><span id="l30.879" class="difflineminus">-    IMPORT_LOG1(&quot;\temail: %s\n&quot;, pStrs[kReturnAddressStr]-&gt;get());</span>
<a href="#l30.880"></a><span id="l30.880" class="difflineminus">-  }</span>
<a href="#l30.881"></a><span id="l30.881" class="difflineminus">-</span>
<a href="#l30.882"></a><span id="l30.882" class="difflineminus">-  SetSmtpServer(accMgr, acc, pStrs[kSmtpServerStr]-&gt;get(), userName);</span>
<a href="#l30.883"></a><span id="l30.883" class="difflineminus">-}</span>
<a href="#l30.884"></a><span id="l30.884" class="difflineminus">-</span>
<a href="#l30.885"></a><span id="l30.885" class="difflineminus">-</span>
<a href="#l30.886"></a><span id="l30.886" class="difflineminus">-void nsEudoraMac::SetSmtpServer(nsIMsgAccountManager *pMgr, nsIMsgAccount *pAcc, const char *pServer, const char *pUser)</span>
<a href="#l30.887"></a><span id="l30.887" class="difflineminus">-{</span>
<a href="#l30.888"></a><span id="l30.888" class="difflineminus">-  nsresult  rv;</span>
<a href="#l30.889"></a><span id="l30.889" class="difflineminus">-</span>
<a href="#l30.890"></a><span id="l30.890" class="difflineminus">-  nsCOMPtr&lt;nsISmtpService&gt; smtpService(do_GetService(NS_SMTPSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l30.891"></a><span id="l30.891" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; smtpService)</span>
<a href="#l30.892"></a><span id="l30.892" class="difflineminus">-  {</span>
<a href="#l30.893"></a><span id="l30.893" class="difflineminus">-    nsCOMPtr&lt;nsISmtpServer&gt;    foundServer;</span>
<a href="#l30.894"></a><span id="l30.894" class="difflineminus">-</span>
<a href="#l30.895"></a><span id="l30.895" class="difflineminus">-    rv = smtpService-&gt;FindServer(pUser, pServer, getter_AddRefs(foundServer));</span>
<a href="#l30.896"></a><span id="l30.896" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; foundServer)</span>
<a href="#l30.897"></a><span id="l30.897" class="difflineminus">-    {</span>
<a href="#l30.898"></a><span id="l30.898" class="difflineminus">-      IMPORT_LOG1(&quot;SMTP server already exists: %s\n&quot;, pServer);</span>
<a href="#l30.899"></a><span id="l30.899" class="difflineminus">-      return;</span>
<a href="#l30.900"></a><span id="l30.900" class="difflineminus">-    }</span>
<a href="#l30.901"></a><span id="l30.901" class="difflineminus">-    nsCOMPtr&lt;nsISmtpServer&gt;    smtpServer;</span>
<a href="#l30.902"></a><span id="l30.902" class="difflineminus">-</span>
<a href="#l30.903"></a><span id="l30.903" class="difflineminus">-    rv = smtpService-&gt;CreateServer(getter_AddRefs(smtpServer));</span>
<a href="#l30.904"></a><span id="l30.904" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; smtpServer)</span>
<a href="#l30.905"></a><span id="l30.905" class="difflineminus">-    {</span>
<a href="#l30.906"></a><span id="l30.906" class="difflineminus">-      smtpServer-&gt;SetHostname(nsDependentCString(pServer));</span>
<a href="#l30.907"></a><span id="l30.907" class="difflineminus">-      if (pUser)</span>
<a href="#l30.908"></a><span id="l30.908" class="difflineminus">-        smtpServer-&gt;SetUsername(nsDependentCString(pUser));</span>
<a href="#l30.909"></a><span id="l30.909" class="difflineminus">-</span>
<a href="#l30.910"></a><span id="l30.910" class="difflineminus">-      IMPORT_LOG1(&quot;Created new SMTP server: %s\n&quot;, pServer);</span>
<a href="#l30.911"></a><span id="l30.911" class="difflineminus">-    }</span>
<a href="#l30.912"></a><span id="l30.912" class="difflineminus">-  }</span>
<a href="#l30.913"></a><span id="l30.913" class="difflineminus">-}</span>
<a href="#l30.914"></a><span id="l30.914" class="difflineminus">-</span>
<a href="#l30.915"></a><span id="l30.915" class="difflineminus">-</span>
<a href="#l30.916"></a><span id="l30.916" class="difflineminus">-nsresult nsEudoraMac::GetAttachmentInfo(const char *pFileName, nsIFile *pFile, nsCString&amp; mimeType, nsCString&amp; aAttachment)</span>
<a href="#l30.917"></a><span id="l30.917" class="difflineminus">-{</span>
<a href="#l30.918"></a><span id="l30.918" class="difflineminus">-  mimeType.Truncate();</span>
<a href="#l30.919"></a><span id="l30.919" class="difflineminus">-</span>
<a href="#l30.920"></a><span id="l30.920" class="difflineminus">-  // Sample attachment line</span>
<a href="#l30.921"></a><span id="l30.921" class="difflineminus">-  // Internet:sandh.jpg (JPEG/JVWR) (0003C2E8)</span>
<a href="#l30.922"></a><span id="l30.922" class="difflineminus">-</span>
<a href="#l30.923"></a><span id="l30.923" class="difflineminus">-  OSType    type = '?\??\?';</span>
<a href="#l30.924"></a><span id="l30.924" class="difflineminus">-  OSType    creator = '?\??\?';</span>
<a href="#l30.925"></a><span id="l30.925" class="difflineminus">-  uint32_t  fNum = 0;</span>
<a href="#l30.926"></a><span id="l30.926" class="difflineminus">-</span>
<a href="#l30.927"></a><span id="l30.927" class="difflineminus">-  nsCString  str(pFileName);</span>
<a href="#l30.928"></a><span id="l30.928" class="difflineminus">-  if (str.Length() &gt; 22)</span>
<a href="#l30.929"></a><span id="l30.929" class="difflineminus">-  {</span>
<a href="#l30.930"></a><span id="l30.930" class="difflineminus">-    // try and extract the mac file info from the attachment line</span>
<a href="#l30.931"></a><span id="l30.931" class="difflineminus">-    nsCString  fileNum;</span>
<a href="#l30.932"></a><span id="l30.932" class="difflineminus">-    nsCString  types;</span>
<a href="#l30.933"></a><span id="l30.933" class="difflineminus">-</span>
<a href="#l30.934"></a><span id="l30.934" class="difflineminus">-    str.Right(fileNum, 10);</span>
<a href="#l30.935"></a><span id="l30.935" class="difflineminus">-    if ((fileNum.CharAt(0) == '(') &amp;&amp; (fileNum.CharAt(9) == ')'))</span>
<a href="#l30.936"></a><span id="l30.936" class="difflineminus">-    {</span>
<a href="#l30.937"></a><span id="l30.937" class="difflineminus">-      if (MsgIsHex(fileNum.get() + 1, 8))</span>
<a href="#l30.938"></a><span id="l30.938" class="difflineminus">-      {</span>
<a href="#l30.939"></a><span id="l30.939" class="difflineminus">-        fNum = MsgUnhex(fileNum.get() + 1, 8);</span>
<a href="#l30.940"></a><span id="l30.940" class="difflineminus">-        str.Left(fileNum, str.Length() - 10);</span>
<a href="#l30.941"></a><span id="l30.941" class="difflineminus">-        str = fileNum;</span>
<a href="#l30.942"></a><span id="l30.942" class="difflineminus">-        str.Trim(kWhitespace);</span>
<a href="#l30.943"></a><span id="l30.943" class="difflineminus">-        str.Right(types, 11);</span>
<a href="#l30.944"></a><span id="l30.944" class="difflineminus">-        if ((types.CharAt(0) == '(') &amp;&amp; (types.CharAt(5) == '/') &amp;&amp; (types.CharAt(10) == ')'))</span>
<a href="#l30.945"></a><span id="l30.945" class="difflineminus">-        {</span>
<a href="#l30.946"></a><span id="l30.946" class="difflineminus">-          type = ((uint32_t)types.CharAt(1)) &lt;&lt; 24;</span>
<a href="#l30.947"></a><span id="l30.947" class="difflineminus">-          type |= ((uint32_t)types.CharAt(2)) &lt;&lt; 16;</span>
<a href="#l30.948"></a><span id="l30.948" class="difflineminus">-          type |= types.CharAt(3) &lt;&lt; 8;</span>
<a href="#l30.949"></a><span id="l30.949" class="difflineminus">-          type |= types.CharAt(4);</span>
<a href="#l30.950"></a><span id="l30.950" class="difflineminus">-          creator = ((uint32_t)types.CharAt(6)) &lt;&lt; 24;</span>
<a href="#l30.951"></a><span id="l30.951" class="difflineminus">-          creator |= ((uint32_t)types.CharAt(7)) &lt;&lt; 16;</span>
<a href="#l30.952"></a><span id="l30.952" class="difflineminus">-          creator |= types.CharAt(8) &lt;&lt; 8;</span>
<a href="#l30.953"></a><span id="l30.953" class="difflineminus">-          creator |= types.CharAt(9);</span>
<a href="#l30.954"></a><span id="l30.954" class="difflineminus">-          str.Left(types, str.Length() - 11);</span>
<a href="#l30.955"></a><span id="l30.955" class="difflineminus">-          str = types;</span>
<a href="#l30.956"></a><span id="l30.956" class="difflineminus">-          str.Trim(kWhitespace);</span>
<a href="#l30.957"></a><span id="l30.957" class="difflineminus">-        }</span>
<a href="#l30.958"></a><span id="l30.958" class="difflineminus">-      }</span>
<a href="#l30.959"></a><span id="l30.959" class="difflineminus">-      else</span>
<a href="#l30.960"></a><span id="l30.960" class="difflineminus">-        fNum = 0;</span>
<a href="#l30.961"></a><span id="l30.961" class="difflineminus">-    }</span>
<a href="#l30.962"></a><span id="l30.962" class="difflineminus">-  }</span>
<a href="#l30.963"></a><span id="l30.963" class="difflineminus">-</span>
<a href="#l30.964"></a><span id="l30.964" class="difflineminus">-#ifdef IMPORT_DEBUG</span>
<a href="#l30.965"></a><span id="l30.965" class="difflineminus">-  nsCString  typeStr;</span>
<a href="#l30.966"></a><span id="l30.966" class="difflineminus">-  nsCString  creatStr;</span>
<a href="#l30.967"></a><span id="l30.967" class="difflineminus">-</span>
<a href="#l30.968"></a><span id="l30.968" class="difflineminus">-  creatStr.Append((const char *)&amp;creator, 4);</span>
<a href="#l30.969"></a><span id="l30.969" class="difflineminus">-  typeStr.Append((const char *)&amp;type, 4);</span>
<a href="#l30.970"></a><span id="l30.970" class="difflineminus">-  IMPORT_LOG3(&quot;\tAttachment type: %s, creator: %s, fileNum: %ld\n&quot;, typeStr.get(), creatStr.get(), fNum);</span>
<a href="#l30.971"></a><span id="l30.971" class="difflineminus">-  IMPORT_LOG1(&quot;\tAttachment file name: %s\n&quot;, str.get());</span>
<a href="#l30.972"></a><span id="l30.972" class="difflineminus">-#endif</span>
<a href="#l30.973"></a><span id="l30.973" class="difflineminus">-  FSRef  fsRef;</span>
<a href="#l30.974"></a><span id="l30.974" class="difflineminus">-  memset(&amp;fsRef, 0, sizeof(fsRef));</span>
<a href="#l30.975"></a><span id="l30.975" class="difflineminus">-  {</span>
<a href="#l30.976"></a><span id="l30.976" class="difflineminus">-    nsresult rv;</span>
<a href="#l30.977"></a><span id="l30.977" class="difflineminus">-    rv = pFile-&gt;InitWithNativePath(str);</span>
<a href="#l30.978"></a><span id="l30.978" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l30.979"></a><span id="l30.979" class="difflineminus">-    {</span>
<a href="#l30.980"></a><span id="l30.980" class="difflineminus">-      IMPORT_LOG0(&quot;\tfailed to set native path\n&quot;);</span>
<a href="#l30.981"></a><span id="l30.981" class="difflineminus">-      return rv;</span>
<a href="#l30.982"></a><span id="l30.982" class="difflineminus">-    }</span>
<a href="#l30.983"></a><span id="l30.983" class="difflineminus">-</span>
<a href="#l30.984"></a><span id="l30.984" class="difflineminus">-    pFile-&gt;GetNativeLeafName(aAttachment);</span>
<a href="#l30.985"></a><span id="l30.985" class="difflineminus">-</span>
<a href="#l30.986"></a><span id="l30.986" class="difflineminus">-    nsCOMPtr&lt;nsILocalFileMac&gt; macFile = do_QueryInterface(pFile, &amp;rv);</span>
<a href="#l30.987"></a><span id="l30.987" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l30.988"></a><span id="l30.988" class="difflineminus">-    {</span>
<a href="#l30.989"></a><span id="l30.989" class="difflineminus">-      IMPORT_LOG0(&quot;\tfailed to get local mac file\n&quot;);</span>
<a href="#l30.990"></a><span id="l30.990" class="difflineminus">-      return rv;</span>
<a href="#l30.991"></a><span id="l30.991" class="difflineminus">-    }</span>
<a href="#l30.992"></a><span id="l30.992" class="difflineminus">-</span>
<a href="#l30.993"></a><span id="l30.993" class="difflineminus">-    rv = macFile-&gt;GetFSRef(&amp;fsRef);</span>
<a href="#l30.994"></a><span id="l30.994" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l30.995"></a><span id="l30.995" class="difflineminus">-    {</span>
<a href="#l30.996"></a><span id="l30.996" class="difflineminus">-      IMPORT_LOG0(&quot;\tfailed to get FSRef\n&quot;);</span>
<a href="#l30.997"></a><span id="l30.997" class="difflineminus">-      return rv;</span>
<a href="#l30.998"></a><span id="l30.998" class="difflineminus">-    }</span>
<a href="#l30.999"></a><span id="l30.999" class="difflineminus">-  }</span>
<a href="#l30.1000"></a><span id="l30.1000" class="difflineminus">-</span>
<a href="#l30.1001"></a><span id="l30.1001" class="difflineminus">-  if (HasResourceFork(&amp;fsRef))</span>
<a href="#l30.1002"></a><span id="l30.1002" class="difflineminus">-    mimeType = &quot;application/applefile&quot;;</span>
<a href="#l30.1003"></a><span id="l30.1003" class="difflineminus">-  else</span>
<a href="#l30.1004"></a><span id="l30.1004" class="difflineminus">-    mimeType = &quot;application/octet-stream&quot;;</span>
<a href="#l30.1005"></a><span id="l30.1005" class="difflineminus">-</span>
<a href="#l30.1006"></a><span id="l30.1006" class="difflineminus">-  IMPORT_LOG1(&quot;\tMimeType: %s\n&quot;, mimeType.get());</span>
<a href="#l30.1007"></a><span id="l30.1007" class="difflineminus">-</span>
<a href="#l30.1008"></a><span id="l30.1008" class="difflineminus">-  return NS_OK;</span>
<a href="#l30.1009"></a><span id="l30.1009" class="difflineminus">-}</span>
<a href="#l30.1010"></a><span id="l30.1010" class="difflineminus">-</span>
<a href="#l30.1011"></a><span id="l30.1011" class="difflineminus">-bool nsEudoraMac::HasResourceFork(FSRef *fsRef)</span>
<a href="#l30.1012"></a><span id="l30.1012" class="difflineminus">-{</span>
<a href="#l30.1013"></a><span id="l30.1013" class="difflineminus">-  FSCatalogInfo catalogInfo;</span>
<a href="#l30.1014"></a><span id="l30.1014" class="difflineminus">-  OSErr err = FSGetCatalogInfo(fsRef,</span>
<a href="#l30.1015"></a><span id="l30.1015" class="difflineminus">-                               kFSCatInfoDataSizes + kFSCatInfoRsrcSizes,</span>
<a href="#l30.1016"></a><span id="l30.1016" class="difflineminus">-                               &amp;catalogInfo, nullptr, nullptr, nullptr);</span>
<a href="#l30.1017"></a><span id="l30.1017" class="difflineminus">-  return (err == noErr &amp;&amp; catalogInfo.rsrcLogicalSize != 0);</span>
<a href="#l30.1018"></a><span id="l30.1018" class="difflineminus">-}</span>
<a href="#l30.1019"></a><span id="l30.1019" class="difflineminus">-</span>
<a href="#l30.1020"></a><span id="l30.1020" class="difflineminus">-</span>
<a href="#l30.1021"></a><span id="l30.1021" class="difflineminus">-#define    kNumBadFolderNames    7</span>
<a href="#l30.1022"></a><span id="l30.1022" class="difflineminus">-const char *cBadFolderNames[kNumBadFolderNames] =</span>
<a href="#l30.1023"></a><span id="l30.1023" class="difflineminus">-{</span>
<a href="#l30.1024"></a><span id="l30.1024" class="difflineminus">-  &quot;Attachments Folder&quot;,</span>
<a href="#l30.1025"></a><span id="l30.1025" class="difflineminus">-  &quot;Eudora Items&quot;,</span>
<a href="#l30.1026"></a><span id="l30.1026" class="difflineminus">-  &quot;Nicknames Folder&quot;,</span>
<a href="#l30.1027"></a><span id="l30.1027" class="difflineminus">-  &quot;Parts Folder&quot;,</span>
<a href="#l30.1028"></a><span id="l30.1028" class="difflineminus">-  &quot;Signature Folder&quot;,</span>
<a href="#l30.1029"></a><span id="l30.1029" class="difflineminus">-  &quot;Spool Folder&quot;,</span>
<a href="#l30.1030"></a><span id="l30.1030" class="difflineminus">-  &quot;Stationery Folder&quot;</span>
<a href="#l30.1031"></a><span id="l30.1031" class="difflineminus">-};</span>
<a href="#l30.1032"></a><span id="l30.1032" class="difflineminus">-</span>
<a href="#l30.1033"></a><span id="l30.1033" class="difflineminus">-bool nsEudoraMac::IsValidMailFolderName(nsCString&amp; name)</span>
<a href="#l30.1034"></a><span id="l30.1034" class="difflineminus">-{</span>
<a href="#l30.1035"></a><span id="l30.1035" class="difflineminus">-  if (m_depth &gt; 1)</span>
<a href="#l30.1036"></a><span id="l30.1036" class="difflineminus">-    return true;</span>
<a href="#l30.1037"></a><span id="l30.1037" class="difflineminus">-</span>
<a href="#l30.1038"></a><span id="l30.1038" class="difflineminus">-  for (int i = 0; i &lt; kNumBadFolderNames; i++)</span>
<a href="#l30.1039"></a><span id="l30.1039" class="difflineminus">-  {</span>
<a href="#l30.1040"></a><span id="l30.1040" class="difflineminus">-    if (name.Equals(cBadFolderNames[i], nsCaseInsensitiveCStringComparator()))</span>
<a href="#l30.1041"></a><span id="l30.1041" class="difflineminus">-      return false;</span>
<a href="#l30.1042"></a><span id="l30.1042" class="difflineminus">-  }</span>
<a href="#l30.1043"></a><span id="l30.1043" class="difflineminus">-</span>
<a href="#l30.1044"></a><span id="l30.1044" class="difflineminus">-  return true;</span>
<a href="#l30.1045"></a><span id="l30.1045" class="difflineminus">-}</span>
<a href="#l30.1046"></a><span id="l30.1046" class="difflineminus">-</span>
<a href="#l30.1047"></a><span id="l30.1047" class="difflineminus">-</span>
<a href="#l30.1048"></a><span id="l30.1048" class="difflineminus">-bool nsEudoraMac::IsValidMailboxName(nsCString&amp; fName)</span>
<a href="#l30.1049"></a><span id="l30.1049" class="difflineminus">-{</span>
<a href="#l30.1050"></a><span id="l30.1050" class="difflineminus">-  if (m_depth &gt; 1)</span>
<a href="#l30.1051"></a><span id="l30.1051" class="difflineminus">-    return true;</span>
<a href="#l30.1052"></a><span id="l30.1052" class="difflineminus">-  return !fName.LowerCaseEqualsLiteral(&quot;eudora nicknames&quot;);</span>
<a href="#l30.1053"></a><span id="l30.1053" class="difflineminus">-}</span>
<a href="#l30.1054"></a><span id="l30.1054" class="difflineminus">-</span>
<a href="#l30.1055"></a><span id="l30.1055" class="difflineminus">-</span>
<a href="#l30.1056"></a><span id="l30.1056" class="difflineminus">-bool nsEudoraMac::IsValidMailboxFile(nsIFile *pFile)</span>
<a href="#l30.1057"></a><span id="l30.1057" class="difflineminus">-{</span>
<a href="#l30.1058"></a><span id="l30.1058" class="difflineminus">-  int64_t  size = 0;</span>
<a href="#l30.1059"></a><span id="l30.1059" class="difflineminus">-  nsresult rv = pFile-&gt;GetFileSize(&amp;size);</span>
<a href="#l30.1060"></a><span id="l30.1060" class="difflineminus">-  if (size)</span>
<a href="#l30.1061"></a><span id="l30.1061" class="difflineminus">-  {</span>
<a href="#l30.1062"></a><span id="l30.1062" class="difflineminus">-    if (size &lt; 10)</span>
<a href="#l30.1063"></a><span id="l30.1063" class="difflineminus">-      return false;</span>
<a href="#l30.1064"></a><span id="l30.1064" class="difflineminus">-    nsCOMPtr &lt;nsIInputStream&gt; inputStream;</span>
<a href="#l30.1065"></a><span id="l30.1065" class="difflineminus">-    rv = NS_NewLocalFileInputStream(getter_AddRefs(inputStream), pFile);</span>
<a href="#l30.1066"></a><span id="l30.1066" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l30.1067"></a><span id="l30.1067" class="difflineminus">-      return false;</span>
<a href="#l30.1068"></a><span id="l30.1068" class="difflineminus">-    uint32_t  read = 0;</span>
<a href="#l30.1069"></a><span id="l30.1069" class="difflineminus">-    char  buffer[6];</span>
<a href="#l30.1070"></a><span id="l30.1070" class="difflineminus">-    char *  pBuf = buffer;</span>
<a href="#l30.1071"></a><span id="l30.1071" class="difflineminus">-    rv = inputStream-&gt;Read(pBuf, 5, &amp;read);</span>
<a href="#l30.1072"></a><span id="l30.1072" class="difflineminus">-    inputStream-&gt;Close();</span>
<a href="#l30.1073"></a><span id="l30.1073" class="difflineminus">-    if (NS_FAILED(rv) || (read != 5))</span>
<a href="#l30.1074"></a><span id="l30.1074" class="difflineminus">-      return false;</span>
<a href="#l30.1075"></a><span id="l30.1075" class="difflineminus">-    buffer[5] = 0;</span>
<a href="#l30.1076"></a><span id="l30.1076" class="difflineminus">-    if (strcmp(buffer, &quot;From &quot;))</span>
<a href="#l30.1077"></a><span id="l30.1077" class="difflineminus">-      return false;</span>
<a href="#l30.1078"></a><span id="l30.1078" class="difflineminus">-  }</span>
<a href="#l30.1079"></a><span id="l30.1079" class="difflineminus">-</span>
<a href="#l30.1080"></a><span id="l30.1080" class="difflineminus">-  return true;</span>
<a href="#l30.1081"></a><span id="l30.1081" class="difflineminus">-}</span>
<a href="#l30.1082"></a><span id="l30.1082" class="difflineminus">-</span>
<a href="#l30.1083"></a><span id="l30.1083" class="difflineminus">-</span>
<a href="#l30.1084"></a><span id="l30.1084" class="difflineminus">-</span>
<a href="#l30.1085"></a><span id="l30.1085" class="difflineminus">-</span>
<a href="#l30.1086"></a><span id="l30.1086" class="difflineminus">-bool nsEudoraMac::FindAddressFolder(nsIFile **pFolder)</span>
<a href="#l30.1087"></a><span id="l30.1087" class="difflineminus">-{</span>
<a href="#l30.1088"></a><span id="l30.1088" class="difflineminus">-  return FindEudoraLocation(pFolder);</span>
<a href="#l30.1089"></a><span id="l30.1089" class="difflineminus">-}</span>
<a href="#l30.1090"></a><span id="l30.1090" class="difflineminus">-</span>
<a href="#l30.1091"></a><span id="l30.1091" class="difflineminus">-nsresult nsEudoraMac::FindAddressBooks(nsIFile *pRoot, nsIMutableArray *pArray)</span>
<a href="#l30.1092"></a><span id="l30.1092" class="difflineminus">-{</span>
<a href="#l30.1093"></a><span id="l30.1093" class="difflineminus">-  // Look for the nicknames file in this folder and then</span>
<a href="#l30.1094"></a><span id="l30.1094" class="difflineminus">-  // additional files in the Nicknames folder</span>
<a href="#l30.1095"></a><span id="l30.1095" class="difflineminus">-  // Try and find the nickNames file</span>
<a href="#l30.1096"></a><span id="l30.1096" class="difflineminus">-  nsresult rv;</span>
<a href="#l30.1097"></a><span id="l30.1097" class="difflineminus">-  nsCOMPtr&lt;nsIFile&gt; file = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l30.1098"></a><span id="l30.1098" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.1099"></a><span id="l30.1099" class="difflineminus">-  rv = file-&gt;InitWithFile(pRoot);</span>
<a href="#l30.1100"></a><span id="l30.1100" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l30.1101"></a><span id="l30.1101" class="difflineminus">-    return rv;</span>
<a href="#l30.1102"></a><span id="l30.1102" class="difflineminus">-</span>
<a href="#l30.1103"></a><span id="l30.1103" class="difflineminus">-  nsCOMPtr&lt;nsIImportService&gt; impSvc(do_GetService(NS_IMPORTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l30.1104"></a><span id="l30.1104" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l30.1105"></a><span id="l30.1105" class="difflineminus">-    return rv;</span>
<a href="#l30.1106"></a><span id="l30.1106" class="difflineminus">-</span>
<a href="#l30.1107"></a><span id="l30.1107" class="difflineminus">-  nsString displayName;</span>
<a href="#l30.1108"></a><span id="l30.1108" class="difflineminus">-  nsEudoraStringBundle::GetStringByID(EUDORAIMPORT_NICKNAMES_NAME, displayName);</span>
<a href="#l30.1109"></a><span id="l30.1109" class="difflineminus">-  int64_t  sz = 0;</span>
<a href="#l30.1110"></a><span id="l30.1110" class="difflineminus">-</span>
<a href="#l30.1111"></a><span id="l30.1111" class="difflineminus">-  // First find the Nicknames file itself</span>
<a href="#l30.1112"></a><span id="l30.1112" class="difflineminus">-  rv = file-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;Eudora Nicknames&quot;));</span>
<a href="#l30.1113"></a><span id="l30.1113" class="difflineminus">-  bool exists = false;</span>
<a href="#l30.1114"></a><span id="l30.1114" class="difflineminus">-  bool isFile = false;</span>
<a href="#l30.1115"></a><span id="l30.1115" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l30.1116"></a><span id="l30.1116" class="difflineminus">-    rv = file-&gt;Exists(&amp;exists);</span>
<a href="#l30.1117"></a><span id="l30.1117" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; exists)</span>
<a href="#l30.1118"></a><span id="l30.1118" class="difflineminus">-    rv = file-&gt;IsFile(&amp;isFile);</span>
<a href="#l30.1119"></a><span id="l30.1119" class="difflineminus">-</span>
<a href="#l30.1120"></a><span id="l30.1120" class="difflineminus">-</span>
<a href="#l30.1121"></a><span id="l30.1121" class="difflineminus">-  nsCOMPtr&lt;nsIImportABDescriptor&gt;  desc;</span>
<a href="#l30.1122"></a><span id="l30.1122" class="difflineminus">-  nsISupports *pInterface;</span>
<a href="#l30.1123"></a><span id="l30.1123" class="difflineminus">-</span>
<a href="#l30.1124"></a><span id="l30.1124" class="difflineminus">-  if (exists &amp;&amp; isFile)</span>
<a href="#l30.1125"></a><span id="l30.1125" class="difflineminus">-  {</span>
<a href="#l30.1126"></a><span id="l30.1126" class="difflineminus">-    rv = impSvc-&gt;CreateNewABDescriptor(getter_AddRefs(desc));</span>
<a href="#l30.1127"></a><span id="l30.1127" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l30.1128"></a><span id="l30.1128" class="difflineminus">-    {</span>
<a href="#l30.1129"></a><span id="l30.1129" class="difflineminus">-      sz = 0;</span>
<a href="#l30.1130"></a><span id="l30.1130" class="difflineminus">-      file-&gt;GetFileSize(&amp;sz);</span>
<a href="#l30.1131"></a><span id="l30.1131" class="difflineminus">-      desc-&gt;SetPreferredName(displayName);</span>
<a href="#l30.1132"></a><span id="l30.1132" class="difflineminus">-      desc-&gt;SetSize(sz);</span>
<a href="#l30.1133"></a><span id="l30.1133" class="difflineminus">-      // SetAbFile will clone the file we pass to it.</span>
<a href="#l30.1134"></a><span id="l30.1134" class="difflineminus">-      desc-&gt;SetAbFile(file);</span>
<a href="#l30.1135"></a><span id="l30.1135" class="difflineminus">-      rv = desc-&gt;QueryInterface(kISupportsIID, (void **) &amp;pInterface);</span>
<a href="#l30.1136"></a><span id="l30.1136" class="difflineminus">-      pArray-&gt;AppendElement(pInterface, false);</span>
<a href="#l30.1137"></a><span id="l30.1137" class="difflineminus">-      pInterface-&gt;Release();</span>
<a href="#l30.1138"></a><span id="l30.1138" class="difflineminus">-    }</span>
<a href="#l30.1139"></a><span id="l30.1139" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l30.1140"></a><span id="l30.1140" class="difflineminus">-    {</span>
<a href="#l30.1141"></a><span id="l30.1141" class="difflineminus">-      IMPORT_LOG0(&quot;*** Error creating address book descriptor for eudora nicknames\n&quot;);</span>
<a href="#l30.1142"></a><span id="l30.1142" class="difflineminus">-      return rv;</span>
<a href="#l30.1143"></a><span id="l30.1143" class="difflineminus">-    }</span>
<a href="#l30.1144"></a><span id="l30.1144" class="difflineminus">-  }</span>
<a href="#l30.1145"></a><span id="l30.1145" class="difflineminus">-</span>
<a href="#l30.1146"></a><span id="l30.1146" class="difflineminus">-  // Now try the directory of address books!</span>
<a href="#l30.1147"></a><span id="l30.1147" class="difflineminus">-  rv = file-&gt;InitWithFile(pRoot);</span>
<a href="#l30.1148"></a><span id="l30.1148" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l30.1149"></a><span id="l30.1149" class="difflineminus">-    rv = file-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;Nicknames Folder&quot;));</span>
<a href="#l30.1150"></a><span id="l30.1150" class="difflineminus">-  exists = false;</span>
<a href="#l30.1151"></a><span id="l30.1151" class="difflineminus">-  bool    isDir = false;</span>
<a href="#l30.1152"></a><span id="l30.1152" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l30.1153"></a><span id="l30.1153" class="difflineminus">-    rv = file-&gt;Exists(&amp;exists);</span>
<a href="#l30.1154"></a><span id="l30.1154" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; exists)</span>
<a href="#l30.1155"></a><span id="l30.1155" class="difflineminus">-    rv = file-&gt;IsDirectory(&amp;isDir);</span>
<a href="#l30.1156"></a><span id="l30.1156" class="difflineminus">-</span>
<a href="#l30.1157"></a><span id="l30.1157" class="difflineminus">-  if (!isDir)</span>
<a href="#l30.1158"></a><span id="l30.1158" class="difflineminus">-    return NS_OK;</span>
<a href="#l30.1159"></a><span id="l30.1159" class="difflineminus">-</span>
<a href="#l30.1160"></a><span id="l30.1160" class="difflineminus">-  bool hasMore;</span>
<a href="#l30.1161"></a><span id="l30.1161" class="difflineminus">-  nsCOMPtr&lt;nsISimpleEnumerator&gt; directoryEnumerator;</span>
<a href="#l30.1162"></a><span id="l30.1162" class="difflineminus">-   rv = file-&gt;GetDirectoryEntries(getter_AddRefs(directoryEnumerator));</span>
<a href="#l30.1163"></a><span id="l30.1163" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.1164"></a><span id="l30.1164" class="difflineminus">-</span>
<a href="#l30.1165"></a><span id="l30.1165" class="difflineminus">-  directoryEnumerator-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l30.1166"></a><span id="l30.1166" class="difflineminus">-</span>
<a href="#l30.1167"></a><span id="l30.1167" class="difflineminus">-  nsCString name;</span>
<a href="#l30.1168"></a><span id="l30.1168" class="difflineminus">-  OSType          type;</span>
<a href="#l30.1169"></a><span id="l30.1169" class="difflineminus">-  OSType          creator;</span>
<a href="#l30.1170"></a><span id="l30.1170" class="difflineminus">-</span>
<a href="#l30.1171"></a><span id="l30.1171" class="difflineminus">-  while (hasMore &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l30.1172"></a><span id="l30.1172" class="difflineminus">-  {</span>
<a href="#l30.1173"></a><span id="l30.1173" class="difflineminus">-    nsCOMPtr&lt;nsISupports&gt; aSupport;</span>
<a href="#l30.1174"></a><span id="l30.1174" class="difflineminus">-    rv = directoryEnumerator-&gt;GetNext(getter_AddRefs(aSupport));</span>
<a href="#l30.1175"></a><span id="l30.1175" class="difflineminus">-    nsCOMPtr&lt;nsIFile&gt; entry(do_QueryInterface(aSupport, &amp;rv));</span>
<a href="#l30.1176"></a><span id="l30.1176" class="difflineminus">-    directoryEnumerator-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l30.1177"></a><span id="l30.1177" class="difflineminus">-</span>
<a href="#l30.1178"></a><span id="l30.1178" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l30.1179"></a><span id="l30.1179" class="difflineminus">-    {</span>
<a href="#l30.1180"></a><span id="l30.1180" class="difflineminus">-      isFile = false;</span>
<a href="#l30.1181"></a><span id="l30.1181" class="difflineminus">-      rv = entry-&gt;IsFile(&amp;isFile);</span>
<a href="#l30.1182"></a><span id="l30.1182" class="difflineminus">-      rv = entry-&gt;GetLeafName(displayName);</span>
<a href="#l30.1183"></a><span id="l30.1183" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; !displayName.IsEmpty() &amp;&amp; isFile)</span>
<a href="#l30.1184"></a><span id="l30.1184" class="difflineminus">-      {</span>
<a href="#l30.1185"></a><span id="l30.1185" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l30.1186"></a><span id="l30.1186" class="difflineminus">-        {</span>
<a href="#l30.1187"></a><span id="l30.1187" class="difflineminus">-          type = 0;</span>
<a href="#l30.1188"></a><span id="l30.1188" class="difflineminus">-          creator = 0;</span>
<a href="#l30.1189"></a><span id="l30.1189" class="difflineminus">-          {</span>
<a href="#l30.1190"></a><span id="l30.1190" class="difflineminus">-            nsCOMPtr&lt;nsILocalFileMac&gt; macFile = do_QueryInterface(entry, &amp;rv);</span>
<a href="#l30.1191"></a><span id="l30.1191" class="difflineminus">-            if (NS_SUCCEEDED(rv))</span>
<a href="#l30.1192"></a><span id="l30.1192" class="difflineminus">-            {</span>
<a href="#l30.1193"></a><span id="l30.1193" class="difflineminus">-              macFile-&gt;GetFileCreator(&amp;creator);</span>
<a href="#l30.1194"></a><span id="l30.1194" class="difflineminus">-              macFile-&gt;GetFileType(&amp;type);</span>
<a href="#l30.1195"></a><span id="l30.1195" class="difflineminus">-            }</span>
<a href="#l30.1196"></a><span id="l30.1196" class="difflineminus">-          }</span>
<a href="#l30.1197"></a><span id="l30.1197" class="difflineminus">-          if (type == 'TEXT')</span>
<a href="#l30.1198"></a><span id="l30.1198" class="difflineminus">-          {</span>
<a href="#l30.1199"></a><span id="l30.1199" class="difflineminus">-</span>
<a href="#l30.1200"></a><span id="l30.1200" class="difflineminus">-            rv = impSvc-&gt;CreateNewABDescriptor(getter_AddRefs(desc));</span>
<a href="#l30.1201"></a><span id="l30.1201" class="difflineminus">-            if (NS_SUCCEEDED(rv))</span>
<a href="#l30.1202"></a><span id="l30.1202" class="difflineminus">-            {</span>
<a href="#l30.1203"></a><span id="l30.1203" class="difflineminus">-              sz = 0;</span>
<a href="#l30.1204"></a><span id="l30.1204" class="difflineminus">-              entry-&gt;GetFileSize(&amp;sz);</span>
<a href="#l30.1205"></a><span id="l30.1205" class="difflineminus">-              desc-&gt;SetPreferredName(displayName);</span>
<a href="#l30.1206"></a><span id="l30.1206" class="difflineminus">-              desc-&gt;SetSize(sz);</span>
<a href="#l30.1207"></a><span id="l30.1207" class="difflineminus">-              // SetAbFile will clone the file we pass to it.</span>
<a href="#l30.1208"></a><span id="l30.1208" class="difflineminus">-              desc-&gt;SetAbFile(entry);</span>
<a href="#l30.1209"></a><span id="l30.1209" class="difflineminus">-              rv = desc-&gt;QueryInterface(kISupportsIID, (void **) &amp;pInterface);</span>
<a href="#l30.1210"></a><span id="l30.1210" class="difflineminus">-              pArray-&gt;AppendElement(pInterface, false);</span>
<a href="#l30.1211"></a><span id="l30.1211" class="difflineminus">-              pInterface-&gt;Release();</span>
<a href="#l30.1212"></a><span id="l30.1212" class="difflineminus">-            }</span>
<a href="#l30.1213"></a><span id="l30.1213" class="difflineminus">-            if (NS_FAILED(rv))</span>
<a href="#l30.1214"></a><span id="l30.1214" class="difflineminus">-            {</span>
<a href="#l30.1215"></a><span id="l30.1215" class="difflineminus">-              IMPORT_LOG0(&quot;*** Error creating address book descriptor for eudora address book\n&quot;);</span>
<a href="#l30.1216"></a><span id="l30.1216" class="difflineminus">-              return rv;</span>
<a href="#l30.1217"></a><span id="l30.1217" class="difflineminus">-            }</span>
<a href="#l30.1218"></a><span id="l30.1218" class="difflineminus">-          }</span>
<a href="#l30.1219"></a><span id="l30.1219" class="difflineminus">-        }</span>
<a href="#l30.1220"></a><span id="l30.1220" class="difflineminus">-      }</span>
<a href="#l30.1221"></a><span id="l30.1221" class="difflineminus">-    }</span>
<a href="#l30.1222"></a><span id="l30.1222" class="difflineminus">-  }</span>
<a href="#l30.1223"></a><span id="l30.1223" class="difflineminus">-  return rv;</span>
<a href="#l30.1224"></a><span id="l30.1224" class="difflineminus">-}</span>
<a href="#l30.1225"></a><span id="l30.1225" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1">deleted file mode 100644</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineminus">--- a/mailnews/import/eudora/src/nsEudoraMac.h</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineplus">+++ /dev/null</span>
<a href="#l31.4"></a><span id="l31.4" class="difflineat">@@ -1,123 +0,0 @@</span>
<a href="#l31.5"></a><span id="l31.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l31.6"></a><span id="l31.6" class="difflineminus">- *</span>
<a href="#l31.7"></a><span id="l31.7" class="difflineminus">- * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l31.8"></a><span id="l31.8" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l31.9"></a><span id="l31.9" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l31.10"></a><span id="l31.10" class="difflineminus">-</span>
<a href="#l31.11"></a><span id="l31.11" class="difflineminus">-#ifndef nsEudoraMac_h__</span>
<a href="#l31.12"></a><span id="l31.12" class="difflineminus">-#define nsEudoraMac_h__</span>
<a href="#l31.13"></a><span id="l31.13" class="difflineminus">-</span>
<a href="#l31.14"></a><span id="l31.14" class="difflineminus">-#include &quot;mozilla/Attributes.h&quot;</span>
<a href="#l31.15"></a><span id="l31.15" class="difflineminus">-#include &quot;nscore.h&quot;</span>
<a href="#l31.16"></a><span id="l31.16" class="difflineminus">-#include &quot;nsStringGlue.h&quot;</span>
<a href="#l31.17"></a><span id="l31.17" class="difflineminus">-#include &quot;nsIFile.h&quot;</span>
<a href="#l31.18"></a><span id="l31.18" class="difflineminus">-#include &quot;nsEudoraMailbox.h&quot;</span>
<a href="#l31.19"></a><span id="l31.19" class="difflineminus">-#include &quot;nsEudoraAddress.h&quot;</span>
<a href="#l31.20"></a><span id="l31.20" class="difflineminus">-</span>
<a href="#l31.21"></a><span id="l31.21" class="difflineminus">-#include &lt;CoreServices/CoreServices.h&gt;</span>
<a href="#l31.22"></a><span id="l31.22" class="difflineminus">-</span>
<a href="#l31.23"></a><span id="l31.23" class="difflineminus">-class nsIImportService;</span>
<a href="#l31.24"></a><span id="l31.24" class="difflineminus">-class nsIMsgAccountManager;</span>
<a href="#l31.25"></a><span id="l31.25" class="difflineminus">-class nsIMsgAccount;</span>
<a href="#l31.26"></a><span id="l31.26" class="difflineminus">-class nsIMutableArray;</span>
<a href="#l31.27"></a><span id="l31.27" class="difflineminus">-</span>
<a href="#l31.28"></a><span id="l31.28" class="difflineminus">-</span>
<a href="#l31.29"></a><span id="l31.29" class="difflineminus">-class nsEudoraMac : public nsEudoraMailbox, public nsEudoraAddress {</span>
<a href="#l31.30"></a><span id="l31.30" class="difflineminus">-public:</span>
<a href="#l31.31"></a><span id="l31.31" class="difflineminus">-  nsEudoraMac();</span>
<a href="#l31.32"></a><span id="l31.32" class="difflineminus">-  ~nsEudoraMac();</span>
<a href="#l31.33"></a><span id="l31.33" class="difflineminus">-</span>
<a href="#l31.34"></a><span id="l31.34" class="difflineminus">-    // retrieve the mail folder</span>
<a href="#l31.35"></a><span id="l31.35" class="difflineminus">-  virtual bool      FindMailFolder(nsIFile **pFolder) override;</span>
<a href="#l31.36"></a><span id="l31.36" class="difflineminus">-    // get the list of mailboxes</span>
<a href="#l31.37"></a><span id="l31.37" class="difflineminus">-  virtual nsresult  FindMailboxes(nsIFile *pRoot,</span>
<a href="#l31.38"></a><span id="l31.38" class="difflineminus">-                                  nsIMutableArray *pArray) override;</span>
<a href="#l31.39"></a><span id="l31.39" class="difflineminus">-    // get a TOC file from a mailbox file</span>
<a href="#l31.40"></a><span id="l31.40" class="difflineminus">-  virtual nsresult  FindTOCFile(nsIFile *pMailFile,</span>
<a href="#l31.41"></a><span id="l31.41" class="difflineminus">-                                nsIFile **pTOCFile,</span>
<a href="#l31.42"></a><span id="l31.42" class="difflineminus">-                                bool *pDeleteToc) override;</span>
<a href="#l31.43"></a><span id="l31.43" class="difflineminus">-</span>
<a href="#l31.44"></a><span id="l31.44" class="difflineminus">-  virtual nsresult  GetAttachmentInfo(const char *pFileName,</span>
<a href="#l31.45"></a><span id="l31.45" class="difflineminus">-                                      nsIFile *pFile,</span>
<a href="#l31.46"></a><span id="l31.46" class="difflineminus">-                                      nsCString&amp; mimeType,</span>
<a href="#l31.47"></a><span id="l31.47" class="difflineminus">-                                      nsCString&amp; aAttachment) override;</span>
<a href="#l31.48"></a><span id="l31.48" class="difflineminus">-</span>
<a href="#l31.49"></a><span id="l31.49" class="difflineminus">-    // Address book stuff</span>
<a href="#l31.50"></a><span id="l31.50" class="difflineminus">-  virtual bool      FindAddressFolder(nsIFile **pFolder) override;</span>
<a href="#l31.51"></a><span id="l31.51" class="difflineminus">-    // get the list of mailboxes</span>
<a href="#l31.52"></a><span id="l31.52" class="difflineminus">-  virtual nsresult  FindAddressBooks(nsIFile *pRoot,</span>
<a href="#l31.53"></a><span id="l31.53" class="difflineminus">-                                     nsIMutableArray *pArray) override;</span>
<a href="#l31.54"></a><span id="l31.54" class="difflineminus">-</span>
<a href="#l31.55"></a><span id="l31.55" class="difflineminus">-    // import settings</span>
<a href="#l31.56"></a><span id="l31.56" class="difflineminus">-  static bool    ImportSettings(nsIFile *pIniFile,</span>
<a href="#l31.57"></a><span id="l31.57" class="difflineminus">-                                nsIMsgAccount **localMailAccount);</span>
<a href="#l31.58"></a><span id="l31.58" class="difflineminus">-  static bool    FindSettingsFile(nsIFile **pIniFile) { return FindEudoraLocation(pIniFile, true);}</span>
<a href="#l31.59"></a><span id="l31.59" class="difflineminus">-</span>
<a href="#l31.60"></a><span id="l31.60" class="difflineminus">-  static bool    FindFiltersFile(nsIFile **pFiltersFile);</span>
<a href="#l31.61"></a><span id="l31.61" class="difflineminus">-</span>
<a href="#l31.62"></a><span id="l31.62" class="difflineminus">-private:</span>
<a href="#l31.63"></a><span id="l31.63" class="difflineminus">-  static bool    FindEudoraLocation(nsIFile **pFolder,</span>
<a href="#l31.64"></a><span id="l31.64" class="difflineminus">-                                    bool findIni = false,</span>
<a href="#l31.65"></a><span id="l31.65" class="difflineminus">-                                    nsIFile *pLookIn = nullptr);</span>
<a href="#l31.66"></a><span id="l31.66" class="difflineminus">-  static bool    FindEudoraLocation(nsIFile **pFolder,</span>
<a href="#l31.67"></a><span id="l31.67" class="difflineminus">-                                    bool findIni,</span>
<a href="#l31.68"></a><span id="l31.68" class="difflineminus">-                                    const char *specialDirName);</span>
<a href="#l31.69"></a><span id="l31.69" class="difflineminus">-  static bool    VerifyEudoraLocation(nsIFile **pFolder, bool findIni);</span>
<a href="#l31.70"></a><span id="l31.70" class="difflineminus">-</span>
<a href="#l31.71"></a><span id="l31.71" class="difflineminus">-</span>
<a href="#l31.72"></a><span id="l31.72" class="difflineminus">-  nsresult  ScanMailDir(nsIFile *pFolder,</span>
<a href="#l31.73"></a><span id="l31.73" class="difflineminus">-                        nsIMutableArray *pArray,</span>
<a href="#l31.74"></a><span id="l31.74" class="difflineminus">-                        nsIImportService *pImport);</span>
<a href="#l31.75"></a><span id="l31.75" class="difflineminus">-  nsresult  IterateMailDir(nsIFile *pFolder,</span>
<a href="#l31.76"></a><span id="l31.76" class="difflineminus">-                           nsIMutableArray *pArray,</span>
<a href="#l31.77"></a><span id="l31.77" class="difflineminus">-                           nsIImportService *pImport);</span>
<a href="#l31.78"></a><span id="l31.78" class="difflineminus">-  nsresult  FoundMailFolder(nsIFile *mailFolder,</span>
<a href="#l31.79"></a><span id="l31.79" class="difflineminus">-                            const char *pName,</span>
<a href="#l31.80"></a><span id="l31.80" class="difflineminus">-                            nsIMutableArray *pArray,</span>
<a href="#l31.81"></a><span id="l31.81" class="difflineminus">-                            nsIImportService *pImport);</span>
<a href="#l31.82"></a><span id="l31.82" class="difflineminus">-  nsresult  FoundMailbox(nsIFile *mailFile,</span>
<a href="#l31.83"></a><span id="l31.83" class="difflineminus">-                         const char *pName,</span>
<a href="#l31.84"></a><span id="l31.84" class="difflineminus">-                         nsIMutableArray *pArray,</span>
<a href="#l31.85"></a><span id="l31.85" class="difflineminus">-                         nsIImportService *pImport);</span>
<a href="#l31.86"></a><span id="l31.86" class="difflineminus">-</span>
<a href="#l31.87"></a><span id="l31.87" class="difflineminus">-  bool      IsValidMailFolderName(nsCString&amp; name);</span>
<a href="#l31.88"></a><span id="l31.88" class="difflineminus">-  bool      IsValidMailboxName(nsCString&amp; fName);</span>
<a href="#l31.89"></a><span id="l31.89" class="difflineminus">-  bool      IsValidMailboxFile(nsIFile *pFile);</span>
<a href="#l31.90"></a><span id="l31.90" class="difflineminus">-</span>
<a href="#l31.91"></a><span id="l31.91" class="difflineminus">-  bool      CreateTocFromResource(nsIFile *pMail, nsIFile **pToc);</span>
<a href="#l31.92"></a><span id="l31.92" class="difflineminus">-</span>
<a href="#l31.93"></a><span id="l31.93" class="difflineminus">-</span>
<a href="#l31.94"></a><span id="l31.94" class="difflineminus">-</span>
<a href="#l31.95"></a><span id="l31.95" class="difflineminus">-    // Settings support</span>
<a href="#l31.96"></a><span id="l31.96" class="difflineminus">-  static bool    BuildPOPAccount(nsIMsgAccountManager *accMgr,</span>
<a href="#l31.97"></a><span id="l31.97" class="difflineminus">-                                 nsCString **pStrs,</span>
<a href="#l31.98"></a><span id="l31.98" class="difflineminus">-                                 nsIMsgAccount **ppAccount,</span>
<a href="#l31.99"></a><span id="l31.99" class="difflineminus">-                                 nsString&amp; accName);</span>
<a href="#l31.100"></a><span id="l31.100" class="difflineminus">-  static bool    BuildIMAPAccount(nsIMsgAccountManager *accMgr,</span>
<a href="#l31.101"></a><span id="l31.101" class="difflineminus">-                                  nsCString **pStrs,</span>
<a href="#l31.102"></a><span id="l31.102" class="difflineminus">-                                  nsIMsgAccount **ppAccount,</span>
<a href="#l31.103"></a><span id="l31.103" class="difflineminus">-                                  nsString&amp; accName);</span>
<a href="#l31.104"></a><span id="l31.104" class="difflineminus">-  static void    SetIdentities(nsIMsgAccountManager *accMgr,</span>
<a href="#l31.105"></a><span id="l31.105" class="difflineminus">-                               nsIMsgAccount *acc,</span>
<a href="#l31.106"></a><span id="l31.106" class="difflineminus">-                               const char *userName,</span>
<a href="#l31.107"></a><span id="l31.107" class="difflineminus">-                               const char *serverName,</span>
<a href="#l31.108"></a><span id="l31.108" class="difflineminus">-                               nsCString **pStrs);</span>
<a href="#l31.109"></a><span id="l31.109" class="difflineminus">-  static void    SetSmtpServer(nsIMsgAccountManager *pMgr,</span>
<a href="#l31.110"></a><span id="l31.110" class="difflineminus">-                               nsIMsgAccount *pAcc,</span>
<a href="#l31.111"></a><span id="l31.111" class="difflineminus">-                               const char *pServer,</span>
<a href="#l31.112"></a><span id="l31.112" class="difflineminus">-                               const char *pUser);</span>
<a href="#l31.113"></a><span id="l31.113" class="difflineminus">-  static bool    GetSettingsFromResource(nsIFile *pSettings,</span>
<a href="#l31.114"></a><span id="l31.114" class="difflineminus">-                                         short resId,</span>
<a href="#l31.115"></a><span id="l31.115" class="difflineminus">-                                         nsCString **pStrs,</span>
<a href="#l31.116"></a><span id="l31.116" class="difflineminus">-                                         bool *pIMAP);</span>
<a href="#l31.117"></a><span id="l31.117" class="difflineminus">-</span>
<a href="#l31.118"></a><span id="l31.118" class="difflineminus">-</span>
<a href="#l31.119"></a><span id="l31.119" class="difflineminus">-private:</span>
<a href="#l31.120"></a><span id="l31.120" class="difflineminus">-  uint32_t m_depth;</span>
<a href="#l31.121"></a><span id="l31.121" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; m_mailImportLocation;</span>
<a href="#l31.122"></a><span id="l31.122" class="difflineminus">-  bool HasResourceFork(FSRef *fsRef);</span>
<a href="#l31.123"></a><span id="l31.123" class="difflineminus">-};</span>
<a href="#l31.124"></a><span id="l31.124" class="difflineminus">-</span>
<a href="#l31.125"></a><span id="l31.125" class="difflineminus">-</span>
<a href="#l31.126"></a><span id="l31.126" class="difflineminus">-#endif /* nsEudoraMac_h__ */</span>
<a href="#l31.127"></a><span id="l31.127" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1">deleted file mode 100644</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineminus">--- a/mailnews/import/eudora/src/nsEudoraMailbox.cpp</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineplus">+++ /dev/null</span>
<a href="#l32.4"></a><span id="l32.4" class="difflineat">@@ -1,1365 +0,0 @@</span>
<a href="#l32.5"></a><span id="l32.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-</span>
<a href="#l32.6"></a><span id="l32.6" class="difflineminus">- *</span>
<a href="#l32.7"></a><span id="l32.7" class="difflineminus">- * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l32.8"></a><span id="l32.8" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l32.9"></a><span id="l32.9" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l32.10"></a><span id="l32.10" class="difflineminus">-</span>
<a href="#l32.11"></a><span id="l32.11" class="difflineminus">-#include &quot;msgCore.h&quot;</span>
<a href="#l32.12"></a><span id="l32.12" class="difflineminus">-#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l32.13"></a><span id="l32.13" class="difflineminus">-#include &quot;nsEudoraMailbox.h&quot;</span>
<a href="#l32.14"></a><span id="l32.14" class="difflineminus">-#include &quot;nsDirectoryServiceDefs.h&quot;</span>
<a href="#l32.15"></a><span id="l32.15" class="difflineminus">-#include &quot;nsEudoraCompose.h&quot;</span>
<a href="#l32.16"></a><span id="l32.16" class="difflineminus">-#include &quot;nspr.h&quot;</span>
<a href="#l32.17"></a><span id="l32.17" class="difflineminus">-#include &quot;nsMsgMessageFlags.h&quot;</span>
<a href="#l32.18"></a><span id="l32.18" class="difflineminus">-#include &quot;nsMailHeaders.h&quot;</span>
<a href="#l32.19"></a><span id="l32.19" class="difflineminus">-#include &quot;nsMsgLocalFolderHdrs.h&quot;</span>
<a href="#l32.20"></a><span id="l32.20" class="difflineminus">-#include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l32.21"></a><span id="l32.21" class="difflineminus">-#include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l32.22"></a><span id="l32.22" class="difflineminus">-#include &quot;nsIMsgPluggableStore.h&quot;</span>
<a href="#l32.23"></a><span id="l32.23" class="difflineminus">-#include &quot;nsMsgUtils.h&quot;</span>
<a href="#l32.24"></a><span id="l32.24" class="difflineminus">-#include &quot;nsCRT.h&quot;</span>
<a href="#l32.25"></a><span id="l32.25" class="difflineminus">-#include &quot;nsNetUtil.h&quot;</span>
<a href="#l32.26"></a><span id="l32.26" class="difflineminus">-#include &quot;EudoraDebugLog.h&quot;</span>
<a href="#l32.27"></a><span id="l32.27" class="difflineminus">-#include &quot;nsISeekableStream.h&quot;</span>
<a href="#l32.28"></a><span id="l32.28" class="difflineminus">-#include &quot;nsIInputStream.h&quot;</span>
<a href="#l32.29"></a><span id="l32.29" class="difflineminus">-#include &quot;nsIOutputStream.h&quot;</span>
<a href="#l32.30"></a><span id="l32.30" class="difflineminus">-</span>
<a href="#l32.31"></a><span id="l32.31" class="difflineminus">-#define  kCopyBufferSize    8192</span>
<a href="#l32.32"></a><span id="l32.32" class="difflineminus">-#define  kMailReadBufferSize  16384</span>
<a href="#l32.33"></a><span id="l32.33" class="difflineminus">-#define DATE_STR_LEN      64      // 64 bytes is plenty to hold the date header.</span>
<a href="#l32.34"></a><span id="l32.34" class="difflineminus">-</span>
<a href="#l32.35"></a><span id="l32.35" class="difflineminus">-#define  kWhitespace  &quot; \t\b\r\n&quot;</span>
<a href="#l32.36"></a><span id="l32.36" class="difflineminus">-</span>
<a href="#l32.37"></a><span id="l32.37" class="difflineminus">-const char *eudoraFromLine = &quot;From - Mon Jan 1 00:00:00 1965\x0D\x0A&quot;;</span>
<a href="#l32.38"></a><span id="l32.38" class="difflineminus">-</span>
<a href="#l32.39"></a><span id="l32.39" class="difflineminus">-#ifdef IMPORT_DEBUG</span>
<a href="#l32.40"></a><span id="l32.40" class="difflineminus">-void DUMP_FILENAME(nsIFile *pFile, bool endLine);</span>
<a href="#l32.41"></a><span id="l32.41" class="difflineminus">-</span>
<a href="#l32.42"></a><span id="l32.42" class="difflineminus">-void DUMP_FILENAME(nsIFile *pFile, bool endLine)</span>
<a href="#l32.43"></a><span id="l32.43" class="difflineminus">-{</span>
<a href="#l32.44"></a><span id="l32.44" class="difflineminus">-  nsCString pPath;</span>
<a href="#l32.45"></a><span id="l32.45" class="difflineminus">-  if (pFile)</span>
<a href="#l32.46"></a><span id="l32.46" class="difflineminus">-    pFile-&gt;GetNativePath(pPath);</span>
<a href="#l32.47"></a><span id="l32.47" class="difflineminus">-  if (!pPath.IsEmpty())</span>
<a href="#l32.48"></a><span id="l32.48" class="difflineminus">-    IMPORT_LOG1(&quot;%s&quot;, pPath.get());</span>
<a href="#l32.49"></a><span id="l32.49" class="difflineminus">-  else</span>
<a href="#l32.50"></a><span id="l32.50" class="difflineminus">-    IMPORT_LOG0(&quot;Unknown&quot;);</span>
<a href="#l32.51"></a><span id="l32.51" class="difflineminus">-  if (endLine)</span>
<a href="#l32.52"></a><span id="l32.52" class="difflineminus">-    IMPORT_LOG0(&quot;\n&quot;);</span>
<a href="#l32.53"></a><span id="l32.53" class="difflineminus">-}</span>
<a href="#l32.54"></a><span id="l32.54" class="difflineminus">-</span>
<a href="#l32.55"></a><span id="l32.55" class="difflineminus">-// #define  DONT_DELETE_EUDORA_TEMP_FILES    1</span>
<a href="#l32.56"></a><span id="l32.56" class="difflineminus">-</span>
<a href="#l32.57"></a><span id="l32.57" class="difflineminus">-#else</span>
<a href="#l32.58"></a><span id="l32.58" class="difflineminus">-#define DUMP_FILENAME(x, y)</span>
<a href="#l32.59"></a><span id="l32.59" class="difflineminus">-#endif</span>
<a href="#l32.60"></a><span id="l32.60" class="difflineminus">-</span>
<a href="#l32.61"></a><span id="l32.61" class="difflineminus">-static const char *eudoraWeekDays[7] = {</span>
<a href="#l32.62"></a><span id="l32.62" class="difflineminus">-  &quot;Mon&quot;,</span>
<a href="#l32.63"></a><span id="l32.63" class="difflineminus">-  &quot;Tue&quot;,</span>
<a href="#l32.64"></a><span id="l32.64" class="difflineminus">-  &quot;Wed&quot;,</span>
<a href="#l32.65"></a><span id="l32.65" class="difflineminus">-  &quot;Thu&quot;,</span>
<a href="#l32.66"></a><span id="l32.66" class="difflineminus">-  &quot;Fri&quot;,</span>
<a href="#l32.67"></a><span id="l32.67" class="difflineminus">-  &quot;Sat&quot;,</span>
<a href="#l32.68"></a><span id="l32.68" class="difflineminus">-  &quot;Sun&quot;</span>
<a href="#l32.69"></a><span id="l32.69" class="difflineminus">-};</span>
<a href="#l32.70"></a><span id="l32.70" class="difflineminus">-</span>
<a href="#l32.71"></a><span id="l32.71" class="difflineminus">-static const char *eudoraMonths[12] = {</span>
<a href="#l32.72"></a><span id="l32.72" class="difflineminus">-  &quot;Jan&quot;,</span>
<a href="#l32.73"></a><span id="l32.73" class="difflineminus">-  &quot;Feb&quot;,</span>
<a href="#l32.74"></a><span id="l32.74" class="difflineminus">-  &quot;Mar&quot;,</span>
<a href="#l32.75"></a><span id="l32.75" class="difflineminus">-  &quot;Apr&quot;,</span>
<a href="#l32.76"></a><span id="l32.76" class="difflineminus">-  &quot;May&quot;,</span>
<a href="#l32.77"></a><span id="l32.77" class="difflineminus">-  &quot;Jun&quot;,</span>
<a href="#l32.78"></a><span id="l32.78" class="difflineminus">-  &quot;Jul&quot;,</span>
<a href="#l32.79"></a><span id="l32.79" class="difflineminus">-  &quot;Aug&quot;,</span>
<a href="#l32.80"></a><span id="l32.80" class="difflineminus">-  &quot;Sep&quot;,</span>
<a href="#l32.81"></a><span id="l32.81" class="difflineminus">-  &quot;Oct&quot;,</span>
<a href="#l32.82"></a><span id="l32.82" class="difflineminus">-  &quot;Nov&quot;,</span>
<a href="#l32.83"></a><span id="l32.83" class="difflineminus">-  &quot;Dec&quot;</span>
<a href="#l32.84"></a><span id="l32.84" class="difflineminus">-};</span>
<a href="#l32.85"></a><span id="l32.85" class="difflineminus">-</span>
<a href="#l32.86"></a><span id="l32.86" class="difflineminus">-uint16_t EudoraTOCEntry::GetMozillaStatusFlags()</span>
<a href="#l32.87"></a><span id="l32.87" class="difflineminus">-{</span>
<a href="#l32.88"></a><span id="l32.88" class="difflineminus">-  // Return the mozilla equivalent of flags that Eudora supports.</span>
<a href="#l32.89"></a><span id="l32.89" class="difflineminus">-  uint16_t  flags = 0;</span>
<a href="#l32.90"></a><span id="l32.90" class="difflineminus">-</span>
<a href="#l32.91"></a><span id="l32.91" class="difflineminus">-#ifndef XP_MACOSX</span>
<a href="#l32.92"></a><span id="l32.92" class="difflineminus">-  switch (m_State)</span>
<a href="#l32.93"></a><span id="l32.93" class="difflineminus">-  {</span>
<a href="#l32.94"></a><span id="l32.94" class="difflineminus">-    case MS_UNREAD:</span>
<a href="#l32.95"></a><span id="l32.95" class="difflineminus">-      flags = 0;</span>
<a href="#l32.96"></a><span id="l32.96" class="difflineminus">-      break;</span>
<a href="#l32.97"></a><span id="l32.97" class="difflineminus">-</span>
<a href="#l32.98"></a><span id="l32.98" class="difflineminus">-    case MS_READ:</span>
<a href="#l32.99"></a><span id="l32.99" class="difflineminus">-      flags = nsMsgMessageFlags::Read;</span>
<a href="#l32.100"></a><span id="l32.100" class="difflineminus">-      break;</span>
<a href="#l32.101"></a><span id="l32.101" class="difflineminus">-</span>
<a href="#l32.102"></a><span id="l32.102" class="difflineminus">-    case MS_REPLIED:</span>
<a href="#l32.103"></a><span id="l32.103" class="difflineminus">-      flags = nsMsgMessageFlags::Read | nsMsgMessageFlags::Replied;</span>
<a href="#l32.104"></a><span id="l32.104" class="difflineminus">-      break;</span>
<a href="#l32.105"></a><span id="l32.105" class="difflineminus">-</span>
<a href="#l32.106"></a><span id="l32.106" class="difflineminus">-    case MS_FORWARDED:</span>
<a href="#l32.107"></a><span id="l32.107" class="difflineminus">-      flags = nsMsgMessageFlags::Read | nsMsgMessageFlags::Forwarded;</span>
<a href="#l32.108"></a><span id="l32.108" class="difflineminus">-      break;</span>
<a href="#l32.109"></a><span id="l32.109" class="difflineminus">-</span>
<a href="#l32.110"></a><span id="l32.110" class="difflineminus">-    case MS_REDIRECT:</span>
<a href="#l32.111"></a><span id="l32.111" class="difflineminus">-      // Redirect doesn't really mean forwarded, but forwarded</span>
<a href="#l32.112"></a><span id="l32.112" class="difflineminus">-      // seems to be the closest equivalent for now.</span>
<a href="#l32.113"></a><span id="l32.113" class="difflineminus">-      flags = nsMsgMessageFlags::Read | nsMsgMessageFlags::Forwarded;</span>
<a href="#l32.114"></a><span id="l32.114" class="difflineminus">-      break;</span>
<a href="#l32.115"></a><span id="l32.115" class="difflineminus">-</span>
<a href="#l32.116"></a><span id="l32.116" class="difflineminus">-    case MS_UNSENDABLE:</span>
<a href="#l32.117"></a><span id="l32.117" class="difflineminus">-    case MS_SENDABLE:</span>
<a href="#l32.118"></a><span id="l32.118" class="difflineminus">-    case MS_QUEUED:</span>
<a href="#l32.119"></a><span id="l32.119" class="difflineminus">-    case MS_SENT:</span>
<a href="#l32.120"></a><span id="l32.120" class="difflineminus">-    case MS_UNSENT:</span>
<a href="#l32.121"></a><span id="l32.121" class="difflineminus">-    case MS_TIME_QUEUED:</span>
<a href="#l32.122"></a><span id="l32.122" class="difflineminus">-    case MS_SPOOLED:</span>
<a href="#l32.123"></a><span id="l32.123" class="difflineminus">-      // To do: Add more sent message flag handling.</span>
<a href="#l32.124"></a><span id="l32.124" class="difflineminus">-      flags = 0;</span>
<a href="#l32.125"></a><span id="l32.125" class="difflineminus">-      break;</span>
<a href="#l32.126"></a><span id="l32.126" class="difflineminus">-</span>
<a href="#l32.127"></a><span id="l32.127" class="difflineminus">-    case MS_RECOVERED:</span>
<a href="#l32.128"></a><span id="l32.128" class="difflineminus">-      flags = nsMsgMessageFlags::Read;</span>
<a href="#l32.129"></a><span id="l32.129" class="difflineminus">-      break;</span>
<a href="#l32.130"></a><span id="l32.130" class="difflineminus">-  }</span>
<a href="#l32.131"></a><span id="l32.131" class="difflineminus">-</span>
<a href="#l32.132"></a><span id="l32.132" class="difflineminus">-  // Range check priority just to be sure</span>
<a href="#l32.133"></a><span id="l32.133" class="difflineminus">-  if (m_Priority &lt; MSP_HIGHEST)</span>
<a href="#l32.134"></a><span id="l32.134" class="difflineminus">-    m_Priority = MSP_HIGHEST;</span>
<a href="#l32.135"></a><span id="l32.135" class="difflineminus">-  if (m_Priority &gt; MSP_LOWEST)</span>
<a href="#l32.136"></a><span id="l32.136" class="difflineminus">-    m_Priority = MSP_LOWEST;</span>
<a href="#l32.137"></a><span id="l32.137" class="difflineminus">-</span>
<a href="#l32.138"></a><span id="l32.138" class="difflineminus">-  // Translate priority into format used in mozilla status flags</span>
<a href="#l32.139"></a><span id="l32.139" class="difflineminus">-  // (which is reversed for some reason)</span>
<a href="#l32.140"></a><span id="l32.140" class="difflineminus">-  flags |= (7-m_Priority) &lt;&lt; 13;</span>
<a href="#l32.141"></a><span id="l32.141" class="difflineminus">-#endif</span>
<a href="#l32.142"></a><span id="l32.142" class="difflineminus">-</span>
<a href="#l32.143"></a><span id="l32.143" class="difflineminus">-  return flags;</span>
<a href="#l32.144"></a><span id="l32.144" class="difflineminus">-}</span>
<a href="#l32.145"></a><span id="l32.145" class="difflineminus">-</span>
<a href="#l32.146"></a><span id="l32.146" class="difflineminus">-uint32_t EudoraTOCEntry::GetMozillaStatus2Flags()</span>
<a href="#l32.147"></a><span id="l32.147" class="difflineminus">-{</span>
<a href="#l32.148"></a><span id="l32.148" class="difflineminus">-#ifdef XP_MACOSX</span>
<a href="#l32.149"></a><span id="l32.149" class="difflineminus">-  return 0;</span>
<a href="#l32.150"></a><span id="l32.150" class="difflineminus">-#else</span>
<a href="#l32.151"></a><span id="l32.151" class="difflineminus">-</span>
<a href="#l32.152"></a><span id="l32.152" class="difflineminus">-  // Return the mozilla equivalent of flags that Eudora supports.</span>
<a href="#l32.153"></a><span id="l32.153" class="difflineminus">-  uint32_t  flags = 0;</span>
<a href="#l32.154"></a><span id="l32.154" class="difflineminus">-</span>
<a href="#l32.155"></a><span id="l32.155" class="difflineminus">-  if (m_Imflags &amp; IMFLAGS_DELETED)</span>
<a href="#l32.156"></a><span id="l32.156" class="difflineminus">-    flags |= nsMsgMessageFlags::IMAPDeleted;</span>
<a href="#l32.157"></a><span id="l32.157" class="difflineminus">-</span>
<a href="#l32.158"></a><span id="l32.158" class="difflineminus">-  if (m_Flags &amp; MSF_READ_RECEIPT)</span>
<a href="#l32.159"></a><span id="l32.159" class="difflineminus">-    flags |= nsMsgMessageFlags::MDNReportNeeded;</span>
<a href="#l32.160"></a><span id="l32.160" class="difflineminus">-</span>
<a href="#l32.161"></a><span id="l32.161" class="difflineminus">-  return flags;</span>
<a href="#l32.162"></a><span id="l32.162" class="difflineminus">-#endif</span>
<a href="#l32.163"></a><span id="l32.163" class="difflineminus">-}</span>
<a href="#l32.164"></a><span id="l32.164" class="difflineminus">-</span>
<a href="#l32.165"></a><span id="l32.165" class="difflineminus">-nsEudoraMailbox::nsEudoraMailbox()</span>
<a href="#l32.166"></a><span id="l32.166" class="difflineminus">-: m_fromLen(0)</span>
<a href="#l32.167"></a><span id="l32.167" class="difflineminus">-{</span>
<a href="#l32.168"></a><span id="l32.168" class="difflineminus">-}</span>
<a href="#l32.169"></a><span id="l32.169" class="difflineminus">-</span>
<a href="#l32.170"></a><span id="l32.170" class="difflineminus">-nsEudoraMailbox::~nsEudoraMailbox()</span>
<a href="#l32.171"></a><span id="l32.171" class="difflineminus">-{</span>
<a href="#l32.172"></a><span id="l32.172" class="difflineminus">-  EmptyAttachments();</span>
<a href="#l32.173"></a><span id="l32.173" class="difflineminus">-}</span>
<a href="#l32.174"></a><span id="l32.174" class="difflineminus">-</span>
<a href="#l32.175"></a><span id="l32.175" class="difflineminus">-nsresult nsEudoraMailbox::CreateTempFile(nsIFile **ppFile)</span>
<a href="#l32.176"></a><span id="l32.176" class="difflineminus">-{</span>
<a href="#l32.177"></a><span id="l32.177" class="difflineminus">-  nsresult rv = GetSpecialDirectoryWithFileName(NS_OS_TEMP_DIR,</span>
<a href="#l32.178"></a><span id="l32.178" class="difflineminus">-                                                &quot;impmail.txt&quot;,</span>
<a href="#l32.179"></a><span id="l32.179" class="difflineminus">-                                                ppFile);</span>
<a href="#l32.180"></a><span id="l32.180" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.181"></a><span id="l32.181" class="difflineminus">-</span>
<a href="#l32.182"></a><span id="l32.182" class="difflineminus">-  return (*ppFile)-&gt;CreateUnique(nsIFile::NORMAL_FILE_TYPE, 00600);</span>
<a href="#l32.183"></a><span id="l32.183" class="difflineminus">-}</span>
<a href="#l32.184"></a><span id="l32.184" class="difflineminus">-</span>
<a href="#l32.185"></a><span id="l32.185" class="difflineminus">-nsresult nsEudoraMailbox::DeleteFile(nsIFile *pFile)</span>
<a href="#l32.186"></a><span id="l32.186" class="difflineminus">-{</span>
<a href="#l32.187"></a><span id="l32.187" class="difflineminus">-  bool      result;</span>
<a href="#l32.188"></a><span id="l32.188" class="difflineminus">-  nsresult  rv = NS_OK;</span>
<a href="#l32.189"></a><span id="l32.189" class="difflineminus">-</span>
<a href="#l32.190"></a><span id="l32.190" class="difflineminus">-  result = false;</span>
<a href="#l32.191"></a><span id="l32.191" class="difflineminus">-  pFile-&gt;Exists(&amp;result);</span>
<a href="#l32.192"></a><span id="l32.192" class="difflineminus">-  if (result) {</span>
<a href="#l32.193"></a><span id="l32.193" class="difflineminus">-    result = false;</span>
<a href="#l32.194"></a><span id="l32.194" class="difflineminus">-    pFile-&gt;IsFile(&amp;result);</span>
<a href="#l32.195"></a><span id="l32.195" class="difflineminus">-    if (result) {</span>
<a href="#l32.196"></a><span id="l32.196" class="difflineminus">-#ifndef DONT_DELETE_EUDORA_TEMP_FILES</span>
<a href="#l32.197"></a><span id="l32.197" class="difflineminus">-        rv = pFile-&gt;Remove(false);</span>
<a href="#l32.198"></a><span id="l32.198" class="difflineminus">-#endif</span>
<a href="#l32.199"></a><span id="l32.199" class="difflineminus">-    }</span>
<a href="#l32.200"></a><span id="l32.200" class="difflineminus">-  }</span>
<a href="#l32.201"></a><span id="l32.201" class="difflineminus">-  return rv;</span>
<a href="#l32.202"></a><span id="l32.202" class="difflineminus">-}</span>
<a href="#l32.203"></a><span id="l32.203" class="difflineminus">-</span>
<a href="#l32.204"></a><span id="l32.204" class="difflineminus">-#define kComposeErrorStr  &quot;X-Eudora-Compose-Error: *****&quot; &quot;\x0D\x0A&quot;</span>
<a href="#l32.205"></a><span id="l32.205" class="difflineminus">-#define kHTMLTag &quot;&lt;html&gt;&quot;</span>
<a href="#l32.206"></a><span id="l32.206" class="difflineminus">-</span>
<a href="#l32.207"></a><span id="l32.207" class="difflineminus">-nsresult nsEudoraMailbox::ImportMailbox(uint32_t *pBytes, bool *pAbort,</span>
<a href="#l32.208"></a><span id="l32.208" class="difflineminus">-                                        const char16_t *pName, nsIFile *pSrc,</span>
<a href="#l32.209"></a><span id="l32.209" class="difflineminus">-                                        nsIMsgFolder *dstFolder,</span>
<a href="#l32.210"></a><span id="l32.210" class="difflineminus">-                                        int32_t *pMsgCount)</span>
<a href="#l32.211"></a><span id="l32.211" class="difflineminus">-{</span>
<a href="#l32.212"></a><span id="l32.212" class="difflineminus">-  nsCOMPtr&lt;nsIFile&gt;   tocFile;</span>
<a href="#l32.213"></a><span id="l32.213" class="difflineminus">-  nsCOMPtr&lt;nsIInputStream&gt; srcInputStream;</span>
<a href="#l32.214"></a><span id="l32.214" class="difflineminus">-  nsCOMPtr&lt;nsIInputStream&gt; tocInputStream;</span>
<a href="#l32.215"></a><span id="l32.215" class="difflineminus">-  nsCOMPtr&lt;nsIOutputStream&gt; mailOutputStream;</span>
<a href="#l32.216"></a><span id="l32.216" class="difflineminus">-  bool                importWithoutToc = true;</span>
<a href="#l32.217"></a><span id="l32.217" class="difflineminus">-  bool                deleteToc = false;</span>
<a href="#l32.218"></a><span id="l32.218" class="difflineminus">-  nsCOMPtr&lt;nsIFile&gt;   mailFile;</span>
<a href="#l32.219"></a><span id="l32.219" class="difflineminus">-</span>
<a href="#l32.220"></a><span id="l32.220" class="difflineminus">-  if (pMsgCount)</span>
<a href="#l32.221"></a><span id="l32.221" class="difflineminus">-    *pMsgCount = 0;</span>
<a href="#l32.222"></a><span id="l32.222" class="difflineminus">-</span>
<a href="#l32.223"></a><span id="l32.223" class="difflineminus">-  nsresult rv = pSrc-&gt;GetFileSize(&amp;m_mailSize);</span>
<a href="#l32.224"></a><span id="l32.224" class="difflineminus">-</span>
<a href="#l32.225"></a><span id="l32.225" class="difflineminus">-  rv = NS_NewLocalFileInputStream(getter_AddRefs(srcInputStream), pSrc);</span>
<a href="#l32.226"></a><span id="l32.226" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.227"></a><span id="l32.227" class="difflineminus">-</span>
<a href="#l32.228"></a><span id="l32.228" class="difflineminus">-  nsCOMPtr&lt;nsIFile&gt; srcFile(pSrc);</span>
<a href="#l32.229"></a><span id="l32.229" class="difflineminus">-</span>
<a href="#l32.230"></a><span id="l32.230" class="difflineminus">-  // First, get the index file for this mailbox</span>
<a href="#l32.231"></a><span id="l32.231" class="difflineminus">-  rv = FindTOCFile(pSrc, getter_AddRefs(tocFile), &amp;deleteToc);</span>
<a href="#l32.232"></a><span id="l32.232" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; tocFile)</span>
<a href="#l32.233"></a><span id="l32.233" class="difflineminus">-  {</span>
<a href="#l32.234"></a><span id="l32.234" class="difflineminus">-    IMPORT_LOG0(&quot;Reading euroda toc file: &quot;);</span>
<a href="#l32.235"></a><span id="l32.235" class="difflineminus">-    DUMP_FILENAME(tocFile, true);</span>
<a href="#l32.236"></a><span id="l32.236" class="difflineminus">-</span>
<a href="#l32.237"></a><span id="l32.237" class="difflineminus">-    // Read the toc and import the messages</span>
<a href="#l32.238"></a><span id="l32.238" class="difflineminus">-    rv = ImportMailboxUsingTOC(pBytes, pAbort, srcInputStream, tocFile,</span>
<a href="#l32.239"></a><span id="l32.239" class="difflineminus">-                               dstFolder, pMsgCount);</span>
<a href="#l32.240"></a><span id="l32.240" class="difflineminus">-</span>
<a href="#l32.241"></a><span id="l32.241" class="difflineminus">-    // clean up</span>
<a href="#l32.242"></a><span id="l32.242" class="difflineminus">-    if (deleteToc)</span>
<a href="#l32.243"></a><span id="l32.243" class="difflineminus">-      DeleteFile(tocFile);</span>
<a href="#l32.244"></a><span id="l32.244" class="difflineminus">-</span>
<a href="#l32.245"></a><span id="l32.245" class="difflineminus">-    // If we were able to import with the TOC, then we don't need to bother</span>
<a href="#l32.246"></a><span id="l32.246" class="difflineminus">-    // importing without the TOC.</span>
<a href="#l32.247"></a><span id="l32.247" class="difflineminus">-    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l32.248"></a><span id="l32.248" class="difflineminus">-      importWithoutToc = false;</span>
<a href="#l32.249"></a><span id="l32.249" class="difflineminus">-      IMPORT_LOG0(&quot;Imported mailbox: &quot;); DUMP_FILENAME(pSrc, false);</span>
<a href="#l32.250"></a><span id="l32.250" class="difflineminus">-      IMPORT_LOG0(&quot;  Using TOC: &quot;); DUMP_FILENAME(tocFile, true);</span>
<a href="#l32.251"></a><span id="l32.251" class="difflineminus">-    }</span>
<a href="#l32.252"></a><span id="l32.252" class="difflineminus">-    else {</span>
<a href="#l32.253"></a><span id="l32.253" class="difflineminus">-      IMPORT_LOG0(&quot;*** Error importing with TOC - will import without TOC.\n&quot;);</span>
<a href="#l32.254"></a><span id="l32.254" class="difflineminus">-    }</span>
<a href="#l32.255"></a><span id="l32.255" class="difflineminus">-  }</span>
<a href="#l32.256"></a><span id="l32.256" class="difflineminus">-</span>
<a href="#l32.257"></a><span id="l32.257" class="difflineminus">-  // pSrc must be Released before returning</span>
<a href="#l32.258"></a><span id="l32.258" class="difflineminus">-</span>
<a href="#l32.259"></a><span id="l32.259" class="difflineminus">-  if (importWithoutToc) {</span>
<a href="#l32.260"></a><span id="l32.260" class="difflineminus">-    // The source file contains partially constructed mail messages,</span>
<a href="#l32.261"></a><span id="l32.261" class="difflineminus">-    // and attachments.  We should first investigate if we can use the mailnews msgCompose</span>
<a href="#l32.262"></a><span id="l32.262" class="difflineminus">-    // stuff to do the work for us.  If not we have to scan the mailboxes and do TONS</span>
<a href="#l32.263"></a><span id="l32.263" class="difflineminus">-    // of work to properly reconstruct the message - Eudora is so nice that it strips things</span>
<a href="#l32.264"></a><span id="l32.264" class="difflineminus">-    // like MIME headers, character encoding, and attachments - beautiful!</span>
<a href="#l32.265"></a><span id="l32.265" class="difflineminus">-</span>
<a href="#l32.266"></a><span id="l32.266" class="difflineminus">-    rv = pSrc-&gt;GetFileSize(&amp;m_mailSize);</span>
<a href="#l32.267"></a><span id="l32.267" class="difflineminus">-</span>
<a href="#l32.268"></a><span id="l32.268" class="difflineminus">-    SimpleBufferTonyRCopiedOnce    readBuffer;</span>
<a href="#l32.269"></a><span id="l32.269" class="difflineminus">-    SimpleBufferTonyRCopiedOnce    headers;</span>
<a href="#l32.270"></a><span id="l32.270" class="difflineminus">-    SimpleBufferTonyRCopiedOnce    body;</span>
<a href="#l32.271"></a><span id="l32.271" class="difflineminus">-    SimpleBufferTonyRCopiedOnce    copy;</span>
<a href="#l32.272"></a><span id="l32.272" class="difflineminus">-</span>
<a href="#l32.273"></a><span id="l32.273" class="difflineminus">-    headers.m_convertCRs = true;</span>
<a href="#l32.274"></a><span id="l32.274" class="difflineminus">-    body.m_convertCRs = true;</span>
<a href="#l32.275"></a><span id="l32.275" class="difflineminus">-</span>
<a href="#l32.276"></a><span id="l32.276" class="difflineminus">-    copy.Allocate(kCopyBufferSize);</span>
<a href="#l32.277"></a><span id="l32.277" class="difflineminus">-    readBuffer.Allocate(kMailReadBufferSize);</span>
<a href="#l32.278"></a><span id="l32.278" class="difflineminus">-    ReadFileState      state;</span>
<a href="#l32.279"></a><span id="l32.279" class="difflineminus">-    state.offset = 0;</span>
<a href="#l32.280"></a><span id="l32.280" class="difflineminus">-    state.size = m_mailSize;</span>
<a href="#l32.281"></a><span id="l32.281" class="difflineminus">-    state.pFile = pSrc;</span>
<a href="#l32.282"></a><span id="l32.282" class="difflineminus">-</span>
<a href="#l32.283"></a><span id="l32.283" class="difflineminus">-    IMPORT_LOG0(&quot;Reading mailbox\n&quot;);</span>
<a href="#l32.284"></a><span id="l32.284" class="difflineminus">-</span>
<a href="#l32.285"></a><span id="l32.285" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l32.286"></a><span id="l32.286" class="difflineminus">-    {</span>
<a href="#l32.287"></a><span id="l32.287" class="difflineminus">-      nsCString defaultDate;</span>
<a href="#l32.288"></a><span id="l32.288" class="difflineminus">-      nsAutoCString bodyType;</span>
<a href="#l32.289"></a><span id="l32.289" class="difflineminus">-</span>
<a href="#l32.290"></a><span id="l32.290" class="difflineminus">-      IMPORT_LOG0(&quot;Reading first message\n&quot;);</span>
<a href="#l32.291"></a><span id="l32.291" class="difflineminus">-</span>
<a href="#l32.292"></a><span id="l32.292" class="difflineminus">-      nsCOMPtr&lt;nsIOutputStream&gt; outputStream;</span>
<a href="#l32.293"></a><span id="l32.293" class="difflineminus">-      nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l32.294"></a><span id="l32.294" class="difflineminus">-      rv = dstFolder-&gt;GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l32.295"></a><span id="l32.295" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.296"></a><span id="l32.296" class="difflineminus">-</span>
<a href="#l32.297"></a><span id="l32.297" class="difflineminus">-      while (!*pAbort &amp;&amp; NS_SUCCEEDED(rv = ReadNextMessage( &amp;state, readBuffer, headers, body, defaultDate, bodyType, NULL))) {</span>
<a href="#l32.298"></a><span id="l32.298" class="difflineminus">-</span>
<a href="#l32.299"></a><span id="l32.299" class="difflineminus">-        if (pBytes)</span>
<a href="#l32.300"></a><span id="l32.300" class="difflineminus">-          *pBytes += body.m_writeOffset - 1 + headers.m_writeOffset - 1;</span>
<a href="#l32.301"></a><span id="l32.301" class="difflineminus">-</span>
<a href="#l32.302"></a><span id="l32.302" class="difflineminus">-        nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l32.303"></a><span id="l32.303" class="difflineminus">-        bool reusable;</span>
<a href="#l32.304"></a><span id="l32.304" class="difflineminus">-</span>
<a href="#l32.305"></a><span id="l32.305" class="difflineminus">-        rv = msgStore-&gt;GetNewMsgOutputStream(dstFolder, getter_AddRefs(msgHdr), &amp;reusable,</span>
<a href="#l32.306"></a><span id="l32.306" class="difflineminus">-                                             getter_AddRefs(outputStream));</span>
<a href="#l32.307"></a><span id="l32.307" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l32.308"></a><span id="l32.308" class="difflineminus">-          break;</span>
<a href="#l32.309"></a><span id="l32.309" class="difflineminus">-</span>
<a href="#l32.310"></a><span id="l32.310" class="difflineminus">-        rv = ImportMessage(headers, body, defaultDate, bodyType, outputStream, pMsgCount);</span>
<a href="#l32.311"></a><span id="l32.311" class="difflineminus">-</span>
<a href="#l32.312"></a><span id="l32.312" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l32.313"></a><span id="l32.313" class="difflineminus">-          msgStore-&gt;FinishNewMessage(outputStream, msgHdr);</span>
<a href="#l32.314"></a><span id="l32.314" class="difflineminus">-        else {</span>
<a href="#l32.315"></a><span id="l32.315" class="difflineminus">-          msgStore-&gt;DiscardNewMessage(outputStream, msgHdr);</span>
<a href="#l32.316"></a><span id="l32.316" class="difflineminus">-          IMPORT_LOG0( &quot;*** Error importing message\n&quot;);</span>
<a href="#l32.317"></a><span id="l32.317" class="difflineminus">-        }</span>
<a href="#l32.318"></a><span id="l32.318" class="difflineminus">-</span>
<a href="#l32.319"></a><span id="l32.319" class="difflineminus">-        if (!reusable)</span>
<a href="#l32.320"></a><span id="l32.320" class="difflineminus">-          outputStream-&gt;Close();</span>
<a href="#l32.321"></a><span id="l32.321" class="difflineminus">-</span>
<a href="#l32.322"></a><span id="l32.322" class="difflineminus">-        if (!readBuffer.m_bytesInBuf &amp;&amp; (state.offset &gt;= state.size))</span>
<a href="#l32.323"></a><span id="l32.323" class="difflineminus">-          break;</span>
<a href="#l32.324"></a><span id="l32.324" class="difflineminus">-      }</span>
<a href="#l32.325"></a><span id="l32.325" class="difflineminus">-      if (outputStream)</span>
<a href="#l32.326"></a><span id="l32.326" class="difflineminus">-        outputStream-&gt;Close();</span>
<a href="#l32.327"></a><span id="l32.327" class="difflineminus">-    }</span>
<a href="#l32.328"></a><span id="l32.328" class="difflineminus">-    else {</span>
<a href="#l32.329"></a><span id="l32.329" class="difflineminus">-      IMPORT_LOG0(&quot;*** Error creating file spec for composition\n&quot;);</span>
<a href="#l32.330"></a><span id="l32.330" class="difflineminus">-    }</span>
<a href="#l32.331"></a><span id="l32.331" class="difflineminus">-  }</span>
<a href="#l32.332"></a><span id="l32.332" class="difflineminus">-  return rv;</span>
<a href="#l32.333"></a><span id="l32.333" class="difflineminus">-}</span>
<a href="#l32.334"></a><span id="l32.334" class="difflineminus">-</span>
<a href="#l32.335"></a><span id="l32.335" class="difflineminus">-#ifdef XP_MACOSX</span>
<a href="#l32.336"></a><span id="l32.336" class="difflineminus">-#define kMsgHeaderSize    220</span>
<a href="#l32.337"></a><span id="l32.337" class="difflineminus">-#define  kMsgFirstOffset    278</span>
<a href="#l32.338"></a><span id="l32.338" class="difflineminus">-#else</span>
<a href="#l32.339"></a><span id="l32.339" class="difflineminus">-#define  kMsgHeaderSize    218</span>
<a href="#l32.340"></a><span id="l32.340" class="difflineminus">-#define kMsgFirstOffset    104</span>
<a href="#l32.341"></a><span id="l32.341" class="difflineminus">-#endif</span>
<a href="#l32.342"></a><span id="l32.342" class="difflineminus">-</span>
<a href="#l32.343"></a><span id="l32.343" class="difflineminus">-nsresult nsEudoraMailbox::ImportMailboxUsingTOC(</span>
<a href="#l32.344"></a><span id="l32.344" class="difflineminus">-  uint32_t *pBytes,</span>
<a href="#l32.345"></a><span id="l32.345" class="difflineminus">-  bool *pAbort,</span>
<a href="#l32.346"></a><span id="l32.346" class="difflineminus">-  nsIInputStream *pInputStream,</span>
<a href="#l32.347"></a><span id="l32.347" class="difflineminus">-  nsIFile *tocFile,</span>
<a href="#l32.348"></a><span id="l32.348" class="difflineminus">-  nsIMsgFolder *dstFolder,</span>
<a href="#l32.349"></a><span id="l32.349" class="difflineminus">-  int32_t *pMsgCount)</span>
<a href="#l32.350"></a><span id="l32.350" class="difflineminus">-{</span>
<a href="#l32.351"></a><span id="l32.351" class="difflineminus">-  nsresult        rv = NS_OK;</span>
<a href="#l32.352"></a><span id="l32.352" class="difflineminus">-</span>
<a href="#l32.353"></a><span id="l32.353" class="difflineminus">-  int64_t  mailSize = m_mailSize;</span>
<a href="#l32.354"></a><span id="l32.354" class="difflineminus">-  int64_t  tocSize = 0;</span>
<a href="#l32.355"></a><span id="l32.355" class="difflineminus">-  uint32_t  saveBytes = pBytes ? *pBytes : 0;</span>
<a href="#l32.356"></a><span id="l32.356" class="difflineminus">-  nsCOMPtr &lt;nsIInputStream&gt; tocInputStream;</span>
<a href="#l32.357"></a><span id="l32.357" class="difflineminus">-</span>
<a href="#l32.358"></a><span id="l32.358" class="difflineminus">-  rv = tocFile-&gt;GetFileSize(&amp;tocSize);</span>
<a href="#l32.359"></a><span id="l32.359" class="difflineminus">-</span>
<a href="#l32.360"></a><span id="l32.360" class="difflineminus">-  // if the index or the mail file is empty then just</span>
<a href="#l32.361"></a><span id="l32.361" class="difflineminus">-  // use the original mail file.</span>
<a href="#l32.362"></a><span id="l32.362" class="difflineminus">-  if (!mailSize || !tocSize)</span>
<a href="#l32.363"></a><span id="l32.363" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l32.364"></a><span id="l32.364" class="difflineminus">-  rv = NS_NewLocalFileInputStream(getter_AddRefs(tocInputStream), tocFile);</span>
<a href="#l32.365"></a><span id="l32.365" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.366"></a><span id="l32.366" class="difflineminus">-</span>
<a href="#l32.367"></a><span id="l32.367" class="difflineminus">-  SimpleBufferTonyRCopiedOnce readBuffer;</span>
<a href="#l32.368"></a><span id="l32.368" class="difflineminus">-  SimpleBufferTonyRCopiedOnce headers;</span>
<a href="#l32.369"></a><span id="l32.369" class="difflineminus">-  SimpleBufferTonyRCopiedOnce body;</span>
<a href="#l32.370"></a><span id="l32.370" class="difflineminus">-  SimpleBufferTonyRCopiedOnce copy;</span>
<a href="#l32.371"></a><span id="l32.371" class="difflineminus">-  int32_t tocOffset = kMsgFirstOffset;</span>
<a href="#l32.372"></a><span id="l32.372" class="difflineminus">-  EudoraTOCEntry tocEntry;</span>
<a href="#l32.373"></a><span id="l32.373" class="difflineminus">-</span>
<a href="#l32.374"></a><span id="l32.374" class="difflineminus">-  copy.Allocate(kCopyBufferSize);</span>
<a href="#l32.375"></a><span id="l32.375" class="difflineminus">-  readBuffer.Allocate(kMailReadBufferSize);</span>
<a href="#l32.376"></a><span id="l32.376" class="difflineminus">-</span>
<a href="#l32.377"></a><span id="l32.377" class="difflineminus">-  IMPORT_LOG0(&quot;Importing mailbox using TOC: &quot;);</span>
<a href="#l32.378"></a><span id="l32.378" class="difflineminus">-  DUMP_FILENAME(tocFile, true);</span>
<a href="#l32.379"></a><span id="l32.379" class="difflineminus">-</span>
<a href="#l32.380"></a><span id="l32.380" class="difflineminus">-  nsCOMPtr&lt;nsISeekableStream&gt; tocSeekableStream = do_QueryInterface(tocInputStream);</span>
<a href="#l32.381"></a><span id="l32.381" class="difflineminus">-  nsCOMPtr&lt;nsISeekableStream&gt; mailboxSeekableStream = do_QueryInterface(pInputStream);</span>
<a href="#l32.382"></a><span id="l32.382" class="difflineminus">-  nsCOMPtr&lt;nsIOutputStream&gt; outputStream;</span>
<a href="#l32.383"></a><span id="l32.383" class="difflineminus">-  nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l32.384"></a><span id="l32.384" class="difflineminus">-</span>
<a href="#l32.385"></a><span id="l32.385" class="difflineminus">-  rv = dstFolder-&gt;GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l32.386"></a><span id="l32.386" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.387"></a><span id="l32.387" class="difflineminus">-</span>
<a href="#l32.388"></a><span id="l32.388" class="difflineminus">-  while (!*pAbort &amp;&amp; (tocOffset &lt; (int32_t)tocSize)) {</span>
<a href="#l32.389"></a><span id="l32.389" class="difflineminus">-    if (NS_FAILED(rv = tocSeekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, tocOffset)))</span>
<a href="#l32.390"></a><span id="l32.390" class="difflineminus">-      break;</span>
<a href="#l32.391"></a><span id="l32.391" class="difflineminus">-</span>
<a href="#l32.392"></a><span id="l32.392" class="difflineminus">-    if (NS_FAILED(rv = ReadTOCEntry(tocInputStream, tocEntry)))</span>
<a href="#l32.393"></a><span id="l32.393" class="difflineminus">-      break;</span>
<a href="#l32.394"></a><span id="l32.394" class="difflineminus">-</span>
<a href="#l32.395"></a><span id="l32.395" class="difflineminus">-    nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l32.396"></a><span id="l32.396" class="difflineminus">-    bool reusable;</span>
<a href="#l32.397"></a><span id="l32.397" class="difflineminus">-</span>
<a href="#l32.398"></a><span id="l32.398" class="difflineminus">-    rv = msgStore-&gt;GetNewMsgOutputStream(dstFolder, getter_AddRefs(msgHdr), &amp;reusable,</span>
<a href="#l32.399"></a><span id="l32.399" class="difflineminus">-                                         getter_AddRefs(outputStream));</span>
<a href="#l32.400"></a><span id="l32.400" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l32.401"></a><span id="l32.401" class="difflineminus">-      break;</span>
<a href="#l32.402"></a><span id="l32.402" class="difflineminus">-</span>
<a href="#l32.403"></a><span id="l32.403" class="difflineminus">-    // Quick and dirty way to read in and parse the message the way the rest</span>
<a href="#l32.404"></a><span id="l32.404" class="difflineminus">-    // of the code expects.</span>
<a href="#l32.405"></a><span id="l32.405" class="difflineminus">-    nsCString              defaultDate;</span>
<a href="#l32.406"></a><span id="l32.406" class="difflineminus">-    nsAutoCString            bodyType;</span>
<a href="#l32.407"></a><span id="l32.407" class="difflineminus">-    ReadFileState            state;</span>
<a href="#l32.408"></a><span id="l32.408" class="difflineminus">-</span>
<a href="#l32.409"></a><span id="l32.409" class="difflineminus">-    // Seek to the start of the email message.</span>
<a href="#l32.410"></a><span id="l32.410" class="difflineminus">-    mailboxSeekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, tocEntry.m_Offset);</span>
<a href="#l32.411"></a><span id="l32.411" class="difflineminus">-</span>
<a href="#l32.412"></a><span id="l32.412" class="difflineminus">-    // We're fudging the data to make ReadNextMessage happy. In particular</span>
<a href="#l32.413"></a><span id="l32.413" class="difflineminus">-    // state.size is meant to be the size of the entire file, because it's</span>
<a href="#l32.414"></a><span id="l32.414" class="difflineminus">-    // assumed that ReadNextMessage will actually have to parse. We know</span>
<a href="#l32.415"></a><span id="l32.415" class="difflineminus">-    // exactly how big the message is, so we simply set the &quot;size&quot; to be</span>
<a href="#l32.416"></a><span id="l32.416" class="difflineminus">-    // immediately where the message ends.</span>
<a href="#l32.417"></a><span id="l32.417" class="difflineminus">-    state.offset = tocEntry.m_Offset;</span>
<a href="#l32.418"></a><span id="l32.418" class="difflineminus">-    state.pInputStream = pInputStream;</span>
<a href="#l32.419"></a><span id="l32.419" class="difflineminus">-    state.size = state.offset + tocEntry.m_Length;</span>
<a href="#l32.420"></a><span id="l32.420" class="difflineminus">-</span>
<a href="#l32.421"></a><span id="l32.421" class="difflineminus">-    if (NS_SUCCEEDED(rv = ReadNextMessage(&amp;state, readBuffer, headers, body, defaultDate, bodyType, &amp;tocEntry)))</span>
<a href="#l32.422"></a><span id="l32.422" class="difflineminus">-    {</span>
<a href="#l32.423"></a><span id="l32.423" class="difflineminus">-      rv = ImportMessage(headers, body, defaultDate, bodyType, outputStream,</span>
<a href="#l32.424"></a><span id="l32.424" class="difflineminus">-                         pMsgCount);</span>
<a href="#l32.425"></a><span id="l32.425" class="difflineminus">-</span>
<a href="#l32.426"></a><span id="l32.426" class="difflineminus">-      if (pBytes)</span>
<a href="#l32.427"></a><span id="l32.427" class="difflineminus">-        *pBytes += tocEntry.m_Length;</span>
<a href="#l32.428"></a><span id="l32.428" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l32.429"></a><span id="l32.429" class="difflineminus">-        msgStore-&gt;FinishNewMessage(outputStream, msgHdr);</span>
<a href="#l32.430"></a><span id="l32.430" class="difflineminus">-      else {</span>
<a href="#l32.431"></a><span id="l32.431" class="difflineminus">-        msgStore-&gt;DiscardNewMessage(outputStream, msgHdr);</span>
<a href="#l32.432"></a><span id="l32.432" class="difflineminus">-        IMPORT_LOG0( &quot;*** Error importing message\n&quot;);</span>
<a href="#l32.433"></a><span id="l32.433" class="difflineminus">-      }</span>
<a href="#l32.434"></a><span id="l32.434" class="difflineminus">-    }</span>
<a href="#l32.435"></a><span id="l32.435" class="difflineminus">-</span>
<a href="#l32.436"></a><span id="l32.436" class="difflineminus">-    // We currently don't consider an error from ReadNextMessage or ImportMessage to be fatal.</span>
<a href="#l32.437"></a><span id="l32.437" class="difflineminus">-    // Reset the error back to no error in case this is the last time through the loop.</span>
<a href="#l32.438"></a><span id="l32.438" class="difflineminus">-    rv = NS_OK;</span>
<a href="#l32.439"></a><span id="l32.439" class="difflineminus">-</span>
<a href="#l32.440"></a><span id="l32.440" class="difflineminus">-    tocOffset += kMsgHeaderSize;</span>
<a href="#l32.441"></a><span id="l32.441" class="difflineminus">-</span>
<a href="#l32.442"></a><span id="l32.442" class="difflineminus">-    if (!reusable)</span>
<a href="#l32.443"></a><span id="l32.443" class="difflineminus">-      outputStream-&gt;Close();</span>
<a href="#l32.444"></a><span id="l32.444" class="difflineminus">-  }</span>
<a href="#l32.445"></a><span id="l32.445" class="difflineminus">-  if (outputStream)</span>
<a href="#l32.446"></a><span id="l32.446" class="difflineminus">-    outputStream-&gt;Close();</span>
<a href="#l32.447"></a><span id="l32.447" class="difflineminus">-</span>
<a href="#l32.448"></a><span id="l32.448" class="difflineminus">-  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l32.449"></a><span id="l32.449" class="difflineminus">-    IMPORT_LOG0(&quot; finished\n&quot;);</span>
<a href="#l32.450"></a><span id="l32.450" class="difflineminus">-  }</span>
<a href="#l32.451"></a><span id="l32.451" class="difflineminus">-  else {</span>
<a href="#l32.452"></a><span id="l32.452" class="difflineminus">-    // We failed somewhere important enough that we kept the error.</span>
<a href="#l32.453"></a><span id="l32.453" class="difflineminus">-    // Bail on all that we imported since we'll be importing everything</span>
<a href="#l32.454"></a><span id="l32.454" class="difflineminus">-    // again using just the mailbox.</span>
<a href="#l32.455"></a><span id="l32.455" class="difflineminus">-    IMPORT_LOG0(&quot;*** Error importing mailbox using TOC: &quot;);</span>
<a href="#l32.456"></a><span id="l32.456" class="difflineminus">-//    DUMP_FILENAME(pMail, true);</span>
<a href="#l32.457"></a><span id="l32.457" class="difflineminus">-</span>
<a href="#l32.458"></a><span id="l32.458" class="difflineminus">-    // Reset pBytes back to where it was before we imported this mailbox.</span>
<a href="#l32.459"></a><span id="l32.459" class="difflineminus">-    // This will likely result in a funky progress bar which will move</span>
<a href="#l32.460"></a><span id="l32.460" class="difflineminus">-    // backwards, but that's probably the best we can do to keep the</span>
<a href="#l32.461"></a><span id="l32.461" class="difflineminus">-    // progress accurate since we'll be re-importing the same mailbox.</span>
<a href="#l32.462"></a><span id="l32.462" class="difflineminus">-    if (pBytes)</span>
<a href="#l32.463"></a><span id="l32.463" class="difflineminus">-      *pBytes = saveBytes;</span>
<a href="#l32.464"></a><span id="l32.464" class="difflineminus">-</span>
<a href="#l32.465"></a><span id="l32.465" class="difflineminus">-    // Set the message count back to 0.</span>
<a href="#l32.466"></a><span id="l32.466" class="difflineminus">-    if (pMsgCount)</span>
<a href="#l32.467"></a><span id="l32.467" class="difflineminus">-      *pMsgCount = 0;</span>
<a href="#l32.468"></a><span id="l32.468" class="difflineminus">-  }</span>
<a href="#l32.469"></a><span id="l32.469" class="difflineminus">-</span>
<a href="#l32.470"></a><span id="l32.470" class="difflineminus">-  return rv;</span>
<a href="#l32.471"></a><span id="l32.471" class="difflineminus">-}</span>
<a href="#l32.472"></a><span id="l32.472" class="difflineminus">-</span>
<a href="#l32.473"></a><span id="l32.473" class="difflineminus">-nsresult nsEudoraMailbox::ReadTOCEntry(nsIInputStream *pToc, EudoraTOCEntry&amp; tocEntry)</span>
<a href="#l32.474"></a><span id="l32.474" class="difflineminus">-{</span>
<a href="#l32.475"></a><span id="l32.475" class="difflineminus">-#define READ_TOC_FIELD(entry) pBuffer = (char *)&amp;entry;\</span>
<a href="#l32.476"></a><span id="l32.476" class="difflineminus">-  if (NS_FAILED(pToc-&gt;Read(pBuffer, sizeof(entry), &amp;bytesRead)) || (bytesRead != sizeof(entry)))\</span>
<a href="#l32.477"></a><span id="l32.477" class="difflineminus">-    return NS_ERROR_FAILURE</span>
<a href="#l32.478"></a><span id="l32.478" class="difflineminus">-</span>
<a href="#l32.479"></a><span id="l32.479" class="difflineminus">-  uint32_t bytesRead = 0;</span>
<a href="#l32.480"></a><span id="l32.480" class="difflineminus">-  char * pBuffer;</span>
<a href="#l32.481"></a><span id="l32.481" class="difflineminus">-</span>
<a href="#l32.482"></a><span id="l32.482" class="difflineminus">-  // Here we'll read any initial data that's in the same format on both Mac and Windows</span>
<a href="#l32.483"></a><span id="l32.483" class="difflineminus">-  READ_TOC_FIELD(tocEntry.m_Offset);</span>
<a href="#l32.484"></a><span id="l32.484" class="difflineminus">-  READ_TOC_FIELD(tocEntry.m_Length);</span>
<a href="#l32.485"></a><span id="l32.485" class="difflineminus">-</span>
<a href="#l32.486"></a><span id="l32.486" class="difflineminus">-#ifdef XP_MACOSX</span>
<a href="#l32.487"></a><span id="l32.487" class="difflineminus">-  // Read Mac specific data</span>
<a href="#l32.488"></a><span id="l32.488" class="difflineminus">-</span>
<a href="#l32.489"></a><span id="l32.489" class="difflineminus">-#else</span>
<a href="#l32.490"></a><span id="l32.490" class="difflineminus">-  // Read Windows specific data</span>
<a href="#l32.491"></a><span id="l32.491" class="difflineminus">-  int16_t      x1 = 0, y1 = 0, x2 = 400, y2 = 300, tzm = 0;</span>
<a href="#l32.492"></a><span id="l32.492" class="difflineminus">-  int8_t      nIgnoreChar;</span>
<a href="#l32.493"></a><span id="l32.493" class="difflineminus">-  uint8_t      cJunkInfo = 0;</span>
<a href="#l32.494"></a><span id="l32.494" class="difflineminus">-  uint32_t    ulJunkPluginID;</span>
<a href="#l32.495"></a><span id="l32.495" class="difflineminus">-</span>
<a href="#l32.496"></a><span id="l32.496" class="difflineminus">-  READ_TOC_FIELD(tocEntry.m_Seconds);</span>
<a href="#l32.497"></a><span id="l32.497" class="difflineminus">-  READ_TOC_FIELD(tocEntry.m_State);</span>
<a href="#l32.498"></a><span id="l32.498" class="difflineminus">-  READ_TOC_FIELD(tocEntry.m_Flags);</span>
<a href="#l32.499"></a><span id="l32.499" class="difflineminus">-  READ_TOC_FIELD(tocEntry.m_Priority);</span>
<a href="#l32.500"></a><span id="l32.500" class="difflineminus">-  READ_TOC_FIELD(nIgnoreChar);</span>
<a href="#l32.501"></a><span id="l32.501" class="difflineminus">-  READ_TOC_FIELD(tocEntry.m_Date);</span>
<a href="#l32.502"></a><span id="l32.502" class="difflineminus">-  READ_TOC_FIELD(tocEntry.m_lArrivalSeconds);</span>
<a href="#l32.503"></a><span id="l32.503" class="difflineminus">-  READ_TOC_FIELD(tocEntry.m_From);</span>
<a href="#l32.504"></a><span id="l32.504" class="difflineminus">-  READ_TOC_FIELD(tocEntry.m_Subject);</span>
<a href="#l32.505"></a><span id="l32.505" class="difflineminus">-</span>
<a href="#l32.506"></a><span id="l32.506" class="difflineminus">-  // We'll read but ignore window position</span>
<a href="#l32.507"></a><span id="l32.507" class="difflineminus">-  READ_TOC_FIELD(x1);</span>
<a href="#l32.508"></a><span id="l32.508" class="difflineminus">-  READ_TOC_FIELD(y1);</span>
<a href="#l32.509"></a><span id="l32.509" class="difflineminus">-  READ_TOC_FIELD(x2);</span>
<a href="#l32.510"></a><span id="l32.510" class="difflineminus">-  READ_TOC_FIELD(y2);</span>
<a href="#l32.511"></a><span id="l32.511" class="difflineminus">-</span>
<a href="#l32.512"></a><span id="l32.512" class="difflineminus">-  READ_TOC_FIELD(tocEntry.m_Label);</span>
<a href="#l32.513"></a><span id="l32.513" class="difflineminus">-  READ_TOC_FIELD(tocEntry.m_Hash);</span>
<a href="#l32.514"></a><span id="l32.514" class="difflineminus">-  READ_TOC_FIELD(tocEntry.m_UniqueMessageId);</span>
<a href="#l32.515"></a><span id="l32.515" class="difflineminus">-  READ_TOC_FIELD(tocEntry.m_FlagsEx);</span>
<a href="#l32.516"></a><span id="l32.516" class="difflineminus">-  READ_TOC_FIELD(tocEntry.m_PersonaHash);</span>
<a href="#l32.517"></a><span id="l32.517" class="difflineminus">-</span>
<a href="#l32.518"></a><span id="l32.518" class="difflineminus">-  READ_TOC_FIELD(tzm);</span>
<a href="#l32.519"></a><span id="l32.519" class="difflineminus">-  tocEntry.m_TimeZoneMinutes = tzm;</span>
<a href="#l32.520"></a><span id="l32.520" class="difflineminus">-</span>
<a href="#l32.521"></a><span id="l32.521" class="difflineminus">-  // IMAP specific info (present, but not useful when POP mailbox)</span>
<a href="#l32.522"></a><span id="l32.522" class="difflineminus">-  READ_TOC_FIELD(tocEntry.m_Imflags);</span>
<a href="#l32.523"></a><span id="l32.523" class="difflineminus">-  READ_TOC_FIELD(tocEntry.m_MsgSize);</span>
<a href="#l32.524"></a><span id="l32.524" class="difflineminus">-</span>
<a href="#l32.525"></a><span id="l32.525" class="difflineminus">-  // Moodwatch info - may never be worth importing</span>
<a href="#l32.526"></a><span id="l32.526" class="difflineminus">-  READ_TOC_FIELD(tocEntry.m_nMood);</span>
<a href="#l32.527"></a><span id="l32.527" class="difflineminus">-</span>
<a href="#l32.528"></a><span id="l32.528" class="difflineminus">-  // Get the junk score byte</span>
<a href="#l32.529"></a><span id="l32.529" class="difflineminus">-  READ_TOC_FIELD(cJunkInfo);</span>
<a href="#l32.530"></a><span id="l32.530" class="difflineminus">-  if (cJunkInfo &amp; 0x80)</span>
<a href="#l32.531"></a><span id="l32.531" class="difflineminus">-  {</span>
<a href="#l32.532"></a><span id="l32.532" class="difflineminus">-    // If the high bit is set note that this message was manually junked</span>
<a href="#l32.533"></a><span id="l32.533" class="difflineminus">-    // and unset the high bit.</span>
<a href="#l32.534"></a><span id="l32.534" class="difflineminus">-    tocEntry.m_bManuallyJunked = true;</span>
<a href="#l32.535"></a><span id="l32.535" class="difflineminus">-    cJunkInfo &amp;= 0x7F;</span>
<a href="#l32.536"></a><span id="l32.536" class="difflineminus">-  }</span>
<a href="#l32.537"></a><span id="l32.537" class="difflineminus">-  else</span>
<a href="#l32.538"></a><span id="l32.538" class="difflineminus">-  {</span>
<a href="#l32.539"></a><span id="l32.539" class="difflineminus">-    tocEntry.m_bManuallyJunked = false;</span>
<a href="#l32.540"></a><span id="l32.540" class="difflineminus">-  }</span>
<a href="#l32.541"></a><span id="l32.541" class="difflineminus">-  tocEntry.m_ucJunkScore = cJunkInfo;</span>
<a href="#l32.542"></a><span id="l32.542" class="difflineminus">-</span>
<a href="#l32.543"></a><span id="l32.543" class="difflineminus">-  READ_TOC_FIELD(ulJunkPluginID);</span>
<a href="#l32.544"></a><span id="l32.544" class="difflineminus">-#endif</span>
<a href="#l32.545"></a><span id="l32.545" class="difflineminus">-</span>
<a href="#l32.546"></a><span id="l32.546" class="difflineminus">-  return NS_OK;</span>
<a href="#l32.547"></a><span id="l32.547" class="difflineminus">-}</span>
<a href="#l32.548"></a><span id="l32.548" class="difflineminus">-</span>
<a href="#l32.549"></a><span id="l32.549" class="difflineminus">-nsresult nsEudoraMailbox::ImportMessage(</span>
<a href="#l32.550"></a><span id="l32.550" class="difflineminus">-  SimpleBufferTonyRCopiedOnce &amp;headers,</span>
<a href="#l32.551"></a><span id="l32.551" class="difflineminus">-  SimpleBufferTonyRCopiedOnce &amp;body,</span>
<a href="#l32.552"></a><span id="l32.552" class="difflineminus">-  nsCString&amp; defaultDate,</span>
<a href="#l32.553"></a><span id="l32.553" class="difflineminus">-  nsAutoCString&amp; bodyType,</span>
<a href="#l32.554"></a><span id="l32.554" class="difflineminus">-  nsIOutputStream *pDst,</span>
<a href="#l32.555"></a><span id="l32.555" class="difflineminus">-  int32_t  *pMsgCount)</span>
<a href="#l32.556"></a><span id="l32.556" class="difflineminus">-{</span>
<a href="#l32.557"></a><span id="l32.557" class="difflineminus">-  nsresult rv = NS_OK;</span>
<a href="#l32.558"></a><span id="l32.558" class="difflineminus">-  uint32_t written = 0;</span>
<a href="#l32.559"></a><span id="l32.559" class="difflineminus">-  nsEudoraCompose compose;</span>
<a href="#l32.560"></a><span id="l32.560" class="difflineminus">-</span>
<a href="#l32.561"></a><span id="l32.561" class="difflineminus">-  // Unfortunately Eudora stores HTML messages in the sent folder</span>
<a href="#l32.562"></a><span id="l32.562" class="difflineminus">-  // without any content type header at all. If the first line of the message body is &lt;html&gt;</span>
<a href="#l32.563"></a><span id="l32.563" class="difflineminus">-  // then mark the message as html internally...See Bug #258489</span>
<a href="#l32.564"></a><span id="l32.564" class="difflineminus">-  if (body.m_pBuffer &amp;&amp; (body.m_writeOffset &gt; (int32_t)strlen(kHTMLTag)) &amp;&amp; (strncmp(body.m_pBuffer, kHTMLTag, strlen(kHTMLTag)) == 0))</span>
<a href="#l32.565"></a><span id="l32.565" class="difflineminus">-    bodyType = &quot;text/html&quot;; // ignore whatever body type we were given...force html</span>
<a href="#l32.566"></a><span id="l32.566" class="difflineminus">-</span>
<a href="#l32.567"></a><span id="l32.567" class="difflineminus">-  compose.SetBody(body.m_pBuffer, body.m_writeOffset - 1, bodyType);</span>
<a href="#l32.568"></a><span id="l32.568" class="difflineminus">-  compose.SetHeaders(headers.m_pBuffer, headers.m_writeOffset - 1);</span>
<a href="#l32.569"></a><span id="l32.569" class="difflineminus">-  compose.SetAttachments(&amp;m_attachments);</span>
<a href="#l32.570"></a><span id="l32.570" class="difflineminus">-  compose.SetDefaultDate(defaultDate);</span>
<a href="#l32.571"></a><span id="l32.571" class="difflineminus">-</span>
<a href="#l32.572"></a><span id="l32.572" class="difflineminus">-        nsCOMPtr &lt;nsIFile&gt; compositionFile;</span>
<a href="#l32.573"></a><span id="l32.573" class="difflineminus">-  rv = compose.SendTheMessage(m_mailImportLocation, getter_AddRefs(compositionFile));</span>
<a href="#l32.574"></a><span id="l32.574" class="difflineminus">-  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l32.575"></a><span id="l32.575" class="difflineminus">-    nsCString            fromLine(eudoraFromLine);</span>
<a href="#l32.576"></a><span id="l32.576" class="difflineminus">-    SimpleBufferTonyRCopiedOnce    copy;</span>
<a href="#l32.577"></a><span id="l32.577" class="difflineminus">-</span>
<a href="#l32.578"></a><span id="l32.578" class="difflineminus">-    copy.Allocate(kCopyBufferSize);</span>
<a href="#l32.579"></a><span id="l32.579" class="difflineminus">-</span>
<a href="#l32.580"></a><span id="l32.580" class="difflineminus">-    /* IMPORT_LOG0(&quot;Composed message in file: &quot;); DUMP_FILENAME(compositionFile, true); */</span>
<a href="#l32.581"></a><span id="l32.581" class="difflineminus">-    // copy the resulting file into the destination file!</span>
<a href="#l32.582"></a><span id="l32.582" class="difflineminus">-    rv = compose.CopyComposedMessage(fromLine, compositionFile, pDst, copy);</span>
<a href="#l32.583"></a><span id="l32.583" class="difflineminus">-    DeleteFile(compositionFile);</span>
<a href="#l32.584"></a><span id="l32.584" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l32.585"></a><span id="l32.585" class="difflineminus">-      IMPORT_LOG0(&quot;*** Error copying composed message to destination mailbox\n&quot;);</span>
<a href="#l32.586"></a><span id="l32.586" class="difflineminus">-    if (pMsgCount)</span>
<a href="#l32.587"></a><span id="l32.587" class="difflineminus">-      (*pMsgCount)++;</span>
<a href="#l32.588"></a><span id="l32.588" class="difflineminus">-  }</span>
<a href="#l32.589"></a><span id="l32.589" class="difflineminus">-  else {</span>
<a href="#l32.590"></a><span id="l32.590" class="difflineminus">-    IMPORT_LOG0(&quot;*** Error composing message, writing raw message\n&quot;);</span>
<a href="#l32.591"></a><span id="l32.591" class="difflineminus">-    rv = WriteFromSep(pDst);</span>
<a href="#l32.592"></a><span id="l32.592" class="difflineminus">-</span>
<a href="#l32.593"></a><span id="l32.593" class="difflineminus">-    rv = pDst-&gt;Write(kComposeErrorStr, strlen(kComposeErrorStr), &amp;written);</span>
<a href="#l32.594"></a><span id="l32.594" class="difflineminus">-</span>
<a href="#l32.595"></a><span id="l32.595" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l32.596"></a><span id="l32.596" class="difflineminus">-      rv = pDst-&gt;Write(headers.m_pBuffer, headers.m_writeOffset - 1, &amp;written);</span>
<a href="#l32.597"></a><span id="l32.597" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; (written == (headers.m_writeOffset - 1)))</span>
<a href="#l32.598"></a><span id="l32.598" class="difflineminus">-      rv = pDst-&gt;Write(&quot;\x0D\x0A&quot; &quot;\x0D\x0A&quot;, 4, &amp;written);</span>
<a href="#l32.599"></a><span id="l32.599" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; (written == 4))</span>
<a href="#l32.600"></a><span id="l32.600" class="difflineminus">-      rv = pDst-&gt;Write(body.m_pBuffer, body.m_writeOffset - 1, &amp;written);</span>
<a href="#l32.601"></a><span id="l32.601" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; (written == (body.m_writeOffset - 1))) {</span>
<a href="#l32.602"></a><span id="l32.602" class="difflineminus">-      rv = pDst-&gt;Write(&quot;\x0D\x0A&quot;, 2, &amp;written);</span>
<a href="#l32.603"></a><span id="l32.603" class="difflineminus">-      if (written != 2)</span>
<a href="#l32.604"></a><span id="l32.604" class="difflineminus">-        rv = NS_ERROR_FAILURE;</span>
<a href="#l32.605"></a><span id="l32.605" class="difflineminus">-    }</span>
<a href="#l32.606"></a><span id="l32.606" class="difflineminus">-</span>
<a href="#l32.607"></a><span id="l32.607" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l32.608"></a><span id="l32.608" class="difflineminus">-      IMPORT_LOG0(&quot;*** Error writing to destination mailbox\n&quot;);</span>
<a href="#l32.609"></a><span id="l32.609" class="difflineminus">-  }</span>
<a href="#l32.610"></a><span id="l32.610" class="difflineminus">-</span>
<a href="#l32.611"></a><span id="l32.611" class="difflineminus">-  return rv;</span>
<a href="#l32.612"></a><span id="l32.612" class="difflineminus">-}</span>
<a href="#l32.613"></a><span id="l32.613" class="difflineminus">-</span>
<a href="#l32.614"></a><span id="l32.614" class="difflineminus">-nsresult nsEudoraMailbox::ReadNextMessage(ReadFileState *pState, SimpleBufferTonyRCopiedOnce&amp; copy,</span>
<a href="#l32.615"></a><span id="l32.615" class="difflineminus">-                                          SimpleBufferTonyRCopiedOnce&amp; header, SimpleBufferTonyRCopiedOnce&amp; body,</span>
<a href="#l32.616"></a><span id="l32.616" class="difflineminus">-                                          nsCString&amp; defaultDate, nsCString&amp; bodyType, EudoraTOCEntry *pTocEntry)</span>
<a href="#l32.617"></a><span id="l32.617" class="difflineminus">-{</span>
<a href="#l32.618"></a><span id="l32.618" class="difflineminus">-  header.m_writeOffset = 0;</span>
<a href="#l32.619"></a><span id="l32.619" class="difflineminus">-  body.m_writeOffset = 0;</span>
<a href="#l32.620"></a><span id="l32.620" class="difflineminus">-</span>
<a href="#l32.621"></a><span id="l32.621" class="difflineminus">-  nsresult    rv;</span>
<a href="#l32.622"></a><span id="l32.622" class="difflineminus">-  int32_t      lineLen;</span>
<a href="#l32.623"></a><span id="l32.623" class="difflineminus">-  char      endBuffer = 0;</span>
<a href="#l32.624"></a><span id="l32.624" class="difflineminus">-</span>
<a href="#l32.625"></a><span id="l32.625" class="difflineminus">-  lineLen = -1;</span>
<a href="#l32.626"></a><span id="l32.626" class="difflineminus">-  // Find the from separator - we should actually be positioned at the</span>
<a href="#l32.627"></a><span id="l32.627" class="difflineminus">-  // from separator, but for now, we'll verify this.</span>
<a href="#l32.628"></a><span id="l32.628" class="difflineminus">-  while (lineLen == -1) {</span>
<a href="#l32.629"></a><span id="l32.629" class="difflineminus">-    if (NS_FAILED(rv = FillMailBuffer(pState, copy))) {</span>
<a href="#l32.630"></a><span id="l32.630" class="difflineminus">-      IMPORT_LOG0(&quot;*** Error, FillMailBuffer FAILED in ReadNextMessage\n&quot;);</span>
<a href="#l32.631"></a><span id="l32.631" class="difflineminus">-      return rv;</span>
<a href="#l32.632"></a><span id="l32.632" class="difflineminus">-    }</span>
<a href="#l32.633"></a><span id="l32.633" class="difflineminus">-    lineLen = IsEudoraFromSeparator(copy.m_pBuffer + copy.m_writeOffset, copy.m_bytesInBuf - copy.m_writeOffset, defaultDate);</span>
<a href="#l32.634"></a><span id="l32.634" class="difflineminus">-</span>
<a href="#l32.635"></a><span id="l32.635" class="difflineminus">-    if (lineLen == -1) {</span>
<a href="#l32.636"></a><span id="l32.636" class="difflineminus">-      while ((lineLen = FindStartLine(copy)) == -1) {</span>
<a href="#l32.637"></a><span id="l32.637" class="difflineminus">-        copy.m_writeOffset = copy.m_bytesInBuf;</span>
<a href="#l32.638"></a><span id="l32.638" class="difflineminus">-        if (NS_FAILED(rv = FillMailBuffer(pState, copy))) {</span>
<a href="#l32.639"></a><span id="l32.639" class="difflineminus">-          IMPORT_LOG0(&quot;*** Error, FillMailBuffer FAILED in ReadNextMessage, looking for next start line\n&quot;);</span>
<a href="#l32.640"></a><span id="l32.640" class="difflineminus">-          return rv;</span>
<a href="#l32.641"></a><span id="l32.641" class="difflineminus">-        }</span>
<a href="#l32.642"></a><span id="l32.642" class="difflineminus">-        if (!copy.m_bytesInBuf) {</span>
<a href="#l32.643"></a><span id="l32.643" class="difflineminus">-          IMPORT_LOG0(&quot;*** Error, ReadNextMessage, looking for start of next line, got end of file.\n&quot;);</span>
<a href="#l32.644"></a><span id="l32.644" class="difflineminus">-          return NS_ERROR_FAILURE;</span>
<a href="#l32.645"></a><span id="l32.645" class="difflineminus">-        }</span>
<a href="#l32.646"></a><span id="l32.646" class="difflineminus">-      }</span>
<a href="#l32.647"></a><span id="l32.647" class="difflineminus">-      copy.m_writeOffset += lineLen;</span>
<a href="#l32.648"></a><span id="l32.648" class="difflineminus">-      lineLen = -1;</span>
<a href="#l32.649"></a><span id="l32.649" class="difflineminus">-    }</span>
<a href="#l32.650"></a><span id="l32.650" class="difflineminus">-  }</span>
<a href="#l32.651"></a><span id="l32.651" class="difflineminus">-</span>
<a href="#l32.652"></a><span id="l32.652" class="difflineminus">-  // Skip past the from line separator</span>
<a href="#l32.653"></a><span id="l32.653" class="difflineminus">-  while ((lineLen = FindStartLine(copy)) == -1) {</span>
<a href="#l32.654"></a><span id="l32.654" class="difflineminus">-    copy.m_writeOffset = copy.m_bytesInBuf;</span>
<a href="#l32.655"></a><span id="l32.655" class="difflineminus">-    if (NS_FAILED(rv = FillMailBuffer(pState, copy))) {</span>
<a href="#l32.656"></a><span id="l32.656" class="difflineminus">-      IMPORT_LOG0(&quot;*** Error, ReadNextMessage, FillMailBuffer failed looking for from sep\n&quot;);</span>
<a href="#l32.657"></a><span id="l32.657" class="difflineminus">-      return rv;</span>
<a href="#l32.658"></a><span id="l32.658" class="difflineminus">-    }</span>
<a href="#l32.659"></a><span id="l32.659" class="difflineminus">-    if (!copy.m_bytesInBuf) {</span>
<a href="#l32.660"></a><span id="l32.660" class="difflineminus">-      IMPORT_LOG0(&quot;*** Error, ReadNextMessage, end of file looking for from sep\n&quot;);</span>
<a href="#l32.661"></a><span id="l32.661" class="difflineminus">-      return NS_ERROR_FAILURE;</span>
<a href="#l32.662"></a><span id="l32.662" class="difflineminus">-    }</span>
<a href="#l32.663"></a><span id="l32.663" class="difflineminus">-  }</span>
<a href="#l32.664"></a><span id="l32.664" class="difflineminus">-  copy.m_writeOffset += lineLen;</span>
<a href="#l32.665"></a><span id="l32.665" class="difflineminus">-  if (NS_FAILED(rv = FillMailBuffer(pState, copy))) {</span>
<a href="#l32.666"></a><span id="l32.666" class="difflineminus">-    IMPORT_LOG0(&quot;*** Error, Unable to fill mail buffer after from sep.\n&quot;);</span>
<a href="#l32.667"></a><span id="l32.667" class="difflineminus">-    return rv;</span>
<a href="#l32.668"></a><span id="l32.668" class="difflineminus">-  }</span>
<a href="#l32.669"></a><span id="l32.669" class="difflineminus">-</span>
<a href="#l32.670"></a><span id="l32.670" class="difflineminus">-  // This should be the headers...</span>
<a href="#l32.671"></a><span id="l32.671" class="difflineminus">-  int32_t endLen = -1;</span>
<a href="#l32.672"></a><span id="l32.672" class="difflineminus">-  while ((endLen = IsEndHeaders(copy)) == -1) {</span>
<a href="#l32.673"></a><span id="l32.673" class="difflineminus">-    while ((lineLen = FindNextEndLine(copy)) == -1) {</span>
<a href="#l32.674"></a><span id="l32.674" class="difflineminus">-      copy.m_writeOffset = copy.m_bytesInBuf;</span>
<a href="#l32.675"></a><span id="l32.675" class="difflineminus">-      if (!header.Write(copy.m_pBuffer, copy.m_writeOffset)) {</span>
<a href="#l32.676"></a><span id="l32.676" class="difflineminus">-        IMPORT_LOG0(&quot;*** ERROR, writing headers\n&quot;);</span>
<a href="#l32.677"></a><span id="l32.677" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l32.678"></a><span id="l32.678" class="difflineminus">-      }</span>
<a href="#l32.679"></a><span id="l32.679" class="difflineminus">-      if (NS_FAILED(rv = FillMailBuffer(pState, copy))) {</span>
<a href="#l32.680"></a><span id="l32.680" class="difflineminus">-        IMPORT_LOG0(&quot;*** Error reading message headers\n&quot;);</span>
<a href="#l32.681"></a><span id="l32.681" class="difflineminus">-        return rv;</span>
<a href="#l32.682"></a><span id="l32.682" class="difflineminus">-      }</span>
<a href="#l32.683"></a><span id="l32.683" class="difflineminus">-      if (!copy.m_bytesInBuf) {</span>
<a href="#l32.684"></a><span id="l32.684" class="difflineminus">-        IMPORT_LOG0(&quot;*** Error, end of file while reading headers\n&quot;);</span>
<a href="#l32.685"></a><span id="l32.685" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l32.686"></a><span id="l32.686" class="difflineminus">-      }</span>
<a href="#l32.687"></a><span id="l32.687" class="difflineminus">-    }</span>
<a href="#l32.688"></a><span id="l32.688" class="difflineminus">-    copy.m_writeOffset += lineLen;</span>
<a href="#l32.689"></a><span id="l32.689" class="difflineminus">-    if ((copy.m_writeOffset + 4) &gt;= copy.m_bytesInBuf) {</span>
<a href="#l32.690"></a><span id="l32.690" class="difflineminus">-      if (!header.Write(copy.m_pBuffer, copy.m_writeOffset)) {</span>
<a href="#l32.691"></a><span id="l32.691" class="difflineminus">-        IMPORT_LOG0(&quot;*** ERROR, writing headers 2\n&quot;);</span>
<a href="#l32.692"></a><span id="l32.692" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l32.693"></a><span id="l32.693" class="difflineminus">-      }</span>
<a href="#l32.694"></a><span id="l32.694" class="difflineminus">-      if (NS_FAILED(rv = FillMailBuffer(pState, copy))) {</span>
<a href="#l32.695"></a><span id="l32.695" class="difflineminus">-        IMPORT_LOG0(&quot;*** Error reading message headers 2\n&quot;);</span>
<a href="#l32.696"></a><span id="l32.696" class="difflineminus">-        return rv;</span>
<a href="#l32.697"></a><span id="l32.697" class="difflineminus">-      }</span>
<a href="#l32.698"></a><span id="l32.698" class="difflineminus">-    }</span>
<a href="#l32.699"></a><span id="l32.699" class="difflineminus">-  }</span>
<a href="#l32.700"></a><span id="l32.700" class="difflineminus">-</span>
<a href="#l32.701"></a><span id="l32.701" class="difflineminus">-  if (!header.Write(copy.m_pBuffer, copy.m_writeOffset)) {</span>
<a href="#l32.702"></a><span id="l32.702" class="difflineminus">-    IMPORT_LOG0(&quot;*** Error writing final headers\n&quot;);</span>
<a href="#l32.703"></a><span id="l32.703" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l32.704"></a><span id="l32.704" class="difflineminus">-  }</span>
<a href="#l32.705"></a><span id="l32.705" class="difflineminus">-</span>
<a href="#l32.706"></a><span id="l32.706" class="difflineminus">-  if (pTocEntry) {</span>
<a href="#l32.707"></a><span id="l32.707" class="difflineminus">-    // This is not the prettiest spot to stick this code, but it works and it was convenient.</span>
<a href="#l32.708"></a><span id="l32.708" class="difflineminus">-    char    header_str[128];</span>
<a href="#l32.709"></a><span id="l32.709" class="difflineminus">-</span>
<a href="#l32.710"></a><span id="l32.710" class="difflineminus">-    // Write X-Mozilla-Status header</span>
<a href="#l32.711"></a><span id="l32.711" class="difflineminus">-    PR_snprintf(header_str, 128, MSG_LINEBREAK X_MOZILLA_STATUS_FORMAT MSG_LINEBREAK, pTocEntry-&gt;GetMozillaStatusFlags());</span>
<a href="#l32.712"></a><span id="l32.712" class="difflineminus">-    header.Write(header_str, strlen(header_str));</span>
<a href="#l32.713"></a><span id="l32.713" class="difflineminus">-</span>
<a href="#l32.714"></a><span id="l32.714" class="difflineminus">-    // Write X-Mozilla-Status2 header</span>
<a href="#l32.715"></a><span id="l32.715" class="difflineminus">-    PR_snprintf(header_str, 128, X_MOZILLA_STATUS2_FORMAT MSG_LINEBREAK, pTocEntry-&gt;GetMozillaStatus2Flags());</span>
<a href="#l32.716"></a><span id="l32.716" class="difflineminus">-    header.Write(header_str, strlen(header_str));</span>
<a href="#l32.717"></a><span id="l32.717" class="difflineminus">-</span>
<a href="#l32.718"></a><span id="l32.718" class="difflineminus">-    // Format and write X-Mozilla-Keys header</span>
<a href="#l32.719"></a><span id="l32.719" class="difflineminus">-    nsCString  keywordHdr(X_MOZILLA_KEYWORDS);</span>
<a href="#l32.720"></a><span id="l32.720" class="difflineminus">-    if (pTocEntry-&gt;HasEudoraLabel()) {</span>
<a href="#l32.721"></a><span id="l32.721" class="difflineminus">-      PR_snprintf(header_str, 128, &quot;eudoralabel%d&quot;, pTocEntry-&gt;GetLabelNumber());</span>
<a href="#l32.722"></a><span id="l32.722" class="difflineminus">-      keywordHdr.Replace(sizeof(HEADER_X_MOZILLA_KEYWORDS) + 1, strlen(header_str), header_str);</span>
<a href="#l32.723"></a><span id="l32.723" class="difflineminus">-    }</span>
<a href="#l32.724"></a><span id="l32.724" class="difflineminus">-    header.Write(keywordHdr.get(), keywordHdr.Length());</span>
<a href="#l32.725"></a><span id="l32.725" class="difflineminus">-  }</span>
<a href="#l32.726"></a><span id="l32.726" class="difflineminus">-</span>
<a href="#l32.727"></a><span id="l32.727" class="difflineminus">-  if (!header.Write(&amp;endBuffer, 1)) {</span>
<a href="#l32.728"></a><span id="l32.728" class="difflineminus">-    IMPORT_LOG0(&quot;*** Error writing header trailing null\n&quot;);</span>
<a href="#l32.729"></a><span id="l32.729" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l32.730"></a><span id="l32.730" class="difflineminus">-  }</span>
<a href="#l32.731"></a><span id="l32.731" class="difflineminus">-</span>
<a href="#l32.732"></a><span id="l32.732" class="difflineminus">-  copy.m_writeOffset += endLen;</span>
<a href="#l32.733"></a><span id="l32.733" class="difflineminus">-  if (NS_FAILED(rv = FillMailBuffer(pState, copy))) {</span>
<a href="#l32.734"></a><span id="l32.734" class="difflineminus">-    IMPORT_LOG0(&quot;*** Error reading beginning of message body\n&quot;);</span>
<a href="#l32.735"></a><span id="l32.735" class="difflineminus">-    return rv;</span>
<a href="#l32.736"></a><span id="l32.736" class="difflineminus">-  }</span>
<a href="#l32.737"></a><span id="l32.737" class="difflineminus">-</span>
<a href="#l32.738"></a><span id="l32.738" class="difflineminus">-  EmptyAttachments();</span>
<a href="#l32.739"></a><span id="l32.739" class="difflineminus">-</span>
<a href="#l32.740"></a><span id="l32.740" class="difflineminus">-  // Get the body!</span>
<a href="#l32.741"></a><span id="l32.741" class="difflineminus">-  // Read one line at a time here and look for the next separator</span>
<a href="#l32.742"></a><span id="l32.742" class="difflineminus">-  nsCString tmp;</span>
<a href="#l32.743"></a><span id="l32.743" class="difflineminus">-  bool insideEudoraTags = false;</span>
<a href="#l32.744"></a><span id="l32.744" class="difflineminus">-  // by default we consider the body text to be plain text</span>
<a href="#l32.745"></a><span id="l32.745" class="difflineminus">-  bodyType = &quot;text/plain&quot;;</span>
<a href="#l32.746"></a><span id="l32.746" class="difflineminus">-</span>
<a href="#l32.747"></a><span id="l32.747" class="difflineminus">-  while ((lineLen = IsEudoraFromSeparator(copy.m_pBuffer + copy.m_writeOffset, copy.m_bytesInBuf - copy.m_writeOffset, tmp)) == -1) {</span>
<a href="#l32.748"></a><span id="l32.748" class="difflineminus">-    int32_t tagLength = 0;</span>
<a href="#l32.749"></a><span id="l32.749" class="difflineminus">-    if (IsEudoraTag (copy.m_pBuffer + copy.m_writeOffset, copy.m_bytesInBuf - copy.m_writeOffset, insideEudoraTags, bodyType, tagLength)) {</span>
<a href="#l32.750"></a><span id="l32.750" class="difflineminus">-      // We don't want to keep eudora tags so skip over them.</span>
<a href="#l32.751"></a><span id="l32.751" class="difflineminus">-</span>
<a href="#l32.752"></a><span id="l32.752" class="difflineminus">-      // let's write the previous text</span>
<a href="#l32.753"></a><span id="l32.753" class="difflineminus">-      if (!body.Write(copy.m_pBuffer, copy.m_writeOffset)) {</span>
<a href="#l32.754"></a><span id="l32.754" class="difflineminus">-        IMPORT_LOG0(&quot;*** Error writing to message body\n&quot;);</span>
<a href="#l32.755"></a><span id="l32.755" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l32.756"></a><span id="l32.756" class="difflineminus">-      }</span>
<a href="#l32.757"></a><span id="l32.757" class="difflineminus">-</span>
<a href="#l32.758"></a><span id="l32.758" class="difflineminus">-      // we want to skip over the tag...for now we are assuming the tag is always at the start of line.</span>
<a href="#l32.759"></a><span id="l32.759" class="difflineminus">-      copy.m_writeOffset += tagLength;</span>
<a href="#l32.760"></a><span id="l32.760" class="difflineminus">-        if (NS_FAILED(rv = FillMailBuffer(pState, copy))) {</span>
<a href="#l32.761"></a><span id="l32.761" class="difflineminus">-          IMPORT_LOG0(&quot;*** Error reading message body\n&quot;);</span>
<a href="#l32.762"></a><span id="l32.762" class="difflineminus">-          return rv;</span>
<a href="#l32.763"></a><span id="l32.763" class="difflineminus">-        }</span>
<a href="#l32.764"></a><span id="l32.764" class="difflineminus">-</span>
<a href="#l32.765"></a><span id="l32.765" class="difflineminus">-      if (!copy.m_bytesInBuf)</span>
<a href="#l32.766"></a><span id="l32.766" class="difflineminus">-        break;</span>
<a href="#l32.767"></a><span id="l32.767" class="difflineminus">-</span>
<a href="#l32.768"></a><span id="l32.768" class="difflineminus">-      continue;</span>
<a href="#l32.769"></a><span id="l32.769" class="difflineminus">-    }</span>
<a href="#l32.770"></a><span id="l32.770" class="difflineminus">-</span>
<a href="#l32.771"></a><span id="l32.771" class="difflineminus">-    // Eudora Attachment lines are always outside Eudora Tags</span>
<a href="#l32.772"></a><span id="l32.772" class="difflineminus">-    // so we shouldn't try to find one here</span>
<a href="#l32.773"></a><span id="l32.773" class="difflineminus">-    if (!insideEudoraTags) {</span>
<a href="#l32.774"></a><span id="l32.774" class="difflineminus">-    // Debatable is whether or not to exclude these lines from the</span>
<a href="#l32.775"></a><span id="l32.775" class="difflineminus">-    // text of the message, I prefer not to in case the original</span>
<a href="#l32.776"></a><span id="l32.776" class="difflineminus">-    // attachment is actually missing.</span>
<a href="#l32.777"></a><span id="l32.777" class="difflineminus">-    rv = ExamineAttachment(copy);</span>
<a href="#l32.778"></a><span id="l32.778" class="difflineminus">-    if (NS_FAILED(rv)) {</span>
<a href="#l32.779"></a><span id="l32.779" class="difflineminus">-      IMPORT_LOG0(&quot;*** Error examining attachment line\n&quot;);</span>
<a href="#l32.780"></a><span id="l32.780" class="difflineminus">-      return rv;</span>
<a href="#l32.781"></a><span id="l32.781" class="difflineminus">-    }</span>
<a href="#l32.782"></a><span id="l32.782" class="difflineminus">-    }</span>
<a href="#l32.783"></a><span id="l32.783" class="difflineminus">-</span>
<a href="#l32.784"></a><span id="l32.784" class="difflineminus">-    while (((lineLen = FindStartLine(copy)) == -1) &amp;&amp; copy.m_bytesInBuf) {</span>
<a href="#l32.785"></a><span id="l32.785" class="difflineminus">-      copy.m_writeOffset = copy.m_bytesInBuf;</span>
<a href="#l32.786"></a><span id="l32.786" class="difflineminus">-      if (!body.Write(copy.m_pBuffer, copy.m_writeOffset)) {</span>
<a href="#l32.787"></a><span id="l32.787" class="difflineminus">-        IMPORT_LOG0(&quot;*** Error writing to message body\n&quot;);</span>
<a href="#l32.788"></a><span id="l32.788" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l32.789"></a><span id="l32.789" class="difflineminus">-      }</span>
<a href="#l32.790"></a><span id="l32.790" class="difflineminus">-      if (NS_FAILED(rv = FillMailBuffer(pState, copy))) {</span>
<a href="#l32.791"></a><span id="l32.791" class="difflineminus">-        IMPORT_LOG0(&quot;*** Error reading message body\n&quot;);</span>
<a href="#l32.792"></a><span id="l32.792" class="difflineminus">-        return rv;</span>
<a href="#l32.793"></a><span id="l32.793" class="difflineminus">-      }</span>
<a href="#l32.794"></a><span id="l32.794" class="difflineminus">-    }</span>
<a href="#l32.795"></a><span id="l32.795" class="difflineminus">-    if (!copy.m_bytesInBuf)</span>
<a href="#l32.796"></a><span id="l32.796" class="difflineminus">-      break;</span>
<a href="#l32.797"></a><span id="l32.797" class="difflineminus">-</span>
<a href="#l32.798"></a><span id="l32.798" class="difflineminus">-    copy.m_writeOffset += lineLen;</span>
<a href="#l32.799"></a><span id="l32.799" class="difflineminus">-</span>
<a href="#l32.800"></a><span id="l32.800" class="difflineminus">-    // found the start of the next line</span>
<a href="#l32.801"></a><span id="l32.801" class="difflineminus">-    // make sure it's long enough to check for the from line</span>
<a href="#l32.802"></a><span id="l32.802" class="difflineminus">-    if ((copy.m_writeOffset + 2048) &gt;= copy.m_bytesInBuf) {</span>
<a href="#l32.803"></a><span id="l32.803" class="difflineminus">-      if (!body.Write(copy.m_pBuffer, copy.m_writeOffset)) {</span>
<a href="#l32.804"></a><span id="l32.804" class="difflineminus">-        IMPORT_LOG0(&quot;*** Error writing to message body 2\n&quot;);</span>
<a href="#l32.805"></a><span id="l32.805" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l32.806"></a><span id="l32.806" class="difflineminus">-      }</span>
<a href="#l32.807"></a><span id="l32.807" class="difflineminus">-      if (NS_FAILED(rv = FillMailBuffer(pState, copy))) {</span>
<a href="#l32.808"></a><span id="l32.808" class="difflineminus">-        IMPORT_LOG0(&quot;*** Error reading message body 2\n&quot;);</span>
<a href="#l32.809"></a><span id="l32.809" class="difflineminus">-        return rv;</span>
<a href="#l32.810"></a><span id="l32.810" class="difflineminus">-      }</span>
<a href="#l32.811"></a><span id="l32.811" class="difflineminus">-    }</span>
<a href="#l32.812"></a><span id="l32.812" class="difflineminus">-  }</span>
<a href="#l32.813"></a><span id="l32.813" class="difflineminus">-</span>
<a href="#l32.814"></a><span id="l32.814" class="difflineminus">-  // the start of the current line is a from, we-re done</span>
<a href="#l32.815"></a><span id="l32.815" class="difflineminus">-  if (!body.Write(copy.m_pBuffer, copy.m_writeOffset)) {</span>
<a href="#l32.816"></a><span id="l32.816" class="difflineminus">-    IMPORT_LOG0(&quot;*** Error writing final message body\n&quot;);</span>
<a href="#l32.817"></a><span id="l32.817" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l32.818"></a><span id="l32.818" class="difflineminus">-  }</span>
<a href="#l32.819"></a><span id="l32.819" class="difflineminus">-  if (!body.Write(&amp;endBuffer, 1)) {</span>
<a href="#l32.820"></a><span id="l32.820" class="difflineminus">-    IMPORT_LOG0(&quot;*** Error writing body trailing null\n&quot;);</span>
<a href="#l32.821"></a><span id="l32.821" class="difflineminus">-    IMPORT_LOG2(&quot;\tbody.m_size: %ld, body.m_writeOffset: %ld\n&quot;, body.m_size, body.m_writeOffset);</span>
<a href="#l32.822"></a><span id="l32.822" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l32.823"></a><span id="l32.823" class="difflineminus">-  }</span>
<a href="#l32.824"></a><span id="l32.824" class="difflineminus">-  if (NS_FAILED(rv = FillMailBuffer(pState, copy))) {</span>
<a href="#l32.825"></a><span id="l32.825" class="difflineminus">-    IMPORT_LOG0(&quot;*** Error filling mail buffer for next read message\n&quot;);</span>
<a href="#l32.826"></a><span id="l32.826" class="difflineminus">-    return rv;</span>
<a href="#l32.827"></a><span id="l32.827" class="difflineminus">-  }</span>
<a href="#l32.828"></a><span id="l32.828" class="difflineminus">-</span>
<a href="#l32.829"></a><span id="l32.829" class="difflineminus">-  return NS_OK;</span>
<a href="#l32.830"></a><span id="l32.830" class="difflineminus">-}</span>
<a href="#l32.831"></a><span id="l32.831" class="difflineminus">-</span>
<a href="#l32.832"></a><span id="l32.832" class="difflineminus">-int32_t  nsEudoraMailbox::FindStartLine(SimpleBufferTonyRCopiedOnce&amp; data)</span>
<a href="#l32.833"></a><span id="l32.833" class="difflineminus">-{</span>
<a href="#l32.834"></a><span id="l32.834" class="difflineminus">-  int32_t len = data.m_bytesInBuf - data.m_writeOffset;</span>
<a href="#l32.835"></a><span id="l32.835" class="difflineminus">-  if (!len)</span>
<a href="#l32.836"></a><span id="l32.836" class="difflineminus">-    return -1;</span>
<a href="#l32.837"></a><span id="l32.837" class="difflineminus">-</span>
<a href="#l32.838"></a><span id="l32.838" class="difflineminus">-  int32_t count = 0;</span>
<a href="#l32.839"></a><span id="l32.839" class="difflineminus">-  const char *pData = data.m_pBuffer + data.m_writeOffset;</span>
<a href="#l32.840"></a><span id="l32.840" class="difflineminus">-  // Skip to next end of line.</span>
<a href="#l32.841"></a><span id="l32.841" class="difflineminus">-  while ((count &lt; len) &amp;&amp; (*pData != nsCRT::CR) &amp;&amp; (*pData != nsCRT::LF)) {</span>
<a href="#l32.842"></a><span id="l32.842" class="difflineminus">-    pData++;</span>
<a href="#l32.843"></a><span id="l32.843" class="difflineminus">-    count++;</span>
<a href="#l32.844"></a><span id="l32.844" class="difflineminus">-  }</span>
<a href="#l32.845"></a><span id="l32.845" class="difflineminus">-  if (count == len)</span>
<a href="#l32.846"></a><span id="l32.846" class="difflineminus">-    return -1;</span>
<a href="#l32.847"></a><span id="l32.847" class="difflineminus">-</span>
<a href="#l32.848"></a><span id="l32.848" class="difflineminus">-  // Skip over end of line(s).</span>
<a href="#l32.849"></a><span id="l32.849" class="difflineminus">-  while ((count &lt; len) &amp;&amp; ((*pData == nsCRT::CR) || (*pData == nsCRT::LF))) {</span>
<a href="#l32.850"></a><span id="l32.850" class="difflineminus">-    pData++;</span>
<a href="#l32.851"></a><span id="l32.851" class="difflineminus">-    count++;</span>
<a href="#l32.852"></a><span id="l32.852" class="difflineminus">-  }</span>
<a href="#l32.853"></a><span id="l32.853" class="difflineminus">-  if (count &lt; len)</span>
<a href="#l32.854"></a><span id="l32.854" class="difflineminus">-    return count;</span>
<a href="#l32.855"></a><span id="l32.855" class="difflineminus">-</span>
<a href="#l32.856"></a><span id="l32.856" class="difflineminus">-  return -1;</span>
<a href="#l32.857"></a><span id="l32.857" class="difflineminus">-}</span>
<a href="#l32.858"></a><span id="l32.858" class="difflineminus">-</span>
<a href="#l32.859"></a><span id="l32.859" class="difflineminus">-int32_t nsEudoraMailbox::FindNextEndLine(SimpleBufferTonyRCopiedOnce&amp; data)</span>
<a href="#l32.860"></a><span id="l32.860" class="difflineminus">-{</span>
<a href="#l32.861"></a><span id="l32.861" class="difflineminus">-  int32_t len = data.m_bytesInBuf - data.m_writeOffset;</span>
<a href="#l32.862"></a><span id="l32.862" class="difflineminus">-  if (!len)</span>
<a href="#l32.863"></a><span id="l32.863" class="difflineminus">-    return -1;</span>
<a href="#l32.864"></a><span id="l32.864" class="difflineminus">-</span>
<a href="#l32.865"></a><span id="l32.865" class="difflineminus">-  int32_t count = 0;</span>
<a href="#l32.866"></a><span id="l32.866" class="difflineminus">-  const char *pData = data.m_pBuffer + data.m_writeOffset;</span>
<a href="#l32.867"></a><span id="l32.867" class="difflineminus">-  // Skip over end of line(s).</span>
<a href="#l32.868"></a><span id="l32.868" class="difflineminus">-  while ((count &lt; len) &amp;&amp; ((*pData == nsCRT::CR) || (*pData == nsCRT::LF))) {</span>
<a href="#l32.869"></a><span id="l32.869" class="difflineminus">-    pData++;</span>
<a href="#l32.870"></a><span id="l32.870" class="difflineminus">-    count++;</span>
<a href="#l32.871"></a><span id="l32.871" class="difflineminus">-  }</span>
<a href="#l32.872"></a><span id="l32.872" class="difflineminus">-  // Skip to next end of line.</span>
<a href="#l32.873"></a><span id="l32.873" class="difflineminus">-  while ((count &lt; len) &amp;&amp; (*pData != nsCRT::CR) &amp;&amp; (*pData != nsCRT::LF)) {</span>
<a href="#l32.874"></a><span id="l32.874" class="difflineminus">-    pData++;</span>
<a href="#l32.875"></a><span id="l32.875" class="difflineminus">-    count++;</span>
<a href="#l32.876"></a><span id="l32.876" class="difflineminus">-  }</span>
<a href="#l32.877"></a><span id="l32.877" class="difflineminus">-  if (count &lt; len)</span>
<a href="#l32.878"></a><span id="l32.878" class="difflineminus">-    return count;</span>
<a href="#l32.879"></a><span id="l32.879" class="difflineminus">-</span>
<a href="#l32.880"></a><span id="l32.880" class="difflineminus">-  return -1;</span>
<a href="#l32.881"></a><span id="l32.881" class="difflineminus">-}</span>
<a href="#l32.882"></a><span id="l32.882" class="difflineminus">-</span>
<a href="#l32.883"></a><span id="l32.883" class="difflineminus">-int32_t nsEudoraMailbox::IsEndHeaders(SimpleBufferTonyRCopiedOnce&amp; data)</span>
<a href="#l32.884"></a><span id="l32.884" class="difflineminus">-{</span>
<a href="#l32.885"></a><span id="l32.885" class="difflineminus">-  int32_t len = data.m_bytesInBuf - data.m_writeOffset;</span>
<a href="#l32.886"></a><span id="l32.886" class="difflineminus">-  if (len &lt; 2)</span>
<a href="#l32.887"></a><span id="l32.887" class="difflineminus">-    return -1;</span>
<a href="#l32.888"></a><span id="l32.888" class="difflineminus">-</span>
<a href="#l32.889"></a><span id="l32.889" class="difflineminus">-  const char *pChar = data.m_pBuffer + data.m_writeOffset;</span>
<a href="#l32.890"></a><span id="l32.890" class="difflineminus">-  // Double nsCRT::CR.</span>
<a href="#l32.891"></a><span id="l32.891" class="difflineminus">-  if ((*pChar == nsCRT::CR) &amp;&amp; (*(pChar + 1) == nsCRT::CR))</span>
<a href="#l32.892"></a><span id="l32.892" class="difflineminus">-    return 2;</span>
<a href="#l32.893"></a><span id="l32.893" class="difflineminus">-</span>
<a href="#l32.894"></a><span id="l32.894" class="difflineminus">-  if (len &lt; 4)</span>
<a href="#l32.895"></a><span id="l32.895" class="difflineminus">-    return -1;</span>
<a href="#l32.896"></a><span id="l32.896" class="difflineminus">-</span>
<a href="#l32.897"></a><span id="l32.897" class="difflineminus">-  // Double (nsCRT::CR + nsCRT::LF).</span>
<a href="#l32.898"></a><span id="l32.898" class="difflineminus">-  if ((*pChar == nsCRT::CR) &amp;&amp; (*(pChar + 1) == nsCRT::LF) &amp;&amp;</span>
<a href="#l32.899"></a><span id="l32.899" class="difflineminus">-      (*(pChar + 2) == nsCRT::CR) &amp;&amp; (*(pChar + 3) == nsCRT::LF))</span>
<a href="#l32.900"></a><span id="l32.900" class="difflineminus">-    return 4;</span>
<a href="#l32.901"></a><span id="l32.901" class="difflineminus">-</span>
<a href="#l32.902"></a><span id="l32.902" class="difflineminus">-  return -1;</span>
<a href="#l32.903"></a><span id="l32.903" class="difflineminus">-}</span>
<a href="#l32.904"></a><span id="l32.904" class="difflineminus">-</span>
<a href="#l32.905"></a><span id="l32.905" class="difflineminus">-static const char *eudoraTag[] = {</span>
<a href="#l32.906"></a><span id="l32.906" class="difflineminus">-  &quot;&lt;x-html&gt;&quot;,</span>
<a href="#l32.907"></a><span id="l32.907" class="difflineminus">-  &quot;&lt;/x-html&gt;&quot;,</span>
<a href="#l32.908"></a><span id="l32.908" class="difflineminus">-  &quot;&lt;x-rich&gt;&quot;,</span>
<a href="#l32.909"></a><span id="l32.909" class="difflineminus">-  &quot;&lt;/x-rich&gt;&quot;,</span>
<a href="#l32.910"></a><span id="l32.910" class="difflineminus">-  &quot;&lt;x-flowed&gt;&quot;,</span>
<a href="#l32.911"></a><span id="l32.911" class="difflineminus">-  &quot;&lt;/x-flowed&gt;&quot;</span>
<a href="#l32.912"></a><span id="l32.912" class="difflineminus">-};</span>
<a href="#l32.913"></a><span id="l32.913" class="difflineminus">-</span>
<a href="#l32.914"></a><span id="l32.914" class="difflineminus">-static int32_t eudoraTagLen[] = {</span>
<a href="#l32.915"></a><span id="l32.915" class="difflineminus">-  8,</span>
<a href="#l32.916"></a><span id="l32.916" class="difflineminus">-  9,</span>
<a href="#l32.917"></a><span id="l32.917" class="difflineminus">-  8,</span>
<a href="#l32.918"></a><span id="l32.918" class="difflineminus">-  9,</span>
<a href="#l32.919"></a><span id="l32.919" class="difflineminus">-  10,</span>
<a href="#l32.920"></a><span id="l32.920" class="difflineminus">-  11,</span>
<a href="#l32.921"></a><span id="l32.921" class="difflineminus">-  0</span>
<a href="#l32.922"></a><span id="l32.922" class="difflineminus">-};</span>
<a href="#l32.923"></a><span id="l32.923" class="difflineminus">-</span>
<a href="#l32.924"></a><span id="l32.924" class="difflineminus">-static const char *TagContentType[] = {</span>
<a href="#l32.925"></a><span id="l32.925" class="difflineminus">-  &quot;text/html&quot;,</span>
<a href="#l32.926"></a><span id="l32.926" class="difflineminus">-  &quot;text/html&quot;,</span>
<a href="#l32.927"></a><span id="l32.927" class="difflineminus">-  &quot;text/enriched&quot;,</span>
<a href="#l32.928"></a><span id="l32.928" class="difflineminus">-  &quot;text/enriched&quot;,</span>
<a href="#l32.929"></a><span id="l32.929" class="difflineminus">-  &quot;text/plain&quot;,</span>
<a href="#l32.930"></a><span id="l32.930" class="difflineminus">-  &quot;text/plain&quot;,</span>
<a href="#l32.931"></a><span id="l32.931" class="difflineminus">-};</span>
<a href="#l32.932"></a><span id="l32.932" class="difflineminus">-</span>
<a href="#l32.933"></a><span id="l32.933" class="difflineminus">-  // Determine if this line contains an eudora special tag</span>
<a href="#l32.934"></a><span id="l32.934" class="difflineminus">-bool    nsEudoraMailbox::IsEudoraTag(const char *pChar, int32_t maxLen, bool &amp;insideEudoraTags, nsCString &amp;bodyType, int32_t &amp;tagLength)</span>
<a href="#l32.935"></a><span id="l32.935" class="difflineminus">-{</span>
<a href="#l32.936"></a><span id="l32.936" class="difflineminus">-  int32_t  idx = 0;</span>
<a href="#l32.937"></a><span id="l32.937" class="difflineminus">-  while ((tagLength = eudoraTagLen[idx]) != 0) {</span>
<a href="#l32.938"></a><span id="l32.938" class="difflineminus">-    if (maxLen &gt;= tagLength &amp;&amp; !strncmp(eudoraTag[idx], pChar, tagLength)) {</span>
<a href="#l32.939"></a><span id="l32.939" class="difflineminus">-      insideEudoraTags = (pChar[1] != '/');</span>
<a href="#l32.940"></a><span id="l32.940" class="difflineminus">-      bodyType = TagContentType[idx];</span>
<a href="#l32.941"></a><span id="l32.941" class="difflineminus">-      return true;</span>
<a href="#l32.942"></a><span id="l32.942" class="difflineminus">-    }</span>
<a href="#l32.943"></a><span id="l32.943" class="difflineminus">-    idx++;</span>
<a href="#l32.944"></a><span id="l32.944" class="difflineminus">-  }</span>
<a href="#l32.945"></a><span id="l32.945" class="difflineminus">-</span>
<a href="#l32.946"></a><span id="l32.946" class="difflineminus">-  return false;</span>
<a href="#l32.947"></a><span id="l32.947" class="difflineminus">-}</span>
<a href="#l32.948"></a><span id="l32.948" class="difflineminus">-</span>
<a href="#l32.949"></a><span id="l32.949" class="difflineminus">-  // Determine if this line meets Eudora standards for a separator line</span>
<a href="#l32.950"></a><span id="l32.950" class="difflineminus">-  // This logic is based on Eudora 1.3.1's strict requirements for what</span>
<a href="#l32.951"></a><span id="l32.951" class="difflineminus">-  // makes a valid separator line.  This may need to be relaxed for newer</span>
<a href="#l32.952"></a><span id="l32.952" class="difflineminus">-  // versions of Eudora.</span>
<a href="#l32.953"></a><span id="l32.953" class="difflineminus">-  // A sample from line:</span>
<a href="#l32.954"></a><span id="l32.954" class="difflineminus">-  // From john@uxc.cso.uiuc.edu Wed Jan 14 12:36:18 1989</span>
<a href="#l32.955"></a><span id="l32.955" class="difflineminus">-int32_t  nsEudoraMailbox::IsEudoraFromSeparator(const char *pChar, int32_t maxLen, nsCString&amp; defaultDate)</span>
<a href="#l32.956"></a><span id="l32.956" class="difflineminus">-{</span>
<a href="#l32.957"></a><span id="l32.957" class="difflineminus">-  if (maxLen &lt; 12)</span>
<a href="#l32.958"></a><span id="l32.958" class="difflineminus">-    return -1;</span>
<a href="#l32.959"></a><span id="l32.959" class="difflineminus">-</span>
<a href="#l32.960"></a><span id="l32.960" class="difflineminus">-  int32_t    len = 0;</span>
<a href="#l32.961"></a><span id="l32.961" class="difflineminus">-  if ((*pChar != 'F') || (*(pChar + 1) != 'r') || (*(pChar + 2) != 'o') || (*(pChar + 3) != 'm'))</span>
<a href="#l32.962"></a><span id="l32.962" class="difflineminus">-    return -1;</span>
<a href="#l32.963"></a><span id="l32.963" class="difflineminus">-  pChar += 4;</span>
<a href="#l32.964"></a><span id="l32.964" class="difflineminus">-  len += 4;</span>
<a href="#l32.965"></a><span id="l32.965" class="difflineminus">-</span>
<a href="#l32.966"></a><span id="l32.966" class="difflineminus">-  // According to Eudora the next char MUST be a space, and there can only be 1 space</span>
<a href="#l32.967"></a><span id="l32.967" class="difflineminus">-  // before the return mail address.</span>
<a href="#l32.968"></a><span id="l32.968" class="difflineminus">-  // I'll be nicer and allow any amount of whitespace</span>
<a href="#l32.969"></a><span id="l32.969" class="difflineminus">-  while (((*pChar == ' ') || (*pChar == '\t')) &amp;&amp; (len &lt; maxLen)) {</span>
<a href="#l32.970"></a><span id="l32.970" class="difflineminus">-    pChar++;</span>
<a href="#l32.971"></a><span id="l32.971" class="difflineminus">-    len++;</span>
<a href="#l32.972"></a><span id="l32.972" class="difflineminus">-  }</span>
<a href="#l32.973"></a><span id="l32.973" class="difflineminus">-  if (len == maxLen)</span>
<a href="#l32.974"></a><span id="l32.974" class="difflineminus">-    return -1;</span>
<a href="#l32.975"></a><span id="l32.975" class="difflineminus">-</span>
<a href="#l32.976"></a><span id="l32.976" class="difflineminus">-  // Determine the length of the line</span>
<a href="#l32.977"></a><span id="l32.977" class="difflineminus">-  int32_t      lineLen = len;</span>
<a href="#l32.978"></a><span id="l32.978" class="difflineminus">-  const char *  pTok = pChar;</span>
<a href="#l32.979"></a><span id="l32.979" class="difflineminus">-  // Skip to next end of line.</span>
<a href="#l32.980"></a><span id="l32.980" class="difflineminus">-  while ((lineLen &lt; maxLen) &amp;&amp; (*pTok != nsCRT::CR) &amp;&amp; (*pTok != nsCRT::LF)) {</span>
<a href="#l32.981"></a><span id="l32.981" class="difflineminus">-    lineLen++;</span>
<a href="#l32.982"></a><span id="l32.982" class="difflineminus">-    pTok++;</span>
<a href="#l32.983"></a><span id="l32.983" class="difflineminus">-  }</span>
<a href="#l32.984"></a><span id="l32.984" class="difflineminus">-  if (len &gt;= lineLen)</span>
<a href="#l32.985"></a><span id="l32.985" class="difflineminus">-    return -1;</span>
<a href="#l32.986"></a><span id="l32.986" class="difflineminus">-</span>
<a href="#l32.987"></a><span id="l32.987" class="difflineminus">-  // Eudora allows the return address to be double quoted or not at all..</span>
<a href="#l32.988"></a><span id="l32.988" class="difflineminus">-  // I'll allow single or double quote, but other than that, just skip</span>
<a href="#l32.989"></a><span id="l32.989" class="difflineminus">-  // the return address until you hit a space char (I allow tab as well)</span>
<a href="#l32.990"></a><span id="l32.990" class="difflineminus">-  char  quote = *pChar;</span>
<a href="#l32.991"></a><span id="l32.991" class="difflineminus">-  if ((quote == '&quot;') || (quote == '\'')) {</span>
<a href="#l32.992"></a><span id="l32.992" class="difflineminus">-    pChar++;</span>
<a href="#l32.993"></a><span id="l32.993" class="difflineminus">-    len++;</span>
<a href="#l32.994"></a><span id="l32.994" class="difflineminus">-    while ((len &lt; lineLen) &amp;&amp; (*pChar != quote)) {</span>
<a href="#l32.995"></a><span id="l32.995" class="difflineminus">-      pChar++;</span>
<a href="#l32.996"></a><span id="l32.996" class="difflineminus">-      len++;</span>
<a href="#l32.997"></a><span id="l32.997" class="difflineminus">-    }</span>
<a href="#l32.998"></a><span id="l32.998" class="difflineminus">-    if (len == lineLen)</span>
<a href="#l32.999"></a><span id="l32.999" class="difflineminus">-      return -1;</span>
<a href="#l32.1000"></a><span id="l32.1000" class="difflineminus">-    len++;</span>
<a href="#l32.1001"></a><span id="l32.1001" class="difflineminus">-    pChar++;</span>
<a href="#l32.1002"></a><span id="l32.1002" class="difflineminus">-  }</span>
<a href="#l32.1003"></a><span id="l32.1003" class="difflineminus">-  else {</span>
<a href="#l32.1004"></a><span id="l32.1004" class="difflineminus">-    while ((len &lt; lineLen) &amp;&amp; (*pChar != ' ') &amp;&amp; (*pChar != '\t')) {</span>
<a href="#l32.1005"></a><span id="l32.1005" class="difflineminus">-      pChar++;</span>
<a href="#l32.1006"></a><span id="l32.1006" class="difflineminus">-      len++;</span>
<a href="#l32.1007"></a><span id="l32.1007" class="difflineminus">-    }</span>
<a href="#l32.1008"></a><span id="l32.1008" class="difflineminus">-  }</span>
<a href="#l32.1009"></a><span id="l32.1009" class="difflineminus">-  while (((*pChar == ' ') || (*pChar == '\t')) &amp;&amp; (len &lt; lineLen)) {</span>
<a href="#l32.1010"></a><span id="l32.1010" class="difflineminus">-    pChar++;</span>
<a href="#l32.1011"></a><span id="l32.1011" class="difflineminus">-    len++;</span>
<a href="#l32.1012"></a><span id="l32.1012" class="difflineminus">-  }</span>
<a href="#l32.1013"></a><span id="l32.1013" class="difflineminus">-  if (len == lineLen)</span>
<a href="#l32.1014"></a><span id="l32.1014" class="difflineminus">-    return -1;</span>
<a href="#l32.1015"></a><span id="l32.1015" class="difflineminus">-</span>
<a href="#l32.1016"></a><span id="l32.1016" class="difflineminus">-  // we've passed the address, now check for the remaining data</span>
<a href="#l32.1017"></a><span id="l32.1017" class="difflineminus">-  // Now it gets really funky!</span>
<a href="#l32.1018"></a><span id="l32.1018" class="difflineminus">-  // In no particular order, with token separators space, tab, comma, newline</span>
<a href="#l32.1019"></a><span id="l32.1019" class="difflineminus">-  // a - the phrase &quot;remote from&quot;, remote must be first, from is optional.  2 froms or 2 remotes fails</span>
<a href="#l32.1020"></a><span id="l32.1020" class="difflineminus">-  // b - one and only one time value xx:xx or xx:xx:xx</span>
<a href="#l32.1021"></a><span id="l32.1021" class="difflineminus">-  // c - one and only one day, 1 to 31</span>
<a href="#l32.1022"></a><span id="l32.1022" class="difflineminus">-  // d - one and only one year, 2 digit anything or 4 digit &gt; 1900</span>
<a href="#l32.1023"></a><span id="l32.1023" class="difflineminus">-  // e - one and only one weekday, 3 letter abreviation</span>
<a href="#l32.1024"></a><span id="l32.1024" class="difflineminus">-  // f - one and only one month, 3 letter abreviation</span>
<a href="#l32.1025"></a><span id="l32.1025" class="difflineminus">-  // 2 allowable &quot;other&quot; tokens</span>
<a href="#l32.1026"></a><span id="l32.1026" class="difflineminus">-  // to be valid, day, year, month, &amp; tym must exist and other must be less than 3</span>
<a href="#l32.1027"></a><span id="l32.1027" class="difflineminus">-</span>
<a href="#l32.1028"></a><span id="l32.1028" class="difflineminus">-  int    day = 0;</span>
<a href="#l32.1029"></a><span id="l32.1029" class="difflineminus">-  int    month = 0;</span>
<a href="#l32.1030"></a><span id="l32.1030" class="difflineminus">-  int    year = 0;</span>
<a href="#l32.1031"></a><span id="l32.1031" class="difflineminus">-  int    weekDay = 0;</span>
<a href="#l32.1032"></a><span id="l32.1032" class="difflineminus">-  int    other = 0;</span>
<a href="#l32.1033"></a><span id="l32.1033" class="difflineminus">-  int    result;</span>
<a href="#l32.1034"></a><span id="l32.1034" class="difflineminus">-  char  tymStr[9];  // Make it a null terminated string (used in PR_snprintf() call()).</span>
<a href="#l32.1035"></a><span id="l32.1035" class="difflineminus">-  bool    tym = false;</span>
<a href="#l32.1036"></a><span id="l32.1036" class="difflineminus">-  bool    remote = false;</span>
<a href="#l32.1037"></a><span id="l32.1037" class="difflineminus">-  bool    from = false;</span>
<a href="#l32.1038"></a><span id="l32.1038" class="difflineminus">-  int32_t  tokLen;</span>
<a href="#l32.1039"></a><span id="l32.1039" class="difflineminus">-  int32_t  tokStart;</span>
<a href="#l32.1040"></a><span id="l32.1040" class="difflineminus">-  int32_t  num;</span>
<a href="#l32.1041"></a><span id="l32.1041" class="difflineminus">-</span>
<a href="#l32.1042"></a><span id="l32.1042" class="difflineminus">-  while ((len &lt; lineLen) &amp;&amp; (other &lt; 3)) {</span>
<a href="#l32.1043"></a><span id="l32.1043" class="difflineminus">-    pTok = pChar;</span>
<a href="#l32.1044"></a><span id="l32.1044" class="difflineminus">-    tokStart = len;</span>
<a href="#l32.1045"></a><span id="l32.1045" class="difflineminus">-    while ((len &lt; lineLen) &amp;&amp; (*pChar != ' ') &amp;&amp; (*pChar != '\t') &amp;&amp; (*pChar != ',')) {</span>
<a href="#l32.1046"></a><span id="l32.1046" class="difflineminus">-      pChar++;</span>
<a href="#l32.1047"></a><span id="l32.1047" class="difflineminus">-      len++;</span>
<a href="#l32.1048"></a><span id="l32.1048" class="difflineminus">-    }</span>
<a href="#l32.1049"></a><span id="l32.1049" class="difflineminus">-    tokLen = len - tokStart;</span>
<a href="#l32.1050"></a><span id="l32.1050" class="difflineminus">-    if (tokLen) {</span>
<a href="#l32.1051"></a><span id="l32.1051" class="difflineminus">-      num = AsciiToLong(pTok, tokLen);</span>
<a href="#l32.1052"></a><span id="l32.1052" class="difflineminus">-      if ((tokLen == 3) &amp;&amp; ((result = IsWeekDayStr(pTok)) != 0)) {</span>
<a href="#l32.1053"></a><span id="l32.1053" class="difflineminus">-        if (weekDay)</span>
<a href="#l32.1054"></a><span id="l32.1054" class="difflineminus">-          return -1;</span>
<a href="#l32.1055"></a><span id="l32.1055" class="difflineminus">-        weekDay = result;</span>
<a href="#l32.1056"></a><span id="l32.1056" class="difflineminus">-      }</span>
<a href="#l32.1057"></a><span id="l32.1057" class="difflineminus">-      else if ((tokLen == 3) &amp;&amp; ((result = IsMonthStr(pTok)) != 0)) {</span>
<a href="#l32.1058"></a><span id="l32.1058" class="difflineminus">-        if (month)</span>
<a href="#l32.1059"></a><span id="l32.1059" class="difflineminus">-          return -1;</span>
<a href="#l32.1060"></a><span id="l32.1060" class="difflineminus">-        month = result;</span>
<a href="#l32.1061"></a><span id="l32.1061" class="difflineminus">-      }</span>
<a href="#l32.1062"></a><span id="l32.1062" class="difflineminus">-      else if ((tokLen == 6) &amp;&amp; !PL_strncasecmp(pTok, &quot;remote&quot;, 6)) {</span>
<a href="#l32.1063"></a><span id="l32.1063" class="difflineminus">-        if (remote || from)</span>
<a href="#l32.1064"></a><span id="l32.1064" class="difflineminus">-          return -1;</span>
<a href="#l32.1065"></a><span id="l32.1065" class="difflineminus">-        remote = true;</span>
<a href="#l32.1066"></a><span id="l32.1066" class="difflineminus">-      }</span>
<a href="#l32.1067"></a><span id="l32.1067" class="difflineminus">-      else if ((tokLen == 4) &amp;&amp; !PL_strncasecmp(pTok, &quot;from&quot;, 4)) {</span>
<a href="#l32.1068"></a><span id="l32.1068" class="difflineminus">-        if (!remote || from)</span>
<a href="#l32.1069"></a><span id="l32.1069" class="difflineminus">-          return -1;</span>
<a href="#l32.1070"></a><span id="l32.1070" class="difflineminus">-        from = true;</span>
<a href="#l32.1071"></a><span id="l32.1071" class="difflineminus">-      }</span>
<a href="#l32.1072"></a><span id="l32.1072" class="difflineminus">-      else if ((tokLen == 4) &amp;&amp; ((num &gt; 1900) || !strncmp(pTok, &quot;0000&quot;, 4))) {</span>
<a href="#l32.1073"></a><span id="l32.1073" class="difflineminus">-        if (year)</span>
<a href="#l32.1074"></a><span id="l32.1074" class="difflineminus">-          return -1;</span>
<a href="#l32.1075"></a><span id="l32.1075" class="difflineminus">-        year = (int)num;</span>
<a href="#l32.1076"></a><span id="l32.1076" class="difflineminus">-        if (!year)</span>
<a href="#l32.1077"></a><span id="l32.1077" class="difflineminus">-          year = 1900;</span>
<a href="#l32.1078"></a><span id="l32.1078" class="difflineminus">-      }</span>
<a href="#l32.1079"></a><span id="l32.1079" class="difflineminus">-      else if (!year &amp;&amp; day &amp;&amp; (tokLen == 2) &amp;&amp; (*(pTok + 1) &gt;= '0') &amp;&amp; (*(pTok + 1) &lt;= '9')) {</span>
<a href="#l32.1080"></a><span id="l32.1080" class="difflineminus">-        if (num &lt; 65)</span>
<a href="#l32.1081"></a><span id="l32.1081" class="difflineminus">-          num += 1900;</span>
<a href="#l32.1082"></a><span id="l32.1082" class="difflineminus">-        else</span>
<a href="#l32.1083"></a><span id="l32.1083" class="difflineminus">-           num += 2000;</span>
<a href="#l32.1084"></a><span id="l32.1084" class="difflineminus">-         year = (int) num;</span>
<a href="#l32.1085"></a><span id="l32.1085" class="difflineminus">-      }</span>
<a href="#l32.1086"></a><span id="l32.1086" class="difflineminus">-      else if ((tokLen &lt;= 2) &amp;&amp; (*pTok &gt;= '0') &amp;&amp; (*pTok &lt;= '9')) {</span>
<a href="#l32.1087"></a><span id="l32.1087" class="difflineminus">-        day = (int) num;</span>
<a href="#l32.1088"></a><span id="l32.1088" class="difflineminus">-        if ((day &lt; 1) || (day &gt; 31))</span>
<a href="#l32.1089"></a><span id="l32.1089" class="difflineminus">-          day = 1;</span>
<a href="#l32.1090"></a><span id="l32.1090" class="difflineminus">-      }</span>
<a href="#l32.1091"></a><span id="l32.1091" class="difflineminus">-      else if ((tokLen &gt;= 5) &amp;&amp; (pTok[2] == ':') &amp;&amp; ((tokLen == 5) || ((tokLen == 8) &amp;&amp; (pTok[5] == ':')))) {</span>
<a href="#l32.1092"></a><span id="l32.1092" class="difflineminus">-        // looks like the tym...</span>
<a href="#l32.1093"></a><span id="l32.1093" class="difflineminus">-        for (result = 0; result &lt; (int)tokLen; result++) {</span>
<a href="#l32.1094"></a><span id="l32.1094" class="difflineminus">-          if ((result != 2) &amp;&amp; (result != 5)) {</span>
<a href="#l32.1095"></a><span id="l32.1095" class="difflineminus">-            if ((pTok[result] &lt; '0') || (pTok[result] &gt; '9')) {</span>
<a href="#l32.1096"></a><span id="l32.1096" class="difflineminus">-              break;</span>
<a href="#l32.1097"></a><span id="l32.1097" class="difflineminus">-            }</span>
<a href="#l32.1098"></a><span id="l32.1098" class="difflineminus">-          }</span>
<a href="#l32.1099"></a><span id="l32.1099" class="difflineminus">-        }</span>
<a href="#l32.1100"></a><span id="l32.1100" class="difflineminus">-        if (result == tokLen) {</span>
<a href="#l32.1101"></a><span id="l32.1101" class="difflineminus">-          if (tym)</span>
<a href="#l32.1102"></a><span id="l32.1102" class="difflineminus">-            return -1;</span>
<a href="#l32.1103"></a><span id="l32.1103" class="difflineminus">-          tym = true;</span>
<a href="#l32.1104"></a><span id="l32.1104" class="difflineminus">-          // for future use, get the time value</span>
<a href="#l32.1105"></a><span id="l32.1105" class="difflineminus">-          memcpy(tymStr, pTok, tokLen);</span>
<a href="#l32.1106"></a><span id="l32.1106" class="difflineminus">-          if (tokLen == 5) {</span>
<a href="#l32.1107"></a><span id="l32.1107" class="difflineminus">-            tymStr[5] = ':';</span>
<a href="#l32.1108"></a><span id="l32.1108" class="difflineminus">-            tymStr[6] = '0';</span>
<a href="#l32.1109"></a><span id="l32.1109" class="difflineminus">-            tymStr[7] = '0';</span>
<a href="#l32.1110"></a><span id="l32.1110" class="difflineminus">-          }</span>
<a href="#l32.1111"></a><span id="l32.1111" class="difflineminus">-          tymStr[8] = 0;</span>
<a href="#l32.1112"></a><span id="l32.1112" class="difflineminus">-        }</span>
<a href="#l32.1113"></a><span id="l32.1113" class="difflineminus">-        else {</span>
<a href="#l32.1114"></a><span id="l32.1114" class="difflineminus">-          other++;</span>
<a href="#l32.1115"></a><span id="l32.1115" class="difflineminus">-        }</span>
<a href="#l32.1116"></a><span id="l32.1116" class="difflineminus">-      }</span>
<a href="#l32.1117"></a><span id="l32.1117" class="difflineminus">-      else</span>
<a href="#l32.1118"></a><span id="l32.1118" class="difflineminus">-        other++;</span>
<a href="#l32.1119"></a><span id="l32.1119" class="difflineminus">-    }</span>
<a href="#l32.1120"></a><span id="l32.1120" class="difflineminus">-    // Skip the space chars...</span>
<a href="#l32.1121"></a><span id="l32.1121" class="difflineminus">-    while ((len &lt; lineLen) &amp;&amp; ((*pChar == ' ') || (*pChar == '\t') || (*pChar == ','))) {</span>
<a href="#l32.1122"></a><span id="l32.1122" class="difflineminus">-      pChar++;</span>
<a href="#l32.1123"></a><span id="l32.1123" class="difflineminus">-      len++;</span>
<a href="#l32.1124"></a><span id="l32.1124" class="difflineminus">-    }</span>
<a href="#l32.1125"></a><span id="l32.1125" class="difflineminus">-  } // end while (len &lt; lineLen) token loop</span>
<a href="#l32.1126"></a><span id="l32.1126" class="difflineminus">-</span>
<a href="#l32.1127"></a><span id="l32.1127" class="difflineminus">-  // Now let's see what we found on the line</span>
<a href="#l32.1128"></a><span id="l32.1128" class="difflineminus">-  if (day &amp;&amp; year &amp;&amp; month &amp;&amp; tym &amp;&amp; (other &lt; 3)) {</span>
<a href="#l32.1129"></a><span id="l32.1129" class="difflineminus">-    // Now we need to make sure the next line</span>
<a href="#l32.1130"></a><span id="l32.1130" class="difflineminus">-    // isn't blank!</span>
<a href="#l32.1131"></a><span id="l32.1131" class="difflineminus">-    while (len &lt; lineLen) {</span>
<a href="#l32.1132"></a><span id="l32.1132" class="difflineminus">-      len++;</span>
<a href="#l32.1133"></a><span id="l32.1133" class="difflineminus">-      pChar++;</span>
<a href="#l32.1134"></a><span id="l32.1134" class="difflineminus">-    }</span>
<a href="#l32.1135"></a><span id="l32.1135" class="difflineminus">-    if (len == maxLen)</span>
<a href="#l32.1136"></a><span id="l32.1136" class="difflineminus">-      return -1;</span>
<a href="#l32.1137"></a><span id="l32.1137" class="difflineminus">-</span>
<a href="#l32.1138"></a><span id="l32.1138" class="difflineminus">-    if (*pChar == nsCRT::CR) {</span>
<a href="#l32.1139"></a><span id="l32.1139" class="difflineminus">-      len++;</span>
<a href="#l32.1140"></a><span id="l32.1140" class="difflineminus">-      pChar++;</span>
<a href="#l32.1141"></a><span id="l32.1141" class="difflineminus">-      if (*pChar == nsCRT::LF) {</span>
<a href="#l32.1142"></a><span id="l32.1142" class="difflineminus">-        len++;</span>
<a href="#l32.1143"></a><span id="l32.1143" class="difflineminus">-        pChar++;</span>
<a href="#l32.1144"></a><span id="l32.1144" class="difflineminus">-      }</span>
<a href="#l32.1145"></a><span id="l32.1145" class="difflineminus">-    }</span>
<a href="#l32.1146"></a><span id="l32.1146" class="difflineminus">-    else if (*pChar == nsCRT::LF) {</span>
<a href="#l32.1147"></a><span id="l32.1147" class="difflineminus">-      len++;</span>
<a href="#l32.1148"></a><span id="l32.1148" class="difflineminus">-      pChar++;</span>
<a href="#l32.1149"></a><span id="l32.1149" class="difflineminus">-    }</span>
<a href="#l32.1150"></a><span id="l32.1150" class="difflineminus">-    else</span>
<a href="#l32.1151"></a><span id="l32.1151" class="difflineminus">-      return -1;</span>
<a href="#l32.1152"></a><span id="l32.1152" class="difflineminus">-</span>
<a href="#l32.1153"></a><span id="l32.1153" class="difflineminus">-    if (len &gt;= maxLen)</span>
<a href="#l32.1154"></a><span id="l32.1154" class="difflineminus">-      return -1;</span>
<a href="#l32.1155"></a><span id="l32.1155" class="difflineminus">-</span>
<a href="#l32.1156"></a><span id="l32.1156" class="difflineminus">-    while (len &lt; maxLen) {</span>
<a href="#l32.1157"></a><span id="l32.1157" class="difflineminus">-      if ((*pChar == nsCRT::CR) || (*pChar == nsCRT::LF))</span>
<a href="#l32.1158"></a><span id="l32.1158" class="difflineminus">-        return -1;</span>
<a href="#l32.1159"></a><span id="l32.1159" class="difflineminus">-</span>
<a href="#l32.1160"></a><span id="l32.1160" class="difflineminus">-      if ((*pChar != ' ') &amp;&amp; (*pChar != '\t'))</span>
<a href="#l32.1161"></a><span id="l32.1161" class="difflineminus">-        break;</span>
<a href="#l32.1162"></a><span id="l32.1162" class="difflineminus">-</span>
<a href="#l32.1163"></a><span id="l32.1163" class="difflineminus">-      pChar++;</span>
<a href="#l32.1164"></a><span id="l32.1164" class="difflineminus">-      len++;</span>
<a href="#l32.1165"></a><span id="l32.1165" class="difflineminus">-    }</span>
<a href="#l32.1166"></a><span id="l32.1166" class="difflineminus">-</span>
<a href="#l32.1167"></a><span id="l32.1167" class="difflineminus">-    // Whew!, the next line isn't blank.</span>
<a href="#l32.1168"></a><span id="l32.1168" class="difflineminus">-    // Generate the default date header in case the date header is missing when we</span>
<a href="#l32.1169"></a><span id="l32.1169" class="difflineminus">-    // write out headers later. The header looks like &quot;Date: Tue, 5 Feb 2002 23:05:04&quot;</span>
<a href="#l32.1170"></a><span id="l32.1170" class="difflineminus">-    char date_header_str[DATE_STR_LEN];</span>
<a href="#l32.1171"></a><span id="l32.1171" class="difflineminus">-    PR_snprintf(date_header_str, DATE_STR_LEN, &quot;Date: %s, %2d %s %4d %s&quot;, eudoraWeekDays[weekDay-1], day, eudoraMonths[month-1], year, tymStr);</span>
<a href="#l32.1172"></a><span id="l32.1172" class="difflineminus">-    defaultDate.Assign(date_header_str);</span>
<a href="#l32.1173"></a><span id="l32.1173" class="difflineminus">-</span>
<a href="#l32.1174"></a><span id="l32.1174" class="difflineminus">-    return lineLen;</span>
<a href="#l32.1175"></a><span id="l32.1175" class="difflineminus">-  }</span>
<a href="#l32.1176"></a><span id="l32.1176" class="difflineminus">-</span>
<a href="#l32.1177"></a><span id="l32.1177" class="difflineminus">-  return -1;</span>
<a href="#l32.1178"></a><span id="l32.1178" class="difflineminus">-}</span>
<a href="#l32.1179"></a><span id="l32.1179" class="difflineminus">-</span>
<a href="#l32.1180"></a><span id="l32.1180" class="difflineminus">-int32_t nsEudoraMailbox::AsciiToLong(const char *pChar, int32_t len)</span>
<a href="#l32.1181"></a><span id="l32.1181" class="difflineminus">-{</span>
<a href="#l32.1182"></a><span id="l32.1182" class="difflineminus">-  int32_t num = 0;</span>
<a href="#l32.1183"></a><span id="l32.1183" class="difflineminus">-  while (len) {</span>
<a href="#l32.1184"></a><span id="l32.1184" class="difflineminus">-    if ((*pChar &lt; '0') || (*pChar &gt; '9'))</span>
<a href="#l32.1185"></a><span id="l32.1185" class="difflineminus">-      return num;</span>
<a href="#l32.1186"></a><span id="l32.1186" class="difflineminus">-    num *= 10;</span>
<a href="#l32.1187"></a><span id="l32.1187" class="difflineminus">-    num += (*pChar - '0');</span>
<a href="#l32.1188"></a><span id="l32.1188" class="difflineminus">-    len--;</span>
<a href="#l32.1189"></a><span id="l32.1189" class="difflineminus">-    pChar++;</span>
<a href="#l32.1190"></a><span id="l32.1190" class="difflineminus">-  }</span>
<a href="#l32.1191"></a><span id="l32.1191" class="difflineminus">-  return num;</span>
<a href="#l32.1192"></a><span id="l32.1192" class="difflineminus">-}</span>
<a href="#l32.1193"></a><span id="l32.1193" class="difflineminus">-</span>
<a href="#l32.1194"></a><span id="l32.1194" class="difflineminus">-int nsEudoraMailbox::IsWeekDayStr(const char *pStr)</span>
<a href="#l32.1195"></a><span id="l32.1195" class="difflineminus">-{</span>
<a href="#l32.1196"></a><span id="l32.1196" class="difflineminus">-  for (int i = 0; i &lt; 7; i++) {</span>
<a href="#l32.1197"></a><span id="l32.1197" class="difflineminus">-    if (!PL_strncasecmp(pStr, eudoraWeekDays[i], 3))</span>
<a href="#l32.1198"></a><span id="l32.1198" class="difflineminus">-      return i + 1;</span>
<a href="#l32.1199"></a><span id="l32.1199" class="difflineminus">-  }</span>
<a href="#l32.1200"></a><span id="l32.1200" class="difflineminus">-  return 0;</span>
<a href="#l32.1201"></a><span id="l32.1201" class="difflineminus">-}</span>
<a href="#l32.1202"></a><span id="l32.1202" class="difflineminus">-</span>
<a href="#l32.1203"></a><span id="l32.1203" class="difflineminus">-int nsEudoraMailbox::IsMonthStr(const char *pStr)</span>
<a href="#l32.1204"></a><span id="l32.1204" class="difflineminus">-{</span>
<a href="#l32.1205"></a><span id="l32.1205" class="difflineminus">-  for (int i = 0; i &lt; 12; i++) {</span>
<a href="#l32.1206"></a><span id="l32.1206" class="difflineminus">-    if (!PL_strncasecmp(pStr, eudoraMonths[i], 3))</span>
<a href="#l32.1207"></a><span id="l32.1207" class="difflineminus">-      return i + 1;</span>
<a href="#l32.1208"></a><span id="l32.1208" class="difflineminus">-  }</span>
<a href="#l32.1209"></a><span id="l32.1209" class="difflineminus">-  return 0;</span>
<a href="#l32.1210"></a><span id="l32.1210" class="difflineminus">-}</span>
<a href="#l32.1211"></a><span id="l32.1211" class="difflineminus">-</span>
<a href="#l32.1212"></a><span id="l32.1212" class="difflineminus">-nsresult nsEudoraMailbox::WriteFromSep(nsIOutputStream *pDst)</span>
<a href="#l32.1213"></a><span id="l32.1213" class="difflineminus">-{</span>
<a href="#l32.1214"></a><span id="l32.1214" class="difflineminus">-  if (!m_fromLen)</span>
<a href="#l32.1215"></a><span id="l32.1215" class="difflineminus">-    m_fromLen = strlen(eudoraFromLine);</span>
<a href="#l32.1216"></a><span id="l32.1216" class="difflineminus">-  uint32_t  written = 0;</span>
<a href="#l32.1217"></a><span id="l32.1217" class="difflineminus">-  nsresult rv = pDst-&gt;Write(eudoraFromLine, m_fromLen, &amp;written);</span>
<a href="#l32.1218"></a><span id="l32.1218" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; (written != m_fromLen))</span>
<a href="#l32.1219"></a><span id="l32.1219" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l32.1220"></a><span id="l32.1220" class="difflineminus">-  return rv;</span>
<a href="#l32.1221"></a><span id="l32.1221" class="difflineminus">-}</span>
<a href="#l32.1222"></a><span id="l32.1222" class="difflineminus">-</span>
<a href="#l32.1223"></a><span id="l32.1223" class="difflineminus">-void nsEudoraMailbox::EmptyAttachments(void)</span>
<a href="#l32.1224"></a><span id="l32.1224" class="difflineminus">-{</span>
<a href="#l32.1225"></a><span id="l32.1225" class="difflineminus">-  int32_t max = m_attachments.Length();</span>
<a href="#l32.1226"></a><span id="l32.1226" class="difflineminus">-  ImportAttachment *  pAttach;</span>
<a href="#l32.1227"></a><span id="l32.1227" class="difflineminus">-  for (int32_t i = 0; i &lt; max; i++) {</span>
<a href="#l32.1228"></a><span id="l32.1228" class="difflineminus">-    pAttach = m_attachments.ElementAt(i);</span>
<a href="#l32.1229"></a><span id="l32.1229" class="difflineminus">-    if (pAttach) {</span>
<a href="#l32.1230"></a><span id="l32.1230" class="difflineminus">-      NS_Free(pAttach-&gt;description);</span>
<a href="#l32.1231"></a><span id="l32.1231" class="difflineminus">-      NS_Free(pAttach-&gt;mimeType);</span>
<a href="#l32.1232"></a><span id="l32.1232" class="difflineminus">-      delete pAttach;</span>
<a href="#l32.1233"></a><span id="l32.1233" class="difflineminus">-    }</span>
<a href="#l32.1234"></a><span id="l32.1234" class="difflineminus">-  }</span>
<a href="#l32.1235"></a><span id="l32.1235" class="difflineminus">-</span>
<a href="#l32.1236"></a><span id="l32.1236" class="difflineminus">-  m_attachments.Clear();</span>
<a href="#l32.1237"></a><span id="l32.1237" class="difflineminus">-}</span>
<a href="#l32.1238"></a><span id="l32.1238" class="difflineminus">-</span>
<a href="#l32.1239"></a><span id="l32.1239" class="difflineminus">-static const char *eudoraAttachLines[] = {</span>
<a href="#l32.1240"></a><span id="l32.1240" class="difflineminus">-  &quot;Attachment Converted:&quot;,</span>
<a href="#l32.1241"></a><span id="l32.1241" class="difflineminus">-  &quot;Attachment converted:&quot;,</span>
<a href="#l32.1242"></a><span id="l32.1242" class="difflineminus">-  &quot;Pice jointe convertie :&quot;,</span>
<a href="#l32.1243"></a><span id="l32.1243" class="difflineminus">-  // Japanese text encoded with Shift-JIS.</span>
<a href="#l32.1244"></a><span id="l32.1244" class="difflineminus">-  // The meaning is &quot;Restored attached file&quot;.</span>
<a href="#l32.1245"></a><span id="l32.1245" class="difflineminus">-  &quot;\x95\x9c\x8c\xb3\x82\xb3\x82\xea\x82\xbd\x93\x59\x95\x74\x83\x74\x83\x40\x83\x43\x83\x8b\x81\x46&quot;</span>
<a href="#l32.1246"></a><span id="l32.1246" class="difflineminus">-};</span>
<a href="#l32.1247"></a><span id="l32.1247" class="difflineminus">-</span>
<a href="#l32.1248"></a><span id="l32.1248" class="difflineminus">-static int32_t eudoraAttachLen[] = {</span>
<a href="#l32.1249"></a><span id="l32.1249" class="difflineminus">-  21,</span>
<a href="#l32.1250"></a><span id="l32.1250" class="difflineminus">-  21,</span>
<a href="#l32.1251"></a><span id="l32.1251" class="difflineminus">-  24,</span>
<a href="#l32.1252"></a><span id="l32.1252" class="difflineminus">-  24,</span>
<a href="#l32.1253"></a><span id="l32.1253" class="difflineminus">-  0</span>
<a href="#l32.1254"></a><span id="l32.1254" class="difflineminus">-};</span>
<a href="#l32.1255"></a><span id="l32.1255" class="difflineminus">-</span>
<a href="#l32.1256"></a><span id="l32.1256" class="difflineminus">-nsresult nsEudoraMailbox::ExamineAttachment(SimpleBufferTonyRCopiedOnce&amp; data)</span>
<a href="#l32.1257"></a><span id="l32.1257" class="difflineminus">-{</span>
<a href="#l32.1258"></a><span id="l32.1258" class="difflineminus">-  // get the file, then get the mime type, and add it to the array</span>
<a href="#l32.1259"></a><span id="l32.1259" class="difflineminus">-  // of attachments.</span>
<a href="#l32.1260"></a><span id="l32.1260" class="difflineminus">-  int32_t    len = data.m_bytesInBuf - data.m_writeOffset;</span>
<a href="#l32.1261"></a><span id="l32.1261" class="difflineminus">-  const char *pChar = data.m_pBuffer + data.m_writeOffset;</span>
<a href="#l32.1262"></a><span id="l32.1262" class="difflineminus">-  const char *pData;</span>
<a href="#l32.1263"></a><span id="l32.1263" class="difflineminus">-  const char *pStart;</span>
<a href="#l32.1264"></a><span id="l32.1264" class="difflineminus">-  int32_t  nameLen;</span>
<a href="#l32.1265"></a><span id="l32.1265" class="difflineminus">-  char  quote;</span>
<a href="#l32.1266"></a><span id="l32.1266" class="difflineminus">-  int32_t  cnt;</span>
<a href="#l32.1267"></a><span id="l32.1267" class="difflineminus">-  int32_t  idx = 0;</span>
<a href="#l32.1268"></a><span id="l32.1268" class="difflineminus">-  while ((cnt = eudoraAttachLen[idx]) != 0) {</span>
<a href="#l32.1269"></a><span id="l32.1269" class="difflineminus">-    if (!strncmp(eudoraAttachLines[idx], pChar, cnt)) {</span>
<a href="#l32.1270"></a><span id="l32.1270" class="difflineminus">-      pData = pChar + cnt;</span>
<a href="#l32.1271"></a><span id="l32.1271" class="difflineminus">-      while (((*pData == ' ') || (*pData == '\t')) &amp;&amp; (cnt &lt; len)) {</span>
<a href="#l32.1272"></a><span id="l32.1272" class="difflineminus">-        cnt++;</span>
<a href="#l32.1273"></a><span id="l32.1273" class="difflineminus">-        pData++;</span>
<a href="#l32.1274"></a><span id="l32.1274" class="difflineminus">-      }</span>
<a href="#l32.1275"></a><span id="l32.1275" class="difflineminus">-      if (pData != pChar) {</span>
<a href="#l32.1276"></a><span id="l32.1276" class="difflineminus">-        quote = *pData;</span>
<a href="#l32.1277"></a><span id="l32.1277" class="difflineminus">-        nameLen = 0;</span>
<a href="#l32.1278"></a><span id="l32.1278" class="difflineminus">-        if ((quote == '&quot;') || (quote == '\'')) {</span>
<a href="#l32.1279"></a><span id="l32.1279" class="difflineminus">-          pData++;</span>
<a href="#l32.1280"></a><span id="l32.1280" class="difflineminus">-          cnt++;</span>
<a href="#l32.1281"></a><span id="l32.1281" class="difflineminus">-          pStart = pData;</span>
<a href="#l32.1282"></a><span id="l32.1282" class="difflineminus">-          while ((*pData != quote) &amp;&amp; (cnt &lt; len)) {</span>
<a href="#l32.1283"></a><span id="l32.1283" class="difflineminus">-            cnt++;</span>
<a href="#l32.1284"></a><span id="l32.1284" class="difflineminus">-            pData++;</span>
<a href="#l32.1285"></a><span id="l32.1285" class="difflineminus">-            nameLen++;</span>
<a href="#l32.1286"></a><span id="l32.1286" class="difflineminus">-          }</span>
<a href="#l32.1287"></a><span id="l32.1287" class="difflineminus">-        }</span>
<a href="#l32.1288"></a><span id="l32.1288" class="difflineminus">-        else {</span>
<a href="#l32.1289"></a><span id="l32.1289" class="difflineminus">-          pStart = pData;</span>
<a href="#l32.1290"></a><span id="l32.1290" class="difflineminus">-          // Skip to next end of line.</span>
<a href="#l32.1291"></a><span id="l32.1291" class="difflineminus">-          while ((cnt &lt; len) &amp;&amp;</span>
<a href="#l32.1292"></a><span id="l32.1292" class="difflineminus">-                 (*pData != nsCRT::CR) &amp;&amp; (*pData != nsCRT::LF)) {</span>
<a href="#l32.1293"></a><span id="l32.1293" class="difflineminus">-            pData++;</span>
<a href="#l32.1294"></a><span id="l32.1294" class="difflineminus">-            cnt++;</span>
<a href="#l32.1295"></a><span id="l32.1295" class="difflineminus">-            nameLen++;</span>
<a href="#l32.1296"></a><span id="l32.1296" class="difflineminus">-          }</span>
<a href="#l32.1297"></a><span id="l32.1297" class="difflineminus">-        }</span>
<a href="#l32.1298"></a><span id="l32.1298" class="difflineminus">-        nsCString  fileName;</span>
<a href="#l32.1299"></a><span id="l32.1299" class="difflineminus">-        fileName.Append(pStart, nameLen);</span>
<a href="#l32.1300"></a><span id="l32.1300" class="difflineminus">-        fileName.Trim(kWhitespace);</span>
<a href="#l32.1301"></a><span id="l32.1301" class="difflineminus">-        if (fileName.Length()) {</span>
<a href="#l32.1302"></a><span id="l32.1302" class="difflineminus">-#ifdef XP_MACOSX</span>
<a href="#l32.1303"></a><span id="l32.1303" class="difflineminus">-          return NS_OK;</span>
<a href="#l32.1304"></a><span id="l32.1304" class="difflineminus">-#else</span>
<a href="#l32.1305"></a><span id="l32.1305" class="difflineminus">-          if(AddAttachment(fileName))</span>
<a href="#l32.1306"></a><span id="l32.1306" class="difflineminus">-            return NS_OK;</span>
<a href="#l32.1307"></a><span id="l32.1307" class="difflineminus">-#endif</span>
<a href="#l32.1308"></a><span id="l32.1308" class="difflineminus">-        }</span>
<a href="#l32.1309"></a><span id="l32.1309" class="difflineminus">-      }</span>
<a href="#l32.1310"></a><span id="l32.1310" class="difflineminus">-    }</span>
<a href="#l32.1311"></a><span id="l32.1311" class="difflineminus">-    idx++;</span>
<a href="#l32.1312"></a><span id="l32.1312" class="difflineminus">-  }</span>
<a href="#l32.1313"></a><span id="l32.1313" class="difflineminus">-</span>
<a href="#l32.1314"></a><span id="l32.1314" class="difflineminus">-  return NS_OK;</span>
<a href="#l32.1315"></a><span id="l32.1315" class="difflineminus">-}</span>
<a href="#l32.1316"></a><span id="l32.1316" class="difflineminus">-</span>
<a href="#l32.1317"></a><span id="l32.1317" class="difflineminus">-bool nsEudoraMailbox::AddAttachment(nsCString&amp; fileName)</span>
<a href="#l32.1318"></a><span id="l32.1318" class="difflineminus">-{</span>
<a href="#l32.1319"></a><span id="l32.1319" class="difflineminus">-  IMPORT_LOG1(&quot;Found attachment: %s\n&quot;, fileName.get());</span>
<a href="#l32.1320"></a><span id="l32.1320" class="difflineminus">-</span>
<a href="#l32.1321"></a><span id="l32.1321" class="difflineminus">-  nsresult rv;</span>
<a href="#l32.1322"></a><span id="l32.1322" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt;  pFile = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l32.1323"></a><span id="l32.1323" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l32.1324"></a><span id="l32.1324" class="difflineminus">-    return false;</span>
<a href="#l32.1325"></a><span id="l32.1325" class="difflineminus">-</span>
<a href="#l32.1326"></a><span id="l32.1326" class="difflineminus">-  nsCString mimeType;</span>
<a href="#l32.1327"></a><span id="l32.1327" class="difflineminus">-  nsCString attachmentName;</span>
<a href="#l32.1328"></a><span id="l32.1328" class="difflineminus">-  if (NS_FAILED(GetAttachmentInfo(fileName.get(), pFile, mimeType, attachmentName)))</span>
<a href="#l32.1329"></a><span id="l32.1329" class="difflineminus">-    return false;</span>
<a href="#l32.1330"></a><span id="l32.1330" class="difflineminus">-</span>
<a href="#l32.1331"></a><span id="l32.1331" class="difflineminus">-  ImportAttachment *a = new ImportAttachment;</span>
<a href="#l32.1332"></a><span id="l32.1332" class="difflineminus">-  a-&gt;mimeType = ToNewCString(mimeType);</span>
<a href="#l32.1333"></a><span id="l32.1333" class="difflineminus">-  a-&gt;description = !attachmentName.IsEmpty() ? ToNewCString(attachmentName) : strdup(&quot;Attached File&quot;);</span>
<a href="#l32.1334"></a><span id="l32.1334" class="difflineminus">-  a-&gt;pAttachment = pFile;</span>
<a href="#l32.1335"></a><span id="l32.1335" class="difflineminus">-</span>
<a href="#l32.1336"></a><span id="l32.1336" class="difflineminus">-  m_attachments.AppendElement(a);</span>
<a href="#l32.1337"></a><span id="l32.1337" class="difflineminus">-</span>
<a href="#l32.1338"></a><span id="l32.1338" class="difflineminus">-  return true;</span>
<a href="#l32.1339"></a><span id="l32.1339" class="difflineminus">-}</span>
<a href="#l32.1340"></a><span id="l32.1340" class="difflineminus">-</span>
<a href="#l32.1341"></a><span id="l32.1341" class="difflineminus">-nsresult nsEudoraMailbox::FillMailBuffer(ReadFileState *pState, SimpleBufferTonyRCopiedOnce&amp; read)</span>
<a href="#l32.1342"></a><span id="l32.1342" class="difflineminus">-{</span>
<a href="#l32.1343"></a><span id="l32.1343" class="difflineminus">-  if (read.m_writeOffset &gt;= read.m_bytesInBuf) {</span>
<a href="#l32.1344"></a><span id="l32.1344" class="difflineminus">-    read.m_writeOffset = 0;</span>
<a href="#l32.1345"></a><span id="l32.1345" class="difflineminus">-    read.m_bytesInBuf = 0;</span>
<a href="#l32.1346"></a><span id="l32.1346" class="difflineminus">-  }</span>
<a href="#l32.1347"></a><span id="l32.1347" class="difflineminus">-  else if (read.m_writeOffset) {</span>
<a href="#l32.1348"></a><span id="l32.1348" class="difflineminus">-    memcpy(read.m_pBuffer, read.m_pBuffer + read.m_writeOffset, read.m_bytesInBuf - read.m_writeOffset);</span>
<a href="#l32.1349"></a><span id="l32.1349" class="difflineminus">-    read.m_bytesInBuf -= read.m_writeOffset;</span>
<a href="#l32.1350"></a><span id="l32.1350" class="difflineminus">-    read.m_writeOffset = 0;</span>
<a href="#l32.1351"></a><span id="l32.1351" class="difflineminus">-  }</span>
<a href="#l32.1352"></a><span id="l32.1352" class="difflineminus">-</span>
<a href="#l32.1353"></a><span id="l32.1353" class="difflineminus">-  uint32_t  count = read.m_size - read.m_bytesInBuf;</span>
<a href="#l32.1354"></a><span id="l32.1354" class="difflineminus">-  if ((count + pState-&gt;offset) &gt; pState-&gt;size)</span>
<a href="#l32.1355"></a><span id="l32.1355" class="difflineminus">-    count = pState-&gt;size - pState-&gt;offset;</span>
<a href="#l32.1356"></a><span id="l32.1356" class="difflineminus">-  if (count) {</span>
<a href="#l32.1357"></a><span id="l32.1357" class="difflineminus">-    uint32_t    bytesRead = 0;</span>
<a href="#l32.1358"></a><span id="l32.1358" class="difflineminus">-    char *    pBuffer = read.m_pBuffer + read.m_bytesInBuf;</span>
<a href="#l32.1359"></a><span id="l32.1359" class="difflineminus">-    nsresult  rv = pState-&gt;pInputStream-&gt;Read(pBuffer, count, &amp;bytesRead);</span>
<a href="#l32.1360"></a><span id="l32.1360" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l32.1361"></a><span id="l32.1361" class="difflineminus">-      return rv;</span>
<a href="#l32.1362"></a><span id="l32.1362" class="difflineminus">-    if (bytesRead != uint32_t(count))</span>
<a href="#l32.1363"></a><span id="l32.1363" class="difflineminus">-      return NS_ERROR_FAILURE;</span>
<a href="#l32.1364"></a><span id="l32.1364" class="difflineminus">-    read.m_bytesInBuf += bytesRead;</span>
<a href="#l32.1365"></a><span id="l32.1365" class="difflineminus">-    pState-&gt;offset += bytesRead;</span>
<a href="#l32.1366"></a><span id="l32.1366" class="difflineminus">-  }</span>
<a href="#l32.1367"></a><span id="l32.1367" class="difflineminus">-</span>
<a href="#l32.1368"></a><span id="l32.1368" class="difflineminus">-  return NS_OK;</span>
<a href="#l32.1369"></a><span id="l32.1369" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1">deleted file mode 100644</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineminus">--- a/mailnews/import/eudora/src/nsEudoraMailbox.h</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineplus">+++ /dev/null</span>
<a href="#l33.4"></a><span id="l33.4" class="difflineat">@@ -1,201 +0,0 @@</span>
<a href="#l33.5"></a><span id="l33.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-</span>
<a href="#l33.6"></a><span id="l33.6" class="difflineminus">- *</span>
<a href="#l33.7"></a><span id="l33.7" class="difflineminus">- * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l33.8"></a><span id="l33.8" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l33.9"></a><span id="l33.9" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l33.10"></a><span id="l33.10" class="difflineminus">-</span>
<a href="#l33.11"></a><span id="l33.11" class="difflineminus">-#ifndef nsEudoraMailbox_h__</span>
<a href="#l33.12"></a><span id="l33.12" class="difflineminus">-#define nsEudoraMailbox_h__</span>
<a href="#l33.13"></a><span id="l33.13" class="difflineminus">-</span>
<a href="#l33.14"></a><span id="l33.14" class="difflineminus">-#include &quot;nscore.h&quot;</span>
<a href="#l33.15"></a><span id="l33.15" class="difflineminus">-#include &quot;nsStringGlue.h&quot;</span>
<a href="#l33.16"></a><span id="l33.16" class="difflineminus">-#include &quot;nsTArray.h&quot;</span>
<a href="#l33.17"></a><span id="l33.17" class="difflineminus">-#include &quot;nsIFile.h&quot;</span>
<a href="#l33.18"></a><span id="l33.18" class="difflineminus">-#include &quot;nsEudoraCompose.h&quot;</span>
<a href="#l33.19"></a><span id="l33.19" class="difflineminus">-</span>
<a href="#l33.20"></a><span id="l33.20" class="difflineminus">-class nsIOutputStream;</span>
<a href="#l33.21"></a><span id="l33.21" class="difflineminus">-class nsIMutableArray;</span>
<a href="#l33.22"></a><span id="l33.22" class="difflineminus">-</span>
<a href="#l33.23"></a><span id="l33.23" class="difflineminus">-/////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l33.24"></a><span id="l33.24" class="difflineminus">-/////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l33.25"></a><span id="l33.25" class="difflineminus">-/////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l33.26"></a><span id="l33.26" class="difflineminus">-</span>
<a href="#l33.27"></a><span id="l33.27" class="difflineminus">-class EudoraTOCEntry {</span>
<a href="#l33.28"></a><span id="l33.28" class="difflineminus">-public:</span>
<a href="#l33.29"></a><span id="l33.29" class="difflineminus">-  uint16_t    GetMozillaStatusFlags();</span>
<a href="#l33.30"></a><span id="l33.30" class="difflineminus">-  uint32_t    GetMozillaStatus2Flags();</span>
<a href="#l33.31"></a><span id="l33.31" class="difflineminus">-</span>
<a href="#l33.32"></a><span id="l33.32" class="difflineminus">-  int32_t      m_Offset;</span>
<a href="#l33.33"></a><span id="l33.33" class="difflineminus">-  int32_t      m_Length;</span>
<a href="#l33.34"></a><span id="l33.34" class="difflineminus">-#ifdef XP_MACOSX</span>
<a href="#l33.35"></a><span id="l33.35" class="difflineminus">-  // Mac specific flags and fields for reading message summaries</span>
<a href="#l33.36"></a><span id="l33.36" class="difflineminus">-  bool        HasEudoraLabel() { return false; }</span>
<a href="#l33.37"></a><span id="l33.37" class="difflineminus">-  int16_t      GetLabelNumber() { return 0; }</span>
<a href="#l33.38"></a><span id="l33.38" class="difflineminus">-</span>
<a href="#l33.39"></a><span id="l33.39" class="difflineminus">-#else</span>
<a href="#l33.40"></a><span id="l33.40" class="difflineminus">-  // Windows specific flags and fields for reading message summaries</span>
<a href="#l33.41"></a><span id="l33.41" class="difflineminus">-  bool        HasEudoraLabel() { return (m_Label &gt; 0) &amp;&amp; (m_Label &lt;= 7); }</span>
<a href="#l33.42"></a><span id="l33.42" class="difflineminus">-  int16_t      GetLabelNumber() { return HasEudoraLabel() ? m_Label : 0; }</span>
<a href="#l33.43"></a><span id="l33.43" class="difflineminus">-</span>
<a href="#l33.44"></a><span id="l33.44" class="difflineminus">-  // MesSummary flags (used with m_Flags)</span>
<a href="#l33.45"></a><span id="l33.45" class="difflineminus">-  static const uint16_t MSF_ALT_SIGNATURE    = 0x0001;</span>
<a href="#l33.46"></a><span id="l33.46" class="difflineminus">-  static const uint16_t MSF_USE_SIGNATURE    = 0x0002;</span>
<a href="#l33.47"></a><span id="l33.47" class="difflineminus">-  static const uint16_t MSF_WORD_WRAP      = 0x0004;</span>
<a href="#l33.48"></a><span id="l33.48" class="difflineminus">-  static const uint16_t MSF_TABS_IN_BODY    = 0x0008;</span>
<a href="#l33.49"></a><span id="l33.49" class="difflineminus">-  static const uint16_t MSF_KEEP_COPIES    = 0x0010;</span>
<a href="#l33.50"></a><span id="l33.50" class="difflineminus">-  static const uint16_t MSF_TEXT_AS_DOC    = 0x0020;</span>
<a href="#l33.51"></a><span id="l33.51" class="difflineminus">-  static const uint16_t MSF_RETURN_RECEIPT  = 0x0040;</span>
<a href="#l33.52"></a><span id="l33.52" class="difflineminus">-  static const uint16_t MSF_QUOTED_PRINTABLE  = 0x0080;</span>
<a href="#l33.53"></a><span id="l33.53" class="difflineminus">-  static const uint16_t MSF_ENCODE0      = 0x0100;</span>
<a href="#l33.54"></a><span id="l33.54" class="difflineminus">-  static const uint16_t MSF_ENCODE1      = 0x0200;</span>
<a href="#l33.55"></a><span id="l33.55" class="difflineminus">-  static const uint16_t MSF_SHOW_ALL_HEADERS  = 0x0400;</span>
<a href="#l33.56"></a><span id="l33.56" class="difflineminus">-  static const uint16_t MSF_SUB_PART      = 0x0800;</span>
<a href="#l33.57"></a><span id="l33.57" class="difflineminus">-  static const uint16_t MSF_MAPI_MESSAGE    = 0x1000;</span>
<a href="#l33.58"></a><span id="l33.58" class="difflineminus">-  static const uint16_t MSF_XRICH        = 0x2000;</span>
<a href="#l33.59"></a><span id="l33.59" class="difflineminus">-  static const uint16_t MSF_READ_RECEIPT    = 0x4000;</span>
<a href="#l33.60"></a><span id="l33.60" class="difflineminus">-  static const uint16_t MSF_HAS_ATTACHMENT  = 0x8000;</span>
<a href="#l33.61"></a><span id="l33.61" class="difflineminus">-  static const uint16_t MSF_COMP_MOD_FLAGS  = 0x8FFF;</span>
<a href="#l33.62"></a><span id="l33.62" class="difflineminus">-  static const uint16_t MSF_BINHEX      = 0;</span>
<a href="#l33.63"></a><span id="l33.63" class="difflineminus">-  static const uint16_t MSF_MIME        = MSF_ENCODE0;</span>
<a href="#l33.64"></a><span id="l33.64" class="difflineminus">-  static const uint16_t MSF_UUENCODE      = MSF_ENCODE1;</span>
<a href="#l33.65"></a><span id="l33.65" class="difflineminus">-</span>
<a href="#l33.66"></a><span id="l33.66" class="difflineminus">-  // MesSummary extended flags (used with m_FlagsEx)</span>
<a href="#l33.67"></a><span id="l33.67" class="difflineminus">-  static const uint16_t MSFEX_AUTO_ATTACHED  = 0x0001;</span>
<a href="#l33.68"></a><span id="l33.68" class="difflineminus">-  static const uint16_t MSFEX_HTML      = 0x0002;</span>
<a href="#l33.69"></a><span id="l33.69" class="difflineminus">-  static const uint16_t MSFEX_MDN        = 0x0004;</span>
<a href="#l33.70"></a><span id="l33.70" class="difflineminus">-  static const uint16_t MSFEX_MIME_ATTACHED  = 0x0008;</span>
<a href="#l33.71"></a><span id="l33.71" class="difflineminus">-  static const uint16_t MSFEX_SEND_PLAIN    = 0x0010;</span>
<a href="#l33.72"></a><span id="l33.72" class="difflineminus">-  static const uint16_t MSFEX_SEND_STYLED    = 0x0020;</span>
<a href="#l33.73"></a><span id="l33.73" class="difflineminus">-  static const uint16_t MSFEX_FLOWED      = 0x0040;</span>
<a href="#l33.74"></a><span id="l33.74" class="difflineminus">-  static const uint16_t MSFEX_INL_SIGNATURE  = 0x0080;</span>
<a href="#l33.75"></a><span id="l33.75" class="difflineminus">-  static const uint16_t MSFEX_EMPTY_BODY    = 0x0100;</span>
<a href="#l33.76"></a><span id="l33.76" class="difflineminus">-</span>
<a href="#l33.77"></a><span id="l33.77" class="difflineminus">-  // MesSummary states</span>
<a href="#l33.78"></a><span id="l33.78" class="difflineminus">-  static const int8_t MS_UNREAD    = 0;</span>
<a href="#l33.79"></a><span id="l33.79" class="difflineminus">-  static const int8_t MS_READ      = 1;</span>
<a href="#l33.80"></a><span id="l33.80" class="difflineminus">-  static const int8_t MS_REPLIED    = 2;</span>
<a href="#l33.81"></a><span id="l33.81" class="difflineminus">-  static const int8_t MS_FORWARDED  = 3;</span>
<a href="#l33.82"></a><span id="l33.82" class="difflineminus">-  static const int8_t MS_REDIRECT    = 4;</span>
<a href="#l33.83"></a><span id="l33.83" class="difflineminus">-  static const int8_t MS_UNSENDABLE  = 5;</span>
<a href="#l33.84"></a><span id="l33.84" class="difflineminus">-  static const int8_t MS_SENDABLE    = 6;</span>
<a href="#l33.85"></a><span id="l33.85" class="difflineminus">-  static const int8_t MS_QUEUED    = 7;</span>
<a href="#l33.86"></a><span id="l33.86" class="difflineminus">-  static const int8_t MS_SENT      = 8;</span>
<a href="#l33.87"></a><span id="l33.87" class="difflineminus">-  static const int8_t MS_UNSENT    = 9;</span>
<a href="#l33.88"></a><span id="l33.88" class="difflineminus">-  static const int8_t MS_TIME_QUEUED  =10;</span>
<a href="#l33.89"></a><span id="l33.89" class="difflineminus">-  static const int8_t MS_SPOOLED    =11;</span>
<a href="#l33.90"></a><span id="l33.90" class="difflineminus">-  static const int8_t MS_RECOVERED  =12;</span>
<a href="#l33.91"></a><span id="l33.91" class="difflineminus">-</span>
<a href="#l33.92"></a><span id="l33.92" class="difflineminus">-  // MesSummary priorites</span>
<a href="#l33.93"></a><span id="l33.93" class="difflineminus">-  static const int16_t MSP_HIGHEST  = 1;</span>
<a href="#l33.94"></a><span id="l33.94" class="difflineminus">-  static const int16_t MSP_HIGH    = 2;</span>
<a href="#l33.95"></a><span id="l33.95" class="difflineminus">-  static const int16_t MSP_NORMAL    = 3;</span>
<a href="#l33.96"></a><span id="l33.96" class="difflineminus">-  static const int16_t MSP_LOW    = 4;</span>
<a href="#l33.97"></a><span id="l33.97" class="difflineminus">-  static const int16_t MSP_LOWEST    = 5;</span>
<a href="#l33.98"></a><span id="l33.98" class="difflineminus">-</span>
<a href="#l33.99"></a><span id="l33.99" class="difflineminus">-  // MesSummary Mood</span>
<a href="#l33.100"></a><span id="l33.100" class="difflineminus">-  static const int8_t MSM_MOOD_UNKNOWN  = 0;</span>
<a href="#l33.101"></a><span id="l33.101" class="difflineminus">-  static const int8_t MSM_MOOD_CLEAN    = 1;</span>
<a href="#l33.102"></a><span id="l33.102" class="difflineminus">-  static const int8_t MSM_MOOD_LOW    = 2;</span>
<a href="#l33.103"></a><span id="l33.103" class="difflineminus">-  static const int8_t MSM_MOOD_MEDIUM    = 3;</span>
<a href="#l33.104"></a><span id="l33.104" class="difflineminus">-  static const int8_t MSM_MOOD_HIGH    = 4;</span>
<a href="#l33.105"></a><span id="l33.105" class="difflineminus">-</span>
<a href="#l33.106"></a><span id="l33.106" class="difflineminus">-  // Imap message flags :</span>
<a href="#l33.107"></a><span id="l33.107" class="difflineminus">-  static const uint32_t IMFLAGS_SEEN    = 0x00000001;</span>
<a href="#l33.108"></a><span id="l33.108" class="difflineminus">-  static const uint32_t IMFLAGS_ANSWERED  = 0x00000002;</span>
<a href="#l33.109"></a><span id="l33.109" class="difflineminus">-  static const uint32_t IMFLAGS_FLAGGED  = 0x00000004;</span>
<a href="#l33.110"></a><span id="l33.110" class="difflineminus">-  static const uint32_t IMFLAGS_DELETED  = 0x00000008;</span>
<a href="#l33.111"></a><span id="l33.111" class="difflineminus">-  static const uint32_t IMFLAGS_DRAFT    = 0x00000010;</span>
<a href="#l33.112"></a><span id="l33.112" class="difflineminus">-  static const uint32_t IMFLAGS_RECENT  = 0x00000020;</span>
<a href="#l33.113"></a><span id="l33.113" class="difflineminus">-</span>
<a href="#l33.114"></a><span id="l33.114" class="difflineminus">-  uint16_t    m_Flags;</span>
<a href="#l33.115"></a><span id="l33.115" class="difflineminus">-  uint16_t    m_FlagsEx;</span>
<a href="#l33.116"></a><span id="l33.116" class="difflineminus">-  uint32_t    m_Hash;</span>
<a href="#l33.117"></a><span id="l33.117" class="difflineminus">-  uint32_t    m_UniqueMessageId;</span>
<a href="#l33.118"></a><span id="l33.118" class="difflineminus">-  uint32_t    m_PersonaHash;</span>
<a href="#l33.119"></a><span id="l33.119" class="difflineminus">-  int16_t      m_State;</span>
<a href="#l33.120"></a><span id="l33.120" class="difflineminus">-  uint8_t      m_ucJunkScore;</span>
<a href="#l33.121"></a><span id="l33.121" class="difflineminus">-  bool        m_bManuallyJunked;</span>
<a href="#l33.122"></a><span id="l33.122" class="difflineminus">-  int8_t      m_Priority;</span>
<a href="#l33.123"></a><span id="l33.123" class="difflineminus">-  int8_t      m_nMood;</span>
<a href="#l33.124"></a><span id="l33.124" class="difflineminus">-  int16_t      m_Label;</span>
<a href="#l33.125"></a><span id="l33.125" class="difflineminus">-  int32_t      m_Seconds;</span>
<a href="#l33.126"></a><span id="l33.126" class="difflineminus">-  int32_t      m_lArrivalSeconds;</span>
<a href="#l33.127"></a><span id="l33.127" class="difflineminus">-  int32_t      m_TimeZoneMinutes;</span>
<a href="#l33.128"></a><span id="l33.128" class="difflineminus">-  char      m_Date[28];</span>
<a href="#l33.129"></a><span id="l33.129" class="difflineminus">-  char      m_From[64];</span>
<a href="#l33.130"></a><span id="l33.130" class="difflineminus">-  char      m_Subject[64];</span>
<a href="#l33.131"></a><span id="l33.131" class="difflineminus">-</span>
<a href="#l33.132"></a><span id="l33.132" class="difflineminus">-  // IMAP specific attributes</span>
<a href="#l33.133"></a><span id="l33.133" class="difflineminus">-  uint32_t    m_Imflags;    // IMAP message flags - 4 bytes.</span>
<a href="#l33.134"></a><span id="l33.134" class="difflineminus">-  uint16_t    m_MsgSize;</span>
<a href="#l33.135"></a><span id="l33.135" class="difflineminus">-  int32_t      m_nUndownloadedAttachments;  // Number of undownloaded attachments.</span>
<a href="#l33.136"></a><span id="l33.136" class="difflineminus">-#endif</span>
<a href="#l33.137"></a><span id="l33.137" class="difflineminus">-};</span>
<a href="#l33.138"></a><span id="l33.138" class="difflineminus">-</span>
<a href="#l33.139"></a><span id="l33.139" class="difflineminus">-class nsEudoraMailbox {</span>
<a href="#l33.140"></a><span id="l33.140" class="difflineminus">-public:</span>
<a href="#l33.141"></a><span id="l33.141" class="difflineminus">-  nsEudoraMailbox();</span>
<a href="#l33.142"></a><span id="l33.142" class="difflineminus">-  virtual ~nsEudoraMailbox();</span>
<a href="#l33.143"></a><span id="l33.143" class="difflineminus">-</span>
<a href="#l33.144"></a><span id="l33.144" class="difflineminus">-  // Things that must be overridden because they are platform specific.</span>
<a href="#l33.145"></a><span id="l33.145" class="difflineminus">-    // retrieve the mail folder</span>
<a href="#l33.146"></a><span id="l33.146" class="difflineminus">-  virtual bool      FindMailFolder(nsIFile **pFolder) { return false;}</span>
<a href="#l33.147"></a><span id="l33.147" class="difflineminus">-    // get the list of mailboxes</span>
<a href="#l33.148"></a><span id="l33.148" class="difflineminus">-  virtual nsresult  FindMailboxes(nsIFile *pRoot, nsIMutableArray *pArray) { return NS_ERROR_FAILURE;}</span>
<a href="#l33.149"></a><span id="l33.149" class="difflineminus">-    // get the toc file corresponding to this mailbox</span>
<a href="#l33.150"></a><span id="l33.150" class="difflineminus">-  virtual nsresult  FindTOCFile(nsIFile *pMailFile, nsIFile **pTOCFile, bool *pDeleteToc) { return NS_ERROR_FAILURE;}</span>
<a href="#l33.151"></a><span id="l33.151" class="difflineminus">-    // interpret the attachment line and return the attached file</span>
<a href="#l33.152"></a><span id="l33.152" class="difflineminus">-  virtual nsresult  GetAttachmentInfo(const char *pFileName, nsIFile *pFile, nsCString&amp; mimeType, nsCString&amp; aAttachment) { return NS_ERROR_FAILURE;}</span>
<a href="#l33.153"></a><span id="l33.153" class="difflineminus">-</span>
<a href="#l33.154"></a><span id="l33.154" class="difflineminus">-  // Non-platform specific common stuff</span>
<a href="#l33.155"></a><span id="l33.155" class="difflineminus">-    // import a mailbox</span>
<a href="#l33.156"></a><span id="l33.156" class="difflineminus">-  nsresult ImportMailbox(uint32_t *pBytes, bool *pAbort, const char16_t *pName,</span>
<a href="#l33.157"></a><span id="l33.157" class="difflineminus">-                         nsIFile *pSrc, nsIMsgFolder *pDst, int32_t *pMsgCount);</span>
<a href="#l33.158"></a><span id="l33.158" class="difflineminus">- </span>
<a href="#l33.159"></a><span id="l33.159" class="difflineminus">-</span>
<a href="#l33.160"></a><span id="l33.160" class="difflineminus">-  static int32_t    IsEudoraFromSeparator(const char *pData, int32_t maxLen, nsCString&amp; defaultDate);</span>
<a href="#l33.161"></a><span id="l33.161" class="difflineminus">-  static bool      IsEudoraTag(const char *pChar, int32_t maxLen, bool &amp;insideEudoraTags, nsCString &amp;bodyType, int32_t&amp; tagLength);</span>
<a href="#l33.162"></a><span id="l33.162" class="difflineminus">-</span>
<a href="#l33.163"></a><span id="l33.163" class="difflineminus">-protected:</span>
<a href="#l33.164"></a><span id="l33.164" class="difflineminus">-  nsresult  CreateTempFile(nsIFile **ppFile);</span>
<a href="#l33.165"></a><span id="l33.165" class="difflineminus">-  nsresult  DeleteFile(nsIFile *pFile);</span>
<a href="#l33.166"></a><span id="l33.166" class="difflineminus">-</span>
<a href="#l33.167"></a><span id="l33.167" class="difflineminus">-</span>
<a href="#l33.168"></a><span id="l33.168" class="difflineminus">-private:</span>
<a href="#l33.169"></a><span id="l33.169" class="difflineminus">-  nsresult ImportMailboxUsingTOC(uint32_t *pBytes, bool *pAbort,</span>
<a href="#l33.170"></a><span id="l33.170" class="difflineminus">-                                 nsIInputStream *pInputStream,</span>
<a href="#l33.171"></a><span id="l33.171" class="difflineminus">-                                 nsIFile *tocFile,</span>
<a href="#l33.172"></a><span id="l33.172" class="difflineminus">-                                 nsIMsgFolder *pDstFolder, int32_t *pMsgCount);</span>
<a href="#l33.173"></a><span id="l33.173" class="difflineminus">-</span>
<a href="#l33.174"></a><span id="l33.174" class="difflineminus">-   nsresult  ReadTOCEntry(nsIInputStream *pToc, EudoraTOCEntry&amp; tocEntry);</span>
<a href="#l33.175"></a><span id="l33.175" class="difflineminus">-   nsresult  ImportMessage(SimpleBufferTonyRCopiedOnce&amp; headers, SimpleBufferTonyRCopiedOnce&amp; body, nsCString&amp; defaultDate, nsAutoCString&amp; bodyType, nsIOutputStream *pDst, int32_t *pMsgCount);</span>
<a href="#l33.176"></a><span id="l33.176" class="difflineminus">-   nsresult  ReadNextMessage(ReadFileState *pState, SimpleBufferTonyRCopiedOnce&amp; copy, SimpleBufferTonyRCopiedOnce&amp; header,</span>
<a href="#l33.177"></a><span id="l33.177" class="difflineminus">-                                        SimpleBufferTonyRCopiedOnce&amp; body, nsCString&amp; defaultDate,</span>
<a href="#l33.178"></a><span id="l33.178" class="difflineminus">-                                        nsCString &amp;defBodyType, EudoraTOCEntry *pTocEntry);</span>
<a href="#l33.179"></a><span id="l33.179" class="difflineminus">-  int32_t    FindStartLine(SimpleBufferTonyRCopiedOnce&amp; data);</span>
<a href="#l33.180"></a><span id="l33.180" class="difflineminus">-  int32_t    FindNextEndLine(SimpleBufferTonyRCopiedOnce&amp; data);</span>
<a href="#l33.181"></a><span id="l33.181" class="difflineminus">-  int32_t    IsEndHeaders(SimpleBufferTonyRCopiedOnce&amp; data);</span>
<a href="#l33.182"></a><span id="l33.182" class="difflineminus">-  nsresult  WriteFromSep(nsIOutputStream *pDst);</span>
<a href="#l33.183"></a><span id="l33.183" class="difflineminus">-  nsresult  FillMailBuffer(ReadFileState *pState, SimpleBufferTonyRCopiedOnce&amp; read);</span>
<a href="#l33.184"></a><span id="l33.184" class="difflineminus">-</span>
<a href="#l33.185"></a><span id="l33.185" class="difflineminus">-  void    EmptyAttachments(void);</span>
<a href="#l33.186"></a><span id="l33.186" class="difflineminus">-  nsresult  ExamineAttachment(SimpleBufferTonyRCopiedOnce&amp; data);</span>
<a href="#l33.187"></a><span id="l33.187" class="difflineminus">-  bool      AddAttachment(nsCString&amp; fileName);</span>
<a href="#l33.188"></a><span id="l33.188" class="difflineminus">-</span>
<a href="#l33.189"></a><span id="l33.189" class="difflineminus">-  static int32_t    AsciiToLong(const char *pChar, int32_t len);</span>
<a href="#l33.190"></a><span id="l33.190" class="difflineminus">-  static int      IsWeekDayStr(const char *pStr);</span>
<a href="#l33.191"></a><span id="l33.191" class="difflineminus">-  static int      IsMonthStr(const char *pStr);</span>
<a href="#l33.192"></a><span id="l33.192" class="difflineminus">-</span>
<a href="#l33.193"></a><span id="l33.193" class="difflineminus">-protected:</span>
<a href="#l33.194"></a><span id="l33.194" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt;    m_mailImportLocation;</span>
<a href="#l33.195"></a><span id="l33.195" class="difflineminus">-</span>
<a href="#l33.196"></a><span id="l33.196" class="difflineminus">-private:</span>
<a href="#l33.197"></a><span id="l33.197" class="difflineminus">-  int64_t    m_mailSize;</span>
<a href="#l33.198"></a><span id="l33.198" class="difflineminus">-  uint32_t      m_fromLen;</span>
<a href="#l33.199"></a><span id="l33.199" class="difflineminus">-  nsTArray&lt;ImportAttachment*&gt;  m_attachments;</span>
<a href="#l33.200"></a><span id="l33.200" class="difflineminus">-};</span>
<a href="#l33.201"></a><span id="l33.201" class="difflineminus">-</span>
<a href="#l33.202"></a><span id="l33.202" class="difflineminus">-</span>
<a href="#l33.203"></a><span id="l33.203" class="difflineminus">-</span>
<a href="#l33.204"></a><span id="l33.204" class="difflineminus">-#endif /* nsEudoraMailbox_h__ */</span>
<a href="#l33.205"></a><span id="l33.205" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1">deleted file mode 100644</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineminus">--- a/mailnews/import/eudora/src/nsEudoraSettings.cpp</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineplus">+++ /dev/null</span>
<a href="#l34.4"></a><span id="l34.4" class="difflineat">@@ -1,124 +0,0 @@</span>
<a href="#l34.5"></a><span id="l34.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-</span>
<a href="#l34.6"></a><span id="l34.6" class="difflineminus">- *</span>
<a href="#l34.7"></a><span id="l34.7" class="difflineminus">- * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l34.8"></a><span id="l34.8" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l34.9"></a><span id="l34.9" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l34.10"></a><span id="l34.10" class="difflineminus">-</span>
<a href="#l34.11"></a><span id="l34.11" class="difflineminus">-/*</span>
<a href="#l34.12"></a><span id="l34.12" class="difflineminus">-  Eudora settings</span>
<a href="#l34.13"></a><span id="l34.13" class="difflineminus">-*/</span>
<a href="#l34.14"></a><span id="l34.14" class="difflineminus">-</span>
<a href="#l34.15"></a><span id="l34.15" class="difflineminus">-#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l34.16"></a><span id="l34.16" class="difflineminus">-#include &quot;nscore.h&quot;</span>
<a href="#l34.17"></a><span id="l34.17" class="difflineminus">-#include &quot;nsEudoraSettings.h&quot;</span>
<a href="#l34.18"></a><span id="l34.18" class="difflineminus">-#include &quot;nsEudoraStringBundle.h&quot;</span>
<a href="#l34.19"></a><span id="l34.19" class="difflineminus">-#include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l34.20"></a><span id="l34.20" class="difflineminus">-#include &quot;EudoraDebugLog.h&quot;</span>
<a href="#l34.21"></a><span id="l34.21" class="difflineminus">-</span>
<a href="#l34.22"></a><span id="l34.22" class="difflineminus">-#if defined(XP_WIN)</span>
<a href="#l34.23"></a><span id="l34.23" class="difflineminus">-#include &quot;nsEudoraWin32.h&quot;</span>
<a href="#l34.24"></a><span id="l34.24" class="difflineminus">-#endif</span>
<a href="#l34.25"></a><span id="l34.25" class="difflineminus">-#ifdef XP_MACOSX</span>
<a href="#l34.26"></a><span id="l34.26" class="difflineminus">-#include &quot;nsEudoraMac.h&quot;</span>
<a href="#l34.27"></a><span id="l34.27" class="difflineminus">-#endif</span>
<a href="#l34.28"></a><span id="l34.28" class="difflineminus">-</span>
<a href="#l34.29"></a><span id="l34.29" class="difflineminus">-</span>
<a href="#l34.30"></a><span id="l34.30" class="difflineminus">-////////////////////////////////////////////////////////////////////////</span>
<a href="#l34.31"></a><span id="l34.31" class="difflineminus">-nsresult nsEudoraSettings::Create(nsIImportSettings** aImport)</span>
<a href="#l34.32"></a><span id="l34.32" class="difflineminus">-{</span>
<a href="#l34.33"></a><span id="l34.33" class="difflineminus">-    NS_PRECONDITION(aImport != nullptr, &quot;null ptr&quot;);</span>
<a href="#l34.34"></a><span id="l34.34" class="difflineminus">-    if (! aImport)</span>
<a href="#l34.35"></a><span id="l34.35" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l34.36"></a><span id="l34.36" class="difflineminus">-</span>
<a href="#l34.37"></a><span id="l34.37" class="difflineminus">-    *aImport = new nsEudoraSettings();</span>
<a href="#l34.38"></a><span id="l34.38" class="difflineminus">-    if (! *aImport)</span>
<a href="#l34.39"></a><span id="l34.39" class="difflineminus">-        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l34.40"></a><span id="l34.40" class="difflineminus">-</span>
<a href="#l34.41"></a><span id="l34.41" class="difflineminus">-    NS_ADDREF(*aImport);</span>
<a href="#l34.42"></a><span id="l34.42" class="difflineminus">-    return NS_OK;</span>
<a href="#l34.43"></a><span id="l34.43" class="difflineminus">-}</span>
<a href="#l34.44"></a><span id="l34.44" class="difflineminus">-</span>
<a href="#l34.45"></a><span id="l34.45" class="difflineminus">-nsEudoraSettings::nsEudoraSettings()</span>
<a href="#l34.46"></a><span id="l34.46" class="difflineminus">-{</span>
<a href="#l34.47"></a><span id="l34.47" class="difflineminus">-}</span>
<a href="#l34.48"></a><span id="l34.48" class="difflineminus">-</span>
<a href="#l34.49"></a><span id="l34.49" class="difflineminus">-nsEudoraSettings::~nsEudoraSettings()</span>
<a href="#l34.50"></a><span id="l34.50" class="difflineminus">-{</span>
<a href="#l34.51"></a><span id="l34.51" class="difflineminus">-}</span>
<a href="#l34.52"></a><span id="l34.52" class="difflineminus">-</span>
<a href="#l34.53"></a><span id="l34.53" class="difflineminus">-NS_IMPL_ISUPPORTS(nsEudoraSettings, nsIImportSettings)</span>
<a href="#l34.54"></a><span id="l34.54" class="difflineminus">-</span>
<a href="#l34.55"></a><span id="l34.55" class="difflineminus">-NS_IMETHODIMP nsEudoraSettings::AutoLocate(char16_t **description, nsIFile **location, bool *_retval)</span>
<a href="#l34.56"></a><span id="l34.56" class="difflineminus">-{</span>
<a href="#l34.57"></a><span id="l34.57" class="difflineminus">-    NS_PRECONDITION(description != nullptr, &quot;null ptr&quot;);</span>
<a href="#l34.58"></a><span id="l34.58" class="difflineminus">-    NS_PRECONDITION(_retval != nullptr, &quot;null ptr&quot;);</span>
<a href="#l34.59"></a><span id="l34.59" class="difflineminus">-    NS_PRECONDITION(location != nullptr, &quot;null ptr&quot;);</span>
<a href="#l34.60"></a><span id="l34.60" class="difflineminus">-  if (!description || !_retval || !location)</span>
<a href="#l34.61"></a><span id="l34.61" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l34.62"></a><span id="l34.62" class="difflineminus">-</span>
<a href="#l34.63"></a><span id="l34.63" class="difflineminus">-  *description = nullptr;</span>
<a href="#l34.64"></a><span id="l34.64" class="difflineminus">-  *_retval = false;</span>
<a href="#l34.65"></a><span id="l34.65" class="difflineminus">-</span>
<a href="#l34.66"></a><span id="l34.66" class="difflineminus">-  nsresult  rv;</span>
<a href="#l34.67"></a><span id="l34.67" class="difflineminus">-        m_pLocation =  do_CreateInstance (NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l34.68"></a><span id="l34.68" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.69"></a><span id="l34.69" class="difflineminus">-  *description = nsEudoraStringBundle::GetStringByID(EUDORAIMPORT_NAME);</span>
<a href="#l34.70"></a><span id="l34.70" class="difflineminus">-</span>
<a href="#l34.71"></a><span id="l34.71" class="difflineminus">-#if defined(XP_WIN)</span>
<a href="#l34.72"></a><span id="l34.72" class="difflineminus">-  *_retval = nsEudoraWin32::FindSettingsFile(getter_AddRefs(m_pLocation));</span>
<a href="#l34.73"></a><span id="l34.73" class="difflineminus">-#endif</span>
<a href="#l34.74"></a><span id="l34.74" class="difflineminus">-</span>
<a href="#l34.75"></a><span id="l34.75" class="difflineminus">-  NS_IF_ADDREF(*location = m_pLocation);</span>
<a href="#l34.76"></a><span id="l34.76" class="difflineminus">-  return NS_OK;</span>
<a href="#l34.77"></a><span id="l34.77" class="difflineminus">-}</span>
<a href="#l34.78"></a><span id="l34.78" class="difflineminus">-</span>
<a href="#l34.79"></a><span id="l34.79" class="difflineminus">-NS_IMETHODIMP nsEudoraSettings::SetLocation(nsIFile *location)</span>
<a href="#l34.80"></a><span id="l34.80" class="difflineminus">-{</span>
<a href="#l34.81"></a><span id="l34.81" class="difflineminus">-  m_pLocation = location;</span>
<a href="#l34.82"></a><span id="l34.82" class="difflineminus">-  return NS_OK;</span>
<a href="#l34.83"></a><span id="l34.83" class="difflineminus">-}</span>
<a href="#l34.84"></a><span id="l34.84" class="difflineminus">-</span>
<a href="#l34.85"></a><span id="l34.85" class="difflineminus">-NS_IMETHODIMP nsEudoraSettings::Import(nsIMsgAccount **localMailAccount, bool *_retval)</span>
<a href="#l34.86"></a><span id="l34.86" class="difflineminus">-{</span>
<a href="#l34.87"></a><span id="l34.87" class="difflineminus">-  NS_PRECONDITION(_retval != nullptr, &quot;null ptr&quot;);</span>
<a href="#l34.88"></a><span id="l34.88" class="difflineminus">-</span>
<a href="#l34.89"></a><span id="l34.89" class="difflineminus">-  *_retval = false;</span>
<a href="#l34.90"></a><span id="l34.90" class="difflineminus">-</span>
<a href="#l34.91"></a><span id="l34.91" class="difflineminus">-  // Get the settings file if it doesn't exist</span>
<a href="#l34.92"></a><span id="l34.92" class="difflineminus">-  if (!m_pLocation) {</span>
<a href="#l34.93"></a><span id="l34.93" class="difflineminus">-#if defined(XP_WIN)</span>
<a href="#l34.94"></a><span id="l34.94" class="difflineminus">-    nsresult  rv;</span>
<a href="#l34.95"></a><span id="l34.95" class="difflineminus">-                m_pLocation =  do_CreateInstance (NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l34.96"></a><span id="l34.96" class="difflineminus">-    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l34.97"></a><span id="l34.97" class="difflineminus">-      if (!nsEudoraWin32::FindSettingsFile(getter_AddRefs(m_pLocation))) {</span>
<a href="#l34.98"></a><span id="l34.98" class="difflineminus">-        m_pLocation = nullptr;</span>
<a href="#l34.99"></a><span id="l34.99" class="difflineminus">-      }</span>
<a href="#l34.100"></a><span id="l34.100" class="difflineminus">-    }</span>
<a href="#l34.101"></a><span id="l34.101" class="difflineminus">-#endif</span>
<a href="#l34.102"></a><span id="l34.102" class="difflineminus">-#ifdef XP_MACOSX</span>
<a href="#l34.103"></a><span id="l34.103" class="difflineminus">-                nsEudoraMac::FindSettingsFile(getter_AddRefs(m_pLocation));</span>
<a href="#l34.104"></a><span id="l34.104" class="difflineminus">-#endif</span>
<a href="#l34.105"></a><span id="l34.105" class="difflineminus">-  }</span>
<a href="#l34.106"></a><span id="l34.106" class="difflineminus">-</span>
<a href="#l34.107"></a><span id="l34.107" class="difflineminus">-  if (!m_pLocation) {</span>
<a href="#l34.108"></a><span id="l34.108" class="difflineminus">-    IMPORT_LOG0(&quot;*** Error, unable to locate settings file for import.\n&quot;);</span>
<a href="#l34.109"></a><span id="l34.109" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l34.110"></a><span id="l34.110" class="difflineminus">-  }</span>
<a href="#l34.111"></a><span id="l34.111" class="difflineminus">-</span>
<a href="#l34.112"></a><span id="l34.112" class="difflineminus">-  // do the settings import</span>
<a href="#l34.113"></a><span id="l34.113" class="difflineminus">-#if defined(XP_WIN)</span>
<a href="#l34.114"></a><span id="l34.114" class="difflineminus">-  *_retval = nsEudoraWin32::ImportSettings(m_pLocation, localMailAccount);</span>
<a href="#l34.115"></a><span id="l34.115" class="difflineminus">-#endif</span>
<a href="#l34.116"></a><span id="l34.116" class="difflineminus">-#ifdef XP_MACOSX</span>
<a href="#l34.117"></a><span id="l34.117" class="difflineminus">-  *_retval = nsEudoraMac::ImportSettings(m_pLocation, localMailAccount);</span>
<a href="#l34.118"></a><span id="l34.118" class="difflineminus">-#endif</span>
<a href="#l34.119"></a><span id="l34.119" class="difflineminus">-</span>
<a href="#l34.120"></a><span id="l34.120" class="difflineminus">-  if (*_retval) {</span>
<a href="#l34.121"></a><span id="l34.121" class="difflineminus">-    IMPORT_LOG0(&quot;Successful import of eudora settings\n&quot;);</span>
<a href="#l34.122"></a><span id="l34.122" class="difflineminus">-  }</span>
<a href="#l34.123"></a><span id="l34.123" class="difflineminus">-  else {</span>
<a href="#l34.124"></a><span id="l34.124" class="difflineminus">-    IMPORT_LOG0(&quot;*** Error, Unsuccessful import of eudora settings\n&quot;);</span>
<a href="#l34.125"></a><span id="l34.125" class="difflineminus">-  }</span>
<a href="#l34.126"></a><span id="l34.126" class="difflineminus">-</span>
<a href="#l34.127"></a><span id="l34.127" class="difflineminus">-  return NS_OK;</span>
<a href="#l34.128"></a><span id="l34.128" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1">deleted file mode 100644</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineminus">--- a/mailnews/import/eudora/src/nsEudoraSettings.h</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineplus">+++ /dev/null</span>
<a href="#l35.4"></a><span id="l35.4" class="difflineat">@@ -1,31 +0,0 @@</span>
<a href="#l35.5"></a><span id="l35.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l35.6"></a><span id="l35.6" class="difflineminus">- *</span>
<a href="#l35.7"></a><span id="l35.7" class="difflineminus">- * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l35.8"></a><span id="l35.8" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l35.9"></a><span id="l35.9" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l35.10"></a><span id="l35.10" class="difflineminus">-</span>
<a href="#l35.11"></a><span id="l35.11" class="difflineminus">-#ifndef nsEudoraSettings_h___</span>
<a href="#l35.12"></a><span id="l35.12" class="difflineminus">-#define nsEudoraSettings_h___</span>
<a href="#l35.13"></a><span id="l35.13" class="difflineminus">-</span>
<a href="#l35.14"></a><span id="l35.14" class="difflineminus">-#include &quot;nsIImportSettings.h&quot;</span>
<a href="#l35.15"></a><span id="l35.15" class="difflineminus">-#include &quot;nsIFile.h&quot;</span>
<a href="#l35.16"></a><span id="l35.16" class="difflineminus">-#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l35.17"></a><span id="l35.17" class="difflineminus">-</span>
<a href="#l35.18"></a><span id="l35.18" class="difflineminus">-class nsEudoraSettings : public nsIImportSettings {</span>
<a href="#l35.19"></a><span id="l35.19" class="difflineminus">-public:</span>
<a href="#l35.20"></a><span id="l35.20" class="difflineminus">-    nsEudoraSettings();</span>
<a href="#l35.21"></a><span id="l35.21" class="difflineminus">-</span>
<a href="#l35.22"></a><span id="l35.22" class="difflineminus">-  static nsresult Create(nsIImportSettings** aImport);</span>
<a href="#l35.23"></a><span id="l35.23" class="difflineminus">-</span>
<a href="#l35.24"></a><span id="l35.24" class="difflineminus">-    // nsISupports interface</span>
<a href="#l35.25"></a><span id="l35.25" class="difflineminus">-    NS_DECL_ISUPPORTS</span>
<a href="#l35.26"></a><span id="l35.26" class="difflineminus">-</span>
<a href="#l35.27"></a><span id="l35.27" class="difflineminus">-  // nsIImportSettings interface</span>
<a href="#l35.28"></a><span id="l35.28" class="difflineminus">-  NS_DECL_NSIIMPORTSETTINGS</span>
<a href="#l35.29"></a><span id="l35.29" class="difflineminus">-</span>
<a href="#l35.30"></a><span id="l35.30" class="difflineminus">-private:</span>
<a href="#l35.31"></a><span id="l35.31" class="difflineminus">-  virtual ~nsEudoraSettings();</span>
<a href="#l35.32"></a><span id="l35.32" class="difflineminus">-  nsCOMPtr&lt;nsIFile&gt; m_pLocation;</span>
<a href="#l35.33"></a><span id="l35.33" class="difflineminus">-};</span>
<a href="#l35.34"></a><span id="l35.34" class="difflineminus">-</span>
<a href="#l35.35"></a><span id="l35.35" class="difflineminus">-#endif /* nsEudoraSettings_h___ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1">deleted file mode 100644</span>
<a href="#l36.2"></a><span id="l36.2" class="difflineminus">--- a/mailnews/import/eudora/src/nsEudoraStringBundle.cpp</span>
<a href="#l36.3"></a><span id="l36.3" class="difflineplus">+++ /dev/null</span>
<a href="#l36.4"></a><span id="l36.4" class="difflineat">@@ -1,90 +0,0 @@</span>
<a href="#l36.5"></a><span id="l36.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l36.6"></a><span id="l36.6" class="difflineminus">- *</span>
<a href="#l36.7"></a><span id="l36.7" class="difflineminus">- * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l36.8"></a><span id="l36.8" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l36.9"></a><span id="l36.9" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l36.10"></a><span id="l36.10" class="difflineminus">-</span>
<a href="#l36.11"></a><span id="l36.11" class="difflineminus">-#include &quot;prprf.h&quot;</span>
<a href="#l36.12"></a><span id="l36.12" class="difflineminus">-#include &quot;prmem.h&quot;</span>
<a href="#l36.13"></a><span id="l36.13" class="difflineminus">-#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l36.14"></a><span id="l36.14" class="difflineminus">-#include &quot;nsIStringBundle.h&quot;</span>
<a href="#l36.15"></a><span id="l36.15" class="difflineminus">-#include &quot;nsEudoraStringBundle.h&quot;</span>
<a href="#l36.16"></a><span id="l36.16" class="difflineminus">-#include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l36.17"></a><span id="l36.17" class="difflineminus">-#include &quot;nsIURI.h&quot;</span>
<a href="#l36.18"></a><span id="l36.18" class="difflineminus">-#include &quot;nsTextFormatter.h&quot;</span>
<a href="#l36.19"></a><span id="l36.19" class="difflineminus">-#include &quot;mozilla/Services.h&quot;</span>
<a href="#l36.20"></a><span id="l36.20" class="difflineminus">-</span>
<a href="#l36.21"></a><span id="l36.21" class="difflineminus">-#define EUDORA_MSGS_URL       &quot;chrome://messenger/locale/eudoraImportMsgs.properties&quot;</span>
<a href="#l36.22"></a><span id="l36.22" class="difflineminus">-</span>
<a href="#l36.23"></a><span id="l36.23" class="difflineminus">-nsIStringBundle *  nsEudoraStringBundle::m_pBundle = nullptr;</span>
<a href="#l36.24"></a><span id="l36.24" class="difflineminus">-</span>
<a href="#l36.25"></a><span id="l36.25" class="difflineminus">-nsIStringBundle *nsEudoraStringBundle::GetStringBundle(void)</span>
<a href="#l36.26"></a><span id="l36.26" class="difflineminus">-{</span>
<a href="#l36.27"></a><span id="l36.27" class="difflineminus">-  if (m_pBundle)</span>
<a href="#l36.28"></a><span id="l36.28" class="difflineminus">-    return m_pBundle;</span>
<a href="#l36.29"></a><span id="l36.29" class="difflineminus">-</span>
<a href="#l36.30"></a><span id="l36.30" class="difflineminus">-  const char*       propertyURL = EUDORA_MSGS_URL;</span>
<a href="#l36.31"></a><span id="l36.31" class="difflineminus">-  nsIStringBundle*  sBundle = nullptr;</span>
<a href="#l36.32"></a><span id="l36.32" class="difflineminus">-</span>
<a href="#l36.33"></a><span id="l36.33" class="difflineminus">-  nsCOMPtr&lt;nsIStringBundleService&gt; sBundleService =</span>
<a href="#l36.34"></a><span id="l36.34" class="difflineminus">-    mozilla::services::GetStringBundleService();</span>
<a href="#l36.35"></a><span id="l36.35" class="difflineminus">-  if (sBundleService)</span>
<a href="#l36.36"></a><span id="l36.36" class="difflineminus">-    sBundleService-&gt;CreateBundle(propertyURL, &amp;sBundle);</span>
<a href="#l36.37"></a><span id="l36.37" class="difflineminus">-</span>
<a href="#l36.38"></a><span id="l36.38" class="difflineminus">-  m_pBundle = sBundle;</span>
<a href="#l36.39"></a><span id="l36.39" class="difflineminus">-  return sBundle;</span>
<a href="#l36.40"></a><span id="l36.40" class="difflineminus">-}</span>
<a href="#l36.41"></a><span id="l36.41" class="difflineminus">-</span>
<a href="#l36.42"></a><span id="l36.42" class="difflineminus">-void nsEudoraStringBundle::GetStringByID(int32_t stringID, nsString&amp; result)</span>
<a href="#l36.43"></a><span id="l36.43" class="difflineminus">-{</span>
<a href="#l36.44"></a><span id="l36.44" class="difflineminus">-</span>
<a href="#l36.45"></a><span id="l36.45" class="difflineminus">-  char16_t *ptrv = GetStringByID(stringID);</span>
<a href="#l36.46"></a><span id="l36.46" class="difflineminus">-  result = ptrv;</span>
<a href="#l36.47"></a><span id="l36.47" class="difflineminus">-  FreeString(ptrv);</span>
<a href="#l36.48"></a><span id="l36.48" class="difflineminus">-}</span>
<a href="#l36.49"></a><span id="l36.49" class="difflineminus">-</span>
<a href="#l36.50"></a><span id="l36.50" class="difflineminus">-char16_t *nsEudoraStringBundle::GetStringByID(int32_t stringID)</span>
<a href="#l36.51"></a><span id="l36.51" class="difflineminus">-{</span>
<a href="#l36.52"></a><span id="l36.52" class="difflineminus">-  if (!m_pBundle)</span>
<a href="#l36.53"></a><span id="l36.53" class="difflineminus">-    m_pBundle = GetStringBundle();</span>
<a href="#l36.54"></a><span id="l36.54" class="difflineminus">-</span>
<a href="#l36.55"></a><span id="l36.55" class="difflineminus">-  if (m_pBundle)</span>
<a href="#l36.56"></a><span id="l36.56" class="difflineminus">-  {</span>
<a href="#l36.57"></a><span id="l36.57" class="difflineminus">-    char16_t *ptrv = nullptr;</span>
<a href="#l36.58"></a><span id="l36.58" class="difflineminus">-    nsresult rv = m_pBundle-&gt;GetStringFromID(stringID, &amp;ptrv);</span>
<a href="#l36.59"></a><span id="l36.59" class="difflineminus">-</span>
<a href="#l36.60"></a><span id="l36.60" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; ptrv)</span>
<a href="#l36.61"></a><span id="l36.61" class="difflineminus">-      return ptrv;</span>
<a href="#l36.62"></a><span id="l36.62" class="difflineminus">-  }</span>
<a href="#l36.63"></a><span id="l36.63" class="difflineminus">-</span>
<a href="#l36.64"></a><span id="l36.64" class="difflineminus">-  nsString resultString(NS_LITERAL_STRING(&quot;[StringID &quot;));</span>
<a href="#l36.65"></a><span id="l36.65" class="difflineminus">-  resultString.AppendInt(stringID);</span>
<a href="#l36.66"></a><span id="l36.66" class="difflineminus">-  resultString.AppendLiteral(&quot;?]&quot;);</span>
<a href="#l36.67"></a><span id="l36.67" class="difflineminus">-</span>
<a href="#l36.68"></a><span id="l36.68" class="difflineminus">-  return ToNewUnicode(resultString);</span>
<a href="#l36.69"></a><span id="l36.69" class="difflineminus">-}</span>
<a href="#l36.70"></a><span id="l36.70" class="difflineminus">-</span>
<a href="#l36.71"></a><span id="l36.71" class="difflineminus">-nsString nsEudoraStringBundle::FormatString(int32_t stringID, ...)</span>
<a href="#l36.72"></a><span id="l36.72" class="difflineminus">-{</span>
<a href="#l36.73"></a><span id="l36.73" class="difflineminus">-  // Yeah, I know.  This causes an extra string buffer allocation, but there's no guarantee</span>
<a href="#l36.74"></a><span id="l36.74" class="difflineminus">-  // that nsString's free and nsTextFormatter::smprintf_free deallocate memory the same way.</span>
<a href="#l36.75"></a><span id="l36.75" class="difflineminus">-  nsAutoString format;</span>
<a href="#l36.76"></a><span id="l36.76" class="difflineminus">-  GetStringByID(stringID, format);</span>
<a href="#l36.77"></a><span id="l36.77" class="difflineminus">-</span>
<a href="#l36.78"></a><span id="l36.78" class="difflineminus">-  va_list args;</span>
<a href="#l36.79"></a><span id="l36.79" class="difflineminus">-  va_start(args, stringID);</span>
<a href="#l36.80"></a><span id="l36.80" class="difflineminus">-</span>
<a href="#l36.81"></a><span id="l36.81" class="difflineminus">-  char16_t *pText = nsTextFormatter::vsmprintf(format.get(), args);</span>
<a href="#l36.82"></a><span id="l36.82" class="difflineminus">-  va_end(args);</span>
<a href="#l36.83"></a><span id="l36.83" class="difflineminus">-</span>
<a href="#l36.84"></a><span id="l36.84" class="difflineminus">-  nsString result(pText);</span>
<a href="#l36.85"></a><span id="l36.85" class="difflineminus">-  nsTextFormatter::smprintf_free(pText);</span>
<a href="#l36.86"></a><span id="l36.86" class="difflineminus">-  return result;</span>
<a href="#l36.87"></a><span id="l36.87" class="difflineminus">-}</span>
<a href="#l36.88"></a><span id="l36.88" class="difflineminus">-</span>
<a href="#l36.89"></a><span id="l36.89" class="difflineminus">-void nsEudoraStringBundle::Cleanup(void)</span>
<a href="#l36.90"></a><span id="l36.90" class="difflineminus">-{</span>
<a href="#l36.91"></a><span id="l36.91" class="difflineminus">-  if (m_pBundle)</span>
<a href="#l36.92"></a><span id="l36.92" class="difflineminus">-    m_pBundle-&gt;Release();</span>
<a href="#l36.93"></a><span id="l36.93" class="difflineminus">-  m_pBundle = nullptr;</span>
<a href="#l36.94"></a><span id="l36.94" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l37.1"></a><span id="l37.1">deleted file mode 100644</span>
<a href="#l37.2"></a><span id="l37.2" class="difflineminus">--- a/mailnews/import/eudora/src/nsEudoraStringBundle.h</span>
<a href="#l37.3"></a><span id="l37.3" class="difflineplus">+++ /dev/null</span>
<a href="#l37.4"></a><span id="l37.4" class="difflineat">@@ -1,57 +0,0 @@</span>
<a href="#l37.5"></a><span id="l37.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l37.6"></a><span id="l37.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l37.7"></a><span id="l37.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l37.8"></a><span id="l37.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l37.9"></a><span id="l37.9" class="difflineminus">-</span>
<a href="#l37.10"></a><span id="l37.10" class="difflineminus">-#ifndef nsEudoraStringBundle_H__</span>
<a href="#l37.11"></a><span id="l37.11" class="difflineminus">-#define nsEudoraStringBundle_H__</span>
<a href="#l37.12"></a><span id="l37.12" class="difflineminus">-</span>
<a href="#l37.13"></a><span id="l37.13" class="difflineminus">-#include &quot;nsStringGlue.h&quot;</span>
<a href="#l37.14"></a><span id="l37.14" class="difflineminus">-</span>
<a href="#l37.15"></a><span id="l37.15" class="difflineminus">-class nsIStringBundle;</span>
<a href="#l37.16"></a><span id="l37.16" class="difflineminus">-</span>
<a href="#l37.17"></a><span id="l37.17" class="difflineminus">-class nsEudoraStringBundle {</span>
<a href="#l37.18"></a><span id="l37.18" class="difflineminus">-public:</span>
<a href="#l37.19"></a><span id="l37.19" class="difflineminus">-  static char16_t       *  GetStringByID(int32_t stringID);</span>
<a href="#l37.20"></a><span id="l37.20" class="difflineminus">-  static void               GetStringByID(int32_t stringID, nsString&amp; result);</span>
<a href="#l37.21"></a><span id="l37.21" class="difflineminus">-  static nsString           FormatString(int32_t stringID, ...);</span>
<a href="#l37.22"></a><span id="l37.22" class="difflineminus">-  static nsIStringBundle *  GetStringBundle(void); // don't release</span>
<a href="#l37.23"></a><span id="l37.23" class="difflineminus">-  static void               FreeString(char16_t *pStr) { NS_Free(pStr);}</span>
<a href="#l37.24"></a><span id="l37.24" class="difflineminus">-  static void               Cleanup(void);</span>
<a href="#l37.25"></a><span id="l37.25" class="difflineminus">-</span>
<a href="#l37.26"></a><span id="l37.26" class="difflineminus">-private:</span>
<a href="#l37.27"></a><span id="l37.27" class="difflineminus">-  static nsIStringBundle *  m_pBundle;</span>
<a href="#l37.28"></a><span id="l37.28" class="difflineminus">-};</span>
<a href="#l37.29"></a><span id="l37.29" class="difflineminus">-</span>
<a href="#l37.30"></a><span id="l37.30" class="difflineminus">-</span>
<a href="#l37.31"></a><span id="l37.31" class="difflineminus">-</span>
<a href="#l37.32"></a><span id="l37.32" class="difflineminus">-#define EUDORAIMPORT_NAME                               2000</span>
<a href="#l37.33"></a><span id="l37.33" class="difflineminus">-#define EUDORAIMPORT_DESCRIPTION                        2029</span>
<a href="#l37.34"></a><span id="l37.34" class="difflineminus">-#define EUDORAIMPORT_MAILBOX_SUCCESS                    2002</span>
<a href="#l37.35"></a><span id="l37.35" class="difflineminus">-#define EUDORAIMPORT_MAILBOX_BADPARAM                   2003</span>
<a href="#l37.36"></a><span id="l37.36" class="difflineminus">-#define EUDORAIMPORT_MAILBOX_BADSOURCEFILE              2004</span>
<a href="#l37.37"></a><span id="l37.37" class="difflineminus">-#define EUDORAIMPORT_MAILBOX_CONVERTERROR               2005</span>
<a href="#l37.38"></a><span id="l37.38" class="difflineminus">-#define EUDORAIMPORT_ACCOUNTNAME                        2006</span>
<a href="#l37.39"></a><span id="l37.39" class="difflineminus">-</span>
<a href="#l37.40"></a><span id="l37.40" class="difflineminus">-#define EUDORAIMPORT_NICKNAMES_NAME                     2007</span>
<a href="#l37.41"></a><span id="l37.41" class="difflineminus">-#define EUDORAIMPORT_ADDRESS_SUCCESS                    2008</span>
<a href="#l37.42"></a><span id="l37.42" class="difflineminus">-#define EUDORAIMPORT_ADDRESS_BADPARAM                   2009</span>
<a href="#l37.43"></a><span id="l37.43" class="difflineminus">-#define EUDORAIMPORT_ADDRESS_BADSOURCEFILE              2010</span>
<a href="#l37.44"></a><span id="l37.44" class="difflineminus">-#define EUDORAIMPORT_ADDRESS_CONVERTERROR               2011</span>
<a href="#l37.45"></a><span id="l37.45" class="difflineminus">-#define EUDORAIMPORT_ADDRESS_LABEL_HOMEMOBILE           2012</span>
<a href="#l37.46"></a><span id="l37.46" class="difflineminus">-#define EUDORAIMPORT_ADDRESS_LABEL_WORKMOBILE           2013</span>
<a href="#l37.47"></a><span id="l37.47" class="difflineminus">-#define EUDORAIMPORT_ADDRESS_LABEL_HOMEFAX              2014</span>
<a href="#l37.48"></a><span id="l37.48" class="difflineminus">-#define EUDORAIMPORT_ADDRESS_LABEL_WORKFAX              2015</span>
<a href="#l37.49"></a><span id="l37.49" class="difflineminus">-#define EUDORAIMPORT_ADDRESS_LABEL_OTHEREMAIL           2016</span>
<a href="#l37.50"></a><span id="l37.50" class="difflineminus">-#define EUDORAIMPORT_ADDRESS_LABEL_OTHERPHONE           2017</span>
<a href="#l37.51"></a><span id="l37.51" class="difflineminus">-#define EUDORAIMPORT_ADDRESS_LABEL_OTHERWEB             2018</span>
<a href="#l37.52"></a><span id="l37.52" class="difflineminus">-</span>
<a href="#l37.53"></a><span id="l37.53" class="difflineminus">-#define EUDORAIMPORT_FILTERS_WARN_OUTGOING              2019</span>
<a href="#l37.54"></a><span id="l37.54" class="difflineminus">-#define EUDORAIMPORT_FILTERS_WARN_ACTION                2020</span>
<a href="#l37.55"></a><span id="l37.55" class="difflineminus">-#define EUDORAIMPORT_FILTERS_WARN_VERB                  2021</span>
<a href="#l37.56"></a><span id="l37.56" class="difflineminus">-#define EUDORAIMPORT_FILTERS_WARN_EMPTY_HEADER          2027</span>
<a href="#l37.57"></a><span id="l37.57" class="difflineminus">-#define EUDORAIMPORT_FILTERS_WARN_NEGATE_VERB           2023</span>
<a href="#l37.58"></a><span id="l37.58" class="difflineminus">-#define EUDORAIMPORT_FILTERS_WARN_META_HEADER           2028</span>
<a href="#l37.59"></a><span id="l37.59" class="difflineminus">-#define EUDORAIMPORT_FILTERS_WARN_MAILBOX_MISSING       2025</span>
<a href="#l37.60"></a><span id="l37.60" class="difflineminus">-</span>
<a href="#l37.61"></a><span id="l37.61" class="difflineminus">-#endif /* nsEudoraStringBundle_H__ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l38.1"></a><span id="l38.1">deleted file mode 100644</span>
<a href="#l38.2"></a><span id="l38.2" class="difflineminus">--- a/mailnews/import/eudora/src/nsEudoraWin32.cpp</span>
<a href="#l38.3"></a><span id="l38.3" class="difflineplus">+++ /dev/null</span>
<a href="#l38.4"></a><span id="l38.4" class="difflineat">@@ -1,1602 +0,0 @@</span>
<a href="#l38.5"></a><span id="l38.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l38.6"></a><span id="l38.6" class="difflineminus">- *</span>
<a href="#l38.7"></a><span id="l38.7" class="difflineminus">- * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l38.8"></a><span id="l38.8" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l38.9"></a><span id="l38.9" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l38.10"></a><span id="l38.10" class="difflineminus">-</span>
<a href="#l38.11"></a><span id="l38.11" class="difflineminus">-#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l38.12"></a><span id="l38.12" class="difflineminus">-#include &quot;nsMsgUtils.h&quot;</span>
<a href="#l38.13"></a><span id="l38.13" class="difflineminus">-#include &quot;nsIComponentManager.h&quot;</span>
<a href="#l38.14"></a><span id="l38.14" class="difflineminus">-#include &quot;nsIServiceManager.h&quot;</span>
<a href="#l38.15"></a><span id="l38.15" class="difflineminus">-#include &quot;nsIMsgAccountManager.h&quot;</span>
<a href="#l38.16"></a><span id="l38.16" class="difflineminus">-#include &quot;nsIMsgAccount.h&quot;</span>
<a href="#l38.17"></a><span id="l38.17" class="difflineminus">-#include &quot;nsIMutableArray.h&quot;</span>
<a href="#l38.18"></a><span id="l38.18" class="difflineminus">-#include &quot;nsIPop3IncomingServer.h&quot;</span>
<a href="#l38.19"></a><span id="l38.19" class="difflineminus">-#include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l38.20"></a><span id="l38.20" class="difflineminus">-#include &quot;nsMsgCompCID.h&quot;</span>
<a href="#l38.21"></a><span id="l38.21" class="difflineminus">-#include &quot;nsISmtpService.h&quot;</span>
<a href="#l38.22"></a><span id="l38.22" class="difflineminus">-#include &quot;nsISmtpServer.h&quot;</span>
<a href="#l38.23"></a><span id="l38.23" class="difflineminus">-#include &quot;nsEudoraWin32.h&quot;</span>
<a href="#l38.24"></a><span id="l38.24" class="difflineminus">-#include &quot;nsIImportService.h&quot;</span>
<a href="#l38.25"></a><span id="l38.25" class="difflineminus">-#include &quot;nsIImportMailboxDescriptor.h&quot;</span>
<a href="#l38.26"></a><span id="l38.26" class="difflineminus">-#include &quot;nsIImportABDescriptor.h&quot;</span>
<a href="#l38.27"></a><span id="l38.27" class="difflineminus">-#include &quot;nsEudoraStringBundle.h&quot;</span>
<a href="#l38.28"></a><span id="l38.28" class="difflineminus">-#include &quot;nsEudoraImport.h&quot;</span>
<a href="#l38.29"></a><span id="l38.29" class="difflineminus">-#include &quot;nsUnicharUtils.h&quot;</span>
<a href="#l38.30"></a><span id="l38.30" class="difflineminus">-#include &quot;nsCRT.h&quot;</span>
<a href="#l38.31"></a><span id="l38.31" class="difflineminus">-#include &quot;nsNetUtil.h&quot;</span>
<a href="#l38.32"></a><span id="l38.32" class="difflineminus">-#include &quot;nsILineInputStream.h&quot;</span>
<a href="#l38.33"></a><span id="l38.33" class="difflineminus">-#include &quot;EudoraDebugLog.h&quot;</span>
<a href="#l38.34"></a><span id="l38.34" class="difflineminus">-#include &quot;prmem.h&quot;</span>
<a href="#l38.35"></a><span id="l38.35" class="difflineminus">-#include &quot;plstr.h&quot;</span>
<a href="#l38.36"></a><span id="l38.36" class="difflineminus">-#include &lt;algorithm&gt;</span>
<a href="#l38.37"></a><span id="l38.37" class="difflineminus">-</span>
<a href="#l38.38"></a><span id="l38.38" class="difflineminus">-static NS_DEFINE_IID(kISupportsIID,      NS_ISUPPORTS_IID);</span>
<a href="#l38.39"></a><span id="l38.39" class="difflineminus">-</span>
<a href="#l38.40"></a><span id="l38.40" class="difflineminus">-static const char *  kWhitespace = &quot;\b\t\r\n &quot;;</span>
<a href="#l38.41"></a><span id="l38.41" class="difflineminus">-</span>
<a href="#l38.42"></a><span id="l38.42" class="difflineminus">-BYTE * nsEudoraWin32::GetValueBytes(HKEY hKey, const char *pValueName)</span>
<a href="#l38.43"></a><span id="l38.43" class="difflineminus">-{</span>
<a href="#l38.44"></a><span id="l38.44" class="difflineminus">-  LONG err;</span>
<a href="#l38.45"></a><span id="l38.45" class="difflineminus">-  DWORD bufSz;</span>
<a href="#l38.46"></a><span id="l38.46" class="difflineminus">-  LPBYTE pBytes = NULL;</span>
<a href="#l38.47"></a><span id="l38.47" class="difflineminus">-</span>
<a href="#l38.48"></a><span id="l38.48" class="difflineminus">-  err = ::RegQueryValueEx(hKey, pValueName, NULL, NULL, NULL, &amp;bufSz);</span>
<a href="#l38.49"></a><span id="l38.49" class="difflineminus">-  if (err == ERROR_SUCCESS)</span>
<a href="#l38.50"></a><span id="l38.50" class="difflineminus">-  {</span>
<a href="#l38.51"></a><span id="l38.51" class="difflineminus">-    pBytes = new BYTE[bufSz];</span>
<a href="#l38.52"></a><span id="l38.52" class="difflineminus">-    err = ::RegQueryValueEx(hKey, pValueName, NULL, NULL, pBytes, &amp;bufSz);</span>
<a href="#l38.53"></a><span id="l38.53" class="difflineminus">-    if (err != ERROR_SUCCESS)</span>
<a href="#l38.54"></a><span id="l38.54" class="difflineminus">-    {</span>
<a href="#l38.55"></a><span id="l38.55" class="difflineminus">-      delete [] pBytes;</span>
<a href="#l38.56"></a><span id="l38.56" class="difflineminus">-      pBytes = NULL;</span>
<a href="#l38.57"></a><span id="l38.57" class="difflineminus">-    }</span>
<a href="#l38.58"></a><span id="l38.58" class="difflineminus">-  }</span>
<a href="#l38.59"></a><span id="l38.59" class="difflineminus">-</span>
<a href="#l38.60"></a><span id="l38.60" class="difflineminus">-  return pBytes;</span>
<a href="#l38.61"></a><span id="l38.61" class="difflineminus">-}</span>
<a href="#l38.62"></a><span id="l38.62" class="difflineminus">-</span>
<a href="#l38.63"></a><span id="l38.63" class="difflineminus">-</span>
<a href="#l38.64"></a><span id="l38.64" class="difflineminus">-nsEudoraWin32::nsEudoraWin32()</span>
<a href="#l38.65"></a><span id="l38.65" class="difflineminus">-{</span>
<a href="#l38.66"></a><span id="l38.66" class="difflineminus">-  m_pMimeSection = nullptr;</span>
<a href="#l38.67"></a><span id="l38.67" class="difflineminus">-}</span>
<a href="#l38.68"></a><span id="l38.68" class="difflineminus">-</span>
<a href="#l38.69"></a><span id="l38.69" class="difflineminus">-nsEudoraWin32::~nsEudoraWin32()</span>
<a href="#l38.70"></a><span id="l38.70" class="difflineminus">-{</span>
<a href="#l38.71"></a><span id="l38.71" class="difflineminus">-  delete [] m_pMimeSection;</span>
<a href="#l38.72"></a><span id="l38.72" class="difflineminus">-}</span>
<a href="#l38.73"></a><span id="l38.73" class="difflineminus">-</span>
<a href="#l38.74"></a><span id="l38.74" class="difflineminus">-bool nsEudoraWin32::FindMailFolder(nsIFile **pFolder)</span>
<a href="#l38.75"></a><span id="l38.75" class="difflineminus">-{</span>
<a href="#l38.76"></a><span id="l38.76" class="difflineminus">-  return FindEudoraLocation(pFolder);</span>
<a href="#l38.77"></a><span id="l38.77" class="difflineminus">-}</span>
<a href="#l38.78"></a><span id="l38.78" class="difflineminus">-</span>
<a href="#l38.79"></a><span id="l38.79" class="difflineminus">-bool nsEudoraWin32::FindEudoraLocation(nsIFile **pFolder, bool findIni)</span>
<a href="#l38.80"></a><span id="l38.80" class="difflineminus">-{</span>
<a href="#l38.81"></a><span id="l38.81" class="difflineminus">-  bool result = false;</span>
<a href="#l38.82"></a><span id="l38.82" class="difflineminus">-  bool    exists = false;</span>
<a href="#l38.83"></a><span id="l38.83" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; eudoraPath = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID);</span>
<a href="#l38.84"></a><span id="l38.84" class="difflineminus">-  // look in the registry to see where eudora is installed?</span>
<a href="#l38.85"></a><span id="l38.85" class="difflineminus">-  HKEY  sKey;</span>
<a href="#l38.86"></a><span id="l38.86" class="difflineminus">-  if (::RegOpenKeyEx(HKEY_CURRENT_USER, &quot;Software\\Qualcomm\\Eudora\\CommandLine&quot;, 0, KEY_QUERY_VALUE, &amp;sKey) == ERROR_SUCCESS)</span>
<a href="#l38.87"></a><span id="l38.87" class="difflineminus">-  {</span>
<a href="#l38.88"></a><span id="l38.88" class="difflineminus">-    // get the value of &quot;Current&quot;</span>
<a href="#l38.89"></a><span id="l38.89" class="difflineminus">-    BYTE *pBytes = GetValueBytes(sKey, &quot;Current&quot;);</span>
<a href="#l38.90"></a><span id="l38.90" class="difflineminus">-    if (pBytes)</span>
<a href="#l38.91"></a><span id="l38.91" class="difflineminus">-    {</span>
<a href="#l38.92"></a><span id="l38.92" class="difflineminus">-      nsCString str((const char *)pBytes);</span>
<a href="#l38.93"></a><span id="l38.93" class="difflineminus">-      delete [] pBytes;</span>
<a href="#l38.94"></a><span id="l38.94" class="difflineminus">-</span>
<a href="#l38.95"></a><span id="l38.95" class="difflineminus">-      MsgCompressWhitespace(str);</span>
<a href="#l38.96"></a><span id="l38.96" class="difflineminus">-</span>
<a href="#l38.97"></a><span id="l38.97" class="difflineminus">-      // Command line is Eudora mailfolder eudora.ini</span>
<a href="#l38.98"></a><span id="l38.98" class="difflineminus">-      if (findIni)</span>
<a href="#l38.99"></a><span id="l38.99" class="difflineminus">-      {</span>
<a href="#l38.100"></a><span id="l38.100" class="difflineminus">-        // find the string coming after the last space</span>
<a href="#l38.101"></a><span id="l38.101" class="difflineminus">-        int32_t index = str.RFind(&quot; &quot;);</span>
<a href="#l38.102"></a><span id="l38.102" class="difflineminus">-        if (index != -1)</span>
<a href="#l38.103"></a><span id="l38.103" class="difflineminus">-        {</span>
<a href="#l38.104"></a><span id="l38.104" class="difflineminus">-          index++; // skip the space</span>
<a href="#l38.105"></a><span id="l38.105" class="difflineminus">-          eudoraPath-&gt;InitWithNativePath(Substring(str, index));</span>
<a href="#l38.106"></a><span id="l38.106" class="difflineminus">-          eudoraPath-&gt;IsFile(&amp;exists);</span>
<a href="#l38.107"></a><span id="l38.107" class="difflineminus">-          if (exists)</span>
<a href="#l38.108"></a><span id="l38.108" class="difflineminus">-            result = exists;</span>
<a href="#l38.109"></a><span id="l38.109" class="difflineminus">-          else // it may just be the mailbox location....guess that there will be a eudora.ini file there</span>
<a href="#l38.110"></a><span id="l38.110" class="difflineminus">-          {</span>
<a href="#l38.111"></a><span id="l38.111" class="difflineminus">-            eudoraPath-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;eudora.ini&quot;));</span>
<a href="#l38.112"></a><span id="l38.112" class="difflineminus">-            eudoraPath-&gt;IsFile(&amp;exists);</span>
<a href="#l38.113"></a><span id="l38.113" class="difflineminus">-            result = exists;</span>
<a href="#l38.114"></a><span id="l38.114" class="difflineminus">-          }</span>
<a href="#l38.115"></a><span id="l38.115" class="difflineminus">-        }</span>
<a href="#l38.116"></a><span id="l38.116" class="difflineminus">-      } // if findIni</span>
<a href="#l38.117"></a><span id="l38.117" class="difflineminus">-      else</span>
<a href="#l38.118"></a><span id="l38.118" class="difflineminus">-      {</span>
<a href="#l38.119"></a><span id="l38.119" class="difflineminus">-        int  idx = -1;</span>
<a href="#l38.120"></a><span id="l38.120" class="difflineminus">-        if (str.CharAt(0) == '&quot;')</span>
<a href="#l38.121"></a><span id="l38.121" class="difflineminus">-        {</span>
<a href="#l38.122"></a><span id="l38.122" class="difflineminus">-          idx = str.FindChar('&quot;', 1);</span>
<a href="#l38.123"></a><span id="l38.123" class="difflineminus">-          if (idx != -1)</span>
<a href="#l38.124"></a><span id="l38.124" class="difflineminus">-            idx++;</span>
<a href="#l38.125"></a><span id="l38.125" class="difflineminus">-        }</span>
<a href="#l38.126"></a><span id="l38.126" class="difflineminus">-        else</span>
<a href="#l38.127"></a><span id="l38.127" class="difflineminus">-          idx = str.FindChar(' ');</span>
<a href="#l38.128"></a><span id="l38.128" class="difflineminus">-</span>
<a href="#l38.129"></a><span id="l38.129" class="difflineminus">-        if (idx != -1)</span>
<a href="#l38.130"></a><span id="l38.130" class="difflineminus">-        {</span>
<a href="#l38.131"></a><span id="l38.131" class="difflineminus">-          idx++;</span>
<a href="#l38.132"></a><span id="l38.132" class="difflineminus">-          while (str.CharAt(idx) == ' ') idx++;</span>
<a href="#l38.133"></a><span id="l38.133" class="difflineminus">-          int endIdx = -1;</span>
<a href="#l38.134"></a><span id="l38.134" class="difflineminus">-          if (str.CharAt(idx) == '&quot;')</span>
<a href="#l38.135"></a><span id="l38.135" class="difflineminus">-            endIdx = str.FindChar('&quot;', idx);</span>
<a href="#l38.136"></a><span id="l38.136" class="difflineminus">-          else {</span>
<a href="#l38.137"></a><span id="l38.137" class="difflineminus">-            endIdx = str.FindChar(' ', idx);</span>
<a href="#l38.138"></a><span id="l38.138" class="difflineminus">-            if (endIdx == -1)</span>
<a href="#l38.139"></a><span id="l38.139" class="difflineminus">-              endIdx = str.Length();</span>
<a href="#l38.140"></a><span id="l38.140" class="difflineminus">-          }</span>
<a href="#l38.141"></a><span id="l38.141" class="difflineminus">-          if (endIdx != -1)</span>
<a href="#l38.142"></a><span id="l38.142" class="difflineminus">-          {</span>
<a href="#l38.143"></a><span id="l38.143" class="difflineminus">-            eudoraPath-&gt;InitWithNativePath(Substring(str, idx, endIdx - idx));</span>
<a href="#l38.144"></a><span id="l38.144" class="difflineminus">-</span>
<a href="#l38.145"></a><span id="l38.145" class="difflineminus">-            if (NS_SUCCEEDED(eudoraPath-&gt;IsDirectory(&amp;exists)))</span>
<a href="#l38.146"></a><span id="l38.146" class="difflineminus">-              result = exists;</span>
<a href="#l38.147"></a><span id="l38.147" class="difflineminus">-          }</span>
<a href="#l38.148"></a><span id="l38.148" class="difflineminus">-        }</span>
<a href="#l38.149"></a><span id="l38.149" class="difflineminus">-      }</span>
<a href="#l38.150"></a><span id="l38.150" class="difflineminus">-    } // if pBytes</span>
<a href="#l38.151"></a><span id="l38.151" class="difflineminus">-    ::RegCloseKey(sKey);</span>
<a href="#l38.152"></a><span id="l38.152" class="difflineminus">-  }</span>
<a href="#l38.153"></a><span id="l38.153" class="difflineminus">-</span>
<a href="#l38.154"></a><span id="l38.154" class="difflineminus">-  NS_IF_ADDREF(*pFolder = eudoraPath);</span>
<a href="#l38.155"></a><span id="l38.155" class="difflineminus">-  return result;</span>
<a href="#l38.156"></a><span id="l38.156" class="difflineminus">-}</span>
<a href="#l38.157"></a><span id="l38.157" class="difflineminus">-</span>
<a href="#l38.158"></a><span id="l38.158" class="difflineminus">-nsresult nsEudoraWin32::FindMailboxes(nsIFile *pRoot, nsIMutableArray *pArray)</span>
<a href="#l38.159"></a><span id="l38.159" class="difflineminus">-{</span>
<a href="#l38.160"></a><span id="l38.160" class="difflineminus">-  nsresult rv;</span>
<a href="#l38.161"></a><span id="l38.161" class="difflineminus">-  nsCOMPtr&lt;nsIImportService&gt; impSvc(do_GetService(NS_IMPORTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l38.162"></a><span id="l38.162" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l38.163"></a><span id="l38.163" class="difflineminus">-    return rv;</span>
<a href="#l38.164"></a><span id="l38.164" class="difflineminus">-</span>
<a href="#l38.165"></a><span id="l38.165" class="difflineminus">-  m_depth = 0;</span>
<a href="#l38.166"></a><span id="l38.166" class="difflineminus">-  m_mailImportLocation = do_QueryInterface(pRoot);</span>
<a href="#l38.167"></a><span id="l38.167" class="difflineminus">-  return ScanMailDir(pRoot, pArray, impSvc);</span>
<a href="#l38.168"></a><span id="l38.168" class="difflineminus">-}</span>
<a href="#l38.169"></a><span id="l38.169" class="difflineminus">-</span>
<a href="#l38.170"></a><span id="l38.170" class="difflineminus">-</span>
<a href="#l38.171"></a><span id="l38.171" class="difflineminus">-nsresult nsEudoraWin32::ScanMailDir(nsIFile *pFolder, nsIMutableArray *pArray, nsIImportService *pImport)</span>
<a href="#l38.172"></a><span id="l38.172" class="difflineminus">-{</span>
<a href="#l38.173"></a><span id="l38.173" class="difflineminus">-  bool            exists = false;</span>
<a href="#l38.174"></a><span id="l38.174" class="difflineminus">-  bool            isFile = false;</span>
<a href="#l38.175"></a><span id="l38.175" class="difflineminus">-  char *          pContents = nullptr;</span>
<a href="#l38.176"></a><span id="l38.176" class="difflineminus">-  int32_t          len = 0;</span>
<a href="#l38.177"></a><span id="l38.177" class="difflineminus">-  nsCOMPtr&lt;nsIFile&gt;  descMap;</span>
<a href="#l38.178"></a><span id="l38.178" class="difflineminus">-  nsresult        rv;</span>
<a href="#l38.179"></a><span id="l38.179" class="difflineminus">-</span>
<a href="#l38.180"></a><span id="l38.180" class="difflineminus">-  if (NS_FAILED(rv = pFolder-&gt;Clone(getter_AddRefs(descMap))))</span>
<a href="#l38.181"></a><span id="l38.181" class="difflineminus">-    return rv;</span>
<a href="#l38.182"></a><span id="l38.182" class="difflineminus">-</span>
<a href="#l38.183"></a><span id="l38.183" class="difflineminus">-  m_depth++;</span>
<a href="#l38.184"></a><span id="l38.184" class="difflineminus">-</span>
<a href="#l38.185"></a><span id="l38.185" class="difflineminus">-  rv = descMap-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;descmap.pce&quot;));</span>
<a href="#l38.186"></a><span id="l38.186" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l38.187"></a><span id="l38.187" class="difflineminus">-    rv = descMap-&gt;IsFile(&amp;isFile);</span>
<a href="#l38.188"></a><span id="l38.188" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l38.189"></a><span id="l38.189" class="difflineminus">-    rv = descMap-&gt;Exists(&amp;exists);</span>
<a href="#l38.190"></a><span id="l38.190" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; exists &amp;&amp; isFile)</span>
<a href="#l38.191"></a><span id="l38.191" class="difflineminus">-  {</span>
<a href="#l38.192"></a><span id="l38.192" class="difflineminus">-    nsCOMPtr&lt;nsIInputStream&gt; inputStream;</span>
<a href="#l38.193"></a><span id="l38.193" class="difflineminus">-    nsresult rv = NS_NewLocalFileInputStream(getter_AddRefs(inputStream), descMap);</span>
<a href="#l38.194"></a><span id="l38.194" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l38.195"></a><span id="l38.195" class="difflineminus">-      return rv;</span>
<a href="#l38.196"></a><span id="l38.196" class="difflineminus">-</span>
<a href="#l38.197"></a><span id="l38.197" class="difflineminus">-    uint64_t bytesLeft64;</span>
<a href="#l38.198"></a><span id="l38.198" class="difflineminus">-    rv = inputStream-&gt;Available(&amp;bytesLeft64);</span>
<a href="#l38.199"></a><span id="l38.199" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l38.200"></a><span id="l38.200" class="difflineminus">-    {</span>
<a href="#l38.201"></a><span id="l38.201" class="difflineminus">-      IMPORT_LOG0(&quot;*** Error checking address file for eof\n&quot;);</span>
<a href="#l38.202"></a><span id="l38.202" class="difflineminus">-      inputStream-&gt;Close();</span>
<a href="#l38.203"></a><span id="l38.203" class="difflineminus">-      return rv;</span>
<a href="#l38.204"></a><span id="l38.204" class="difflineminus">-    }</span>
<a href="#l38.205"></a><span id="l38.205" class="difflineminus">-    uint32_t bytesLeft = std::min(uint64_t(PR_UINT32_MAX - 1), bytesLeft64);</span>
<a href="#l38.206"></a><span id="l38.206" class="difflineminus">-    pContents = (char *) PR_Malloc(bytesLeft + 1);</span>
<a href="#l38.207"></a><span id="l38.207" class="difflineminus">-    if (!pContents)</span>
<a href="#l38.208"></a><span id="l38.208" class="difflineminus">-      return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l38.209"></a><span id="l38.209" class="difflineminus">-    uint32_t bytesRead;</span>
<a href="#l38.210"></a><span id="l38.210" class="difflineminus">-    rv = inputStream-&gt;Read(pContents, bytesLeft, &amp;bytesRead);</span>
<a href="#l38.211"></a><span id="l38.211" class="difflineminus">-    if (bytesRead != bytesLeft)</span>
<a href="#l38.212"></a><span id="l38.212" class="difflineminus">-      return NS_ERROR_FAILURE;</span>
<a href="#l38.213"></a><span id="l38.213" class="difflineminus">-    pContents[bytesRead] = '\0';</span>
<a href="#l38.214"></a><span id="l38.214" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; pContents)</span>
<a href="#l38.215"></a><span id="l38.215" class="difflineminus">-    {</span>
<a href="#l38.216"></a><span id="l38.216" class="difflineminus">-      len = bytesRead;</span>
<a href="#l38.217"></a><span id="l38.217" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l38.218"></a><span id="l38.218" class="difflineminus">-        rv = ScanDescmap(pFolder, pArray, pImport, pContents, len);</span>
<a href="#l38.219"></a><span id="l38.219" class="difflineminus">-      PR_Free(pContents);</span>
<a href="#l38.220"></a><span id="l38.220" class="difflineminus">-    }</span>
<a href="#l38.221"></a><span id="l38.221" class="difflineminus">-    else</span>
<a href="#l38.222"></a><span id="l38.222" class="difflineminus">-      rv = NS_ERROR_FAILURE;</span>
<a href="#l38.223"></a><span id="l38.223" class="difflineminus">-  }</span>
<a href="#l38.224"></a><span id="l38.224" class="difflineminus">-</span>
<a href="#l38.225"></a><span id="l38.225" class="difflineminus">-  if (NS_FAILED(rv) || !isFile || !exists)</span>
<a href="#l38.226"></a><span id="l38.226" class="difflineminus">-    rv = IterateMailDir(pFolder, pArray, pImport);</span>
<a href="#l38.227"></a><span id="l38.227" class="difflineminus">-</span>
<a href="#l38.228"></a><span id="l38.228" class="difflineminus">-  m_depth--;</span>
<a href="#l38.229"></a><span id="l38.229" class="difflineminus">-</span>
<a href="#l38.230"></a><span id="l38.230" class="difflineminus">-  return rv;</span>
<a href="#l38.231"></a><span id="l38.231" class="difflineminus">-}</span>
<a href="#l38.232"></a><span id="l38.232" class="difflineminus">-</span>
<a href="#l38.233"></a><span id="l38.233" class="difflineminus">-nsresult nsEudoraWin32::IterateMailDir(nsIFile *pFolder, nsIMutableArray *pArray, nsIImportService *pImport)</span>
<a href="#l38.234"></a><span id="l38.234" class="difflineminus">-{</span>
<a href="#l38.235"></a><span id="l38.235" class="difflineminus">-  bool hasMore;</span>
<a href="#l38.236"></a><span id="l38.236" class="difflineminus">-  nsCOMPtr&lt;nsISimpleEnumerator&gt; directoryEnumerator;</span>
<a href="#l38.237"></a><span id="l38.237" class="difflineminus">-  nsresult rv = pFolder-&gt;GetDirectoryEntries(getter_AddRefs(directoryEnumerator));</span>
<a href="#l38.238"></a><span id="l38.238" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l38.239"></a><span id="l38.239" class="difflineminus">-</span>
<a href="#l38.240"></a><span id="l38.240" class="difflineminus">-  directoryEnumerator-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l38.241"></a><span id="l38.241" class="difflineminus">-  bool              isFolder;</span>
<a href="#l38.242"></a><span id="l38.242" class="difflineminus">-  bool              isFile;</span>
<a href="#l38.243"></a><span id="l38.243" class="difflineminus">-  nsCOMPtr&lt;nsIFile&gt; entry;</span>
<a href="#l38.244"></a><span id="l38.244" class="difflineminus">-  nsCString         fName;</span>
<a href="#l38.245"></a><span id="l38.245" class="difflineminus">-  nsCString         ext;</span>
<a href="#l38.246"></a><span id="l38.246" class="difflineminus">-  nsCString         name;</span>
<a href="#l38.247"></a><span id="l38.247" class="difflineminus">-</span>
<a href="#l38.248"></a><span id="l38.248" class="difflineminus">-  while (hasMore &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l38.249"></a><span id="l38.249" class="difflineminus">-  {</span>
<a href="#l38.250"></a><span id="l38.250" class="difflineminus">-    nsCOMPtr&lt;nsISupports&gt; aSupport;</span>
<a href="#l38.251"></a><span id="l38.251" class="difflineminus">-    rv = directoryEnumerator-&gt;GetNext(getter_AddRefs(aSupport));</span>
<a href="#l38.252"></a><span id="l38.252" class="difflineminus">-    nsCOMPtr&lt;nsIFile&gt; entry(do_QueryInterface(aSupport, &amp;rv));</span>
<a href="#l38.253"></a><span id="l38.253" class="difflineminus">-    directoryEnumerator-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l38.254"></a><span id="l38.254" class="difflineminus">-</span>
<a href="#l38.255"></a><span id="l38.255" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l38.256"></a><span id="l38.256" class="difflineminus">-    {</span>
<a href="#l38.257"></a><span id="l38.257" class="difflineminus">-      rv = entry-&gt;GetNativeLeafName(fName);</span>
<a href="#l38.258"></a><span id="l38.258" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; !fName.IsEmpty())</span>
<a href="#l38.259"></a><span id="l38.259" class="difflineminus">-      {</span>
<a href="#l38.260"></a><span id="l38.260" class="difflineminus">-        if (fName.Length() &gt; 4)</span>
<a href="#l38.261"></a><span id="l38.261" class="difflineminus">-        {</span>
<a href="#l38.262"></a><span id="l38.262" class="difflineminus">-          ext = StringTail(fName, 4);</span>
<a href="#l38.263"></a><span id="l38.263" class="difflineminus">-          name = StringHead(fName, fName.Length() - 4);</span>
<a href="#l38.264"></a><span id="l38.264" class="difflineminus">-        }</span>
<a href="#l38.265"></a><span id="l38.265" class="difflineminus">-        else</span>
<a href="#l38.266"></a><span id="l38.266" class="difflineminus">-        {</span>
<a href="#l38.267"></a><span id="l38.267" class="difflineminus">-          ext.Truncate();</span>
<a href="#l38.268"></a><span id="l38.268" class="difflineminus">-          name = fName;</span>
<a href="#l38.269"></a><span id="l38.269" class="difflineminus">-        }</span>
<a href="#l38.270"></a><span id="l38.270" class="difflineminus">-        ToLowerCase(ext);</span>
<a href="#l38.271"></a><span id="l38.271" class="difflineminus">-        if (ext.EqualsLiteral(&quot;.fol&quot;))</span>
<a href="#l38.272"></a><span id="l38.272" class="difflineminus">-        {</span>
<a href="#l38.273"></a><span id="l38.273" class="difflineminus">-          isFolder = false;</span>
<a href="#l38.274"></a><span id="l38.274" class="difflineminus">-          entry-&gt;IsDirectory(&amp;isFolder);</span>
<a href="#l38.275"></a><span id="l38.275" class="difflineminus">-          if (isFolder)</span>
<a href="#l38.276"></a><span id="l38.276" class="difflineminus">-          {</span>
<a href="#l38.277"></a><span id="l38.277" class="difflineminus">-            // add the folder</span>
<a href="#l38.278"></a><span id="l38.278" class="difflineminus">-            rv = FoundMailFolder(entry, name.get(), pArray, pImport);</span>
<a href="#l38.279"></a><span id="l38.279" class="difflineminus">-            if (NS_SUCCEEDED(rv))</span>
<a href="#l38.280"></a><span id="l38.280" class="difflineminus">-            {</span>
<a href="#l38.281"></a><span id="l38.281" class="difflineminus">-              rv = ScanMailDir(entry, pArray, pImport);</span>
<a href="#l38.282"></a><span id="l38.282" class="difflineminus">-              if (NS_FAILED(rv))</span>
<a href="#l38.283"></a><span id="l38.283" class="difflineminus">-                IMPORT_LOG0(&quot;*** Error scanning mail directory\n&quot;);</span>
<a href="#l38.284"></a><span id="l38.284" class="difflineminus">-            }</span>
<a href="#l38.285"></a><span id="l38.285" class="difflineminus">-          }</span>
<a href="#l38.286"></a><span id="l38.286" class="difflineminus">-        }</span>
<a href="#l38.287"></a><span id="l38.287" class="difflineminus">-        else if (ext.EqualsLiteral(&quot;.mbx&quot;))</span>
<a href="#l38.288"></a><span id="l38.288" class="difflineminus">-        {</span>
<a href="#l38.289"></a><span id="l38.289" class="difflineminus">-          isFile = false;</span>
<a href="#l38.290"></a><span id="l38.290" class="difflineminus">-          entry-&gt;IsFile(&amp;isFile);</span>
<a href="#l38.291"></a><span id="l38.291" class="difflineminus">-          if (isFile)</span>
<a href="#l38.292"></a><span id="l38.292" class="difflineminus">-            rv = FoundMailbox(entry, name.get(), pArray, pImport);</span>
<a href="#l38.293"></a><span id="l38.293" class="difflineminus">-        }</span>
<a href="#l38.294"></a><span id="l38.294" class="difflineminus">-      }</span>
<a href="#l38.295"></a><span id="l38.295" class="difflineminus">-    }</span>
<a href="#l38.296"></a><span id="l38.296" class="difflineminus">-  }</span>
<a href="#l38.297"></a><span id="l38.297" class="difflineminus">-  return rv;</span>
<a href="#l38.298"></a><span id="l38.298" class="difflineminus">-}</span>
<a href="#l38.299"></a><span id="l38.299" class="difflineminus">-</span>
<a href="#l38.300"></a><span id="l38.300" class="difflineminus">-nsresult nsEudoraWin32::ScanDescmap(nsIFile *pFolder, nsIMutableArray *pArray, nsIImportService *pImport, const char *pData, int32_t len)</span>
<a href="#l38.301"></a><span id="l38.301" class="difflineminus">-{</span>
<a href="#l38.302"></a><span id="l38.302" class="difflineminus">-  // use this to find stuff in the directory.</span>
<a href="#l38.303"></a><span id="l38.303" class="difflineminus">-</span>
<a href="#l38.304"></a><span id="l38.304" class="difflineminus">-  nsCOMPtr&lt;nsIFile&gt;  entry;</span>
<a href="#l38.305"></a><span id="l38.305" class="difflineminus">-  nsresult        rv;</span>
<a href="#l38.306"></a><span id="l38.306" class="difflineminus">-</span>
<a href="#l38.307"></a><span id="l38.307" class="difflineminus">-  if (NS_FAILED(rv = pFolder-&gt;Clone(getter_AddRefs(entry))))</span>
<a href="#l38.308"></a><span id="l38.308" class="difflineminus">-    return rv;</span>
<a href="#l38.309"></a><span id="l38.309" class="difflineminus">-  entry-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;dummy&quot;));</span>
<a href="#l38.310"></a><span id="l38.310" class="difflineminus">-  // format is Name,FileName,Type,Flag?</span>
<a href="#l38.311"></a><span id="l38.311" class="difflineminus">-  //  Type = M or S for mailbox</span>
<a href="#l38.312"></a><span id="l38.312" class="difflineminus">-  //       = F for folder</span>
<a href="#l38.313"></a><span id="l38.313" class="difflineminus">-</span>
<a href="#l38.314"></a><span id="l38.314" class="difflineminus">-  int32_t      fieldLen;</span>
<a href="#l38.315"></a><span id="l38.315" class="difflineminus">-  int32_t      pos = 0;</span>
<a href="#l38.316"></a><span id="l38.316" class="difflineminus">-  const char * pStart;</span>
<a href="#l38.317"></a><span id="l38.317" class="difflineminus">-  nsCString    name;</span>
<a href="#l38.318"></a><span id="l38.318" class="difflineminus">-  nsCString    fName;</span>
<a href="#l38.319"></a><span id="l38.319" class="difflineminus">-  nsCString    type;</span>
<a href="#l38.320"></a><span id="l38.320" class="difflineminus">-  nsCString    flag;</span>
<a href="#l38.321"></a><span id="l38.321" class="difflineminus">-  bool         isFile;</span>
<a href="#l38.322"></a><span id="l38.322" class="difflineminus">-  bool         isFolder;</span>
<a href="#l38.323"></a><span id="l38.323" class="difflineminus">-  while (pos &lt; len)</span>
<a href="#l38.324"></a><span id="l38.324" class="difflineminus">-  {</span>
<a href="#l38.325"></a><span id="l38.325" class="difflineminus">-    pStart = pData;</span>
<a href="#l38.326"></a><span id="l38.326" class="difflineminus">-    fieldLen = 0;</span>
<a href="#l38.327"></a><span id="l38.327" class="difflineminus">-    while ((pos &lt; len) &amp;&amp; (*pData != ','))</span>
<a href="#l38.328"></a><span id="l38.328" class="difflineminus">-    {</span>
<a href="#l38.329"></a><span id="l38.329" class="difflineminus">-      pos++;</span>
<a href="#l38.330"></a><span id="l38.330" class="difflineminus">-      pData++;</span>
<a href="#l38.331"></a><span id="l38.331" class="difflineminus">-      fieldLen++;</span>
<a href="#l38.332"></a><span id="l38.332" class="difflineminus">-    }</span>
<a href="#l38.333"></a><span id="l38.333" class="difflineminus">-    name.Truncate();</span>
<a href="#l38.334"></a><span id="l38.334" class="difflineminus">-    if (fieldLen)</span>
<a href="#l38.335"></a><span id="l38.335" class="difflineminus">-      name.Append(pStart, fieldLen);</span>
<a href="#l38.336"></a><span id="l38.336" class="difflineminus">-    name.Trim(kWhitespace);</span>
<a href="#l38.337"></a><span id="l38.337" class="difflineminus">-    pos++;</span>
<a href="#l38.338"></a><span id="l38.338" class="difflineminus">-    pData++;</span>
<a href="#l38.339"></a><span id="l38.339" class="difflineminus">-    pStart = pData;</span>
<a href="#l38.340"></a><span id="l38.340" class="difflineminus">-    fieldLen = 0;</span>
<a href="#l38.341"></a><span id="l38.341" class="difflineminus">-    while ((pos &lt; len) &amp;&amp; (*pData != ','))</span>
<a href="#l38.342"></a><span id="l38.342" class="difflineminus">-    {</span>
<a href="#l38.343"></a><span id="l38.343" class="difflineminus">-      pos++;</span>
<a href="#l38.344"></a><span id="l38.344" class="difflineminus">-      pData++;</span>
<a href="#l38.345"></a><span id="l38.345" class="difflineminus">-      fieldLen++;</span>
<a href="#l38.346"></a><span id="l38.346" class="difflineminus">-    }</span>
<a href="#l38.347"></a><span id="l38.347" class="difflineminus">-    fName.Truncate();</span>
<a href="#l38.348"></a><span id="l38.348" class="difflineminus">-    if (fieldLen)</span>
<a href="#l38.349"></a><span id="l38.349" class="difflineminus">-      fName.Append(pStart, fieldLen);</span>
<a href="#l38.350"></a><span id="l38.350" class="difflineminus">-    // Descmap file name is written without any extraneous white space - i.e.</span>
<a href="#l38.351"></a><span id="l38.351" class="difflineminus">-    // if there's whitespace present it's intentional and important. Don't</span>
<a href="#l38.352"></a><span id="l38.352" class="difflineminus">-    // strip whitespace from the fName.</span>
<a href="#l38.353"></a><span id="l38.353" class="difflineminus">-    pos++;</span>
<a href="#l38.354"></a><span id="l38.354" class="difflineminus">-    pData++;</span>
<a href="#l38.355"></a><span id="l38.355" class="difflineminus">-    pStart = pData;</span>
<a href="#l38.356"></a><span id="l38.356" class="difflineminus">-    fieldLen = 0;</span>
<a href="#l38.357"></a><span id="l38.357" class="difflineminus">-    while ((pos &lt; len) &amp;&amp; (*pData != ','))</span>
<a href="#l38.358"></a><span id="l38.358" class="difflineminus">-    {</span>
<a href="#l38.359"></a><span id="l38.359" class="difflineminus">-      pos++;</span>
<a href="#l38.360"></a><span id="l38.360" class="difflineminus">-      pData++;</span>
<a href="#l38.361"></a><span id="l38.361" class="difflineminus">-      fieldLen++;</span>
<a href="#l38.362"></a><span id="l38.362" class="difflineminus">-    }</span>
<a href="#l38.363"></a><span id="l38.363" class="difflineminus">-    type.Truncate();</span>
<a href="#l38.364"></a><span id="l38.364" class="difflineminus">-    if (fieldLen)</span>
<a href="#l38.365"></a><span id="l38.365" class="difflineminus">-      type.Append(pStart, fieldLen);</span>
<a href="#l38.366"></a><span id="l38.366" class="difflineminus">-    type.Trim(kWhitespace);</span>
<a href="#l38.367"></a><span id="l38.367" class="difflineminus">-    pos++;</span>
<a href="#l38.368"></a><span id="l38.368" class="difflineminus">-    pData++;</span>
<a href="#l38.369"></a><span id="l38.369" class="difflineminus">-    pStart = pData;</span>
<a href="#l38.370"></a><span id="l38.370" class="difflineminus">-    fieldLen = 0;</span>
<a href="#l38.371"></a><span id="l38.371" class="difflineminus">-    // Skip to next end of line, or ',' separator.</span>
<a href="#l38.372"></a><span id="l38.372" class="difflineminus">-    while ((pos &lt; len) &amp;&amp;</span>
<a href="#l38.373"></a><span id="l38.373" class="difflineminus">-           (*pData != nsCRT::CR) &amp;&amp; (*pData != nsCRT::LF) &amp;&amp; (*pData != ','))</span>
<a href="#l38.374"></a><span id="l38.374" class="difflineminus">-    {</span>
<a href="#l38.375"></a><span id="l38.375" class="difflineminus">-      pos++;</span>
<a href="#l38.376"></a><span id="l38.376" class="difflineminus">-      pData++;</span>
<a href="#l38.377"></a><span id="l38.377" class="difflineminus">-      fieldLen++;</span>
<a href="#l38.378"></a><span id="l38.378" class="difflineminus">-    }</span>
<a href="#l38.379"></a><span id="l38.379" class="difflineminus">-    flag.Truncate();</span>
<a href="#l38.380"></a><span id="l38.380" class="difflineminus">-    if (fieldLen)</span>
<a href="#l38.381"></a><span id="l38.381" class="difflineminus">-      flag.Append(pStart, fieldLen);</span>
<a href="#l38.382"></a><span id="l38.382" class="difflineminus">-    flag.Trim(kWhitespace);</span>
<a href="#l38.383"></a><span id="l38.383" class="difflineminus">-    // Skip over end of line(s).</span>
<a href="#l38.384"></a><span id="l38.384" class="difflineminus">-    while ((pos &lt; len) &amp;&amp; ((*pData == nsCRT::CR) || (*pData == nsCRT::LF)))</span>
<a href="#l38.385"></a><span id="l38.385" class="difflineminus">-    {</span>
<a href="#l38.386"></a><span id="l38.386" class="difflineminus">-      pos++;</span>
<a href="#l38.387"></a><span id="l38.387" class="difflineminus">-      pData++;</span>
<a href="#l38.388"></a><span id="l38.388" class="difflineminus">-    }</span>
<a href="#l38.389"></a><span id="l38.389" class="difflineminus">-</span>
<a href="#l38.390"></a><span id="l38.390" class="difflineminus">-    IMPORT_LOG2(&quot;name: %s, fName: %s\n&quot;, name.get(), fName.get());</span>
<a href="#l38.391"></a><span id="l38.391" class="difflineminus">-</span>
<a href="#l38.392"></a><span id="l38.392" class="difflineminus">-    if (!fName.IsEmpty() &amp;&amp; !name.IsEmpty() &amp;&amp; (type.Length() == 1))</span>
<a href="#l38.393"></a><span id="l38.393" class="difflineminus">-    {</span>
<a href="#l38.394"></a><span id="l38.394" class="difflineminus">-      rv = entry-&gt;SetNativeLeafName(fName);</span>
<a href="#l38.395"></a><span id="l38.395" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l38.396"></a><span id="l38.396" class="difflineminus">-      {</span>
<a href="#l38.397"></a><span id="l38.397" class="difflineminus">-        if (type.CharAt(0) == 'F')</span>
<a href="#l38.398"></a><span id="l38.398" class="difflineminus">-        {</span>
<a href="#l38.399"></a><span id="l38.399" class="difflineminus">-          isFolder = false;</span>
<a href="#l38.400"></a><span id="l38.400" class="difflineminus">-          entry-&gt;IsDirectory(&amp;isFolder);</span>
<a href="#l38.401"></a><span id="l38.401" class="difflineminus">-          if (isFolder)</span>
<a href="#l38.402"></a><span id="l38.402" class="difflineminus">-          {</span>
<a href="#l38.403"></a><span id="l38.403" class="difflineminus">-            rv = FoundMailFolder(entry, name.get(), pArray, pImport);</span>
<a href="#l38.404"></a><span id="l38.404" class="difflineminus">-            if (NS_SUCCEEDED(rv))</span>
<a href="#l38.405"></a><span id="l38.405" class="difflineminus">-            {</span>
<a href="#l38.406"></a><span id="l38.406" class="difflineminus">-              rv = ScanMailDir(entry, pArray, pImport);</span>
<a href="#l38.407"></a><span id="l38.407" class="difflineminus">-              if (NS_FAILED(rv))</span>
<a href="#l38.408"></a><span id="l38.408" class="difflineminus">-                IMPORT_LOG0(&quot;*** Error scanning mail directory\n&quot;);</span>
<a href="#l38.409"></a><span id="l38.409" class="difflineminus">-            }</span>
<a href="#l38.410"></a><span id="l38.410" class="difflineminus">-          }</span>
<a href="#l38.411"></a><span id="l38.411" class="difflineminus">-        }</span>
<a href="#l38.412"></a><span id="l38.412" class="difflineminus">-        else if ((type.CharAt(0) == 'M') || (type.CharAt(0) == 'S'))</span>
<a href="#l38.413"></a><span id="l38.413" class="difflineminus">-        {</span>
<a href="#l38.414"></a><span id="l38.414" class="difflineminus">-          isFile = false;</span>
<a href="#l38.415"></a><span id="l38.415" class="difflineminus">-          entry-&gt;IsFile(&amp;isFile);</span>
<a href="#l38.416"></a><span id="l38.416" class="difflineminus">-          if (isFile)</span>
<a href="#l38.417"></a><span id="l38.417" class="difflineminus">-            FoundMailbox(entry, name.get(), pArray, pImport);</span>
<a href="#l38.418"></a><span id="l38.418" class="difflineminus">-        }</span>
<a href="#l38.419"></a><span id="l38.419" class="difflineminus">-      }</span>
<a href="#l38.420"></a><span id="l38.420" class="difflineminus">-    }</span>
<a href="#l38.421"></a><span id="l38.421" class="difflineminus">-  }</span>
<a href="#l38.422"></a><span id="l38.422" class="difflineminus">-</span>
<a href="#l38.423"></a><span id="l38.423" class="difflineminus">-  return NS_OK;</span>
<a href="#l38.424"></a><span id="l38.424" class="difflineminus">-}</span>
<a href="#l38.425"></a><span id="l38.425" class="difflineminus">-</span>
<a href="#l38.426"></a><span id="l38.426" class="difflineminus">-</span>
<a href="#l38.427"></a><span id="l38.427" class="difflineminus">-nsresult nsEudoraWin32::FoundMailbox(nsIFile *mailFile, const char *pName, nsIMutableArray *pArray, nsIImportService *pImport)</span>
<a href="#l38.428"></a><span id="l38.428" class="difflineminus">-{</span>
<a href="#l38.429"></a><span id="l38.429" class="difflineminus">-  nsString displayName;</span>
<a href="#l38.430"></a><span id="l38.430" class="difflineminus">-  nsCOMPtr&lt;nsIImportMailboxDescriptor&gt; desc;</span>
<a href="#l38.431"></a><span id="l38.431" class="difflineminus">-  nsISupports * pInterface;</span>
<a href="#l38.432"></a><span id="l38.432" class="difflineminus">-</span>
<a href="#l38.433"></a><span id="l38.433" class="difflineminus">-  NS_CopyNativeToUnicode(nsDependentCString(pName), displayName);</span>
<a href="#l38.434"></a><span id="l38.434" class="difflineminus">-</span>
<a href="#l38.435"></a><span id="l38.435" class="difflineminus">-#ifdef IMPORT_DEBUG</span>
<a href="#l38.436"></a><span id="l38.436" class="difflineminus">-  nsAutoCString path;</span>
<a href="#l38.437"></a><span id="l38.437" class="difflineminus">-  mailFile-&gt;GetNativePath(path);</span>
<a href="#l38.438"></a><span id="l38.438" class="difflineminus">-  if (!path.IsEmpty())</span>
<a href="#l38.439"></a><span id="l38.439" class="difflineminus">-    IMPORT_LOG2(&quot;Found eudora mailbox, %s: %s\n&quot;, path.get(), pName);</span>
<a href="#l38.440"></a><span id="l38.440" class="difflineminus">-  else</span>
<a href="#l38.441"></a><span id="l38.441" class="difflineminus">-    IMPORT_LOG1(&quot;Found eudora mailbox, %s\n&quot;, pName);</span>
<a href="#l38.442"></a><span id="l38.442" class="difflineminus">-  IMPORT_LOG1(&quot;\tm_depth = %d\n&quot;, (int)m_depth);</span>
<a href="#l38.443"></a><span id="l38.443" class="difflineminus">-#endif</span>
<a href="#l38.444"></a><span id="l38.444" class="difflineminus">-</span>
<a href="#l38.445"></a><span id="l38.445" class="difflineminus">-  nsresult rv = pImport-&gt;CreateNewMailboxDescriptor(getter_AddRefs(desc));</span>
<a href="#l38.446"></a><span id="l38.446" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l38.447"></a><span id="l38.447" class="difflineminus">-  {</span>
<a href="#l38.448"></a><span id="l38.448" class="difflineminus">-    int64_t sz = 0;</span>
<a href="#l38.449"></a><span id="l38.449" class="difflineminus">-    mailFile-&gt;GetFileSize(&amp;sz);</span>
<a href="#l38.450"></a><span id="l38.450" class="difflineminus">-    desc-&gt;SetDisplayName(displayName.get());</span>
<a href="#l38.451"></a><span id="l38.451" class="difflineminus">-    desc-&gt;SetDepth(m_depth);</span>
<a href="#l38.452"></a><span id="l38.452" class="difflineminus">-    desc-&gt;SetSize(sz);</span>
<a href="#l38.453"></a><span id="l38.453" class="difflineminus">-    nsCOMPtr &lt;nsIFile&gt; pFile = nullptr;</span>
<a href="#l38.454"></a><span id="l38.454" class="difflineminus">-    desc-&gt;GetFile(getter_AddRefs(pFile));</span>
<a href="#l38.455"></a><span id="l38.455" class="difflineminus">-    if (pFile)</span>
<a href="#l38.456"></a><span id="l38.456" class="difflineminus">-    {</span>
<a href="#l38.457"></a><span id="l38.457" class="difflineminus">-      pFile-&gt;InitWithFile(mailFile);</span>
<a href="#l38.458"></a><span id="l38.458" class="difflineminus">-    }</span>
<a href="#l38.459"></a><span id="l38.459" class="difflineminus">-    rv = desc-&gt;QueryInterface(kISupportsIID, (void **) &amp;pInterface);</span>
<a href="#l38.460"></a><span id="l38.460" class="difflineminus">-    pArray-&gt;AppendElement(pInterface, false);</span>
<a href="#l38.461"></a><span id="l38.461" class="difflineminus">-    pInterface-&gt;Release();</span>
<a href="#l38.462"></a><span id="l38.462" class="difflineminus">-  }</span>
<a href="#l38.463"></a><span id="l38.463" class="difflineminus">-</span>
<a href="#l38.464"></a><span id="l38.464" class="difflineminus">-  return NS_OK;</span>
<a href="#l38.465"></a><span id="l38.465" class="difflineminus">-}</span>
<a href="#l38.466"></a><span id="l38.466" class="difflineminus">-</span>
<a href="#l38.467"></a><span id="l38.467" class="difflineminus">-</span>
<a href="#l38.468"></a><span id="l38.468" class="difflineminus">-nsresult nsEudoraWin32::FoundMailFolder(nsIFile *mailFolder, const char *pName, nsIMutableArray *pArray, nsIImportService *pImport)</span>
<a href="#l38.469"></a><span id="l38.469" class="difflineminus">-{</span>
<a href="#l38.470"></a><span id="l38.470" class="difflineminus">-  nsString                displayName;</span>
<a href="#l38.471"></a><span id="l38.471" class="difflineminus">-  nsCOMPtr&lt;nsIImportMailboxDescriptor&gt;  desc;</span>
<a href="#l38.472"></a><span id="l38.472" class="difflineminus">-  nsISupports *              pInterface;</span>
<a href="#l38.473"></a><span id="l38.473" class="difflineminus">-</span>
<a href="#l38.474"></a><span id="l38.474" class="difflineminus">-  NS_CopyNativeToUnicode(nsDependentCString(pName), displayName);</span>
<a href="#l38.475"></a><span id="l38.475" class="difflineminus">-</span>
<a href="#l38.476"></a><span id="l38.476" class="difflineminus">-#ifdef IMPORT_DEBUG</span>
<a href="#l38.477"></a><span id="l38.477" class="difflineminus">-  nsAutoCString path;</span>
<a href="#l38.478"></a><span id="l38.478" class="difflineminus">-  mailFolder-&gt;GetNativePath(path);</span>
<a href="#l38.479"></a><span id="l38.479" class="difflineminus">-  if (!path.IsEmpty())</span>
<a href="#l38.480"></a><span id="l38.480" class="difflineminus">-    IMPORT_LOG2(&quot;Found eudora folder, %s: %s\n&quot;, path.get(), pName);</span>
<a href="#l38.481"></a><span id="l38.481" class="difflineminus">-  else</span>
<a href="#l38.482"></a><span id="l38.482" class="difflineminus">-    IMPORT_LOG1(&quot;Found eudora folder, %s\n&quot;, pName);</span>
<a href="#l38.483"></a><span id="l38.483" class="difflineminus">-  IMPORT_LOG1(&quot;\tm_depth = %d\n&quot;, (int)m_depth);</span>
<a href="#l38.484"></a><span id="l38.484" class="difflineminus">-#endif</span>
<a href="#l38.485"></a><span id="l38.485" class="difflineminus">-</span>
<a href="#l38.486"></a><span id="l38.486" class="difflineminus">-  nsresult rv = pImport-&gt;CreateNewMailboxDescriptor(getter_AddRefs(desc));</span>
<a href="#l38.487"></a><span id="l38.487" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l38.488"></a><span id="l38.488" class="difflineminus">-  {</span>
<a href="#l38.489"></a><span id="l38.489" class="difflineminus">-    uint32_t    sz = 0;</span>
<a href="#l38.490"></a><span id="l38.490" class="difflineminus">-    desc-&gt;SetDisplayName(displayName.get());</span>
<a href="#l38.491"></a><span id="l38.491" class="difflineminus">-    desc-&gt;SetDepth(m_depth);</span>
<a href="#l38.492"></a><span id="l38.492" class="difflineminus">-    desc-&gt;SetSize(sz);</span>
<a href="#l38.493"></a><span id="l38.493" class="difflineminus">-    nsCOMPtr &lt;nsIFile&gt; pFile = nullptr;</span>
<a href="#l38.494"></a><span id="l38.494" class="difflineminus">-    desc-&gt;GetFile(getter_AddRefs(pFile));</span>
<a href="#l38.495"></a><span id="l38.495" class="difflineminus">-    if (pFile)</span>
<a href="#l38.496"></a><span id="l38.496" class="difflineminus">-    {</span>
<a href="#l38.497"></a><span id="l38.497" class="difflineminus">-      pFile-&gt;InitWithFile(mailFolder);</span>
<a href="#l38.498"></a><span id="l38.498" class="difflineminus">-    }</span>
<a href="#l38.499"></a><span id="l38.499" class="difflineminus">-    rv = desc-&gt;QueryInterface(kISupportsIID, (void **) &amp;pInterface);</span>
<a href="#l38.500"></a><span id="l38.500" class="difflineminus">-    pArray-&gt;AppendElement(pInterface, false);</span>
<a href="#l38.501"></a><span id="l38.501" class="difflineminus">-    pInterface-&gt;Release();</span>
<a href="#l38.502"></a><span id="l38.502" class="difflineminus">-  }</span>
<a href="#l38.503"></a><span id="l38.503" class="difflineminus">-</span>
<a href="#l38.504"></a><span id="l38.504" class="difflineminus">-  return NS_OK;</span>
<a href="#l38.505"></a><span id="l38.505" class="difflineminus">-}</span>
<a href="#l38.506"></a><span id="l38.506" class="difflineminus">-</span>
<a href="#l38.507"></a><span id="l38.507" class="difflineminus">-</span>
<a href="#l38.508"></a><span id="l38.508" class="difflineminus">-nsresult nsEudoraWin32::FindTOCFile(nsIFile *pMailFile, nsIFile **ppTOCFile, bool *pDeleteToc)</span>
<a href="#l38.509"></a><span id="l38.509" class="difflineminus">-{</span>
<a href="#l38.510"></a><span id="l38.510" class="difflineminus">-  nsresult    rv;</span>
<a href="#l38.511"></a><span id="l38.511" class="difflineminus">-  nsAutoCString  leaf;</span>
<a href="#l38.512"></a><span id="l38.512" class="difflineminus">-</span>
<a href="#l38.513"></a><span id="l38.513" class="difflineminus">-  *pDeleteToc = false;</span>
<a href="#l38.514"></a><span id="l38.514" class="difflineminus">-  *ppTOCFile = nullptr;</span>
<a href="#l38.515"></a><span id="l38.515" class="difflineminus">-  rv = pMailFile-&gt;GetNativeLeafName(leaf);</span>
<a href="#l38.516"></a><span id="l38.516" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l38.517"></a><span id="l38.517" class="difflineminus">-    return rv;</span>
<a href="#l38.518"></a><span id="l38.518" class="difflineminus">-  rv = pMailFile-&gt;GetParent(ppTOCFile);</span>
<a href="#l38.519"></a><span id="l38.519" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l38.520"></a><span id="l38.520" class="difflineminus">-    return rv;</span>
<a href="#l38.521"></a><span id="l38.521" class="difflineminus">-</span>
<a href="#l38.522"></a><span id="l38.522" class="difflineminus">-  nsCString  name;</span>
<a href="#l38.523"></a><span id="l38.523" class="difflineminus">-  if ((leaf.Length() &gt; 4) &amp;&amp; (leaf.CharAt(leaf.Length() - 4) == '.'))</span>
<a href="#l38.524"></a><span id="l38.524" class="difflineminus">-    name = StringHead(leaf, leaf.Length() - 4);</span>
<a href="#l38.525"></a><span id="l38.525" class="difflineminus">-  else</span>
<a href="#l38.526"></a><span id="l38.526" class="difflineminus">-    name = leaf;</span>
<a href="#l38.527"></a><span id="l38.527" class="difflineminus">-  name.Append(&quot;.toc&quot;);</span>
<a href="#l38.528"></a><span id="l38.528" class="difflineminus">-  rv = (*ppTOCFile)-&gt;AppendNative(name);</span>
<a href="#l38.529"></a><span id="l38.529" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l38.530"></a><span id="l38.530" class="difflineminus">-    return rv;</span>
<a href="#l38.531"></a><span id="l38.531" class="difflineminus">-</span>
<a href="#l38.532"></a><span id="l38.532" class="difflineminus">-  bool    exists = false;</span>
<a href="#l38.533"></a><span id="l38.533" class="difflineminus">-  rv = (*ppTOCFile)-&gt;Exists(&amp;exists);</span>
<a href="#l38.534"></a><span id="l38.534" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l38.535"></a><span id="l38.535" class="difflineminus">-    return rv;</span>
<a href="#l38.536"></a><span id="l38.536" class="difflineminus">-  bool    isFile = false;</span>
<a href="#l38.537"></a><span id="l38.537" class="difflineminus">-  rv = (*ppTOCFile)-&gt;IsFile(&amp;isFile);</span>
<a href="#l38.538"></a><span id="l38.538" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l38.539"></a><span id="l38.539" class="difflineminus">-    return rv;</span>
<a href="#l38.540"></a><span id="l38.540" class="difflineminus">-  if (exists &amp;&amp; isFile)</span>
<a href="#l38.541"></a><span id="l38.541" class="difflineminus">-    return NS_OK;</span>
<a href="#l38.542"></a><span id="l38.542" class="difflineminus">-</span>
<a href="#l38.543"></a><span id="l38.543" class="difflineminus">-  return NS_ERROR_FAILURE;</span>
<a href="#l38.544"></a><span id="l38.544" class="difflineminus">-}</span>
<a href="#l38.545"></a><span id="l38.545" class="difflineminus">-</span>
<a href="#l38.546"></a><span id="l38.546" class="difflineminus">-</span>
<a href="#l38.547"></a><span id="l38.547" class="difflineminus">-bool nsEudoraWin32::ImportSettings(nsIFile *pIniFile, nsIMsgAccount **localMailAccount)</span>
<a href="#l38.548"></a><span id="l38.548" class="difflineminus">-{</span>
<a href="#l38.549"></a><span id="l38.549" class="difflineminus">-  bool      result = false;</span>
<a href="#l38.550"></a><span id="l38.550" class="difflineminus">-  nsresult  rv;</span>
<a href="#l38.551"></a><span id="l38.551" class="difflineminus">-</span>
<a href="#l38.552"></a><span id="l38.552" class="difflineminus">-  nsCOMPtr&lt;nsIMsgAccountManager&gt; accMgr =</span>
<a href="#l38.553"></a><span id="l38.553" class="difflineminus">-           do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l38.554"></a><span id="l38.554" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l38.555"></a><span id="l38.555" class="difflineminus">-  {</span>
<a href="#l38.556"></a><span id="l38.556" class="difflineminus">-    IMPORT_LOG0(&quot;*** Failed to create a account manager!\n&quot;);</span>
<a href="#l38.557"></a><span id="l38.557" class="difflineminus">-    return false;</span>
<a href="#l38.558"></a><span id="l38.558" class="difflineminus">-  }</span>
<a href="#l38.559"></a><span id="l38.559" class="difflineminus">-</span>
<a href="#l38.560"></a><span id="l38.560" class="difflineminus">-  // Eudora info is arranged by key, 1 for the default, then persona's for additional</span>
<a href="#l38.561"></a><span id="l38.561" class="difflineminus">-  // accounts.</span>
<a href="#l38.562"></a><span id="l38.562" class="difflineminus">-  // Start with the first one, then do each persona</span>
<a href="#l38.563"></a><span id="l38.563" class="difflineminus">-  nsCString iniPath;</span>
<a href="#l38.564"></a><span id="l38.564" class="difflineminus">-  pIniFile-&gt;GetNativePath(iniPath);</span>
<a href="#l38.565"></a><span id="l38.565" class="difflineminus">-  if (iniPath.IsEmpty())</span>
<a href="#l38.566"></a><span id="l38.566" class="difflineminus">-    return false;</span>
<a href="#l38.567"></a><span id="l38.567" class="difflineminus">-  UINT       valInt;</span>
<a href="#l38.568"></a><span id="l38.568" class="difflineminus">-  SimpleBufferTonyRCopiedOnce  section;</span>
<a href="#l38.569"></a><span id="l38.569" class="difflineminus">-  DWORD      sSize;</span>
<a href="#l38.570"></a><span id="l38.570" class="difflineminus">-  DWORD      sOffset = 0;</span>
<a href="#l38.571"></a><span id="l38.571" class="difflineminus">-  DWORD      start;</span>
<a href="#l38.572"></a><span id="l38.572" class="difflineminus">-  nsCString  sectionName(&quot;Settings&quot;);</span>
<a href="#l38.573"></a><span id="l38.573" class="difflineminus">-  int        popCount = 0;</span>
<a href="#l38.574"></a><span id="l38.574" class="difflineminus">-  int        accounts = 0;</span>
<a href="#l38.575"></a><span id="l38.575" class="difflineminus">-</span>
<a href="#l38.576"></a><span id="l38.576" class="difflineminus">-  DWORD  allocSize = 0;</span>
<a href="#l38.577"></a><span id="l38.577" class="difflineminus">-  do</span>
<a href="#l38.578"></a><span id="l38.578" class="difflineminus">-  {</span>
<a href="#l38.579"></a><span id="l38.579" class="difflineminus">-    allocSize += 2048;</span>
<a href="#l38.580"></a><span id="l38.580" class="difflineminus">-    section.Allocate(allocSize);</span>
<a href="#l38.581"></a><span id="l38.581" class="difflineminus">-    sSize = ::GetPrivateProfileSection(&quot;Personalities&quot;, section.m_pBuffer, allocSize, iniPath.get());</span>
<a href="#l38.582"></a><span id="l38.582" class="difflineminus">-  } while (sSize == (allocSize - 2));</span>
<a href="#l38.583"></a><span id="l38.583" class="difflineminus">-</span>
<a href="#l38.584"></a><span id="l38.584" class="difflineminus">-  nsIMsgAccount *  pAccount;</span>
<a href="#l38.585"></a><span id="l38.585" class="difflineminus">-</span>
<a href="#l38.586"></a><span id="l38.586" class="difflineminus">-  do</span>
<a href="#l38.587"></a><span id="l38.587" class="difflineminus">-  {</span>
<a href="#l38.588"></a><span id="l38.588" class="difflineminus">-    if (!sectionName.IsEmpty())</span>
<a href="#l38.589"></a><span id="l38.589" class="difflineminus">-    {</span>
<a href="#l38.590"></a><span id="l38.590" class="difflineminus">-      pAccount = nullptr;</span>
<a href="#l38.591"></a><span id="l38.591" class="difflineminus">-      valInt = ::GetPrivateProfileInt(sectionName.get(), &quot;UsesPOP&quot;, 1, iniPath.get());</span>
<a href="#l38.592"></a><span id="l38.592" class="difflineminus">-      if (valInt)</span>
<a href="#l38.593"></a><span id="l38.593" class="difflineminus">-      {</span>
<a href="#l38.594"></a><span id="l38.594" class="difflineminus">-        // This is a POP account</span>
<a href="#l38.595"></a><span id="l38.595" class="difflineminus">-        if (BuildPOPAccount(accMgr, sectionName.get(), iniPath.get(), &amp;pAccount))</span>
<a href="#l38.596"></a><span id="l38.596" class="difflineminus">-        {</span>
<a href="#l38.597"></a><span id="l38.597" class="difflineminus">-          accounts++;</span>
<a href="#l38.598"></a><span id="l38.598" class="difflineminus">-          popCount++;</span>
<a href="#l38.599"></a><span id="l38.599" class="difflineminus">-          if (popCount &gt; 1)</span>
<a href="#l38.600"></a><span id="l38.600" class="difflineminus">-          {</span>
<a href="#l38.601"></a><span id="l38.601" class="difflineminus">-            if (localMailAccount &amp;&amp; *localMailAccount)</span>
<a href="#l38.602"></a><span id="l38.602" class="difflineminus">-              NS_RELEASE(*localMailAccount);</span>
<a href="#l38.603"></a><span id="l38.603" class="difflineminus">-          }</span>
<a href="#l38.604"></a><span id="l38.604" class="difflineminus">-          else if (localMailAccount)</span>
<a href="#l38.605"></a><span id="l38.605" class="difflineminus">-          {</span>
<a href="#l38.606"></a><span id="l38.606" class="difflineminus">-            *localMailAccount = pAccount;</span>
<a href="#l38.607"></a><span id="l38.607" class="difflineminus">-            NS_IF_ADDREF(pAccount);</span>
<a href="#l38.608"></a><span id="l38.608" class="difflineminus">-          }</span>
<a href="#l38.609"></a><span id="l38.609" class="difflineminus">-        }</span>
<a href="#l38.610"></a><span id="l38.610" class="difflineminus">-      }</span>
<a href="#l38.611"></a><span id="l38.611" class="difflineminus">-      else</span>
<a href="#l38.612"></a><span id="l38.612" class="difflineminus">-      {</span>
<a href="#l38.613"></a><span id="l38.613" class="difflineminus">-        valInt = ::GetPrivateProfileInt(sectionName.get(), &quot;UsesIMAP&quot;, 0, iniPath.get());</span>
<a href="#l38.614"></a><span id="l38.614" class="difflineminus">-        if (valInt)</span>
<a href="#l38.615"></a><span id="l38.615" class="difflineminus">-        {</span>
<a href="#l38.616"></a><span id="l38.616" class="difflineminus">-          // This is an IMAP account</span>
<a href="#l38.617"></a><span id="l38.617" class="difflineminus">-          if (BuildIMAPAccount(accMgr, sectionName.get(), iniPath.get(), &amp;pAccount))</span>
<a href="#l38.618"></a><span id="l38.618" class="difflineminus">-            accounts++;</span>
<a href="#l38.619"></a><span id="l38.619" class="difflineminus">-        }</span>
<a href="#l38.620"></a><span id="l38.620" class="difflineminus">-      }</span>
<a href="#l38.621"></a><span id="l38.621" class="difflineminus">-      if (pAccount &amp;&amp; (sOffset == 0))</span>
<a href="#l38.622"></a><span id="l38.622" class="difflineminus">-        accMgr-&gt;SetDefaultAccount(pAccount);</span>
<a href="#l38.623"></a><span id="l38.623" class="difflineminus">-</span>
<a href="#l38.624"></a><span id="l38.624" class="difflineminus">-      NS_IF_RELEASE(pAccount);</span>
<a href="#l38.625"></a><span id="l38.625" class="difflineminus">-    }</span>
<a href="#l38.626"></a><span id="l38.626" class="difflineminus">-</span>
<a href="#l38.627"></a><span id="l38.627" class="difflineminus">-    sectionName.Truncate();</span>
<a href="#l38.628"></a><span id="l38.628" class="difflineminus">-    while ((sOffset &lt; sSize) &amp;&amp; (section.m_pBuffer[sOffset] != '='))</span>
<a href="#l38.629"></a><span id="l38.629" class="difflineminus">-      sOffset++;</span>
<a href="#l38.630"></a><span id="l38.630" class="difflineminus">-    sOffset++;</span>
<a href="#l38.631"></a><span id="l38.631" class="difflineminus">-    start = sOffset;</span>
<a href="#l38.632"></a><span id="l38.632" class="difflineminus">-    while ((sOffset &lt; sSize) &amp;&amp; (section.m_pBuffer[sOffset] != 0))</span>
<a href="#l38.633"></a><span id="l38.633" class="difflineminus">-      sOffset++;</span>
<a href="#l38.634"></a><span id="l38.634" class="difflineminus">-    if (sOffset &gt; start)</span>
<a href="#l38.635"></a><span id="l38.635" class="difflineminus">-    {</span>
<a href="#l38.636"></a><span id="l38.636" class="difflineminus">-      sectionName.Append(section.m_pBuffer + start, sOffset - start);</span>
<a href="#l38.637"></a><span id="l38.637" class="difflineminus">-      sectionName.Trim(kWhitespace);</span>
<a href="#l38.638"></a><span id="l38.638" class="difflineminus">-    }</span>
<a href="#l38.639"></a><span id="l38.639" class="difflineminus">-</span>
<a href="#l38.640"></a><span id="l38.640" class="difflineminus">-  } while (sOffset &lt; sSize);</span>
<a href="#l38.641"></a><span id="l38.641" class="difflineminus">-</span>
<a href="#l38.642"></a><span id="l38.642" class="difflineminus">-  // Now save the new acct info to pref file.</span>
<a href="#l38.643"></a><span id="l38.643" class="difflineminus">-  rv = accMgr-&gt;SaveAccountInfo();</span>
<a href="#l38.644"></a><span id="l38.644" class="difflineminus">-  NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Can't save account info to pref file&quot;);</span>
<a href="#l38.645"></a><span id="l38.645" class="difflineminus">-</span>
<a href="#l38.646"></a><span id="l38.646" class="difflineminus">-</span>
<a href="#l38.647"></a><span id="l38.647" class="difflineminus">-  return accounts != 0;</span>
<a href="#l38.648"></a><span id="l38.648" class="difflineminus">-}</span>
<a href="#l38.649"></a><span id="l38.649" class="difflineminus">-</span>
<a href="#l38.650"></a><span id="l38.650" class="difflineminus">-bool nsEudoraWin32::FindFiltersFile(nsIFile **pFiltersFile)</span>
<a href="#l38.651"></a><span id="l38.651" class="difflineminus">-{</span>
<a href="#l38.652"></a><span id="l38.652" class="difflineminus">-  bool result = FindEudoraLocation(pFiltersFile, false);</span>
<a href="#l38.653"></a><span id="l38.653" class="difflineminus">-</span>
<a href="#l38.654"></a><span id="l38.654" class="difflineminus">-  if (result)</span>
<a href="#l38.655"></a><span id="l38.655" class="difflineminus">-  {</span>
<a href="#l38.656"></a><span id="l38.656" class="difflineminus">-    (*pFiltersFile)-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;Filters.pce&quot;));</span>
<a href="#l38.657"></a><span id="l38.657" class="difflineminus">-    (*pFiltersFile)-&gt;IsFile(&amp;result);</span>
<a href="#l38.658"></a><span id="l38.658" class="difflineminus">-  }</span>
<a href="#l38.659"></a><span id="l38.659" class="difflineminus">-</span>
<a href="#l38.660"></a><span id="l38.660" class="difflineminus">-  return result;</span>
<a href="#l38.661"></a><span id="l38.661" class="difflineminus">-}</span>
<a href="#l38.662"></a><span id="l38.662" class="difflineminus">-</span>
<a href="#l38.663"></a><span id="l38.663" class="difflineminus">-bool nsEudoraWin32::GetMailboxNameHierarchy(const nsACString&amp; pEudoraLocation, const char* pEudoraFilePath, nsCString&amp; nameHierarchy)</span>
<a href="#l38.664"></a><span id="l38.664" class="difflineminus">-{</span>
<a href="#l38.665"></a><span id="l38.665" class="difflineminus">-  if (pEudoraLocation.IsEmpty() || !pEudoraFilePath || !*pEudoraFilePath)</span>
<a href="#l38.666"></a><span id="l38.666" class="difflineminus">-    return false;</span>
<a href="#l38.667"></a><span id="l38.667" class="difflineminus">-</span>
<a href="#l38.668"></a><span id="l38.668" class="difflineminus">-  nsresult rv;</span>
<a href="#l38.669"></a><span id="l38.669" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; descMap = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID);</span>
<a href="#l38.670"></a><span id="l38.670" class="difflineminus">-</span>
<a href="#l38.671"></a><span id="l38.671" class="difflineminus">-  rv = descMap-&gt;InitWithNativePath(pEudoraLocation);</span>
<a href="#l38.672"></a><span id="l38.672" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l38.673"></a><span id="l38.673" class="difflineminus">-  rv = descMap-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;descmap.pce&quot;));</span>
<a href="#l38.674"></a><span id="l38.674" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l38.675"></a><span id="l38.675" class="difflineminus">-</span>
<a href="#l38.676"></a><span id="l38.676" class="difflineminus">-  nsCOMPtr &lt;nsIInputStream&gt; inputStream;</span>
<a href="#l38.677"></a><span id="l38.677" class="difflineminus">-  rv = NS_NewLocalFileInputStream(getter_AddRefs(inputStream), descMap);</span>
<a href="#l38.678"></a><span id="l38.678" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l38.679"></a><span id="l38.679" class="difflineminus">-</span>
<a href="#l38.680"></a><span id="l38.680" class="difflineminus">-  nsCOMPtr&lt;nsILineInputStream&gt; lineStream(do_QueryInterface(inputStream, &amp;rv));</span>
<a href="#l38.681"></a><span id="l38.681" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l38.682"></a><span id="l38.682" class="difflineminus">-</span>
<a href="#l38.683"></a><span id="l38.683" class="difflineminus">-  int32_t pathLength;</span>
<a href="#l38.684"></a><span id="l38.684" class="difflineminus">-  const char* backslash = strchr(pEudoraFilePath, '\\');</span>
<a href="#l38.685"></a><span id="l38.685" class="difflineminus">-  if (backslash)</span>
<a href="#l38.686"></a><span id="l38.686" class="difflineminus">-    pathLength = backslash - pEudoraFilePath;</span>
<a href="#l38.687"></a><span id="l38.687" class="difflineminus">-  else</span>
<a href="#l38.688"></a><span id="l38.688" class="difflineminus">-    pathLength = strlen(pEudoraFilePath);</span>
<a href="#l38.689"></a><span id="l38.689" class="difflineminus">-</span>
<a href="#l38.690"></a><span id="l38.690" class="difflineminus">-  bool more = true;</span>
<a href="#l38.691"></a><span id="l38.691" class="difflineminus">-  nsAutoCString buf;</span>
<a href="#l38.692"></a><span id="l38.692" class="difflineminus">-  while (more)</span>
<a href="#l38.693"></a><span id="l38.693" class="difflineminus">-  {</span>
<a href="#l38.694"></a><span id="l38.694" class="difflineminus">-    rv = lineStream-&gt;ReadLine(buf, &amp;more);</span>
<a href="#l38.695"></a><span id="l38.695" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l38.696"></a><span id="l38.696" class="difflineminus">-</span>
<a href="#l38.697"></a><span id="l38.697" class="difflineminus">-    int32_t iNameEnd = buf.FindChar(',');</span>
<a href="#l38.698"></a><span id="l38.698" class="difflineminus">-    if (iNameEnd &lt; 0)</span>
<a href="#l38.699"></a><span id="l38.699" class="difflineminus">-      continue;</span>
<a href="#l38.700"></a><span id="l38.700" class="difflineminus">-    const nsACString&amp; name = Substring(buf, 0, iNameEnd);</span>
<a href="#l38.701"></a><span id="l38.701" class="difflineminus">-    int32_t iPathEnd = buf.FindChar(',', iNameEnd + 1);</span>
<a href="#l38.702"></a><span id="l38.702" class="difflineminus">-    if (iPathEnd &lt; 0)</span>
<a href="#l38.703"></a><span id="l38.703" class="difflineminus">-      continue;</span>
<a href="#l38.704"></a><span id="l38.704" class="difflineminus">-    const nsACString&amp; path = Substring(buf, iNameEnd + 1, iPathEnd - iNameEnd - 1);</span>
<a href="#l38.705"></a><span id="l38.705" class="difflineminus">-    const char type = buf[iPathEnd + 1];</span>
<a href="#l38.706"></a><span id="l38.706" class="difflineminus">-    if (strnicmp(path.BeginReading(), pEudoraFilePath, pathLength) == 0 &amp;&amp; path.Length() == pathLength)</span>
<a href="#l38.707"></a><span id="l38.707" class="difflineminus">-    {</span>
<a href="#l38.708"></a><span id="l38.708" class="difflineminus">-      nameHierarchy += &quot;\\&quot;;</span>
<a href="#l38.709"></a><span id="l38.709" class="difflineminus">-      nameHierarchy += name;</span>
<a href="#l38.710"></a><span id="l38.710" class="difflineminus">-      if (pEudoraFilePath[pathLength] == 0)</span>
<a href="#l38.711"></a><span id="l38.711" class="difflineminus">-        return true;</span>
<a href="#l38.712"></a><span id="l38.712" class="difflineminus">-      if (type != 'F')</span>
<a href="#l38.713"></a><span id="l38.713" class="difflineminus">-      {</span>
<a href="#l38.714"></a><span id="l38.714" class="difflineminus">-        // Something went wrong.  We've matched a mailbox, but the</span>
<a href="#l38.715"></a><span id="l38.715" class="difflineminus">-        // hierarchical name says we've got more folders to traverse.</span>
<a href="#l38.716"></a><span id="l38.716" class="difflineminus">-        return false;</span>
<a href="#l38.717"></a><span id="l38.717" class="difflineminus">-      }</span>
<a href="#l38.718"></a><span id="l38.718" class="difflineminus">-</span>
<a href="#l38.719"></a><span id="l38.719" class="difflineminus">-      nsCString newLocation(pEudoraLocation);</span>
<a href="#l38.720"></a><span id="l38.720" class="difflineminus">-      newLocation += '\\';</span>
<a href="#l38.721"></a><span id="l38.721" class="difflineminus">-      newLocation += path;</span>
<a href="#l38.722"></a><span id="l38.722" class="difflineminus">-      return GetMailboxNameHierarchy(newLocation, pEudoraFilePath + pathLength + 1, nameHierarchy);</span>
<a href="#l38.723"></a><span id="l38.723" class="difflineminus">-    }</span>
<a href="#l38.724"></a><span id="l38.724" class="difflineminus">-  }</span>
<a href="#l38.725"></a><span id="l38.725" class="difflineminus">-</span>
<a href="#l38.726"></a><span id="l38.726" class="difflineminus">-  return false;</span>
<a href="#l38.727"></a><span id="l38.727" class="difflineminus">-}</span>
<a href="#l38.728"></a><span id="l38.728" class="difflineminus">-</span>
<a href="#l38.729"></a><span id="l38.729" class="difflineminus">-// maximium size of settings strings</span>
<a href="#l38.730"></a><span id="l38.730" class="difflineminus">-#define  kIniValueSize    384</span>
<a href="#l38.731"></a><span id="l38.731" class="difflineminus">-</span>
<a href="#l38.732"></a><span id="l38.732" class="difflineminus">-</span>
<a href="#l38.733"></a><span id="l38.733" class="difflineminus">-void nsEudoraWin32::GetServerAndUserName(const char *pSection, const char *pIni, nsCString&amp; serverName, nsCString&amp; userName, char *pBuff)</span>
<a href="#l38.734"></a><span id="l38.734" class="difflineminus">-{</span>
<a href="#l38.735"></a><span id="l38.735" class="difflineminus">-  DWORD    valSize;</span>
<a href="#l38.736"></a><span id="l38.736" class="difflineminus">-  int      idx;</span>
<a href="#l38.737"></a><span id="l38.737" class="difflineminus">-  nsCString  tStr;</span>
<a href="#l38.738"></a><span id="l38.738" class="difflineminus">-</span>
<a href="#l38.739"></a><span id="l38.739" class="difflineminus">-  serverName.Truncate();</span>
<a href="#l38.740"></a><span id="l38.740" class="difflineminus">-  userName.Truncate();</span>
<a href="#l38.741"></a><span id="l38.741" class="difflineminus">-</span>
<a href="#l38.742"></a><span id="l38.742" class="difflineminus">-  valSize = ::GetPrivateProfileString(pSection, &quot;PopServer&quot;, &quot;&quot;, pBuff, kIniValueSize, pIni);</span>
<a href="#l38.743"></a><span id="l38.743" class="difflineminus">-  if (valSize)</span>
<a href="#l38.744"></a><span id="l38.744" class="difflineminus">-    serverName = pBuff;</span>
<a href="#l38.745"></a><span id="l38.745" class="difflineminus">-  else</span>
<a href="#l38.746"></a><span id="l38.746" class="difflineminus">-  {</span>
<a href="#l38.747"></a><span id="l38.747" class="difflineminus">-    valSize = ::GetPrivateProfileString(pSection, &quot;POPAccount&quot;, &quot;&quot;, pBuff, kIniValueSize, pIni);</span>
<a href="#l38.748"></a><span id="l38.748" class="difflineminus">-    if (valSize)</span>
<a href="#l38.749"></a><span id="l38.749" class="difflineminus">-    {</span>
<a href="#l38.750"></a><span id="l38.750" class="difflineminus">-      serverName = pBuff;</span>
<a href="#l38.751"></a><span id="l38.751" class="difflineminus">-      idx = serverName.FindChar('@');</span>
<a href="#l38.752"></a><span id="l38.752" class="difflineminus">-      if (idx != -1)</span>
<a href="#l38.753"></a><span id="l38.753" class="difflineminus">-        serverName = Substring(serverName, idx + 1);</span>
<a href="#l38.754"></a><span id="l38.754" class="difflineminus">-    }</span>
<a href="#l38.755"></a><span id="l38.755" class="difflineminus">-  }</span>
<a href="#l38.756"></a><span id="l38.756" class="difflineminus">-  valSize = ::GetPrivateProfileString(pSection, &quot;LoginName&quot;, &quot;&quot;, pBuff, kIniValueSize, pIni);</span>
<a href="#l38.757"></a><span id="l38.757" class="difflineminus">-  if (valSize)</span>
<a href="#l38.758"></a><span id="l38.758" class="difflineminus">-    userName = pBuff;</span>
<a href="#l38.759"></a><span id="l38.759" class="difflineminus">-  else</span>
<a href="#l38.760"></a><span id="l38.760" class="difflineminus">-  {</span>
<a href="#l38.761"></a><span id="l38.761" class="difflineminus">-    valSize = ::GetPrivateProfileString(pSection, &quot;POPAccount&quot;, &quot;&quot;, pBuff, kIniValueSize, pIni);</span>
<a href="#l38.762"></a><span id="l38.762" class="difflineminus">-    if (valSize)</span>
<a href="#l38.763"></a><span id="l38.763" class="difflineminus">-    {</span>
<a href="#l38.764"></a><span id="l38.764" class="difflineminus">-      userName = pBuff;</span>
<a href="#l38.765"></a><span id="l38.765" class="difflineminus">-      idx = userName.FindChar('@');</span>
<a href="#l38.766"></a><span id="l38.766" class="difflineminus">-      if (idx != -1)</span>
<a href="#l38.767"></a><span id="l38.767" class="difflineminus">-        userName.SetLength(idx);</span>
<a href="#l38.768"></a><span id="l38.768" class="difflineminus">-    }</span>
<a href="#l38.769"></a><span id="l38.769" class="difflineminus">-  }</span>
<a href="#l38.770"></a><span id="l38.770" class="difflineminus">-}</span>
<a href="#l38.771"></a><span id="l38.771" class="difflineminus">-</span>
<a href="#l38.772"></a><span id="l38.772" class="difflineminus">-void nsEudoraWin32::GetAccountName(const char *pSection, nsString&amp; str)</span>
<a href="#l38.773"></a><span id="l38.773" class="difflineminus">-{</span>
<a href="#l38.774"></a><span id="l38.774" class="difflineminus">-  str.Truncate();</span>
<a href="#l38.775"></a><span id="l38.775" class="difflineminus">-</span>
<a href="#l38.776"></a><span id="l38.776" class="difflineminus">-  nsCString s(pSection);</span>
<a href="#l38.777"></a><span id="l38.777" class="difflineminus">-</span>
<a href="#l38.778"></a><span id="l38.778" class="difflineminus">-  if (s.LowerCaseEqualsLiteral(&quot;settings&quot;))</span>
<a href="#l38.779"></a><span id="l38.779" class="difflineminus">-  {</span>
<a href="#l38.780"></a><span id="l38.780" class="difflineminus">-    str.AssignLiteral(&quot;Eudora &quot;);</span>
<a href="#l38.781"></a><span id="l38.781" class="difflineminus">-    str.Append(NS_ConvertASCIItoUTF16(pSection));</span>
<a href="#l38.782"></a><span id="l38.782" class="difflineminus">-  }</span>
<a href="#l38.783"></a><span id="l38.783" class="difflineminus">-  else</span>
<a href="#l38.784"></a><span id="l38.784" class="difflineminus">-  {</span>
<a href="#l38.785"></a><span id="l38.785" class="difflineminus">-    str.AssignASCII(pSection);</span>
<a href="#l38.786"></a><span id="l38.786" class="difflineminus">-    if (StringBeginsWith(s, NS_LITERAL_CSTRING(&quot;persona-&quot;), nsCaseInsensitiveCStringComparator()))</span>
<a href="#l38.787"></a><span id="l38.787" class="difflineminus">-      CopyASCIItoUTF16(Substring(s, 8), str);</span>
<a href="#l38.788"></a><span id="l38.788" class="difflineminus">-  }</span>
<a href="#l38.789"></a><span id="l38.789" class="difflineminus">-}</span>
<a href="#l38.790"></a><span id="l38.790" class="difflineminus">-</span>
<a href="#l38.791"></a><span id="l38.791" class="difflineminus">-</span>
<a href="#l38.792"></a><span id="l38.792" class="difflineminus">-bool nsEudoraWin32::BuildPOPAccount(nsIMsgAccountManager *accMgr, const char *pSection, const char *pIni, nsIMsgAccount **ppAccount)</span>
<a href="#l38.793"></a><span id="l38.793" class="difflineminus">-{</span>
<a href="#l38.794"></a><span id="l38.794" class="difflineminus">-  if (ppAccount)</span>
<a href="#l38.795"></a><span id="l38.795" class="difflineminus">-    *ppAccount = nullptr;</span>
<a href="#l38.796"></a><span id="l38.796" class="difflineminus">-</span>
<a href="#l38.797"></a><span id="l38.797" class="difflineminus">-  char valBuff[kIniValueSize];</span>
<a href="#l38.798"></a><span id="l38.798" class="difflineminus">-  nsCString serverName;</span>
<a href="#l38.799"></a><span id="l38.799" class="difflineminus">-  nsCString userName;</span>
<a href="#l38.800"></a><span id="l38.800" class="difflineminus">-</span>
<a href="#l38.801"></a><span id="l38.801" class="difflineminus">-  GetServerAndUserName(pSection, pIni, serverName, userName, valBuff);</span>
<a href="#l38.802"></a><span id="l38.802" class="difflineminus">-</span>
<a href="#l38.803"></a><span id="l38.803" class="difflineminus">-  if (serverName.IsEmpty() || userName.IsEmpty())</span>
<a href="#l38.804"></a><span id="l38.804" class="difflineminus">-    return false;</span>
<a href="#l38.805"></a><span id="l38.805" class="difflineminus">-</span>
<a href="#l38.806"></a><span id="l38.806" class="difflineminus">-  bool result = false;</span>
<a href="#l38.807"></a><span id="l38.807" class="difflineminus">-</span>
<a href="#l38.808"></a><span id="l38.808" class="difflineminus">-  // I now have a user name/server name pair, find out if it already exists?</span>
<a href="#l38.809"></a><span id="l38.809" class="difflineminus">-  nsCOMPtr&lt;nsIMsgIncomingServer&gt; in;</span>
<a href="#l38.810"></a><span id="l38.810" class="difflineminus">-  nsresult rv = accMgr-&gt;FindServer(userName, serverName, NS_LITERAL_CSTRING(&quot;pop3&quot;), getter_AddRefs(in));</span>
<a href="#l38.811"></a><span id="l38.811" class="difflineminus">-  if (NS_FAILED(rv) || !in)</span>
<a href="#l38.812"></a><span id="l38.812" class="difflineminus">-  {</span>
<a href="#l38.813"></a><span id="l38.813" class="difflineminus">-    // Create the incoming server and an account for it?</span>
<a href="#l38.814"></a><span id="l38.814" class="difflineminus">-    rv = accMgr-&gt;CreateIncomingServer(userName, serverName, NS_LITERAL_CSTRING(&quot;pop3&quot;), getter_AddRefs(in));</span>
<a href="#l38.815"></a><span id="l38.815" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; in)</span>
<a href="#l38.816"></a><span id="l38.816" class="difflineminus">-    {</span>
<a href="#l38.817"></a><span id="l38.817" class="difflineminus">-      rv = in-&gt;SetType(NS_LITERAL_CSTRING(&quot;pop3&quot;));</span>
<a href="#l38.818"></a><span id="l38.818" class="difflineminus">-      // rv = in-&gt;SetHostName(serverName);</span>
<a href="#l38.819"></a><span id="l38.819" class="difflineminus">-      // rv = in-&gt;SetUsername(userName);</span>
<a href="#l38.820"></a><span id="l38.820" class="difflineminus">-</span>
<a href="#l38.821"></a><span id="l38.821" class="difflineminus">-      IMPORT_LOG2(&quot;Created POP3 server named: %s, userName: %s\n&quot;, serverName.get(), userName.get());</span>
<a href="#l38.822"></a><span id="l38.822" class="difflineminus">-</span>
<a href="#l38.823"></a><span id="l38.823" class="difflineminus">-      nsString prettyName;</span>
<a href="#l38.824"></a><span id="l38.824" class="difflineminus">-      GetAccountName(pSection, prettyName);</span>
<a href="#l38.825"></a><span id="l38.825" class="difflineminus">-      IMPORT_LOG1(&quot;\tSet pretty name to: %S\n&quot;, prettyName.get());</span>
<a href="#l38.826"></a><span id="l38.826" class="difflineminus">-      rv = in-&gt;SetPrettyName(prettyName);</span>
<a href="#l38.827"></a><span id="l38.827" class="difflineminus">-</span>
<a href="#l38.828"></a><span id="l38.828" class="difflineminus">-      // We have a server, create an account.</span>
<a href="#l38.829"></a><span id="l38.829" class="difflineminus">-      nsCOMPtr&lt;nsIMsgAccount&gt;  account;</span>
<a href="#l38.830"></a><span id="l38.830" class="difflineminus">-      rv = accMgr-&gt;CreateAccount(getter_AddRefs(account));</span>
<a href="#l38.831"></a><span id="l38.831" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; account)</span>
<a href="#l38.832"></a><span id="l38.832" class="difflineminus">-      {</span>
<a href="#l38.833"></a><span id="l38.833" class="difflineminus">-        rv = account-&gt;SetIncomingServer(in);</span>
<a href="#l38.834"></a><span id="l38.834" class="difflineminus">-</span>
<a href="#l38.835"></a><span id="l38.835" class="difflineminus">-        IMPORT_LOG0(&quot;Created a new account and set the incoming server to the POP3 server.\n&quot;);</span>
<a href="#l38.836"></a><span id="l38.836" class="difflineminus">-</span>
<a href="#l38.837"></a><span id="l38.837" class="difflineminus">-        nsCOMPtr&lt;nsIPop3IncomingServer&gt; pop3Server = do_QueryInterface(in, &amp;rv);</span>
<a href="#l38.838"></a><span id="l38.838" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,false);</span>
<a href="#l38.839"></a><span id="l38.839" class="difflineminus">-        UINT valInt = ::GetPrivateProfileInt(pSection, &quot;LeaveMailOnServer&quot;, 0, pIni);</span>
<a href="#l38.840"></a><span id="l38.840" class="difflineminus">-        pop3Server-&gt;SetLeaveMessagesOnServer(valInt ? true : false);</span>
<a href="#l38.841"></a><span id="l38.841" class="difflineminus">-</span>
<a href="#l38.842"></a><span id="l38.842" class="difflineminus">-        // Fiddle with the identities</span>
<a href="#l38.843"></a><span id="l38.843" class="difflineminus">-        SetIdentities(accMgr, account, pSection, pIni, userName.get(), serverName.get(), valBuff);</span>
<a href="#l38.844"></a><span id="l38.844" class="difflineminus">-        result = true;</span>
<a href="#l38.845"></a><span id="l38.845" class="difflineminus">-        if (ppAccount)</span>
<a href="#l38.846"></a><span id="l38.846" class="difflineminus">-          account-&gt;QueryInterface(NS_GET_IID(nsIMsgAccount), (void **)ppAccount);</span>
<a href="#l38.847"></a><span id="l38.847" class="difflineminus">-      }</span>
<a href="#l38.848"></a><span id="l38.848" class="difflineminus">-    }</span>
<a href="#l38.849"></a><span id="l38.849" class="difflineminus">-  }</span>
<a href="#l38.850"></a><span id="l38.850" class="difflineminus">-  else</span>
<a href="#l38.851"></a><span id="l38.851" class="difflineminus">-    result = true;</span>
<a href="#l38.852"></a><span id="l38.852" class="difflineminus">-</span>
<a href="#l38.853"></a><span id="l38.853" class="difflineminus">-  return result;</span>
<a href="#l38.854"></a><span id="l38.854" class="difflineminus">-}</span>
<a href="#l38.855"></a><span id="l38.855" class="difflineminus">-</span>
<a href="#l38.856"></a><span id="l38.856" class="difflineminus">-bool nsEudoraWin32::BuildIMAPAccount(nsIMsgAccountManager *accMgr, const char *pSection, const char *pIni, nsIMsgAccount **ppAccount)</span>
<a href="#l38.857"></a><span id="l38.857" class="difflineminus">-{</span>
<a href="#l38.858"></a><span id="l38.858" class="difflineminus">-  char valBuff[kIniValueSize];</span>
<a href="#l38.859"></a><span id="l38.859" class="difflineminus">-  nsCString serverName;</span>
<a href="#l38.860"></a><span id="l38.860" class="difflineminus">-  nsCString userName;</span>
<a href="#l38.861"></a><span id="l38.861" class="difflineminus">-</span>
<a href="#l38.862"></a><span id="l38.862" class="difflineminus">-  GetServerAndUserName(pSection, pIni, serverName, userName, valBuff);</span>
<a href="#l38.863"></a><span id="l38.863" class="difflineminus">-</span>
<a href="#l38.864"></a><span id="l38.864" class="difflineminus">-  if (serverName.IsEmpty() || userName.IsEmpty())</span>
<a href="#l38.865"></a><span id="l38.865" class="difflineminus">-    return false;</span>
<a href="#l38.866"></a><span id="l38.866" class="difflineminus">-</span>
<a href="#l38.867"></a><span id="l38.867" class="difflineminus">-  bool result = false;</span>
<a href="#l38.868"></a><span id="l38.868" class="difflineminus">-</span>
<a href="#l38.869"></a><span id="l38.869" class="difflineminus">-  nsCOMPtr&lt;nsIMsgIncomingServer&gt; in;</span>
<a href="#l38.870"></a><span id="l38.870" class="difflineminus">-  nsresult rv = accMgr-&gt;FindServer(userName, serverName, NS_LITERAL_CSTRING(&quot;imap&quot;), getter_AddRefs(in));</span>
<a href="#l38.871"></a><span id="l38.871" class="difflineminus">-  if (NS_FAILED(rv) || (in == nullptr))</span>
<a href="#l38.872"></a><span id="l38.872" class="difflineminus">-  {</span>
<a href="#l38.873"></a><span id="l38.873" class="difflineminus">-    // Create the incoming server and an account for it?</span>
<a href="#l38.874"></a><span id="l38.874" class="difflineminus">-    rv = accMgr-&gt;CreateIncomingServer(userName, serverName, NS_LITERAL_CSTRING(&quot;imap&quot;), getter_AddRefs(in));</span>
<a href="#l38.875"></a><span id="l38.875" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; in)</span>
<a href="#l38.876"></a><span id="l38.876" class="difflineminus">-    {</span>
<a href="#l38.877"></a><span id="l38.877" class="difflineminus">-      rv = in-&gt;SetType(NS_LITERAL_CSTRING(&quot;imap&quot;));</span>
<a href="#l38.878"></a><span id="l38.878" class="difflineminus">-      // rv = in-&gt;SetHostName(serverName);</span>
<a href="#l38.879"></a><span id="l38.879" class="difflineminus">-      // rv = in-&gt;SetUsername(userName);</span>
<a href="#l38.880"></a><span id="l38.880" class="difflineminus">-</span>
<a href="#l38.881"></a><span id="l38.881" class="difflineminus">-      IMPORT_LOG2(&quot;Created IMAP server named: %s, userName: %s\n&quot;, serverName.get(), userName.get());</span>
<a href="#l38.882"></a><span id="l38.882" class="difflineminus">-</span>
<a href="#l38.883"></a><span id="l38.883" class="difflineminus">-      nsString prettyName;</span>
<a href="#l38.884"></a><span id="l38.884" class="difflineminus">-      GetAccountName(pSection, prettyName);</span>
<a href="#l38.885"></a><span id="l38.885" class="difflineminus">-      IMPORT_LOG1(&quot;\tSet pretty name to: %S\n&quot;, prettyName.get());</span>
<a href="#l38.886"></a><span id="l38.886" class="difflineminus">-      rv = in-&gt;SetPrettyName(prettyName);</span>
<a href="#l38.887"></a><span id="l38.887" class="difflineminus">-</span>
<a href="#l38.888"></a><span id="l38.888" class="difflineminus">-      // We have a server, create an account.</span>
<a href="#l38.889"></a><span id="l38.889" class="difflineminus">-      nsCOMPtr&lt;nsIMsgAccount&gt; account;</span>
<a href="#l38.890"></a><span id="l38.890" class="difflineminus">-      rv = accMgr-&gt;CreateAccount(getter_AddRefs(account));</span>
<a href="#l38.891"></a><span id="l38.891" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; account)</span>
<a href="#l38.892"></a><span id="l38.892" class="difflineminus">-      {</span>
<a href="#l38.893"></a><span id="l38.893" class="difflineminus">-        rv = account-&gt;SetIncomingServer(in);</span>
<a href="#l38.894"></a><span id="l38.894" class="difflineminus">-</span>
<a href="#l38.895"></a><span id="l38.895" class="difflineminus">-        IMPORT_LOG0(&quot;Created an account and set the IMAP server as the incoming server\n&quot;);</span>
<a href="#l38.896"></a><span id="l38.896" class="difflineminus">-</span>
<a href="#l38.897"></a><span id="l38.897" class="difflineminus">-        // Fiddle with the identities</span>
<a href="#l38.898"></a><span id="l38.898" class="difflineminus">-        SetIdentities(accMgr, account, pSection, pIni, userName.get(), serverName.get(), valBuff);</span>
<a href="#l38.899"></a><span id="l38.899" class="difflineminus">-        result = true;</span>
<a href="#l38.900"></a><span id="l38.900" class="difflineminus">-        if (ppAccount)</span>
<a href="#l38.901"></a><span id="l38.901" class="difflineminus">-          account-&gt;QueryInterface(NS_GET_IID(nsIMsgAccount), (void **)ppAccount);</span>
<a href="#l38.902"></a><span id="l38.902" class="difflineminus">-      }</span>
<a href="#l38.903"></a><span id="l38.903" class="difflineminus">-    }</span>
<a href="#l38.904"></a><span id="l38.904" class="difflineminus">-  }</span>
<a href="#l38.905"></a><span id="l38.905" class="difflineminus">-  else</span>
<a href="#l38.906"></a><span id="l38.906" class="difflineminus">-    result = true;</span>
<a href="#l38.907"></a><span id="l38.907" class="difflineminus">-</span>
<a href="#l38.908"></a><span id="l38.908" class="difflineminus">-  return result;</span>
<a href="#l38.909"></a><span id="l38.909" class="difflineminus">-}</span>
<a href="#l38.910"></a><span id="l38.910" class="difflineminus">-</span>
<a href="#l38.911"></a><span id="l38.911" class="difflineminus">-void nsEudoraWin32::SetIdentities(nsIMsgAccountManager *accMgr, nsIMsgAccount *acc, const char *pSection, const char *pIniFile, const char *userName, const char *serverName, char *pBuff)</span>
<a href="#l38.912"></a><span id="l38.912" class="difflineminus">-{</span>
<a href="#l38.913"></a><span id="l38.913" class="difflineminus">-  nsAutoCString realName;</span>
<a href="#l38.914"></a><span id="l38.914" class="difflineminus">-  nsAutoCString email;</span>
<a href="#l38.915"></a><span id="l38.915" class="difflineminus">-  nsAutoCString server;</span>
<a href="#l38.916"></a><span id="l38.916" class="difflineminus">-  DWORD valSize;</span>
<a href="#l38.917"></a><span id="l38.917" class="difflineminus">-  nsresult rv;</span>
<a href="#l38.918"></a><span id="l38.918" class="difflineminus">-</span>
<a href="#l38.919"></a><span id="l38.919" class="difflineminus">-  valSize = ::GetPrivateProfileString(pSection, &quot;RealName&quot;, &quot;&quot;, pBuff, kIniValueSize, pIniFile);</span>
<a href="#l38.920"></a><span id="l38.920" class="difflineminus">-  if (valSize)</span>
<a href="#l38.921"></a><span id="l38.921" class="difflineminus">-    realName = pBuff;</span>
<a href="#l38.922"></a><span id="l38.922" class="difflineminus">-  valSize = ::GetPrivateProfileString(pSection, &quot;SMTPServer&quot;, &quot;&quot;, pBuff, kIniValueSize, pIniFile);</span>
<a href="#l38.923"></a><span id="l38.923" class="difflineminus">-  if (valSize)</span>
<a href="#l38.924"></a><span id="l38.924" class="difflineminus">-    server = pBuff;</span>
<a href="#l38.925"></a><span id="l38.925" class="difflineminus">-  valSize = ::GetPrivateProfileString(pSection, &quot;ReturnAddress&quot;, &quot;&quot;, pBuff, kIniValueSize, pIniFile);</span>
<a href="#l38.926"></a><span id="l38.926" class="difflineminus">-  if (valSize)</span>
<a href="#l38.927"></a><span id="l38.927" class="difflineminus">-    email = pBuff;</span>
<a href="#l38.928"></a><span id="l38.928" class="difflineminus">-</span>
<a href="#l38.929"></a><span id="l38.929" class="difflineminus">-  nsCOMPtr&lt;nsIMsgIdentity&gt; id;</span>
<a href="#l38.930"></a><span id="l38.930" class="difflineminus">-  rv = accMgr-&gt;CreateIdentity(getter_AddRefs(id));</span>
<a href="#l38.931"></a><span id="l38.931" class="difflineminus">-  if (id)</span>
<a href="#l38.932"></a><span id="l38.932" class="difflineminus">-  {</span>
<a href="#l38.933"></a><span id="l38.933" class="difflineminus">-    nsAutoString fullName;</span>
<a href="#l38.934"></a><span id="l38.934" class="difflineminus">-    fullName.Assign(NS_ConvertASCIItoUTF16(realName));</span>
<a href="#l38.935"></a><span id="l38.935" class="difflineminus">-    id-&gt;SetFullName(fullName);</span>
<a href="#l38.936"></a><span id="l38.936" class="difflineminus">-    id-&gt;SetIdentityName(fullName);</span>
<a href="#l38.937"></a><span id="l38.937" class="difflineminus">-    if (email.IsEmpty())</span>
<a href="#l38.938"></a><span id="l38.938" class="difflineminus">-    {</span>
<a href="#l38.939"></a><span id="l38.939" class="difflineminus">-      email = userName;</span>
<a href="#l38.940"></a><span id="l38.940" class="difflineminus">-      email += &quot;@&quot;;</span>
<a href="#l38.941"></a><span id="l38.941" class="difflineminus">-      email += serverName;</span>
<a href="#l38.942"></a><span id="l38.942" class="difflineminus">-    }</span>
<a href="#l38.943"></a><span id="l38.943" class="difflineminus">-    id-&gt;SetEmail(email);</span>
<a href="#l38.944"></a><span id="l38.944" class="difflineminus">-    acc-&gt;AddIdentity(id);</span>
<a href="#l38.945"></a><span id="l38.945" class="difflineminus">-</span>
<a href="#l38.946"></a><span id="l38.946" class="difflineminus">-    IMPORT_LOG0(&quot;Created identity and added to the account\n&quot;);</span>
<a href="#l38.947"></a><span id="l38.947" class="difflineminus">-    IMPORT_LOG1(&quot;\tname: %s\n&quot;, realName.get());</span>
<a href="#l38.948"></a><span id="l38.948" class="difflineminus">-    IMPORT_LOG1(&quot;\temail: %s\n&quot;, email.get());</span>
<a href="#l38.949"></a><span id="l38.949" class="difflineminus">-  }</span>
<a href="#l38.950"></a><span id="l38.950" class="difflineminus">-  SetSmtpServer(accMgr, acc, server.get(), userName);</span>
<a href="#l38.951"></a><span id="l38.951" class="difflineminus">-}</span>
<a href="#l38.952"></a><span id="l38.952" class="difflineminus">-</span>
<a href="#l38.953"></a><span id="l38.953" class="difflineminus">-</span>
<a href="#l38.954"></a><span id="l38.954" class="difflineminus">-void nsEudoraWin32::SetSmtpServer(nsIMsgAccountManager *pMgr, nsIMsgAccount *pAcc, const char *pServer, const char *pUser)</span>
<a href="#l38.955"></a><span id="l38.955" class="difflineminus">-{</span>
<a href="#l38.956"></a><span id="l38.956" class="difflineminus">-  nsresult  rv;</span>
<a href="#l38.957"></a><span id="l38.957" class="difflineminus">-</span>
<a href="#l38.958"></a><span id="l38.958" class="difflineminus">-  nsCOMPtr&lt;nsISmtpService&gt; smtpService(do_GetService(NS_SMTPSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l38.959"></a><span id="l38.959" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; smtpService)</span>
<a href="#l38.960"></a><span id="l38.960" class="difflineminus">-  {</span>
<a href="#l38.961"></a><span id="l38.961" class="difflineminus">-    nsCOMPtr&lt;nsISmtpServer&gt;    foundServer;</span>
<a href="#l38.962"></a><span id="l38.962" class="difflineminus">-</span>
<a href="#l38.963"></a><span id="l38.963" class="difflineminus">-    rv = smtpService-&gt;FindServer(pUser, pServer, getter_AddRefs(foundServer));</span>
<a href="#l38.964"></a><span id="l38.964" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; foundServer)</span>
<a href="#l38.965"></a><span id="l38.965" class="difflineminus">-    {</span>
<a href="#l38.966"></a><span id="l38.966" class="difflineminus">-      IMPORT_LOG1(&quot;SMTP server already exists: %s\n&quot;, pServer);</span>
<a href="#l38.967"></a><span id="l38.967" class="difflineminus">-      return;</span>
<a href="#l38.968"></a><span id="l38.968" class="difflineminus">-    }</span>
<a href="#l38.969"></a><span id="l38.969" class="difflineminus">-    nsCOMPtr&lt;nsISmtpServer&gt;    smtpServer;</span>
<a href="#l38.970"></a><span id="l38.970" class="difflineminus">-</span>
<a href="#l38.971"></a><span id="l38.971" class="difflineminus">-    rv = smtpService-&gt;CreateServer(getter_AddRefs(smtpServer));</span>
<a href="#l38.972"></a><span id="l38.972" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; smtpServer)</span>
<a href="#l38.973"></a><span id="l38.973" class="difflineminus">-    {</span>
<a href="#l38.974"></a><span id="l38.974" class="difflineminus">-      smtpServer-&gt;SetHostname(nsDependentCString(pServer));</span>
<a href="#l38.975"></a><span id="l38.975" class="difflineminus">-      if (pUser)</span>
<a href="#l38.976"></a><span id="l38.976" class="difflineminus">-        smtpServer-&gt;SetUsername(nsDependentCString(pUser));</span>
<a href="#l38.977"></a><span id="l38.977" class="difflineminus">-</span>
<a href="#l38.978"></a><span id="l38.978" class="difflineminus">-      IMPORT_LOG1(&quot;Created new SMTP server: %s\n&quot;, pServer);</span>
<a href="#l38.979"></a><span id="l38.979" class="difflineminus">-    }</span>
<a href="#l38.980"></a><span id="l38.980" class="difflineminus">-  }</span>
<a href="#l38.981"></a><span id="l38.981" class="difflineminus">-}</span>
<a href="#l38.982"></a><span id="l38.982" class="difflineminus">-</span>
<a href="#l38.983"></a><span id="l38.983" class="difflineminus">-nsresult nsEudoraWin32::GetAttachmentInfo(const char *pFileName, nsIFile *pFile, nsCString&amp; mimeType, nsCString&amp; aAttachmentName)</span>
<a href="#l38.984"></a><span id="l38.984" class="difflineminus">-{</span>
<a href="#l38.985"></a><span id="l38.985" class="difflineminus">-  nsresult  rv;</span>
<a href="#l38.986"></a><span id="l38.986" class="difflineminus">-  mimeType.Truncate();</span>
<a href="#l38.987"></a><span id="l38.987" class="difflineminus">-  pFile-&gt;InitWithNativePath(nsDependentCString(pFileName));</span>
<a href="#l38.988"></a><span id="l38.988" class="difflineminus">-  bool      isFile = false;</span>
<a href="#l38.989"></a><span id="l38.989" class="difflineminus">-  bool      exists = false;</span>
<a href="#l38.990"></a><span id="l38.990" class="difflineminus">-  if (NS_FAILED(rv = pFile-&gt;Exists(&amp;exists)))</span>
<a href="#l38.991"></a><span id="l38.991" class="difflineminus">-    return rv;</span>
<a href="#l38.992"></a><span id="l38.992" class="difflineminus">-  if (exists &amp;&amp; NS_FAILED(rv = pFile-&gt;IsFile(&amp;isFile)))</span>
<a href="#l38.993"></a><span id="l38.993" class="difflineminus">-    return rv;</span>
<a href="#l38.994"></a><span id="l38.994" class="difflineminus">-</span>
<a href="#l38.995"></a><span id="l38.995" class="difflineminus">-  if (!exists || !isFile)</span>
<a href="#l38.996"></a><span id="l38.996" class="difflineminus">-  {</span>
<a href="#l38.997"></a><span id="l38.997" class="difflineminus">-    // Windows Eudora writes the full path to the attachment when the message</span>
<a href="#l38.998"></a><span id="l38.998" class="difflineminus">-    // is received, but doesn't update that path if the attachment directory</span>
<a href="#l38.999"></a><span id="l38.999" class="difflineminus">-    // changes (e.g. if email directory is moved). When operating on an</span>
<a href="#l38.1000"></a><span id="l38.1000" class="difflineminus">-    // attachment (opening, etc.) Eudora will first check the full path</span>
<a href="#l38.1001"></a><span id="l38.1001" class="difflineminus">-    // and then if the file doesn't exist there Eudora will check the</span>
<a href="#l38.1002"></a><span id="l38.1002" class="difflineminus">-    // current attachment directory for a file with the same name.</span>
<a href="#l38.1003"></a><span id="l38.1003" class="difflineminus">-    //</span>
<a href="#l38.1004"></a><span id="l38.1004" class="difflineminus">-    // Check to see if we have any better luck looking for the attachment</span>
<a href="#l38.1005"></a><span id="l38.1005" class="difflineminus">-    // in the current attachment directory.</span>
<a href="#l38.1006"></a><span id="l38.1006" class="difflineminus">-    nsAutoCString name;</span>
<a href="#l38.1007"></a><span id="l38.1007" class="difflineminus">-    pFile-&gt;GetNativeLeafName(name);</span>
<a href="#l38.1008"></a><span id="l38.1008" class="difflineminus">-    if (name.IsEmpty())</span>
<a href="#l38.1009"></a><span id="l38.1009" class="difflineminus">-      return NS_ERROR_FAILURE;</span>
<a href="#l38.1010"></a><span id="l38.1010" class="difflineminus">-</span>
<a href="#l38.1011"></a><span id="l38.1011" class="difflineminus">-    nsCOMPtr &lt;nsIFile&gt; altFile;</span>
<a href="#l38.1012"></a><span id="l38.1012" class="difflineminus">-    rv = m_mailImportLocation-&gt;Clone(getter_AddRefs(altFile));</span>
<a href="#l38.1013"></a><span id="l38.1013" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l38.1014"></a><span id="l38.1014" class="difflineminus">-    // For now, we'll do that using a hard coded name and location for the</span>
<a href="#l38.1015"></a><span id="l38.1015" class="difflineminus">-    // attachment directory on Windows (the default location) &quot;attach&quot; inside</span>
<a href="#l38.1016"></a><span id="l38.1016" class="difflineminus">-    // of the Eudora mail directory. Once settings from Eudora are imported</span>
<a href="#l38.1017"></a><span id="l38.1017" class="difflineminus">-    // better, we'll want to check where the settings say attachments are stored.</span>
<a href="#l38.1018"></a><span id="l38.1018" class="difflineminus">-    altFile-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;attach&quot;));</span>
<a href="#l38.1019"></a><span id="l38.1019" class="difflineminus">-    altFile-&gt;AppendNative(name);</span>
<a href="#l38.1020"></a><span id="l38.1020" class="difflineminus">-</span>
<a href="#l38.1021"></a><span id="l38.1021" class="difflineminus">-    // Did we come up with a different path or was the original path already</span>
<a href="#l38.1022"></a><span id="l38.1022" class="difflineminus">-    // in the current attachment directory?</span>
<a href="#l38.1023"></a><span id="l38.1023" class="difflineminus">-    bool    isSamePath = true;</span>
<a href="#l38.1024"></a><span id="l38.1024" class="difflineminus">-    rv = altFile-&gt;Equals(pFile, &amp;isSamePath);</span>
<a href="#l38.1025"></a><span id="l38.1025" class="difflineminus">-</span>
<a href="#l38.1026"></a><span id="l38.1026" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; !isSamePath)</span>
<a href="#l38.1027"></a><span id="l38.1027" class="difflineminus">-    {</span>
<a href="#l38.1028"></a><span id="l38.1028" class="difflineminus">-      // We came up with a different path - check the new path.</span>
<a href="#l38.1029"></a><span id="l38.1029" class="difflineminus">-      if (NS_FAILED(rv = altFile-&gt;Exists(&amp;exists)))</span>
<a href="#l38.1030"></a><span id="l38.1030" class="difflineminus">-        return rv;</span>
<a href="#l38.1031"></a><span id="l38.1031" class="difflineminus">-      if (exists &amp;&amp; NS_FAILED(rv = altFile-&gt;IsFile(&amp;isFile)))</span>
<a href="#l38.1032"></a><span id="l38.1032" class="difflineminus">-        return rv;</span>
<a href="#l38.1033"></a><span id="l38.1033" class="difflineminus">-</span>
<a href="#l38.1034"></a><span id="l38.1034" class="difflineminus">-      // Keep the new path if it helped us.</span>
<a href="#l38.1035"></a><span id="l38.1035" class="difflineminus">-      if (exists &amp;&amp; isFile)</span>
<a href="#l38.1036"></a><span id="l38.1036" class="difflineminus">-      {</span>
<a href="#l38.1037"></a><span id="l38.1037" class="difflineminus">-        nsCString   nativePath;</span>
<a href="#l38.1038"></a><span id="l38.1038" class="difflineminus">-        altFile-&gt;GetNativePath(nativePath);</span>
<a href="#l38.1039"></a><span id="l38.1039" class="difflineminus">-        pFile-&gt;InitWithNativePath(nativePath);</span>
<a href="#l38.1040"></a><span id="l38.1040" class="difflineminus">-      }</span>
<a href="#l38.1041"></a><span id="l38.1041" class="difflineminus">-    }</span>
<a href="#l38.1042"></a><span id="l38.1042" class="difflineminus">-  }</span>
<a href="#l38.1043"></a><span id="l38.1043" class="difflineminus">-</span>
<a href="#l38.1044"></a><span id="l38.1044" class="difflineminus">-  if (exists &amp;&amp; isFile)</span>
<a href="#l38.1045"></a><span id="l38.1045" class="difflineminus">-  {</span>
<a href="#l38.1046"></a><span id="l38.1046" class="difflineminus">-    nsAutoCString name;</span>
<a href="#l38.1047"></a><span id="l38.1047" class="difflineminus">-    pFile-&gt;GetNativeLeafName(name);</span>
<a href="#l38.1048"></a><span id="l38.1048" class="difflineminus">-    if (name.IsEmpty())</span>
<a href="#l38.1049"></a><span id="l38.1049" class="difflineminus">-      return NS_ERROR_FAILURE;</span>
<a href="#l38.1050"></a><span id="l38.1050" class="difflineminus">-    if (name.Length() &gt; 4)</span>
<a href="#l38.1051"></a><span id="l38.1051" class="difflineminus">-    {</span>
<a href="#l38.1052"></a><span id="l38.1052" class="difflineminus">-      nsCString ext;</span>
<a href="#l38.1053"></a><span id="l38.1053" class="difflineminus">-      int32_t idx = name.RFindChar('.');</span>
<a href="#l38.1054"></a><span id="l38.1054" class="difflineminus">-      if (idx != -1)</span>
<a href="#l38.1055"></a><span id="l38.1055" class="difflineminus">-      {</span>
<a href="#l38.1056"></a><span id="l38.1056" class="difflineminus">-        ext = Substring(name, idx);</span>
<a href="#l38.1057"></a><span id="l38.1057" class="difflineminus">-        GetMimeTypeFromExtension(ext, mimeType);</span>
<a href="#l38.1058"></a><span id="l38.1058" class="difflineminus">-      }</span>
<a href="#l38.1059"></a><span id="l38.1059" class="difflineminus">-    }</span>
<a href="#l38.1060"></a><span id="l38.1060" class="difflineminus">-    if (mimeType.IsEmpty())</span>
<a href="#l38.1061"></a><span id="l38.1061" class="difflineminus">-      mimeType = &quot;application/octet-stream&quot;;</span>
<a href="#l38.1062"></a><span id="l38.1062" class="difflineminus">-</span>
<a href="#l38.1063"></a><span id="l38.1063" class="difflineminus">-    nsAutoString description;</span>
<a href="#l38.1064"></a><span id="l38.1064" class="difflineminus">-    rv = NS_CopyNativeToUnicode(name, description);</span>
<a href="#l38.1065"></a><span id="l38.1065" class="difflineminus">- </span>
<a href="#l38.1066"></a><span id="l38.1066" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l38.1067"></a><span id="l38.1067" class="difflineminus">-      aAttachmentName = NS_ConvertUTF16toUTF8(description);</span>
<a href="#l38.1068"></a><span id="l38.1068" class="difflineminus">-    else</span>
<a href="#l38.1069"></a><span id="l38.1069" class="difflineminus">-      aAttachmentName = name;</span>
<a href="#l38.1070"></a><span id="l38.1070" class="difflineminus">-</span>
<a href="#l38.1071"></a><span id="l38.1071" class="difflineminus">-    return NS_OK;</span>
<a href="#l38.1072"></a><span id="l38.1072" class="difflineminus">-  }</span>
<a href="#l38.1073"></a><span id="l38.1073" class="difflineminus">-</span>
<a href="#l38.1074"></a><span id="l38.1074" class="difflineminus">-  return NS_ERROR_FAILURE;</span>
<a href="#l38.1075"></a><span id="l38.1075" class="difflineminus">-}</span>
<a href="#l38.1076"></a><span id="l38.1076" class="difflineminus">-</span>
<a href="#l38.1077"></a><span id="l38.1077" class="difflineminus">-bool nsEudoraWin32::FindMimeIniFile(nsIFile *pFile)</span>
<a href="#l38.1078"></a><span id="l38.1078" class="difflineminus">-{</span>
<a href="#l38.1079"></a><span id="l38.1079" class="difflineminus">-  bool hasMore;</span>
<a href="#l38.1080"></a><span id="l38.1080" class="difflineminus">-  nsCOMPtr&lt;nsISimpleEnumerator&gt; directoryEnumerator;</span>
<a href="#l38.1081"></a><span id="l38.1081" class="difflineminus">-  nsresult rv = pFile-&gt;GetDirectoryEntries(getter_AddRefs(directoryEnumerator));</span>
<a href="#l38.1082"></a><span id="l38.1082" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l38.1083"></a><span id="l38.1083" class="difflineminus">-</span>
<a href="#l38.1084"></a><span id="l38.1084" class="difflineminus">-  directoryEnumerator-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l38.1085"></a><span id="l38.1085" class="difflineminus">-  bool              isFile;</span>
<a href="#l38.1086"></a><span id="l38.1086" class="difflineminus">-  nsCOMPtr&lt;nsIFile&gt; entry;</span>
<a href="#l38.1087"></a><span id="l38.1087" class="difflineminus">-  nsCString         fName;</span>
<a href="#l38.1088"></a><span id="l38.1088" class="difflineminus">-  nsCString         ext;</span>
<a href="#l38.1089"></a><span id="l38.1089" class="difflineminus">-  nsCString         name;</span>
<a href="#l38.1090"></a><span id="l38.1090" class="difflineminus">-</span>
<a href="#l38.1091"></a><span id="l38.1091" class="difflineminus">-  bool found = false;</span>
<a href="#l38.1092"></a><span id="l38.1092" class="difflineminus">-</span>
<a href="#l38.1093"></a><span id="l38.1093" class="difflineminus">-  while (hasMore &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l38.1094"></a><span id="l38.1094" class="difflineminus">-  {</span>
<a href="#l38.1095"></a><span id="l38.1095" class="difflineminus">-    nsCOMPtr&lt;nsISupports&gt; aSupport;</span>
<a href="#l38.1096"></a><span id="l38.1096" class="difflineminus">-    rv = directoryEnumerator-&gt;GetNext(getter_AddRefs(aSupport));</span>
<a href="#l38.1097"></a><span id="l38.1097" class="difflineminus">-    nsCOMPtr&lt;nsIFile&gt; entry(do_QueryInterface(aSupport, &amp;rv));</span>
<a href="#l38.1098"></a><span id="l38.1098" class="difflineminus">-    directoryEnumerator-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l38.1099"></a><span id="l38.1099" class="difflineminus">-</span>
<a href="#l38.1100"></a><span id="l38.1100" class="difflineminus">-</span>
<a href="#l38.1101"></a><span id="l38.1101" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l38.1102"></a><span id="l38.1102" class="difflineminus">-    {</span>
<a href="#l38.1103"></a><span id="l38.1103" class="difflineminus">-      rv = entry-&gt;GetNativeLeafName(fName);</span>
<a href="#l38.1104"></a><span id="l38.1104" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; !fName.IsEmpty())</span>
<a href="#l38.1105"></a><span id="l38.1105" class="difflineminus">-      {</span>
<a href="#l38.1106"></a><span id="l38.1106" class="difflineminus">-        if (fName.Length() &gt; 4)</span>
<a href="#l38.1107"></a><span id="l38.1107" class="difflineminus">-        {</span>
<a href="#l38.1108"></a><span id="l38.1108" class="difflineminus">-          ext = StringTail(fName, 4);</span>
<a href="#l38.1109"></a><span id="l38.1109" class="difflineminus">-          name = StringHead(fName, fName.Length() - 4);</span>
<a href="#l38.1110"></a><span id="l38.1110" class="difflineminus">-        }</span>
<a href="#l38.1111"></a><span id="l38.1111" class="difflineminus">-        else</span>
<a href="#l38.1112"></a><span id="l38.1112" class="difflineminus">-        {</span>
<a href="#l38.1113"></a><span id="l38.1113" class="difflineminus">-          ext.Truncate();</span>
<a href="#l38.1114"></a><span id="l38.1114" class="difflineminus">-          name = fName;</span>
<a href="#l38.1115"></a><span id="l38.1115" class="difflineminus">-        }</span>
<a href="#l38.1116"></a><span id="l38.1116" class="difflineminus">-        ToLowerCase(ext);</span>
<a href="#l38.1117"></a><span id="l38.1117" class="difflineminus">-        if (ext.EqualsLiteral(&quot;.ini&quot;))</span>
<a href="#l38.1118"></a><span id="l38.1118" class="difflineminus">-        {</span>
<a href="#l38.1119"></a><span id="l38.1119" class="difflineminus">-          isFile = false;</span>
<a href="#l38.1120"></a><span id="l38.1120" class="difflineminus">-          entry-&gt;IsFile(&amp;isFile);</span>
<a href="#l38.1121"></a><span id="l38.1121" class="difflineminus">-          if (isFile)</span>
<a href="#l38.1122"></a><span id="l38.1122" class="difflineminus">-          {</span>
<a href="#l38.1123"></a><span id="l38.1123" class="difflineminus">-            if (found)</span>
<a href="#l38.1124"></a><span id="l38.1124" class="difflineminus">-            {</span>
<a href="#l38.1125"></a><span id="l38.1125" class="difflineminus">-              // which one of these files is newer?</span>
<a href="#l38.1126"></a><span id="l38.1126" class="difflineminus">-              int64_t  modDate1, modDate2;</span>
<a href="#l38.1127"></a><span id="l38.1127" class="difflineminus">-              entry-&gt;GetLastModifiedTime(&amp;modDate2);</span>
<a href="#l38.1128"></a><span id="l38.1128" class="difflineminus">-              pFile-&gt;GetLastModifiedTime(&amp;modDate1);</span>
<a href="#l38.1129"></a><span id="l38.1129" class="difflineminus">-              if (modDate2 &gt; modDate1)</span>
<a href="#l38.1130"></a><span id="l38.1130" class="difflineminus">-                pFile-&gt;InitWithFile(entry);</span>
<a href="#l38.1131"></a><span id="l38.1131" class="difflineminus">-            }</span>
<a href="#l38.1132"></a><span id="l38.1132" class="difflineminus">-            else</span>
<a href="#l38.1133"></a><span id="l38.1133" class="difflineminus">-            {</span>
<a href="#l38.1134"></a><span id="l38.1134" class="difflineminus">-              pFile-&gt;InitWithFile(entry);</span>
<a href="#l38.1135"></a><span id="l38.1135" class="difflineminus">-              found = true;</span>
<a href="#l38.1136"></a><span id="l38.1136" class="difflineminus">-            }</span>
<a href="#l38.1137"></a><span id="l38.1137" class="difflineminus">-          }</span>
<a href="#l38.1138"></a><span id="l38.1138" class="difflineminus">-        }</span>
<a href="#l38.1139"></a><span id="l38.1139" class="difflineminus">-      }</span>
<a href="#l38.1140"></a><span id="l38.1140" class="difflineminus">-    }</span>
<a href="#l38.1141"></a><span id="l38.1141" class="difflineminus">-  }</span>
<a href="#l38.1142"></a><span id="l38.1142" class="difflineminus">-  return found;</span>
<a href="#l38.1143"></a><span id="l38.1143" class="difflineminus">-}</span>
<a href="#l38.1144"></a><span id="l38.1144" class="difflineminus">-</span>
<a href="#l38.1145"></a><span id="l38.1145" class="difflineminus">-</span>
<a href="#l38.1146"></a><span id="l38.1146" class="difflineminus">-void nsEudoraWin32::GetMimeTypeFromExtension(nsCString&amp; ext, nsCString&amp; mimeType)</span>
<a href="#l38.1147"></a><span id="l38.1147" class="difflineminus">-{</span>
<a href="#l38.1148"></a><span id="l38.1148" class="difflineminus">-  HKEY  sKey;</span>
<a href="#l38.1149"></a><span id="l38.1149" class="difflineminus">-  if (::RegOpenKeyEx(HKEY_CLASSES_ROOT, ext.get(), 0, KEY_QUERY_VALUE, &amp;sKey) == ERROR_SUCCESS)</span>
<a href="#l38.1150"></a><span id="l38.1150" class="difflineminus">-  {</span>
<a href="#l38.1151"></a><span id="l38.1151" class="difflineminus">-    // get the value of &quot;Current&quot;</span>
<a href="#l38.1152"></a><span id="l38.1152" class="difflineminus">-    BYTE *pBytes = GetValueBytes(sKey, &quot;Content Type&quot;);</span>
<a href="#l38.1153"></a><span id="l38.1153" class="difflineminus">-    if (pBytes)</span>
<a href="#l38.1154"></a><span id="l38.1154" class="difflineminus">-    {</span>
<a href="#l38.1155"></a><span id="l38.1155" class="difflineminus">-      mimeType = (const char *)pBytes;</span>
<a href="#l38.1156"></a><span id="l38.1156" class="difflineminus">-      delete [] pBytes;</span>
<a href="#l38.1157"></a><span id="l38.1157" class="difflineminus">-    }</span>
<a href="#l38.1158"></a><span id="l38.1158" class="difflineminus">-    ::RegCloseKey(sKey);</span>
<a href="#l38.1159"></a><span id="l38.1159" class="difflineminus">-  }</span>
<a href="#l38.1160"></a><span id="l38.1160" class="difflineminus">-</span>
<a href="#l38.1161"></a><span id="l38.1161" class="difflineminus">-  if (!mimeType.IsEmpty() || !m_mailImportLocation || (ext.Length() &gt; 10))</span>
<a href="#l38.1162"></a><span id="l38.1162" class="difflineminus">-    return;</span>
<a href="#l38.1163"></a><span id="l38.1163" class="difflineminus">-</span>
<a href="#l38.1164"></a><span id="l38.1164" class="difflineminus">-  // TLR: FIXME: We should/could cache the extension to mime type maps we find</span>
<a href="#l38.1165"></a><span id="l38.1165" class="difflineminus">-  // and check the cache first before scanning all of eudora's mappings?</span>
<a href="#l38.1166"></a><span id="l38.1166" class="difflineminus">-</span>
<a href="#l38.1167"></a><span id="l38.1167" class="difflineminus">-  // It's not in the registry, try and find the .ini file for Eudora's private</span>
<a href="#l38.1168"></a><span id="l38.1168" class="difflineminus">-  // mime type list</span>
<a href="#l38.1169"></a><span id="l38.1169" class="difflineminus">-  if (!m_pMimeSection)</span>
<a href="#l38.1170"></a><span id="l38.1170" class="difflineminus">-  {</span>
<a href="#l38.1171"></a><span id="l38.1171" class="difflineminus">-    nsCOMPtr &lt;nsIFile&gt; pFile = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID);</span>
<a href="#l38.1172"></a><span id="l38.1172" class="difflineminus">-    if (!pFile)</span>
<a href="#l38.1173"></a><span id="l38.1173" class="difflineminus">-      return;</span>
<a href="#l38.1174"></a><span id="l38.1174" class="difflineminus">-</span>
<a href="#l38.1175"></a><span id="l38.1175" class="difflineminus">-    pFile-&gt;InitWithFile(m_mailImportLocation);</span>
<a href="#l38.1176"></a><span id="l38.1176" class="difflineminus">-</span>
<a href="#l38.1177"></a><span id="l38.1177" class="difflineminus">-    pFile-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;eudora.ini&quot;));</span>
<a href="#l38.1178"></a><span id="l38.1178" class="difflineminus">-    bool exists = false;</span>
<a href="#l38.1179"></a><span id="l38.1179" class="difflineminus">-    bool isFile = false;</span>
<a href="#l38.1180"></a><span id="l38.1180" class="difflineminus">-    nsresult rv = pFile-&gt;Exists(&amp;exists);</span>
<a href="#l38.1181"></a><span id="l38.1181" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l38.1182"></a><span id="l38.1182" class="difflineminus">-      rv = pFile-&gt;IsFile(&amp;isFile);</span>
<a href="#l38.1183"></a><span id="l38.1183" class="difflineminus">-    if (!isFile || !exists)</span>
<a href="#l38.1184"></a><span id="l38.1184" class="difflineminus">-    {</span>
<a href="#l38.1185"></a><span id="l38.1185" class="difflineminus">-      rv = pFile-&gt;InitWithFile(m_mailImportLocation);</span>
<a href="#l38.1186"></a><span id="l38.1186" class="difflineminus">-      if (NS_FAILED(rv))</span>
<a href="#l38.1187"></a><span id="l38.1187" class="difflineminus">-        return;</span>
<a href="#l38.1188"></a><span id="l38.1188" class="difflineminus">-      if (!FindMimeIniFile(pFile))</span>
<a href="#l38.1189"></a><span id="l38.1189" class="difflineminus">-        return;</span>
<a href="#l38.1190"></a><span id="l38.1190" class="difflineminus">-    }</span>
<a href="#l38.1191"></a><span id="l38.1191" class="difflineminus">-</span>
<a href="#l38.1192"></a><span id="l38.1192" class="difflineminus">-    nsAutoCString fileName;</span>
<a href="#l38.1193"></a><span id="l38.1193" class="difflineminus">-    pFile-&gt;GetNativePath(fileName);</span>
<a href="#l38.1194"></a><span id="l38.1194" class="difflineminus">-    if (fileName.IsEmpty())</span>
<a href="#l38.1195"></a><span id="l38.1195" class="difflineminus">-      return;</span>
<a href="#l38.1196"></a><span id="l38.1196" class="difflineminus">-    // Read the mime map section</span>
<a href="#l38.1197"></a><span id="l38.1197" class="difflineminus">-    DWORD  size = 1024;</span>
<a href="#l38.1198"></a><span id="l38.1198" class="difflineminus">-    DWORD  dSize = size - 2;</span>
<a href="#l38.1199"></a><span id="l38.1199" class="difflineminus">-    while (dSize == (size - 2))</span>
<a href="#l38.1200"></a><span id="l38.1200" class="difflineminus">-    {</span>
<a href="#l38.1201"></a><span id="l38.1201" class="difflineminus">-      if (m_pMimeSection)</span>
<a href="#l38.1202"></a><span id="l38.1202" class="difflineminus">-        delete [] m_pMimeSection;</span>
<a href="#l38.1203"></a><span id="l38.1203" class="difflineminus">-      size += 1024;</span>
<a href="#l38.1204"></a><span id="l38.1204" class="difflineminus">-      m_pMimeSection = new char[size];</span>
<a href="#l38.1205"></a><span id="l38.1205" class="difflineminus">-      dSize = ::GetPrivateProfileSection(&quot;Mappings&quot;, m_pMimeSection, size, fileName.get());</span>
<a href="#l38.1206"></a><span id="l38.1206" class="difflineminus">-    }</span>
<a href="#l38.1207"></a><span id="l38.1207" class="difflineminus">-  }</span>
<a href="#l38.1208"></a><span id="l38.1208" class="difflineminus">-</span>
<a href="#l38.1209"></a><span id="l38.1209" class="difflineminus">-  if (!m_pMimeSection)</span>
<a href="#l38.1210"></a><span id="l38.1210" class="difflineminus">-    return;</span>
<a href="#l38.1211"></a><span id="l38.1211" class="difflineminus">-</span>
<a href="#l38.1212"></a><span id="l38.1212" class="difflineminus">-  IMPORT_LOG1(&quot;Looking for mime type for extension: %s\n&quot;, ext.get());</span>
<a href="#l38.1213"></a><span id="l38.1213" class="difflineminus">-</span>
<a href="#l38.1214"></a><span id="l38.1214" class="difflineminus">-  // out/in/both=extension,mac creator,mac type,mime type1,mime type2</span>
<a href="#l38.1215"></a><span id="l38.1215" class="difflineminus">-  const char *pExt = ext.get();</span>
<a href="#l38.1216"></a><span id="l38.1216" class="difflineminus">-  pExt++;</span>
<a href="#l38.1217"></a><span id="l38.1217" class="difflineminus">-</span>
<a href="#l38.1218"></a><span id="l38.1218" class="difflineminus">-  char  *  pChar = m_pMimeSection;</span>
<a href="#l38.1219"></a><span id="l38.1219" class="difflineminus">-  char  *  pStart;</span>
<a href="#l38.1220"></a><span id="l38.1220" class="difflineminus">-  int      len;</span>
<a href="#l38.1221"></a><span id="l38.1221" class="difflineminus">-  nsCString  tStr;</span>
<a href="#l38.1222"></a><span id="l38.1222" class="difflineminus">-  for(;;)</span>
<a href="#l38.1223"></a><span id="l38.1223" class="difflineminus">-  {</span>
<a href="#l38.1224"></a><span id="l38.1224" class="difflineminus">-    while (*pChar != '=')</span>
<a href="#l38.1225"></a><span id="l38.1225" class="difflineminus">-    {</span>
<a href="#l38.1226"></a><span id="l38.1226" class="difflineminus">-      if (!(*pChar) &amp;&amp; !(*(pChar + 1)))</span>
<a href="#l38.1227"></a><span id="l38.1227" class="difflineminus">-        return;</span>
<a href="#l38.1228"></a><span id="l38.1228" class="difflineminus">-      pChar++;</span>
<a href="#l38.1229"></a><span id="l38.1229" class="difflineminus">-    }</span>
<a href="#l38.1230"></a><span id="l38.1230" class="difflineminus">-    if (*pChar)</span>
<a href="#l38.1231"></a><span id="l38.1231" class="difflineminus">-      pChar++;</span>
<a href="#l38.1232"></a><span id="l38.1232" class="difflineminus">-    pStart = pChar;</span>
<a href="#l38.1233"></a><span id="l38.1233" class="difflineminus">-    len = 0;</span>
<a href="#l38.1234"></a><span id="l38.1234" class="difflineminus">-    while (*pChar &amp;&amp; (*pChar != ','))</span>
<a href="#l38.1235"></a><span id="l38.1235" class="difflineminus">-    {</span>
<a href="#l38.1236"></a><span id="l38.1236" class="difflineminus">-      pChar++;</span>
<a href="#l38.1237"></a><span id="l38.1237" class="difflineminus">-      len++;</span>
<a href="#l38.1238"></a><span id="l38.1238" class="difflineminus">-    }</span>
<a href="#l38.1239"></a><span id="l38.1239" class="difflineminus">-    if (!*pChar)</span>
<a href="#l38.1240"></a><span id="l38.1240" class="difflineminus">-      return;</span>
<a href="#l38.1241"></a><span id="l38.1241" class="difflineminus">-</span>
<a href="#l38.1242"></a><span id="l38.1242" class="difflineminus">-    tStr.Truncate();</span>
<a href="#l38.1243"></a><span id="l38.1243" class="difflineminus">-    tStr.Append(pStart, len);</span>
<a href="#l38.1244"></a><span id="l38.1244" class="difflineminus">-    tStr.Trim(kWhitespace);</span>
<a href="#l38.1245"></a><span id="l38.1245" class="difflineminus">-    if (!PL_strcasecmp(tStr.get(), pExt))</span>
<a href="#l38.1246"></a><span id="l38.1246" class="difflineminus">-    {</span>
<a href="#l38.1247"></a><span id="l38.1247" class="difflineminus">-      // skip the mac creator and type</span>
<a href="#l38.1248"></a><span id="l38.1248" class="difflineminus">-      pChar++;</span>
<a href="#l38.1249"></a><span id="l38.1249" class="difflineminus">-      while (*pChar &amp;&amp; (*pChar != ','))</span>
<a href="#l38.1250"></a><span id="l38.1250" class="difflineminus">-        pChar++;</span>
<a href="#l38.1251"></a><span id="l38.1251" class="difflineminus">-      if (!*pChar)</span>
<a href="#l38.1252"></a><span id="l38.1252" class="difflineminus">-        return;</span>
<a href="#l38.1253"></a><span id="l38.1253" class="difflineminus">-</span>
<a href="#l38.1254"></a><span id="l38.1254" class="difflineminus">-      pChar++;</span>
<a href="#l38.1255"></a><span id="l38.1255" class="difflineminus">-      while (*pChar &amp;&amp; (*pChar != ','))</span>
<a href="#l38.1256"></a><span id="l38.1256" class="difflineminus">-        pChar++;</span>
<a href="#l38.1257"></a><span id="l38.1257" class="difflineminus">-      if (!*pChar)</span>
<a href="#l38.1258"></a><span id="l38.1258" class="difflineminus">-        return;</span>
<a href="#l38.1259"></a><span id="l38.1259" class="difflineminus">-</span>
<a href="#l38.1260"></a><span id="l38.1260" class="difflineminus">-      pChar++;</span>
<a href="#l38.1261"></a><span id="l38.1261" class="difflineminus">-      // Get the first mime type</span>
<a href="#l38.1262"></a><span id="l38.1262" class="difflineminus">-      len = 0;</span>
<a href="#l38.1263"></a><span id="l38.1263" class="difflineminus">-      pStart = pChar;</span>
<a href="#l38.1264"></a><span id="l38.1264" class="difflineminus">-      while (*pChar &amp;&amp; (*pChar != ','))</span>
<a href="#l38.1265"></a><span id="l38.1265" class="difflineminus">-      {</span>
<a href="#l38.1266"></a><span id="l38.1266" class="difflineminus">-        pChar++;</span>
<a href="#l38.1267"></a><span id="l38.1267" class="difflineminus">-        len++;</span>
<a href="#l38.1268"></a><span id="l38.1268" class="difflineminus">-      }</span>
<a href="#l38.1269"></a><span id="l38.1269" class="difflineminus">-      if (!*pChar)</span>
<a href="#l38.1270"></a><span id="l38.1270" class="difflineminus">-        return;</span>
<a href="#l38.1271"></a><span id="l38.1271" class="difflineminus">-</span>
<a href="#l38.1272"></a><span id="l38.1272" class="difflineminus">-      pChar++;</span>
<a href="#l38.1273"></a><span id="l38.1273" class="difflineminus">-      if (!len)</span>
<a href="#l38.1274"></a><span id="l38.1274" class="difflineminus">-        continue;</span>
<a href="#l38.1275"></a><span id="l38.1275" class="difflineminus">-</span>
<a href="#l38.1276"></a><span id="l38.1276" class="difflineminus">-      tStr.Truncate();</span>
<a href="#l38.1277"></a><span id="l38.1277" class="difflineminus">-      tStr.Append(pStart, len);</span>
<a href="#l38.1278"></a><span id="l38.1278" class="difflineminus">-      tStr.Trim(kWhitespace);</span>
<a href="#l38.1279"></a><span id="l38.1279" class="difflineminus">-      if (tStr.IsEmpty())</span>
<a href="#l38.1280"></a><span id="l38.1280" class="difflineminus">-        continue;</span>
<a href="#l38.1281"></a><span id="l38.1281" class="difflineminus">-</span>
<a href="#l38.1282"></a><span id="l38.1282" class="difflineminus">-      mimeType.Truncate();</span>
<a href="#l38.1283"></a><span id="l38.1283" class="difflineminus">-      mimeType.Append(tStr.get());</span>
<a href="#l38.1284"></a><span id="l38.1284" class="difflineminus">-      mimeType.Append(&quot;/&quot;);</span>
<a href="#l38.1285"></a><span id="l38.1285" class="difflineminus">-      pStart = pChar;</span>
<a href="#l38.1286"></a><span id="l38.1286" class="difflineminus">-      len = 0;</span>
<a href="#l38.1287"></a><span id="l38.1287" class="difflineminus">-      // Skip to next end of line.</span>
<a href="#l38.1288"></a><span id="l38.1288" class="difflineminus">-      while (*pChar &amp;&amp; (*pChar != nsCRT::CR) &amp;&amp; (*pChar != nsCRT::LF))</span>
<a href="#l38.1289"></a><span id="l38.1289" class="difflineminus">-      {</span>
<a href="#l38.1290"></a><span id="l38.1290" class="difflineminus">-        pChar++;</span>
<a href="#l38.1291"></a><span id="l38.1291" class="difflineminus">-        len++;</span>
<a href="#l38.1292"></a><span id="l38.1292" class="difflineminus">-      }</span>
<a href="#l38.1293"></a><span id="l38.1293" class="difflineminus">-      if (!len)</span>
<a href="#l38.1294"></a><span id="l38.1294" class="difflineminus">-        continue;</span>
<a href="#l38.1295"></a><span id="l38.1295" class="difflineminus">-</span>
<a href="#l38.1296"></a><span id="l38.1296" class="difflineminus">-      tStr.Truncate();</span>
<a href="#l38.1297"></a><span id="l38.1297" class="difflineminus">-      tStr.Append(pStart, len);</span>
<a href="#l38.1298"></a><span id="l38.1298" class="difflineminus">-      tStr.Trim(kWhitespace);</span>
<a href="#l38.1299"></a><span id="l38.1299" class="difflineminus">-      if (tStr.IsEmpty())</span>
<a href="#l38.1300"></a><span id="l38.1300" class="difflineminus">-        continue;</span>
<a href="#l38.1301"></a><span id="l38.1301" class="difflineminus">-</span>
<a href="#l38.1302"></a><span id="l38.1302" class="difflineminus">-      mimeType.Append(tStr.get());</span>
<a href="#l38.1303"></a><span id="l38.1303" class="difflineminus">-</span>
<a href="#l38.1304"></a><span id="l38.1304" class="difflineminus">-      IMPORT_LOG1(&quot;Found Mime Type: %s\n&quot;, mimeType.get());</span>
<a href="#l38.1305"></a><span id="l38.1305" class="difflineminus">-</span>
<a href="#l38.1306"></a><span id="l38.1306" class="difflineminus">-      return;</span>
<a href="#l38.1307"></a><span id="l38.1307" class="difflineminus">-    }</span>
<a href="#l38.1308"></a><span id="l38.1308" class="difflineminus">-  }</span>
<a href="#l38.1309"></a><span id="l38.1309" class="difflineminus">-}</span>
<a href="#l38.1310"></a><span id="l38.1310" class="difflineminus">-</span>
<a href="#l38.1311"></a><span id="l38.1311" class="difflineminus">-bool nsEudoraWin32::FindAddressFolder(nsIFile **pFolder)</span>
<a href="#l38.1312"></a><span id="l38.1312" class="difflineminus">-{</span>
<a href="#l38.1313"></a><span id="l38.1313" class="difflineminus">-  IMPORT_LOG0(&quot;*** Looking for Eudora address folder\n&quot;);</span>
<a href="#l38.1314"></a><span id="l38.1314" class="difflineminus">-</span>
<a href="#l38.1315"></a><span id="l38.1315" class="difflineminus">-  return FindEudoraLocation(pFolder);</span>
<a href="#l38.1316"></a><span id="l38.1316" class="difflineminus">-}</span>
<a href="#l38.1317"></a><span id="l38.1317" class="difflineminus">-</span>
<a href="#l38.1318"></a><span id="l38.1318" class="difflineminus">-nsresult nsEudoraWin32::FindAddressBooks(nsIFile *pRoot, nsIMutableArray *pArray)</span>
<a href="#l38.1319"></a><span id="l38.1319" class="difflineminus">-{</span>
<a href="#l38.1320"></a><span id="l38.1320" class="difflineminus">-  nsresult rv;</span>
<a href="#l38.1321"></a><span id="l38.1321" class="difflineminus">-  nsCOMPtr&lt;nsIFile&gt; file = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l38.1322"></a><span id="l38.1322" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l38.1323"></a><span id="l38.1323" class="difflineminus">-  rv = file-&gt;InitWithFile(pRoot);</span>
<a href="#l38.1324"></a><span id="l38.1324" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l38.1325"></a><span id="l38.1325" class="difflineminus">-</span>
<a href="#l38.1326"></a><span id="l38.1326" class="difflineminus">-  nsCOMPtr&lt;nsIImportService&gt; impSvc(do_GetService(NS_IMPORTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l38.1327"></a><span id="l38.1327" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l38.1328"></a><span id="l38.1328" class="difflineminus">-    return rv;</span>
<a href="#l38.1329"></a><span id="l38.1329" class="difflineminus">-  m_addressImportFolder = pRoot;</span>
<a href="#l38.1330"></a><span id="l38.1330" class="difflineminus">-  nsString    displayName;</span>
<a href="#l38.1331"></a><span id="l38.1331" class="difflineminus">-  nsEudoraStringBundle::GetStringByID(EUDORAIMPORT_NICKNAMES_NAME, displayName);</span>
<a href="#l38.1332"></a><span id="l38.1332" class="difflineminus">-</span>
<a href="#l38.1333"></a><span id="l38.1333" class="difflineminus">-  // First off, get the default nndbase.txt, then scan the default nicknames subdir,</span>
<a href="#l38.1334"></a><span id="l38.1334" class="difflineminus">-  // then look in the .ini file for additional directories to scan for address books!</span>
<a href="#l38.1335"></a><span id="l38.1335" class="difflineminus">-  bool exists = false;</span>
<a href="#l38.1336"></a><span id="l38.1336" class="difflineminus">-  bool isFile = false;</span>
<a href="#l38.1337"></a><span id="l38.1337" class="difflineminus">-</span>
<a href="#l38.1338"></a><span id="l38.1338" class="difflineminus">-  rv = file-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;nndbase.txt&quot;));</span>
<a href="#l38.1339"></a><span id="l38.1339" class="difflineminus">-  bool checkedBoth = false;</span>
<a href="#l38.1340"></a><span id="l38.1340" class="difflineminus">-  do</span>
<a href="#l38.1341"></a><span id="l38.1341" class="difflineminus">-  {</span>
<a href="#l38.1342"></a><span id="l38.1342" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l38.1343"></a><span id="l38.1343" class="difflineminus">-      rv = file-&gt;Exists(&amp;exists);</span>
<a href="#l38.1344"></a><span id="l38.1344" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; exists)</span>
<a href="#l38.1345"></a><span id="l38.1345" class="difflineminus">-      rv = file-&gt;IsFile(&amp;isFile);</span>
<a href="#l38.1346"></a><span id="l38.1346" class="difflineminus">-</span>
<a href="#l38.1347"></a><span id="l38.1347" class="difflineminus">-    // Stop if we already checked the second default name possibility or</span>
<a href="#l38.1348"></a><span id="l38.1348" class="difflineminus">-    // if we found the default address book name.</span>
<a href="#l38.1349"></a><span id="l38.1349" class="difflineminus">-    if (checkedBoth || (exists &amp;&amp; isFile))</span>
<a href="#l38.1350"></a><span id="l38.1350" class="difflineminus">-      break;</span>
<a href="#l38.1351"></a><span id="l38.1351" class="difflineminus">-</span>
<a href="#l38.1352"></a><span id="l38.1352" class="difflineminus">-    // Check for alternate file extension &quot;.nnt&quot; which Windows Eudora uses as an option</span>
<a href="#l38.1353"></a><span id="l38.1353" class="difflineminus">-    // to hide from simple minded viruses that scan &quot;.txt&quot; files for addresses.</span>
<a href="#l38.1354"></a><span id="l38.1354" class="difflineminus">-    rv = file-&gt;SetNativeLeafName(NS_LITERAL_CSTRING(&quot;nndbase.nnt&quot;));</span>
<a href="#l38.1355"></a><span id="l38.1355" class="difflineminus">-    checkedBoth = true;</span>
<a href="#l38.1356"></a><span id="l38.1356" class="difflineminus">-  } while (NS_SUCCEEDED(rv));</span>
<a href="#l38.1357"></a><span id="l38.1357" class="difflineminus">-</span>
<a href="#l38.1358"></a><span id="l38.1358" class="difflineminus">-  if (exists &amp;&amp; isFile)</span>
<a href="#l38.1359"></a><span id="l38.1359" class="difflineminus">-  {</span>
<a href="#l38.1360"></a><span id="l38.1360" class="difflineminus">-    if (NS_FAILED(rv = FoundAddressBook(file, displayName.get(), pArray, impSvc)))</span>
<a href="#l38.1361"></a><span id="l38.1361" class="difflineminus">-      return rv;</span>
<a href="#l38.1362"></a><span id="l38.1362" class="difflineminus">-  }</span>
<a href="#l38.1363"></a><span id="l38.1363" class="difflineminus">-</span>
<a href="#l38.1364"></a><span id="l38.1364" class="difflineminus">-  // Try the default directory</span>
<a href="#l38.1365"></a><span id="l38.1365" class="difflineminus">-  rv = file-&gt;InitWithFile(pRoot);</span>
<a href="#l38.1366"></a><span id="l38.1366" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l38.1367"></a><span id="l38.1367" class="difflineminus">-    return rv;</span>
<a href="#l38.1368"></a><span id="l38.1368" class="difflineminus">-  rv = file-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;Nickname&quot;));</span>
<a href="#l38.1369"></a><span id="l38.1369" class="difflineminus">-  bool isDir = false;</span>
<a href="#l38.1370"></a><span id="l38.1370" class="difflineminus">-  exists = false;</span>
<a href="#l38.1371"></a><span id="l38.1371" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l38.1372"></a><span id="l38.1372" class="difflineminus">-    rv = file-&gt;Exists(&amp;exists);</span>
<a href="#l38.1373"></a><span id="l38.1373" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; exists)</span>
<a href="#l38.1374"></a><span id="l38.1374" class="difflineminus">-    rv = file-&gt;IsDirectory(&amp;isDir);</span>
<a href="#l38.1375"></a><span id="l38.1375" class="difflineminus">-  if (exists &amp;&amp; isDir)</span>
<a href="#l38.1376"></a><span id="l38.1376" class="difflineminus">-  {</span>
<a href="#l38.1377"></a><span id="l38.1377" class="difflineminus">-    if (NS_FAILED(rv = ScanAddressDir(file, pArray, impSvc)))</span>
<a href="#l38.1378"></a><span id="l38.1378" class="difflineminus">-      return rv;</span>
<a href="#l38.1379"></a><span id="l38.1379" class="difflineminus">-  }</span>
<a href="#l38.1380"></a><span id="l38.1380" class="difflineminus">-</span>
<a href="#l38.1381"></a><span id="l38.1381" class="difflineminus">-  // Try the ini file to find other directories!</span>
<a href="#l38.1382"></a><span id="l38.1382" class="difflineminus">-  rv = file-&gt;InitWithFile(pRoot);</span>
<a href="#l38.1383"></a><span id="l38.1383" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l38.1384"></a><span id="l38.1384" class="difflineminus">-    return rv;</span>
<a href="#l38.1385"></a><span id="l38.1385" class="difflineminus">-  rv = file-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;eudora.ini&quot;));</span>
<a href="#l38.1386"></a><span id="l38.1386" class="difflineminus">-  exists = false;</span>
<a href="#l38.1387"></a><span id="l38.1387" class="difflineminus">-  isFile = false;</span>
<a href="#l38.1388"></a><span id="l38.1388" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l38.1389"></a><span id="l38.1389" class="difflineminus">-    rv = file-&gt;Exists(&amp;exists);</span>
<a href="#l38.1390"></a><span id="l38.1390" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; exists)</span>
<a href="#l38.1391"></a><span id="l38.1391" class="difflineminus">-    rv = file-&gt;IsFile(&amp;isFile);</span>
<a href="#l38.1392"></a><span id="l38.1392" class="difflineminus">-</span>
<a href="#l38.1393"></a><span id="l38.1393" class="difflineminus">-  if (!isFile || !exists)</span>
<a href="#l38.1394"></a><span id="l38.1394" class="difflineminus">-  {</span>
<a href="#l38.1395"></a><span id="l38.1395" class="difflineminus">-    rv = file-&gt;InitWithFile(pRoot);</span>
<a href="#l38.1396"></a><span id="l38.1396" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l38.1397"></a><span id="l38.1397" class="difflineminus">-      return NS_OK;</span>
<a href="#l38.1398"></a><span id="l38.1398" class="difflineminus">-    if (!FindMimeIniFile(file))</span>
<a href="#l38.1399"></a><span id="l38.1399" class="difflineminus">-      return NS_OK;</span>
<a href="#l38.1400"></a><span id="l38.1400" class="difflineminus">-  }</span>
<a href="#l38.1401"></a><span id="l38.1401" class="difflineminus">-</span>
<a href="#l38.1402"></a><span id="l38.1402" class="difflineminus">-  nsCString fileName;</span>
<a href="#l38.1403"></a><span id="l38.1403" class="difflineminus">-  file-&gt;GetNativePath(fileName);</span>
<a href="#l38.1404"></a><span id="l38.1404" class="difflineminus">-  // This is the supposed ini file name!</span>
<a href="#l38.1405"></a><span id="l38.1405" class="difflineminus">-  // Get the extra directories for nicknames and parse it for valid nickname directories</span>
<a href="#l38.1406"></a><span id="l38.1406" class="difflineminus">-  // to look into...</span>
<a href="#l38.1407"></a><span id="l38.1407" class="difflineminus">-  char *pBuffer = new char[2048];</span>
<a href="#l38.1408"></a><span id="l38.1408" class="difflineminus">-  DWORD len = ::GetPrivateProfileString(&quot;Settings&quot;, &quot;ExtraNicknameDirs&quot;, &quot;&quot;, pBuffer, 2048, fileName.get());</span>
<a href="#l38.1409"></a><span id="l38.1409" class="difflineminus">-  if (len == 2047)</span>
<a href="#l38.1410"></a><span id="l38.1410" class="difflineminus">-  {</span>
<a href="#l38.1411"></a><span id="l38.1411" class="difflineminus">-    // If the value is really that large then don't bother!</span>
<a href="#l38.1412"></a><span id="l38.1412" class="difflineminus">-    delete [] pBuffer;</span>
<a href="#l38.1413"></a><span id="l38.1413" class="difflineminus">-    return NS_OK;</span>
<a href="#l38.1414"></a><span id="l38.1414" class="difflineminus">-  }</span>
<a href="#l38.1415"></a><span id="l38.1415" class="difflineminus">-  nsCString  dirs(pBuffer);</span>
<a href="#l38.1416"></a><span id="l38.1416" class="difflineminus">-  delete [] pBuffer;</span>
<a href="#l38.1417"></a><span id="l38.1417" class="difflineminus">-  dirs.Trim(kWhitespace);</span>
<a href="#l38.1418"></a><span id="l38.1418" class="difflineminus">-  int32_t  idx = 0;</span>
<a href="#l38.1419"></a><span id="l38.1419" class="difflineminus">-  nsCString  currentDir;</span>
<a href="#l38.1420"></a><span id="l38.1420" class="difflineminus">-  while ((idx = dirs.FindChar(';')) != -1)</span>
<a href="#l38.1421"></a><span id="l38.1421" class="difflineminus">-  {</span>
<a href="#l38.1422"></a><span id="l38.1422" class="difflineminus">-    currentDir = StringHead(dirs, idx);</span>
<a href="#l38.1423"></a><span id="l38.1423" class="difflineminus">-    currentDir.Trim(kWhitespace);</span>
<a href="#l38.1424"></a><span id="l38.1424" class="difflineminus">-    if (!currentDir.IsEmpty())</span>
<a href="#l38.1425"></a><span id="l38.1425" class="difflineminus">-    {</span>
<a href="#l38.1426"></a><span id="l38.1426" class="difflineminus">-      rv = file-&gt;InitWithNativePath(currentDir);</span>
<a href="#l38.1427"></a><span id="l38.1427" class="difflineminus">-      exists = false;</span>
<a href="#l38.1428"></a><span id="l38.1428" class="difflineminus">-      isDir = false;</span>
<a href="#l38.1429"></a><span id="l38.1429" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l38.1430"></a><span id="l38.1430" class="difflineminus">-        rv = file-&gt;Exists(&amp;exists);</span>
<a href="#l38.1431"></a><span id="l38.1431" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; exists)</span>
<a href="#l38.1432"></a><span id="l38.1432" class="difflineminus">-        rv = file-&gt;IsDirectory(&amp;isDir);</span>
<a href="#l38.1433"></a><span id="l38.1433" class="difflineminus">-      if (exists &amp;&amp; isDir)</span>
<a href="#l38.1434"></a><span id="l38.1434" class="difflineminus">-      {</span>
<a href="#l38.1435"></a><span id="l38.1435" class="difflineminus">-        if (NS_FAILED(rv = ScanAddressDir(file, pArray, impSvc)))</span>
<a href="#l38.1436"></a><span id="l38.1436" class="difflineminus">-          return rv;</span>
<a href="#l38.1437"></a><span id="l38.1437" class="difflineminus">-      }</span>
<a href="#l38.1438"></a><span id="l38.1438" class="difflineminus">-    }</span>
<a href="#l38.1439"></a><span id="l38.1439" class="difflineminus">-    dirs = Substring(dirs, idx + 1);</span>
<a href="#l38.1440"></a><span id="l38.1440" class="difflineminus">-    dirs.Trim(kWhitespace);</span>
<a href="#l38.1441"></a><span id="l38.1441" class="difflineminus">-  }</span>
<a href="#l38.1442"></a><span id="l38.1442" class="difflineminus">-  if (!dirs.IsEmpty())</span>
<a href="#l38.1443"></a><span id="l38.1443" class="difflineminus">-  {</span>
<a href="#l38.1444"></a><span id="l38.1444" class="difflineminus">-    rv = file-&gt;InitWithNativePath(dirs);</span>
<a href="#l38.1445"></a><span id="l38.1445" class="difflineminus">-    exists = false;</span>
<a href="#l38.1446"></a><span id="l38.1446" class="difflineminus">-    isDir = false;</span>
<a href="#l38.1447"></a><span id="l38.1447" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l38.1448"></a><span id="l38.1448" class="difflineminus">-      rv = file-&gt;Exists(&amp;exists);</span>
<a href="#l38.1449"></a><span id="l38.1449" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; exists)</span>
<a href="#l38.1450"></a><span id="l38.1450" class="difflineminus">-      rv = file-&gt;IsDirectory(&amp;isDir);</span>
<a href="#l38.1451"></a><span id="l38.1451" class="difflineminus">-    if (exists &amp;&amp; isDir)</span>
<a href="#l38.1452"></a><span id="l38.1452" class="difflineminus">-    {</span>
<a href="#l38.1453"></a><span id="l38.1453" class="difflineminus">-      if (NS_FAILED(rv = ScanAddressDir(file, pArray, impSvc)))</span>
<a href="#l38.1454"></a><span id="l38.1454" class="difflineminus">-        return rv;</span>
<a href="#l38.1455"></a><span id="l38.1455" class="difflineminus">-    }</span>
<a href="#l38.1456"></a><span id="l38.1456" class="difflineminus">-  }</span>
<a href="#l38.1457"></a><span id="l38.1457" class="difflineminus">-  return NS_OK;</span>
<a href="#l38.1458"></a><span id="l38.1458" class="difflineminus">-}</span>
<a href="#l38.1459"></a><span id="l38.1459" class="difflineminus">-</span>
<a href="#l38.1460"></a><span id="l38.1460" class="difflineminus">-</span>
<a href="#l38.1461"></a><span id="l38.1461" class="difflineminus">-nsresult nsEudoraWin32::ScanAddressDir(nsIFile *pDir, nsIMutableArray *pArray, nsIImportService *impSvc)</span>
<a href="#l38.1462"></a><span id="l38.1462" class="difflineminus">-{</span>
<a href="#l38.1463"></a><span id="l38.1463" class="difflineminus">-  bool hasMore;</span>
<a href="#l38.1464"></a><span id="l38.1464" class="difflineminus">-  nsCOMPtr&lt;nsISimpleEnumerator&gt; directoryEnumerator;</span>
<a href="#l38.1465"></a><span id="l38.1465" class="difflineminus">-  nsresult rv = pDir-&gt;GetDirectoryEntries(getter_AddRefs(directoryEnumerator));</span>
<a href="#l38.1466"></a><span id="l38.1466" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l38.1467"></a><span id="l38.1467" class="difflineminus">-</span>
<a href="#l38.1468"></a><span id="l38.1468" class="difflineminus">-  directoryEnumerator-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l38.1469"></a><span id="l38.1469" class="difflineminus">-  bool              isFile;</span>
<a href="#l38.1470"></a><span id="l38.1470" class="difflineminus">-  nsCOMPtr&lt;nsIFile&gt; entry;</span>
<a href="#l38.1471"></a><span id="l38.1471" class="difflineminus">-  nsCString         fName;</span>
<a href="#l38.1472"></a><span id="l38.1472" class="difflineminus">-  nsCString         ext;</span>
<a href="#l38.1473"></a><span id="l38.1473" class="difflineminus">-  nsCString         name;</span>
<a href="#l38.1474"></a><span id="l38.1474" class="difflineminus">-</span>
<a href="#l38.1475"></a><span id="l38.1475" class="difflineminus">-  bool found = false;</span>
<a href="#l38.1476"></a><span id="l38.1476" class="difflineminus">-</span>
<a href="#l38.1477"></a><span id="l38.1477" class="difflineminus">-  while (hasMore &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l38.1478"></a><span id="l38.1478" class="difflineminus">-  {</span>
<a href="#l38.1479"></a><span id="l38.1479" class="difflineminus">-    nsCOMPtr&lt;nsISupports&gt; aSupport;</span>
<a href="#l38.1480"></a><span id="l38.1480" class="difflineminus">-    rv = directoryEnumerator-&gt;GetNext(getter_AddRefs(aSupport));</span>
<a href="#l38.1481"></a><span id="l38.1481" class="difflineminus">-    nsCOMPtr&lt;nsIFile&gt; entry(do_QueryInterface(aSupport, &amp;rv));</span>
<a href="#l38.1482"></a><span id="l38.1482" class="difflineminus">-    directoryEnumerator-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l38.1483"></a><span id="l38.1483" class="difflineminus">-</span>
<a href="#l38.1484"></a><span id="l38.1484" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l38.1485"></a><span id="l38.1485" class="difflineminus">-    {</span>
<a href="#l38.1486"></a><span id="l38.1486" class="difflineminus">-      rv = entry-&gt;GetNativeLeafName(fName);</span>
<a href="#l38.1487"></a><span id="l38.1487" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; !fName.IsEmpty())</span>
<a href="#l38.1488"></a><span id="l38.1488" class="difflineminus">-      {</span>
<a href="#l38.1489"></a><span id="l38.1489" class="difflineminus">-        if (fName.Length() &gt; 4)</span>
<a href="#l38.1490"></a><span id="l38.1490" class="difflineminus">-        {</span>
<a href="#l38.1491"></a><span id="l38.1491" class="difflineminus">-          ext = StringTail(fName, 4);</span>
<a href="#l38.1492"></a><span id="l38.1492" class="difflineminus">-          name = StringHead(fName, fName.Length() - 4);</span>
<a href="#l38.1493"></a><span id="l38.1493" class="difflineminus">-        }</span>
<a href="#l38.1494"></a><span id="l38.1494" class="difflineminus">-        else</span>
<a href="#l38.1495"></a><span id="l38.1495" class="difflineminus">-        {</span>
<a href="#l38.1496"></a><span id="l38.1496" class="difflineminus">-          ext.Truncate();</span>
<a href="#l38.1497"></a><span id="l38.1497" class="difflineminus">-          name = fName;</span>
<a href="#l38.1498"></a><span id="l38.1498" class="difflineminus">-        }</span>
<a href="#l38.1499"></a><span id="l38.1499" class="difflineminus">-        ToLowerCase(ext);</span>
<a href="#l38.1500"></a><span id="l38.1500" class="difflineminus">-        if (ext.EqualsLiteral(&quot;.txt&quot;))</span>
<a href="#l38.1501"></a><span id="l38.1501" class="difflineminus">-        {</span>
<a href="#l38.1502"></a><span id="l38.1502" class="difflineminus">-          isFile = false;</span>
<a href="#l38.1503"></a><span id="l38.1503" class="difflineminus">-          entry-&gt;IsFile(&amp;isFile);</span>
<a href="#l38.1504"></a><span id="l38.1504" class="difflineminus">-          if (isFile)</span>
<a href="#l38.1505"></a><span id="l38.1505" class="difflineminus">-          {</span>
<a href="#l38.1506"></a><span id="l38.1506" class="difflineminus">-            rv = FoundAddressBook(entry, nullptr, pArray, impSvc);</span>
<a href="#l38.1507"></a><span id="l38.1507" class="difflineminus">-            if (NS_FAILED(rv))</span>
<a href="#l38.1508"></a><span id="l38.1508" class="difflineminus">-              return rv;</span>
<a href="#l38.1509"></a><span id="l38.1509" class="difflineminus">-          }</span>
<a href="#l38.1510"></a><span id="l38.1510" class="difflineminus">-        }</span>
<a href="#l38.1511"></a><span id="l38.1511" class="difflineminus">-      }</span>
<a href="#l38.1512"></a><span id="l38.1512" class="difflineminus">-    }</span>
<a href="#l38.1513"></a><span id="l38.1513" class="difflineminus">-  }</span>
<a href="#l38.1514"></a><span id="l38.1514" class="difflineminus">-</span>
<a href="#l38.1515"></a><span id="l38.1515" class="difflineminus">-  return rv;</span>
<a href="#l38.1516"></a><span id="l38.1516" class="difflineminus">-}</span>
<a href="#l38.1517"></a><span id="l38.1517" class="difflineminus">-</span>
<a href="#l38.1518"></a><span id="l38.1518" class="difflineminus">-</span>
<a href="#l38.1519"></a><span id="l38.1519" class="difflineminus">-nsresult nsEudoraWin32::FoundAddressBook(nsIFile *file, const char16_t *pName, nsIMutableArray *pArray, nsIImportService *impSvc)</span>
<a href="#l38.1520"></a><span id="l38.1520" class="difflineminus">-{</span>
<a href="#l38.1521"></a><span id="l38.1521" class="difflineminus">-  nsCOMPtr&lt;nsIImportABDescriptor&gt; desc;</span>
<a href="#l38.1522"></a><span id="l38.1522" class="difflineminus">-  nsISupports *  pInterface;</span>
<a href="#l38.1523"></a><span id="l38.1523" class="difflineminus">-  nsString name;</span>
<a href="#l38.1524"></a><span id="l38.1524" class="difflineminus">-  nsresult rv;</span>
<a href="#l38.1525"></a><span id="l38.1525" class="difflineminus">-</span>
<a href="#l38.1526"></a><span id="l38.1526" class="difflineminus">-  if (pName)</span>
<a href="#l38.1527"></a><span id="l38.1527" class="difflineminus">-    name = pName;</span>
<a href="#l38.1528"></a><span id="l38.1528" class="difflineminus">-  else {</span>
<a href="#l38.1529"></a><span id="l38.1529" class="difflineminus">-    nsAutoString leaf;</span>
<a href="#l38.1530"></a><span id="l38.1530" class="difflineminus">-    rv = file-&gt;GetLeafName(leaf);</span>
<a href="#l38.1531"></a><span id="l38.1531" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l38.1532"></a><span id="l38.1532" class="difflineminus">-      return rv;</span>
<a href="#l38.1533"></a><span id="l38.1533" class="difflineminus">-    if (leaf.IsEmpty())</span>
<a href="#l38.1534"></a><span id="l38.1534" class="difflineminus">-      return NS_ERROR_FAILURE;</span>
<a href="#l38.1535"></a><span id="l38.1535" class="difflineminus">-    nsString  tStr;</span>
<a href="#l38.1536"></a><span id="l38.1536" class="difflineminus">-    tStr = StringTail(leaf, 4);</span>
<a href="#l38.1537"></a><span id="l38.1537" class="difflineminus">-    if (tStr.LowerCaseEqualsLiteral(&quot;.txt&quot;)  || tStr.LowerCaseEqualsLiteral(&quot;.nnt&quot;))</span>
<a href="#l38.1538"></a><span id="l38.1538" class="difflineminus">-      leaf.SetLength(leaf.Length() - 4);</span>
<a href="#l38.1539"></a><span id="l38.1539" class="difflineminus">-  }</span>
<a href="#l38.1540"></a><span id="l38.1540" class="difflineminus">-</span>
<a href="#l38.1541"></a><span id="l38.1541" class="difflineminus">-  rv = impSvc-&gt;CreateNewABDescriptor(getter_AddRefs(desc));</span>
<a href="#l38.1542"></a><span id="l38.1542" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l38.1543"></a><span id="l38.1543" class="difflineminus">-  {</span>
<a href="#l38.1544"></a><span id="l38.1544" class="difflineminus">-    int64_t sz = 0;</span>
<a href="#l38.1545"></a><span id="l38.1545" class="difflineminus">-    file-&gt;GetFileSize(&amp;sz);</span>
<a href="#l38.1546"></a><span id="l38.1546" class="difflineminus">-    desc-&gt;SetPreferredName(name);</span>
<a href="#l38.1547"></a><span id="l38.1547" class="difflineminus">-    desc-&gt;SetSize((uint32_t) sz);</span>
<a href="#l38.1548"></a><span id="l38.1548" class="difflineminus">-    desc-&gt;SetAbFile(file);</span>
<a href="#l38.1549"></a><span id="l38.1549" class="difflineminus">-    rv = desc-&gt;QueryInterface(kISupportsIID, (void **) &amp;pInterface);</span>
<a href="#l38.1550"></a><span id="l38.1550" class="difflineminus">-    pArray-&gt;AppendElement(pInterface, false);</span>
<a href="#l38.1551"></a><span id="l38.1551" class="difflineminus">-    pInterface-&gt;Release();</span>
<a href="#l38.1552"></a><span id="l38.1552" class="difflineminus">-  }</span>
<a href="#l38.1553"></a><span id="l38.1553" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l38.1554"></a><span id="l38.1554" class="difflineminus">-  {</span>
<a href="#l38.1555"></a><span id="l38.1555" class="difflineminus">-    IMPORT_LOG0(&quot;*** Error creating address book descriptor for eudora\n&quot;);</span>
<a href="#l38.1556"></a><span id="l38.1556" class="difflineminus">-    return rv;</span>
<a href="#l38.1557"></a><span id="l38.1557" class="difflineminus">-  }</span>
<a href="#l38.1558"></a><span id="l38.1558" class="difflineminus">-</span>
<a href="#l38.1559"></a><span id="l38.1559" class="difflineminus">-  return NS_OK;</span>
<a href="#l38.1560"></a><span id="l38.1560" class="difflineminus">-}</span>
<a href="#l38.1561"></a><span id="l38.1561" class="difflineminus">-</span>
<a href="#l38.1562"></a><span id="l38.1562" class="difflineminus">-</span>
<a href="#l38.1563"></a><span id="l38.1563" class="difflineminus">-void nsEudoraWin32::ConvertPath(nsCString&amp; str)</span>
<a href="#l38.1564"></a><span id="l38.1564" class="difflineminus">-{</span>
<a href="#l38.1565"></a><span id="l38.1565" class="difflineminus">-  nsCString  temp;</span>
<a href="#l38.1566"></a><span id="l38.1566" class="difflineminus">-  nsCString  path;</span>
<a href="#l38.1567"></a><span id="l38.1567" class="difflineminus">-  int32_t    idx = 0;</span>
<a href="#l38.1568"></a><span id="l38.1568" class="difflineminus">-  int32_t    start = 0;</span>
<a href="#l38.1569"></a><span id="l38.1569" class="difflineminus">-  nsCString  search;</span>
<a href="#l38.1570"></a><span id="l38.1570" class="difflineminus">-</span>
<a href="#l38.1571"></a><span id="l38.1571" class="difflineminus">-  idx = str.FindChar('\\', idx);</span>
<a href="#l38.1572"></a><span id="l38.1572" class="difflineminus">-  if ((idx == 2) &amp;&amp; (str.CharAt(1) == ':'))</span>
<a href="#l38.1573"></a><span id="l38.1573" class="difflineminus">-  {</span>
<a href="#l38.1574"></a><span id="l38.1574" class="difflineminus">-    path = StringHead(str, 3);</span>
<a href="#l38.1575"></a><span id="l38.1575" class="difflineminus">-    idx++;</span>
<a href="#l38.1576"></a><span id="l38.1576" class="difflineminus">-    idx = str.FindChar('\\', idx);</span>
<a href="#l38.1577"></a><span id="l38.1577" class="difflineminus">-    start = 3;</span>
<a href="#l38.1578"></a><span id="l38.1578" class="difflineminus">-    if ((idx == -1) &amp;&amp; (str.Length() &gt; 3))</span>
<a href="#l38.1579"></a><span id="l38.1579" class="difflineminus">-      path.Append(Substring(str, start));</span>
<a href="#l38.1580"></a><span id="l38.1580" class="difflineminus">-  }</span>
<a href="#l38.1581"></a><span id="l38.1581" class="difflineminus">-</span>
<a href="#l38.1582"></a><span id="l38.1582" class="difflineminus">-  WIN32_FIND_DATA findFileData;</span>
<a href="#l38.1583"></a><span id="l38.1583" class="difflineminus">-  while (idx != -1)</span>
<a href="#l38.1584"></a><span id="l38.1584" class="difflineminus">-  {</span>
<a href="#l38.1585"></a><span id="l38.1585" class="difflineminus">-    search = path;</span>
<a href="#l38.1586"></a><span id="l38.1586" class="difflineminus">-    search.Append(Substring(str, start, idx - start));</span>
<a href="#l38.1587"></a><span id="l38.1587" class="difflineminus">-    HANDLE h = FindFirstFile(search.get(), &amp;findFileData);</span>
<a href="#l38.1588"></a><span id="l38.1588" class="difflineminus">-    if (h == INVALID_HANDLE_VALUE)</span>
<a href="#l38.1589"></a><span id="l38.1589" class="difflineminus">-      return;</span>
<a href="#l38.1590"></a><span id="l38.1590" class="difflineminus">-    path.Append(findFileData.cFileName);</span>
<a href="#l38.1591"></a><span id="l38.1591" class="difflineminus">-    idx++;</span>
<a href="#l38.1592"></a><span id="l38.1592" class="difflineminus">-    start = idx;</span>
<a href="#l38.1593"></a><span id="l38.1593" class="difflineminus">-    idx = str.FindChar('\\', idx);</span>
<a href="#l38.1594"></a><span id="l38.1594" class="difflineminus">-    FindClose(h);</span>
<a href="#l38.1595"></a><span id="l38.1595" class="difflineminus">-    if (idx != -1)</span>
<a href="#l38.1596"></a><span id="l38.1596" class="difflineminus">-      path.Append('\\');</span>
<a href="#l38.1597"></a><span id="l38.1597" class="difflineminus">-    else</span>
<a href="#l38.1598"></a><span id="l38.1598" class="difflineminus">-    {</span>
<a href="#l38.1599"></a><span id="l38.1599" class="difflineminus">-      path.Append('\\');</span>
<a href="#l38.1600"></a><span id="l38.1600" class="difflineminus">-      path.Append(Substring(str, start));</span>
<a href="#l38.1601"></a><span id="l38.1601" class="difflineminus">-    }</span>
<a href="#l38.1602"></a><span id="l38.1602" class="difflineminus">-  }</span>
<a href="#l38.1603"></a><span id="l38.1603" class="difflineminus">-</span>
<a href="#l38.1604"></a><span id="l38.1604" class="difflineminus">-  str = path;</span>
<a href="#l38.1605"></a><span id="l38.1605" class="difflineminus">-}</span>
<a href="#l38.1606"></a><span id="l38.1606" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l39.1"></a><span id="l39.1">deleted file mode 100644</span>
<a href="#l39.2"></a><span id="l39.2" class="difflineminus">--- a/mailnews/import/eudora/src/nsEudoraWin32.h</span>
<a href="#l39.3"></a><span id="l39.3" class="difflineplus">+++ /dev/null</span>
<a href="#l39.4"></a><span id="l39.4" class="difflineat">@@ -1,88 +0,0 @@</span>
<a href="#l39.5"></a><span id="l39.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l39.6"></a><span id="l39.6" class="difflineminus">- *</span>
<a href="#l39.7"></a><span id="l39.7" class="difflineminus">- * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l39.8"></a><span id="l39.8" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l39.9"></a><span id="l39.9" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l39.10"></a><span id="l39.10" class="difflineminus">-</span>
<a href="#l39.11"></a><span id="l39.11" class="difflineminus">-#ifndef nsEudoraWin32_h__</span>
<a href="#l39.12"></a><span id="l39.12" class="difflineminus">-#define nsEudoraWin32_h__</span>
<a href="#l39.13"></a><span id="l39.13" class="difflineminus">-</span>
<a href="#l39.14"></a><span id="l39.14" class="difflineminus">-#include &quot;mozilla/Attributes.h&quot;</span>
<a href="#l39.15"></a><span id="l39.15" class="difflineminus">-#include &quot;nscore.h&quot;</span>
<a href="#l39.16"></a><span id="l39.16" class="difflineminus">-#include &quot;nsStringGlue.h&quot;</span>
<a href="#l39.17"></a><span id="l39.17" class="difflineminus">-#include &quot;nsIFile.h&quot;</span>
<a href="#l39.18"></a><span id="l39.18" class="difflineminus">-#include &quot;nsEudoraMailbox.h&quot;</span>
<a href="#l39.19"></a><span id="l39.19" class="difflineminus">-#include &quot;nsEudoraAddress.h&quot;</span>
<a href="#l39.20"></a><span id="l39.20" class="difflineminus">-</span>
<a href="#l39.21"></a><span id="l39.21" class="difflineminus">-#include &lt;windows.h&gt;</span>
<a href="#l39.22"></a><span id="l39.22" class="difflineminus">-</span>
<a href="#l39.23"></a><span id="l39.23" class="difflineminus">-class nsIImportService;</span>
<a href="#l39.24"></a><span id="l39.24" class="difflineminus">-class nsIMsgAccountManager;</span>
<a href="#l39.25"></a><span id="l39.25" class="difflineminus">-class nsIMsgAccount;</span>
<a href="#l39.26"></a><span id="l39.26" class="difflineminus">-class nsIMutableArray;</span>
<a href="#l39.27"></a><span id="l39.27" class="difflineminus">-</span>
<a href="#l39.28"></a><span id="l39.28" class="difflineminus">-</span>
<a href="#l39.29"></a><span id="l39.29" class="difflineminus">-class nsEudoraWin32 : public nsEudoraMailbox, public nsEudoraAddress {</span>
<a href="#l39.30"></a><span id="l39.30" class="difflineminus">-public:</span>
<a href="#l39.31"></a><span id="l39.31" class="difflineminus">-  nsEudoraWin32();</span>
<a href="#l39.32"></a><span id="l39.32" class="difflineminus">-  ~nsEudoraWin32();</span>
<a href="#l39.33"></a><span id="l39.33" class="difflineminus">-</span>
<a href="#l39.34"></a><span id="l39.34" class="difflineminus">-    // retrieve the mail folder</span>
<a href="#l39.35"></a><span id="l39.35" class="difflineminus">-  virtual bool      FindMailFolder(nsIFile **pFolder) override;</span>
<a href="#l39.36"></a><span id="l39.36" class="difflineminus">-    // get the list of mailboxes</span>
<a href="#l39.37"></a><span id="l39.37" class="difflineminus">-  virtual nsresult  FindMailboxes(nsIFile *pRoot, nsIMutableArray *pArray) override;</span>
<a href="#l39.38"></a><span id="l39.38" class="difflineminus">-    // get a TOC file from a mailbox file</span>
<a href="#l39.39"></a><span id="l39.39" class="difflineminus">-  virtual nsresult  FindTOCFile(nsIFile *pMailFile, nsIFile **pTOCFile, bool *pDeleteToc) override;</span>
<a href="#l39.40"></a><span id="l39.40" class="difflineminus">-</span>
<a href="#l39.41"></a><span id="l39.41" class="difflineminus">-  virtual nsresult  GetAttachmentInfo(const char *pFileName, nsIFile *pFile, nsCString&amp; mimeType, nsCString&amp; aAttachment) override;</span>
<a href="#l39.42"></a><span id="l39.42" class="difflineminus">-</span>
<a href="#l39.43"></a><span id="l39.43" class="difflineminus">-  // Things that must be overridden because they are platform specific.</span>
<a href="#l39.44"></a><span id="l39.44" class="difflineminus">-    // retrieve the address book folder</span>
<a href="#l39.45"></a><span id="l39.45" class="difflineminus">-  virtual bool      FindAddressFolder(nsIFile **pFolder) override;</span>
<a href="#l39.46"></a><span id="l39.46" class="difflineminus">-    // get the list of address books</span>
<a href="#l39.47"></a><span id="l39.47" class="difflineminus">-  virtual nsresult  FindAddressBooks(nsIFile *pRoot, nsIMutableArray *pArray) override;</span>
<a href="#l39.48"></a><span id="l39.48" class="difflineminus">-</span>
<a href="#l39.49"></a><span id="l39.49" class="difflineminus">-    // import settings from Win32 ini file</span>
<a href="#l39.50"></a><span id="l39.50" class="difflineminus">-  static bool    ImportSettings(nsIFile *pIniFile, nsIMsgAccount **localMailAccount);</span>
<a href="#l39.51"></a><span id="l39.51" class="difflineminus">-  static bool    FindSettingsFile(nsIFile **pIniFile) { return FindEudoraLocation(pIniFile, true);}</span>
<a href="#l39.52"></a><span id="l39.52" class="difflineminus">-</span>
<a href="#l39.53"></a><span id="l39.53" class="difflineminus">-  static bool    FindFiltersFile(nsIFile **pFiltersFile);</span>
<a href="#l39.54"></a><span id="l39.54" class="difflineminus">-</span>
<a href="#l39.55"></a><span id="l39.55" class="difflineminus">-  static bool    GetMailboxNameHierarchy(const nsACString&amp; pEudoraLocation, const char* pEudoraFilePath, nsCString&amp; nameHierarchy);</span>
<a href="#l39.56"></a><span id="l39.56" class="difflineminus">-</span>
<a href="#l39.57"></a><span id="l39.57" class="difflineminus">-private:</span>
<a href="#l39.58"></a><span id="l39.58" class="difflineminus">-  nsresult  ScanMailDir(nsIFile *pFolder, nsIMutableArray *pArray, nsIImportService *pImport);</span>
<a href="#l39.59"></a><span id="l39.59" class="difflineminus">-  nsresult  IterateMailDir(nsIFile *pFolder, nsIMutableArray *pArray, nsIImportService *pImport);</span>
<a href="#l39.60"></a><span id="l39.60" class="difflineminus">-  nsresult  ScanDescmap(nsIFile *pFolder, nsIMutableArray *pArray, nsIImportService *pImport, const char *pData, int32_t len);</span>
<a href="#l39.61"></a><span id="l39.61" class="difflineminus">-  nsresult  FoundMailFolder(nsIFile *mailFolder, const char *pName, nsIMutableArray *pArray, nsIImportService *pImport);</span>
<a href="#l39.62"></a><span id="l39.62" class="difflineminus">-  nsresult  FoundMailbox(nsIFile *mailFile, const char *pName, nsIMutableArray *pArray, nsIImportService *pImport);</span>
<a href="#l39.63"></a><span id="l39.63" class="difflineminus">-  bool      FindMimeIniFile(nsIFile *pFile);</span>
<a href="#l39.64"></a><span id="l39.64" class="difflineminus">-  void    GetMimeTypeFromExtension(nsCString&amp; ext, nsCString&amp; mimeType);</span>
<a href="#l39.65"></a><span id="l39.65" class="difflineminus">-  nsresult  FoundAddressBook(nsIFile *file, const char16_t *pName, nsIMutableArray *pArray, nsIImportService *impSvc);</span>
<a href="#l39.66"></a><span id="l39.66" class="difflineminus">-  nsresult  ScanAddressDir(nsIFile *pDir, nsIMutableArray *pArray, nsIImportService *impSvc);</span>
<a href="#l39.67"></a><span id="l39.67" class="difflineminus">-</span>
<a href="#l39.68"></a><span id="l39.68" class="difflineminus">-</span>
<a href="#l39.69"></a><span id="l39.69" class="difflineminus">-  static bool      FindEudoraLocation(nsIFile **pFolder, bool findIni = false);</span>
<a href="#l39.70"></a><span id="l39.70" class="difflineminus">-</span>
<a href="#l39.71"></a><span id="l39.71" class="difflineminus">-    // Settings support</span>
<a href="#l39.72"></a><span id="l39.72" class="difflineminus">-  static bool    BuildPOPAccount(nsIMsgAccountManager *accMgr, const char *pSection, const char *pIni, nsIMsgAccount **ppAccount);</span>
<a href="#l39.73"></a><span id="l39.73" class="difflineminus">-  static bool    BuildIMAPAccount(nsIMsgAccountManager *accMgr, const char *pSection, const char *pIni, nsIMsgAccount **ppAccount);</span>
<a href="#l39.74"></a><span id="l39.74" class="difflineminus">-  static void    GetServerAndUserName(const char *pSection, const char *pIni, nsCString&amp; serverName, nsCString&amp; userName, char *pBuff);</span>
<a href="#l39.75"></a><span id="l39.75" class="difflineminus">-  static void    GetAccountName(const char *pSection, nsString&amp; str);</span>
<a href="#l39.76"></a><span id="l39.76" class="difflineminus">-  static void    SetIdentities(nsIMsgAccountManager *accMgr, nsIMsgAccount *acc, const char *pSection, const char *pIniFile, const char *userName, const char *serverName, char *pBuff);</span>
<a href="#l39.77"></a><span id="l39.77" class="difflineminus">-  static void    SetSmtpServer(nsIMsgAccountManager *pMgr, nsIMsgAccount *pAcc, const char *pServer, const char *pUser);</span>
<a href="#l39.78"></a><span id="l39.78" class="difflineminus">-</span>
<a href="#l39.79"></a><span id="l39.79" class="difflineminus">-</span>
<a href="#l39.80"></a><span id="l39.80" class="difflineminus">-</span>
<a href="#l39.81"></a><span id="l39.81" class="difflineminus">-  static BYTE *  GetValueBytes(HKEY hKey, const char *pValueName);</span>
<a href="#l39.82"></a><span id="l39.82" class="difflineminus">-  static void    ConvertPath(nsCString&amp; str);</span>
<a href="#l39.83"></a><span id="l39.83" class="difflineminus">-</span>
<a href="#l39.84"></a><span id="l39.84" class="difflineminus">-private:</span>
<a href="#l39.85"></a><span id="l39.85" class="difflineminus">-  uint32_t    m_depth;</span>
<a href="#l39.86"></a><span id="l39.86" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt;  m_addressImportFolder;</span>
<a href="#l39.87"></a><span id="l39.87" class="difflineminus">-  char *      m_pMimeSection;</span>
<a href="#l39.88"></a><span id="l39.88" class="difflineminus">-};</span>
<a href="#l39.89"></a><span id="l39.89" class="difflineminus">-</span>
<a href="#l39.90"></a><span id="l39.90" class="difflineminus">-</span>
<a href="#l39.91"></a><span id="l39.91" class="difflineminus">-#endif /* nsEudoraWin32_h__ */</span>
<a href="#l39.92"></a><span id="l39.92" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l40.1"></a><span id="l40.1" class="difflineminus">--- a/mailnews/import/public/nsIImportAddressBooks.idl</span>
<a href="#l40.2"></a><span id="l40.2" class="difflineplus">+++ b/mailnews/import/public/nsIImportAddressBooks.idl</span>
<a href="#l40.3"></a><span id="l40.3" class="difflineat">@@ -4,18 +4,17 @@</span>
<a href="#l40.4"></a><span id="l40.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l40.5"></a><span id="l40.5"> </span>
<a href="#l40.6"></a><span id="l40.6"> /*</span>
<a href="#l40.7"></a><span id="l40.7"> </span>
<a href="#l40.8"></a><span id="l40.8">   Interface for importing address books using the standard UI.  Address</span>
<a href="#l40.9"></a><span id="l40.9">   book import occurs in several forms (yuck!).</span>
<a href="#l40.10"></a><span id="l40.10">   The destination can be 1..n new address books corresponding to the source</span>
<a href="#l40.11"></a><span id="l40.11">   format.  For instance a text file would import into a new address book</span>
<a href="#l40.12"></a><span id="l40.12" class="difflineminus">-  with the same name as the text file, Eudora may import multiple address books</span>
<a href="#l40.13"></a><span id="l40.13" class="difflineminus">-  with the same names as the ones in Eudora.</span>
<a href="#l40.14"></a><span id="l40.14" class="difflineplus">+  with the same name as the text file.</span>
<a href="#l40.15"></a><span id="l40.15">   The destination can be 1 pre-defined address book, all entries will be</span>
<a href="#l40.16"></a><span id="l40.16">   added to the supplied address book - this allows the address book UI so provide</span>
<a href="#l40.17"></a><span id="l40.17">   an import command specific for an individual address book.</span>
<a href="#l40.18"></a><span id="l40.18"> </span>
<a href="#l40.19"></a><span id="l40.19">   The source can import 1 or mulitple address books.</span>
<a href="#l40.20"></a><span id="l40.20">   The address books can be auto-discoverable or user specified.</span>
<a href="#l40.21"></a><span id="l40.21">   The address books can require field mapping or not.</span>
<a href="#l40.22"></a><span id="l40.22"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l41.1"></a><span id="l41.1" class="difflineminus">--- a/mailnews/import/test/unit/resources/import_helper.js</span>
<a href="#l41.2"></a><span id="l41.2" class="difflineplus">+++ b/mailnews/import/test/unit/resources/import_helper.js</span>
<a href="#l41.3"></a><span id="l41.3" class="difflineat">@@ -325,17 +325,17 @@ AbImportHelper.prototype =</span>
<a href="#l41.4"></a><span id="l41.4"> </span>
<a href="#l41.5"></a><span id="l41.5"> /**</span>
<a href="#l41.6"></a><span id="l41.6">  * MailImportHelper</span>
<a href="#l41.7"></a><span id="l41.7">  * A helper for mail imports.</span>
<a href="#l41.8"></a><span id="l41.8">  *</span>
<a href="#l41.9"></a><span id="l41.9">  * @param aFile      An instance of nsIFile to import.</span>
<a href="#l41.10"></a><span id="l41.10">  * @param aModuleSearchString</span>
<a href="#l41.11"></a><span id="l41.11">  *                   The string to search the module names for, such as</span>
<a href="#l41.12"></a><span id="l41.12" class="difflineminus">- *                   &quot;Outlook Express&quot; or &quot;Eudora mail&quot; etc. etc.</span>
<a href="#l41.13"></a><span id="l41.13" class="difflineplus">+ *                   &quot;Outlook Express&quot;, etc.</span>
<a href="#l41.14"></a><span id="l41.14">  * @param aExpected  An instance of nsIFile to compare with the imported</span>
<a href="#l41.15"></a><span id="l41.15">  *                   folders.</span>
<a href="#l41.16"></a><span id="l41.16">  *</span>
<a href="#l41.17"></a><span id="l41.17">  * @constructor</span>
<a href="#l41.18"></a><span id="l41.18">  * @class</span>
<a href="#l41.19"></a><span id="l41.19">  */</span>
<a href="#l41.20"></a><span id="l41.20"> function MailImportHelper(aFile, aModuleSearchString, aExpected)</span>
<a href="#l41.21"></a><span id="l41.21"> {</span>
<a href="#l41.22"></a><span id="l41.22" class="difflineat">@@ -382,17 +382,17 @@ MailImportHelper.prototype =</span>
<a href="#l41.23"></a><span id="l41.23"> </span>
<a href="#l41.24"></a><span id="l41.24"> /**</span>
<a href="#l41.25"></a><span id="l41.25">  * SettingsImportHelper</span>
<a href="#l41.26"></a><span id="l41.26">  * A helper for settings imports.</span>
<a href="#l41.27"></a><span id="l41.27">  *</span>
<a href="#l41.28"></a><span id="l41.28">  * @param aFile      An instance of nsIFile to import, can be null.</span>
<a href="#l41.29"></a><span id="l41.29">  * @param aModuleSearchString</span>
<a href="#l41.30"></a><span id="l41.30">  *                   The string to search the module names for, such as</span>
<a href="#l41.31"></a><span id="l41.31" class="difflineminus">- *                   &quot;Outlook Express&quot; or &quot;Eudora mail&quot; etc. etc.</span>
<a href="#l41.32"></a><span id="l41.32" class="difflineplus">+ *                   &quot;Outlook Express&quot;, etc.</span>
<a href="#l41.33"></a><span id="l41.33">  * @param aExpected  An array of object which has incomingServer, identity</span>
<a href="#l41.34"></a><span id="l41.34">  *                   and smtpSever to compare with imported nsIMsgAccount.</span>
<a href="#l41.35"></a><span id="l41.35">  *</span>
<a href="#l41.36"></a><span id="l41.36">  * @constructor</span>
<a href="#l41.37"></a><span id="l41.37">  * @class</span>
<a href="#l41.38"></a><span id="l41.38">  */</span>
<a href="#l41.39"></a><span id="l41.39"> function SettingsImportHelper(aFile, aModuleSearchString, aExpected)</span>
<a href="#l41.40"></a><span id="l41.40"> {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l42.1"></a><span id="l42.1" class="difflineminus">--- a/mailnews/moz.build</span>
<a href="#l42.2"></a><span id="l42.2" class="difflineplus">+++ b/mailnews/moz.build</span>
<a href="#l42.3"></a><span id="l42.3" class="difflineat">@@ -20,23 +20,20 @@ DIRS += [</span>
<a href="#l42.4"></a><span id="l42.4">     'local/public',</span>
<a href="#l42.5"></a><span id="l42.5">     'local/src',</span>
<a href="#l42.6"></a><span id="l42.6">     'mime',</span>
<a href="#l42.7"></a><span id="l42.7">     'news',</span>
<a href="#l42.8"></a><span id="l42.8"> ]</span>
<a href="#l42.9"></a><span id="l42.9"> </span>
<a href="#l42.10"></a><span id="l42.10"> if CONFIG['MOZ_WIDGET_TOOLKIT'] == 'cocoa':</span>
<a href="#l42.11"></a><span id="l42.11">     DIRS += [</span>
<a href="#l42.12"></a><span id="l42.12" class="difflineminus">-        'import/eudora/src',</span>
<a href="#l42.13"></a><span id="l42.13">         'import/applemail/src',</span>
<a href="#l42.14"></a><span id="l42.14">     ]</span>
<a href="#l42.15"></a><span id="l42.15"> </span>
<a href="#l42.16"></a><span id="l42.16"> if CONFIG['OS_ARCH'] == 'WINNT':</span>
<a href="#l42.17"></a><span id="l42.17" class="difflineminus">-    DIRS += ['import/eudora/src']</span>
<a href="#l42.18"></a><span id="l42.18" class="difflineminus">-</span>
<a href="#l42.19"></a><span id="l42.19">     if CONFIG['MOZ_MAPI_SUPPORT']:</span>
<a href="#l42.20"></a><span id="l42.20">         DIRS += ['import/outlook/src']</span>
<a href="#l42.21"></a><span id="l42.21"> </span>
<a href="#l42.22"></a><span id="l42.22">     if not CONFIG['GNU_CC']:</span>
<a href="#l42.23"></a><span id="l42.23">         DIRS += [</span>
<a href="#l42.24"></a><span id="l42.24">             'import/oexpress',</span>
<a href="#l42.25"></a><span id="l42.25">             'import/winlivemail',</span>
<a href="#l42.26"></a><span id="l42.26">         ]</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

