<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 12766:c06df11f1abf92b09be9401efe8ee4399e2da51d</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ c06df11f1abf92b09be9401efe8ee4399e2da51d" />
<meta property="og:url" content="/comm-central/rev/c06df11f1abf92b09be9401efe8ee4399e2da51d" />
<meta property="og:description" content="Part of bug 452232 - Move LDAP autocomplete over to toolkit interfaces. Switch javascript parts to the toolkit interfaces. r=Neil,jcranmer" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / c06df11f1abf92b09be9401efe8ee4399e2da51d 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/c06df11f1abf92b09be9401efe8ee4399e2da51d">shortlog</a> |
<a href="/comm-central/log/c06df11f1abf92b09be9401efe8ee4399e2da51d">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/c06df11f1abf92b09be9401efe8ee4399e2da51d">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/c06df11f1abf92b09be9401efe8ee4399e2da51d">files</a> |
changeset |
<a href="/comm-central/raw-rev/c06df11f1abf92b09be9401efe8ee4399e2da51d">raw</a>  | <a href="/comm-central/archive/c06df11f1abf92b09be9401efe8ee4399e2da51d.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
Part of <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=452232">bug 452232</a> - Move LDAP autocomplete over to toolkit interfaces. Switch javascript parts to the toolkit interfaces. r=Neil,jcranmer
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#77;&#97;&#114;&#107;&#32;&#66;&#97;&#110;&#110;&#101;&#114;&#32;&#60;&#98;&#117;&#103;&#122;&#105;&#108;&#108;&#97;&#64;&#115;&#116;&#97;&#110;&#100;&#97;&#114;&#100;&#56;&#46;&#112;&#108;&#117;&#115;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 17 Jul 2013 14:39:53 +0200</td></tr>

<tr>
 <td>changeset 12766</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/c06df11f1abf92b09be9401efe8ee4399e2da51d">c06df11f1abf92b09be9401efe8ee4399e2da51d</a></td>
</tr>



<tr>
<td>parent 12765</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/f0535a4d8727fa11e925a1d52a65ecf6d20352f9">f0535a4d8727fa11e925a1d52a65ecf6d20352f9</a>
</td>
</tr>

<tr>
<td>child 12767</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/0ba38b41f77f623b4c1dc1a6d31042dd3820b88d">0ba38b41f77f623b4c1dc1a6d31042dd3820b88d</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=c06df11f1abf92b09be9401efe8ee4399e2da51d">9343</a></td></tr>
<tr><td>push user</td><td>bugzilla@standard8.plus.com</td></tr>
<tr><td>push date</td><td class="date age">Wed, 17 Jul 2013 12:41:24 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@0ba38b41f77f [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=0ba38b41f77f623b4c1dc1a6d31042dd3820b88d">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=0ba38b41f77f623b4c1dc1a6d31042dd3820b88d&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0ba38b41f77f623b4c1dc1a6d31042dd3820b88d&newProject=comm-central&newRevision=f0535a4d8727fa11e925a1d52a65ecf6d20352f9&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0ba38b41f77f623b4c1dc1a6d31042dd3820b88d&newProject=comm-central&newRevision=f0535a4d8727fa11e925a1d52a65ecf6d20352f9&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0ba38b41f77f623b4c1dc1a6d31042dd3820b88d&newProject=comm-central&newRevision=f0535a4d8727fa11e925a1d52a65ecf6d20352f9&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28Neil%29&revcount=50">Neil</a>, <a href="/comm-central/log?rev=reviewer%28jcranmer%29&revcount=50">jcranmer</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=452232">452232</a></td></tr>




</table></div>

<div class="page_body description">Part of <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=452232">bug 452232</a> - Move LDAP autocomplete over to toolkit interfaces. Switch javascript parts to the toolkit interfaces. r=Neil,jcranmer</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c06df11f1abf92b09be9401efe8ee4399e2da51d/mail/components/addrbook/content/abCommon.js">mail/components/addrbook/content/abCommon.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c06df11f1abf92b09be9401efe8ee4399e2da51d/mail/components/addrbook/content/abCommon.js">file</a> |
<a href="/comm-central/annotate/c06df11f1abf92b09be9401efe8ee4399e2da51d/mail/components/addrbook/content/abCommon.js">annotate</a> |
<a href="/comm-central/diff/c06df11f1abf92b09be9401efe8ee4399e2da51d/mail/components/addrbook/content/abCommon.js">diff</a> |
<a href="/comm-central/comparison/c06df11f1abf92b09be9401efe8ee4399e2da51d/mail/components/addrbook/content/abCommon.js">comparison</a> |
<a href="/comm-central/log/c06df11f1abf92b09be9401efe8ee4399e2da51d/mail/components/addrbook/content/abCommon.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c06df11f1abf92b09be9401efe8ee4399e2da51d/mail/components/addrbook/content/abEditListDialog.xul">mail/components/addrbook/content/abEditListDialog.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c06df11f1abf92b09be9401efe8ee4399e2da51d/mail/components/addrbook/content/abEditListDialog.xul">file</a> |
<a href="/comm-central/annotate/c06df11f1abf92b09be9401efe8ee4399e2da51d/mail/components/addrbook/content/abEditListDialog.xul">annotate</a> |
<a href="/comm-central/diff/c06df11f1abf92b09be9401efe8ee4399e2da51d/mail/components/addrbook/content/abEditListDialog.xul">diff</a> |
<a href="/comm-central/comparison/c06df11f1abf92b09be9401efe8ee4399e2da51d/mail/components/addrbook/content/abEditListDialog.xul">comparison</a> |
<a href="/comm-central/log/c06df11f1abf92b09be9401efe8ee4399e2da51d/mail/components/addrbook/content/abEditListDialog.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c06df11f1abf92b09be9401efe8ee4399e2da51d/mail/components/addrbook/content/abMailListDialog.xul">mail/components/addrbook/content/abMailListDialog.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c06df11f1abf92b09be9401efe8ee4399e2da51d/mail/components/addrbook/content/abMailListDialog.xul">file</a> |
<a href="/comm-central/annotate/c06df11f1abf92b09be9401efe8ee4399e2da51d/mail/components/addrbook/content/abMailListDialog.xul">annotate</a> |
<a href="/comm-central/diff/c06df11f1abf92b09be9401efe8ee4399e2da51d/mail/components/addrbook/content/abMailListDialog.xul">diff</a> |
<a href="/comm-central/comparison/c06df11f1abf92b09be9401efe8ee4399e2da51d/mail/components/addrbook/content/abMailListDialog.xul">comparison</a> |
<a href="/comm-central/log/c06df11f1abf92b09be9401efe8ee4399e2da51d/mail/components/addrbook/content/abMailListDialog.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c06df11f1abf92b09be9401efe8ee4399e2da51d/mail/components/compose/content/MsgComposeCommands.js">mail/components/compose/content/MsgComposeCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c06df11f1abf92b09be9401efe8ee4399e2da51d/mail/components/compose/content/MsgComposeCommands.js">file</a> |
<a href="/comm-central/annotate/c06df11f1abf92b09be9401efe8ee4399e2da51d/mail/components/compose/content/MsgComposeCommands.js">annotate</a> |
<a href="/comm-central/diff/c06df11f1abf92b09be9401efe8ee4399e2da51d/mail/components/compose/content/MsgComposeCommands.js">diff</a> |
<a href="/comm-central/comparison/c06df11f1abf92b09be9401efe8ee4399e2da51d/mail/components/compose/content/MsgComposeCommands.js">comparison</a> |
<a href="/comm-central/log/c06df11f1abf92b09be9401efe8ee4399e2da51d/mail/components/compose/content/MsgComposeCommands.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c06df11f1abf92b09be9401efe8ee4399e2da51d/suite/mailnews/addrbook/abListOverlay.xul">suite/mailnews/addrbook/abListOverlay.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c06df11f1abf92b09be9401efe8ee4399e2da51d/suite/mailnews/addrbook/abListOverlay.xul">file</a> |
<a href="/comm-central/annotate/c06df11f1abf92b09be9401efe8ee4399e2da51d/suite/mailnews/addrbook/abListOverlay.xul">annotate</a> |
<a href="/comm-central/diff/c06df11f1abf92b09be9401efe8ee4399e2da51d/suite/mailnews/addrbook/abListOverlay.xul">diff</a> |
<a href="/comm-central/comparison/c06df11f1abf92b09be9401efe8ee4399e2da51d/suite/mailnews/addrbook/abListOverlay.xul">comparison</a> |
<a href="/comm-central/log/c06df11f1abf92b09be9401efe8ee4399e2da51d/suite/mailnews/addrbook/abListOverlay.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c06df11f1abf92b09be9401efe8ee4399e2da51d/suite/mailnews/compose/MsgComposeCommands.js">suite/mailnews/compose/MsgComposeCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c06df11f1abf92b09be9401efe8ee4399e2da51d/suite/mailnews/compose/MsgComposeCommands.js">file</a> |
<a href="/comm-central/annotate/c06df11f1abf92b09be9401efe8ee4399e2da51d/suite/mailnews/compose/MsgComposeCommands.js">annotate</a> |
<a href="/comm-central/diff/c06df11f1abf92b09be9401efe8ee4399e2da51d/suite/mailnews/compose/MsgComposeCommands.js">diff</a> |
<a href="/comm-central/comparison/c06df11f1abf92b09be9401efe8ee4399e2da51d/suite/mailnews/compose/MsgComposeCommands.js">comparison</a> |
<a href="/comm-central/log/c06df11f1abf92b09be9401efe8ee4399e2da51d/suite/mailnews/compose/MsgComposeCommands.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/components/addrbook/content/abCommon.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/components/addrbook/content/abCommon.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -607,261 +607,16 @@ function QuickSearchFocus()</span>
<a href="#l1.4"></a><span id="l1.4"> {</span>
<a href="#l1.5"></a><span id="l1.5">   var searchInput = document.getElementById(&quot;peopleSearchInput&quot;);</span>
<a href="#l1.6"></a><span id="l1.6">   if (searchInput) {</span>
<a href="#l1.7"></a><span id="l1.7">     searchInput.focus();</span>
<a href="#l1.8"></a><span id="l1.8">     searchInput.select();</span>
<a href="#l1.9"></a><span id="l1.9">   }</span>
<a href="#l1.10"></a><span id="l1.10"> }</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-var gQuickSearchFocusEl = null;</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-var gIsOffline;</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-var gSessionAdded;</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineminus">-var gCurrentAutocompleteDirectory;</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineminus">-var gAutocompleteSession;</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineminus">-var gSetupLdapAutocomplete;</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineminus">-var gLDAPSession;</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineminus">-</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineminus">-function setupLdapAutocompleteSession()</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineminus">-{</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineminus">-    var autocompleteLdap = false;</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineminus">-    var autocompleteDirectory = null;</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineminus">-    var prevAutocompleteDirectory = gCurrentAutocompleteDirectory;</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineminus">-    var i;</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineminus">-</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineminus">-    autocompleteLdap = Services.prefs.getBoolPref(&quot;ldap_2.autoComplete.useDirectory&quot;);</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineminus">-    if (autocompleteLdap)</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineminus">-        autocompleteDirectory = Services.prefs.getCharPref(</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineminus">-            &quot;ldap_2.autoComplete.directoryServer&quot;);</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineminus">-</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineminus">-    // use a temporary to do the setup so that we don't overwrite the</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineminus">-    // global, then have some problem and throw an exception, and leave the</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineminus">-    // global with a partially setup session.  we'll assign the temp</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineminus">-    // into the global after we're done setting up the session</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineminus">-    //</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineminus">-    var LDAPSession;</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineminus">-    if (gLDAPSession) {</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineminus">-        LDAPSession = gLDAPSession;</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineminus">-    } else {</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineminus">-        LDAPSession = Components.classes[</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineminus">-            &quot;@mozilla.org/autocompleteSession;1?type=ldap&quot;].createInstance()</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineminus">-            .QueryInterface(Components.interfaces.nsILDAPAutoCompleteSession);</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineminus">-    }</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineminus">-</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineminus">-    if (autocompleteDirectory &amp;&amp; !gIsOffline) {</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineminus">-        // the compose window code adds an observer on the directory server</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineminus">-        // prefs, but I don't think we need this here.</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineminus">-        gCurrentAutocompleteDirectory = autocompleteDirectory;</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineminus">-</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineminus">-        // fill in the session params if there is a session</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineminus">-        //</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineminus">-        if (LDAPSession) {</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineminus">-            let url =</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineminus">-              Services.prefs.getComplexValue(autocompleteDirectory + &quot;.uri&quot;,</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineminus">-                Components.interfaces.nsISupportsString).data;</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineminus">-</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineminus">-            LDAPSession.serverURL = Services.io.newURI(url, null, null)</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineminus">-              .QueryInterface(Components.interfaces.nsILDAPURL);</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineminus">-</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineminus">-            // get the login to authenticate as, if there is one</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineminus">-            //</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineminus">-            try {</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineminus">-                LDAPSession.login = Services.prefs.getComplexValue(</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineminus">-                    autocompleteDirectory + &quot;.auth.dn&quot;,</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineminus">-                    Components.interfaces.nsISupportsString).data;</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineminus">-            } catch (ex) {</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineminus">-                // if we don't have this pref, no big deal</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineminus">-            }</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineminus">-</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineminus">-            try {</span>
<a href="#l1.73"></a><span id="l1.73" class="difflineminus">-                LDAPSession.saslMechanism = Services.prefs.getComplexValue(</span>
<a href="#l1.74"></a><span id="l1.74" class="difflineminus">-                    autocompleteDirectory + &quot;.auth.saslmech&quot;,</span>
<a href="#l1.75"></a><span id="l1.75" class="difflineminus">-                    Components.interfaces.nsISupportsString).data;</span>
<a href="#l1.76"></a><span id="l1.76" class="difflineminus">-            } catch (ex) {</span>
<a href="#l1.77"></a><span id="l1.77" class="difflineminus">-                // if we don't have a mechanism, we'll just use simple binds</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineminus">-            }</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineminus">-</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineminus">-            // don't search on non-CJK strings shorter than this</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineminus">-            //</span>
<a href="#l1.82"></a><span id="l1.82" class="difflineminus">-            try {</span>
<a href="#l1.83"></a><span id="l1.83" class="difflineminus">-                LDAPSession.minStringLength = Services.prefs.getIntPref(</span>
<a href="#l1.84"></a><span id="l1.84" class="difflineminus">-                    autocompleteDirectory + &quot;.autoComplete.minStringLength&quot;);</span>
<a href="#l1.85"></a><span id="l1.85" class="difflineminus">-            } catch (ex) {</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineminus">-                // if this pref isn't there, no big deal.  just let</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineminus">-                // nsLDAPAutoCompleteSession use its default.</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineminus">-            }</span>
<a href="#l1.89"></a><span id="l1.89" class="difflineminus">-</span>
<a href="#l1.90"></a><span id="l1.90" class="difflineminus">-            // don't search on CJK strings shorter than this</span>
<a href="#l1.91"></a><span id="l1.91" class="difflineminus">-            //</span>
<a href="#l1.92"></a><span id="l1.92" class="difflineminus">-            try {</span>
<a href="#l1.93"></a><span id="l1.93" class="difflineminus">-                LDAPSession.cjkMinStringLength = Services.prefs.getIntPref(</span>
<a href="#l1.94"></a><span id="l1.94" class="difflineminus">-                  autocompleteDirectory + &quot;.autoComplete.cjkMinStringLength&quot;);</span>
<a href="#l1.95"></a><span id="l1.95" class="difflineminus">-            } catch (ex) {</span>
<a href="#l1.96"></a><span id="l1.96" class="difflineminus">-                // if this pref isn't there, no big deal.  just let</span>
<a href="#l1.97"></a><span id="l1.97" class="difflineminus">-                // nsLDAPAutoCompleteSession use its default.</span>
<a href="#l1.98"></a><span id="l1.98" class="difflineminus">-            }</span>
<a href="#l1.99"></a><span id="l1.99" class="difflineminus">-</span>
<a href="#l1.100"></a><span id="l1.100" class="difflineminus">-            // we don't try/catch here, because if this fails, we're outta luck</span>
<a href="#l1.101"></a><span id="l1.101" class="difflineminus">-            //</span>
<a href="#l1.102"></a><span id="l1.102" class="difflineminus">-            var ldapFormatter = Components.classes[</span>
<a href="#l1.103"></a><span id="l1.103" class="difflineminus">-                &quot;@mozilla.org/ldap-autocomplete-formatter;1?type=addrbook&quot;]</span>
<a href="#l1.104"></a><span id="l1.104" class="difflineminus">-                .createInstance().QueryInterface(</span>
<a href="#l1.105"></a><span id="l1.105" class="difflineminus">-                    Components.interfaces.nsIAbLDAPAutoCompFormatter);</span>
<a href="#l1.106"></a><span id="l1.106" class="difflineminus">-</span>
<a href="#l1.107"></a><span id="l1.107" class="difflineminus">-            // override autocomplete name format?</span>
<a href="#l1.108"></a><span id="l1.108" class="difflineminus">-            //</span>
<a href="#l1.109"></a><span id="l1.109" class="difflineminus">-            try {</span>
<a href="#l1.110"></a><span id="l1.110" class="difflineminus">-                ldapFormatter.nameFormat =</span>
<a href="#l1.111"></a><span id="l1.111" class="difflineminus">-                    Services.prefs.getComplexValue(autocompleteDirectory +</span>
<a href="#l1.112"></a><span id="l1.112" class="difflineminus">-                        &quot;.autoComplete.nameFormat&quot;,</span>
<a href="#l1.113"></a><span id="l1.113" class="difflineminus">-                        Components.interfaces.nsISupportsString).data;</span>
<a href="#l1.114"></a><span id="l1.114" class="difflineminus">-            } catch (ex) {</span>
<a href="#l1.115"></a><span id="l1.115" class="difflineminus">-                // if this pref isn't there, no big deal.  just let</span>
<a href="#l1.116"></a><span id="l1.116" class="difflineminus">-                // nsAbLDAPAutoCompFormatter use its default.</span>
<a href="#l1.117"></a><span id="l1.117" class="difflineminus">-            }</span>
<a href="#l1.118"></a><span id="l1.118" class="difflineminus">-</span>
<a href="#l1.119"></a><span id="l1.119" class="difflineminus">-            // override autocomplete mail address format?</span>
<a href="#l1.120"></a><span id="l1.120" class="difflineminus">-            //</span>
<a href="#l1.121"></a><span id="l1.121" class="difflineminus">-            try {</span>
<a href="#l1.122"></a><span id="l1.122" class="difflineminus">-                ldapFormatter.addressFormat =</span>
<a href="#l1.123"></a><span id="l1.123" class="difflineminus">-                    Services.prefs.getComplexValue(autocompleteDirectory +</span>
<a href="#l1.124"></a><span id="l1.124" class="difflineminus">-                        &quot;.autoComplete.addressFormat&quot;,</span>
<a href="#l1.125"></a><span id="l1.125" class="difflineminus">-                        Components.interfaces.nsISupportsString).data;</span>
<a href="#l1.126"></a><span id="l1.126" class="difflineminus">-            } catch (ex) {</span>
<a href="#l1.127"></a><span id="l1.127" class="difflineminus">-                // if this pref isn't there, no big deal.  just let</span>
<a href="#l1.128"></a><span id="l1.128" class="difflineminus">-                // nsAbLDAPAutoCompFormatter use its default.</span>
<a href="#l1.129"></a><span id="l1.129" class="difflineminus">-            }</span>
<a href="#l1.130"></a><span id="l1.130" class="difflineminus">-</span>
<a href="#l1.131"></a><span id="l1.131" class="difflineminus">-            try {</span>
<a href="#l1.132"></a><span id="l1.132" class="difflineminus">-                // figure out what goes in the comment column, if anything</span>
<a href="#l1.133"></a><span id="l1.133" class="difflineminus">-                //</span>
<a href="#l1.134"></a><span id="l1.134" class="difflineminus">-                // 0 = none</span>
<a href="#l1.135"></a><span id="l1.135" class="difflineminus">-                // 1 = name of addressbook this card came from</span>
<a href="#l1.136"></a><span id="l1.136" class="difflineminus">-                // 2 = other per-addressbook format</span>
<a href="#l1.137"></a><span id="l1.137" class="difflineminus">-                //</span>
<a href="#l1.138"></a><span id="l1.138" class="difflineminus">-                var showComments = 0;</span>
<a href="#l1.139"></a><span id="l1.139" class="difflineminus">-                showComments = Services.prefs.getIntPref(</span>
<a href="#l1.140"></a><span id="l1.140" class="difflineminus">-                    &quot;mail.autoComplete.commentColumn&quot;);</span>
<a href="#l1.141"></a><span id="l1.141" class="difflineminus">-</span>
<a href="#l1.142"></a><span id="l1.142" class="difflineminus">-                switch (showComments) {</span>
<a href="#l1.143"></a><span id="l1.143" class="difflineminus">-</span>
<a href="#l1.144"></a><span id="l1.144" class="difflineminus">-                case 1:</span>
<a href="#l1.145"></a><span id="l1.145" class="difflineminus">-                    // use the name of this directory</span>
<a href="#l1.146"></a><span id="l1.146" class="difflineminus">-                    //</span>
<a href="#l1.147"></a><span id="l1.147" class="difflineminus">-                    ldapFormatter.commentFormat = Services.prefs.getComplexValue(</span>
<a href="#l1.148"></a><span id="l1.148" class="difflineminus">-                        autocompleteDirectory + &quot;.description&quot;,</span>
<a href="#l1.149"></a><span id="l1.149" class="difflineminus">-                        Components.interfaces.nsISupportsString).data;</span>
<a href="#l1.150"></a><span id="l1.150" class="difflineminus">-                    break;</span>
<a href="#l1.151"></a><span id="l1.151" class="difflineminus">-</span>
<a href="#l1.152"></a><span id="l1.152" class="difflineminus">-                case 2:</span>
<a href="#l1.153"></a><span id="l1.153" class="difflineminus">-                    // override ldap-specific autocomplete entry?</span>
<a href="#l1.154"></a><span id="l1.154" class="difflineminus">-                    //</span>
<a href="#l1.155"></a><span id="l1.155" class="difflineminus">-                    try {</span>
<a href="#l1.156"></a><span id="l1.156" class="difflineminus">-                        ldapFormatter.commentFormat =</span>
<a href="#l1.157"></a><span id="l1.157" class="difflineminus">-                            Services.prefs.getComplexValue(autocompleteDirectory +</span>
<a href="#l1.158"></a><span id="l1.158" class="difflineminus">-                                &quot;.autoComplete.commentFormat&quot;,</span>
<a href="#l1.159"></a><span id="l1.159" class="difflineminus">-                                Components.interfaces.nsISupportsString).data;</span>
<a href="#l1.160"></a><span id="l1.160" class="difflineminus">-                    } catch (innerException) {</span>
<a href="#l1.161"></a><span id="l1.161" class="difflineminus">-                        // if nothing has been specified, use the ldap</span>
<a href="#l1.162"></a><span id="l1.162" class="difflineminus">-                        // organization field</span>
<a href="#l1.163"></a><span id="l1.163" class="difflineminus">-                        ldapFormatter.commentFormat = &quot;[o]&quot;;</span>
<a href="#l1.164"></a><span id="l1.164" class="difflineminus">-                    }</span>
<a href="#l1.165"></a><span id="l1.165" class="difflineminus">-                    break;</span>
<a href="#l1.166"></a><span id="l1.166" class="difflineminus">-</span>
<a href="#l1.167"></a><span id="l1.167" class="difflineminus">-                case 0:</span>
<a href="#l1.168"></a><span id="l1.168" class="difflineminus">-                default:</span>
<a href="#l1.169"></a><span id="l1.169" class="difflineminus">-                    // do nothing</span>
<a href="#l1.170"></a><span id="l1.170" class="difflineminus">-                }</span>
<a href="#l1.171"></a><span id="l1.171" class="difflineminus">-            } catch (ex) {</span>
<a href="#l1.172"></a><span id="l1.172" class="difflineminus">-                // if something went wrong while setting up comments, try and</span>
<a href="#l1.173"></a><span id="l1.173" class="difflineminus">-                // proceed anyway</span>
<a href="#l1.174"></a><span id="l1.174" class="difflineminus">-            }</span>
<a href="#l1.175"></a><span id="l1.175" class="difflineminus">-</span>
<a href="#l1.176"></a><span id="l1.176" class="difflineminus">-            // set the session's formatter, which also happens to</span>
<a href="#l1.177"></a><span id="l1.177" class="difflineminus">-            // force a call to the formatter's getAttributes() method</span>
<a href="#l1.178"></a><span id="l1.178" class="difflineminus">-            // -- which is why this needs to happen after we've set the</span>
<a href="#l1.179"></a><span id="l1.179" class="difflineminus">-            // various formats</span>
<a href="#l1.180"></a><span id="l1.180" class="difflineminus">-            //</span>
<a href="#l1.181"></a><span id="l1.181" class="difflineminus">-            LDAPSession.formatter = ldapFormatter;</span>
<a href="#l1.182"></a><span id="l1.182" class="difflineminus">-</span>
<a href="#l1.183"></a><span id="l1.183" class="difflineminus">-            // override autocomplete entry formatting?</span>
<a href="#l1.184"></a><span id="l1.184" class="difflineminus">-            //</span>
<a href="#l1.185"></a><span id="l1.185" class="difflineminus">-            try {</span>
<a href="#l1.186"></a><span id="l1.186" class="difflineminus">-                LDAPSession.outputFormat =</span>
<a href="#l1.187"></a><span id="l1.187" class="difflineminus">-                    Services.prefs.getComplexValue(autocompleteDirectory +</span>
<a href="#l1.188"></a><span id="l1.188" class="difflineminus">-                        &quot;.autoComplete.outputFormat&quot;,</span>
<a href="#l1.189"></a><span id="l1.189" class="difflineminus">-                        Components.interfaces.nsISupportsString).data;</span>
<a href="#l1.190"></a><span id="l1.190" class="difflineminus">-</span>
<a href="#l1.191"></a><span id="l1.191" class="difflineminus">-            } catch (ex) {</span>
<a href="#l1.192"></a><span id="l1.192" class="difflineminus">-                // if this pref isn't there, no big deal.  just let</span>
<a href="#l1.193"></a><span id="l1.193" class="difflineminus">-                // nsLDAPAutoCompleteSession use its default.</span>
<a href="#l1.194"></a><span id="l1.194" class="difflineminus">-            }</span>
<a href="#l1.195"></a><span id="l1.195" class="difflineminus">-</span>
<a href="#l1.196"></a><span id="l1.196" class="difflineminus">-            // override default search filter template?</span>
<a href="#l1.197"></a><span id="l1.197" class="difflineminus">-            //</span>
<a href="#l1.198"></a><span id="l1.198" class="difflineminus">-            try {</span>
<a href="#l1.199"></a><span id="l1.199" class="difflineminus">-                LDAPSession.filterTemplate = Services.prefs.getComplexValue(</span>
<a href="#l1.200"></a><span id="l1.200" class="difflineminus">-                    autocompleteDirectory + &quot;.autoComplete.filterTemplate&quot;,</span>
<a href="#l1.201"></a><span id="l1.201" class="difflineminus">-                    Components.interfaces.nsISupportsString).data;</span>
<a href="#l1.202"></a><span id="l1.202" class="difflineminus">-</span>
<a href="#l1.203"></a><span id="l1.203" class="difflineminus">-            } catch (ex) {</span>
<a href="#l1.204"></a><span id="l1.204" class="difflineminus">-                // if this pref isn't there, no big deal.  just let</span>
<a href="#l1.205"></a><span id="l1.205" class="difflineminus">-                // nsLDAPAutoCompleteSession use its default</span>
<a href="#l1.206"></a><span id="l1.206" class="difflineminus">-            }</span>
<a href="#l1.207"></a><span id="l1.207" class="difflineminus">-</span>
<a href="#l1.208"></a><span id="l1.208" class="difflineminus">-            // override default maxHits (currently 100)</span>
<a href="#l1.209"></a><span id="l1.209" class="difflineminus">-            //</span>
<a href="#l1.210"></a><span id="l1.210" class="difflineminus">-            try {</span>
<a href="#l1.211"></a><span id="l1.211" class="difflineminus">-                // XXXdmose should really use .autocomplete.maxHits,</span>
<a href="#l1.212"></a><span id="l1.212" class="difflineminus">-                // but there's no UI for that yet</span>
<a href="#l1.213"></a><span id="l1.213" class="difflineminus">-                //</span>
<a href="#l1.214"></a><span id="l1.214" class="difflineminus">-                LDAPSession.maxHits =</span>
<a href="#l1.215"></a><span id="l1.215" class="difflineminus">-                    Services.prefs.getIntPref(autocompleteDirectory + &quot;.maxHits&quot;);</span>
<a href="#l1.216"></a><span id="l1.216" class="difflineminus">-            } catch (ex) {</span>
<a href="#l1.217"></a><span id="l1.217" class="difflineminus">-                // if this pref isn't there, or is out of range, no big deal.</span>
<a href="#l1.218"></a><span id="l1.218" class="difflineminus">-                // just let nsLDAPAutoCompleteSession use its default.</span>
<a href="#l1.219"></a><span id="l1.219" class="difflineminus">-            }</span>
<a href="#l1.220"></a><span id="l1.220" class="difflineminus">-</span>
<a href="#l1.221"></a><span id="l1.221" class="difflineminus">-            if (!gSessionAdded) {</span>
<a href="#l1.222"></a><span id="l1.222" class="difflineminus">-                // if we make it here, we know that session initialization has</span>
<a href="#l1.223"></a><span id="l1.223" class="difflineminus">-                // succeeded; add the session for all recipients, and</span>
<a href="#l1.224"></a><span id="l1.224" class="difflineminus">-                // remember that we've done so</span>
<a href="#l1.225"></a><span id="l1.225" class="difflineminus">-                var autoCompleteWidget;</span>
<a href="#l1.226"></a><span id="l1.226" class="difflineminus">-                for (i=1; i &lt;= awGetMaxRecipients(); i++)</span>
<a href="#l1.227"></a><span id="l1.227" class="difflineminus">-                {</span>
<a href="#l1.228"></a><span id="l1.228" class="difflineminus">-                    autoCompleteWidget = document.getElementById(&quot;addressCol1#&quot; + i);</span>
<a href="#l1.229"></a><span id="l1.229" class="difflineminus">-                    if (autoCompleteWidget)</span>
<a href="#l1.230"></a><span id="l1.230" class="difflineminus">-                    {</span>
<a href="#l1.231"></a><span id="l1.231" class="difflineminus">-                      autoCompleteWidget.addSession(LDAPSession);</span>
<a href="#l1.232"></a><span id="l1.232" class="difflineminus">-                      // ldap searches don't insert a default entry with the default domain appended to it</span>
<a href="#l1.233"></a><span id="l1.233" class="difflineminus">-                      // so reduce the minimum results for a popup to 2 in this case.</span>
<a href="#l1.234"></a><span id="l1.234" class="difflineminus">-                      autoCompleteWidget.minResultsForPopup = 2;</span>
<a href="#l1.235"></a><span id="l1.235" class="difflineminus">-</span>
<a href="#l1.236"></a><span id="l1.236" class="difflineminus">-                    }</span>
<a href="#l1.237"></a><span id="l1.237" class="difflineminus">-                 }</span>
<a href="#l1.238"></a><span id="l1.238" class="difflineminus">-                gSessionAdded = true;</span>
<a href="#l1.239"></a><span id="l1.239" class="difflineminus">-            }</span>
<a href="#l1.240"></a><span id="l1.240" class="difflineminus">-        }</span>
<a href="#l1.241"></a><span id="l1.241" class="difflineminus">-    } else {</span>
<a href="#l1.242"></a><span id="l1.242" class="difflineminus">-      if (gCurrentAutocompleteDirectory) {</span>
<a href="#l1.243"></a><span id="l1.243" class="difflineminus">-        gCurrentAutocompleteDirectory = null;</span>
<a href="#l1.244"></a><span id="l1.244" class="difflineminus">-      }</span>
<a href="#l1.245"></a><span id="l1.245" class="difflineminus">-      if (gLDAPSession &amp;&amp; gSessionAdded) {</span>
<a href="#l1.246"></a><span id="l1.246" class="difflineminus">-        for (i=1; i &lt;= awGetMaxRecipients(); i++)</span>
<a href="#l1.247"></a><span id="l1.247" class="difflineminus">-          document.getElementById(&quot;addressCol1#&quot; + i).</span>
<a href="#l1.248"></a><span id="l1.248" class="difflineminus">-              removeSession(gLDAPSession);</span>
<a href="#l1.249"></a><span id="l1.249" class="difflineminus">-        gSessionAdded = false;</span>
<a href="#l1.250"></a><span id="l1.250" class="difflineminus">-      }</span>
<a href="#l1.251"></a><span id="l1.251" class="difflineminus">-    }</span>
<a href="#l1.252"></a><span id="l1.252" class="difflineminus">-</span>
<a href="#l1.253"></a><span id="l1.253" class="difflineminus">-    gLDAPSession = LDAPSession;</span>
<a href="#l1.254"></a><span id="l1.254" class="difflineminus">-    gSetupLdapAutocomplete = true;</span>
<a href="#l1.255"></a><span id="l1.255" class="difflineminus">-}</span>
<a href="#l1.256"></a><span id="l1.256" class="difflineminus">-</span>
<a href="#l1.257"></a><span id="l1.257"> /**</span>
<a href="#l1.258"></a><span id="l1.258">  * Returns an nsIFile of the directory in which contact photos are stored.</span>
<a href="#l1.259"></a><span id="l1.259">  * This will create the directory if it does not yet exist.</span>
<a href="#l1.260"></a><span id="l1.260">  */</span>
<a href="#l1.261"></a><span id="l1.261"> function getPhotosDir() {</span>
<a href="#l1.262"></a><span id="l1.262">   let file = Services.dirsvc.get(&quot;ProfD&quot;, Components.interfaces.nsIFile);</span>
<a href="#l1.263"></a><span id="l1.263">   // Get the Photos directory</span>
<a href="#l1.264"></a><span id="l1.264">   file.append(&quot;Photos&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/components/addrbook/content/abEditListDialog.xul</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/components/addrbook/content/abEditListDialog.xul</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -52,21 +52,20 @@</span>
<a href="#l2.4"></a><span id="l2.4">     &lt;label control=&quot;addressingWidget&quot; value=&quot;&amp;AddressTitle.label;&quot;/&gt;</span>
<a href="#l2.5"></a><span id="l2.5">     &lt;spacer style=&quot;height:0.1em&quot;/&gt;</span>
<a href="#l2.6"></a><span id="l2.6"> </span>
<a href="#l2.7"></a><span id="l2.7">     &lt;listbox id=&quot;addressingWidget&quot; style=&quot;height: 15em;&quot; onclick=&quot;awClickEmptySpace(event.target, true)&quot;&gt;</span>
<a href="#l2.8"></a><span id="l2.8">       &lt;listitem class=&quot;addressingWidgetItem&quot; allowevents=&quot;true&quot;&gt;</span>
<a href="#l2.9"></a><span id="l2.9">         &lt;listcell class=&quot;addressingWidgetCell&quot;&gt;</span>
<a href="#l2.10"></a><span id="l2.10">           &lt;textbox id=&quot;addressCol1#1&quot; class=&quot;plain textbox-addressingWidget uri-element&quot;</span>
<a href="#l2.11"></a><span id="l2.11">                    type=&quot;autocomplete&quot; flex=&quot;1&quot;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-                   autocompletesearch=&quot;addrbook&quot; timeout=&quot;300&quot; maxrows=&quot;4&quot;</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+                   autocompletesearch=&quot;addrbook ldap&quot; timeout=&quot;300&quot; maxrows=&quot;4&quot;</span>
<a href="#l2.14"></a><span id="l2.14">                    completedefaultindex=&quot;true&quot; forcecomplete=&quot;true&quot;</span>
<a href="#l2.15"></a><span id="l2.15">                    minresultsforpopup=&quot;3&quot;</span>
<a href="#l2.16"></a><span id="l2.16">                    ontextentered=&quot;awRecipientTextCommand(eventParam, this)&quot;</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineminus">-                   oninput=&quot;setupLdapAutocompleteSession();&quot;</span>
<a href="#l2.18"></a><span id="l2.18">                    onkeypress=&quot;handleKeyPress(this, event);&quot;</span>
<a href="#l2.19"></a><span id="l2.19">                    onkeydown=&quot;awRecipientKeyDown(event, this);&quot;</span>
<a href="#l2.20"></a><span id="l2.20">                    onclick=&quot;awNotAnEmptyArea(event);&quot;&gt;</span>
<a href="#l2.21"></a><span id="l2.21">             &lt;image onclick=&quot;this.parentNode.select();&quot; class=&quot;person-icon&quot;/&gt;</span>
<a href="#l2.22"></a><span id="l2.22">           &lt;/textbox&gt;</span>
<a href="#l2.23"></a><span id="l2.23">         &lt;/listcell&gt;</span>
<a href="#l2.24"></a><span id="l2.24">       &lt;/listitem&gt;</span>
<a href="#l2.25"></a><span id="l2.25">     &lt;/listbox&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/components/addrbook/content/abMailListDialog.xul</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/components/addrbook/content/abMailListDialog.xul</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -62,21 +62,20 @@</span>
<a href="#l3.4"></a><span id="l3.4">     &lt;label control=&quot;addressingWidget&quot; value=&quot;&amp;AddressTitle.label;&quot;/&gt;</span>
<a href="#l3.5"></a><span id="l3.5">     &lt;spacer style=&quot;height:0.1em&quot;/&gt;</span>
<a href="#l3.6"></a><span id="l3.6"> </span>
<a href="#l3.7"></a><span id="l3.7">     &lt;listbox id=&quot;addressingWidget&quot; style=&quot;height: 15em;&quot; onclick=&quot;awClickEmptySpace(event.target, true)&quot;&gt;</span>
<a href="#l3.8"></a><span id="l3.8">       &lt;listitem class=&quot;addressingWidgetItem&quot; allowevents=&quot;true&quot;&gt;</span>
<a href="#l3.9"></a><span id="l3.9">         &lt;listcell class=&quot;addressingWidgetCell&quot;&gt;</span>
<a href="#l3.10"></a><span id="l3.10">           &lt;textbox id=&quot;addressCol1#1&quot; class=&quot;plain textbox-addressingWidget uri-element&quot;</span>
<a href="#l3.11"></a><span id="l3.11">                    type=&quot;autocomplete&quot; flex=&quot;1&quot;</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-                   autocompletesearch=&quot;addrbook&quot; timeout=&quot;300&quot; maxrows=&quot;4&quot; </span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+                   autocompletesearch=&quot;addrbook ldap&quot; timeout=&quot;300&quot; maxrows=&quot;4&quot;</span>
<a href="#l3.14"></a><span id="l3.14">                    completedefaultindex=&quot;true&quot; forcecomplete=&quot;true&quot;</span>
<a href="#l3.15"></a><span id="l3.15">                    minresultsforpopup=&quot;3&quot;</span>
<a href="#l3.16"></a><span id="l3.16">                    ontextentered=&quot;awRecipientTextCommand(eventParam, this)&quot;</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineminus">-                   oninput=&quot;setupLdapAutocompleteSession();&quot;</span>
<a href="#l3.18"></a><span id="l3.18">                    onkeypress=&quot;handleKeyPress(this, event);&quot;</span>
<a href="#l3.19"></a><span id="l3.19">                    onkeydown=&quot;awRecipientKeyDown(event, this);&quot;</span>
<a href="#l3.20"></a><span id="l3.20">                    onclick=&quot;awNotAnEmptyArea(event);&quot;&gt;</span>
<a href="#l3.21"></a><span id="l3.21">             &lt;image onclick=&quot;this.parentNode.select();&quot; class=&quot;person-icon&quot;/&gt;</span>
<a href="#l3.22"></a><span id="l3.22">           &lt;/textbox&gt;</span>
<a href="#l3.23"></a><span id="l3.23">         &lt;/listcell&gt;            </span>
<a href="#l3.24"></a><span id="l3.24">       &lt;/listitem&gt;</span>
<a href="#l3.25"></a><span id="l3.25">     &lt;/listbox&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/components/compose/content/MsgComposeCommands.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/components/compose/content/MsgComposeCommands.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -12,17 +12,17 @@ Components.utils.import(&quot;resource:///mod</span>
<a href="#l4.4"></a><span id="l4.4"> Components.utils.import(&quot;resource:///modules/cloudFileAccounts.js&quot;);</span>
<a href="#l4.5"></a><span id="l4.5"> Components.utils.import(&quot;resource:///modules/errUtils.js&quot;);</span>
<a href="#l4.6"></a><span id="l4.6"> Components.utils.import(&quot;resource:///modules/folderUtils.jsm&quot;);</span>
<a href="#l4.7"></a><span id="l4.7"> Components.utils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l4.8"></a><span id="l4.8"> Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l4.9"></a><span id="l4.9"> Components.utils.import(&quot;resource:///modules/MailUtils.js&quot;);</span>
<a href="#l4.10"></a><span id="l4.10"> Components.utils.import(&quot;resource://gre/modules/InlineSpellChecker.jsm&quot;);</span>
<a href="#l4.11"></a><span id="l4.11"> Components.utils.import(&quot;resource://gre/modules/PluralForm.jsm&quot;);</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;)</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l4.14"></a><span id="l4.14"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l4.15"></a><span id="l4.15"> </span>
<a href="#l4.16"></a><span id="l4.16"> /**</span>
<a href="#l4.17"></a><span id="l4.17">  * interfaces</span>
<a href="#l4.18"></a><span id="l4.18">  */</span>
<a href="#l4.19"></a><span id="l4.19"> const nsIMsgCompDeliverMode = Components.interfaces.nsIMsgCompDeliverMode;</span>
<a href="#l4.20"></a><span id="l4.20"> const nsIMsgCompSendFormat = Components.interfaces.nsIMsgCompSendFormat;</span>
<a href="#l4.21"></a><span id="l4.21"> const nsIMsgCompConvertible = Components.interfaces.nsIMsgCompConvertible;</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineat">@@ -56,20 +56,16 @@ var gMsgCompose;</span>
<a href="#l4.23"></a><span id="l4.23"> var gWindowLocked;</span>
<a href="#l4.24"></a><span id="l4.24"> var gSendLocked;</span>
<a href="#l4.25"></a><span id="l4.25"> var gContentChanged;</span>
<a href="#l4.26"></a><span id="l4.26"> var gAutoSaving;</span>
<a href="#l4.27"></a><span id="l4.27"> var gCurrentIdentity;</span>
<a href="#l4.28"></a><span id="l4.28"> var defaultSaveOperation;</span>
<a href="#l4.29"></a><span id="l4.29"> var gSendOrSaveOperationInProgress;</span>
<a href="#l4.30"></a><span id="l4.30"> var gCloseWindowAfterSave;</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">-var gSessionAdded;</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineminus">-var gCurrentAutocompleteDirectory;</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineminus">-var gSetupLdapAutocomplete;</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineminus">-var gLDAPSession;</span>
<a href="#l4.35"></a><span id="l4.35"> var gSavedSendNowKey;</span>
<a href="#l4.36"></a><span id="l4.36"> var gSendFormat;</span>
<a href="#l4.37"></a><span id="l4.37"> </span>
<a href="#l4.38"></a><span id="l4.38"> var gMsgIdentityElement;</span>
<a href="#l4.39"></a><span id="l4.39"> var gMsgAddressingWidgetTreeElement;</span>
<a href="#l4.40"></a><span id="l4.40"> var gMsgSubjectElement;</span>
<a href="#l4.41"></a><span id="l4.41"> var gMsgAttachmentElement;</span>
<a href="#l4.42"></a><span id="l4.42"> var gMsgHeadersToolbarElement;</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineat">@@ -116,20 +112,16 @@ function InitializeGlobalVariables()</span>
<a href="#l4.44"></a><span id="l4.44">   gMsgCompose = null;</span>
<a href="#l4.45"></a><span id="l4.45">   gWindowLocked = false;</span>
<a href="#l4.46"></a><span id="l4.46">   gContentChanged = false;</span>
<a href="#l4.47"></a><span id="l4.47">   gCurrentIdentity = null;</span>
<a href="#l4.48"></a><span id="l4.48">   defaultSaveOperation = &quot;draft&quot;;</span>
<a href="#l4.49"></a><span id="l4.49">   gSendOrSaveOperationInProgress = false;</span>
<a href="#l4.50"></a><span id="l4.50">   gAutoSaving = false;</span>
<a href="#l4.51"></a><span id="l4.51">   gCloseWindowAfterSave = false;</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineminus">-  gSessionAdded = false;</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineminus">-  gCurrentAutocompleteDirectory = null;</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineminus">-  gSetupLdapAutocomplete = false;</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineminus">-  gLDAPSession = null;</span>
<a href="#l4.56"></a><span id="l4.56">   gSavedSendNowKey = null;</span>
<a href="#l4.57"></a><span id="l4.57">   gSendFormat = nsIMsgCompSendFormat.AskUser;</span>
<a href="#l4.58"></a><span id="l4.58">   gSendDefaultCharset = null;</span>
<a href="#l4.59"></a><span id="l4.59">   gCharsetTitle = null;</span>
<a href="#l4.60"></a><span id="l4.60">   gCharsetConvertManager = Components.classes['@mozilla.org/charset-converter-manager;1'].getService(Components.interfaces.nsICharsetConverterManager);</span>
<a href="#l4.61"></a><span id="l4.61">   gHideMenus = false;</span>
<a href="#l4.62"></a><span id="l4.62">   gRemindLater = false;</span>
<a href="#l4.63"></a><span id="l4.63"> </span>
<a href="#l4.64"></a><span id="l4.64" class="difflineat">@@ -143,21 +135,16 @@ function InitializeGlobalVariables()</span>
<a href="#l4.65"></a><span id="l4.65">                         .createInstance(Components.interfaces.nsIMsgWindow);</span>
<a href="#l4.66"></a><span id="l4.66">   MailServices.mailSession.AddMsgWindow(msgWindow);</span>
<a href="#l4.67"></a><span id="l4.67"> }</span>
<a href="#l4.68"></a><span id="l4.68"> InitializeGlobalVariables();</span>
<a href="#l4.69"></a><span id="l4.69"> </span>
<a href="#l4.70"></a><span id="l4.70"> function ReleaseGlobalVariables()</span>
<a href="#l4.71"></a><span id="l4.71"> {</span>
<a href="#l4.72"></a><span id="l4.72">   gCurrentIdentity = null;</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineminus">-  gCurrentAutocompleteDirectory = null;</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineminus">-  if (gLDAPSession) {</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineminus">-    gLDAPSession = null;</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineminus">-    Components.utils.forceGC();</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineminus">-  }</span>
<a href="#l4.78"></a><span id="l4.78">   gCharsetConvertManager = null;</span>
<a href="#l4.79"></a><span id="l4.79">   gMsgCompose = null;</span>
<a href="#l4.80"></a><span id="l4.80">   gMessenger = null;</span>
<a href="#l4.81"></a><span id="l4.81">   _gComposeBundle = null;</span>
<a href="#l4.82"></a><span id="l4.82">   MailServices.mailSession.RemoveMsgWindow(msgWindow);</span>
<a href="#l4.83"></a><span id="l4.83">   msgWindow = null;</span>
<a href="#l4.84"></a><span id="l4.84"> }</span>
<a href="#l4.85"></a><span id="l4.85"> </span>
<a href="#l4.86"></a><span id="l4.86" class="difflineat">@@ -179,17 +166,16 @@ function updateEditableFields(aDisable)</span>
<a href="#l4.87"></a><span id="l4.87">   let elements = document.querySelectorAll('[disableonsend=&quot;true&quot;]');</span>
<a href="#l4.88"></a><span id="l4.88">   for (let i = 0; i &lt; elements.length; i++)</span>
<a href="#l4.89"></a><span id="l4.89">     elements[i].disabled = aDisable;</span>
<a href="#l4.90"></a><span id="l4.90"> }</span>
<a href="#l4.91"></a><span id="l4.91"> </span>
<a href="#l4.92"></a><span id="l4.92"> var gComposeRecyclingListener = {</span>
<a href="#l4.93"></a><span id="l4.93">   onClose: function() {</span>
<a href="#l4.94"></a><span id="l4.94">     //Reset recipients and attachments</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineminus">-    ReleaseAutoCompleteState();</span>
<a href="#l4.96"></a><span id="l4.96">     awResetAllRows();</span>
<a href="#l4.97"></a><span id="l4.97">     RemoveAllAttachments();</span>
<a href="#l4.98"></a><span id="l4.98"> </span>
<a href="#l4.99"></a><span id="l4.99">     // We need to clear the identity popup menu in case the user will change them.</span>
<a href="#l4.100"></a><span id="l4.100">     // It will be rebuilt later in ComposeStartup</span>
<a href="#l4.101"></a><span id="l4.101">     ClearIdentityListPopup(document.getElementById(&quot;msgIdentityPopup&quot;));</span>
<a href="#l4.102"></a><span id="l4.102"> </span>
<a href="#l4.103"></a><span id="l4.103">     //Clear the subject</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineat">@@ -1456,23 +1442,16 @@ function updateOptionItems()</span>
<a href="#l4.105"></a><span id="l4.105"> var messageComposeOfflineQuitObserver =</span>
<a href="#l4.106"></a><span id="l4.106"> {</span>
<a href="#l4.107"></a><span id="l4.107">   observe: function(aSubject, aTopic, aData)</span>
<a href="#l4.108"></a><span id="l4.108">   {</span>
<a href="#l4.109"></a><span id="l4.109">     // sanity checks</span>
<a href="#l4.110"></a><span id="l4.110">     if (aTopic == &quot;network:offline-status-changed&quot;)</span>
<a href="#l4.111"></a><span id="l4.111">     {</span>
<a href="#l4.112"></a><span id="l4.112">       MessageComposeOfflineStateChanged(Services.io.offline);</span>
<a href="#l4.113"></a><span id="l4.113" class="difflineminus">-</span>
<a href="#l4.114"></a><span id="l4.114" class="difflineminus">-      try {</span>
<a href="#l4.115"></a><span id="l4.115" class="difflineminus">-        setupLdapAutocompleteSession();</span>
<a href="#l4.116"></a><span id="l4.116" class="difflineminus">-      } catch (ex) {</span>
<a href="#l4.117"></a><span id="l4.117" class="difflineminus">-        // catch the exception and ignore it, so that if LDAP setup</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineminus">-        // fails, the entire compose window stuff doesn't get aborted</span>
<a href="#l4.119"></a><span id="l4.119" class="difflineminus">-      }</span>
<a href="#l4.120"></a><span id="l4.120">     }</span>
<a href="#l4.121"></a><span id="l4.121">     // check whether to veto the quit request (unless another observer already</span>
<a href="#l4.122"></a><span id="l4.122">     // did)</span>
<a href="#l4.123"></a><span id="l4.123">     else if (aTopic == &quot;quit-application-requested&quot;</span>
<a href="#l4.124"></a><span id="l4.124">         &amp;&amp; (aSubject instanceof Components.interfaces.nsISupportsPRBool)</span>
<a href="#l4.125"></a><span id="l4.125">         &amp;&amp; !aSubject.data)</span>
<a href="#l4.126"></a><span id="l4.126">       aSubject.data = !ComposeCanClose();</span>
<a href="#l4.127"></a><span id="l4.127">   }</span>
<a href="#l4.128"></a><span id="l4.128" class="difflineat">@@ -1523,329 +1502,16 @@ function MessageComposeOfflineStateChang</span>
<a href="#l4.129"></a><span id="l4.129">       if (gSavedSendNowKey) {</span>
<a href="#l4.130"></a><span id="l4.130">         sendNowMenuItem.setAttribute('key', gSavedSendNowKey);</span>
<a href="#l4.131"></a><span id="l4.131">       }</span>
<a href="#l4.132"></a><span id="l4.132">     }</span>
<a href="#l4.133"></a><span id="l4.133"> </span>
<a href="#l4.134"></a><span id="l4.134">   } catch(e) {}</span>
<a href="#l4.135"></a><span id="l4.135"> }</span>
<a href="#l4.136"></a><span id="l4.136"> </span>
<a href="#l4.137"></a><span id="l4.137" class="difflineminus">-var directoryServerObserver = {</span>
<a href="#l4.138"></a><span id="l4.138" class="difflineminus">-  observe: function(subject, topic, value) {</span>
<a href="#l4.139"></a><span id="l4.139" class="difflineminus">-      try {</span>
<a href="#l4.140"></a><span id="l4.140" class="difflineminus">-          setupLdapAutocompleteSession();</span>
<a href="#l4.141"></a><span id="l4.141" class="difflineminus">-      } catch (ex) {</span>
<a href="#l4.142"></a><span id="l4.142" class="difflineminus">-          // catch the exception and ignore it, so that if LDAP setup</span>
<a href="#l4.143"></a><span id="l4.143" class="difflineminus">-          // fails, the entire compose window doesn't get horked</span>
<a href="#l4.144"></a><span id="l4.144" class="difflineminus">-      }</span>
<a href="#l4.145"></a><span id="l4.145" class="difflineminus">-  }</span>
<a href="#l4.146"></a><span id="l4.146" class="difflineminus">-}</span>
<a href="#l4.147"></a><span id="l4.147" class="difflineminus">-</span>
<a href="#l4.148"></a><span id="l4.148" class="difflineminus">-function AddDirectoryServerObserver(flag) {</span>
<a href="#l4.149"></a><span id="l4.149" class="difflineminus">-  if (flag) {</span>
<a href="#l4.150"></a><span id="l4.150" class="difflineminus">-    Services.prefs.addObserver(&quot;ldap_2.autoComplete.useDirectory&quot;,</span>
<a href="#l4.151"></a><span id="l4.151" class="difflineminus">-                               directoryServerObserver, false);</span>
<a href="#l4.152"></a><span id="l4.152" class="difflineminus">-    Services.prefs.addObserver(&quot;ldap_2.autoComplete.directoryServer&quot;,</span>
<a href="#l4.153"></a><span id="l4.153" class="difflineminus">-                               directoryServerObserver, false);</span>
<a href="#l4.154"></a><span id="l4.154" class="difflineminus">-  }</span>
<a href="#l4.155"></a><span id="l4.155" class="difflineminus">-  else</span>
<a href="#l4.156"></a><span id="l4.156" class="difflineminus">-  {</span>
<a href="#l4.157"></a><span id="l4.157" class="difflineminus">-    var prefstring = &quot;mail.identity.&quot; + gCurrentIdentity.key + &quot;.overrideGlobal_Pref&quot;;</span>
<a href="#l4.158"></a><span id="l4.158" class="difflineminus">-    Services.prefs.addObserver(prefstring, directoryServerObserver, false);</span>
<a href="#l4.159"></a><span id="l4.159" class="difflineminus">-    prefstring = &quot;mail.identity.&quot; + gCurrentIdentity.key + &quot;.directoryServer&quot;;</span>
<a href="#l4.160"></a><span id="l4.160" class="difflineminus">-    Services.prefs.addObserver(prefstring, directoryServerObserver, false);</span>
<a href="#l4.161"></a><span id="l4.161" class="difflineminus">-  }</span>
<a href="#l4.162"></a><span id="l4.162" class="difflineminus">-}</span>
<a href="#l4.163"></a><span id="l4.163" class="difflineminus">-</span>
<a href="#l4.164"></a><span id="l4.164" class="difflineminus">-function RemoveDirectoryServerObserver(prefstring)</span>
<a href="#l4.165"></a><span id="l4.165" class="difflineminus">-{</span>
<a href="#l4.166"></a><span id="l4.166" class="difflineminus">-  if (!prefstring) {</span>
<a href="#l4.167"></a><span id="l4.167" class="difflineminus">-    Services.prefs.removeObserver(&quot;ldap_2.autoComplete.useDirectory&quot;,</span>
<a href="#l4.168"></a><span id="l4.168" class="difflineminus">-                                  directoryServerObserver);</span>
<a href="#l4.169"></a><span id="l4.169" class="difflineminus">-    Services.prefs.removeObserver(&quot;ldap_2.autoComplete.directoryServer&quot;,</span>
<a href="#l4.170"></a><span id="l4.170" class="difflineminus">-                                  directoryServerObserver);</span>
<a href="#l4.171"></a><span id="l4.171" class="difflineminus">-  }</span>
<a href="#l4.172"></a><span id="l4.172" class="difflineminus">-  else</span>
<a href="#l4.173"></a><span id="l4.173" class="difflineminus">-  {</span>
<a href="#l4.174"></a><span id="l4.174" class="difflineminus">-    var str = prefstring + &quot;.overrideGlobal_Pref&quot;;</span>
<a href="#l4.175"></a><span id="l4.175" class="difflineminus">-    Services.prefs.removeObserver(str, directoryServerObserver);</span>
<a href="#l4.176"></a><span id="l4.176" class="difflineminus">-    str = prefstring + &quot;.directoryServer&quot;;</span>
<a href="#l4.177"></a><span id="l4.177" class="difflineminus">-    Services.prefs.removeObserver(str, directoryServerObserver);</span>
<a href="#l4.178"></a><span id="l4.178" class="difflineminus">-  }</span>
<a href="#l4.179"></a><span id="l4.179" class="difflineminus">-}</span>
<a href="#l4.180"></a><span id="l4.180" class="difflineminus">-</span>
<a href="#l4.181"></a><span id="l4.181" class="difflineminus">-function AddDirectorySettingsObserver()</span>
<a href="#l4.182"></a><span id="l4.182" class="difflineminus">-{</span>
<a href="#l4.183"></a><span id="l4.183" class="difflineminus">-  Services.prefs.addObserver(gCurrentAutocompleteDirectory, directoryServerObserver,</span>
<a href="#l4.184"></a><span id="l4.184" class="difflineminus">-                             false);</span>
<a href="#l4.185"></a><span id="l4.185" class="difflineminus">-}</span>
<a href="#l4.186"></a><span id="l4.186" class="difflineminus">-</span>
<a href="#l4.187"></a><span id="l4.187" class="difflineminus">-function RemoveDirectorySettingsObserver(prefstring)</span>
<a href="#l4.188"></a><span id="l4.188" class="difflineminus">-{</span>
<a href="#l4.189"></a><span id="l4.189" class="difflineminus">-  Services.prefs.removeObserver(prefstring, directoryServerObserver);</span>
<a href="#l4.190"></a><span id="l4.190" class="difflineminus">-}</span>
<a href="#l4.191"></a><span id="l4.191" class="difflineminus">-</span>
<a href="#l4.192"></a><span id="l4.192" class="difflineminus">-function setupLdapAutocompleteSession()</span>
<a href="#l4.193"></a><span id="l4.193" class="difflineminus">-{</span>
<a href="#l4.194"></a><span id="l4.194" class="difflineminus">-    var autocompleteLdap = false;</span>
<a href="#l4.195"></a><span id="l4.195" class="difflineminus">-    var autocompleteDirectory = null;</span>
<a href="#l4.196"></a><span id="l4.196" class="difflineminus">-    var prevAutocompleteDirectory = gCurrentAutocompleteDirectory;</span>
<a href="#l4.197"></a><span id="l4.197" class="difflineminus">-</span>
<a href="#l4.198"></a><span id="l4.198" class="difflineminus">-    autocompleteLdap = getPref(&quot;ldap_2.autoComplete.useDirectory&quot;);</span>
<a href="#l4.199"></a><span id="l4.199" class="difflineminus">-    if (autocompleteLdap)</span>
<a href="#l4.200"></a><span id="l4.200" class="difflineminus">-        autocompleteDirectory = getPref(&quot;ldap_2.autoComplete.directoryServer&quot;);</span>
<a href="#l4.201"></a><span id="l4.201" class="difflineminus">-</span>
<a href="#l4.202"></a><span id="l4.202" class="difflineminus">-    if(gCurrentIdentity.overrideGlobalPref) {</span>
<a href="#l4.203"></a><span id="l4.203" class="difflineminus">-        autocompleteDirectory = gCurrentIdentity.directoryServer;</span>
<a href="#l4.204"></a><span id="l4.204" class="difflineminus">-    }</span>
<a href="#l4.205"></a><span id="l4.205" class="difflineminus">-</span>
<a href="#l4.206"></a><span id="l4.206" class="difflineminus">-    // use a temporary to do the setup so that we don't overwrite the</span>
<a href="#l4.207"></a><span id="l4.207" class="difflineminus">-    // global, then have some problem and throw an exception, and leave the</span>
<a href="#l4.208"></a><span id="l4.208" class="difflineminus">-    // global with a partially setup session.  we'll assign the temp</span>
<a href="#l4.209"></a><span id="l4.209" class="difflineminus">-    // into the global after we're done setting up the session</span>
<a href="#l4.210"></a><span id="l4.210" class="difflineminus">-    //</span>
<a href="#l4.211"></a><span id="l4.211" class="difflineminus">-    var LDAPSession;</span>
<a href="#l4.212"></a><span id="l4.212" class="difflineminus">-    if (gLDAPSession) {</span>
<a href="#l4.213"></a><span id="l4.213" class="difflineminus">-        LDAPSession = gLDAPSession;</span>
<a href="#l4.214"></a><span id="l4.214" class="difflineminus">-    } else {</span>
<a href="#l4.215"></a><span id="l4.215" class="difflineminus">-        LDAPSession = Components</span>
<a href="#l4.216"></a><span id="l4.216" class="difflineminus">-            .classes[&quot;@mozilla.org/autocompleteSession;1?type=ldap&quot;];</span>
<a href="#l4.217"></a><span id="l4.217" class="difflineminus">-        if (LDAPSession) {</span>
<a href="#l4.218"></a><span id="l4.218" class="difflineminus">-          try {</span>
<a href="#l4.219"></a><span id="l4.219" class="difflineminus">-            LDAPSession = LDAPSession.createInstance()</span>
<a href="#l4.220"></a><span id="l4.220" class="difflineminus">-                .QueryInterface(Components.interfaces.nsILDAPAutoCompleteSession);</span>
<a href="#l4.221"></a><span id="l4.221" class="difflineminus">-          } catch (ex) {dump (&quot;ERROR: Cannot get the LDAP autocomplete session\n&quot; + ex + &quot;\n&quot;);}</span>
<a href="#l4.222"></a><span id="l4.222" class="difflineminus">-        }</span>
<a href="#l4.223"></a><span id="l4.223" class="difflineminus">-    }</span>
<a href="#l4.224"></a><span id="l4.224" class="difflineminus">-</span>
<a href="#l4.225"></a><span id="l4.225" class="difflineminus">-    if (autocompleteDirectory &amp;&amp; !Services.io.offline) {</span>
<a href="#l4.226"></a><span id="l4.226" class="difflineminus">-        // Add observer on the directory server we are autocompleting against</span>
<a href="#l4.227"></a><span id="l4.227" class="difflineminus">-        // only if current server is different from previous.</span>
<a href="#l4.228"></a><span id="l4.228" class="difflineminus">-        // Remove observer if current server is different from previous</span>
<a href="#l4.229"></a><span id="l4.229" class="difflineminus">-        gCurrentAutocompleteDirectory = autocompleteDirectory;</span>
<a href="#l4.230"></a><span id="l4.230" class="difflineminus">-        if (prevAutocompleteDirectory) {</span>
<a href="#l4.231"></a><span id="l4.231" class="difflineminus">-          if (prevAutocompleteDirectory != gCurrentAutocompleteDirectory) {</span>
<a href="#l4.232"></a><span id="l4.232" class="difflineminus">-            RemoveDirectorySettingsObserver(prevAutocompleteDirectory);</span>
<a href="#l4.233"></a><span id="l4.233" class="difflineminus">-            AddDirectorySettingsObserver();</span>
<a href="#l4.234"></a><span id="l4.234" class="difflineminus">-          }</span>
<a href="#l4.235"></a><span id="l4.235" class="difflineminus">-        }</span>
<a href="#l4.236"></a><span id="l4.236" class="difflineminus">-        else</span>
<a href="#l4.237"></a><span id="l4.237" class="difflineminus">-          AddDirectorySettingsObserver();</span>
<a href="#l4.238"></a><span id="l4.238" class="difflineminus">-</span>
<a href="#l4.239"></a><span id="l4.239" class="difflineminus">-        // fill in the session params if there is a session</span>
<a href="#l4.240"></a><span id="l4.240" class="difflineminus">-        //</span>
<a href="#l4.241"></a><span id="l4.241" class="difflineminus">-        if (LDAPSession) {</span>
<a href="#l4.242"></a><span id="l4.242" class="difflineminus">-            let url = getPref(autocompleteDirectory + &quot;.uri&quot;, true);</span>
<a href="#l4.243"></a><span id="l4.243" class="difflineminus">-</span>
<a href="#l4.244"></a><span id="l4.244" class="difflineminus">-            LDAPSession.serverURL = Services.io</span>
<a href="#l4.245"></a><span id="l4.245" class="difflineminus">-                                            .newURI(url, null, null)</span>
<a href="#l4.246"></a><span id="l4.246" class="difflineminus">-                                            .QueryInterface(Components.interfaces.nsILDAPURL);</span>
<a href="#l4.247"></a><span id="l4.247" class="difflineminus">-</span>
<a href="#l4.248"></a><span id="l4.248" class="difflineminus">-            // get the login to authenticate as, if there is one</span>
<a href="#l4.249"></a><span id="l4.249" class="difflineminus">-            //</span>
<a href="#l4.250"></a><span id="l4.250" class="difflineminus">-            try {</span>
<a href="#l4.251"></a><span id="l4.251" class="difflineminus">-                LDAPSession.login = getPref(autocompleteDirectory + &quot;.auth.dn&quot;, true);</span>
<a href="#l4.252"></a><span id="l4.252" class="difflineminus">-            } catch (ex) {</span>
<a href="#l4.253"></a><span id="l4.253" class="difflineminus">-                // if we don't have this pref, no big deal</span>
<a href="#l4.254"></a><span id="l4.254" class="difflineminus">-            }</span>
<a href="#l4.255"></a><span id="l4.255" class="difflineminus">-</span>
<a href="#l4.256"></a><span id="l4.256" class="difflineminus">-            try {</span>
<a href="#l4.257"></a><span id="l4.257" class="difflineminus">-                 LDAPSession.saslMechanism = getPref(autocompleteDirectory +</span>
<a href="#l4.258"></a><span id="l4.258" class="difflineminus">-                                                     &quot;.auth.saslmech&quot;, true);</span>
<a href="#l4.259"></a><span id="l4.259" class="difflineminus">-            } catch (ex) {</span>
<a href="#l4.260"></a><span id="l4.260" class="difflineminus">-                // don't care if we don't have this pref</span>
<a href="#l4.261"></a><span id="l4.261" class="difflineminus">-            }</span>
<a href="#l4.262"></a><span id="l4.262" class="difflineminus">-</span>
<a href="#l4.263"></a><span id="l4.263" class="difflineminus">-            // set the LDAP protocol version correctly</span>
<a href="#l4.264"></a><span id="l4.264" class="difflineminus">-            var protocolVersion;</span>
<a href="#l4.265"></a><span id="l4.265" class="difflineminus">-            try {</span>
<a href="#l4.266"></a><span id="l4.266" class="difflineminus">-                protocolVersion = getPref(autocompleteDirectory +</span>
<a href="#l4.267"></a><span id="l4.267" class="difflineminus">-                                          &quot;.protocolVersion&quot;);</span>
<a href="#l4.268"></a><span id="l4.268" class="difflineminus">-            } catch (ex) {</span>
<a href="#l4.269"></a><span id="l4.269" class="difflineminus">-                // if we don't have this pref, no big deal</span>
<a href="#l4.270"></a><span id="l4.270" class="difflineminus">-            }</span>
<a href="#l4.271"></a><span id="l4.271" class="difflineminus">-            if (protocolVersion == &quot;2&quot;) {</span>
<a href="#l4.272"></a><span id="l4.272" class="difflineminus">-                LDAPSession.version =</span>
<a href="#l4.273"></a><span id="l4.273" class="difflineminus">-                    Components.interfaces.nsILDAPConnection.VERSION2;</span>
<a href="#l4.274"></a><span id="l4.274" class="difflineminus">-            }</span>
<a href="#l4.275"></a><span id="l4.275" class="difflineminus">-</span>
<a href="#l4.276"></a><span id="l4.276" class="difflineminus">-            // don't search on non-CJK strings shorter than this</span>
<a href="#l4.277"></a><span id="l4.277" class="difflineminus">-            //</span>
<a href="#l4.278"></a><span id="l4.278" class="difflineminus">-            try {</span>
<a href="#l4.279"></a><span id="l4.279" class="difflineminus">-                LDAPSession.minStringLength = getPref(</span>
<a href="#l4.280"></a><span id="l4.280" class="difflineminus">-                    autocompleteDirectory + &quot;.autoComplete.minStringLength&quot;);</span>
<a href="#l4.281"></a><span id="l4.281" class="difflineminus">-            } catch (ex) {</span>
<a href="#l4.282"></a><span id="l4.282" class="difflineminus">-                // if this pref isn't there, no big deal.  just let</span>
<a href="#l4.283"></a><span id="l4.283" class="difflineminus">-                // nsLDAPAutoCompleteSession use its default.</span>
<a href="#l4.284"></a><span id="l4.284" class="difflineminus">-            }</span>
<a href="#l4.285"></a><span id="l4.285" class="difflineminus">-</span>
<a href="#l4.286"></a><span id="l4.286" class="difflineminus">-            // don't search on CJK strings shorter than this</span>
<a href="#l4.287"></a><span id="l4.287" class="difflineminus">-            //</span>
<a href="#l4.288"></a><span id="l4.288" class="difflineminus">-            try {</span>
<a href="#l4.289"></a><span id="l4.289" class="difflineminus">-                LDAPSession.cjkMinStringLength = getPref(</span>
<a href="#l4.290"></a><span id="l4.290" class="difflineminus">-                  autocompleteDirectory + &quot;.autoComplete.cjkMinStringLength&quot;);</span>
<a href="#l4.291"></a><span id="l4.291" class="difflineminus">-            } catch (ex) {</span>
<a href="#l4.292"></a><span id="l4.292" class="difflineminus">-                // if this pref isn't there, no big deal.  just let</span>
<a href="#l4.293"></a><span id="l4.293" class="difflineminus">-                // nsLDAPAutoCompleteSession use its default.</span>
<a href="#l4.294"></a><span id="l4.294" class="difflineminus">-            }</span>
<a href="#l4.295"></a><span id="l4.295" class="difflineminus">-</span>
<a href="#l4.296"></a><span id="l4.296" class="difflineminus">-            // we don't try/catch here, because if this fails, we're outta luck</span>
<a href="#l4.297"></a><span id="l4.297" class="difflineminus">-            //</span>
<a href="#l4.298"></a><span id="l4.298" class="difflineminus">-            var ldapFormatter = Components.classes[</span>
<a href="#l4.299"></a><span id="l4.299" class="difflineminus">-                &quot;@mozilla.org/ldap-autocomplete-formatter;1?type=addrbook&quot;]</span>
<a href="#l4.300"></a><span id="l4.300" class="difflineminus">-                .createInstance().QueryInterface(</span>
<a href="#l4.301"></a><span id="l4.301" class="difflineminus">-                    Components.interfaces.nsIAbLDAPAutoCompFormatter);</span>
<a href="#l4.302"></a><span id="l4.302" class="difflineminus">-</span>
<a href="#l4.303"></a><span id="l4.303" class="difflineminus">-            // override autocomplete name format?</span>
<a href="#l4.304"></a><span id="l4.304" class="difflineminus">-            //</span>
<a href="#l4.305"></a><span id="l4.305" class="difflineminus">-            try {</span>
<a href="#l4.306"></a><span id="l4.306" class="difflineminus">-                ldapFormatter.nameFormat = getPref(autocompleteDirectory +</span>
<a href="#l4.307"></a><span id="l4.307" class="difflineminus">-                                                   &quot;.autoComplete.nameFormat&quot;,</span>
<a href="#l4.308"></a><span id="l4.308" class="difflineminus">-                                                   true);</span>
<a href="#l4.309"></a><span id="l4.309" class="difflineminus">-            } catch (ex) {</span>
<a href="#l4.310"></a><span id="l4.310" class="difflineminus">-                // if this pref isn't there, no big deal.  just let</span>
<a href="#l4.311"></a><span id="l4.311" class="difflineminus">-                // nsAbLDAPAutoCompFormatter use its default.</span>
<a href="#l4.312"></a><span id="l4.312" class="difflineminus">-            }</span>
<a href="#l4.313"></a><span id="l4.313" class="difflineminus">-</span>
<a href="#l4.314"></a><span id="l4.314" class="difflineminus">-            // override autocomplete mail address format?</span>
<a href="#l4.315"></a><span id="l4.315" class="difflineminus">-            //</span>
<a href="#l4.316"></a><span id="l4.316" class="difflineminus">-            try {</span>
<a href="#l4.317"></a><span id="l4.317" class="difflineminus">-                ldapFormatter.addressFormat = getPref(autocompleteDirectory +</span>
<a href="#l4.318"></a><span id="l4.318" class="difflineminus">-                                                      &quot;.autoComplete.addressFormat&quot;,</span>
<a href="#l4.319"></a><span id="l4.319" class="difflineminus">-                                                      true);</span>
<a href="#l4.320"></a><span id="l4.320" class="difflineminus">-            } catch (ex) {</span>
<a href="#l4.321"></a><span id="l4.321" class="difflineminus">-                // if this pref isn't there, no big deal.  just let</span>
<a href="#l4.322"></a><span id="l4.322" class="difflineminus">-                // nsAbLDAPAutoCompFormatter use its default.</span>
<a href="#l4.323"></a><span id="l4.323" class="difflineminus">-            }</span>
<a href="#l4.324"></a><span id="l4.324" class="difflineminus">-</span>
<a href="#l4.325"></a><span id="l4.325" class="difflineminus">-            try {</span>
<a href="#l4.326"></a><span id="l4.326" class="difflineminus">-                // figure out what goes in the comment column, if anything</span>
<a href="#l4.327"></a><span id="l4.327" class="difflineminus">-                //</span>
<a href="#l4.328"></a><span id="l4.328" class="difflineminus">-                // 0 = none</span>
<a href="#l4.329"></a><span id="l4.329" class="difflineminus">-                // 1 = name of addressbook this card came from</span>
<a href="#l4.330"></a><span id="l4.330" class="difflineminus">-                // 2 = other per-addressbook format</span>
<a href="#l4.331"></a><span id="l4.331" class="difflineminus">-                //</span>
<a href="#l4.332"></a><span id="l4.332" class="difflineminus">-                var showComments = getPref(&quot;mail.autoComplete.commentColumn&quot;);</span>
<a href="#l4.333"></a><span id="l4.333" class="difflineminus">-</span>
<a href="#l4.334"></a><span id="l4.334" class="difflineminus">-                switch (showComments) {</span>
<a href="#l4.335"></a><span id="l4.335" class="difflineminus">-</span>
<a href="#l4.336"></a><span id="l4.336" class="difflineminus">-                case 1:</span>
<a href="#l4.337"></a><span id="l4.337" class="difflineminus">-                    // use the name of this directory</span>
<a href="#l4.338"></a><span id="l4.338" class="difflineminus">-                    //</span>
<a href="#l4.339"></a><span id="l4.339" class="difflineminus">-                    ldapFormatter.commentFormat = getPref(</span>
<a href="#l4.340"></a><span id="l4.340" class="difflineminus">-                        autocompleteDirectory + &quot;.description&quot;, true);</span>
<a href="#l4.341"></a><span id="l4.341" class="difflineminus">-                    break;</span>
<a href="#l4.342"></a><span id="l4.342" class="difflineminus">-</span>
<a href="#l4.343"></a><span id="l4.343" class="difflineminus">-                case 2:</span>
<a href="#l4.344"></a><span id="l4.344" class="difflineminus">-                    // override ldap-specific autocomplete entry?</span>
<a href="#l4.345"></a><span id="l4.345" class="difflineminus">-                    //</span>
<a href="#l4.346"></a><span id="l4.346" class="difflineminus">-                    try {</span>
<a href="#l4.347"></a><span id="l4.347" class="difflineminus">-                        ldapFormatter.commentFormat =</span>
<a href="#l4.348"></a><span id="l4.348" class="difflineminus">-                            getPref(autocompleteDirectory +</span>
<a href="#l4.349"></a><span id="l4.349" class="difflineminus">-                                    &quot;.autoComplete.commentFormat&quot;, true);</span>
<a href="#l4.350"></a><span id="l4.350" class="difflineminus">-                    } catch (innerException) {</span>
<a href="#l4.351"></a><span id="l4.351" class="difflineminus">-                        // if nothing has been specified, use the ldap</span>
<a href="#l4.352"></a><span id="l4.352" class="difflineminus">-                        // organization field</span>
<a href="#l4.353"></a><span id="l4.353" class="difflineminus">-                        ldapFormatter.commentFormat = &quot;[o]&quot;;</span>
<a href="#l4.354"></a><span id="l4.354" class="difflineminus">-                    }</span>
<a href="#l4.355"></a><span id="l4.355" class="difflineminus">-                    break;</span>
<a href="#l4.356"></a><span id="l4.356" class="difflineminus">-</span>
<a href="#l4.357"></a><span id="l4.357" class="difflineminus">-                case 0:</span>
<a href="#l4.358"></a><span id="l4.358" class="difflineminus">-                default:</span>
<a href="#l4.359"></a><span id="l4.359" class="difflineminus">-                    // do nothing</span>
<a href="#l4.360"></a><span id="l4.360" class="difflineminus">-                }</span>
<a href="#l4.361"></a><span id="l4.361" class="difflineminus">-            } catch (ex) {</span>
<a href="#l4.362"></a><span id="l4.362" class="difflineminus">-                // if something went wrong while setting up comments, try and</span>
<a href="#l4.363"></a><span id="l4.363" class="difflineminus">-                // proceed anyway</span>
<a href="#l4.364"></a><span id="l4.364" class="difflineminus">-            }</span>
<a href="#l4.365"></a><span id="l4.365" class="difflineminus">-</span>
<a href="#l4.366"></a><span id="l4.366" class="difflineminus">-            // set the session's formatter, which also happens to</span>
<a href="#l4.367"></a><span id="l4.367" class="difflineminus">-            // force a call to the formatter's getAttributes() method</span>
<a href="#l4.368"></a><span id="l4.368" class="difflineminus">-            // -- which is why this needs to happen after we've set the</span>
<a href="#l4.369"></a><span id="l4.369" class="difflineminus">-            // various formats</span>
<a href="#l4.370"></a><span id="l4.370" class="difflineminus">-            //</span>
<a href="#l4.371"></a><span id="l4.371" class="difflineminus">-            LDAPSession.formatter = ldapFormatter;</span>
<a href="#l4.372"></a><span id="l4.372" class="difflineminus">-</span>
<a href="#l4.373"></a><span id="l4.373" class="difflineminus">-            // override autocomplete entry formatting?</span>
<a href="#l4.374"></a><span id="l4.374" class="difflineminus">-            //</span>
<a href="#l4.375"></a><span id="l4.375" class="difflineminus">-            try {</span>
<a href="#l4.376"></a><span id="l4.376" class="difflineminus">-                LDAPSession.outputFormat = getPref(autocompleteDirectory +</span>
<a href="#l4.377"></a><span id="l4.377" class="difflineminus">-                                                   &quot;.autoComplete.outputFormat&quot;,</span>
<a href="#l4.378"></a><span id="l4.378" class="difflineminus">-                                                   true);</span>
<a href="#l4.379"></a><span id="l4.379" class="difflineminus">-</span>
<a href="#l4.380"></a><span id="l4.380" class="difflineminus">-            } catch (ex) {</span>
<a href="#l4.381"></a><span id="l4.381" class="difflineminus">-                // if this pref isn't there, no big deal.  just let</span>
<a href="#l4.382"></a><span id="l4.382" class="difflineminus">-                // nsLDAPAutoCompleteSession use its default.</span>
<a href="#l4.383"></a><span id="l4.383" class="difflineminus">-            }</span>
<a href="#l4.384"></a><span id="l4.384" class="difflineminus">-</span>
<a href="#l4.385"></a><span id="l4.385" class="difflineminus">-            // override default search filter template?</span>
<a href="#l4.386"></a><span id="l4.386" class="difflineminus">-            //</span>
<a href="#l4.387"></a><span id="l4.387" class="difflineminus">-            try {</span>
<a href="#l4.388"></a><span id="l4.388" class="difflineminus">-                LDAPSession.filterTemplate = getPref(</span>
<a href="#l4.389"></a><span id="l4.389" class="difflineminus">-                    autocompleteDirectory + &quot;.autoComplete.filterTemplate&quot;,</span>
<a href="#l4.390"></a><span id="l4.390" class="difflineminus">-                    true);</span>
<a href="#l4.391"></a><span id="l4.391" class="difflineminus">-</span>
<a href="#l4.392"></a><span id="l4.392" class="difflineminus">-            } catch (ex) {</span>
<a href="#l4.393"></a><span id="l4.393" class="difflineminus">-                // if this pref isn't there, no big deal.  just let</span>
<a href="#l4.394"></a><span id="l4.394" class="difflineminus">-                // nsLDAPAutoCompleteSession use its default</span>
<a href="#l4.395"></a><span id="l4.395" class="difflineminus">-            }</span>
<a href="#l4.396"></a><span id="l4.396" class="difflineminus">-</span>
<a href="#l4.397"></a><span id="l4.397" class="difflineminus">-            // override default maxHits (currently 100)</span>
<a href="#l4.398"></a><span id="l4.398" class="difflineminus">-            //</span>
<a href="#l4.399"></a><span id="l4.399" class="difflineminus">-            try {</span>
<a href="#l4.400"></a><span id="l4.400" class="difflineminus">-                // XXXdmose should really use .autocomplete.maxHits,</span>
<a href="#l4.401"></a><span id="l4.401" class="difflineminus">-                // but there's no UI for that yet</span>
<a href="#l4.402"></a><span id="l4.402" class="difflineminus">-                //</span>
<a href="#l4.403"></a><span id="l4.403" class="difflineminus">-                LDAPSession.maxHits = getPref(autocompleteDirectory + &quot;.maxHits&quot;);</span>
<a href="#l4.404"></a><span id="l4.404" class="difflineminus">-            } catch (ex) {</span>
<a href="#l4.405"></a><span id="l4.405" class="difflineminus">-                // if this pref isn't there, or is out of range, no big deal.</span>
<a href="#l4.406"></a><span id="l4.406" class="difflineminus">-                // just let nsLDAPAutoCompleteSession use its default.</span>
<a href="#l4.407"></a><span id="l4.407" class="difflineminus">-            }</span>
<a href="#l4.408"></a><span id="l4.408" class="difflineminus">-</span>
<a href="#l4.409"></a><span id="l4.409" class="difflineminus">-            if (!gSessionAdded) {</span>
<a href="#l4.410"></a><span id="l4.410" class="difflineminus">-                // if we make it here, we know that session initialization has</span>
<a href="#l4.411"></a><span id="l4.411" class="difflineminus">-                // succeeded; add the session for all recipients, and</span>
<a href="#l4.412"></a><span id="l4.412" class="difflineminus">-                // remember that we've done so</span>
<a href="#l4.413"></a><span id="l4.413" class="difflineminus">-                let maxRecipients = awGetMaxRecipients();</span>
<a href="#l4.414"></a><span id="l4.414" class="difflineminus">-                for (let i = 1; i &lt;= maxRecipients; i++)</span>
<a href="#l4.415"></a><span id="l4.415" class="difflineminus">-                {</span>
<a href="#l4.416"></a><span id="l4.416" class="difflineminus">-                    let autoCompleteWidget = document.getElementById(&quot;addressCol2#&quot; + i);</span>
<a href="#l4.417"></a><span id="l4.417" class="difflineminus">-                    if (autoCompleteWidget)</span>
<a href="#l4.418"></a><span id="l4.418" class="difflineminus">-                    {</span>
<a href="#l4.419"></a><span id="l4.419" class="difflineminus">-                      autoCompleteWidget.addSession(LDAPSession);</span>
<a href="#l4.420"></a><span id="l4.420" class="difflineminus">-                      // ldap searches don't insert a default entry with the default domain appended to it</span>
<a href="#l4.421"></a><span id="l4.421" class="difflineminus">-                      // so reduce the minimum results for a popup to 2 in this case.</span>
<a href="#l4.422"></a><span id="l4.422" class="difflineminus">-                      autoCompleteWidget.minResultsForPopup = 2;</span>
<a href="#l4.423"></a><span id="l4.423" class="difflineminus">-</span>
<a href="#l4.424"></a><span id="l4.424" class="difflineminus">-                    }</span>
<a href="#l4.425"></a><span id="l4.425" class="difflineminus">-                 }</span>
<a href="#l4.426"></a><span id="l4.426" class="difflineminus">-                gSessionAdded = true;</span>
<a href="#l4.427"></a><span id="l4.427" class="difflineminus">-            }</span>
<a href="#l4.428"></a><span id="l4.428" class="difflineminus">-        }</span>
<a href="#l4.429"></a><span id="l4.429" class="difflineminus">-    } else {</span>
<a href="#l4.430"></a><span id="l4.430" class="difflineminus">-      if (gCurrentAutocompleteDirectory) {</span>
<a href="#l4.431"></a><span id="l4.431" class="difflineminus">-        // Remove observer on the directory server since we are not doing Ldap</span>
<a href="#l4.432"></a><span id="l4.432" class="difflineminus">-        // autocompletion.</span>
<a href="#l4.433"></a><span id="l4.433" class="difflineminus">-        RemoveDirectorySettingsObserver(gCurrentAutocompleteDirectory);</span>
<a href="#l4.434"></a><span id="l4.434" class="difflineminus">-        gCurrentAutocompleteDirectory = null;</span>
<a href="#l4.435"></a><span id="l4.435" class="difflineminus">-      }</span>
<a href="#l4.436"></a><span id="l4.436" class="difflineminus">-      if (gLDAPSession &amp;&amp; gSessionAdded) {</span>
<a href="#l4.437"></a><span id="l4.437" class="difflineminus">-        let maxRecipients = awGetMaxRecipients();</span>
<a href="#l4.438"></a><span id="l4.438" class="difflineminus">-        for (let i = 1; i &lt;= maxRecipients; i++)</span>
<a href="#l4.439"></a><span id="l4.439" class="difflineminus">-          document.getElementById(&quot;addressCol2#&quot; + i)</span>
<a href="#l4.440"></a><span id="l4.440" class="difflineminus">-                  .removeSession(gLDAPSession);</span>
<a href="#l4.441"></a><span id="l4.441" class="difflineminus">-</span>
<a href="#l4.442"></a><span id="l4.442" class="difflineminus">-        gSessionAdded = false;</span>
<a href="#l4.443"></a><span id="l4.443" class="difflineminus">-      }</span>
<a href="#l4.444"></a><span id="l4.444" class="difflineminus">-    }</span>
<a href="#l4.445"></a><span id="l4.445" class="difflineminus">-</span>
<a href="#l4.446"></a><span id="l4.446" class="difflineminus">-    gLDAPSession = LDAPSession;</span>
<a href="#l4.447"></a><span id="l4.447" class="difflineminus">-    gSetupLdapAutocomplete = true;</span>
<a href="#l4.448"></a><span id="l4.448" class="difflineminus">-}</span>
<a href="#l4.449"></a><span id="l4.449" class="difflineminus">-</span>
<a href="#l4.450"></a><span id="l4.450"> function DoCommandClose()</span>
<a href="#l4.451"></a><span id="l4.451"> {</span>
<a href="#l4.452"></a><span id="l4.452">   if (ComposeCanClose()) {</span>
<a href="#l4.453"></a><span id="l4.453"> </span>
<a href="#l4.454"></a><span id="l4.454">     // Notify the SendListener that Send has been aborted and Stopped</span>
<a href="#l4.455"></a><span id="l4.455">     if (gMsgCompose)</span>
<a href="#l4.456"></a><span id="l4.456">       gMsgCompose.onSendNotPerformed(null, Components.results.NS_ERROR_ABORT);</span>
<a href="#l4.457"></a><span id="l4.457"> </span>
<a href="#l4.458"></a><span id="l4.458" class="difflineat">@@ -2478,17 +2144,16 @@ function ComposeLoad()</span>
<a href="#l4.459"></a><span id="l4.459">   try {</span>
<a href="#l4.460"></a><span id="l4.460">     var other_headers = getPref(&quot;mail.compose.other.header&quot;);</span>
<a href="#l4.461"></a><span id="l4.461">   }</span>
<a href="#l4.462"></a><span id="l4.462">   catch (ex) {</span>
<a href="#l4.463"></a><span id="l4.463">     dump(&quot;failed to get the mail.compose.other.header pref\n&quot;);</span>
<a href="#l4.464"></a><span id="l4.464">   }</span>
<a href="#l4.465"></a><span id="l4.465"> </span>
<a href="#l4.466"></a><span id="l4.466">   AddMessageComposeOfflineQuitObserver();</span>
<a href="#l4.467"></a><span id="l4.467" class="difflineminus">-  AddDirectoryServerObserver(true);</span>
<a href="#l4.468"></a><span id="l4.468"> </span>
<a href="#l4.469"></a><span id="l4.469">   try {</span>
<a href="#l4.470"></a><span id="l4.470">     // XXX: We used to set commentColumn on the initial auto complete column after the document has loaded</span>
<a href="#l4.471"></a><span id="l4.471">     // inside of setupAutocomplete. But this happens too late for the first widget and it was never showing</span>
<a href="#l4.472"></a><span id="l4.472">     // the comment field. Try to set it before the document finishes loading:</span>
<a href="#l4.473"></a><span id="l4.473">     if (getPref(&quot;mail.autoComplete.commentColumn&quot;))</span>
<a href="#l4.474"></a><span id="l4.474">       document.getElementById('addressCol2#1').showCommentColumn = true;</span>
<a href="#l4.475"></a><span id="l4.475">   }</span>
<a href="#l4.476"></a><span id="l4.476" class="difflineat">@@ -2538,23 +2203,18 @@ function ComposeUnload()</span>
<a href="#l4.477"></a><span id="l4.477">   enableInlineSpellCheck(false);</span>
<a href="#l4.478"></a><span id="l4.478"> </span>
<a href="#l4.479"></a><span id="l4.479">   EditorCleanup();</span>
<a href="#l4.480"></a><span id="l4.480"> </span>
<a href="#l4.481"></a><span id="l4.481">   if (gMsgCompose)</span>
<a href="#l4.482"></a><span id="l4.482">     gMsgCompose.removeMsgSendListener(gSendListener);</span>
<a href="#l4.483"></a><span id="l4.483"> </span>
<a href="#l4.484"></a><span id="l4.484">   RemoveMessageComposeOfflineQuitObserver();</span>
<a href="#l4.485"></a><span id="l4.485" class="difflineminus">-  RemoveDirectoryServerObserver(null);</span>
<a href="#l4.486"></a><span id="l4.486">   gAttachmentNotifier.shutdown();</span>
<a href="#l4.487"></a><span id="l4.487"> </span>
<a href="#l4.488"></a><span id="l4.488" class="difflineminus">-  if (gCurrentIdentity)</span>
<a href="#l4.489"></a><span id="l4.489" class="difflineminus">-    RemoveDirectoryServerObserver(&quot;mail.identity.&quot; + gCurrentIdentity.key);</span>
<a href="#l4.490"></a><span id="l4.490" class="difflineminus">-  if (gCurrentAutocompleteDirectory)</span>
<a href="#l4.491"></a><span id="l4.491" class="difflineminus">-    RemoveDirectorySettingsObserver(gCurrentAutocompleteDirectory);</span>
<a href="#l4.492"></a><span id="l4.492">   if (gMsgCompose)</span>
<a href="#l4.493"></a><span id="l4.493">     gMsgCompose.UnregisterStateListener(stateListener);</span>
<a href="#l4.494"></a><span id="l4.494">   if (gAutoSaveTimeout)</span>
<a href="#l4.495"></a><span id="l4.495">     clearTimeout(gAutoSaveTimeout);</span>
<a href="#l4.496"></a><span id="l4.496">   if (msgWindow)</span>
<a href="#l4.497"></a><span id="l4.497">     msgWindow.closeWindow();</span>
<a href="#l4.498"></a><span id="l4.498"> </span>
<a href="#l4.499"></a><span id="l4.499">   ReleaseGlobalVariables();</span>
<a href="#l4.500"></a><span id="l4.500" class="difflineat">@@ -3436,17 +3096,16 @@ function SetComposeWindowTitle()</span>
<a href="#l4.501"></a><span id="l4.501"> }</span>
<a href="#l4.502"></a><span id="l4.502"> </span>
<a href="#l4.503"></a><span id="l4.503"> // Check for changes to document and allow saving before closing</span>
<a href="#l4.504"></a><span id="l4.504"> // This is hooked up to the OS's window close widget (e.g., &quot;X&quot; for Windows)</span>
<a href="#l4.505"></a><span id="l4.505"> function ComposeCanClose()</span>
<a href="#l4.506"></a><span id="l4.506"> {</span>
<a href="#l4.507"></a><span id="l4.507">   // Do this early, so ldap sessions have a better chance to</span>
<a href="#l4.508"></a><span id="l4.508">   // cleanup after themselves.</span>
<a href="#l4.509"></a><span id="l4.509" class="difflineminus">-  ReleaseAutoCompleteState();</span>
<a href="#l4.510"></a><span id="l4.510">   if (gSendOrSaveOperationInProgress)</span>
<a href="#l4.511"></a><span id="l4.511">   {</span>
<a href="#l4.512"></a><span id="l4.512">     let result;</span>
<a href="#l4.513"></a><span id="l4.513"> </span>
<a href="#l4.514"></a><span id="l4.514">     let brandBundle = document.getElementById(&quot;brandBundle&quot;);</span>
<a href="#l4.515"></a><span id="l4.515">     let brandShortName = brandBundle.getString(&quot;brandShortName&quot;);</span>
<a href="#l4.516"></a><span id="l4.516">     let promptTitle = getComposeBundle().getString(&quot;quitComposeWindowTitle&quot;);</span>
<a href="#l4.517"></a><span id="l4.517">     let promptMsg = getComposeBundle().getFormattedString(&quot;quitComposeWindowMessage2&quot;,</span>
<a href="#l4.518"></a><span id="l4.518" class="difflineat">@@ -3547,32 +3206,16 @@ function RemoveDraft()</span>
<a href="#l4.519"></a><span id="l4.519"> }</span>
<a href="#l4.520"></a><span id="l4.520"> </span>
<a href="#l4.521"></a><span id="l4.521"> function SetContentAndBodyAsUnmodified()</span>
<a href="#l4.522"></a><span id="l4.522"> {</span>
<a href="#l4.523"></a><span id="l4.523">   gMsgCompose.bodyModified = false;</span>
<a href="#l4.524"></a><span id="l4.524">   gContentChanged = false;</span>
<a href="#l4.525"></a><span id="l4.525"> }</span>
<a href="#l4.526"></a><span id="l4.526"> </span>
<a href="#l4.527"></a><span id="l4.527" class="difflineminus">-function ReleaseAutoCompleteState()</span>
<a href="#l4.528"></a><span id="l4.528" class="difflineminus">-{</span>
<a href="#l4.529"></a><span id="l4.529" class="difflineminus">-  let maxRecipients = awGetMaxRecipients();</span>
<a href="#l4.530"></a><span id="l4.530" class="difflineminus">-  for (let i = 1; i &lt;= maxRecipients; i++)</span>
<a href="#l4.531"></a><span id="l4.531" class="difflineminus">-    document.getElementById(&quot;addressCol2#&quot; + i).removeSession(gLDAPSession);</span>
<a href="#l4.532"></a><span id="l4.532" class="difflineminus">-</span>
<a href="#l4.533"></a><span id="l4.533" class="difflineminus">-  gSessionAdded = false;</span>
<a href="#l4.534"></a><span id="l4.534" class="difflineminus">-  gSetupLdapAutocomplete = false;</span>
<a href="#l4.535"></a><span id="l4.535" class="difflineminus">-  if (gLDAPSession) {</span>
<a href="#l4.536"></a><span id="l4.536" class="difflineminus">-    gLDAPSession = null;</span>
<a href="#l4.537"></a><span id="l4.537" class="difflineminus">-    // We're trying to force ldap sessions to get cleaned up as</span>
<a href="#l4.538"></a><span id="l4.538" class="difflineminus">-    // soon as possible so they don't hang on shutdown.</span>
<a href="#l4.539"></a><span id="l4.539" class="difflineminus">-    Components.utils.forceGC();</span>
<a href="#l4.540"></a><span id="l4.540" class="difflineminus">-  }</span>
<a href="#l4.541"></a><span id="l4.541" class="difflineminus">-}</span>
<a href="#l4.542"></a><span id="l4.542" class="difflineminus">-</span>
<a href="#l4.543"></a><span id="l4.543"> function MsgComposeCloseWindow(recycleIt)</span>
<a href="#l4.544"></a><span id="l4.544"> {</span>
<a href="#l4.545"></a><span id="l4.545">   if (gMsgCompose)</span>
<a href="#l4.546"></a><span id="l4.546">     gMsgCompose.CloseWindow(recycleIt);</span>
<a href="#l4.547"></a><span id="l4.547">   else</span>
<a href="#l4.548"></a><span id="l4.548">     window.close();</span>
<a href="#l4.549"></a><span id="l4.549"> }</span>
<a href="#l4.550"></a><span id="l4.550"> </span>
<a href="#l4.551"></a><span id="l4.551" class="difflineat">@@ -4136,18 +3779,16 @@ function LoadIdentity(startup)</span>
<a href="#l4.552"></a><span id="l4.552">         }</span>
<a href="#l4.553"></a><span id="l4.553"> </span>
<a href="#l4.554"></a><span id="l4.554">         let maxRecipients = awGetMaxRecipients();</span>
<a href="#l4.555"></a><span id="l4.555">         for (let i = 1; i &lt;= maxRecipients; i++)</span>
<a href="#l4.556"></a><span id="l4.556">           awGetInputElement(i).setAttribute(&quot;autocompletesearchparam&quot;, idKey);</span>
<a href="#l4.557"></a><span id="l4.557"> </span>
<a href="#l4.558"></a><span id="l4.558">         if (!startup &amp;&amp; prevIdentity &amp;&amp; idKey != prevIdentity.key)</span>
<a href="#l4.559"></a><span id="l4.559">         {</span>
<a href="#l4.560"></a><span id="l4.560" class="difflineminus">-          var prefstring = &quot;mail.identity.&quot; + prevIdentity.key;</span>
<a href="#l4.561"></a><span id="l4.561" class="difflineminus">-          RemoveDirectoryServerObserver(prefstring);</span>
<a href="#l4.562"></a><span id="l4.562">           var prevReplyTo = prevIdentity.replyTo;</span>
<a href="#l4.563"></a><span id="l4.563">           var prevCc = &quot;&quot;;</span>
<a href="#l4.564"></a><span id="l4.564">           var prevBcc = &quot;&quot;;</span>
<a href="#l4.565"></a><span id="l4.565">           var prevReceipt = prevIdentity.requestReturnReceipt;</span>
<a href="#l4.566"></a><span id="l4.566">           var prevDSN = prevIdentity.DSN;</span>
<a href="#l4.567"></a><span id="l4.567">           var prevAttachVCard = prevIdentity.attachVCard;</span>
<a href="#l4.568"></a><span id="l4.568"> </span>
<a href="#l4.569"></a><span id="l4.569">           if (prevIdentity.doCc)</span>
<a href="#l4.570"></a><span id="l4.570" class="difflineat">@@ -4230,28 +3871,20 @@ function LoadIdentity(startup)</span>
<a href="#l4.571"></a><span id="l4.571">             gMsgCompose.identity = gCurrentIdentity;</span>
<a href="#l4.572"></a><span id="l4.572">           } catch (ex) { dump(&quot;### Cannot change the identity: &quot; + ex + &quot;\n&quot;);}</span>
<a href="#l4.573"></a><span id="l4.573"> </span>
<a href="#l4.574"></a><span id="l4.574">           var event = document.createEvent('Events');</span>
<a href="#l4.575"></a><span id="l4.575">           event.initEvent('compose-from-changed', false, true);</span>
<a href="#l4.576"></a><span id="l4.576">           document.getElementById(&quot;msgcomposeWindow&quot;).dispatchEvent(event);</span>
<a href="#l4.577"></a><span id="l4.577">         }</span>
<a href="#l4.578"></a><span id="l4.578"> </span>
<a href="#l4.579"></a><span id="l4.579" class="difflineminus">-      AddDirectoryServerObserver(false);</span>
<a href="#l4.580"></a><span id="l4.580">       if (!startup) {</span>
<a href="#l4.581"></a><span id="l4.581">           if (getPref(&quot;mail.autoComplete.highlightNonMatches&quot;))</span>
<a href="#l4.582"></a><span id="l4.582">             document.getElementById('addressCol2#1').highlightNonMatches = true;</span>
<a href="#l4.583"></a><span id="l4.583"> </span>
<a href="#l4.584"></a><span id="l4.584" class="difflineminus">-          try {</span>
<a href="#l4.585"></a><span id="l4.585" class="difflineminus">-              setupLdapAutocompleteSession();</span>
<a href="#l4.586"></a><span id="l4.586" class="difflineminus">-          } catch (ex) {</span>
<a href="#l4.587"></a><span id="l4.587" class="difflineminus">-              // catch the exception and ignore it, so that if LDAP setup</span>
<a href="#l4.588"></a><span id="l4.588" class="difflineminus">-              // fails, the entire compose window doesn't end up horked</span>
<a href="#l4.589"></a><span id="l4.589" class="difflineminus">-          }</span>
<a href="#l4.590"></a><span id="l4.590" class="difflineminus">-</span>
<a href="#l4.591"></a><span id="l4.591">           addRecipientsToIgnoreList(gCurrentIdentity.identityName);  // only do this if we aren't starting up....it gets done as part of startup already</span>
<a href="#l4.592"></a><span id="l4.592">       }</span>
<a href="#l4.593"></a><span id="l4.593">     }</span>
<a href="#l4.594"></a><span id="l4.594"> }</span>
<a href="#l4.595"></a><span id="l4.595"> </span>
<a href="#l4.596"></a><span id="l4.596"> function setupAutocomplete()</span>
<a href="#l4.597"></a><span id="l4.597"> {</span>
<a href="#l4.598"></a><span id="l4.598">   var autoCompleteWidget = document.getElementById(&quot;addressCol2#1&quot;);</span>
<a href="#l4.599"></a><span id="l4.599" class="difflineat">@@ -4271,28 +3904,16 @@ function setupAutocomplete()</span>
<a href="#l4.600"></a><span id="l4.600"> </span>
<a href="#l4.601"></a><span id="l4.601">     if (getPref(&quot;mail.autoComplete.commentColumn&quot;))</span>
<a href="#l4.602"></a><span id="l4.602">       autoCompleteWidget.showCommentColumn = true;</span>
<a href="#l4.603"></a><span id="l4.603">   } catch (ex)</span>
<a href="#l4.604"></a><span id="l4.604">   {</span>
<a href="#l4.605"></a><span id="l4.605">       // if we can't get this pref, then don't show the columns (which is</span>
<a href="#l4.606"></a><span id="l4.606">       // what the XUL defaults to)</span>
<a href="#l4.607"></a><span id="l4.607">   }</span>
<a href="#l4.608"></a><span id="l4.608" class="difflineminus">-</span>
<a href="#l4.609"></a><span id="l4.609" class="difflineminus">-  if (!gSetupLdapAutocomplete)</span>
<a href="#l4.610"></a><span id="l4.610" class="difflineminus">-  {</span>
<a href="#l4.611"></a><span id="l4.611" class="difflineminus">-    try</span>
<a href="#l4.612"></a><span id="l4.612" class="difflineminus">-    {</span>
<a href="#l4.613"></a><span id="l4.613" class="difflineminus">-          setupLdapAutocompleteSession();</span>
<a href="#l4.614"></a><span id="l4.614" class="difflineminus">-    } catch (ex)</span>
<a href="#l4.615"></a><span id="l4.615" class="difflineminus">-    {</span>
<a href="#l4.616"></a><span id="l4.616" class="difflineminus">-          // catch the exception and ignore it, so that if LDAP setup</span>
<a href="#l4.617"></a><span id="l4.617" class="difflineminus">-          // fails, the entire compose window doesn't end up horked</span>
<a href="#l4.618"></a><span id="l4.618" class="difflineminus">-      }</span>
<a href="#l4.619"></a><span id="l4.619" class="difflineminus">-  }</span>
<a href="#l4.620"></a><span id="l4.620"> }</span>
<a href="#l4.621"></a><span id="l4.621"> </span>
<a href="#l4.622"></a><span id="l4.622"> function subjectKeyPress(event)</span>
<a href="#l4.623"></a><span id="l4.623"> {</span>
<a href="#l4.624"></a><span id="l4.624">   if (event.keyCode == KeyEvent.DOM_VK_RETURN)</span>
<a href="#l4.625"></a><span id="l4.625">     SetMsgBodyFrameFocus();</span>
<a href="#l4.626"></a><span id="l4.626"> }</span>
<a href="#l4.627"></a><span id="l4.627"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/suite/mailnews/addrbook/abListOverlay.xul</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/suite/mailnews/addrbook/abListOverlay.xul</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -60,17 +60,17 @@</span>
<a href="#l5.4"></a><span id="l5.4">   &lt;listbox id=&quot;addressingWidget&quot; style=&quot;height: 15em;&quot;</span>
<a href="#l5.5"></a><span id="l5.5">            onclick=&quot;awClickEmptySpace(event.target, true)&quot;&gt;</span>
<a href="#l5.6"></a><span id="l5.6">     &lt;listitem class=&quot;addressingWidgetItem&quot; allowevents=&quot;true&quot;&gt;</span>
<a href="#l5.7"></a><span id="l5.7">       &lt;listcell class=&quot;addressingWidgetCell&quot;&gt;</span>
<a href="#l5.8"></a><span id="l5.8">         &lt;textbox id=&quot;addressCol1#1&quot;</span>
<a href="#l5.9"></a><span id="l5.9">                  class=&quot;plain textbox-addressingWidget uri-element&quot;</span>
<a href="#l5.10"></a><span id="l5.10">                  type=&quot;autocomplete&quot;</span>
<a href="#l5.11"></a><span id="l5.11">                  flex=&quot;1&quot;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-                 autocompletesearch=&quot;addrbook&quot; timeout=&quot;300&quot; maxrows=&quot;4&quot;</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+                 autocompletesearch=&quot;addrbook ldap&quot; timeout=&quot;300&quot; maxrows=&quot;4&quot;</span>
<a href="#l5.14"></a><span id="l5.14">                  completedefaultindex=&quot;true&quot; forcecomplete=&quot;true&quot;</span>
<a href="#l5.15"></a><span id="l5.15">                  minresultsforpopup=&quot;3&quot;</span>
<a href="#l5.16"></a><span id="l5.16">                  ontextentered=&quot;awRecipientTextCommand(eventParam, this)&quot;</span>
<a href="#l5.17"></a><span id="l5.17">                  onkeypress=&quot;handleKeyPress(this, event);&quot;</span>
<a href="#l5.18"></a><span id="l5.18">                  onkeydown=&quot;awRecipientKeyDown(event, this);&quot;</span>
<a href="#l5.19"></a><span id="l5.19">                  onclick=&quot;awNotAnEmptyArea(event);&quot;&gt;</span>
<a href="#l5.20"></a><span id="l5.20">           &lt;image onclick=&quot;awNotAnEmptyArea(event)&quot; class=&quot;person-icon&quot;/&gt;</span>
<a href="#l5.21"></a><span id="l5.21">         &lt;/textbox&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/suite/mailnews/compose/MsgComposeCommands.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/suite/mailnews/compose/MsgComposeCommands.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -51,20 +51,16 @@ var gMsgCompose;</span>
<a href="#l6.4"></a><span id="l6.4"> var gAccountManager;</span>
<a href="#l6.5"></a><span id="l6.5"> var gWindowLocked;</span>
<a href="#l6.6"></a><span id="l6.6"> var gContentChanged;</span>
<a href="#l6.7"></a><span id="l6.7"> var gAutoSaving;</span>
<a href="#l6.8"></a><span id="l6.8"> var gCurrentIdentity;</span>
<a href="#l6.9"></a><span id="l6.9"> var defaultSaveOperation;</span>
<a href="#l6.10"></a><span id="l6.10"> var gSendOrSaveOperationInProgress;</span>
<a href="#l6.11"></a><span id="l6.11"> var gCloseWindowAfterSave;</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-var gSessionAdded;</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-var gCurrentAutocompleteDirectory;</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-var gSetupLdapAutocomplete;</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineminus">-var gLDAPSession;</span>
<a href="#l6.16"></a><span id="l6.16"> var gSavedSendNowKey;</span>
<a href="#l6.17"></a><span id="l6.17"> var gSendFormat;</span>
<a href="#l6.18"></a><span id="l6.18"> var gLogComposePerformance;</span>
<a href="#l6.19"></a><span id="l6.19"> </span>
<a href="#l6.20"></a><span id="l6.20"> var gMsgIdentityElement;</span>
<a href="#l6.21"></a><span id="l6.21"> var gMsgAddressingWidgetElement;</span>
<a href="#l6.22"></a><span id="l6.22"> var gMsgSubjectElement;</span>
<a href="#l6.23"></a><span id="l6.23"> var gMsgAttachmentElement;</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineat">@@ -95,20 +91,16 @@ function InitializeGlobalVariables()</span>
<a href="#l6.25"></a><span id="l6.25">   gMsgCompose = null;</span>
<a href="#l6.26"></a><span id="l6.26">   gWindowLocked = false;</span>
<a href="#l6.27"></a><span id="l6.27">   gContentChanged = false;</span>
<a href="#l6.28"></a><span id="l6.28">   gCurrentIdentity = null;</span>
<a href="#l6.29"></a><span id="l6.29">   defaultSaveOperation = &quot;draft&quot;;</span>
<a href="#l6.30"></a><span id="l6.30">   gSendOrSaveOperationInProgress = false;</span>
<a href="#l6.31"></a><span id="l6.31">   gAutoSaving = false;</span>
<a href="#l6.32"></a><span id="l6.32">   gCloseWindowAfterSave = false;</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineminus">-  gSessionAdded = false;</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineminus">-  gCurrentAutocompleteDirectory = null;</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineminus">-  gSetupLdapAutocomplete = false;</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineminus">-  gLDAPSession = null;</span>
<a href="#l6.37"></a><span id="l6.37">   gSavedSendNowKey = null;</span>
<a href="#l6.38"></a><span id="l6.38">   gSendFormat = nsIMsgCompSendFormat.AskUser;</span>
<a href="#l6.39"></a><span id="l6.39">   gSendDefaultCharset = null;</span>
<a href="#l6.40"></a><span id="l6.40">   gCharsetTitle = null;</span>
<a href="#l6.41"></a><span id="l6.41">   gCharsetConvertManager = Components.classes['@mozilla.org/charset-converter-manager;1'].getService(Components.interfaces.nsICharsetConverterManager);</span>
<a href="#l6.42"></a><span id="l6.42">   gMailSession = Components.classes[&quot;@mozilla.org/messenger/services/session;1&quot;].getService(Components.interfaces.nsIMsgMailSession);</span>
<a href="#l6.43"></a><span id="l6.43">   gHideMenus = false;</span>
<a href="#l6.44"></a><span id="l6.44">   // We are storing the value of the bool logComposePerformance inorder to avoid logging unnecessarily.</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineat">@@ -121,21 +113,16 @@ function InitializeGlobalVariables()</span>
<a href="#l6.46"></a><span id="l6.46">   gAttachVCardOptionChanged = false;</span>
<a href="#l6.47"></a><span id="l6.47"> }</span>
<a href="#l6.48"></a><span id="l6.48"> InitializeGlobalVariables();</span>
<a href="#l6.49"></a><span id="l6.49"> </span>
<a href="#l6.50"></a><span id="l6.50"> function ReleaseGlobalVariables()</span>
<a href="#l6.51"></a><span id="l6.51"> {</span>
<a href="#l6.52"></a><span id="l6.52">   gAccountManager = null;</span>
<a href="#l6.53"></a><span id="l6.53">   gCurrentIdentity = null;</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineminus">-  gCurrentAutocompleteDirectory = null;</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineminus">-  if (gLDAPSession) {</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineminus">-    gLDAPSession = null;</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineminus">-    Components.utils.forceGC();</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineminus">-  }</span>
<a href="#l6.59"></a><span id="l6.59">   gCharsetConvertManager = null;</span>
<a href="#l6.60"></a><span id="l6.60">   gMsgCompose = null;</span>
<a href="#l6.61"></a><span id="l6.61">   gMailSession = null;</span>
<a href="#l6.62"></a><span id="l6.62"> }</span>
<a href="#l6.63"></a><span id="l6.63"> </span>
<a href="#l6.64"></a><span id="l6.64"> function disableEditableFields()</span>
<a href="#l6.65"></a><span id="l6.65"> {</span>
<a href="#l6.66"></a><span id="l6.66">   gMsgCompose.editor.flags |= nsIPlaintextEditorMail.eEditorReadonlyMask;</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineat">@@ -152,17 +139,16 @@ function enableEditableFields()</span>
<a href="#l6.68"></a><span id="l6.68">   for (let i = 0; i &lt; enableElements.length; i++)</span>
<a href="#l6.69"></a><span id="l6.69">     enableElements[i].removeAttribute('disabled');</span>
<a href="#l6.70"></a><span id="l6.70"> </span>
<a href="#l6.71"></a><span id="l6.71"> }</span>
<a href="#l6.72"></a><span id="l6.72"> </span>
<a href="#l6.73"></a><span id="l6.73"> var gComposeRecyclingListener = {</span>
<a href="#l6.74"></a><span id="l6.74">   onClose: function() {</span>
<a href="#l6.75"></a><span id="l6.75">     //Reset recipients and attachments</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineminus">-    ReleaseAutoCompleteState();</span>
<a href="#l6.77"></a><span id="l6.77">     awResetAllRows();</span>
<a href="#l6.78"></a><span id="l6.78">     RemoveAllAttachments();</span>
<a href="#l6.79"></a><span id="l6.79"> </span>
<a href="#l6.80"></a><span id="l6.80">     // We need to clear the identity popup menu in case the user will change them. It will be rebuilded later in ComposeStartup</span>
<a href="#l6.81"></a><span id="l6.81">     ClearIdentityListPopup(document.getElementById(&quot;msgIdentityPopup&quot;));</span>
<a href="#l6.82"></a><span id="l6.82"> </span>
<a href="#l6.83"></a><span id="l6.83">     //Clear the subject</span>
<a href="#l6.84"></a><span id="l6.84">     GetMsgSubjectElement().value = &quot;&quot;;</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineat">@@ -658,23 +644,16 @@ function updateOptionItems()</span>
<a href="#l6.86"></a><span id="l6.86"> }</span>
<a href="#l6.87"></a><span id="l6.87"> </span>
<a href="#l6.88"></a><span id="l6.88"> var messageComposeOfflineQuitObserver = {</span>
<a href="#l6.89"></a><span id="l6.89">   observe: function(aSubject, aTopic, aState) {</span>
<a href="#l6.90"></a><span id="l6.90">     // sanity checks</span>
<a href="#l6.91"></a><span id="l6.91">     if (aTopic == &quot;network:offline-status-changed&quot;)</span>
<a href="#l6.92"></a><span id="l6.92">     {</span>
<a href="#l6.93"></a><span id="l6.93">       MessageComposeOfflineStateChanged(aState == &quot;offline&quot;);</span>
<a href="#l6.94"></a><span id="l6.94" class="difflineminus">-</span>
<a href="#l6.95"></a><span id="l6.95" class="difflineminus">-      try {</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineminus">-        setupLdapAutocompleteSession();</span>
<a href="#l6.97"></a><span id="l6.97" class="difflineminus">-      } catch (ex) {</span>
<a href="#l6.98"></a><span id="l6.98" class="difflineminus">-        // catch the exception and ignore it, so that if LDAP setup</span>
<a href="#l6.99"></a><span id="l6.99" class="difflineminus">-        // fails, the entire compose window stuff doesn't get aborted</span>
<a href="#l6.100"></a><span id="l6.100" class="difflineminus">-      }</span>
<a href="#l6.101"></a><span id="l6.101">     }</span>
<a href="#l6.102"></a><span id="l6.102">     // check whether to veto the quit request (unless another observer already</span>
<a href="#l6.103"></a><span id="l6.103">     // did)</span>
<a href="#l6.104"></a><span id="l6.104">     else if (aTopic == &quot;quit-application-requested&quot; &amp;&amp;</span>
<a href="#l6.105"></a><span id="l6.105">              aSubject instanceof Components.interfaces.nsISupportsPRBool &amp;&amp;</span>
<a href="#l6.106"></a><span id="l6.106">              !aSubject.data)</span>
<a href="#l6.107"></a><span id="l6.107">       aSubject.data = !ComposeCanClose();</span>
<a href="#l6.108"></a><span id="l6.108">   }</span>
<a href="#l6.109"></a><span id="l6.109" class="difflineat">@@ -725,334 +704,16 @@ function MessageComposeOfflineStateChang</span>
<a href="#l6.110"></a><span id="l6.110">       if (gSavedSendNowKey) {</span>
<a href="#l6.111"></a><span id="l6.111">         sendNowMenuItem.setAttribute('key', gSavedSendNowKey);</span>
<a href="#l6.112"></a><span id="l6.112">       }</span>
<a href="#l6.113"></a><span id="l6.113">     }</span>
<a href="#l6.114"></a><span id="l6.114"> </span>
<a href="#l6.115"></a><span id="l6.115">   } catch(e) {}</span>
<a href="#l6.116"></a><span id="l6.116"> }</span>
<a href="#l6.117"></a><span id="l6.117"> </span>
<a href="#l6.118"></a><span id="l6.118" class="difflineminus">-var directoryServerObserver = {</span>
<a href="#l6.119"></a><span id="l6.119" class="difflineminus">-  observe: function(subject, topic, value) {</span>
<a href="#l6.120"></a><span id="l6.120" class="difflineminus">-      try {</span>
<a href="#l6.121"></a><span id="l6.121" class="difflineminus">-          setupLdapAutocompleteSession();</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineminus">-      } catch (ex) {</span>
<a href="#l6.123"></a><span id="l6.123" class="difflineminus">-          // catch the exception and ignore it, so that if LDAP setup</span>
<a href="#l6.124"></a><span id="l6.124" class="difflineminus">-          // fails, the entire compose window doesn't get horked</span>
<a href="#l6.125"></a><span id="l6.125" class="difflineminus">-      }</span>
<a href="#l6.126"></a><span id="l6.126" class="difflineminus">-  }</span>
<a href="#l6.127"></a><span id="l6.127" class="difflineminus">-}</span>
<a href="#l6.128"></a><span id="l6.128" class="difflineminus">-</span>
<a href="#l6.129"></a><span id="l6.129" class="difflineminus">-function AddDirectoryServerObserver(flag) {</span>
<a href="#l6.130"></a><span id="l6.130" class="difflineminus">-  if (flag) {</span>
<a href="#l6.131"></a><span id="l6.131" class="difflineminus">-    Services.prefs.addObserver(&quot;ldap_2.autoComplete.useDirectory&quot;,</span>
<a href="#l6.132"></a><span id="l6.132" class="difflineminus">-                               directoryServerObserver, false);</span>
<a href="#l6.133"></a><span id="l6.133" class="difflineminus">-    Services.prefs.addObserver(&quot;ldap_2.autoComplete.directoryServer&quot;,</span>
<a href="#l6.134"></a><span id="l6.134" class="difflineminus">-                               directoryServerObserver, false);</span>
<a href="#l6.135"></a><span id="l6.135" class="difflineminus">-  }</span>
<a href="#l6.136"></a><span id="l6.136" class="difflineminus">-  else</span>
<a href="#l6.137"></a><span id="l6.137" class="difflineminus">-  {</span>
<a href="#l6.138"></a><span id="l6.138" class="difflineminus">-    var prefstring = &quot;mail.identity.&quot; + gCurrentIdentity.key + &quot;.overrideGlobal_Pref&quot;;</span>
<a href="#l6.139"></a><span id="l6.139" class="difflineminus">-    Services.prefs.addObserver(prefstring, directoryServerObserver, false);</span>
<a href="#l6.140"></a><span id="l6.140" class="difflineminus">-    prefstring = &quot;mail.identity.&quot; + gCurrentIdentity.key + &quot;.directoryServer&quot;;</span>
<a href="#l6.141"></a><span id="l6.141" class="difflineminus">-    Services.prefs.addObserver(prefstring, directoryServerObserver, false);</span>
<a href="#l6.142"></a><span id="l6.142" class="difflineminus">-  }</span>
<a href="#l6.143"></a><span id="l6.143" class="difflineminus">-}</span>
<a href="#l6.144"></a><span id="l6.144" class="difflineminus">-</span>
<a href="#l6.145"></a><span id="l6.145" class="difflineminus">-function RemoveDirectoryServerObserver(prefstring)</span>
<a href="#l6.146"></a><span id="l6.146" class="difflineminus">-{</span>
<a href="#l6.147"></a><span id="l6.147" class="difflineminus">-  if (!prefstring) {</span>
<a href="#l6.148"></a><span id="l6.148" class="difflineminus">-    Services.prefs.removeObserver(&quot;ldap_2.autoComplete.useDirectory&quot;, directoryServerObserver);</span>
<a href="#l6.149"></a><span id="l6.149" class="difflineminus">-    Services.prefs.removeObserver(&quot;ldap_2.autoComplete.directoryServer&quot;, directoryServerObserver);</span>
<a href="#l6.150"></a><span id="l6.150" class="difflineminus">-  }</span>
<a href="#l6.151"></a><span id="l6.151" class="difflineminus">-  else</span>
<a href="#l6.152"></a><span id="l6.152" class="difflineminus">-  {</span>
<a href="#l6.153"></a><span id="l6.153" class="difflineminus">-    var str = prefstring + &quot;.overrideGlobal_Pref&quot;;</span>
<a href="#l6.154"></a><span id="l6.154" class="difflineminus">-    Services.prefs.removeObserver(str, directoryServerObserver);</span>
<a href="#l6.155"></a><span id="l6.155" class="difflineminus">-    str = prefstring + &quot;.directoryServer&quot;;</span>
<a href="#l6.156"></a><span id="l6.156" class="difflineminus">-    Services.prefs.removeObserver(str, directoryServerObserver);</span>
<a href="#l6.157"></a><span id="l6.157" class="difflineminus">-  }</span>
<a href="#l6.158"></a><span id="l6.158" class="difflineminus">-}</span>
<a href="#l6.159"></a><span id="l6.159" class="difflineminus">-</span>
<a href="#l6.160"></a><span id="l6.160" class="difflineminus">-function AddDirectorySettingsObserver()</span>
<a href="#l6.161"></a><span id="l6.161" class="difflineminus">-{</span>
<a href="#l6.162"></a><span id="l6.162" class="difflineminus">-  Services.prefs.addObserver(gCurrentAutocompleteDirectory, directoryServerObserver, false);</span>
<a href="#l6.163"></a><span id="l6.163" class="difflineminus">-}</span>
<a href="#l6.164"></a><span id="l6.164" class="difflineminus">-</span>
<a href="#l6.165"></a><span id="l6.165" class="difflineminus">-function RemoveDirectorySettingsObserver(prefstring)</span>
<a href="#l6.166"></a><span id="l6.166" class="difflineminus">-{</span>
<a href="#l6.167"></a><span id="l6.167" class="difflineminus">-  Services.prefs.removeObserver(prefstring, directoryServerObserver);</span>
<a href="#l6.168"></a><span id="l6.168" class="difflineminus">-}</span>
<a href="#l6.169"></a><span id="l6.169" class="difflineminus">-</span>
<a href="#l6.170"></a><span id="l6.170" class="difflineminus">-function setupLdapAutocompleteSession()</span>
<a href="#l6.171"></a><span id="l6.171" class="difflineminus">-{</span>
<a href="#l6.172"></a><span id="l6.172" class="difflineminus">-    var autocompleteDirectory = null;</span>
<a href="#l6.173"></a><span id="l6.173" class="difflineminus">-    var prevAutocompleteDirectory = gCurrentAutocompleteDirectory;</span>
<a href="#l6.174"></a><span id="l6.174" class="difflineminus">-</span>
<a href="#l6.175"></a><span id="l6.175" class="difflineminus">-    if (Services.prefs.getBoolPref(&quot;ldap_2.autoComplete.useDirectory&quot;))</span>
<a href="#l6.176"></a><span id="l6.176" class="difflineminus">-        autocompleteDirectory = Services.prefs.getCharPref(</span>
<a href="#l6.177"></a><span id="l6.177" class="difflineminus">-            &quot;ldap_2.autoComplete.directoryServer&quot;);</span>
<a href="#l6.178"></a><span id="l6.178" class="difflineminus">-</span>
<a href="#l6.179"></a><span id="l6.179" class="difflineminus">-    if(gCurrentIdentity.overrideGlobalPref) {</span>
<a href="#l6.180"></a><span id="l6.180" class="difflineminus">-        autocompleteDirectory = gCurrentIdentity.directoryServer;</span>
<a href="#l6.181"></a><span id="l6.181" class="difflineminus">-    }</span>
<a href="#l6.182"></a><span id="l6.182" class="difflineminus">-</span>
<a href="#l6.183"></a><span id="l6.183" class="difflineminus">-    // use a temporary to do the setup so that we don't overwrite the</span>
<a href="#l6.184"></a><span id="l6.184" class="difflineminus">-    // global, then have some problem and throw an exception, and leave the</span>
<a href="#l6.185"></a><span id="l6.185" class="difflineminus">-    // global with a partially setup session.  we'll assign the temp</span>
<a href="#l6.186"></a><span id="l6.186" class="difflineminus">-    // into the global after we're done setting up the session</span>
<a href="#l6.187"></a><span id="l6.187" class="difflineminus">-    //</span>
<a href="#l6.188"></a><span id="l6.188" class="difflineminus">-    var LDAPSession;</span>
<a href="#l6.189"></a><span id="l6.189" class="difflineminus">-    if (gLDAPSession) {</span>
<a href="#l6.190"></a><span id="l6.190" class="difflineminus">-        LDAPSession = gLDAPSession;</span>
<a href="#l6.191"></a><span id="l6.191" class="difflineminus">-    } else {</span>
<a href="#l6.192"></a><span id="l6.192" class="difflineminus">-        LDAPSession = Components</span>
<a href="#l6.193"></a><span id="l6.193" class="difflineminus">-            .classes[&quot;@mozilla.org/autocompleteSession;1?type=ldap&quot;];</span>
<a href="#l6.194"></a><span id="l6.194" class="difflineminus">-        if (LDAPSession) {</span>
<a href="#l6.195"></a><span id="l6.195" class="difflineminus">-          try {</span>
<a href="#l6.196"></a><span id="l6.196" class="difflineminus">-            LDAPSession = LDAPSession.createInstance()</span>
<a href="#l6.197"></a><span id="l6.197" class="difflineminus">-                .QueryInterface(Components.interfaces.nsILDAPAutoCompleteSession);</span>
<a href="#l6.198"></a><span id="l6.198" class="difflineminus">-          } catch (ex) {dump (&quot;ERROR: Cannot get the LDAP autocomplete session\n&quot; + ex + &quot;\n&quot;);}</span>
<a href="#l6.199"></a><span id="l6.199" class="difflineminus">-        }</span>
<a href="#l6.200"></a><span id="l6.200" class="difflineminus">-    }</span>
<a href="#l6.201"></a><span id="l6.201" class="difflineminus">-</span>
<a href="#l6.202"></a><span id="l6.202" class="difflineminus">-    if (autocompleteDirectory &amp;&amp; !Services.io.offline) {</span>
<a href="#l6.203"></a><span id="l6.203" class="difflineminus">-        // Add observer on the directory server we are autocompleting against</span>
<a href="#l6.204"></a><span id="l6.204" class="difflineminus">-        // only if current server is different from previous.</span>
<a href="#l6.205"></a><span id="l6.205" class="difflineminus">-        // Remove observer if current server is different from previous</span>
<a href="#l6.206"></a><span id="l6.206" class="difflineminus">-        gCurrentAutocompleteDirectory = autocompleteDirectory;</span>
<a href="#l6.207"></a><span id="l6.207" class="difflineminus">-        if (prevAutocompleteDirectory) {</span>
<a href="#l6.208"></a><span id="l6.208" class="difflineminus">-          if (prevAutocompleteDirectory != gCurrentAutocompleteDirectory) {</span>
<a href="#l6.209"></a><span id="l6.209" class="difflineminus">-            RemoveDirectorySettingsObserver(prevAutocompleteDirectory);</span>
<a href="#l6.210"></a><span id="l6.210" class="difflineminus">-            AddDirectorySettingsObserver();</span>
<a href="#l6.211"></a><span id="l6.211" class="difflineminus">-          }</span>
<a href="#l6.212"></a><span id="l6.212" class="difflineminus">-        }</span>
<a href="#l6.213"></a><span id="l6.213" class="difflineminus">-        else</span>
<a href="#l6.214"></a><span id="l6.214" class="difflineminus">-          AddDirectorySettingsObserver();</span>
<a href="#l6.215"></a><span id="l6.215" class="difflineminus">-</span>
<a href="#l6.216"></a><span id="l6.216" class="difflineminus">-        // fill in the session params if there is a session</span>
<a href="#l6.217"></a><span id="l6.217" class="difflineminus">-        //</span>
<a href="#l6.218"></a><span id="l6.218" class="difflineminus">-        if (LDAPSession) {</span>
<a href="#l6.219"></a><span id="l6.219" class="difflineminus">-            let url = Services.prefs.getComplexValue(autocompleteDirectory +&quot;.uri&quot;,</span>
<a href="#l6.220"></a><span id="l6.220" class="difflineminus">-              Components.interfaces.nsISupportsString).data;</span>
<a href="#l6.221"></a><span id="l6.221" class="difflineminus">-</span>
<a href="#l6.222"></a><span id="l6.222" class="difflineminus">-            LDAPSession.serverURL =</span>
<a href="#l6.223"></a><span id="l6.223" class="difflineminus">-              Services.io.newURI(url, null, null)</span>
<a href="#l6.224"></a><span id="l6.224" class="difflineminus">-                         .QueryInterface(Components.interfaces.nsILDAPURL);</span>
<a href="#l6.225"></a><span id="l6.225" class="difflineminus">-</span>
<a href="#l6.226"></a><span id="l6.226" class="difflineminus">-            // get the login to authenticate as, if there is one</span>
<a href="#l6.227"></a><span id="l6.227" class="difflineminus">-            //</span>
<a href="#l6.228"></a><span id="l6.228" class="difflineminus">-            try {</span>
<a href="#l6.229"></a><span id="l6.229" class="difflineminus">-                LDAPSession.login = Services.prefs.getComplexValue(</span>
<a href="#l6.230"></a><span id="l6.230" class="difflineminus">-                    autocompleteDirectory + &quot;.auth.dn&quot;,</span>
<a href="#l6.231"></a><span id="l6.231" class="difflineminus">-                    Components.interfaces.nsISupportsString).data;</span>
<a href="#l6.232"></a><span id="l6.232" class="difflineminus">-            } catch (ex) {</span>
<a href="#l6.233"></a><span id="l6.233" class="difflineminus">-                // if we don't have this pref, no big deal</span>
<a href="#l6.234"></a><span id="l6.234" class="difflineminus">-            }</span>
<a href="#l6.235"></a><span id="l6.235" class="difflineminus">-            </span>
<a href="#l6.236"></a><span id="l6.236" class="difflineminus">-            try {</span>
<a href="#l6.237"></a><span id="l6.237" class="difflineminus">-                LDAPSession.saslMechanism = Services.prefs.getComplexValue(</span>
<a href="#l6.238"></a><span id="l6.238" class="difflineminus">-                    autocompleteDirectory + &quot;.auth.saslmech&quot;,</span>
<a href="#l6.239"></a><span id="l6.239" class="difflineminus">-                    Components.interfaces.nsISupportsString).data;</span>
<a href="#l6.240"></a><span id="l6.240" class="difflineminus">-            } catch (ex) {</span>
<a href="#l6.241"></a><span id="l6.241" class="difflineminus">-                // don't care if we don't have this pref</span>
<a href="#l6.242"></a><span id="l6.242" class="difflineminus">-            } </span>
<a href="#l6.243"></a><span id="l6.243" class="difflineminus">-</span>
<a href="#l6.244"></a><span id="l6.244" class="difflineminus">-            // set the LDAP protocol version correctly</span>
<a href="#l6.245"></a><span id="l6.245" class="difflineminus">-            var protocolVersion;</span>
<a href="#l6.246"></a><span id="l6.246" class="difflineminus">-            try {</span>
<a href="#l6.247"></a><span id="l6.247" class="difflineminus">-                protocolVersion = Services.prefs.getCharPref(autocompleteDirectory +</span>
<a href="#l6.248"></a><span id="l6.248" class="difflineminus">-                                                             &quot;.protocolVersion&quot;);</span>
<a href="#l6.249"></a><span id="l6.249" class="difflineminus">-            } catch (ex) {</span>
<a href="#l6.250"></a><span id="l6.250" class="difflineminus">-                // if we don't have this pref, no big deal</span>
<a href="#l6.251"></a><span id="l6.251" class="difflineminus">-            }</span>
<a href="#l6.252"></a><span id="l6.252" class="difflineminus">-            if (protocolVersion == &quot;2&quot;) {</span>
<a href="#l6.253"></a><span id="l6.253" class="difflineminus">-                LDAPSession.version =</span>
<a href="#l6.254"></a><span id="l6.254" class="difflineminus">-                    Components.interfaces.nsILDAPConnection.VERSION2;</span>
<a href="#l6.255"></a><span id="l6.255" class="difflineminus">-            }</span>
<a href="#l6.256"></a><span id="l6.256" class="difflineminus">-</span>
<a href="#l6.257"></a><span id="l6.257" class="difflineminus">-            // don't search on non-CJK strings shorter than this</span>
<a href="#l6.258"></a><span id="l6.258" class="difflineminus">-            //</span>
<a href="#l6.259"></a><span id="l6.259" class="difflineminus">-            try {</span>
<a href="#l6.260"></a><span id="l6.260" class="difflineminus">-                LDAPSession.minStringLength = Services.prefs.getIntPref(</span>
<a href="#l6.261"></a><span id="l6.261" class="difflineminus">-                    autocompleteDirectory + &quot;.autoComplete.minStringLength&quot;);</span>
<a href="#l6.262"></a><span id="l6.262" class="difflineminus">-            } catch (ex) {</span>
<a href="#l6.263"></a><span id="l6.263" class="difflineminus">-                // if this pref isn't there, no big deal.  just let</span>
<a href="#l6.264"></a><span id="l6.264" class="difflineminus">-                // nsLDAPAutoCompleteSession use its default.</span>
<a href="#l6.265"></a><span id="l6.265" class="difflineminus">-            }</span>
<a href="#l6.266"></a><span id="l6.266" class="difflineminus">-</span>
<a href="#l6.267"></a><span id="l6.267" class="difflineminus">-            // don't search on CJK strings shorter than this</span>
<a href="#l6.268"></a><span id="l6.268" class="difflineminus">-            //</span>
<a href="#l6.269"></a><span id="l6.269" class="difflineminus">-            try {</span>
<a href="#l6.270"></a><span id="l6.270" class="difflineminus">-                LDAPSession.cjkMinStringLength = Services.prefs.getIntPref(</span>
<a href="#l6.271"></a><span id="l6.271" class="difflineminus">-                  autocompleteDirectory + &quot;.autoComplete.cjkMinStringLength&quot;);</span>
<a href="#l6.272"></a><span id="l6.272" class="difflineminus">-            } catch (ex) {</span>
<a href="#l6.273"></a><span id="l6.273" class="difflineminus">-                // if this pref isn't there, no big deal.  just let</span>
<a href="#l6.274"></a><span id="l6.274" class="difflineminus">-                // nsLDAPAutoCompleteSession use its default.</span>
<a href="#l6.275"></a><span id="l6.275" class="difflineminus">-            }</span>
<a href="#l6.276"></a><span id="l6.276" class="difflineminus">-</span>
<a href="#l6.277"></a><span id="l6.277" class="difflineminus">-            // we don't try/catch here, because if this fails, we're outta luck</span>
<a href="#l6.278"></a><span id="l6.278" class="difflineminus">-            //</span>
<a href="#l6.279"></a><span id="l6.279" class="difflineminus">-            var ldapFormatter = Components.classes[</span>
<a href="#l6.280"></a><span id="l6.280" class="difflineminus">-                &quot;@mozilla.org/ldap-autocomplete-formatter;1?type=addrbook&quot;]</span>
<a href="#l6.281"></a><span id="l6.281" class="difflineminus">-                .createInstance().QueryInterface(</span>
<a href="#l6.282"></a><span id="l6.282" class="difflineminus">-                    Components.interfaces.nsIAbLDAPAutoCompFormatter);</span>
<a href="#l6.283"></a><span id="l6.283" class="difflineminus">-</span>
<a href="#l6.284"></a><span id="l6.284" class="difflineminus">-            // override autocomplete name format?</span>
<a href="#l6.285"></a><span id="l6.285" class="difflineminus">-            //</span>
<a href="#l6.286"></a><span id="l6.286" class="difflineminus">-            try {</span>
<a href="#l6.287"></a><span id="l6.287" class="difflineminus">-                ldapFormatter.nameFormat =</span>
<a href="#l6.288"></a><span id="l6.288" class="difflineminus">-                    Services.prefs.getComplexValue(autocompleteDirectory +</span>
<a href="#l6.289"></a><span id="l6.289" class="difflineminus">-                                                   &quot;.autoComplete.nameFormat&quot;,</span>
<a href="#l6.290"></a><span id="l6.290" class="difflineminus">-                                                   Components.interfaces.nsISupportsString).data;</span>
<a href="#l6.291"></a><span id="l6.291" class="difflineminus">-            } catch (ex) {</span>
<a href="#l6.292"></a><span id="l6.292" class="difflineminus">-                // if this pref isn't there, no big deal.  just let</span>
<a href="#l6.293"></a><span id="l6.293" class="difflineminus">-                // nsAbLDAPAutoCompFormatter use its default.</span>
<a href="#l6.294"></a><span id="l6.294" class="difflineminus">-            }</span>
<a href="#l6.295"></a><span id="l6.295" class="difflineminus">-</span>
<a href="#l6.296"></a><span id="l6.296" class="difflineminus">-            // override autocomplete mail address format?</span>
<a href="#l6.297"></a><span id="l6.297" class="difflineminus">-            //</span>
<a href="#l6.298"></a><span id="l6.298" class="difflineminus">-            try {</span>
<a href="#l6.299"></a><span id="l6.299" class="difflineminus">-                ldapFormatter.addressFormat =</span>
<a href="#l6.300"></a><span id="l6.300" class="difflineminus">-                    Services.prefs.getComplexValue(autocompleteDirectory +</span>
<a href="#l6.301"></a><span id="l6.301" class="difflineminus">-                                                   &quot;.autoComplete.addressFormat&quot;,</span>
<a href="#l6.302"></a><span id="l6.302" class="difflineminus">-                                                   Components.interfaces.nsISupportsString).data;</span>
<a href="#l6.303"></a><span id="l6.303" class="difflineminus">-            } catch (ex) {</span>
<a href="#l6.304"></a><span id="l6.304" class="difflineminus">-                // if this pref isn't there, no big deal.  just let</span>
<a href="#l6.305"></a><span id="l6.305" class="difflineminus">-                // nsAbLDAPAutoCompFormatter use its default.</span>
<a href="#l6.306"></a><span id="l6.306" class="difflineminus">-            }</span>
<a href="#l6.307"></a><span id="l6.307" class="difflineminus">-</span>
<a href="#l6.308"></a><span id="l6.308" class="difflineminus">-            try {</span>
<a href="#l6.309"></a><span id="l6.309" class="difflineminus">-                // figure out what goes in the comment column, if anything</span>
<a href="#l6.310"></a><span id="l6.310" class="difflineminus">-                //</span>
<a href="#l6.311"></a><span id="l6.311" class="difflineminus">-                // 0 = none</span>
<a href="#l6.312"></a><span id="l6.312" class="difflineminus">-                // 1 = name of addressbook this card came from</span>
<a href="#l6.313"></a><span id="l6.313" class="difflineminus">-                // 2 = other per-addressbook format</span>
<a href="#l6.314"></a><span id="l6.314" class="difflineminus">-                //</span>
<a href="#l6.315"></a><span id="l6.315" class="difflineminus">-                var showComments = 0;</span>
<a href="#l6.316"></a><span id="l6.316" class="difflineminus">-</span>
<a href="#l6.317"></a><span id="l6.317" class="difflineminus">-                switch (Services.prefs.getIntPref(&quot;mail.autoComplete.commentColumn&quot;)) {</span>
<a href="#l6.318"></a><span id="l6.318" class="difflineminus">-</span>
<a href="#l6.319"></a><span id="l6.319" class="difflineminus">-                case 1:</span>
<a href="#l6.320"></a><span id="l6.320" class="difflineminus">-                    // use the name of this directory</span>
<a href="#l6.321"></a><span id="l6.321" class="difflineminus">-                    //</span>
<a href="#l6.322"></a><span id="l6.322" class="difflineminus">-                    ldapFormatter.commentFormat = Services.prefs.getComplexValue(</span>
<a href="#l6.323"></a><span id="l6.323" class="difflineminus">-                                autocompleteDirectory + &quot;.description&quot;,</span>
<a href="#l6.324"></a><span id="l6.324" class="difflineminus">-                                Components.interfaces.nsISupportsString).data;</span>
<a href="#l6.325"></a><span id="l6.325" class="difflineminus">-                    break;</span>
<a href="#l6.326"></a><span id="l6.326" class="difflineminus">-</span>
<a href="#l6.327"></a><span id="l6.327" class="difflineminus">-                case 2:</span>
<a href="#l6.328"></a><span id="l6.328" class="difflineminus">-                    // override ldap-specific autocomplete entry?</span>
<a href="#l6.329"></a><span id="l6.329" class="difflineminus">-                    //</span>
<a href="#l6.330"></a><span id="l6.330" class="difflineminus">-                    try {</span>
<a href="#l6.331"></a><span id="l6.331" class="difflineminus">-                        ldapFormatter.commentFormat =</span>
<a href="#l6.332"></a><span id="l6.332" class="difflineminus">-                            Services.prefs.getComplexValue(autocompleteDirectory +</span>
<a href="#l6.333"></a><span id="l6.333" class="difflineminus">-                                                           &quot;.autoComplete.commentFormat&quot;,</span>
<a href="#l6.334"></a><span id="l6.334" class="difflineminus">-                                                           Components.interfaces.nsISupportsString).data;</span>
<a href="#l6.335"></a><span id="l6.335" class="difflineminus">-                    } catch (innerException) {</span>
<a href="#l6.336"></a><span id="l6.336" class="difflineminus">-                        // if nothing has been specified, use the ldap</span>
<a href="#l6.337"></a><span id="l6.337" class="difflineminus">-                        // organization field</span>
<a href="#l6.338"></a><span id="l6.338" class="difflineminus">-                        ldapFormatter.commentFormat = &quot;[o]&quot;;</span>
<a href="#l6.339"></a><span id="l6.339" class="difflineminus">-                    }</span>
<a href="#l6.340"></a><span id="l6.340" class="difflineminus">-                    break;</span>
<a href="#l6.341"></a><span id="l6.341" class="difflineminus">-</span>
<a href="#l6.342"></a><span id="l6.342" class="difflineminus">-                case 0:</span>
<a href="#l6.343"></a><span id="l6.343" class="difflineminus">-                default:</span>
<a href="#l6.344"></a><span id="l6.344" class="difflineminus">-                    // do nothing</span>
<a href="#l6.345"></a><span id="l6.345" class="difflineminus">-                }</span>
<a href="#l6.346"></a><span id="l6.346" class="difflineminus">-            } catch (ex) {</span>
<a href="#l6.347"></a><span id="l6.347" class="difflineminus">-                // if something went wrong while setting up comments, try and</span>
<a href="#l6.348"></a><span id="l6.348" class="difflineminus">-                // proceed anyway</span>
<a href="#l6.349"></a><span id="l6.349" class="difflineminus">-            }</span>
<a href="#l6.350"></a><span id="l6.350" class="difflineminus">-</span>
<a href="#l6.351"></a><span id="l6.351" class="difflineminus">-            // set the session's formatter, which also happens to</span>
<a href="#l6.352"></a><span id="l6.352" class="difflineminus">-            // force a call to the formatter's getAttributes() method</span>
<a href="#l6.353"></a><span id="l6.353" class="difflineminus">-            // -- which is why this needs to happen after we've set the</span>
<a href="#l6.354"></a><span id="l6.354" class="difflineminus">-            // various formats</span>
<a href="#l6.355"></a><span id="l6.355" class="difflineminus">-            //</span>
<a href="#l6.356"></a><span id="l6.356" class="difflineminus">-            LDAPSession.formatter = ldapFormatter;</span>
<a href="#l6.357"></a><span id="l6.357" class="difflineminus">-</span>
<a href="#l6.358"></a><span id="l6.358" class="difflineminus">-            // override autocomplete entry formatting?</span>
<a href="#l6.359"></a><span id="l6.359" class="difflineminus">-            //</span>
<a href="#l6.360"></a><span id="l6.360" class="difflineminus">-            try {</span>
<a href="#l6.361"></a><span id="l6.361" class="difflineminus">-                LDAPSession.outputFormat =</span>
<a href="#l6.362"></a><span id="l6.362" class="difflineminus">-                    Services.prefs.getComplexValue(autocompleteDirectory +</span>
<a href="#l6.363"></a><span id="l6.363" class="difflineminus">-                                                   &quot;.autoComplete.outputFormat&quot;,</span>
<a href="#l6.364"></a><span id="l6.364" class="difflineminus">-                                                   Components.interfaces.nsISupportsString).data;</span>
<a href="#l6.365"></a><span id="l6.365" class="difflineminus">-</span>
<a href="#l6.366"></a><span id="l6.366" class="difflineminus">-            } catch (ex) {</span>
<a href="#l6.367"></a><span id="l6.367" class="difflineminus">-                // if this pref isn't there, no big deal.  just let</span>
<a href="#l6.368"></a><span id="l6.368" class="difflineminus">-                // nsLDAPAutoCompleteSession use its default.</span>
<a href="#l6.369"></a><span id="l6.369" class="difflineminus">-            }</span>
<a href="#l6.370"></a><span id="l6.370" class="difflineminus">-</span>
<a href="#l6.371"></a><span id="l6.371" class="difflineminus">-            // override default search filter template?</span>
<a href="#l6.372"></a><span id="l6.372" class="difflineminus">-            //</span>
<a href="#l6.373"></a><span id="l6.373" class="difflineminus">-            try {</span>
<a href="#l6.374"></a><span id="l6.374" class="difflineminus">-                LDAPSession.filterTemplate = Services.prefs.getComplexValue(</span>
<a href="#l6.375"></a><span id="l6.375" class="difflineminus">-                    autocompleteDirectory + &quot;.autoComplete.filterTemplate&quot;,</span>
<a href="#l6.376"></a><span id="l6.376" class="difflineminus">-                    Components.interfaces.nsISupportsString).data;</span>
<a href="#l6.377"></a><span id="l6.377" class="difflineminus">-</span>
<a href="#l6.378"></a><span id="l6.378" class="difflineminus">-            } catch (ex) {</span>
<a href="#l6.379"></a><span id="l6.379" class="difflineminus">-                // if this pref isn't there, no big deal.  just let</span>
<a href="#l6.380"></a><span id="l6.380" class="difflineminus">-                // nsLDAPAutoCompleteSession use its default</span>
<a href="#l6.381"></a><span id="l6.381" class="difflineminus">-            }</span>
<a href="#l6.382"></a><span id="l6.382" class="difflineminus">-</span>
<a href="#l6.383"></a><span id="l6.383" class="difflineminus">-            // override default maxHits (currently 100)</span>
<a href="#l6.384"></a><span id="l6.384" class="difflineminus">-            //</span>
<a href="#l6.385"></a><span id="l6.385" class="difflineminus">-            try {</span>
<a href="#l6.386"></a><span id="l6.386" class="difflineminus">-                // XXXdmose should really use .autocomplete.maxHits,</span>
<a href="#l6.387"></a><span id="l6.387" class="difflineminus">-                // but there's no UI for that yet</span>
<a href="#l6.388"></a><span id="l6.388" class="difflineminus">-                //</span>
<a href="#l6.389"></a><span id="l6.389" class="difflineminus">-                LDAPSession.maxHits =</span>
<a href="#l6.390"></a><span id="l6.390" class="difflineminus">-                    Services.prefs.getIntPref(autocompleteDirectory + &quot;.maxHits&quot;);</span>
<a href="#l6.391"></a><span id="l6.391" class="difflineminus">-            } catch (ex) {</span>
<a href="#l6.392"></a><span id="l6.392" class="difflineminus">-                // if this pref isn't there, or is out of range, no big deal.</span>
<a href="#l6.393"></a><span id="l6.393" class="difflineminus">-                // just let nsLDAPAutoCompleteSession use its default.</span>
<a href="#l6.394"></a><span id="l6.394" class="difflineminus">-            }</span>
<a href="#l6.395"></a><span id="l6.395" class="difflineminus">-</span>
<a href="#l6.396"></a><span id="l6.396" class="difflineminus">-            if (!gSessionAdded) {</span>
<a href="#l6.397"></a><span id="l6.397" class="difflineminus">-                // if we make it here, we know that session initialization has</span>
<a href="#l6.398"></a><span id="l6.398" class="difflineminus">-                // succeeded; add the session for all recipients, and</span>
<a href="#l6.399"></a><span id="l6.399" class="difflineminus">-                // remember that we've done so</span>
<a href="#l6.400"></a><span id="l6.400" class="difflineminus">-                let maxRecipients = awGetMaxRecipients();</span>
<a href="#l6.401"></a><span id="l6.401" class="difflineminus">-                for (let i = 1; i &lt;= maxRecipients; i++)</span>
<a href="#l6.402"></a><span id="l6.402" class="difflineminus">-                {</span>
<a href="#l6.403"></a><span id="l6.403" class="difflineminus">-                    let autoCompleteWidget = document.getElementById(&quot;addressCol2#&quot; + i);</span>
<a href="#l6.404"></a><span id="l6.404" class="difflineminus">-                    if (autoCompleteWidget)</span>
<a href="#l6.405"></a><span id="l6.405" class="difflineminus">-                    {</span>
<a href="#l6.406"></a><span id="l6.406" class="difflineminus">-                      autoCompleteWidget.addSession(LDAPSession);</span>
<a href="#l6.407"></a><span id="l6.407" class="difflineminus">-                      // ldap searches don't insert a default entry with the default domain appended to it</span>
<a href="#l6.408"></a><span id="l6.408" class="difflineminus">-                      // so reduce the minimum results for a popup to 2 in this case.</span>
<a href="#l6.409"></a><span id="l6.409" class="difflineminus">-                      autoCompleteWidget.minResultsForPopup = 2;</span>
<a href="#l6.410"></a><span id="l6.410" class="difflineminus">-</span>
<a href="#l6.411"></a><span id="l6.411" class="difflineminus">-                    }</span>
<a href="#l6.412"></a><span id="l6.412" class="difflineminus">-                 }</span>
<a href="#l6.413"></a><span id="l6.413" class="difflineminus">-                gSessionAdded = true;</span>
<a href="#l6.414"></a><span id="l6.414" class="difflineminus">-            }</span>
<a href="#l6.415"></a><span id="l6.415" class="difflineminus">-        }</span>
<a href="#l6.416"></a><span id="l6.416" class="difflineminus">-    } else {</span>
<a href="#l6.417"></a><span id="l6.417" class="difflineminus">-      if (gCurrentAutocompleteDirectory) {</span>
<a href="#l6.418"></a><span id="l6.418" class="difflineminus">-        // Remove observer on the directory server since we are not doing Ldap</span>
<a href="#l6.419"></a><span id="l6.419" class="difflineminus">-        // autocompletion.</span>
<a href="#l6.420"></a><span id="l6.420" class="difflineminus">-        RemoveDirectorySettingsObserver(gCurrentAutocompleteDirectory);</span>
<a href="#l6.421"></a><span id="l6.421" class="difflineminus">-        gCurrentAutocompleteDirectory = null;</span>
<a href="#l6.422"></a><span id="l6.422" class="difflineminus">-      }</span>
<a href="#l6.423"></a><span id="l6.423" class="difflineminus">-      if (gLDAPSession &amp;&amp; gSessionAdded) {</span>
<a href="#l6.424"></a><span id="l6.424" class="difflineminus">-        let maxRecipients = awGetMaxRecipients();</span>
<a href="#l6.425"></a><span id="l6.425" class="difflineminus">-        for (let i = 1; i &lt;= maxRecipients; i++)</span>
<a href="#l6.426"></a><span id="l6.426" class="difflineminus">-          document.getElementById(&quot;addressCol2#&quot; + i)</span>
<a href="#l6.427"></a><span id="l6.427" class="difflineminus">-                  .removeSession(gLDAPSession);</span>
<a href="#l6.428"></a><span id="l6.428" class="difflineminus">-        gSessionAdded = false;</span>
<a href="#l6.429"></a><span id="l6.429" class="difflineminus">-      }</span>
<a href="#l6.430"></a><span id="l6.430" class="difflineminus">-    }</span>
<a href="#l6.431"></a><span id="l6.431" class="difflineminus">-</span>
<a href="#l6.432"></a><span id="l6.432" class="difflineminus">-    gLDAPSession = LDAPSession;</span>
<a href="#l6.433"></a><span id="l6.433" class="difflineminus">-    gSetupLdapAutocomplete = true;</span>
<a href="#l6.434"></a><span id="l6.434" class="difflineminus">-}</span>
<a href="#l6.435"></a><span id="l6.435" class="difflineminus">-</span>
<a href="#l6.436"></a><span id="l6.436"> function DoCommandClose()</span>
<a href="#l6.437"></a><span id="l6.437"> {</span>
<a href="#l6.438"></a><span id="l6.438">   if (ComposeCanClose()) {</span>
<a href="#l6.439"></a><span id="l6.439">     // Notify the SendListener that Send has been aborted and Stopped</span>
<a href="#l6.440"></a><span id="l6.440">     if (gMsgCompose)</span>
<a href="#l6.441"></a><span id="l6.441">       gMsgCompose.onSendNotPerformed(null, Components.results.NS_ERROR_ABORT);</span>
<a href="#l6.442"></a><span id="l6.442"> </span>
<a href="#l6.443"></a><span id="l6.443">     // note: if we're not caching this window, this destroys it for us</span>
<a href="#l6.444"></a><span id="l6.444" class="difflineat">@@ -1474,17 +1135,16 @@ function ComposeLoad()</span>
<a href="#l6.445"></a><span id="l6.445"> </span>
<a href="#l6.446"></a><span id="l6.446">   var otherHeaders = getPref(&quot;mail.compose.other.header&quot;);</span>
<a href="#l6.447"></a><span id="l6.447"> </span>
<a href="#l6.448"></a><span id="l6.448">   sRDF = Components.classes['@mozilla.org/rdf/rdf-service;1']</span>
<a href="#l6.449"></a><span id="l6.449">                    .getService(Components.interfaces.nsIRDFService);</span>
<a href="#l6.450"></a><span id="l6.450">   sNameProperty = sRDF.GetResource(&quot;http://home.netscape.com/NC-rdf#Name?sort=true&quot;);</span>
<a href="#l6.451"></a><span id="l6.451"> </span>
<a href="#l6.452"></a><span id="l6.452">   AddMessageComposeOfflineQuitObserver();</span>
<a href="#l6.453"></a><span id="l6.453" class="difflineminus">-  AddDirectoryServerObserver(true);</span>
<a href="#l6.454"></a><span id="l6.454"> </span>
<a href="#l6.455"></a><span id="l6.455">   if (gLogComposePerformance)</span>
<a href="#l6.456"></a><span id="l6.456">     sMsgComposeService.TimeStamp(&quot;Start initializing the compose window (ComposeLoad)&quot;, false);</span>
<a href="#l6.457"></a><span id="l6.457"> </span>
<a href="#l6.458"></a><span id="l6.458">   try {</span>
<a href="#l6.459"></a><span id="l6.459">     SetupCommandUpdateHandlers();</span>
<a href="#l6.460"></a><span id="l6.460">     // This will do migration, or create a new account if we need to.</span>
<a href="#l6.461"></a><span id="l6.461">     // We also want to open the account wizard if no identities are found</span>
<a href="#l6.462"></a><span id="l6.462" class="difflineat">@@ -1523,22 +1183,17 @@ function ComposeUnload()</span>
<a href="#l6.463"></a><span id="l6.463">   UnloadCommandUpdateHandlers();</span>
<a href="#l6.464"></a><span id="l6.464"> </span>
<a href="#l6.465"></a><span id="l6.465">   // Stop InlineSpellCheckerUI so personal dictionary is saved</span>
<a href="#l6.466"></a><span id="l6.466">   EnableInlineSpellCheck(false);</span>
<a href="#l6.467"></a><span id="l6.467"> </span>
<a href="#l6.468"></a><span id="l6.468">   EditorCleanup();</span>
<a href="#l6.469"></a><span id="l6.469"> </span>
<a href="#l6.470"></a><span id="l6.470">   RemoveMessageComposeOfflineQuitObserver();</span>
<a href="#l6.471"></a><span id="l6.471" class="difflineminus">-  RemoveDirectoryServerObserver(null);</span>
<a href="#l6.472"></a><span id="l6.472" class="difflineminus">-</span>
<a href="#l6.473"></a><span id="l6.473" class="difflineminus">-  if (gCurrentIdentity)</span>
<a href="#l6.474"></a><span id="l6.474" class="difflineminus">-    RemoveDirectoryServerObserver(&quot;mail.identity.&quot; + gCurrentIdentity.key);</span>
<a href="#l6.475"></a><span id="l6.475" class="difflineminus">-  if (gCurrentAutocompleteDirectory)</span>
<a href="#l6.476"></a><span id="l6.476" class="difflineminus">-    RemoveDirectorySettingsObserver(gCurrentAutocompleteDirectory);</span>
<a href="#l6.477"></a><span id="l6.477" class="difflineplus">+</span>
<a href="#l6.478"></a><span id="l6.478">   if (gMsgCompose)</span>
<a href="#l6.479"></a><span id="l6.479">     gMsgCompose.UnregisterStateListener(stateListener);</span>
<a href="#l6.480"></a><span id="l6.480">   if (gAutoSaveTimeout)</span>
<a href="#l6.481"></a><span id="l6.481">     clearTimeout(gAutoSaveTimeout);</span>
<a href="#l6.482"></a><span id="l6.482"> }</span>
<a href="#l6.483"></a><span id="l6.483"> </span>
<a href="#l6.484"></a><span id="l6.484"> function SetDocumentCharacterSet(aCharset)</span>
<a href="#l6.485"></a><span id="l6.485"> {</span>
<a href="#l6.486"></a><span id="l6.486" class="difflineat">@@ -2314,19 +1969,16 @@ function SetComposeWindowTitle()</span>
<a href="#l6.487"></a><span id="l6.487">   newTitle += GetCharsetUIString();</span>
<a href="#l6.488"></a><span id="l6.488">   document.title = sComposeMsgsBundle.getString(&quot;windowTitlePrefix&quot;) + &quot; &quot; + newTitle;</span>
<a href="#l6.489"></a><span id="l6.489"> }</span>
<a href="#l6.490"></a><span id="l6.490"> </span>
<a href="#l6.491"></a><span id="l6.491"> // Check for changes to document and allow saving before closing</span>
<a href="#l6.492"></a><span id="l6.492"> // This is hooked up to the OS's window close widget (e.g., &quot;X&quot; for Windows)</span>
<a href="#l6.493"></a><span id="l6.493"> function ComposeCanClose()</span>
<a href="#l6.494"></a><span id="l6.494"> {</span>
<a href="#l6.495"></a><span id="l6.495" class="difflineminus">-  // Do this early, so ldap sessions have a better chance to</span>
<a href="#l6.496"></a><span id="l6.496" class="difflineminus">-  // cleanup after themselves.</span>
<a href="#l6.497"></a><span id="l6.497" class="difflineminus">-  ReleaseAutoCompleteState();</span>
<a href="#l6.498"></a><span id="l6.498">   if (gSendOrSaveOperationInProgress)</span>
<a href="#l6.499"></a><span id="l6.499">   {</span>
<a href="#l6.500"></a><span id="l6.500">     var brandShortName = sBrandBundle.getString(&quot;brandShortName&quot;);</span>
<a href="#l6.501"></a><span id="l6.501"> </span>
<a href="#l6.502"></a><span id="l6.502">     var promptTitle = sComposeMsgsBundle.getString(&quot;quitComposeWindowTitle&quot;);</span>
<a href="#l6.503"></a><span id="l6.503">     var promptMsg = sComposeMsgsBundle.getFormattedString(&quot;quitComposeWindowMessage2&quot;,</span>
<a href="#l6.504"></a><span id="l6.504">                                                           [brandShortName], 1);</span>
<a href="#l6.505"></a><span id="l6.505">     var quitButtonLabel = sComposeMsgsBundle.getString(&quot;quitComposeWindowQuitButtonLabel2&quot;);</span>
<a href="#l6.506"></a><span id="l6.506" class="difflineat">@@ -2405,32 +2057,16 @@ function RemoveDraft()</span>
<a href="#l6.507"></a><span id="l6.507"> }</span>
<a href="#l6.508"></a><span id="l6.508"> </span>
<a href="#l6.509"></a><span id="l6.509"> function SetContentAndBodyAsUnmodified()</span>
<a href="#l6.510"></a><span id="l6.510"> {</span>
<a href="#l6.511"></a><span id="l6.511">   gMsgCompose.bodyModified = false;</span>
<a href="#l6.512"></a><span id="l6.512">   gContentChanged = false;</span>
<a href="#l6.513"></a><span id="l6.513"> }</span>
<a href="#l6.514"></a><span id="l6.514"> </span>
<a href="#l6.515"></a><span id="l6.515" class="difflineminus">-function ReleaseAutoCompleteState()</span>
<a href="#l6.516"></a><span id="l6.516" class="difflineminus">-{</span>
<a href="#l6.517"></a><span id="l6.517" class="difflineminus">-  let maxRecipients = awGetMaxRecipients();</span>
<a href="#l6.518"></a><span id="l6.518" class="difflineminus">-  for (let i = 1; i &lt;= maxRecipients; i++)</span>
<a href="#l6.519"></a><span id="l6.519" class="difflineminus">-    document.getElementById(&quot;addressCol2#&quot; + i).removeSession(gLDAPSession);</span>
<a href="#l6.520"></a><span id="l6.520" class="difflineminus">-</span>
<a href="#l6.521"></a><span id="l6.521" class="difflineminus">-  gSessionAdded = false;</span>
<a href="#l6.522"></a><span id="l6.522" class="difflineminus">-  gSetupLdapAutocomplete = false;</span>
<a href="#l6.523"></a><span id="l6.523" class="difflineminus">-  if (gLDAPSession) {</span>
<a href="#l6.524"></a><span id="l6.524" class="difflineminus">-    gLDAPSession = null;</span>
<a href="#l6.525"></a><span id="l6.525" class="difflineminus">-    // We're trying to force ldap sessions to get cleaned up as</span>
<a href="#l6.526"></a><span id="l6.526" class="difflineminus">-    // soon as possible so they don't hang on shutdown.</span>
<a href="#l6.527"></a><span id="l6.527" class="difflineminus">-    Components.utils.forceGC();</span>
<a href="#l6.528"></a><span id="l6.528" class="difflineminus">-  }</span>
<a href="#l6.529"></a><span id="l6.529" class="difflineminus">-}</span>
<a href="#l6.530"></a><span id="l6.530" class="difflineminus">-</span>
<a href="#l6.531"></a><span id="l6.531"> function MsgComposeCloseWindow(recycleIt)</span>
<a href="#l6.532"></a><span id="l6.532"> {</span>
<a href="#l6.533"></a><span id="l6.533">   if (gMsgCompose)</span>
<a href="#l6.534"></a><span id="l6.534">     gMsgCompose.CloseWindow(recycleIt);</span>
<a href="#l6.535"></a><span id="l6.535">   else</span>
<a href="#l6.536"></a><span id="l6.536">     window.close();</span>
<a href="#l6.537"></a><span id="l6.537"> }</span>
<a href="#l6.538"></a><span id="l6.538"> </span>
<a href="#l6.539"></a><span id="l6.539" class="difflineat">@@ -2811,18 +2447,16 @@ function LoadIdentity(startup)</span>
<a href="#l6.540"></a><span id="l6.540">         gCurrentIdentity = gAccountManager.getIdentity(idKey);</span>
<a href="#l6.541"></a><span id="l6.541"> </span>
<a href="#l6.542"></a><span id="l6.542">         let maxRecipients = awGetMaxRecipients();</span>
<a href="#l6.543"></a><span id="l6.543">         for (let i = 1; i &lt;= maxRecipients; i++)</span>
<a href="#l6.544"></a><span id="l6.544">           awGetInputElement(i).setAttribute(&quot;autocompletesearchparam&quot;, idKey);</span>
<a href="#l6.545"></a><span id="l6.545"> </span>
<a href="#l6.546"></a><span id="l6.546">         if (!startup &amp;&amp; prevIdentity &amp;&amp; idKey != prevIdentity.key)</span>
<a href="#l6.547"></a><span id="l6.547">         {</span>
<a href="#l6.548"></a><span id="l6.548" class="difflineminus">-          var prefstring = &quot;mail.identity.&quot; + prevIdentity.key;</span>
<a href="#l6.549"></a><span id="l6.549" class="difflineminus">-          RemoveDirectoryServerObserver(prefstring);</span>
<a href="#l6.550"></a><span id="l6.550">           var prevReplyTo = prevIdentity.replyTo;</span>
<a href="#l6.551"></a><span id="l6.551">           var prevCc = &quot;&quot;;</span>
<a href="#l6.552"></a><span id="l6.552">           var prevBcc = &quot;&quot;;</span>
<a href="#l6.553"></a><span id="l6.553">           var prevReceipt = prevIdentity.requestReturnReceipt;</span>
<a href="#l6.554"></a><span id="l6.554">           var prevDSN = prevIdentity.requestDSN;</span>
<a href="#l6.555"></a><span id="l6.555">           var prevAttachVCard = prevIdentity.attachVCard;</span>
<a href="#l6.556"></a><span id="l6.556"> </span>
<a href="#l6.557"></a><span id="l6.557">           if (prevIdentity.doCc)</span>
<a href="#l6.558"></a><span id="l6.558" class="difflineat">@@ -2905,28 +2539,20 @@ function LoadIdentity(startup)</span>
<a href="#l6.559"></a><span id="l6.559">             gMsgCompose.identity = gCurrentIdentity;</span>
<a href="#l6.560"></a><span id="l6.560">           } catch (ex) { dump(&quot;### Cannot change the identity: &quot; + ex + &quot;\n&quot;);}</span>
<a href="#l6.561"></a><span id="l6.561"> </span>
<a href="#l6.562"></a><span id="l6.562">           var event = document.createEvent('Events');</span>
<a href="#l6.563"></a><span id="l6.563">           event.initEvent('compose-from-changed', false, true);</span>
<a href="#l6.564"></a><span id="l6.564">           document.getElementById(&quot;msgcomposeWindow&quot;).dispatchEvent(event);</span>
<a href="#l6.565"></a><span id="l6.565">         }</span>
<a href="#l6.566"></a><span id="l6.566"> </span>
<a href="#l6.567"></a><span id="l6.567" class="difflineminus">-      AddDirectoryServerObserver(false);</span>
<a href="#l6.568"></a><span id="l6.568">       if (!startup) {</span>
<a href="#l6.569"></a><span id="l6.569">           if (getPref(&quot;mail.autoComplete.highlightNonMatches&quot;))</span>
<a href="#l6.570"></a><span id="l6.570">             document.getElementById('addressCol2#1').highlightNonMatches = true;</span>
<a href="#l6.571"></a><span id="l6.571"> </span>
<a href="#l6.572"></a><span id="l6.572" class="difflineminus">-          try {</span>
<a href="#l6.573"></a><span id="l6.573" class="difflineminus">-              setupLdapAutocompleteSession();</span>
<a href="#l6.574"></a><span id="l6.574" class="difflineminus">-          } catch (ex) {</span>
<a href="#l6.575"></a><span id="l6.575" class="difflineminus">-              // catch the exception and ignore it, so that if LDAP setup</span>
<a href="#l6.576"></a><span id="l6.576" class="difflineminus">-              // fails, the entire compose window doesn't end up horked</span>
<a href="#l6.577"></a><span id="l6.577" class="difflineminus">-          }</span>
<a href="#l6.578"></a><span id="l6.578" class="difflineminus">-</span>
<a href="#l6.579"></a><span id="l6.579">           // only do this if we aren't starting up....it gets done as part of startup already</span>
<a href="#l6.580"></a><span id="l6.580">           addRecipientsToIgnoreList(gCurrentIdentity.identityName);</span>
<a href="#l6.581"></a><span id="l6.581">       }</span>
<a href="#l6.582"></a><span id="l6.582">     }</span>
<a href="#l6.583"></a><span id="l6.583"> }</span>
<a href="#l6.584"></a><span id="l6.584"> </span>
<a href="#l6.585"></a><span id="l6.585"> function setupAutocomplete()</span>
<a href="#l6.586"></a><span id="l6.586"> {</span>
<a href="#l6.587"></a><span id="l6.587" class="difflineat">@@ -2945,24 +2571,16 @@ function setupAutocomplete()</span>
<a href="#l6.588"></a><span id="l6.588">         autoCompleteWidget.highlightNonMatches = true;</span>
<a href="#l6.589"></a><span id="l6.589"> </span>
<a href="#l6.590"></a><span id="l6.590">       if (getPref(&quot;mail.autoComplete.commentColumn&quot;))</span>
<a href="#l6.591"></a><span id="l6.591">         autoCompleteWidget.showCommentColumn = true;</span>
<a href="#l6.592"></a><span id="l6.592">   } catch (ex) {</span>
<a href="#l6.593"></a><span id="l6.593">       // if we can't get this pref, then don't show the columns (which is</span>
<a href="#l6.594"></a><span id="l6.594">       // what the XUL defaults to)</span>
<a href="#l6.595"></a><span id="l6.595">   }</span>
<a href="#l6.596"></a><span id="l6.596" class="difflineminus">-  if (!gSetupLdapAutocomplete) {</span>
<a href="#l6.597"></a><span id="l6.597" class="difflineminus">-      try {</span>
<a href="#l6.598"></a><span id="l6.598" class="difflineminus">-          setupLdapAutocompleteSession();</span>
<a href="#l6.599"></a><span id="l6.599" class="difflineminus">-      } catch (ex) {</span>
<a href="#l6.600"></a><span id="l6.600" class="difflineminus">-          // catch the exception and ignore it, so that if LDAP setup</span>
<a href="#l6.601"></a><span id="l6.601" class="difflineminus">-          // fails, the entire compose window doesn't end up horked</span>
<a href="#l6.602"></a><span id="l6.602" class="difflineminus">-      }</span>
<a href="#l6.603"></a><span id="l6.603" class="difflineminus">-  }</span>
<a href="#l6.604"></a><span id="l6.604"> }</span>
<a href="#l6.605"></a><span id="l6.605"> </span>
<a href="#l6.606"></a><span id="l6.606"> function subjectKeyPress(event)</span>
<a href="#l6.607"></a><span id="l6.607"> {</span>
<a href="#l6.608"></a><span id="l6.608">   switch(event.keyCode) {</span>
<a href="#l6.609"></a><span id="l6.609">   case KeyEvent.DOM_VK_TAB:</span>
<a href="#l6.610"></a><span id="l6.610">     if (!event.shiftKey &amp;&amp; !event.ctrlKey &amp;&amp; !event.altKey &amp;&amp; !event.metaKey) {</span>
<a href="#l6.611"></a><span id="l6.611">       SetMsgBodyFrameFocus();</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

