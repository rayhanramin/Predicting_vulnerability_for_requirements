<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 29184:fa5c346560d7e9b1ed341e9e2bf644ebde887889</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ fa5c346560d7e9b1ed341e9e2bf644ebde887889" />
<meta property="og:url" content="/comm-central/rev/fa5c346560d7e9b1ed341e9e2bf644ebde887889" />
<meta property="og:description" content="Bug 1627570 - Give tab info (instead of just tab ID) to API events. r=mkmelin" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / fa5c346560d7e9b1ed341e9e2bf644ebde887889 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/fa5c346560d7e9b1ed341e9e2bf644ebde887889">shortlog</a> |
<a href="/comm-central/log/fa5c346560d7e9b1ed341e9e2bf644ebde887889">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/fa5c346560d7e9b1ed341e9e2bf644ebde887889">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/fa5c346560d7e9b1ed341e9e2bf644ebde887889">files</a> |
changeset |
<a href="/comm-central/raw-rev/fa5c346560d7e9b1ed341e9e2bf644ebde887889">raw</a>  | <a href="/comm-central/archive/fa5c346560d7e9b1ed341e9e2bf644ebde887889.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1627570">Bug 1627570</a> - Give tab info (instead of just tab ID) to API events. r=mkmelin
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#71;&#101;&#111;&#102;&#102;&#32;&#76;&#97;&#110;&#107;&#111;&#119;&#32;&#60;&#103;&#101;&#111;&#102;&#102;&#64;&#100;&#97;&#114;&#107;&#116;&#114;&#111;&#106;&#97;&#110;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Sun, 05 Apr 2020 11:35:47 +1200</td></tr>

<tr>
 <td>changeset 29184</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/fa5c346560d7e9b1ed341e9e2bf644ebde887889">fa5c346560d7e9b1ed341e9e2bf644ebde887889</a></td>
</tr>



<tr>
<td>parent 29183</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/498f9468fd8b619c8230110fc23ced9ab55a8ce6">498f9468fd8b619c8230110fc23ced9ab55a8ce6</a>
</td>
</tr>

<tr>
<td>child 29185</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/f30adb6e9f15523a628bc773574a7f35ef5abfcd">f30adb6e9f15523a628bc773574a7f35ef5abfcd</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=fa5c346560d7e9b1ed341e9e2bf644ebde887889">17242</a></td></tr>
<tr><td>push user</td><td>geoff@darktrojan.net</td></tr>
<tr><td>push date</td><td class="date age">Mon, 06 Apr 2020 09:57:42 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@2232bbc48416 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=2232bbc484164c7b42f432b13eadee4989c8ee34">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=2232bbc484164c7b42f432b13eadee4989c8ee34&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=2232bbc484164c7b42f432b13eadee4989c8ee34&newProject=comm-central&newRevision=fa5c346560d7e9b1ed341e9e2bf644ebde887889&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=2232bbc484164c7b42f432b13eadee4989c8ee34&newProject=comm-central&newRevision=fa5c346560d7e9b1ed341e9e2bf644ebde887889&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=2232bbc484164c7b42f432b13eadee4989c8ee34&newProject=comm-central&newRevision=fa5c346560d7e9b1ed341e9e2bf644ebde887889&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mkmelin%29&revcount=50">mkmelin</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1627570">1627570</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1627570">Bug 1627570</a> - Give tab info (instead of just tab ID) to API events. r=mkmelin</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/fa5c346560d7e9b1ed341e9e2bf644ebde887889/mail/components/extensions/parent/ext-mailTabs.js">mail/components/extensions/parent/ext-mailTabs.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/fa5c346560d7e9b1ed341e9e2bf644ebde887889/mail/components/extensions/parent/ext-mailTabs.js">file</a> |
<a href="/comm-central/annotate/fa5c346560d7e9b1ed341e9e2bf644ebde887889/mail/components/extensions/parent/ext-mailTabs.js">annotate</a> |
<a href="/comm-central/diff/fa5c346560d7e9b1ed341e9e2bf644ebde887889/mail/components/extensions/parent/ext-mailTabs.js">diff</a> |
<a href="/comm-central/comparison/fa5c346560d7e9b1ed341e9e2bf644ebde887889/mail/components/extensions/parent/ext-mailTabs.js">comparison</a> |
<a href="/comm-central/log/fa5c346560d7e9b1ed341e9e2bf644ebde887889/mail/components/extensions/parent/ext-mailTabs.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/fa5c346560d7e9b1ed341e9e2bf644ebde887889/mail/components/extensions/parent/ext-messageDisplay.js">mail/components/extensions/parent/ext-messageDisplay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/fa5c346560d7e9b1ed341e9e2bf644ebde887889/mail/components/extensions/parent/ext-messageDisplay.js">file</a> |
<a href="/comm-central/annotate/fa5c346560d7e9b1ed341e9e2bf644ebde887889/mail/components/extensions/parent/ext-messageDisplay.js">annotate</a> |
<a href="/comm-central/diff/fa5c346560d7e9b1ed341e9e2bf644ebde887889/mail/components/extensions/parent/ext-messageDisplay.js">diff</a> |
<a href="/comm-central/comparison/fa5c346560d7e9b1ed341e9e2bf644ebde887889/mail/components/extensions/parent/ext-messageDisplay.js">comparison</a> |
<a href="/comm-central/log/fa5c346560d7e9b1ed341e9e2bf644ebde887889/mail/components/extensions/parent/ext-messageDisplay.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/fa5c346560d7e9b1ed341e9e2bf644ebde887889/mail/components/extensions/schemas/mailTabs.json">mail/components/extensions/schemas/mailTabs.json</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/fa5c346560d7e9b1ed341e9e2bf644ebde887889/mail/components/extensions/schemas/mailTabs.json">file</a> |
<a href="/comm-central/annotate/fa5c346560d7e9b1ed341e9e2bf644ebde887889/mail/components/extensions/schemas/mailTabs.json">annotate</a> |
<a href="/comm-central/diff/fa5c346560d7e9b1ed341e9e2bf644ebde887889/mail/components/extensions/schemas/mailTabs.json">diff</a> |
<a href="/comm-central/comparison/fa5c346560d7e9b1ed341e9e2bf644ebde887889/mail/components/extensions/schemas/mailTabs.json">comparison</a> |
<a href="/comm-central/log/fa5c346560d7e9b1ed341e9e2bf644ebde887889/mail/components/extensions/schemas/mailTabs.json">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/fa5c346560d7e9b1ed341e9e2bf644ebde887889/mail/components/extensions/schemas/messageDisplay.json">mail/components/extensions/schemas/messageDisplay.json</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/fa5c346560d7e9b1ed341e9e2bf644ebde887889/mail/components/extensions/schemas/messageDisplay.json">file</a> |
<a href="/comm-central/annotate/fa5c346560d7e9b1ed341e9e2bf644ebde887889/mail/components/extensions/schemas/messageDisplay.json">annotate</a> |
<a href="/comm-central/diff/fa5c346560d7e9b1ed341e9e2bf644ebde887889/mail/components/extensions/schemas/messageDisplay.json">diff</a> |
<a href="/comm-central/comparison/fa5c346560d7e9b1ed341e9e2bf644ebde887889/mail/components/extensions/schemas/messageDisplay.json">comparison</a> |
<a href="/comm-central/log/fa5c346560d7e9b1ed341e9e2bf644ebde887889/mail/components/extensions/schemas/messageDisplay.json">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/fa5c346560d7e9b1ed341e9e2bf644ebde887889/mail/components/extensions/test/browser/browser_ext_mailTabs.js">mail/components/extensions/test/browser/browser_ext_mailTabs.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/fa5c346560d7e9b1ed341e9e2bf644ebde887889/mail/components/extensions/test/browser/browser_ext_mailTabs.js">file</a> |
<a href="/comm-central/annotate/fa5c346560d7e9b1ed341e9e2bf644ebde887889/mail/components/extensions/test/browser/browser_ext_mailTabs.js">annotate</a> |
<a href="/comm-central/diff/fa5c346560d7e9b1ed341e9e2bf644ebde887889/mail/components/extensions/test/browser/browser_ext_mailTabs.js">diff</a> |
<a href="/comm-central/comparison/fa5c346560d7e9b1ed341e9e2bf644ebde887889/mail/components/extensions/test/browser/browser_ext_mailTabs.js">comparison</a> |
<a href="/comm-central/log/fa5c346560d7e9b1ed341e9e2bf644ebde887889/mail/components/extensions/test/browser/browser_ext_mailTabs.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/fa5c346560d7e9b1ed341e9e2bf644ebde887889/mail/components/extensions/test/browser/browser_ext_messageDisplay.js">mail/components/extensions/test/browser/browser_ext_messageDisplay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/fa5c346560d7e9b1ed341e9e2bf644ebde887889/mail/components/extensions/test/browser/browser_ext_messageDisplay.js">file</a> |
<a href="/comm-central/annotate/fa5c346560d7e9b1ed341e9e2bf644ebde887889/mail/components/extensions/test/browser/browser_ext_messageDisplay.js">annotate</a> |
<a href="/comm-central/diff/fa5c346560d7e9b1ed341e9e2bf644ebde887889/mail/components/extensions/test/browser/browser_ext_messageDisplay.js">diff</a> |
<a href="/comm-central/comparison/fa5c346560d7e9b1ed341e9e2bf644ebde887889/mail/components/extensions/test/browser/browser_ext_messageDisplay.js">comparison</a> |
<a href="/comm-central/log/fa5c346560d7e9b1ed341e9e2bf644ebde887889/mail/components/extensions/test/browser/browser_ext_messageDisplay.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/components/extensions/parent/ext-mailTabs.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/components/extensions/parent/ext-mailTabs.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -346,17 +346,17 @@ this.mailTabs = class extends ExtensionA</span>
<a href="#l1.4"></a><span id="l1.4">           // Inactive tabs are updated when they become active, except the search doesn't. :(</span>
<a href="#l1.5"></a><span id="l1.5">         },</span>
<a href="#l1.6"></a><span id="l1.6"> </span>
<a href="#l1.7"></a><span id="l1.7">         onDisplayedFolderChanged: new EventManager({</span>
<a href="#l1.8"></a><span id="l1.8">           context,</span>
<a href="#l1.9"></a><span id="l1.9">           name: &quot;mailTabs.onDisplayedFolderChanged&quot;,</span>
<a href="#l1.10"></a><span id="l1.10">           register: fire =&gt; {</span>
<a href="#l1.11"></a><span id="l1.11">             let listener = (event, tab, folder) =&gt; {</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-              fire.sync(tabTracker.getId(tab), convertFolder(folder));</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+              fire.sync(tabManager.convert(tab), convertFolder(folder));</span>
<a href="#l1.14"></a><span id="l1.14">             };</span>
<a href="#l1.15"></a><span id="l1.15"> </span>
<a href="#l1.16"></a><span id="l1.16">             uiListener.on(&quot;folder-changed&quot;, listener);</span>
<a href="#l1.17"></a><span id="l1.17">             uiListener.incrementListeners();</span>
<a href="#l1.18"></a><span id="l1.18">             return () =&gt; {</span>
<a href="#l1.19"></a><span id="l1.19">               uiListener.off(&quot;folder-changed&quot;, listener);</span>
<a href="#l1.20"></a><span id="l1.20">               uiListener.decrementListeners();</span>
<a href="#l1.21"></a><span id="l1.21">             };</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineat">@@ -364,17 +364,17 @@ this.mailTabs = class extends ExtensionA</span>
<a href="#l1.23"></a><span id="l1.23">         }).api(),</span>
<a href="#l1.24"></a><span id="l1.24"> </span>
<a href="#l1.25"></a><span id="l1.25">         onSelectedMessagesChanged: new EventManager({</span>
<a href="#l1.26"></a><span id="l1.26">           context,</span>
<a href="#l1.27"></a><span id="l1.27">           name: &quot;mailTabs.onSelectedMessagesChanged&quot;,</span>
<a href="#l1.28"></a><span id="l1.28">           register: fire =&gt; {</span>
<a href="#l1.29"></a><span id="l1.29">             let listener = (event, tab, messages) =&gt; {</span>
<a href="#l1.30"></a><span id="l1.30">               fire.sync(</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-                tabTracker.getId(tab),</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+                tabManager.convert(tab),</span>
<a href="#l1.33"></a><span id="l1.33">                 messageListTracker.startList(messages, extension)</span>
<a href="#l1.34"></a><span id="l1.34">               );</span>
<a href="#l1.35"></a><span id="l1.35">             };</span>
<a href="#l1.36"></a><span id="l1.36"> </span>
<a href="#l1.37"></a><span id="l1.37">             uiListener.on(&quot;messages-changed&quot;, listener);</span>
<a href="#l1.38"></a><span id="l1.38">             uiListener.incrementListeners();</span>
<a href="#l1.39"></a><span id="l1.39">             return () =&gt; {</span>
<a href="#l1.40"></a><span id="l1.40">               uiListener.off(&quot;messages-changed&quot;, listener);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/components/extensions/parent/ext-messageDisplay.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/components/extensions/parent/ext-messageDisplay.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -1,27 +1,27 @@</span>
<a href="#l2.4"></a><span id="l2.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l2.5"></a><span id="l2.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l2.6"></a><span id="l2.6">  * file, you can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l2.7"></a><span id="l2.7"> </span>
<a href="#l2.8"></a><span id="l2.8"> this.messageDisplay = class extends ExtensionAPI {</span>
<a href="#l2.9"></a><span id="l2.9">   getAPI(context) {</span>
<a href="#l2.10"></a><span id="l2.10">     let { extension } = context;</span>
<a href="#l2.11"></a><span id="l2.11" class="difflineminus">-    let { tabManager } = extension;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+    let { tabManager, windowManager } = extension;</span>
<a href="#l2.13"></a><span id="l2.13">     return {</span>
<a href="#l2.14"></a><span id="l2.14">       messageDisplay: {</span>
<a href="#l2.15"></a><span id="l2.15">         onMessageDisplayed: new EventManager({</span>
<a href="#l2.16"></a><span id="l2.16">           context,</span>
<a href="#l2.17"></a><span id="l2.17">           name: &quot;messageDisplay.onMessageDisplayed&quot;,</span>
<a href="#l2.18"></a><span id="l2.18">           register: fire =&gt; {</span>
<a href="#l2.19"></a><span id="l2.19">             let listener = {</span>
<a href="#l2.20"></a><span id="l2.20">               handleEvent(event) {</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineminus">-                let window = extension.windowManager.wrapWindow(event.target);</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineplus">+                let win = windowManager.wrapWindow(event.target);</span>
<a href="#l2.23"></a><span id="l2.23">                 fire.async(</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineminus">-                  window.activeTab.id,</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+                  tabManager.convert(win.activeTab.nativeTab),</span>
<a href="#l2.26"></a><span id="l2.26">                   convertMessage(event.detail, extension)</span>
<a href="#l2.27"></a><span id="l2.27">                 );</span>
<a href="#l2.28"></a><span id="l2.28">               },</span>
<a href="#l2.29"></a><span id="l2.29">             };</span>
<a href="#l2.30"></a><span id="l2.30"> </span>
<a href="#l2.31"></a><span id="l2.31">             windowTracker.addListener(&quot;MsgLoaded&quot;, listener);</span>
<a href="#l2.32"></a><span id="l2.32">             return () =&gt; {</span>
<a href="#l2.33"></a><span id="l2.33">               windowTracker.removeListener(&quot;MsgLoaded&quot;, listener);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/components/extensions/schemas/mailTabs.json</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/components/extensions/schemas/mailTabs.json</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -233,20 +233,38 @@</span>
<a href="#l3.4"></a><span id="l3.4">       }</span>
<a href="#l3.5"></a><span id="l3.5">     ],</span>
<a href="#l3.6"></a><span id="l3.6">     &quot;events&quot;: [</span>
<a href="#l3.7"></a><span id="l3.7">       {</span>
<a href="#l3.8"></a><span id="l3.8">         &quot;name&quot;: &quot;onDisplayedFolderChanged&quot;,</span>
<a href="#l3.9"></a><span id="l3.9">         &quot;type&quot;: &quot;function&quot;,</span>
<a href="#l3.10"></a><span id="l3.10">         &quot;description&quot;: &quot;Fired when the displayed folder changes in any mail tab.&quot;,</span>
<a href="#l3.11"></a><span id="l3.11">         &quot;permissions&quot;: [&quot;accountsRead&quot;],</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-        &quot;parameters&quot;: []</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+        &quot;parameters&quot;: [</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+          {</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+            &quot;name&quot;: &quot;tab&quot;,</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+            &quot;$ref&quot;: &quot;tabs.Tab&quot;</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+          },</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+          {</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+            &quot;name&quot;: &quot;displayedFolder&quot;,</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+            &quot;$ref&quot;: &quot;folders.MailFolder&quot;</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+          }</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+        ]</span>
<a href="#l3.23"></a><span id="l3.23">       },</span>
<a href="#l3.24"></a><span id="l3.24">       {</span>
<a href="#l3.25"></a><span id="l3.25">         &quot;name&quot;: &quot;onSelectedMessagesChanged&quot;,</span>
<a href="#l3.26"></a><span id="l3.26">         &quot;type&quot;: &quot;function&quot;,</span>
<a href="#l3.27"></a><span id="l3.27">         &quot;description&quot;: &quot;Fired when the selected messages change in any mail tab.&quot;,</span>
<a href="#l3.28"></a><span id="l3.28">         &quot;permissions&quot;: [&quot;messagesRead&quot;],</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineminus">-        &quot;parameters&quot;: []</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+        &quot;parameters&quot;: [</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+          {</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+            &quot;name&quot;: &quot;tab&quot;,</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+            &quot;$ref&quot;: &quot;tabs.Tab&quot;</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+          },</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+          {</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+            &quot;name&quot;: &quot;selectedMessages&quot;,</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+            &quot;$ref&quot;: &quot;messages.MessageList&quot;</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+          }</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+        ]</span>
<a href="#l3.40"></a><span id="l3.40">       }</span>
<a href="#l3.41"></a><span id="l3.41">     ]</span>
<a href="#l3.42"></a><span id="l3.42">   }</span>
<a href="#l3.43"></a><span id="l3.43"> ]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/components/extensions/schemas/messageDisplay.json</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/components/extensions/schemas/messageDisplay.json</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -6,18 +6,18 @@</span>
<a href="#l4.4"></a><span id="l4.4">     ],</span>
<a href="#l4.5"></a><span id="l4.5">     &quot;events&quot;: [</span>
<a href="#l4.6"></a><span id="l4.6">       {</span>
<a href="#l4.7"></a><span id="l4.7">         &quot;name&quot;: &quot;onMessageDisplayed&quot;,</span>
<a href="#l4.8"></a><span id="l4.8">         &quot;type&quot;: &quot;function&quot;,</span>
<a href="#l4.9"></a><span id="l4.9">         &quot;description&quot;: &quot;Fired when a message is displayed, whether in a 3-pane tab, a message tab, or a message window.&quot;,</span>
<a href="#l4.10"></a><span id="l4.10">         &quot;parameters&quot;: [</span>
<a href="#l4.11"></a><span id="l4.11">           {</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-            &quot;name&quot;: &quot;tabId&quot;,</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-            &quot;type&quot;: &quot;integer&quot;</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+            &quot;name&quot;: &quot;tab&quot;,</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+            &quot;$ref&quot;: &quot;tabs.Tab&quot;</span>
<a href="#l4.16"></a><span id="l4.16">           },</span>
<a href="#l4.17"></a><span id="l4.17">           {</span>
<a href="#l4.18"></a><span id="l4.18">             &quot;name&quot;: &quot;message&quot;,</span>
<a href="#l4.19"></a><span id="l4.19">             &quot;$ref&quot;: &quot;messages.MessageHeader&quot;</span>
<a href="#l4.20"></a><span id="l4.20">           }</span>
<a href="#l4.21"></a><span id="l4.21">         ]</span>
<a href="#l4.22"></a><span id="l4.22">       }</span>
<a href="#l4.23"></a><span id="l4.23">     ],</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/components/extensions/test/browser/browser_ext_mailTabs.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/components/extensions/test/browser/browser_ext_mailTabs.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -201,40 +201,40 @@ add_task(async function test_displayedFo</span>
<a href="#l5.4"></a><span id="l5.4">       currentWindow: true,</span>
<a href="#l5.5"></a><span id="l5.5">     });</span>
<a href="#l5.6"></a><span id="l5.6">     browser.test.assertEq(accountId, current.displayedFolder.accountId);</span>
<a href="#l5.7"></a><span id="l5.7">     browser.test.assertEq(&quot;/&quot;, current.displayedFolder.path);</span>
<a href="#l5.8"></a><span id="l5.8"> </span>
<a href="#l5.9"></a><span id="l5.9">     async function selectFolder(newFolderPath) {</span>
<a href="#l5.10"></a><span id="l5.10">       return new Promise(resolve =&gt; {</span>
<a href="#l5.11"></a><span id="l5.11">         browser.mailTabs.onDisplayedFolderChanged.addListener(function listener(</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-          tabId,</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+          tab,</span>
<a href="#l5.14"></a><span id="l5.14">           folder</span>
<a href="#l5.15"></a><span id="l5.15">         ) {</span>
<a href="#l5.16"></a><span id="l5.16">           browser.mailTabs.onDisplayedFolderChanged.removeListener(listener);</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineminus">-          browser.test.assertEq(current.id, tabId);</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+          browser.test.assertEq(current.id, tab.id);</span>
<a href="#l5.19"></a><span id="l5.19">           browser.test.assertEq(accountId, folder.accountId);</span>
<a href="#l5.20"></a><span id="l5.20">           browser.test.assertEq(newFolderPath, folder.path);</span>
<a href="#l5.21"></a><span id="l5.21">           resolve();</span>
<a href="#l5.22"></a><span id="l5.22">         });</span>
<a href="#l5.23"></a><span id="l5.23">         browser.test.sendMessage(&quot;selectFolder&quot;, newFolderPath);</span>
<a href="#l5.24"></a><span id="l5.24">       });</span>
<a href="#l5.25"></a><span id="l5.25">     }</span>
<a href="#l5.26"></a><span id="l5.26">     await selectFolder(&quot;/Trash&quot;);</span>
<a href="#l5.27"></a><span id="l5.27">     await selectFolder(&quot;/Unsent Messages&quot;);</span>
<a href="#l5.28"></a><span id="l5.28">     await selectFolder(&quot;/&quot;);</span>
<a href="#l5.29"></a><span id="l5.29"> </span>
<a href="#l5.30"></a><span id="l5.30">     async function selectFolderByUpdate(newFolderPath) {</span>
<a href="#l5.31"></a><span id="l5.31">       return new Promise(resolve =&gt; {</span>
<a href="#l5.32"></a><span id="l5.32">         browser.mailTabs.onDisplayedFolderChanged.addListener(function listener(</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineminus">-          tabId,</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineplus">+          tab,</span>
<a href="#l5.35"></a><span id="l5.35">           folder</span>
<a href="#l5.36"></a><span id="l5.36">         ) {</span>
<a href="#l5.37"></a><span id="l5.37">           browser.mailTabs.onDisplayedFolderChanged.removeListener(listener);</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineminus">-          browser.test.assertEq(current.id, tabId);</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineplus">+          browser.test.assertEq(current.id, tab.id);</span>
<a href="#l5.40"></a><span id="l5.40">           browser.test.assertEq(accountId, folder.accountId);</span>
<a href="#l5.41"></a><span id="l5.41">           browser.test.assertEq(newFolderPath, folder.path);</span>
<a href="#l5.42"></a><span id="l5.42">           resolve();</span>
<a href="#l5.43"></a><span id="l5.43">         });</span>
<a href="#l5.44"></a><span id="l5.44">         browser.mailTabs.update({</span>
<a href="#l5.45"></a><span id="l5.45">           displayedFolder: { accountId, path: newFolderPath },</span>
<a href="#l5.46"></a><span id="l5.46">         });</span>
<a href="#l5.47"></a><span id="l5.47">       });</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineat">@@ -287,17 +287,17 @@ add_task(async function test_selectedMes</span>
<a href="#l5.49"></a><span id="l5.49">     // or when we call addListener below, it won't happen before the event is fired.</span>
<a href="#l5.50"></a><span id="l5.50">     // This only applies if none of the earlier tests are run, but I'm saving you from wasting</span>
<a href="#l5.51"></a><span id="l5.51">     // time figuring out what's going on like I did.</span>
<a href="#l5.52"></a><span id="l5.52">     await browser.mailTabs.query({});</span>
<a href="#l5.53"></a><span id="l5.53"> </span>
<a href="#l5.54"></a><span id="l5.54">     async function selectMessages(...newMessages) {</span>
<a href="#l5.55"></a><span id="l5.55">       return new Promise(resolve =&gt; {</span>
<a href="#l5.56"></a><span id="l5.56">         browser.mailTabs.onSelectedMessagesChanged.addListener(</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineminus">-          function listener(tabId, messageList) {</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineplus">+          function listener(tab, messageList) {</span>
<a href="#l5.59"></a><span id="l5.59">             browser.mailTabs.onSelectedMessagesChanged.removeListener(listener);</span>
<a href="#l5.60"></a><span id="l5.60">             resolve(messageList);</span>
<a href="#l5.61"></a><span id="l5.61">           }</span>
<a href="#l5.62"></a><span id="l5.62">         );</span>
<a href="#l5.63"></a><span id="l5.63">         browser.test.sendMessage(&quot;selectMessage&quot;, newMessages);</span>
<a href="#l5.64"></a><span id="l5.64">       });</span>
<a href="#l5.65"></a><span id="l5.65">     }</span>
<a href="#l5.66"></a><span id="l5.66"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/components/extensions/test/browser/browser_ext_messageDisplay.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/components/extensions/test/browser/browser_ext_messageDisplay.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -21,70 +21,70 @@ add_task(async () =&gt; {</span>
<a href="#l6.4"></a><span id="l6.4">         active: true,</span>
<a href="#l6.5"></a><span id="l6.5">         currentWindow: true,</span>
<a href="#l6.6"></a><span id="l6.6">       });</span>
<a href="#l6.7"></a><span id="l6.7">       let { messages } = await browser.messages.list(displayedFolder);</span>
<a href="#l6.8"></a><span id="l6.8"> </span>
<a href="#l6.9"></a><span id="l6.9">       // Test that selecting a different message fires the event.</span>
<a href="#l6.10"></a><span id="l6.10">       let eventListener = waitForEvent();</span>
<a href="#l6.11"></a><span id="l6.11">       browser.test.sendMessage(&quot;show message 1&quot;);</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-      let [tabId, message] = await eventListener;</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-      browser.test.assertEq(firstTabId, tabId);</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+      let [tab, message] = await eventListener;</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+      browser.test.assertEq(firstTabId, tab.id);</span>
<a href="#l6.16"></a><span id="l6.16">       browser.test.assertEq(messages[1].subject, message.subject);</span>
<a href="#l6.17"></a><span id="l6.17"> </span>
<a href="#l6.18"></a><span id="l6.18" class="difflineminus">-      message = await browser.messageDisplay.getDisplayedMessage(tabId);</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+      message = await browser.messageDisplay.getDisplayedMessage(tab.id);</span>
<a href="#l6.20"></a><span id="l6.20">       browser.test.assertEq(messages[1].subject, message.subject);</span>
<a href="#l6.21"></a><span id="l6.21"> </span>
<a href="#l6.22"></a><span id="l6.22">       // ... and again, for good measure.</span>
<a href="#l6.23"></a><span id="l6.23">       eventListener = waitForEvent();</span>
<a href="#l6.24"></a><span id="l6.24">       browser.test.sendMessage(&quot;show message 2&quot;);</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineminus">-      [tabId, message] = await eventListener;</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineminus">-      browser.test.assertEq(firstTabId, tabId);</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineplus">+      [tab, message] = await eventListener;</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineplus">+      browser.test.assertEq(firstTabId, tab.id);</span>
<a href="#l6.29"></a><span id="l6.29">       browser.test.assertEq(messages[2].subject, message.subject);</span>
<a href="#l6.30"></a><span id="l6.30"> </span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-      message = await browser.messageDisplay.getDisplayedMessage(tabId);</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+      message = await browser.messageDisplay.getDisplayedMessage(tab.id);</span>
<a href="#l6.33"></a><span id="l6.33">       browser.test.assertEq(messages[2].subject, message.subject);</span>
<a href="#l6.34"></a><span id="l6.34"> </span>
<a href="#l6.35"></a><span id="l6.35">       // Test that opening a message in a new tab fires the event.</span>
<a href="#l6.36"></a><span id="l6.36">       eventListener = waitForEvent();</span>
<a href="#l6.37"></a><span id="l6.37">       browser.test.sendMessage(&quot;open message tab&quot;);</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineminus">-      [tabId, message] = await eventListener;</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineminus">-      browser.test.assertTrue(firstTabId != tabId);</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineplus">+      [tab, message] = await eventListener;</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineplus">+      browser.test.assertTrue(firstTabId != tab.id);</span>
<a href="#l6.42"></a><span id="l6.42">       browser.test.assertEq(messages[2].subject, message.subject);</span>
<a href="#l6.43"></a><span id="l6.43"> </span>
<a href="#l6.44"></a><span id="l6.44" class="difflineminus">-      message = await browser.messageDisplay.getDisplayedMessage(tabId);</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineplus">+      message = await browser.messageDisplay.getDisplayedMessage(tab.id);</span>
<a href="#l6.46"></a><span id="l6.46">       browser.test.assertEq(messages[2].subject, message.subject);</span>
<a href="#l6.47"></a><span id="l6.47"> </span>
<a href="#l6.48"></a><span id="l6.48">       // Test that the first tab is not displaying a message.</span>
<a href="#l6.49"></a><span id="l6.49">       message = await browser.messageDisplay.getDisplayedMessage(firstTabId);</span>
<a href="#l6.50"></a><span id="l6.50">       browser.test.assertEq(null, message);</span>
<a href="#l6.51"></a><span id="l6.51"> </span>
<a href="#l6.52"></a><span id="l6.52">       // Closing the tab should return us to the first tab, and fires the</span>
<a href="#l6.53"></a><span id="l6.53">       // event. It doesn't have to be this way, it just is.</span>
<a href="#l6.54"></a><span id="l6.54">       eventListener = waitForEvent();</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineminus">-      browser.tabs.remove(tabId);</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineminus">-      [tabId, message] = await eventListener;</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineminus">-      browser.test.assertEq(firstTabId, tabId);</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineplus">+      browser.tabs.remove(tab.id);</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineplus">+      [tab, message] = await eventListener;</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineplus">+      browser.test.assertEq(firstTabId, tab.id);</span>
<a href="#l6.61"></a><span id="l6.61">       browser.test.assertEq(messages[2].subject, message.subject);</span>
<a href="#l6.62"></a><span id="l6.62"> </span>
<a href="#l6.63"></a><span id="l6.63" class="difflineminus">-      message = await browser.messageDisplay.getDisplayedMessage(tabId);</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineplus">+      message = await browser.messageDisplay.getDisplayedMessage(tab.id);</span>
<a href="#l6.65"></a><span id="l6.65">       browser.test.assertEq(messages[2].subject, message.subject);</span>
<a href="#l6.66"></a><span id="l6.66"> </span>
<a href="#l6.67"></a><span id="l6.67">       // Test that opening a message in a new window fires the event.</span>
<a href="#l6.68"></a><span id="l6.68">       eventListener = waitForEvent();</span>
<a href="#l6.69"></a><span id="l6.69">       browser.test.sendMessage(&quot;open message window&quot;);</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineminus">-      [tabId, message] = await eventListener;</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineminus">-      browser.test.assertTrue(firstTabId != tabId);</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineplus">+      [tab, message] = await eventListener;</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineplus">+      browser.test.assertTrue(firstTabId != tab.id);</span>
<a href="#l6.74"></a><span id="l6.74">       browser.test.assertEq(messages[2].subject, message.subject);</span>
<a href="#l6.75"></a><span id="l6.75"> </span>
<a href="#l6.76"></a><span id="l6.76" class="difflineminus">-      message = await browser.messageDisplay.getDisplayedMessage(tabId);</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineplus">+      message = await browser.messageDisplay.getDisplayedMessage(tab.id);</span>
<a href="#l6.78"></a><span id="l6.78">       browser.test.assertEq(messages[2].subject, message.subject);</span>
<a href="#l6.79"></a><span id="l6.79"> </span>
<a href="#l6.80"></a><span id="l6.80">       // Close the window.</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineminus">-      browser.tabs.remove(tabId);</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineplus">+      browser.tabs.remove(tab.id);</span>
<a href="#l6.83"></a><span id="l6.83"> </span>
<a href="#l6.84"></a><span id="l6.84">       browser.test.notifyPass(&quot;finished&quot;);</span>
<a href="#l6.85"></a><span id="l6.85">     },</span>
<a href="#l6.86"></a><span id="l6.86">     manifest: {</span>
<a href="#l6.87"></a><span id="l6.87">       permissions: [&quot;accountsRead&quot;, &quot;messagesRead&quot;],</span>
<a href="#l6.88"></a><span id="l6.88">     },</span>
<a href="#l6.89"></a><span id="l6.89">   });</span>
<a href="#l6.90"></a><span id="l6.90"> </span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

