<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 3699:b7a1e8bc053a177768b2af5c4c8c3176163a1321</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ b7a1e8bc053a177768b2af5c4c8c3176163a1321" />
<meta property="og:url" content="/comm-central/rev/b7a1e8bc053a177768b2af5c4c8c3176163a1321" />
<meta property="og:description" content="merge of add-protovis" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / b7a1e8bc053a177768b2af5c4c8c3176163a1321 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/b7a1e8bc053a177768b2af5c4c8c3176163a1321">shortlog</a> |
<a href="/comm-central/log/b7a1e8bc053a177768b2af5c4c8c3176163a1321">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/b7a1e8bc053a177768b2af5c4c8c3176163a1321">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/b7a1e8bc053a177768b2af5c4c8c3176163a1321">files</a> |
changeset |
<a href="/comm-central/raw-rev/b7a1e8bc053a177768b2af5c4c8c3176163a1321">raw</a>  | <a href="/comm-central/archive/b7a1e8bc053a177768b2af5c4c8c3176163a1321.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
merge of add-protovis
<span class="logtags"><span class="inbranchtag" title="add-jquery">add-jquery</span> </span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#65;&#110;&#100;&#114;&#101;&#119;&#32;&#83;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#32;&#60;&#97;&#115;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#64;&#97;&#115;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#46;&#111;&#114;&#103;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 04 Sep 2009 15:55:59 -0700</td></tr>
<tr><td>branch</td><td>add-jquery</td></tr>
<tr>
 <td>changeset 3699</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/b7a1e8bc053a177768b2af5c4c8c3176163a1321">b7a1e8bc053a177768b2af5c4c8c3176163a1321</a></td>
</tr>



<tr>
<td>parent 3692</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/cd282238ceaa9199c8c2c5f4b82fa1f27fbb05b8">cd282238ceaa9199c8c2c5f4b82fa1f27fbb05b8</a> (current diff)
</td>
</tr>
<tr>
<td>parent 3698</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/c6a1b52b3e3f7bfb72984e227c821aff3d1c59d5">c6a1b52b3e3f7bfb72984e227c821aff3d1c59d5</a> (<a href="/comm-central/rev/c6a1b52b3e3f7bfb72984e227c821aff3d1c59d5:b7a1e8bc053a">diff</a>)
</td>
</tr>

<tr>
<td>child 3700</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/701d04f111112c5c910f84014d4fc0e3ddd0ac9d">701d04f111112c5c910f84014d4fc0e3ddd0ac9d</a>
</td>
</tr>
<tr>
<td>child 3706</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/45fbab07d8b3e6cf7fb227e5783b1a5dcdc141d5">45fbab07d8b3e6cf7fb227e5783b1a5dcdc141d5</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=b7a1e8bc053a177768b2af5c4c8c3176163a1321">2927</a></td></tr>
<tr><td>push user</td><td>bugmail@asutherland.org</td></tr>
<tr><td>push date</td><td class="date age">Thu, 10 Sep 2009 01:15:56 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@0b161ed73eb6 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=0b161ed73eb66538ade852cb5a4b9b1b2c319a33">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=0b161ed73eb66538ade852cb5a4b9b1b2c319a33&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0b161ed73eb66538ade852cb5a4b9b1b2c319a33&newProject=comm-central&newRevision=b5e0aff84bf4077a47919481912ad0bd11c6a8d8&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0b161ed73eb66538ade852cb5a4b9b1b2c319a33&newProject=comm-central&newRevision=b5e0aff84bf4077a47919481912ad0bd11c6a8d8&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0b161ed73eb66538ade852cb5a4b9b1b2c319a33&newProject=comm-central&newRevision=b5e0aff84bf4077a47919481912ad0bd11c6a8d8&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>






</table></div>

<div class="page_body description">merge of add-protovis</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b7a1e8bc053a177768b2af5c4c8c3176163a1321/.hgpatchinfo/add-jquery.dep">.hgpatchinfo/add-jquery.dep</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b7a1e8bc053a177768b2af5c4c8c3176163a1321/.hgpatchinfo/add-jquery.dep">file</a> |
<a href="/comm-central/annotate/b7a1e8bc053a177768b2af5c4c8c3176163a1321/.hgpatchinfo/add-jquery.dep">annotate</a> |
<a href="/comm-central/diff/b7a1e8bc053a177768b2af5c4c8c3176163a1321/.hgpatchinfo/add-jquery.dep">diff</a> |
<a href="/comm-central/comparison/b7a1e8bc053a177768b2af5c4c8c3176163a1321/.hgpatchinfo/add-jquery.dep">comparison</a> |
<a href="/comm-central/log/b7a1e8bc053a177768b2af5c4c8c3176163a1321/.hgpatchinfo/add-jquery.dep">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/.hgpatchinfo/add-jquery.dep</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/.hgpatchinfo/add-jquery.dep</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -1,1 +1,1 @@</span>
<a href="#l1.4"></a><span id="l1.4" class="difflineminus">-2900b9e8de1e35e783dd517583a1d95bcca480b2</span>
<a href="#l1.5"></a><span id="l1.5">\ No newline at end of file</span>
<a href="#l1.6"></a><span id="l1.6" class="difflineplus">+c6a1b52b3e3f7bfb72984e227c821aff3d1c59d5</span>
<a href="#l1.7"></a><span id="l1.7">\ No newline at end of file</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/.hgpatchinfo/add-protovis.dep</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/.hgpatchinfo/add-protovis.dep</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -1,1 +1,1 @@</span>
<a href="#l2.4"></a><span id="l2.4" class="difflineminus">-0bb2a0ee37c1af1c76d758c1eee1d99b18924704</span>
<a href="#l2.5"></a><span id="l2.5">\ No newline at end of file</span>
<a href="#l2.6"></a><span id="l2.6" class="difflineplus">+b11a45aa831d50594e7f23968bda9bc010103ef1</span>
<a href="#l2.7"></a><span id="l2.7">\ No newline at end of file</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/calendar/confvars.sh</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/calendar/confvars.sh</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -44,17 +44,17 @@ MOZ_CALENDAR=1</span>
<a href="#l3.4"></a><span id="l3.4"> MOZ_APP_VERSION=$SUNBIRD_VERSION</span>
<a href="#l3.5"></a><span id="l3.5"> MOZ_PLAINTEXT_EDITOR_ONLY=1</span>
<a href="#l3.6"></a><span id="l3.6"> NECKO_PROTOCOLS_DEFAULT=&quot;about data file ftp http res viewsource&quot;</span>
<a href="#l3.7"></a><span id="l3.7"> MOZ_NO_ACTIVEX_SUPPORT=1</span>
<a href="#l3.8"></a><span id="l3.8"> MOZ_ACTIVEX_SCRIPTING_SUPPORT=</span>
<a href="#l3.9"></a><span id="l3.9"> MOZ_INSTALLER=</span>
<a href="#l3.10"></a><span id="l3.10"> MOZ_MATHML=</span>
<a href="#l3.11"></a><span id="l3.11"> NECKO_DISK_CACHE=</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-if test &quot;$MOZILLA_BRANCH_VERSION&quot; = &quot;1.9.1&quot;; then</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+# MOZ_OJI is only required to be cleared for MOZILLA_1_9_1_BRANCH.</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+# mozilla-central does not have this.</span>
<a href="#l3.15"></a><span id="l3.15"> MOZ_OJI=</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineminus">-fi</span>
<a href="#l3.17"></a><span id="l3.17"> NECKO_COOKIES=</span>
<a href="#l3.18"></a><span id="l3.18"> MOZ_NO_XPCOM_OBSOLETE=1</span>
<a href="#l3.19"></a><span id="l3.19"> MOZ_EXTENSIONS_DEFAULT=</span>
<a href="#l3.20"></a><span id="l3.20"> MOZ_UNIVERSALCHARDET=</span>
<a href="#l3.21"></a><span id="l3.21"> MOZ_APP_VERSION=`cat $topsrcdir/$MOZ_BUILD_APP/sunbird/config/version.txt`</span>
<a href="#l3.22"></a><span id="l3.22"> SUNBIRD_VERSION=$MOZ_APP_VERSION</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/config/autoconf.mk.in</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/config/autoconf.mk.in</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -468,17 +468,16 @@ TK_CFLAGS	= @TK_CFLAGS@</span>
<a href="#l4.4"></a><span id="l4.4"> TK_LIBS		= @TK_LIBS@</span>
<a href="#l4.5"></a><span id="l4.5"> </span>
<a href="#l4.6"></a><span id="l4.6"> CAIRO_FT_CFLAGS		= @CAIRO_FT_CFLAGS@</span>
<a href="#l4.7"></a><span id="l4.7"> </span>
<a href="#l4.8"></a><span id="l4.8"> MOZ_TREE_FREETYPE		= @MOZ_TREE_FREETYPE@</span>
<a href="#l4.9"></a><span id="l4.9"> MOZ_ENABLE_GTK2		= @MOZ_ENABLE_GTK2@</span>
<a href="#l4.10"></a><span id="l4.10"> MOZ_ENABLE_QT		= @MOZ_ENABLE_QT@</span>
<a href="#l4.11"></a><span id="l4.11"> MOZ_ENABLE_PHOTON	= @MOZ_ENABLE_PHOTON@</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-MOZ_ENABLE_COCOA	= @MOZ_ENABLE_COCOA@</span>
<a href="#l4.13"></a><span id="l4.13"> MOZ_ENABLE_XREMOTE	= @MOZ_ENABLE_XREMOTE@</span>
<a href="#l4.14"></a><span id="l4.14"> </span>
<a href="#l4.15"></a><span id="l4.15"> MOZ_GTK2_CFLAGS		= @MOZ_GTK2_CFLAGS@</span>
<a href="#l4.16"></a><span id="l4.16"> MOZ_GTK2_LIBS		= @MOZ_GTK2_LIBS@</span>
<a href="#l4.17"></a><span id="l4.17"> </span>
<a href="#l4.18"></a><span id="l4.18"> MOZ_QT_CFLAGS		= @MOZ_QT_CFLAGS@</span>
<a href="#l4.19"></a><span id="l4.19"> MOZ_QT_LIBS		= @MOZ_QT_LIBS@</span>
<a href="#l4.20"></a><span id="l4.20"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/configure.in</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/configure.in</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -4830,17 +4830,16 @@ cairo-os2)</span>
<a href="#l5.4"></a><span id="l5.4">     TK_CFLAGS='$(MOZ_CAIRO_CFLAGS)'</span>
<a href="#l5.5"></a><span id="l5.5">     TK_LIBS='$(MOZ_CAIRO_LIBS)'</span>
<a href="#l5.6"></a><span id="l5.6">     ;;</span>
<a href="#l5.7"></a><span id="l5.7"> </span>
<a href="#l5.8"></a><span id="l5.8"> cairo-mac|cairo-cocoa)</span>
<a href="#l5.9"></a><span id="l5.9">     if test &quot;$MOZ_WIDGET_TOOLKIT&quot; = &quot;cairo-cocoa&quot;; then</span>
<a href="#l5.10"></a><span id="l5.10">         MOZ_WIDGET_TOOLKIT=cocoa</span>
<a href="#l5.11"></a><span id="l5.11">         AC_DEFINE(MOZ_WIDGET_COCOA)</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-        MOZ_ENABLE_COCOA=1</span>
<a href="#l5.13"></a><span id="l5.13">     else</span>
<a href="#l5.14"></a><span id="l5.14">         MOZ_WIDGET_TOOLKIT=mac</span>
<a href="#l5.15"></a><span id="l5.15">     fi</span>
<a href="#l5.16"></a><span id="l5.16">     MOZ_USER_DIR=&quot;Mozilla&quot;</span>
<a href="#l5.17"></a><span id="l5.17">     AC_DEFINE(XP_MACOSX)</span>
<a href="#l5.18"></a><span id="l5.18">     AC_DEFINE(TARGET_CARBON)</span>
<a href="#l5.19"></a><span id="l5.19">     AC_DEFINE(TARGET_API_MAC_CARBON)</span>
<a href="#l5.20"></a><span id="l5.20">     TK_LIBS='-framework Carbon -framework AddressBook'</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineat">@@ -4945,17 +4944,16 @@ then</span>
<a href="#l5.22"></a><span id="l5.22"> fi</span>
<a href="#l5.23"></a><span id="l5.23"> </span>
<a href="#l5.24"></a><span id="l5.24"> AC_SUBST(GTK_CONFIG)</span>
<a href="#l5.25"></a><span id="l5.25"> AC_SUBST(TK_CFLAGS)</span>
<a href="#l5.26"></a><span id="l5.26"> AC_SUBST(TK_LIBS)</span>
<a href="#l5.27"></a><span id="l5.27"> </span>
<a href="#l5.28"></a><span id="l5.28"> AC_SUBST(MOZ_ENABLE_GTK2)</span>
<a href="#l5.29"></a><span id="l5.29"> AC_SUBST(MOZ_ENABLE_PHOTON)</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineminus">-AC_SUBST(MOZ_ENABLE_COCOA)</span>
<a href="#l5.31"></a><span id="l5.31"> AC_SUBST(MOZ_ENABLE_QT)</span>
<a href="#l5.32"></a><span id="l5.32"> AC_SUBST(MOZ_ENABLE_XREMOTE)</span>
<a href="#l5.33"></a><span id="l5.33"> AC_SUBST(MOZ_GTK2_CFLAGS)</span>
<a href="#l5.34"></a><span id="l5.34"> AC_SUBST(MOZ_GTK2_LIBS)</span>
<a href="#l5.35"></a><span id="l5.35"> AC_SUBST(MOZ_QT_CFLAGS)</span>
<a href="#l5.36"></a><span id="l5.36"> AC_SUBST(MOZ_QT_LIBS)</span>
<a href="#l5.37"></a><span id="l5.37"> </span>
<a href="#l5.38"></a><span id="l5.38"> AC_SUBST(MOC)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/app/profile/all-thunderbird.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/app/profile/all-thunderbird.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -457,12 +457,13 @@ pref(&quot;toolbar.customization.usesheet&quot;, t</span>
<a href="#l6.4"></a><span id="l6.4"> pref(&quot;toolbar.customization.usesheet&quot;, false);</span>
<a href="#l6.5"></a><span id="l6.5"> #endif</span>
<a href="#l6.6"></a><span id="l6.6"> </span>
<a href="#l6.7"></a><span id="l6.7"> // Check for missing attachments?</span>
<a href="#l6.8"></a><span id="l6.8"> pref(&quot;mail.compose.attachment_reminder&quot;, true);</span>
<a href="#l6.9"></a><span id="l6.9"> // Words that should trigger a missing attachments warning.</span>
<a href="#l6.10"></a><span id="l6.10"> pref(&quot;mail.compose.attachment_reminder_keywords&quot;, &quot;chrome://messenger/locale/messengercompose/composeMsgs.properties&quot;);</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+pref(&quot;browser.formfill.enable&quot;, true);</span>
<a href="#l6.13"></a><span id="l6.13"> // Override the all.js values so that unit tests pass and we get sane values.</span>
<a href="#l6.14"></a><span id="l6.14"> pref(&quot;browser.history_expire_days&quot;, 180);</span>
<a href="#l6.15"></a><span id="l6.15"> pref(&quot;browser.history_expire_days_min&quot;, 90);</span>
<a href="#l6.16"></a><span id="l6.16"> pref(&quot;browser.history_expire_sites&quot;, 40000);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/base/content/mailCore.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/base/content/mailCore.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -116,18 +116,18 @@ function MailToolboxCustomizeDone(aEvent</span>
<a href="#l7.4"></a><span id="l7.4"> </span>
<a href="#l7.5"></a><span id="l7.5">   // make sure the mail views search box is initialized</span>
<a href="#l7.6"></a><span id="l7.6">   if (document.getElementById(&quot;mailviews-container&quot;))</span>
<a href="#l7.7"></a><span id="l7.7">     ViewPickerOnLoad();</span>
<a href="#l7.8"></a><span id="l7.8"> </span>
<a href="#l7.9"></a><span id="l7.9">   // make sure the folder location picker is initialized</span>
<a href="#l7.10"></a><span id="l7.10">   if (document.getElementById(&quot;folder-location-container&quot;))</span>
<a href="#l7.11"></a><span id="l7.11">   {</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-    loadFolderViewForTree(gCurrentFolderView, document.getElementById('folderLocationPopup').tree);</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-    UpdateFolderLocationPicker(gFolderDisplay.displayedFolder);</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+    // XXX FIXME: used to call loadFolderViewForTree  and UpdateFolderLocationPicker</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+    // but those were removed in changeset 1de58e1d7549</span>
<a href="#l7.16"></a><span id="l7.16">   }</span>
<a href="#l7.17"></a><span id="l7.17"> </span>
<a href="#l7.18"></a><span id="l7.18">   gSearchInput = null;</span>
<a href="#l7.19"></a><span id="l7.19">   if (document.getElementById(&quot;search-container&quot;))</span>
<a href="#l7.20"></a><span id="l7.20">     GetSearchInput();</span>
<a href="#l7.21"></a><span id="l7.21"> </span>
<a href="#l7.22"></a><span id="l7.22">   var customizePopup = document.getElementById(customizePopupId);</span>
<a href="#l7.23"></a><span id="l7.23">   customizePopup.removeAttribute(&quot;disabled&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mail/base/content/mailWindowOverlay.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mail/base/content/mailWindowOverlay.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -233,21 +233,27 @@ function view_init()</span>
<a href="#l8.4"></a><span id="l8.4"> function InitViewLayoutStyleMenu(event)</span>
<a href="#l8.5"></a><span id="l8.5"> {</span>
<a href="#l8.6"></a><span id="l8.6">   var paneConfig = pref.getIntPref(&quot;mail.pane_config.dynamic&quot;);</span>
<a href="#l8.7"></a><span id="l8.7">   var layoutStyleMenuitem = event.target.childNodes[paneConfig];</span>
<a href="#l8.8"></a><span id="l8.8">   if (layoutStyleMenuitem)</span>
<a href="#l8.9"></a><span id="l8.9">     layoutStyleMenuitem.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l8.10"></a><span id="l8.10"> }</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+/**</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+ * Initialize (check) appropriate folder mode under the View |Â Folder menu.</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+ */</span>
<a href="#l8.15"></a><span id="l8.15"> function InitViewFolderViewsMenu(event)</span>
<a href="#l8.16"></a><span id="l8.16"> {</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineminus">-  var layoutStyleMenuitem = event.target.childNodes[gCurrentFolderView];</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineminus">-  if (layoutStyleMenuitem)</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineminus">-    layoutStyleMenuitem.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineplus">+  for (let i = 0; i &lt; event.target.childNodes.length; i++) {</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineplus">+    if (event.target.childNodes[i].value == gFolderTreeView.mode) {</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineplus">+      event.target.childNodes[i].setAttribute(&quot;checked&quot;, true);</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineplus">+      break;</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+    }</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineplus">+  }</span>
<a href="#l8.26"></a><span id="l8.26"> }</span>
<a href="#l8.27"></a><span id="l8.27"> </span>
<a href="#l8.28"></a><span id="l8.28"> function setSortByMenuItemCheckState(id, value)</span>
<a href="#l8.29"></a><span id="l8.29"> {</span>
<a href="#l8.30"></a><span id="l8.30">   var menuitem = document.getElementById(id);</span>
<a href="#l8.31"></a><span id="l8.31">   if (menuitem)</span>
<a href="#l8.32"></a><span id="l8.32">     menuitem.setAttribute(&quot;checked&quot;, value);</span>
<a href="#l8.33"></a><span id="l8.33"> }</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineat">@@ -2278,31 +2284,26 @@ let mailTabType = {</span>
<a href="#l8.35"></a><span id="l8.35">         gFolderTreeView.selection.selectEventsSuppressed = false;</span>
<a href="#l8.36"></a><span id="l8.36">       }</span>
<a href="#l8.37"></a><span id="l8.37">     }</span>
<a href="#l8.38"></a><span id="l8.38"> </span>
<a href="#l8.39"></a><span id="l8.39">     // restore focus</span>
<a href="#l8.40"></a><span id="l8.40">     this.restoreFocus(aTab);</span>
<a href="#l8.41"></a><span id="l8.41">   },</span>
<a href="#l8.42"></a><span id="l8.42"> </span>
<a href="#l8.43"></a><span id="l8.43" class="difflineminus">-  supportsCommand: function(aTab, aCommand) {</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineminus">-    return DefaultController.supportsCommand(aCommand);</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineminus">-  },</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineminus">-</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineminus">-  isCommandEnabled: function(aTab, aCommand) {</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineminus">-    return DefaultController.isCommandEnabled(aCommand);</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineminus">-  },</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineminus">-</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineminus">-  doCommand: function(aTab, aCommand) {</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineminus">-    DefaultController.doCommand(aCommand, aTab);</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineminus">-  },</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineminus">-</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineminus">-  onEvent: function(aTab, aEvent) {</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineminus">-    DefaultController.onEvent(aEvent);</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineminus">-  }</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineplus">+  //</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineplus">+  // nsIController implementation</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineplus">+  //</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineplus">+  // We ignore the aTab parameter sent by tabmail when calling nsIController</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineplus">+  // stuff and just delegate the call to a default controller by using it as</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineplus">+  // our proto chain:</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineplus">+  // - &quot;DefaultController&quot; is the default controller of messenger.xul</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineplus">+  // - &quot;MessageWindowController&quot; is the default controller of messageWindow.xul</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineplus">+  __proto__: &quot;DefaultController&quot; in window &amp;&amp; window.DefaultController ||</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineplus">+             &quot;MessageWindowController&quot; in window &amp;&amp; window.MessageWindowController</span>
<a href="#l8.68"></a><span id="l8.68"> };</span>
<a href="#l8.69"></a><span id="l8.69"> /**</span>
<a href="#l8.70"></a><span id="l8.70">  * The glodaSearch tab mode has a UI widget outside of the mailTabType's</span>
<a href="#l8.71"></a><span id="l8.71">  *  display panel, the #glodaSearchInput textbox.  This means we need to use a</span>
<a href="#l8.72"></a><span id="l8.72">  *  tab monitor so that we can appropriately update the contents of the textbox.</span>
<a href="#l8.73"></a><span id="l8.73">  * Every time a tab is changed, we save the state of the text box and restore</span>
<a href="#l8.74"></a><span id="l8.74">  *  its previous value for the tab we are switching to, as well as whether this</span>
<a href="#l8.75"></a><span id="l8.75">  *  value is a change to the currently-used value (if it is a glodaSearch) tab.</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineat">@@ -2444,27 +2445,29 @@ function MsgOpenNewWindowForMessage(aMsg</span>
<a href="#l8.77"></a><span id="l8.77"> }</span>
<a href="#l8.78"></a><span id="l8.78"> </span>
<a href="#l8.79"></a><span id="l8.79"> function MsgJunk()</span>
<a href="#l8.80"></a><span id="l8.80"> {</span>
<a href="#l8.81"></a><span id="l8.81">   MsgJunkMailInfo(true);</span>
<a href="#l8.82"></a><span id="l8.82">   JunkSelectedMessages(!SelectedMessagesAreJunk());</span>
<a href="#l8.83"></a><span id="l8.83"> }</span>
<a href="#l8.84"></a><span id="l8.84"> </span>
<a href="#l8.85"></a><span id="l8.85" class="difflineminus">-</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineplus">+/**</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineplus">+ * Update the &quot;mark as junk&quot; button in the message header area.</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineplus">+ */</span>
<a href="#l8.89"></a><span id="l8.89"> function UpdateJunkButton()</span>
<a href="#l8.90"></a><span id="l8.90"> {</span>
<a href="#l8.91"></a><span id="l8.91">   // The junk message should slave off the selected message, as the preview pane</span>
<a href="#l8.92"></a><span id="l8.92">   //  may not be visible</span>
<a href="#l8.93"></a><span id="l8.93">   let hdr = gFolderDisplay.selectedMessage;</span>
<a href="#l8.94"></a><span id="l8.94">   // But only the message display knows if we are dealing with a dummy.</span>
<a href="#l8.95"></a><span id="l8.95">   if (!hdr || gMessageDisplay.isDummy) // .eml file</span>
<a href="#l8.96"></a><span id="l8.96">     return;</span>
<a href="#l8.97"></a><span id="l8.97">   let junkScore = hdr.getStringProperty(&quot;junkscore&quot;);</span>
<a href="#l8.98"></a><span id="l8.98" class="difflineminus">-  let hideJunk = (junkScore != &quot;&quot;) &amp;&amp; (junkScore != &quot;0&quot;);</span>
<a href="#l8.99"></a><span id="l8.99" class="difflineplus">+  let hideJunk = (junkScore == Components.interfaces.nsIJunkMailPlugin.IS_SPAM_SCORE);</span>
<a href="#l8.100"></a><span id="l8.100">   if (gFolderDisplay.selectedMessageIsNews)</span>
<a href="#l8.101"></a><span id="l8.101">     hideJunk = true;</span>
<a href="#l8.102"></a><span id="l8.102"> </span>
<a href="#l8.103"></a><span id="l8.103">   getCurrentMsgHdrButtonBox().getButton('hdrJunkButton').disabled = hideJunk;</span>
<a href="#l8.104"></a><span id="l8.104"> }</span>
<a href="#l8.105"></a><span id="l8.105"> </span>
<a href="#l8.106"></a><span id="l8.106"> function MsgMarkMsgAsRead()</span>
<a href="#l8.107"></a><span id="l8.107"> {</span>
<a href="#l8.108"></a><span id="l8.108" class="difflineat">@@ -3050,28 +3053,28 @@ function HandleJunkStatusChanged(folder)</span>
<a href="#l8.109"></a><span id="l8.109">     // We may be forcing junk mail to be rendered with sanitized html.</span>
<a href="#l8.110"></a><span id="l8.110">     // In that scenario, we want to reload the message if the status has just</span>
<a href="#l8.111"></a><span id="l8.111">     // changed to not junk.</span>
<a href="#l8.112"></a><span id="l8.112">     var sanitizeJunkMail = gPrefBranch.getBoolPref(&quot;mail.spam.display.sanitize&quot;);</span>
<a href="#l8.113"></a><span id="l8.113"> </span>
<a href="#l8.114"></a><span id="l8.114">     // Only bother doing this if we are modifying the html for junk mail....</span>
<a href="#l8.115"></a><span id="l8.115">     if (sanitizeJunkMail)</span>
<a href="#l8.116"></a><span id="l8.116">     {</span>
<a href="#l8.117"></a><span id="l8.117" class="difflineminus">-      var moveJunkMail = (folder &amp;&amp; folder.server &amp;&amp; folder.server.spamSettings) ?</span>
<a href="#l8.118"></a><span id="l8.118" class="difflineminus">-                          folder.server.spamSettings.manualMark : false;</span>
<a href="#l8.119"></a><span id="l8.119" class="difflineminus">-</span>
<a href="#l8.120"></a><span id="l8.120" class="difflineminus">-      var junkScore = msgHdr.getStringProperty(&quot;junkscore&quot;);</span>
<a href="#l8.121"></a><span id="l8.121" class="difflineminus">-      var isJunk = (junkScore == &quot;&quot;) || (junkScore == &quot;0&quot;);</span>
<a href="#l8.122"></a><span id="l8.122" class="difflineminus">-</span>
<a href="#l8.123"></a><span id="l8.123" class="difflineminus">-      // We used to only reload the message if we were toggling the message</span>
<a href="#l8.124"></a><span id="l8.124" class="difflineminus">-      // to NOT JUNK from junk but it can be useful to see the HTML in the</span>
<a href="#l8.125"></a><span id="l8.125" class="difflineminus">-      // message get converted to sanitized form when a message is marked as</span>
<a href="#l8.126"></a><span id="l8.126" class="difflineminus">-      // junk. Furthermore, if we are about to move the message that was just</span>
<a href="#l8.127"></a><span id="l8.127" class="difflineminus">-      // marked as junk then don't bother reloading it.</span>
<a href="#l8.128"></a><span id="l8.128" class="difflineminus">-      if (!(isJunk &amp;&amp; moveJunkMail))</span>
<a href="#l8.129"></a><span id="l8.129" class="difflineplus">+      let junkScore = msgHdr.getStringProperty(&quot;junkscore&quot;);</span>
<a href="#l8.130"></a><span id="l8.130" class="difflineplus">+      let isJunk = (junkScore == Components.interfaces.nsIJunkMailPlugin.IS_SPAM_SCORE);</span>
<a href="#l8.131"></a><span id="l8.131" class="difflineplus">+</span>
<a href="#l8.132"></a><span id="l8.132" class="difflineplus">+      // If the current row  isn't going to change, reload to show sanitized or</span>
<a href="#l8.133"></a><span id="l8.133" class="difflineplus">+      // unsanitized. Otherwise we wouldn't see the reloaded version anyway.</span>
<a href="#l8.134"></a><span id="l8.134" class="difflineplus">+</span>
<a href="#l8.135"></a><span id="l8.135" class="difflineplus">+      // 1) When marking as non-junk, the msg would move back to the inbox.</span>
<a href="#l8.136"></a><span id="l8.136" class="difflineplus">+      // 2) When marking as junk, the msg will move or delete, if manualMark is set.</span>
<a href="#l8.137"></a><span id="l8.137" class="difflineplus">+      // 3) Marking as junk in the junk folder just changes the junk status.</span>
<a href="#l8.138"></a><span id="l8.138" class="difflineplus">+      if ((!isJunk &amp;&amp; folder.isSpecialFolder(Components.interfaces.nsMsgFolderFlags.Inbox)) ||</span>
<a href="#l8.139"></a><span id="l8.139" class="difflineplus">+          (isJunk &amp;&amp; !folder.server.spamSettings.manualMark) ||</span>
<a href="#l8.140"></a><span id="l8.140" class="difflineplus">+          (isJunk &amp;&amp; folder.isSpecialFolder(Components.interfaces.nsMsgFolderFlags.Junk)))</span>
<a href="#l8.141"></a><span id="l8.141">         ReloadMessage();</span>
<a href="#l8.142"></a><span id="l8.142">     }</span>
<a href="#l8.143"></a><span id="l8.143">   }</span>
<a href="#l8.144"></a><span id="l8.144"> }</span>
<a href="#l8.145"></a><span id="l8.145"> </span>
<a href="#l8.146"></a><span id="l8.146"> var gMessageNotificationBar =</span>
<a href="#l8.147"></a><span id="l8.147"> {</span>
<a href="#l8.148"></a><span id="l8.148">   mBarStatus: 0,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mail/base/content/mailWindowOverlay.xul</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mail/base/content/mailWindowOverlay.xul</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -1024,29 +1024,38 @@</span>
<a href="#l9.4"></a><span id="l9.4">             &lt;menuitem id=&quot;messagePaneVertical&quot; type=&quot;radio&quot; label=&quot;&amp;messagePaneVertical.label;&quot; name=&quot;viewlayoutgroup&quot;</span>
<a href="#l9.5"></a><span id="l9.5">                       accesskey=&quot;&amp;messagePaneVertical.accesskey;&quot; oncommand=&quot;ChangeMailLayout(kVerticalMailLayout);&quot;/&gt;</span>
<a href="#l9.6"></a><span id="l9.6">             &lt;menuseparator id=&quot;viewMenuAfterPaneVerticalSeparator&quot;/&gt;</span>
<a href="#l9.7"></a><span id="l9.7">             &lt;menuitem id=&quot;menu_showMessage&quot; type=&quot;checkbox&quot; label=&quot;&amp;showMessageCmd.label;&quot; key=&quot;key_toggleMessagePane&quot;</span>
<a href="#l9.8"></a><span id="l9.8">                       accesskey=&quot;&amp;showMessageCmd.accesskey;&quot; oncommand=&quot;MsgToggleMessagePane();&quot;/&gt;</span>
<a href="#l9.9"></a><span id="l9.9">           &lt;/menupopup&gt;</span>
<a href="#l9.10"></a><span id="l9.10">         &lt;/menu&gt;</span>
<a href="#l9.11"></a><span id="l9.11">         &lt;menu id=&quot;menu_FolderViews&quot; label=&quot;&amp;folderView.label;&quot; accesskey=&quot;&amp;folderView.accesskey;&quot;&gt;</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-          &lt;menupopup id=&quot;menu_FolderViewsPopup&quot; onpopupshowing=&quot;InitViewFolderViewsMenu(event)&quot;&gt;</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-            &lt;menuitem id=&quot;menu_allFolders&quot;      label=&quot;&amp;allFolders.label;&quot; accesskey=&quot;&amp;allFolders.accesskey;&quot;</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+          &lt;menupopup id=&quot;menu_FolderViewsPopup&quot;</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+                     onpopupshowing=&quot;InitViewFolderViewsMenu(event)&quot;&gt;</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+            &lt;menuitem id=&quot;menu_allFolders&quot; value=&quot;all&quot;</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+                      label=&quot;&amp;allFolders.label;&quot;</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+                      accesskey=&quot;&amp;allFolders.accesskey;&quot;</span>
<a href="#l9.19"></a><span id="l9.19">                       type=&quot;radio&quot; name=&quot;viewmessages&quot;</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineminus">-                      oncommand=&quot;gFolderTreeView.mode = 'all';&quot;/&gt;</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineminus">-            &lt;menuitem id=&quot;menu_unreadFolders&quot;   label=&quot;&amp;unreadFolders.label;&quot; accesskey=&quot;&amp;unreadFolders.accesskey;&quot;</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineplus">+                      oncommand=&quot;gFolderTreeView.mode = this.value;&quot;/&gt;</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineplus">+            &lt;menuitem id=&quot;menu_unreadFolders&quot;</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineplus">+                      label=&quot;&amp;unreadFolders.label;&quot; value=&quot;unread&quot;</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineplus">+                      accesskey=&quot;&amp;unreadFolders.accesskey;&quot;</span>
<a href="#l9.26"></a><span id="l9.26">                       type=&quot;radio&quot; name=&quot;viewmessages&quot;</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineminus">-                      oncommand=&quot;gFolderTreeView.mode = 'unread';&quot;/&gt;</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineminus">-            &lt;menuitem id=&quot;menu_favoriteFolders&quot; label=&quot;&amp;favoriteFolders.label;&quot; accesskey=&quot;&amp;favoriteFolders.accesskey;&quot;</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineplus">+                      oncommand=&quot;gFolderTreeView.mode = this.value;&quot;/&gt;</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineplus">+            &lt;menuitem id=&quot;menu_favoriteFolders&quot; value=&quot;favorite&quot;</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineplus">+                      label=&quot;&amp;favoriteFolders.label;&quot;</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+                      accesskey=&quot;&amp;favoriteFolders.accesskey;&quot;</span>
<a href="#l9.33"></a><span id="l9.33">                       type=&quot;radio&quot; name=&quot;viewmessages&quot;</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineminus">-                      oncommand=&quot;gFolderTreeView.mode = 'favorite';&quot;/&gt;</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineminus">-            &lt;menuitem id=&quot;menu_recentFolders&quot;   label=&quot;&amp;recentFolders.label;&quot; accesskey=&quot;&amp;recentFolders.accesskey;&quot;</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineplus">+                      oncommand=&quot;gFolderTreeView.mode = this.value;&quot;/&gt;</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineplus">+            &lt;menuitem id=&quot;menu_recentFolders&quot; value=&quot;recent&quot;</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineplus">+                      label=&quot;&amp;recentFolders.label;&quot;</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineplus">+                      accesskey=&quot;&amp;recentFolders.accesskey;&quot;</span>
<a href="#l9.40"></a><span id="l9.40">                       type=&quot;radio&quot; name=&quot;viewmessages&quot;</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineminus">-                      oncommand=&quot;gFolderTreeView.mode = 'recent';&quot;/&gt;</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineplus">+                      oncommand=&quot;gFolderTreeView.mode = this.value;&quot;/&gt;</span>
<a href="#l9.43"></a><span id="l9.43">           &lt;/menupopup&gt;</span>
<a href="#l9.44"></a><span id="l9.44">         &lt;/menu&gt;</span>
<a href="#l9.45"></a><span id="l9.45">         &lt;menuseparator id=&quot;viewSortMenuSeparator&quot;/&gt;</span>
<a href="#l9.46"></a><span id="l9.46">         &lt;menu id=&quot;viewSortMenu&quot; accesskey=&quot;&amp;sortMenu.accesskey;&quot; label=&quot;&amp;sortMenu.label;&quot;&gt;</span>
<a href="#l9.47"></a><span id="l9.47">           &lt;menupopup id=&quot;menu_viewSortPopup&quot; onpopupshowing=&quot;InitViewSortByMenu()&quot;&gt;</span>
<a href="#l9.48"></a><span id="l9.48">             &lt;menuitem id=&quot;sortByDateMenuitem&quot; type=&quot;radio&quot; name=&quot;sortby&quot; label=&quot;&amp;sortByDateCmd.label;&quot; accesskey=&quot;&amp;sortByDateCmd.accesskey;&quot; oncommand=&quot;MsgSortThreadPane('byDate')&quot;/&gt;</span>
<a href="#l9.49"></a><span id="l9.49">             &lt;menuitem id=&quot;sortByReceivedMenuitem&quot; type=&quot;radio&quot; name=&quot;sortby&quot; label=&quot;&amp;sortByReceivedCmd.label;&quot; accesskey=&quot;&amp;sortByReceivedCmd.accesskey;&quot; oncommand=&quot;MsgSortThreadPane('byReceived')&quot;/&gt;</span>
<a href="#l9.50"></a><span id="l9.50">             &lt;menuitem id=&quot;sortByFlagMenuitem&quot; type=&quot;radio&quot; name=&quot;sortby&quot; label=&quot;&amp;sortByStarCmd.label;&quot; accesskey=&quot;&amp;sortByStarCmd.accesskey;&quot; oncommand=&quot;MsgSortThreadPane('byFlagged')&quot;/&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mail/base/content/msgMail3PaneWindow.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mail/base/content/msgMail3PaneWindow.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -61,17 +61,16 @@ const kVerticalPaneConfig = 2;</span>
<a href="#l10.4"></a><span id="l10.4"> const kNumFolderViews = 4; // total number of folder views</span>
<a href="#l10.5"></a><span id="l10.5"> </span>
<a href="#l10.6"></a><span id="l10.6"> /** widget with id=messagepanebox, initialized by GetMessagePane() */</span>
<a href="#l10.7"></a><span id="l10.7"> var gMessagePane;</span>
<a href="#l10.8"></a><span id="l10.8"> /** widget with id=searchInput, initialized by GetSearchInput() */</span>
<a href="#l10.9"></a><span id="l10.9"> var gSearchInput;</span>
<a href="#l10.10"></a><span id="l10.10"> </span>
<a href="#l10.11"></a><span id="l10.11"> var gThreadAndMessagePaneSplitter = null;</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-var gCurrentFolderView;</span>
<a href="#l10.13"></a><span id="l10.13"> var gStartFolderUri = null;</span>
<a href="#l10.14"></a><span id="l10.14"> /**</span>
<a href="#l10.15"></a><span id="l10.15">  * Tracks whether the right mouse button changed the selection or not.  If the</span>
<a href="#l10.16"></a><span id="l10.16">  * user right clicks on the selection, it stays the same.  If they click outside</span>
<a href="#l10.17"></a><span id="l10.17">  * of it, we alter the selection (but not the current index) to be the row they</span>
<a href="#l10.18"></a><span id="l10.18">  * clicked on.</span>
<a href="#l10.19"></a><span id="l10.19">  *</span>
<a href="#l10.20"></a><span id="l10.20">  * The value of this variable is an object with &quot;view&quot; and &quot;selection&quot; keys</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mail/base/content/specialTabs.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mail/base/content/specialTabs.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -159,17 +159,17 @@ var specialTabs = {</span>
<a href="#l11.4"></a><span id="l11.4">     },</span>
<a href="#l11.5"></a><span id="l11.5">     restoreTab: function onRestoreTab(aTabmail, aPersistedState) {</span>
<a href="#l11.6"></a><span id="l11.6">       aTabmail.openTab(&quot;contentTab&quot;, { contentPage: aPersistedState.tabURI,</span>
<a href="#l11.7"></a><span id="l11.7">                                        background: true } );</span>
<a href="#l11.8"></a><span id="l11.8">     },</span>
<a href="#l11.9"></a><span id="l11.9">     onTitleChanged: function onTitleChanged(aTab) {</span>
<a href="#l11.10"></a><span id="l11.10">       aTab.title = aTab.browser.contentDocument.title;</span>
<a href="#l11.11"></a><span id="l11.11">     },</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-    supportsCommand: function supportsCommand(aTab, aCommand) {</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+    supportsCommand: function supportsCommand(aCommand, aTab) {</span>
<a href="#l11.14"></a><span id="l11.14">       switch (aCommand) {</span>
<a href="#l11.15"></a><span id="l11.15">         case &quot;cmd_fullZoomReduce&quot;:</span>
<a href="#l11.16"></a><span id="l11.16">         case &quot;cmd_fullZoomEnlarge&quot;:</span>
<a href="#l11.17"></a><span id="l11.17">         case &quot;cmd_fullZoomReset&quot;:</span>
<a href="#l11.18"></a><span id="l11.18">         case &quot;cmd_fullZoomToggle&quot;:</span>
<a href="#l11.19"></a><span id="l11.19">         case &quot;cmd_find&quot;:</span>
<a href="#l11.20"></a><span id="l11.20">         case &quot;cmd_findAgain&quot;:</span>
<a href="#l11.21"></a><span id="l11.21">         case &quot;cmd_findPrevious&quot;:</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineat">@@ -178,17 +178,17 @@ var specialTabs = {</span>
<a href="#l11.23"></a><span id="l11.23">         case &quot;button_print&quot;:</span>
<a href="#l11.24"></a><span id="l11.24">         // XXX print preview not currently supported - bug 497994 to implement.</span>
<a href="#l11.25"></a><span id="l11.25">         // case &quot;cmd_printpreview&quot;:</span>
<a href="#l11.26"></a><span id="l11.26">           return true;</span>
<a href="#l11.27"></a><span id="l11.27">         default:</span>
<a href="#l11.28"></a><span id="l11.28">           return false;</span>
<a href="#l11.29"></a><span id="l11.29">       }</span>
<a href="#l11.30"></a><span id="l11.30">     },</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineminus">-    isCommandEnabled: function isCommandEnabled(aTab, aCommand) {</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineplus">+    isCommandEnabled: function isCommandEnabled(aCommand, aTab) {</span>
<a href="#l11.33"></a><span id="l11.33">       switch (aCommand) {</span>
<a href="#l11.34"></a><span id="l11.34">         case &quot;cmd_fullZoomReduce&quot;:</span>
<a href="#l11.35"></a><span id="l11.35">         case &quot;cmd_fullZoomEnlarge&quot;:</span>
<a href="#l11.36"></a><span id="l11.36">         case &quot;cmd_fullZoomReset&quot;:</span>
<a href="#l11.37"></a><span id="l11.37">         case &quot;cmd_fullZoomToggle&quot;:</span>
<a href="#l11.38"></a><span id="l11.38">         case &quot;cmd_find&quot;:</span>
<a href="#l11.39"></a><span id="l11.39">         case &quot;cmd_findAgain&quot;:</span>
<a href="#l11.40"></a><span id="l11.40">         case &quot;cmd_findPrevious&quot;:</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineat">@@ -197,17 +197,17 @@ var specialTabs = {</span>
<a href="#l11.42"></a><span id="l11.42">         case &quot;button_print&quot;:</span>
<a href="#l11.43"></a><span id="l11.43">         // XXX print preview not currently supported - bug 497994 to implement.</span>
<a href="#l11.44"></a><span id="l11.44">         // case &quot;cmd_printpreview&quot;:</span>
<a href="#l11.45"></a><span id="l11.45">           return true;</span>
<a href="#l11.46"></a><span id="l11.46">         default:</span>
<a href="#l11.47"></a><span id="l11.47">           return false;</span>
<a href="#l11.48"></a><span id="l11.48">       }</span>
<a href="#l11.49"></a><span id="l11.49">     },</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineminus">-    doCommand: function isCommandEnabled(aTab, aCommand) {</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineplus">+    doCommand: function isCommandEnabled(aCommand, aTab) {</span>
<a href="#l11.52"></a><span id="l11.52">       switch (aCommand) {</span>
<a href="#l11.53"></a><span id="l11.53">         case &quot;cmd_fullZoomReduce&quot;:</span>
<a href="#l11.54"></a><span id="l11.54">           ZoomManager.reduce();</span>
<a href="#l11.55"></a><span id="l11.55">           break;</span>
<a href="#l11.56"></a><span id="l11.56">         case &quot;cmd_fullZoomEnlarge&quot;:</span>
<a href="#l11.57"></a><span id="l11.57">           ZoomManager.enlarge();</span>
<a href="#l11.58"></a><span id="l11.58">           break;</span>
<a href="#l11.59"></a><span id="l11.59">         case &quot;cmd_fullZoomReset&quot;:</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mail/base/content/specialTabs.xul</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mail/base/content/specialTabs.xul</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -31,21 +31,33 @@</span>
<a href="#l12.4"></a><span id="l12.4">    - use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l12.5"></a><span id="l12.5">    - decision by deleting the provisions above and replace them with the notice</span>
<a href="#l12.6"></a><span id="l12.6">    - and other provisions required by the LGPL or the GPL. If you do not delete</span>
<a href="#l12.7"></a><span id="l12.7">    - the provisions above, a recipient may use your version of this file under</span>
<a href="#l12.8"></a><span id="l12.8">    - the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l12.9"></a><span id="l12.9">    -</span>
<a href="#l12.10"></a><span id="l12.10">    - ***** END LICENSE BLOCK ***** --&gt;</span>
<a href="#l12.11"></a><span id="l12.11"> </span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+&lt;!DOCTYPE overlay [</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+&lt;!ENTITY % globalDTD SYSTEM &quot;chrome://global/locale/global.dtd&quot;&gt;</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+%globalDTD;</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+]&gt;</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineplus">+</span>
<a href="#l12.17"></a><span id="l12.17"> &lt;overlay id=&quot;specialTabs&quot;</span>
<a href="#l12.18"></a><span id="l12.18">          xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;&gt;</span>
<a href="#l12.19"></a><span id="l12.19"> </span>
<a href="#l12.20"></a><span id="l12.20" class="difflineplus">+  &lt;popupset id=&quot;mainPopupSet&quot;&gt;</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineplus">+    &lt;!-- for search and content formfill/pw manager --&gt;</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineplus">+    &lt;panel type=&quot;autocomplete&quot; id=&quot;PopupAutoComplete&quot; level=&quot;top&quot;</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineplus">+           noautofocus=&quot;true&quot; chromedir=&quot;&amp;locale.dir;&quot;/&gt;</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineplus">+  &lt;/popupset&gt;</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineplus">+</span>
<a href="#l12.26"></a><span id="l12.26">   &lt;vbox id=&quot;contentTab&quot; collapsed=&quot;true&quot;&gt;</span>
<a href="#l12.27"></a><span id="l12.27">     &lt;vbox flex=&quot;1&quot;&gt;</span>
<a href="#l12.28"></a><span id="l12.28">       &lt;notificationbox flex=&quot;1&quot;&gt;</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineminus">-        &lt;browser type=&quot;content-targetable&quot; flex=&quot;1&quot; disablehistory=&quot;true&quot;/&gt;</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineplus">+        &lt;browser type=&quot;content-targetable&quot; flex=&quot;1&quot; disablehistory=&quot;true&quot;</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineplus">+                 autocompletepopup=&quot;PopupAutoComplete&quot;/&gt;</span>
<a href="#l12.32"></a><span id="l12.32">       &lt;/notificationbox&gt;</span>
<a href="#l12.33"></a><span id="l12.33">       &lt;findbar/&gt;</span>
<a href="#l12.34"></a><span id="l12.34">     &lt;/vbox&gt;</span>
<a href="#l12.35"></a><span id="l12.35">   &lt;/vbox&gt;</span>
<a href="#l12.36"></a><span id="l12.36"> &lt;/overlay&gt;</span>
<a href="#l12.37"></a><span id="l12.37"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mail/base/content/tabmail.xml</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mail/base/content/tabmail.xml</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -200,25 +200,25 @@</span>
<a href="#l13.4"></a><span id="l13.4">     -     opened.  This may seem odd, but it should help keep your code simple</span>
<a href="#l13.5"></a><span id="l13.5">     -     while letting you do whatever you want.  Since openTab is synchronous</span>
<a href="#l13.6"></a><span id="l13.6">     -     and returns the tabInfo structure built for the tab, you can perform</span>
<a href="#l13.7"></a><span id="l13.7">     -     any additional work you need after the call to openTab.</span>
<a href="#l13.8"></a><span id="l13.8">     - * onTitleChanged(aTab): Called when someone calls tabmail.setTabTitle() to</span>
<a href="#l13.9"></a><span id="l13.9">     -     hint that the tab's title needs to be updated.  This function should</span>
<a href="#l13.10"></a><span id="l13.10">     -     update aTab.title if it can.</span>
<a href="#l13.11"></a><span id="l13.11">     - Mode definition functions to do with menu/toolbar commands:</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-    - * supportsCommand(aTab, aCommand): Called when a menu or toolbar needs to</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+    - * supportsCommand(aCommand, aTab): Called when a menu or toolbar needs to</span>
<a href="#l13.14"></a><span id="l13.14">     -     be updated. Return true if you support that command in</span>
<a href="#l13.15"></a><span id="l13.15">     -     isCommandEnabled and doCommand, return false otherwise.</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineminus">-    - * isCommandEnabled(aTab, aCommand): Called when a menu or toolbar needs</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineplus">+    - * isCommandEnabled(aCommand, aTab): Called when a menu or toolbar needs</span>
<a href="#l13.18"></a><span id="l13.18">     -     to be updated. Return true if the command can be executed at the</span>
<a href="#l13.19"></a><span id="l13.19">     -     current time, false otherwise.</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineminus">-    - * doCommand(aTab, aCommand): Called when a menu or toolbar command is to</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineplus">+    - * doCommand(aCommand, aTab): Called when a menu or toolbar command is to</span>
<a href="#l13.22"></a><span id="l13.22">     -     be executed. Perform the action appropriate to the command.</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineminus">-    - * onEvent(aTab, aEvent): This can be used to handle different events on</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineplus">+    - * onEvent(aEvent, aTab): This can be used to handle different events on</span>
<a href="#l13.25"></a><span id="l13.25">     -     the window.</span>
<a href="#l13.26"></a><span id="l13.26">     - * getBrowser(aTab): This function should return the browser element for</span>
<a href="#l13.27"></a><span id="l13.27">     -     your tab if there is one (return null or don't define this function</span>
<a href="#l13.28"></a><span id="l13.28">     -     otherwise). It is used for some toolkit functions that require a</span>
<a href="#l13.29"></a><span id="l13.29">     -     global &quot;getBrowser&quot; function, e.g. ZoomManager.</span>
<a href="#l13.30"></a><span id="l13.30">     -</span>
<a href="#l13.31"></a><span id="l13.31">     - Tab monitoring code is expected to be used for widgets on the screen</span>
<a href="#l13.32"></a><span id="l13.32">     -  outside of the tab box that need to update themselves as the active tab</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineat">@@ -968,17 +968,17 @@</span>
<a href="#l13.34"></a><span id="l13.34">              // This can happen if we're starting up and haven't got a tab</span>
<a href="#l13.35"></a><span id="l13.35">              // loaded yet.</span>
<a href="#l13.36"></a><span id="l13.36">              if (!tab)</span>
<a href="#l13.37"></a><span id="l13.37">                return false;</span>
<a href="#l13.38"></a><span id="l13.38"> </span>
<a href="#l13.39"></a><span id="l13.39">              let supportsCommandFunc = tab.mode.supportsCommand ||</span>
<a href="#l13.40"></a><span id="l13.40">                                        tab.mode.tabType.supportsCommand;</span>
<a href="#l13.41"></a><span id="l13.41">              if (supportsCommandFunc)</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineminus">-               return supportsCommandFunc.call(tab.mode.tabType, tab, aCommand);</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineplus">+               return supportsCommandFunc.call(tab.mode.tabType, aCommand, tab);</span>
<a href="#l13.44"></a><span id="l13.44"> </span>
<a href="#l13.45"></a><span id="l13.45">              return false;</span>
<a href="#l13.46"></a><span id="l13.46">            ]]&gt;</span>
<a href="#l13.47"></a><span id="l13.47">         &lt;/body&gt;</span>
<a href="#l13.48"></a><span id="l13.48">       &lt;/method&gt;</span>
<a href="#l13.49"></a><span id="l13.49">       &lt;method name=&quot;isCommandEnabled&quot;&gt;</span>
<a href="#l13.50"></a><span id="l13.50">         &lt;parameter name=&quot;aCommand&quot;/&gt;</span>
<a href="#l13.51"></a><span id="l13.51">         &lt;body&gt;</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineat">@@ -988,17 +988,17 @@</span>
<a href="#l13.53"></a><span id="l13.53">              // This can happen if we're starting up and haven't got a tab</span>
<a href="#l13.54"></a><span id="l13.54">              // loaded yet.</span>
<a href="#l13.55"></a><span id="l13.55">              if (!tab)</span>
<a href="#l13.56"></a><span id="l13.56">                return false;</span>
<a href="#l13.57"></a><span id="l13.57"> </span>
<a href="#l13.58"></a><span id="l13.58">              let isCommandEnabledFunc = tab.mode.isCommandEnabled ||</span>
<a href="#l13.59"></a><span id="l13.59">                                         tab.mode.tabType.isCommandEnabled;</span>
<a href="#l13.60"></a><span id="l13.60">              if (isCommandEnabledFunc)</span>
<a href="#l13.61"></a><span id="l13.61" class="difflineminus">-               return isCommandEnabledFunc.call(tab.mode.tabType, tab, aCommand);</span>
<a href="#l13.62"></a><span id="l13.62" class="difflineplus">+               return isCommandEnabledFunc.call(tab.mode.tabType, aCommand, tab);</span>
<a href="#l13.63"></a><span id="l13.63"> </span>
<a href="#l13.64"></a><span id="l13.64">              return false;</span>
<a href="#l13.65"></a><span id="l13.65">            ]]&gt;</span>
<a href="#l13.66"></a><span id="l13.66">         &lt;/body&gt;</span>
<a href="#l13.67"></a><span id="l13.67">       &lt;/method&gt;</span>
<a href="#l13.68"></a><span id="l13.68">       &lt;method name=&quot;doCommand&quot;&gt;</span>
<a href="#l13.69"></a><span id="l13.69">         &lt;parameter name=&quot;aCommand&quot;/&gt;</span>
<a href="#l13.70"></a><span id="l13.70">         &lt;body&gt;</span>
<a href="#l13.71"></a><span id="l13.71" class="difflineat">@@ -1008,17 +1008,17 @@</span>
<a href="#l13.72"></a><span id="l13.72">              // This can happen if we're starting up and haven't got a tab</span>
<a href="#l13.73"></a><span id="l13.73">              // loaded yet.</span>
<a href="#l13.74"></a><span id="l13.74">              if (!tab)</span>
<a href="#l13.75"></a><span id="l13.75">                return;</span>
<a href="#l13.76"></a><span id="l13.76"> </span>
<a href="#l13.77"></a><span id="l13.77">              let doCommandFunc = tab.mode.doCommand ||</span>
<a href="#l13.78"></a><span id="l13.78">                                  tab.mode.tabType.doCommand;</span>
<a href="#l13.79"></a><span id="l13.79">              if (doCommandFunc)</span>
<a href="#l13.80"></a><span id="l13.80" class="difflineminus">-               doCommandFunc.call(tab.mode.tabType, tab, aCommand);</span>
<a href="#l13.81"></a><span id="l13.81" class="difflineplus">+               doCommandFunc.call(tab.mode.tabType, aCommand, tab);</span>
<a href="#l13.82"></a><span id="l13.82">            ]]&gt;</span>
<a href="#l13.83"></a><span id="l13.83">         &lt;/body&gt;</span>
<a href="#l13.84"></a><span id="l13.84">       &lt;/method&gt;</span>
<a href="#l13.85"></a><span id="l13.85">       &lt;method name=&quot;onEvent&quot;&gt;</span>
<a href="#l13.86"></a><span id="l13.86">         &lt;parameter name=&quot;aEvent&quot;/&gt;</span>
<a href="#l13.87"></a><span id="l13.87">         &lt;body&gt;</span>
<a href="#l13.88"></a><span id="l13.88">            &lt;![CDATA[</span>
<a href="#l13.89"></a><span id="l13.89">              let tab = this.currentTabInfo;</span>
<a href="#l13.90"></a><span id="l13.90" class="difflineat">@@ -1026,17 +1026,17 @@</span>
<a href="#l13.91"></a><span id="l13.91">              // This can happen if we're starting up and haven't got a tab</span>
<a href="#l13.92"></a><span id="l13.92">              // loaded yet.</span>
<a href="#l13.93"></a><span id="l13.93">              if (!tab)</span>
<a href="#l13.94"></a><span id="l13.94">                return;</span>
<a href="#l13.95"></a><span id="l13.95"> </span>
<a href="#l13.96"></a><span id="l13.96">              let onEventFunc = tab.mode.onEvent ||</span>
<a href="#l13.97"></a><span id="l13.97">                                tab.mode.tabType.onEvent;</span>
<a href="#l13.98"></a><span id="l13.98">              if (onEventFunc)</span>
<a href="#l13.99"></a><span id="l13.99" class="difflineminus">-               return onEventFunc.call(tab.mode.tabType, tab, aEvent);</span>
<a href="#l13.100"></a><span id="l13.100" class="difflineplus">+               return onEventFunc.call(tab.mode.tabType, aEvent, tab);</span>
<a href="#l13.101"></a><span id="l13.101"> </span>
<a href="#l13.102"></a><span id="l13.102">              return false;</span>
<a href="#l13.103"></a><span id="l13.103">            ]]&gt;</span>
<a href="#l13.104"></a><span id="l13.104">         &lt;/body&gt;</span>
<a href="#l13.105"></a><span id="l13.105">       &lt;/method&gt;</span>
<a href="#l13.106"></a><span id="l13.106">       &lt;!-- Set the document title based on the tab title --&gt;</span>
<a href="#l13.107"></a><span id="l13.107">       &lt;method name=&quot;setDocumentTitle&quot;&gt;</span>
<a href="#l13.108"></a><span id="l13.108">         &lt;parameter name=&quot;aTab&quot;/&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mail/components/search/content/searchCommon.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mail/components/search/content/searchCommon.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -404,41 +404,60 @@ let SearchSupport =</span>
<a href="#l14.4"></a><span id="l14.4">       this.__foldersToIndex = this._foldersToIndexGenerator();</span>
<a href="#l14.5"></a><span id="l14.5">     return this.__foldersToIndex;</span>
<a href="#l14.6"></a><span id="l14.6">   },</span>
<a href="#l14.7"></a><span id="l14.7"> </span>
<a href="#l14.8"></a><span id="l14.8">   _findNextHdrToIndex: function search_find_next_header()</span>
<a href="#l14.9"></a><span id="l14.9">   {</span>
<a href="#l14.10"></a><span id="l14.10">     try</span>
<a href="#l14.11"></a><span id="l14.11">     {</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineplus">+      let reindexTime = this._getLastReindexTime(this._currentFolderToIndex);</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+      this._log.debug(&quot;Reindex time for this folder is &quot; + reindexTime);</span>
<a href="#l14.14"></a><span id="l14.14">       if (!this._headerEnumerator)</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineminus">-        this._headerEnumerator = this._currentFolderToIndex.messages;</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineplus">+      {</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineplus">+        //  we need to create search terms for messages to index</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineplus">+        let searchSession = Cc[&quot;@mozilla.org/messenger/searchSession;1&quot;]</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineplus">+                              .createInstance(Ci.nsIMsgSearchSession);</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineplus">+        let searchTerms = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineplus">+</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineplus">+        searchSession.addScopeTerm(Ci.nsMsgSearchScope.offlineMail, this._currentFolderToIndex);</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineplus">+        let nsMsgSearchAttrib = Ci.nsMsgSearchAttrib;</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineplus">+        let nsMsgSearchOp = Ci.nsMsgSearchOp;</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineplus">+        // first term: (_hdrIndexProperty &lt; reindexTime)</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineplus">+        let searchTerm = searchSession.createTerm();</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineplus">+        searchTerm.booleanAnd = false; // actually don't care here</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineplus">+        searchTerm.attrib = nsMsgSearchAttrib.Uint32HdrProperty;</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineplus">+        searchTerm.op = nsMsgSearchOp.IsLessThan;</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineplus">+        value = searchTerm.value;</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineplus">+        value.attrib = searchTerm.attrib;</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineplus">+        searchTerm.hdrProperty = this._hdrIndexedProperty;</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineplus">+        value.status = reindexTime;</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineplus">+        searchTerm.value = value;</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineplus">+        searchTerms.appendElement(searchTerm, false);</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineplus">+        this._headerEnumerator = this._currentFolderToIndex.msgDatabase</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineplus">+                                 .getFilterEnumerator(searchTerms);</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineplus">+      }</span>
<a href="#l14.39"></a><span id="l14.39"> </span>
<a href="#l14.40"></a><span id="l14.40">       // iterate over the folder finding the next message to index</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineminus">-      let reindexTime = this._getLastReindexTime(this._currentFolderToIndex);</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineminus">-      this._log.debug(&quot;Reindex time for this folder is &quot; + reindexTime);</span>
<a href="#l14.43"></a><span id="l14.43">       while (this._headerEnumerator.hasMoreElements())</span>
<a href="#l14.44"></a><span id="l14.44">       {</span>
<a href="#l14.45"></a><span id="l14.45">         let msgHdr = this._headerEnumerator.getNext()</span>
<a href="#l14.46"></a><span id="l14.46">                          .QueryInterface(Ci.nsIMsgDBHdr);</span>
<a href="#l14.47"></a><span id="l14.47"> </span>
<a href="#l14.48"></a><span id="l14.48" class="difflineminus">-        if (msgHdr.getUint32Property(this._hdrIndexedProperty) &lt; reindexTime)</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineplus">+        // Check if the file exists. If it does, then assume indexing to be</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineplus">+        // complete for this file</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineplus">+        if (this._getSupportFile(msgHdr).exists())</span>
<a href="#l14.52"></a><span id="l14.52">         {</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineminus">-          // Check if the file exists. If it does, then assume indexing to be</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineminus">-          // complete for this file</span>
<a href="#l14.55"></a><span id="l14.55" class="difflineminus">-          if (this._getSupportFile(msgHdr).exists())</span>
<a href="#l14.56"></a><span id="l14.56" class="difflineminus">-          {</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineminus">-            this._log.debug(&quot;Message time not set but file exists; setting &quot; +</span>
<a href="#l14.58"></a><span id="l14.58" class="difflineminus">-                            &quot;time to &quot; + reindexTime);</span>
<a href="#l14.59"></a><span id="l14.59" class="difflineminus">-            msgHdr.setUint32Property(this._hdrIndexedProperty, reindexTime);</span>
<a href="#l14.60"></a><span id="l14.60" class="difflineminus">-          }</span>
<a href="#l14.61"></a><span id="l14.61" class="difflineminus">-          else</span>
<a href="#l14.62"></a><span id="l14.62" class="difflineminus">-          {</span>
<a href="#l14.63"></a><span id="l14.63" class="difflineminus">-            return [msgHdr, reindexTime];</span>
<a href="#l14.64"></a><span id="l14.64" class="difflineminus">-          }</span>
<a href="#l14.65"></a><span id="l14.65" class="difflineplus">+          this._log.debug(&quot;Message time not set but file exists; setting &quot; +</span>
<a href="#l14.66"></a><span id="l14.66" class="difflineplus">+                          &quot;time to &quot; + reindexTime);</span>
<a href="#l14.67"></a><span id="l14.67" class="difflineplus">+          msgHdr.setUint32Property(this._hdrIndexedProperty, reindexTime);</span>
<a href="#l14.68"></a><span id="l14.68" class="difflineplus">+        }</span>
<a href="#l14.69"></a><span id="l14.69" class="difflineplus">+        else</span>
<a href="#l14.70"></a><span id="l14.70" class="difflineplus">+        {</span>
<a href="#l14.71"></a><span id="l14.71" class="difflineplus">+          return [msgHdr, reindexTime];</span>
<a href="#l14.72"></a><span id="l14.72">         }</span>
<a href="#l14.73"></a><span id="l14.73">       }</span>
<a href="#l14.74"></a><span id="l14.74">     }</span>
<a href="#l14.75"></a><span id="l14.75">     catch(ex) { this._log.debug(&quot;Error while finding next header: &quot; + ex); }</span>
<a href="#l14.76"></a><span id="l14.76"> </span>
<a href="#l14.77"></a><span id="l14.77">     // If we couldn't find any headers to index, null out the enumerator</span>
<a href="#l14.78"></a><span id="l14.78">     this._headerEnumerator = null;</span>
<a href="#l14.79"></a><span id="l14.79">     if (! (this._currentFolderToIndex.flags &amp; Ci.nsMsgFolderFlags.Inbox))</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mail/confvars.sh</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mail/confvars.sh</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -36,19 +36,19 @@</span>
<a href="#l15.4"></a><span id="l15.4"> #</span>
<a href="#l15.5"></a><span id="l15.5"> # ***** END LICENSE BLOCK *****</span>
<a href="#l15.6"></a><span id="l15.6"> </span>
<a href="#l15.7"></a><span id="l15.7"> MOZ_APP_NAME=thunderbird</span>
<a href="#l15.8"></a><span id="l15.8"> MOZ_UPDATER=1</span>
<a href="#l15.9"></a><span id="l15.9"> MOZ_THUNDERBIRD=1</span>
<a href="#l15.10"></a><span id="l15.10"> MOZ_NO_ACTIVEX_SUPPORT=1</span>
<a href="#l15.11"></a><span id="l15.11"> MOZ_ACTIVEX_SCRIPTING_SUPPORT=</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-if test &quot;$MOZILLA_BRANCH_VERSION&quot; = &quot;1.9.1&quot;; then</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+# MOZ_OJI is only required to be cleared for MOZILLA_1_9_1_BRANCH.</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineplus">+# mozilla-central does not have this.</span>
<a href="#l15.15"></a><span id="l15.15"> MOZ_OJI=</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineminus">-fi</span>
<a href="#l15.17"></a><span id="l15.17"> NECKO_PROTOCOLS_DEFAULT=&quot;about data file ftp http res viewsource&quot;</span>
<a href="#l15.18"></a><span id="l15.18"> MOZ_IMG_DECODERS_DEFAULT=`echo &quot;$MOZ_IMG_DECODERS_DEFAULT&quot; | sed &quot;s/ xbm//&quot;`</span>
<a href="#l15.19"></a><span id="l15.19"> MOZ_MAIL_NEWS=1</span>
<a href="#l15.20"></a><span id="l15.20"> if [ &quot;$COMM_BUILD&quot; ]; then</span>
<a href="#l15.21"></a><span id="l15.21">   MOZ_LDAP_XPCOM=1</span>
<a href="#l15.22"></a><span id="l15.22"> fi</span>
<a href="#l15.23"></a><span id="l15.23"> MOZ_STATIC_MAIL_BUILD=1</span>
<a href="#l15.24"></a><span id="l15.24"> MOZ_COMPOSER=1</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mail/installer/removed-files.in</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mail/installer/removed-files.in</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -45,22 +45,31 @@ components/accessibility-atk.xpt</span>
<a href="#l16.4"></a><span id="l16.4"> components/airbag.xpt</span>
<a href="#l16.5"></a><span id="l16.5"> components/bookmarks.xpt</span>
<a href="#l16.6"></a><span id="l16.6"> components/downloadmanager.xpt</span>
<a href="#l16.7"></a><span id="l16.7"> components/compreg.dat</span>
<a href="#l16.8"></a><span id="l16.8"> components/history.xpt</span>
<a href="#l16.9"></a><span id="l16.9"> components/jsconsole.xpt</span>
<a href="#l16.10"></a><span id="l16.10"> components/mailnews.xpt</span>
<a href="#l16.11"></a><span id="l16.11"> components/mozgnome.xpt</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineplus">+#ifdef MOZILLA_1_9_1_BRANCH</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+components/satchel.xpt</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineplus">+#endif</span>
<a href="#l16.15"></a><span id="l16.15"> components/@DLL_PREFIX@myspell@DLL_SUFFIX@</span>
<a href="#l16.16"></a><span id="l16.16"> components/necko_data.xpt</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineplus">+#ifdef MOZILLA_1_9_1_BRANCH</span>
<a href="#l16.18"></a><span id="l16.18" class="difflineplus">+components/GPSDGeolocationProvider.js</span>
<a href="#l16.19"></a><span id="l16.19" class="difflineplus">+#endif</span>
<a href="#l16.20"></a><span id="l16.20"> components/nsBackgroundUpdateService.js</span>
<a href="#l16.21"></a><span id="l16.21"> components/nsCloseAllWindows.js</span>
<a href="#l16.22"></a><span id="l16.22"> components/nsComposerCmdLineHandler.js</span>
<a href="#l16.23"></a><span id="l16.23"> components/nsDownloadProgressListener.js</span>
<a href="#l16.24"></a><span id="l16.24" class="difflineplus">+#ifdef MOZILLA_1_9_1_BRANCH</span>
<a href="#l16.25"></a><span id="l16.25" class="difflineplus">+components/nsFormAutoComplete.js</span>
<a href="#l16.26"></a><span id="l16.26" class="difflineplus">+#endif</span>
<a href="#l16.27"></a><span id="l16.27"> components/nsInterfaceInfoToIDL.js</span>
<a href="#l16.28"></a><span id="l16.28"> components/nsLDAPPrefsService.js</span>
<a href="#l16.29"></a><span id="l16.29"> #ifdef XP_WIN</span>
<a href="#l16.30"></a><span id="l16.30"> #ifndef MOZILLA_1_9_1_BRANCH</span>
<a href="#l16.31"></a><span id="l16.31"> components/nsPostUpdateWin.js</span>
<a href="#l16.32"></a><span id="l16.32"> #endif</span>
<a href="#l16.33"></a><span id="l16.33"> #endif</span>
<a href="#l16.34"></a><span id="l16.34"> components/nsScriptableIO.js</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mail/installer/windows/packages-static</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mail/installer/windows/packages-static</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -278,16 +278,19 @@ bin\components\pref.xpt</span>
<a href="#l17.4"></a><span id="l17.4"> ; profile</span>
<a href="#l17.5"></a><span id="l17.5"> bin\components\profile.xpt</span>
<a href="#l17.6"></a><span id="l17.6"> bin\components\toolkitprofile.xpt</span>
<a href="#l17.7"></a><span id="l17.7"> </span>
<a href="#l17.8"></a><span id="l17.8"> ; toolkit</span>
<a href="#l17.9"></a><span id="l17.9"> bin\components\commandlines.xpt</span>
<a href="#l17.10"></a><span id="l17.10"> bin\components\chrome.xpt</span>
<a href="#l17.11"></a><span id="l17.11"> bin\components\nsDefaultCLH.js</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineplus">+#ifndef MOZILLA_1_9_1_BRANCH</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+bin\components\nsFormAutoComplete.js</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineplus">+#endif</span>
<a href="#l17.15"></a><span id="l17.15"> </span>
<a href="#l17.16"></a><span id="l17.16"> ; rdf</span>
<a href="#l17.17"></a><span id="l17.17"> bin\components\rdf.xpt</span>
<a href="#l17.18"></a><span id="l17.18"> </span>
<a href="#l17.19"></a><span id="l17.19"> ; required i18n libraries</span>
<a href="#l17.20"></a><span id="l17.20"> bin\components\intl.xpt</span>
<a href="#l17.21"></a><span id="l17.21"> bin\components\locale.xpt</span>
<a href="#l17.22"></a><span id="l17.22"> bin\components\uconv.xpt</span>
<a href="#l17.23"></a><span id="l17.23" class="difflineat">@@ -313,16 +316,19 @@ bin\components\dom_storage.xpt</span>
<a href="#l17.24"></a><span id="l17.24"> bin\components\dom_stylesheets.xpt</span>
<a href="#l17.25"></a><span id="l17.25"> bin\components\dom_threads.xpt</span>
<a href="#l17.26"></a><span id="l17.26"> bin\components\dom_traversal.xpt</span>
<a href="#l17.27"></a><span id="l17.27"> bin\components\dom_views.xpt</span>
<a href="#l17.28"></a><span id="l17.28"> bin\components\dom_xbl.xpt</span>
<a href="#l17.29"></a><span id="l17.29"> bin\components\dom_xul.xpt</span>
<a href="#l17.30"></a><span id="l17.30"> bin\components\dom_loadsave.xpt</span>
<a href="#l17.31"></a><span id="l17.31"> bin\components\NetworkGeolocationProvider.js</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineplus">+#ifndef MOZILLA_1_9_1_BRANCH</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineplus">+bin\components\GPSDGeolocationProvider.js</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineplus">+#endif</span>
<a href="#l17.35"></a><span id="l17.35"> </span>
<a href="#l17.36"></a><span id="l17.36"> ; editor / composer for HTML compose</span>
<a href="#l17.37"></a><span id="l17.37"> bin\components\editor.xpt</span>
<a href="#l17.38"></a><span id="l17.38"> bin\components\composer.xpt</span>
<a href="#l17.39"></a><span id="l17.39"> bin\components\txmgr.xpt</span>
<a href="#l17.40"></a><span id="l17.40"> </span>
<a href="#l17.41"></a><span id="l17.41"> ; find functionality</span>
<a href="#l17.42"></a><span id="l17.42"> ; Optional - only if your code uses nsIWebBrowserFind</span>
<a href="#l17.43"></a><span id="l17.43" class="difflineat">@@ -409,16 +415,19 @@ bin\components\windowds.xpt</span>
<a href="#l17.44"></a><span id="l17.44"> bin\components\dom_xpath.xpt</span>
<a href="#l17.45"></a><span id="l17.45"> bin\AccessibleMarshal.dll</span>
<a href="#l17.46"></a><span id="l17.46"> bin\components\lwbrk.xpt</span>
<a href="#l17.47"></a><span id="l17.47"> bin\components\nsTryToClose.js</span>
<a href="#l17.48"></a><span id="l17.48"> bin\components\pluginGlue.js</span>
<a href="#l17.49"></a><span id="l17.49"> bin\components\txEXSLTRegExFunctions.js</span>
<a href="#l17.50"></a><span id="l17.50"> bin\components\feeds.xpt</span>
<a href="#l17.51"></a><span id="l17.51"> bin\components\saxparser.xpt</span>
<a href="#l17.52"></a><span id="l17.52" class="difflineplus">+#ifndef MOZILLA_1_9_1_BRANCH</span>
<a href="#l17.53"></a><span id="l17.53" class="difflineplus">+bin\components\satchel.xpt</span>
<a href="#l17.54"></a><span id="l17.54" class="difflineplus">+#endif</span>
<a href="#l17.55"></a><span id="l17.55"> bin\components\shistory.xpt</span>
<a href="#l17.56"></a><span id="l17.56"> bin\components\zipwriter.xpt</span>
<a href="#l17.57"></a><span id="l17.57"> bin\components\nsBadCertHandler.js</span>
<a href="#l17.58"></a><span id="l17.58"> bin\components\cookie.xpt</span>
<a href="#l17.59"></a><span id="l17.59"> bin\components\places.xpt</span>
<a href="#l17.60"></a><span id="l17.60"> bin\components\prefetch.xpt</span>
<a href="#l17.61"></a><span id="l17.61"> </span>
<a href="#l17.62"></a><span id="l17.62"> bin\res\hiddenWindow.html</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mail/themes/gnomestripe/mail/folderPane.css</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mail/themes/gnomestripe/mail/folderPane.css</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -135,17 +135,16 @@ treechildren::-moz-tree-image(folderName</span>
<a href="#l18.4"></a><span id="l18.4"> </span>
<a href="#l18.5"></a><span id="l18.5"> .tabmail-tab[type=&quot;folder&quot;][SpecialFolder=&quot;Archive&quot;] &gt; .tab-image-middle &gt; .tab-icon &gt; .tab-icon-image,</span>
<a href="#l18.6"></a><span id="l18.6"> treechildren::-moz-tree-image(folderNameCol, specialFolder-Archive) {</span>
<a href="#l18.7"></a><span id="l18.7">   background-image: url(&quot;chrome://messenger/skin/icons/folder-pane.png&quot;);</span>
<a href="#l18.8"></a><span id="l18.8">   background-position: left -192px;</span>
<a href="#l18.9"></a><span id="l18.9">   list-style-image: url(&quot;chrome://messenger/skin/icons/folder-blank.png&quot;);</span>
<a href="#l18.10"></a><span id="l18.10"> }</span>
<a href="#l18.11"></a><span id="l18.11"> </span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-</span>
<a href="#l18.13"></a><span id="l18.13"> /* ..... Shared folders .....</span>
<a href="#l18.14"></a><span id="l18.14"> </span>
<a href="#l18.15"></a><span id="l18.15"> treechildren::-moz-tree-image(folderNameCol, imapShared-true) {</span>
<a href="#l18.16"></a><span id="l18.16">   -moz-image-region: rect(0 192px 16px 176px);</span>
<a href="#l18.17"></a><span id="l18.17"> }</span>
<a href="#l18.18"></a><span id="l18.18"> </span>
<a href="#l18.19"></a><span id="l18.19"> */ </span>
<a href="#l18.20"></a><span id="l18.20"> </span>
<a href="#l18.21"></a><span id="l18.21" class="difflineat">@@ -153,16 +152,23 @@ treechildren::-moz-tree-image(folderName</span>
<a href="#l18.22"></a><span id="l18.22"> </span>
<a href="#l18.23"></a><span id="l18.23"> .tabmail-tab[type=&quot;folder&quot;][SpecialFolder=&quot;Virtual&quot;] &gt; .tab-image-middle &gt; .tab-icon &gt; .tab-icon-image,</span>
<a href="#l18.24"></a><span id="l18.24"> treechildren::-moz-tree-image(folderNameCol, specialFolder-Virtual) {</span>
<a href="#l18.25"></a><span id="l18.25">   background-image: url(&quot;chrome://messenger/skin/icons/folder-pane.png&quot;);</span>
<a href="#l18.26"></a><span id="l18.26">   background-position: left -128px;</span>
<a href="#l18.27"></a><span id="l18.27">   list-style-image: url(&quot;chrome://messenger/skin/icons/folder-blank.png&quot;);</span>
<a href="#l18.28"></a><span id="l18.28"> }</span>
<a href="#l18.29"></a><span id="l18.29"> </span>
<a href="#l18.30"></a><span id="l18.30" class="difflineplus">+/* .....  Newsgroup .....  */</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineplus">+.tabmail-tab[type=&quot;folder&quot;][ServerType=&quot;nntp&quot;] &gt; .tab-image-middle &gt; .tab-icon &gt; .tab-icon-image {</span>
<a href="#l18.32"></a><span id="l18.32" class="difflineplus">+  background-image: url(&quot;chrome://messenger/skin/icons/folder-pane.png&quot;);</span>
<a href="#l18.33"></a><span id="l18.33" class="difflineplus">+  background-position: left -208px;</span>
<a href="#l18.34"></a><span id="l18.34" class="difflineplus">+  list-style-image: url(&quot;chrome://messenger/skin/icons/folder-blank.png&quot;);</span>
<a href="#l18.35"></a><span id="l18.35" class="difflineplus">+}</span>
<a href="#l18.36"></a><span id="l18.36" class="difflineplus">+</span>
<a href="#l18.37"></a><span id="l18.37"> /* ..... Account nodes ..... */</span>
<a href="#l18.38"></a><span id="l18.38"> .tabmail-tab[type=&quot;folder&quot;][IsServer=&quot;true&quot;] &gt; .tab-image-middle &gt; .tab-icon &gt; .tab-icon-image {</span>
<a href="#l18.39"></a><span id="l18.39">   -moz-margin-start: 0px;</span>
<a href="#l18.40"></a><span id="l18.40">   background-image: url(&quot;chrome://messenger/skin/icons/folder-pane.png&quot;);</span>
<a href="#l18.41"></a><span id="l18.41">   background-position: left -16px;</span>
<a href="#l18.42"></a><span id="l18.42">   list-style-image: url(&quot;chrome://messenger/skin/icons/folder-blank.png&quot;);</span>
<a href="#l18.43"></a><span id="l18.43"> }</span>
<a href="#l18.44"></a><span id="l18.44"> </span>
<a href="#l18.45"></a><span id="l18.45" class="difflineat">@@ -188,23 +194,16 @@ treechildren::-moz-tree-image(folderName</span>
<a href="#l18.46"></a><span id="l18.46"> </span>
<a href="#l18.47"></a><span id="l18.47"> /* ..... Secure news server ..... */</span>
<a href="#l18.48"></a><span id="l18.48"> .tabmail-tab[type=&quot;folder&quot;][IsServer=&quot;true&quot;][ServerType=&quot;nntp&quot;][IsSecure=&quot;true&quot;] &gt; .tab-image-middle &gt; .tab-icon &gt; .tab-icon-image {</span>
<a href="#l18.49"></a><span id="l18.49">   background-image: none;</span>
<a href="#l18.50"></a><span id="l18.50">   list-style-image: url(&quot;chrome://messenger/skin/icons/server.png&quot;);</span>
<a href="#l18.51"></a><span id="l18.51">   -moz-image-region: rect(0 80px 16px 64px);</span>
<a href="#l18.52"></a><span id="l18.52"> }</span>
<a href="#l18.53"></a><span id="l18.53"> </span>
<a href="#l18.54"></a><span id="l18.54" class="difflineminus">-/* .....  Newsgroup .....  */</span>
<a href="#l18.55"></a><span id="l18.55" class="difflineminus">-.tabmail-tab[type=&quot;folder&quot;][ServerType=&quot;nntp&quot;] &gt; .tab-image-middle &gt; .tab-icon &gt; .tab-icon-image {</span>
<a href="#l18.56"></a><span id="l18.56" class="difflineminus">-  background-image: none;</span>
<a href="#l18.57"></a><span id="l18.57" class="difflineminus">-  list-style-image: url(&quot;chrome://messenger/skin/icons/server.png&quot;);</span>
<a href="#l18.58"></a><span id="l18.58" class="difflineminus">-  -moz-image-region: rect(0 160px 16px 144px);</span>
<a href="#l18.59"></a><span id="l18.59" class="difflineminus">-}</span>
<a href="#l18.60"></a><span id="l18.60" class="difflineminus">-</span>
<a href="#l18.61"></a><span id="l18.61"> treechildren::-moz-tree-image(folderNameCol, specialFolder-Virtual, newMessages-true) {</span>
<a href="#l18.62"></a><span id="l18.62">   list-style-image: url(&quot;chrome://messenger/skin/icons/folder.png&quot;);</span>
<a href="#l18.63"></a><span id="l18.63">   -moz-image-region: rect(16px 176px 32px 160px);</span>
<a href="#l18.64"></a><span id="l18.64"> }</span>
<a href="#l18.65"></a><span id="l18.65"> </span>
<a href="#l18.66"></a><span id="l18.66"> treechildren::-moz-tree-cell-text(folderNameCol, newMessages-true),</span>
<a href="#l18.67"></a><span id="l18.67"> treechildren::-moz-tree-cell-text(folderNameCol, specialFolder-Inbox, newMessages-true) {</span>
<a href="#l18.68"></a><span id="l18.68">   font-weight: bold;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1">index 106eba272d621db42bfc67d0ffaee5da67ed5fe4..5427e77b8ffc21649cd8b7884421eadc2c86f2b5</span>
<a href="#l19.2"></a><span id="l19.2">GIT binary patch
literal 6546
zc$@)}8Exi?P)&lt;h;3K|Lk000e1NJLTq000mG007_!1^@s63Ss7W00001b5ch_0Itp)
z=&gt;Px#24YJ`L;(K){{a7&gt;y{D4^000SaNLh0L01FcU01FcV0GgZ_00007bV*G`2iXT7
z2q`ouUPgET02vZVL_t(&amp;-tC)rm{vuW|36jtzNvF0=g`oosD!})0)k&gt;f)ODR;_#rrk
zaes`XGUKeP4!AlfhB1vJm}VT;urf1&lt;2^7&gt;pf}*H^3f(9YyPMA8P50ia+CSdF+jKY3
zJNw5zzvoxaQ_sD(-a6kpRdwprsZ-|_B-6tWKYWR0S&lt;eU|BwZw948U#k=FNLDRVGp|
zk38~7+qAQ$X6NMO;&lt;~y6v26=H*Wt}K-ceG@?0NI%#R2Rzk`Pv5VF6cN{WpTSAOsi^
zPk?x&lt;;F%&gt;CBLp-wG^880+qWa|gu*U%5eS3;Ap|XLQR-_9t*vp);hd%Whrt*_+=DjP
zj}YK`ih~WU#2pVS9z-ckJQnX9pt-3TV+@|Qh?oGLr-?Z(R#p*NS)gMIV+@UrjRb?i
zP5_#l0fBG@ZM)oLsZ5Wu9W&amp;(S254$(vI+`vP6O7o188b$(oWpr^;a+HY8G)_m&amp;V3M
zQ`)2OrF-sKaK-Jn-}P=9ps}&amp;&gt;#_O)VeyPC-jFHA98aKwI=3jv!6v|qVo0GHG_W5rG
z-W7+pa=}FxOdB_5?5eA0&amp;ymGNMKrfG^X8jxs1&lt;L#dE1KRD;@xN;)y46Y@cWh1#=3-
zL$5v*DvlRa219|qQc9#Hks|T5q=l3MDXkP2NGU&lt;EqiSze?d;jtOtPKbk?Fn1l$V}x
z{0aDcer(&amp;uXZx@$8!0U?25mIaXp~4af+Z#E*MC%|jCwvHp|&lt;~r1$l-3NF&gt;IAs-5I!
z=OqPPB!sA?g@FSGpp;_&amp;fqnGvKajkFLUvSCx&amp;XE%&lt;@p5#1z-&amp;Q`wYO-s@&lt;66=jGwL
zE+7~(cqp-WoZdZqiGbht6W~ExDYa+C8?Q?t1jm|;F&lt;_|X|BWP8t$yn)Ddn?Dseaud
zv@C0%)_M-_y}xpAI2&lt;&lt;JO&gt;J$h=Dqjd*=sB1^$P?7M4}Nw!5|&gt;g@}I~${jPQ5JMP5E
z%gskA)lVkbAr_5t@L&amp;x}d1$TBTBEgY2L^_QhI-&lt;$7?x$Blp?Kxv$C&gt;qU5_0V+wnXP
zrBYd?bLGwolu~48XQ!8U8o={B3JMAcg|gYOaXqf&lt;qLhc{d3c`7$DeE@J3E_#f&amp;!FM
zX#hL5$~@0at~P&lt;^d8}OZ4r5L}8Gy~7ZzeB4A1NhT&gt;vjspc3m$mp3N=I)YQ~4ZtOVf
z&gt;g)O7?;ij#Y2su`ii@eJtUw4seqMeOz{B?3M9bkw7$@#fHoOdglHy`6p4DExl?^YW
zwzigVBurspabgS-eN|Y}qO`R1r~*`4T8bqTGmsjCeQj;6{d)KA+bt1pY-#}5XUAf(
zIV;}$+p~`A_Dj#XZZAZ-U0EXAwzbc3-8ugYR^y`k?=k-ffDQ1g`TzRgBEE0&amp;y@$58
zg9i_Gi?~OR9v$t2yYIdmfN|r-@#&amp;|Zrr*y!_gnzpe*0~J^mk(W?Ifj$4}b4+3{vTi
zJMK7Q&lt;;&lt;2l1xT@&amp;NpN`C;XwA`KMoi$0DwJv_H@~5mmGAKj+q0;aXM6V9EWMsrgd80
zB?l?iQ)$hbH5~xXJoC&amp;nNE#sSI82%}DQR6M9!}h0!h{K6%pr?2$w3DICm!d64?dtB
zf}kC7qR231@&gt;Ei)&amp;&lt;3cjt0NwFIQ7(1@jNeSTo^C{1lX3HY0RRGO4dsNy!PdnUtBt&gt;
zd{kOpAA^O!XP&lt;2XSS&lt;h+-G9$V!0FvxjJN&amp;r_S@{Io_gxF&gt;gww5694e7yY6}wfCUQ{
zbbDuBuwa4dAP4pJ_32$F(_Tuw3n8#9i~Rij&amp;P7&gt;kO+`gTJA!t)PYBA(%a6PkMvNG7
zL=KL)n1m4RIOw2#kA;J&gt;va(KEjA2Y5VIv=HIagLzw)=79$dNz@hylT)ccC*5gb)Z3
zIyQw;QBiTk!Ao#-lv(JU195Z?gb?i5v7^(LQ={J*P^TPp269w6C@L!Y?`^InB_(ez
zT)6Q3?huufl)UmkXCHL+!&gt;pzLddsr20F?4PV&lt;&gt;t3S|{F}jV15e^Y5~a@L2Ntzbj=_
zr;W)Yu_q;b(DVq}bge7xMfcxxS|AYkeWUrld~4QoeubN~T-){30u#M(i609eqa$;j
z0x_T&gt;9*_Tv9S8)T`r$wS`1l?@da~ufEEcW#XJ(&amp;wGYELU=@9^~yXbZ&gt;@W;0w;+Ioi
z;l#ev{M9v8$G`fYFFz+8#~InPXD`~qtqjf^%eCVl=Y^GzV2c3ScquK;pI1G~|2cUv
zL-NPd7H*|?uRb`AGdMknOP2m2trL3(rt&lt;U~zh%w^zXaf!H-Ag-&lt;}=vx&amp;Ox^DBtD;y
zo95k|ISU3M1Y^gINy3d`b5jw|y&gt;%bb7L3Z8!NmS^(&lt;8EV%eM3w*_i`2c+gNR%K~5+
zzams=(GWYpRVOS$Bt=Fk#nvs`I+ug``r3A?&gt;(s)lFh)~fS4*b$P7loCYJKfTA0@?8
zGGfGV^78WlXl-j_$MzkEhz)6XkezY?&amp;As}kX%nDwXC)u4Tib4&lt;IsLSWj3^tKc&gt;&gt;Si
zz(B&gt;$?P)JXj~+dlGkb2kx=k&amp;O?5O-EU1!Wm&lt;JxzjM~_~R;iqay94HPmZ+oWQAhvBM
zeQdVxyV|;gWdr*U?A9W#IarNt+xu&lt;Tb#8d+&lt;rkmPS`X@$9uRV`QtG;+x-IUw^VY$6
z`FRthFiU|fphjzP+5B7Y{OG8L=Hdqy4wBNW1Cu{&lt;=4HXsk{&amp;V;%!&gt;d1$@?Dye$WA6
z@dJ0ugpM%B3Bjd8n47Qt=}lR&amp;SPa{?F~%UJEX&gt;W#&amp;wc(+PhLCwsvDMwWJ_g2nk5+V
zg%IZIls=g|cV5VIT`P5dE-C5Bwr!i;K79tPUiIFJ5wowlVTf4#z{1{AnzzqBYu4yh
z?=I*1&gt;uwfWYwGK3@%sb#d_LORT4`%*0bx&lt;GW1BZ+$_$pTc=h%Ay85f75L^%R4+Q*T
z;DEuxaU5c?7`t}uq^fE^(P#wQ_OW;09$H!&amp;IrGeOt&amp;cxms~a2YE(Fe!2y@Qdx%2Y;
zen0VeoHc9S!sqibWXN!$(J;ms_8-_oNpTO#hL0i^iweu&lt;^PhC$cuPvNKnfTu!1nut
zOqp^H!C)4fH*X{-Cy&amp;vi$C964$mkQsFmmK^IF7^iim&amp;kbe4KLX6adT4&amp;dDVbX){7d
zkvi74wY9Ku&lt;A;=&amp;k0vWCht}3+_V3@zuHD}&lt;s(dtkdiTR&lt;Wq@p32w7uUR&amp;S*YmSr(~
zcsb3@jnvg0O!t4?x;5nF&lt;S=;P5c2c#sjl9K=P3ge+gj^QLdcn+kWVP3&gt;DjY4mSs^^
zHY)8$5kjzg_b!xD96VUV$tREJ(@!@@ZNyyL@AnUV^|crF6yz5U6jF-fq7p32A{5HT
z7)2&lt;Q&amp;FQC4rLC=vhK4!@4H`yaVIjM|uM`;Zt!-J&gt;W06R-AQp|xJO8{(OZ|SI|DBb~
zO=)RQ6YvLRV^agMXq2X=2F8pzg}l519((*=v=)ywH@AG1UQ7=&gt;xNwmW=BhC#Pblr(
zyFWvRmLY_&amp;jWM`xoOnFWbI(7XRIFmw{9EsQy~FOj_&lt;@BZ5KNWA+z9jn3IOYnW)k&lt;_
zddr&gt;v_CM=CIMR&gt;nU*J(-pjKQoaW&lt;w~+xz-Iai`xe=Z3Q7bZPO2Zn3rQkNoV@SM0D`
zGt;;=GtH;3$hP%=qSKSPc&lt;AB9cW9&amp;M8)JL`rGYQ3@}lLwF;l0~QvVhJxy9%3#rq$!
zz41J^CN^Fr_X&lt;x+&gt;v0x8xG2)n(ri4&gt;Gj)63G#g(G8mH&lt;!&lt;5rz#8ou_K`fV7e&gt;Kx-7
zILB;!F=*;`zivFwGc7I6=Dx-EdbZZumz|x%!Mz`{d*jt;1D~#5gZ5&amp;aa_%geYnQX&gt;
z-Bk$b2Vm!hxePjO8Kr$s#~5?yMESyNAEWip(|w!R&lt;Bs$`X*8^&gt;`8C=ks{5)oa?`xi
zj$|JIdj$qfZt3|*&gt;upXRa}o&amp;uvD*hVwY~UkO=7o}z9NPWDMLvAvD*jMu-Dp6SA9d%
z|F;jivJZq1s&lt;o}v?yh~%+SUS~ZOgJAU;6YPZjw@3-C1y2Ywh#-mx#?*FhE-JVWZ8=
z)Pg#?ae*tOSfQ2qg)MFCk&lt;ybUURXM2vXr*JotuM{Pu&amp;&gt;MDxI|x^VM!ye^K4npGsRR
zJ+sGzvnAE*5W_A;^gadCumjVu9qPZqG&lt;^puL1&gt;hh0FePoMo*Lnw{4nfV~iz(Ss2Tp
z!x8MfA&amp;BDR52&gt;uZ@8f;47$S8DV-oYEVo2KtLvl5GE+!Vidw&amp;7Wikp$8BawZ^Vx4&gt;?
z*0AZ=B`2ac{uZ@sRhk=;*GUq&lt;xN%IR6|47Pe1k?I?I&gt;pVO5!hEfV2DtgyqMYx)|B-
zj6_}60WY2b5R0NCt%&amp;j~ux9=dYwA77&lt;Npb(v@dGgOT?ZS2TmK-&gt;34z%V&amp;YM7V;KPP
zFecK9i93jbVOXPngzuau@SVRDS=b*Ft-^VGJ|epmd&amp;)vgG@JlA#6cJnZpB;quS6H*
z5nVh4we?lx;4`t$eh}k0c$=1@cD{#Iela4aKPDE**cY5=0wg&amp;wrg0bXmwt%a`YP72
zv$2Ms3tFK*e&lt;4BCcPyC9K{SbFYfrqH&amp;~5v%CnnBA&amp;O5gyl*{lL3GqGfSrT9zBx#cB
z$AVx8-=td+d42Frx)p*UOn5&amp;g-iqvfA_PO|=I_9bAp4Dn)M^Bfp%CO1;I4ZJ-)X&lt;V
zUH&gt;pvUIA!@xAp-LGV!ex?%x*!CP9+~Q22e8DC~v#&gt;Q6-1{|+m^2vLymCwLnl0s&amp;U9
ze#!3#K}hV;GXaz&gt;B`cb~`eat&amp;s0o687M3yT{((XE*Xf0o=)cBzE=@bO7%5qiSk97%
zjb^3+-!a+*u8^$InqU0m2FB(&amp;p#`|{+cCPmMhaxD81qcz!lPeMxbfTj{^&amp;Oy)Y&lt;-*
z?&gt;Z*GijC0{;JXdW(}hD$odw3o%~wgc3&amp;st;z$0UxiOjbX{@-M@LWb9&amp;?~fNAQv1S?
zye$L-T0r$H3+4gyZNM1ig4XGMVb97XSPlC+ZCjNNX2A5&gt;pp`E%h*w~wKZMEHRDAh8
z81%Cx$Y5T3RUT_)_ftP3Uh^Fo!&lt;auKY+?H;Td+Dqcp$R-OAfqp7vb-=5bQIMtg;jE
z7x%(nQpTWvc^Y8_*#7HG1H)*Vw&lt;erZPVE80JHDa+Rlg%^$Z15rThHD&lt;{v1Xo8gS|=
z$RGXVq`%#Cv=bv0Tj_V@Lo{so54PS=Lc@mtpx;#w6RFtRe$PnSs2u=eRlCU^I*G=Q
zUM6o$;u#t+o&gt;&lt;lH&amp;geS=1P2bIZO3Ygr(HwKmJJk7orBwW04pcI-874?ILID8n!V58
zL~i*Mj(hMsN~YWZ$|KZ!6wRAHJj6oM8tHI$_7#*+aLObOu3SX?+3OJg5Oz*4hR%P7
z?;pFAme1CbfBa?XJ|rbgl7GTw?c8656ApdUtoR+f9=jBOQGeo9;lv&amp;(QmgR_j7aUu
zLZthad8d*H%8_J&gt;yN&lt;On=FbT6-UlnIwbnh8rc2HADKmPl{&amp;3Z9rPKf^Wv$kFfRyrp
zF(yw6Sv_sa+5O)8VC6w$Opy?xK{`&amp;n=kzHvm_B6&amp;0+IjLsuji&lt;({tM7v#~8JM=39A
zTXyiwGtROQl)U}!8%7G5d*&amp;HuS)S*Xir3%zi#dPBERH1xBlFVsgSD%po^oq#W6YlS
z-d|aA)|uyI-M_4o_1hadT*zdm@_yMY_;DHGNZ1c%lpTx3PxL&amp;m+8D!^yPBAGQW1Wi
z?DSA&amp;fHyYQ;CUW?pFbXpM|Vk#`O;_GDsjx!c*+oSR60j9vQj2d$MZP#2d8B@PQ28P
z#bX0zo_A3)OhBQu#?xI|XK15Q%45yn--{Y!YNghuan&lt;U#+C0xgX@jc_aZeL&gt;J7(8A
z#6dV5_Q&amp;J#5w_#R%j+BJcc;6c4X&amp;p&lt;JtX&gt;UnFMgLEXz^K+axVZerVf1&lt;#`@jYm_!P
zO5=F#bKF(9N~2Yxe-lrg6mlGAn5~o=cJ5iztwa|R07{#~+`&gt;tnXh0&gt;80P8lajYuJ@
zr4S;zZsWSPROE-zhMa&amp;+Zm?rE8NlI4IN&amp;L7w5_!+Z*Fed2{3kOE^9xpIifU&lt;9+Zdx
z2?j%s6OVr@o__Ahia;RHcj_6_vWzk53yPG;cJ&amp;Rg;_c&lt;wN~^(&gt;Cr-8B`{3PZJRbA;
ze10`!+Btz$YgWcx*RfLHso!nO*3+h(&lt;xidN#M0+}UxlI2U}9S95-H_DfygqL$hC8B
zEL!^P@2izoJ*Bj2wN`y&gt;+x}cBH8Q#U52P+EuK-@?hFNgsZNI$z#q&gt;&amp;BbpJiwx^GMd
zJ(P4%s+%@#YBxxAb#;szHxApju`CPQwlf3!WCyh_gg{D}zH^!}V+NZyZ$9E&gt;m27{b
zA(2vISr${LP6c4&gt;*s&lt;j0&lt;#l}vaySQ&gt;Emc)jVT_@np`m*m?AWmbpU+1{MFmnywr&lt;_p
zWj8u-V2ok&lt;^y!q8lrU=4C&lt;+S;Iq}33357z()`gUW)z#G@grK#xH4$&lt;ZiyfT&lt;fUmy#
zD$Q=@`^O)Dd~98qK7Bfcg@xF*%}FPnL{3f)Qc5OFn2&lt;iXAJvnU2&gt;48-Xf&amp;E0o6OX+
zXOBP!fUm#)I=usFt@+}MFWQAmY}l~j(2iYmFy29wFT3orcCAdFJo$*&lt;nE+SbxA@*}
ztwzB4UlLvjaM_iEFVR{q&gt;mI58)oU;Ay5GL^@}ZZNm!JO16+iiPx5$_M&lt;&lt;a|K)n*%b
z&lt;%*yDnx#vh=fK`QNNHhN@`%sLQzr3Gm(1hS&amp;sM!F4_&amp;~0h2QVT?+*|Nq;im8Fi0&gt;M
zN&lt;M=G0s*QHRJEVR%F54q^s&amp;X=&gt;cZyFRwoAW(#wY~0e(7p@(-x0-ib~|LMqSTc?RWa
z97p523ePoY4PG){(HOH-09&lt;&lt;cP;&lt;-t%V}uZn)DGFTAJbrk%MjJ)6le+)|M!dutzMe
zC@dJlCm(;pYcGB)?9Qz*C@$*9fW8TTS~&amp;bQU+s8@a8@hPs6l&amp;H$JHpsp~60;Gm%!1
zo!&gt;uAB=Sun+!*lLA%ejGrN#Lj0R$G7^b_zG5DW~UU$4t?y%^u_Ud7Ju-=|mUaY_3~
z;SUBn0{DHo_&lt;VT?Au&amp;Kz?J@*{f&amp;DH(V9~etDQIJG;vQB8w;2Hp5@Qmf&lt;&lt;+%+p(yVZ
z{Pr+%vU^fq_9M1^^BSJ#qK(4M2uV%@cv@jh!b)+RX1?G57OtZZ!pHW?zv9FdIu*m3
zj73TT1OUF@+29Twe4&lt;YogLXBZ)`{TvXf^$MO+YD)QU=FSe7|d-OTty)w*kkAdw0I{
z&gt;Wd4zA&amp;9&lt;M)V&amp;Mv#G?D}&gt;EZVWKJ+|ySZ0mzriUyqn)sK1&lt;&lt;BK&amp;!hDa6zcxrIqf%P`
z#^MJT-Ld@jzeXL$F`4;}Sw8dqvdhh$zg}tXx;S7W;g)v4SJzaV#Sh*WwxyImA6hmz
zSn=K0hZ*@Mxz#78ta8_OtPF&gt;xF%a&lt;k586`7Eyj~mN0lFUn5q)(jO&gt;v^kHhvKipTll
z%g&lt;3-ZL&gt;YkJ4N~o-&amp;Ahxz(L-Svk{gLc!llXe$|eHK$eZx`Yc;(?dw_6m!iVLMEr5m
zxhoKSx$I`71f^Vt4&lt;3PK2QbFq_xo{Nm$&amp;shwk?Dp;1BS|TW@f|c{A}mkC$J0k=%*D
z;S)fk$vzDpd-4ecg6y0eCZ0NxvJoQ@LSSPO!OmmHjN&gt;nVTgJt+E@Ahc-CQ&amp;Gr|dtl
zk60|qzyU)jDlDR=wuWb)dxlU}7CzgT05HiO7ZnvUe%yHex_lYoaG32ozGn49=OI&amp;Z
zdB!m9mNyB9!xR-4Wv&lt;4A1@3tsMMXuFk1VI9wUyG+o@nJU=i&lt;|ubMfhkzWaQH+rlW%
zI~22&lt;LRZQo91hde+(0}Ur*H3s^X=(nYm;hDQBqV&amp;Boe_&gt;UfSo9zF&amp;w&amp;qck+ubLxai
zJo)5P?A^DAv**8)h&gt;*_BCqKV{y!;|O&amp;m$6zw7*|4#^AUP$CZyJ9Bw5yCx?H(=We7B
z&gt;9dnap7KMX5Yh;A3P4I3bDVh2fPRB;TnB$3$Tino%aga9&amp;cG5M$Mv(x3rV&amp;eFxWlD
zGwz}r88T!zZQ(WmS3LOe{Woi^@3C#$mx@m`#?Z3&lt;UJEZmwjVCO@LYWU5cSOw-delW
z&lt;c&lt;5kT6sz#SdcRJEe`V~#&amp;@p{s@4M`)4X#5nAt)Ine_A@$ewt28Q|Xb%iGmIZXf(@
z!L{`QQE;@7%1(+JXZ&gt;bLi7kc9pML%I(rAs=3ZpbeYfS1Gs1omqvP7Mn(t)gA`e=T7
z8r@j5Bcaw9rIJKRkYt@qpMVYEMPrH9GYHc}8D+s}oT6|HHf*M#F-&amp;_7l9hEQET&gt;xT
z(-y-TRgP(Bq(|jmk#vcs0NS(si97&gt;G%jABL0KRhPv&amp;hCKoXYR0sgGLsy|lH?27{Lz
zgG{!apybNQebWkb=eIjqx@;fQ&gt;h{yt)JC6Q-GL69{6rU`u|r)*vaEbMO{{_1x_X@B
zPiDZ4&amp;!UXL^+3J0B{_((XvZnc)@fp8;N&lt;ZW7(H$R%7E*E&lt;0XQdYy&lt;TF!4wYvL*2(;
znly1{P7%8vcuHd%W18Pz`b7TWg656ARVst%ia5c6#=ht`ONu)a-p5|Q#Zv~WE8-MD
zmv`?&lt;X^uqf9xFgs#OW?{1&gt;m|~^OOI%H9sXtUF4?!0zdL=wqe?+o&amp;W#&lt;07*qoM6N&lt;$
Eg57}I+W-In</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mail/themes/qute/jar.mn</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mail/themes/qute/jar.mn</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -23,18 +23,28 @@ classic.jar:</span>
<a href="#l20.4"></a><span id="l20.4">   skin/classic/editor/EditorDialog.css                        (editor/EditorDialog.css)</span>
<a href="#l20.5"></a><span id="l20.5">   skin/classic/editor/icons/img-align-bottom.gif              (editor/img-align-bottom.gif)</span>
<a href="#l20.6"></a><span id="l20.6">   skin/classic/editor/icons/img-align-left.gif                (editor/img-align-left.gif)</span>
<a href="#l20.7"></a><span id="l20.7">   skin/classic/editor/icons/img-align-middle.gif              (editor/img-align-middle.gif)</span>
<a href="#l20.8"></a><span id="l20.8">   skin/classic/editor/icons/img-align-right.gif               (editor/img-align-right.gif)</span>
<a href="#l20.9"></a><span id="l20.9">   skin/classic/editor/icons/img-align-top.gif                 (editor/img-align-top.gif)</span>
<a href="#l20.10"></a><span id="l20.10"> % skin messenger classic/1.0 %skin/classic/messenger/ os=WINNT osversion&lt;6</span>
<a href="#l20.11"></a><span id="l20.11"> % skin messenger classic/1.0 %skin/classic/messenger/ os!=WINNT</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-# NOTE: If you add a new file here, you'll need to add it to the aero</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineminus">-# section at the bottom of this file, too.</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineplus">+</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineplus">+# ATTENTION! ATTENTION! ATTENTION! ATTENTION! ATTENTION! ATTENTION! ATTENTION!</span>
<a href="#l20.16"></a><span id="l20.16" class="difflineplus">+# ATTENTION! ATTENTION! ATTENTION! ATTENTION! ATTENTION! ATTENTION! ATTENTION!</span>
<a href="#l20.17"></a><span id="l20.17" class="difflineplus">+#</span>
<a href="#l20.18"></a><span id="l20.18" class="difflineplus">+# If you add a new file here, you'll need to add it to the aero section at the</span>
<a href="#l20.19"></a><span id="l20.19" class="difflineplus">+# bottom of this file, too. If you do not, people using Windows prior to Vista</span>
<a href="#l20.20"></a><span id="l20.20" class="difflineplus">+# will be able to enjoy your additions, but people using Vista and above will</span>
<a href="#l20.21"></a><span id="l20.21" class="difflineplus">+# not.</span>
<a href="#l20.22"></a><span id="l20.22" class="difflineplus">+#</span>
<a href="#l20.23"></a><span id="l20.23" class="difflineplus">+# ATTENTION! ATTENTION! ATTENTION! ATTENTION! ATTENTION! ATTENTION! ATTENTION!</span>
<a href="#l20.24"></a><span id="l20.24" class="difflineplus">+# ATTENTION! ATTENTION! ATTENTION! ATTENTION! ATTENTION! ATTENTION! ATTENTION!</span>
<a href="#l20.25"></a><span id="l20.25" class="difflineplus">+</span>
<a href="#l20.26"></a><span id="l20.26">   skin/classic/messenger/primaryToolbar.css                   (mail/primaryToolbar.css)</span>
<a href="#l20.27"></a><span id="l20.27">   skin/classic/messenger/accountCentral.css                   (mail/accountCentral.css)</span>
<a href="#l20.28"></a><span id="l20.28">   skin/classic/messenger/accountCreation.css                  (mail/accountCreation.css)</span>
<a href="#l20.29"></a><span id="l20.29">   skin/classic/messenger/accountManage.css                    (mail/accountManage.css)</span>
<a href="#l20.30"></a><span id="l20.30">   skin/classic/messenger/accountWizard.css                    (mail/accountWizard.css)</span>
<a href="#l20.31"></a><span id="l20.31">   skin/classic/messenger/section_collapsed.png                (mail/section_collapsed.png)</span>
<a href="#l20.32"></a><span id="l20.32">   skin/classic/messenger/section_expanded.png                 (mail/section_expanded.png)</span>
<a href="#l20.33"></a><span id="l20.33">   skin/classic/messenger/messageHeader.css                    (mail/messageHeader.css)</span>
<a href="#l20.34"></a><span id="l20.34" class="difflineat">@@ -221,16 +231,18 @@ classic.jar:</span>
<a href="#l20.35"></a><span id="l20.35">   skin/classic/messenger-newsblog/icons/server-rss.png        (mail/newsblog/server-rss.png)</span>
<a href="#l20.36"></a><span id="l20.36"> #ifdef XP_WIN</span>
<a href="#l20.37"></a><span id="l20.37"> % skin messenger classic/1.0 %skin/classic/aero/messenger/ os=WINNT osversion&gt;=6</span>
<a href="#l20.38"></a><span id="l20.38">   skin/classic/aero/messenger/primaryToolbar.css                   (mail/primaryToolbar.css)</span>
<a href="#l20.39"></a><span id="l20.39">   skin/classic/aero/messenger/accountCentral.css                   (mail/accountCentral.css)</span>
<a href="#l20.40"></a><span id="l20.40">   skin/classic/aero/messenger/accountCreation.css                  (mail/accountCreation.css)</span>
<a href="#l20.41"></a><span id="l20.41">   skin/classic/aero/messenger/accountManage.css                    (mail/accountManage.css)</span>
<a href="#l20.42"></a><span id="l20.42">   skin/classic/aero/messenger/accountWizard.css                    (mail/accountWizard.css)</span>
<a href="#l20.43"></a><span id="l20.43" class="difflineplus">+  skin/classic/aero/messenger/section_collapsed.png                (mail/section_collapsed.png)</span>
<a href="#l20.44"></a><span id="l20.44" class="difflineplus">+  skin/classic/aero/messenger/section_expanded.png                 (mail/section_expanded.png)</span>
<a href="#l20.45"></a><span id="l20.45">   skin/classic/aero/messenger/messageHeader.css                    (mail/messageHeader.css)</span>
<a href="#l20.46"></a><span id="l20.46">   skin/classic/aero/messenger/messageBody.css                      (mail/messageBody.css)</span>
<a href="#l20.47"></a><span id="l20.47">   skin/classic/aero/messenger/messageQuotes.css                    (mail/messageQuotes.css)</span>
<a href="#l20.48"></a><span id="l20.48"> * skin/classic/aero/messenger/messenger.css                        (mail/messenger-aero.css)</span>
<a href="#l20.49"></a><span id="l20.49">   skin/classic/aero/messenger/mailWindow1.css                      (mail/mailWindow1.css)</span>
<a href="#l20.50"></a><span id="l20.50">   skin/classic/aero/messenger/tagColors.css                        (mail/tagColors.css)</span>
<a href="#l20.51"></a><span id="l20.51">   skin/classic/aero/messenger/messageWindow.css                    (mail/messageWindow.css)</span>
<a href="#l20.52"></a><span id="l20.52">   skin/classic/aero/messenger/searchBox.css                        (mail/searchBox.css)</span>
<a href="#l20.53"></a><span id="l20.53" class="difflineat">@@ -280,23 +292,27 @@ classic.jar:</span>
<a href="#l20.54"></a><span id="l20.54">   skin/classic/aero/messenger/addressbook/icons/abcard-large.png   (mail/addrbook/abcard-large.png)</span>
<a href="#l20.55"></a><span id="l20.55">   skin/classic/aero/messenger/addressbook/icons/remote-addrbook.png (mail/addrbook/remote-addrbook.png)</span>
<a href="#l20.56"></a><span id="l20.56">   skin/classic/aero/messenger/addressbook/icons/remote-addrbook-error.png      (mail/addrbook/remote-addrbook-error.png)</span>
<a href="#l20.57"></a><span id="l20.57">   skin/classic/aero/messenger/addressbook/icons/secure-remote-addrbook.png     (mail/addrbook/secure-remote-addrbook.png)</span>
<a href="#l20.58"></a><span id="l20.58">   skin/classic/aero/messenger/messengercompose/messengercompose.css (mail/compose/messengercompose-aero.css)</span>
<a href="#l20.59"></a><span id="l20.59">   skin/classic/aero/messenger/messengercompose/compose-toolbar.png  (mail/compose/compose-toolbar.png)</span>
<a href="#l20.60"></a><span id="l20.60">   skin/classic/aero/messenger/messengercompose/compose-toolbar-small.png   (mail/compose/compose-toolbar-small.png)</span>
<a href="#l20.61"></a><span id="l20.61">   skin/classic/aero/messenger/messengercompose/format-buttons.png  (mail/compose/format-buttons-aero.png)</span>
<a href="#l20.62"></a><span id="l20.62" class="difflineplus">+  skin/classic/aero/messenger/preferences/alwaysAsk.png            (mail/preferences/alwaysAsk.png)</span>
<a href="#l20.63"></a><span id="l20.63" class="difflineplus">+  skin/classic/aero/messenger/preferences/application.png          (mail/preferences/application.png)</span>
<a href="#l20.64"></a><span id="l20.64"> * skin/classic/aero/messenger/preferences/preferences.css          (mail/preferences/preferences-aero.css)</span>
<a href="#l20.65"></a><span id="l20.65">   skin/classic/aero/messenger/preferences/general.png              (mail/preferences/general-aero.png)</span>
<a href="#l20.66"></a><span id="l20.66">   skin/classic/aero/messenger/preferences/display.png              (mail/preferences/display-aero.png)</span>
<a href="#l20.67"></a><span id="l20.67">   skin/classic/aero/messenger/preferences/composition.png          (mail/preferences/composition-aero.png)</span>
<a href="#l20.68"></a><span id="l20.68">   skin/classic/aero/messenger/preferences/junk.png                 (mail/preferences/junk-aero.png)</span>
<a href="#l20.69"></a><span id="l20.69">   skin/classic/aero/messenger/preferences/security.png             (mail/preferences/security-aero.png)</span>
<a href="#l20.70"></a><span id="l20.70">   skin/classic/aero/messenger/preferences/attachments.png          (mail/preferences/attachments-aero.png)</span>
<a href="#l20.71"></a><span id="l20.71" class="difflineplus">+  skin/classic/aero/messenger/preferences/applications.css         (mail/preferences/applications.css)</span>
<a href="#l20.72"></a><span id="l20.72" class="difflineplus">+  skin/classic/aero/messenger/preferences/saveFile.png             (mail/preferences/saveFile.png)</span>
<a href="#l20.73"></a><span id="l20.73">   skin/classic/aero/messenger/preferences/advanced.png             (mail/preferences/advanced-aero.png)</span>
<a href="#l20.74"></a><span id="l20.74">   skin/classic/aero/messenger/preferences/background.png           (mail/preferences/background.png)</span>
<a href="#l20.75"></a><span id="l20.75">   skin/classic/aero/messenger/preferences/hover.png                (mail/preferences/hover.png)</span>
<a href="#l20.76"></a><span id="l20.76">   skin/classic/aero/messenger/preferences/selected.png             (mail/preferences/selected.png)</span>
<a href="#l20.77"></a><span id="l20.77">   skin/classic/aero/messenger/smime/msgCompSMIMEOverlay.css        (mail/smime/msgCompSMIMEOverlay.css)</span>
<a href="#l20.78"></a><span id="l20.78">   skin/classic/aero/messenger/smime/msgHdrViewSMIMEOverlay.css     (mail/smime/msgHdrViewSMIMEOverlay.css)</span>
<a href="#l20.79"></a><span id="l20.79">   skin/classic/aero/messenger/smime/msgReadSMIMEOverlay.css        (mail/smime/msgReadSMIMEOverlay.css)</span>
<a href="#l20.80"></a><span id="l20.80">   skin/classic/aero/messenger/smime/msgReadSecurityInfo.css        (mail/smime/msgReadSecurityInfo.css)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mailnews/base/content/folderProps.js</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mailnews/base/content/folderProps.js</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -146,17 +146,17 @@ function folderPropsOKButton()</span>
<a href="#l21.4"></a><span id="l21.4">     else</span>
<a href="#l21.5"></a><span id="l21.5">       gMsgFolder.clearFlag(nsMsgFolderFlags.Offline);</span>
<a href="#l21.6"></a><span id="l21.6"> </span>
<a href="#l21.7"></a><span id="l21.7">     if(document.getElementById(&quot;folderCheckForNewMessages&quot;).checked)</span>
<a href="#l21.8"></a><span id="l21.8">       gMsgFolder.setFlag(nsMsgFolderFlags.CheckNew);</span>
<a href="#l21.9"></a><span id="l21.9">     else</span>
<a href="#l21.10"></a><span id="l21.10">       gMsgFolder.clearFlag(nsMsgFolderFlags.CheckNew);</span>
<a href="#l21.11"></a><span id="l21.11"> </span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-    var retentionSettings = saveCommonRetentionSettings();</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+    var retentionSettings = saveCommonRetentionSettings(gMsgFolder.retentionSettings);</span>
<a href="#l21.14"></a><span id="l21.14">     retentionSettings.useServerDefaults = document.getElementById(&quot;retention.useDefault&quot;).checked;</span>
<a href="#l21.15"></a><span id="l21.15">     gMsgFolder.retentionSettings = retentionSettings;</span>
<a href="#l21.16"></a><span id="l21.16"> </span>
<a href="#l21.17"></a><span id="l21.17">   }</span>
<a href="#l21.18"></a><span id="l21.18"> </span>
<a href="#l21.19"></a><span id="l21.19">   try</span>
<a href="#l21.20"></a><span id="l21.20">   {</span>
<a href="#l21.21"></a><span id="l21.21">     // This throws an exception when an illegal folder name was entered.</span>
<a href="#l21.22"></a><span id="l21.22" class="difflineat">@@ -236,17 +236,17 @@ function folderPropsOnLoad()</span>
<a href="#l21.23"></a><span id="l21.23">     else {</span>
<a href="#l21.24"></a><span id="l21.24">       if(serverType == &quot;imap&quot; || serverType == &quot;pop3&quot;)</span>
<a href="#l21.25"></a><span id="l21.25">         document.getElementById(&quot;offline.selectForOfflineFolder&quot;).checked = false;</span>
<a href="#l21.26"></a><span id="l21.26"> </span>
<a href="#l21.27"></a><span id="l21.27">       if(serverType == &quot;nntp&quot;)</span>
<a href="#l21.28"></a><span id="l21.28">         document.getElementById(&quot;offline.selectForOfflineNewsgroup&quot;).checked = false;</span>
<a href="#l21.29"></a><span id="l21.29">     }</span>
<a href="#l21.30"></a><span id="l21.30"> </span>
<a href="#l21.31"></a><span id="l21.31" class="difflineminus">-    // select the menu item </span>
<a href="#l21.32"></a><span id="l21.32" class="difflineplus">+    // select the menu item</span>
<a href="#l21.33"></a><span id="l21.33">     var folderCharsetList = document.getElementById(&quot;folderCharsetList&quot;);</span>
<a href="#l21.34"></a><span id="l21.34">     var elements = folderCharsetList.getElementsByAttribute(&quot;value&quot;, gMsgFolder.charset);</span>
<a href="#l21.35"></a><span id="l21.35">     folderCharsetList.selectedItem = elements[0];</span>
<a href="#l21.36"></a><span id="l21.36"> </span>
<a href="#l21.37"></a><span id="l21.37">     // set override checkbox</span>
<a href="#l21.38"></a><span id="l21.38">     document.getElementById(&quot;folderCharsetOverride&quot;).checked = gMsgFolder.charsetOverride;</span>
<a href="#l21.39"></a><span id="l21.39"> </span>
<a href="#l21.40"></a><span id="l21.40">     // set check for new mail checkbox</span>
<a href="#l21.41"></a><span id="l21.41" class="difflineat">@@ -337,27 +337,27 @@ function hideShowControls(serverType)</span>
<a href="#l21.42"></a><span id="l21.42">     // Retention policy doesn't apply to Drafts/Templates/Outbox.</span>
<a href="#l21.43"></a><span id="l21.43">     if (gMsgFolder.isSpecialFolder(nsMsgFolderFlags.Drafts |</span>
<a href="#l21.44"></a><span id="l21.44">                                    nsMsgFolderFlags.Templates |</span>
<a href="#l21.45"></a><span id="l21.45">                                    nsMsgFolderFlags.Queue, true))</span>
<a href="#l21.46"></a><span id="l21.46">       document.getElementById(&quot;Retention&quot;).hidden = true;</span>
<a href="#l21.47"></a><span id="l21.47">   }</span>
<a href="#l21.48"></a><span id="l21.48"> }</span>
<a href="#l21.49"></a><span id="l21.49"> </span>
<a href="#l21.50"></a><span id="l21.50" class="difflineminus">-function getEnclosingContainer(startNode) </span>
<a href="#l21.51"></a><span id="l21.51" class="difflineplus">+function getEnclosingContainer(startNode)</span>
<a href="#l21.52"></a><span id="l21.52"> {</span>
<a href="#l21.53"></a><span id="l21.53">   var parent = startNode;</span>
<a href="#l21.54"></a><span id="l21.54" class="difflineminus">-  var box; </span>
<a href="#l21.55"></a><span id="l21.55" class="difflineminus">-  while (parent &amp;&amp; parent != document) </span>
<a href="#l21.56"></a><span id="l21.56" class="difflineplus">+  var box;</span>
<a href="#l21.57"></a><span id="l21.57" class="difflineplus">+  while (parent &amp;&amp; parent != document)</span>
<a href="#l21.58"></a><span id="l21.58">   {</span>
<a href="#l21.59"></a><span id="l21.59">     var isContainer = (parent.getAttribute(&quot;iscontrolcontainer&quot;) == &quot;true&quot;);</span>
<a href="#l21.60"></a><span id="l21.60"> </span>
<a href="#l21.61"></a><span id="l21.61">     // remember the FIRST container we encounter, or the first controlcontainer</span>
<a href="#l21.62"></a><span id="l21.62">     if (!box || isContainer) box=parent;</span>
<a href="#l21.63"></a><span id="l21.63" class="difflineminus">-        </span>
<a href="#l21.64"></a><span id="l21.64" class="difflineplus">+</span>
<a href="#l21.65"></a><span id="l21.65">     // break out with a controlcontainer</span>
<a href="#l21.66"></a><span id="l21.66">     if (isContainer) break;</span>
<a href="#l21.67"></a><span id="l21.67">       parent = parent.parentNode;</span>
<a href="#l21.68"></a><span id="l21.68">   }</span>
<a href="#l21.69"></a><span id="l21.69">   return box;</span>
<a href="#l21.70"></a><span id="l21.70"> }</span>
<a href="#l21.71"></a><span id="l21.71"> </span>
<a href="#l21.72"></a><span id="l21.72"> function onOfflineFolderDownload()</span>
<a href="#l21.73"></a><span id="l21.73" class="difflineat">@@ -367,17 +367,17 @@ function onOfflineFolderDownload()</span>
<a href="#l21.74"></a><span id="l21.74"> }</span>
<a href="#l21.75"></a><span id="l21.75"> </span>
<a href="#l21.76"></a><span id="l21.76"> function onFolderPrivileges()</span>
<a href="#l21.77"></a><span id="l21.77"> {</span>
<a href="#l21.78"></a><span id="l21.78">   var imapFolder = gMsgFolder.QueryInterface(Components.interfaces.nsIMsgImapMailFolder);</span>
<a href="#l21.79"></a><span id="l21.79">   if (imapFolder)</span>
<a href="#l21.80"></a><span id="l21.80">     imapFolder.folderPrivileges(window.arguments[0].msgWindow);</span>
<a href="#l21.81"></a><span id="l21.81">   // let's try closing the modal dialog to see if it fixes the various problems running this url</span>
<a href="#l21.82"></a><span id="l21.82" class="difflineminus">-  window.close(); </span>
<a href="#l21.83"></a><span id="l21.83" class="difflineplus">+  window.close();</span>
<a href="#l21.84"></a><span id="l21.84"> }</span>
<a href="#l21.85"></a><span id="l21.85"> </span>
<a href="#l21.86"></a><span id="l21.86"> </span>
<a href="#l21.87"></a><span id="l21.87"> function onUseDefaultRetentionSettings()</span>
<a href="#l21.88"></a><span id="l21.88"> {</span>
<a href="#l21.89"></a><span id="l21.89">   var useDefault = document.getElementById(&quot;retention.useDefault&quot;).checked;</span>
<a href="#l21.90"></a><span id="l21.90">   document.getElementById('retention.keepMsg').disabled = useDefault;</span>
<a href="#l21.91"></a><span id="l21.91">   document.getElementById('retention.keepNewMsgMinLabel').disabled = useDefault;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mailnews/base/content/retention.js</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mailnews/base/content/retention.js</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -38,41 +38,37 @@</span>
<a href="#l22.4"></a><span id="l22.4">  * ***** END LICENSE BLOCK ****** */</span>
<a href="#l22.5"></a><span id="l22.5"> </span>
<a href="#l22.6"></a><span id="l22.6"> </span>
<a href="#l22.7"></a><span id="l22.7"> function initCommonRetentionSettings(retentionSettings)</span>
<a href="#l22.8"></a><span id="l22.8"> {</span>
<a href="#l22.9"></a><span id="l22.9">   document.getElementById(&quot;retention.keepUnread&quot;).checked =  retentionSettings.keepUnreadMessagesOnly;</span>
<a href="#l22.10"></a><span id="l22.10">   document.getElementById(&quot;retention.keepMsg&quot;).value = retentionSettings.retainByPreference;</span>
<a href="#l22.11"></a><span id="l22.11">   if(retentionSettings.daysToKeepHdrs &gt; 0)</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-    document.getElementById(&quot;retention.keepOldMsgMin&quot;).value = </span>
<a href="#l22.13"></a><span id="l22.13" class="difflineplus">+    document.getElementById(&quot;retention.keepOldMsgMin&quot;).value =</span>
<a href="#l22.14"></a><span id="l22.14">     (retentionSettings.daysToKeepHdrs &gt; 0) ? retentionSettings.daysToKeepHdrs : 30;</span>
<a href="#l22.15"></a><span id="l22.15">   document.getElementById(&quot;retention.keepNewMsgMin&quot;).value =</span>
<a href="#l22.16"></a><span id="l22.16">     (retentionSettings.numHeadersToKeep &gt; 0) ? retentionSettings.numHeadersToKeep : 2000;</span>
<a href="#l22.17"></a><span id="l22.17"> </span>
<a href="#l22.18"></a><span id="l22.18">   document.getElementById(&quot;retention.applyToFlagged&quot;).checked =</span>
<a href="#l22.19"></a><span id="l22.19">     !retentionSettings.applyToFlaggedMessages;</span>
<a href="#l22.20"></a><span id="l22.20"> }</span>
<a href="#l22.21"></a><span id="l22.21"> </span>
<a href="#l22.22"></a><span id="l22.22" class="difflineminus">-function saveCommonRetentionSettings()</span>
<a href="#l22.23"></a><span id="l22.23" class="difflineplus">+function saveCommonRetentionSettings(aRetentionSettings)</span>
<a href="#l22.24"></a><span id="l22.24"> {</span>
<a href="#l22.25"></a><span id="l22.25" class="difflineminus">-  var retentionSettings =</span>
<a href="#l22.26"></a><span id="l22.26" class="difflineminus">-    Components.classes[&quot;@mozilla.org/msgDatabase/retentionSettings;1&quot;]</span>
<a href="#l22.27"></a><span id="l22.27" class="difflineminus">-              .createInstance(Components.interfaces.nsIMsgRetentionSettings);</span>
<a href="#l22.28"></a><span id="l22.28" class="difflineplus">+  aRetentionSettings.retainByPreference = document.getElementById(&quot;retention.keepMsg&quot;).value;</span>
<a href="#l22.29"></a><span id="l22.29"> </span>
<a href="#l22.30"></a><span id="l22.30" class="difflineminus">-  retentionSettings.retainByPreference = document.getElementById(&quot;retention.keepMsg&quot;).value;</span>
<a href="#l22.31"></a><span id="l22.31" class="difflineplus">+  aRetentionSettings.daysToKeepHdrs = document.getElementById(&quot;retention.keepOldMsgMin&quot;).value;</span>
<a href="#l22.32"></a><span id="l22.32" class="difflineplus">+  aRetentionSettings.numHeadersToKeep = document.getElementById(&quot;retention.keepNewMsgMin&quot;).value;</span>
<a href="#l22.33"></a><span id="l22.33" class="difflineplus">+  aRetentionSettings.keepUnreadMessagesOnly = document.getElementById(&quot;retention.keepUnread&quot;).checked;</span>
<a href="#l22.34"></a><span id="l22.34"> </span>
<a href="#l22.35"></a><span id="l22.35" class="difflineminus">-  retentionSettings.daysToKeepHdrs = document.getElementById(&quot;retention.keepOldMsgMin&quot;).value;</span>
<a href="#l22.36"></a><span id="l22.36" class="difflineminus">-  retentionSettings.numHeadersToKeep = document.getElementById(&quot;retention.keepNewMsgMin&quot;).value;</span>
<a href="#l22.37"></a><span id="l22.37" class="difflineminus">-  retentionSettings.keepUnreadMessagesOnly = document.getElementById(&quot;retention.keepUnread&quot;).checked;</span>
<a href="#l22.38"></a><span id="l22.38" class="difflineminus">-</span>
<a href="#l22.39"></a><span id="l22.39" class="difflineminus">-  retentionSettings.applyToFlaggedMessages =</span>
<a href="#l22.40"></a><span id="l22.40" class="difflineplus">+  aRetentionSettings.applyToFlaggedMessages =</span>
<a href="#l22.41"></a><span id="l22.41">     !document.getElementById(&quot;retention.applyToFlagged&quot;).checked;</span>
<a href="#l22.42"></a><span id="l22.42"> </span>
<a href="#l22.43"></a><span id="l22.43" class="difflineminus">-  return retentionSettings;</span>
<a href="#l22.44"></a><span id="l22.44" class="difflineplus">+  return aRetentionSettings;</span>
<a href="#l22.45"></a><span id="l22.45"> }</span>
<a href="#l22.46"></a><span id="l22.46"> </span>
<a href="#l22.47"></a><span id="l22.47"> function onCheckKeepMsg()</span>
<a href="#l22.48"></a><span id="l22.48"> {</span>
<a href="#l22.49"></a><span id="l22.49">   if (gLockedPref &amp;&amp; gLockedPref[&quot;retention.keepMsg&quot;]) {</span>
<a href="#l22.50"></a><span id="l22.50">     // if the pref associated with the radiobutton is locked, as indicated</span>
<a href="#l22.51"></a><span id="l22.51">     // by the gLockedPref, skip this function.  All elements in this</span>
<a href="#l22.52"></a><span id="l22.52">     // radiogroup have been locked by the function onLockPreference.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mailnews/base/prefs/content/am-offline.js</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mailnews/base/prefs/content/am-offline.js</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -160,17 +160,17 @@ function onSave()</span>
<a href="#l23.4"></a><span id="l23.4"> {</span>
<a href="#l23.5"></a><span id="l23.5">     var downloadSettings =</span>
<a href="#l23.6"></a><span id="l23.6">       Components.classes[&quot;@mozilla.org/msgDatabase/downloadSettings;1&quot;]</span>
<a href="#l23.7"></a><span id="l23.7">                 .createInstance(Components.interfaces.nsIMsgDownloadSettings);</span>
<a href="#l23.8"></a><span id="l23.8"> </span>
<a href="#l23.9"></a><span id="l23.9">     gIncomingServer.limitOfflineMessageSize = document.getElementById(&quot;offline.notDownload&quot;).checked;</span>
<a href="#l23.10"></a><span id="l23.10">     gIncomingServer.maxMessageSize = document.getElementById(&quot;offline.notDownloadMin&quot;).value;</span>
<a href="#l23.11"></a><span id="l23.11"> </span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-    var retentionSettings = saveCommonRetentionSettings();</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineplus">+    var retentionSettings = saveCommonRetentionSettings(gIncomingServer.retentionSettings);</span>
<a href="#l23.14"></a><span id="l23.14"> </span>
<a href="#l23.15"></a><span id="l23.15">     retentionSettings.daysToKeepBodies = document.getElementById(&quot;nntp.removeBodyMin&quot;).value;</span>
<a href="#l23.16"></a><span id="l23.16">     retentionSettings.cleanupBodiesByDays = document.getElementById(&quot;nntp.removeBody&quot;).checked;</span>
<a href="#l23.17"></a><span id="l23.17"> </span>
<a href="#l23.18"></a><span id="l23.18">     downloadSettings.downloadByDate = document.getElementById(&quot;nntp.downloadMsg&quot;).checked;</span>
<a href="#l23.19"></a><span id="l23.19">     downloadSettings.downloadUnreadOnly = document.getElementById(&quot;nntp.notDownloadRead&quot;).checked;</span>
<a href="#l23.20"></a><span id="l23.20">     downloadSettings.ageLimitOfMsgsToDownload = document.getElementById(&quot;nntp.downloadMsgMin&quot;).value;</span>
<a href="#l23.21"></a><span id="l23.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mailnews/base/public/nsIMsgFolderListener.idl</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mailnews/base/public/nsIMsgFolderListener.idl</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -47,17 +47,17 @@ interface nsIArray;</span>
<a href="#l24.4"></a><span id="l24.4">  * especially w.r.t. moving messages and folders.  Some listeners want to know</span>
<a href="#l24.5"></a><span id="l24.5">  * about moves, instead of getting an itemAdded and itemRemoved notification.</span>
<a href="#l24.6"></a><span id="l24.6">  * Folder listeners also only tend to get called if a view is open on the folder,</span>
<a href="#l24.7"></a><span id="l24.7">  * which is not always the case. I don't want to change nsIFolderListener at this</span>
<a href="#l24.8"></a><span id="l24.8">  * point since there are lots of extensions that rely on it. Eventually,</span>
<a href="#l24.9"></a><span id="l24.9">  * these two interfaces should be combined somehow.</span>
<a href="#l24.10"></a><span id="l24.10">  */</span>
<a href="#l24.11"></a><span id="l24.11"> </span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-[scriptable, uuid(4dee6994-1a7d-4200-b9a7-b1fc54df3397)]</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineplus">+[scriptable, uuid(eebbedae-ce43-4151-9798-3f1c6e5a5af0)]</span>
<a href="#l24.14"></a><span id="l24.14"> interface nsIMsgFolderListener : nsISupports {</span>
<a href="#l24.15"></a><span id="l24.15">   /**</span>
<a href="#l24.16"></a><span id="l24.16">    * Notified immediately after a message is added to a folder. This could be a new incoming</span>
<a href="#l24.17"></a><span id="l24.17">    * message to a local folder, or a new message in an IMAP folder when it is opened.</span>
<a href="#l24.18"></a><span id="l24.18">    *</span>
<a href="#l24.19"></a><span id="l24.19">    * @param aMsg The message header that was just added</span>
<a href="#l24.20"></a><span id="l24.20">    */</span>
<a href="#l24.21"></a><span id="l24.21">   void msgAdded(in nsIMsgDBHdr aMsg);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mailnews/base/public/nsIMsgFolderNotificationService.idl</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mailnews/base/public/nsIMsgFolderNotificationService.idl</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -40,17 +40,17 @@</span>
<a href="#l25.4"></a><span id="l25.4"> </span>
<a href="#l25.5"></a><span id="l25.5"> interface nsIMsgDBHdr;</span>
<a href="#l25.6"></a><span id="l25.6"> interface nsIMsgFolder;</span>
<a href="#l25.7"></a><span id="l25.7"> interface nsIMsgFolderListener;</span>
<a href="#l25.8"></a><span id="l25.8"> interface nsIArray;</span>
<a href="#l25.9"></a><span id="l25.9"> </span>
<a href="#l25.10"></a><span id="l25.10"> typedef unsigned long msgFolderListenerFlag;</span>
<a href="#l25.11"></a><span id="l25.11"> </span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-[scriptable, uuid(54900730-ba1f-4315-af44-cfbb2121d115)]</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineplus">+[scriptable, uuid(e5d75176-a3d7-4f80-a1fe-b915a679ca53)]</span>
<a href="#l25.14"></a><span id="l25.14"> interface nsIMsgFolderNotificationService : nsISupports {</span>
<a href="#l25.15"></a><span id="l25.15">   /**</span>
<a href="#l25.16"></a><span id="l25.16">    * @name Notification flags</span>
<a href="#l25.17"></a><span id="l25.17">    * These flags determine which notifications will be sent.</span>
<a href="#l25.18"></a><span id="l25.18">    * @{</span>
<a href="#l25.19"></a><span id="l25.19">    */</span>
<a href="#l25.20"></a><span id="l25.20">   /// nsIMsgFolderListener::msgAdded notification</span>
<a href="#l25.21"></a><span id="l25.21">   const msgFolderListenerFlag msgAdded = 0x1;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/mailnews/base/public/nsISpamSettings.idl</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/mailnews/base/public/nsISpamSettings.idl</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -76,20 +76,24 @@ interface nsISpamSettings: nsISupports {</span>
<a href="#l26.4"></a><span id="l26.4">    * interval, in days</span>
<a href="#l26.5"></a><span id="l26.5">    */</span>
<a href="#l26.6"></a><span id="l26.6">   attribute long purgeInterval;</span>
<a href="#l26.7"></a><span id="l26.7"> </span>
<a href="#l26.8"></a><span id="l26.8">   attribute boolean useWhiteList;</span>
<a href="#l26.9"></a><span id="l26.9">   attribute string whiteListAbURI;</span>
<a href="#l26.10"></a><span id="l26.10"> </span>
<a href="#l26.11"></a><span id="l26.11">   /**</span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-   * should we do something (move or delete)</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineminus">-   * when the user manually marks a message as junk?</span>
<a href="#l26.14"></a><span id="l26.14" class="difflineplus">+   * Should we do something when the user manually marks a message as junk?</span>
<a href="#l26.15"></a><span id="l26.15">    */</span>
<a href="#l26.16"></a><span id="l26.16">   readonly attribute boolean manualMark;</span>
<a href="#l26.17"></a><span id="l26.17" class="difflineplus">+</span>
<a href="#l26.18"></a><span id="l26.18" class="difflineplus">+  /**</span>
<a href="#l26.19"></a><span id="l26.19" class="difflineplus">+   * With manualMark true, which action (move to the Junk folder, or delete)</span>
<a href="#l26.20"></a><span id="l26.20" class="difflineplus">+   * should we take when the user marks a message as junk.</span>
<a href="#l26.21"></a><span id="l26.21" class="difflineplus">+   */</span>
<a href="#l26.22"></a><span id="l26.22">   readonly attribute long manualMarkMode;</span>
<a href="#l26.23"></a><span id="l26.23">   const long MANUAL_MARK_MODE_MOVE = 0;</span>
<a href="#l26.24"></a><span id="l26.24">   const long MANUAL_MARK_MODE_DELETE = 1;</span>
<a href="#l26.25"></a><span id="l26.25"> </span>
<a href="#l26.26"></a><span id="l26.26">   /**</span>
<a href="#l26.27"></a><span id="l26.27">    * integrate with server-side spam detection programs</span>
<a href="#l26.28"></a><span id="l26.28">    */</span>
<a href="#l26.29"></a><span id="l26.29">   attribute boolean useServerFilter;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/mailnews/base/search/public/nsIMsgSearchCustomTerm.idl</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/mailnews/base/search/public/nsIMsgSearchCustomTerm.idl</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -34,32 +34,35 @@</span>
<a href="#l27.4"></a><span id="l27.4">  *</span>
<a href="#l27.5"></a><span id="l27.5">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l27.6"></a><span id="l27.6"> </span>
<a href="#l27.7"></a><span id="l27.7"> #include &quot;nsMsgSearchCore.idl&quot;</span>
<a href="#l27.8"></a><span id="l27.8"> </span>
<a href="#l27.9"></a><span id="l27.9"> /**</span>
<a href="#l27.10"></a><span id="l27.10">  * describes a custom term added to a message search or filter</span>
<a href="#l27.11"></a><span id="l27.11">  */</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-[scriptable,uuid(8DD6E135-6790-475e-9547-3C1408CF2F08)]</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineplus">+[scriptable,uuid(925DB5AA-21AF-494c-8652-984BC7BAD13A)]</span>
<a href="#l27.14"></a><span id="l27.14"> interface nsIMsgSearchCustomTerm : nsISupports</span>
<a href="#l27.15"></a><span id="l27.15"> {</span>
<a href="#l27.16"></a><span id="l27.16">   /**</span>
<a href="#l27.17"></a><span id="l27.17">    * globally unique string to identify this search term.</span>
<a href="#l27.18"></a><span id="l27.18">    * recommended form: ExtensionName@example.com#TermName</span>
<a href="#l27.19"></a><span id="l27.19">    * Commas and quotes are not allowed, the id must not</span>
<a href="#l27.20"></a><span id="l27.20">    * parse to an integer, and names of standard search</span>
<a href="#l27.21"></a><span id="l27.21">    * attributes in SearchAttribEntryTable in nsMsgSearchTerm.cpp</span>
<a href="#l27.22"></a><span id="l27.22">    * are not allowed.</span>
<a href="#l27.23"></a><span id="l27.23">    */</span>
<a href="#l27.24"></a><span id="l27.24">   readonly attribute ACString id;</span>
<a href="#l27.25"></a><span id="l27.25"> </span>
<a href="#l27.26"></a><span id="l27.26">   /// name to display in term list. This should be localized. */</span>
<a href="#l27.27"></a><span id="l27.27">   readonly attribute AString name;</span>
<a href="#l27.28"></a><span id="l27.28"> </span>
<a href="#l27.29"></a><span id="l27.29" class="difflineplus">+  /// Does this term need the message body?</span>
<a href="#l27.30"></a><span id="l27.30" class="difflineplus">+  readonly attribute boolean needsBody;</span>
<a href="#l27.31"></a><span id="l27.31" class="difflineplus">+</span>
<a href="#l27.32"></a><span id="l27.32">   /**</span>
<a href="#l27.33"></a><span id="l27.33">    * Is this custom term enabled?</span>
<a href="#l27.34"></a><span id="l27.34">    *</span>
<a href="#l27.35"></a><span id="l27.35">    * @param scope          search scope (nsMsgSearchScope)</span>
<a href="#l27.36"></a><span id="l27.36">    * @param op             search operator (nsMsgSearchOp). If null, determine</span>
<a href="#l27.37"></a><span id="l27.37">    *                       if term is available for any operator.</span>
<a href="#l27.38"></a><span id="l27.38">    *</span>
<a href="#l27.39"></a><span id="l27.39">    * @return               true if enabled</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgImapSearch.cpp</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgImapSearch.cpp</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -595,18 +595,22 @@ nsMsgSearchValidityManager::InitOnlineMa</span>
<a href="#l28.4"></a><span id="l28.4">   m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l28.5"></a><span id="l28.5">   m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::IsEmpty, 1);</span>
<a href="#l28.6"></a><span id="l28.6">   m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::IsEmpty, 1);</span>
<a href="#l28.7"></a><span id="l28.7">   m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::IsntEmpty, 1);</span>
<a href="#l28.8"></a><span id="l28.8">   m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::IsntEmpty, 1);</span>
<a href="#l28.9"></a><span id="l28.9"> </span>
<a href="#l28.10"></a><span id="l28.10">   m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Contains, 1);</span>
<a href="#l28.11"></a><span id="l28.11">   m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Contains, 1);</span>
<a href="#l28.12"></a><span id="l28.12" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l28.14"></a><span id="l28.14">   m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Is, 1);</span>
<a href="#l28.15"></a><span id="l28.15">   m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Is, 1);</span>
<a href="#l28.16"></a><span id="l28.16" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l28.17"></a><span id="l28.17" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l28.18"></a><span id="l28.18">   m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l28.19"></a><span id="l28.19">   m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l28.20"></a><span id="l28.20">   m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l28.21"></a><span id="l28.21">   m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l28.22"></a><span id="l28.22"> </span>
<a href="#l28.23"></a><span id="l28.23">   return rv;</span>
<a href="#l28.24"></a><span id="l28.24"> }</span>
<a href="#l28.25"></a><span id="l28.25"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/mailnews/base/src/nsMsgAccountManager.cpp</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgAccountManager.cpp</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -190,16 +190,17 @@ nsMsgAccountManager::~nsMsgAccountManage</span>
<a href="#l29.4"></a><span id="l29.4">     Shutdown();</span>
<a href="#l29.5"></a><span id="l29.5">     //Don't remove from Observer service in Shutdown because Shutdown also gets called</span>
<a href="#l29.6"></a><span id="l29.6">     //from xpcom shutdown observer.  And we don't want to remove from the service in that case.</span>
<a href="#l29.7"></a><span id="l29.7">     nsCOMPtr&lt;nsIObserverService&gt; observerService =</span>
<a href="#l29.8"></a><span id="l29.8">          do_GetService(&quot;@mozilla.org/observer-service;1&quot;, &amp;rv);</span>
<a href="#l29.9"></a><span id="l29.9">     if (NS_SUCCEEDED(rv))</span>
<a href="#l29.10"></a><span id="l29.10">     {</span>
<a href="#l29.11"></a><span id="l29.11">       observerService-&gt;RemoveObserver(this, NS_XPCOM_SHUTDOWN_OBSERVER_ID);</span>
<a href="#l29.12"></a><span id="l29.12" class="difflineplus">+      observerService-&gt;RemoveObserver(this, &quot;quit-application-granted&quot;);</span>
<a href="#l29.13"></a><span id="l29.13">       observerService-&gt;RemoveObserver(this, ABOUT_TO_GO_OFFLINE_TOPIC);</span>
<a href="#l29.14"></a><span id="l29.14">     }</span>
<a href="#l29.15"></a><span id="l29.15">   }</span>
<a href="#l29.16"></a><span id="l29.16"> }</span>
<a href="#l29.17"></a><span id="l29.17"> </span>
<a href="#l29.18"></a><span id="l29.18"> nsresult nsMsgAccountManager::Init()</span>
<a href="#l29.19"></a><span id="l29.19"> {</span>
<a href="#l29.20"></a><span id="l29.20">   nsresult rv;</span>
<a href="#l29.21"></a><span id="l29.21" class="difflineat">@@ -212,17 +213,17 @@ nsresult nsMsgAccountManager::Init()</span>
<a href="#l29.22"></a><span id="l29.22"> </span>
<a href="#l29.23"></a><span id="l29.23">   rv = NS_NewISupportsArray(getter_AddRefs(mFolderListeners));</span>
<a href="#l29.24"></a><span id="l29.24"> </span>
<a href="#l29.25"></a><span id="l29.25">   nsCOMPtr&lt;nsIObserverService&gt; observerService =</span>
<a href="#l29.26"></a><span id="l29.26">            do_GetService(&quot;@mozilla.org/observer-service;1&quot;, &amp;rv);</span>
<a href="#l29.27"></a><span id="l29.27">   if (NS_SUCCEEDED(rv))</span>
<a href="#l29.28"></a><span id="l29.28">   {</span>
<a href="#l29.29"></a><span id="l29.29">     observerService-&gt;AddObserver(this, NS_XPCOM_SHUTDOWN_OBSERVER_ID, PR_TRUE);</span>
<a href="#l29.30"></a><span id="l29.30" class="difflineminus">-    observerService-&gt;AddObserver(this, &quot;quit-application&quot; , PR_TRUE);</span>
<a href="#l29.31"></a><span id="l29.31" class="difflineplus">+    observerService-&gt;AddObserver(this, &quot;quit-application-granted&quot; , PR_TRUE);</span>
<a href="#l29.32"></a><span id="l29.32">     observerService-&gt;AddObserver(this, ABOUT_TO_GO_OFFLINE_TOPIC, PR_TRUE);</span>
<a href="#l29.33"></a><span id="l29.33">     observerService-&gt;AddObserver(this, &quot;profile-before-change&quot;, PR_TRUE);</span>
<a href="#l29.34"></a><span id="l29.34">   }</span>
<a href="#l29.35"></a><span id="l29.35"> </span>
<a href="#l29.36"></a><span id="l29.36">   return NS_OK;</span>
<a href="#l29.37"></a><span id="l29.37"> }</span>
<a href="#l29.38"></a><span id="l29.38"> </span>
<a href="#l29.39"></a><span id="l29.39"> nsresult nsMsgAccountManager::Shutdown()</span>
<a href="#l29.40"></a><span id="l29.40" class="difflineat">@@ -288,23 +289,22 @@ nsMsgAccountManager::SetUserNeedsToAuthe</span>
<a href="#l29.41"></a><span id="l29.41"> </span>
<a href="#l29.42"></a><span id="l29.42"> NS_IMETHODIMP nsMsgAccountManager::Observe(nsISupports *aSubject, const char *aTopic, const PRUnichar *someData)</span>
<a href="#l29.43"></a><span id="l29.43"> {</span>
<a href="#l29.44"></a><span id="l29.44">   if(!strcmp(aTopic,NS_XPCOM_SHUTDOWN_OBSERVER_ID))</span>
<a href="#l29.45"></a><span id="l29.45">   {</span>
<a href="#l29.46"></a><span id="l29.46">     Shutdown();</span>
<a href="#l29.47"></a><span id="l29.47">     return NS_OK;</span>
<a href="#l29.48"></a><span id="l29.48">   }</span>
<a href="#l29.49"></a><span id="l29.49" class="difflineminus">-</span>
<a href="#l29.50"></a><span id="l29.50" class="difflineminus">-  if (!strcmp(aTopic,&quot;quit-application&quot;))</span>
<a href="#l29.51"></a><span id="l29.51" class="difflineplus">+  if (!strcmp(aTopic, &quot;quit-application-granted&quot;))</span>
<a href="#l29.52"></a><span id="l29.52">   {</span>
<a href="#l29.53"></a><span id="l29.53" class="difflineminus">-    m_shutdownInProgress = PR_TRUE;</span>
<a href="#l29.54"></a><span id="l29.54" class="difflineplus">+    // CleanupOnExit will set m_shutdownInProgress to true.</span>
<a href="#l29.55"></a><span id="l29.55" class="difflineplus">+    CleanupOnExit();</span>
<a href="#l29.56"></a><span id="l29.56">     return NS_OK;</span>
<a href="#l29.57"></a><span id="l29.57">   }</span>
<a href="#l29.58"></a><span id="l29.58" class="difflineminus">-</span>
<a href="#l29.59"></a><span id="l29.59">   if (!strcmp(aTopic, ABOUT_TO_GO_OFFLINE_TOPIC))</span>
<a href="#l29.60"></a><span id="l29.60">   {</span>
<a href="#l29.61"></a><span id="l29.61">     nsAutoString dataString(NS_LITERAL_STRING(&quot;offline&quot;));</span>
<a href="#l29.62"></a><span id="l29.62">     if (someData)</span>
<a href="#l29.63"></a><span id="l29.63">     {</span>
<a href="#l29.64"></a><span id="l29.64">       nsAutoString someDataString(someData);</span>
<a href="#l29.65"></a><span id="l29.65">       if (dataString.Equals(someDataString))</span>
<a href="#l29.66"></a><span id="l29.66">         CloseCachedConnections();</span>
<a href="#l29.67"></a><span id="l29.67" class="difflineat">@@ -1486,16 +1486,21 @@ nsMsgAccountManager::CloseCachedConnecti</span>
<a href="#l29.68"></a><span id="l29.68"> {</span>
<a href="#l29.69"></a><span id="l29.69">   m_incomingServers.Enumerate(hashCloseCachedConnections, nsnull);</span>
<a href="#l29.70"></a><span id="l29.70">   return NS_OK;</span>
<a href="#l29.71"></a><span id="l29.71"> }</span>
<a href="#l29.72"></a><span id="l29.72"> </span>
<a href="#l29.73"></a><span id="l29.73"> NS_IMETHODIMP</span>
<a href="#l29.74"></a><span id="l29.74"> nsMsgAccountManager::CleanupOnExit()</span>
<a href="#l29.75"></a><span id="l29.75"> {</span>
<a href="#l29.76"></a><span id="l29.76" class="difflineplus">+  // This can get called multiple times, and potentially re-entrantly.</span>
<a href="#l29.77"></a><span id="l29.77" class="difflineplus">+  // So add some protection against that.</span>
<a href="#l29.78"></a><span id="l29.78" class="difflineplus">+  if (m_shutdownInProgress)</span>
<a href="#l29.79"></a><span id="l29.79" class="difflineplus">+    return NS_OK;</span>
<a href="#l29.80"></a><span id="l29.80" class="difflineplus">+  m_shutdownInProgress = PR_TRUE;</span>
<a href="#l29.81"></a><span id="l29.81">   m_incomingServers.Enumerate(hashCleanupOnExit, nsnull);</span>
<a href="#l29.82"></a><span id="l29.82">   // Try to do this early on in the shutdown process before</span>
<a href="#l29.83"></a><span id="l29.83">   // necko shuts itself down.</span>
<a href="#l29.84"></a><span id="l29.84">   CloseCachedConnections();</span>
<a href="#l29.85"></a><span id="l29.85">   return NS_OK;</span>
<a href="#l29.86"></a><span id="l29.86"> }</span>
<a href="#l29.87"></a><span id="l29.87"> </span>
<a href="#l29.88"></a><span id="l29.88"> NS_IMETHODIMP</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/mailnews/base/src/nsMsgMailSession.cpp</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgMailSession.cpp</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -389,25 +389,30 @@ NS_IMETHODIMP nsMsgMailSession::AddMsgWi</span>
<a href="#l30.4"></a><span id="l30.4">   NS_ENSURE_ARG_POINTER(msgWindow);</span>
<a href="#l30.5"></a><span id="l30.5">   mWindows.AppendObject(msgWindow);</span>
<a href="#l30.6"></a><span id="l30.6">   return NS_OK;</span>
<a href="#l30.7"></a><span id="l30.7"> }</span>
<a href="#l30.8"></a><span id="l30.8"> </span>
<a href="#l30.9"></a><span id="l30.9"> NS_IMETHODIMP nsMsgMailSession::RemoveMsgWindow(nsIMsgWindow *msgWindow)</span>
<a href="#l30.10"></a><span id="l30.10"> {</span>
<a href="#l30.11"></a><span id="l30.11">   mWindows.RemoveObject(msgWindow);</span>
<a href="#l30.12"></a><span id="l30.12" class="difflineplus">+  // Mac keeps a hidden window open so the app doesn't shut down when</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineplus">+  // the last window is closed. So don't shutdown the account manager in that</span>
<a href="#l30.14"></a><span id="l30.14" class="difflineplus">+  // case.</span>
<a href="#l30.15"></a><span id="l30.15" class="difflineplus">+#ifndef XP_MACOSX</span>
<a href="#l30.16"></a><span id="l30.16">   if (!mWindows.Count())</span>
<a href="#l30.17"></a><span id="l30.17">   {</span>
<a href="#l30.18"></a><span id="l30.18">     nsresult rv;</span>
<a href="#l30.19"></a><span id="l30.19">     nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager = </span>
<a href="#l30.20"></a><span id="l30.20">       do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l30.21"></a><span id="l30.21">     if (NS_FAILED(rv))</span>
<a href="#l30.22"></a><span id="l30.22">       return rv;</span>
<a href="#l30.23"></a><span id="l30.23">     accountManager-&gt;CleanupOnExit();</span>
<a href="#l30.24"></a><span id="l30.24">   }</span>
<a href="#l30.25"></a><span id="l30.25" class="difflineplus">+#endif</span>
<a href="#l30.26"></a><span id="l30.26">   return NS_OK;</span>
<a href="#l30.27"></a><span id="l30.27"> }</span>
<a href="#l30.28"></a><span id="l30.28"> </span>
<a href="#l30.29"></a><span id="l30.29"> NS_IMETHODIMP nsMsgMailSession::IsFolderOpenInWindow(nsIMsgFolder *folder, PRBool *aResult)</span>
<a href="#l30.30"></a><span id="l30.30"> {</span>
<a href="#l30.31"></a><span id="l30.31">   if (!aResult)</span>
<a href="#l30.32"></a><span id="l30.32">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l30.33"></a><span id="l30.33">   *aResult = PR_FALSE;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -128,16 +128,17 @@ nsIAtom* nsMsgDBFolder::kNumNewBiffMessa</span>
<a href="#l31.4"></a><span id="l31.4"> nsIAtom* nsMsgDBFolder::kTotalUnreadMessagesAtom=nsnull;</span>
<a href="#l31.5"></a><span id="l31.5"> nsIAtom* nsMsgDBFolder::kFlaggedAtom=nsnull;</span>
<a href="#l31.6"></a><span id="l31.6"> nsIAtom* nsMsgDBFolder::kStatusAtom=nsnull;</span>
<a href="#l31.7"></a><span id="l31.7"> nsIAtom* nsMsgDBFolder::kNameAtom=nsnull;</span>
<a href="#l31.8"></a><span id="l31.8"> nsIAtom* nsMsgDBFolder::kSynchronizeAtom=nsnull;</span>
<a href="#l31.9"></a><span id="l31.9"> nsIAtom* nsMsgDBFolder::kOpenAtom=nsnull;</span>
<a href="#l31.10"></a><span id="l31.10"> nsIAtom* nsMsgDBFolder::kIsDeferred=nsnull;</span>
<a href="#l31.11"></a><span id="l31.11"> nsIAtom* nsMsgDBFolder::kKeywords=nsnull;</span>
<a href="#l31.12"></a><span id="l31.12" class="difflineplus">+nsIAtom* nsMsgDBFolder::mFiltersAppliedAtom=nsnull;</span>
<a href="#l31.13"></a><span id="l31.13"> </span>
<a href="#l31.14"></a><span id="l31.14"> nsICollation * nsMsgDBFolder::gCollationKeyGenerator = nsnull;</span>
<a href="#l31.15"></a><span id="l31.15"> </span>
<a href="#l31.16"></a><span id="l31.16"> PRUnichar *nsMsgDBFolder::kLocalizedInboxName;</span>
<a href="#l31.17"></a><span id="l31.17"> PRUnichar *nsMsgDBFolder::kLocalizedTrashName;</span>
<a href="#l31.18"></a><span id="l31.18"> PRUnichar *nsMsgDBFolder::kLocalizedSentName;</span>
<a href="#l31.19"></a><span id="l31.19"> PRUnichar *nsMsgDBFolder::kLocalizedDraftsName;</span>
<a href="#l31.20"></a><span id="l31.20"> PRUnichar *nsMsgDBFolder::kLocalizedTemplatesName;</span>
<a href="#l31.21"></a><span id="l31.21" class="difflineat">@@ -169,17 +170,18 @@ const nsStaticAtom nsMsgDBFolder::folder</span>
<a href="#l31.22"></a><span id="l31.22">   { &quot;TotalUnreadMessages&quot;, &amp;nsMsgDBFolder::kTotalUnreadMessagesAtom },</span>
<a href="#l31.23"></a><span id="l31.23">   { &quot;TotalMessages&quot;, &amp;nsMsgDBFolder::kTotalMessagesAtom },</span>
<a href="#l31.24"></a><span id="l31.24">   { &quot;FolderSize&quot;, &amp;nsMsgDBFolder::kFolderSizeAtom },</span>
<a href="#l31.25"></a><span id="l31.25">   { &quot;Status&quot;, &amp;nsMsgDBFolder::kStatusAtom },</span>
<a href="#l31.26"></a><span id="l31.26">   { &quot;Flagged&quot;, &amp;nsMsgDBFolder::kFlaggedAtom },</span>
<a href="#l31.27"></a><span id="l31.27">   { &quot;Synchronize&quot;, &amp;nsMsgDBFolder::kSynchronizeAtom },</span>
<a href="#l31.28"></a><span id="l31.28">   { &quot;open&quot;, &amp;nsMsgDBFolder::kOpenAtom },</span>
<a href="#l31.29"></a><span id="l31.29">   { &quot;isDeferred&quot;, &amp;nsMsgDBFolder::kIsDeferred },</span>
<a href="#l31.30"></a><span id="l31.30" class="difflineminus">-  { &quot;Keywords&quot;, &amp;nsMsgDBFolder::kKeywords }</span>
<a href="#l31.31"></a><span id="l31.31" class="difflineplus">+  { &quot;Keywords&quot;, &amp;nsMsgDBFolder::kKeywords },</span>
<a href="#l31.32"></a><span id="l31.32" class="difflineplus">+  { &quot;FiltersApplied&quot;, &amp;nsMsgDBFolder::mFiltersAppliedAtom }</span>
<a href="#l31.33"></a><span id="l31.33"> };</span>
<a href="#l31.34"></a><span id="l31.34"> </span>
<a href="#l31.35"></a><span id="l31.35"> nsMsgDBFolder::nsMsgDBFolder(void)</span>
<a href="#l31.36"></a><span id="l31.36"> : mAddListener(PR_TRUE),</span>
<a href="#l31.37"></a><span id="l31.37">   mNewMessages(PR_FALSE),</span>
<a href="#l31.38"></a><span id="l31.38">   mGettingNewMessages(PR_FALSE),</span>
<a href="#l31.39"></a><span id="l31.39">   mLastMessageLoaded(nsMsgKey_None),</span>
<a href="#l31.40"></a><span id="l31.40">   mFlags(0),</span>
<a href="#l31.41"></a><span id="l31.41" class="difflineat">@@ -1698,17 +1700,18 @@ nsresult nsMsgDBFolder::CompactOfflineSt</span>
<a href="#l31.42"></a><span id="l31.42">   nsCOMPtr &lt;nsIMsgFolderCompactor&gt; folderCompactor =  do_CreateInstance(NS_MSGOFFLINESTORECOMPACTOR_CONTRACTID, &amp;rv);</span>
<a href="#l31.43"></a><span id="l31.43">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l31.44"></a><span id="l31.44">   return folderCompactor-&gt;Compact(this, PR_TRUE, aListener, inWindow);</span>
<a href="#l31.45"></a><span id="l31.45"> }</span>
<a href="#l31.46"></a><span id="l31.46"> </span>
<a href="#l31.47"></a><span id="l31.47"> nsresult</span>
<a href="#l31.48"></a><span id="l31.48"> nsMsgDBFolder::AutoCompact(nsIMsgWindow *aWindow)</span>
<a href="#l31.49"></a><span id="l31.49"> {</span>
<a href="#l31.50"></a><span id="l31.50" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aWindow);</span>
<a href="#l31.51"></a><span id="l31.51" class="difflineplus">+  // we don't check for null aWindow, because this routine can get called</span>
<a href="#l31.52"></a><span id="l31.52" class="difflineplus">+  // in unit tests where we have no window. Just assume not OK if no window.</span>
<a href="#l31.53"></a><span id="l31.53">   PRBool prompt;</span>
<a href="#l31.54"></a><span id="l31.54">   nsresult rv = GetPromptPurgeThreshold(&amp;prompt);</span>
<a href="#l31.55"></a><span id="l31.55">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l31.56"></a><span id="l31.56">   PRTime timeNow = PR_Now();   //time in microseconds</span>
<a href="#l31.57"></a><span id="l31.57">   PRTime timeAfterOneHourOfLastPurgeCheck;</span>
<a href="#l31.58"></a><span id="l31.58">   LL_ADD(timeAfterOneHourOfLastPurgeCheck, gtimeOfLastPurgeCheck, oneHour);</span>
<a href="#l31.59"></a><span id="l31.59">   if (LL_CMP(timeAfterOneHourOfLastPurgeCheck, &lt;, timeNow) &amp;&amp; prompt)</span>
<a href="#l31.60"></a><span id="l31.60">   {</span>
<a href="#l31.61"></a><span id="l31.61" class="difflineat">@@ -1790,17 +1793,17 @@ nsMsgDBFolder::AutoCompact(nsIMsgWindow </span>
<a href="#l31.62"></a><span id="l31.62">        {</span>
<a href="#l31.63"></a><span id="l31.63">          PRBool okToCompact = PR_FALSE;</span>
<a href="#l31.64"></a><span id="l31.64">          nsCOMPtr&lt;nsIPrefService&gt; pref = do_GetService(NS_PREFSERVICE_CONTRACTID);</span>
<a href="#l31.65"></a><span id="l31.65">          nsCOMPtr&lt;nsIPrefBranch&gt; branch;</span>
<a href="#l31.66"></a><span id="l31.66">          pref-&gt;GetBranch(&quot;&quot;, getter_AddRefs(branch));</span>
<a href="#l31.67"></a><span id="l31.67"> </span>
<a href="#l31.68"></a><span id="l31.68">          PRBool askBeforePurge;</span>
<a href="#l31.69"></a><span id="l31.69">          branch-&gt;GetBoolPref(PREF_MAIL_PURGE_ASK, &amp;askBeforePurge);</span>
<a href="#l31.70"></a><span id="l31.70" class="difflineminus">-         if (askBeforePurge)</span>
<a href="#l31.71"></a><span id="l31.71" class="difflineplus">+         if (askBeforePurge &amp;&amp; aWindow)</span>
<a href="#l31.72"></a><span id="l31.72">          {</span>
<a href="#l31.73"></a><span id="l31.73">            nsCOMPtr &lt;nsIStringBundle&gt; bundle;</span>
<a href="#l31.74"></a><span id="l31.74">            rv = GetBaseStringBundle(getter_AddRefs(bundle));</span>
<a href="#l31.75"></a><span id="l31.75">            NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l31.76"></a><span id="l31.76">            nsString dialogTitle;</span>
<a href="#l31.77"></a><span id="l31.77">            nsString confirmString;</span>
<a href="#l31.78"></a><span id="l31.78">            nsString checkboxText;</span>
<a href="#l31.79"></a><span id="l31.79">            nsString buttonCompactNowText;</span>
<a href="#l31.80"></a><span id="l31.80" class="difflineat">@@ -1831,17 +1834,17 @@ nsMsgDBFolder::AutoCompact(nsIMsgWindow </span>
<a href="#l31.81"></a><span id="l31.81">            if (!buttonPressed)</span>
<a href="#l31.82"></a><span id="l31.82">            {</span>
<a href="#l31.83"></a><span id="l31.83">              okToCompact = PR_TRUE;</span>
<a href="#l31.84"></a><span id="l31.84">              if (!alwaysAsk) // [ ] Always ask me before compacting folders automatically</span>
<a href="#l31.85"></a><span id="l31.85">                branch-&gt;SetBoolPref(PREF_MAIL_PURGE_ASK, PR_FALSE);</span>
<a href="#l31.86"></a><span id="l31.86">            }</span>
<a href="#l31.87"></a><span id="l31.87">          }</span>
<a href="#l31.88"></a><span id="l31.88">          else</span>
<a href="#l31.89"></a><span id="l31.89" class="difflineminus">-           okToCompact = PR_TRUE;</span>
<a href="#l31.90"></a><span id="l31.90" class="difflineplus">+           okToCompact = aWindow || !askBeforePurge;</span>
<a href="#l31.91"></a><span id="l31.91"> </span>
<a href="#l31.92"></a><span id="l31.92">          if (okToCompact)</span>
<a href="#l31.93"></a><span id="l31.93">          {</span>
<a href="#l31.94"></a><span id="l31.94">             nsCOMPtr &lt;nsIAtom&gt; aboutToCompactAtom = do_GetAtom(&quot;AboutToCompact&quot;);</span>
<a href="#l31.95"></a><span id="l31.95">             NotifyFolderEvent(aboutToCompactAtom);</span>
<a href="#l31.96"></a><span id="l31.96"> </span>
<a href="#l31.97"></a><span id="l31.97">            if ( localExpungedBytes &gt; 0)</span>
<a href="#l31.98"></a><span id="l31.98">            {</span>
<a href="#l31.99"></a><span id="l31.99" class="difflineat">@@ -2312,46 +2315,39 @@ nsMsgDBFolder::CallFilterPlugins(nsIMsgW</span>
<a href="#l31.100"></a><span id="l31.100"> </span>
<a href="#l31.101"></a><span id="l31.101">   nsCOMPtr &lt;nsIJunkMailPlugin&gt; junkMailPlugin = do_QueryInterface(filterPlugin);</span>
<a href="#l31.102"></a><span id="l31.102">   if (!junkMailPlugin) // we currently only support the junk mail plugin</span>
<a href="#l31.103"></a><span id="l31.103">     return NS_OK;</span>
<a href="#l31.104"></a><span id="l31.104"> </span>
<a href="#l31.105"></a><span id="l31.105">   // if it's a news folder, then we really don't support junk in the ui</span>
<a href="#l31.106"></a><span id="l31.106">   // yet the legacy spamLevel seems to think we should analyze it.</span>
<a href="#l31.107"></a><span id="l31.107">   // Maybe we should upgrade that, but for now let's not analyze. We'll</span>
<a href="#l31.108"></a><span id="l31.108" class="difflineminus">-  // use the preference &quot;mail.filter_news_for_junk&quot;, and/or</span>
<a href="#l31.109"></a><span id="l31.109">   // let an extension set an inherited property if they really want us to</span>
<a href="#l31.110"></a><span id="l31.110">   // analyze this. We need that anyway to allow extension-based overrides.</span>
<a href="#l31.111"></a><span id="l31.111">   // When we finalize adding junk in news to core, we'll deal with the</span>
<a href="#l31.112"></a><span id="l31.112">   // spamLevel issue</span>
<a href="#l31.113"></a><span id="l31.113"> </span>
<a href="#l31.114"></a><span id="l31.114" class="difflineminus">-  PRBool filterNewsForJunk = PR_FALSE;</span>
<a href="#l31.115"></a><span id="l31.115" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l31.116"></a><span id="l31.116" class="difflineminus">-  if (prefBranch)</span>
<a href="#l31.117"></a><span id="l31.117" class="difflineminus">-    prefBranch-&gt;GetBoolPref(&quot;mail.filter_news_for_junk&quot;, &amp;filterNewsForJunk);</span>
<a href="#l31.118"></a><span id="l31.118" class="difflineminus">-</span>
<a href="#l31.119"></a><span id="l31.119">   // if this is the junk folder, or the trash folder</span>
<a href="#l31.120"></a><span id="l31.120">   // don't analyze for spam, because we don't care</span>
<a href="#l31.121"></a><span id="l31.121">   //</span>
<a href="#l31.122"></a><span id="l31.122">   // if it's the sent, unsent, templates, or drafts,</span>
<a href="#l31.123"></a><span id="l31.123">   // don't analyze for spam, because the user</span>
<a href="#l31.124"></a><span id="l31.124">   // created that message</span>
<a href="#l31.125"></a><span id="l31.125">   //</span>
<a href="#l31.126"></a><span id="l31.126">   // if it's a public imap folder, or another users</span>
<a href="#l31.127"></a><span id="l31.127">   // imap folder, don't analyze for spam, because</span>
<a href="#l31.128"></a><span id="l31.128">   // it's not ours to analyze</span>
<a href="#l31.129"></a><span id="l31.129">   //</span>
<a href="#l31.130"></a><span id="l31.130"> </span>
<a href="#l31.131"></a><span id="l31.131">   PRBool filterForJunk = PR_TRUE;</span>
<a href="#l31.132"></a><span id="l31.132">   if (serverType.EqualsLiteral(&quot;rss&quot;) ||</span>
<a href="#l31.133"></a><span id="l31.133" class="difflineminus">-      (mFlags &amp; nsMsgFolderFlags::Newsgroup &amp;&amp; !filterNewsForJunk) ||</span>
<a href="#l31.134"></a><span id="l31.134">       (mFlags &amp; (nsMsgFolderFlags::Junk | nsMsgFolderFlags::Trash |</span>
<a href="#l31.135"></a><span id="l31.135">                  nsMsgFolderFlags::SentMail | nsMsgFolderFlags::Queue |</span>
<a href="#l31.136"></a><span id="l31.136">                  nsMsgFolderFlags::Drafts | nsMsgFolderFlags::Templates |</span>
<a href="#l31.137"></a><span id="l31.137" class="difflineminus">-                 nsMsgFolderFlags::ImapPublic |</span>
<a href="#l31.138"></a><span id="l31.138" class="difflineplus">+                 nsMsgFolderFlags::ImapPublic | nsMsgFolderFlags::Newsgroup |</span>
<a href="#l31.139"></a><span id="l31.139">                  nsMsgFolderFlags::ImapOtherUser) &amp;&amp;</span>
<a href="#l31.140"></a><span id="l31.140">        !(mFlags &amp; nsMsgFolderFlags::Inbox)))</span>
<a href="#l31.141"></a><span id="l31.141">     filterForJunk = PR_FALSE;</span>
<a href="#l31.142"></a><span id="l31.142"> </span>
<a href="#l31.143"></a><span id="l31.143">   spamSettings-&gt;GetLevel(&amp;spamLevel);</span>
<a href="#l31.144"></a><span id="l31.144">   if (!spamLevel)</span>
<a href="#l31.145"></a><span id="l31.145">     filterForJunk = PR_FALSE;</span>
<a href="#l31.146"></a><span id="l31.146"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/mailnews/base/util/nsMsgDBFolder.h</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgDBFolder.h</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -193,16 +193,17 @@ protected:</span>
<a href="#l32.4"></a><span id="l32.4">   nsCOMPtr&lt;nsIOutputStream&gt; m_tempMessageStream;</span>
<a href="#l32.5"></a><span id="l32.5"> </span>
<a href="#l32.6"></a><span id="l32.6">   nsCOMPtr &lt;nsIMsgRetentionSettings&gt; m_retentionSettings;</span>
<a href="#l32.7"></a><span id="l32.7">   nsCOMPtr &lt;nsIMsgDownloadSettings&gt; m_downloadSettings;</span>
<a href="#l32.8"></a><span id="l32.8">   static NS_MSG_BASE_STATIC_MEMBER_(nsIAtom*) mFolderLoadedAtom;</span>
<a href="#l32.9"></a><span id="l32.9">   static NS_MSG_BASE_STATIC_MEMBER_(nsIAtom*) mDeleteOrMoveMsgCompletedAtom;</span>
<a href="#l32.10"></a><span id="l32.10">   static NS_MSG_BASE_STATIC_MEMBER_(nsIAtom*) mDeleteOrMoveMsgFailedAtom;</span>
<a href="#l32.11"></a><span id="l32.11">   static NS_MSG_BASE_STATIC_MEMBER_(nsIAtom*) mJunkStatusChangedAtom;</span>
<a href="#l32.12"></a><span id="l32.12" class="difflineplus">+  static NS_MSG_BASE_STATIC_MEMBER_(nsIAtom*) mFiltersAppliedAtom;</span>
<a href="#l32.13"></a><span id="l32.13">   static NS_MSG_BASE_STATIC_MEMBER_(nsrefcnt) mInstanceCount;</span>
<a href="#l32.14"></a><span id="l32.14"> </span>
<a href="#l32.15"></a><span id="l32.15"> protected:</span>
<a href="#l32.16"></a><span id="l32.16">   PRUint32 mFlags;</span>
<a href="#l32.17"></a><span id="l32.17">   nsWeakPtr mParent;     //This won't be refcounted for ownership reasons.</span>
<a href="#l32.18"></a><span id="l32.18">   PRInt32 mNumUnreadMessages;        /* count of unread messages (-1 means unknown; -2 means unknown but we already tried to find out.) */</span>
<a href="#l32.19"></a><span id="l32.19">   PRInt32 mNumTotalMessages;         /* count of existing messages. */</span>
<a href="#l32.20"></a><span id="l32.20">   PRBool mNotifyCountChanges;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1" class="difflineminus">--- a/mailnews/base/util/nsMsgProtocol.cpp</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgProtocol.cpp</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineat">@@ -274,16 +274,24 @@ nsresult nsMsgProtocol::OpenFileSocket(n</span>
<a href="#l33.4"></a><span id="l33.4">   rv = sts-&gt;CreateInputTransport(stream, nsInt64(aStartPosition),</span>
<a href="#l33.5"></a><span id="l33.5">                                  nsInt64(aReadCount), PR_TRUE,</span>
<a href="#l33.6"></a><span id="l33.6">                                  getter_AddRefs(m_transport));</span>
<a href="#l33.7"></a><span id="l33.7"> </span>
<a href="#l33.8"></a><span id="l33.8">   m_socketIsOpen = PR_FALSE;</span>
<a href="#l33.9"></a><span id="l33.9">   return rv;</span>
<a href="#l33.10"></a><span id="l33.10"> }</span>
<a href="#l33.11"></a><span id="l33.11"> </span>
<a href="#l33.12"></a><span id="l33.12" class="difflineplus">+nsresult nsMsgProtocol::GetTopmostMsgWindow(nsIMsgWindow **aWindow)</span>
<a href="#l33.13"></a><span id="l33.13" class="difflineplus">+{</span>
<a href="#l33.14"></a><span id="l33.14" class="difflineplus">+  nsresult rv;</span>
<a href="#l33.15"></a><span id="l33.15" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMailSession&gt; mailSession(do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv));</span>
<a href="#l33.16"></a><span id="l33.16" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l33.17"></a><span id="l33.17" class="difflineplus">+  return mailSession-&gt;GetTopmostMsgWindow(aWindow);</span>
<a href="#l33.18"></a><span id="l33.18" class="difflineplus">+}</span>
<a href="#l33.19"></a><span id="l33.19" class="difflineplus">+</span>
<a href="#l33.20"></a><span id="l33.20"> nsresult nsMsgProtocol::SetupTransportState()</span>
<a href="#l33.21"></a><span id="l33.21"> {</span>
<a href="#l33.22"></a><span id="l33.22">   if (!m_socketIsOpen &amp;&amp; m_transport)</span>
<a href="#l33.23"></a><span id="l33.23">   {</span>
<a href="#l33.24"></a><span id="l33.24">     nsresult rv;</span>
<a href="#l33.25"></a><span id="l33.25"> </span>
<a href="#l33.26"></a><span id="l33.26">     // open buffered, blocking output stream</span>
<a href="#l33.27"></a><span id="l33.27">     rv = m_transport-&gt;OpenOutputStream(nsITransport::OPEN_BLOCKING, 0, 0, getter_AddRefs(m_outputStream));</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1" class="difflineminus">--- a/mailnews/base/util/nsMsgProtocol.h</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgProtocol.h</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineat">@@ -49,16 +49,18 @@</span>
<a href="#l34.4"></a><span id="l34.4"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l34.5"></a><span id="l34.5"> #include &quot;nsIInterfaceRequestor.h&quot;</span>
<a href="#l34.6"></a><span id="l34.6"> #include &quot;nsIInterfaceRequestorUtils.h&quot;</span>
<a href="#l34.7"></a><span id="l34.7"> #include &quot;nsIProgressEventSink.h&quot;</span>
<a href="#l34.8"></a><span id="l34.8"> #include &quot;nsITransport.h&quot;</span>
<a href="#l34.9"></a><span id="l34.9"> #include &quot;nsIAsyncOutputStream.h&quot;</span>
<a href="#l34.10"></a><span id="l34.10"> #include &quot;nsIAuthModule.h&quot;</span>
<a href="#l34.11"></a><span id="l34.11"> </span>
<a href="#l34.12"></a><span id="l34.12" class="difflineplus">+class nsIMsgWindow;</span>
<a href="#l34.13"></a><span id="l34.13" class="difflineplus">+</span>
<a href="#l34.14"></a><span id="l34.14"> #define UNKNOWN_ERROR             101</span>
<a href="#l34.15"></a><span id="l34.15"> #define UNKNOWN_HOST_ERROR        102</span>
<a href="#l34.16"></a><span id="l34.16"> #define CONNECTION_REFUSED_ERROR  103</span>
<a href="#l34.17"></a><span id="l34.17"> #define NET_TIMEOUT_ERROR         104</span>
<a href="#l34.18"></a><span id="l34.18"> </span>
<a href="#l34.19"></a><span id="l34.19"> class nsIPrompt;</span>
<a href="#l34.20"></a><span id="l34.20"> class nsIMsgMailNewsUrl;</span>
<a href="#l34.21"></a><span id="l34.21"> class nsMsgFilePostHelper;</span>
<a href="#l34.22"></a><span id="l34.22" class="difflineat">@@ -118,16 +120,18 @@ protected:</span>
<a href="#l34.23"></a><span id="l34.23">                                              PRInt32 aGetPort,</span>
<a href="#l34.24"></a><span id="l34.24">                                              const char *connectionType,</span>
<a href="#l34.25"></a><span id="l34.25">                                              nsIProxyInfo *aProxyInfo,</span>
<a href="#l34.26"></a><span id="l34.26">                                              nsIInterfaceRequestor* callbacks);</span>
<a href="#l34.27"></a><span id="l34.27">   // helper routine</span>
<a href="#l34.28"></a><span id="l34.28">   nsresult GetFileFromURL(nsIURI * aURL, nsIFile **aResult);</span>
<a href="#l34.29"></a><span id="l34.29">   virtual nsresult OpenFileSocket(nsIURI * aURL, PRUint32 aStartPosition, PRInt32 aReadCount); // used to open a file socket connection</span>
<a href="#l34.30"></a><span id="l34.30"> </span>
<a href="#l34.31"></a><span id="l34.31" class="difflineplus">+  nsresult GetTopmostMsgWindow(nsIMsgWindow **aWindow);</span>
<a href="#l34.32"></a><span id="l34.32" class="difflineplus">+</span>
<a href="#l34.33"></a><span id="l34.33">   // a Protocol typically overrides this method. They free any of their own connection state and then</span>
<a href="#l34.34"></a><span id="l34.34">   // they call up into the base class to free the generic connection objects</span>
<a href="#l34.35"></a><span id="l34.35">   virtual nsresult CloseSocket(); </span>
<a href="#l34.36"></a><span id="l34.36"> </span>
<a href="#l34.37"></a><span id="l34.37">   virtual nsresult SetupTransportState(); // private method used by OpenNetworkSocket and OpenFileSocket</span>
<a href="#l34.38"></a><span id="l34.38"> </span>
<a href="#l34.39"></a><span id="l34.39">   // ProcessProtocolState - This is the function that gets churned by calls to OnDataAvailable. </span>
<a href="#l34.40"></a><span id="l34.40">   // As data arrives on the socket, OnDataAvailable calls ProcessProtocolState.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1" class="difflineminus">--- a/mailnews/db/gloda/modules/datamodel.js</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/datamodel.js</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineat">@@ -444,17 +444,18 @@ GlodaMessage.prototype = {</span>
<a href="#l35.4"></a><span id="l35.4">   toString: function gloda_message_toString() {</span>
<a href="#l35.5"></a><span id="l35.5">     // uh, this is a tough one...</span>
<a href="#l35.6"></a><span id="l35.6">     return &quot;Message:&quot; + this._id;</span>
<a href="#l35.7"></a><span id="l35.7">   },</span>
<a href="#l35.8"></a><span id="l35.8"> </span>
<a href="#l35.9"></a><span id="l35.9">   _clone: function gloda_message_clone() {</span>
<a href="#l35.10"></a><span id="l35.10">     return new GlodaMessage(this._datastore, this._id, this._folderID,</span>
<a href="#l35.11"></a><span id="l35.11">       this._messageKey, this._conversationID, this._conversation, this._date,</span>
<a href="#l35.12"></a><span id="l35.12" class="difflineminus">-      this._headerMessageID, this._deleted);</span>
<a href="#l35.13"></a><span id="l35.13" class="difflineplus">+      this._headerMessageID, this._deleted, this._jsonText, this._notability,</span>
<a href="#l35.14"></a><span id="l35.14" class="difflineplus">+      this._subject, this._indexedBodyText, this._attachmentNames);</span>
<a href="#l35.15"></a><span id="l35.15">   },</span>
<a href="#l35.16"></a><span id="l35.16"> </span>
<a href="#l35.17"></a><span id="l35.17">   _ghost: function gloda_message_ghost() {</span>
<a href="#l35.18"></a><span id="l35.18">     this._folderID = null;</span>
<a href="#l35.19"></a><span id="l35.19">     this._messageKey = null;</span>
<a href="#l35.20"></a><span id="l35.20">   },</span>
<a href="#l35.21"></a><span id="l35.21"> </span>
<a href="#l35.22"></a><span id="l35.22">   _nuke: function gloda_message_nuke() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1" class="difflineminus">--- a/mailnews/db/gloda/modules/datastore.js</span>
<a href="#l36.2"></a><span id="l36.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/datastore.js</span>
<a href="#l36.3"></a><span id="l36.3" class="difflineat">@@ -15,16 +15,17 @@</span>
<a href="#l36.4"></a><span id="l36.4">  *</span>
<a href="#l36.5"></a><span id="l36.5">  * The Initial Developer of the Original Code is</span>
<a href="#l36.6"></a><span id="l36.6">  * Mozilla Messaging, Inc.</span>
<a href="#l36.7"></a><span id="l36.7">  * Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l36.8"></a><span id="l36.8">  * the Initial Developer. All Rights Reserved.</span>
<a href="#l36.9"></a><span id="l36.9">  *</span>
<a href="#l36.10"></a><span id="l36.10">  * Contributor(s):</span>
<a href="#l36.11"></a><span id="l36.11">  *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l36.12"></a><span id="l36.12" class="difflineplus">+ *   Siddharth Agarwal &lt;sid.bugzilla@gmail.com&gt;</span>
<a href="#l36.13"></a><span id="l36.13">  *</span>
<a href="#l36.14"></a><span id="l36.14">  * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l36.15"></a><span id="l36.15">  * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l36.16"></a><span id="l36.16">  * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l36.17"></a><span id="l36.17">  * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l36.18"></a><span id="l36.18">  * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l36.19"></a><span id="l36.19">  * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l36.20"></a><span id="l36.20">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l36.21"></a><span id="l36.21" class="difflineat">@@ -48,62 +49,16 @@ const Cr = Components.results;</span>
<a href="#l36.22"></a><span id="l36.22"> const Cu = Components.utils;</span>
<a href="#l36.23"></a><span id="l36.23"> </span>
<a href="#l36.24"></a><span id="l36.24"> Cu.import(&quot;resource://app/modules/gloda/log4moz.js&quot;);</span>
<a href="#l36.25"></a><span id="l36.25"> </span>
<a href="#l36.26"></a><span id="l36.26"> Cu.import(&quot;resource://app/modules/gloda/datamodel.js&quot;);</span>
<a href="#l36.27"></a><span id="l36.27"> Cu.import(&quot;resource://app/modules/gloda/databind.js&quot;);</span>
<a href="#l36.28"></a><span id="l36.28"> Cu.import(&quot;resource://app/modules/gloda/collection.js&quot;);</span>
<a href="#l36.29"></a><span id="l36.29"> </span>
<a href="#l36.30"></a><span id="l36.30" class="difflineminus">-let MBM_LOG = Log4Moz.repository.getLogger(&quot;gloda.ds.mbm&quot;);</span>
<a href="#l36.31"></a><span id="l36.31" class="difflineminus">-</span>
<a href="#l36.32"></a><span id="l36.32" class="difflineminus">-/**</span>
<a href="#l36.33"></a><span id="l36.33" class="difflineminus">- * @class This callback handles processing the asynchronous query results of</span>
<a href="#l36.34"></a><span id="l36.34" class="difflineminus">- *  GlodaDatastore.getMessagesByMessageID.  Because that method is only</span>
<a href="#l36.35"></a><span id="l36.35" class="difflineminus">- *  called as part of the indexing process, we are guaranteed that there will</span>
<a href="#l36.36"></a><span id="l36.36" class="difflineminus">- *  be no real caching ramifications.  Accordingly, we can also defer our cache</span>
<a href="#l36.37"></a><span id="l36.37" class="difflineminus">- *  processing (via GlodaCollectionManager) until the query completes.</span>
<a href="#l36.38"></a><span id="l36.38" class="difflineminus">- *</span>
<a href="#l36.39"></a><span id="l36.39" class="difflineminus">- * @param aMsgIDToIndex Map from message-id to the desired</span>
<a href="#l36.40"></a><span id="l36.40" class="difflineminus">- *</span>
<a href="#l36.41"></a><span id="l36.41" class="difflineminus">- * @constructor</span>
<a href="#l36.42"></a><span id="l36.42" class="difflineminus">- */</span>
<a href="#l36.43"></a><span id="l36.43" class="difflineminus">-function MessagesByMessageIdCallback(aMsgIDToIndex, aResults,</span>
<a href="#l36.44"></a><span id="l36.44" class="difflineminus">-                                     aCallback, aCallbackThis) {</span>
<a href="#l36.45"></a><span id="l36.45" class="difflineminus">-  this.msgIDToIndex = aMsgIDToIndex;</span>
<a href="#l36.46"></a><span id="l36.46" class="difflineminus">-  this.results = aResults;</span>
<a href="#l36.47"></a><span id="l36.47" class="difflineminus">-  this.callback = aCallback;</span>
<a href="#l36.48"></a><span id="l36.48" class="difflineminus">-  this.callbackThis = aCallbackThis;</span>
<a href="#l36.49"></a><span id="l36.49" class="difflineminus">-}</span>
<a href="#l36.50"></a><span id="l36.50" class="difflineminus">-</span>
<a href="#l36.51"></a><span id="l36.51" class="difflineminus">-MessagesByMessageIdCallback.prototype = {</span>
<a href="#l36.52"></a><span id="l36.52" class="difflineminus">-  onItemsAdded: function gloda_ds_mbmi_onItemsAdded(aItems, aCollection) {</span>
<a href="#l36.53"></a><span id="l36.53" class="difflineminus">-    // just outright bail if we are shutdown</span>
<a href="#l36.54"></a><span id="l36.54" class="difflineminus">-    if (GlodaDatastore.datastoreIsShutdown)</span>
<a href="#l36.55"></a><span id="l36.55" class="difflineminus">-      return;</span>
<a href="#l36.56"></a><span id="l36.56" class="difflineminus">-</span>
<a href="#l36.57"></a><span id="l36.57" class="difflineminus">-    MBM_LOG.debug(&quot;getting results...&quot;);</span>
<a href="#l36.58"></a><span id="l36.58" class="difflineminus">-    for each (let [, message] in Iterator(aItems)) {</span>
<a href="#l36.59"></a><span id="l36.59" class="difflineminus">-      this.results[this.msgIDToIndex[message.headerMessageID]].push(message);</span>
<a href="#l36.60"></a><span id="l36.60" class="difflineminus">-    }</span>
<a href="#l36.61"></a><span id="l36.61" class="difflineminus">-  },</span>
<a href="#l36.62"></a><span id="l36.62" class="difflineminus">-  onItemsModified: function () {},</span>
<a href="#l36.63"></a><span id="l36.63" class="difflineminus">-  onItemsRemoved: function () {},</span>
<a href="#l36.64"></a><span id="l36.64" class="difflineminus">-  onQueryCompleted: function gloda_ds_mbmi_onQueryCompleted(aCollection) {</span>
<a href="#l36.65"></a><span id="l36.65" class="difflineminus">-    // just outright bail if we are shutdown</span>
<a href="#l36.66"></a><span id="l36.66" class="difflineminus">-    if (GlodaDatastore.datastoreIsShutdown)</span>
<a href="#l36.67"></a><span id="l36.67" class="difflineminus">-      return;</span>
<a href="#l36.68"></a><span id="l36.68" class="difflineminus">-</span>
<a href="#l36.69"></a><span id="l36.69" class="difflineminus">-    MBM_LOG.debug(&quot;query completed, notifying... &quot; + this.results);</span>
<a href="#l36.70"></a><span id="l36.70" class="difflineminus">-    // we no longer need to unify; it is done for us.</span>
<a href="#l36.71"></a><span id="l36.71" class="difflineminus">-</span>
<a href="#l36.72"></a><span id="l36.72" class="difflineminus">-    this.callback.call(this.callbackThis, this.results);</span>
<a href="#l36.73"></a><span id="l36.73" class="difflineminus">-  }</span>
<a href="#l36.74"></a><span id="l36.74" class="difflineminus">-};</span>
<a href="#l36.75"></a><span id="l36.75" class="difflineminus">-</span>
<a href="#l36.76"></a><span id="l36.76"> let PCH_LOG = Log4Moz.repository.getLogger(&quot;gloda.ds.pch&quot;);</span>
<a href="#l36.77"></a><span id="l36.77"> </span>
<a href="#l36.78"></a><span id="l36.78"> function PostCommitHandler(aCallbacks) {</span>
<a href="#l36.79"></a><span id="l36.79">   this.callbacks = aCallbacks;</span>
<a href="#l36.80"></a><span id="l36.80">   GlodaDatastore._pendingAsyncStatements++;</span>
<a href="#l36.81"></a><span id="l36.81"> }</span>
<a href="#l36.82"></a><span id="l36.82"> </span>
<a href="#l36.83"></a><span id="l36.83"> PostCommitHandler.prototype = {</span>
<a href="#l36.84"></a><span id="l36.84" class="difflineat">@@ -1883,44 +1838,56 @@ var GlodaDatastore = {</span>
<a href="#l36.85"></a><span id="l36.85">        ims.executeAsync(this.trackAsync());</span>
<a href="#l36.86"></a><span id="l36.86">     }</span>
<a href="#l36.87"></a><span id="l36.87">     catch(ex) {</span>
<a href="#l36.88"></a><span id="l36.88">        throw(&quot;error executing statement... &quot; +</span>
<a href="#l36.89"></a><span id="l36.89">              this.asyncConnection.lastError + &quot;: &quot; +</span>
<a href="#l36.90"></a><span id="l36.90">              this.asyncConnection.lastErrorString + &quot; - &quot; + ex);</span>
<a href="#l36.91"></a><span id="l36.91">     }</span>
<a href="#l36.92"></a><span id="l36.92"> </span>
<a href="#l36.93"></a><span id="l36.93" class="difflineminus">-    // we only create the full-text row if the body is non-null.</span>
<a href="#l36.94"></a><span id="l36.94" class="difflineminus">-    // so, even though body might be null, we still want to create the</span>
<a href="#l36.95"></a><span id="l36.95" class="difflineminus">-    //  full-text search row</span>
<a href="#l36.96"></a><span id="l36.96" class="difflineminus">-    if (aMessage._bodyLines) {</span>
<a href="#l36.97"></a><span id="l36.97" class="difflineminus">-      if (aMessage._content &amp;&amp; aMessage._content.hasContent())</span>
<a href="#l36.98"></a><span id="l36.98" class="difflineminus">-        aMessage._indexedBodyText = aMessage._content.getContentString(true);</span>
<a href="#l36.99"></a><span id="l36.99" class="difflineminus">-      else</span>
<a href="#l36.100"></a><span id="l36.100" class="difflineminus">-        aMessage._indexedBodyText = aMessage._bodyLines.join(&quot;\n&quot;);</span>
<a href="#l36.101"></a><span id="l36.101" class="difflineminus">-</span>
<a href="#l36.102"></a><span id="l36.102" class="difflineminus">-      let imts = this._insertMessageTextStatement;</span>
<a href="#l36.103"></a><span id="l36.103" class="difflineminus">-      imts.bindInt64Parameter(0, aMessage.id);</span>
<a href="#l36.104"></a><span id="l36.104" class="difflineminus">-      imts.bindStringParameter(1, aMessage._subject);</span>
<a href="#l36.105"></a><span id="l36.105" class="difflineplus">+    // we create the full-text row for any message that isn't a ghost,</span>
<a href="#l36.106"></a><span id="l36.106" class="difflineplus">+    // whether we have the body or not</span>
<a href="#l36.107"></a><span id="l36.107" class="difflineplus">+    if (aMessage.folderID !== null)</span>
<a href="#l36.108"></a><span id="l36.108" class="difflineplus">+      this._insertMessageText(aMessage);</span>
<a href="#l36.109"></a><span id="l36.109" class="difflineplus">+  },</span>
<a href="#l36.110"></a><span id="l36.110" class="difflineplus">+</span>
<a href="#l36.111"></a><span id="l36.111" class="difflineplus">+  /**</span>
<a href="#l36.112"></a><span id="l36.112" class="difflineplus">+   * Inserts a full-text row. This should only be called if you're sure you want</span>
<a href="#l36.113"></a><span id="l36.113" class="difflineplus">+   * to insert a row into the table.</span>
<a href="#l36.114"></a><span id="l36.114" class="difflineplus">+   */</span>
<a href="#l36.115"></a><span id="l36.115" class="difflineplus">+  _insertMessageText: function gloda_ds__insertMessageText(aMessage) {</span>
<a href="#l36.116"></a><span id="l36.116" class="difflineplus">+    if (aMessage._content &amp;&amp; aMessage._content.hasContent())</span>
<a href="#l36.117"></a><span id="l36.117" class="difflineplus">+      aMessage._indexedBodyText = aMessage._content.getContentString(true);</span>
<a href="#l36.118"></a><span id="l36.118" class="difflineplus">+    else if (aMessage._bodyLines)</span>
<a href="#l36.119"></a><span id="l36.119" class="difflineplus">+      aMessage._indexedBodyText = aMessage._bodyLines.join(&quot;\n&quot;);</span>
<a href="#l36.120"></a><span id="l36.120" class="difflineplus">+    else</span>
<a href="#l36.121"></a><span id="l36.121" class="difflineplus">+      aMessage._indexedBodyText = null;</span>
<a href="#l36.122"></a><span id="l36.122" class="difflineplus">+</span>
<a href="#l36.123"></a><span id="l36.123" class="difflineplus">+    let imts = this._insertMessageTextStatement;</span>
<a href="#l36.124"></a><span id="l36.124" class="difflineplus">+    imts.bindInt64Parameter(0, aMessage.id);</span>
<a href="#l36.125"></a><span id="l36.125" class="difflineplus">+    imts.bindStringParameter(1, aMessage._subject);</span>
<a href="#l36.126"></a><span id="l36.126" class="difflineplus">+    if (aMessage._indexedBodyText == null)</span>
<a href="#l36.127"></a><span id="l36.127" class="difflineplus">+      imts.bindNullParameter(2);</span>
<a href="#l36.128"></a><span id="l36.128" class="difflineplus">+    else</span>
<a href="#l36.129"></a><span id="l36.129">       imts.bindStringParameter(2, aMessage._indexedBodyText);</span>
<a href="#l36.130"></a><span id="l36.130" class="difflineminus">-      if (aMessage._attachmentNames === null)</span>
<a href="#l36.131"></a><span id="l36.131" class="difflineminus">-        imts.bindNullParameter(3);</span>
<a href="#l36.132"></a><span id="l36.132" class="difflineminus">-      else</span>
<a href="#l36.133"></a><span id="l36.133" class="difflineminus">-        imts.bindStringParameter(3, aMessage._attachmentNames.join(&quot;\n&quot;));</span>
<a href="#l36.134"></a><span id="l36.134" class="difflineminus">-      imts.bindStringParameter(4, aMessage._indexAuthor);</span>
<a href="#l36.135"></a><span id="l36.135" class="difflineminus">-      imts.bindStringParameter(5, aMessage._indexRecipients);</span>
<a href="#l36.136"></a><span id="l36.136" class="difflineminus">-</span>
<a href="#l36.137"></a><span id="l36.137" class="difflineminus">-      try {</span>
<a href="#l36.138"></a><span id="l36.138" class="difflineminus">-         imts.executeAsync(this.trackAsync());</span>
<a href="#l36.139"></a><span id="l36.139" class="difflineminus">-      }</span>
<a href="#l36.140"></a><span id="l36.140" class="difflineminus">-      catch(ex) {</span>
<a href="#l36.141"></a><span id="l36.141" class="difflineminus">-         throw(&quot;error executing fulltext statement... &quot; +</span>
<a href="#l36.142"></a><span id="l36.142" class="difflineminus">-               this.asyncConnection.lastError + &quot;: &quot; +</span>
<a href="#l36.143"></a><span id="l36.143" class="difflineminus">-               this.asyncConnection.lastErrorString + &quot; - &quot; + ex);</span>
<a href="#l36.144"></a><span id="l36.144" class="difflineminus">-      }</span>
<a href="#l36.145"></a><span id="l36.145" class="difflineplus">+    if (aMessage._attachmentNames === null)</span>
<a href="#l36.146"></a><span id="l36.146" class="difflineplus">+      imts.bindNullParameter(3);</span>
<a href="#l36.147"></a><span id="l36.147" class="difflineplus">+    else</span>
<a href="#l36.148"></a><span id="l36.148" class="difflineplus">+      imts.bindStringParameter(3, aMessage._attachmentNames.join(&quot;\n&quot;));</span>
<a href="#l36.149"></a><span id="l36.149" class="difflineplus">+</span>
<a href="#l36.150"></a><span id="l36.150" class="difflineplus">+    imts.bindStringParameter(4, aMessage._indexAuthor);</span>
<a href="#l36.151"></a><span id="l36.151" class="difflineplus">+    imts.bindStringParameter(5, aMessage._indexRecipients);</span>
<a href="#l36.152"></a><span id="l36.152" class="difflineplus">+</span>
<a href="#l36.153"></a><span id="l36.153" class="difflineplus">+    try {</span>
<a href="#l36.154"></a><span id="l36.154" class="difflineplus">+      imts.executeAsync(this.trackAsync());</span>
<a href="#l36.155"></a><span id="l36.155" class="difflineplus">+    }</span>
<a href="#l36.156"></a><span id="l36.156" class="difflineplus">+    catch(ex) {</span>
<a href="#l36.157"></a><span id="l36.157" class="difflineplus">+      throw(&quot;error executing fulltext statement... &quot; +</span>
<a href="#l36.158"></a><span id="l36.158" class="difflineplus">+            this.asyncConnection.lastError + &quot;: &quot; +</span>
<a href="#l36.159"></a><span id="l36.159" class="difflineplus">+            this.asyncConnection.lastErrorString + &quot; - &quot; + ex);</span>
<a href="#l36.160"></a><span id="l36.160">     }</span>
<a href="#l36.161"></a><span id="l36.161">   },</span>
<a href="#l36.162"></a><span id="l36.162"> </span>
<a href="#l36.163"></a><span id="l36.163">   get _updateMessageStatement() {</span>
<a href="#l36.164"></a><span id="l36.164">     let statement = this._createAsyncStatement(</span>
<a href="#l36.165"></a><span id="l36.165">       &quot;UPDATE messages SET folderID = ?1, \</span>
<a href="#l36.166"></a><span id="l36.166">                            messageKey = ?2, \</span>
<a href="#l36.167"></a><span id="l36.167">                            conversationID = ?3, \</span>
<a href="#l36.168"></a><span id="l36.168" class="difflineat">@@ -1928,20 +1895,34 @@ var GlodaDatastore = {</span>
<a href="#l36.169"></a><span id="l36.169">                            headerMessageID = ?5, \</span>
<a href="#l36.170"></a><span id="l36.170">                            jsonAttributes = ?6, \</span>
<a href="#l36.171"></a><span id="l36.171">                            notability = ?7 \</span>
<a href="#l36.172"></a><span id="l36.172">               WHERE id = ?8&quot;);</span>
<a href="#l36.173"></a><span id="l36.173">     this.__defineGetter__(&quot;_updateMessageStatement&quot;, function() statement);</span>
<a href="#l36.174"></a><span id="l36.174">     return this._updateMessageStatement;</span>
<a href="#l36.175"></a><span id="l36.175">   },</span>
<a href="#l36.176"></a><span id="l36.176"> </span>
<a href="#l36.177"></a><span id="l36.177" class="difflineplus">+  get _updateMessageTextStatement() {</span>
<a href="#l36.178"></a><span id="l36.178" class="difflineplus">+    let statement = this._createAsyncStatement(</span>
<a href="#l36.179"></a><span id="l36.179" class="difflineplus">+      &quot;UPDATE messagesText SET body = ?1, \</span>
<a href="#l36.180"></a><span id="l36.180" class="difflineplus">+                               attachmentNames = ?2 \</span>
<a href="#l36.181"></a><span id="l36.181" class="difflineplus">+              WHERE docid = ?3&quot;);</span>
<a href="#l36.182"></a><span id="l36.182" class="difflineplus">+</span>
<a href="#l36.183"></a><span id="l36.183" class="difflineplus">+    this.__defineGetter__(&quot;_updateMessageTextStatement&quot;, function() statement);</span>
<a href="#l36.184"></a><span id="l36.184" class="difflineplus">+    return this._updateMessageTextStatement;</span>
<a href="#l36.185"></a><span id="l36.185" class="difflineplus">+  },</span>
<a href="#l36.186"></a><span id="l36.186" class="difflineplus">+</span>
<a href="#l36.187"></a><span id="l36.187">   /**</span>
<a href="#l36.188"></a><span id="l36.188" class="difflineminus">-   * Update the database row associated with the message.  If aBody is supplied,</span>
<a href="#l36.189"></a><span id="l36.189" class="difflineminus">-   *  the associated full-text row is created; it is assumed that it did not</span>
<a href="#l36.190"></a><span id="l36.190" class="difflineminus">-   *  previously exist.</span>
<a href="#l36.191"></a><span id="l36.191" class="difflineplus">+   * Update the database row associated with the message. If the message is</span>
<a href="#l36.192"></a><span id="l36.192" class="difflineplus">+   * not a ghost and has _isNew defined, messagesText is affected.</span>
<a href="#l36.193"></a><span id="l36.193" class="difflineplus">+   *</span>
<a href="#l36.194"></a><span id="l36.194" class="difflineplus">+   * aMessage._isNew is currently equivalent to the fact that there is no</span>
<a href="#l36.195"></a><span id="l36.195" class="difflineplus">+   * full-text row associated with this message, and we work with this</span>
<a href="#l36.196"></a><span id="l36.196" class="difflineplus">+   * assumption here. Note that if aMessage._isNew is not defined, then</span>
<a href="#l36.197"></a><span id="l36.197" class="difflineplus">+   * we don't do anything.</span>
<a href="#l36.198"></a><span id="l36.198">    */</span>
<a href="#l36.199"></a><span id="l36.199">   updateMessage: function gloda_ds_updateMessage(aMessage) {</span>
<a href="#l36.200"></a><span id="l36.200">     let ums = this._updateMessageStatement;</span>
<a href="#l36.201"></a><span id="l36.201">     ums.bindInt64Parameter(7, aMessage.id);</span>
<a href="#l36.202"></a><span id="l36.202">     if (aMessage.folderID === null)</span>
<a href="#l36.203"></a><span id="l36.203">       ums.bindNullParameter(0);</span>
<a href="#l36.204"></a><span id="l36.204">     else</span>
<a href="#l36.205"></a><span id="l36.205">       ums.bindInt64Parameter(0, aMessage.folderID);</span>
<a href="#l36.206"></a><span id="l36.206" class="difflineat">@@ -1958,49 +1939,74 @@ var GlodaDatastore = {</span>
<a href="#l36.207"></a><span id="l36.207">     if (aMessage._jsonText)</span>
<a href="#l36.208"></a><span id="l36.208">       ums.bindStringParameter(5, aMessage._jsonText);</span>
<a href="#l36.209"></a><span id="l36.209">     else</span>
<a href="#l36.210"></a><span id="l36.210">       ums.bindNullParameter(5);</span>
<a href="#l36.211"></a><span id="l36.211">     ums.bindInt64Parameter(6, aMessage.notability);</span>
<a href="#l36.212"></a><span id="l36.212"> </span>
<a href="#l36.213"></a><span id="l36.213">     ums.executeAsync(this.trackAsync());</span>
<a href="#l36.214"></a><span id="l36.214"> </span>
<a href="#l36.215"></a><span id="l36.215" class="difflineminus">-    if (aMessage._isNew &amp;&amp; aMessage._bodyLines) {</span>
<a href="#l36.216"></a><span id="l36.216" class="difflineminus">-      if (aMessage._content &amp;&amp; aMessage._content.hasContent())</span>
<a href="#l36.217"></a><span id="l36.217" class="difflineminus">-        aMessage._indexedBodyText = aMessage._content.getContentString(true);</span>
<a href="#l36.218"></a><span id="l36.218" class="difflineminus">-      else</span>
<a href="#l36.219"></a><span id="l36.219" class="difflineminus">-        aMessage._indexedBodyText = aMessage._bodyLines.join(&quot;\n&quot;);</span>
<a href="#l36.220"></a><span id="l36.220" class="difflineminus">-</span>
<a href="#l36.221"></a><span id="l36.221" class="difflineminus">-      let imts = this._insertMessageTextStatement;</span>
<a href="#l36.222"></a><span id="l36.222" class="difflineminus">-      imts.bindInt64Parameter(0, aMessage.id);</span>
<a href="#l36.223"></a><span id="l36.223" class="difflineminus">-      imts.bindStringParameter(1, aMessage._subject);</span>
<a href="#l36.224"></a><span id="l36.224" class="difflineminus">-      imts.bindStringParameter(2, aMessage._indexedBodyText);</span>
<a href="#l36.225"></a><span id="l36.225" class="difflineminus">-      if (aMessage._attachmentNames === null)</span>
<a href="#l36.226"></a><span id="l36.226" class="difflineminus">-        imts.bindNullParameter(3);</span>
<a href="#l36.227"></a><span id="l36.227" class="difflineplus">+    if (aMessage.folderID !== null) {</span>
<a href="#l36.228"></a><span id="l36.228" class="difflineplus">+      if (aMessage._isNew === true)</span>
<a href="#l36.229"></a><span id="l36.229" class="difflineplus">+        this._insertMessageText(aMessage);</span>
<a href="#l36.230"></a><span id="l36.230">       else</span>
<a href="#l36.231"></a><span id="l36.231" class="difflineminus">-        imts.bindStringParameter(3, aMessage._attachmentNames.join(&quot;\n&quot;));</span>
<a href="#l36.232"></a><span id="l36.232" class="difflineminus">-      imts.bindStringParameter(4, aMessage._indexAuthor);</span>
<a href="#l36.233"></a><span id="l36.233" class="difflineminus">-      imts.bindStringParameter(5, aMessage._indexRecipients);</span>
<a href="#l36.234"></a><span id="l36.234" class="difflineminus">-</span>
<a href="#l36.235"></a><span id="l36.235" class="difflineminus">-      try {</span>
<a href="#l36.236"></a><span id="l36.236" class="difflineminus">-         imts.executeAsync(this.trackAsync());</span>
<a href="#l36.237"></a><span id="l36.237" class="difflineminus">-      }</span>
<a href="#l36.238"></a><span id="l36.238" class="difflineminus">-      catch(ex) {</span>
<a href="#l36.239"></a><span id="l36.239" class="difflineminus">-         throw(&quot;error executing fulltext statement... &quot; +</span>
<a href="#l36.240"></a><span id="l36.240" class="difflineminus">-               this.asyncConnection.lastError + &quot;: &quot; +</span>
<a href="#l36.241"></a><span id="l36.241" class="difflineminus">-               this.asyncConnection.lastErrorString + &quot; - &quot; + ex);</span>
<a href="#l36.242"></a><span id="l36.242" class="difflineminus">-      }</span>
<a href="#l36.243"></a><span id="l36.243" class="difflineplus">+        this._updateMessageText(aMessage);</span>
<a href="#l36.244"></a><span id="l36.244">     }</span>
<a href="#l36.245"></a><span id="l36.245"> </span>
<a href="#l36.246"></a><span id="l36.246">     // In completely abstract theory, this is where we would call</span>
<a href="#l36.247"></a><span id="l36.247">     //  GlodaCollectionManager.itemsModified, except that the attributes may</span>
<a href="#l36.248"></a><span id="l36.248">     //  also have changed, so it's out of our hands.  (Gloda.grokNoun</span>
<a href="#l36.249"></a><span id="l36.249">     //  handles it.)</span>
<a href="#l36.250"></a><span id="l36.250">   },</span>
<a href="#l36.251"></a><span id="l36.251"> </span>
<a href="#l36.252"></a><span id="l36.252" class="difflineplus">+  /**</span>
<a href="#l36.253"></a><span id="l36.253" class="difflineplus">+   * Updates the full-text row associated with this message. This only performs</span>
<a href="#l36.254"></a><span id="l36.254" class="difflineplus">+   * the UPDATE query if the indexed body text has changed, which means that if</span>
<a href="#l36.255"></a><span id="l36.255" class="difflineplus">+   * the body hasn't changed but the attachments have, we don't update.</span>
<a href="#l36.256"></a><span id="l36.256" class="difflineplus">+   */</span>
<a href="#l36.257"></a><span id="l36.257" class="difflineplus">+  _updateMessageText: function gloda_ds__updateMessageText(aMessage) {</span>
<a href="#l36.258"></a><span id="l36.258" class="difflineplus">+    let newIndexedBodyText;</span>
<a href="#l36.259"></a><span id="l36.259" class="difflineplus">+    if (aMessage._content &amp;&amp; aMessage._content.hasContent())</span>
<a href="#l36.260"></a><span id="l36.260" class="difflineplus">+      newIndexedBodyText = aMessage._content.getContentString(true);</span>
<a href="#l36.261"></a><span id="l36.261" class="difflineplus">+    else if (aMessage._bodyLines)</span>
<a href="#l36.262"></a><span id="l36.262" class="difflineplus">+      newIndexedBodyText = aMessage._bodyLines.join(&quot;\n&quot;);</span>
<a href="#l36.263"></a><span id="l36.263" class="difflineplus">+    else</span>
<a href="#l36.264"></a><span id="l36.264" class="difflineplus">+      newIndexedBodyText = null;</span>
<a href="#l36.265"></a><span id="l36.265" class="difflineplus">+</span>
<a href="#l36.266"></a><span id="l36.266" class="difflineplus">+    // If the body text matches, don't perform an update</span>
<a href="#l36.267"></a><span id="l36.267" class="difflineplus">+    if (newIndexedBodyText == aMessage._indexedBodyText) {</span>
<a href="#l36.268"></a><span id="l36.268" class="difflineplus">+      this._log.debug(&quot;in _updateMessageText, skipping update because body matches&quot;);</span>
<a href="#l36.269"></a><span id="l36.269" class="difflineplus">+      return;</span>
<a href="#l36.270"></a><span id="l36.270" class="difflineplus">+    }</span>
<a href="#l36.271"></a><span id="l36.271" class="difflineplus">+</span>
<a href="#l36.272"></a><span id="l36.272" class="difflineplus">+    aMessage._indexedBodyText = newIndexedBodyText;</span>
<a href="#l36.273"></a><span id="l36.273" class="difflineplus">+</span>
<a href="#l36.274"></a><span id="l36.274" class="difflineplus">+    let umts = this._updateMessageTextStatement;</span>
<a href="#l36.275"></a><span id="l36.275" class="difflineplus">+    umts.bindInt64Parameter(2, aMessage.id);</span>
<a href="#l36.276"></a><span id="l36.276" class="difflineplus">+</span>
<a href="#l36.277"></a><span id="l36.277" class="difflineplus">+    if (aMessage._indexedBodyText == null)</span>
<a href="#l36.278"></a><span id="l36.278" class="difflineplus">+      umts.bindNullParameter(0);</span>
<a href="#l36.279"></a><span id="l36.279" class="difflineplus">+    else</span>
<a href="#l36.280"></a><span id="l36.280" class="difflineplus">+      umts.bindStringParameter(0, aMessage._indexedBodyText);</span>
<a href="#l36.281"></a><span id="l36.281" class="difflineplus">+</span>
<a href="#l36.282"></a><span id="l36.282" class="difflineplus">+    if (aMessage._attachmentNames == null)</span>
<a href="#l36.283"></a><span id="l36.283" class="difflineplus">+      umts.bindNullParameter(1);</span>
<a href="#l36.284"></a><span id="l36.284" class="difflineplus">+    else</span>
<a href="#l36.285"></a><span id="l36.285" class="difflineplus">+      umts.bindStringParameter(1, aMessage._attachmentNames.join(&quot;\n&quot;));</span>
<a href="#l36.286"></a><span id="l36.286" class="difflineplus">+</span>
<a href="#l36.287"></a><span id="l36.287" class="difflineplus">+    try {</span>
<a href="#l36.288"></a><span id="l36.288" class="difflineplus">+      umts.executeAsync(this.trackAsync());</span>
<a href="#l36.289"></a><span id="l36.289" class="difflineplus">+    }</span>
<a href="#l36.290"></a><span id="l36.290" class="difflineplus">+    catch(ex) {</span>
<a href="#l36.291"></a><span id="l36.291" class="difflineplus">+      throw(&quot;error executing fulltext statement... &quot; +</span>
<a href="#l36.292"></a><span id="l36.292" class="difflineplus">+            this.asyncConnection.lastError + &quot;: &quot; +</span>
<a href="#l36.293"></a><span id="l36.293" class="difflineplus">+            this.asyncConnection.lastErrorString + &quot; - &quot; + ex);</span>
<a href="#l36.294"></a><span id="l36.294" class="difflineplus">+    }</span>
<a href="#l36.295"></a><span id="l36.295" class="difflineplus">+  },</span>
<a href="#l36.296"></a><span id="l36.296" class="difflineplus">+</span>
<a href="#l36.297"></a><span id="l36.297">   get _updateMessageLocationStatement() {</span>
<a href="#l36.298"></a><span id="l36.298">     let statement = this._createAsyncStatement(</span>
<a href="#l36.299"></a><span id="l36.299">       &quot;UPDATE messages SET folderID = ?1, messageKey = ?2 WHERE id = ?3&quot;);</span>
<a href="#l36.300"></a><span id="l36.300">     this.__defineGetter__(&quot;_updateMessageLocationStatement&quot;,</span>
<a href="#l36.301"></a><span id="l36.301">                           function() statement);</span>
<a href="#l36.302"></a><span id="l36.302">     return this._updateMessageLocationStatement;</span>
<a href="#l36.303"></a><span id="l36.303">   },</span>
<a href="#l36.304"></a><span id="l36.304"> </span>
<a href="#l36.305"></a><span id="l36.305" class="difflineat">@@ -2207,59 +2213,16 @@ var GlodaDatastore = {</span>
<a href="#l36.306"></a><span id="l36.306">     while (this._syncStep(smidbfs)) {</span>
<a href="#l36.307"></a><span id="l36.307">       messageIDs.push(smidbfs.getInt64(0));</span>
<a href="#l36.308"></a><span id="l36.308">     }</span>
<a href="#l36.309"></a><span id="l36.309">     smidbfs.reset();</span>
<a href="#l36.310"></a><span id="l36.310"> </span>
<a href="#l36.311"></a><span id="l36.311">     return messageIDs;</span>
<a href="#l36.312"></a><span id="l36.312">   },</span>
<a href="#l36.313"></a><span id="l36.313"> </span>
<a href="#l36.314"></a><span id="l36.314" class="difflineminus">-  /**</span>
<a href="#l36.315"></a><span id="l36.315" class="difflineminus">-   * Given a list of Message-ID's, return a matching list of lists of messages</span>
<a href="#l36.316"></a><span id="l36.316" class="difflineminus">-   *  matching those Message-ID's.  So if you pass an array with three</span>
<a href="#l36.317"></a><span id="l36.317" class="difflineminus">-   *  Message-ID's [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;], you would get back an array containing</span>
<a href="#l36.318"></a><span id="l36.318" class="difflineminus">-   *  3 lists, where the first list contains all the messages with a message-id</span>
<a href="#l36.319"></a><span id="l36.319" class="difflineminus">-   *  of &quot;a&quot;, and so forth.  The reason a list is returned rather than null/a</span>
<a href="#l36.320"></a><span id="l36.320" class="difflineminus">-   *  message is that we accept the reality that we have multiple copies of</span>
<a href="#l36.321"></a><span id="l36.321" class="difflineminus">-   *  messages with the same ID.</span>
<a href="#l36.322"></a><span id="l36.322" class="difflineminus">-   * This call is asynchronous because it depends on previously created messages</span>
<a href="#l36.323"></a><span id="l36.323" class="difflineminus">-   *  to be reflected in our results, which requires us to execute on the async</span>
<a href="#l36.324"></a><span id="l36.324" class="difflineminus">-   *  thread where all our writes happen.  This also turns out to be a</span>
<a href="#l36.325"></a><span id="l36.325" class="difflineminus">-   *  reasonable thing because we could imagine pathological cases where there</span>
<a href="#l36.326"></a><span id="l36.326" class="difflineminus">-   *  could be a lot of message-id's and/or a lot of messages with those</span>
<a href="#l36.327"></a><span id="l36.327" class="difflineminus">-   *  message-id's.</span>
<a href="#l36.328"></a><span id="l36.328" class="difflineminus">-   */</span>
<a href="#l36.329"></a><span id="l36.329" class="difflineminus">-  getMessagesByMessageID: function gloda_ds_getMessagesByMessageID(aMessageIDs,</span>
<a href="#l36.330"></a><span id="l36.330" class="difflineminus">-      aCallback, aCallbackThis) {</span>
<a href="#l36.331"></a><span id="l36.331" class="difflineminus">-    let msgIDToIndex = {};</span>
<a href="#l36.332"></a><span id="l36.332" class="difflineminus">-    let results = [];</span>
<a href="#l36.333"></a><span id="l36.333" class="difflineminus">-    for (let iID = 0; iID &lt; aMessageIDs.length; ++iID) {</span>
<a href="#l36.334"></a><span id="l36.334" class="difflineminus">-      let msgID = aMessageIDs[iID];</span>
<a href="#l36.335"></a><span id="l36.335" class="difflineminus">-      results.push([]);</span>
<a href="#l36.336"></a><span id="l36.336" class="difflineminus">-      msgIDToIndex[msgID] = iID;</span>
<a href="#l36.337"></a><span id="l36.337" class="difflineminus">-    }</span>
<a href="#l36.338"></a><span id="l36.338" class="difflineminus">-</span>
<a href="#l36.339"></a><span id="l36.339" class="difflineminus">-    // Unfortunately, IN doesn't work with statement binding mechanisms, and</span>
<a href="#l36.340"></a><span id="l36.340" class="difflineminus">-    //  a chain of ORed tests really can't be bound unless we create one per</span>
<a href="#l36.341"></a><span id="l36.341" class="difflineminus">-    //  value of N (seems silly).</span>
<a href="#l36.342"></a><span id="l36.342" class="difflineminus">-    let quotedIDs = [&quot;'&quot; + msgID.replace(&quot;'&quot;, &quot;''&quot;, &quot;g&quot;) + &quot;'&quot; for each</span>
<a href="#l36.343"></a><span id="l36.343" class="difflineminus">-                     ([i, msgID] in Iterator(aMessageIDs))]</span>
<a href="#l36.344"></a><span id="l36.344" class="difflineminus">-    let sqlString = &quot;SELECT * FROM messages WHERE headerMessageID IN (&quot; +</span>
<a href="#l36.345"></a><span id="l36.345" class="difflineminus">-                    quotedIDs + &quot;)&quot;;</span>
<a href="#l36.346"></a><span id="l36.346" class="difflineminus">-</span>
<a href="#l36.347"></a><span id="l36.347" class="difflineminus">-    let nounDef = GlodaMessage.prototype.NOUN_DEF;</span>
<a href="#l36.348"></a><span id="l36.348" class="difflineminus">-    let listener = new MessagesByMessageIdCallback(msgIDToIndex, results,</span>
<a href="#l36.349"></a><span id="l36.349" class="difflineminus">-        aCallback, aCallbackThis);</span>
<a href="#l36.350"></a><span id="l36.350" class="difflineminus">-    // Use a null query because we don't want any update notifications about our</span>
<a href="#l36.351"></a><span id="l36.351" class="difflineminus">-    //  collection.  They would just confuse and anger the listener.</span>
<a href="#l36.352"></a><span id="l36.352" class="difflineminus">-    let query = new nounDef.nullQueryClass();</span>
<a href="#l36.353"></a><span id="l36.353" class="difflineminus">-    return this._queryFromSQLString(sqlString, [], nounDef,</span>
<a href="#l36.354"></a><span id="l36.354" class="difflineminus">-        query, listener);</span>
<a href="#l36.355"></a><span id="l36.355" class="difflineminus">-  },</span>
<a href="#l36.356"></a><span id="l36.356" class="difflineminus">-</span>
<a href="#l36.357"></a><span id="l36.357">   get _updateMessagesMarkDeletedByFolderID() {</span>
<a href="#l36.358"></a><span id="l36.358">     let statement = this._createAsyncStatement(</span>
<a href="#l36.359"></a><span id="l36.359">       &quot;UPDATE messages SET folderID = NULL, messageKey = NULL, \</span>
<a href="#l36.360"></a><span id="l36.360">               deleted = 1 WHERE folderID = ?1&quot;);</span>
<a href="#l36.361"></a><span id="l36.361">     this.__defineGetter__(&quot;_updateMessagesMarkDeletedByFolderID&quot;,</span>
<a href="#l36.362"></a><span id="l36.362">       function() statement);</span>
<a href="#l36.363"></a><span id="l36.363">     return this._updateMessagesMarkDeletedByFolderID;</span>
<a href="#l36.364"></a><span id="l36.364">   },</span>
<a href="#l36.365"></a><span id="l36.365" class="difflineat">@@ -2758,18 +2721,22 @@ var GlodaDatastore = {</span>
<a href="#l36.366"></a><span id="l36.366">     let unionQueries = [aQuery].concat(aQuery._unions);</span>
<a href="#l36.367"></a><span id="l36.367">     let boundArgs = [];</span>
<a href="#l36.368"></a><span id="l36.368"> </span>
<a href="#l36.369"></a><span id="l36.369">     // Use the dbQueryValidityConstraintSuffix to provide constraints that</span>
<a href="#l36.370"></a><span id="l36.370">     //  filter items down to those that are valid for the query mechanism to</span>
<a href="#l36.371"></a><span id="l36.371">     //  return.  For example, in the case of messages, deleted or ghost</span>
<a href="#l36.372"></a><span id="l36.372">     //  messages should not be returned by this query layer.  We require</span>
<a href="#l36.373"></a><span id="l36.373">     //  hand-rolled SQL to do that for now.</span>
<a href="#l36.374"></a><span id="l36.374" class="difflineminus">-    let validityConstraintSuffix  =</span>
<a href="#l36.375"></a><span id="l36.375" class="difflineminus">-      nounDef.dbQueryValidityConstraintSuffix || &quot;&quot;;</span>
<a href="#l36.376"></a><span id="l36.376" class="difflineplus">+    let validityConstraintSuffix;</span>
<a href="#l36.377"></a><span id="l36.377" class="difflineplus">+    if (nounDef.dbQueryValidityConstraintSuffix &amp;&amp;</span>
<a href="#l36.378"></a><span id="l36.378" class="difflineplus">+        !aQuery.options.noDbQueryValidityConstraints)</span>
<a href="#l36.379"></a><span id="l36.379" class="difflineplus">+      validityConstraintSuffix = nounDef.dbQueryValidityConstraintSuffix;</span>
<a href="#l36.380"></a><span id="l36.380" class="difflineplus">+    else</span>
<a href="#l36.381"></a><span id="l36.381" class="difflineplus">+      validityConstraintSuffix = &quot;&quot;;</span>
<a href="#l36.382"></a><span id="l36.382"> </span>
<a href="#l36.383"></a><span id="l36.383">     for (let iUnion = 0; iUnion &lt; unionQueries.length; iUnion++) {</span>
<a href="#l36.384"></a><span id="l36.384">       let curQuery = unionQueries[iUnion];</span>
<a href="#l36.385"></a><span id="l36.385">       let selects = [];</span>
<a href="#l36.386"></a><span id="l36.386"> </span>
<a href="#l36.387"></a><span id="l36.387">       let lastConstraintWasSpecial = false;</span>
<a href="#l36.388"></a><span id="l36.388">       let curConstraintIsSpecial;</span>
<a href="#l36.389"></a><span id="l36.389"> </span>
<a href="#l36.390"></a><span id="l36.390" class="difflineat">@@ -2907,18 +2874,24 @@ var GlodaDatastore = {</span>
<a href="#l36.391"></a><span id="l36.391">       }</span>
<a href="#l36.392"></a><span id="l36.392"> </span>
<a href="#l36.393"></a><span id="l36.393">       if (selects.length)</span>
<a href="#l36.394"></a><span id="l36.394">         whereClauses.push(&quot;id IN (&quot; + selects.join(&quot; INTERSECT &quot;) + &quot;)&quot; +</span>
<a href="#l36.395"></a><span id="l36.395">                           validityConstraintSuffix);</span>
<a href="#l36.396"></a><span id="l36.396">     }</span>
<a href="#l36.397"></a><span id="l36.397"> </span>
<a href="#l36.398"></a><span id="l36.398">     let sqlString = &quot;SELECT * FROM &quot; + nounDef.tableName;</span>
<a href="#l36.399"></a><span id="l36.399" class="difflineminus">-    if (nounDef.dbQueryJoinMagic &amp;&amp; !aQuery.options.noMagic)</span>
<a href="#l36.400"></a><span id="l36.400" class="difflineminus">-      sqlString += nounDef.dbQueryJoinMagic;</span>
<a href="#l36.401"></a><span id="l36.401" class="difflineplus">+    if (!aQuery.options.noMagic) {</span>
<a href="#l36.402"></a><span id="l36.402" class="difflineplus">+      if (aQuery.options.noDbQueryValidityConstraints &amp;&amp;</span>
<a href="#l36.403"></a><span id="l36.403" class="difflineplus">+          nounDef.dbQueryJoinMagicWithNoValidityConstraints)</span>
<a href="#l36.404"></a><span id="l36.404" class="difflineplus">+        sqlString += nounDef.dbQueryJoinMagicWithNoValidityConstraints;</span>
<a href="#l36.405"></a><span id="l36.405" class="difflineplus">+      else if (nounDef.dbQueryJoinMagic)</span>
<a href="#l36.406"></a><span id="l36.406" class="difflineplus">+        sqlString += nounDef.dbQueryJoinMagic;</span>
<a href="#l36.407"></a><span id="l36.407" class="difflineplus">+    }</span>
<a href="#l36.408"></a><span id="l36.408" class="difflineplus">+</span>
<a href="#l36.409"></a><span id="l36.409">     if (whereClauses.length)</span>
<a href="#l36.410"></a><span id="l36.410">       sqlString += &quot; WHERE (&quot; + whereClauses.join(&quot;) OR (&quot;) + &quot;)&quot;;</span>
<a href="#l36.411"></a><span id="l36.411"> </span>
<a href="#l36.412"></a><span id="l36.412">     if (aQuery.options.explicitSQL)</span>
<a href="#l36.413"></a><span id="l36.413">       sqlString = aQuery.options.explicitSQL;</span>
<a href="#l36.414"></a><span id="l36.414"> </span>
<a href="#l36.415"></a><span id="l36.415">     if (aQuery.options.outerWrapColumns)</span>
<a href="#l36.416"></a><span id="l36.416">       sqlString = &quot;SELECT *, &quot; + aQuery.options.outerWrapColumns.join(&quot;, &quot;) +</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l37.1"></a><span id="l37.1" class="difflineminus">--- a/mailnews/db/gloda/modules/fundattr.js</span>
<a href="#l37.2"></a><span id="l37.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/fundattr.js</span>
<a href="#l37.3"></a><span id="l37.3" class="difflineat">@@ -44,17 +44,17 @@ const Cu = Components.utils;</span>
<a href="#l37.4"></a><span id="l37.4"> </span>
<a href="#l37.5"></a><span id="l37.5"> Cu.import(&quot;resource://app/modules/gloda/log4moz.js&quot;);</span>
<a href="#l37.6"></a><span id="l37.6"> </span>
<a href="#l37.7"></a><span id="l37.7"> Cu.import(&quot;resource://app/modules/gloda/utils.js&quot;);</span>
<a href="#l37.8"></a><span id="l37.8"> Cu.import(&quot;resource://app/modules/gloda/gloda.js&quot;);</span>
<a href="#l37.9"></a><span id="l37.9"> Cu.import(&quot;resource://app/modules/gloda/datastore.js&quot;);</span>
<a href="#l37.10"></a><span id="l37.10"> </span>
<a href="#l37.11"></a><span id="l37.11"> Cu.import(&quot;resource://app/modules/gloda/noun_mimetype.js&quot;);</span>
<a href="#l37.12"></a><span id="l37.12" class="difflineminus">-</span>
<a href="#l37.13"></a><span id="l37.13" class="difflineplus">+Cu.import(&quot;resource://app/modules/gloda/connotent.js&quot;);</span>
<a href="#l37.14"></a><span id="l37.14"> </span>
<a href="#l37.15"></a><span id="l37.15"> /**</span>
<a href="#l37.16"></a><span id="l37.16">  * @namespace The Gloda Fundamental Attribute provider is a special attribute</span>
<a href="#l37.17"></a><span id="l37.17">  *  provider; it provides attributes that the rest of the providers should be</span>
<a href="#l37.18"></a><span id="l37.18">  *  able to assume exist.  Also, it may end up accessing things at a lower level</span>
<a href="#l37.19"></a><span id="l37.19">  *  than most extension providers should do.  In summary, don't mimic this code</span>
<a href="#l37.20"></a><span id="l37.20">  *  unless you won't complain when your code breaks.</span>
<a href="#l37.21"></a><span id="l37.21">  */</span>
<a href="#l37.22"></a><span id="l37.22" class="difflineat">@@ -95,16 +95,17 @@ var GlodaFundAttr = {</span>
<a href="#l37.23"></a><span id="l37.23">   _attrBody: null,</span>
<a href="#l37.24"></a><span id="l37.24">   _attrFrom: null,</span>
<a href="#l37.25"></a><span id="l37.25">   _attrFromMe: null,</span>
<a href="#l37.26"></a><span id="l37.26">   _attrTo: null,</span>
<a href="#l37.27"></a><span id="l37.27">   _attrToMe: null,</span>
<a href="#l37.28"></a><span id="l37.28">   _attrCc: null,</span>
<a href="#l37.29"></a><span id="l37.29">   _attrCcMe: null,</span>
<a href="#l37.30"></a><span id="l37.30">   _attrDate: null,</span>
<a href="#l37.31"></a><span id="l37.31" class="difflineplus">+  _attrHeaderMessageID: null,</span>
<a href="#l37.32"></a><span id="l37.32"> </span>
<a href="#l37.33"></a><span id="l37.33">   defineAttributes: function() {</span>
<a href="#l37.34"></a><span id="l37.34">     /* ***** Conversations ***** */</span>
<a href="#l37.35"></a><span id="l37.35">     // conversation: subjectMatches</span>
<a href="#l37.36"></a><span id="l37.36">     this._attrConvSubject = Gloda.defineAttribute({</span>
<a href="#l37.37"></a><span id="l37.37">       provider: this,</span>
<a href="#l37.38"></a><span id="l37.38">       extensionName: Gloda.BUILT_IN,</span>
<a href="#l37.39"></a><span id="l37.39">       attributeType: Gloda.kAttrDerived,</span>
<a href="#l37.40"></a><span id="l37.40" class="difflineat">@@ -281,16 +282,29 @@ var GlodaFundAttr = {</span>
<a href="#l37.41"></a><span id="l37.41">                         attributeName: &quot;date&quot;,</span>
<a href="#l37.42"></a><span id="l37.42">                         singular: true,</span>
<a href="#l37.43"></a><span id="l37.43">                         special: Gloda.kSpecialColumn,</span>
<a href="#l37.44"></a><span id="l37.44">                         specialColumnName: &quot;date&quot;,</span>
<a href="#l37.45"></a><span id="l37.45">                         subjectNouns: [Gloda.NOUN_MESSAGE],</span>
<a href="#l37.46"></a><span id="l37.46">                         objectNoun: Gloda.NOUN_DATE,</span>
<a href="#l37.47"></a><span id="l37.47">                         }); // tested-by: test_attributes_fundamental</span>
<a href="#l37.48"></a><span id="l37.48"> </span>
<a href="#l37.49"></a><span id="l37.49" class="difflineplus">+    // Header message ID.</span>
<a href="#l37.50"></a><span id="l37.50" class="difflineplus">+    this._attrHeaderMessageID = Gloda.defineAttribute({</span>
<a href="#l37.51"></a><span id="l37.51" class="difflineplus">+                        provider: this,</span>
<a href="#l37.52"></a><span id="l37.52" class="difflineplus">+                        extensionName: Gloda.BUILT_IN,</span>
<a href="#l37.53"></a><span id="l37.53" class="difflineplus">+                        attributeType: Gloda.kAttrFundamental,</span>
<a href="#l37.54"></a><span id="l37.54" class="difflineplus">+                        attributeName: &quot;headerMessageID&quot;,</span>
<a href="#l37.55"></a><span id="l37.55" class="difflineplus">+                        singular: true,</span>
<a href="#l37.56"></a><span id="l37.56" class="difflineplus">+                        special: Gloda.kSpecialColumn,</span>
<a href="#l37.57"></a><span id="l37.57" class="difflineplus">+                        specialColumnName: &quot;headerMessageID&quot;,</span>
<a href="#l37.58"></a><span id="l37.58" class="difflineplus">+                        subjectNouns: [Gloda.NOUN_MESSAGE],</span>
<a href="#l37.59"></a><span id="l37.59" class="difflineplus">+                        objectNoun: Gloda.NOUN_STRING,</span>
<a href="#l37.60"></a><span id="l37.60" class="difflineplus">+                        }); // tested-by: test_attributes_fundamental</span>
<a href="#l37.61"></a><span id="l37.61" class="difflineplus">+</span>
<a href="#l37.62"></a><span id="l37.62">     // Attachment MIME Types</span>
<a href="#l37.63"></a><span id="l37.63">     this._attrAttachmentTypes = Gloda.defineAttribute({</span>
<a href="#l37.64"></a><span id="l37.64">       provider: this,</span>
<a href="#l37.65"></a><span id="l37.65">       extensionName: Gloda.BUILT_IN,</span>
<a href="#l37.66"></a><span id="l37.66">       attributeType: Gloda.kAttrFundamental,</span>
<a href="#l37.67"></a><span id="l37.67">       attributeName: &quot;attachmentTypes&quot;,</span>
<a href="#l37.68"></a><span id="l37.68">       singular: false,</span>
<a href="#l37.69"></a><span id="l37.69">       subjectNouns: [Gloda.NOUN_MESSAGE],</span>
<a href="#l37.70"></a><span id="l37.70" class="difflineat">@@ -427,29 +441,31 @@ var GlodaFundAttr = {</span>
<a href="#l37.71"></a><span id="l37.71">     let authorIdentity = authorIdentities[0];</span>
<a href="#l37.72"></a><span id="l37.72">     aGlodaMessage.from = authorIdentity;</span>
<a href="#l37.73"></a><span id="l37.73"> </span>
<a href="#l37.74"></a><span id="l37.74">     // -- To, Cc</span>
<a href="#l37.75"></a><span id="l37.75">     aGlodaMessage.to = toIdentities;</span>
<a href="#l37.76"></a><span id="l37.76">     aGlodaMessage.cc = ccIdentities;</span>
<a href="#l37.77"></a><span id="l37.77"> </span>
<a href="#l37.78"></a><span id="l37.78">     // -- Attachments</span>
<a href="#l37.79"></a><span id="l37.79" class="difflineminus">-    let attachmentTypes = [];</span>
<a href="#l37.80"></a><span id="l37.80" class="difflineminus">-    for each (let [, attachment] in Iterator(aMimeMsg.allAttachments)) {</span>
<a href="#l37.81"></a><span id="l37.81" class="difflineminus">-      // We don't care about would-be attachments that are not user-intended</span>
<a href="#l37.82"></a><span id="l37.82" class="difflineminus">-      //  attachments but rather artifacts of the message content.</span>
<a href="#l37.83"></a><span id="l37.83" class="difflineminus">-      // We also want to avoid dealing with obviously bogus mime types.</span>
<a href="#l37.84"></a><span id="l37.84" class="difflineminus">-      //  (If you don't have a &quot;/&quot;, you are probably bogus.)</span>
<a href="#l37.85"></a><span id="l37.85" class="difflineminus">-      if (attachment.isRealAttachment &amp;&amp;</span>
<a href="#l37.86"></a><span id="l37.86" class="difflineminus">-          (attachment.contentType.indexOf(&quot;/&quot;) != -1)) {</span>
<a href="#l37.87"></a><span id="l37.87" class="difflineminus">-        attachmentTypes.push(MimeTypeNoun.getMimeType(attachment.contentType));</span>
<a href="#l37.88"></a><span id="l37.88" class="difflineplus">+    if (aMimeMsg) {</span>
<a href="#l37.89"></a><span id="l37.89" class="difflineplus">+      let attachmentTypes = [];</span>
<a href="#l37.90"></a><span id="l37.90" class="difflineplus">+      for each (let [, attachment] in Iterator(aMimeMsg.allAttachments)) {</span>
<a href="#l37.91"></a><span id="l37.91" class="difflineplus">+        // We don't care about would-be attachments that are not user-intended</span>
<a href="#l37.92"></a><span id="l37.92" class="difflineplus">+        //  attachments but rather artifacts of the message content.</span>
<a href="#l37.93"></a><span id="l37.93" class="difflineplus">+        // We also want to avoid dealing with obviously bogus mime types.</span>
<a href="#l37.94"></a><span id="l37.94" class="difflineplus">+        //  (If you don't have a &quot;/&quot;, you are probably bogus.)</span>
<a href="#l37.95"></a><span id="l37.95" class="difflineplus">+        if (attachment.isRealAttachment &amp;&amp;</span>
<a href="#l37.96"></a><span id="l37.96" class="difflineplus">+            (attachment.contentType.indexOf(&quot;/&quot;) != -1)) {</span>
<a href="#l37.97"></a><span id="l37.97" class="difflineplus">+          attachmentTypes.push(MimeTypeNoun.getMimeType(attachment.contentType));</span>
<a href="#l37.98"></a><span id="l37.98" class="difflineplus">+        }</span>
<a href="#l37.99"></a><span id="l37.99">       }</span>
<a href="#l37.100"></a><span id="l37.100" class="difflineminus">-    }</span>
<a href="#l37.101"></a><span id="l37.101" class="difflineminus">-    if (attachmentTypes.length) {</span>
<a href="#l37.102"></a><span id="l37.102" class="difflineminus">-      aGlodaMessage.attachmentTypes = attachmentTypes;</span>
<a href="#l37.103"></a><span id="l37.103" class="difflineplus">+      if (attachmentTypes.length) {</span>
<a href="#l37.104"></a><span id="l37.104" class="difflineplus">+        aGlodaMessage.attachmentTypes = attachmentTypes;</span>
<a href="#l37.105"></a><span id="l37.105" class="difflineplus">+      }</span>
<a href="#l37.106"></a><span id="l37.106">     }</span>
<a href="#l37.107"></a><span id="l37.107"> </span>
<a href="#l37.108"></a><span id="l37.108">     // TODO: deal with mailing lists, including implicit-to.  this will require</span>
<a href="#l37.109"></a><span id="l37.109">     //  convincing the indexer to pass us in the previous message if it is</span>
<a href="#l37.110"></a><span id="l37.110">     //  available.  (which we'll simply pass to everyone... it can help body</span>
<a href="#l37.111"></a><span id="l37.111">     //  logic for quoting purposes, etc. too.)</span>
<a href="#l37.112"></a><span id="l37.112"> </span>
<a href="#l37.113"></a><span id="l37.113">     yield Gloda.kWorkDone;</span>
<a href="#l37.114"></a><span id="l37.114" class="difflineat">@@ -560,19 +576,22 @@ var GlodaFundAttr = {</span>
<a href="#l37.115"></a><span id="l37.115">     }</span>
<a href="#l37.116"></a><span id="l37.116">     if (fromMeTo.length)</span>
<a href="#l37.117"></a><span id="l37.117">       aGlodaMessage.fromMeTo = fromMeTo;</span>
<a href="#l37.118"></a><span id="l37.118">     if (ccMe.length)</span>
<a href="#l37.119"></a><span id="l37.119">       aGlodaMessage.ccMe = ccMe;</span>
<a href="#l37.120"></a><span id="l37.120">     if (fromMeCc.length)</span>
<a href="#l37.121"></a><span id="l37.121">       aGlodaMessage.fromMeCc = fromMeCc;</span>
<a href="#l37.122"></a><span id="l37.122"> </span>
<a href="#l37.123"></a><span id="l37.123" class="difflineminus">-    if (aRawReps.bodyLines &amp;&amp;</span>
<a href="#l37.124"></a><span id="l37.124" class="difflineminus">-        this.contentWhittle({}, aRawReps.bodyLines, aRawReps.content)) {</span>
<a href="#l37.125"></a><span id="l37.125" class="difflineminus">-      // we were going to do something here?</span>
<a href="#l37.126"></a><span id="l37.126" class="difflineplus">+    // Content</span>
<a href="#l37.127"></a><span id="l37.127" class="difflineplus">+    if (aRawReps.bodyLines) {</span>
<a href="#l37.128"></a><span id="l37.128" class="difflineplus">+      aGlodaMessage._content = new GlodaContent();</span>
<a href="#l37.129"></a><span id="l37.129" class="difflineplus">+      if (this.contentWhittle({}, aRawReps.bodyLines, aGlodaMessage._content)) {</span>
<a href="#l37.130"></a><span id="l37.130" class="difflineplus">+        // we were going to do something here?</span>
<a href="#l37.131"></a><span id="l37.131" class="difflineplus">+      }</span>
<a href="#l37.132"></a><span id="l37.132">     }</span>
<a href="#l37.133"></a><span id="l37.133"> </span>
<a href="#l37.134"></a><span id="l37.134">     yield Gloda.kWorkDone;</span>
<a href="#l37.135"></a><span id="l37.135">   },</span>
<a href="#l37.136"></a><span id="l37.136"> </span>
<a href="#l37.137"></a><span id="l37.137">   /**</span>
<a href="#l37.138"></a><span id="l37.138">    * Duplicates the notability logic from optimize().  Arguably optimize should</span>
<a href="#l37.139"></a><span id="l37.139">    *  be factored to call us, grokNounItem should be factored to call us, or we</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l38.1"></a><span id="l38.1" class="difflineminus">--- a/mailnews/db/gloda/modules/gloda.js</span>
<a href="#l38.2"></a><span id="l38.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/gloda.js</span>
<a href="#l38.3"></a><span id="l38.3" class="difflineat">@@ -49,16 +49,59 @@ Cu.import(&quot;resource://app/modules/gloda/</span>
<a href="#l38.4"></a><span id="l38.4"> Cu.import(&quot;resource://app/modules/gloda/databind.js&quot;);</span>
<a href="#l38.5"></a><span id="l38.5"> Cu.import(&quot;resource://app/modules/gloda/collection.js&quot;);</span>
<a href="#l38.6"></a><span id="l38.6"> Cu.import(&quot;resource://app/modules/gloda/connotent.js&quot;);</span>
<a href="#l38.7"></a><span id="l38.7"> Cu.import(&quot;resource://app/modules/gloda/query.js&quot;);</span>
<a href="#l38.8"></a><span id="l38.8"> Cu.import(&quot;resource://app/modules/gloda/utils.js&quot;);</span>
<a href="#l38.9"></a><span id="l38.9"> </span>
<a href="#l38.10"></a><span id="l38.10"> Cu.import(&quot;resource://app/modules/iteratorUtils.jsm&quot;);</span>
<a href="#l38.11"></a><span id="l38.11"> </span>
<a href="#l38.12"></a><span id="l38.12" class="difflineplus">+let MBM_LOG = Log4Moz.repository.getLogger(&quot;gloda.NS.mbm&quot;);</span>
<a href="#l38.13"></a><span id="l38.13" class="difflineplus">+</span>
<a href="#l38.14"></a><span id="l38.14" class="difflineplus">+/**</span>
<a href="#l38.15"></a><span id="l38.15" class="difflineplus">+ * @class This callback handles processing the asynchronous query results of</span>
<a href="#l38.16"></a><span id="l38.16" class="difflineplus">+ *  Gloda.getMessagesByMessageID.</span>
<a href="#l38.17"></a><span id="l38.17" class="difflineplus">+ *</span>
<a href="#l38.18"></a><span id="l38.18" class="difflineplus">+ * @param aMsgIDToIndex Map from message-id to the desired</span>
<a href="#l38.19"></a><span id="l38.19" class="difflineplus">+ *</span>
<a href="#l38.20"></a><span id="l38.20" class="difflineplus">+ * @constructor</span>
<a href="#l38.21"></a><span id="l38.21" class="difflineplus">+ */</span>
<a href="#l38.22"></a><span id="l38.22" class="difflineplus">+function MessagesByMessageIdCallback(aMsgIDToIndex, aResults,</span>
<a href="#l38.23"></a><span id="l38.23" class="difflineplus">+                                     aCallback, aCallbackThis) {</span>
<a href="#l38.24"></a><span id="l38.24" class="difflineplus">+  this.msgIDToIndex = aMsgIDToIndex;</span>
<a href="#l38.25"></a><span id="l38.25" class="difflineplus">+  this.results = aResults;</span>
<a href="#l38.26"></a><span id="l38.26" class="difflineplus">+  this.callback = aCallback;</span>
<a href="#l38.27"></a><span id="l38.27" class="difflineplus">+  this.callbackThis = aCallbackThis;</span>
<a href="#l38.28"></a><span id="l38.28" class="difflineplus">+}</span>
<a href="#l38.29"></a><span id="l38.29" class="difflineplus">+</span>
<a href="#l38.30"></a><span id="l38.30" class="difflineplus">+MessagesByMessageIdCallback.prototype = {</span>
<a href="#l38.31"></a><span id="l38.31" class="difflineplus">+  onItemsAdded: function gloda_ds_mbmi_onItemsAdded(aItems, aCollection) {</span>
<a href="#l38.32"></a><span id="l38.32" class="difflineplus">+    // just outright bail if we are shutdown</span>
<a href="#l38.33"></a><span id="l38.33" class="difflineplus">+    if (GlodaDatastore.datastoreIsShutdown)</span>
<a href="#l38.34"></a><span id="l38.34" class="difflineplus">+      return;</span>
<a href="#l38.35"></a><span id="l38.35" class="difflineplus">+</span>
<a href="#l38.36"></a><span id="l38.36" class="difflineplus">+    MBM_LOG.debug(&quot;getting results...&quot;);</span>
<a href="#l38.37"></a><span id="l38.37" class="difflineplus">+    for each (let [, message] in Iterator(aItems)) {</span>
<a href="#l38.38"></a><span id="l38.38" class="difflineplus">+      this.results[this.msgIDToIndex[message.headerMessageID]].push(message);</span>
<a href="#l38.39"></a><span id="l38.39" class="difflineplus">+    }</span>
<a href="#l38.40"></a><span id="l38.40" class="difflineplus">+  },</span>
<a href="#l38.41"></a><span id="l38.41" class="difflineplus">+  onItemsModified: function () {},</span>
<a href="#l38.42"></a><span id="l38.42" class="difflineplus">+  onItemsRemoved: function () {},</span>
<a href="#l38.43"></a><span id="l38.43" class="difflineplus">+  onQueryCompleted: function gloda_ds_mbmi_onQueryCompleted(aCollection) {</span>
<a href="#l38.44"></a><span id="l38.44" class="difflineplus">+    // just outright bail if we are shutdown</span>
<a href="#l38.45"></a><span id="l38.45" class="difflineplus">+    if (GlodaDatastore.datastoreIsShutdown)</span>
<a href="#l38.46"></a><span id="l38.46" class="difflineplus">+      return;</span>
<a href="#l38.47"></a><span id="l38.47" class="difflineplus">+</span>
<a href="#l38.48"></a><span id="l38.48" class="difflineplus">+    MBM_LOG.debug(&quot;query completed, notifying... &quot; + this.results);</span>
<a href="#l38.49"></a><span id="l38.49" class="difflineplus">+    // we no longer need to unify; it is done for us.</span>
<a href="#l38.50"></a><span id="l38.50" class="difflineplus">+</span>
<a href="#l38.51"></a><span id="l38.51" class="difflineplus">+    this.callback.call(this.callbackThis, this.results);</span>
<a href="#l38.52"></a><span id="l38.52" class="difflineplus">+  }</span>
<a href="#l38.53"></a><span id="l38.53" class="difflineplus">+};</span>
<a href="#l38.54"></a><span id="l38.54" class="difflineplus">+</span>
<a href="#l38.55"></a><span id="l38.55"> /**</span>
<a href="#l38.56"></a><span id="l38.56">  * Provides the user-visible (and extension visible) global database</span>
<a href="#l38.57"></a><span id="l38.57">  *  functionality.  There is currently a dependency/ordering</span>
<a href="#l38.58"></a><span id="l38.58">  *  problem in that the concept of 'gloda' also includes some logic that is</span>
<a href="#l38.59"></a><span id="l38.59">  *  contributed by built-in extensions, if you will.  Those built-in extensions</span>
<a href="#l38.60"></a><span id="l38.60">  *  (fundattr.js, explattr.js) also import this file.  To avoid a circular</span>
<a href="#l38.61"></a><span id="l38.61">  *  dependency, those built-in extensions are loaded by everybody.js.  The</span>
<a href="#l38.62"></a><span id="l38.62">  *  simplest/best solution is probably to move everybody.js to be gloda.js and</span>
<a href="#l38.63"></a><span id="l38.63" class="difflineat">@@ -322,16 +365,55 @@ var Gloda = {</span>
<a href="#l38.64"></a><span id="l38.64">       let messageKeys = [hdr.messageKey for each (hdr in headersForFolder)];</span>
<a href="#l38.65"></a><span id="l38.65">       clause.messageKey.apply(clause, messageKeys);</span>
<a href="#l38.66"></a><span id="l38.66">     }</span>
<a href="#l38.67"></a><span id="l38.67"> </span>
<a href="#l38.68"></a><span id="l38.68">     return query.getCollection(aListener, aData);</span>
<a href="#l38.69"></a><span id="l38.69">   },</span>
<a href="#l38.70"></a><span id="l38.70"> </span>
<a href="#l38.71"></a><span id="l38.71">   /**</span>
<a href="#l38.72"></a><span id="l38.72" class="difflineplus">+   * Given a list of Message-ID's, return a matching list of lists of messages</span>
<a href="#l38.73"></a><span id="l38.73" class="difflineplus">+   *  matching those Message-ID's.  So if you pass an array with three</span>
<a href="#l38.74"></a><span id="l38.74" class="difflineplus">+   *  Message-ID's [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;], you would get back an array containing</span>
<a href="#l38.75"></a><span id="l38.75" class="difflineplus">+   *  3 lists, where the first list contains all the messages with a message-id</span>
<a href="#l38.76"></a><span id="l38.76" class="difflineplus">+   *  of &quot;a&quot;, and so forth.  The reason a list is returned rather than null/a</span>
<a href="#l38.77"></a><span id="l38.77" class="difflineplus">+   *  message is that we accept the reality that we have multiple copies of</span>
<a href="#l38.78"></a><span id="l38.78" class="difflineplus">+   *  messages with the same ID.</span>
<a href="#l38.79"></a><span id="l38.79" class="difflineplus">+   * This call is asynchronous because it depends on previously created messages</span>
<a href="#l38.80"></a><span id="l38.80" class="difflineplus">+   *  to be reflected in our results, which requires us to execute on the async</span>
<a href="#l38.81"></a><span id="l38.81" class="difflineplus">+   *  thread where all our writes happen.  This also turns out to be a</span>
<a href="#l38.82"></a><span id="l38.82" class="difflineplus">+   *  reasonable thing because we could imagine pathological cases where there</span>
<a href="#l38.83"></a><span id="l38.83" class="difflineplus">+   *  could be a lot of message-id's and/or a lot of messages with those</span>
<a href="#l38.84"></a><span id="l38.84" class="difflineplus">+   *  message-id's.</span>
<a href="#l38.85"></a><span id="l38.85" class="difflineplus">+   */</span>
<a href="#l38.86"></a><span id="l38.86" class="difflineplus">+  getMessagesByMessageID: function gloda_ns_getMessagesByMessageID(aMessageIDs,</span>
<a href="#l38.87"></a><span id="l38.87" class="difflineplus">+      aCallback, aCallbackThis) {</span>
<a href="#l38.88"></a><span id="l38.88" class="difflineplus">+    let msgIDToIndex = {};</span>
<a href="#l38.89"></a><span id="l38.89" class="difflineplus">+    let results = [];</span>
<a href="#l38.90"></a><span id="l38.90" class="difflineplus">+    for (let iID = 0; iID &lt; aMessageIDs.length; ++iID) {</span>
<a href="#l38.91"></a><span id="l38.91" class="difflineplus">+      let msgID = aMessageIDs[iID];</span>
<a href="#l38.92"></a><span id="l38.92" class="difflineplus">+      results.push([]);</span>
<a href="#l38.93"></a><span id="l38.93" class="difflineplus">+      msgIDToIndex[msgID] = iID;</span>
<a href="#l38.94"></a><span id="l38.94" class="difflineplus">+    }</span>
<a href="#l38.95"></a><span id="l38.95" class="difflineplus">+</span>
<a href="#l38.96"></a><span id="l38.96" class="difflineplus">+    let quotedIDs = [&quot;'&quot; + msgID.replace(&quot;'&quot;, &quot;''&quot;, &quot;g&quot;) + &quot;'&quot; for each</span>
<a href="#l38.97"></a><span id="l38.97" class="difflineplus">+                      ([i, msgID] in Iterator(aMessageIDs))];</span>
<a href="#l38.98"></a><span id="l38.98" class="difflineplus">+</span>
<a href="#l38.99"></a><span id="l38.99" class="difflineplus">+    let query = Gloda.newQuery(Gloda.NOUN_MESSAGE, {</span>
<a href="#l38.100"></a><span id="l38.100" class="difflineplus">+      noDbQueryValidityConstraints: true,</span>
<a href="#l38.101"></a><span id="l38.101" class="difflineplus">+    });</span>
<a href="#l38.102"></a><span id="l38.102" class="difflineplus">+    query.headerMessageID.apply(query, quotedIDs);</span>
<a href="#l38.103"></a><span id="l38.103" class="difflineplus">+    query.frozen = true;</span>
<a href="#l38.104"></a><span id="l38.104" class="difflineplus">+</span>
<a href="#l38.105"></a><span id="l38.105" class="difflineplus">+    let listener = new MessagesByMessageIdCallback(msgIDToIndex, results,</span>
<a href="#l38.106"></a><span id="l38.106" class="difflineplus">+                                                   aCallback, aCallbackThis);</span>
<a href="#l38.107"></a><span id="l38.107" class="difflineplus">+    return query.getCollection(listener);</span>
<a href="#l38.108"></a><span id="l38.108" class="difflineplus">+  },</span>
<a href="#l38.109"></a><span id="l38.109" class="difflineplus">+</span>
<a href="#l38.110"></a><span id="l38.110" class="difflineplus">+  /**</span>
<a href="#l38.111"></a><span id="l38.111">    * @testpoint gloda.ns.getMessageContent</span>
<a href="#l38.112"></a><span id="l38.112">    */</span>
<a href="#l38.113"></a><span id="l38.113">   getMessageContent: function gloda_ns_getMessageContent(aGlodaMessage, aMimeMsg) {</span>
<a href="#l38.114"></a><span id="l38.114">     return mimeMsgToContentAndMeta(aMimeMsg, aGlodaMessage.folderMessage.folder)[0];</span>
<a href="#l38.115"></a><span id="l38.115">   },</span>
<a href="#l38.116"></a><span id="l38.116"> </span>
<a href="#l38.117"></a><span id="l38.117">   getFolderForFolder: function gloda_ns_getFolderForFolder(aMsgFolder) {</span>
<a href="#l38.118"></a><span id="l38.118">     return GlodaDatastore._mapFolder(aMsgFolder);</span>
<a href="#l38.119"></a><span id="l38.119" class="difflineat">@@ -1072,16 +1154,20 @@ var Gloda = {</span>
<a href="#l38.120"></a><span id="l38.120">       //  have the body available.  this is because we want the subject indexed.</span>
<a href="#l38.121"></a><span id="l38.121">       dbQueryJoinMagic:</span>
<a href="#l38.122"></a><span id="l38.122">         &quot; INNER JOIN messagesText ON messages.id = messagesText.rowid&quot;,</span>
<a href="#l38.123"></a><span id="l38.123">       attrTableName: &quot;messageAttributes&quot;, attrIDColumnName: &quot;messageID&quot;,</span>
<a href="#l38.124"></a><span id="l38.124">       datastore: GlodaDatastore, objFromRow: GlodaDatastore._messageFromRow,</span>
<a href="#l38.125"></a><span id="l38.125">       dbAttribAdjuster: GlodaDatastore.adjustMessageAttributes,</span>
<a href="#l38.126"></a><span id="l38.126">       dbQueryValidityConstraintSuffix:</span>
<a href="#l38.127"></a><span id="l38.127">         &quot; AND +deleted = 0 AND +folderID IS NOT NULL AND +messageKey IS NOT NULL&quot;,</span>
<a href="#l38.128"></a><span id="l38.128" class="difflineplus">+      // This is what's used when we have no validity constraints, i.e. we allow</span>
<a href="#l38.129"></a><span id="l38.129" class="difflineplus">+      // for ghost messages, which do not have a row in the messagesText table.</span>
<a href="#l38.130"></a><span id="l38.130" class="difflineplus">+      dbQueryJoinMagicWithNoValidityConstraints:</span>
<a href="#l38.131"></a><span id="l38.131" class="difflineplus">+        &quot; LEFT JOIN messagesText ON messages.id = messagesText.rowid&quot;,</span>
<a href="#l38.132"></a><span id="l38.132">       objInsert: GlodaDatastore.insertMessage,</span>
<a href="#l38.133"></a><span id="l38.133">       objUpdate: GlodaDatastore.updateMessage,</span>
<a href="#l38.134"></a><span id="l38.134">       toParamAndValue: function(aMessage) {</span>
<a href="#l38.135"></a><span id="l38.135">         if (aMessage instanceof GlodaMessage)</span>
<a href="#l38.136"></a><span id="l38.136">           return [null, aMessage.id];</span>
<a href="#l38.137"></a><span id="l38.137">         else // assume they're just passing the id directly</span>
<a href="#l38.138"></a><span id="l38.138">           return [null, aMessage];</span>
<a href="#l38.139"></a><span id="l38.139">       }}, this.NOUN_MESSAGE);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l39.1"></a><span id="l39.1" class="difflineminus">--- a/mailnews/db/gloda/modules/indexer.js</span>
<a href="#l39.2"></a><span id="l39.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/indexer.js</span>
<a href="#l39.3"></a><span id="l39.3" class="difflineat">@@ -16,16 +16,17 @@</span>
<a href="#l39.4"></a><span id="l39.4">  * The Initial Developer of the Original Code is</span>
<a href="#l39.5"></a><span id="l39.5">  * Mozilla Messaging, Inc.</span>
<a href="#l39.6"></a><span id="l39.6">  * Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l39.7"></a><span id="l39.7">  * the Initial Developer. All Rights Reserved.</span>
<a href="#l39.8"></a><span id="l39.8">  *</span>
<a href="#l39.9"></a><span id="l39.9">  * Contributor(s):</span>
<a href="#l39.10"></a><span id="l39.10">  *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l39.11"></a><span id="l39.11">  *   Kent James &lt;kent@caspia.com&gt;</span>
<a href="#l39.12"></a><span id="l39.12" class="difflineplus">+ *   Siddharth Agarwal &lt;sid.bugzilla@gmail.com&gt;</span>
<a href="#l39.13"></a><span id="l39.13">  *</span>
<a href="#l39.14"></a><span id="l39.14">  * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l39.15"></a><span id="l39.15">  * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l39.16"></a><span id="l39.16">  * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l39.17"></a><span id="l39.17">  * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l39.18"></a><span id="l39.18">  * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l39.19"></a><span id="l39.19">  * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l39.20"></a><span id="l39.20">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l39.21"></a><span id="l39.21" class="difflineat">@@ -238,17 +239,18 @@ IndexingJob.prototype = {</span>
<a href="#l39.22"></a><span id="l39.22">  *   header that indicates the message is dirty.</span>
<a href="#l39.23"></a><span id="l39.23">  * - We store a property on folders that indicate that the folder's index is</span>
<a href="#l39.24"></a><span id="l39.24">  *   up-to-date.  Absence of this property is akin to a 0=folder not up to date.</span>
<a href="#l39.25"></a><span id="l39.25">  *   There is no particular reason for the choice of using the folder's</span>
<a href="#l39.26"></a><span id="l39.26">  *   properties (via the folder cache implementation) over gloda's own folder</span>
<a href="#l39.27"></a><span id="l39.27">  *   meta-data.</span>
<a href="#l39.28"></a><span id="l39.28">  *</span>
<a href="#l39.29"></a><span id="l39.29">  * Indexing Message Control</span>
<a href="#l39.30"></a><span id="l39.30" class="difflineminus">- * - We index IMAP messages that are offline.  We index all local messages.</span>
<a href="#l39.31"></a><span id="l39.31" class="difflineplus">+ * - We index the headers of all IMAP messages. We index the bodies of all IMAP</span>
<a href="#l39.32"></a><span id="l39.32" class="difflineplus">+ *   messages that are offline.  We index all local messages.</span>
<a href="#l39.33"></a><span id="l39.33">  *   We plan to avoid indexing news messages.</span>
<a href="#l39.34"></a><span id="l39.34">  * - We would like a way to express desires about indexing that either don't</span>
<a href="#l39.35"></a><span id="l39.35">  *   confound offline storage with indexing, or actually allow some choice.</span>
<a href="#l39.36"></a><span id="l39.36">  *</span>
<a href="#l39.37"></a><span id="l39.37">  * Indexing</span>
<a href="#l39.38"></a><span id="l39.38">  * - We process one folder at a time, walking the headers in the folder,</span>
<a href="#l39.39"></a><span id="l39.39">  *   indexing those which should be indexed, but which have never been indexed</span>
<a href="#l39.40"></a><span id="l39.40">  *   or are dirty.</span>
<a href="#l39.41"></a><span id="l39.41" class="difflineat">@@ -1056,18 +1058,18 @@ var GlodaIndexer = {</span>
<a href="#l39.42"></a><span id="l39.42"> </span>
<a href="#l39.43"></a><span id="l39.43">     else {</span>
<a href="#l39.44"></a><span id="l39.44">       // We need to create search terms for messages to index. Messages should</span>
<a href="#l39.45"></a><span id="l39.45">       //  be indexed if they're indexable (local or offline and not expunged)</span>
<a href="#l39.46"></a><span id="l39.46">       //  and either haven't been indexed or are dirty.</span>
<a href="#l39.47"></a><span id="l39.47">       // The basic search expression is:</span>
<a href="#l39.48"></a><span id="l39.48">       //  ((GLODA_MESSAGE_ID_PROPERTY Is 0) || (GLODA_DIRTY_PROPERTY Isnt 0))</span>
<a href="#l39.49"></a><span id="l39.49">       // If the folder !isLocal we add the terms:</span>
<a href="#l39.50"></a><span id="l39.50" class="difflineminus">-      //  &amp;&amp; (Status Is nsMsgMessageFlags.Offline)</span>
<a href="#l39.51"></a><span id="l39.51" class="difflineminus">-      //  &amp;&amp; (Status Isnt nsMsgMessageFlags.Expunged)</span>
<a href="#l39.52"></a><span id="l39.52" class="difflineplus">+      //  - if the folder is offline -- &amp;&amp; (Status Is nsMsgMessageFlags.Offline)</span>
<a href="#l39.53"></a><span id="l39.53" class="difflineplus">+      //  - &amp;&amp; (Status Isnt nsMsgMessageFlags.Expunged)</span>
<a href="#l39.54"></a><span id="l39.54"> </span>
<a href="#l39.55"></a><span id="l39.55">       let searchSession = Cc[&quot;@mozilla.org/messenger/searchSession;1&quot;]</span>
<a href="#l39.56"></a><span id="l39.56">                             .createInstance(Ci.nsIMsgSearchSession);</span>
<a href="#l39.57"></a><span id="l39.57">       let searchTerms = Cc[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l39.58"></a><span id="l39.58">                          .createInstance(Ci.nsIMutableArray);</span>
<a href="#l39.59"></a><span id="l39.59">       let isLocal = this._indexingFolder instanceof Ci.nsIMsgLocalMailFolder;</span>
<a href="#l39.60"></a><span id="l39.60"> </span>
<a href="#l39.61"></a><span id="l39.61">       searchSession.addScopeTerm(Ci.nsMsgSearchScope.offlineMail,</span>
<a href="#l39.62"></a><span id="l39.62" class="difflineat">@@ -1076,17 +1078,17 @@ var GlodaIndexer = {</span>
<a href="#l39.63"></a><span id="l39.63">       let nsMsgSearchOp = Ci.nsMsgSearchOp;</span>
<a href="#l39.64"></a><span id="l39.64"> </span>
<a href="#l39.65"></a><span id="l39.65">       // first term: (GLODA_MESSAGE_ID_PROPERTY Is 0</span>
<a href="#l39.66"></a><span id="l39.66">       let searchTerm = searchSession.createTerm();</span>
<a href="#l39.67"></a><span id="l39.67">       searchTerm.booleanAnd = false; // actually don't care here</span>
<a href="#l39.68"></a><span id="l39.68">       searchTerm.beginsGrouping = true;</span>
<a href="#l39.69"></a><span id="l39.69">       searchTerm.attrib = nsMsgSearchAttrib.Uint32HdrProperty;</span>
<a href="#l39.70"></a><span id="l39.70">       searchTerm.op = nsMsgSearchOp.Is;</span>
<a href="#l39.71"></a><span id="l39.71" class="difflineminus">-      value = searchTerm.value;</span>
<a href="#l39.72"></a><span id="l39.72" class="difflineplus">+      let value = searchTerm.value;</span>
<a href="#l39.73"></a><span id="l39.73">       value.attrib = searchTerm.attrib;</span>
<a href="#l39.74"></a><span id="l39.74">       value.status = 0;</span>
<a href="#l39.75"></a><span id="l39.75">       searchTerm.value = value;</span>
<a href="#l39.76"></a><span id="l39.76">       searchTerm.hdrProperty = GLODA_MESSAGE_ID_PROPERTY;</span>
<a href="#l39.77"></a><span id="l39.77">       searchTerms.appendElement(searchTerm, false);</span>
<a href="#l39.78"></a><span id="l39.78"> </span>
<a href="#l39.79"></a><span id="l39.79">       //  second term: || GLODA_DIRTY_PROPERTY Isnt 0 )</span>
<a href="#l39.80"></a><span id="l39.80">       searchTerm = searchSession.createTerm();</span>
<a href="#l39.81"></a><span id="l39.81" class="difflineat">@@ -1098,26 +1100,29 @@ var GlodaIndexer = {</span>
<a href="#l39.82"></a><span id="l39.82">       value.attrib = searchTerm.attrib;</span>
<a href="#l39.83"></a><span id="l39.83">       value.status = 0;</span>
<a href="#l39.84"></a><span id="l39.84">       searchTerm.value = value;</span>
<a href="#l39.85"></a><span id="l39.85">       searchTerm.hdrProperty = GLODA_DIRTY_PROPERTY;</span>
<a href="#l39.86"></a><span id="l39.86">       searchTerms.appendElement(searchTerm, false);</span>
<a href="#l39.87"></a><span id="l39.87"> </span>
<a href="#l39.88"></a><span id="l39.88">       if (!isLocal)</span>
<a href="#l39.89"></a><span id="l39.89">       {</span>
<a href="#l39.90"></a><span id="l39.90" class="difflineminus">-        //  third term: &amp;&amp; Status Is nsMsgMessageFlags.Offline</span>
<a href="#l39.91"></a><span id="l39.91" class="difflineminus">-        searchTerm = searchSession.createTerm();</span>
<a href="#l39.92"></a><span id="l39.92" class="difflineminus">-        searchTerm.booleanAnd = true;</span>
<a href="#l39.93"></a><span id="l39.93" class="difflineminus">-        searchTerm.attrib = nsMsgSearchAttrib.MsgStatus;</span>
<a href="#l39.94"></a><span id="l39.94" class="difflineminus">-        searchTerm.op = nsMsgSearchOp.Is;</span>
<a href="#l39.95"></a><span id="l39.95" class="difflineminus">-        value = searchTerm.value;</span>
<a href="#l39.96"></a><span id="l39.96" class="difflineminus">-        value.attrib = searchTerm.attrib;</span>
<a href="#l39.97"></a><span id="l39.97" class="difflineminus">-        value.status = Ci.nsMsgMessageFlags.Offline;</span>
<a href="#l39.98"></a><span id="l39.98" class="difflineminus">-        searchTerm.value = value;</span>
<a href="#l39.99"></a><span id="l39.99" class="difflineminus">-        searchTerms.appendElement(searchTerm, false);</span>
<a href="#l39.100"></a><span id="l39.100" class="difflineplus">+        // If the folder is offline, then the message should be too</span>
<a href="#l39.101"></a><span id="l39.101" class="difflineplus">+        if (this._indexingFolder.flags &amp; Ci.nsMsgFolderFlags.Offline) {</span>
<a href="#l39.102"></a><span id="l39.102" class="difflineplus">+          // third term: &amp;&amp; Status Is nsMsgMessageFlags.Offline</span>
<a href="#l39.103"></a><span id="l39.103" class="difflineplus">+          searchTerm = searchSession.createTerm();</span>
<a href="#l39.104"></a><span id="l39.104" class="difflineplus">+          searchTerm.booleanAnd = true;</span>
<a href="#l39.105"></a><span id="l39.105" class="difflineplus">+          searchTerm.attrib = nsMsgSearchAttrib.MsgStatus;</span>
<a href="#l39.106"></a><span id="l39.106" class="difflineplus">+          searchTerm.op = nsMsgSearchOp.Is;</span>
<a href="#l39.107"></a><span id="l39.107" class="difflineplus">+          value = searchTerm.value;</span>
<a href="#l39.108"></a><span id="l39.108" class="difflineplus">+          value.attrib = searchTerm.attrib;</span>
<a href="#l39.109"></a><span id="l39.109" class="difflineplus">+          value.status = Ci.nsMsgMessageFlags.Offline;</span>
<a href="#l39.110"></a><span id="l39.110" class="difflineplus">+          searchTerm.value = value;</span>
<a href="#l39.111"></a><span id="l39.111" class="difflineplus">+          searchTerms.appendElement(searchTerm, false);</span>
<a href="#l39.112"></a><span id="l39.112" class="difflineplus">+        }</span>
<a href="#l39.113"></a><span id="l39.113"> </span>
<a href="#l39.114"></a><span id="l39.114">         // fourth term: &amp;&amp; Status Isnt nsMsgMessageFlags.Expunged</span>
<a href="#l39.115"></a><span id="l39.115">         searchTerm = searchSession.createTerm();</span>
<a href="#l39.116"></a><span id="l39.116">         searchTerm.booleanAnd = true;</span>
<a href="#l39.117"></a><span id="l39.117">         searchTerm.attrib = nsMsgSearchAttrib.MsgStatus;</span>
<a href="#l39.118"></a><span id="l39.118">         searchTerm.op = nsMsgSearchOp.Isnt;</span>
<a href="#l39.119"></a><span id="l39.119">         value = searchTerm.value;</span>
<a href="#l39.120"></a><span id="l39.120">         value.attrib = searchTerm.attrib;</span>
<a href="#l39.121"></a><span id="l39.121" class="difflineat">@@ -1647,20 +1652,20 @@ var GlodaIndexer = {</span>
<a href="#l39.122"></a><span id="l39.122">           createInstance(Ci.nsISupportsArray);</span>
<a href="#l39.123"></a><span id="l39.123">         rootFolder.ListDescendents(allFolders);</span>
<a href="#l39.124"></a><span id="l39.124">         let numFolders = allFolders.Count();</span>
<a href="#l39.125"></a><span id="l39.125">         for (let folderIndex = 0; folderIndex &lt; numFolders; folderIndex++) {</span>
<a href="#l39.126"></a><span id="l39.126">           let folder = allFolders.GetElementAt(folderIndex).QueryInterface(</span>
<a href="#l39.127"></a><span id="l39.127">             Ci.nsIMsgFolder);</span>
<a href="#l39.128"></a><span id="l39.128">           if (!this.shouldIndexFolder(folder))</span>
<a href="#l39.129"></a><span id="l39.129">             continue;</span>
<a href="#l39.130"></a><span id="l39.130" class="difflineminus">-          // we could also check nsMsgFolderFlags.Mail conceivably...</span>
<a href="#l39.131"></a><span id="l39.131" class="difflineminus">-          let isLocal = folder instanceof Ci.nsIMsgLocalMailFolder;</span>
<a href="#l39.132"></a><span id="l39.132" class="difflineminus">-          // we only index local folders or IMAP folders that are marked offline</span>
<a href="#l39.133"></a><span id="l39.133" class="difflineminus">-          if (!isLocal &amp;&amp; !(folder.flags &amp; Ci.nsMsgFolderFlags.Offline))</span>
<a href="#l39.134"></a><span id="l39.134" class="difflineplus">+</span>
<a href="#l39.135"></a><span id="l39.135" class="difflineplus">+          // we only index local or IMAP folders</span>
<a href="#l39.136"></a><span id="l39.136" class="difflineplus">+          if (!(folder instanceof Ci.nsIMsgLocalMailFolder) &amp;&amp;</span>
<a href="#l39.137"></a><span id="l39.137" class="difflineplus">+              !(folder instanceof Ci.nsIMsgImapMailFolder))</span>
<a href="#l39.138"></a><span id="l39.138">             continue;</span>
<a href="#l39.139"></a><span id="l39.139"> </span>
<a href="#l39.140"></a><span id="l39.140">           let glodaFolder = Gloda.getFolderForFolder(folder);</span>
<a href="#l39.141"></a><span id="l39.141">           if (glodaFolder.indexingPriority !=</span>
<a href="#l39.142"></a><span id="l39.142">               glodaFolder.kIndexingNeverPriority)</span>
<a href="#l39.143"></a><span id="l39.143">             foldersToProcess.push(glodaFolder);</span>
<a href="#l39.144"></a><span id="l39.144">         }</span>
<a href="#l39.145"></a><span id="l39.145">       }</span>
<a href="#l39.146"></a><span id="l39.146" class="difflineat">@@ -1729,17 +1734,16 @@ var GlodaIndexer = {</span>
<a href="#l39.147"></a><span id="l39.147"> </span>
<a href="#l39.148"></a><span id="l39.148">     // Make sure listeners get notified about this job.</span>
<a href="#l39.149"></a><span id="l39.149">     this._notifyListeners();</span>
<a href="#l39.150"></a><span id="l39.150"> </span>
<a href="#l39.151"></a><span id="l39.151">     // there is of course a cost to all this header investigation even if we</span>
<a href="#l39.152"></a><span id="l39.152">     //  don't do something.  so we will yield with kWorkSync for every block.</span>
<a href="#l39.153"></a><span id="l39.153">     const HEADER_CHECK_BLOCK_SIZE = 25;</span>
<a href="#l39.154"></a><span id="l39.154"> </span>
<a href="#l39.155"></a><span id="l39.155" class="difflineminus">-    let isLocal = this._indexingFolder instanceof Ci.nsIMsgLocalMailFolder;</span>
<a href="#l39.156"></a><span id="l39.156">     // we can safely presume if we are here that this folder has been selected</span>
<a href="#l39.157"></a><span id="l39.157">     //  for offline processing...</span>
<a href="#l39.158"></a><span id="l39.158"> </span>
<a href="#l39.159"></a><span id="l39.159">     // Handle the filthy case.  A filthy folder may have misleading properties</span>
<a href="#l39.160"></a><span id="l39.160">     //  on the message that claim the message is indexed.  They are misleading</span>
<a href="#l39.161"></a><span id="l39.161">     //  because the database, for whatever reason, does not have the messages</span>
<a href="#l39.162"></a><span id="l39.162">     //  (accurately) indexed.</span>
<a href="#l39.163"></a><span id="l39.163">     // We need to walk all the messages and mark them filthy if they have a</span>
<a href="#l39.164"></a><span id="l39.164" class="difflineat">@@ -1830,50 +1834,42 @@ var GlodaIndexer = {</span>
<a href="#l39.165"></a><span id="l39.165">   /**</span>
<a href="#l39.166"></a><span id="l39.166">    * Index a specific list of messages that we know to index from</span>
<a href="#l39.167"></a><span id="l39.167">    *  event-notification hints.</span>
<a href="#l39.168"></a><span id="l39.168">    */</span>
<a href="#l39.169"></a><span id="l39.169">   _worker_messageIndex: function gloda_worker_messageAdd(aJob) {</span>
<a href="#l39.170"></a><span id="l39.170">     // if we are already in the correct folder, our &quot;get in the folder&quot; clause</span>
<a href="#l39.171"></a><span id="l39.171">     //  will not execute, so we need to make sure this value is accurate in</span>
<a href="#l39.172"></a><span id="l39.172">     //  that case.  (and we want to avoid multiple checks...)</span>
<a href="#l39.173"></a><span id="l39.173" class="difflineminus">-    let folderIsLocal =</span>
<a href="#l39.174"></a><span id="l39.174" class="difflineminus">-      this._indexingFolder instanceof Ci.nsIMsgLocalMailFolder;</span>
<a href="#l39.175"></a><span id="l39.175">     for (; aJob.offset &lt; aJob.items.length; aJob.offset++) {</span>
<a href="#l39.176"></a><span id="l39.176">       let item = aJob.items[aJob.offset];</span>
<a href="#l39.177"></a><span id="l39.177">       // item is either [folder ID, message key] or</span>
<a href="#l39.178"></a><span id="l39.178">       //                [folder ID, message ID]</span>
<a href="#l39.179"></a><span id="l39.179"> </span>
<a href="#l39.180"></a><span id="l39.180">       // get in the folder</span>
<a href="#l39.181"></a><span id="l39.181">       if (!this._indexingGlodaFolder ||</span>
<a href="#l39.182"></a><span id="l39.182">           this._indexingGlodaFolder.id != item[0]) {</span>
<a href="#l39.183"></a><span id="l39.183">         yield this._indexerEnterFolder(item[0]);</span>
<a href="#l39.184"></a><span id="l39.184"> </span>
<a href="#l39.185"></a><span id="l39.185">         // stay out of folders we should not be in!</span>
<a href="#l39.186"></a><span id="l39.186">         if (!this.shouldIndexFolder(this._indexingFolder))</span>
<a href="#l39.187"></a><span id="l39.187">           continue;</span>
<a href="#l39.188"></a><span id="l39.188" class="difflineminus">-</span>
<a href="#l39.189"></a><span id="l39.189" class="difflineminus">-        folderIsLocal =</span>
<a href="#l39.190"></a><span id="l39.190" class="difflineminus">-          this._indexingFolder instanceof Ci.nsIMsgLocalMailFolder;</span>
<a href="#l39.191"></a><span id="l39.191">       }</span>
<a href="#l39.192"></a><span id="l39.192"> </span>
<a href="#l39.193"></a><span id="l39.193">       let msgHdr;</span>
<a href="#l39.194"></a><span id="l39.194">       if (typeof item[1] == &quot;number&quot;)</span>
<a href="#l39.195"></a><span id="l39.195">         msgHdr = this._indexingFolder.GetMessageHeader(item[1]);</span>
<a href="#l39.196"></a><span id="l39.196">       else</span>
<a href="#l39.197"></a><span id="l39.197">         // same deal as in move processing.</span>
<a href="#l39.198"></a><span id="l39.198">         // TODO fixme to not assume singular message-id's.</span>
<a href="#l39.199"></a><span id="l39.199">         msgHdr = this._indexingDatabase.getMsgHdrForMessageID(item[1]);</span>
<a href="#l39.200"></a><span id="l39.200"> </span>
<a href="#l39.201"></a><span id="l39.201" class="difflineminus">-      // it needs a header, the header needs to not be expunged, plus, the</span>
<a href="#l39.202"></a><span id="l39.202" class="difflineminus">-      //  message needs to be considered offline.</span>
<a href="#l39.203"></a><span id="l39.203" class="difflineplus">+      // it needs a header, and the header needs to not be expunged.</span>
<a href="#l39.204"></a><span id="l39.204">       if (msgHdr &amp;&amp;</span>
<a href="#l39.205"></a><span id="l39.205" class="difflineminus">-          !(msgHdr.flags &amp; Components.interfaces.nsMsgMessageFlags.Expunged) &amp;&amp;</span>
<a href="#l39.206"></a><span id="l39.206" class="difflineminus">-          (folderIsLocal ||</span>
<a href="#l39.207"></a><span id="l39.207" class="difflineminus">-           (msgHdr.flags &amp; Components.interfaces.nsMsgMessageFlags.Offline)))</span>
<a href="#l39.208"></a><span id="l39.208" class="difflineplus">+          !(msgHdr.flags &amp; Components.interfaces.nsMsgMessageFlags.Expunged))</span>
<a href="#l39.209"></a><span id="l39.209">         yield this._callbackHandle.pushAndGo(this._indexMessage(msgHdr,</span>
<a href="#l39.210"></a><span id="l39.210">             this._callbackHandle));</span>
<a href="#l39.211"></a><span id="l39.211">       else</span>
<a href="#l39.212"></a><span id="l39.212">         yield this.kWorkSync;</span>
<a href="#l39.213"></a><span id="l39.213">     }</span>
<a href="#l39.214"></a><span id="l39.214">     yield this.kWorkDone;</span>
<a href="#l39.215"></a><span id="l39.215">   },</span>
<a href="#l39.216"></a><span id="l39.216"> </span>
<a href="#l39.217"></a><span id="l39.217" class="difflineat">@@ -2064,19 +2060,26 @@ var GlodaIndexer = {</span>
<a href="#l39.218"></a><span id="l39.218">      *  is conceivable we will see a number of these events in fairly rapid</span>
<a href="#l39.219"></a><span id="l39.219">      *  succession.)</span>
<a href="#l39.220"></a><span id="l39.220">      */</span>
<a href="#l39.221"></a><span id="l39.221">     msgAdded: function gloda_indexer_msgAdded(aMsgHdr) {</span>
<a href="#l39.222"></a><span id="l39.222">       // make sure the message is eligible for indexing...</span>
<a href="#l39.223"></a><span id="l39.223">       let msgFolder = aMsgHdr.folder;</span>
<a href="#l39.224"></a><span id="l39.224">       if (!this.indexer.shouldIndexFolder(msgFolder))</span>
<a href="#l39.225"></a><span id="l39.225">         return;</span>
<a href="#l39.226"></a><span id="l39.226" class="difflineplus">+</span>
<a href="#l39.227"></a><span id="l39.227" class="difflineplus">+      // Make sure the message is eligible for indexing.</span>
<a href="#l39.228"></a><span id="l39.228" class="difflineplus">+      // We index local messages, IMAP messages that are offline, and IMAP</span>
<a href="#l39.229"></a><span id="l39.229" class="difflineplus">+      // messages that aren't offline but whose folders aren't offline either</span>
<a href="#l39.230"></a><span id="l39.230">       let isFolderLocal = msgFolder instanceof Ci.nsIMsgLocalMailFolder;</span>
<a href="#l39.231"></a><span id="l39.231" class="difflineminus">-      if (!isFolderLocal &amp;&amp; !(msgFolder.flags&amp;Ci.nsMsgFolderFlags.Offline))</span>
<a href="#l39.232"></a><span id="l39.232" class="difflineminus">-        return;</span>
<a href="#l39.233"></a><span id="l39.233" class="difflineplus">+      if (!isFolderLocal) {</span>
<a href="#l39.234"></a><span id="l39.234" class="difflineplus">+        if (!(aMsgHdr.flags &amp; Ci.nsMsgMessageFlags.Offline) &amp;&amp;</span>
<a href="#l39.235"></a><span id="l39.235" class="difflineplus">+            (msgFolder.flags &amp; Ci.nsMsgFolderFlags.Offline))</span>
<a href="#l39.236"></a><span id="l39.236" class="difflineplus">+          return;</span>
<a href="#l39.237"></a><span id="l39.237" class="difflineplus">+      }</span>
<a href="#l39.238"></a><span id="l39.238"> </span>
<a href="#l39.239"></a><span id="l39.239">       // mark the folder dirty so we know to look in it, but there is no need</span>
<a href="#l39.240"></a><span id="l39.240">       //  to mark the message because it will lack a gloda-id anyways.</span>
<a href="#l39.241"></a><span id="l39.241">       let glodaFolder = GlodaDatastore._mapFolder(msgFolder);</span>
<a href="#l39.242"></a><span id="l39.242">       glodaFolder.dirtyStatus = true;</span>
<a href="#l39.243"></a><span id="l39.243"> </span>
<a href="#l39.244"></a><span id="l39.244">       if (this.indexer._pendingAddJob === null) {</span>
<a href="#l39.245"></a><span id="l39.245">         this.indexer._pendingAddJob = new IndexingJob(&quot;message&quot;, 1, null);</span>
<a href="#l39.246"></a><span id="l39.246" class="difflineat">@@ -2374,19 +2377,26 @@ var GlodaIndexer = {</span>
<a href="#l39.247"></a><span id="l39.247">      *  the indexer will cleanly map this to the existing gloda message.</span>
<a href="#l39.248"></a><span id="l39.248">      */</span>
<a href="#l39.249"></a><span id="l39.249">     _reindexChangedMessage: function gloda_indexer_reindexChangedMessage(</span>
<a href="#l39.250"></a><span id="l39.250">         aMsgHdr) {</span>
<a href="#l39.251"></a><span id="l39.251">       // make sure the message is eligible for indexing...</span>
<a href="#l39.252"></a><span id="l39.252">       let msgFolder = aMsgHdr.folder;</span>
<a href="#l39.253"></a><span id="l39.253">       if (!this.indexer.shouldIndexFolder(msgFolder))</span>
<a href="#l39.254"></a><span id="l39.254">         return;</span>
<a href="#l39.255"></a><span id="l39.255" class="difflineplus">+</span>
<a href="#l39.256"></a><span id="l39.256" class="difflineplus">+      // Make sure the message is eligible for indexing.</span>
<a href="#l39.257"></a><span id="l39.257" class="difflineplus">+      // We index local messages, IMAP messages that are offline, and IMAP</span>
<a href="#l39.258"></a><span id="l39.258" class="difflineplus">+      // messages that aren't offline but whose folders aren't offline either</span>
<a href="#l39.259"></a><span id="l39.259">       let isFolderLocal = msgFolder instanceof Ci.nsIMsgLocalMailFolder;</span>
<a href="#l39.260"></a><span id="l39.260" class="difflineminus">-      if (!isFolderLocal &amp;&amp; !(msgFolder.flags&amp;Ci.nsMsgFolderFlags.Offline))</span>
<a href="#l39.261"></a><span id="l39.261" class="difflineminus">-        return;</span>
<a href="#l39.262"></a><span id="l39.262" class="difflineplus">+      if (!isFolderLocal) {</span>
<a href="#l39.263"></a><span id="l39.263" class="difflineplus">+        if (!(aMsgHdr.flags &amp; Ci.nsMsgMessageFlags.Offline) &amp;&amp;</span>
<a href="#l39.264"></a><span id="l39.264" class="difflineplus">+            (msgFolder.flags &amp; Ci.nsMsgFolderFlags.Offline))</span>
<a href="#l39.265"></a><span id="l39.265" class="difflineplus">+          return;</span>
<a href="#l39.266"></a><span id="l39.266" class="difflineplus">+      }</span>
<a href="#l39.267"></a><span id="l39.267"> </span>
<a href="#l39.268"></a><span id="l39.268">       // mark the message as dirty</span>
<a href="#l39.269"></a><span id="l39.269">       // (We could check for the presence of the gloda message id property</span>
<a href="#l39.270"></a><span id="l39.270">       //  first to know whether we technically need the dirty property.  I'm</span>
<a href="#l39.271"></a><span id="l39.271">       //  not sure whether it is worth the high-probability exception cost.)</span>
<a href="#l39.272"></a><span id="l39.272">       aMsgHdr.setUint32Property(GLODA_DIRTY_PROPERTY, 1);</span>
<a href="#l39.273"></a><span id="l39.273">       // mark the folder dirty too, so we know to look inside</span>
<a href="#l39.274"></a><span id="l39.274">       let glodaFolder = GlodaDatastore._mapFolder(msgFolder);</span>
<a href="#l39.275"></a><span id="l39.275" class="difflineat">@@ -2394,23 +2404,25 @@ var GlodaIndexer = {</span>
<a href="#l39.276"></a><span id="l39.276"> </span>
<a href="#l39.277"></a><span id="l39.277">       if (this.indexer._pendingAddJob === null) {</span>
<a href="#l39.278"></a><span id="l39.278">         this.indexer._pendingAddJob = new IndexingJob(&quot;message&quot;, 1, null);</span>
<a href="#l39.279"></a><span id="l39.279">         this.indexer._indexQueue.push(this.indexer._pendingAddJob);</span>
<a href="#l39.280"></a><span id="l39.280">         this.indexer._indexingJobGoal++;</span>
<a href="#l39.281"></a><span id="l39.281">       }</span>
<a href="#l39.282"></a><span id="l39.282">       // only queue the message if we haven't overflowed our event-driven budget</span>
<a href="#l39.283"></a><span id="l39.283">       if (this.indexer._pendingAddJob.items.length &lt;</span>
<a href="#l39.284"></a><span id="l39.284" class="difflineminus">-          this.indexer._indexMaxEventQueueMessages)</span>
<a href="#l39.285"></a><span id="l39.285" class="difflineplus">+          this.indexer._indexMaxEventQueueMessages) {</span>
<a href="#l39.286"></a><span id="l39.286">         this.indexer._pendingAddJob.items.push(</span>
<a href="#l39.287"></a><span id="l39.287">           [GlodaDatastore._mapFolder(msgFolder).id,</span>
<a href="#l39.288"></a><span id="l39.288">            aMsgHdr.messageKey]);</span>
<a href="#l39.289"></a><span id="l39.289" class="difflineminus">-      else</span>
<a href="#l39.290"></a><span id="l39.290" class="difflineplus">+        this.indexer.indexing = true;</span>
<a href="#l39.291"></a><span id="l39.291" class="difflineplus">+      }</span>
<a href="#l39.292"></a><span id="l39.292" class="difflineplus">+      else {</span>
<a href="#l39.293"></a><span id="l39.293">         this.indexer.indexingSweepNeeded = true;</span>
<a href="#l39.294"></a><span id="l39.294" class="difflineminus">-      this.indexer.indexing = true;</span>
<a href="#l39.295"></a><span id="l39.295" class="difflineplus">+      }</span>
<a href="#l39.296"></a><span id="l39.296">     },</span>
<a href="#l39.297"></a><span id="l39.297"> </span>
<a href="#l39.298"></a><span id="l39.298">     OnItemAdded: function gloda_indexer_OnItemAdded(aParentItem, aItem) {</span>
<a href="#l39.299"></a><span id="l39.299">     },</span>
<a href="#l39.300"></a><span id="l39.300">     OnItemRemoved: function gloda_indexer_OnItemRemoved(aParentItem, aItem) {</span>
<a href="#l39.301"></a><span id="l39.301">     },</span>
<a href="#l39.302"></a><span id="l39.302">     OnItemPropertyChanged: function gloda_indexer_OnItemPropertyChanged(</span>
<a href="#l39.303"></a><span id="l39.303">                              aItem, aProperty, aOldValue, aNewValue) {</span>
<a href="#l39.304"></a><span id="l39.304" class="difflineat">@@ -2480,23 +2492,37 @@ var GlodaIndexer = {</span>
<a href="#l39.305"></a><span id="l39.305">     onJunkScoreChanged: function(aInstigator) {},</span>
<a href="#l39.306"></a><span id="l39.306">     onHdrPropertyChanged: function (aHdrToChange, aPreChange, aStatus,</span>
<a href="#l39.307"></a><span id="l39.307">                                     aInstigator) {},</span>
<a href="#l39.308"></a><span id="l39.308">     onEvent: function (aDB, aEvent) {},</span>
<a href="#l39.309"></a><span id="l39.309">   },</span>
<a href="#l39.310"></a><span id="l39.310"> </span>
<a href="#l39.311"></a><span id="l39.311">   _indexMessage: function gloda_indexMessage(aMsgHdr, aCallbackHandle) {</span>
<a href="#l39.312"></a><span id="l39.312">     let logDebug = this._log.level &lt;= Log4Moz.Level.Debug;</span>
<a href="#l39.313"></a><span id="l39.313" class="difflineminus">-</span>
<a href="#l39.314"></a><span id="l39.314">     if (logDebug)</span>
<a href="#l39.315"></a><span id="l39.315">       this._log.debug(&quot;*** Indexing message: &quot; + aMsgHdr.messageKey + &quot; : &quot; +</span>
<a href="#l39.316"></a><span id="l39.316">                       aMsgHdr.subject);</span>
<a href="#l39.317"></a><span id="l39.317" class="difflineminus">-    MsgHdrToMimeMessage(aMsgHdr, aCallbackHandle.callbackThis,</span>
<a href="#l39.318"></a><span id="l39.318" class="difflineminus">-        aCallbackHandle.callback);</span>
<a href="#l39.319"></a><span id="l39.319" class="difflineminus">-    let [,aMimeMsg] = yield this.kWorkAsync;</span>
<a href="#l39.320"></a><span id="l39.320" class="difflineplus">+</span>
<a href="#l39.321"></a><span id="l39.321" class="difflineplus">+    // If the message is offline, then get the message body as well</span>
<a href="#l39.322"></a><span id="l39.322" class="difflineplus">+    let isMsgOffline = false;</span>
<a href="#l39.323"></a><span id="l39.323" class="difflineplus">+    let aMimeMsg;</span>
<a href="#l39.324"></a><span id="l39.324" class="difflineplus">+    if ((aMsgHdr.flags &amp; Ci.nsMsgMessageFlags.Offline) ||</span>
<a href="#l39.325"></a><span id="l39.325" class="difflineplus">+        (aMsgHdr.folder instanceof Ci.nsIMsgLocalMailFolder)) {</span>
<a href="#l39.326"></a><span id="l39.326" class="difflineplus">+      isMsgOffline = true;</span>
<a href="#l39.327"></a><span id="l39.327" class="difflineplus">+      MsgHdrToMimeMessage(aMsgHdr, aCallbackHandle.callbackThis,</span>
<a href="#l39.328"></a><span id="l39.328" class="difflineplus">+          aCallbackHandle.callback);</span>
<a href="#l39.329"></a><span id="l39.329" class="difflineplus">+      [,aMimeMsg] = yield this.kWorkAsync;</span>
<a href="#l39.330"></a><span id="l39.330" class="difflineplus">+    }</span>
<a href="#l39.331"></a><span id="l39.331" class="difflineplus">+    else {</span>
<a href="#l39.332"></a><span id="l39.332" class="difflineplus">+      if (logDebug)</span>
<a href="#l39.333"></a><span id="l39.333" class="difflineplus">+        this._log.debug(&quot;  * Message is not offline -- only headers indexed&quot;);</span>
<a href="#l39.334"></a><span id="l39.334" class="difflineplus">+    }</span>
<a href="#l39.335"></a><span id="l39.335" class="difflineplus">+</span>
<a href="#l39.336"></a><span id="l39.336" class="difflineplus">+    if (logDebug)</span>
<a href="#l39.337"></a><span id="l39.337" class="difflineplus">+      this._log.debug(&quot;  * Got message, subject &quot; + aMsgHdr.subject);</span>
<a href="#l39.338"></a><span id="l39.338"> </span>
<a href="#l39.339"></a><span id="l39.339">     if (this._unitTestSuperVerbose) {</span>
<a href="#l39.340"></a><span id="l39.340">       if (aMimeMsg)</span>
<a href="#l39.341"></a><span id="l39.341">         this._log.debug(&quot;  * Got Mime &quot; + aMimeMsg.prettyString());</span>
<a href="#l39.342"></a><span id="l39.342">       else</span>
<a href="#l39.343"></a><span id="l39.343">         this._log.debug(&quot;  * NO MIME MESSAGE!!!\n&quot;);</span>
<a href="#l39.344"></a><span id="l39.344">     }</span>
<a href="#l39.345"></a><span id="l39.345"> </span>
<a href="#l39.346"></a><span id="l39.346" class="difflineat">@@ -2506,18 +2532,18 @@ var GlodaIndexer = {</span>
<a href="#l39.347"></a><span id="l39.347"> </span>
<a href="#l39.348"></a><span id="l39.348">     // - See if any of the ancestors exist and have a conversationID...</span>
<a href="#l39.349"></a><span id="l39.349">     // (references are ordered from old [0] to new [n-1])</span>
<a href="#l39.350"></a><span id="l39.350">     let references = [aMsgHdr.getStringReference(i) for each</span>
<a href="#l39.351"></a><span id="l39.351">                       (i in range(0, aMsgHdr.numReferences))];</span>
<a href="#l39.352"></a><span id="l39.352">     // also see if we already know about the message...</span>
<a href="#l39.353"></a><span id="l39.353">     references.push(aMsgHdr.messageId);</span>
<a href="#l39.354"></a><span id="l39.354"> </span>
<a href="#l39.355"></a><span id="l39.355" class="difflineminus">-    this._datastore.getMessagesByMessageID(references, aCallbackHandle.callback,</span>
<a href="#l39.356"></a><span id="l39.356" class="difflineminus">-      aCallbackHandle.callbackThis);</span>
<a href="#l39.357"></a><span id="l39.357" class="difflineplus">+    Gloda.getMessagesByMessageID(references, aCallbackHandle.callback,</span>
<a href="#l39.358"></a><span id="l39.358" class="difflineplus">+                                 aCallbackHandle.callbackThis);</span>
<a href="#l39.359"></a><span id="l39.359">     // (ancestorLists has a direct correspondence to the message ids)</span>
<a href="#l39.360"></a><span id="l39.360">     let ancestorLists = yield this.kWorkAsync;</span>
<a href="#l39.361"></a><span id="l39.361"> </span>
<a href="#l39.362"></a><span id="l39.362">     if (logDebug) {</span>
<a href="#l39.363"></a><span id="l39.363">       this._log.debug(&quot;ancestors raw: &quot; + ancestorLists);</span>
<a href="#l39.364"></a><span id="l39.364">       this._log.debug(&quot;ref len: &quot; + references.length + &quot; anc len: &quot; + ancestorLists.length);</span>
<a href="#l39.365"></a><span id="l39.365">       this._log.debug(&quot;references: &quot; + Log4Moz.enumerateProperties(references).join(&quot;,&quot;));</span>
<a href="#l39.366"></a><span id="l39.366">       this._log.debug(&quot;ancestors: &quot; + Log4Moz.enumerateProperties(ancestorLists).join(&quot;,&quot;));</span>
<a href="#l39.367"></a><span id="l39.367" class="difflineat">@@ -2663,38 +2689,38 @@ var GlodaIndexer = {</span>
<a href="#l39.368"></a><span id="l39.368">       //  associated with the id is still exactly the same.  It is conceivable</span>
<a href="#l39.369"></a><span id="l39.369">       //  that there are cases where this is not true.</span>
<a href="#l39.370"></a><span id="l39.370">     }</span>
<a href="#l39.371"></a><span id="l39.371"> </span>
<a href="#l39.372"></a><span id="l39.372">     if (aMimeMsg) {</span>
<a href="#l39.373"></a><span id="l39.373">       let bodyPlain = aMimeMsg.coerceBodyToPlaintext(aMsgHdr.folder);</span>
<a href="#l39.374"></a><span id="l39.374">       if (bodyPlain) {</span>
<a href="#l39.375"></a><span id="l39.375">         curMsg._bodyLines = bodyPlain.split(/\r?\n/);</span>
<a href="#l39.376"></a><span id="l39.376" class="difflineminus">-        curMsg._content = new GlodaContent();</span>
<a href="#l39.377"></a><span id="l39.377" class="difflineplus">+        // curMsg._content gets set by fundattr.js</span>
<a href="#l39.378"></a><span id="l39.378">       }</span>
<a href="#l39.379"></a><span id="l39.379">     }</span>
<a href="#l39.380"></a><span id="l39.380"> </span>
<a href="#l39.381"></a><span id="l39.381">     if (isConceptuallyNew) {</span>
<a href="#l39.382"></a><span id="l39.382">       curMsg._isNew = true;</span>
<a href="#l39.383"></a><span id="l39.383">       // curMsg._indexedBodyText is set by GlodaDatastore.insertMessage or</span>
<a href="#l39.384"></a><span id="l39.384">       //  GlodaDatastore.updateMessage</span>
<a href="#l39.385"></a><span id="l39.385" class="difflineminus">-      curMsg._subject = aMsgHdr.mime2DecodedSubject;</span>
<a href="#l39.386"></a><span id="l39.386" class="difflineminus">-      curMsg._attachmentNames = attachmentNames;</span>
<a href="#l39.387"></a><span id="l39.387" class="difflineplus">+    }</span>
<a href="#l39.388"></a><span id="l39.388"> </span>
<a href="#l39.389"></a><span id="l39.389" class="difflineminus">-      // curMsg._indexAuthor gets set by fundattr.js</span>
<a href="#l39.390"></a><span id="l39.390" class="difflineminus">-      // curMsg._indexRecipients gets set by fundattr.js</span>
<a href="#l39.391"></a><span id="l39.391" class="difflineminus">-    }</span>
<a href="#l39.392"></a><span id="l39.392" class="difflineplus">+    curMsg._subject = aMsgHdr.mime2DecodedSubject;</span>
<a href="#l39.393"></a><span id="l39.393" class="difflineplus">+    curMsg._attachmentNames = attachmentNames;</span>
<a href="#l39.394"></a><span id="l39.394" class="difflineplus">+</span>
<a href="#l39.395"></a><span id="l39.395" class="difflineplus">+    // curMsg._indexAuthor gets set by fundattr.js</span>
<a href="#l39.396"></a><span id="l39.396" class="difflineplus">+    // curMsg._indexRecipients gets set by fundattr.js</span>
<a href="#l39.397"></a><span id="l39.397"> </span>
<a href="#l39.398"></a><span id="l39.398">     // zero the notability so everything in grokNounItem can just increment</span>
<a href="#l39.399"></a><span id="l39.399">     curMsg.notability = 0;</span>
<a href="#l39.400"></a><span id="l39.400"> </span>
<a href="#l39.401"></a><span id="l39.401">     yield aCallbackHandle.pushAndGo(</span>
<a href="#l39.402"></a><span id="l39.402">         Gloda.grokNounItem(curMsg,</span>
<a href="#l39.403"></a><span id="l39.403" class="difflineminus">-            {header: aMsgHdr, mime: aMimeMsg,</span>
<a href="#l39.404"></a><span id="l39.404" class="difflineminus">-             bodyLines: curMsg._bodyLines, content: curMsg._content},</span>
<a href="#l39.405"></a><span id="l39.405" class="difflineplus">+            {header: aMsgHdr, mime: aMimeMsg, bodyLines: curMsg._bodyLines},</span>
<a href="#l39.406"></a><span id="l39.406">             isConceptuallyNew, isRecordNew,</span>
<a href="#l39.407"></a><span id="l39.407">             aCallbackHandle));</span>
<a href="#l39.408"></a><span id="l39.408"> </span>
<a href="#l39.409"></a><span id="l39.409">     delete curMsg._bodyLines;</span>
<a href="#l39.410"></a><span id="l39.410">     delete curMsg._content;</span>
<a href="#l39.411"></a><span id="l39.411">     delete curMsg._isNew;</span>
<a href="#l39.412"></a><span id="l39.412">     delete curMsg._indexAuthor;</span>
<a href="#l39.413"></a><span id="l39.413">     delete curMsg._indexRecipients;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l40.1"></a><span id="l40.1" class="difflineminus">--- a/mailnews/db/gloda/modules/query.js</span>
<a href="#l40.2"></a><span id="l40.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/query.js</span>
<a href="#l40.3"></a><span id="l40.3" class="difflineat">@@ -68,16 +68,19 @@ Cu.import(&quot;resource://app/modules/gloda/</span>
<a href="#l40.4"></a><span id="l40.4">  *     - outerWrapColumns: If provided, wraps the query in a &quot;SELECT *,blah</span>
<a href="#l40.5"></a><span id="l40.5">  *           FROM (actual query)&quot; where blah is your list of outerWrapColumns</span>
<a href="#l40.6"></a><span id="l40.6">  *           made comma-delimited.  The idea is that this allows you to</span>
<a href="#l40.7"></a><span id="l40.7">  *           reference the result of expressions inside the query using their</span>
<a href="#l40.8"></a><span id="l40.8">  *           names rather than having to duplicate the logic.  In practice,</span>
<a href="#l40.9"></a><span id="l40.9">  *           this makes things more readable but is unlikely to improve</span>
<a href="#l40.10"></a><span id="l40.10">  *           performance.  (Namely, my use of 'offsets' for full-text stuff</span>
<a href="#l40.11"></a><span id="l40.11">  *           ends up in the EXPLAIN plan twice despite this.)</span>
<a href="#l40.12"></a><span id="l40.12" class="difflineplus">+ *     - noDbQueryValidityConstraints: Indicates that any validity constraints</span>
<a href="#l40.13"></a><span id="l40.13" class="difflineplus">+ *           should be ignored. This should be used when you need to get every</span>
<a href="#l40.14"></a><span id="l40.14" class="difflineplus">+ *           match regardless of whether it's valid.</span>
<a href="#l40.15"></a><span id="l40.15">  *</span>
<a href="#l40.16"></a><span id="l40.16">  * @property _owner The query instance that holds the list of unions...</span>
<a href="#l40.17"></a><span id="l40.17">  * @property _constraints A list of (lists of OR constraints) that are ANDed</span>
<a href="#l40.18"></a><span id="l40.18">  *     together.  For example [[FROM bob, FROM jim], [DATE last week]] would</span>
<a href="#l40.19"></a><span id="l40.19">  *     be requesting us to find all the messages from either bob or jim, and</span>
<a href="#l40.20"></a><span id="l40.20">  *     sent in the last week.</span>
<a href="#l40.21"></a><span id="l40.21">  * @property _unions A list of other queries whose results are unioned with our</span>
<a href="#l40.22"></a><span id="l40.22">  *     own.  There is no concept of nesting or sub-queries apart from this</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l41.1"></a><span id="l41.1" class="difflineminus">--- a/mailnews/db/gloda/test/unit/resources/glodaTestHelper.js</span>
<a href="#l41.2"></a><span id="l41.2" class="difflineplus">+++ b/mailnews/db/gloda/test/unit/resources/glodaTestHelper.js</span>
<a href="#l41.3"></a><span id="l41.3" class="difflineat">@@ -15,33 +15,35 @@</span>
<a href="#l41.4"></a><span id="l41.4">  *</span>
<a href="#l41.5"></a><span id="l41.5">  * The Initial Developer of the Original Code is</span>
<a href="#l41.6"></a><span id="l41.6">  * Mozilla Messaging, Inc.</span>
<a href="#l41.7"></a><span id="l41.7">  * Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l41.8"></a><span id="l41.8">  * the Initial Developer. All Rights Reserved.</span>
<a href="#l41.9"></a><span id="l41.9">  *</span>
<a href="#l41.10"></a><span id="l41.10">  * Contributor(s):</span>
<a href="#l41.11"></a><span id="l41.11">  *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l41.12"></a><span id="l41.12" class="difflineplus">+ *   Siddharth Agarwal &lt;sid.bugzilla@gmail.com&gt;</span>
<a href="#l41.13"></a><span id="l41.13">  *</span>
<a href="#l41.14"></a><span id="l41.14">  * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l41.15"></a><span id="l41.15">  * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l41.16"></a><span id="l41.16">  * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l41.17"></a><span id="l41.17">  * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l41.18"></a><span id="l41.18">  * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l41.19"></a><span id="l41.19">  * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l41.20"></a><span id="l41.20">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l41.21"></a><span id="l41.21">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l41.22"></a><span id="l41.22">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l41.23"></a><span id="l41.23">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l41.24"></a><span id="l41.24">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l41.25"></a><span id="l41.25">  *</span>
<a href="#l41.26"></a><span id="l41.26">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l41.27"></a><span id="l41.27"> </span>
<a href="#l41.28"></a><span id="l41.28" class="difflineminus">-// -- Pull in the POP3 fake-server / local account helper code</span>
<a href="#l41.29"></a><span id="l41.29" class="difflineminus">-load(&quot;../../test_mailnewslocal/unit/head_maillocal.js&quot;);</span>
<a href="#l41.30"></a><span id="l41.30" class="difflineplus">+// Import the main scripts that mailnews tests need to set up and tear down</span>
<a href="#l41.31"></a><span id="l41.31" class="difflineplus">+load(&quot;../../mailnews/resources/mailDirService.js&quot;);</span>
<a href="#l41.32"></a><span id="l41.32" class="difflineplus">+load(&quot;../../mailnews/resources/mailTestUtils.js&quot;);</span>
<a href="#l41.33"></a><span id="l41.33"> </span>
<a href="#l41.34"></a><span id="l41.34"> /**</span>
<a href="#l41.35"></a><span id="l41.35">  * Create a 'me' identity of &quot;me@localhost&quot; for the benefit of Gloda.  At the</span>
<a href="#l41.36"></a><span id="l41.36">  *  time of this writing, Gloda only initializes Gloda.myIdentities and</span>
<a href="#l41.37"></a><span id="l41.37">  *  Gloda.myContact at startup with no event-driven updates.  As such, this</span>
<a href="#l41.38"></a><span id="l41.38">  *  function needs to be called prior to gloda startup.</span>
<a href="#l41.39"></a><span id="l41.39">  */</span>
<a href="#l41.40"></a><span id="l41.40"> function createMeIdentity() {</span>
<a href="#l41.41"></a><span id="l41.41" class="difflineat">@@ -212,27 +214,54 @@ function getObjectTree(o, recurse, compr</span>
<a href="#l41.42"></a><span id="l41.42">  *     never really needed it anyways.  I just didn't know about the local</span>
<a href="#l41.43"></a><span id="l41.43">  *     folder addMessage method.  (so sad!)</span>
<a href="#l41.44"></a><span id="l41.44">  */</span>
<a href="#l41.45"></a><span id="l41.45"> const INJECT_FAKE_SERVER = 1;</span>
<a href="#l41.46"></a><span id="l41.46"> /** Inject messages using freshly created mboxes. */</span>
<a href="#l41.47"></a><span id="l41.47"> const INJECT_MBOX = 2;</span>
<a href="#l41.48"></a><span id="l41.48"> /** Inject messages using addMessage. */</span>
<a href="#l41.49"></a><span id="l41.49"> const INJECT_ADDMESSAGE = 3;</span>
<a href="#l41.50"></a><span id="l41.50" class="difflineplus">+/** Inject messages using the IMAP fakeserver. */</span>
<a href="#l41.51"></a><span id="l41.51" class="difflineplus">+const INJECT_IMAP_FAKE_SERVER = 4;</span>
<a href="#l41.52"></a><span id="l41.52"> </span>
<a href="#l41.53"></a><span id="l41.53"> /**</span>
<a href="#l41.54"></a><span id="l41.54">  * Convert a list of synthetic messages to a form appropriate to feed to the</span>
<a href="#l41.55"></a><span id="l41.55">  *  POP3 fakeserver.</span>
<a href="#l41.56"></a><span id="l41.56">  */</span>
<a href="#l41.57"></a><span id="l41.57"> function _synthMessagesToFakeRep(aSynthMessages) {</span>
<a href="#l41.58"></a><span id="l41.58">   return [{fileData: msg.toMessageString(), size: -1} for each</span>
<a href="#l41.59"></a><span id="l41.59">           (msg in aSynthMessages)];</span>
<a href="#l41.60"></a><span id="l41.60"> }</span>
<a href="#l41.61"></a><span id="l41.61"> </span>
<a href="#l41.62"></a><span id="l41.62" class="difflineplus">+function lobotomizeAdaptiveIndexer() {</span>
<a href="#l41.63"></a><span id="l41.63" class="difflineplus">+  // The indexer doesn't need to worry about load; zero his rescheduling time.</span>
<a href="#l41.64"></a><span id="l41.64" class="difflineplus">+  GlodaIndexer._INDEX_INTERVAL = 0;</span>
<a href="#l41.65"></a><span id="l41.65" class="difflineplus">+</span>
<a href="#l41.66"></a><span id="l41.66" class="difflineplus">+  let realIdleService = GlodaIndexer._idleService;</span>
<a href="#l41.67"></a><span id="l41.67" class="difflineplus">+  // pretend we are always idle</span>
<a href="#l41.68"></a><span id="l41.68" class="difflineplus">+  GlodaIndexer._idleService = {</span>
<a href="#l41.69"></a><span id="l41.69" class="difflineplus">+    idleTime: 1000,</span>
<a href="#l41.70"></a><span id="l41.70" class="difflineplus">+    addIdleObserver: function() {</span>
<a href="#l41.71"></a><span id="l41.71" class="difflineplus">+      realIdleService.addIdleObserver.apply(realIdleService, arguments);</span>
<a href="#l41.72"></a><span id="l41.72" class="difflineplus">+    },</span>
<a href="#l41.73"></a><span id="l41.73" class="difflineplus">+    removeIdleObserver: function() {</span>
<a href="#l41.74"></a><span id="l41.74" class="difflineplus">+      realIdleService.removeIdleObserver.apply(realIdleService, arguments);</span>
<a href="#l41.75"></a><span id="l41.75" class="difflineplus">+    }</span>
<a href="#l41.76"></a><span id="l41.76" class="difflineplus">+  };</span>
<a href="#l41.77"></a><span id="l41.77" class="difflineplus">+</span>
<a href="#l41.78"></a><span id="l41.78" class="difflineplus">+  // Lobotomize the adaptive indexer</span>
<a href="#l41.79"></a><span id="l41.79" class="difflineplus">+  GlodaIndexer._cpuTargetIndexTime = 10000;</span>
<a href="#l41.80"></a><span id="l41.80" class="difflineplus">+  GlodaIndexer._CPU_TARGET_INDEX_TIME_ACTIVE = 10000;</span>
<a href="#l41.81"></a><span id="l41.81" class="difflineplus">+  GlodaIndexer._CPU_TARGET_INDEX_TIME_IDLE = 10000;</span>
<a href="#l41.82"></a><span id="l41.82" class="difflineplus">+  GlodaIndexer._CPU_IS_BUSY_TIME = 10000;</span>
<a href="#l41.83"></a><span id="l41.83" class="difflineplus">+  GlodaIndexer._PAUSE_LATE_IS_BUSY_TIME = 10000;</span>
<a href="#l41.84"></a><span id="l41.84" class="difflineplus">+}</span>
<a href="#l41.85"></a><span id="l41.85" class="difflineplus">+</span>
<a href="#l41.86"></a><span id="l41.86"> function imsInit() {</span>
<a href="#l41.87"></a><span id="l41.87" class="difflineplus">+  dump(&quot;Initializing index message state\n&quot;);</span>
<a href="#l41.88"></a><span id="l41.88">   let ims = indexMessageState;</span>
<a href="#l41.89"></a><span id="l41.89"> </span>
<a href="#l41.90"></a><span id="l41.90">   if (!ims.inited) {</span>
<a href="#l41.91"></a><span id="l41.91">     // Disable new mail notifications</span>
<a href="#l41.92"></a><span id="l41.92">     var prefSvc = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l41.93"></a><span id="l41.93">       .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l41.94"></a><span id="l41.94"> </span>
<a href="#l41.95"></a><span id="l41.95">     prefSvc.setBoolPref(&quot;mail.biff.play_sound&quot;, false);</span>
<a href="#l41.96"></a><span id="l41.96" class="difflineat">@@ -241,55 +270,74 @@ function imsInit() {</span>
<a href="#l41.97"></a><span id="l41.97">     prefSvc.setBoolPref(&quot;mail.biff.animate_dock_icon&quot;, false);</span>
<a href="#l41.98"></a><span id="l41.98"> </span>
<a href="#l41.99"></a><span id="l41.99">     Gloda.addIndexerListener(messageIndexerListener.onIndexNotification);</span>
<a href="#l41.100"></a><span id="l41.100">     ims.catchAllCollection = Gloda._wildcardCollection(Gloda.NOUN_MESSAGE);</span>
<a href="#l41.101"></a><span id="l41.101">     ims.catchAllCollection.listener = messageCollectionListener;</span>
<a href="#l41.102"></a><span id="l41.102"> </span>
<a href="#l41.103"></a><span id="l41.103">     // Make the indexer be more verbose about indexing for us...</span>
<a href="#l41.104"></a><span id="l41.104">     GlodaIndexer._unitTestSuperVerbose = true;</span>
<a href="#l41.105"></a><span id="l41.105" class="difflineminus">-    // The indexer doesn't need to worry about load; zero his rescheduling time.</span>
<a href="#l41.106"></a><span id="l41.106" class="difflineminus">-    GlodaIndexer._INDEX_INTERVAL = 0;</span>
<a href="#l41.107"></a><span id="l41.107"> </span>
<a href="#l41.108"></a><span id="l41.108" class="difflineminus">-    let realIdleService = GlodaIndexer._idleService;</span>
<a href="#l41.109"></a><span id="l41.109" class="difflineminus">-    // pretend we are always idle</span>
<a href="#l41.110"></a><span id="l41.110" class="difflineminus">-    GlodaIndexer._idleService = {</span>
<a href="#l41.111"></a><span id="l41.111" class="difflineminus">-      idleTime: 1000,</span>
<a href="#l41.112"></a><span id="l41.112" class="difflineminus">-      addIdleObserver: function() {</span>
<a href="#l41.113"></a><span id="l41.113" class="difflineminus">-        realIdleService.addIdleObserver.apply(realIdleService, arguments);</span>
<a href="#l41.114"></a><span id="l41.114" class="difflineminus">-      },</span>
<a href="#l41.115"></a><span id="l41.115" class="difflineminus">-      removeIdleObserver: function() {</span>
<a href="#l41.116"></a><span id="l41.116" class="difflineminus">-        realIdleService.removeIdleObserver.apply(realIdleService, arguments);</span>
<a href="#l41.117"></a><span id="l41.117" class="difflineminus">-      }</span>
<a href="#l41.118"></a><span id="l41.118" class="difflineminus">-    };</span>
<a href="#l41.119"></a><span id="l41.119" class="difflineminus">-</span>
<a href="#l41.120"></a><span id="l41.120" class="difflineminus">-    // Lobotomize the adaptive indexer</span>
<a href="#l41.121"></a><span id="l41.121" class="difflineminus">-    GlodaIndexer._cpuTargetIndexTime = 10000;</span>
<a href="#l41.122"></a><span id="l41.122" class="difflineminus">-    GlodaIndexer._CPU_TARGET_INDEX_TIME_ACTIVE = 10000;</span>
<a href="#l41.123"></a><span id="l41.123" class="difflineminus">-    GlodaIndexer._CPU_TARGET_INDEX_TIME_IDLE = 10000;</span>
<a href="#l41.124"></a><span id="l41.124" class="difflineminus">-    GlodaIndexer._CPU_IS_BUSY_TIME = 10000;</span>
<a href="#l41.125"></a><span id="l41.125" class="difflineminus">-    GlodaIndexer._PAUSE_LATE_IS_BUSY_TIME = 10000;</span>
<a href="#l41.126"></a><span id="l41.126" class="difflineplus">+    lobotomizeAdaptiveIndexer();</span>
<a href="#l41.127"></a><span id="l41.127"> </span>
<a href="#l41.128"></a><span id="l41.128">     if (ims.injectMechanism == INJECT_FAKE_SERVER) {</span>
<a href="#l41.129"></a><span id="l41.129" class="difflineplus">+      // -- Pull in the POP3 fake-server / local account helper code</span>
<a href="#l41.130"></a><span id="l41.130" class="difflineplus">+      load(&quot;../../test_mailnewslocal/unit/head_maillocal.js&quot;);</span>
<a href="#l41.131"></a><span id="l41.131">       // set up POP3 fakeserver to feed things in...</span>
<a href="#l41.132"></a><span id="l41.132">       [ims.daemon, ims.server] = setupServerDaemon();</span>
<a href="#l41.133"></a><span id="l41.133">       // (this will call loadLocalMailAccount())</span>
<a href="#l41.134"></a><span id="l41.134">       ims.incomingServer = createPop3ServerAndLocalFolders();</span>
<a href="#l41.135"></a><span id="l41.135"> </span>
<a href="#l41.136"></a><span id="l41.136">       ims.pop3Service = Cc[&quot;@mozilla.org/messenger/popservice;1&quot;]</span>
<a href="#l41.137"></a><span id="l41.137">                           .getService(Ci.nsIPop3Service);</span>
<a href="#l41.138"></a><span id="l41.138">     }</span>
<a href="#l41.139"></a><span id="l41.139">     else if (ims.injectMechanism == INJECT_MBOX) {</span>
<a href="#l41.140"></a><span id="l41.140">       // we need a local account to stash the mboxes under.</span>
<a href="#l41.141"></a><span id="l41.141">       loadLocalMailAccount();</span>
<a href="#l41.142"></a><span id="l41.142">     }</span>
<a href="#l41.143"></a><span id="l41.143">     else if (ims.injectMechanism == INJECT_ADDMESSAGE) {</span>
<a href="#l41.144"></a><span id="l41.144">       // we need an inbox</span>
<a href="#l41.145"></a><span id="l41.145">       loadLocalMailAccount();</span>
<a href="#l41.146"></a><span id="l41.146">     }</span>
<a href="#l41.147"></a><span id="l41.147" class="difflineplus">+    else if (ims.injectMechanism == INJECT_IMAP_FAKE_SERVER) {</span>
<a href="#l41.148"></a><span id="l41.148" class="difflineplus">+      // Pull in the IMAP fake server code</span>
<a href="#l41.149"></a><span id="l41.149" class="difflineplus">+      load(&quot;../../test_imap/unit/head_server.js&quot;);</span>
<a href="#l41.150"></a><span id="l41.150" class="difflineplus">+</span>
<a href="#l41.151"></a><span id="l41.151" class="difflineplus">+      // set up IMAP fakeserver and incoming server</span>
<a href="#l41.152"></a><span id="l41.152" class="difflineplus">+      ims.daemon = new imapDaemon();</span>
<a href="#l41.153"></a><span id="l41.153" class="difflineplus">+      ims.server = makeServer(ims.daemon, &quot;&quot;);</span>
<a href="#l41.154"></a><span id="l41.154" class="difflineplus">+      ims.incomingServer = createLocalIMAPServer();</span>
<a href="#l41.155"></a><span id="l41.155" class="difflineplus">+      // we need a local account for the IMAP server to have its sent messages in</span>
<a href="#l41.156"></a><span id="l41.156" class="difflineplus">+      loadLocalMailAccount();</span>
<a href="#l41.157"></a><span id="l41.157" class="difflineplus">+</span>
<a href="#l41.158"></a><span id="l41.158" class="difflineplus">+      // We need an identity so that updateFolder doesn't fail</span>
<a href="#l41.159"></a><span id="l41.159" class="difflineplus">+      let acctMgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l41.160"></a><span id="l41.160" class="difflineplus">+                      .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l41.161"></a><span id="l41.161" class="difflineplus">+      let localAccount = acctMgr.createAccount();</span>
<a href="#l41.162"></a><span id="l41.162" class="difflineplus">+      let identity = acctMgr.createIdentity();</span>
<a href="#l41.163"></a><span id="l41.163" class="difflineplus">+      localAccount.addIdentity(identity);</span>
<a href="#l41.164"></a><span id="l41.164" class="difflineplus">+      localAccount.defaultIdentity = identity;</span>
<a href="#l41.165"></a><span id="l41.165" class="difflineplus">+      localAccount.incomingServer = gLocalIncomingServer;</span>
<a href="#l41.166"></a><span id="l41.166" class="difflineplus">+      acctMgr.defaultAccount = localAccount;</span>
<a href="#l41.167"></a><span id="l41.167" class="difflineplus">+</span>
<a href="#l41.168"></a><span id="l41.168" class="difflineplus">+      // Let's also have another account, using the same identity</span>
<a href="#l41.169"></a><span id="l41.169" class="difflineplus">+      let imapAccount = acctMgr.createAccount();</span>
<a href="#l41.170"></a><span id="l41.170" class="difflineplus">+      imapAccount.addIdentity(identity);</span>
<a href="#l41.171"></a><span id="l41.171" class="difflineplus">+      imapAccount.defaultIdentity = identity;</span>
<a href="#l41.172"></a><span id="l41.172" class="difflineplus">+      imapAccount.incomingServer = ims.incomingServer;</span>
<a href="#l41.173"></a><span id="l41.173" class="difflineplus">+</span>
<a href="#l41.174"></a><span id="l41.174" class="difflineplus">+      // The server doesn't support more than one connection</span>
<a href="#l41.175"></a><span id="l41.175" class="difflineplus">+      prefSvc.setIntPref(&quot;mail.server.server1.max_cached_connections&quot;, 1);</span>
<a href="#l41.176"></a><span id="l41.176" class="difflineplus">+      // We aren't interested in downloading messages automatically</span>
<a href="#l41.177"></a><span id="l41.177" class="difflineplus">+      prefSvc.setBoolPref(&quot;mail.server.server1.download_on_biff&quot;, false);</span>
<a href="#l41.178"></a><span id="l41.178" class="difflineplus">+</span>
<a href="#l41.179"></a><span id="l41.179" class="difflineplus">+      // Set the inbox to not be offline</span>
<a href="#l41.180"></a><span id="l41.180" class="difflineplus">+      ims.imapInbox = ims.incomingServer.rootFolder.getChildNamed(&quot;Inbox&quot;);</span>
<a href="#l41.181"></a><span id="l41.181" class="difflineplus">+      ims.imapInbox.flags &amp;= ~Ci.nsMsgFolderFlags.Offline;</span>
<a href="#l41.182"></a><span id="l41.182" class="difflineplus">+    }</span>
<a href="#l41.183"></a><span id="l41.183"> </span>
<a href="#l41.184"></a><span id="l41.184">     ims.inited = true;</span>
<a href="#l41.185"></a><span id="l41.185">   }</span>
<a href="#l41.186"></a><span id="l41.186"> }</span>
<a href="#l41.187"></a><span id="l41.187"> </span>
<a href="#l41.188"></a><span id="l41.188"> /**</span>
<a href="#l41.189"></a><span id="l41.189">  * Have gloda index the given synthetic messages, calling the verifier function</span>
<a href="#l41.190"></a><span id="l41.190">  *  (with accumulator field) once the message has been succesfully indexed.</span>
<a href="#l41.191"></a><span id="l41.191" class="difflineat">@@ -307,26 +355,21 @@ function imsInit() {</span>
<a href="#l41.192"></a><span id="l41.192">  *     indexed message), and aPreviousResult (the value last returned by the</span>
<a href="#l41.193"></a><span id="l41.193">  *     verifier function for this given set of messages, or undefined if it is</span>
<a href="#l41.194"></a><span id="l41.194">  *     the first message.)</span>
<a href="#l41.195"></a><span id="l41.195">  * @param aOnDone The function to call when we complete processing this set of</span>
<a href="#l41.196"></a><span id="l41.196">  *     messages.</span>
<a href="#l41.197"></a><span id="l41.197">  */</span>
<a href="#l41.198"></a><span id="l41.198"> function indexMessages(aSynthMessages, aVerifier, aOnDone) {</span>
<a href="#l41.199"></a><span id="l41.199">   let ims = indexMessageState;</span>
<a href="#l41.200"></a><span id="l41.200" class="difflineminus">-</span>
<a href="#l41.201"></a><span id="l41.201" class="difflineminus">-  ims.inputMessages = aSynthMessages;</span>
<a href="#l41.202"></a><span id="l41.202" class="difflineminus">-  ims.glodaMessages = [];</span>
<a href="#l41.203"></a><span id="l41.203" class="difflineminus">-  ims.verifier = aVerifier;</span>
<a href="#l41.204"></a><span id="l41.204" class="difflineminus">-  ims.previousValue = undefined;</span>
<a href="#l41.205"></a><span id="l41.205" class="difflineminus">-  ims.onDone = aOnDone;</span>
<a href="#l41.206"></a><span id="l41.206" class="difflineplus">+  ims.expectMessages(aSynthMessages, aVerifier, aOnDone);</span>
<a href="#l41.207"></a><span id="l41.207"> </span>
<a href="#l41.208"></a><span id="l41.208">   if (ims.injectMechanism == INJECT_FAKE_SERVER) {</span>
<a href="#l41.209"></a><span id="l41.209">     ims.daemon.setMessages(_synthMessagesToFakeRep(aSynthMessages));</span>
<a href="#l41.210"></a><span id="l41.210" class="difflineminus">-    do_timeout(0, &quot;driveFakeServer();&quot;);</span>
<a href="#l41.211"></a><span id="l41.211" class="difflineplus">+    do_timeout(0, &quot;drivePOP3FakeServer();&quot;);</span>
<a href="#l41.212"></a><span id="l41.212">   }</span>
<a href="#l41.213"></a><span id="l41.213">   else if (ims.injectMechanism == INJECT_MBOX) {</span>
<a href="#l41.214"></a><span id="l41.214">     ims.mboxName = &quot;injecty&quot; + ims.nextMboxNumber++;</span>
<a href="#l41.215"></a><span id="l41.215">     writeMessagesToMbox(aSynthMessages, gProfileDir,</span>
<a href="#l41.216"></a><span id="l41.216">                         &quot;Mail&quot;, &quot;Local Folders&quot;, ims.mboxName);</span>
<a href="#l41.217"></a><span id="l41.217"> </span>
<a href="#l41.218"></a><span id="l41.218">     let rootFolder = gLocalIncomingServer.rootMsgFolder;</span>
<a href="#l41.219"></a><span id="l41.219">     let subFolder = rootFolder.addSubfolder(ims.mboxName);</span>
<a href="#l41.220"></a><span id="l41.220" class="difflineat">@@ -339,57 +382,101 @@ function indexMessages(aSynthMessages, a</span>
<a href="#l41.221"></a><span id="l41.221">     });</span>
<a href="#l41.222"></a><span id="l41.222">   }</span>
<a href="#l41.223"></a><span id="l41.223">   else if (ims.injectMechanism == INJECT_ADDMESSAGE) {</span>
<a href="#l41.224"></a><span id="l41.224">     let localFolder = gLocalInboxFolder.QueryInterface(Ci.nsIMsgLocalMailFolder);</span>
<a href="#l41.225"></a><span id="l41.225">     for (let [, msg] in Iterator(aSynthMessages)) {</span>
<a href="#l41.226"></a><span id="l41.226">       localFolder.addMessage(msg.toMboxString());</span>
<a href="#l41.227"></a><span id="l41.227">     }</span>
<a href="#l41.228"></a><span id="l41.228">   }</span>
<a href="#l41.229"></a><span id="l41.229" class="difflineplus">+  else if (ims.injectMechanism == INJECT_IMAP_FAKE_SERVER) {</span>
<a href="#l41.230"></a><span id="l41.230" class="difflineplus">+    let ioService = Cc[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l41.231"></a><span id="l41.231" class="difflineplus">+                      .getService(Ci.nsIIOService);</span>
<a href="#l41.232"></a><span id="l41.232" class="difflineplus">+    let serverInbox = ims.daemon.getMailbox(&quot;INBOX&quot;);</span>
<a href="#l41.233"></a><span id="l41.233"> </span>
<a href="#l41.234"></a><span id="l41.234" class="difflineplus">+    for (let [, msg] in Iterator(aSynthMessages)) {</span>
<a href="#l41.235"></a><span id="l41.235" class="difflineplus">+      // Generate a URI out of the message</span>
<a href="#l41.236"></a><span id="l41.236" class="difflineplus">+      let URI = ioService.newURI(&quot;data:text/plain;base64,&quot; + btoa(msg.toMessageString()), null, null);</span>
<a href="#l41.237"></a><span id="l41.237" class="difflineplus">+      // Add it to the server</span>
<a href="#l41.238"></a><span id="l41.238" class="difflineplus">+      serverInbox.addMessage(new imapMessage(URI.spec, serverInbox.uidnext++, []));</span>
<a href="#l41.239"></a><span id="l41.239" class="difflineplus">+    }</span>
<a href="#l41.240"></a><span id="l41.240" class="difflineplus">+    // Time to do stuff with the fakeserver</span>
<a href="#l41.241"></a><span id="l41.241" class="difflineplus">+    driveIMAPFakeServer();</span>
<a href="#l41.242"></a><span id="l41.242" class="difflineplus">+  }</span>
<a href="#l41.243"></a><span id="l41.243"> }</span>
<a href="#l41.244"></a><span id="l41.244"> </span>
<a href="#l41.245"></a><span id="l41.245"> function injectMessagesUsing(aInjectMechanism) {</span>
<a href="#l41.246"></a><span id="l41.246">   indexMessageState.injectMechanism = aInjectMechanism;</span>
<a href="#l41.247"></a><span id="l41.247"> }</span>
<a href="#l41.248"></a><span id="l41.248"> </span>
<a href="#l41.249"></a><span id="l41.249"> var indexMessageState = {</span>
<a href="#l41.250"></a><span id="l41.250">   /** have we been initialized (hooked listeners, etc.) */</span>
<a href="#l41.251"></a><span id="l41.251">   inited: false,</span>
<a href="#l41.252"></a><span id="l41.252" class="difflineplus">+  /** whether we're due for any index notifications */</span>
<a href="#l41.253"></a><span id="l41.253" class="difflineplus">+  expectingIndexNotifications: false,</span>
<a href="#l41.254"></a><span id="l41.254">   /** our catch-all message collection that nets us all messages passing by */</span>
<a href="#l41.255"></a><span id="l41.255">   catchAllCollection: null,</span>
<a href="#l41.256"></a><span id="l41.256">   /** the set of synthetic messages passed in to indexMessages */</span>
<a href="#l41.257"></a><span id="l41.257">   inputMessages: null,</span>
<a href="#l41.258"></a><span id="l41.258">   /** the gloda messages resulting from indexing corresponding to input ones */</span>
<a href="#l41.259"></a><span id="l41.259">   glodaMessages: null,</span>
<a href="#l41.260"></a><span id="l41.260">   /** the user-specified accumulate-style verification func */</span>
<a href="#l41.261"></a><span id="l41.261">   verifier: null,</span>
<a href="#l41.262"></a><span id="l41.262">   /** the result of the last call to the verification function */</span>
<a href="#l41.263"></a><span id="l41.263">   previousValue: undefined,</span>
<a href="#l41.264"></a><span id="l41.264">   /** the function to call once we have indexed all the messages */</span>
<a href="#l41.265"></a><span id="l41.265">   onDone: null,</span>
<a href="#l41.266"></a><span id="l41.266"> </span>
<a href="#l41.267"></a><span id="l41.267">   injectMechanism: INJECT_ADDMESSAGE,</span>
<a href="#l41.268"></a><span id="l41.268"> </span>
<a href="#l41.269"></a><span id="l41.269">   /* === Fake Server State === */</span>
<a href="#l41.270"></a><span id="l41.270" class="difflineminus">-  /** nsMailServer instance with POP3_RFC1939 handler */</span>
<a href="#l41.271"></a><span id="l41.271" class="difflineplus">+  /** nsMailServer instance (if POP3, with POP3_RFC1939 handler) */</span>
<a href="#l41.272"></a><span id="l41.272">   server: null,</span>
<a href="#l41.273"></a><span id="l41.273">   serverStarted: false,</span>
<a href="#l41.274"></a><span id="l41.274" class="difflineminus">-  /** pop3Daemon instance */</span>
<a href="#l41.275"></a><span id="l41.275" class="difflineplus">+  /** pop3Daemon/imapDaemon instance */</span>
<a href="#l41.276"></a><span id="l41.276">   daemon: null,</span>
<a href="#l41.277"></a><span id="l41.277" class="difflineminus">-  /** incoming pop3 server */</span>
<a href="#l41.278"></a><span id="l41.278" class="difflineplus">+  /** incoming pop3/imap server */</span>
<a href="#l41.279"></a><span id="l41.279">   incomingServer: null,</span>
<a href="#l41.280"></a><span id="l41.280" class="difflineminus">-  /** pop3 service */</span>
<a href="#l41.281"></a><span id="l41.281" class="difflineplus">+  /** pop3 service (not used for imap) */</span>
<a href="#l41.282"></a><span id="l41.282">   pop3Service: null,</span>
<a href="#l41.283"></a><span id="l41.283" class="difflineplus">+  /** IMAP inbox */</span>
<a href="#l41.284"></a><span id="l41.284" class="difflineplus">+  imapInbox: null,</span>
<a href="#l41.285"></a><span id="l41.285"> </span>
<a href="#l41.286"></a><span id="l41.286">   /* === MBox Injection State === */</span>
<a href="#l41.287"></a><span id="l41.287">   nextMboxNumber: 0,</span>
<a href="#l41.288"></a><span id="l41.288">   mboxName: null,</span>
<a href="#l41.289"></a><span id="l41.289"> </span>
<a href="#l41.290"></a><span id="l41.290">   /**</span>
<a href="#l41.291"></a><span id="l41.291" class="difflineplus">+   * Sets up messages to expect index notifications for.</span>
<a href="#l41.292"></a><span id="l41.292" class="difflineplus">+   *</span>
<a href="#l41.293"></a><span id="l41.293" class="difflineplus">+   * @param aSynthMessages The synthetic messages to expect notifications</span>
<a href="#l41.294"></a><span id="l41.294" class="difflineplus">+   *     for. We currently don't do anything with these other than count them,</span>
<a href="#l41.295"></a><span id="l41.295" class="difflineplus">+   *     so pass whatever you want and it will be the 'source message' (1st</span>
<a href="#l41.296"></a><span id="l41.296" class="difflineplus">+   *     argument) to your verifier function.</span>
<a href="#l41.297"></a><span id="l41.297" class="difflineplus">+   * @param aVerifier The function to call to verify that the indexing had the</span>
<a href="#l41.298"></a><span id="l41.298" class="difflineplus">+   *     desired result.  Takes arguments aSynthMessage (the synthetic message</span>
<a href="#l41.299"></a><span id="l41.299" class="difflineplus">+   *     just indexed), aGlodaMessage (the gloda message representation of the</span>
<a href="#l41.300"></a><span id="l41.300" class="difflineplus">+   *     indexed message), and aPreviousResult (the value last returned by the</span>
<a href="#l41.301"></a><span id="l41.301" class="difflineplus">+   *     verifier function for this given set of messages, or undefined if it is</span>
<a href="#l41.302"></a><span id="l41.302" class="difflineplus">+   *     the first message.)</span>
<a href="#l41.303"></a><span id="l41.303" class="difflineplus">+   * @param aOnDone The function to call when we complete processing this set of</span>
<a href="#l41.304"></a><span id="l41.304" class="difflineplus">+   *     messages.</span>
<a href="#l41.305"></a><span id="l41.305" class="difflineplus">+   */</span>
<a href="#l41.306"></a><span id="l41.306" class="difflineplus">+  expectMessages: function indexMessageState_expectMessages(aSynthMessages, aVerifier,</span>
<a href="#l41.307"></a><span id="l41.307" class="difflineplus">+                                                            aOnDone) {</span>
<a href="#l41.308"></a><span id="l41.308" class="difflineplus">+    dump(&quot;^^^ setting up &quot; + aSynthMessages.length + &quot; message(s) to expect\n&quot;);</span>
<a href="#l41.309"></a><span id="l41.309" class="difflineplus">+    this.inputMessages = aSynthMessages;</span>
<a href="#l41.310"></a><span id="l41.310" class="difflineplus">+    this.expectingIndexNotifications = true;</span>
<a href="#l41.311"></a><span id="l41.311" class="difflineplus">+    this.glodaMessages = [];</span>
<a href="#l41.312"></a><span id="l41.312" class="difflineplus">+    this.verifier = aVerifier;</span>
<a href="#l41.313"></a><span id="l41.313" class="difflineplus">+    this.previousValue = undefined;</span>
<a href="#l41.314"></a><span id="l41.314" class="difflineplus">+    this.onDone = aOnDone;</span>
<a href="#l41.315"></a><span id="l41.315" class="difflineplus">+  },</span>
<a href="#l41.316"></a><span id="l41.316" class="difflineplus">+</span>
<a href="#l41.317"></a><span id="l41.317" class="difflineplus">+  /**</span>
<a href="#l41.318"></a><span id="l41.318">    * Listener to handle the completion of the POP3 message retrieval (one way or</span>
<a href="#l41.319"></a><span id="l41.319">    *  the other.)</span>
<a href="#l41.320"></a><span id="l41.320">    */</span>
<a href="#l41.321"></a><span id="l41.321">   urlListener: {</span>
<a href="#l41.322"></a><span id="l41.322">     OnStartRunningUrl: function (url) {</span>
<a href="#l41.323"></a><span id="l41.323">     },</span>
<a href="#l41.324"></a><span id="l41.324">     OnStopRunningUrl: function (url, result) {</span>
<a href="#l41.325"></a><span id="l41.325">       let ims = indexMessageState;</span>
<a href="#l41.326"></a><span id="l41.326" class="difflineat">@@ -413,48 +500,22 @@ var indexMessageState = {</span>
<a href="#l41.327"></a><span id="l41.327"> </span>
<a href="#l41.328"></a><span id="l41.328">       // we are expecting the gloda indexer to receive some notification as the</span>
<a href="#l41.329"></a><span id="l41.329">       //  result of the new messages showing up, so we don't actually need to</span>
<a href="#l41.330"></a><span id="l41.330">       //  do anything here.</span>
<a href="#l41.331"></a><span id="l41.331">     }</span>
<a href="#l41.332"></a><span id="l41.332">   }</span>
<a href="#l41.333"></a><span id="l41.333"> };</span>
<a href="#l41.334"></a><span id="l41.334"> </span>
<a href="#l41.335"></a><span id="l41.335" class="difflineminus">-</span>
<a href="#l41.336"></a><span id="l41.336"> /**</span>
<a href="#l41.337"></a><span id="l41.337" class="difflineminus">- * Indicate that we should expect some modified messages to be indexed.</span>
<a href="#l41.338"></a><span id="l41.338" class="difflineminus">- *</span>
<a href="#l41.339"></a><span id="l41.339" class="difflineminus">- * @param aMessages The messages that will be modified and we should expect</span>
<a href="#l41.340"></a><span id="l41.340" class="difflineminus">- *   notifications about.  We currently don't do anything with these other than</span>
<a href="#l41.341"></a><span id="l41.341" class="difflineminus">- *   count them, so pass whatever you want and it will be the 'source message'</span>
<a href="#l41.342"></a><span id="l41.342" class="difflineminus">- *   (1st argument) to your verifier function.</span>
<a href="#l41.343"></a><span id="l41.343" class="difflineminus">- * @param aVerifier See indexMessage's aVerifier argument.</span>
<a href="#l41.344"></a><span id="l41.344" class="difflineminus">- * @param aDone The (optional) callback to call on completion.</span>
<a href="#l41.345"></a><span id="l41.345" class="difflineplus">+ * Perform POP3 mail fetching, seeing it through to completion.</span>
<a href="#l41.346"></a><span id="l41.346">  */</span>
<a href="#l41.347"></a><span id="l41.347" class="difflineminus">-function expectModifiedMessages(aMessages, aVerifier, aOnDone) {</span>
<a href="#l41.348"></a><span id="l41.348" class="difflineplus">+function drivePOP3FakeServer() {</span>
<a href="#l41.349"></a><span id="l41.349">   let ims = indexMessageState;</span>
<a href="#l41.350"></a><span id="l41.350" class="difflineminus">-</span>
<a href="#l41.351"></a><span id="l41.351" class="difflineminus">-  ims.inputMessages = aMessages;</span>
<a href="#l41.352"></a><span id="l41.352" class="difflineminus">-  ims.glodaMessages = [];</span>
<a href="#l41.353"></a><span id="l41.353" class="difflineminus">-  ims.verifier = aVerifier;</span>
<a href="#l41.354"></a><span id="l41.354" class="difflineminus">-  ims.previousValue = undefined;</span>
<a href="#l41.355"></a><span id="l41.355" class="difflineminus">-  ims.onDone = aOnDone;</span>
<a href="#l41.356"></a><span id="l41.356" class="difflineminus">-</span>
<a href="#l41.357"></a><span id="l41.357" class="difflineminus">-  // we don't actually need to do anything.  the caller is going to be</span>
<a href="#l41.358"></a><span id="l41.358" class="difflineminus">-  //  triggering a notification which will spur the indexer into action.  the</span>
<a href="#l41.359"></a><span id="l41.359" class="difflineminus">-  //  indexer uses its own scheduling mechanism to drive itself, so as long</span>
<a href="#l41.360"></a><span id="l41.360" class="difflineminus">-  //  as an event loop is active, we're good.</span>
<a href="#l41.361"></a><span id="l41.361" class="difflineminus">-}</span>
<a href="#l41.362"></a><span id="l41.362" class="difflineminus">-</span>
<a href="#l41.363"></a><span id="l41.363" class="difflineminus">-/**</span>
<a href="#l41.364"></a><span id="l41.364" class="difflineminus">- * Perform the mail fetching, seeing it through to completion.</span>
<a href="#l41.365"></a><span id="l41.365" class="difflineminus">- */</span>
<a href="#l41.366"></a><span id="l41.366" class="difflineminus">-function driveFakeServer() {</span>
<a href="#l41.367"></a><span id="l41.367" class="difflineminus">-  let ims = indexMessageState;</span>
<a href="#l41.368"></a><span id="l41.368" class="difflineminus">-dump(&quot;&gt;&gt;&gt; enter driveFakeServer\n&quot;);</span>
<a href="#l41.369"></a><span id="l41.369" class="difflineplus">+dump(&quot;&gt;&gt;&gt; enter drivePOP3FakeServer\n&quot;);</span>
<a href="#l41.370"></a><span id="l41.370">   // Handle the server in a try/catch/finally loop so that we always will stop</span>
<a href="#l41.371"></a><span id="l41.371">   // the server if something fails.</span>
<a href="#l41.372"></a><span id="l41.372">   try {</span>
<a href="#l41.373"></a><span id="l41.373">     if (!(ims.serverStarted)) {</span>
<a href="#l41.374"></a><span id="l41.374">       dump(&quot;  starting fake server\n&quot;);</span>
<a href="#l41.375"></a><span id="l41.375">       ims.server.start(POP3_PORT);</span>
<a href="#l41.376"></a><span id="l41.376">       ims.serverStarted = true;</span>
<a href="#l41.377"></a><span id="l41.377">     }</span>
<a href="#l41.378"></a><span id="l41.378" class="difflineat">@@ -475,35 +536,70 @@ dump(&quot;&gt;&gt;&gt; enter driveFakeServer\n&quot;);</span>
<a href="#l41.379"></a><span id="l41.379">     do_throw(e);</span>
<a href="#l41.380"></a><span id="l41.380">   }</span>
<a href="#l41.381"></a><span id="l41.381">   finally {</span>
<a href="#l41.382"></a><span id="l41.382">     dump(&quot;  draining events\n&quot;);</span>
<a href="#l41.383"></a><span id="l41.383">     var thread = gThreadManager.currentThread;</span>
<a href="#l41.384"></a><span id="l41.384">     while (thread.hasPendingEvents())</span>
<a href="#l41.385"></a><span id="l41.385">       thread.processNextEvent(true);</span>
<a href="#l41.386"></a><span id="l41.386">   }</span>
<a href="#l41.387"></a><span id="l41.387" class="difflineminus">-dump(&quot;&lt;&lt;&lt; exit driveFakeServer\n&quot;);</span>
<a href="#l41.388"></a><span id="l41.388" class="difflineplus">+dump(&quot;&lt;&lt;&lt; exit drivePOP3FakeServer\n&quot;);</span>
<a href="#l41.389"></a><span id="l41.389"> }</span>
<a href="#l41.390"></a><span id="l41.390"> </span>
<a href="#l41.391"></a><span id="l41.391"> /**</span>
<a href="#l41.392"></a><span id="l41.392" class="difflineplus">+ * Perform an IMAP mail fetch, seeing it through to completion</span>
<a href="#l41.393"></a><span id="l41.393" class="difflineplus">+ */</span>
<a href="#l41.394"></a><span id="l41.394" class="difflineplus">+function driveIMAPFakeServer() {</span>
<a href="#l41.395"></a><span id="l41.395" class="difflineplus">+  dump(&quot;&gt;&gt;&gt; enter driveIMAPFakeServer\n&quot;);</span>
<a href="#l41.396"></a><span id="l41.396" class="difflineplus">+  let ims = indexMessageState;</span>
<a href="#l41.397"></a><span id="l41.397" class="difflineplus">+  // Handle the server in a try/catch/finally loop so that we always will stop</span>
<a href="#l41.398"></a><span id="l41.398" class="difflineplus">+  // the server if something fails.</span>
<a href="#l41.399"></a><span id="l41.399" class="difflineplus">+  try {</span>
<a href="#l41.400"></a><span id="l41.400" class="difflineplus">+    dump(&quot;  resetting fake server\n&quot;);</span>
<a href="#l41.401"></a><span id="l41.401" class="difflineplus">+    ims.server.resetTest();</span>
<a href="#l41.402"></a><span id="l41.402" class="difflineplus">+</span>
<a href="#l41.403"></a><span id="l41.403" class="difflineplus">+    // Update the inbox</span>
<a href="#l41.404"></a><span id="l41.404" class="difflineplus">+    dump(&quot;  issuing updateFolder\n&quot;);</span>
<a href="#l41.405"></a><span id="l41.405" class="difflineplus">+    ims.imapInbox.updateFolder(null);</span>
<a href="#l41.406"></a><span id="l41.406" class="difflineplus">+    // performTest won't work here because that seemingly blocks until the</span>
<a href="#l41.407"></a><span id="l41.407" class="difflineplus">+    // socket is closed, which is something undesirable here</span>
<a href="#l41.408"></a><span id="l41.408" class="difflineplus">+  }</span>
<a href="#l41.409"></a><span id="l41.409" class="difflineplus">+  catch (e) {</span>
<a href="#l41.410"></a><span id="l41.410" class="difflineplus">+    ims.server.stop();</span>
<a href="#l41.411"></a><span id="l41.411" class="difflineplus">+    do_throw(e);</span>
<a href="#l41.412"></a><span id="l41.412" class="difflineplus">+  }</span>
<a href="#l41.413"></a><span id="l41.413" class="difflineplus">+  finally {</span>
<a href="#l41.414"></a><span id="l41.414" class="difflineplus">+    dump(&quot;  draining events\n&quot;);</span>
<a href="#l41.415"></a><span id="l41.415" class="difflineplus">+    let thread = gThreadManager.currentThread;</span>
<a href="#l41.416"></a><span id="l41.416" class="difflineplus">+    while (thread.hasPendingEvents())</span>
<a href="#l41.417"></a><span id="l41.417" class="difflineplus">+      thread.processNextEvent(true);</span>
<a href="#l41.418"></a><span id="l41.418" class="difflineplus">+  }</span>
<a href="#l41.419"></a><span id="l41.419" class="difflineplus">+  dump(&quot;&lt;&lt;&lt; exit driveIMAPFakeServer\n&quot;);</span>
<a href="#l41.420"></a><span id="l41.420" class="difflineplus">+}</span>
<a href="#l41.421"></a><span id="l41.421" class="difflineplus">+</span>
<a href="#l41.422"></a><span id="l41.422" class="difflineplus">+</span>
<a href="#l41.423"></a><span id="l41.423" class="difflineplus">+/**</span>
<a href="#l41.424"></a><span id="l41.424">  * Tear down the fake server.  This is very important to avoid things getting</span>
<a href="#l41.425"></a><span id="l41.425">  *  upset during shutdown.  (Namely, XPConnect will get mad about running in</span>
<a href="#l41.426"></a><span id="l41.426">  *  a context without &quot;Components&quot; defined.)</span>
<a href="#l41.427"></a><span id="l41.427">  */</span>
<a href="#l41.428"></a><span id="l41.428"> function killFakeServer() {</span>
<a href="#l41.429"></a><span id="l41.429" class="difflineplus">+  dump(&quot;Killing fake server\n&quot;);</span>
<a href="#l41.430"></a><span id="l41.430">   let ims = indexMessageState;</span>
<a href="#l41.431"></a><span id="l41.431"> </span>
<a href="#l41.432"></a><span id="l41.432">   ims.incomingServer.closeCachedConnections();</span>
<a href="#l41.433"></a><span id="l41.433"> </span>
<a href="#l41.434"></a><span id="l41.434">   // No more tests, let everything finish</span>
<a href="#l41.435"></a><span id="l41.435">   ims.server.stop();</span>
<a href="#l41.436"></a><span id="l41.436"> </span>
<a href="#l41.437"></a><span id="l41.437">   var thread = gThreadManager.currentThread;</span>
<a href="#l41.438"></a><span id="l41.438">   while (thread.hasPendingEvents())</span>
<a href="#l41.439"></a><span id="l41.439">     thread.processNextEvent(true);</span>
<a href="#l41.440"></a><span id="l41.440" class="difflineplus">+</span>
<a href="#l41.441"></a><span id="l41.441" class="difflineplus">+  do_test_finished();</span>
<a href="#l41.442"></a><span id="l41.442"> }</span>
<a href="#l41.443"></a><span id="l41.443"> </span>
<a href="#l41.444"></a><span id="l41.444"> /**</span>
<a href="#l41.445"></a><span id="l41.445">  * Our catch-all collection listener.  Any time a new message gets indexed,</span>
<a href="#l41.446"></a><span id="l41.446">  *  we should receive an onItemsAdded call.  Any time an existing message</span>
<a href="#l41.447"></a><span id="l41.447">  *  gets reindexed, we should receive an onItemsModified call.  Any time an</span>
<a href="#l41.448"></a><span id="l41.448">  *  existing message actually gets purged from the system, we should receive</span>
<a href="#l41.449"></a><span id="l41.449">  *  an onItemsRemoved call.</span>
<a href="#l41.450"></a><span id="l41.450" class="difflineat">@@ -544,47 +640,65 @@ function runOnIndexingComplete(aCallback</span>
<a href="#l41.451"></a><span id="l41.451">  * Gloda indexer listener, used to know when all active indexing jobs have</span>
<a href="#l41.452"></a><span id="l41.452">  *  completed so that we can try and process all the things that should have</span>
<a href="#l41.453"></a><span id="l41.453">  *  been processed.</span>
<a href="#l41.454"></a><span id="l41.454">  */</span>
<a href="#l41.455"></a><span id="l41.455"> var messageIndexerListener = {</span>
<a href="#l41.456"></a><span id="l41.456">   callbackOnDone: null,</span>
<a href="#l41.457"></a><span id="l41.457">   onIndexNotification: function(aStatus, aPrettyName, aJobIndex, aJobTotal,</span>
<a href="#l41.458"></a><span id="l41.458">                                 aJobItemIndex, aJobItemGoal) {</span>
<a href="#l41.459"></a><span id="l41.459" class="difflineplus">+    dump(&quot;((( Index listener notified! aStatus = &quot; + aStatus + &quot;\n&quot;);</span>
<a href="#l41.460"></a><span id="l41.460" class="difflineplus">+    // Ignore moving/removing notifications</span>
<a href="#l41.461"></a><span id="l41.461" class="difflineplus">+    if (aStatus == Gloda.kIndexerMoving || aStatus == Gloda.kIndexerRemoving)</span>
<a href="#l41.462"></a><span id="l41.462" class="difflineplus">+      return;</span>
<a href="#l41.463"></a><span id="l41.463" class="difflineplus">+</span>
<a href="#l41.464"></a><span id="l41.464" class="difflineplus">+    let ims = indexMessageState;</span>
<a href="#l41.465"></a><span id="l41.465" class="difflineplus">+    // If we shouldn't be receiving notifications and we receive one with aStatus</span>
<a href="#l41.466"></a><span id="l41.466" class="difflineplus">+    // != kIndexerIdle. throw.</span>
<a href="#l41.467"></a><span id="l41.467" class="difflineplus">+    if (!ims.expectingIndexNotifications) {</span>
<a href="#l41.468"></a><span id="l41.468" class="difflineplus">+      if (aStatus == Gloda.kIndexerIdle) {</span>
<a href="#l41.469"></a><span id="l41.469" class="difflineplus">+        dump(&quot;((( Ignoring indexing notification since it's just kIndexerIdle.\n&quot;);</span>
<a href="#l41.470"></a><span id="l41.470" class="difflineplus">+        return;</span>
<a href="#l41.471"></a><span id="l41.471" class="difflineplus">+      }</span>
<a href="#l41.472"></a><span id="l41.472" class="difflineplus">+      else {</span>
<a href="#l41.473"></a><span id="l41.473" class="difflineplus">+        do_throw(&quot;Exception during index notification -- we weren't &quot; +</span>
<a href="#l41.474"></a><span id="l41.474" class="difflineplus">+                 &quot;expecting one.&quot;);</span>
<a href="#l41.475"></a><span id="l41.475" class="difflineplus">+      }</span>
<a href="#l41.476"></a><span id="l41.476" class="difflineplus">+    }</span>
<a href="#l41.477"></a><span id="l41.477" class="difflineplus">+</span>
<a href="#l41.478"></a><span id="l41.478">     // we only care if indexing has just completed...</span>
<a href="#l41.479"></a><span id="l41.479" class="difflineminus">-    if (!GlodaIndexer.indexing) {</span>
<a href="#l41.480"></a><span id="l41.480" class="difflineplus">+    if (aStatus == Gloda.kIndexerIdle) {</span>
<a href="#l41.481"></a><span id="l41.481">       if (messageIndexerListener.callbackOnDone) {</span>
<a href="#l41.482"></a><span id="l41.482">         let callback = messageIndexerListener.callbackOnDone;</span>
<a href="#l41.483"></a><span id="l41.483">         messageIndexerListener.callbackOnDone = null;</span>
<a href="#l41.484"></a><span id="l41.484">         callback();</span>
<a href="#l41.485"></a><span id="l41.485">       }</span>
<a href="#l41.486"></a><span id="l41.486"> </span>
<a href="#l41.487"></a><span id="l41.487" class="difflineminus">-      let ims = indexMessageState;</span>
<a href="#l41.488"></a><span id="l41.488" class="difflineminus">-</span>
<a href="#l41.489"></a><span id="l41.489" class="difflineminus">-      // this is just the synthetic notification if inputMessages is null</span>
<a href="#l41.490"></a><span id="l41.490" class="difflineminus">-      if (ims.inputMessages === null) {</span>
<a href="#l41.491"></a><span id="l41.491" class="difflineminus">-        dump(&quot;((( ignoring indexing notification, assuming synthetic &quot; +</span>
<a href="#l41.492"></a><span id="l41.492" class="difflineminus">-             &quot;notification.\n&quot;);</span>
<a href="#l41.493"></a><span id="l41.493" class="difflineminus">-        return;</span>
<a href="#l41.494"></a><span id="l41.494" class="difflineminus">-      }</span>
<a href="#l41.495"></a><span id="l41.495" class="difflineminus">-</span>
<a href="#l41.496"></a><span id="l41.496">       // if we haven't seen all the messages we should see, assume that the</span>
<a href="#l41.497"></a><span id="l41.497">       //  rest are on their way, and are just coming in a subsequent job...</span>
<a href="#l41.498"></a><span id="l41.498">       // (Also, the first time we register our listener, we will get a synthetic</span>
<a href="#l41.499"></a><span id="l41.499">       //  idle status; at least if the indexer is idle.)</span>
<a href="#l41.500"></a><span id="l41.500" class="difflineminus">-      if (ims.glodaMessages.length &lt; ims.inputMessages.length) {</span>
<a href="#l41.501"></a><span id="l41.501" class="difflineplus">+      let glodaLen = ims.glodaMessages.length, inputLen =</span>
<a href="#l41.502"></a><span id="l41.502" class="difflineplus">+        ims.inputMessages.length;</span>
<a href="#l41.503"></a><span id="l41.503" class="difflineplus">+      if (glodaLen &lt; inputLen) {</span>
<a href="#l41.504"></a><span id="l41.504">         dump(&quot;((( indexing is no longer indexing, but we're still expecting &quot; +</span>
<a href="#l41.505"></a><span id="l41.505" class="difflineminus">-             &quot;more results, ignoring.\n&quot;);</span>
<a href="#l41.506"></a><span id="l41.506" class="difflineplus">+             inputLen + &quot; - &quot; + glodaLen + &quot; = &quot; + (inputLen - glodaLen) +</span>
<a href="#l41.507"></a><span id="l41.507" class="difflineplus">+             &quot; more results, ignoring.\n&quot;);</span>
<a href="#l41.508"></a><span id="l41.508" class="difflineplus">+        // If we're running IMAP, then update the folder once more</span>
<a href="#l41.509"></a><span id="l41.509" class="difflineplus">+        if (ims.imapInbox)</span>
<a href="#l41.510"></a><span id="l41.510" class="difflineplus">+          ims.imapInbox.updateFolder(null);</span>
<a href="#l41.511"></a><span id="l41.511">         return;</span>
<a href="#l41.512"></a><span id="l41.512">       }</span>
<a href="#l41.513"></a><span id="l41.513"> </span>
<a href="#l41.514"></a><span id="l41.514">       dump(&quot;((( indexer notification (&quot; + ims.glodaMessages.length +</span>
<a href="#l41.515"></a><span id="l41.515">            &quot; messages) about to verify: &quot; +</span>
<a href="#l41.516"></a><span id="l41.516">            (ims.verifier ? ims.verifier.name : &quot;none&quot;) + &quot; and complete: &quot; +</span>
<a href="#l41.517"></a><span id="l41.517">            (ims.onDone ? ims.onDone.name : &quot;none&quot;) + &quot;\n&quot;);</span>
<a href="#l41.518"></a><span id="l41.518" class="difflineplus">+      // If we're verifying messages, we shouldn't be expecting them</span>
<a href="#l41.519"></a><span id="l41.519" class="difflineplus">+      ims.expectingIndexNotifications = false;</span>
<a href="#l41.520"></a><span id="l41.520"> </span>
<a href="#l41.521"></a><span id="l41.521">       // call the verifier.  (we expect them to generate an exception if the</span>
<a href="#l41.522"></a><span id="l41.522">       //  verification fails, using do_check_*/do_throw; we don't care about</span>
<a href="#l41.523"></a><span id="l41.523">       //  the return value except to propagate forward to subsequent calls.)</span>
<a href="#l41.524"></a><span id="l41.524">       for (let iMessage=0; iMessage &lt; ims.inputMessages.length; iMessage++) {</span>
<a href="#l41.525"></a><span id="l41.525">         if (ims.verifier) {</span>
<a href="#l41.526"></a><span id="l41.526">           try {</span>
<a href="#l41.527"></a><span id="l41.527">             ims.previousValue = ims.verifier(ims.inputMessages[iMessage],</span>
<a href="#l41.528"></a><span id="l41.528" class="difflineat">@@ -595,16 +709,17 @@ var messageIndexerListener = {</span>
<a href="#l41.529"></a><span id="l41.529">             do_throw(&quot;Exception during verification via &quot; + ims.verifier.name +</span>
<a href="#l41.530"></a><span id="l41.530">                 &quot; on message index: &quot; + iMessage + &quot; previous value: &quot; +</span>
<a href="#l41.531"></a><span id="l41.531">                 ims.previousValue + &quot; gloda message: &quot; +</span>
<a href="#l41.532"></a><span id="l41.532">                 ims.glodaMessages[iMessage] + &quot;\nexception: &quot; + ex);</span>
<a href="#l41.533"></a><span id="l41.533">           }</span>
<a href="#l41.534"></a><span id="l41.534">         }</span>
<a href="#l41.535"></a><span id="l41.535">       }</span>
<a href="#l41.536"></a><span id="l41.536"> </span>
<a href="#l41.537"></a><span id="l41.537" class="difflineplus">+      dump(&quot;((( Verification complete\n&quot;);</span>
<a href="#l41.538"></a><span id="l41.538">       if (ims.onDone) {</span>
<a href="#l41.539"></a><span id="l41.539">         try {</span>
<a href="#l41.540"></a><span id="l41.540">           ims.onDone();</span>
<a href="#l41.541"></a><span id="l41.541">         }</span>
<a href="#l41.542"></a><span id="l41.542">         catch (ex) {</span>
<a href="#l41.543"></a><span id="l41.543">           do_throw(&quot;Exception calling ims.onDone (&quot; + ims.onDone.name + &quot;): &quot; +</span>
<a href="#l41.544"></a><span id="l41.544">               ex);</span>
<a href="#l41.545"></a><span id="l41.545">         }</span>
<a href="#l41.546"></a><span id="l41.546" class="difflineat">@@ -765,19 +880,18 @@ function twiddleAndTest(aSynthMsg, aActi</span>
<a href="#l41.547"></a><span id="l41.547">   function twiddle_next_attr(smsg, gmsg) {</span>
<a href="#l41.548"></a><span id="l41.548">     let curTwiddling = aActionsAndTests[iTwiddling];</span>
<a href="#l41.549"></a><span id="l41.549">     let twiddleFunc = curTwiddling[0];</span>
<a href="#l41.550"></a><span id="l41.550">     let desiredState = curTwiddling[2];</span>
<a href="#l41.551"></a><span id="l41.551"> </span>
<a href="#l41.552"></a><span id="l41.552">     // the underlying nsIMsgDBHdr should exist at this point...</span>
<a href="#l41.553"></a><span id="l41.553">     do_check_neq(gmsg.folderMessage, null);</span>
<a href="#l41.554"></a><span id="l41.554">     // prepare</span>
<a href="#l41.555"></a><span id="l41.555" class="difflineminus">-    expectModifiedMessages([gmsg.folderMessage], verify_next_attr);</span>
<a href="#l41.556"></a><span id="l41.556" class="difflineplus">+    indexMessageState.expectMessages([gmsg.folderMessage], verify_next_attr);</span>
<a href="#l41.557"></a><span id="l41.557">     // tell the function to perform its mutation to the desired state</span>
<a href="#l41.558"></a><span id="l41.558" class="difflineminus">-    dump(&quot;twiddling: &quot; + twiddleFunc.name + &quot;: &quot; + desiredState + &quot;\n&quot;);</span>
<a href="#l41.559"></a><span id="l41.559">     twiddleFunc(gmsg.folderMessage, desiredState);</span>
<a href="#l41.560"></a><span id="l41.560">   }</span>
<a href="#l41.561"></a><span id="l41.561">   function verify_next_attr(smsg, gmsg) {</span>
<a href="#l41.562"></a><span id="l41.562">     let curTwiddling = aActionsAndTests[iTwiddling];</span>
<a href="#l41.563"></a><span id="l41.563">     let verifyFunc = curTwiddling[1];</span>
<a href="#l41.564"></a><span id="l41.564">     let expectedVal = curTwiddling[curTwiddling.length == 3 ? 2 : 3];</span>
<a href="#l41.565"></a><span id="l41.565">     dump(&quot;verifying: &quot; + verifyFunc.name + &quot;: &quot; + expectedVal + &quot;\n&quot;);</span>
<a href="#l41.566"></a><span id="l41.566">     verifyFunc(smsg, gmsg, expectedVal);</span>
<a href="#l41.567"></a><span id="l41.567" class="difflineat">@@ -1016,18 +1130,21 @@ function _gh_test_iterator() {</span>
<a href="#l41.568"></a><span id="l41.568">       }</span>
<a href="#l41.569"></a><span id="l41.569">     }</span>
<a href="#l41.570"></a><span id="l41.570">     else {</span>
<a href="#l41.571"></a><span id="l41.571">       dump(&quot;====== Test function: &quot; + test.name + &quot;\n&quot;);</span>
<a href="#l41.572"></a><span id="l41.572">       yield test();</span>
<a href="#l41.573"></a><span id="l41.573">     }</span>
<a href="#l41.574"></a><span id="l41.574">   }</span>
<a href="#l41.575"></a><span id="l41.575"> </span>
<a href="#l41.576"></a><span id="l41.576" class="difflineminus">-  if (indexMessageState.injectMechanism == INJECT_FAKE_SERVER) {</span>
<a href="#l41.577"></a><span id="l41.577" class="difflineminus">-    killFakeServer();</span>
<a href="#l41.578"></a><span id="l41.578" class="difflineplus">+  if (indexMessageState.injectMechanism == INJECT_FAKE_SERVER ||</span>
<a href="#l41.579"></a><span id="l41.579" class="difflineplus">+      indexMessageState.injectMechanism == INJECT_IMAP_FAKE_SERVER) {</span>
<a href="#l41.580"></a><span id="l41.580" class="difflineplus">+    do_test_pending();</span>
<a href="#l41.581"></a><span id="l41.581" class="difflineplus">+    // Give a bit of time for any remaining notifications to go through.</span>
<a href="#l41.582"></a><span id="l41.582" class="difflineplus">+    do_timeout(500, &quot;killFakeServer()&quot;);</span>
<a href="#l41.583"></a><span id="l41.583">   }</span>
<a href="#l41.584"></a><span id="l41.584"> </span>
<a href="#l41.585"></a><span id="l41.585">   do_test_finished();</span>
<a href="#l41.586"></a><span id="l41.586"> </span>
<a href="#l41.587"></a><span id="l41.587">   // once the control flow hits the root after do_test_finished, we're done,</span>
<a href="#l41.588"></a><span id="l41.588">   //  so let's just yield something to avoid callers having to deal with an</span>
<a href="#l41.589"></a><span id="l41.589">   //  exception indicating completion.</span>
<a href="#l41.590"></a><span id="l41.590">   yield null;</span>
<a href="#l41.591"></a><span id="l41.591" class="difflineat">@@ -1067,25 +1184,33 @@ function parameterizeTest(aTestFunc, aPa</span>
<a href="#l41.592"></a><span id="l41.592"> }</span>
<a href="#l41.593"></a><span id="l41.593"> </span>
<a href="#l41.594"></a><span id="l41.594"> /**</span>
<a href="#l41.595"></a><span id="l41.595">  * Test driving logic that takes a list of tests to run.  Every completed test</span>
<a href="#l41.596"></a><span id="l41.596">  *  needs to call (or cause to be called) next_test.</span>
<a href="#l41.597"></a><span id="l41.597">  *</span>
<a href="#l41.598"></a><span id="l41.598">  * @param aTests A list of test functions to call.</span>
<a href="#l41.599"></a><span id="l41.599">  * @param aLongestTestRunTimeConceivableInSecs Optional parameter</span>
<a href="#l41.600"></a><span id="l41.600" class="difflineplus">+ * @param aDontInitIMS Optional parameter. If this is specified then the index</span>
<a href="#l41.601"></a><span id="l41.601" class="difflineplus">+ *                     message state is not initialized</span>
<a href="#l41.602"></a><span id="l41.602">  */</span>
<a href="#l41.603"></a><span id="l41.603" class="difflineminus">-function glodaHelperRunTests(aTests, aLongestTestRunTimeConceivableInSecs) {</span>
<a href="#l41.604"></a><span id="l41.604" class="difflineplus">+function glodaHelperRunTests(aTests, aLongestTestRunTimeConceivableInSecs,</span>
<a href="#l41.605"></a><span id="l41.605" class="difflineplus">+                             aDontInitIMS) {</span>
<a href="#l41.606"></a><span id="l41.606">   if (aLongestTestRunTimeConceivableInSecs == null)</span>
<a href="#l41.607"></a><span id="l41.607">     aLongestTestRunTimeConceivableInSecs =</span>
<a href="#l41.608"></a><span id="l41.608">         DEFAULT_LONGEST_TEST_RUN_CONCEIVABLE_SECS;</span>
<a href="#l41.609"></a><span id="l41.609">   do_timeout(aLongestTestRunTimeConceivableInSecs * 1000,</span>
<a href="#l41.610"></a><span id="l41.610">       &quot;do_throw('Timeout running test, and we want you to have the log.');&quot;);</span>
<a href="#l41.611"></a><span id="l41.611"> </span>
<a href="#l41.612"></a><span id="l41.612" class="difflineminus">-  imsInit();</span>
<a href="#l41.613"></a><span id="l41.613" class="difflineplus">+  if (!aDontInitIMS)</span>
<a href="#l41.614"></a><span id="l41.614" class="difflineplus">+    imsInit();</span>
<a href="#l41.615"></a><span id="l41.615" class="difflineplus">+  // even if we don't want to init IMS, we want to avoid anything adaptive</span>
<a href="#l41.616"></a><span id="l41.616" class="difflineplus">+  //  happening.</span>
<a href="#l41.617"></a><span id="l41.617" class="difflineplus">+  else</span>
<a href="#l41.618"></a><span id="l41.618" class="difflineplus">+    lobotomizeAdaptiveIndexer();</span>
<a href="#l41.619"></a><span id="l41.619">   glodaHelperTests = aTests;</span>
<a href="#l41.620"></a><span id="l41.620">   glodaHelperIterator = _gh_test_iterator();</span>
<a href="#l41.621"></a><span id="l41.621">   next_test();</span>
<a href="#l41.622"></a><span id="l41.622"> }</span>
<a href="#l41.623"></a><span id="l41.623"> </span>
<a href="#l41.624"></a><span id="l41.624"> /**</span>
<a href="#l41.625"></a><span id="l41.625">  * Wipe out almost everything from the clutches of the GlodaCollectionManager.</span>
<a href="#l41.626"></a><span id="l41.626">  * By default, it is caching things and knows about all the non-GC'ed</span>
<a href="#l41.627"></a><span id="l41.627" class="difflineat">@@ -1130,8 +1255,24 @@ function nukeGlodaCachesAndCollections()</span>
<a href="#l41.628"></a><span id="l41.628">   // caches aren't intended to be cleared, but we also don't want to lose our</span>
<a href="#l41.629"></a><span id="l41.629">   //  caches, so we need to create new ones from the ashes of the old ones.</span>
<a href="#l41.630"></a><span id="l41.630">   let oldCaches = GlodaCollectionManager._cachesByNoun;</span>
<a href="#l41.631"></a><span id="l41.631">   GlodaCollectionManager._cachesByNoun = {};</span>
<a href="#l41.632"></a><span id="l41.632">   for each (let cache in oldCaches) {</span>
<a href="#l41.633"></a><span id="l41.633">     GlodaCollectionManager.defineCache(cache._nounDef, cache._maxCacheSize);</span>
<a href="#l41.634"></a><span id="l41.634">   }</span>
<a href="#l41.635"></a><span id="l41.635"> }</span>
<a href="#l41.636"></a><span id="l41.636" class="difflineplus">+</span>
<a href="#l41.637"></a><span id="l41.637" class="difflineplus">+/**</span>
<a href="#l41.638"></a><span id="l41.638" class="difflineplus">+ * Given an IMAP folder, marks it offline and downloads its messages.</span>
<a href="#l41.639"></a><span id="l41.639" class="difflineplus">+ *</span>
<a href="#l41.640"></a><span id="l41.640" class="difflineplus">+ * @param aFolder an IMAP message folder</span>
<a href="#l41.641"></a><span id="l41.641" class="difflineplus">+ * @param aSynthMessages see indexMessageState.expectMessages</span>
<a href="#l41.642"></a><span id="l41.642" class="difflineplus">+ * @param aVerifier see indexMessageState.expectMessages</span>
<a href="#l41.643"></a><span id="l41.643" class="difflineplus">+ * @param aDone see indexMessageState.expectMessages</span>
<a href="#l41.644"></a><span id="l41.644" class="difflineplus">+ */</span>
<a href="#l41.645"></a><span id="l41.645" class="difflineplus">+function imapDownloadAllMessages(aFolder, aSynthMessages, aVerifier, aDone) {</span>
<a href="#l41.646"></a><span id="l41.646" class="difflineplus">+  // Let the message state know that we're expecting messages</span>
<a href="#l41.647"></a><span id="l41.647" class="difflineplus">+  indexMessageState.expectMessages(aSynthMessages, aVerifier, aDone);</span>
<a href="#l41.648"></a><span id="l41.648" class="difflineplus">+  aFolder.setFlag(Ci.nsMsgFolderFlags.Offline);</span>
<a href="#l41.649"></a><span id="l41.649" class="difflineplus">+  aFolder.downloadAllForOffline(null, null);</span>
<a href="#l41.650"></a><span id="l41.650" class="difflineplus">+  // The indexer listener is going to call aDone, so our job is done here</span>
<a href="#l41.651"></a><span id="l41.651" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l42.1"></a><span id="l42.1" class="difflineminus">--- a/mailnews/db/gloda/test/unit/test_gloda_content.js</span>
<a href="#l42.2"></a><span id="l42.2" class="difflineplus">+++ b/mailnews/db/gloda/test/unit/test_gloda_content.js</span>
<a href="#l42.3"></a><span id="l42.3" class="difflineat">@@ -92,16 +92,27 @@ var messageInfos = [</span>
<a href="#l42.4"></a><span id="l42.4">            [false, &quot;&gt; wrote&quot;],</span>
<a href="#l42.5"></a><span id="l42.5">            [true, &quot;cheese&quot;],</span>
<a href="#l42.6"></a><span id="l42.6">            [false, &quot;&quot;]]</span>
<a href="#l42.7"></a><span id="l42.7">   }</span>
<a href="#l42.8"></a><span id="l42.8"> ];</span>
<a href="#l42.9"></a><span id="l42.9"> </span>
<a href="#l42.10"></a><span id="l42.10"> /* ===== Tests ===== */</span>
<a href="#l42.11"></a><span id="l42.11"> </span>
<a href="#l42.12"></a><span id="l42.12" class="difflineplus">+/**</span>
<a href="#l42.13"></a><span id="l42.13" class="difflineplus">+ * Hooks for pre/post setup message, used for the IMAP tests.</span>
<a href="#l42.14"></a><span id="l42.14" class="difflineplus">+ */</span>
<a href="#l42.15"></a><span id="l42.15" class="difflineplus">+var pre_inject_message_hook = function default_pre_inject_message_hook() {</span>
<a href="#l42.16"></a><span id="l42.16" class="difflineplus">+  next_test();</span>
<a href="#l42.17"></a><span id="l42.17" class="difflineplus">+};</span>
<a href="#l42.18"></a><span id="l42.18" class="difflineplus">+</span>
<a href="#l42.19"></a><span id="l42.19" class="difflineplus">+var post_inject_message_hook = function default_post_inject_message_hook() {</span>
<a href="#l42.20"></a><span id="l42.20" class="difflineplus">+  next_test();</span>
<a href="#l42.21"></a><span id="l42.21" class="difflineplus">+};</span>
<a href="#l42.22"></a><span id="l42.22" class="difflineplus">+</span>
<a href="#l42.23"></a><span id="l42.23"> function setup_create_message(info) {</span>
<a href="#l42.24"></a><span id="l42.24">   info.body = {body: [tupe[1] for each</span>
<a href="#l42.25"></a><span id="l42.25">                       ([, tupe] in Iterator(info.bode))].join(&quot;\r\n&quot;)};</span>
<a href="#l42.26"></a><span id="l42.26">   info.expected = [tupe[1] for each</span>
<a href="#l42.27"></a><span id="l42.27">                    ([, tupe] in Iterator(info.bode)) if</span>
<a href="#l42.28"></a><span id="l42.28">                    (tupe[0])].join(&quot;\n&quot;);</span>
<a href="#l42.29"></a><span id="l42.29"> </span>
<a href="#l42.30"></a><span id="l42.30">   info._synMsg = msgGen.makeMessage(info);</span>
<a href="#l42.31"></a><span id="l42.31" class="difflineat">@@ -120,20 +131,22 @@ function glodaInfoStasher(aSynthMessage,</span>
<a href="#l42.32"></a><span id="l42.32">       messageInfos[iMsg]._glodaMsg = aGlodaMessage;</span>
<a href="#l42.33"></a><span id="l42.33">     }</span>
<a href="#l42.34"></a><span id="l42.34">   }</span>
<a href="#l42.35"></a><span id="l42.35"> }</span>
<a href="#l42.36"></a><span id="l42.36"> </span>
<a href="#l42.37"></a><span id="l42.37"> /**</span>
<a href="#l42.38"></a><span id="l42.38">  * Actually inject all the messages we created above.</span>
<a href="#l42.39"></a><span id="l42.39">  */</span>
<a href="#l42.40"></a><span id="l42.40" class="difflineplus">+var gSynMessages;</span>
<a href="#l42.41"></a><span id="l42.41" class="difflineplus">+</span>
<a href="#l42.42"></a><span id="l42.42"> function setup_inject_messages() {</span>
<a href="#l42.43"></a><span id="l42.43" class="difflineminus">-  let synMessages = [info._synMsg for each</span>
<a href="#l42.44"></a><span id="l42.44" class="difflineminus">-                      ([, info] in Iterator(messageInfos))];</span>
<a href="#l42.45"></a><span id="l42.45" class="difflineminus">-  indexMessages(synMessages, glodaInfoStasher, next_test);</span>
<a href="#l42.46"></a><span id="l42.46" class="difflineplus">+  gSynMessages = [info._synMsg for each</span>
<a href="#l42.47"></a><span id="l42.47" class="difflineplus">+                  ([, info] in Iterator(messageInfos))];</span>
<a href="#l42.48"></a><span id="l42.48" class="difflineplus">+  indexMessages(gSynMessages, glodaInfoStasher, next_test);</span>
<a href="#l42.49"></a><span id="l42.49"> }</span>
<a href="#l42.50"></a><span id="l42.50"> </span>
<a href="#l42.51"></a><span id="l42.51"> function test_stream_message(info) {</span>
<a href="#l42.52"></a><span id="l42.52">   let msgHdr = info._glodaMsg.folderMessage;</span>
<a href="#l42.53"></a><span id="l42.53"> </span>
<a href="#l42.54"></a><span id="l42.54">   MsgHdrToMimeMessage(msgHdr, null, function(aMsgHdr, aMimeMsg) {</span>
<a href="#l42.55"></a><span id="l42.55">     verify_message_content(info, info._synMsg, info._glodaMsg, aMsgHdr,</span>
<a href="#l42.56"></a><span id="l42.56">                            aMimeMsg);</span>
<a href="#l42.57"></a><span id="l42.57" class="difflineat">@@ -161,16 +174,20 @@ function verify_message_content(aInfo, a</span>
<a href="#l42.58"></a><span id="l42.58"> </span>
<a href="#l42.59"></a><span id="l42.59">   next_test();</span>
<a href="#l42.60"></a><span id="l42.60"> }</span>
<a href="#l42.61"></a><span id="l42.61"> </span>
<a href="#l42.62"></a><span id="l42.62"> /* ===== Driver ===== */</span>
<a href="#l42.63"></a><span id="l42.63"> </span>
<a href="#l42.64"></a><span id="l42.64"> var tests = [</span>
<a href="#l42.65"></a><span id="l42.65">   parameterizeTest(setup_create_message, messageInfos),</span>
<a href="#l42.66"></a><span id="l42.66" class="difflineplus">+  function pre_inject_message() { pre_inject_message_hook(); },</span>
<a href="#l42.67"></a><span id="l42.67">   setup_inject_messages,</span>
<a href="#l42.68"></a><span id="l42.68" class="difflineplus">+  function post_inject_message() { post_inject_message_hook(); },</span>
<a href="#l42.69"></a><span id="l42.69" class="difflineplus">+ // disable_index_notifications,</span>
<a href="#l42.70"></a><span id="l42.70">   parameterizeTest(test_stream_message, messageInfos),</span>
<a href="#l42.71"></a><span id="l42.71"> ];</span>
<a href="#l42.72"></a><span id="l42.72"> </span>
<a href="#l42.73"></a><span id="l42.73"> function run_test() {</span>
<a href="#l42.74"></a><span id="l42.74" class="difflineminus">-  injectMessagesUsing(INJECT_MBOX);</span>
<a href="#l42.75"></a><span id="l42.75">   glodaHelperRunTests(tests);</span>
<a href="#l42.76"></a><span id="l42.76"> }</span>
<a href="#l42.77"></a><span id="l42.77" class="difflineplus">+</span>
<a href="#l42.78"></a><span id="l42.78" class="difflineplus">+injectMessagesUsing(INJECT_MBOX);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l43.1"></a><span id="l43.1">new file mode 100644</span>
<a href="#l43.2"></a><span id="l43.2" class="difflineminus">--- /dev/null</span>
<a href="#l43.3"></a><span id="l43.3" class="difflineplus">+++ b/mailnews/db/gloda/test/unit/test_gloda_content_imap_originally_offline.js</span>
<a href="#l43.4"></a><span id="l43.4" class="difflineat">@@ -0,0 +1,17 @@</span>
<a href="#l43.5"></a><span id="l43.5" class="difflineplus">+/* -*- Mode: JavaScript; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l43.6"></a><span id="l43.6" class="difflineplus">+/**</span>
<a href="#l43.7"></a><span id="l43.7" class="difflineplus">+ * Tests the operation of the GlodaContent (in connotent.js) and its exposure</span>
<a href="#l43.8"></a><span id="l43.8" class="difflineplus">+ * via Gloda.getMessageContent for IMAP messages that are originally offline.</span>
<a href="#l43.9"></a><span id="l43.9" class="difflineplus">+ */</span>
<a href="#l43.10"></a><span id="l43.10" class="difflineplus">+</span>
<a href="#l43.11"></a><span id="l43.11" class="difflineplus">+load(&quot;test_gloda_content.js&quot;);</span>
<a href="#l43.12"></a><span id="l43.12" class="difflineplus">+</span>
<a href="#l43.13"></a><span id="l43.13" class="difflineplus">+/**</span>
<a href="#l43.14"></a><span id="l43.14" class="difflineplus">+ * Set the imap folder to offline before adding the messages.</span>
<a href="#l43.15"></a><span id="l43.15" class="difflineplus">+ */</span>
<a href="#l43.16"></a><span id="l43.16" class="difflineplus">+var pre_inject_message_hook = function imap_pre_inject_message_hook() {</span>
<a href="#l43.17"></a><span id="l43.17" class="difflineplus">+  indexMessageState.imapInbox.setFlag(Ci.nsMsgFolderFlags.Offline);</span>
<a href="#l43.18"></a><span id="l43.18" class="difflineplus">+  next_test();</span>
<a href="#l43.19"></a><span id="l43.19" class="difflineplus">+};</span>
<a href="#l43.20"></a><span id="l43.20" class="difflineplus">+</span>
<a href="#l43.21"></a><span id="l43.21" class="difflineplus">+injectMessagesUsing(INJECT_IMAP_FAKE_SERVER);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l44.1"></a><span id="l44.1">new file mode 100644</span>
<a href="#l44.2"></a><span id="l44.2" class="difflineminus">--- /dev/null</span>
<a href="#l44.3"></a><span id="l44.3" class="difflineplus">+++ b/mailnews/db/gloda/test/unit/test_gloda_content_imap_switched_to_offline.js</span>
<a href="#l44.4"></a><span id="l44.4" class="difflineat">@@ -0,0 +1,19 @@</span>
<a href="#l44.5"></a><span id="l44.5" class="difflineplus">+/* -*- Mode: JavaScript; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l44.6"></a><span id="l44.6" class="difflineplus">+/**</span>
<a href="#l44.7"></a><span id="l44.7" class="difflineplus">+ * Tests the operation of the GlodaContent (in connotent.js) and its exposure</span>
<a href="#l44.8"></a><span id="l44.8" class="difflineplus">+ * via Gloda.getMessageContent for IMAP messages that were not originally</span>
<a href="#l44.9"></a><span id="l44.9" class="difflineplus">+ * offline, but were later made offline.</span>
<a href="#l44.10"></a><span id="l44.10" class="difflineplus">+ */</span>
<a href="#l44.11"></a><span id="l44.11" class="difflineplus">+</span>
<a href="#l44.12"></a><span id="l44.12" class="difflineplus">+load(&quot;test_gloda_content.js&quot;);</span>
<a href="#l44.13"></a><span id="l44.13" class="difflineplus">+</span>
<a href="#l44.14"></a><span id="l44.14" class="difflineplus">+/**</span>
<a href="#l44.15"></a><span id="l44.15" class="difflineplus">+ * Set the imap folder to offline after adding the messages, then force a</span>
<a href="#l44.16"></a><span id="l44.16" class="difflineplus">+ * download of all messages.</span>
<a href="#l44.17"></a><span id="l44.17" class="difflineplus">+ */</span>
<a href="#l44.18"></a><span id="l44.18" class="difflineplus">+var post_inject_message_hook = function imap_post_inject_message_hook() {</span>
<a href="#l44.19"></a><span id="l44.19" class="difflineplus">+  imapDownloadAllMessages(indexMessageState.imapInbox, gSynMessages,</span>
<a href="#l44.20"></a><span id="l44.20" class="difflineplus">+                          glodaInfoStasher, next_test);</span>
<a href="#l44.21"></a><span id="l44.21" class="difflineplus">+};</span>
<a href="#l44.22"></a><span id="l44.22" class="difflineplus">+</span>
<a href="#l44.23"></a><span id="l44.23" class="difflineplus">+injectMessagesUsing(INJECT_IMAP_FAKE_SERVER);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l45.1"></a><span id="l45.1" class="difflineminus">--- a/mailnews/db/gloda/test/unit/test_index_messages.js</span>
<a href="#l45.2"></a><span id="l45.2" class="difflineplus">+++ b/mailnews/db/gloda/test/unit/test_index_messages.js</span>
<a href="#l45.3"></a><span id="l45.3" class="difflineat">@@ -5,30 +5,45 @@</span>
<a href="#l45.4"></a><span id="l45.4">  *</span>
<a href="#l45.5"></a><span id="l45.5">  * Things we don't test that you think we might test:</span>
<a href="#l45.6"></a><span id="l45.6">  * - Full-text search.  Happens in query testing.</span>
<a href="#l45.7"></a><span id="l45.7">  */</span>
<a href="#l45.8"></a><span id="l45.8"> </span>
<a href="#l45.9"></a><span id="l45.9"> load(&quot;../../mailnews/resources/messageGenerator.js&quot;);</span>
<a href="#l45.10"></a><span id="l45.10"> load(&quot;resources/glodaTestHelper.js&quot;);</span>
<a href="#l45.11"></a><span id="l45.11"> </span>
<a href="#l45.12"></a><span id="l45.12" class="difflineplus">+// Whether we can expect fulltext results</span>
<a href="#l45.13"></a><span id="l45.13" class="difflineplus">+var expectFulltextResults = true;</span>
<a href="#l45.14"></a><span id="l45.14" class="difflineplus">+</span>
<a href="#l45.15"></a><span id="l45.15"> // Create a message generator</span>
<a href="#l45.16"></a><span id="l45.16"> var msgGen = new MessageGenerator();</span>
<a href="#l45.17"></a><span id="l45.17"> // Create a message scenario generator using that message generator</span>
<a href="#l45.18"></a><span id="l45.18"> var scenarios = new MessageScenarioFactory(msgGen);</span>
<a href="#l45.19"></a><span id="l45.19"> </span>
<a href="#l45.20"></a><span id="l45.20"> /* ===== Threading / Conversation Grouping ===== */</span>
<a href="#l45.21"></a><span id="l45.21"> </span>
<a href="#l45.22"></a><span id="l45.22" class="difflineplus">+var gSynMessages = [];</span>
<a href="#l45.23"></a><span id="l45.23"> function allMessageInSameConversation(aSynthMessage, aGlodaMessage, aConvID) {</span>
<a href="#l45.24"></a><span id="l45.24">   if (aConvID === undefined)</span>
<a href="#l45.25"></a><span id="l45.25">     return aGlodaMessage.conversationID;</span>
<a href="#l45.26"></a><span id="l45.26">   do_check_eq(aConvID, aGlodaMessage.conversationID);</span>
<a href="#l45.27"></a><span id="l45.27" class="difflineplus">+  // Cheat and stash the synthetic message (we need them for one of the IMAP</span>
<a href="#l45.28"></a><span id="l45.28" class="difflineplus">+  // tests)</span>
<a href="#l45.29"></a><span id="l45.29" class="difflineplus">+  gSynMessages.push(aSynthMessage);</span>
<a href="#l45.30"></a><span id="l45.30">   return aConvID;</span>
<a href="#l45.31"></a><span id="l45.31"> }</span>
<a href="#l45.32"></a><span id="l45.32"> </span>
<a href="#l45.33"></a><span id="l45.33" class="difflineplus">+// These are overridden by the IMAP tests as needed</span>
<a href="#l45.34"></a><span id="l45.34" class="difflineplus">+var pre_test_threading_hook = function default_pre_test_threading_hook() {</span>
<a href="#l45.35"></a><span id="l45.35" class="difflineplus">+  next_test();</span>
<a href="#l45.36"></a><span id="l45.36" class="difflineplus">+};</span>
<a href="#l45.37"></a><span id="l45.37" class="difflineplus">+var post_test_threading_hook = function default_post_test_threading_hook() {</span>
<a href="#l45.38"></a><span id="l45.38" class="difflineplus">+  next_test();</span>
<a href="#l45.39"></a><span id="l45.39" class="difflineplus">+};</span>
<a href="#l45.40"></a><span id="l45.40" class="difflineplus">+</span>
<a href="#l45.41"></a><span id="l45.41"> /**</span>
<a href="#l45.42"></a><span id="l45.42">  * Test our conversation/threading logic in the straight-forward direct</span>
<a href="#l45.43"></a><span id="l45.43">  *  reply case, the missing intermediary case, and the siblings with missing</span>
<a href="#l45.44"></a><span id="l45.44">  *  parent case.  We also test all permutations of receipt of those messages.</span>
<a href="#l45.45"></a><span id="l45.45">  * (Also tests that we index new messages.)</span>
<a href="#l45.46"></a><span id="l45.46">  */</span>
<a href="#l45.47"></a><span id="l45.47"> function test_threading() {</span>
<a href="#l45.48"></a><span id="l45.48">   indexAndPermuteMessages(scenarios.directReply,</span>
<a href="#l45.49"></a><span id="l45.49" class="difflineat">@@ -67,22 +82,27 @@ function test_attributes_fundamental() {</span>
<a href="#l45.50"></a><span id="l45.50">     ],</span>
<a href="#l45.51"></a><span id="l45.51">   });</span>
<a href="#l45.52"></a><span id="l45.52">   // save it off for test_attributes_fundamental_from_disk</span>
<a href="#l45.53"></a><span id="l45.53">   fundamentalSyntheticMessage = smsg;</span>
<a href="#l45.54"></a><span id="l45.54"> </span>
<a href="#l45.55"></a><span id="l45.55">   indexMessages([smsg], verify_attributes_fundamental, next_test);</span>
<a href="#l45.56"></a><span id="l45.56"> }</span>
<a href="#l45.57"></a><span id="l45.57"> </span>
<a href="#l45.58"></a><span id="l45.58" class="difflineplus">+// Overridden by test_index_imap_mesasges</span>
<a href="#l45.59"></a><span id="l45.59" class="difflineplus">+var get_expected_folder_URI = function local_get_expected_folder_URI() {</span>
<a href="#l45.60"></a><span id="l45.60" class="difflineplus">+  return gLocalInboxFolder.URI;</span>
<a href="#l45.61"></a><span id="l45.61" class="difflineplus">+};</span>
<a href="#l45.62"></a><span id="l45.62" class="difflineplus">+</span>
<a href="#l45.63"></a><span id="l45.63"> function verify_attributes_fundamental(smsg, gmsg) {</span>
<a href="#l45.64"></a><span id="l45.64">   try {</span>
<a href="#l45.65"></a><span id="l45.65">     // save off the message id for test_attributes_fundamental_from_disk</span>
<a href="#l45.66"></a><span id="l45.66">     fundamentalGlodaMessageId = gmsg.id;</span>
<a href="#l45.67"></a><span id="l45.67"> </span>
<a href="#l45.68"></a><span id="l45.68" class="difflineminus">-    do_check_eq(gmsg.folderURI, gLocalInboxFolder.URI);</span>
<a href="#l45.69"></a><span id="l45.69" class="difflineplus">+    do_check_eq(gmsg.folderURI, get_expected_folder_URI());</span>
<a href="#l45.70"></a><span id="l45.70"> </span>
<a href="#l45.71"></a><span id="l45.71">     // -- subject</span>
<a href="#l45.72"></a><span id="l45.72">     do_check_eq(smsg.subject, gmsg.conversation.subject);</span>
<a href="#l45.73"></a><span id="l45.73">     do_check_eq(smsg.subject, gmsg.subject);</span>
<a href="#l45.74"></a><span id="l45.74"> </span>
<a href="#l45.75"></a><span id="l45.75">     // -- contact/identity information</span>
<a href="#l45.76"></a><span id="l45.76">     // - from</span>
<a href="#l45.77"></a><span id="l45.77">     // check the e-mail address</span>
<a href="#l45.78"></a><span id="l45.78" class="difflineat">@@ -92,22 +112,32 @@ function verify_attributes_fundamental(s</span>
<a href="#l45.79"></a><span id="l45.79">     do_check_eq(smsg.fromName, gmsg.from.contact.name);</span>
<a href="#l45.80"></a><span id="l45.80"> </span>
<a href="#l45.81"></a><span id="l45.81">     // - to</span>
<a href="#l45.82"></a><span id="l45.82">     do_check_eq(smsg.toAddress, gmsg.to[0].value);</span>
<a href="#l45.83"></a><span id="l45.83">     do_check_eq(smsg.toName, gmsg.to[0].contact.name);</span>
<a href="#l45.84"></a><span id="l45.84"> </span>
<a href="#l45.85"></a><span id="l45.85">     // date</span>
<a href="#l45.86"></a><span id="l45.86">     do_check_eq(smsg.date.valueOf(), gmsg.date.valueOf());</span>
<a href="#l45.87"></a><span id="l45.87" class="difflineplus">+    </span>
<a href="#l45.88"></a><span id="l45.88" class="difflineplus">+    // -- message ID</span>
<a href="#l45.89"></a><span id="l45.89" class="difflineplus">+    do_check_eq(smsg.messageId, gmsg.headerMessageID);</span>
<a href="#l45.90"></a><span id="l45.90"> </span>
<a href="#l45.91"></a><span id="l45.91" class="difflineminus">-    // -- attachments</span>
<a href="#l45.92"></a><span id="l45.92" class="difflineminus">-    do_check_eq(gmsg.attachmentTypes.length, 1);</span>
<a href="#l45.93"></a><span id="l45.93" class="difflineminus">-    do_check_eq(gmsg.attachmentTypes[0], &quot;text/plain&quot;);</span>
<a href="#l45.94"></a><span id="l45.94" class="difflineminus">-    do_check_eq(gmsg.attachmentNames.length, 1);</span>
<a href="#l45.95"></a><span id="l45.95" class="difflineminus">-    do_check_eq(gmsg.attachmentNames[0], &quot;bob.txt&quot;);</span>
<a href="#l45.96"></a><span id="l45.96" class="difflineplus">+    // -- attachments. We won't have these if we don't have fulltext results</span>
<a href="#l45.97"></a><span id="l45.97" class="difflineplus">+    if (expectFulltextResults) {</span>
<a href="#l45.98"></a><span id="l45.98" class="difflineplus">+      do_check_eq(gmsg.attachmentTypes.length, 1);</span>
<a href="#l45.99"></a><span id="l45.99" class="difflineplus">+      do_check_eq(gmsg.attachmentTypes[0], &quot;text/plain&quot;);</span>
<a href="#l45.100"></a><span id="l45.100" class="difflineplus">+      do_check_eq(gmsg.attachmentNames.length, 1);</span>
<a href="#l45.101"></a><span id="l45.101" class="difflineplus">+      do_check_eq(gmsg.attachmentNames[0], &quot;bob.txt&quot;);</span>
<a href="#l45.102"></a><span id="l45.102" class="difflineplus">+    }</span>
<a href="#l45.103"></a><span id="l45.103" class="difflineplus">+    else {</span>
<a href="#l45.104"></a><span id="l45.104" class="difflineplus">+      // Make sure we don't actually get attachments!</span>
<a href="#l45.105"></a><span id="l45.105" class="difflineplus">+      do_check_eq(gmsg.attachmentTypes, null);</span>
<a href="#l45.106"></a><span id="l45.106" class="difflineplus">+      do_check_eq(gmsg.attachmentNames, null);</span>
<a href="#l45.107"></a><span id="l45.107" class="difflineplus">+    }</span>
<a href="#l45.108"></a><span id="l45.108">   }</span>
<a href="#l45.109"></a><span id="l45.109">   catch (ex) {</span>
<a href="#l45.110"></a><span id="l45.110">     // print out some info on the various states of the messages...</span>
<a href="#l45.111"></a><span id="l45.111">     dump(&quot;***** FUNDAMENTAL ATTRIBUTE NON-MATCH\n&quot;);</span>
<a href="#l45.112"></a><span id="l45.112">     ddumpObject(smsg, &quot;smsg&quot;, 0);</span>
<a href="#l45.113"></a><span id="l45.113">     ddumpObject(gmsg, &quot;gmsg&quot;, 0);</span>
<a href="#l45.114"></a><span id="l45.114">     throw ex;</span>
<a href="#l45.115"></a><span id="l45.115">   }</span>
<a href="#l45.116"></a><span id="l45.116" class="difflineat">@@ -224,17 +254,19 @@ function test_message_moving() {</span>
<a href="#l45.117"></a><span id="l45.117"> /* ===== Message Deletion ===== */</span>
<a href="#l45.118"></a><span id="l45.118"> function test_message_deletion() {</span>
<a href="#l45.119"></a><span id="l45.119"> }</span>
<a href="#l45.120"></a><span id="l45.120"> </span>
<a href="#l45.121"></a><span id="l45.121"> /* ===== Folder Move/Rename/Copy (Single and Nested) ===== */</span>
<a href="#l45.122"></a><span id="l45.122"> </span>
<a href="#l45.123"></a><span id="l45.123"> </span>
<a href="#l45.124"></a><span id="l45.124"> var tests = [</span>
<a href="#l45.125"></a><span id="l45.125" class="difflineplus">+  function pre_test_threading() { pre_test_threading_hook(); },</span>
<a href="#l45.126"></a><span id="l45.126">   test_threading,</span>
<a href="#l45.127"></a><span id="l45.127" class="difflineplus">+  function post_test_threading() { post_test_threading_hook(); },</span>
<a href="#l45.128"></a><span id="l45.128">   test_attributes_fundamental,</span>
<a href="#l45.129"></a><span id="l45.129">   test_attributes_fundamental_from_disk,</span>
<a href="#l45.130"></a><span id="l45.130">   test_attributes_explicit,</span>
<a href="#l45.131"></a><span id="l45.131"> ];</span>
<a href="#l45.132"></a><span id="l45.132"> </span>
<a href="#l45.133"></a><span id="l45.133"> function run_test() {</span>
<a href="#l45.134"></a><span id="l45.134">   glodaHelperRunTests(tests);</span>
<a href="#l45.135"></a><span id="l45.135"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l46.1"></a><span id="l46.1" class="difflineminus">--- a/mailnews/db/gloda/test/unit/test_index_messages_in_bulk.js</span>
<a href="#l46.2"></a><span id="l46.2" class="difflineplus">+++ b/mailnews/db/gloda/test/unit/test_index_messages_in_bulk.js</span>
<a href="#l46.3"></a><span id="l46.3" class="difflineat">@@ -9,27 +9,40 @@ load(&quot;resources/glodaTestHelper.js&quot;);</span>
<a href="#l46.4"></a><span id="l46.4"> // Create a message generator</span>
<a href="#l46.5"></a><span id="l46.5"> var msgGen = new MessageGenerator();</span>
<a href="#l46.6"></a><span id="l46.6"> // Create a message scenario generator using that message generator</span>
<a href="#l46.7"></a><span id="l46.7"> var scenarios = new MessageScenarioFactory(msgGen);</span>
<a href="#l46.8"></a><span id="l46.8"> </span>
<a href="#l46.9"></a><span id="l46.9"> /**</span>
<a href="#l46.10"></a><span id="l46.10">  * Provide a bunch of messages to be indexed.</span>
<a href="#l46.11"></a><span id="l46.11">  */</span>
<a href="#l46.12"></a><span id="l46.12" class="difflineplus">+var gSynMessages;</span>
<a href="#l46.13"></a><span id="l46.13"> function test_index_a_bunch() {</span>
<a href="#l46.14"></a><span id="l46.14">   // 4-children-per, 3-deep = 21</span>
<a href="#l46.15"></a><span id="l46.15" class="difflineplus">+  // 6-children-per, 3 deep = 43</span>
<a href="#l46.16"></a><span id="l46.16" class="difflineplus">+  // 7-children-per, 3-deep = 57</span>
<a href="#l46.17"></a><span id="l46.17">   // 4-children-per, 4-deep = 85</span>
<a href="#l46.18"></a><span id="l46.18">   // 4-children-per, 5-deep pyramid = 341</span>
<a href="#l46.19"></a><span id="l46.19">   // 5-children-per, 5-deep pyramid = 781</span>
<a href="#l46.20"></a><span id="l46.20">   // 4-children-per, 6-deep pyramid = 1365 messages</span>
<a href="#l46.21"></a><span id="l46.21" class="difflineminus">-  let messages = scenarios.fullPyramid(4, 3);</span>
<a href="#l46.22"></a><span id="l46.22" class="difflineplus">+  gSynMessages = scenarios.fullPyramid(6, 3);</span>
<a href="#l46.23"></a><span id="l46.23">   // we have no need to verify.</span>
<a href="#l46.24"></a><span id="l46.24" class="difflineminus">-  indexMessages(messages, null, next_test);</span>
<a href="#l46.25"></a><span id="l46.25" class="difflineplus">+  indexMessages(gSynMessages, null, next_test);</span>
<a href="#l46.26"></a><span id="l46.26"> }</span>
<a href="#l46.27"></a><span id="l46.27"> </span>
<a href="#l46.28"></a><span id="l46.28" class="difflineplus">+var pre_test_hook = function default_pre_test_hook() {</span>
<a href="#l46.29"></a><span id="l46.29" class="difflineplus">+  next_test();</span>
<a href="#l46.30"></a><span id="l46.30" class="difflineplus">+};</span>
<a href="#l46.31"></a><span id="l46.31" class="difflineplus">+var post_test_hook = function default_post_test_hook() {</span>
<a href="#l46.32"></a><span id="l46.32" class="difflineplus">+  next_test();</span>
<a href="#l46.33"></a><span id="l46.33" class="difflineplus">+};</span>
<a href="#l46.34"></a><span id="l46.34" class="difflineplus">+</span>
<a href="#l46.35"></a><span id="l46.35"> var tests = [</span>
<a href="#l46.36"></a><span id="l46.36" class="difflineplus">+  function pre_test() { pre_test_hook(); },</span>
<a href="#l46.37"></a><span id="l46.37">   test_index_a_bunch,</span>
<a href="#l46.38"></a><span id="l46.38" class="difflineplus">+  function post_test() { post_test_hook(); },</span>
<a href="#l46.39"></a><span id="l46.39"> ];</span>
<a href="#l46.40"></a><span id="l46.40"> </span>
<a href="#l46.41"></a><span id="l46.41"> function run_test() {</span>
<a href="#l46.42"></a><span id="l46.42" class="difflineminus">-  injectMessagesUsing(INJECT_MBOX);</span>
<a href="#l46.43"></a><span id="l46.43">   glodaHelperRunTests(tests);</span>
<a href="#l46.44"></a><span id="l46.44"> }</span>
<a href="#l46.45"></a><span id="l46.45" class="difflineplus">+</span>
<a href="#l46.46"></a><span id="l46.46" class="difflineplus">+injectMessagesUsing(INJECT_MBOX);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l47.1"></a><span id="l47.1">new file mode 100644</span>
<a href="#l47.2"></a><span id="l47.2" class="difflineminus">--- /dev/null</span>
<a href="#l47.3"></a><span id="l47.3" class="difflineplus">+++ b/mailnews/db/gloda/test/unit/test_index_non_offline_imap_messages.js</span>
<a href="#l47.4"></a><span id="l47.4" class="difflineat">@@ -0,0 +1,16 @@</span>
<a href="#l47.5"></a><span id="l47.5" class="difflineplus">+/* -*- Mode: JavaScript; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l47.6"></a><span id="l47.6" class="difflineplus">+/**</span>
<a href="#l47.7"></a><span id="l47.7" class="difflineplus">+ * Tests how well gloda indexes IMAP messages that aren't offline.</span>
<a href="#l47.8"></a><span id="l47.8" class="difflineplus">+ */</span>
<a href="#l47.9"></a><span id="l47.9" class="difflineplus">+</span>
<a href="#l47.10"></a><span id="l47.10" class="difflineplus">+// Most of the definitions are common, so just re-use those</span>
<a href="#l47.11"></a><span id="l47.11" class="difflineplus">+load(&quot;test_index_messages.js&quot;);</span>
<a href="#l47.12"></a><span id="l47.12" class="difflineplus">+</span>
<a href="#l47.13"></a><span id="l47.13" class="difflineplus">+var get_expected_folder_URI = function imap_get_expected_folder_URI() {</span>
<a href="#l47.14"></a><span id="l47.14" class="difflineplus">+  return indexMessageState.imapInbox.URI;</span>
<a href="#l47.15"></a><span id="l47.15" class="difflineplus">+};</span>
<a href="#l47.16"></a><span id="l47.16" class="difflineplus">+</span>
<a href="#l47.17"></a><span id="l47.17" class="difflineplus">+var expectFulltextResults = false;</span>
<a href="#l47.18"></a><span id="l47.18" class="difflineplus">+</span>
<a href="#l47.19"></a><span id="l47.19" class="difflineplus">+// Switch to the IMAP fake server</span>
<a href="#l47.20"></a><span id="l47.20" class="difflineplus">+injectMessagesUsing(INJECT_IMAP_FAKE_SERVER);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l48.1"></a><span id="l48.1">new file mode 100644</span>
<a href="#l48.2"></a><span id="l48.2" class="difflineminus">--- /dev/null</span>
<a href="#l48.3"></a><span id="l48.3" class="difflineplus">+++ b/mailnews/db/gloda/test/unit/test_index_non_offline_imap_messages_in_bulk.js</span>
<a href="#l48.4"></a><span id="l48.4" class="difflineat">@@ -0,0 +1,10 @@</span>
<a href="#l48.5"></a><span id="l48.5" class="difflineplus">+/* -*- Mode: JavaScript; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l48.6"></a><span id="l48.6" class="difflineplus">+/**</span>
<a href="#l48.7"></a><span id="l48.7" class="difflineplus">+ * Tests how well gloda indexes IMAP messages that aren't offline in bulk.</span>
<a href="#l48.8"></a><span id="l48.8" class="difflineplus">+ */</span>
<a href="#l48.9"></a><span id="l48.9" class="difflineplus">+</span>
<a href="#l48.10"></a><span id="l48.10" class="difflineplus">+// The definitions are common, so just re-use those</span>
<a href="#l48.11"></a><span id="l48.11" class="difflineplus">+load(&quot;test_index_messages_in_bulk.js&quot;);</span>
<a href="#l48.12"></a><span id="l48.12" class="difflineplus">+</span>
<a href="#l48.13"></a><span id="l48.13" class="difflineplus">+// Switch to the IMAP fake server</span>
<a href="#l48.14"></a><span id="l48.14" class="difflineplus">+injectMessagesUsing(INJECT_IMAP_FAKE_SERVER);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l49.1"></a><span id="l49.1">new file mode 100644</span>
<a href="#l49.2"></a><span id="l49.2" class="difflineminus">--- /dev/null</span>
<a href="#l49.3"></a><span id="l49.3" class="difflineplus">+++ b/mailnews/db/gloda/test/unit/test_index_originally_offline_imap_messages.js</span>
<a href="#l49.4"></a><span id="l49.4" class="difflineat">@@ -0,0 +1,19 @@</span>
<a href="#l49.5"></a><span id="l49.5" class="difflineplus">+/* -*- Mode: JavaScript; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l49.6"></a><span id="l49.6" class="difflineplus">+/**</span>
<a href="#l49.7"></a><span id="l49.7" class="difflineplus">+ * Tests how well gloda indexes IMAP messages that are offline from the start.</span>
<a href="#l49.8"></a><span id="l49.8" class="difflineplus">+ */</span>
<a href="#l49.9"></a><span id="l49.9" class="difflineplus">+</span>
<a href="#l49.10"></a><span id="l49.10" class="difflineplus">+// Most of the definitions are common, so just re-use those</span>
<a href="#l49.11"></a><span id="l49.11" class="difflineplus">+load(&quot;test_index_messages.js&quot;);</span>
<a href="#l49.12"></a><span id="l49.12" class="difflineplus">+</span>
<a href="#l49.13"></a><span id="l49.13" class="difflineplus">+var get_expected_folder_URI = function imap_get_expected_folder_URI() {</span>
<a href="#l49.14"></a><span id="l49.14" class="difflineplus">+  return indexMessageState.imapInbox.URI;</span>
<a href="#l49.15"></a><span id="l49.15" class="difflineplus">+};</span>
<a href="#l49.16"></a><span id="l49.16" class="difflineplus">+</span>
<a href="#l49.17"></a><span id="l49.17" class="difflineplus">+var pre_test_threading_hook = function imap_pre_test_threading_hook() {</span>
<a href="#l49.18"></a><span id="l49.18" class="difflineplus">+  indexMessageState.imapInbox.setFlag(Ci.nsMsgFolderFlags.Offline);</span>
<a href="#l49.19"></a><span id="l49.19" class="difflineplus">+  next_test();</span>
<a href="#l49.20"></a><span id="l49.20" class="difflineplus">+};</span>
<a href="#l49.21"></a><span id="l49.21" class="difflineplus">+</span>
<a href="#l49.22"></a><span id="l49.22" class="difflineplus">+// Switch to the IMAP fake server</span>
<a href="#l49.23"></a><span id="l49.23" class="difflineplus">+injectMessagesUsing(INJECT_IMAP_FAKE_SERVER);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l50.1"></a><span id="l50.1">new file mode 100644</span>
<a href="#l50.2"></a><span id="l50.2" class="difflineminus">--- /dev/null</span>
<a href="#l50.3"></a><span id="l50.3" class="difflineplus">+++ b/mailnews/db/gloda/test/unit/test_index_originally_offline_imap_messages_in_bulk.js</span>
<a href="#l50.4"></a><span id="l50.4" class="difflineat">@@ -0,0 +1,15 @@</span>
<a href="#l50.5"></a><span id="l50.5" class="difflineplus">+/* -*- Mode: JavaScript; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l50.6"></a><span id="l50.6" class="difflineplus">+/**</span>
<a href="#l50.7"></a><span id="l50.7" class="difflineplus">+ * Tests how well gloda indexes IMAP messages that aren't offline in bulk.</span>
<a href="#l50.8"></a><span id="l50.8" class="difflineplus">+ */</span>
<a href="#l50.9"></a><span id="l50.9" class="difflineplus">+</span>
<a href="#l50.10"></a><span id="l50.10" class="difflineplus">+// The definitions are common, so just re-use those</span>
<a href="#l50.11"></a><span id="l50.11" class="difflineplus">+load(&quot;test_index_messages_in_bulk.js&quot;);</span>
<a href="#l50.12"></a><span id="l50.12" class="difflineplus">+</span>
<a href="#l50.13"></a><span id="l50.13" class="difflineplus">+var pre_test_hook = function imap_pre_test_hook() {</span>
<a href="#l50.14"></a><span id="l50.14" class="difflineplus">+  indexMessageState.imapInbox.setFlag(Ci.nsMsgFolderFlags.Offline);</span>
<a href="#l50.15"></a><span id="l50.15" class="difflineplus">+  next_test();</span>
<a href="#l50.16"></a><span id="l50.16" class="difflineplus">+};</span>
<a href="#l50.17"></a><span id="l50.17" class="difflineplus">+</span>
<a href="#l50.18"></a><span id="l50.18" class="difflineplus">+// Switch to the IMAP fake server</span>
<a href="#l50.19"></a><span id="l50.19" class="difflineplus">+injectMessagesUsing(INJECT_IMAP_FAKE_SERVER);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l51.1"></a><span id="l51.1">new file mode 100644</span>
<a href="#l51.2"></a><span id="l51.2" class="difflineminus">--- /dev/null</span>
<a href="#l51.3"></a><span id="l51.3" class="difflineplus">+++ b/mailnews/db/gloda/test/unit/test_index_switched_to_offline_imap_messages.js</span>
<a href="#l51.4"></a><span id="l51.4" class="difflineat">@@ -0,0 +1,21 @@</span>
<a href="#l51.5"></a><span id="l51.5" class="difflineplus">+/* -*- Mode: JavaScript; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l51.6"></a><span id="l51.6" class="difflineplus">+/**</span>
<a href="#l51.7"></a><span id="l51.7" class="difflineplus">+ * Tests how well gloda indexes IMAP messages that are not offline at first, but</span>
<a href="#l51.8"></a><span id="l51.8" class="difflineplus">+ * are made offline later.</span>
<a href="#l51.9"></a><span id="l51.9" class="difflineplus">+ */</span>
<a href="#l51.10"></a><span id="l51.10" class="difflineplus">+</span>
<a href="#l51.11"></a><span id="l51.11" class="difflineplus">+// Most of the definitions are common, so just re-use those</span>
<a href="#l51.12"></a><span id="l51.12" class="difflineplus">+load(&quot;test_index_messages.js&quot;);</span>
<a href="#l51.13"></a><span id="l51.13" class="difflineplus">+</span>
<a href="#l51.14"></a><span id="l51.14" class="difflineplus">+var get_expected_folder_URI = function imap_get_expected_folder_URI() {</span>
<a href="#l51.15"></a><span id="l51.15" class="difflineplus">+  return indexMessageState.imapInbox.URI;</span>
<a href="#l51.16"></a><span id="l51.16" class="difflineplus">+};</span>
<a href="#l51.17"></a><span id="l51.17" class="difflineplus">+</span>
<a href="#l51.18"></a><span id="l51.18" class="difflineplus">+var post_test_threading_hook = function imap_post_test_threading_hook() {</span>
<a href="#l51.19"></a><span id="l51.19" class="difflineplus">+  // We aren't concerned about verification here, so just pass in null</span>
<a href="#l51.20"></a><span id="l51.20" class="difflineplus">+  imapDownloadAllMessages(indexMessageState.imapInbox, gSynMessages, null,</span>
<a href="#l51.21"></a><span id="l51.21" class="difflineplus">+                          next_test);</span>
<a href="#l51.22"></a><span id="l51.22" class="difflineplus">+};</span>
<a href="#l51.23"></a><span id="l51.23" class="difflineplus">+</span>
<a href="#l51.24"></a><span id="l51.24" class="difflineplus">+// Switch to the IMAP fake server</span>
<a href="#l51.25"></a><span id="l51.25" class="difflineplus">+injectMessagesUsing(INJECT_IMAP_FAKE_SERVER);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l52.1"></a><span id="l52.1">new file mode 100644</span>
<a href="#l52.2"></a><span id="l52.2" class="difflineminus">--- /dev/null</span>
<a href="#l52.3"></a><span id="l52.3" class="difflineplus">+++ b/mailnews/db/gloda/test/unit/test_index_switched_to_offline_imap_messages_in_bulk.js</span>
<a href="#l52.4"></a><span id="l52.4" class="difflineat">@@ -0,0 +1,16 @@</span>
<a href="#l52.5"></a><span id="l52.5" class="difflineplus">+/* -*- Mode: JavaScript; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l52.6"></a><span id="l52.6" class="difflineplus">+/**</span>
<a href="#l52.7"></a><span id="l52.7" class="difflineplus">+ * Tests how well gloda indexes IMAP messages that aren't offline in bulk.</span>
<a href="#l52.8"></a><span id="l52.8" class="difflineplus">+ */</span>
<a href="#l52.9"></a><span id="l52.9" class="difflineplus">+</span>
<a href="#l52.10"></a><span id="l52.10" class="difflineplus">+// The definitions are common, so just re-use those</span>
<a href="#l52.11"></a><span id="l52.11" class="difflineplus">+load(&quot;test_index_messages_in_bulk.js&quot;);</span>
<a href="#l52.12"></a><span id="l52.12" class="difflineplus">+</span>
<a href="#l52.13"></a><span id="l52.13" class="difflineplus">+var post_test_hook = function imap_post_test_hook() {</span>
<a href="#l52.14"></a><span id="l52.14" class="difflineplus">+  // We're not verifying anything</span>
<a href="#l52.15"></a><span id="l52.15" class="difflineplus">+  imapDownloadAllMessages(indexMessageState.imapInbox, gSynMessages,</span>
<a href="#l52.16"></a><span id="l52.16" class="difflineplus">+                          null, next_test);</span>
<a href="#l52.17"></a><span id="l52.17" class="difflineplus">+};</span>
<a href="#l52.18"></a><span id="l52.18" class="difflineplus">+</span>
<a href="#l52.19"></a><span id="l52.19" class="difflineplus">+// Switch to the IMAP fake server</span>
<a href="#l52.20"></a><span id="l52.20" class="difflineplus">+injectMessagesUsing(INJECT_IMAP_FAKE_SERVER);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l53.1"></a><span id="l53.1" class="difflineminus">--- a/mailnews/db/gloda/test/unit/test_query_core.js</span>
<a href="#l53.2"></a><span id="l53.2" class="difflineplus">+++ b/mailnews/db/gloda/test/unit/test_query_core.js</span>
<a href="#l53.3"></a><span id="l53.3" class="difflineat">@@ -236,17 +236,32 @@ function setup_search_ranking_idiom() {</span>
<a href="#l53.4"></a><span id="l53.4">     new Widget(6, daymore, &quot;&quot;, 0, &quot;&quot;, &quot;bar&quot;), // 1 + 0+</span>
<a href="#l53.5"></a><span id="l53.5">     new Widget(5, origin, &quot;&quot;, 1, &quot;&quot;, &quot;bar&quot;), // 2 + 0</span>
<a href="#l53.6"></a><span id="l53.6">     new Widget(4, daymore, &quot;&quot;, 0, &quot;bar&quot;, &quot;bar&quot;), // 2 + 0+</span>
<a href="#l53.7"></a><span id="l53.7">     new Widget(3, origin, &quot;&quot;, 1, &quot;bar&quot;, &quot;baz&quot;), // 3 + 0</span>
<a href="#l53.8"></a><span id="l53.8">     new Widget(2, monthmore, &quot;&quot;, 0, &quot;&quot;, &quot;bar&quot;), // 1 + 4</span>
<a href="#l53.9"></a><span id="l53.9">     new Widget(1, origin, &quot;&quot;, 0, &quot;bar baz&quot;, &quot;bar baz bar bar&quot;), // 6 + 0</span>
<a href="#l53.10"></a><span id="l53.10">     new Widget(0, origin, &quot;&quot;, 1, &quot;bar baz&quot;, &quot;bar baz bar bar&quot;) // 7 + 0</span>
<a href="#l53.11"></a><span id="l53.11">   ];</span>
<a href="#l53.12"></a><span id="l53.12" class="difflineminus">-  runOnIndexingComplete(next_test);</span>
<a href="#l53.13"></a><span id="l53.13" class="difflineplus">+</span>
<a href="#l53.14"></a><span id="l53.14" class="difflineplus">+  let indexingInProgress = false;</span>
<a href="#l53.15"></a><span id="l53.15" class="difflineplus">+</span>
<a href="#l53.16"></a><span id="l53.16" class="difflineplus">+  // Since we don't use the message indexer listener any more in this test, we</span>
<a href="#l53.17"></a><span id="l53.17" class="difflineplus">+  // need to add our own listener.</span>
<a href="#l53.18"></a><span id="l53.18" class="difflineplus">+  function genericIndexerCallback(aStatus) {</span>
<a href="#l53.19"></a><span id="l53.19" class="difflineplus">+    // If indexingInProgress is false, we've received the synthetic</span>
<a href="#l53.20"></a><span id="l53.20" class="difflineplus">+    // notification, so ignore it</span>
<a href="#l53.21"></a><span id="l53.21" class="difflineplus">+    if (indexingInProgress &amp;&amp; aStatus == Gloda.kIndexerIdle) {</span>
<a href="#l53.22"></a><span id="l53.22" class="difflineplus">+      // We're done, so remove ourselves and move to the next test</span>
<a href="#l53.23"></a><span id="l53.23" class="difflineplus">+      Gloda.removeIndexerListener(genericIndexerCallback);</span>
<a href="#l53.24"></a><span id="l53.24" class="difflineplus">+      next_test();</span>
<a href="#l53.25"></a><span id="l53.25" class="difflineplus">+    }</span>
<a href="#l53.26"></a><span id="l53.26" class="difflineplus">+  }</span>
<a href="#l53.27"></a><span id="l53.27" class="difflineplus">+  Gloda.addIndexerListener(genericIndexerCallback);</span>
<a href="#l53.28"></a><span id="l53.28" class="difflineplus">+  indexingInProgress = true;</span>
<a href="#l53.29"></a><span id="l53.29">   GenericIndexer.indexNewObjects(fooWidgets.concat(barBazWidgets));</span>
<a href="#l53.30"></a><span id="l53.30"> }</span>
<a href="#l53.31"></a><span id="l53.31"> </span>
<a href="#l53.32"></a><span id="l53.32"> // add one because the last snippet shouldn't have a trailing space</span>
<a href="#l53.33"></a><span id="l53.33"> const OFFSET_SCORE_SQL_SNIPPET =</span>
<a href="#l53.34"></a><span id="l53.34">   &quot;(((length(osets) + 1) / &quot; + OFFSET_CHARS_PER_FULLTEXT_MATCH + &quot;) * &quot; +</span>
<a href="#l53.35"></a><span id="l53.35">   SCORE_FOR_FULLTEXT_MATCH + &quot;)&quot;;</span>
<a href="#l53.36"></a><span id="l53.36"> </span>
<a href="#l53.37"></a><span id="l53.37" class="difflineat">@@ -312,12 +327,11 @@ var tests = [</span>
<a href="#l53.38"></a><span id="l53.38">   setup_test_noun_and_attributes,</span>
<a href="#l53.39"></a><span id="l53.39">   test_lots_of_string_constraints,</span>
<a href="#l53.40"></a><span id="l53.40">   setup_search_ranking_idiom,</span>
<a href="#l53.41"></a><span id="l53.41">   test_search_ranking_idiom_offsets,</span>
<a href="#l53.42"></a><span id="l53.42">   test_search_ranking_idiom_score,</span>
<a href="#l53.43"></a><span id="l53.43"> ];</span>
<a href="#l53.44"></a><span id="l53.44"> </span>
<a href="#l53.45"></a><span id="l53.45"> function run_test() {</span>
<a href="#l53.46"></a><span id="l53.46" class="difflineminus">-  // use mbox injection so we get multiple folders...</span>
<a href="#l53.47"></a><span id="l53.47" class="difflineminus">-  injectMessagesUsing(INJECT_MBOX);</span>
<a href="#l53.48"></a><span id="l53.48" class="difflineminus">-  glodaHelperRunTests(tests);</span>
<a href="#l53.49"></a><span id="l53.49" class="difflineplus">+  // Don't initialize the index message state</span>
<a href="#l53.50"></a><span id="l53.50" class="difflineplus">+  glodaHelperRunTests(tests, null, true);</span>
<a href="#l53.51"></a><span id="l53.51"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l54.1"></a><span id="l54.1" class="difflineminus">--- a/mailnews/db/gloda/test/unit/test_query_messages.js</span>
<a href="#l54.2"></a><span id="l54.2" class="difflineplus">+++ b/mailnews/db/gloda/test/unit/test_query_messages.js</span>
<a href="#l54.3"></a><span id="l54.3" class="difflineat">@@ -17,16 +17,22 @@</span>
<a href="#l54.4"></a><span id="l54.4"> </span>
<a href="#l54.5"></a><span id="l54.5"> load(&quot;../../mailnews/resources/messageGenerator.js&quot;);</span>
<a href="#l54.6"></a><span id="l54.6"> load(&quot;resources/glodaTestHelper.js&quot;);</span>
<a href="#l54.7"></a><span id="l54.7"> </span>
<a href="#l54.8"></a><span id="l54.8"> // Create a message generator</span>
<a href="#l54.9"></a><span id="l54.9"> var msgGen = new MessageGenerator();</span>
<a href="#l54.10"></a><span id="l54.10"> // Create a message scenario generator using that message generator</span>
<a href="#l54.11"></a><span id="l54.11"> var scenarios = new MessageScenarioFactory(msgGen);</span>
<a href="#l54.12"></a><span id="l54.12" class="difflineplus">+// Whether we're using a single folder to test. We need to skip a few tests if</span>
<a href="#l54.13"></a><span id="l54.13" class="difflineplus">+// we're doing so</span>
<a href="#l54.14"></a><span id="l54.14" class="difflineplus">+var singleFolder = false;</span>
<a href="#l54.15"></a><span id="l54.15" class="difflineplus">+// Whether we expect fulltext results. IMAP folders that are offline shouldn't</span>
<a href="#l54.16"></a><span id="l54.16" class="difflineplus">+// have their bodies indexed.</span>
<a href="#l54.17"></a><span id="l54.17" class="difflineplus">+var expectFulltextResults = true;</span>
<a href="#l54.18"></a><span id="l54.18"> </span>
<a href="#l54.19"></a><span id="l54.19"> /* ===== Populate ===== */</span>
<a href="#l54.20"></a><span id="l54.20"> var world = {</span>
<a href="#l54.21"></a><span id="l54.21">   phase: 0,</span>
<a href="#l54.22"></a><span id="l54.22"> </span>
<a href="#l54.23"></a><span id="l54.23">   // a list of tuples of [name, email] of length NUM_AUTHORS</span>
<a href="#l54.24"></a><span id="l54.24">   peoples: null,</span>
<a href="#l54.25"></a><span id="l54.25">   NUM_AUTHORS: 5,</span>
<a href="#l54.26"></a><span id="l54.26" class="difflineat">@@ -196,38 +202,56 @@ function generateFolderMessages() {</span>
<a href="#l54.27"></a><span id="l54.27"> function glodaInfoStasher(aSynthMessage, aGlodaMessage) {</span>
<a href="#l54.28"></a><span id="l54.28">   if (aSynthMessage.iConvo !== undefined)</span>
<a href="#l54.29"></a><span id="l54.29">     world.glodaConversationIds[aSynthMessage.iConvo] =</span>
<a href="#l54.30"></a><span id="l54.30">       aGlodaMessage.conversation.id;</span>
<a href="#l54.31"></a><span id="l54.31">   if (world.glodaFolders.length &lt;= world.phase)</span>
<a href="#l54.32"></a><span id="l54.32">     world.glodaFolders.push(aGlodaMessage.folder);</span>
<a href="#l54.33"></a><span id="l54.33"> }</span>
<a href="#l54.34"></a><span id="l54.34"> </span>
<a href="#l54.35"></a><span id="l54.35" class="difflineplus">+// We override these for the IMAP tests</span>
<a href="#l54.36"></a><span id="l54.36" class="difflineplus">+var pre_setup_populate_hook = function default_pre_setup_populate_hook() {</span>
<a href="#l54.37"></a><span id="l54.37" class="difflineplus">+  next_test();</span>
<a href="#l54.38"></a><span id="l54.38" class="difflineplus">+};</span>
<a href="#l54.39"></a><span id="l54.39" class="difflineplus">+var post_setup_populate_hook = function default_post_setup_populate_hook() {</span>
<a href="#l54.40"></a><span id="l54.40" class="difflineplus">+  next_test();</span>
<a href="#l54.41"></a><span id="l54.41" class="difflineplus">+};</span>
<a href="#l54.42"></a><span id="l54.42" class="difflineplus">+</span>
<a href="#l54.43"></a><span id="l54.43" class="difflineplus">+var gSynMessages = [];</span>
<a href="#l54.44"></a><span id="l54.44"> // first, we must populate our message store with delicious messages.</span>
<a href="#l54.45"></a><span id="l54.45"> function setup_populate() {</span>
<a href="#l54.46"></a><span id="l54.46">   world.glodaHolderCollection = Gloda.explicitCollection(Gloda.NOUN_MESSAGE,</span>
<a href="#l54.47"></a><span id="l54.47">     []);</span>
<a href="#l54.48"></a><span id="l54.48"> </span>
<a href="#l54.49"></a><span id="l54.49">   world.peoples = msgGen.makeNamesAndAddresses(world.NUM_AUTHORS);</span>
<a href="#l54.50"></a><span id="l54.50">   world.outlierAuthor = msgGen.makeNameAndAddress();</span>
<a href="#l54.51"></a><span id="l54.51">   world.outlierFriend = msgGen.makeNameAndAddress();</span>
<a href="#l54.52"></a><span id="l54.52">   // set up the per-conversation values with blanks initially</span>
<a href="#l54.53"></a><span id="l54.53">   for (let iConvo = 0; iConvo &lt; world.NUM_CONVERSATIONS; iConvo++) {</span>
<a href="#l54.54"></a><span id="l54.54">     world.lastMessagesInConvos.push(null);</span>
<a href="#l54.55"></a><span id="l54.55">     world.conversationLists.push([]);</span>
<a href="#l54.56"></a><span id="l54.56">     world.glodaConversationIds.push(null);</span>
<a href="#l54.57"></a><span id="l54.57">   }</span>
<a href="#l54.58"></a><span id="l54.58"> </span>
<a href="#l54.59"></a><span id="l54.59" class="difflineminus">-  indexMessages(generateFolderMessages(), glodaInfoStasher,</span>
<a href="#l54.60"></a><span id="l54.60" class="difflineminus">-                setup_populate_phase_two);</span>
<a href="#l54.61"></a><span id="l54.61" class="difflineplus">+  let messages = generateFolderMessages();</span>
<a href="#l54.62"></a><span id="l54.62" class="difflineplus">+  gSynMessages = gSynMessages.concat(messages);</span>
<a href="#l54.63"></a><span id="l54.63" class="difflineplus">+  indexMessages(messages, glodaInfoStasher, setup_populate_phase_two);</span>
<a href="#l54.64"></a><span id="l54.64"> }</span>
<a href="#l54.65"></a><span id="l54.65"> </span>
<a href="#l54.66"></a><span id="l54.66"> function setup_populate_phase_two() {</span>
<a href="#l54.67"></a><span id="l54.67" class="difflineminus">-  world.phase++;</span>
<a href="#l54.68"></a><span id="l54.68" class="difflineminus">-  indexMessages(generateFolderMessages(), glodaInfoStasher, next_test);</span>
<a href="#l54.69"></a><span id="l54.69" class="difflineplus">+  // If we have one folder, we don't attempt to populate the other one</span>
<a href="#l54.70"></a><span id="l54.70" class="difflineplus">+  if (singleFolder) {</span>
<a href="#l54.71"></a><span id="l54.71" class="difflineplus">+    next_test();</span>
<a href="#l54.72"></a><span id="l54.72" class="difflineplus">+  }</span>
<a href="#l54.73"></a><span id="l54.73" class="difflineplus">+  else {</span>
<a href="#l54.74"></a><span id="l54.74" class="difflineplus">+    world.phase++;</span>
<a href="#l54.75"></a><span id="l54.75" class="difflineplus">+    let messages = generateFolderMessages();</span>
<a href="#l54.76"></a><span id="l54.76" class="difflineplus">+    gSynMessages = gSynMessages.concat(messages);</span>
<a href="#l54.77"></a><span id="l54.77" class="difflineplus">+    indexMessages(messages, glodaInfoStasher, next_test);</span>
<a href="#l54.78"></a><span id="l54.78" class="difflineplus">+  }</span>
<a href="#l54.79"></a><span id="l54.79"> }</span>
<a href="#l54.80"></a><span id="l54.80"> </span>
<a href="#l54.81"></a><span id="l54.81"> /* ===== Non-text queries ===== */</span>
<a href="#l54.82"></a><span id="l54.82"> </span>
<a href="#l54.83"></a><span id="l54.83"> /* === messages === */</span>
<a href="#l54.84"></a><span id="l54.84"> </span>
<a href="#l54.85"></a><span id="l54.85"> /**</span>
<a href="#l54.86"></a><span id="l54.86">  * Takes a list of mutually exclusive queries and a list of the resulting</span>
<a href="#l54.87"></a><span id="l54.87" class="difflineat">@@ -289,30 +313,38 @@ function test_query_messages_by_conversa</span>
<a href="#l54.88"></a><span id="l54.88"> var ts_folderNum = 0;</span>
<a href="#l54.89"></a><span id="l54.89"> var ts_folderQueries = [];</span>
<a href="#l54.90"></a><span id="l54.90"> var ts_folderCollections = [];</span>
<a href="#l54.91"></a><span id="l54.91"> /**</span>
<a href="#l54.92"></a><span id="l54.92">  * @tests gloda.noun.message.attr.folder</span>
<a href="#l54.93"></a><span id="l54.93">  * @tests gloda.datastore.sqlgen.kConstraintIn</span>
<a href="#l54.94"></a><span id="l54.94">  */</span>
<a href="#l54.95"></a><span id="l54.95"> function test_query_messages_by_folder() {</span>
<a href="#l54.96"></a><span id="l54.96" class="difflineplus">+  // If we have one folder to test with, we can't do this test more times</span>
<a href="#l54.97"></a><span id="l54.97" class="difflineplus">+  if (singleFolder &amp;&amp; ts_folderNum &gt;= 1) {</span>
<a href="#l54.98"></a><span id="l54.98" class="difflineplus">+    next_test();</span>
<a href="#l54.99"></a><span id="l54.99" class="difflineplus">+    return;</span>
<a href="#l54.100"></a><span id="l54.100" class="difflineplus">+  }</span>
<a href="#l54.101"></a><span id="l54.101" class="difflineplus">+</span>
<a href="#l54.102"></a><span id="l54.102">   let folderNum = ts_folderNum++;</span>
<a href="#l54.103"></a><span id="l54.103">   let query = Gloda.newQuery(Gloda.NOUN_MESSAGE);</span>
<a href="#l54.104"></a><span id="l54.104">   query.folder(world.glodaFolders[folderNum]);</span>
<a href="#l54.105"></a><span id="l54.105"> </span>
<a href="#l54.106"></a><span id="l54.106">   ts_folderQueries.push(query);</span>
<a href="#l54.107"></a><span id="l54.107">   ts_folderCollections.push(queryExpect(query, world.folderClumps[folderNum]));</span>
<a href="#l54.108"></a><span id="l54.108">   // queryExpect calls next_test</span>
<a href="#l54.109"></a><span id="l54.109"> }</span>
<a href="#l54.110"></a><span id="l54.110"> </span>
<a href="#l54.111"></a><span id="l54.111"> /**</span>
<a href="#l54.112"></a><span id="l54.112">  * @tests gloda.query.test.kConstraintIn</span>
<a href="#l54.113"></a><span id="l54.113">  */</span>
<a href="#l54.114"></a><span id="l54.114"> function test_query_messages_by_folder_nonmatches() {</span>
<a href="#l54.115"></a><span id="l54.115" class="difflineminus">-  verify_nonMatches(ts_folderQueries, ts_folderCollections);</span>
<a href="#l54.116"></a><span id="l54.116" class="difflineplus">+  // No can do with one folder</span>
<a href="#l54.117"></a><span id="l54.117" class="difflineplus">+  if (!singleFolder)</span>
<a href="#l54.118"></a><span id="l54.118" class="difflineplus">+    verify_nonMatches(ts_folderQueries, ts_folderCollections);</span>
<a href="#l54.119"></a><span id="l54.119">   next_test();</span>
<a href="#l54.120"></a><span id="l54.120"> }</span>
<a href="#l54.121"></a><span id="l54.121"> </span>
<a href="#l54.122"></a><span id="l54.122"> /**</span>
<a href="#l54.123"></a><span id="l54.123">  * @tests Gloda.ns.getMessageCollectionForHeader()</span>
<a href="#l54.124"></a><span id="l54.124">  */</span>
<a href="#l54.125"></a><span id="l54.125"> function test_get_message_for_header() {</span>
<a href="#l54.126"></a><span id="l54.126">   // pick an arbitrary message</span>
<a href="#l54.127"></a><span id="l54.127" class="difflineat">@@ -453,32 +485,34 @@ dump(&quot;convNum: &quot; + convNum + &quot; blah: &quot; +</span>
<a href="#l54.128"></a><span id="l54.128">  */</span>
<a href="#l54.129"></a><span id="l54.129"> function test_query_messages_by_body_text() {</span>
<a href="#l54.130"></a><span id="l54.130">   // we only need to use one conversation</span>
<a href="#l54.131"></a><span id="l54.131">   let convNum = 0;</span>
<a href="#l54.132"></a><span id="l54.132">   let query = Gloda.newQuery(Gloda.NOUN_MESSAGE);</span>
<a href="#l54.133"></a><span id="l54.133">   let convBodyTerm = uniqueTermGenerator(</span>
<a href="#l54.134"></a><span id="l54.134">     UNIQUE_OFFSET_BODY + UNIQUE_OFFSET_CONV + convNum);</span>
<a href="#l54.135"></a><span id="l54.135">   query.bodyMatches(convBodyTerm);</span>
<a href="#l54.136"></a><span id="l54.136" class="difflineminus">-  queryExpect(query, world.conversationLists[convNum]); // calls next_test</span>
<a href="#l54.137"></a><span id="l54.137" class="difflineplus">+  queryExpect(query, expectFulltextResults ? world.conversationLists[convNum] :</span>
<a href="#l54.138"></a><span id="l54.138" class="difflineplus">+                                             []); // calls next_test</span>
<a href="#l54.139"></a><span id="l54.139"> }</span>
<a href="#l54.140"></a><span id="l54.140"> </span>
<a href="#l54.141"></a><span id="l54.141"> /**</span>
<a href="#l54.142"></a><span id="l54.142">  * Test attachment name searching using the conversation unique attachment term.</span>
<a href="#l54.143"></a><span id="l54.143">  *</span>
<a href="#l54.144"></a><span id="l54.144">  * @tests gloda.noun.message.attr.attachmentNamesMatch</span>
<a href="#l54.145"></a><span id="l54.145">  * @tests gloda.datastore.sqlgen.kConstraintFulltext</span>
<a href="#l54.146"></a><span id="l54.146">  */</span>
<a href="#l54.147"></a><span id="l54.147"> function test_query_messages_by_attachment_names() {</span>
<a href="#l54.148"></a><span id="l54.148">   let convNum = 0;</span>
<a href="#l54.149"></a><span id="l54.149">   let query = Gloda.newQuery(Gloda.NOUN_MESSAGE);</span>
<a href="#l54.150"></a><span id="l54.150">   let convUniqueAttachment = uniqueTermGenerator(</span>
<a href="#l54.151"></a><span id="l54.151">     UNIQUE_OFFSET_ATTACHMENT + UNIQUE_OFFSET_CONV + convNum);</span>
<a href="#l54.152"></a><span id="l54.152">   query.attachmentNamesMatch(convUniqueAttachment);</span>
<a href="#l54.153"></a><span id="l54.153" class="difflineminus">-  queryExpect(query, world.conversationLists[convNum]); // calls next_test</span>
<a href="#l54.154"></a><span id="l54.154" class="difflineplus">+  queryExpect(query, expectFulltextResults ? world.conversationLists[convNum] :</span>
<a href="#l54.155"></a><span id="l54.155" class="difflineplus">+                                             []); // calls next_test</span>
<a href="#l54.156"></a><span id="l54.156"> }</span>
<a href="#l54.157"></a><span id="l54.157"> </span>
<a href="#l54.158"></a><span id="l54.158"> /**</span>
<a href="#l54.159"></a><span id="l54.159">  * Test author name fulltext searching using an arbitrary author.</span>
<a href="#l54.160"></a><span id="l54.160">  *</span>
<a href="#l54.161"></a><span id="l54.161">  * @tests gloda.noun.message.attr.authorMatches</span>
<a href="#l54.162"></a><span id="l54.162">  * @tests gloda.datastore.sqlgen.kConstraintFulltext</span>
<a href="#l54.163"></a><span id="l54.163">  */</span>
<a href="#l54.164"></a><span id="l54.164" class="difflineat">@@ -590,17 +624,19 @@ function test_query_identities_by_kind_a</span>
<a href="#l54.165"></a><span id="l54.165">                     [peoplesIdentityCollection, outlierIdentityCollection]);</span>
<a href="#l54.166"></a><span id="l54.166">   next_test();</span>
<a href="#l54.167"></a><span id="l54.167"> }</span>
<a href="#l54.168"></a><span id="l54.168"> </span>
<a href="#l54.169"></a><span id="l54.169"> </span>
<a href="#l54.170"></a><span id="l54.170"> /* ===== Driver ===== */</span>
<a href="#l54.171"></a><span id="l54.171"> </span>
<a href="#l54.172"></a><span id="l54.172"> var tests = [</span>
<a href="#l54.173"></a><span id="l54.173" class="difflineplus">+  function pre_setup_populate() { pre_setup_populate_hook(); },</span>
<a href="#l54.174"></a><span id="l54.174">   setup_populate,</span>
<a href="#l54.175"></a><span id="l54.175" class="difflineplus">+  function post_setup_populate() { post_setup_populate_hook(); },</span>
<a href="#l54.176"></a><span id="l54.176">   test_query_messages_by_conversation,</span>
<a href="#l54.177"></a><span id="l54.177">   test_query_messages_by_conversation,</span>
<a href="#l54.178"></a><span id="l54.178">   test_query_messages_by_conversation_nonmatches,</span>
<a href="#l54.179"></a><span id="l54.179">   test_query_messages_by_folder,</span>
<a href="#l54.180"></a><span id="l54.180">   test_query_messages_by_folder,</span>
<a href="#l54.181"></a><span id="l54.181">   test_query_messages_by_folder_nonmatches,</span>
<a href="#l54.182"></a><span id="l54.182">   test_get_message_for_header,</span>
<a href="#l54.183"></a><span id="l54.183">   test_get_messages_for_headers,</span>
<a href="#l54.184"></a><span id="l54.184" class="difflineat">@@ -624,12 +660,13 @@ var tests = [</span>
<a href="#l54.185"></a><span id="l54.185">   test_query_messages_by_recipients_name,</span>
<a href="#l54.186"></a><span id="l54.186">   test_query_messages_by_recipients_email,</span>
<a href="#l54.187"></a><span id="l54.187">   // like</span>
<a href="#l54.188"></a><span id="l54.188">   test_query_contacts_by_name,</span>
<a href="#l54.189"></a><span id="l54.189">   test_query_contacts_by_name_nonmatch</span>
<a href="#l54.190"></a><span id="l54.190"> ];</span>
<a href="#l54.191"></a><span id="l54.191"> </span>
<a href="#l54.192"></a><span id="l54.192"> function run_test() {</span>
<a href="#l54.193"></a><span id="l54.193" class="difflineminus">-  // use mbox injection so we get multiple folders...</span>
<a href="#l54.194"></a><span id="l54.194" class="difflineminus">-  injectMessagesUsing(INJECT_MBOX);</span>
<a href="#l54.195"></a><span id="l54.195">   glodaHelperRunTests(tests);</span>
<a href="#l54.196"></a><span id="l54.196"> }</span>
<a href="#l54.197"></a><span id="l54.197" class="difflineplus">+</span>
<a href="#l54.198"></a><span id="l54.198" class="difflineplus">+// use mbox injection so we get multiple folders...</span>
<a href="#l54.199"></a><span id="l54.199" class="difflineplus">+injectMessagesUsing(INJECT_MBOX);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l55.1"></a><span id="l55.1">new file mode 100644</span>
<a href="#l55.2"></a><span id="l55.2" class="difflineminus">--- /dev/null</span>
<a href="#l55.3"></a><span id="l55.3" class="difflineplus">+++ b/mailnews/db/gloda/test/unit/test_query_non_offline_imap_messages.js</span>
<a href="#l55.4"></a><span id="l55.4" class="difflineat">@@ -0,0 +1,10 @@</span>
<a href="#l55.5"></a><span id="l55.5" class="difflineplus">+/* -*- Mode: JavaScript; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l55.6"></a><span id="l55.6" class="difflineplus">+/**</span>
<a href="#l55.7"></a><span id="l55.7" class="difflineplus">+ * Test query support for IMAP messages that aren't offline.</span>
<a href="#l55.8"></a><span id="l55.8" class="difflineplus">+ */</span>
<a href="#l55.9"></a><span id="l55.9" class="difflineplus">+load(&quot;test_query_messages.js&quot;);</span>
<a href="#l55.10"></a><span id="l55.10" class="difflineplus">+</span>
<a href="#l55.11"></a><span id="l55.11" class="difflineplus">+var expectFulltextResults = false;</span>
<a href="#l55.12"></a><span id="l55.12" class="difflineplus">+// TODO: Make this use multiple folders, like the local folders test</span>
<a href="#l55.13"></a><span id="l55.13" class="difflineplus">+var singleFolder = true;</span>
<a href="#l55.14"></a><span id="l55.14" class="difflineplus">+injectMessagesUsing(INJECT_IMAP_FAKE_SERVER);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l56.1"></a><span id="l56.1">new file mode 100644</span>
<a href="#l56.2"></a><span id="l56.2" class="difflineminus">--- /dev/null</span>
<a href="#l56.3"></a><span id="l56.3" class="difflineplus">+++ b/mailnews/db/gloda/test/unit/test_query_originally_offline_imap_messages.js</span>
<a href="#l56.4"></a><span id="l56.4" class="difflineat">@@ -0,0 +1,16 @@</span>
<a href="#l56.5"></a><span id="l56.5" class="difflineplus">+/* -*- Mode: JavaScript; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l56.6"></a><span id="l56.6" class="difflineplus">+/**</span>
<a href="#l56.7"></a><span id="l56.7" class="difflineplus">+ * Test query support for IMAP messages that were offline before they were</span>
<a href="#l56.8"></a><span id="l56.8" class="difflineplus">+ * indexed.</span>
<a href="#l56.9"></a><span id="l56.9" class="difflineplus">+ */</span>
<a href="#l56.10"></a><span id="l56.10" class="difflineplus">+load(&quot;test_query_messages.js&quot;);</span>
<a href="#l56.11"></a><span id="l56.11" class="difflineplus">+</span>
<a href="#l56.12"></a><span id="l56.12" class="difflineplus">+// Set the inbox to offline before proceeding</span>
<a href="#l56.13"></a><span id="l56.13" class="difflineplus">+var pre_setup_populate_hook = function imap_pre_setup_populate_hook() {</span>
<a href="#l56.14"></a><span id="l56.14" class="difflineplus">+  indexMessageState.imapInbox.setFlag(Ci.nsMsgFolderFlags.Offline);</span>
<a href="#l56.15"></a><span id="l56.15" class="difflineplus">+  next_test();</span>
<a href="#l56.16"></a><span id="l56.16" class="difflineplus">+};</span>
<a href="#l56.17"></a><span id="l56.17" class="difflineplus">+</span>
<a href="#l56.18"></a><span id="l56.18" class="difflineplus">+// TODO: Make this use multiple folders, like the local folders test</span>
<a href="#l56.19"></a><span id="l56.19" class="difflineplus">+var singleFolder = true;</span>
<a href="#l56.20"></a><span id="l56.20" class="difflineplus">+injectMessagesUsing(INJECT_IMAP_FAKE_SERVER);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l57.1"></a><span id="l57.1">new file mode 100644</span>
<a href="#l57.2"></a><span id="l57.2" class="difflineminus">--- /dev/null</span>
<a href="#l57.3"></a><span id="l57.3" class="difflineplus">+++ b/mailnews/db/gloda/test/unit/test_query_switched_to_offline_imap_messages.js</span>
<a href="#l57.4"></a><span id="l57.4" class="difflineat">@@ -0,0 +1,19 @@</span>
<a href="#l57.5"></a><span id="l57.5" class="difflineplus">+/* -*- Mode: JavaScript; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l57.6"></a><span id="l57.6" class="difflineplus">+/**</span>
<a href="#l57.7"></a><span id="l57.7" class="difflineplus">+ * Test query support for IMAP messages that were indexed, then made available</span>
<a href="#l57.8"></a><span id="l57.8" class="difflineplus">+ * offline.</span>
<a href="#l57.9"></a><span id="l57.9" class="difflineplus">+ */</span>
<a href="#l57.10"></a><span id="l57.10" class="difflineplus">+load(&quot;test_query_messages.js&quot;);</span>
<a href="#l57.11"></a><span id="l57.11" class="difflineplus">+</span>
<a href="#l57.12"></a><span id="l57.12" class="difflineplus">+/**</span>
<a href="#l57.13"></a><span id="l57.13" class="difflineplus">+ * Set the imap folder to offline after adding the messages, then force a</span>
<a href="#l57.14"></a><span id="l57.14" class="difflineplus">+ * download of all messages.</span>
<a href="#l57.15"></a><span id="l57.15" class="difflineplus">+ */</span>
<a href="#l57.16"></a><span id="l57.16" class="difflineplus">+var post_setup_populate_hook = function imap_post_setup_populate_hook() {</span>
<a href="#l57.17"></a><span id="l57.17" class="difflineplus">+  imapDownloadAllMessages(indexMessageState.imapInbox, gSynMessages, null,</span>
<a href="#l57.18"></a><span id="l57.18" class="difflineplus">+                          next_test);</span>
<a href="#l57.19"></a><span id="l57.19" class="difflineplus">+};</span>
<a href="#l57.20"></a><span id="l57.20" class="difflineplus">+</span>
<a href="#l57.21"></a><span id="l57.21" class="difflineplus">+// TODO: Make this use multiple folders, like the local folders test</span>
<a href="#l57.22"></a><span id="l57.22" class="difflineplus">+var singleFolder = true;</span>
<a href="#l57.23"></a><span id="l57.23" class="difflineplus">+injectMessagesUsing(INJECT_IMAP_FAKE_SERVER);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l58.1"></a><span id="l58.1" class="difflineminus">--- a/mailnews/db/msgdb/public/nsIMsgDatabase.idl</span>
<a href="#l58.2"></a><span id="l58.2" class="difflineplus">+++ b/mailnews/db/msgdb/public/nsIMsgDatabase.idl</span>
<a href="#l58.3"></a><span id="l58.3" class="difflineat">@@ -237,17 +237,17 @@ interface nsIMsgDBService : nsISupports</span>
<a href="#l58.4"></a><span id="l58.4">    *</span>
<a href="#l58.5"></a><span id="l58.5">    * @param aFolder   The folder to get the cached (open) db for.</span>
<a href="#l58.6"></a><span id="l58.6">    *</span>
<a href="#l58.7"></a><span id="l58.7">    * @returns         null if the db isn't open, otherwise the db.</span>
<a href="#l58.8"></a><span id="l58.8">    */</span>
<a href="#l58.9"></a><span id="l58.9">   nsIMsgDatabase cachedDBForFolder(in nsIMsgFolder aFolder);</span>
<a href="#l58.10"></a><span id="l58.10"> };</span>
<a href="#l58.11"></a><span id="l58.11"> </span>
<a href="#l58.12"></a><span id="l58.12" class="difflineminus">-[scriptable, uuid(51fd11c9-5be6-4cad-af6b-fb18d6232be4)]</span>
<a href="#l58.13"></a><span id="l58.13" class="difflineplus">+[scriptable, uuid(231E3473-DA59-4d18-AD54-F5A9D24AE3FC)]</span>
<a href="#l58.14"></a><span id="l58.14"> interface nsIMsgDatabase : nsIDBChangeAnnouncer {</span>
<a href="#l58.15"></a><span id="l58.15">   /**</span>
<a href="#l58.16"></a><span id="l58.16">    * Opens a database folder.</span>
<a href="#l58.17"></a><span id="l58.17">    *</span>
<a href="#l58.18"></a><span id="l58.18">    * @param aFolderName     The name of the folder to create.</span>
<a href="#l58.19"></a><span id="l58.19">    * @param aCreate         Whether or not the file should be created.</span>
<a href="#l58.20"></a><span id="l58.20">    * @param aLeaveInvalidDB Set to true if you do not want the database to be</span>
<a href="#l58.21"></a><span id="l58.21">    *                        deleted if it is invalid.</span>
<a href="#l58.22"></a><span id="l58.22" class="difflineat">@@ -338,16 +338,24 @@ interface nsIMsgDatabase : nsIDBChangeAn</span>
<a href="#l58.23"></a><span id="l58.23">   void MarkHdrRead(in nsIMsgDBHdr msgHdr, in boolean bRead,</span>
<a href="#l58.24"></a><span id="l58.24">                          in nsIDBChangeListener instigator);</span>
<a href="#l58.25"></a><span id="l58.25"> </span>
<a href="#l58.26"></a><span id="l58.26">   void MarkHdrReplied(in nsIMsgDBHdr msgHdr, in boolean bReplied,</span>
<a href="#l58.27"></a><span id="l58.27">                          in nsIDBChangeListener instigator);</span>
<a href="#l58.28"></a><span id="l58.28"> </span>
<a href="#l58.29"></a><span id="l58.29">   void MarkHdrMarked(in nsIMsgDBHdr msgHdr, in boolean mark,</span>
<a href="#l58.30"></a><span id="l58.30">                          in nsIDBChangeListener instigator);</span>
<a href="#l58.31"></a><span id="l58.31" class="difflineplus">+  /**</span>
<a href="#l58.32"></a><span id="l58.32" class="difflineplus">+   * Remove the new status from a message.</span>
<a href="#l58.33"></a><span id="l58.33" class="difflineplus">+   *</span>
<a href="#l58.34"></a><span id="l58.34" class="difflineplus">+   * @param aMsgHdr        The database reference header for the message</span>
<a href="#l58.35"></a><span id="l58.35" class="difflineplus">+   * @param aInstigator    Reference to original calling object</span>
<a href="#l58.36"></a><span id="l58.36" class="difflineplus">+   */</span>
<a href="#l58.37"></a><span id="l58.37" class="difflineplus">+  void MarkHdrNotNew(in nsIMsgDBHdr aMsgHdr,</span>
<a href="#l58.38"></a><span id="l58.38" class="difflineplus">+                     in nsIDBChangeListener aInstigator);</span>
<a href="#l58.39"></a><span id="l58.39"> </span>
<a href="#l58.40"></a><span id="l58.40">   // MDN support</span>
<a href="#l58.41"></a><span id="l58.41">   void MarkMDNNeeded(in nsMsgKey key, in boolean bNeeded,</span>
<a href="#l58.42"></a><span id="l58.42">                            in nsIDBChangeListener instigator);</span>
<a href="#l58.43"></a><span id="l58.43"> </span>
<a href="#l58.44"></a><span id="l58.44">   // MarkMDNneeded only used when mail server is a POP3 server</span>
<a href="#l58.45"></a><span id="l58.45">   // or when the IMAP server does not support user defined</span>
<a href="#l58.46"></a><span id="l58.46">   // PERMANENTFLAGS</span>
<a href="#l58.47"></a><span id="l58.47" class="difflineat">@@ -402,25 +410,35 @@ interface nsIMsgDatabase : nsIDBChangeAn</span>
<a href="#l58.48"></a><span id="l58.48">   void UndoDelete(in nsIMsgDBHdr msgHdr);</span>
<a href="#l58.49"></a><span id="l58.49"> </span>
<a href="#l58.50"></a><span id="l58.50">   void MarkMarked(in nsMsgKey key, in boolean mark,</span>
<a href="#l58.51"></a><span id="l58.51">                         in nsIDBChangeListener instigator);</span>
<a href="#l58.52"></a><span id="l58.52">   void MarkOffline(in nsMsgKey key, in boolean offline,</span>
<a href="#l58.53"></a><span id="l58.53">                          in nsIDBChangeListener instigator);</span>
<a href="#l58.54"></a><span id="l58.54">   void SetLabel(in nsMsgKey key, in nsMsgLabelValue label);</span>
<a href="#l58.55"></a><span id="l58.55">   void setStringProperty(in nsMsgKey aKey, in string aProperty, in string aValue);</span>
<a href="#l58.56"></a><span id="l58.56" class="difflineminus">-  /*</span>
<a href="#l58.57"></a><span id="l58.57" class="difflineplus">+  /**</span>
<a href="#l58.58"></a><span id="l58.58">    * Set the value of a string property in a message header</span>
<a href="#l58.59"></a><span id="l58.59">    *</span>
<a href="#l58.60"></a><span id="l58.60">    * @param msgHdr    Header of the message whose property will be changed</span>
<a href="#l58.61"></a><span id="l58.61">    * @param aProperty the property to change</span>
<a href="#l58.62"></a><span id="l58.62">    * @param aValue    new value for the property</span>
<a href="#l58.63"></a><span id="l58.63">    */</span>
<a href="#l58.64"></a><span id="l58.64">   void setStringPropertyByHdr(in nsIMsgDBHdr msgHdr, in string aProperty, in string aValue);</span>
<a href="#l58.65"></a><span id="l58.65"> </span>
<a href="#l58.66"></a><span id="l58.66" class="difflineplus">+  /**</span>
<a href="#l58.67"></a><span id="l58.67" class="difflineplus">+   * Set the value of a uint32 property in a message header.</span>
<a href="#l58.68"></a><span id="l58.68" class="difflineplus">+   *</span>
<a href="#l58.69"></a><span id="l58.69" class="difflineplus">+   * @param aMsgHdr   header of the message whose property will be changed</span>
<a href="#l58.70"></a><span id="l58.70" class="difflineplus">+   * @param aProperty the property to change</span>
<a href="#l58.71"></a><span id="l58.71" class="difflineplus">+   * @param aValue    new value for the property</span>
<a href="#l58.72"></a><span id="l58.72" class="difflineplus">+   */</span>
<a href="#l58.73"></a><span id="l58.73" class="difflineplus">+  void setUint32PropertyByHdr(in nsIMsgDBHdr aMsgHdr,</span>
<a href="#l58.74"></a><span id="l58.74" class="difflineplus">+                              in string aProperty, in unsigned long aValue);</span>
<a href="#l58.75"></a><span id="l58.75" class="difflineplus">+</span>
<a href="#l58.76"></a><span id="l58.76">   void MarkImapDeleted(in nsMsgKey key, in boolean deleted,</span>
<a href="#l58.77"></a><span id="l58.77">                              in nsIDBChangeListener instigator);</span>
<a href="#l58.78"></a><span id="l58.78"> </span>
<a href="#l58.79"></a><span id="l58.79">   readonly attribute nsMsgKey FirstNew;</span>
<a href="#l58.80"></a><span id="l58.80"> </span>
<a href="#l58.81"></a><span id="l58.81">   attribute nsIMsgRetentionSettings msgRetentionSettings;</span>
<a href="#l58.82"></a><span id="l58.82">   // purge unwanted message headers and/or bodies. If deleteViaFolder is</span>
<a href="#l58.83"></a><span id="l58.83">   // true, we'll call nsIMsgFolder::DeleteMessages to delete the messages.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l59.1"></a><span id="l59.1" class="difflineminus">--- a/mailnews/db/msgdb/public/nsMsgDatabase.h</span>
<a href="#l59.2"></a><span id="l59.2" class="difflineplus">+++ b/mailnews/db/msgdb/public/nsMsgDatabase.h</span>
<a href="#l59.3"></a><span id="l59.3" class="difflineat">@@ -399,17 +399,16 @@ public:</span>
<a href="#l59.4"></a><span id="l59.4">   virtual ~nsMsgRetentionSettings();</span>
<a href="#l59.5"></a><span id="l59.5"> </span>
<a href="#l59.6"></a><span id="l59.6">   NS_DECL_ISUPPORTS</span>
<a href="#l59.7"></a><span id="l59.7">   NS_DECL_NSIMSGRETENTIONSETTINGS</span>
<a href="#l59.8"></a><span id="l59.8"> protected:</span>
<a href="#l59.9"></a><span id="l59.9">   nsMsgRetainByPreference m_retainByPreference;</span>
<a href="#l59.10"></a><span id="l59.10">   PRUint32                m_daysToKeepHdrs;</span>
<a href="#l59.11"></a><span id="l59.11">   PRUint32                m_numHeadersToKeep;</span>
<a href="#l59.12"></a><span id="l59.12" class="difflineminus">-  PRUint32                m_keepUnreadMessagesProp;</span>
<a href="#l59.13"></a><span id="l59.13">   PRBool                  m_keepUnreadMessagesOnly;</span>
<a href="#l59.14"></a><span id="l59.14">   PRBool                  m_useServerDefaults;</span>
<a href="#l59.15"></a><span id="l59.15">   PRBool                  m_cleanupBodiesByDays;</span>
<a href="#l59.16"></a><span id="l59.16">   PRUint32                m_daysToKeepBodies;</span>
<a href="#l59.17"></a><span id="l59.17">   PRBool                  m_applyToFlaggedMessages;</span>
<a href="#l59.18"></a><span id="l59.18"> };</span>
<a href="#l59.19"></a><span id="l59.19"> </span>
<a href="#l59.20"></a><span id="l59.20"> class nsMsgDownloadSettings : public nsIMsgDownloadSettings</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l60.1"></a><span id="l60.1" class="difflineminus">--- a/mailnews/db/msgdb/src/nsMsgDatabase.cpp</span>
<a href="#l60.2"></a><span id="l60.2" class="difflineplus">+++ b/mailnews/db/msgdb/src/nsMsgDatabase.cpp</span>
<a href="#l60.3"></a><span id="l60.3" class="difflineat">@@ -676,17 +676,30 @@ NS_IMETHODIMP nsMsgDatabase::RemoveListe</span>
<a href="#l60.4"></a><span id="l60.4">   PR_END_MACRO</span>
<a href="#l60.5"></a><span id="l60.5"> </span>
<a href="#l60.6"></a><span id="l60.6"> // change announcer methods - just broadcast to all listeners.</span>
<a href="#l60.7"></a><span id="l60.7"> NS_IMETHODIMP nsMsgDatabase::NotifyHdrChangeAll(nsIMsgDBHdr *aHdrChanged,</span>
<a href="#l60.8"></a><span id="l60.8">                                                 PRUint32 aOldFlags,</span>
<a href="#l60.9"></a><span id="l60.9">                                                 PRUint32 aNewFlags,</span>
<a href="#l60.10"></a><span id="l60.10">                                                 nsIDBChangeListener *aInstigator)</span>
<a href="#l60.11"></a><span id="l60.11"> {</span>
<a href="#l60.12"></a><span id="l60.12" class="difflineminus">-  NOTIFY_LISTENERS(OnHdrFlagsChanged, (aHdrChanged, aOldFlags, aNewFlags, aInstigator));</span>
<a href="#l60.13"></a><span id="l60.13" class="difflineplus">+  // We will only notify the change if the header exists in the database.</span>
<a href="#l60.14"></a><span id="l60.14" class="difflineplus">+  // This allows database functions to be usable in both the case where the</span>
<a href="#l60.15"></a><span id="l60.15" class="difflineplus">+  // header is in the db, or the header is not so no notifications should be</span>
<a href="#l60.16"></a><span id="l60.16" class="difflineplus">+  // given.</span>
<a href="#l60.17"></a><span id="l60.17" class="difflineplus">+  nsMsgKey key;</span>
<a href="#l60.18"></a><span id="l60.18" class="difflineplus">+  PRBool inDb = PR_FALSE;</span>
<a href="#l60.19"></a><span id="l60.19" class="difflineplus">+  if (aHdrChanged)</span>
<a href="#l60.20"></a><span id="l60.20" class="difflineplus">+  {</span>
<a href="#l60.21"></a><span id="l60.21" class="difflineplus">+    aHdrChanged-&gt;GetMessageKey(&amp;key);</span>
<a href="#l60.22"></a><span id="l60.22" class="difflineplus">+    ContainsKey(key, &amp;inDb);</span>
<a href="#l60.23"></a><span id="l60.23" class="difflineplus">+  }</span>
<a href="#l60.24"></a><span id="l60.24" class="difflineplus">+  if (inDb)</span>
<a href="#l60.25"></a><span id="l60.25" class="difflineplus">+    NOTIFY_LISTENERS(OnHdrFlagsChanged,</span>
<a href="#l60.26"></a><span id="l60.26" class="difflineplus">+                     (aHdrChanged, aOldFlags, aNewFlags, aInstigator));</span>
<a href="#l60.27"></a><span id="l60.27">   return NS_OK;</span>
<a href="#l60.28"></a><span id="l60.28"> }</span>
<a href="#l60.29"></a><span id="l60.29"> </span>
<a href="#l60.30"></a><span id="l60.30"> NS_IMETHODIMP nsMsgDatabase::NotifyReadChanged(nsIDBChangeListener *aInstigator)</span>
<a href="#l60.31"></a><span id="l60.31"> {</span>
<a href="#l60.32"></a><span id="l60.32">   NOTIFY_LISTENERS(OnReadChanged, (aInstigator));</span>
<a href="#l60.33"></a><span id="l60.33">   return NS_OK;</span>
<a href="#l60.34"></a><span id="l60.34"> }</span>
<a href="#l60.35"></a><span id="l60.35" class="difflineat">@@ -2181,16 +2194,69 @@ NS_IMETHODIMP nsMsgDatabase::SetStringPr</span>
<a href="#l60.36"></a><span id="l60.36">       listener-&gt;OnHdrPropertyChanged(msgHdr, PR_FALSE, &amp;status, nsnull);</span>
<a href="#l60.37"></a><span id="l60.37">       // ignore errors</span>
<a href="#l60.38"></a><span id="l60.38">     }</span>
<a href="#l60.39"></a><span id="l60.39">   }</span>
<a href="#l60.40"></a><span id="l60.40"> </span>
<a href="#l60.41"></a><span id="l60.41">   return NS_OK;</span>
<a href="#l60.42"></a><span id="l60.42"> }</span>
<a href="#l60.43"></a><span id="l60.43"> </span>
<a href="#l60.44"></a><span id="l60.44" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l60.45"></a><span id="l60.45" class="difflineplus">+nsMsgDatabase::SetUint32PropertyByHdr(nsIMsgDBHdr *aMsgHdr,</span>
<a href="#l60.46"></a><span id="l60.46" class="difflineplus">+                                      const char *aProperty,</span>
<a href="#l60.47"></a><span id="l60.47" class="difflineplus">+                                      PRUint32 aValue)</span>
<a href="#l60.48"></a><span id="l60.48" class="difflineplus">+{</span>
<a href="#l60.49"></a><span id="l60.49" class="difflineplus">+  // If no change to this property, bail out.</span>
<a href="#l60.50"></a><span id="l60.50" class="difflineplus">+  PRUint32 oldValue;</span>
<a href="#l60.51"></a><span id="l60.51" class="difflineplus">+  nsresult rv = aMsgHdr-&gt;GetUint32Property(aProperty, &amp;oldValue);</span>
<a href="#l60.52"></a><span id="l60.52" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l60.53"></a><span id="l60.53" class="difflineplus">+  if (oldValue == aValue)</span>
<a href="#l60.54"></a><span id="l60.54" class="difflineplus">+    return NS_OK;</span>
<a href="#l60.55"></a><span id="l60.55" class="difflineplus">+</span>
<a href="#l60.56"></a><span id="l60.56" class="difflineplus">+  // Don't do notifications if message not yet added to database.</span>
<a href="#l60.57"></a><span id="l60.57" class="difflineplus">+  PRBool notify = PR_TRUE;  </span>
<a href="#l60.58"></a><span id="l60.58" class="difflineplus">+  nsMsgKey key = nsMsgKey_None;</span>
<a href="#l60.59"></a><span id="l60.59" class="difflineplus">+  aMsgHdr-&gt;GetMessageKey(&amp;key);</span>
<a href="#l60.60"></a><span id="l60.60" class="difflineplus">+  ContainsKey(key, &amp;notify);</span>
<a href="#l60.61"></a><span id="l60.61" class="difflineplus">+</span>
<a href="#l60.62"></a><span id="l60.62" class="difflineplus">+  // Precall OnHdrPropertyChanged to store prechange status.</span>
<a href="#l60.63"></a><span id="l60.63" class="difflineplus">+  nsTArray&lt;PRUint32&gt; statusArray(m_ChangeListeners.Length());</span>
<a href="#l60.64"></a><span id="l60.64" class="difflineplus">+  PRUint32 status;</span>
<a href="#l60.65"></a><span id="l60.65" class="difflineplus">+  nsCOMPtr&lt;nsIDBChangeListener&gt; listener;</span>
<a href="#l60.66"></a><span id="l60.66" class="difflineplus">+  if (notify)</span>
<a href="#l60.67"></a><span id="l60.67" class="difflineplus">+  {</span>
<a href="#l60.68"></a><span id="l60.68" class="difflineplus">+    nsTObserverArray&lt;nsCOMPtr&lt;nsIDBChangeListener&gt; &gt;::ForwardIterator listeners(m_ChangeListeners);</span>
<a href="#l60.69"></a><span id="l60.69" class="difflineplus">+    while (listeners.HasMore())</span>
<a href="#l60.70"></a><span id="l60.70" class="difflineplus">+    {</span>
<a href="#l60.71"></a><span id="l60.71" class="difflineplus">+      listener = listeners.GetNext();</span>
<a href="#l60.72"></a><span id="l60.72" class="difflineplus">+      listener-&gt;OnHdrPropertyChanged(aMsgHdr, PR_TRUE, &amp;status, nsnull);</span>
<a href="#l60.73"></a><span id="l60.73" class="difflineplus">+      // Ignore errors, but append element to keep arrays in sync.</span>
<a href="#l60.74"></a><span id="l60.74" class="difflineplus">+      statusArray.AppendElement(status);</span>
<a href="#l60.75"></a><span id="l60.75" class="difflineplus">+    }</span>
<a href="#l60.76"></a><span id="l60.76" class="difflineplus">+  }</span>
<a href="#l60.77"></a><span id="l60.77" class="difflineplus">+</span>
<a href="#l60.78"></a><span id="l60.78" class="difflineplus">+  rv = aMsgHdr-&gt;SetUint32Property(aProperty, aValue);</span>
<a href="#l60.79"></a><span id="l60.79" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l60.80"></a><span id="l60.80" class="difflineplus">+</span>
<a href="#l60.81"></a><span id="l60.81" class="difflineplus">+  // Postcall OnHdrPropertyChanged to process the change.</span>
<a href="#l60.82"></a><span id="l60.82" class="difflineplus">+  if (notify)</span>
<a href="#l60.83"></a><span id="l60.83" class="difflineplus">+  {</span>
<a href="#l60.84"></a><span id="l60.84" class="difflineplus">+    nsTObserverArray&lt;nsCOMPtr&lt;nsIDBChangeListener&gt; &gt;::ForwardIterator listeners(m_ChangeListeners);</span>
<a href="#l60.85"></a><span id="l60.85" class="difflineplus">+    for (PRUint32 i = 0; listeners.HasMore(); i++)</span>
<a href="#l60.86"></a><span id="l60.86" class="difflineplus">+    {</span>
<a href="#l60.87"></a><span id="l60.87" class="difflineplus">+      listener = listeners.GetNext();</span>
<a href="#l60.88"></a><span id="l60.88" class="difflineplus">+      status = statusArray[i];</span>
<a href="#l60.89"></a><span id="l60.89" class="difflineplus">+      listener-&gt;OnHdrPropertyChanged(aMsgHdr, PR_FALSE, &amp;status, nsnull);</span>
<a href="#l60.90"></a><span id="l60.90" class="difflineplus">+      // Ignore errors.</span>
<a href="#l60.91"></a><span id="l60.91" class="difflineplus">+    }</span>
<a href="#l60.92"></a><span id="l60.92" class="difflineplus">+  }</span>
<a href="#l60.93"></a><span id="l60.93" class="difflineplus">+</span>
<a href="#l60.94"></a><span id="l60.94" class="difflineplus">+  return NS_OK;</span>
<a href="#l60.95"></a><span id="l60.95" class="difflineplus">+}</span>
<a href="#l60.96"></a><span id="l60.96" class="difflineplus">+</span>
<a href="#l60.97"></a><span id="l60.97"> NS_IMETHODIMP nsMsgDatabase::SetLabel(nsMsgKey key, nsMsgLabelValue label)</span>
<a href="#l60.98"></a><span id="l60.98"> {</span>
<a href="#l60.99"></a><span id="l60.99">   nsresult rv;</span>
<a href="#l60.100"></a><span id="l60.100">   nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l60.101"></a><span id="l60.101"> </span>
<a href="#l60.102"></a><span id="l60.102">   rv = GetMsgHdrForKey(key, getter_AddRefs(msgHdr));</span>
<a href="#l60.103"></a><span id="l60.103">   if (NS_FAILED(rv) || !msgHdr)</span>
<a href="#l60.104"></a><span id="l60.104">     return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l60.105"></a><span id="l60.105" class="difflineat">@@ -2367,16 +2433,26 @@ NS_IMETHODIMP nsMsgDatabase::MarkHdrRepl</span>
<a href="#l60.106"></a><span id="l60.106"> </span>
<a href="#l60.107"></a><span id="l60.107"> </span>
<a href="#l60.108"></a><span id="l60.108"> NS_IMETHODIMP nsMsgDatabase::MarkHdrMarked(nsIMsgDBHdr *msgHdr, PRBool mark,</span>
<a href="#l60.109"></a><span id="l60.109">                          nsIDBChangeListener *instigator)</span>
<a href="#l60.110"></a><span id="l60.110"> {</span>
<a href="#l60.111"></a><span id="l60.111">   return SetMsgHdrFlag(msgHdr, mark, nsMsgMessageFlags::Marked, instigator);</span>
<a href="#l60.112"></a><span id="l60.112"> }</span>
<a href="#l60.113"></a><span id="l60.113"> </span>
<a href="#l60.114"></a><span id="l60.114" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l60.115"></a><span id="l60.115" class="difflineplus">+nsMsgDatabase::MarkHdrNotNew(nsIMsgDBHdr *aMsgHdr,</span>
<a href="#l60.116"></a><span id="l60.116" class="difflineplus">+                             nsIDBChangeListener *aInstigator)</span>
<a href="#l60.117"></a><span id="l60.117" class="difflineplus">+{</span>
<a href="#l60.118"></a><span id="l60.118" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aMsgHdr);</span>
<a href="#l60.119"></a><span id="l60.119" class="difflineplus">+  nsMsgKey msgKey;</span>
<a href="#l60.120"></a><span id="l60.120" class="difflineplus">+  aMsgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l60.121"></a><span id="l60.121" class="difflineplus">+  m_newSet.RemoveElement(msgKey);</span>
<a href="#l60.122"></a><span id="l60.122" class="difflineplus">+  return SetMsgHdrFlag(aMsgHdr, PR_FALSE, nsMsgMessageFlags::New, aInstigator);</span>
<a href="#l60.123"></a><span id="l60.123" class="difflineplus">+}</span>
<a href="#l60.124"></a><span id="l60.124"> </span>
<a href="#l60.125"></a><span id="l60.125"> NS_IMETHODIMP nsMsgDatabase::MarkAllRead(nsTArray&lt;nsMsgKey&gt; *thoseMarked)</span>
<a href="#l60.126"></a><span id="l60.126"> {</span>
<a href="#l60.127"></a><span id="l60.127">   nsresult    rv;</span>
<a href="#l60.128"></a><span id="l60.128">   nsMsgHdr  *pHeader;</span>
<a href="#l60.129"></a><span id="l60.129"> </span>
<a href="#l60.130"></a><span id="l60.130">   nsCOMPtr &lt;nsISimpleEnumerator&gt; hdrs;</span>
<a href="#l60.131"></a><span id="l60.131">   rv = EnumerateMessages(getter_AddRefs(hdrs));</span>
<a href="#l60.132"></a><span id="l60.132" class="difflineat">@@ -5025,17 +5101,26 @@ nsresult nsMsgDatabase::PurgeExcessMessa</span>
<a href="#l60.133"></a><span id="l60.133">         Commit(nsMsgDBCommitType::kLargeCommit);</span>
<a href="#l60.134"></a><span id="l60.134">     }</span>
<a href="#l60.135"></a><span id="l60.135">   }</span>
<a href="#l60.136"></a><span id="l60.136">   return rv;</span>
<a href="#l60.137"></a><span id="l60.137"> }</span>
<a href="#l60.138"></a><span id="l60.138"> </span>
<a href="#l60.139"></a><span id="l60.139"> NS_IMPL_ISUPPORTS1(nsMsgRetentionSettings, nsIMsgRetentionSettings)</span>
<a href="#l60.140"></a><span id="l60.140"> </span>
<a href="#l60.141"></a><span id="l60.141" class="difflineplus">+// Initialise the member variables to resonable defaults.</span>
<a href="#l60.142"></a><span id="l60.142"> nsMsgRetentionSettings::nsMsgRetentionSettings()</span>
<a href="#l60.143"></a><span id="l60.143" class="difflineplus">+: m_retainByPreference(1),</span>
<a href="#l60.144"></a><span id="l60.144" class="difflineplus">+  m_daysToKeepHdrs(0),</span>
<a href="#l60.145"></a><span id="l60.145" class="difflineplus">+  m_numHeadersToKeep(0),</span>
<a href="#l60.146"></a><span id="l60.146" class="difflineplus">+  m_keepUnreadMessagesOnly(PR_FALSE),</span>
<a href="#l60.147"></a><span id="l60.147" class="difflineplus">+  m_useServerDefaults(PR_TRUE),</span>
<a href="#l60.148"></a><span id="l60.148" class="difflineplus">+  m_cleanupBodiesByDays(PR_FALSE),</span>
<a href="#l60.149"></a><span id="l60.149" class="difflineplus">+  m_daysToKeepBodies(0),</span>
<a href="#l60.150"></a><span id="l60.150" class="difflineplus">+  m_applyToFlaggedMessages(PR_FALSE)</span>
<a href="#l60.151"></a><span id="l60.151"> {</span>
<a href="#l60.152"></a><span id="l60.152"> }</span>
<a href="#l60.153"></a><span id="l60.153"> </span>
<a href="#l60.154"></a><span id="l60.154"> nsMsgRetentionSettings::~nsMsgRetentionSettings()</span>
<a href="#l60.155"></a><span id="l60.155"> {</span>
<a href="#l60.156"></a><span id="l60.156"> }</span>
<a href="#l60.157"></a><span id="l60.157"> </span>
<a href="#l60.158"></a><span id="l60.158"> /* attribute unsigned long retainByPreference */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l61.1"></a><span id="l61.1" class="difflineminus">--- a/mailnews/imap/src/nsImapIncomingServer.cpp</span>
<a href="#l61.2"></a><span id="l61.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapIncomingServer.cpp</span>
<a href="#l61.3"></a><span id="l61.3" class="difflineat">@@ -406,16 +406,28 @@ nsImapIncomingServer::SetIsAOLServer(PRB</span>
<a href="#l61.4"></a><span id="l61.4">   return NS_OK;</span>
<a href="#l61.5"></a><span id="l61.5"> }</span>
<a href="#l61.6"></a><span id="l61.6"> </span>
<a href="#l61.7"></a><span id="l61.7"> NS_IMETHODIMP</span>
<a href="#l61.8"></a><span id="l61.8"> nsImapIncomingServer::GetImapConnectionAndLoadUrl(nsIEventTarget * aClientEventTarget,</span>
<a href="#l61.9"></a><span id="l61.9">                                                   nsIImapUrl* aImapUrl,</span>
<a href="#l61.10"></a><span id="l61.10">                                                   nsISupports* aConsumer)</span>
<a href="#l61.11"></a><span id="l61.11"> {</span>
<a href="#l61.12"></a><span id="l61.12" class="difflineplus">+  // if we're shutting down, and not running the kinds of urls we run at</span>
<a href="#l61.13"></a><span id="l61.13" class="difflineplus">+  // shutdown, then this should fail because running urls during</span>
<a href="#l61.14"></a><span id="l61.14" class="difflineplus">+  // shutdown will very likely fail and potentially hang.</span>
<a href="#l61.15"></a><span id="l61.15" class="difflineplus">+  if (m_shuttingDown)</span>
<a href="#l61.16"></a><span id="l61.16" class="difflineplus">+  {</span>
<a href="#l61.17"></a><span id="l61.17" class="difflineplus">+    nsImapAction imapAction;</span>
<a href="#l61.18"></a><span id="l61.18" class="difflineplus">+    aImapUrl-&gt;GetImapAction(&amp;imapAction);</span>
<a href="#l61.19"></a><span id="l61.19" class="difflineplus">+    if (imapAction != nsIImapUrl::nsImapExpungeFolder &amp;&amp;</span>
<a href="#l61.20"></a><span id="l61.20" class="difflineplus">+        imapAction != nsIImapUrl::nsImapDeleteAllMsgs &amp;&amp;</span>
<a href="#l61.21"></a><span id="l61.21" class="difflineplus">+        imapAction != nsIImapUrl::nsImapDeleteFolder)</span>
<a href="#l61.22"></a><span id="l61.22" class="difflineplus">+      return NS_ERROR_FAILURE;</span>
<a href="#l61.23"></a><span id="l61.23" class="difflineplus">+  }</span>
<a href="#l61.24"></a><span id="l61.24">   nsresult rv = NS_OK;</span>
<a href="#l61.25"></a><span id="l61.25">   nsCOMPtr &lt;nsIImapProtocol&gt; aProtocol;</span>
<a href="#l61.26"></a><span id="l61.26"> </span>
<a href="#l61.27"></a><span id="l61.27">   rv = GetImapConnection(aClientEventTarget, aImapUrl, getter_AddRefs(aProtocol));</span>
<a href="#l61.28"></a><span id="l61.28">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l61.29"></a><span id="l61.29"> </span>
<a href="#l61.30"></a><span id="l61.30">   nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(aImapUrl, &amp;rv);</span>
<a href="#l61.31"></a><span id="l61.31">   if (aProtocol)</span>
<a href="#l61.32"></a><span id="l61.32" class="difflineat">@@ -2906,17 +2918,35 @@ nsImapIncomingServer::GetSupportsSubscri</span>
<a href="#l61.33"></a><span id="l61.33">   *retVal = PR_FALSE;</span>
<a href="#l61.34"></a><span id="l61.34">   return NS_OK;</span>
<a href="#l61.35"></a><span id="l61.35"> }</span>
<a href="#l61.36"></a><span id="l61.36"> </span>
<a href="#l61.37"></a><span id="l61.37"> NS_IMETHODIMP</span>
<a href="#l61.38"></a><span id="l61.38"> nsImapIncomingServer::GetFilterScope(nsMsgSearchScopeValue *filterScope)</span>
<a href="#l61.39"></a><span id="l61.39"> {</span>
<a href="#l61.40"></a><span id="l61.40">   NS_ENSURE_ARG_POINTER(filterScope);</span>
<a href="#l61.41"></a><span id="l61.41" class="difflineminus">-  *filterScope = nsMsgSearchScope::onlineMailFilter;</span>
<a href="#l61.42"></a><span id="l61.42" class="difflineplus">+  // If the inbox is enabled for offline use, then use the offline filter</span>
<a href="#l61.43"></a><span id="l61.43" class="difflineplus">+  // scope, else use the online filter scope.</span>
<a href="#l61.44"></a><span id="l61.44" class="difflineplus">+  //</span>
<a href="#l61.45"></a><span id="l61.45" class="difflineplus">+  // XXX We use the same scope for all folders with the same incoming server,</span>
<a href="#l61.46"></a><span id="l61.46" class="difflineplus">+  // yet it is possible to set the offline flag separately for each folder.</span>
<a href="#l61.47"></a><span id="l61.47" class="difflineplus">+  // Manual filters could perhaps check the offline status of each folder,</span>
<a href="#l61.48"></a><span id="l61.48" class="difflineplus">+  // though it's hard to see how to make that work since we only store filters</span>
<a href="#l61.49"></a><span id="l61.49" class="difflineplus">+  // per server.</span>
<a href="#l61.50"></a><span id="l61.50" class="difflineplus">+  // </span>
<a href="#l61.51"></a><span id="l61.51" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; rootMsgFolder;</span>
<a href="#l61.52"></a><span id="l61.52" class="difflineplus">+  nsresult rv = GetRootMsgFolder(getter_AddRefs(rootMsgFolder));</span>
<a href="#l61.53"></a><span id="l61.53" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l61.54"></a><span id="l61.54" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; offlineInboxMsgFolder;</span>
<a href="#l61.55"></a><span id="l61.55" class="difflineplus">+  rv = rootMsgFolder-&gt;GetFolderWithFlags(nsMsgFolderFlags::Inbox |</span>
<a href="#l61.56"></a><span id="l61.56" class="difflineplus">+                                           nsMsgFolderFlags::Offline,</span>
<a href="#l61.57"></a><span id="l61.57" class="difflineplus">+                                         getter_AddRefs(offlineInboxMsgFolder));</span>
<a href="#l61.58"></a><span id="l61.58" class="difflineplus">+</span>
<a href="#l61.59"></a><span id="l61.59" class="difflineplus">+  *filterScope = offlineInboxMsgFolder ? nsMsgSearchScope::offlineMailFilter</span>
<a href="#l61.60"></a><span id="l61.60" class="difflineplus">+                                       : nsMsgSearchScope::onlineMailFilter;</span>
<a href="#l61.61"></a><span id="l61.61">   return NS_OK;</span>
<a href="#l61.62"></a><span id="l61.62"> }</span>
<a href="#l61.63"></a><span id="l61.63"> </span>
<a href="#l61.64"></a><span id="l61.64"> NS_IMETHODIMP</span>
<a href="#l61.65"></a><span id="l61.65"> nsImapIncomingServer::GetSearchScope(nsMsgSearchScopeValue *searchScope)</span>
<a href="#l61.66"></a><span id="l61.66"> {</span>
<a href="#l61.67"></a><span id="l61.67">   NS_ENSURE_ARG_POINTER(searchScope);</span>
<a href="#l61.68"></a><span id="l61.68">  *searchScope = WeAreOffline() ? nsMsgSearchScope::offlineMail : nsMsgSearchScope::onlineMail;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l62.1"></a><span id="l62.1" class="difflineminus">--- a/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l62.2"></a><span id="l62.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l62.3"></a><span id="l62.3" class="difflineat">@@ -71,16 +71,18 @@</span>
<a href="#l62.4"></a><span id="l62.4"> #include &quot;nsTextFormatter.h&quot;</span>
<a href="#l62.5"></a><span id="l62.5"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l62.6"></a><span id="l62.6"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l62.7"></a><span id="l62.7"> #include &quot;nsMsgI18N.h&quot;</span>
<a href="#l62.8"></a><span id="l62.8"> #include &quot;nsICacheSession.h&quot;</span>
<a href="#l62.9"></a><span id="l62.9"> #include &quot;nsEscape.h&quot;</span>
<a href="#l62.10"></a><span id="l62.10"> #include &quot;nsIDOMWindowInternal.h&quot;</span>
<a href="#l62.11"></a><span id="l62.11"> #include &quot;nsIMsgFilter.h&quot;</span>
<a href="#l62.12"></a><span id="l62.12" class="difflineplus">+#include &quot;nsIMsgFilterService.h&quot;</span>
<a href="#l62.13"></a><span id="l62.13" class="difflineplus">+#include &quot;nsIMsgSearchCustomTerm.h&quot;</span>
<a href="#l62.14"></a><span id="l62.14"> #include &quot;nsImapMoveCoalescer.h&quot;</span>
<a href="#l62.15"></a><span id="l62.15"> #include &quot;nsIPrompt.h&quot;</span>
<a href="#l62.16"></a><span id="l62.16"> #include &quot;nsIPromptService.h&quot;</span>
<a href="#l62.17"></a><span id="l62.17"> #include &quot;nsIDocShell.h&quot;</span>
<a href="#l62.18"></a><span id="l62.18"> #include &quot;nsIInterfaceRequestor.h&quot;</span>
<a href="#l62.19"></a><span id="l62.19"> #include &quot;nsIInterfaceRequestorUtils.h&quot;</span>
<a href="#l62.20"></a><span id="l62.20"> #include &quot;nsReadableUtils.h&quot;</span>
<a href="#l62.21"></a><span id="l62.21"> #include &quot;nsUnicharUtils.h&quot;</span>
<a href="#l62.22"></a><span id="l62.22" class="difflineat">@@ -217,17 +219,18 @@ nsImapMailFolder::nsImapMailFolder() :</span>
<a href="#l62.23"></a><span id="l62.23">     m_folderNeedsACLListed(PR_TRUE),</span>
<a href="#l62.24"></a><span id="l62.24">     m_performingBiff(PR_FALSE),</span>
<a href="#l62.25"></a><span id="l62.25">     m_folderQuotaCommandIssued(PR_FALSE),</span>
<a href="#l62.26"></a><span id="l62.26">     m_folderQuotaDataIsValid(PR_FALSE),</span>
<a href="#l62.27"></a><span id="l62.27">     m_updatingFolder(PR_FALSE),</span>
<a href="#l62.28"></a><span id="l62.28">     m_downloadingFolderForOfflineUse(PR_FALSE),</span>
<a href="#l62.29"></a><span id="l62.29">     m_folderQuotaUsedKB(0),</span>
<a href="#l62.30"></a><span id="l62.30">     m_folderQuotaMaxKB(0),</span>
<a href="#l62.31"></a><span id="l62.31" class="difflineminus">-    m_applyIncomingFilters(PR_FALSE)</span>
<a href="#l62.32"></a><span id="l62.32" class="difflineplus">+    m_applyIncomingFilters(PR_FALSE),</span>
<a href="#l62.33"></a><span id="l62.33" class="difflineplus">+    m_filterListRequiresBody(PR_FALSE)</span>
<a href="#l62.34"></a><span id="l62.34"> {</span>
<a href="#l62.35"></a><span id="l62.35">   MOZ_COUNT_CTOR(nsImapMailFolder); // double count these for now.</span>
<a href="#l62.36"></a><span id="l62.36"> </span>
<a href="#l62.37"></a><span id="l62.37">   if (mImapHdrDownloadedAtom == nsnull)</span>
<a href="#l62.38"></a><span id="l62.38">     mImapHdrDownloadedAtom = NS_NewAtom(&quot;ImapHdrDownloaded&quot;);</span>
<a href="#l62.39"></a><span id="l62.39">   m_appendMsgMonitor = nsnull;  // since we're not using this (yet?) make it null.</span>
<a href="#l62.40"></a><span id="l62.40">   // if we do start using it, it should be created lazily</span>
<a href="#l62.41"></a><span id="l62.41"> </span>
<a href="#l62.42"></a><span id="l62.42" class="difflineat">@@ -721,16 +724,78 @@ NS_IMETHODIMP nsImapMailFolder::UpdateFo</span>
<a href="#l62.43"></a><span id="l62.43">     // the mdn filter is for filing return receipts into the sent folder</span>
<a href="#l62.44"></a><span id="l62.44">     // some servers (like AOL mail servers)</span>
<a href="#l62.45"></a><span id="l62.45">     // can't file to the sent folder, so we don't add the filter for those servers</span>
<a href="#l62.46"></a><span id="l62.46">     if (canFileMessagesOnServer)</span>
<a href="#l62.47"></a><span id="l62.47">     {</span>
<a href="#l62.48"></a><span id="l62.48">       rv = server-&gt;ConfigureTemporaryFilters(m_filterList);</span>
<a href="#l62.49"></a><span id="l62.49">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l62.50"></a><span id="l62.50">     }</span>
<a href="#l62.51"></a><span id="l62.51" class="difflineplus">+</span>
<a href="#l62.52"></a><span id="l62.52" class="difflineplus">+    // If a body filter is enabled for an offline folder, delay the filter</span>
<a href="#l62.53"></a><span id="l62.53" class="difflineplus">+    // application until after message has been downloaded.</span>
<a href="#l62.54"></a><span id="l62.54" class="difflineplus">+    m_filterListRequiresBody = PR_FALSE;</span>
<a href="#l62.55"></a><span id="l62.55" class="difflineplus">+</span>
<a href="#l62.56"></a><span id="l62.56" class="difflineplus">+    if (mFlags &amp; nsMsgFolderFlags::Offline)</span>
<a href="#l62.57"></a><span id="l62.57" class="difflineplus">+    {</span>
<a href="#l62.58"></a><span id="l62.58" class="difflineplus">+      nsCOMPtr&lt;nsIMsgFilterService&gt; filterService =</span>
<a href="#l62.59"></a><span id="l62.59" class="difflineplus">+        do_GetService(NS_MSGFILTERSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l62.60"></a><span id="l62.60" class="difflineplus">+      PRUint32 filterCount = 0;</span>
<a href="#l62.61"></a><span id="l62.61" class="difflineplus">+      m_filterList-&gt;GetFilterCount(&amp;filterCount);</span>
<a href="#l62.62"></a><span id="l62.62" class="difflineplus">+      for (PRUint32 index = 0;</span>
<a href="#l62.63"></a><span id="l62.63" class="difflineplus">+           index &lt; filterCount &amp;&amp; !m_filterListRequiresBody;</span>
<a href="#l62.64"></a><span id="l62.64" class="difflineplus">+           ++index)</span>
<a href="#l62.65"></a><span id="l62.65" class="difflineplus">+      {</span>
<a href="#l62.66"></a><span id="l62.66" class="difflineplus">+        nsCOMPtr&lt;nsIMsgFilter&gt; filter;</span>
<a href="#l62.67"></a><span id="l62.67" class="difflineplus">+        m_filterList-&gt;GetFilterAt(index, getter_AddRefs(filter));</span>
<a href="#l62.68"></a><span id="l62.68" class="difflineplus">+        if (!filter)</span>
<a href="#l62.69"></a><span id="l62.69" class="difflineplus">+          continue;</span>
<a href="#l62.70"></a><span id="l62.70" class="difflineplus">+        nsMsgFilterTypeType filterType;</span>
<a href="#l62.71"></a><span id="l62.71" class="difflineplus">+        filter-&gt;GetFilterType(&amp;filterType);</span>
<a href="#l62.72"></a><span id="l62.72" class="difflineplus">+        if (!(filterType &amp; nsMsgFilterType::Incoming))</span>
<a href="#l62.73"></a><span id="l62.73" class="difflineplus">+          continue;</span>
<a href="#l62.74"></a><span id="l62.74" class="difflineplus">+        PRBool enabled = PR_FALSE;</span>
<a href="#l62.75"></a><span id="l62.75" class="difflineplus">+        filter-&gt;GetEnabled(&amp;enabled);</span>
<a href="#l62.76"></a><span id="l62.76" class="difflineplus">+        if (!enabled)</span>
<a href="#l62.77"></a><span id="l62.77" class="difflineplus">+          continue;</span>
<a href="#l62.78"></a><span id="l62.78" class="difflineplus">+        nsCOMPtr&lt;nsISupportsArray&gt; searchTerms;</span>
<a href="#l62.79"></a><span id="l62.79" class="difflineplus">+        PRUint32 numSearchTerms = 0;</span>
<a href="#l62.80"></a><span id="l62.80" class="difflineplus">+        filter-&gt;GetSearchTerms(getter_AddRefs(searchTerms));</span>
<a href="#l62.81"></a><span id="l62.81" class="difflineplus">+        if (searchTerms)</span>
<a href="#l62.82"></a><span id="l62.82" class="difflineplus">+          searchTerms-&gt;Count(&amp;numSearchTerms);</span>
<a href="#l62.83"></a><span id="l62.83" class="difflineplus">+        for (PRUint32 termIndex = 0;</span>
<a href="#l62.84"></a><span id="l62.84" class="difflineplus">+             termIndex &lt; numSearchTerms &amp;&amp; !m_filterListRequiresBody;</span>
<a href="#l62.85"></a><span id="l62.85" class="difflineplus">+             termIndex++)</span>
<a href="#l62.86"></a><span id="l62.86" class="difflineplus">+        {</span>
<a href="#l62.87"></a><span id="l62.87" class="difflineplus">+          nsCOMPtr&lt;nsIMsgSearchTerm&gt; term;</span>
<a href="#l62.88"></a><span id="l62.88" class="difflineplus">+          rv = searchTerms-&gt;QueryElementAt(termIndex,</span>
<a href="#l62.89"></a><span id="l62.89" class="difflineplus">+                                           NS_GET_IID(nsIMsgSearchTerm),</span>
<a href="#l62.90"></a><span id="l62.90" class="difflineplus">+                                           getter_AddRefs(term));</span>
<a href="#l62.91"></a><span id="l62.91" class="difflineplus">+          nsMsgSearchAttribValue attrib;</span>
<a href="#l62.92"></a><span id="l62.92" class="difflineplus">+          rv = term-&gt;GetAttrib(&amp;attrib);</span>
<a href="#l62.93"></a><span id="l62.93" class="difflineplus">+          NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l62.94"></a><span id="l62.94" class="difflineplus">+          if (attrib == nsMsgSearchAttrib::Body)</span>
<a href="#l62.95"></a><span id="l62.95" class="difflineplus">+            m_filterListRequiresBody = PR_TRUE;</span>
<a href="#l62.96"></a><span id="l62.96" class="difflineplus">+          else if (attrib == nsMsgSearchAttrib::Custom)</span>
<a href="#l62.97"></a><span id="l62.97" class="difflineplus">+          {</span>
<a href="#l62.98"></a><span id="l62.98" class="difflineplus">+            nsCAutoString customId;</span>
<a href="#l62.99"></a><span id="l62.99" class="difflineplus">+            rv = term-&gt;GetCustomId(customId);</span>
<a href="#l62.100"></a><span id="l62.100" class="difflineplus">+            nsCOMPtr&lt;nsIMsgSearchCustomTerm&gt; customTerm;</span>
<a href="#l62.101"></a><span id="l62.101" class="difflineplus">+            if (NS_SUCCEEDED(rv) &amp;&amp; filterService)</span>
<a href="#l62.102"></a><span id="l62.102" class="difflineplus">+              rv = filterService-&gt;GetCustomTerm(customId,</span>
<a href="#l62.103"></a><span id="l62.103" class="difflineplus">+                                                getter_AddRefs(customTerm));</span>
<a href="#l62.104"></a><span id="l62.104" class="difflineplus">+            PRBool needsBody = PR_FALSE;</span>
<a href="#l62.105"></a><span id="l62.105" class="difflineplus">+            if (NS_SUCCEEDED(rv))</span>
<a href="#l62.106"></a><span id="l62.106" class="difflineplus">+              rv = customTerm-&gt;GetNeedsBody(&amp;needsBody);</span>
<a href="#l62.107"></a><span id="l62.107" class="difflineplus">+            if (NS_SUCCEEDED(rv) &amp;&amp; needsBody)</span>
<a href="#l62.108"></a><span id="l62.108" class="difflineplus">+              m_filterListRequiresBody = PR_TRUE;</span>
<a href="#l62.109"></a><span id="l62.109" class="difflineplus">+          }</span>
<a href="#l62.110"></a><span id="l62.110" class="difflineplus">+        }</span>
<a href="#l62.111"></a><span id="l62.111" class="difflineplus">+      }</span>
<a href="#l62.112"></a><span id="l62.112" class="difflineplus">+    }</span>
<a href="#l62.113"></a><span id="l62.113">   }</span>
<a href="#l62.114"></a><span id="l62.114"> </span>
<a href="#l62.115"></a><span id="l62.115">   selectFolder = PR_TRUE;</span>
<a href="#l62.116"></a><span id="l62.116"> </span>
<a href="#l62.117"></a><span id="l62.117">   PRBool isServer;</span>
<a href="#l62.118"></a><span id="l62.118">   rv = GetIsServer(&amp;isServer);</span>
<a href="#l62.119"></a><span id="l62.119">   if (NS_SUCCEEDED(rv) &amp;&amp; isServer)</span>
<a href="#l62.120"></a><span id="l62.120">   {</span>
<a href="#l62.121"></a><span id="l62.121" class="difflineat">@@ -3046,23 +3111,25 @@ nsresult nsImapMailFolder::NormalEndHead</span>
<a href="#l62.122"></a><span id="l62.122">           }</span>
<a href="#l62.123"></a><span id="l62.123">           PRInt32 numNewMessages;</span>
<a href="#l62.124"></a><span id="l62.124">           GetNumNewMessages(PR_FALSE, &amp;numNewMessages);</span>
<a href="#l62.125"></a><span id="l62.125">           SetNumNewMessages(numNewMessages - 1);</span>
<a href="#l62.126"></a><span id="l62.126">         }</span>
<a href="#l62.127"></a><span id="l62.127">       }</span>
<a href="#l62.128"></a><span id="l62.128">       rv = m_msgParser-&gt;GetAllHeaders(&amp;headers, &amp;headersSize);</span>
<a href="#l62.129"></a><span id="l62.129"> </span>
<a href="#l62.130"></a><span id="l62.130" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; headers &amp;&amp; !m_msgMovedByFilter)</span>
<a href="#l62.131"></a><span id="l62.131" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; headers &amp;&amp; !m_msgMovedByFilter &amp;&amp;</span>
<a href="#l62.132"></a><span id="l62.132" class="difflineplus">+          !m_filterListRequiresBody)</span>
<a href="#l62.133"></a><span id="l62.133">       {</span>
<a href="#l62.134"></a><span id="l62.134">         if (m_filterList)</span>
<a href="#l62.135"></a><span id="l62.135">         {</span>
<a href="#l62.136"></a><span id="l62.136">           GetMoveCoalescer();  // not sure why we're doing this here.</span>
<a href="#l62.137"></a><span id="l62.137">           m_filterList-&gt;ApplyFiltersToHdr(nsMsgFilterType::InboxRule, newMsgHdr, this, mDatabase,</span>
<a href="#l62.138"></a><span id="l62.138">                                           headers, headersSize, this, msgWindow, nsnull);</span>
<a href="#l62.139"></a><span id="l62.139" class="difflineplus">+          NotifyFolderEvent(mFiltersAppliedAtom);</span>
<a href="#l62.140"></a><span id="l62.140">         }</span>
<a href="#l62.141"></a><span id="l62.141">       }</span>
<a href="#l62.142"></a><span id="l62.142">     }</span>
<a href="#l62.143"></a><span id="l62.143">   }</span>
<a href="#l62.144"></a><span id="l62.144">   // here we need to tweak flags from uid state..</span>
<a href="#l62.145"></a><span id="l62.145">   if (mDatabase &amp;&amp; (!m_msgMovedByFilter || ShowDeletedMessages()))</span>
<a href="#l62.146"></a><span id="l62.146">   {</span>
<a href="#l62.147"></a><span id="l62.147">     mDatabase-&gt;AddNewHdrToDB(newMsgHdr, PR_TRUE);</span>
<a href="#l62.148"></a><span id="l62.148" class="difflineat">@@ -3259,30 +3326,46 @@ NS_IMETHODIMP nsImapMailFolder::StartMes</span>
<a href="#l62.149"></a><span id="l62.149"> // just finished the current message.</span>
<a href="#l62.150"></a><span id="l62.150"> NS_IMETHODIMP nsImapMailFolder::EndMessage(nsMsgKey key)</span>
<a href="#l62.151"></a><span id="l62.151"> {</span>
<a href="#l62.152"></a><span id="l62.152">   return NS_OK;</span>
<a href="#l62.153"></a><span id="l62.153"> }</span>
<a href="#l62.154"></a><span id="l62.154"> </span>
<a href="#l62.155"></a><span id="l62.155"> NS_IMETHODIMP nsImapMailFolder::ApplyFilterHit(nsIMsgFilter *filter, nsIMsgWindow *msgWindow, PRBool *applyMore)</span>
<a href="#l62.156"></a><span id="l62.156"> {</span>
<a href="#l62.157"></a><span id="l62.157" class="difflineplus">+  //</span>
<a href="#l62.158"></a><span id="l62.158" class="difflineplus">+  //  This routine is called indirectly from ApplyFiltersToHdr in two</span>
<a href="#l62.159"></a><span id="l62.159" class="difflineplus">+  //  circumstances, controlled by m_filterListRequiresBody:</span>
<a href="#l62.160"></a><span id="l62.160" class="difflineplus">+  //</span>
<a href="#l62.161"></a><span id="l62.161" class="difflineplus">+  //  If false, after headers are parsed in NormalEndHeaderParseStream.</span>
<a href="#l62.162"></a><span id="l62.162" class="difflineplus">+  //  If true, after the message body is downloaded in NormalEndMsgWriteStream.</span>
<a href="#l62.163"></a><span id="l62.163" class="difflineplus">+  //</span>
<a href="#l62.164"></a><span id="l62.164" class="difflineplus">+  //  In NormalEndHeaderParseStream, the message has not been added to the</span>
<a href="#l62.165"></a><span id="l62.165" class="difflineplus">+  //  database, and it is important that database notifications and count </span>
<a href="#l62.166"></a><span id="l62.166" class="difflineplus">+  //  updates do not occur. In NormalEndMsgWriteStream, the message has been</span>
<a href="#l62.167"></a><span id="l62.167" class="difflineplus">+  //  added to the database, and database notifications and count updates</span>
<a href="#l62.168"></a><span id="l62.168" class="difflineplus">+  //  should be performed.</span>
<a href="#l62.169"></a><span id="l62.169" class="difflineplus">+  //</span>
<a href="#l62.170"></a><span id="l62.170" class="difflineplus">+</span>
<a href="#l62.171"></a><span id="l62.171">   NS_ENSURE_ARG_POINTER(applyMore);</span>
<a href="#l62.172"></a><span id="l62.172"> </span>
<a href="#l62.173"></a><span id="l62.173">   nsMsgRuleActionType actionType;</span>
<a href="#l62.174"></a><span id="l62.174">   nsCString actionTargetFolderUri;</span>
<a href="#l62.175"></a><span id="l62.175">   PRUint32  newFlags;</span>
<a href="#l62.176"></a><span id="l62.176">   nsresult rv = NS_OK;</span>
<a href="#l62.177"></a><span id="l62.177"> </span>
<a href="#l62.178"></a><span id="l62.178">   // look at action - currently handle move</span>
<a href="#l62.179"></a><span id="l62.179"> #ifdef DEBUG_bienvenu</span>
<a href="#l62.180"></a><span id="l62.180">   printf(&quot;got a rule hit!\n&quot;);</span>
<a href="#l62.181"></a><span id="l62.181"> #endif</span>
<a href="#l62.182"></a><span id="l62.182"> </span>
<a href="#l62.183"></a><span id="l62.183">   nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l62.184"></a><span id="l62.184" class="difflineminus">-  if (m_msgParser)</span>
<a href="#l62.185"></a><span id="l62.185" class="difflineplus">+  if (m_filterListRequiresBody)</span>
<a href="#l62.186"></a><span id="l62.186" class="difflineplus">+    GetMessageHeader(m_curMsgUid, getter_AddRefs(msgHdr));</span>
<a href="#l62.187"></a><span id="l62.187" class="difflineplus">+  else if (m_msgParser)</span>
<a href="#l62.188"></a><span id="l62.188">     m_msgParser-&gt;GetNewMsgHdr(getter_AddRefs(msgHdr));</span>
<a href="#l62.189"></a><span id="l62.189">   if (!msgHdr)</span>
<a href="#l62.190"></a><span id="l62.190">     return NS_ERROR_NULL_POINTER; //fatal error, cannot apply filters</span>
<a href="#l62.191"></a><span id="l62.191"> </span>
<a href="#l62.192"></a><span id="l62.192">   PRBool deleteToTrash = DeleteIsMoveToTrash();</span>
<a href="#l62.193"></a><span id="l62.193">   nsCOMPtr&lt;nsISupportsArray&gt; filterActionList = do_CreateInstance(NS_SUPPORTSARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l62.194"></a><span id="l62.194">   NS_ENSURE_TRUE(filterActionList, rv);</span>
<a href="#l62.195"></a><span id="l62.195">   rv = filter-&gt;GetSortedActionList(filterActionList);</span>
<a href="#l62.196"></a><span id="l62.196" class="difflineat">@@ -3334,17 +3417,18 @@ NS_IMETHODIMP nsImapMailFolder::ApplyFil</span>
<a href="#l62.197"></a><span id="l62.197">             nsCOMPtr &lt;nsIMsgFolder&gt; mailTrash;</span>
<a href="#l62.198"></a><span id="l62.198">             rv = GetTrashFolder(getter_AddRefs(mailTrash));</span>
<a href="#l62.199"></a><span id="l62.199">             if (NS_SUCCEEDED(rv) &amp;&amp; mailTrash)</span>
<a href="#l62.200"></a><span id="l62.200">               rv = mailTrash-&gt;GetURI(actionTargetFolderUri);</span>
<a href="#l62.201"></a><span id="l62.201">             // msgHdr-&gt;OrFlags(nsMsgMessageFlags::Read, &amp;newFlags);  // mark read in trash.</span>
<a href="#l62.202"></a><span id="l62.202">           }</span>
<a href="#l62.203"></a><span id="l62.203">           else  // (!deleteToTrash)</span>
<a href="#l62.204"></a><span id="l62.204">           {</span>
<a href="#l62.205"></a><span id="l62.205" class="difflineminus">-            msgHdr-&gt;OrFlags(nsMsgMessageFlags::Read | nsMsgMessageFlags::IMAPDeleted, &amp;newFlags);</span>
<a href="#l62.206"></a><span id="l62.206" class="difflineplus">+            mDatabase-&gt;MarkHdrRead(msgHdr, PR_TRUE, nsnull);</span>
<a href="#l62.207"></a><span id="l62.207" class="difflineplus">+            mDatabase-&gt;MarkImapDeleted(msgKey, PR_TRUE, nsnull);</span>
<a href="#l62.208"></a><span id="l62.208">             StoreImapFlags(kImapMsgSeenFlag | kImapMsgDeletedFlag, PR_TRUE,</span>
<a href="#l62.209"></a><span id="l62.209">                            &amp;msgKey, 1, nsnull);</span>
<a href="#l62.210"></a><span id="l62.210">             m_msgMovedByFilter = PR_TRUE; // this will prevent us from adding the header to the db.</span>
<a href="#l62.211"></a><span id="l62.211">           }</span>
<a href="#l62.212"></a><span id="l62.212">           msgIsNew = PR_FALSE;</span>
<a href="#l62.213"></a><span id="l62.213">         }</span>
<a href="#l62.214"></a><span id="l62.214">         // note that delete falls through to move.</span>
<a href="#l62.215"></a><span id="l62.215">         case nsMsgFilterAction::MoveToFolder:</span>
<a href="#l62.216"></a><span id="l62.216" class="difflineat">@@ -3354,18 +3438,18 @@ NS_IMETHODIMP nsImapMailFolder::ApplyFil</span>
<a href="#l62.217"></a><span id="l62.217">           rv = GetURI(uri);</span>
<a href="#l62.218"></a><span id="l62.218"> </span>
<a href="#l62.219"></a><span id="l62.219">           if (!actionTargetFolderUri.Equals(uri))</span>
<a href="#l62.220"></a><span id="l62.220">           {</span>
<a href="#l62.221"></a><span id="l62.221">             msgHdr-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l62.222"></a><span id="l62.222"> </span>
<a href="#l62.223"></a><span id="l62.223">             if (msgFlags &amp; nsMsgMessageFlags::MDNReportNeeded &amp;&amp; !isRead)</span>
<a href="#l62.224"></a><span id="l62.224">             {</span>
<a href="#l62.225"></a><span id="l62.225" class="difflineminus">-               msgHdr-&gt;SetFlags(msgFlags &amp; ~nsMsgMessageFlags::MDNReportNeeded);</span>
<a href="#l62.226"></a><span id="l62.226" class="difflineminus">-               msgHdr-&gt;OrFlags(nsMsgMessageFlags::MDNReportSent, &amp;newFlags);</span>
<a href="#l62.227"></a><span id="l62.227" class="difflineplus">+               mDatabase-&gt;MarkMDNNeeded(msgKey, PR_FALSE, nsnull);</span>
<a href="#l62.228"></a><span id="l62.228" class="difflineplus">+               mDatabase-&gt;MarkMDNSent(msgKey, PR_TRUE, nsnull);</span>
<a href="#l62.229"></a><span id="l62.229">             }</span>
<a href="#l62.230"></a><span id="l62.230">             nsresult err = MoveIncorporatedMessage(msgHdr, mDatabase, actionTargetFolderUri, filter, msgWindow);</span>
<a href="#l62.231"></a><span id="l62.231">             if (NS_SUCCEEDED(err))</span>
<a href="#l62.232"></a><span id="l62.232">               m_msgMovedByFilter = PR_TRUE;</span>
<a href="#l62.233"></a><span id="l62.233">           }</span>
<a href="#l62.234"></a><span id="l62.234">           // don't apply any more filters, even if it was a move to the same folder</span>
<a href="#l62.235"></a><span id="l62.235">           *applyMore = PR_FALSE; </span>
<a href="#l62.236"></a><span id="l62.236">         }</span>
<a href="#l62.237"></a><span id="l62.237" class="difflineat">@@ -3378,18 +3462,18 @@ NS_IMETHODIMP nsImapMailFolder::ApplyFil</span>
<a href="#l62.238"></a><span id="l62.238">           if (!actionTargetFolderUri.Equals(uri))</span>
<a href="#l62.239"></a><span id="l62.239">           {</span>
<a href="#l62.240"></a><span id="l62.240">             // XXXshaver I'm not actually 100% what the right semantics are for</span>
<a href="#l62.241"></a><span id="l62.241">             // MDNs and copied messages, but I suspect deep down inside that</span>
<a href="#l62.242"></a><span id="l62.242">             // we probably want to suppress them only on the copies.</span>
<a href="#l62.243"></a><span id="l62.243">             msgHdr-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l62.244"></a><span id="l62.244">             if (msgFlags &amp; nsMsgMessageFlags::MDNReportNeeded &amp;&amp; !isRead)</span>
<a href="#l62.245"></a><span id="l62.245">             {</span>
<a href="#l62.246"></a><span id="l62.246" class="difflineminus">-               msgHdr-&gt;SetFlags(msgFlags &amp; ~nsMsgMessageFlags::MDNReportNeeded);</span>
<a href="#l62.247"></a><span id="l62.247" class="difflineminus">-               msgHdr-&gt;OrFlags(nsMsgMessageFlags::MDNReportSent, &amp;newFlags);</span>
<a href="#l62.248"></a><span id="l62.248" class="difflineplus">+               mDatabase-&gt;MarkMDNNeeded(msgKey, PR_FALSE, nsnull);</span>
<a href="#l62.249"></a><span id="l62.249" class="difflineplus">+               mDatabase-&gt;MarkMDNSent(msgKey, PR_TRUE, nsnull);</span>
<a href="#l62.250"></a><span id="l62.250">             }</span>
<a href="#l62.251"></a><span id="l62.251"> </span>
<a href="#l62.252"></a><span id="l62.252">             nsCOMPtr&lt;nsIMutableArray&gt; messageArray(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l62.253"></a><span id="l62.253">             NS_ENSURE_TRUE(messageArray, rv);</span>
<a href="#l62.254"></a><span id="l62.254">             messageArray-&gt;AppendElement(msgHdr, PR_FALSE);</span>
<a href="#l62.255"></a><span id="l62.255"> </span>
<a href="#l62.256"></a><span id="l62.256">             nsCOMPtr&lt;nsIMsgFolder&gt; dstFolder;</span>
<a href="#l62.257"></a><span id="l62.257">             rv = GetExistingFolder(actionTargetFolderUri, getter_AddRefs(dstFolder));</span>
<a href="#l62.258"></a><span id="l62.258" class="difflineat">@@ -3413,36 +3497,66 @@ NS_IMETHODIMP nsImapMailFolder::ApplyFil</span>
<a href="#l62.259"></a><span id="l62.259">         break;</span>
<a href="#l62.260"></a><span id="l62.260">         case nsMsgFilterAction::MarkFlagged:</span>
<a href="#l62.261"></a><span id="l62.261">         {</span>
<a href="#l62.262"></a><span id="l62.262">           mDatabase-&gt;MarkHdrMarked(msgHdr, PR_TRUE, nsnull);</span>
<a href="#l62.263"></a><span id="l62.263">           StoreImapFlags(kImapMsgFlaggedFlag, PR_TRUE, &amp;msgKey, 1, nsnull);</span>
<a href="#l62.264"></a><span id="l62.264">         }</span>
<a href="#l62.265"></a><span id="l62.265">         break;</span>
<a href="#l62.266"></a><span id="l62.266">         case nsMsgFilterAction::KillThread:</span>
<a href="#l62.267"></a><span id="l62.267" class="difflineminus">-          msgHdr-&gt;SetUint32Property(&quot;ProtoThreadFlags&quot;, nsMsgMessageFlags::Ignored);</span>
<a href="#l62.268"></a><span id="l62.268" class="difflineminus">-          break;</span>
<a href="#l62.269"></a><span id="l62.269" class="difflineplus">+        case nsMsgFilterAction::WatchThread:</span>
<a href="#l62.270"></a><span id="l62.270" class="difflineplus">+        {</span>
<a href="#l62.271"></a><span id="l62.271" class="difflineplus">+          nsCOMPtr &lt;nsIMsgThread&gt; msgThread;</span>
<a href="#l62.272"></a><span id="l62.272" class="difflineplus">+          nsMsgKey threadKey;</span>
<a href="#l62.273"></a><span id="l62.273" class="difflineplus">+          mDatabase-&gt;GetThreadContainingMsgHdr(msgHdr, getter_AddRefs(msgThread));</span>
<a href="#l62.274"></a><span id="l62.274" class="difflineplus">+          if (msgThread)</span>
<a href="#l62.275"></a><span id="l62.275" class="difflineplus">+          {</span>
<a href="#l62.276"></a><span id="l62.276" class="difflineplus">+            msgThread-&gt;GetThreadKey(&amp;threadKey);</span>
<a href="#l62.277"></a><span id="l62.277" class="difflineplus">+            if (actionType == nsMsgFilterAction::KillThread)</span>
<a href="#l62.278"></a><span id="l62.278" class="difflineplus">+              mDatabase-&gt;MarkThreadIgnored(msgThread, threadKey, PR_TRUE, nsnull);</span>
<a href="#l62.279"></a><span id="l62.279" class="difflineplus">+            else</span>
<a href="#l62.280"></a><span id="l62.280" class="difflineplus">+              mDatabase-&gt;MarkThreadWatched(msgThread, threadKey, PR_TRUE, nsnull);</span>
<a href="#l62.281"></a><span id="l62.281" class="difflineplus">+          }</span>
<a href="#l62.282"></a><span id="l62.282" class="difflineplus">+          else</span>
<a href="#l62.283"></a><span id="l62.283" class="difflineplus">+          {</span>
<a href="#l62.284"></a><span id="l62.284" class="difflineplus">+            if (actionType == nsMsgFilterAction::KillThread)</span>
<a href="#l62.285"></a><span id="l62.285" class="difflineplus">+              msgHdr-&gt;SetUint32Property(&quot;ProtoThreadFlags&quot;, nsMsgMessageFlags::Ignored);</span>
<a href="#l62.286"></a><span id="l62.286" class="difflineplus">+            else</span>
<a href="#l62.287"></a><span id="l62.287" class="difflineplus">+              msgHdr-&gt;SetUint32Property(&quot;ProtoThreadFlags&quot;, nsMsgMessageFlags::Watched);</span>
<a href="#l62.288"></a><span id="l62.288" class="difflineplus">+          }</span>
<a href="#l62.289"></a><span id="l62.289" class="difflineplus">+          if (actionType == nsMsgFilterAction::KillThread)</span>
<a href="#l62.290"></a><span id="l62.290" class="difflineplus">+          {</span>
<a href="#l62.291"></a><span id="l62.291" class="difflineplus">+            mDatabase-&gt;MarkHdrRead(msgHdr, PR_TRUE, nsnull);</span>
<a href="#l62.292"></a><span id="l62.292" class="difflineplus">+            StoreImapFlags(kImapMsgSeenFlag, PR_TRUE, &amp;msgKey, 1, nsnull);</span>
<a href="#l62.293"></a><span id="l62.293" class="difflineplus">+            msgIsNew = PR_FALSE;</span>
<a href="#l62.294"></a><span id="l62.294" class="difflineplus">+          }</span>
<a href="#l62.295"></a><span id="l62.295" class="difflineplus">+        }</span>
<a href="#l62.296"></a><span id="l62.296" class="difflineplus">+        break;</span>
<a href="#l62.297"></a><span id="l62.297">         case nsMsgFilterAction::KillSubthread:</span>
<a href="#l62.298"></a><span id="l62.298" class="difflineminus">-          msgHdr-&gt;OrFlags(nsMsgMessageFlags::Ignored, &amp;newFlags);</span>
<a href="#l62.299"></a><span id="l62.299" class="difflineminus">-          break;</span>
<a href="#l62.300"></a><span id="l62.300" class="difflineminus">-        case nsMsgFilterAction::WatchThread:</span>
<a href="#l62.301"></a><span id="l62.301" class="difflineminus">-          msgHdr-&gt;OrFlags(nsMsgMessageFlags::Watched, &amp;newFlags);</span>
<a href="#l62.302"></a><span id="l62.302" class="difflineplus">+        {</span>
<a href="#l62.303"></a><span id="l62.303" class="difflineplus">+          mDatabase-&gt;MarkHeaderKilled(msgHdr, PR_TRUE, nsnull);</span>
<a href="#l62.304"></a><span id="l62.304" class="difflineplus">+          mDatabase-&gt;MarkHdrRead(msgHdr, PR_TRUE, nsnull);</span>
<a href="#l62.305"></a><span id="l62.305" class="difflineplus">+          StoreImapFlags(kImapMsgSeenFlag, PR_TRUE, &amp;msgKey, 1, nsnull);</span>
<a href="#l62.306"></a><span id="l62.306" class="difflineplus">+          msgIsNew = PR_FALSE;</span>
<a href="#l62.307"></a><span id="l62.307" class="difflineplus">+        }</span>
<a href="#l62.308"></a><span id="l62.308">         break;</span>
<a href="#l62.309"></a><span id="l62.309">         case nsMsgFilterAction::ChangePriority:</span>
<a href="#l62.310"></a><span id="l62.310">         {</span>
<a href="#l62.311"></a><span id="l62.311" class="difflineminus">-          nsMsgPriorityValue filterPriority;</span>
<a href="#l62.312"></a><span id="l62.312" class="difflineplus">+          nsMsgPriorityValue filterPriority; // a PRInt32</span>
<a href="#l62.313"></a><span id="l62.313">           filterAction-&gt;GetPriority(&amp;filterPriority);</span>
<a href="#l62.314"></a><span id="l62.314" class="difflineminus">-          msgHdr-&gt;SetPriority(filterPriority);</span>
<a href="#l62.315"></a><span id="l62.315" class="difflineplus">+          mDatabase-&gt;SetUint32PropertyByHdr(msgHdr, &quot;priority&quot;,</span>
<a href="#l62.316"></a><span id="l62.316" class="difflineplus">+                                            static_cast&lt;PRUint32&gt;(filterPriority));</span>
<a href="#l62.317"></a><span id="l62.317">         }</span>
<a href="#l62.318"></a><span id="l62.318">         break;</span>
<a href="#l62.319"></a><span id="l62.319">         case nsMsgFilterAction::Label:</span>
<a href="#l62.320"></a><span id="l62.320">         {</span>
<a href="#l62.321"></a><span id="l62.321">           nsMsgLabelValue filterLabel;</span>
<a href="#l62.322"></a><span id="l62.322">           filterAction-&gt;GetLabel(&amp;filterLabel);</span>
<a href="#l62.323"></a><span id="l62.323" class="difflineminus">-          msgHdr-&gt;SetLabel(filterLabel);</span>
<a href="#l62.324"></a><span id="l62.324" class="difflineplus">+          mDatabase-&gt;SetUint32PropertyByHdr(msgHdr, &quot;label&quot;,</span>
<a href="#l62.325"></a><span id="l62.325" class="difflineplus">+                                            static_cast&lt;PRUint32&gt;(filterLabel));</span>
<a href="#l62.326"></a><span id="l62.326">           StoreImapFlags((filterLabel &lt;&lt; 9), PR_TRUE, &amp;msgKey, 1, nsnull);</span>
<a href="#l62.327"></a><span id="l62.327">         }</span>
<a href="#l62.328"></a><span id="l62.328">         break;</span>
<a href="#l62.329"></a><span id="l62.329">         case nsMsgFilterAction::AddTag:</span>
<a href="#l62.330"></a><span id="l62.330">         {</span>
<a href="#l62.331"></a><span id="l62.331">           nsCString keyword;</span>
<a href="#l62.332"></a><span id="l62.332">           filterAction-&gt;GetStrValue(keyword);</span>
<a href="#l62.333"></a><span id="l62.333">           nsCOMPtr&lt;nsIMutableArray&gt; messageArray(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l62.334"></a><span id="l62.334" class="difflineat">@@ -3464,18 +3578,38 @@ NS_IMETHODIMP nsImapMailFolder::ApplyFil</span>
<a href="#l62.335"></a><span id="l62.335">           if (junkScore == nsIJunkMailPlugin::IS_SPAM_SCORE ||</span>
<a href="#l62.336"></a><span id="l62.336">               junkScore == nsIJunkMailPlugin::IS_HAM_SCORE)</span>
<a href="#l62.337"></a><span id="l62.337">           {</span>
<a href="#l62.338"></a><span id="l62.338">             nsTArray&lt;nsMsgKey&gt; *keysToClassify = m_moveCoalescer-&gt;GetKeyBucket(</span>
<a href="#l62.339"></a><span id="l62.339">                        (junkScore == nsIJunkMailPlugin::IS_SPAM_SCORE) ? 0 : 1);</span>
<a href="#l62.340"></a><span id="l62.340">             NS_ASSERTION(keysToClassify, &quot;error getting key bucket&quot;);</span>
<a href="#l62.341"></a><span id="l62.341">             if (keysToClassify)</span>
<a href="#l62.342"></a><span id="l62.342">               keysToClassify-&gt;AppendElement(msgKey);</span>
<a href="#l62.343"></a><span id="l62.343" class="difflineminus">-            if (junkScore == nsIJunkMailPlugin::IS_SPAM_SCORE)</span>
<a href="#l62.344"></a><span id="l62.344" class="difflineplus">+            if (msgIsNew &amp;&amp; junkScore == nsIJunkMailPlugin::IS_SPAM_SCORE)</span>
<a href="#l62.345"></a><span id="l62.345" class="difflineplus">+            {              </span>
<a href="#l62.346"></a><span id="l62.346">               msgIsNew = PR_FALSE;</span>
<a href="#l62.347"></a><span id="l62.347" class="difflineplus">+              mDatabase-&gt;MarkHdrNotNew(msgHdr, nsnull);</span>
<a href="#l62.348"></a><span id="l62.348" class="difflineplus">+              // nsMsgDBFolder::SendFlagNotifications by the call to</span>
<a href="#l62.349"></a><span id="l62.349" class="difflineplus">+              // SetBiffState(nsMsgBiffState_NoMail) will reset numNewMessages</span>
<a href="#l62.350"></a><span id="l62.350" class="difflineplus">+              // only if the message is also read and database notifications</span>
<a href="#l62.351"></a><span id="l62.351" class="difflineplus">+              // are active, but we are not going to mark it read in this</span>
<a href="#l62.352"></a><span id="l62.352" class="difflineplus">+              // action, preferring to leave the choice to the user.</span>
<a href="#l62.353"></a><span id="l62.353" class="difflineplus">+              // So correct numNewMessages.</span>
<a href="#l62.354"></a><span id="l62.354" class="difflineplus">+              if (m_filterListRequiresBody)</span>
<a href="#l62.355"></a><span id="l62.355" class="difflineplus">+              {</span>
<a href="#l62.356"></a><span id="l62.356" class="difflineplus">+                msgHdr-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l62.357"></a><span id="l62.357" class="difflineplus">+                if (!(msgFlags &amp; nsMsgMessageFlags::Read))</span>
<a href="#l62.358"></a><span id="l62.358" class="difflineplus">+                {</span>
<a href="#l62.359"></a><span id="l62.359" class="difflineplus">+                  PRInt32 numNewMessages;</span>
<a href="#l62.360"></a><span id="l62.360" class="difflineplus">+                  GetNumNewMessages(PR_FALSE, &amp;numNewMessages);</span>
<a href="#l62.361"></a><span id="l62.361" class="difflineplus">+                  SetNumNewMessages(--numNewMessages);</span>
<a href="#l62.362"></a><span id="l62.362" class="difflineplus">+                  SetHasNewMessages(numNewMessages != 0);</span>
<a href="#l62.363"></a><span id="l62.363" class="difflineplus">+                }</span>
<a href="#l62.364"></a><span id="l62.364" class="difflineplus">+              }</span>
<a href="#l62.365"></a><span id="l62.365" class="difflineplus">+            }</span>
<a href="#l62.366"></a><span id="l62.366">           }</span>
<a href="#l62.367"></a><span id="l62.367">         }</span>
<a href="#l62.368"></a><span id="l62.368">         break;</span>
<a href="#l62.369"></a><span id="l62.369">       case nsMsgFilterAction::Forward:</span>
<a href="#l62.370"></a><span id="l62.370">         {</span>
<a href="#l62.371"></a><span id="l62.371">           nsCString forwardTo;</span>
<a href="#l62.372"></a><span id="l62.372">           filterAction-&gt;GetStrValue(forwardTo);</span>
<a href="#l62.373"></a><span id="l62.373">           nsCOMPtr &lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l62.374"></a><span id="l62.374" class="difflineat">@@ -3524,16 +3658,20 @@ NS_IMETHODIMP nsImapMailFolder::ApplyFil</span>
<a href="#l62.375"></a><span id="l62.375"> </span>
<a href="#l62.376"></a><span id="l62.376">           nsCOMPtr&lt;nsIMutableArray&gt; messageArray(</span>
<a href="#l62.377"></a><span id="l62.377">               do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l62.378"></a><span id="l62.378">           NS_ENSURE_TRUE(messageArray, rv);</span>
<a href="#l62.379"></a><span id="l62.379">           messageArray-&gt;AppendElement(msgHdr, PR_FALSE);</span>
<a href="#l62.380"></a><span id="l62.380"> </span>
<a href="#l62.381"></a><span id="l62.381">           customAction-&gt;Apply(messageArray, value, nsnull,</span>
<a href="#l62.382"></a><span id="l62.382">                               nsMsgFilterType::InboxRule, msgWindow);</span>
<a href="#l62.383"></a><span id="l62.383" class="difflineplus">+          // allow custom action to affect new</span>
<a href="#l62.384"></a><span id="l62.384" class="difflineplus">+          msgHdr-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l62.385"></a><span id="l62.385" class="difflineplus">+          if (!(msgFlags &amp; nsMsgMessageFlags::New))</span>
<a href="#l62.386"></a><span id="l62.386" class="difflineplus">+            msgIsNew = PR_FALSE;</span>
<a href="#l62.387"></a><span id="l62.387">         }</span>
<a href="#l62.388"></a><span id="l62.388">         break;</span>
<a href="#l62.389"></a><span id="l62.389"> </span>
<a href="#l62.390"></a><span id="l62.390">         default:</span>
<a href="#l62.391"></a><span id="l62.391">           break;</span>
<a href="#l62.392"></a><span id="l62.392">       }</span>
<a href="#l62.393"></a><span id="l62.393">       if (loggingEnabled)</span>
<a href="#l62.394"></a><span id="l62.394">       {</span>
<a href="#l62.395"></a><span id="l62.395" class="difflineat">@@ -3543,17 +3681,23 @@ NS_IMETHODIMP nsImapMailFolder::ApplyFil</span>
<a href="#l62.396"></a><span id="l62.396">           (void) filter-&gt;LogRuleHit(filterAction, msgHdr);</span>
<a href="#l62.397"></a><span id="l62.397">       }</span>
<a href="#l62.398"></a><span id="l62.398">     }</span>
<a href="#l62.399"></a><span id="l62.399">   }</span>
<a href="#l62.400"></a><span id="l62.400">   if (!msgIsNew)</span>
<a href="#l62.401"></a><span id="l62.401">   {</span>
<a href="#l62.402"></a><span id="l62.402">     PRInt32 numNewMessages;</span>
<a href="#l62.403"></a><span id="l62.403">     GetNumNewMessages(PR_FALSE, &amp;numNewMessages);</span>
<a href="#l62.404"></a><span id="l62.404" class="difflineminus">-    SetNumNewMessages(numNewMessages - 1);</span>
<a href="#l62.405"></a><span id="l62.405" class="difflineplus">+    // When database notifications are active, new counts will be reset</span>
<a href="#l62.406"></a><span id="l62.406" class="difflineplus">+    // to zero in nsMsgDBFolder::SendFlagNotifications by the call to</span>
<a href="#l62.407"></a><span id="l62.407" class="difflineplus">+    // SetBiffState(nsMsgBiffState_NoMail), so don't repeat them here.</span>
<a href="#l62.408"></a><span id="l62.408" class="difflineplus">+    if (!m_filterListRequiresBody)</span>
<a href="#l62.409"></a><span id="l62.409" class="difflineplus">+      SetNumNewMessages(--numNewMessages);</span>
<a href="#l62.410"></a><span id="l62.410" class="difflineplus">+    if (mDatabase)</span>
<a href="#l62.411"></a><span id="l62.411" class="difflineplus">+      mDatabase-&gt;MarkHdrNotNew(msgHdr, nsnull);</span>
<a href="#l62.412"></a><span id="l62.412">   }</span>
<a href="#l62.413"></a><span id="l62.413">   return NS_OK;</span>
<a href="#l62.414"></a><span id="l62.414"> }</span>
<a href="#l62.415"></a><span id="l62.415"> </span>
<a href="#l62.416"></a><span id="l62.416"> NS_IMETHODIMP nsImapMailFolder::SetImapFlags(const char *uids, PRInt32 flags, nsIURI **url)</span>
<a href="#l62.417"></a><span id="l62.417"> {</span>
<a href="#l62.418"></a><span id="l62.418">   nsresult rv;</span>
<a href="#l62.419"></a><span id="l62.419">   nsCOMPtr&lt;nsIImapService&gt; imapService = do_GetService(NS_IMAPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l62.420"></a><span id="l62.420" class="difflineat">@@ -4292,16 +4436,71 @@ void nsImapMailFolder::EndOfflineDownloa</span>
<a href="#l62.421"></a><span id="l62.421"> NS_IMETHODIMP</span>
<a href="#l62.422"></a><span id="l62.422"> nsImapMailFolder::NormalEndMsgWriteStream(nsMsgKey uidOfMessage,</span>
<a href="#l62.423"></a><span id="l62.423">                                           PRBool markRead,</span>
<a href="#l62.424"></a><span id="l62.424">                                           nsIImapUrl *imapUrl)</span>
<a href="#l62.425"></a><span id="l62.425"> {</span>
<a href="#l62.426"></a><span id="l62.426">   if (m_offlineHeader)</span>
<a href="#l62.427"></a><span id="l62.427">     EndNewOfflineMessage();</span>
<a href="#l62.428"></a><span id="l62.428">   m_curMsgUid = uidOfMessage;</span>
<a href="#l62.429"></a><span id="l62.429" class="difflineplus">+</span>
<a href="#l62.430"></a><span id="l62.430" class="difflineplus">+  // Apply filter now if it needed a body</span>
<a href="#l62.431"></a><span id="l62.431" class="difflineplus">+  if (m_filterListRequiresBody)</span>
<a href="#l62.432"></a><span id="l62.432" class="difflineplus">+  {</span>
<a href="#l62.433"></a><span id="l62.433" class="difflineplus">+    if (m_filterList)</span>
<a href="#l62.434"></a><span id="l62.434" class="difflineplus">+    {</span>
<a href="#l62.435"></a><span id="l62.435" class="difflineplus">+      nsCOMPtr&lt;nsIMsgDBHdr&gt; newMsgHdr;</span>
<a href="#l62.436"></a><span id="l62.436" class="difflineplus">+      GetMessageHeader(uidOfMessage, getter_AddRefs(newMsgHdr));</span>
<a href="#l62.437"></a><span id="l62.437" class="difflineplus">+      GetMoveCoalescer();</span>
<a href="#l62.438"></a><span id="l62.438" class="difflineplus">+      nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l62.439"></a><span id="l62.439" class="difflineplus">+      if (imapUrl)</span>
<a href="#l62.440"></a><span id="l62.440" class="difflineplus">+      {</span>
<a href="#l62.441"></a><span id="l62.441" class="difflineplus">+        nsresult rv;</span>
<a href="#l62.442"></a><span id="l62.442" class="difflineplus">+        nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgUrl;</span>
<a href="#l62.443"></a><span id="l62.443" class="difflineplus">+        msgUrl = do_QueryInterface(imapUrl, &amp;rv);</span>
<a href="#l62.444"></a><span id="l62.444" class="difflineplus">+        if (msgUrl &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l62.445"></a><span id="l62.445" class="difflineplus">+          msgUrl-&gt;GetMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l62.446"></a><span id="l62.446" class="difflineplus">+      }</span>
<a href="#l62.447"></a><span id="l62.447" class="difflineplus">+      m_filterList-&gt;ApplyFiltersToHdr(nsMsgFilterType::InboxRule, newMsgHdr,</span>
<a href="#l62.448"></a><span id="l62.448" class="difflineplus">+                                      this, mDatabase, nsnull, nsnull, this,</span>
<a href="#l62.449"></a><span id="l62.449" class="difflineplus">+                                      msgWindow, nsnull);</span>
<a href="#l62.450"></a><span id="l62.450" class="difflineplus">+      NotifyFolderEvent(mFiltersAppliedAtom);</span>
<a href="#l62.451"></a><span id="l62.451" class="difflineplus">+    }</span>
<a href="#l62.452"></a><span id="l62.452" class="difflineplus">+    // Process filter plugins and other items normally done at the end of</span>
<a href="#l62.453"></a><span id="l62.453" class="difflineplus">+    // HeaderFetchCompleted.</span>
<a href="#l62.454"></a><span id="l62.454" class="difflineplus">+    PRBool pendingMoves = m_moveCoalescer &amp;&amp; m_moveCoalescer-&gt;HasPendingMoves();</span>
<a href="#l62.455"></a><span id="l62.455" class="difflineplus">+    PlaybackCoalescedOperations();</span>
<a href="#l62.456"></a><span id="l62.456" class="difflineplus">+</span>
<a href="#l62.457"></a><span id="l62.457" class="difflineplus">+    PRBool filtersRun;</span>
<a href="#l62.458"></a><span id="l62.458" class="difflineplus">+    CallFilterPlugins(nsnull, &amp;filtersRun);</span>
<a href="#l62.459"></a><span id="l62.459" class="difflineplus">+    PRInt32 numNewBiffMsgs = 0;</span>
<a href="#l62.460"></a><span id="l62.460" class="difflineplus">+    if (m_performingBiff)</span>
<a href="#l62.461"></a><span id="l62.461" class="difflineplus">+      GetNumNewMessages(PR_FALSE, &amp;numNewBiffMsgs);</span>
<a href="#l62.462"></a><span id="l62.462" class="difflineplus">+</span>
<a href="#l62.463"></a><span id="l62.463" class="difflineplus">+    if (!filtersRun &amp;&amp; m_performingBiff &amp;&amp; mDatabase &amp;&amp; numNewBiffMsgs &gt; 0 &amp;&amp;</span>
<a href="#l62.464"></a><span id="l62.464" class="difflineplus">+        (!pendingMoves || !ShowPreviewText()))</span>
<a href="#l62.465"></a><span id="l62.465" class="difflineplus">+    {</span>
<a href="#l62.466"></a><span id="l62.466" class="difflineplus">+      // If we are performing biff for this folder, tell the</span>
<a href="#l62.467"></a><span id="l62.467" class="difflineplus">+      // stand-alone biff about the new high water mark</span>
<a href="#l62.468"></a><span id="l62.468" class="difflineplus">+      // We must ensure that the server knows that we are performing biff.</span>
<a href="#l62.469"></a><span id="l62.469" class="difflineplus">+      // Otherwise the stand-alone biff won't fire.</span>
<a href="#l62.470"></a><span id="l62.470" class="difflineplus">+      nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l62.471"></a><span id="l62.471" class="difflineplus">+      if (NS_SUCCEEDED(GetServer(getter_AddRefs(server))) &amp;&amp; server)</span>
<a href="#l62.472"></a><span id="l62.472" class="difflineplus">+        server-&gt;SetPerformingBiff(PR_TRUE);</span>
<a href="#l62.473"></a><span id="l62.473" class="difflineplus">+</span>
<a href="#l62.474"></a><span id="l62.474" class="difflineplus">+      SetBiffState(nsIMsgFolder::nsMsgBiffState_NewMail);</span>
<a href="#l62.475"></a><span id="l62.475" class="difflineplus">+      if (server)</span>
<a href="#l62.476"></a><span id="l62.476" class="difflineplus">+        server-&gt;SetPerformingBiff(PR_FALSE);</span>
<a href="#l62.477"></a><span id="l62.477" class="difflineplus">+      m_performingBiff = PR_FALSE;</span>
<a href="#l62.478"></a><span id="l62.478" class="difflineplus">+    }</span>
<a href="#l62.479"></a><span id="l62.479" class="difflineplus">+</span>
<a href="#l62.480"></a><span id="l62.480" class="difflineplus">+    if (m_filterList)</span>
<a href="#l62.481"></a><span id="l62.481" class="difflineplus">+      (void)m_filterList-&gt;FlushLogIfNecessary();</span>
<a href="#l62.482"></a><span id="l62.482" class="difflineplus">+  }</span>
<a href="#l62.483"></a><span id="l62.483" class="difflineplus">+</span>
<a href="#l62.484"></a><span id="l62.484">   return NS_OK;</span>
<a href="#l62.485"></a><span id="l62.485"> }</span>
<a href="#l62.486"></a><span id="l62.486"> </span>
<a href="#l62.487"></a><span id="l62.487"> NS_IMETHODIMP</span>
<a href="#l62.488"></a><span id="l62.488"> nsImapMailFolder::AbortMsgWriteStream()</span>
<a href="#l62.489"></a><span id="l62.489"> {</span>
<a href="#l62.490"></a><span id="l62.490">   m_offlineHeader = nsnull;</span>
<a href="#l62.491"></a><span id="l62.491">   return NS_ERROR_FAILURE;</span>
<a href="#l62.492"></a><span id="l62.492" class="difflineat">@@ -5365,16 +5564,18 @@ nsImapMailFolder::HeaderFetchCompleted(n</span>
<a href="#l62.493"></a><span id="l62.493"> </span>
<a href="#l62.494"></a><span id="l62.494">     PRBool autoDownloadNewHeaders = PR_FALSE;</span>
<a href="#l62.495"></a><span id="l62.495">     PRBool autoSyncOfflineStores = PR_FALSE;</span>
<a href="#l62.496"></a><span id="l62.496"> </span>
<a href="#l62.497"></a><span id="l62.497">     if (imapServer)</span>
<a href="#l62.498"></a><span id="l62.498">     {</span>
<a href="#l62.499"></a><span id="l62.499">       imapServer-&gt;GetAutoSyncOfflineStores(&amp;autoSyncOfflineStores);</span>
<a href="#l62.500"></a><span id="l62.500">       imapServer-&gt;GetDownloadBodiesOnGetNewMail(&amp;autoDownloadNewHeaders);</span>
<a href="#l62.501"></a><span id="l62.501" class="difflineplus">+      if (m_filterListRequiresBody)</span>
<a href="#l62.502"></a><span id="l62.502" class="difflineplus">+        autoDownloadNewHeaders = PR_TRUE;</span>
<a href="#l62.503"></a><span id="l62.503">     }</span>
<a href="#l62.504"></a><span id="l62.504">     PRBool notifiedBodies = PR_FALSE;</span>
<a href="#l62.505"></a><span id="l62.505">     if (m_downloadingFolderForOfflineUse || autoSyncOfflineStores ||</span>
<a href="#l62.506"></a><span id="l62.506">         autoDownloadNewHeaders)</span>
<a href="#l62.507"></a><span id="l62.507">     {</span>
<a href="#l62.508"></a><span id="l62.508">       nsTArray&lt;nsMsgKey&gt; keysToDownload;</span>
<a href="#l62.509"></a><span id="l62.509">       GetBodysToDownload(&amp;keysToDownload);</span>
<a href="#l62.510"></a><span id="l62.510">       if (!keysToDownload.IsEmpty())</span>
<a href="#l62.511"></a><span id="l62.511" class="difflineat">@@ -5405,40 +5606,41 @@ nsImapMailFolder::HeaderFetchCompleted(n</span>
<a href="#l62.512"></a><span id="l62.512">     if (runningUri)</span>
<a href="#l62.513"></a><span id="l62.513">     {</span>
<a href="#l62.514"></a><span id="l62.514">       nsCOMPtr &lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(runningUri);</span>
<a href="#l62.515"></a><span id="l62.515">       if (mailnewsUrl)</span>
<a href="#l62.516"></a><span id="l62.516">         mailnewsUrl-&gt;GetMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l62.517"></a><span id="l62.517">     }</span>
<a href="#l62.518"></a><span id="l62.518">   }</span>
<a href="#l62.519"></a><span id="l62.519"> </span>
<a href="#l62.520"></a><span id="l62.520" class="difflineminus">-  PRBool filtersRun;</span>
<a href="#l62.521"></a><span id="l62.521" class="difflineminus">-  CallFilterPlugins(msgWindow, &amp;filtersRun);</span>
<a href="#l62.522"></a><span id="l62.522" class="difflineminus">-  if (!filtersRun &amp;&amp; m_performingBiff &amp;&amp; mDatabase &amp;&amp; numNewBiffMsgs &gt; 0 &amp;&amp;</span>
<a href="#l62.523"></a><span id="l62.523" class="difflineminus">-      (!pendingMoves || !ShowPreviewText()))</span>
<a href="#l62.524"></a><span id="l62.524" class="difflineminus">-  {</span>
<a href="#l62.525"></a><span id="l62.525" class="difflineminus">-    if (!pendingMoves)</span>
<a href="#l62.526"></a><span id="l62.526" class="difflineminus">-      SetHasNewMessages(PR_TRUE);</span>
<a href="#l62.527"></a><span id="l62.527" class="difflineminus">-</span>
<a href="#l62.528"></a><span id="l62.528" class="difflineminus">-    // If we are performing biff for this folder, tell the</span>
<a href="#l62.529"></a><span id="l62.529" class="difflineminus">-    // stand-alone biff about the new high water mark</span>
<a href="#l62.530"></a><span id="l62.530" class="difflineminus">-    // We must ensure that the server knows that we are performing biff.</span>
<a href="#l62.531"></a><span id="l62.531" class="difflineminus">-    // Otherwise the stand-alone biff won't fire.</span>
<a href="#l62.532"></a><span id="l62.532" class="difflineminus">-    nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l62.533"></a><span id="l62.533" class="difflineminus">-    if (NS_SUCCEEDED(GetServer(getter_AddRefs(server))) &amp;&amp; server)</span>
<a href="#l62.534"></a><span id="l62.534" class="difflineminus">-      server-&gt;SetPerformingBiff(PR_TRUE);</span>
<a href="#l62.535"></a><span id="l62.535" class="difflineminus">-</span>
<a href="#l62.536"></a><span id="l62.536" class="difflineminus">-    SetBiffState(nsIMsgFolder::nsMsgBiffState_NewMail);</span>
<a href="#l62.537"></a><span id="l62.537" class="difflineminus">-    if (server)</span>
<a href="#l62.538"></a><span id="l62.538" class="difflineminus">-      server-&gt;SetPerformingBiff(PR_FALSE);</span>
<a href="#l62.539"></a><span id="l62.539" class="difflineminus">-    m_performingBiff = PR_FALSE;</span>
<a href="#l62.540"></a><span id="l62.540" class="difflineminus">-  }</span>
<a href="#l62.541"></a><span id="l62.541" class="difflineminus">-</span>
<a href="#l62.542"></a><span id="l62.542" class="difflineminus">-  if (m_filterList)</span>
<a href="#l62.543"></a><span id="l62.543" class="difflineminus">-    (void)m_filterList-&gt;FlushLogIfNecessary();</span>
<a href="#l62.544"></a><span id="l62.544" class="difflineplus">+  // delay calling plugins if filter application is also delayed</span>
<a href="#l62.545"></a><span id="l62.545" class="difflineplus">+  if (!m_filterListRequiresBody)</span>
<a href="#l62.546"></a><span id="l62.546" class="difflineplus">+  {</span>
<a href="#l62.547"></a><span id="l62.547" class="difflineplus">+    PRBool filtersRun;</span>
<a href="#l62.548"></a><span id="l62.548" class="difflineplus">+    CallFilterPlugins(msgWindow, &amp;filtersRun);</span>
<a href="#l62.549"></a><span id="l62.549" class="difflineplus">+    if (!filtersRun &amp;&amp; m_performingBiff &amp;&amp; mDatabase &amp;&amp; numNewBiffMsgs &gt; 0 &amp;&amp;</span>
<a href="#l62.550"></a><span id="l62.550" class="difflineplus">+        (!pendingMoves || !ShowPreviewText()))</span>
<a href="#l62.551"></a><span id="l62.551" class="difflineplus">+    {</span>
<a href="#l62.552"></a><span id="l62.552" class="difflineplus">+      // If we are performing biff for this folder, tell the</span>
<a href="#l62.553"></a><span id="l62.553" class="difflineplus">+      // stand-alone biff about the new high water mark</span>
<a href="#l62.554"></a><span id="l62.554" class="difflineplus">+      // We must ensure that the server knows that we are performing biff.</span>
<a href="#l62.555"></a><span id="l62.555" class="difflineplus">+      // Otherwise the stand-alone biff won't fire.</span>
<a href="#l62.556"></a><span id="l62.556" class="difflineplus">+      nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l62.557"></a><span id="l62.557" class="difflineplus">+      if (NS_SUCCEEDED(GetServer(getter_AddRefs(server))) &amp;&amp; server)</span>
<a href="#l62.558"></a><span id="l62.558" class="difflineplus">+        server-&gt;SetPerformingBiff(PR_TRUE);</span>
<a href="#l62.559"></a><span id="l62.559" class="difflineplus">+</span>
<a href="#l62.560"></a><span id="l62.560" class="difflineplus">+      SetBiffState(nsIMsgFolder::nsMsgBiffState_NewMail);</span>
<a href="#l62.561"></a><span id="l62.561" class="difflineplus">+      if (server)</span>
<a href="#l62.562"></a><span id="l62.562" class="difflineplus">+        server-&gt;SetPerformingBiff(PR_FALSE);</span>
<a href="#l62.563"></a><span id="l62.563" class="difflineplus">+      m_performingBiff = PR_FALSE;</span>
<a href="#l62.564"></a><span id="l62.564" class="difflineplus">+    }</span>
<a href="#l62.565"></a><span id="l62.565" class="difflineplus">+</span>
<a href="#l62.566"></a><span id="l62.566" class="difflineplus">+    if (m_filterList)</span>
<a href="#l62.567"></a><span id="l62.567" class="difflineplus">+      (void)m_filterList-&gt;FlushLogIfNecessary();</span>
<a href="#l62.568"></a><span id="l62.568" class="difflineplus">+  }</span>
<a href="#l62.569"></a><span id="l62.569"> </span>
<a href="#l62.570"></a><span id="l62.570">   return NS_OK;</span>
<a href="#l62.571"></a><span id="l62.571"> }</span>
<a href="#l62.572"></a><span id="l62.572"> </span>
<a href="#l62.573"></a><span id="l62.573"> NS_IMETHODIMP</span>
<a href="#l62.574"></a><span id="l62.574"> nsImapMailFolder::SetBiffStateAndUpdate(nsMsgBiffState biffState)</span>
<a href="#l62.575"></a><span id="l62.575"> {</span>
<a href="#l62.576"></a><span id="l62.576">   SetBiffState(biffState);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l63.1"></a><span id="l63.1" class="difflineminus">--- a/mailnews/imap/src/nsImapMailFolder.h</span>
<a href="#l63.2"></a><span id="l63.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapMailFolder.h</span>
<a href="#l63.3"></a><span id="l63.3" class="difflineat">@@ -502,16 +502,17 @@ protected:</span>
<a href="#l63.4"></a><span id="l63.4">   nsMsgIMAPFolderACL *m_folderACL;</span>
<a href="#l63.5"></a><span id="l63.5">   PRUint32     m_aclFlags;</span>
<a href="#l63.6"></a><span id="l63.6">   PRUint32     m_supportedUserFlags;</span>
<a href="#l63.7"></a><span id="l63.7"> </span>
<a href="#l63.8"></a><span id="l63.8">   static nsIAtom* mImapHdrDownloadedAtom;</span>
<a href="#l63.9"></a><span id="l63.9"> </span>
<a href="#l63.10"></a><span id="l63.10">   // offline imap support</span>
<a href="#l63.11"></a><span id="l63.11">   PRBool m_downloadingFolderForOfflineUse;</span>
<a href="#l63.12"></a><span id="l63.12" class="difflineplus">+  PRBool m_filterListRequiresBody;</span>
<a href="#l63.13"></a><span id="l63.13">   </span>
<a href="#l63.14"></a><span id="l63.14">   // auto-sync (preemptive download) support</span>
<a href="#l63.15"></a><span id="l63.15">   nsRefPtr&lt;nsAutoSyncState&gt; m_autoSyncStateObj;</span>
<a href="#l63.16"></a><span id="l63.16">   </span>
<a href="#l63.17"></a><span id="l63.17">   // Quota support</span>
<a href="#l63.18"></a><span id="l63.18">   nsCString m_folderQuotaRoot;</span>
<a href="#l63.19"></a><span id="l63.19">   PRUint32 m_folderQuotaUsedKB;</span>
<a href="#l63.20"></a><span id="l63.20">   PRUint32 m_folderQuotaMaxKB;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l64.1"></a><span id="l64.1" class="difflineminus">--- a/mailnews/imap/src/nsImapProtocol.cpp</span>
<a href="#l64.2"></a><span id="l64.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapProtocol.cpp</span>
<a href="#l64.3"></a><span id="l64.3" class="difflineat">@@ -764,16 +764,18 @@ nsresult nsImapProtocol::SetupWithUrl(ns</span>
<a href="#l64.4"></a><span id="l64.4">       // if we have a listener from a mock channel, over-ride the consumer that was passed in</span>
<a href="#l64.5"></a><span id="l64.5">       nsCOMPtr&lt;nsIStreamListener&gt; channelListener;</span>
<a href="#l64.6"></a><span id="l64.6">       m_mockChannel-&gt;GetChannelListener(getter_AddRefs(channelListener));</span>
<a href="#l64.7"></a><span id="l64.7">       if (channelListener) // only over-ride if we have a non null channel listener</span>
<a href="#l64.8"></a><span id="l64.8">         aRealStreamListener = channelListener;</span>
<a href="#l64.9"></a><span id="l64.9">       m_mockChannel-&gt;GetChannelContext(getter_AddRefs(m_channelContext));</span>
<a href="#l64.10"></a><span id="l64.10">       nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l64.11"></a><span id="l64.11">       GetMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l64.12"></a><span id="l64.12" class="difflineplus">+      if (!msgWindow)</span>
<a href="#l64.13"></a><span id="l64.13" class="difflineplus">+        GetTopmostMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l64.14"></a><span id="l64.14">       if (msgWindow)</span>
<a href="#l64.15"></a><span id="l64.15">       {</span>
<a href="#l64.16"></a><span id="l64.16">         nsCOMPtr&lt;nsIInterfaceRequestor&gt; interfaceRequestor;</span>
<a href="#l64.17"></a><span id="l64.17">         msgWindow-&gt;GetNotificationCallbacks(getter_AddRefs(interfaceRequestor));</span>
<a href="#l64.18"></a><span id="l64.18">         m_mockChannel-&gt;SetNotificationCallbacks(interfaceRequestor);</span>
<a href="#l64.19"></a><span id="l64.19">       }</span>
<a href="#l64.20"></a><span id="l64.20">     }</span>
<a href="#l64.21"></a><span id="l64.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l65.1"></a><span id="l65.1">new file mode 100644</span>
<a href="#l65.2"></a><span id="l65.2" class="difflineminus">--- /dev/null</span>
<a href="#l65.3"></a><span id="l65.3" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapFilterActions.js</span>
<a href="#l65.4"></a><span id="l65.4" class="difflineat">@@ -0,0 +1,774 @@</span>
<a href="#l65.5"></a><span id="l65.5" class="difflineplus">+/*</span>
<a href="#l65.6"></a><span id="l65.6" class="difflineplus">+ * This file tests imap filter actions, particularly as affected by the</span>
<a href="#l65.7"></a><span id="l65.7" class="difflineplus">+ * addition of body searches in bug 127250. Actions that involves sending</span>
<a href="#l65.8"></a><span id="l65.8" class="difflineplus">+ * mail are not tested. The tests check various counts, and the effects</span>
<a href="#l65.9"></a><span id="l65.9" class="difflineplus">+ * on the message database of the filters. Effects on IMAP server</span>
<a href="#l65.10"></a><span id="l65.10" class="difflineplus">+ * flags, if any, are not tested.</span>
<a href="#l65.11"></a><span id="l65.11" class="difflineplus">+ *</span>
<a href="#l65.12"></a><span id="l65.12" class="difflineplus">+ * Original author: Kent James &lt;kent@caspia.com&gt;</span>
<a href="#l65.13"></a><span id="l65.13" class="difflineplus">+ * adapted from test_localToImapFilter.js</span>
<a href="#l65.14"></a><span id="l65.14" class="difflineplus">+ */</span>
<a href="#l65.15"></a><span id="l65.15" class="difflineplus">+</span>
<a href="#l65.16"></a><span id="l65.16" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/iteratorUtils.jsm&quot;);</span>
<a href="#l65.17"></a><span id="l65.17" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/folderUtils.jsm&quot;);</span>
<a href="#l65.18"></a><span id="l65.18" class="difflineplus">+</span>
<a href="#l65.19"></a><span id="l65.19" class="difflineplus">+const nsMsgSearchScope = Ci.nsMsgSearchScope;</span>
<a href="#l65.20"></a><span id="l65.20" class="difflineplus">+const nsMsgSearchAttrib = Ci.nsMsgSearchAttrib;</span>
<a href="#l65.21"></a><span id="l65.21" class="difflineplus">+const nsMsgSearchOp = Ci.nsMsgSearchOp;</span>
<a href="#l65.22"></a><span id="l65.22" class="difflineplus">+const Is = nsMsgSearchOp.Is;</span>
<a href="#l65.23"></a><span id="l65.23" class="difflineplus">+const Contains = nsMsgSearchOp.Contains;</span>
<a href="#l65.24"></a><span id="l65.24" class="difflineplus">+const Subject = nsMsgSearchAttrib.Subject;</span>
<a href="#l65.25"></a><span id="l65.25" class="difflineplus">+const Body = nsMsgSearchAttrib.Body;</span>
<a href="#l65.26"></a><span id="l65.26" class="difflineplus">+</span>
<a href="#l65.27"></a><span id="l65.27" class="difflineplus">+// Globals</span>
<a href="#l65.28"></a><span id="l65.28" class="difflineplus">+var gIMAPDaemon; // the imap fake server daemon</span>
<a href="#l65.29"></a><span id="l65.29" class="difflineplus">+var gServer; // the imap fake server</span>
<a href="#l65.30"></a><span id="l65.30" class="difflineplus">+var gIMAPIncomingServer; // nsIMsgIncomingServer for the imap server</span>
<a href="#l65.31"></a><span id="l65.31" class="difflineplus">+var gRootFolder; // root message folder for the imap server</span>
<a href="#l65.32"></a><span id="l65.32" class="difflineplus">+var gIMAPInbox; // imap inbox message folder</span>
<a href="#l65.33"></a><span id="l65.33" class="difflineplus">+var gIMAPTrashFolder; // imap trash message folder</span>
<a href="#l65.34"></a><span id="l65.34" class="difflineplus">+var gSubfolder; // a local message folder used as a target for moves and copies</span>
<a href="#l65.35"></a><span id="l65.35" class="difflineplus">+var gLastKey; // the last message key</span>
<a href="#l65.36"></a><span id="l65.36" class="difflineplus">+var gFilter; // a message filter with a subject search</span>
<a href="#l65.37"></a><span id="l65.37" class="difflineplus">+var gAction; // current message action (reused)</span>
<a href="#l65.38"></a><span id="l65.38" class="difflineplus">+var gBodyFilter; // a message filter with a body search</span>
<a href="#l65.39"></a><span id="l65.39" class="difflineplus">+var gInboxListener; // database listener object</span>
<a href="#l65.40"></a><span id="l65.40" class="difflineplus">+var gContinueListener; // what listener is used to continue the test?</span>
<a href="#l65.41"></a><span id="l65.41" class="difflineplus">+var gHeader; // the current message db header</span>
<a href="#l65.42"></a><span id="l65.42" class="difflineplus">+var gChecks; // the function that will be used to check the results of the filter</span>
<a href="#l65.43"></a><span id="l65.43" class="difflineplus">+var gInboxCount; // the previous number of messages in the Inbox</span>
<a href="#l65.44"></a><span id="l65.44" class="difflineplus">+var gSubfolderCount; // the previous number of messages in the subfolder</span>
<a href="#l65.45"></a><span id="l65.45" class="difflineplus">+var gMoveCallbackCount; // the number of callbacks from the move listener</span>
<a href="#l65.46"></a><span id="l65.46" class="difflineplus">+const gMessage = &quot;draft1&quot;; // message file used as the test message</span>
<a href="#l65.47"></a><span id="l65.47" class="difflineplus">+</span>
<a href="#l65.48"></a><span id="l65.48" class="difflineplus">+// subject of the test message</span>
<a href="#l65.49"></a><span id="l65.49" class="difflineplus">+const gMessageSubject = &quot;Hello, did you receive my bugmail?&quot;;</span>
<a href="#l65.50"></a><span id="l65.50" class="difflineplus">+</span>
<a href="#l65.51"></a><span id="l65.51" class="difflineplus">+// a string in the body of the test message</span>
<a href="#l65.52"></a><span id="l65.52" class="difflineplus">+const gMessageInBody = &quot;an HTML message&quot;;</span>
<a href="#l65.53"></a><span id="l65.53" class="difflineplus">+</span>
<a href="#l65.54"></a><span id="l65.54" class="difflineplus">+// various object references</span>
<a href="#l65.55"></a><span id="l65.55" class="difflineplus">+const gCopyService = Cc[&quot;@mozilla.org/messenger/messagecopyservice;1&quot;]</span>
<a href="#l65.56"></a><span id="l65.56" class="difflineplus">+                       .getService(Ci.nsIMsgCopyService);</span>
<a href="#l65.57"></a><span id="l65.57" class="difflineplus">+const gDbService = Components.classes[&quot;@mozilla.org/msgDatabase/msgDBService;1&quot;]</span>
<a href="#l65.58"></a><span id="l65.58" class="difflineplus">+                             .getService(Components.interfaces.nsIMsgDBService);</span>
<a href="#l65.59"></a><span id="l65.59" class="difflineplus">+const gIMAPService = Cc[&quot;@mozilla.org/messenger/messageservice;1?type=imap&quot;]</span>
<a href="#l65.60"></a><span id="l65.60" class="difflineplus">+                       .getService(Ci.nsIMsgMessageService);</span>
<a href="#l65.61"></a><span id="l65.61" class="difflineplus">+const gMailSession = Cc[&quot;@mozilla.org/messenger/services/session;1&quot;]</span>
<a href="#l65.62"></a><span id="l65.62" class="difflineplus">+                     .getService(Ci.nsIMsgMailSession);</span>
<a href="#l65.63"></a><span id="l65.63" class="difflineplus">+const kFiltersAppliedAtom = Cc[&quot;@mozilla.org/atom-service;1&quot;]</span>
<a href="#l65.64"></a><span id="l65.64" class="difflineplus">+                              .getService(Ci.nsIAtomService)</span>
<a href="#l65.65"></a><span id="l65.65" class="difflineplus">+                              .getAtom(&quot;FiltersApplied&quot;);</span>
<a href="#l65.66"></a><span id="l65.66" class="difflineplus">+const kDeleteOrMoveMsgCompleted = Cc[&quot;@mozilla.org/atom-service;1&quot;]</span>
<a href="#l65.67"></a><span id="l65.67" class="difflineplus">+                                    .getService(Ci.nsIAtomService)</span>
<a href="#l65.68"></a><span id="l65.68" class="difflineplus">+                                    .getAtom(&quot;DeleteOrMoveMsgCompleted&quot;);</span>
<a href="#l65.69"></a><span id="l65.69" class="difflineplus">+</span>
<a href="#l65.70"></a><span id="l65.70" class="difflineplus">+// Definition of tests. The test function name is the filter action</span>
<a href="#l65.71"></a><span id="l65.71" class="difflineplus">+// being tested, with &quot;Body&quot; appended to tests that use delayed</span>
<a href="#l65.72"></a><span id="l65.72" class="difflineplus">+// application of filters due to a body search</span>
<a href="#l65.73"></a><span id="l65.73" class="difflineplus">+const gTestArray =</span>
<a href="#l65.74"></a><span id="l65.74" class="difflineplus">+[  // The initial tests do not result in new messages added.</span>
<a href="#l65.75"></a><span id="l65.75" class="difflineplus">+  function MoveToFolder() {</span>
<a href="#l65.76"></a><span id="l65.76" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.MoveToFolder;</span>
<a href="#l65.77"></a><span id="l65.77" class="difflineplus">+    gAction.targetFolderUri = gSubfolder.URI;</span>
<a href="#l65.78"></a><span id="l65.78" class="difflineplus">+    gChecks = function checkMoveToFolder() {</span>
<a href="#l65.79"></a><span id="l65.79" class="difflineplus">+      testCounts(false, 0, 0, 0);</span>
<a href="#l65.80"></a><span id="l65.80" class="difflineplus">+      do_check_eq(gSubfolderCount + 1, folderCount(gSubfolder));</span>
<a href="#l65.81"></a><span id="l65.81" class="difflineplus">+      // no net messages were added to the inbox</span>
<a href="#l65.82"></a><span id="l65.82" class="difflineplus">+      do_check_eq(gInboxCount, folderCount(gIMAPInbox));</span>
<a href="#l65.83"></a><span id="l65.83" class="difflineplus">+    }</span>
<a href="#l65.84"></a><span id="l65.84" class="difflineplus">+    gInboxCount = folderCount(gIMAPInbox);</span>
<a href="#l65.85"></a><span id="l65.85" class="difflineplus">+    gSubfolderCount = folderCount(gSubfolder);</span>
<a href="#l65.86"></a><span id="l65.86" class="difflineplus">+    setupTest(gFilter, gAction);</span>
<a href="#l65.87"></a><span id="l65.87" class="difflineplus">+  },</span>
<a href="#l65.88"></a><span id="l65.88" class="difflineplus">+  function MoveToFolderBody() {</span>
<a href="#l65.89"></a><span id="l65.89" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.MoveToFolder;</span>
<a href="#l65.90"></a><span id="l65.90" class="difflineplus">+    gAction.targetFolderUri = gSubfolder.URI;</span>
<a href="#l65.91"></a><span id="l65.91" class="difflineplus">+    gChecks = function checkMoveToFolderBody() {</span>
<a href="#l65.92"></a><span id="l65.92" class="difflineplus">+      testCounts(false, 0, 0, 0);</span>
<a href="#l65.93"></a><span id="l65.93" class="difflineplus">+      do_check_eq(gSubfolderCount + 1, folderCount(gSubfolder));</span>
<a href="#l65.94"></a><span id="l65.94" class="difflineplus">+      // no net messsages were added to the inbox</span>
<a href="#l65.95"></a><span id="l65.95" class="difflineplus">+      do_check_eq(gInboxCount, folderCount(gIMAPInbox));</span>
<a href="#l65.96"></a><span id="l65.96" class="difflineplus">+    }</span>
<a href="#l65.97"></a><span id="l65.97" class="difflineplus">+    gInboxCount = folderCount(gIMAPInbox);</span>
<a href="#l65.98"></a><span id="l65.98" class="difflineplus">+    gSubfolderCount = folderCount(gSubfolder);</span>
<a href="#l65.99"></a><span id="l65.99" class="difflineplus">+    setupTest(gBodyFilter, gAction);</span>
<a href="#l65.100"></a><span id="l65.100" class="difflineplus">+  },</span>
<a href="#l65.101"></a><span id="l65.101" class="difflineplus">+  function MarkRead() {</span>
<a href="#l65.102"></a><span id="l65.102" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.MarkRead;</span>
<a href="#l65.103"></a><span id="l65.103" class="difflineplus">+    gChecks = function checks() {</span>
<a href="#l65.104"></a><span id="l65.104" class="difflineplus">+      testCounts(false, 0, 0, 0);</span>
<a href="#l65.105"></a><span id="l65.105" class="difflineplus">+      do_check_true(gHeader.isRead);</span>
<a href="#l65.106"></a><span id="l65.106" class="difflineplus">+    }</span>
<a href="#l65.107"></a><span id="l65.107" class="difflineplus">+    setupTest(gFilter, gAction);</span>
<a href="#l65.108"></a><span id="l65.108" class="difflineplus">+  },</span>
<a href="#l65.109"></a><span id="l65.109" class="difflineplus">+  function MarkReadBody() {</span>
<a href="#l65.110"></a><span id="l65.110" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.MarkRead;</span>
<a href="#l65.111"></a><span id="l65.111" class="difflineplus">+    gChecks = function checkMarkRead() {</span>
<a href="#l65.112"></a><span id="l65.112" class="difflineplus">+      testCounts(false, 0, 0, 0);</span>
<a href="#l65.113"></a><span id="l65.113" class="difflineplus">+      do_check_true(gHeader.isRead);</span>
<a href="#l65.114"></a><span id="l65.114" class="difflineplus">+    }</span>
<a href="#l65.115"></a><span id="l65.115" class="difflineplus">+    setupTest(gBodyFilter, gAction);</span>
<a href="#l65.116"></a><span id="l65.116" class="difflineplus">+</span>
<a href="#l65.117"></a><span id="l65.117" class="difflineplus">+  },</span>
<a href="#l65.118"></a><span id="l65.118" class="difflineplus">+  function KillThread() {</span>
<a href="#l65.119"></a><span id="l65.119" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.KillThread;</span>
<a href="#l65.120"></a><span id="l65.120" class="difflineplus">+    gChecks = function checkKillThread() {</span>
<a href="#l65.121"></a><span id="l65.121" class="difflineplus">+      testCounts(false, 0, 0, 0);</span>
<a href="#l65.122"></a><span id="l65.122" class="difflineplus">+      let thread = db().GetThreadContainingMsgHdr(gHeader);</span>
<a href="#l65.123"></a><span id="l65.123" class="difflineplus">+      do_check_neq(0, thread.flags &amp; Ci.nsMsgMessageFlags.Ignored);</span>
<a href="#l65.124"></a><span id="l65.124" class="difflineplus">+    }</span>
<a href="#l65.125"></a><span id="l65.125" class="difflineplus">+    setupTest(gFilter, gAction);</span>
<a href="#l65.126"></a><span id="l65.126" class="difflineplus">+  },</span>
<a href="#l65.127"></a><span id="l65.127" class="difflineplus">+  function KillThreadBody() {</span>
<a href="#l65.128"></a><span id="l65.128" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.KillThread;</span>
<a href="#l65.129"></a><span id="l65.129" class="difflineplus">+    gChecks = function checkKillThread() {</span>
<a href="#l65.130"></a><span id="l65.130" class="difflineplus">+      testCounts(false, 0, 0, 0);</span>
<a href="#l65.131"></a><span id="l65.131" class="difflineplus">+      let thread = db().GetThreadContainingMsgHdr(gHeader);</span>
<a href="#l65.132"></a><span id="l65.132" class="difflineplus">+      do_check_neq(0, thread.flags &amp; Ci.nsMsgMessageFlags.Ignored);</span>
<a href="#l65.133"></a><span id="l65.133" class="difflineplus">+    }</span>
<a href="#l65.134"></a><span id="l65.134" class="difflineplus">+    setupTest(gBodyFilter, gAction);</span>
<a href="#l65.135"></a><span id="l65.135" class="difflineplus">+  },</span>
<a href="#l65.136"></a><span id="l65.136" class="difflineplus">+  function KillSubthread() {</span>
<a href="#l65.137"></a><span id="l65.137" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.KillSubthread;</span>
<a href="#l65.138"></a><span id="l65.138" class="difflineplus">+    gChecks = function checkKillSubthread() {</span>
<a href="#l65.139"></a><span id="l65.139" class="difflineplus">+      testCounts(false, 0, 0, 0);</span>
<a href="#l65.140"></a><span id="l65.140" class="difflineplus">+      do_check_neq(0, gHeader.flags &amp; Ci.nsMsgMessageFlags.Ignored);</span>
<a href="#l65.141"></a><span id="l65.141" class="difflineplus">+    }</span>
<a href="#l65.142"></a><span id="l65.142" class="difflineplus">+    setupTest(gFilter, gAction);</span>
<a href="#l65.143"></a><span id="l65.143" class="difflineplus">+  },</span>
<a href="#l65.144"></a><span id="l65.144" class="difflineplus">+  function KillSubthreadBody() {</span>
<a href="#l65.145"></a><span id="l65.145" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.KillSubthread;</span>
<a href="#l65.146"></a><span id="l65.146" class="difflineplus">+    gChecks = function checkKillSubthreadBody() {</span>
<a href="#l65.147"></a><span id="l65.147" class="difflineplus">+      testCounts(false, 0, 0, 0);</span>
<a href="#l65.148"></a><span id="l65.148" class="difflineplus">+      do_check_neq(0, gHeader.flags &amp; Ci.nsMsgMessageFlags.Ignored);</span>
<a href="#l65.149"></a><span id="l65.149" class="difflineplus">+    }</span>
<a href="#l65.150"></a><span id="l65.150" class="difflineplus">+    setupTest(gBodyFilter, gAction);</span>
<a href="#l65.151"></a><span id="l65.151" class="difflineplus">+  },</span>
<a href="#l65.152"></a><span id="l65.152" class="difflineplus">+  // this tests for marking message as junk</span>
<a href="#l65.153"></a><span id="l65.153" class="difflineplus">+  function JunkScore() {</span>
<a href="#l65.154"></a><span id="l65.154" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.JunkScore;</span>
<a href="#l65.155"></a><span id="l65.155" class="difflineplus">+    gAction.junkScore = 100;</span>
<a href="#l65.156"></a><span id="l65.156" class="difflineplus">+    gChecks = function checkJunkScore() {</span>
<a href="#l65.157"></a><span id="l65.157" class="difflineplus">+      // marking as junk resets new but not unread</span>
<a href="#l65.158"></a><span id="l65.158" class="difflineplus">+      testCounts(false, 1, 0, 0);</span>
<a href="#l65.159"></a><span id="l65.159" class="difflineplus">+      do_check_eq(gHeader.getStringProperty(&quot;junkscore&quot;), &quot;100&quot;);</span>
<a href="#l65.160"></a><span id="l65.160" class="difflineplus">+      do_check_eq(gHeader.getStringProperty(&quot;junkscoreorigin&quot;), &quot;filter&quot;);</span>
<a href="#l65.161"></a><span id="l65.161" class="difflineplus">+    }</span>
<a href="#l65.162"></a><span id="l65.162" class="difflineplus">+    setupTest(gFilter, gAction);</span>
<a href="#l65.163"></a><span id="l65.163" class="difflineplus">+  },</span>
<a href="#l65.164"></a><span id="l65.164" class="difflineplus">+  // this tests for marking message as junk</span>
<a href="#l65.165"></a><span id="l65.165" class="difflineplus">+  function JunkScoreBody() {</span>
<a href="#l65.166"></a><span id="l65.166" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.JunkScore;</span>
<a href="#l65.167"></a><span id="l65.167" class="difflineplus">+    gAction.junkScore = 100;</span>
<a href="#l65.168"></a><span id="l65.168" class="difflineplus">+    gChecks = function checkJunkScoreBody() {</span>
<a href="#l65.169"></a><span id="l65.169" class="difflineplus">+      // marking as junk resets new but not unread</span>
<a href="#l65.170"></a><span id="l65.170" class="difflineplus">+      testCounts(false, 1, 0, 0);</span>
<a href="#l65.171"></a><span id="l65.171" class="difflineplus">+      do_check_eq(gHeader.getStringProperty(&quot;junkscore&quot;), &quot;100&quot;);</span>
<a href="#l65.172"></a><span id="l65.172" class="difflineplus">+      do_check_eq(gHeader.getStringProperty(&quot;junkscoreorigin&quot;), &quot;filter&quot;);</span>
<a href="#l65.173"></a><span id="l65.173" class="difflineplus">+    }</span>
<a href="#l65.174"></a><span id="l65.174" class="difflineplus">+    setupTest(gBodyFilter, gAction);</span>
<a href="#l65.175"></a><span id="l65.175" class="difflineplus">+  },</span>
<a href="#l65.176"></a><span id="l65.176" class="difflineplus">+</span>
<a href="#l65.177"></a><span id="l65.177" class="difflineplus">+  // The remaining tests add new messages</span>
<a href="#l65.178"></a><span id="l65.178" class="difflineplus">+  function WatchThread() {</span>
<a href="#l65.179"></a><span id="l65.179" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.WatchThread;</span>
<a href="#l65.180"></a><span id="l65.180" class="difflineplus">+    gChecks = function checkWatchThread() {</span>
<a href="#l65.181"></a><span id="l65.181" class="difflineplus">+      testCounts(true, 1, 1, 1);</span>
<a href="#l65.182"></a><span id="l65.182" class="difflineplus">+      let thread = db().GetThreadContainingMsgHdr(gHeader);</span>
<a href="#l65.183"></a><span id="l65.183" class="difflineplus">+      do_check_neq(0, thread.flags &amp; Ci.nsMsgMessageFlags.Watched);</span>
<a href="#l65.184"></a><span id="l65.184" class="difflineplus">+    }</span>
<a href="#l65.185"></a><span id="l65.185" class="difflineplus">+    setupTest(gFilter, gAction);</span>
<a href="#l65.186"></a><span id="l65.186" class="difflineplus">+  },</span>
<a href="#l65.187"></a><span id="l65.187" class="difflineplus">+  function WatchThreadBody() {</span>
<a href="#l65.188"></a><span id="l65.188" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.WatchThread;</span>
<a href="#l65.189"></a><span id="l65.189" class="difflineplus">+    gChecks = function checkWatchThreadBody() {</span>
<a href="#l65.190"></a><span id="l65.190" class="difflineplus">+      testCounts(true, 1, 1, 1);</span>
<a href="#l65.191"></a><span id="l65.191" class="difflineplus">+      let thread = db().GetThreadContainingMsgHdr(gHeader);</span>
<a href="#l65.192"></a><span id="l65.192" class="difflineplus">+      do_check_neq(0, thread.flags &amp; Ci.nsMsgMessageFlags.Watched);</span>
<a href="#l65.193"></a><span id="l65.193" class="difflineplus">+    }</span>
<a href="#l65.194"></a><span id="l65.194" class="difflineplus">+    setupTest(gBodyFilter, gAction);</span>
<a href="#l65.195"></a><span id="l65.195" class="difflineplus">+  },</span>
<a href="#l65.196"></a><span id="l65.196" class="difflineplus">+  function MarkFlagged() {</span>
<a href="#l65.197"></a><span id="l65.197" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.MarkFlagged;</span>
<a href="#l65.198"></a><span id="l65.198" class="difflineplus">+    gChecks = function checkMarkFlagged() {</span>
<a href="#l65.199"></a><span id="l65.199" class="difflineplus">+      testCounts(true, 1, 1, 1);</span>
<a href="#l65.200"></a><span id="l65.200" class="difflineplus">+      do_check_true(gHeader.isFlagged);</span>
<a href="#l65.201"></a><span id="l65.201" class="difflineplus">+    }</span>
<a href="#l65.202"></a><span id="l65.202" class="difflineplus">+    setupTest(gFilter, gAction);</span>
<a href="#l65.203"></a><span id="l65.203" class="difflineplus">+  },</span>
<a href="#l65.204"></a><span id="l65.204" class="difflineplus">+  function MarkFlaggedBody() {</span>
<a href="#l65.205"></a><span id="l65.205" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.MarkFlagged;</span>
<a href="#l65.206"></a><span id="l65.206" class="difflineplus">+    gChecks = function checkMarkFlaggedBody() {</span>
<a href="#l65.207"></a><span id="l65.207" class="difflineplus">+      testCounts(true, 1, 1, 1);</span>
<a href="#l65.208"></a><span id="l65.208" class="difflineplus">+      do_check_true(gHeader.isFlagged);</span>
<a href="#l65.209"></a><span id="l65.209" class="difflineplus">+    }</span>
<a href="#l65.210"></a><span id="l65.210" class="difflineplus">+    setupTest(gBodyFilter, gAction);</span>
<a href="#l65.211"></a><span id="l65.211" class="difflineplus">+  },</span>
<a href="#l65.212"></a><span id="l65.212" class="difflineplus">+  function ChangePriority() {</span>
<a href="#l65.213"></a><span id="l65.213" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.ChangePriority;</span>
<a href="#l65.214"></a><span id="l65.214" class="difflineplus">+    gAction.priority = Ci.nsMsgPriority.highest;</span>
<a href="#l65.215"></a><span id="l65.215" class="difflineplus">+    gChecks = function checkChangePriority() {</span>
<a href="#l65.216"></a><span id="l65.216" class="difflineplus">+      testCounts(true, 1, 1, 1);</span>
<a href="#l65.217"></a><span id="l65.217" class="difflineplus">+      do_check_eq(Ci.nsMsgPriority.highest, gHeader.priority);</span>
<a href="#l65.218"></a><span id="l65.218" class="difflineplus">+    }</span>
<a href="#l65.219"></a><span id="l65.219" class="difflineplus">+    setupTest(gFilter, gAction);</span>
<a href="#l65.220"></a><span id="l65.220" class="difflineplus">+  },</span>
<a href="#l65.221"></a><span id="l65.221" class="difflineplus">+  function ChangePriorityBody() {</span>
<a href="#l65.222"></a><span id="l65.222" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.ChangePriority;</span>
<a href="#l65.223"></a><span id="l65.223" class="difflineplus">+    gAction.priority = Ci.nsMsgPriority.highest;</span>
<a href="#l65.224"></a><span id="l65.224" class="difflineplus">+    gChecks = function checkChangePriorityBody() {</span>
<a href="#l65.225"></a><span id="l65.225" class="difflineplus">+      testCounts(true, 1, 1, 1);</span>
<a href="#l65.226"></a><span id="l65.226" class="difflineplus">+      do_check_eq(Ci.nsMsgPriority.highest, gHeader.priority);</span>
<a href="#l65.227"></a><span id="l65.227" class="difflineplus">+    }</span>
<a href="#l65.228"></a><span id="l65.228" class="difflineplus">+    setupTest(gBodyFilter, gAction);</span>
<a href="#l65.229"></a><span id="l65.229" class="difflineplus">+  },</span>
<a href="#l65.230"></a><span id="l65.230" class="difflineplus">+  function Label() {</span>
<a href="#l65.231"></a><span id="l65.231" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.Label;</span>
<a href="#l65.232"></a><span id="l65.232" class="difflineplus">+    gAction.label = 2;</span>
<a href="#l65.233"></a><span id="l65.233" class="difflineplus">+    gChecks = function checkLabel() {</span>
<a href="#l65.234"></a><span id="l65.234" class="difflineplus">+      testCounts(true, 1, 1, 1);</span>
<a href="#l65.235"></a><span id="l65.235" class="difflineplus">+      do_check_eq(2, gHeader.label);</span>
<a href="#l65.236"></a><span id="l65.236" class="difflineplus">+    }</span>
<a href="#l65.237"></a><span id="l65.237" class="difflineplus">+    setupTest(gFilter, gAction);</span>
<a href="#l65.238"></a><span id="l65.238" class="difflineplus">+  },</span>
<a href="#l65.239"></a><span id="l65.239" class="difflineplus">+  function LabelBody() {</span>
<a href="#l65.240"></a><span id="l65.240" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.Label;</span>
<a href="#l65.241"></a><span id="l65.241" class="difflineplus">+    gAction.label = 3;</span>
<a href="#l65.242"></a><span id="l65.242" class="difflineplus">+    gChecks = function checkLabelBody() {</span>
<a href="#l65.243"></a><span id="l65.243" class="difflineplus">+      testCounts(true, 1, 1, 1);</span>
<a href="#l65.244"></a><span id="l65.244" class="difflineplus">+      do_check_eq(3, gHeader.label);</span>
<a href="#l65.245"></a><span id="l65.245" class="difflineplus">+    }</span>
<a href="#l65.246"></a><span id="l65.246" class="difflineplus">+    setupTest(gBodyFilter, gAction);</span>
<a href="#l65.247"></a><span id="l65.247" class="difflineplus">+  },</span>
<a href="#l65.248"></a><span id="l65.248" class="difflineplus">+  function AddTag() {</span>
<a href="#l65.249"></a><span id="l65.249" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.AddTag;</span>
<a href="#l65.250"></a><span id="l65.250" class="difflineplus">+    gAction.strValue = &quot;TheTag&quot;;</span>
<a href="#l65.251"></a><span id="l65.251" class="difflineplus">+    gChecks = function checkAddTag() {</span>
<a href="#l65.252"></a><span id="l65.252" class="difflineplus">+      testCounts(true, 1, 1, 1);</span>
<a href="#l65.253"></a><span id="l65.253" class="difflineplus">+      do_check_eq(gHeader.getStringProperty(&quot;keywords&quot;), &quot;TheTag&quot;);</span>
<a href="#l65.254"></a><span id="l65.254" class="difflineplus">+    }</span>
<a href="#l65.255"></a><span id="l65.255" class="difflineplus">+    setupTest(gFilter, gAction);</span>
<a href="#l65.256"></a><span id="l65.256" class="difflineplus">+  },</span>
<a href="#l65.257"></a><span id="l65.257" class="difflineplus">+  function AddTagBody() {</span>
<a href="#l65.258"></a><span id="l65.258" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.AddTag;</span>
<a href="#l65.259"></a><span id="l65.259" class="difflineplus">+    gAction.strValue = &quot;TheTag2&quot;;</span>
<a href="#l65.260"></a><span id="l65.260" class="difflineplus">+    gChecks = function checkAddTagBody() {</span>
<a href="#l65.261"></a><span id="l65.261" class="difflineplus">+      testCounts(true, 1, 1, 1);</span>
<a href="#l65.262"></a><span id="l65.262" class="difflineplus">+      do_check_eq(gHeader.getStringProperty(&quot;keywords&quot;), &quot;TheTag2&quot;);</span>
<a href="#l65.263"></a><span id="l65.263" class="difflineplus">+    }</span>
<a href="#l65.264"></a><span id="l65.264" class="difflineplus">+    setupTest(gBodyFilter, gAction);</span>
<a href="#l65.265"></a><span id="l65.265" class="difflineplus">+  },</span>
<a href="#l65.266"></a><span id="l65.266" class="difflineplus">+  // this tests for marking message as good</span>
<a href="#l65.267"></a><span id="l65.267" class="difflineplus">+  function JunkScoreAsGood() {</span>
<a href="#l65.268"></a><span id="l65.268" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.JunkScore;</span>
<a href="#l65.269"></a><span id="l65.269" class="difflineplus">+    gAction.junkScore = 0;</span>
<a href="#l65.270"></a><span id="l65.270" class="difflineplus">+    gChecks = function checkJunkScore() {</span>
<a href="#l65.271"></a><span id="l65.271" class="difflineplus">+      testCounts(true, 1, 1, 1);</span>
<a href="#l65.272"></a><span id="l65.272" class="difflineplus">+      do_check_eq(gHeader.getStringProperty(&quot;junkscore&quot;), &quot;0&quot;);</span>
<a href="#l65.273"></a><span id="l65.273" class="difflineplus">+      do_check_eq(gHeader.getStringProperty(&quot;junkscoreorigin&quot;), &quot;filter&quot;);</span>
<a href="#l65.274"></a><span id="l65.274" class="difflineplus">+    }</span>
<a href="#l65.275"></a><span id="l65.275" class="difflineplus">+    setupTest(gFilter, gAction);</span>
<a href="#l65.276"></a><span id="l65.276" class="difflineplus">+  },</span>
<a href="#l65.277"></a><span id="l65.277" class="difflineplus">+  // this tests for marking message as good</span>
<a href="#l65.278"></a><span id="l65.278" class="difflineplus">+  function JunkScoreAsGoodBody() {</span>
<a href="#l65.279"></a><span id="l65.279" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.JunkScore;</span>
<a href="#l65.280"></a><span id="l65.280" class="difflineplus">+    gAction.junkScore = 0;</span>
<a href="#l65.281"></a><span id="l65.281" class="difflineplus">+    gChecks = function checkJunkScoreBody() {</span>
<a href="#l65.282"></a><span id="l65.282" class="difflineplus">+      testCounts(true, 1, 1, 1);</span>
<a href="#l65.283"></a><span id="l65.283" class="difflineplus">+      do_check_eq(gHeader.getStringProperty(&quot;junkscore&quot;), &quot;0&quot;);</span>
<a href="#l65.284"></a><span id="l65.284" class="difflineplus">+      do_check_eq(gHeader.getStringProperty(&quot;junkscoreorigin&quot;), &quot;filter&quot;);</span>
<a href="#l65.285"></a><span id="l65.285" class="difflineplus">+    }</span>
<a href="#l65.286"></a><span id="l65.286" class="difflineplus">+    setupTest(gBodyFilter, gAction);</span>
<a href="#l65.287"></a><span id="l65.287" class="difflineplus">+  },</span>
<a href="#l65.288"></a><span id="l65.288" class="difflineplus">+  function CopyToFolder() {</span>
<a href="#l65.289"></a><span id="l65.289" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.CopyToFolder;</span>
<a href="#l65.290"></a><span id="l65.290" class="difflineplus">+    gAction.targetFolderUri = gSubfolder.URI;</span>
<a href="#l65.291"></a><span id="l65.291" class="difflineplus">+    gChecks = function checkCopyToFolder() {</span>
<a href="#l65.292"></a><span id="l65.292" class="difflineplus">+      testCounts(true, 1, 1, 1);</span>
<a href="#l65.293"></a><span id="l65.293" class="difflineplus">+      do_check_eq(gInboxCount + 1, folderCount(gIMAPInbox));</span>
<a href="#l65.294"></a><span id="l65.294" class="difflineplus">+      do_check_eq(gSubfolderCount + 1, folderCount(gSubfolder));</span>
<a href="#l65.295"></a><span id="l65.295" class="difflineplus">+    }</span>
<a href="#l65.296"></a><span id="l65.296" class="difflineplus">+    gInboxCount = folderCount(gIMAPInbox);</span>
<a href="#l65.297"></a><span id="l65.297" class="difflineplus">+    gSubfolderCount = folderCount(gSubfolder);</span>
<a href="#l65.298"></a><span id="l65.298" class="difflineplus">+    setupTest(gFilter, gAction);</span>
<a href="#l65.299"></a><span id="l65.299" class="difflineplus">+  },</span>
<a href="#l65.300"></a><span id="l65.300" class="difflineplus">+  function CopyToFolderBody() {</span>
<a href="#l65.301"></a><span id="l65.301" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.CopyToFolder;</span>
<a href="#l65.302"></a><span id="l65.302" class="difflineplus">+    gAction.targetFolderUri = gSubfolder.URI;</span>
<a href="#l65.303"></a><span id="l65.303" class="difflineplus">+    gChecks = function checkCopyToFolderBody() {</span>
<a href="#l65.304"></a><span id="l65.304" class="difflineplus">+      testCounts(true, 1, 1, 1);</span>
<a href="#l65.305"></a><span id="l65.305" class="difflineplus">+      do_check_eq(gInboxCount + 1, folderCount(gIMAPInbox));</span>
<a href="#l65.306"></a><span id="l65.306" class="difflineplus">+      do_check_eq(gSubfolderCount + 1, folderCount(gSubfolder));</span>
<a href="#l65.307"></a><span id="l65.307" class="difflineplus">+    }</span>
<a href="#l65.308"></a><span id="l65.308" class="difflineplus">+    gInboxCount = folderCount(gIMAPInbox);</span>
<a href="#l65.309"></a><span id="l65.309" class="difflineplus">+    gSubfolderCount = folderCount(gSubfolder);</span>
<a href="#l65.310"></a><span id="l65.310" class="difflineplus">+    setupTest(gBodyFilter, gAction);</span>
<a href="#l65.311"></a><span id="l65.311" class="difflineplus">+  },</span>
<a href="#l65.312"></a><span id="l65.312" class="difflineplus">+</span>
<a href="#l65.313"></a><span id="l65.313" class="difflineplus">+];</span>
<a href="#l65.314"></a><span id="l65.314" class="difflineplus">+</span>
<a href="#l65.315"></a><span id="l65.315" class="difflineplus">+function run_test()</span>
<a href="#l65.316"></a><span id="l65.316" class="difflineplus">+{</span>
<a href="#l65.317"></a><span id="l65.317" class="difflineplus">+  // This is before any of the actual tests, so...</span>
<a href="#l65.318"></a><span id="l65.318" class="difflineplus">+  gTest = 0;</span>
<a href="#l65.319"></a><span id="l65.319" class="difflineplus">+</span>
<a href="#l65.320"></a><span id="l65.320" class="difflineplus">+  // Add a listener.</span>
<a href="#l65.321"></a><span id="l65.321" class="difflineplus">+  gIMAPDaemon = new imapDaemon();</span>
<a href="#l65.322"></a><span id="l65.322" class="difflineplus">+  gServer = makeServer(gIMAPDaemon, &quot;&quot;);</span>
<a href="#l65.323"></a><span id="l65.323" class="difflineplus">+</span>
<a href="#l65.324"></a><span id="l65.324" class="difflineplus">+  gIMAPIncomingServer = createLocalIMAPServer();</span>
<a href="#l65.325"></a><span id="l65.325" class="difflineplus">+</span>
<a href="#l65.326"></a><span id="l65.326" class="difflineplus">+  if (!gLocalInboxFolder)</span>
<a href="#l65.327"></a><span id="l65.327" class="difflineplus">+    loadLocalMailAccount();</span>
<a href="#l65.328"></a><span id="l65.328" class="difflineplus">+</span>
<a href="#l65.329"></a><span id="l65.329" class="difflineplus">+  // We need an identity so that updateFolder doesn't fail</span>
<a href="#l65.330"></a><span id="l65.330" class="difflineplus">+  let acctMgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l65.331"></a><span id="l65.331" class="difflineplus">+                  .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l65.332"></a><span id="l65.332" class="difflineplus">+  let localAccount = acctMgr.createAccount();</span>
<a href="#l65.333"></a><span id="l65.333" class="difflineplus">+  let identity = acctMgr.createIdentity();</span>
<a href="#l65.334"></a><span id="l65.334" class="difflineplus">+  localAccount.addIdentity(identity);</span>
<a href="#l65.335"></a><span id="l65.335" class="difflineplus">+  localAccount.defaultIdentity = identity;</span>
<a href="#l65.336"></a><span id="l65.336" class="difflineplus">+  localAccount.incomingServer = gLocalIncomingServer;</span>
<a href="#l65.337"></a><span id="l65.337" class="difflineplus">+  acctMgr.defaultAccount = localAccount;</span>
<a href="#l65.338"></a><span id="l65.338" class="difflineplus">+</span>
<a href="#l65.339"></a><span id="l65.339" class="difflineplus">+  // Let's also have another account, using the same identity</span>
<a href="#l65.340"></a><span id="l65.340" class="difflineplus">+  let imapAccount = acctMgr.createAccount();</span>
<a href="#l65.341"></a><span id="l65.341" class="difflineplus">+  imapAccount.addIdentity(identity);</span>
<a href="#l65.342"></a><span id="l65.342" class="difflineplus">+  imapAccount.defaultIdentity = identity;</span>
<a href="#l65.343"></a><span id="l65.343" class="difflineplus">+  imapAccount.incomingServer = gIMAPIncomingServer;</span>
<a href="#l65.344"></a><span id="l65.344" class="difflineplus">+</span>
<a href="#l65.345"></a><span id="l65.345" class="difflineplus">+  // The server doesn't support more than one connection</span>
<a href="#l65.346"></a><span id="l65.346" class="difflineplus">+  let prefBranch = Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l65.347"></a><span id="l65.347" class="difflineplus">+                     .getService(Ci.nsIPrefBranch);</span>
<a href="#l65.348"></a><span id="l65.348" class="difflineplus">+  prefBranch.setIntPref(&quot;mail.server.default.max_cached_connections&quot;, 1);</span>
<a href="#l65.349"></a><span id="l65.349" class="difflineplus">+  // We aren't interested in downloading messages automatically</span>
<a href="#l65.350"></a><span id="l65.350" class="difflineplus">+  prefBranch.setBoolPref(&quot;mail.server.default.download_on_biff&quot;, false);</span>
<a href="#l65.351"></a><span id="l65.351" class="difflineplus">+  prefBranch.setBoolPref(&quot;mail.biff.play_sound&quot;, false);</span>
<a href="#l65.352"></a><span id="l65.352" class="difflineplus">+  prefBranch.setBoolPref(&quot;mail.biff.show_alert&quot;, false);</span>
<a href="#l65.353"></a><span id="l65.353" class="difflineplus">+  prefBranch.setBoolPref(&quot;mail.biff.show_tray_icon&quot;, false);</span>
<a href="#l65.354"></a><span id="l65.354" class="difflineplus">+  prefBranch.setBoolPref(&quot;mail.biff.animate_dock_icon&quot;, false);</span>
<a href="#l65.355"></a><span id="l65.355" class="difflineplus">+</span>
<a href="#l65.356"></a><span id="l65.356" class="difflineplus">+  gSubfolder = gLocalIncomingServer.rootFolder.addSubfolder(&quot;Subfolder&quot;);</span>
<a href="#l65.357"></a><span id="l65.357" class="difflineplus">+  gIMAPIncomingServer.performExpand(null);</span>
<a href="#l65.358"></a><span id="l65.358" class="difflineplus">+</span>
<a href="#l65.359"></a><span id="l65.359" class="difflineplus">+  gRootFolder = gIMAPIncomingServer.rootFolder;</span>
<a href="#l65.360"></a><span id="l65.360" class="difflineplus">+  gIMAPInbox = gRootFolder.getChildNamed(&quot;INBOX&quot;);</span>
<a href="#l65.361"></a><span id="l65.361" class="difflineplus">+  gIMAPMailbox = gIMAPDaemon.getMailbox(&quot;INBOX&quot;);</span>
<a href="#l65.362"></a><span id="l65.362" class="difflineplus">+  dump(&quot;gIMAPInbox uri = &quot; + gIMAPInbox.URI + &quot;\n&quot;);</span>
<a href="#l65.363"></a><span id="l65.363" class="difflineplus">+  msgImapFolder = gIMAPInbox.QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l65.364"></a><span id="l65.364" class="difflineplus">+  // these hacks are required because we've created the inbox before</span>
<a href="#l65.365"></a><span id="l65.365" class="difflineplus">+  // running initial folder discovery, and adding the folder bails</span>
<a href="#l65.366"></a><span id="l65.366" class="difflineplus">+  // out before we set it as verified online, so we bail out, and</span>
<a href="#l65.367"></a><span id="l65.367" class="difflineplus">+  // then remove the INBOX folder since it's not verified.</span>
<a href="#l65.368"></a><span id="l65.368" class="difflineplus">+  msgImapFolder.hierarchyDelimiter = '/';</span>
<a href="#l65.369"></a><span id="l65.369" class="difflineplus">+  msgImapFolder.verifiedAsOnlineFolder = true;</span>
<a href="#l65.370"></a><span id="l65.370" class="difflineplus">+</span>
<a href="#l65.371"></a><span id="l65.371" class="difflineplus">+// Create a non-body filter.</span>
<a href="#l65.372"></a><span id="l65.372" class="difflineplus">+  let filterList = gIMAPIncomingServer.getFilterList(null);</span>
<a href="#l65.373"></a><span id="l65.373" class="difflineplus">+  gFilter = filterList.createFilter(&quot;subject&quot;);</span>
<a href="#l65.374"></a><span id="l65.374" class="difflineplus">+  let searchTerm = gFilter.createTerm();</span>
<a href="#l65.375"></a><span id="l65.375" class="difflineplus">+  searchTerm.attrib = Subject;</span>
<a href="#l65.376"></a><span id="l65.376" class="difflineplus">+  searchTerm.op = Is;</span>
<a href="#l65.377"></a><span id="l65.377" class="difflineplus">+  var value = searchTerm.value;</span>
<a href="#l65.378"></a><span id="l65.378" class="difflineplus">+  value.attrib = Subject;</span>
<a href="#l65.379"></a><span id="l65.379" class="difflineplus">+  value.str = gMessageSubject;</span>
<a href="#l65.380"></a><span id="l65.380" class="difflineplus">+  searchTerm.value = value;</span>
<a href="#l65.381"></a><span id="l65.381" class="difflineplus">+  searchTerm.booleanAnd = false;</span>
<a href="#l65.382"></a><span id="l65.382" class="difflineplus">+  gFilter.appendTerm(searchTerm);</span>
<a href="#l65.383"></a><span id="l65.383" class="difflineplus">+  gFilter.enabled = true;</span>
<a href="#l65.384"></a><span id="l65.384" class="difflineplus">+</span>
<a href="#l65.385"></a><span id="l65.385" class="difflineplus">+  // Create a filter with a body term that that forces delayed application of</span>
<a href="#l65.386"></a><span id="l65.386" class="difflineplus">+  // filters until after body download.</span>
<a href="#l65.387"></a><span id="l65.387" class="difflineplus">+  gBodyFilter = filterList.createFilter(&quot;body&quot;);</span>
<a href="#l65.388"></a><span id="l65.388" class="difflineplus">+  searchTerm = gBodyFilter.createTerm();</span>
<a href="#l65.389"></a><span id="l65.389" class="difflineplus">+  searchTerm.attrib = Body;</span>
<a href="#l65.390"></a><span id="l65.390" class="difflineplus">+  searchTerm.op = Contains;</span>
<a href="#l65.391"></a><span id="l65.391" class="difflineplus">+  value = searchTerm.value;</span>
<a href="#l65.392"></a><span id="l65.392" class="difflineplus">+  value.attrib = Body;</span>
<a href="#l65.393"></a><span id="l65.393" class="difflineplus">+  value.str = gMessageInBody;</span>
<a href="#l65.394"></a><span id="l65.394" class="difflineplus">+  searchTerm.value = value;</span>
<a href="#l65.395"></a><span id="l65.395" class="difflineplus">+  searchTerm.booleanAnd = false;</span>
<a href="#l65.396"></a><span id="l65.396" class="difflineplus">+  gBodyFilter.appendTerm(searchTerm);</span>
<a href="#l65.397"></a><span id="l65.397" class="difflineplus">+  gBodyFilter.enabled = true;</span>
<a href="#l65.398"></a><span id="l65.398" class="difflineplus">+</span>
<a href="#l65.399"></a><span id="l65.399" class="difflineplus">+  // an action that can be modified by tests</span>
<a href="#l65.400"></a><span id="l65.400" class="difflineplus">+  gAction = gFilter.createAction();</span>
<a href="#l65.401"></a><span id="l65.401" class="difflineplus">+</span>
<a href="#l65.402"></a><span id="l65.402" class="difflineplus">+  gMailSession.AddFolderListener(FolderListener, Ci.nsIFolderListener.event);</span>
<a href="#l65.403"></a><span id="l65.403" class="difflineplus">+</span>
<a href="#l65.404"></a><span id="l65.404" class="difflineplus">+  // &quot;Master&quot; do_test_pending(), paired with a do_test_finished() at the end of</span>
<a href="#l65.405"></a><span id="l65.405" class="difflineplus">+  // all the operations.</span>
<a href="#l65.406"></a><span id="l65.406" class="difflineplus">+  do_test_pending();</span>
<a href="#l65.407"></a><span id="l65.407" class="difflineplus">+</span>
<a href="#l65.408"></a><span id="l65.408" class="difflineplus">+  //start first test</span>
<a href="#l65.409"></a><span id="l65.409" class="difflineplus">+  gCurTestNum = 1;</span>
<a href="#l65.410"></a><span id="l65.410" class="difflineplus">+  doTest();</span>
<a href="#l65.411"></a><span id="l65.411" class="difflineplus">+}</span>
<a href="#l65.412"></a><span id="l65.412" class="difflineplus">+</span>
<a href="#l65.413"></a><span id="l65.413" class="difflineplus">+/*</span>
<a href="#l65.414"></a><span id="l65.414" class="difflineplus">+ * functions used to support test setup and execution</span>
<a href="#l65.415"></a><span id="l65.415" class="difflineplus">+ */</span>
<a href="#l65.416"></a><span id="l65.416" class="difflineplus">+</span>
<a href="#l65.417"></a><span id="l65.417" class="difflineplus">+// if the source matches the listener used to continue a test,</span>
<a href="#l65.418"></a><span id="l65.418" class="difflineplus">+// run the test checks, and start the next test.</span>
<a href="#l65.419"></a><span id="l65.419" class="difflineplus">+function testContinue(source)</span>
<a href="#l65.420"></a><span id="l65.420" class="difflineplus">+{</span>
<a href="#l65.421"></a><span id="l65.421" class="difflineplus">+  if (gContinueListener === source)</span>
<a href="#l65.422"></a><span id="l65.422" class="difflineplus">+  {</span>
<a href="#l65.423"></a><span id="l65.423" class="difflineplus">+    if (gContinueListener == kDeleteOrMoveMsgCompleted &amp;&amp;</span>
<a href="#l65.424"></a><span id="l65.424" class="difflineplus">+        gAction.type == Ci.nsMsgFilterAction.MoveToFolder)</span>
<a href="#l65.425"></a><span id="l65.425" class="difflineplus">+    {</span>
<a href="#l65.426"></a><span id="l65.426" class="difflineplus">+      // Moves give 2 events, just use the second.</span>
<a href="#l65.427"></a><span id="l65.427" class="difflineplus">+      gMoveCallbackCount++;</span>
<a href="#l65.428"></a><span id="l65.428" class="difflineplus">+      if (gMoveCallbackCount != 2)</span>
<a href="#l65.429"></a><span id="l65.429" class="difflineplus">+        return;</span>
<a href="#l65.430"></a><span id="l65.430" class="difflineplus">+    }</span>
<a href="#l65.431"></a><span id="l65.431" class="difflineplus">+    if (gChecks)</span>
<a href="#l65.432"></a><span id="l65.432" class="difflineplus">+      gChecks();</span>
<a href="#l65.433"></a><span id="l65.433" class="difflineplus">+    gCurTestNum++;</span>
<a href="#l65.434"></a><span id="l65.434" class="difflineplus">+    do_timeout(100, &quot;doTest();&quot;);</span>
<a href="#l65.435"></a><span id="l65.435" class="difflineplus">+  }</span>
<a href="#l65.436"></a><span id="l65.436" class="difflineplus">+}</span>
<a href="#l65.437"></a><span id="l65.437" class="difflineplus">+</span>
<a href="#l65.438"></a><span id="l65.438" class="difflineplus">+// basic preparation done for each test</span>
<a href="#l65.439"></a><span id="l65.439" class="difflineplus">+function setupTest(aFilter, aAction)</span>
<a href="#l65.440"></a><span id="l65.440" class="difflineplus">+{</span>
<a href="#l65.441"></a><span id="l65.441" class="difflineplus">+  if (aAction &amp;&amp;</span>
<a href="#l65.442"></a><span id="l65.442" class="difflineplus">+      ((aAction.type == Ci.nsMsgFilterAction.CopyToFolder) ||</span>
<a href="#l65.443"></a><span id="l65.443" class="difflineplus">+       (aAction.type == Ci.nsMsgFilterAction.MoveToFolder)))</span>
<a href="#l65.444"></a><span id="l65.444" class="difflineplus">+    gContinueListener = kDeleteOrMoveMsgCompleted;</span>
<a href="#l65.445"></a><span id="l65.445" class="difflineplus">+  else if (aFilter === gBodyFilter)</span>
<a href="#l65.446"></a><span id="l65.446" class="difflineplus">+    gContinueListener = kFiltersAppliedAtom;</span>
<a href="#l65.447"></a><span id="l65.447" class="difflineplus">+  else</span>
<a href="#l65.448"></a><span id="l65.448" class="difflineplus">+    gContinueListener = URLListener;</span>
<a href="#l65.449"></a><span id="l65.449" class="difflineplus">+  let filterList = gIMAPIncomingServer.getFilterList(null);</span>
<a href="#l65.450"></a><span id="l65.450" class="difflineplus">+  while (filterList.filterCount)</span>
<a href="#l65.451"></a><span id="l65.451" class="difflineplus">+    filterList.removeFilterAt(0);</span>
<a href="#l65.452"></a><span id="l65.452" class="difflineplus">+  if (aFilter)</span>
<a href="#l65.453"></a><span id="l65.453" class="difflineplus">+  {</span>
<a href="#l65.454"></a><span id="l65.454" class="difflineplus">+    aFilter.clearActionList();</span>
<a href="#l65.455"></a><span id="l65.455" class="difflineplus">+    if (aAction) {</span>
<a href="#l65.456"></a><span id="l65.456" class="difflineplus">+      aFilter.appendAction(aAction);</span>
<a href="#l65.457"></a><span id="l65.457" class="difflineplus">+      filterList.insertFilterAt(0, aFilter);</span>
<a href="#l65.458"></a><span id="l65.458" class="difflineplus">+    }</span>
<a href="#l65.459"></a><span id="l65.459" class="difflineplus">+  }</span>
<a href="#l65.460"></a><span id="l65.460" class="difflineplus">+  if (gInboxListener)</span>
<a href="#l65.461"></a><span id="l65.461" class="difflineplus">+  {</span>
<a href="#l65.462"></a><span id="l65.462" class="difflineplus">+    try {</span>
<a href="#l65.463"></a><span id="l65.463" class="difflineplus">+      gIMAPInbox.msgDatabase.RemoveListener(gInboxListener);</span>
<a href="#l65.464"></a><span id="l65.464" class="difflineplus">+    }</span>
<a href="#l65.465"></a><span id="l65.465" class="difflineplus">+    catch(e) {}</span>
<a href="#l65.466"></a><span id="l65.466" class="difflineplus">+    try {</span>
<a href="#l65.467"></a><span id="l65.467" class="difflineplus">+      gDbService.UnregisterPendingListener(gInboxListener);</span>
<a href="#l65.468"></a><span id="l65.468" class="difflineplus">+    }</span>
<a href="#l65.469"></a><span id="l65.469" class="difflineplus">+    catch(e) {}</span>
<a href="#l65.470"></a><span id="l65.470" class="difflineplus">+  }</span>
<a href="#l65.471"></a><span id="l65.471" class="difflineplus">+</span>
<a href="#l65.472"></a><span id="l65.472" class="difflineplus">+  gInboxListener = new DBListener();</span>
<a href="#l65.473"></a><span id="l65.473" class="difflineplus">+  gDbService.registerPendingListener(gIMAPInbox, gInboxListener);</span>
<a href="#l65.474"></a><span id="l65.474" class="difflineplus">+  gMoveCallbackCount = 0;</span>
<a href="#l65.475"></a><span id="l65.475" class="difflineplus">+  gIMAPMailbox.addMessage(new imapMessage(specForFileName(gMessage),</span>
<a href="#l65.476"></a><span id="l65.476" class="difflineplus">+                          gIMAPMailbox.uidnext++, []));</span>
<a href="#l65.477"></a><span id="l65.477" class="difflineplus">+  gIMAPInbox.updateFolderWithListener(null, URLListener);</span>
<a href="#l65.478"></a><span id="l65.478" class="difflineplus">+}</span>
<a href="#l65.479"></a><span id="l65.479" class="difflineplus">+</span>
<a href="#l65.480"></a><span id="l65.480" class="difflineplus">+// run the next test</span>
<a href="#l65.481"></a><span id="l65.481" class="difflineplus">+function doTest()</span>
<a href="#l65.482"></a><span id="l65.482" class="difflineplus">+{</span>
<a href="#l65.483"></a><span id="l65.483" class="difflineplus">+  test = gCurTestNum;</span>
<a href="#l65.484"></a><span id="l65.484" class="difflineplus">+  if (test &lt;= gTestArray.length)</span>
<a href="#l65.485"></a><span id="l65.485" class="difflineplus">+  {</span>
<a href="#l65.486"></a><span id="l65.486" class="difflineplus">+</span>
<a href="#l65.487"></a><span id="l65.487" class="difflineplus">+    var testFn = gTestArray[test-1];</span>
<a href="#l65.488"></a><span id="l65.488" class="difflineplus">+    dump(&quot;Doing test &quot; + test + &quot; &quot; + testFn.name + &quot;\n&quot;);</span>
<a href="#l65.489"></a><span id="l65.489" class="difflineplus">+    // Set a limit of ten seconds; if the notifications haven't arrived by then there's a problem.</span>
<a href="#l65.490"></a><span id="l65.490" class="difflineplus">+    do_timeout(10000, &quot;if (gCurTestNum == &quot;+test+&quot;) \</span>
<a href="#l65.491"></a><span id="l65.491" class="difflineplus">+      do_throw('Notifications not received in 10000 ms for operation &quot;+testFn.name+&quot;, current status is '+gCurrStatus);&quot;);</span>
<a href="#l65.492"></a><span id="l65.492" class="difflineplus">+    try {</span>
<a href="#l65.493"></a><span id="l65.493" class="difflineplus">+    testFn();</span>
<a href="#l65.494"></a><span id="l65.494" class="difflineplus">+    } catch(ex) {</span>
<a href="#l65.495"></a><span id="l65.495" class="difflineplus">+      gServer.stop();</span>
<a href="#l65.496"></a><span id="l65.496" class="difflineplus">+      do_throw ('TEST FAILED ' + e);</span>
<a href="#l65.497"></a><span id="l65.497" class="difflineplus">+    }</span>
<a href="#l65.498"></a><span id="l65.498" class="difflineplus">+  }</span>
<a href="#l65.499"></a><span id="l65.499" class="difflineplus">+  else</span>
<a href="#l65.500"></a><span id="l65.500" class="difflineplus">+    do_timeout(1000, &quot;endTest();&quot;);</span>
<a href="#l65.501"></a><span id="l65.501" class="difflineplus">+}</span>
<a href="#l65.502"></a><span id="l65.502" class="difflineplus">+</span>
<a href="#l65.503"></a><span id="l65.503" class="difflineplus">+// Cleanup, null out everything, close all cached connections and stop the</span>
<a href="#l65.504"></a><span id="l65.504" class="difflineplus">+// server</span>
<a href="#l65.505"></a><span id="l65.505" class="difflineplus">+function endTest()</span>
<a href="#l65.506"></a><span id="l65.506" class="difflineplus">+{</span>
<a href="#l65.507"></a><span id="l65.507" class="difflineplus">+  dump(&quot; Exiting mail tests\n&quot;);</span>
<a href="#l65.508"></a><span id="l65.508" class="difflineplus">+  if (gInboxListener)</span>
<a href="#l65.509"></a><span id="l65.509" class="difflineplus">+  {</span>
<a href="#l65.510"></a><span id="l65.510" class="difflineplus">+    try {</span>
<a href="#l65.511"></a><span id="l65.511" class="difflineplus">+      gIMAPInbox.msgDatabase.RemoveListener(gInboxListener);</span>
<a href="#l65.512"></a><span id="l65.512" class="difflineplus">+    }</span>
<a href="#l65.513"></a><span id="l65.513" class="difflineplus">+    catch(e) {}</span>
<a href="#l65.514"></a><span id="l65.514" class="difflineplus">+    try {</span>
<a href="#l65.515"></a><span id="l65.515" class="difflineplus">+      gDbService.UnregisterPendingListener(gInboxListener);</span>
<a href="#l65.516"></a><span id="l65.516" class="difflineplus">+    }</span>
<a href="#l65.517"></a><span id="l65.517" class="difflineplus">+    catch(e) {}</span>
<a href="#l65.518"></a><span id="l65.518" class="difflineplus">+  }</span>
<a href="#l65.519"></a><span id="l65.519" class="difflineplus">+  gRootFolder = null;</span>
<a href="#l65.520"></a><span id="l65.520" class="difflineplus">+  gIMAPInbox = null;</span>
<a href="#l65.521"></a><span id="l65.521" class="difflineplus">+  gIMAPTrashFolder = null;</span>
<a href="#l65.522"></a><span id="l65.522" class="difflineplus">+  gSubfolder = null;</span>
<a href="#l65.523"></a><span id="l65.523" class="difflineplus">+  gServer.resetTest();</span>
<a href="#l65.524"></a><span id="l65.524" class="difflineplus">+  gIMAPIncomingServer.closeCachedConnections();</span>
<a href="#l65.525"></a><span id="l65.525" class="difflineplus">+  gServer.performTest();</span>
<a href="#l65.526"></a><span id="l65.526" class="difflineplus">+  gServer.stop();</span>
<a href="#l65.527"></a><span id="l65.527" class="difflineplus">+  let thread = gThreadManager.currentThread;</span>
<a href="#l65.528"></a><span id="l65.528" class="difflineplus">+  while (thread.hasPendingEvents())</span>
<a href="#l65.529"></a><span id="l65.529" class="difflineplus">+    thread.processNextEvent(true);</span>
<a href="#l65.530"></a><span id="l65.530" class="difflineplus">+</span>
<a href="#l65.531"></a><span id="l65.531" class="difflineplus">+  do_test_finished(); // for the one in run_test()</span>
<a href="#l65.532"></a><span id="l65.532" class="difflineplus">+}</span>
<a href="#l65.533"></a><span id="l65.533" class="difflineplus">+</span>
<a href="#l65.534"></a><span id="l65.534" class="difflineplus">+/*</span>
<a href="#l65.535"></a><span id="l65.535" class="difflineplus">+ * listener objects</span>
<a href="#l65.536"></a><span id="l65.536" class="difflineplus">+ */</span>
<a href="#l65.537"></a><span id="l65.537" class="difflineplus">+</span>
<a href="#l65.538"></a><span id="l65.538" class="difflineplus">+// nsIFolderListener implementation</span>
<a href="#l65.539"></a><span id="l65.539" class="difflineplus">+var FolderListener = {</span>
<a href="#l65.540"></a><span id="l65.540" class="difflineplus">+  OnItemEvent: function OnItemEvent(aEventFolder, aEvent) {</span>
<a href="#l65.541"></a><span id="l65.541" class="difflineplus">+    dump(&quot;received folder event &quot; + aEvent.toString() +</span>
<a href="#l65.542"></a><span id="l65.542" class="difflineplus">+         &quot; folder &quot; + aEventFolder.name +</span>
<a href="#l65.543"></a><span id="l65.543" class="difflineplus">+         &quot;\n&quot;);</span>
<a href="#l65.544"></a><span id="l65.544" class="difflineplus">+    testContinue(aEvent);</span>
<a href="#l65.545"></a><span id="l65.545" class="difflineplus">+  }</span>
<a href="#l65.546"></a><span id="l65.546" class="difflineplus">+};</span>
<a href="#l65.547"></a><span id="l65.547" class="difflineplus">+</span>
<a href="#l65.548"></a><span id="l65.548" class="difflineplus">+// nsIMsgCopyServiceListener implementation - runs next test when copy</span>
<a href="#l65.549"></a><span id="l65.549" class="difflineplus">+// is completed.</span>
<a href="#l65.550"></a><span id="l65.550" class="difflineplus">+var CopyListener =</span>
<a href="#l65.551"></a><span id="l65.551" class="difflineplus">+{</span>
<a href="#l65.552"></a><span id="l65.552" class="difflineplus">+  OnStartCopy: function OnStartCopy() {},</span>
<a href="#l65.553"></a><span id="l65.553" class="difflineplus">+  OnProgress: function OnProgress(aProgress, aProgressMax) {},</span>
<a href="#l65.554"></a><span id="l65.554" class="difflineplus">+  SetMessageKey: function SetMessageKey(aKey)</span>
<a href="#l65.555"></a><span id="l65.555" class="difflineplus">+  {</span>
<a href="#l65.556"></a><span id="l65.556" class="difflineplus">+    gLastKey = aKey;</span>
<a href="#l65.557"></a><span id="l65.557" class="difflineplus">+  },</span>
<a href="#l65.558"></a><span id="l65.558" class="difflineplus">+  SetMessageId: function SetMessageId(aMessageId) {},</span>
<a href="#l65.559"></a><span id="l65.559" class="difflineplus">+  OnStopCopy: function OnStopCopy(aStatus)</span>
<a href="#l65.560"></a><span id="l65.560" class="difflineplus">+  {</span>
<a href="#l65.561"></a><span id="l65.561" class="difflineplus">+    dump(&quot;in OnStopCopy &quot; + gCurTestNum + &quot;\n&quot;);</span>
<a href="#l65.562"></a><span id="l65.562" class="difflineplus">+    // Check: message successfully copied.</span>
<a href="#l65.563"></a><span id="l65.563" class="difflineplus">+    do_check_eq(aStatus, 0);</span>
<a href="#l65.564"></a><span id="l65.564" class="difflineplus">+    // Ugly hack: make sure we don't get stuck in a JS-&gt;C++-&gt;JS-&gt;C++... call stack</span>
<a href="#l65.565"></a><span id="l65.565" class="difflineplus">+    // This can happen with a bunch of synchronous functions grouped together, and</span>
<a href="#l65.566"></a><span id="l65.566" class="difflineplus">+    // can even cause tests to fail because they're still waiting for the listener</span>
<a href="#l65.567"></a><span id="l65.567" class="difflineplus">+    // to return</span>
<a href="#l65.568"></a><span id="l65.568" class="difflineplus">+    testContinue(this);</span>
<a href="#l65.569"></a><span id="l65.569" class="difflineplus">+  }</span>
<a href="#l65.570"></a><span id="l65.570" class="difflineplus">+};</span>
<a href="#l65.571"></a><span id="l65.571" class="difflineplus">+</span>
<a href="#l65.572"></a><span id="l65.572" class="difflineplus">+// nsIURLListener implementation - runs next test</span>
<a href="#l65.573"></a><span id="l65.573" class="difflineplus">+var URLListener =</span>
<a href="#l65.574"></a><span id="l65.574" class="difflineplus">+{</span>
<a href="#l65.575"></a><span id="l65.575" class="difflineplus">+  OnStartRunningUrl: function OnStartRunningUrl(aURL) {},</span>
<a href="#l65.576"></a><span id="l65.576" class="difflineplus">+  OnStopRunningUrl: function OnStopRunningUrl(aURL, aStatus)</span>
<a href="#l65.577"></a><span id="l65.577" class="difflineplus">+  {</span>
<a href="#l65.578"></a><span id="l65.578" class="difflineplus">+    dump(&quot;in OnStopRunningURL &quot; + gCurTestNum + &quot;\n&quot;);</span>
<a href="#l65.579"></a><span id="l65.579" class="difflineplus">+    do_check_eq(aStatus, 0);</span>
<a href="#l65.580"></a><span id="l65.580" class="difflineplus">+    testContinue(this);</span>
<a href="#l65.581"></a><span id="l65.581" class="difflineplus">+  }</span>
<a href="#l65.582"></a><span id="l65.582" class="difflineplus">+}</span>
<a href="#l65.583"></a><span id="l65.583" class="difflineplus">+</span>
<a href="#l65.584"></a><span id="l65.584" class="difflineplus">+// nsIDBChangeListener implementation. Counts of calls are kept, but not</span>
<a href="#l65.585"></a><span id="l65.585" class="difflineplus">+// currently used in the tests. Current role is to provide a reference</span>
<a href="#l65.586"></a><span id="l65.586" class="difflineplus">+// to the new message header (plus give some examples of using db listeners</span>
<a href="#l65.587"></a><span id="l65.587" class="difflineplus">+// in javascript).</span>
<a href="#l65.588"></a><span id="l65.588" class="difflineplus">+function DBListener()</span>
<a href="#l65.589"></a><span id="l65.589" class="difflineplus">+{</span>
<a href="#l65.590"></a><span id="l65.590" class="difflineplus">+  this.counts = {};</span>
<a href="#l65.591"></a><span id="l65.591" class="difflineplus">+  counts = this.counts;</span>
<a href="#l65.592"></a><span id="l65.592" class="difflineplus">+  counts.onHdrFlagsChanged = 0;</span>
<a href="#l65.593"></a><span id="l65.593" class="difflineplus">+  counts.onHdrDeleted = 0;</span>
<a href="#l65.594"></a><span id="l65.594" class="difflineplus">+  counts.onHdrAdded = 0;</span>
<a href="#l65.595"></a><span id="l65.595" class="difflineplus">+  counts.onParentChanged = 0;</span>
<a href="#l65.596"></a><span id="l65.596" class="difflineplus">+  counts.onAnnouncerGoingAway = 0;</span>
<a href="#l65.597"></a><span id="l65.597" class="difflineplus">+  counts.onReadChanged = 0;</span>
<a href="#l65.598"></a><span id="l65.598" class="difflineplus">+  counts.onJunkScoreChanged = 0;</span>
<a href="#l65.599"></a><span id="l65.599" class="difflineplus">+  counts.onHdrPropertyChanged = 0;</span>
<a href="#l65.600"></a><span id="l65.600" class="difflineplus">+  counts.onEvent = 0;</span>
<a href="#l65.601"></a><span id="l65.601" class="difflineplus">+}</span>
<a href="#l65.602"></a><span id="l65.602" class="difflineplus">+</span>
<a href="#l65.603"></a><span id="l65.603" class="difflineplus">+DBListener.prototype =</span>
<a href="#l65.604"></a><span id="l65.604" class="difflineplus">+{</span>
<a href="#l65.605"></a><span id="l65.605" class="difflineplus">+  onHdrFlagsChanged:</span>
<a href="#l65.606"></a><span id="l65.606" class="difflineplus">+    function onHdrFlagsChanged(aHdrChanged, aOldFlags, aNewFlags, aInstigator)</span>
<a href="#l65.607"></a><span id="l65.607" class="difflineplus">+    {</span>
<a href="#l65.608"></a><span id="l65.608" class="difflineplus">+      this.counts.onHdrFlagsChanged++;</span>
<a href="#l65.609"></a><span id="l65.609" class="difflineplus">+    },</span>
<a href="#l65.610"></a><span id="l65.610" class="difflineplus">+</span>
<a href="#l65.611"></a><span id="l65.611" class="difflineplus">+  onHdrDeleted:</span>
<a href="#l65.612"></a><span id="l65.612" class="difflineplus">+    function onHdrDeleted(aHdrChanged, aParentKey, Flags, aInstigator)</span>
<a href="#l65.613"></a><span id="l65.613" class="difflineplus">+    {</span>
<a href="#l65.614"></a><span id="l65.614" class="difflineplus">+      this.counts.onHdrDeleted++;</span>
<a href="#l65.615"></a><span id="l65.615" class="difflineplus">+    },</span>
<a href="#l65.616"></a><span id="l65.616" class="difflineplus">+</span>
<a href="#l65.617"></a><span id="l65.617" class="difflineplus">+  onHdrAdded:</span>
<a href="#l65.618"></a><span id="l65.618" class="difflineplus">+    function onHdrAdded(aHdrChanged, aParentKey, aFlags, aInstigator)</span>
<a href="#l65.619"></a><span id="l65.619" class="difflineplus">+    {</span>
<a href="#l65.620"></a><span id="l65.620" class="difflineplus">+      this.counts.onHdrAdded++;</span>
<a href="#l65.621"></a><span id="l65.621" class="difflineplus">+      gHeader = aHdrChanged;</span>
<a href="#l65.622"></a><span id="l65.622" class="difflineplus">+    },</span>
<a href="#l65.623"></a><span id="l65.623" class="difflineplus">+</span>
<a href="#l65.624"></a><span id="l65.624" class="difflineplus">+  onParentChanged:</span>
<a href="#l65.625"></a><span id="l65.625" class="difflineplus">+    function onParentChanged(aKeyChanged, oldParent, newParent, aInstigator)</span>
<a href="#l65.626"></a><span id="l65.626" class="difflineplus">+    {</span>
<a href="#l65.627"></a><span id="l65.627" class="difflineplus">+      this.counts.onParentChanged++;</span>
<a href="#l65.628"></a><span id="l65.628" class="difflineplus">+    },</span>
<a href="#l65.629"></a><span id="l65.629" class="difflineplus">+    </span>
<a href="#l65.630"></a><span id="l65.630" class="difflineplus">+  onAnnouncerGoingAway:</span>
<a href="#l65.631"></a><span id="l65.631" class="difflineplus">+    function onAnnouncerGoingAway(instigator)</span>
<a href="#l65.632"></a><span id="l65.632" class="difflineplus">+    {</span>
<a href="#l65.633"></a><span id="l65.633" class="difflineplus">+      if (gInboxListener)</span>
<a href="#l65.634"></a><span id="l65.634" class="difflineplus">+        try {</span>
<a href="#l65.635"></a><span id="l65.635" class="difflineplus">+          gIMAPInbox.msgDatabase.RemoveListener(gInboxListener);</span>
<a href="#l65.636"></a><span id="l65.636" class="difflineplus">+        }</span>
<a href="#l65.637"></a><span id="l65.637" class="difflineplus">+        catch (e) {dump(&quot; listener not found\n&quot;);}</span>
<a href="#l65.638"></a><span id="l65.638" class="difflineplus">+      this.counts.onAnnouncerGoingAway++;</span>
<a href="#l65.639"></a><span id="l65.639" class="difflineplus">+    },</span>
<a href="#l65.640"></a><span id="l65.640" class="difflineplus">+    </span>
<a href="#l65.641"></a><span id="l65.641" class="difflineplus">+  onReadChanged:</span>
<a href="#l65.642"></a><span id="l65.642" class="difflineplus">+    function onReadChanged(aInstigator)</span>
<a href="#l65.643"></a><span id="l65.643" class="difflineplus">+    {</span>
<a href="#l65.644"></a><span id="l65.644" class="difflineplus">+      this.counts.onReadChanged++;</span>
<a href="#l65.645"></a><span id="l65.645" class="difflineplus">+    },</span>
<a href="#l65.646"></a><span id="l65.646" class="difflineplus">+    </span>
<a href="#l65.647"></a><span id="l65.647" class="difflineplus">+  onJunkScoreChanged:</span>
<a href="#l65.648"></a><span id="l65.648" class="difflineplus">+    function onJunkScoreChanged(aInstigator)</span>
<a href="#l65.649"></a><span id="l65.649" class="difflineplus">+    {</span>
<a href="#l65.650"></a><span id="l65.650" class="difflineplus">+      this.counts.onJunkScoreChanged++;</span>
<a href="#l65.651"></a><span id="l65.651" class="difflineplus">+    },</span>
<a href="#l65.652"></a><span id="l65.652" class="difflineplus">+    </span>
<a href="#l65.653"></a><span id="l65.653" class="difflineplus">+  onHdrPropertyChanged:</span>
<a href="#l65.654"></a><span id="l65.654" class="difflineplus">+    function onHdrPropertyChanged(aHdrToChange, aPreChange, aStatus, aInstigator)</span>
<a href="#l65.655"></a><span id="l65.655" class="difflineplus">+    {</span>
<a href="#l65.656"></a><span id="l65.656" class="difflineplus">+      this.counts.onHdrPropertyChanged++;</span>
<a href="#l65.657"></a><span id="l65.657" class="difflineplus">+    },</span>
<a href="#l65.658"></a><span id="l65.658" class="difflineplus">+    </span>
<a href="#l65.659"></a><span id="l65.659" class="difflineplus">+  onEvent:</span>
<a href="#l65.660"></a><span id="l65.660" class="difflineplus">+    function onEvent(aDB, aEvent)</span>
<a href="#l65.661"></a><span id="l65.661" class="difflineplus">+    {</span>
<a href="#l65.662"></a><span id="l65.662" class="difflineplus">+      this.counts.onEvent++;</span>
<a href="#l65.663"></a><span id="l65.663" class="difflineplus">+    },</span>
<a href="#l65.664"></a><span id="l65.664" class="difflineplus">+</span>
<a href="#l65.665"></a><span id="l65.665" class="difflineplus">+};</span>
<a href="#l65.666"></a><span id="l65.666" class="difflineplus">+</span>
<a href="#l65.667"></a><span id="l65.667" class="difflineplus">+/*</span>
<a href="#l65.668"></a><span id="l65.668" class="difflineplus">+ * helper functions</span>
<a href="#l65.669"></a><span id="l65.669" class="difflineplus">+ */</span>
<a href="#l65.670"></a><span id="l65.670" class="difflineplus">+</span>
<a href="#l65.671"></a><span id="l65.671" class="difflineplus">+// return the number of messages in a folder (and check that the</span>
<a href="#l65.672"></a><span id="l65.672" class="difflineplus">+// folder counts match the database counts)</span>
<a href="#l65.673"></a><span id="l65.673" class="difflineplus">+function folderCount(folder)</span>
<a href="#l65.674"></a><span id="l65.674" class="difflineplus">+{</span>
<a href="#l65.675"></a><span id="l65.675" class="difflineplus">+  // count using the database</span>
<a href="#l65.676"></a><span id="l65.676" class="difflineplus">+  let enumerator = folder.msgDatabase.EnumerateMessages();</span>
<a href="#l65.677"></a><span id="l65.677" class="difflineplus">+  let dbCount = 0;</span>
<a href="#l65.678"></a><span id="l65.678" class="difflineplus">+  while (enumerator.hasMoreElements())</span>
<a href="#l65.679"></a><span id="l65.679" class="difflineplus">+  {</span>
<a href="#l65.680"></a><span id="l65.680" class="difflineplus">+    dbCount++;</span>
<a href="#l65.681"></a><span id="l65.681" class="difflineplus">+    let hdr = enumerator.getNext();</span>
<a href="#l65.682"></a><span id="l65.682" class="difflineplus">+  }</span>
<a href="#l65.683"></a><span id="l65.683" class="difflineplus">+</span>
<a href="#l65.684"></a><span id="l65.684" class="difflineplus">+  // count using the folder</span>
<a href="#l65.685"></a><span id="l65.685" class="difflineplus">+  let folderCount = folder.getTotalMessages(false);</span>
<a href="#l65.686"></a><span id="l65.686" class="difflineplus">+</span>
<a href="#l65.687"></a><span id="l65.687" class="difflineplus">+  // compare the two</span>
<a href="#l65.688"></a><span id="l65.688" class="difflineplus">+  do_check_eq(dbCount, folderCount);</span>
<a href="#l65.689"></a><span id="l65.689" class="difflineplus">+  return dbCount;</span>
<a href="#l65.690"></a><span id="l65.690" class="difflineplus">+}</span>
<a href="#l65.691"></a><span id="l65.691" class="difflineplus">+</span>
<a href="#l65.692"></a><span id="l65.692" class="difflineplus">+// list all of the messages in a folder for debug</span>
<a href="#l65.693"></a><span id="l65.693" class="difflineplus">+function listMessages(folder) {</span>
<a href="#l65.694"></a><span id="l65.694" class="difflineplus">+  let enumerator = folder.msgDatabase.EnumerateMessages();</span>
<a href="#l65.695"></a><span id="l65.695" class="difflineplus">+  var msgCount = 0;</span>
<a href="#l65.696"></a><span id="l65.696" class="difflineplus">+  dump(&quot;listing messages for &quot; + folder.prettyName + &quot;\n&quot;);</span>
<a href="#l65.697"></a><span id="l65.697" class="difflineplus">+  while(enumerator.hasMoreElements())</span>
<a href="#l65.698"></a><span id="l65.698" class="difflineplus">+  {</span>
<a href="#l65.699"></a><span id="l65.699" class="difflineplus">+    msgCount++;</span>
<a href="#l65.700"></a><span id="l65.700" class="difflineplus">+    let hdr = enumerator.getNext().QueryInterface(Ci.nsIMsgDBHdr);</span>
<a href="#l65.701"></a><span id="l65.701" class="difflineplus">+    dump(msgCount + &quot;: &quot; + hdr.subject + &quot;\n&quot;);</span>
<a href="#l65.702"></a><span id="l65.702" class="difflineplus">+  }</span>
<a href="#l65.703"></a><span id="l65.703" class="difflineplus">+}</span>
<a href="#l65.704"></a><span id="l65.704" class="difflineplus">+</span>
<a href="#l65.705"></a><span id="l65.705" class="difflineplus">+// given a test file, return the file uri spec</span>
<a href="#l65.706"></a><span id="l65.706" class="difflineplus">+function specForFileName(aFileName)</span>
<a href="#l65.707"></a><span id="l65.707" class="difflineplus">+{</span>
<a href="#l65.708"></a><span id="l65.708" class="difflineplus">+  let file = do_get_file(&quot;../../mailnews/data/&quot; + aFileName);</span>
<a href="#l65.709"></a><span id="l65.709" class="difflineplus">+  let msgfileuri = Cc[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l65.710"></a><span id="l65.710" class="difflineplus">+                     .getService(Ci.nsIIOService)</span>
<a href="#l65.711"></a><span id="l65.711" class="difflineplus">+                     .newFileURI(file)</span>
<a href="#l65.712"></a><span id="l65.712" class="difflineplus">+                     .QueryInterface(Ci.nsIFileURL);</span>
<a href="#l65.713"></a><span id="l65.713" class="difflineplus">+  return msgfileuri.spec;</span>
<a href="#l65.714"></a><span id="l65.714" class="difflineplus">+}</span>
<a href="#l65.715"></a><span id="l65.715" class="difflineplus">+</span>
<a href="#l65.716"></a><span id="l65.716" class="difflineplus">+// shorthand for the inbox message summary database</span>
<a href="#l65.717"></a><span id="l65.717" class="difflineplus">+function db()</span>
<a href="#l65.718"></a><span id="l65.718" class="difflineplus">+{</span>
<a href="#l65.719"></a><span id="l65.719" class="difflineplus">+  return gIMAPInbox.msgDatabase;</span>
<a href="#l65.720"></a><span id="l65.720" class="difflineplus">+}</span>
<a href="#l65.721"></a><span id="l65.721" class="difflineplus">+</span>
<a href="#l65.722"></a><span id="l65.722" class="difflineplus">+// This function may be used in the test array to show</span>
<a href="#l65.723"></a><span id="l65.723" class="difflineplus">+// more detailed results after a particular test.</span>
<a href="#l65.724"></a><span id="l65.724" class="difflineplus">+function showResults() {</span>
<a href="#l65.725"></a><span id="l65.725" class="difflineplus">+  listMessages(gIMAPInbox);</span>
<a href="#l65.726"></a><span id="l65.726" class="difflineplus">+  if (gInboxListener)</span>
<a href="#l65.727"></a><span id="l65.727" class="difflineplus">+    printListener(gInboxListener);</span>
<a href="#l65.728"></a><span id="l65.728" class="difflineplus">+  gCurTestNum++;</span>
<a href="#l65.729"></a><span id="l65.729" class="difflineplus">+  do_timeout(100, &quot;doTest();&quot;);</span>
<a href="#l65.730"></a><span id="l65.730" class="difflineplus">+}</span>
<a href="#l65.731"></a><span id="l65.731" class="difflineplus">+</span>
<a href="#l65.732"></a><span id="l65.732" class="difflineplus">+// static variables used in testCounts</span>
<a href="#l65.733"></a><span id="l65.733" class="difflineplus">+var gPreviousUnread = 0;</span>
<a href="#l65.734"></a><span id="l65.734" class="difflineplus">+var gPreviousDbNew = 0;</span>
<a href="#l65.735"></a><span id="l65.735" class="difflineplus">+</span>
<a href="#l65.736"></a><span id="l65.736" class="difflineplus">+// Test various counts.</span>
<a href="#l65.737"></a><span id="l65.737" class="difflineplus">+//</span>
<a href="#l65.738"></a><span id="l65.738" class="difflineplus">+//  aHasNew:         folder hasNew flag</span>
<a href="#l65.739"></a><span id="l65.739" class="difflineplus">+//  aUnreadDelta:    change in unread count for the folder</span>
<a href="#l65.740"></a><span id="l65.740" class="difflineplus">+//  aFolderNewDelta: change in new count for the folder</span>
<a href="#l65.741"></a><span id="l65.741" class="difflineplus">+//  aDbNewDelta:     change in new count for the database</span>
<a href="#l65.742"></a><span id="l65.742" class="difflineplus">+//</span>
<a href="#l65.743"></a><span id="l65.743" class="difflineplus">+function testCounts(aHasNew, aUnreadDelta, aFolderNewDelta, aDbNewDelta)</span>
<a href="#l65.744"></a><span id="l65.744" class="difflineplus">+{</span>
<a href="#l65.745"></a><span id="l65.745" class="difflineplus">+  try {</span>
<a href="#l65.746"></a><span id="l65.746" class="difflineplus">+  let folderNew = gIMAPInbox.getNumNewMessages(false);</span>
<a href="#l65.747"></a><span id="l65.747" class="difflineplus">+  let hasNew = gIMAPInbox.hasNewMessages;</span>
<a href="#l65.748"></a><span id="l65.748" class="difflineplus">+  let unread = gIMAPInbox.getNumUnread(false);</span>
<a href="#l65.749"></a><span id="l65.749" class="difflineplus">+  let countOut = {};</span>
<a href="#l65.750"></a><span id="l65.750" class="difflineplus">+  let arrayOut = {};</span>
<a href="#l65.751"></a><span id="l65.751" class="difflineplus">+  db().getNewList(countOut, arrayOut);</span>
<a href="#l65.752"></a><span id="l65.752" class="difflineplus">+  let dbNew = countOut.value ? countOut.value : 0;</span>
<a href="#l65.753"></a><span id="l65.753" class="difflineplus">+  let folderNewFlag = gIMAPInbox.getFlag(Ci.nsMsgFolderFlags.GotNew);</span>
<a href="#l65.754"></a><span id="l65.754" class="difflineplus">+  dump(&quot; hasNew: &quot; + hasNew +</span>
<a href="#l65.755"></a><span id="l65.755" class="difflineplus">+       &quot; unread: &quot; + unread +</span>
<a href="#l65.756"></a><span id="l65.756" class="difflineplus">+       &quot; folderNew: &quot; + folderNew +</span>
<a href="#l65.757"></a><span id="l65.757" class="difflineplus">+       &quot; folderNewFlag: &quot; + folderNewFlag +</span>
<a href="#l65.758"></a><span id="l65.758" class="difflineplus">+       &quot; dbNew: &quot; + dbNew +</span>
<a href="#l65.759"></a><span id="l65.759" class="difflineplus">+       &quot;\n&quot;);</span>
<a href="#l65.760"></a><span id="l65.760" class="difflineplus">+  do_check_eq(aHasNew, hasNew);</span>
<a href="#l65.761"></a><span id="l65.761" class="difflineplus">+  do_check_eq(aUnreadDelta, unread - gPreviousUnread);</span>
<a href="#l65.762"></a><span id="l65.762" class="difflineplus">+  gPreviousUnread = unread;</span>
<a href="#l65.763"></a><span id="l65.763" class="difflineplus">+  // this seems to be rest for each folder update</span>
<a href="#l65.764"></a><span id="l65.764" class="difflineplus">+  do_check_eq(aFolderNewDelta, folderNew);</span>
<a href="#l65.765"></a><span id="l65.765" class="difflineplus">+  do_check_eq(aDbNewDelta, dbNew - gPreviousDbNew);</span>
<a href="#l65.766"></a><span id="l65.766" class="difflineplus">+  gPreviousDbNew = dbNew;</span>
<a href="#l65.767"></a><span id="l65.767" class="difflineplus">+  } catch (e) {dump(e);}</span>
<a href="#l65.768"></a><span id="l65.768" class="difflineplus">+}</span>
<a href="#l65.769"></a><span id="l65.769" class="difflineplus">+</span>
<a href="#l65.770"></a><span id="l65.770" class="difflineplus">+// print the counts for debugging purposes in this test</span>
<a href="#l65.771"></a><span id="l65.771" class="difflineplus">+function printListener(listener)</span>
<a href="#l65.772"></a><span id="l65.772" class="difflineplus">+{</span>
<a href="#l65.773"></a><span id="l65.773" class="difflineplus">+  print(&quot;DBListener counts: &quot;);</span>
<a href="#l65.774"></a><span id="l65.774" class="difflineplus">+  for (var item in listener.counts) {</span>
<a href="#l65.775"></a><span id="l65.775" class="difflineplus">+      dump(item + &quot;: &quot; + listener.counts[item] + &quot; &quot;);</span>
<a href="#l65.776"></a><span id="l65.776" class="difflineplus">+  }</span>
<a href="#l65.777"></a><span id="l65.777" class="difflineplus">+  dump(&quot;\n&quot;);</span>
<a href="#l65.778"></a><span id="l65.778" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l66.1"></a><span id="l66.1" class="difflineminus">--- a/mailnews/local/src/nsLocalMailFolder.cpp</span>
<a href="#l66.2"></a><span id="l66.2" class="difflineplus">+++ b/mailnews/local/src/nsLocalMailFolder.cpp</span>
<a href="#l66.3"></a><span id="l66.3" class="difflineat">@@ -2752,22 +2752,27 @@ NS_IMETHODIMP nsMsgLocalMailFolder::EndC</span>
<a href="#l66.4"></a><span id="l66.4"> </span>
<a href="#l66.5"></a><span id="l66.5">         if (mCopyState-&gt;m_msgWindow &amp;&amp; mCopyState-&gt;m_undoMsgTxn)</span>
<a href="#l66.6"></a><span id="l66.6">         {</span>
<a href="#l66.7"></a><span id="l66.7">           nsCOMPtr&lt;nsITransactionManager&gt; txnMgr;</span>
<a href="#l66.8"></a><span id="l66.8">           mCopyState-&gt;m_msgWindow-&gt;GetTransactionManager(getter_AddRefs(txnMgr));</span>
<a href="#l66.9"></a><span id="l66.9">           if (txnMgr)</span>
<a href="#l66.10"></a><span id="l66.10">             txnMgr-&gt;DoTransaction(mCopyState-&gt;m_undoMsgTxn);</span>
<a href="#l66.11"></a><span id="l66.11">         }</span>
<a href="#l66.12"></a><span id="l66.12" class="difflineminus">-        if (srcFolder &amp;&amp; !mCopyState-&gt;m_isFolder)</span>
<a href="#l66.13"></a><span id="l66.13" class="difflineminus">-          srcFolder-&gt;NotifyFolderEvent(mDeleteOrMoveMsgCompletedAtom);</span>
<a href="#l66.14"></a><span id="l66.14" class="difflineminus">-</span>
<a href="#l66.15"></a><span id="l66.15" class="difflineminus">-        (void) OnCopyCompleted(mCopyState-&gt;m_srcSupport, PR_TRUE);</span>
<a href="#l66.16"></a><span id="l66.16" class="difflineplus">+</span>
<a href="#l66.17"></a><span id="l66.17">         // enable the dest folder</span>
<a href="#l66.18"></a><span id="l66.18">         EnableNotifications(allMessageCountNotifications, PR_TRUE, PR_FALSE /*dbBatching*/); //dest folder doesn't need db batching</span>
<a href="#l66.19"></a><span id="l66.19" class="difflineplus">+        if (srcFolder &amp;&amp; !mCopyState-&gt;m_isFolder)</span>
<a href="#l66.20"></a><span id="l66.20" class="difflineplus">+        {</span>
<a href="#l66.21"></a><span id="l66.21" class="difflineplus">+          // I'm not too sure of the proper location of this event. It seems to need to be</span>
<a href="#l66.22"></a><span id="l66.22" class="difflineplus">+          // after the EnableNotifications, or the folder counts can be incorrect</span>
<a href="#l66.23"></a><span id="l66.23" class="difflineplus">+          // during the mDeleteOrMoveMsgCompletedAtom call.</span>
<a href="#l66.24"></a><span id="l66.24" class="difflineplus">+          srcFolder-&gt;NotifyFolderEvent(mDeleteOrMoveMsgCompletedAtom);</span>
<a href="#l66.25"></a><span id="l66.25" class="difflineplus">+        }</span>
<a href="#l66.26"></a><span id="l66.26" class="difflineplus">+        (void) OnCopyCompleted(mCopyState-&gt;m_srcSupport, PR_TRUE);</span>
<a href="#l66.27"></a><span id="l66.27">       }</span>
<a href="#l66.28"></a><span id="l66.28">     }</span>
<a href="#l66.29"></a><span id="l66.29">     // Send the itemAdded notification in case we didn't send the itemMoveCopyCompleted notification earlier.</span>
<a href="#l66.30"></a><span id="l66.30">     // Posting news messages involves this, yet doesn't have the newHdr initialized, so don't send any</span>
<a href="#l66.31"></a><span id="l66.31">     // notifications in that case.</span>
<a href="#l66.32"></a><span id="l66.32">     if (!numHdrs &amp;&amp; newHdr)</span>
<a href="#l66.33"></a><span id="l66.33">     {</span>
<a href="#l66.34"></a><span id="l66.34">       nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l66.35"></a><span id="l66.35" class="difflineat">@@ -2834,21 +2839,24 @@ NS_IMETHODIMP nsMsgLocalMailFolder::EndM</span>
<a href="#l66.36"></a><span id="l66.36">         // we call DeleteMessages on the source folder. So don't mark it for deletion</span>
<a href="#l66.37"></a><span id="l66.37">         // here, in that case.</span>
<a href="#l66.38"></a><span id="l66.38">         if (!GetDeleteFromServerOnMove())</span>
<a href="#l66.39"></a><span id="l66.39">           localSrcFolder-&gt;MarkMsgsOnPop3Server(mCopyState-&gt;m_messages, POP3_DELETE);</span>
<a href="#l66.40"></a><span id="l66.40">       }</span>
<a href="#l66.41"></a><span id="l66.41">     }</span>
<a href="#l66.42"></a><span id="l66.42">     // lets delete these all at once - much faster that way</span>
<a href="#l66.43"></a><span id="l66.43">     rv = srcFolder-&gt;DeleteMessages(mCopyState-&gt;m_messages, mCopyState-&gt;m_msgWindow, PR_TRUE, PR_TRUE, nsnull, mCopyState-&gt;m_allowUndo);</span>
<a href="#l66.44"></a><span id="l66.44" class="difflineminus">-    srcFolder-&gt;NotifyFolderEvent(NS_SUCCEEDED(rv) ? mDeleteOrMoveMsgCompletedAtom : mDeleteOrMoveMsgFailedAtom);</span>
<a href="#l66.45"></a><span id="l66.45">     AutoCompact(mCopyState-&gt;m_msgWindow);</span>
<a href="#l66.46"></a><span id="l66.46"> </span>
<a href="#l66.47"></a><span id="l66.47">     // enable the dest folder</span>
<a href="#l66.48"></a><span id="l66.48">     EnableNotifications(allMessageCountNotifications, PR_TRUE, PR_FALSE /*dbBatching*/); //dest folder doesn't need db batching</span>
<a href="#l66.49"></a><span id="l66.49" class="difflineplus">+    // I'm not too sure of the proper location of this event. It seems to need to be</span>
<a href="#l66.50"></a><span id="l66.50" class="difflineplus">+    // after the EnableNotifications, or the folder counts can be incorrect</span>
<a href="#l66.51"></a><span id="l66.51" class="difflineplus">+    // during the mDeleteOrMoveMsgCompletedAtom call.</span>
<a href="#l66.52"></a><span id="l66.52" class="difflineplus">+    srcFolder-&gt;NotifyFolderEvent(NS_SUCCEEDED(rv) ? mDeleteOrMoveMsgCompletedAtom : mDeleteOrMoveMsgFailedAtom);</span>
<a href="#l66.53"></a><span id="l66.53"> </span>
<a href="#l66.54"></a><span id="l66.54">     if (NS_SUCCEEDED(rv) &amp;&amp; mCopyState-&gt;m_msgWindow &amp;&amp; mCopyState-&gt;m_undoMsgTxn)</span>
<a href="#l66.55"></a><span id="l66.55">     {</span>
<a href="#l66.56"></a><span id="l66.56">       nsCOMPtr&lt;nsITransactionManager&gt; txnMgr;</span>
<a href="#l66.57"></a><span id="l66.57">       mCopyState-&gt;m_msgWindow-&gt;GetTransactionManager(getter_AddRefs(txnMgr));</span>
<a href="#l66.58"></a><span id="l66.58">       if (txnMgr)</span>
<a href="#l66.59"></a><span id="l66.59">         txnMgr-&gt;DoTransaction(mCopyState-&gt;m_undoMsgTxn);</span>
<a href="#l66.60"></a><span id="l66.60">     }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l67.1"></a><span id="l67.1" class="difflineminus">--- a/mailnews/local/src/nsPop3Protocol.cpp</span>
<a href="#l67.2"></a><span id="l67.2" class="difflineplus">+++ b/mailnews/local/src/nsPop3Protocol.cpp</span>
<a href="#l67.3"></a><span id="l67.3" class="difflineat">@@ -534,16 +534,18 @@ nsresult nsPop3Protocol::Initialize(nsIU</span>
<a href="#l67.4"></a><span id="l67.4">     // When we are making a secure connection, we need to make sure that we</span>
<a href="#l67.5"></a><span id="l67.5">     // pass an interface requestor down to the socket transport so that PSM can</span>
<a href="#l67.6"></a><span id="l67.6">     // retrieve a nsIPrompt instance if needed.</span>
<a href="#l67.7"></a><span id="l67.7">     nsCOMPtr&lt;nsIInterfaceRequestor&gt; ir;</span>
<a href="#l67.8"></a><span id="l67.8">     if (m_socketType != nsIMsgIncomingServer::defaultSocket)</span>
<a href="#l67.9"></a><span id="l67.9">     {</span>
<a href="#l67.10"></a><span id="l67.10">       nsCOMPtr&lt;nsIMsgWindow&gt; msgwin;</span>
<a href="#l67.11"></a><span id="l67.11">       mailnewsUrl-&gt;GetMsgWindow(getter_AddRefs(msgwin));</span>
<a href="#l67.12"></a><span id="l67.12" class="difflineplus">+      if (!msgwin)</span>
<a href="#l67.13"></a><span id="l67.13" class="difflineplus">+        GetTopmostMsgWindow(getter_AddRefs(msgwin));</span>
<a href="#l67.14"></a><span id="l67.14">       if (msgwin)</span>
<a href="#l67.15"></a><span id="l67.15">       {</span>
<a href="#l67.16"></a><span id="l67.16">         nsCOMPtr&lt;nsIDocShell&gt; docshell;</span>
<a href="#l67.17"></a><span id="l67.17">         msgwin-&gt;GetRootDocShell(getter_AddRefs(docshell));</span>
<a href="#l67.18"></a><span id="l67.18">         ir = do_QueryInterface(docshell);</span>
<a href="#l67.19"></a><span id="l67.19">         nsCOMPtr&lt;nsIInterfaceRequestor&gt; notificationCallbacks;</span>
<a href="#l67.20"></a><span id="l67.20">         msgwin-&gt;GetNotificationCallbacks(getter_AddRefs(notificationCallbacks));</span>
<a href="#l67.21"></a><span id="l67.21">         if (notificationCallbacks)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l68.1"></a><span id="l68.1" class="difflineminus">--- a/mailnews/test/fakeserver/maild.js</span>
<a href="#l68.2"></a><span id="l68.2" class="difflineplus">+++ b/mailnews/test/fakeserver/maild.js</span>
<a href="#l68.3"></a><span id="l68.3" class="difflineat">@@ -34,16 +34,21 @@</span>
<a href="#l68.4"></a><span id="l68.4">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l68.5"></a><span id="l68.5">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l68.6"></a><span id="l68.6">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l68.7"></a><span id="l68.7">  *</span>
<a href="#l68.8"></a><span id="l68.8">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l68.9"></a><span id="l68.9"> </span>
<a href="#l68.10"></a><span id="l68.10"> // Much of the original code is taken from netwerk's httpserver implementation</span>
<a href="#l68.11"></a><span id="l68.11"> </span>
<a href="#l68.12"></a><span id="l68.12" class="difflineplus">+// Make sure we execute this file exactly once</span>
<a href="#l68.13"></a><span id="l68.13" class="difflineplus">+var gMaild_js__;</span>
<a href="#l68.14"></a><span id="l68.14" class="difflineplus">+if (!gMaild_js__) {</span>
<a href="#l68.15"></a><span id="l68.15" class="difflineplus">+gMaild_js__ = true;</span>
<a href="#l68.16"></a><span id="l68.16" class="difflineplus">+</span>
<a href="#l68.17"></a><span id="l68.17"> var Cc = Components.classes;</span>
<a href="#l68.18"></a><span id="l68.18"> var Ci = Components.interfaces;</span>
<a href="#l68.19"></a><span id="l68.19"> var Cr = Components.results;</span>
<a href="#l68.20"></a><span id="l68.20"> var CC = Components.Constructor;</span>
<a href="#l68.21"></a><span id="l68.21"> </span>
<a href="#l68.22"></a><span id="l68.22"> /** The XPCOM thread manager. */</span>
<a href="#l68.23"></a><span id="l68.23"> var gThreadManager = null;</span>
<a href="#l68.24"></a><span id="l68.24"> </span>
<a href="#l68.25"></a><span id="l68.25" class="difflineat">@@ -115,26 +120,33 @@ function nsMailServer(handler) {</span>
<a href="#l68.26"></a><span id="l68.26">    * True if the socket in this is closed (and closure notifications have been</span>
<a href="#l68.27"></a><span id="l68.27">    * sent and processed if the socket was ever opened), false otherwise.</span>
<a href="#l68.28"></a><span id="l68.28">    */</span>
<a href="#l68.29"></a><span id="l68.29">   this._socketClosed = true;</span>
<a href="#l68.30"></a><span id="l68.30"> </span>
<a href="#l68.31"></a><span id="l68.31">   this._handler = handler;</span>
<a href="#l68.32"></a><span id="l68.32">   this._readers = [];</span>
<a href="#l68.33"></a><span id="l68.33">   this._test = false;</span>
<a href="#l68.34"></a><span id="l68.34" class="difflineplus">+</span>
<a href="#l68.35"></a><span id="l68.35" class="difflineplus">+  /**</span>
<a href="#l68.36"></a><span id="l68.36" class="difflineplus">+   * An array to hold refs to all the input streams below, so that they don't</span>
<a href="#l68.37"></a><span id="l68.37" class="difflineplus">+   * get GCed</span>
<a href="#l68.38"></a><span id="l68.38" class="difflineplus">+   */</span>
<a href="#l68.39"></a><span id="l68.39" class="difflineplus">+  this._inputStreams = [];</span>
<a href="#l68.40"></a><span id="l68.40"> }</span>
<a href="#l68.41"></a><span id="l68.41"> nsMailServer.prototype = {</span>
<a href="#l68.42"></a><span id="l68.42">   onSocketAccepted : function (socket, trans) {</span>
<a href="#l68.43"></a><span id="l68.43">     if (this._debug != fsDebugNone)</span>
<a href="#l68.44"></a><span id="l68.44">       print(&quot;Received Connection from &quot; + trans.host + &quot;:&quot; + trans.port);</span>
<a href="#l68.45"></a><span id="l68.45"> </span>
<a href="#l68.46"></a><span id="l68.46">     const SEGMENT_SIZE = 1024;</span>
<a href="#l68.47"></a><span id="l68.47">     const SEGMENT_COUNT = 1024;</span>
<a href="#l68.48"></a><span id="l68.48">     var input = trans.openInputStream(0, SEGMENT_SIZE, SEGMENT_COUNT)</span>
<a href="#l68.49"></a><span id="l68.49">                      .QueryInterface(Ci.nsIAsyncInputStream);</span>
<a href="#l68.50"></a><span id="l68.50" class="difflineplus">+    this._inputStreams.push(input);</span>
<a href="#l68.51"></a><span id="l68.51"> </span>
<a href="#l68.52"></a><span id="l68.52">     var reader = new nsMailReader(this, this._handler, trans, this._debug);</span>
<a href="#l68.53"></a><span id="l68.53">     this._readers.push(reader);</span>
<a href="#l68.54"></a><span id="l68.54"> </span>
<a href="#l68.55"></a><span id="l68.55">     // Note: must use main thread here, or we might get a GC that will cause</span>
<a href="#l68.56"></a><span id="l68.56">     //       threadsafety assertions.  We really need to fix XPConnect so that</span>
<a href="#l68.57"></a><span id="l68.57">     //       you can actually do things in multi-threaded JS.  :-(</span>
<a href="#l68.58"></a><span id="l68.58">     input.asyncWait(reader, 0, 0, gThreadManager.mainThread);</span>
<a href="#l68.59"></a><span id="l68.59" class="difflineat">@@ -521,8 +533,10 @@ nsMailReader.prototype = {</span>
<a href="#l68.60"></a><span id="l68.60">  *   use on the server</span>
<a href="#l68.61"></a><span id="l68.61">  */</span>
<a href="#l68.62"></a><span id="l68.62"> function server(port, handler) {</span>
<a href="#l68.63"></a><span id="l68.63">   var srv = new nsMailServer(handler);</span>
<a href="#l68.64"></a><span id="l68.64">   srv.start(port);</span>
<a href="#l68.65"></a><span id="l68.65">   srv.performTest();</span>
<a href="#l68.66"></a><span id="l68.66">   return srv.playTransaction();</span>
<a href="#l68.67"></a><span id="l68.67"> }</span>
<a href="#l68.68"></a><span id="l68.68" class="difflineplus">+</span>
<a href="#l68.69"></a><span id="l68.69" class="difflineplus">+} // gMaild_js__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l69.1"></a><span id="l69.1" class="difflineminus">--- a/mailnews/test/resources/mailDirService.js</span>
<a href="#l69.2"></a><span id="l69.2" class="difflineplus">+++ b/mailnews/test/resources/mailDirService.js</span>
<a href="#l69.3"></a><span id="l69.3" class="difflineat">@@ -4,16 +4,21 @@</span>
<a href="#l69.4"></a><span id="l69.4">  * directory under the process directory and use that as the profile</span>
<a href="#l69.5"></a><span id="l69.5">  * directory for the mailnews tests to locate files during unit tests.</span>
<a href="#l69.6"></a><span id="l69.6">  *</span>
<a href="#l69.7"></a><span id="l69.7">  * For xpcshell tests, the &quot;profile&quot; directory will be:</span>
<a href="#l69.8"></a><span id="l69.8">  * &lt;objdir&gt;/dist/bin/mailtest/  (on Windows and Linux)</span>
<a href="#l69.9"></a><span id="l69.9">  * &lt;objdir&gt;/dist/Thunderbird{Debug}.app/Contents/MacOS/mailtest/  (on Mac OS X)</span>
<a href="#l69.10"></a><span id="l69.10">  */</span>
<a href="#l69.11"></a><span id="l69.11"> </span>
<a href="#l69.12"></a><span id="l69.12" class="difflineplus">+// Make sure we execute this file exactly once</span>
<a href="#l69.13"></a><span id="l69.13" class="difflineplus">+var gMailDirService_js__;</span>
<a href="#l69.14"></a><span id="l69.14" class="difflineplus">+if (!gMailDirService_js__) {</span>
<a href="#l69.15"></a><span id="l69.15" class="difflineplus">+gMailDirService_js__ = true;</span>
<a href="#l69.16"></a><span id="l69.16" class="difflineplus">+</span>
<a href="#l69.17"></a><span id="l69.17"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l69.18"></a><span id="l69.18"> </span>
<a href="#l69.19"></a><span id="l69.19"> // Declare these globally for unit tests and be done with it.</span>
<a href="#l69.20"></a><span id="l69.20"> var Cc = Components.classes;</span>
<a href="#l69.21"></a><span id="l69.21"> var Ci = Components.interfaces;</span>
<a href="#l69.22"></a><span id="l69.22"> var Cr = Components.results;</span>
<a href="#l69.23"></a><span id="l69.23"> var CC = Components.Constructor;</span>
<a href="#l69.24"></a><span id="l69.24"> </span>
<a href="#l69.25"></a><span id="l69.25" class="difflineat">@@ -128,8 +133,10 @@ catch (e) {</span>
<a href="#l69.26"></a><span id="l69.26">   if (gProfileDir.exists())</span>
<a href="#l69.27"></a><span id="l69.27">     gProfileDir.remove(true);</span>
<a href="#l69.28"></a><span id="l69.28"> </span>
<a href="#l69.29"></a><span id="l69.29">   // This throw is so that we know if this bug happens</span>
<a href="#l69.30"></a><span id="l69.30">   throw Cr.NS_ERROR_FAILURE;</span>
<a href="#l69.31"></a><span id="l69.31"> }</span>
<a href="#l69.32"></a><span id="l69.32"> // Always ensure the profile directory exists before we start the tests</span>
<a href="#l69.33"></a><span id="l69.33"> gProfileDir.create(Ci.nsIFile.DIRECTORY_TYPE, 0700);</span>
<a href="#l69.34"></a><span id="l69.34" class="difflineplus">+</span>
<a href="#l69.35"></a><span id="l69.35" class="difflineplus">+} // gMailDirService_js__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l70.1"></a><span id="l70.1" class="difflineminus">--- a/mailnews/test/resources/mailTestUtils.js</span>
<a href="#l70.2"></a><span id="l70.2" class="difflineplus">+++ b/mailnews/test/resources/mailTestUtils.js</span>
<a href="#l70.3"></a><span id="l70.3" class="difflineat">@@ -30,16 +30,21 @@</span>
<a href="#l70.4"></a><span id="l70.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l70.5"></a><span id="l70.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l70.6"></a><span id="l70.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l70.7"></a><span id="l70.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l70.8"></a><span id="l70.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l70.9"></a><span id="l70.9">  *</span>
<a href="#l70.10"></a><span id="l70.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l70.11"></a><span id="l70.11"> </span>
<a href="#l70.12"></a><span id="l70.12" class="difflineplus">+// Make sure we execute this file exactly once</span>
<a href="#l70.13"></a><span id="l70.13" class="difflineplus">+var gMailTestUtils_js__;</span>
<a href="#l70.14"></a><span id="l70.14" class="difflineplus">+if (!gMailTestUtils_js__) {</span>
<a href="#l70.15"></a><span id="l70.15" class="difflineplus">+gMailTestUtils_js__ = true;</span>
<a href="#l70.16"></a><span id="l70.16" class="difflineplus">+</span>
<a href="#l70.17"></a><span id="l70.17"> // we would like for everyone to have fixIterator and toXPComArray</span>
<a href="#l70.18"></a><span id="l70.18"> Components.utils.import(&quot;resource://gre/modules/iteratorUtils.jsm&quot;);</span>
<a href="#l70.19"></a><span id="l70.19"> </span>
<a href="#l70.20"></a><span id="l70.20"> // Local Mail Folders. Requires prior setup of profile directory</span>
<a href="#l70.21"></a><span id="l70.21"> </span>
<a href="#l70.22"></a><span id="l70.22"> var gLocalIncomingServer;</span>
<a href="#l70.23"></a><span id="l70.23"> var gLocalInboxFolder;</span>
<a href="#l70.24"></a><span id="l70.24"> </span>
<a href="#l70.25"></a><span id="l70.25" class="difflineat">@@ -270,8 +275,10 @@ function updateFolderAndNotify(aFolder, </span>
<a href="#l70.26"></a><span id="l70.26">       }</span>
<a href="#l70.27"></a><span id="l70.27">     }</span>
<a href="#l70.28"></a><span id="l70.28">   };</span>
<a href="#l70.29"></a><span id="l70.29"> </span>
<a href="#l70.30"></a><span id="l70.30">   mailSession.AddFolderListener(folderListener, Ci.nsIFolderListener.event);</span>
<a href="#l70.31"></a><span id="l70.31"> </span>
<a href="#l70.32"></a><span id="l70.32">   aFolder.updateFolder(null);</span>
<a href="#l70.33"></a><span id="l70.33"> }</span>
<a href="#l70.34"></a><span id="l70.34" class="difflineplus">+</span>
<a href="#l70.35"></a><span id="l70.35" class="difflineplus">+} // gMailTestUtils_js__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l71.1"></a><span id="l71.1" class="difflineminus">--- a/suite/common/downloads/downloadmanager.xul</span>
<a href="#l71.2"></a><span id="l71.2" class="difflineplus">+++ b/suite/common/downloads/downloadmanager.xul</span>
<a href="#l71.3"></a><span id="l71.3" class="difflineat">@@ -167,17 +167,18 @@</span>
<a href="#l71.4"></a><span id="l71.4">       &lt;menuitem id=&quot;dlContext-remove&quot;</span>
<a href="#l71.5"></a><span id="l71.5">                 label=&quot;&amp;cmd.remove.label;&quot;</span>
<a href="#l71.6"></a><span id="l71.6">                 accesskey=&quot;&amp;cmd.remove.accesskey;&quot;</span>
<a href="#l71.7"></a><span id="l71.7">                 command=&quot;cmd_remove&quot;/&gt;</span>
<a href="#l71.8"></a><span id="l71.8">       &lt;menuseparator/&gt;</span>
<a href="#l71.9"></a><span id="l71.9">       &lt;menuitem id=&quot;dlContext-open&quot;</span>
<a href="#l71.10"></a><span id="l71.10">                 label=&quot;&amp;cmd.open.label;&quot;</span>
<a href="#l71.11"></a><span id="l71.11">                 accesskey=&quot;&amp;cmd.open.accesskey;&quot;</span>
<a href="#l71.12"></a><span id="l71.12" class="difflineminus">-                command=&quot;cmd_open&quot;/&gt;</span>
<a href="#l71.13"></a><span id="l71.13" class="difflineplus">+                command=&quot;cmd_open&quot;</span>
<a href="#l71.14"></a><span id="l71.14" class="difflineplus">+                default=&quot;true&quot;/&gt;</span>
<a href="#l71.15"></a><span id="l71.15">       &lt;menuitem id=&quot;dlContext-show&quot;</span>
<a href="#l71.16"></a><span id="l71.16">                 label=&quot;&amp;cmd.show.label;&quot;</span>
<a href="#l71.17"></a><span id="l71.17">                 accesskey=&quot;&amp;cmd.show.accesskey;&quot;</span>
<a href="#l71.18"></a><span id="l71.18">                 command=&quot;cmd_show&quot;/&gt;</span>
<a href="#l71.19"></a><span id="l71.19">       &lt;menuitem id=&quot;dlContext-openReferrer&quot;</span>
<a href="#l71.20"></a><span id="l71.20">                 label=&quot;&amp;cmd.goToDownloadPage.label;&quot;</span>
<a href="#l71.21"></a><span id="l71.21">                 accesskey=&quot;&amp;cmd.goToDownloadPage.accesskey;&quot;</span>
<a href="#l71.22"></a><span id="l71.22">                 command=&quot;cmd_openReferrer&quot;/&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l72.1"></a><span id="l72.1" class="difflineminus">--- a/suite/common/pref/pref-download.xul</span>
<a href="#l72.2"></a><span id="l72.2" class="difflineplus">+++ b/suite/common/pref/pref-download.xul</span>
<a href="#l72.3"></a><span id="l72.3" class="difflineat">@@ -33,17 +33,16 @@</span>
<a href="#l72.4"></a><span id="l72.4">  decision by deleting the provisions above and replace them with the notice</span>
<a href="#l72.5"></a><span id="l72.5">  and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l72.6"></a><span id="l72.6">  the provisions above, a recipient may use your version of this file under</span>
<a href="#l72.7"></a><span id="l72.7">  the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l72.8"></a><span id="l72.8"> </span>
<a href="#l72.9"></a><span id="l72.9">  ***** END LICENSE BLOCK ***** --&gt;</span>
<a href="#l72.10"></a><span id="l72.10"> </span>
<a href="#l72.11"></a><span id="l72.11"> &lt;?xml-stylesheet href=&quot;chrome://communicator/skin/&quot; type=&quot;text/css&quot;?&gt;</span>
<a href="#l72.12"></a><span id="l72.12" class="difflineminus">-&lt;?xml-stylesheet href=&quot;chrome://mozapps/content/preferences/preferences.css&quot;?&gt;</span>
<a href="#l72.13"></a><span id="l72.13"> </span>
<a href="#l72.14"></a><span id="l72.14"> &lt;!DOCTYPE overlay SYSTEM &quot;chrome://communicator/locale/pref/pref-download.dtd&quot;&gt;</span>
<a href="#l72.15"></a><span id="l72.15"> </span>
<a href="#l72.16"></a><span id="l72.16"> &lt;overlay xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;&gt;</span>
<a href="#l72.17"></a><span id="l72.17">   &lt;prefpane id=&quot;download_pane&quot;</span>
<a href="#l72.18"></a><span id="l72.18">             label=&quot;&amp;pref.download.title;&quot;</span>
<a href="#l72.19"></a><span id="l72.19">             script=&quot;chrome://communicator/content/pref/pref-download.js&quot;&gt;</span>
<a href="#l72.20"></a><span id="l72.20"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l73.1"></a><span id="l73.1" class="difflineminus">--- a/suite/common/pref/preferences.xul</span>
<a href="#l73.2"></a><span id="l73.2" class="difflineplus">+++ b/suite/common/pref/preferences.xul</span>
<a href="#l73.3"></a><span id="l73.3" class="difflineat">@@ -34,17 +34,16 @@</span>
<a href="#l73.4"></a><span id="l73.4">    - the provisions above, a recipient may use your version of this file under</span>
<a href="#l73.5"></a><span id="l73.5">    - the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l73.6"></a><span id="l73.6">    -</span>
<a href="#l73.7"></a><span id="l73.7">    - ***** END LICENSE BLOCK ***** --&gt;</span>
<a href="#l73.8"></a><span id="l73.8"> </span>
<a href="#l73.9"></a><span id="l73.9"> &lt;?xml-stylesheet type=&quot;text/css&quot; href=&quot;chrome://communicator/skin/&quot;?&gt;</span>
<a href="#l73.10"></a><span id="l73.10"> &lt;?xml-stylesheet type=&quot;text/css&quot; href=&quot;chrome://communicator/content/communicator.css&quot;?&gt;</span>
<a href="#l73.11"></a><span id="l73.11"> &lt;?xml-stylesheet type=&quot;text/css&quot; href=&quot;chrome://communicator/content/pref/prefpanels.css&quot;?&gt;</span>
<a href="#l73.12"></a><span id="l73.12" class="difflineminus">-&lt;?xml-stylesheet type=&quot;text/css&quot; href=&quot;chrome://mozapps/content/preferences/preferences.css&quot;?&gt;</span>
<a href="#l73.13"></a><span id="l73.13"> &lt;?xml-stylesheet type=&quot;text/css&quot; href=&quot;chrome://communicator/skin/prefpanels.css&quot;?&gt;</span>
<a href="#l73.14"></a><span id="l73.14"> &lt;?xml-stylesheet type=&quot;text/css&quot; href=&quot;chrome://communicator/skin/preferences.css&quot;?&gt;</span>
<a href="#l73.15"></a><span id="l73.15"> </span>
<a href="#l73.16"></a><span id="l73.16"> &lt;!DOCTYPE prefwindow [</span>
<a href="#l73.17"></a><span id="l73.17">   &lt;!ENTITY % dtdPrefs    SYSTEM &quot;chrome://communicator/locale/pref/preferences.dtd&quot;&gt; %dtdPrefs;</span>
<a href="#l73.18"></a><span id="l73.18">   &lt;!ENTITY % dtdPlatform SYSTEM &quot;chrome://communicator-platform/locale/pref/platformPrefOverlay.dtd&quot;&gt; %dtdPlatform;</span>
<a href="#l73.19"></a><span id="l73.19"> ]&gt;</span>
<a href="#l73.20"></a><span id="l73.20"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l74.1"></a><span id="l74.1" class="difflineminus">--- a/suite/common/src/nsSessionStore.js</span>
<a href="#l74.2"></a><span id="l74.2" class="difflineplus">+++ b/suite/common/src/nsSessionStore.js</span>
<a href="#l74.3"></a><span id="l74.3" class="difflineat">@@ -313,17 +313,17 @@ SessionStoreService.prototype = {</span>
<a href="#l74.4"></a><span id="l74.4">         this._prefBranch.setBoolPref(&quot;sessionstore.resume_session_once&quot;, true);</span>
<a href="#l74.5"></a><span id="l74.5">       this._loadState = STATE_QUITTING; // just to be sure</span>
<a href="#l74.6"></a><span id="l74.6">       this._uninit();</span>
<a href="#l74.7"></a><span id="l74.7">       break;</span>
<a href="#l74.8"></a><span id="l74.8">     case &quot;browser:purge-session-history&quot;: // catch sanitization</span>
<a href="#l74.9"></a><span id="l74.9">       let openWindows = {};</span>
<a href="#l74.10"></a><span id="l74.10">       this._forEachBrowserWindow(function(aWindow) {</span>
<a href="#l74.11"></a><span id="l74.11">         Array.forEach(aWindow.getBrowser().browsers, function(aBrowser) {</span>
<a href="#l74.12"></a><span id="l74.12" class="difflineminus">-          delete aBrowser.parentNode.__SS_data;</span>
<a href="#l74.13"></a><span id="l74.13" class="difflineplus">+          delete aBrowser.__SS_data;</span>
<a href="#l74.14"></a><span id="l74.14">         });</span>
<a href="#l74.15"></a><span id="l74.15">         openWindows[aWindow.__SSi] = true;</span>
<a href="#l74.16"></a><span id="l74.16">       });</span>
<a href="#l74.17"></a><span id="l74.17">       // also clear all data about closed tabs and windows</span>
<a href="#l74.18"></a><span id="l74.18">       for (let ix in this._windows) {</span>
<a href="#l74.19"></a><span id="l74.19">         if (ix in openWindows)</span>
<a href="#l74.20"></a><span id="l74.20">           this._windows[ix]._closedTabs = [];</span>
<a href="#l74.21"></a><span id="l74.21">         else</span>
<a href="#l74.22"></a><span id="l74.22" class="difflineat">@@ -372,46 +372,45 @@ SessionStoreService.prototype = {</span>
<a href="#l74.23"></a><span id="l74.23">   },</span>
<a href="#l74.24"></a><span id="l74.24"> </span>
<a href="#l74.25"></a><span id="l74.25"> /* ........ Window Event Handlers .............. */</span>
<a href="#l74.26"></a><span id="l74.26"> </span>
<a href="#l74.27"></a><span id="l74.27">   /**</span>
<a href="#l74.28"></a><span id="l74.28">    * Implement nsIDOMEventListener for handling various window and tab events</span>
<a href="#l74.29"></a><span id="l74.29">    */</span>
<a href="#l74.30"></a><span id="l74.30">   handleEvent: function sss_handleEvent(aEvent) {</span>
<a href="#l74.31"></a><span id="l74.31" class="difflineplus">+    var win = aEvent.currentTarget.ownerDocument.defaultView;</span>
<a href="#l74.32"></a><span id="l74.32">     switch (aEvent.type) {</span>
<a href="#l74.33"></a><span id="l74.33">       case &quot;load&quot;:</span>
<a href="#l74.34"></a><span id="l74.34">       case &quot;pageshow&quot;:</span>
<a href="#l74.35"></a><span id="l74.35" class="difflineminus">-        this.onTabLoad(aEvent.currentTarget.ownerDocument.defaultView, aEvent.currentTarget, aEvent);</span>
<a href="#l74.36"></a><span id="l74.36" class="difflineplus">+        this.onTabLoad(win, aEvent.currentTarget, aEvent);</span>
<a href="#l74.37"></a><span id="l74.37">         break;</span>
<a href="#l74.38"></a><span id="l74.38">       case &quot;change&quot;:</span>
<a href="#l74.39"></a><span id="l74.39">       case &quot;input&quot;:</span>
<a href="#l74.40"></a><span id="l74.40">       case &quot;DOMAutoComplete&quot;:</span>
<a href="#l74.41"></a><span id="l74.41" class="difflineminus">-        this.onTabInput(aEvent.currentTarget.ownerDocument.defaultView, aEvent.currentTarget);</span>
<a href="#l74.42"></a><span id="l74.42" class="difflineplus">+        this.onTabInput(win, aEvent.currentTarget);</span>
<a href="#l74.43"></a><span id="l74.43">         break;</span>
<a href="#l74.44"></a><span id="l74.44">       case &quot;scroll&quot;:</span>
<a href="#l74.45"></a><span id="l74.45" class="difflineminus">-        this.onTabScroll(aEvent.currentTarget.ownerDocument.defaultView);</span>
<a href="#l74.46"></a><span id="l74.46" class="difflineplus">+        this.onTabScroll(win);</span>
<a href="#l74.47"></a><span id="l74.47">         break;</span>
<a href="#l74.48"></a><span id="l74.48">       case &quot;TabOpen&quot;:</span>
<a href="#l74.49"></a><span id="l74.49">       case &quot;TabClose&quot;:</span>
<a href="#l74.50"></a><span id="l74.50" class="difflineminus">-        var panelID = aEvent.originalTarget.linkedPanel;</span>
<a href="#l74.51"></a><span id="l74.51" class="difflineminus">-        var tabpanel = aEvent.originalTarget.ownerDocument.getElementById(panelID);</span>
<a href="#l74.52"></a><span id="l74.52" class="difflineplus">+        let browser = aEvent.originalTarget.linkedBrowser;</span>
<a href="#l74.53"></a><span id="l74.53">         if (aEvent.type == &quot;TabOpen&quot;) {</span>
<a href="#l74.54"></a><span id="l74.54" class="difflineminus">-          this.onTabAdd(aEvent.currentTarget.ownerDocument.defaultView, tabpanel);</span>
<a href="#l74.55"></a><span id="l74.55" class="difflineplus">+          this.onTabAdd(win, browser);</span>
<a href="#l74.56"></a><span id="l74.56">         }</span>
<a href="#l74.57"></a><span id="l74.57">         else {</span>
<a href="#l74.58"></a><span id="l74.58">           // aEvent.detail determines if the tab was closed by moving to a different window</span>
<a href="#l74.59"></a><span id="l74.59">           if (!aEvent.detail)</span>
<a href="#l74.60"></a><span id="l74.60" class="difflineminus">-            this.onTabClose(aEvent.currentTarget.ownerDocument.defaultView, aEvent.originalTarget);</span>
<a href="#l74.61"></a><span id="l74.61" class="difflineminus">-          this.onTabRemove(aEvent.currentTarget.ownerDocument.defaultView, tabpanel);</span>
<a href="#l74.62"></a><span id="l74.62" class="difflineplus">+            this.onTabClose(win, aEvent.originalTarget);</span>
<a href="#l74.63"></a><span id="l74.63" class="difflineplus">+          this.onTabRemove(win, browser);</span>
<a href="#l74.64"></a><span id="l74.64">         }</span>
<a href="#l74.65"></a><span id="l74.65">         break;</span>
<a href="#l74.66"></a><span id="l74.66">       case &quot;TabSelect&quot;:</span>
<a href="#l74.67"></a><span id="l74.67" class="difflineminus">-        var tabpanels = aEvent.currentTarget.mPanelContainer;</span>
<a href="#l74.68"></a><span id="l74.68" class="difflineminus">-        this.onTabSelect(aEvent.currentTarget.ownerDocument.defaultView, tabpanels);</span>
<a href="#l74.69"></a><span id="l74.69" class="difflineplus">+        this.onTabSelect(win);</span>
<a href="#l74.70"></a><span id="l74.70">         break;</span>
<a href="#l74.71"></a><span id="l74.71">     }</span>
<a href="#l74.72"></a><span id="l74.72">   },</span>
<a href="#l74.73"></a><span id="l74.73"> </span>
<a href="#l74.74"></a><span id="l74.74">   /**</span>
<a href="#l74.75"></a><span id="l74.75">    * If it's the first window load since app start...</span>
<a href="#l74.76"></a><span id="l74.76">    * - determine if we're reloading after a crash or a forced-restart</span>
<a href="#l74.77"></a><span id="l74.77">    * - restore window state</span>
<a href="#l74.78"></a><span id="l74.78" class="difflineat">@@ -466,21 +465,20 @@ SessionStoreService.prototype = {</span>
<a href="#l74.79"></a><span id="l74.79">     }</span>
<a href="#l74.80"></a><span id="l74.80">     // this window was opened by _openWindowWithState</span>
<a href="#l74.81"></a><span id="l74.81">     else if (!this._isWindowLoaded(aWindow)) {</span>
<a href="#l74.82"></a><span id="l74.82">       let followUp = this._statesToRestore[aWindow.__SS_restoreID].windows.length == 1;</span>
<a href="#l74.83"></a><span id="l74.83">       this.restoreWindow(aWindow, this._statesToRestore[aWindow.__SS_restoreID], true, followUp);</span>
<a href="#l74.84"></a><span id="l74.84">     }</span>
<a href="#l74.85"></a><span id="l74.85"> </span>
<a href="#l74.86"></a><span id="l74.86">     var tabbrowser = aWindow.getBrowser();</span>
<a href="#l74.87"></a><span id="l74.87" class="difflineminus">-    var tabpanels = tabbrowser.mPanelContainer;</span>
<a href="#l74.88"></a><span id="l74.88"> </span>
<a href="#l74.89"></a><span id="l74.89">     // add tab change listeners to all already existing tabs</span>
<a href="#l74.90"></a><span id="l74.90" class="difflineminus">-    for (var i = 0; i &lt; tabpanels.childNodes.length; i++) {</span>
<a href="#l74.91"></a><span id="l74.91" class="difflineminus">-      this.onTabAdd(aWindow, tabpanels.childNodes[i], true);</span>
<a href="#l74.92"></a><span id="l74.92" class="difflineplus">+    for (let i = 0; i &lt; tabbrowser.browsers.length; i++) {</span>
<a href="#l74.93"></a><span id="l74.93" class="difflineplus">+      this.onTabAdd(aWindow, tabbrowser.browsers[i], true);</span>
<a href="#l74.94"></a><span id="l74.94">     }</span>
<a href="#l74.95"></a><span id="l74.95">     // notification of tab add/remove/selection</span>
<a href="#l74.96"></a><span id="l74.96">     tabbrowser.addEventListener(&quot;TabOpen&quot;, this, true);</span>
<a href="#l74.97"></a><span id="l74.97">     tabbrowser.addEventListener(&quot;TabClose&quot;, this, true);</span>
<a href="#l74.98"></a><span id="l74.98">     tabbrowser.addEventListener(&quot;TabSelect&quot;, this, true);</span>
<a href="#l74.99"></a><span id="l74.99">   },</span>
<a href="#l74.100"></a><span id="l74.100"> </span>
<a href="#l74.101"></a><span id="l74.101">   /**</span>
<a href="#l74.102"></a><span id="l74.102" class="difflineat">@@ -506,17 +504,16 @@ SessionStoreService.prototype = {</span>
<a href="#l74.103"></a><span id="l74.103">       return;</span>
<a href="#l74.104"></a><span id="l74.104">     }</span>
<a href="#l74.105"></a><span id="l74.105"> </span>
<a href="#l74.106"></a><span id="l74.106">     if (this.windowToFocus &amp;&amp; this.windowToFocus == aWindow) {</span>
<a href="#l74.107"></a><span id="l74.107">       delete this.windowToFocus;</span>
<a href="#l74.108"></a><span id="l74.108">     }</span>
<a href="#l74.109"></a><span id="l74.109"> </span>
<a href="#l74.110"></a><span id="l74.110">     var tabbrowser = aWindow.getBrowser();</span>
<a href="#l74.111"></a><span id="l74.111" class="difflineminus">-    var tabpanels = tabbrowser.mPanelContainer;</span>
<a href="#l74.112"></a><span id="l74.112"> </span>
<a href="#l74.113"></a><span id="l74.113">     tabbrowser.removeEventListener(&quot;TabOpen&quot;, this, true);</span>
<a href="#l74.114"></a><span id="l74.114">     tabbrowser.removeEventListener(&quot;TabClose&quot;, this, true);</span>
<a href="#l74.115"></a><span id="l74.115">     tabbrowser.removeEventListener(&quot;TabSelect&quot;, this, true);</span>
<a href="#l74.116"></a><span id="l74.116"> </span>
<a href="#l74.117"></a><span id="l74.117">     let winData = this._windows[aWindow.__SSi];</span>
<a href="#l74.118"></a><span id="l74.118">     if (this._loadState == STATE_RUNNING) { // window not closed during a regular shut-down</span>
<a href="#l74.119"></a><span id="l74.119">       // update all window data for a last time</span>
<a href="#l74.120"></a><span id="l74.120" class="difflineat">@@ -538,78 +535,78 @@ SessionStoreService.prototype = {</span>
<a href="#l74.121"></a><span id="l74.121"> </span>
<a href="#l74.122"></a><span id="l74.122">       // clear this window from the list</span>
<a href="#l74.123"></a><span id="l74.123">       delete this._windows[aWindow.__SSi];</span>
<a href="#l74.124"></a><span id="l74.124"> </span>
<a href="#l74.125"></a><span id="l74.125">       // save the state without this window to disk</span>
<a href="#l74.126"></a><span id="l74.126">       this.saveStateDelayed();</span>
<a href="#l74.127"></a><span id="l74.127">     }</span>
<a href="#l74.128"></a><span id="l74.128"> </span>
<a href="#l74.129"></a><span id="l74.129" class="difflineminus">-    for (var i = 0; i &lt; tabpanels.childNodes.length; i++) {</span>
<a href="#l74.130"></a><span id="l74.130" class="difflineminus">-      this.onTabRemove(aWindow, tabpanels.childNodes[i], true);</span>
<a href="#l74.131"></a><span id="l74.131" class="difflineplus">+    for (let i = 0; i &lt; tabbrowser.browsers.length; i++) {</span>
<a href="#l74.132"></a><span id="l74.132" class="difflineplus">+      this.onTabRemove(aWindow, tabbrowser.browsers[i], true);</span>
<a href="#l74.133"></a><span id="l74.133">     }</span>
<a href="#l74.134"></a><span id="l74.134"> </span>
<a href="#l74.135"></a><span id="l74.135">     // cache the window state until the window is completely gone</span>
<a href="#l74.136"></a><span id="l74.136">     aWindow.__SS_dyingCache = winData;</span>
<a href="#l74.137"></a><span id="l74.137"> </span>
<a href="#l74.138"></a><span id="l74.138">     delete aWindow.__SSi;</span>
<a href="#l74.139"></a><span id="l74.139">   },</span>
<a href="#l74.140"></a><span id="l74.140"> </span>
<a href="#l74.141"></a><span id="l74.141">   /**</span>
<a href="#l74.142"></a><span id="l74.142">    * set up listeners for a new tab</span>
<a href="#l74.143"></a><span id="l74.143">    * @param aWindow</span>
<a href="#l74.144"></a><span id="l74.144">    *        Window reference</span>
<a href="#l74.145"></a><span id="l74.145" class="difflineminus">-   * @param aPanel</span>
<a href="#l74.146"></a><span id="l74.146" class="difflineminus">-   *        TabPanel reference</span>
<a href="#l74.147"></a><span id="l74.147" class="difflineplus">+   * @param aBrowser</span>
<a href="#l74.148"></a><span id="l74.148" class="difflineplus">+   *        Browser reference</span>
<a href="#l74.149"></a><span id="l74.149">    * @param aNoNotification</span>
<a href="#l74.150"></a><span id="l74.150">    *        bool Do not save state if we're updating an existing tab</span>
<a href="#l74.151"></a><span id="l74.151">    */</span>
<a href="#l74.152"></a><span id="l74.152" class="difflineminus">-  onTabAdd: function sss_onTabAdd(aWindow, aPanel, aNoNotification) {</span>
<a href="#l74.153"></a><span id="l74.153" class="difflineminus">-    aPanel.addEventListener(&quot;load&quot;, this, true);</span>
<a href="#l74.154"></a><span id="l74.154" class="difflineminus">-    aPanel.addEventListener(&quot;pageshow&quot;, this, true);</span>
<a href="#l74.155"></a><span id="l74.155" class="difflineminus">-    aPanel.addEventListener(&quot;change&quot;, this, true);</span>
<a href="#l74.156"></a><span id="l74.156" class="difflineminus">-    aPanel.addEventListener(&quot;input&quot;, this, true);</span>
<a href="#l74.157"></a><span id="l74.157" class="difflineminus">-    aPanel.addEventListener(&quot;DOMAutoComplete&quot;, this, true);</span>
<a href="#l74.158"></a><span id="l74.158" class="difflineminus">-    aPanel.addEventListener(&quot;scroll&quot;, this, true);</span>
<a href="#l74.159"></a><span id="l74.159" class="difflineplus">+  onTabAdd: function sss_onTabAdd(aWindow, aBrowser, aNoNotification) {</span>
<a href="#l74.160"></a><span id="l74.160" class="difflineplus">+    aBrowser.addEventListener(&quot;load&quot;, this, true);</span>
<a href="#l74.161"></a><span id="l74.161" class="difflineplus">+    aBrowser.addEventListener(&quot;pageshow&quot;, this, true);</span>
<a href="#l74.162"></a><span id="l74.162" class="difflineplus">+    aBrowser.addEventListener(&quot;change&quot;, this, true);</span>
<a href="#l74.163"></a><span id="l74.163" class="difflineplus">+    aBrowser.addEventListener(&quot;input&quot;, this, true);</span>
<a href="#l74.164"></a><span id="l74.164" class="difflineplus">+    aBrowser.addEventListener(&quot;DOMAutoComplete&quot;, this, true);</span>
<a href="#l74.165"></a><span id="l74.165" class="difflineplus">+    aBrowser.addEventListener(&quot;scroll&quot;, this, true);</span>
<a href="#l74.166"></a><span id="l74.166"> </span>
<a href="#l74.167"></a><span id="l74.167">     if (!aNoNotification) {</span>
<a href="#l74.168"></a><span id="l74.168">       this.saveStateDelayed(aWindow);</span>
<a href="#l74.169"></a><span id="l74.169">     }</span>
<a href="#l74.170"></a><span id="l74.170">   },</span>
<a href="#l74.171"></a><span id="l74.171"> </span>
<a href="#l74.172"></a><span id="l74.172">   /**</span>
<a href="#l74.173"></a><span id="l74.173">    * remove listeners for a tab</span>
<a href="#l74.174"></a><span id="l74.174">    * @param aWindow</span>
<a href="#l74.175"></a><span id="l74.175">    *        Window reference</span>
<a href="#l74.176"></a><span id="l74.176" class="difflineminus">-   * @param aPanel</span>
<a href="#l74.177"></a><span id="l74.177" class="difflineminus">-   *        TabPanel reference</span>
<a href="#l74.178"></a><span id="l74.178" class="difflineplus">+   * @param aBrowser</span>
<a href="#l74.179"></a><span id="l74.179" class="difflineplus">+   *        Browser reference</span>
<a href="#l74.180"></a><span id="l74.180">    * @param aNoNotification</span>
<a href="#l74.181"></a><span id="l74.181">    *        bool Do not save state if we're updating an existing tab</span>
<a href="#l74.182"></a><span id="l74.182">    */</span>
<a href="#l74.183"></a><span id="l74.183" class="difflineminus">-  onTabRemove: function sss_onTabRemove(aWindow, aPanel, aNoNotification) {</span>
<a href="#l74.184"></a><span id="l74.184" class="difflineminus">-    aPanel.removeEventListener(&quot;load&quot;, this, true);</span>
<a href="#l74.185"></a><span id="l74.185" class="difflineminus">-    aPanel.removeEventListener(&quot;pageshow&quot;, this, true);</span>
<a href="#l74.186"></a><span id="l74.186" class="difflineminus">-    aPanel.removeEventListener(&quot;change&quot;, this, true);</span>
<a href="#l74.187"></a><span id="l74.187" class="difflineminus">-    aPanel.removeEventListener(&quot;input&quot;, this, true);</span>
<a href="#l74.188"></a><span id="l74.188" class="difflineminus">-    aPanel.removeEventListener(&quot;DOMAutoComplete&quot;, this, true);</span>
<a href="#l74.189"></a><span id="l74.189" class="difflineminus">-    aPanel.removeEventListener(&quot;scroll&quot;, this, true);</span>
<a href="#l74.190"></a><span id="l74.190" class="difflineplus">+  onTabRemove: function sss_onTabRemove(aWindow, aBrowser, aNoNotification) {</span>
<a href="#l74.191"></a><span id="l74.191" class="difflineplus">+    aBrowser.removeEventListener(&quot;load&quot;, this, true);</span>
<a href="#l74.192"></a><span id="l74.192" class="difflineplus">+    aBrowser.removeEventListener(&quot;pageshow&quot;, this, true);</span>
<a href="#l74.193"></a><span id="l74.193" class="difflineplus">+    aBrowser.removeEventListener(&quot;change&quot;, this, true);</span>
<a href="#l74.194"></a><span id="l74.194" class="difflineplus">+    aBrowser.removeEventListener(&quot;input&quot;, this, true);</span>
<a href="#l74.195"></a><span id="l74.195" class="difflineplus">+    aBrowser.removeEventListener(&quot;DOMAutoComplete&quot;, this, true);</span>
<a href="#l74.196"></a><span id="l74.196" class="difflineplus">+    aBrowser.removeEventListener(&quot;scroll&quot;, this, true);</span>
<a href="#l74.197"></a><span id="l74.197"> </span>
<a href="#l74.198"></a><span id="l74.198" class="difflineminus">-    delete aPanel.__SS_data;</span>
<a href="#l74.199"></a><span id="l74.199" class="difflineplus">+    delete aBrowser.__SS_data;</span>
<a href="#l74.200"></a><span id="l74.200"> </span>
<a href="#l74.201"></a><span id="l74.201">     if (!aNoNotification) {</span>
<a href="#l74.202"></a><span id="l74.202">       this.saveStateDelayed(aWindow);</span>
<a href="#l74.203"></a><span id="l74.203">     }</span>
<a href="#l74.204"></a><span id="l74.204">   },</span>
<a href="#l74.205"></a><span id="l74.205"> </span>
<a href="#l74.206"></a><span id="l74.206">   /**</span>
<a href="#l74.207"></a><span id="l74.207">    * When a tab closes, collect its properties</span>
<a href="#l74.208"></a><span id="l74.208">    * @param aWindow</span>
<a href="#l74.209"></a><span id="l74.209">    *        Window reference</span>
<a href="#l74.210"></a><span id="l74.210">    * @param aTab</span>
<a href="#l74.211"></a><span id="l74.211" class="difflineminus">-   *        TabPanel reference</span>
<a href="#l74.212"></a><span id="l74.212" class="difflineplus">+   *        Tab reference</span>
<a href="#l74.213"></a><span id="l74.213">    */</span>
<a href="#l74.214"></a><span id="l74.214">   onTabClose: function sss_onTabClose(aWindow, aTab) {</span>
<a href="#l74.215"></a><span id="l74.215">     // notify the tabbrowser that the tab state will be retrieved for the last time</span>
<a href="#l74.216"></a><span id="l74.216">     // (so that extension authors can easily set data on soon-to-be-closed tabs)</span>
<a href="#l74.217"></a><span id="l74.217">     var event = aWindow.document.createEvent(&quot;Events&quot;);</span>
<a href="#l74.218"></a><span id="l74.218">     event.initEvent(&quot;SSTabClosing&quot;, true, false);</span>
<a href="#l74.219"></a><span id="l74.219">     aTab.dispatchEvent(event);</span>
<a href="#l74.220"></a><span id="l74.220"> </span>
<a href="#l74.221"></a><span id="l74.221" class="difflineat">@@ -638,68 +635,66 @@ SessionStoreService.prototype = {</span>
<a href="#l74.222"></a><span id="l74.222">       aTab.tabData = tabsData;</span>
<a href="#l74.223"></a><span id="l74.223">     };</span>
<a href="#l74.224"></a><span id="l74.224">   },</span>
<a href="#l74.225"></a><span id="l74.225"> </span>
<a href="#l74.226"></a><span id="l74.226">   /**</span>
<a href="#l74.227"></a><span id="l74.227">    * When a tab loads, save state.</span>
<a href="#l74.228"></a><span id="l74.228">    * @param aWindow</span>
<a href="#l74.229"></a><span id="l74.229">    *        Window reference</span>
<a href="#l74.230"></a><span id="l74.230" class="difflineminus">-   * @param aPanel</span>
<a href="#l74.231"></a><span id="l74.231" class="difflineminus">-   *        TabPanel reference</span>
<a href="#l74.232"></a><span id="l74.232" class="difflineplus">+   * @param aBrowser</span>
<a href="#l74.233"></a><span id="l74.233" class="difflineplus">+   *        Browser reference</span>
<a href="#l74.234"></a><span id="l74.234">    * @param aEvent</span>
<a href="#l74.235"></a><span id="l74.235">    *        Event obj</span>
<a href="#l74.236"></a><span id="l74.236">    */</span>
<a href="#l74.237"></a><span id="l74.237" class="difflineminus">-  onTabLoad: function sss_onTabLoad(aWindow, aPanel, aEvent) {</span>
<a href="#l74.238"></a><span id="l74.238" class="difflineplus">+  onTabLoad: function sss_onTabLoad(aWindow, aBrowser, aEvent) {</span>
<a href="#l74.239"></a><span id="l74.239">     // react on &quot;load&quot; and solitary &quot;pageshow&quot; events (the first &quot;pageshow&quot;</span>
<a href="#l74.240"></a><span id="l74.240">     // following &quot;load&quot; is too late for deleting the data caches)</span>
<a href="#l74.241"></a><span id="l74.241">     if (aEvent.type != &quot;load&quot; &amp;&amp; !aEvent.persisted) {</span>
<a href="#l74.242"></a><span id="l74.242">       return;</span>
<a href="#l74.243"></a><span id="l74.243">     }</span>
<a href="#l74.244"></a><span id="l74.244"> </span>
<a href="#l74.245"></a><span id="l74.245" class="difflineminus">-    delete aPanel.__SS_data;</span>
<a href="#l74.246"></a><span id="l74.246" class="difflineplus">+    delete aBrowser.__SS_data;</span>
<a href="#l74.247"></a><span id="l74.247">     this.saveStateDelayed(aWindow);</span>
<a href="#l74.248"></a><span id="l74.248"> </span>
<a href="#l74.249"></a><span id="l74.249">     // attempt to update the current URL we send in a crash report</span>
<a href="#l74.250"></a><span id="l74.250">     this._updateCrashReportURL(aWindow);</span>
<a href="#l74.251"></a><span id="l74.251">   },</span>
<a href="#l74.252"></a><span id="l74.252"> </span>
<a href="#l74.253"></a><span id="l74.253">   /**</span>
<a href="#l74.254"></a><span id="l74.254" class="difflineminus">-   * Called when a tabpanel sends the &quot;input&quot; notification</span>
<a href="#l74.255"></a><span id="l74.255" class="difflineplus">+   * Called when a browser sends the &quot;input&quot; notification</span>
<a href="#l74.256"></a><span id="l74.256">    * @param aWindow</span>
<a href="#l74.257"></a><span id="l74.257">    *        Window reference</span>
<a href="#l74.258"></a><span id="l74.258" class="difflineminus">-   * @param aPanel</span>
<a href="#l74.259"></a><span id="l74.259" class="difflineminus">-   *        TabPanel reference</span>
<a href="#l74.260"></a><span id="l74.260" class="difflineplus">+   * @param aBrowser</span>
<a href="#l74.261"></a><span id="l74.261" class="difflineplus">+   *        Browser reference</span>
<a href="#l74.262"></a><span id="l74.262">    */</span>
<a href="#l74.263"></a><span id="l74.263" class="difflineminus">-  onTabInput: function sss_onTabInput(aWindow, aPanel) {</span>
<a href="#l74.264"></a><span id="l74.264" class="difflineminus">-    if (aPanel.__SS_data)</span>
<a href="#l74.265"></a><span id="l74.265" class="difflineminus">-      delete aPanel.__SS_data._formDataSaved;</span>
<a href="#l74.266"></a><span id="l74.266" class="difflineplus">+  onTabInput: function sss_onTabInput(aWindow, aBrowser) {</span>
<a href="#l74.267"></a><span id="l74.267" class="difflineplus">+    if (aBrowser.__SS_data)</span>
<a href="#l74.268"></a><span id="l74.268" class="difflineplus">+      delete aBrowser.__SS_data._formDataSaved;</span>
<a href="#l74.269"></a><span id="l74.269"> </span>
<a href="#l74.270"></a><span id="l74.270">     this.saveStateDelayed(aWindow, 3000);</span>
<a href="#l74.271"></a><span id="l74.271">   },</span>
<a href="#l74.272"></a><span id="l74.272"> </span>
<a href="#l74.273"></a><span id="l74.273">   /**</span>
<a href="#l74.274"></a><span id="l74.274" class="difflineminus">-   * Called when a tabpanel sends a &quot;scroll&quot; notification</span>
<a href="#l74.275"></a><span id="l74.275" class="difflineplus">+   * Called when a browser sends a &quot;scroll&quot; notification</span>
<a href="#l74.276"></a><span id="l74.276">    * @param aWindow</span>
<a href="#l74.277"></a><span id="l74.277">    *        Window reference</span>
<a href="#l74.278"></a><span id="l74.278">    */</span>
<a href="#l74.279"></a><span id="l74.279">   onTabScroll: function sss_onTabScroll(aWindow) {</span>
<a href="#l74.280"></a><span id="l74.280">     this.saveStateDelayed(aWindow, 3000);</span>
<a href="#l74.281"></a><span id="l74.281">   },</span>
<a href="#l74.282"></a><span id="l74.282"> </span>
<a href="#l74.283"></a><span id="l74.283">   /**</span>
<a href="#l74.284"></a><span id="l74.284">    * When a tab is selected, save session data</span>
<a href="#l74.285"></a><span id="l74.285">    * @param aWindow</span>
<a href="#l74.286"></a><span id="l74.286">    *        Window reference</span>
<a href="#l74.287"></a><span id="l74.287" class="difflineminus">-   * @param aPanels</span>
<a href="#l74.288"></a><span id="l74.288" class="difflineminus">-   *        TabPanel reference</span>
<a href="#l74.289"></a><span id="l74.289">    */</span>
<a href="#l74.290"></a><span id="l74.290" class="difflineminus">-  onTabSelect: function sss_onTabSelect(aWindow, aPanels) {</span>
<a href="#l74.291"></a><span id="l74.291" class="difflineplus">+  onTabSelect: function sss_onTabSelect(aWindow) {</span>
<a href="#l74.292"></a><span id="l74.292">     if (this._loadState == STATE_RUNNING) {</span>
<a href="#l74.293"></a><span id="l74.293" class="difflineminus">-      this._windows[aWindow.__SSi].selected = aPanels.selectedIndex;</span>
<a href="#l74.294"></a><span id="l74.294" class="difflineplus">+      this._windows[aWindow.__SSi].selected = aWindow.getBrowser().tabContainer.selectedIndex;</span>
<a href="#l74.295"></a><span id="l74.295">       this.saveStateDelayed(aWindow);</span>
<a href="#l74.296"></a><span id="l74.296"> </span>
<a href="#l74.297"></a><span id="l74.297">       // attempt to update the current URL we send in a crash report</span>
<a href="#l74.298"></a><span id="l74.298">       this._updateCrashReportURL(aWindow);</span>
<a href="#l74.299"></a><span id="l74.299">     }</span>
<a href="#l74.300"></a><span id="l74.300">   },</span>
<a href="#l74.301"></a><span id="l74.301"> </span>
<a href="#l74.302"></a><span id="l74.302"> /* ........ nsISessionStore API .............. */</span>
<a href="#l74.303"></a><span id="l74.303" class="difflineat">@@ -938,43 +933,43 @@ SessionStoreService.prototype = {</span>
<a href="#l74.304"></a><span id="l74.304">    */</span>
<a href="#l74.305"></a><span id="l74.305">   _collectTabData: function sss_collectTabData(aTab, aFullData) {</span>
<a href="#l74.306"></a><span id="l74.306">     var tabData = { entries: [] };</span>
<a href="#l74.307"></a><span id="l74.307">     var browser = aTab.linkedBrowser;</span>
<a href="#l74.308"></a><span id="l74.308"> </span>
<a href="#l74.309"></a><span id="l74.309">     if (!browser || !browser.currentURI)</span>
<a href="#l74.310"></a><span id="l74.310">       // can happen when calling this function right after .addTab()</span>
<a href="#l74.311"></a><span id="l74.311">       return tabData;</span>
<a href="#l74.312"></a><span id="l74.312" class="difflineminus">-    else if (browser.parentNode.__SS_data &amp;&amp; browser.parentNode.__SS_data._tabStillLoading)</span>
<a href="#l74.313"></a><span id="l74.313" class="difflineplus">+    else if (browser.__SS_data &amp;&amp; browser.__SS_data._tabStillLoading)</span>
<a href="#l74.314"></a><span id="l74.314">       // use the data to be restored when the tab hasn't been completely loaded</span>
<a href="#l74.315"></a><span id="l74.315" class="difflineminus">-      return browser.parentNode.__SS_data;</span>
<a href="#l74.316"></a><span id="l74.316" class="difflineplus">+      return browser.__SS_data;</span>
<a href="#l74.317"></a><span id="l74.317"> </span>
<a href="#l74.318"></a><span id="l74.318">     var history = null;</span>
<a href="#l74.319"></a><span id="l74.319">     try {</span>
<a href="#l74.320"></a><span id="l74.320">       history = browser.sessionHistory;</span>
<a href="#l74.321"></a><span id="l74.321">     }</span>
<a href="#l74.322"></a><span id="l74.322">     catch (ex) { } // this could happen if we catch a tab during (de)initialization</span>
<a href="#l74.323"></a><span id="l74.323"> </span>
<a href="#l74.324"></a><span id="l74.324">     // XXXzeniko anchor navigation doesn't reset __SS_data, so we could reuse</span>
<a href="#l74.325"></a><span id="l74.325">     //           data even when we shouldn't (e.g. Back, different anchor)</span>
<a href="#l74.326"></a><span id="l74.326" class="difflineminus">-    if (history &amp;&amp; browser.parentNode.__SS_data &amp;&amp;</span>
<a href="#l74.327"></a><span id="l74.327" class="difflineminus">-        browser.parentNode.__SS_data.entries[history.index] &amp;&amp;</span>
<a href="#l74.328"></a><span id="l74.328" class="difflineplus">+    if (history &amp;&amp; browser.__SS_data &amp;&amp;</span>
<a href="#l74.329"></a><span id="l74.329" class="difflineplus">+        browser.__SS_data.entries[history.index] &amp;&amp;</span>
<a href="#l74.330"></a><span id="l74.330">         history.index &lt; this._sessionhistory_max_entries - 1 &amp;&amp; !aFullData) {</span>
<a href="#l74.331"></a><span id="l74.331" class="difflineminus">-      tabData = browser.parentNode.__SS_data;</span>
<a href="#l74.332"></a><span id="l74.332" class="difflineplus">+      tabData = browser.__SS_data;</span>
<a href="#l74.333"></a><span id="l74.333">       tabData.index = history.index + 1;</span>
<a href="#l74.334"></a><span id="l74.334">     }</span>
<a href="#l74.335"></a><span id="l74.335">     else if (history &amp;&amp; history.count &gt; 0) {</span>
<a href="#l74.336"></a><span id="l74.336">       for (var j = 0; j &lt; history.count; j++)</span>
<a href="#l74.337"></a><span id="l74.337">         tabData.entries.push(this._serializeHistoryEntry(history.getEntryAtIndex(j, false),</span>
<a href="#l74.338"></a><span id="l74.338">                                                          aFullData));</span>
<a href="#l74.339"></a><span id="l74.339">       tabData.index = history.index + 1;</span>
<a href="#l74.340"></a><span id="l74.340"> </span>
<a href="#l74.341"></a><span id="l74.341">       // make sure not to cache privacy sensitive data which shouldn't get out</span>
<a href="#l74.342"></a><span id="l74.342">       if (!aFullData)</span>
<a href="#l74.343"></a><span id="l74.343" class="difflineminus">-        browser.parentNode.__SS_data = tabData;</span>
<a href="#l74.344"></a><span id="l74.344" class="difflineplus">+        browser.__SS_data = tabData;</span>
<a href="#l74.345"></a><span id="l74.345">     }</span>
<a href="#l74.346"></a><span id="l74.346">     else if (browser.currentURI.spec != &quot;about:blank&quot; ||</span>
<a href="#l74.347"></a><span id="l74.347">              browser.contentDocument.body.hasChildNodes()) {</span>
<a href="#l74.348"></a><span id="l74.348">       tabData.entries[0] = { url: browser.currentURI.spec };</span>
<a href="#l74.349"></a><span id="l74.349">       tabData.index = 1;</span>
<a href="#l74.350"></a><span id="l74.350">     }</span>
<a href="#l74.351"></a><span id="l74.351"> </span>
<a href="#l74.352"></a><span id="l74.352">     var disallow = [];</span>
<a href="#l74.353"></a><span id="l74.353" class="difflineat">@@ -1179,18 +1174,18 @@ SessionStoreService.prototype = {</span>
<a href="#l74.354"></a><span id="l74.354">    * @param aWindow</span>
<a href="#l74.355"></a><span id="l74.355">    *        Window reference</span>
<a href="#l74.356"></a><span id="l74.356">    */</span>
<a href="#l74.357"></a><span id="l74.357">   _updateTextAndScrollData: function sss_updateTextAndScrollData(aWindow) {</span>
<a href="#l74.358"></a><span id="l74.358">     var browsers = aWindow.getBrowser().browsers;</span>
<a href="#l74.359"></a><span id="l74.359">     for (var i = 0; i &lt; browsers.length; i++) {</span>
<a href="#l74.360"></a><span id="l74.360">       try {</span>
<a href="#l74.361"></a><span id="l74.361">         var tabData = this._windows[aWindow.__SSi].tabs[i];</span>
<a href="#l74.362"></a><span id="l74.362" class="difflineminus">-        if (browsers[i].parentNode.__SS_data &amp;&amp;</span>
<a href="#l74.363"></a><span id="l74.363" class="difflineminus">-            browsers[i].parentNode.__SS_data._tabStillLoading)</span>
<a href="#l74.364"></a><span id="l74.364" class="difflineplus">+        if (browsers[i].__SS_data &amp;&amp;</span>
<a href="#l74.365"></a><span id="l74.365" class="difflineplus">+            browsers[i].__SS_data._tabStillLoading)</span>
<a href="#l74.366"></a><span id="l74.366">           continue; // ignore incompletely initialized tabs</span>
<a href="#l74.367"></a><span id="l74.367">         this._updateTextAndScrollDataForTab(aWindow, browsers[i], tabData);</span>
<a href="#l74.368"></a><span id="l74.368">       }</span>
<a href="#l74.369"></a><span id="l74.369">       catch (ex) { debug(ex); } // get as much data as possible, ignore failures (might succeed the next time)</span>
<a href="#l74.370"></a><span id="l74.370">     }</span>
<a href="#l74.371"></a><span id="l74.371">   },</span>
<a href="#l74.372"></a><span id="l74.372"> </span>
<a href="#l74.373"></a><span id="l74.373">   /**</span>
<a href="#l74.374"></a><span id="l74.374" class="difflineat">@@ -1728,17 +1723,17 @@ SessionStoreService.prototype = {</span>
<a href="#l74.375"></a><span id="l74.375">       // wall-paper fix for bug 439675: make sure that the URL to be loaded</span>
<a href="#l74.376"></a><span id="l74.376">       // is always visible in the address bar</span>
<a href="#l74.377"></a><span id="l74.377">       let activeIndex = (aTabData[t].index || aTabData[t].entries.length) - 1;</span>
<a href="#l74.378"></a><span id="l74.378">       let activePageData = aTabData[t].entries[activeIndex] || null;</span>
<a href="#l74.379"></a><span id="l74.379">       browser.userTypedValue = activePageData ? activePageData.url || null : null;</span>
<a href="#l74.380"></a><span id="l74.380"> </span>
<a href="#l74.381"></a><span id="l74.381">       // keep the data around to prevent dataloss in case</span>
<a href="#l74.382"></a><span id="l74.382">       // a tab gets closed before it's been properly restored</span>
<a href="#l74.383"></a><span id="l74.383" class="difflineminus">-      browser.parentNode.__SS_data = aTabData[t];</span>
<a href="#l74.384"></a><span id="l74.384" class="difflineplus">+      browser.__SS_data = aTabData[t];</span>
<a href="#l74.385"></a><span id="l74.385">     }</span>
<a href="#l74.386"></a><span id="l74.386"> </span>
<a href="#l74.387"></a><span id="l74.387">     // make sure to restore the selected tab first (if any)</span>
<a href="#l74.388"></a><span id="l74.388">     if (aSelectTab-- &amp;&amp; aTabs[aSelectTab]) {</span>
<a href="#l74.389"></a><span id="l74.389">         aTabs.unshift(aTabs.splice(aSelectTab, 1)[0]);</span>
<a href="#l74.390"></a><span id="l74.390">         aTabData.unshift(aTabData.splice(aSelectTab, 1)[0]);</span>
<a href="#l74.391"></a><span id="l74.391">         tabbrowser.selectedTab = aTabs[0];</span>
<a href="#l74.392"></a><span id="l74.392">     }</span>
<a href="#l74.393"></a><span id="l74.393" class="difflineat">@@ -2135,17 +2130,17 @@ SessionStoreService.prototype = {</span>
<a href="#l74.394"></a><span id="l74.394">       }</span>
<a href="#l74.395"></a><span id="l74.395">     }</span>
<a href="#l74.396"></a><span id="l74.396">     var sidebar = aWindow.document.getElementById(&quot;sidebar-box&quot;);</span>
<a href="#l74.397"></a><span id="l74.397">     if (sidebar.getAttribute(&quot;sidebarcommand&quot;) != aSidebar) {</span>
<a href="#l74.398"></a><span id="l74.398">       aWindow.toggleSidebar(aSidebar);</span>
<a href="#l74.399"></a><span id="l74.399">     }</span>
<a href="#l74.400"></a><span id="l74.400">     // since resizing/moving a window brings it to the foreground,</span>
<a href="#l74.401"></a><span id="l74.401">     // we might want to re-focus the last focused window</span>
<a href="#l74.402"></a><span id="l74.402" class="difflineminus">-    if (this.windowToFocus) {</span>
<a href="#l74.403"></a><span id="l74.403" class="difflineplus">+    if (this.windowToFocus &amp;&amp; this.windowToFocus.content) {</span>
<a href="#l74.404"></a><span id="l74.404">       this.windowToFocus.content.focus();</span>
<a href="#l74.405"></a><span id="l74.405">     }</span>
<a href="#l74.406"></a><span id="l74.406">   },</span>
<a href="#l74.407"></a><span id="l74.407"> </span>
<a href="#l74.408"></a><span id="l74.408">   /**</span>
<a href="#l74.409"></a><span id="l74.409">    * Restores cookies (accepting both Firefox 2.0 and current format)</span>
<a href="#l74.410"></a><span id="l74.410">    * @param aCookies</span>
<a href="#l74.411"></a><span id="l74.411">    *        Array of cookie objects</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l75.1"></a><span id="l75.1" class="difflineminus">--- a/suite/mailnews/search/FilterListDialog.js</span>
<a href="#l75.2"></a><span id="l75.2" class="difflineplus">+++ b/suite/mailnews/search/FilterListDialog.js</span>
<a href="#l75.3"></a><span id="l75.3" class="difflineat">@@ -178,32 +178,34 @@ function onLoad()</span>
<a href="#l75.4"></a><span id="l75.4">     gReorderUpButton = document.getElementById(&quot;reorderUpButton&quot;);</span>
<a href="#l75.5"></a><span id="l75.5">     gReorderDownButton = document.getElementById(&quot;reorderDownButton&quot;);</span>
<a href="#l75.6"></a><span id="l75.6">     gRunFiltersFolderPickerLabel = document.getElementById(&quot;folderPickerPrefix&quot;);</span>
<a href="#l75.7"></a><span id="l75.7">     gRunFiltersFolderPicker = document.getElementById(&quot;runFiltersFolder&quot;);</span>
<a href="#l75.8"></a><span id="l75.8">     gRunFiltersButton = document.getElementById(&quot;runFiltersButton&quot;);</span>
<a href="#l75.9"></a><span id="l75.9">     gStatusBar = document.getElementById(&quot;statusbar-icon&quot;);</span>
<a href="#l75.10"></a><span id="l75.10">     gStatusText = document.getElementById(&quot;statusText&quot;);</span>
<a href="#l75.11"></a><span id="l75.11"> </span>
<a href="#l75.12"></a><span id="l75.12" class="difflineminus">-    updateButtons();</span>
<a href="#l75.13"></a><span id="l75.13" class="difflineplus">+    gFilterTree.view = gFilterTreeView;</span>
<a href="#l75.14"></a><span id="l75.14"> </span>
<a href="#l75.15"></a><span id="l75.15">     // get the selected server if it can have filters.</span>
<a href="#l75.16"></a><span id="l75.16">     var firstItem = getSelectedServerForFilters();</span>
<a href="#l75.17"></a><span id="l75.17"> </span>
<a href="#l75.18"></a><span id="l75.18">     // if the selected server cannot have filters, get the default server</span>
<a href="#l75.19"></a><span id="l75.19">     // if the default server cannot have filters, check all accounts</span>
<a href="#l75.20"></a><span id="l75.20">     // and get a server that can have filters.</span>
<a href="#l75.21"></a><span id="l75.21">     if (!firstItem)</span>
<a href="#l75.22"></a><span id="l75.22" class="difflineminus">-        firstItem = getServerThatCanHaveFilters();</span>
<a href="#l75.23"></a><span id="l75.23" class="difflineplus">+      firstItem = getServerThatCanHaveFilters();</span>
<a href="#l75.24"></a><span id="l75.24"> </span>
<a href="#l75.25"></a><span id="l75.25" class="difflineminus">-    if (firstItem) {</span>
<a href="#l75.26"></a><span id="l75.26" class="difflineminus">-        selectServer(firstItem);</span>
<a href="#l75.27"></a><span id="l75.27" class="difflineminus">-    }</span>
<a href="#l75.28"></a><span id="l75.28" class="difflineplus">+    if (firstItem)</span>
<a href="#l75.29"></a><span id="l75.29" class="difflineplus">+      selectServer(firstItem);</span>
<a href="#l75.30"></a><span id="l75.30" class="difflineplus">+    else</span>
<a href="#l75.31"></a><span id="l75.31" class="difflineplus">+      updateButtons();</span>
<a href="#l75.32"></a><span id="l75.32"> </span>
<a href="#l75.33"></a><span id="l75.33" class="difflineminus">-    gFilterTree.view = gFilterTreeView;</span>
<a href="#l75.34"></a><span id="l75.34" class="difflineplus">+    // Focus the list.</span>
<a href="#l75.35"></a><span id="l75.35" class="difflineplus">+    gFilterTree.focus();</span>
<a href="#l75.36"></a><span id="l75.36"> </span>
<a href="#l75.37"></a><span id="l75.37">     window.tryToClose = onFilterClose;</span>
<a href="#l75.38"></a><span id="l75.38"> }</span>
<a href="#l75.39"></a><span id="l75.39"> </span>
<a href="#l75.40"></a><span id="l75.40"> /*</span>
<a href="#l75.41"></a><span id="l75.41"> function onCancel()</span>
<a href="#l75.42"></a><span id="l75.42"> {</span>
<a href="#l75.43"></a><span id="l75.43">     var firstItem = getSelectedServerForFilters();</span>
<a href="#l75.44"></a><span id="l75.44" class="difflineat">@@ -268,16 +270,20 @@ function setServer(uri)</span>
<a href="#l75.45"></a><span id="l75.45">      return;</span>
<a href="#l75.46"></a><span id="l75.46"> </span>
<a href="#l75.47"></a><span id="l75.47">    var resource = gRDF.GetResource(uri);</span>
<a href="#l75.48"></a><span id="l75.48">    var msgFolder = resource.QueryInterface(Components.interfaces.nsIMsgFolder);</span>
<a href="#l75.49"></a><span id="l75.49"> </span>
<a href="#l75.50"></a><span id="l75.50">    //Calling getFilterList will detect any errors in rules.dat, backup the file, and alert the user</span>
<a href="#l75.51"></a><span id="l75.51">    gFilterTreeView.filterList = msgFolder.getEditableFilterList(gFilterListMsgWindow);</span>
<a href="#l75.52"></a><span id="l75.52"> </span>
<a href="#l75.53"></a><span id="l75.53" class="difflineplus">+   // Select the first item in the list, if there is one.</span>
<a href="#l75.54"></a><span id="l75.54" class="difflineplus">+   if (gFilterTreeView.rowCount)</span>
<a href="#l75.55"></a><span id="l75.55" class="difflineplus">+     gFilterTreeView.selection.select(0);</span>
<a href="#l75.56"></a><span id="l75.56" class="difflineplus">+</span>
<a href="#l75.57"></a><span id="l75.57">    // this will get the deferred to account root folder, if server is deferred</span>
<a href="#l75.58"></a><span id="l75.58">    msgFolder = msgFolder.server.rootMsgFolder;</span>
<a href="#l75.59"></a><span id="l75.59">    var rootFolderUri = msgFolder.URI;</span>
<a href="#l75.60"></a><span id="l75.60"> </span>
<a href="#l75.61"></a><span id="l75.61">    // root the folder picker to this server</span>
<a href="#l75.62"></a><span id="l75.62">    gRunFiltersFolderPicker.setAttribute(&quot;ref&quot;, rootFolderUri);</span>
<a href="#l75.63"></a><span id="l75.63">  </span>
<a href="#l75.64"></a><span id="l75.64">    // run filters after the fact not supported by news</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l76.1"></a><span id="l76.1" class="difflineminus">--- a/suite/mailnews/tabmail.xml</span>
<a href="#l76.2"></a><span id="l76.2" class="difflineplus">+++ b/suite/mailnews/tabmail.xml</span>
<a href="#l76.3"></a><span id="l76.3" class="difflineat">@@ -607,18 +607,19 @@</span>
<a href="#l76.4"></a><span id="l76.4">             let closeFunc = tabInfo.mode.closeTab ||</span>
<a href="#l76.5"></a><span id="l76.5">                             tabInfo.mode.tabType.closeTab;</span>
<a href="#l76.6"></a><span id="l76.6">             if (closeFunc)</span>
<a href="#l76.7"></a><span id="l76.7">               closeFunc.call(tabInfo.mode.tabType, tabInfo);</span>
<a href="#l76.8"></a><span id="l76.8"> </span>
<a href="#l76.9"></a><span id="l76.9">             this.tabInfo.splice(iTab, 1);</span>
<a href="#l76.10"></a><span id="l76.10">             tabInfo.mode.tabs.splice(tabInfo.mode.tabs.indexOf(tabInfo), 1);</span>
<a href="#l76.11"></a><span id="l76.11">             this.tabContainer.removeChild(aTabNode);</span>
<a href="#l76.12"></a><span id="l76.12" class="difflineplus">+            --numTabs;</span>
<a href="#l76.13"></a><span id="l76.13">             if (this.tabContainer.selectedIndex == -1)</span>
<a href="#l76.14"></a><span id="l76.14" class="difflineminus">-              this.tabContainer.selectedIndex = (iTab == --numTabs) ? iTab - 1 : iTab;</span>
<a href="#l76.15"></a><span id="l76.15" class="difflineplus">+              this.tabContainer.selectedIndex = (iTab == numTabs) ? iTab - 1 : iTab;</span>
<a href="#l76.16"></a><span id="l76.16">             if (this.currentTabInfo == tabInfo)</span>
<a href="#l76.17"></a><span id="l76.17">               this.updateCurrentTab();</span>
<a href="#l76.18"></a><span id="l76.18"> </span>
<a href="#l76.19"></a><span id="l76.19">             if (tabInfo.panel)</span>
<a href="#l76.20"></a><span id="l76.20">             {</span>
<a href="#l76.21"></a><span id="l76.21">               this.panelContainer.removeChild(tabInfo.panel);</span>
<a href="#l76.22"></a><span id="l76.22">               delete tabInfo.panel;</span>
<a href="#l76.23"></a><span id="l76.23">             }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l77.1"></a><span id="l77.1" class="difflineminus">--- a/suite/smile/test/browser_Browser.js</span>
<a href="#l77.2"></a><span id="l77.2" class="difflineplus">+++ b/suite/smile/test/browser_Browser.js</span>
<a href="#l77.3"></a><span id="l77.3" class="difflineat">@@ -1,79 +1,88 @@</span>
<a href="#l77.4"></a><span id="l77.4" class="difflineminus">-const Ci = Components.interfaces;</span>
<a href="#l77.5"></a><span id="l77.5" class="difflineminus">-const Cc = Components.classes;</span>
<a href="#l77.6"></a><span id="l77.6" class="difflineminus">-</span>
<a href="#l77.7"></a><span id="l77.7" class="difflineminus">-function url(spec) {</span>
<a href="#l77.8"></a><span id="l77.8" class="difflineminus">-  var ios = Cc[&quot;@mozilla.org/network/io-service;1&quot;].getService(Ci.nsIIOService);</span>
<a href="#l77.9"></a><span id="l77.9" class="difflineminus">-  return ios.newURI(spec, null, null);</span>
<a href="#l77.10"></a><span id="l77.10" class="difflineminus">-}</span>
<a href="#l77.11"></a><span id="l77.11" class="difflineminus">-</span>
<a href="#l77.12"></a><span id="l77.12"> var gPageA = null;</span>
<a href="#l77.13"></a><span id="l77.13"> var gPageB = null;</span>
<a href="#l77.14"></a><span id="l77.14"> </span>
<a href="#l77.15"></a><span id="l77.15"> // cached data from events</span>
<a href="#l77.16"></a><span id="l77.16"> var gTabOpenPageA = null;</span>
<a href="#l77.17"></a><span id="l77.17"> var gTabOpenPageB = null;</span>
<a href="#l77.18"></a><span id="l77.18"> var gTabOpenCount = 0;</span>
<a href="#l77.19"></a><span id="l77.19"> var gTabCloseCount = 0;</span>
<a href="#l77.20"></a><span id="l77.20"> var gTabMoveCount = 0;</span>
<a href="#l77.21"></a><span id="l77.21"> var gPageLoadCount = 0;</span>
<a href="#l77.22"></a><span id="l77.22"> </span>
<a href="#l77.23"></a><span id="l77.23"> function test() {</span>
<a href="#l77.24"></a><span id="l77.24" class="difflineplus">+  waitForExplicitFinish();</span>
<a href="#l77.25"></a><span id="l77.25" class="difflineplus">+</span>
<a href="#l77.26"></a><span id="l77.26" class="difflineplus">+  // nsIFocusManager is not available on MOZILLA_1_9_1</span>
<a href="#l77.27"></a><span id="l77.27" class="difflineplus">+  if (&quot;nsIFocusManager&quot; in Ci) {</span>
<a href="#l77.28"></a><span id="l77.28" class="difflineplus">+    if (Cc[&quot;@mozilla.org/focus-manager;1&quot;].getService(Ci.nsIFocusManager)</span>
<a href="#l77.29"></a><span id="l77.29" class="difflineplus">+                                          .activeWindow != window) {</span>
<a href="#l77.30"></a><span id="l77.30" class="difflineplus">+      setTimeout(test, 0);</span>
<a href="#l77.31"></a><span id="l77.31" class="difflineplus">+      window.focus();</span>
<a href="#l77.32"></a><span id="l77.32" class="difflineplus">+      return;</span>
<a href="#l77.33"></a><span id="l77.33" class="difflineplus">+    }</span>
<a href="#l77.34"></a><span id="l77.34" class="difflineplus">+  } else if (!document.hasFocus()) {</span>
<a href="#l77.35"></a><span id="l77.35" class="difflineplus">+    setTimeout(test, 0);</span>
<a href="#l77.36"></a><span id="l77.36" class="difflineplus">+    window.focus();</span>
<a href="#l77.37"></a><span id="l77.37" class="difflineplus">+    return;</span>
<a href="#l77.38"></a><span id="l77.38" class="difflineplus">+  }</span>
<a href="#l77.39"></a><span id="l77.39" class="difflineplus">+</span>
<a href="#l77.40"></a><span id="l77.40">   var windows = Application.windows;</span>
<a href="#l77.41"></a><span id="l77.41">   ok(windows, &quot;Check access to browser windows&quot;);</span>
<a href="#l77.42"></a><span id="l77.42" class="difflineminus">-  ok(windows.length, &quot;There should be at least one browser window open&quot;);</span>
<a href="#l77.43"></a><span id="l77.43" class="difflineplus">+  is(windows.length, 1, &quot;There should be one browser window open&quot;);</span>
<a href="#l77.44"></a><span id="l77.44"> </span>
<a href="#l77.45"></a><span id="l77.45">   var activeWin = Application.activeWindow;</span>
<a href="#l77.46"></a><span id="l77.46">   activeWin.events.addListener(&quot;TabOpen&quot;, onTabOpen);</span>
<a href="#l77.47"></a><span id="l77.47">   activeWin.events.addListener(&quot;TabClose&quot;, onTabClose);</span>
<a href="#l77.48"></a><span id="l77.48">   activeWin.events.addListener(&quot;TabMove&quot;, onTabMove);</span>
<a href="#l77.49"></a><span id="l77.49"> </span>
<a href="#l77.50"></a><span id="l77.50" class="difflineminus">-  gPageA = activeWin.open(url(&quot;chrome://mochikit/content/browser/suite/smile/test/ContentA.html&quot;));</span>
<a href="#l77.51"></a><span id="l77.51" class="difflineplus">+  gPageA = activeWin.open(makeURI(&quot;chrome://mochikit/content/browser/suite/smile/test/ContentA.html&quot;));</span>
<a href="#l77.52"></a><span id="l77.52">   gPageA.events.addListener(&quot;load&quot;, onPageAFirstLoad);</span>
<a href="#l77.53"></a><span id="l77.53"> </span>
<a href="#l77.54"></a><span id="l77.54">   is(activeWin.tabs.length, 2, &quot;Checking length of 'Browser.tabs' after opening 1 additional tab&quot;);</span>
<a href="#l77.55"></a><span id="l77.55"> </span>
<a href="#l77.56"></a><span id="l77.56" class="difflineminus">-  waitForExplicitFinish();</span>
<a href="#l77.57"></a><span id="l77.57" class="difflineminus">-</span>
<a href="#l77.58"></a><span id="l77.58" class="difflineminus">-  function execAfterOpen() {</span>
<a href="#l77.59"></a><span id="l77.59" class="difflineminus">-    executeSoon(afterOpen);</span>
<a href="#l77.60"></a><span id="l77.60" class="difflineminus">-  }</span>
<a href="#l77.61"></a><span id="l77.61" class="difflineminus">-</span>
<a href="#l77.62"></a><span id="l77.62">   function onPageAFirstLoad(event) {</span>
<a href="#l77.63"></a><span id="l77.63">     gPageA.events.removeListener(&quot;load&quot;, onPageAFirstLoad);</span>
<a href="#l77.64"></a><span id="l77.64">     is(gPageA.uri.spec, event.data.uri.spec, &quot;Checking event browser tab is equal to page A&quot;);</span>
<a href="#l77.65"></a><span id="l77.65"> </span>
<a href="#l77.66"></a><span id="l77.66" class="difflineminus">-    gPageB = activeWin.open(url(&quot;chrome://mochikit/content/browser/suite/smile/test/ContentB.html&quot;));</span>
<a href="#l77.67"></a><span id="l77.67" class="difflineminus">-    gPageB.events.addListener(&quot;load&quot;, execAfterOpen);</span>
<a href="#l77.68"></a><span id="l77.68" class="difflineplus">+    gPageB = activeWin.open(makeURI(&quot;chrome://mochikit/content/browser/suite/smile/test/ContentB.html&quot;));</span>
<a href="#l77.69"></a><span id="l77.69" class="difflineplus">+    gPageB.events.addListener(&quot;load&quot;, delayAfterOpen);</span>
<a href="#l77.70"></a><span id="l77.70">     gPageB.focus();</span>
<a href="#l77.71"></a><span id="l77.71"> </span>
<a href="#l77.72"></a><span id="l77.72">     is(activeWin.tabs.length, 3, &quot;Checking length of 'Browser.tabs' after opening a second additional tab&quot;);</span>
<a href="#l77.73"></a><span id="l77.73">     is(activeWin.activeTab.index, gPageB.index, &quot;Checking 'Browser.activeTab' after setting focus&quot;);</span>
<a href="#l77.74"></a><span id="l77.74">   }</span>
<a href="#l77.75"></a><span id="l77.75"> </span>
<a href="#l77.76"></a><span id="l77.76" class="difflineplus">+  function delayAfterOpen() {</span>
<a href="#l77.77"></a><span id="l77.77" class="difflineplus">+    executeSoon(afterOpen);</span>
<a href="#l77.78"></a><span id="l77.78" class="difflineplus">+  }</span>
<a href="#l77.79"></a><span id="l77.79" class="difflineplus">+</span>
<a href="#l77.80"></a><span id="l77.80">   // need to wait for the url's to be refreshed during the load</span>
<a href="#l77.81"></a><span id="l77.81">   function afterOpen(event) {</span>
<a href="#l77.82"></a><span id="l77.82" class="difflineminus">-    gPageB.events.removeListener(&quot;load&quot;, execAfterOpen);</span>
<a href="#l77.83"></a><span id="l77.83" class="difflineplus">+    gPageB.events.removeListener(&quot;load&quot;, delayAfterOpen);</span>
<a href="#l77.84"></a><span id="l77.84">     // check actuals</span>
<a href="#l77.85"></a><span id="l77.85">     is(gPageA.uri.spec, &quot;chrome://mochikit/content/browser/suite/smile/test/ContentA.html&quot;, &quot;Checking 'BrowserTab.uri' after opening&quot;);</span>
<a href="#l77.86"></a><span id="l77.86">     is(gPageB.uri.spec, &quot;chrome://mochikit/content/browser/suite/smile/test/ContentB.html&quot;, &quot;Checking 'BrowserTab.uri' after opening&quot;);</span>
<a href="#l77.87"></a><span id="l77.87"> </span>
<a href="#l77.88"></a><span id="l77.88">     // check cached values from TabOpen event</span>
<a href="#l77.89"></a><span id="l77.89">     is(gPageA.uri.spec, gTabOpenPageA.uri.spec, &quot;Checking first browser tab open is equal to page A&quot;);</span>
<a href="#l77.90"></a><span id="l77.90">     is(gPageB.uri.spec, gTabOpenPageB.uri.spec, &quot;Checking second browser tab open is equal to page B&quot;);</span>
<a href="#l77.91"></a><span id="l77.91">     // check event</span>
<a href="#l77.92"></a><span id="l77.92">     is(gTabOpenCount, 2, &quot;Checking event handler for tab open&quot;);</span>
<a href="#l77.93"></a><span id="l77.93"> </span>
<a href="#l77.94"></a><span id="l77.94">     // test document access</span>
<a href="#l77.95"></a><span id="l77.95">     var test1 = gPageA.document.getElementById(&quot;test1&quot;);</span>
<a href="#l77.96"></a><span id="l77.96">     ok(test1, &quot;Checking existence of element in content DOM&quot;);</span>
<a href="#l77.97"></a><span id="l77.97">     is(test1.innerHTML, &quot;A&quot;, &quot;Checking content of element in content DOM&quot;);</span>
<a href="#l77.98"></a><span id="l77.98"> </span>
<a href="#l77.99"></a><span id="l77.99">     // test moving tab</span>
<a href="#l77.100"></a><span id="l77.100" class="difflineplus">+    is(gTabMoveCount, 0, &quot;Checking initial tab move count&quot;);</span>
<a href="#l77.101"></a><span id="l77.101" class="difflineplus">+</span>
<a href="#l77.102"></a><span id="l77.102" class="difflineplus">+    // move the tab</span>
<a href="#l77.103"></a><span id="l77.103">     gPageA.moveToEnd();</span>
<a href="#l77.104"></a><span id="l77.104">     is(gPageA.index, 2, &quot;Checking index after moving tab&quot;);</span>
<a href="#l77.105"></a><span id="l77.105"> </span>
<a href="#l77.106"></a><span id="l77.106">     // check event</span>
<a href="#l77.107"></a><span id="l77.107">     is(gTabMoveCount, 1, &quot;Checking event handler for tab move&quot;);</span>
<a href="#l77.108"></a><span id="l77.108"> </span>
<a href="#l77.109"></a><span id="l77.109">     let browser = gBrowser.getBrowserAtIndex(gPageB.index);</span>
<a href="#l77.110"></a><span id="l77.110">     browser.addProgressListener({</span>
<a href="#l77.111"></a><span id="l77.111" class="difflineat">@@ -97,34 +106,34 @@ function test() {</span>
<a href="#l77.112"></a><span id="l77.112">            iid.equals(Ci.nsISupports))</span>
<a href="#l77.113"></a><span id="l77.113">            return this;</span>
<a href="#l77.114"></a><span id="l77.114"> </span>
<a href="#l77.115"></a><span id="l77.115">         throw Components.results.NS_ERROR_NO_INTERFACE;</span>
<a href="#l77.116"></a><span id="l77.116">       }</span>
<a href="#l77.117"></a><span id="l77.117">     });</span>
<a href="#l77.118"></a><span id="l77.118"> </span>
<a href="#l77.119"></a><span id="l77.119">     // test loading new content with a frame into a tab</span>
<a href="#l77.120"></a><span id="l77.120" class="difflineminus">-    // the event will be checked in afterClose</span>
<a href="#l77.121"></a><span id="l77.121" class="difflineplus">+    // the event will be checked in onPageBLoadComplete</span>
<a href="#l77.122"></a><span id="l77.122">     gPageB.events.addListener(&quot;load&quot;, onPageBLoadWithFrames);</span>
<a href="#l77.123"></a><span id="l77.123" class="difflineminus">-    gPageB.load(url(&quot;chrome://mochikit/content/browser/suite/smile/test/ContentWithFrames.html&quot;));</span>
<a href="#l77.124"></a><span id="l77.124" class="difflineplus">+    gPageB.load(makeURI(&quot;chrome://mochikit/content/browser/suite/smile/test/ContentWithFrames.html&quot;));</span>
<a href="#l77.125"></a><span id="l77.125">   }</span>
<a href="#l77.126"></a><span id="l77.126"> </span>
<a href="#l77.127"></a><span id="l77.127">   function onPageBLoadWithFrames(event) {</span>
<a href="#l77.128"></a><span id="l77.128">     gPageLoadCount++;</span>
<a href="#l77.129"></a><span id="l77.129">   }</span>
<a href="#l77.130"></a><span id="l77.130"> </span>
<a href="#l77.131"></a><span id="l77.131">   function onPageBLoadComplete() {</span>
<a href="#l77.132"></a><span id="l77.132">     gPageB.events.removeListener(&quot;load&quot;, onPageBLoadWithFrames);</span>
<a href="#l77.133"></a><span id="l77.133">     // check page load with frame event</span>
<a href="#l77.134"></a><span id="l77.134">     is(gPageLoadCount, 1, &quot;Checking load count after loading new content with a frame&quot;);</span>
<a href="#l77.135"></a><span id="l77.135"> </span>
<a href="#l77.136"></a><span id="l77.136">     // test loading new content into a tab</span>
<a href="#l77.137"></a><span id="l77.137" class="difflineminus">-    // the event will be checked in onPageLoad</span>
<a href="#l77.138"></a><span id="l77.138" class="difflineplus">+    // the event will be checked in onPageASecondLoad</span>
<a href="#l77.139"></a><span id="l77.139">     gPageA.events.addListener(&quot;load&quot;, onPageASecondLoad);</span>
<a href="#l77.140"></a><span id="l77.140" class="difflineminus">-    gPageA.load(url(&quot;chrome://mochikit/content/browser/suite/smile/test/ContentB.html&quot;));</span>
<a href="#l77.141"></a><span id="l77.141" class="difflineplus">+    gPageA.load(makeURI(&quot;chrome://mochikit/content/browser/suite/smile/test/ContentB.html&quot;));</span>
<a href="#l77.142"></a><span id="l77.142">   }</span>
<a href="#l77.143"></a><span id="l77.143"> </span>
<a href="#l77.144"></a><span id="l77.144">   function onPageASecondLoad(event) {</span>
<a href="#l77.145"></a><span id="l77.145">     gPageA.events.removeListener(&quot;load&quot;, onPageASecondLoad);</span>
<a href="#l77.146"></a><span id="l77.146">     is(gPageA.uri.spec, &quot;chrome://mochikit/content/browser/suite/smile/test/ContentB.html&quot;, &quot;Checking 'BrowserTab.uri' after loading new content&quot;);</span>
<a href="#l77.147"></a><span id="l77.147"> </span>
<a href="#l77.148"></a><span id="l77.148">     // start testing closing tabs</span>
<a href="#l77.149"></a><span id="l77.149">     // the event will be checked in afterClose</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l78.1"></a><span id="l78.1" class="difflineminus">--- a/suite/themes/classic/communicator/preferences.css</span>
<a href="#l78.2"></a><span id="l78.2" class="difflineplus">+++ b/suite/themes/classic/communicator/preferences.css</span>
<a href="#l78.3"></a><span id="l78.3" class="difflineat">@@ -42,38 +42,8 @@</span>
<a href="#l78.4"></a><span id="l78.4"> /* ::::: Main Window ::::: */</span>
<a href="#l78.5"></a><span id="l78.5"> </span>
<a href="#l78.6"></a><span id="l78.6"> prefwindow {</span>
<a href="#l78.7"></a><span id="l78.7">   padding-top: 8px;</span>
<a href="#l78.8"></a><span id="l78.8">   padding-bottom: 0px;</span>
<a href="#l78.9"></a><span id="l78.9">   -moz-padding-start: 8px;</span>
<a href="#l78.10"></a><span id="l78.10">   -moz-padding-end: 10px;</span>
<a href="#l78.11"></a><span id="l78.11"> }</span>
<a href="#l78.12"></a><span id="l78.12" class="difflineminus">-</span>
<a href="#l78.13"></a><span id="l78.13" class="difflineminus">-/* File Field Widget */</span>
<a href="#l78.14"></a><span id="l78.14" class="difflineminus">-filefield {</span>
<a href="#l78.15"></a><span id="l78.15" class="difflineminus">-  margin: 2px 4px;</span>
<a href="#l78.16"></a><span id="l78.16" class="difflineminus">-  -moz-appearance: textfield;</span>
<a href="#l78.17"></a><span id="l78.17" class="difflineminus">-}</span>
<a href="#l78.18"></a><span id="l78.18" class="difflineminus">-</span>
<a href="#l78.19"></a><span id="l78.19" class="difflineminus">-.fileFieldContentBox {</span>
<a href="#l78.20"></a><span id="l78.20" class="difflineminus">-  background-color: -moz-Dialog;</span>
<a href="#l78.21"></a><span id="l78.21" class="difflineminus">-}</span>
<a href="#l78.22"></a><span id="l78.22" class="difflineminus">-</span>
<a href="#l78.23"></a><span id="l78.23" class="difflineminus">-.fileFieldIcon[disabled=&quot;true&quot;] {</span>
<a href="#l78.24"></a><span id="l78.24" class="difflineminus">-  opacity: 0.4;</span>
<a href="#l78.25"></a><span id="l78.25" class="difflineminus">-}</span>
<a href="#l78.26"></a><span id="l78.26" class="difflineminus">-</span>
<a href="#l78.27"></a><span id="l78.27" class="difflineminus">-.fileFieldIcon {</span>
<a href="#l78.28"></a><span id="l78.28" class="difflineminus">-  width: 16px;</span>
<a href="#l78.29"></a><span id="l78.29" class="difflineminus">-  height: 16px;</span>
<a href="#l78.30"></a><span id="l78.30" class="difflineminus">-  margin-top: 1px;</span>
<a href="#l78.31"></a><span id="l78.31" class="difflineminus">-  margin-bottom: 1px;</span>
<a href="#l78.32"></a><span id="l78.32" class="difflineminus">-  -moz-margin-start: 1px;</span>
<a href="#l78.33"></a><span id="l78.33" class="difflineminus">-  -moz-margin-end: 4px;</span>
<a href="#l78.34"></a><span id="l78.34" class="difflineminus">-}</span>
<a href="#l78.35"></a><span id="l78.35" class="difflineminus">-</span>
<a href="#l78.36"></a><span id="l78.36" class="difflineminus">-.fileFieldLabel {</span>
<a href="#l78.37"></a><span id="l78.37" class="difflineminus">-  -moz-appearance: none;</span>
<a href="#l78.38"></a><span id="l78.38" class="difflineminus">-  background-color: transparent;</span>
<a href="#l78.39"></a><span id="l78.39" class="difflineminus">-  border: none;</span>
<a href="#l78.40"></a><span id="l78.40" class="difflineminus">-  margin: 0px;</span>
<a href="#l78.41"></a><span id="l78.41" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l79.1"></a><span id="l79.1" class="difflineminus">--- a/suite/themes/classic/mac/communicator/button.css</span>
<a href="#l79.2"></a><span id="l79.2" class="difflineplus">+++ b/suite/themes/classic/mac/communicator/button.css</span>
<a href="#l79.3"></a><span id="l79.3" class="difflineat">@@ -44,16 +44,21 @@</span>
<a href="#l79.4"></a><span id="l79.4"> </span>
<a href="#l79.5"></a><span id="l79.5"> /* ::::: large toolbar buttons ::::: */</span>
<a href="#l79.6"></a><span id="l79.6"> </span>
<a href="#l79.7"></a><span id="l79.7"> .toolbarbutton-1,</span>
<a href="#l79.8"></a><span id="l79.8"> .toolbarbutton-1 &gt; .toolbarbutton-menubutton-button {</span>
<a href="#l79.9"></a><span id="l79.9">   -moz-box-orient: vertical;</span>
<a href="#l79.10"></a><span id="l79.10"> }</span>
<a href="#l79.11"></a><span id="l79.11"> </span>
<a href="#l79.12"></a><span id="l79.12" class="difflineplus">+.toolbarbutton-1[open],</span>
<a href="#l79.13"></a><span id="l79.13" class="difflineplus">+.toolbarbutton-1[open] &gt; .toolbarbutton-menubutton-button {</span>
<a href="#l79.14"></a><span id="l79.14" class="difflineplus">+  text-shadow: none;</span>
<a href="#l79.15"></a><span id="l79.15" class="difflineplus">+}</span>
<a href="#l79.16"></a><span id="l79.16" class="difflineplus">+</span>
<a href="#l79.17"></a><span id="l79.17"> .toolbarbutton-1[type=&quot;menu-button&quot;] {</span>
<a href="#l79.18"></a><span id="l79.18">   -moz-box-orient: horizontal;</span>
<a href="#l79.19"></a><span id="l79.19">   padding: 0;</span>
<a href="#l79.20"></a><span id="l79.20"> }</span>
<a href="#l79.21"></a><span id="l79.21"> </span>
<a href="#l79.22"></a><span id="l79.22"> .toolbarbutton-1[type=&quot;menu&quot;] {</span>
<a href="#l79.23"></a><span id="l79.23">   -moz-binding: url(&quot;chrome://global/content/bindings/toolbarbutton.xml#menu-vertical&quot;);</span>
<a href="#l79.24"></a><span id="l79.24"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l80.1"></a><span id="l80.1" class="difflineminus">--- a/suite/themes/classic/mac/communicator/helpOverlay.css</span>
<a href="#l80.2"></a><span id="l80.2" class="difflineplus">+++ b/suite/themes/classic/mac/communicator/helpOverlay.css</span>
<a href="#l80.3"></a><span id="l80.3" class="difflineat">@@ -65,30 +65,32 @@</span>
<a href="#l80.4"></a><span id="l80.4">   -moz-image-region: inherit;</span>
<a href="#l80.5"></a><span id="l80.5"> }</span>
<a href="#l80.6"></a><span id="l80.6"> </span>
<a href="#l80.7"></a><span id="l80.7"> #help-back-button,</span>
<a href="#l80.8"></a><span id="l80.8"> #help-back-button:not([disabled=&quot;true&quot;]):hover {</span>
<a href="#l80.9"></a><span id="l80.9">   -moz-image-region: rect(60px 29px 89px 0);</span>
<a href="#l80.10"></a><span id="l80.10"> }</span>
<a href="#l80.11"></a><span id="l80.11"> </span>
<a href="#l80.12"></a><span id="l80.12" class="difflineminus">-#help-back-button:not([disabled=&quot;true&quot;]):hover:active {</span>
<a href="#l80.13"></a><span id="l80.13" class="difflineplus">+#help-back-button:not([disabled=&quot;true&quot;]):hover:active,</span>
<a href="#l80.14"></a><span id="l80.14" class="difflineplus">+#help-back-button[open]:not([disabled=&quot;true&quot;]) {</span>
<a href="#l80.15"></a><span id="l80.15">   -moz-image-region: rect(60px 59px 89px 30px);</span>
<a href="#l80.16"></a><span id="l80.16"> }</span>
<a href="#l80.17"></a><span id="l80.17"> </span>
<a href="#l80.18"></a><span id="l80.18"> #help-back-button[disabled=&quot;true&quot;] {</span>
<a href="#l80.19"></a><span id="l80.19">   -moz-image-region: rect(60px 89px 89px 60px);</span>
<a href="#l80.20"></a><span id="l80.20"> }</span>
<a href="#l80.21"></a><span id="l80.21"> </span>
<a href="#l80.22"></a><span id="l80.22"> #help-forward-button,</span>
<a href="#l80.23"></a><span id="l80.23"> #help-forward-button:not([disabled=&quot;true&quot;]):hover {</span>
<a href="#l80.24"></a><span id="l80.24">   -moz-image-region: rect(90px 29px 119px 0);</span>
<a href="#l80.25"></a><span id="l80.25"> }</span>
<a href="#l80.26"></a><span id="l80.26"> </span>
<a href="#l80.27"></a><span id="l80.27" class="difflineminus">-#help-forward-button:not([disabled=&quot;true&quot;]):hover:active {</span>
<a href="#l80.28"></a><span id="l80.28" class="difflineplus">+#help-forward-button:not([disabled=&quot;true&quot;]):hover:active,</span>
<a href="#l80.29"></a><span id="l80.29" class="difflineplus">+#help-forward-button[open]:not([disabled=&quot;true&quot;]) {</span>
<a href="#l80.30"></a><span id="l80.30">   -moz-image-region: rect(90px 59px 119px 30px);</span>
<a href="#l80.31"></a><span id="l80.31"> }</span>
<a href="#l80.32"></a><span id="l80.32"> </span>
<a href="#l80.33"></a><span id="l80.33"> #help-forward-button[disabled=&quot;true&quot;] {</span>
<a href="#l80.34"></a><span id="l80.34">   -moz-image-region: rect(90px 89px 119px 60px);</span>
<a href="#l80.35"></a><span id="l80.35"> }</span>
<a href="#l80.36"></a><span id="l80.36"> </span>
<a href="#l80.37"></a><span id="l80.37"> #help-home-button,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l81.1"></a><span id="l81.1" class="difflineminus">--- a/suite/themes/classic/mac/editor/editorPrimaryToolbar.css</span>
<a href="#l81.2"></a><span id="l81.2" class="difflineplus">+++ b/suite/themes/classic/mac/editor/editorPrimaryToolbar.css</span>
<a href="#l81.3"></a><span id="l81.3" class="difflineat">@@ -106,17 +106,18 @@</span>
<a href="#l81.4"></a><span id="l81.4">   -moz-image-region: rect(180px 89px 209px 60px) !important;</span>
<a href="#l81.5"></a><span id="l81.5"> }</span>
<a href="#l81.6"></a><span id="l81.6"> </span>
<a href="#l81.7"></a><span id="l81.7"> #printButton {</span>
<a href="#l81.8"></a><span id="l81.8">   list-style-image: url(&quot;chrome://communicator/skin/icons/communicatoricons.png&quot;);</span>
<a href="#l81.9"></a><span id="l81.9">   -moz-image-region: rect(0 29px 29px 0);</span>
<a href="#l81.10"></a><span id="l81.10"> }</span>
<a href="#l81.11"></a><span id="l81.11"> </span>
<a href="#l81.12"></a><span id="l81.12" class="difflineminus">-#printButton:hover:active {</span>
<a href="#l81.13"></a><span id="l81.13" class="difflineplus">+#printButton:hover:active,</span>
<a href="#l81.14"></a><span id="l81.14" class="difflineplus">+#printButton[open] {</span>
<a href="#l81.15"></a><span id="l81.15">   -moz-image-region: rect(0 59px 29px 30px);</span>
<a href="#l81.16"></a><span id="l81.16"> }</span>
<a href="#l81.17"></a><span id="l81.17"> </span>
<a href="#l81.18"></a><span id="l81.18"> #printButton[disabled=&quot;true&quot;] {</span>
<a href="#l81.19"></a><span id="l81.19">   -moz-image-region: rect(0 89px 29px 60px);</span>
<a href="#l81.20"></a><span id="l81.20"> }</span>
<a href="#l81.21"></a><span id="l81.21"> </span>
<a href="#l81.22"></a><span id="l81.22"> #linkButton {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l82.1"></a><span id="l82.1" class="difflineminus">--- a/suite/themes/classic/mac/messenger/messengercompose/messengercompose.css</span>
<a href="#l82.2"></a><span id="l82.2" class="difflineplus">+++ b/suite/themes/classic/mac/messenger/messengercompose/messengercompose.css</span>
<a href="#l82.3"></a><span id="l82.3" class="difflineat">@@ -52,67 +52,70 @@</span>
<a href="#l82.4"></a><span id="l82.4"> }</span>
<a href="#l82.5"></a><span id="l82.5"> </span>
<a href="#l82.6"></a><span id="l82.6"> #button-send {</span>
<a href="#l82.7"></a><span id="l82.7">   -moz-image-region: rect(330px 29px 359px 0);</span>
<a href="#l82.8"></a><span id="l82.8"> }</span>
<a href="#l82.9"></a><span id="l82.9"> </span>
<a href="#l82.10"></a><span id="l82.10"> #button-send:hover:active {</span>
<a href="#l82.11"></a><span id="l82.11">   -moz-image-region: rect(330px 59px 359px 30px);</span>
<a href="#l82.12"></a><span id="l82.12" class="difflineminus">-} </span>
<a href="#l82.13"></a><span id="l82.13" class="difflineplus">+}</span>
<a href="#l82.14"></a><span id="l82.14"> </span>
<a href="#l82.15"></a><span id="l82.15"> #button-send[disabled=&quot;true&quot;] {</span>
<a href="#l82.16"></a><span id="l82.16">   -moz-image-region: rect(330px 89px 359px 60px) !important;</span>
<a href="#l82.17"></a><span id="l82.17" class="difflineminus">-} </span>
<a href="#l82.18"></a><span id="l82.18" class="difflineplus">+}</span>
<a href="#l82.19"></a><span id="l82.19"> </span>
<a href="#l82.20"></a><span id="l82.20"> #button-address {</span>
<a href="#l82.21"></a><span id="l82.21">   -moz-image-region: rect(270px 29px 299px 0);</span>
<a href="#l82.22"></a><span id="l82.22"> }</span>
<a href="#l82.23"></a><span id="l82.23"> </span>
<a href="#l82.24"></a><span id="l82.24"> #button-address:hover:active {</span>
<a href="#l82.25"></a><span id="l82.25">   -moz-image-region: rect(270px 59px 299px 30px);</span>
<a href="#l82.26"></a><span id="l82.26" class="difflineminus">-} </span>
<a href="#l82.27"></a><span id="l82.27" class="difflineplus">+}</span>
<a href="#l82.28"></a><span id="l82.28"> </span>
<a href="#l82.29"></a><span id="l82.29"> #button-address[disabled=&quot;true&quot;] {</span>
<a href="#l82.30"></a><span id="l82.30">   -moz-image-region: rect(270px 89px 299px 60px) !important;</span>
<a href="#l82.31"></a><span id="l82.31" class="difflineminus">-} </span>
<a href="#l82.32"></a><span id="l82.32" class="difflineplus">+}</span>
<a href="#l82.33"></a><span id="l82.33"> </span>
<a href="#l82.34"></a><span id="l82.34"> #button-attach {</span>
<a href="#l82.35"></a><span id="l82.35">   -moz-image-region: rect(300px 29px 329px 0);</span>
<a href="#l82.36"></a><span id="l82.36"> }</span>
<a href="#l82.37"></a><span id="l82.37"> </span>
<a href="#l82.38"></a><span id="l82.38" class="difflineminus">-#button-attach:hover:active {</span>
<a href="#l82.39"></a><span id="l82.39" class="difflineplus">+#button-attach:hover:active,</span>
<a href="#l82.40"></a><span id="l82.40" class="difflineplus">+#button-attach[open] {</span>
<a href="#l82.41"></a><span id="l82.41">   -moz-image-region: rect(300px 59px 329px 30px);</span>
<a href="#l82.42"></a><span id="l82.42" class="difflineminus">-} </span>
<a href="#l82.43"></a><span id="l82.43" class="difflineplus">+}</span>
<a href="#l82.44"></a><span id="l82.44"> </span>
<a href="#l82.45"></a><span id="l82.45"> #button-attach[disabled=&quot;true&quot;] {</span>
<a href="#l82.46"></a><span id="l82.46">   -moz-image-region: rect(300px 89px 329px 60px) !important;</span>
<a href="#l82.47"></a><span id="l82.47" class="difflineminus">-} </span>
<a href="#l82.48"></a><span id="l82.48" class="difflineplus">+}</span>
<a href="#l82.49"></a><span id="l82.49"> </span>
<a href="#l82.50"></a><span id="l82.50"> #spellingButton {</span>
<a href="#l82.51"></a><span id="l82.51">   list-style-image: url(&quot;chrome://editor/skin/icons/editoricons.png&quot;);</span>
<a href="#l82.52"></a><span id="l82.52">   -moz-image-region: rect(240px 29px 269px 0);</span>
<a href="#l82.53"></a><span id="l82.53"> }</span>
<a href="#l82.54"></a><span id="l82.54"> </span>
<a href="#l82.55"></a><span id="l82.55" class="difflineminus">-#spellingButton:hover:active {</span>
<a href="#l82.56"></a><span id="l82.56" class="difflineplus">+#spellingButton:hover:active,</span>
<a href="#l82.57"></a><span id="l82.57" class="difflineplus">+#spellingButton[open] {</span>
<a href="#l82.58"></a><span id="l82.58">   -moz-image-region: rect(240px 59px 269px 30px);</span>
<a href="#l82.59"></a><span id="l82.59"> }</span>
<a href="#l82.60"></a><span id="l82.60"> </span>
<a href="#l82.61"></a><span id="l82.61"> #spellingButton[disabled=&quot;true&quot;] {</span>
<a href="#l82.62"></a><span id="l82.62">   -moz-image-region: rect(240px 89px 269px 60px) !important;</span>
<a href="#l82.63"></a><span id="l82.63"> }</span>
<a href="#l82.64"></a><span id="l82.64"> </span>
<a href="#l82.65"></a><span id="l82.65"> #button-save {</span>
<a href="#l82.66"></a><span id="l82.66">   list-style-image: url(&quot;chrome://editor/skin/icons/editoricons.png&quot;);</span>
<a href="#l82.67"></a><span id="l82.67">   -moz-image-region: rect(210px 29px 239px 0);</span>
<a href="#l82.68"></a><span id="l82.68"> }</span>
<a href="#l82.69"></a><span id="l82.69"> </span>
<a href="#l82.70"></a><span id="l82.70" class="difflineminus">-#button-save:hover:active {</span>
<a href="#l82.71"></a><span id="l82.71" class="difflineplus">+#button-save:hover:active,</span>
<a href="#l82.72"></a><span id="l82.72" class="difflineplus">+#button-save[open] {</span>
<a href="#l82.73"></a><span id="l82.73">   -moz-image-region: rect(210px 59px 239px 30px);</span>
<a href="#l82.74"></a><span id="l82.74" class="difflineminus">-} </span>
<a href="#l82.75"></a><span id="l82.75" class="difflineplus">+}</span>
<a href="#l82.76"></a><span id="l82.76"> </span>
<a href="#l82.77"></a><span id="l82.77"> #button-save[disabled=&quot;true&quot;] {</span>
<a href="#l82.78"></a><span id="l82.78">   -moz-image-region: rect(210px 89px 239px 60px) !important;</span>
<a href="#l82.79"></a><span id="l82.79"> }</span>
<a href="#l82.80"></a><span id="l82.80"> </span>
<a href="#l82.81"></a><span id="l82.81"> #attachmentbucket-sizer {</span>
<a href="#l82.82"></a><span id="l82.82">   border-top: none;</span>
<a href="#l82.83"></a><span id="l82.83">   border-bottom: none;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l83.1"></a><span id="l83.1" class="difflineminus">--- a/suite/themes/classic/mac/messenger/primaryToolbar.css</span>
<a href="#l83.2"></a><span id="l83.2" class="difflineplus">+++ b/suite/themes/classic/mac/messenger/primaryToolbar.css</span>
<a href="#l83.3"></a><span id="l83.3" class="difflineat">@@ -44,128 +44,134 @@</span>
<a href="#l83.4"></a><span id="l83.4"> </span>
<a href="#l83.5"></a><span id="l83.5"> /* ::::: primary toolbar buttons ::::: */</span>
<a href="#l83.6"></a><span id="l83.6"> </span>
<a href="#l83.7"></a><span id="l83.7"> #button-getmsg {</span>
<a href="#l83.8"></a><span id="l83.8">   list-style-image: url(&quot;chrome://messenger/skin/icons/messengericons.png&quot;);</span>
<a href="#l83.9"></a><span id="l83.9">   -moz-image-region: rect(90px 29px 119px 0);</span>
<a href="#l83.10"></a><span id="l83.10"> }</span>
<a href="#l83.11"></a><span id="l83.11"> </span>
<a href="#l83.12"></a><span id="l83.12" class="difflineminus">-#button-getmsg:hover:active {</span>
<a href="#l83.13"></a><span id="l83.13" class="difflineplus">+#button-getmsg:hover:active,</span>
<a href="#l83.14"></a><span id="l83.14" class="difflineplus">+#button-getmsg[open] {</span>
<a href="#l83.15"></a><span id="l83.15">   -moz-image-region: rect(90px 59px 119px 30px);</span>
<a href="#l83.16"></a><span id="l83.16"> } </span>
<a href="#l83.17"></a><span id="l83.17"> </span>
<a href="#l83.18"></a><span id="l83.18"> #button-getmsg[disabled=&quot;true&quot;] {</span>
<a href="#l83.19"></a><span id="l83.19">   -moz-image-region: rect(90px 89px 119px 60px) !important;</span>
<a href="#l83.20"></a><span id="l83.20" class="difflineminus">-} </span>
<a href="#l83.21"></a><span id="l83.21" class="difflineplus">+}</span>
<a href="#l83.22"></a><span id="l83.22"> </span>
<a href="#l83.23"></a><span id="l83.23"> #button-newmsg {</span>
<a href="#l83.24"></a><span id="l83.24">   list-style-image: url(&quot;chrome://messenger/skin/icons/messengericons.png&quot;);</span>
<a href="#l83.25"></a><span id="l83.25">   -moz-image-region: rect(150px 29px 179px 0);</span>
<a href="#l83.26"></a><span id="l83.26"> }</span>
<a href="#l83.27"></a><span id="l83.27"> </span>
<a href="#l83.28"></a><span id="l83.28" class="difflineminus">-#button-newmsg:hover:active {</span>
<a href="#l83.29"></a><span id="l83.29" class="difflineplus">+#button-newmsg:hover:active,</span>
<a href="#l83.30"></a><span id="l83.30" class="difflineplus">+#button-newmsg[open] {</span>
<a href="#l83.31"></a><span id="l83.31">   -moz-image-region: rect(150px 59px 179px 30px);</span>
<a href="#l83.32"></a><span id="l83.32" class="difflineminus">-} </span>
<a href="#l83.33"></a><span id="l83.33" class="difflineplus">+}</span>
<a href="#l83.34"></a><span id="l83.34"> </span>
<a href="#l83.35"></a><span id="l83.35"> #button-newmsg[disabled=&quot;true&quot;] {</span>
<a href="#l83.36"></a><span id="l83.36">   -moz-image-region: rect(150px 89px 179px 60px) !important;</span>
<a href="#l83.37"></a><span id="l83.37" class="difflineminus">-} </span>
<a href="#l83.38"></a><span id="l83.38" class="difflineplus">+}</span>
<a href="#l83.39"></a><span id="l83.39"> </span>
<a href="#l83.40"></a><span id="l83.40"> #button-reply {</span>
<a href="#l83.41"></a><span id="l83.41">   list-style-image: url(&quot;chrome://messenger/skin/icons/messengericons.png&quot;);</span>
<a href="#l83.42"></a><span id="l83.42">   -moz-image-region: rect(210px 29px 239px 0);</span>
<a href="#l83.43"></a><span id="l83.43"> }</span>
<a href="#l83.44"></a><span id="l83.44"> </span>
<a href="#l83.45"></a><span id="l83.45"> #button-reply:hover:active {</span>
<a href="#l83.46"></a><span id="l83.46">   -moz-image-region: rect(210px 59px 239px 30px);</span>
<a href="#l83.47"></a><span id="l83.47" class="difflineminus">-} </span>
<a href="#l83.48"></a><span id="l83.48" class="difflineplus">+}</span>
<a href="#l83.49"></a><span id="l83.49"> </span>
<a href="#l83.50"></a><span id="l83.50"> #button-reply[disabled=&quot;true&quot;] {</span>
<a href="#l83.51"></a><span id="l83.51">   -moz-image-region: rect(210px 89px 239px 60px) !important;</span>
<a href="#l83.52"></a><span id="l83.52" class="difflineminus">-} </span>
<a href="#l83.53"></a><span id="l83.53" class="difflineplus">+}</span>
<a href="#l83.54"></a><span id="l83.54"> </span>
<a href="#l83.55"></a><span id="l83.55"> #button-replyall {</span>
<a href="#l83.56"></a><span id="l83.56">   list-style-image: url(&quot;chrome://messenger/skin/icons/messengericons.png&quot;);</span>
<a href="#l83.57"></a><span id="l83.57">   -moz-image-region: rect(240px 29px 269px 0);</span>
<a href="#l83.58"></a><span id="l83.58"> }</span>
<a href="#l83.59"></a><span id="l83.59"> </span>
<a href="#l83.60"></a><span id="l83.60"> #button-replyall:hover:active {</span>
<a href="#l83.61"></a><span id="l83.61">   -moz-image-region: rect(240px 59px 269px 30px);</span>
<a href="#l83.62"></a><span id="l83.62"> } </span>
<a href="#l83.63"></a><span id="l83.63"> </span>
<a href="#l83.64"></a><span id="l83.64"> #button-replyall[disabled=&quot;true&quot;] {</span>
<a href="#l83.65"></a><span id="l83.65">   -moz-image-region: rect(240px 89px 269px 60px) !important;</span>
<a href="#l83.66"></a><span id="l83.66" class="difflineminus">-} </span>
<a href="#l83.67"></a><span id="l83.67" class="difflineplus">+}</span>
<a href="#l83.68"></a><span id="l83.68"> </span>
<a href="#l83.69"></a><span id="l83.69"> #button-forward {</span>
<a href="#l83.70"></a><span id="l83.70">   list-style-image: url(&quot;chrome://messenger/skin/icons/messengericons.png&quot;);</span>
<a href="#l83.71"></a><span id="l83.71">   -moz-image-region: rect(60px 29px 89px 0);</span>
<a href="#l83.72"></a><span id="l83.72"> }</span>
<a href="#l83.73"></a><span id="l83.73"> </span>
<a href="#l83.74"></a><span id="l83.74" class="difflineminus">-#button-forward:hover:active {</span>
<a href="#l83.75"></a><span id="l83.75" class="difflineplus">+#button-forward:hover:active,</span>
<a href="#l83.76"></a><span id="l83.76" class="difflineplus">+#button-forward[open] {</span>
<a href="#l83.77"></a><span id="l83.77">   -moz-image-region: rect(60px 59px 89px 30px);</span>
<a href="#l83.78"></a><span id="l83.78"> } </span>
<a href="#l83.79"></a><span id="l83.79"> </span>
<a href="#l83.80"></a><span id="l83.80"> #button-forward[disabled=&quot;true&quot;] {</span>
<a href="#l83.81"></a><span id="l83.81">   -moz-image-region: rect(60px 89px 89px 60px) !important;</span>
<a href="#l83.82"></a><span id="l83.82"> } </span>
<a href="#l83.83"></a><span id="l83.83"> </span>
<a href="#l83.84"></a><span id="l83.84"> #button-file {</span>
<a href="#l83.85"></a><span id="l83.85">   list-style-image: url(&quot;chrome://messenger/skin/icons/messengericons.png&quot;);</span>
<a href="#l83.86"></a><span id="l83.86">   -moz-image-region: rect(30px 29px 59px 0);</span>
<a href="#l83.87"></a><span id="l83.87"> }</span>
<a href="#l83.88"></a><span id="l83.88"> </span>
<a href="#l83.89"></a><span id="l83.89"> #button-file:hover:active,</span>
<a href="#l83.90"></a><span id="l83.90"> #button-file[open] {</span>
<a href="#l83.91"></a><span id="l83.91">   -moz-image-region: rect(30px 59px 59px 30px);</span>
<a href="#l83.92"></a><span id="l83.92" class="difflineminus">-} </span>
<a href="#l83.93"></a><span id="l83.93" class="difflineplus">+}</span>
<a href="#l83.94"></a><span id="l83.94"> </span>
<a href="#l83.95"></a><span id="l83.95"> #button-file[disabled=&quot;true&quot;] {</span>
<a href="#l83.96"></a><span id="l83.96">   -moz-image-region: rect(30px 89px 59px 60px) !important;</span>
<a href="#l83.97"></a><span id="l83.97" class="difflineminus">-} </span>
<a href="#l83.98"></a><span id="l83.98" class="difflineplus">+}</span>
<a href="#l83.99"></a><span id="l83.99"> </span>
<a href="#l83.100"></a><span id="l83.100"> #button-goback {</span>
<a href="#l83.101"></a><span id="l83.101">   list-style-image: url(&quot;chrome://communicator/skin/icons/communicatoricons.png&quot;);</span>
<a href="#l83.102"></a><span id="l83.102">   -moz-image-region: rect(60px 29px 89px 0);</span>
<a href="#l83.103"></a><span id="l83.103"> }</span>
<a href="#l83.104"></a><span id="l83.104"> </span>
<a href="#l83.105"></a><span id="l83.105" class="difflineminus">-#button-goback:hover:active {</span>
<a href="#l83.106"></a><span id="l83.106" class="difflineplus">+#button-goback:hover:active,</span>
<a href="#l83.107"></a><span id="l83.107" class="difflineplus">+#button-goback[open] {</span>
<a href="#l83.108"></a><span id="l83.108">   -moz-image-region: rect(60px 59px 89px 30px);</span>
<a href="#l83.109"></a><span id="l83.109"> }</span>
<a href="#l83.110"></a><span id="l83.110"> </span>
<a href="#l83.111"></a><span id="l83.111"> #button-goback[disabled=&quot;true&quot;] {</span>
<a href="#l83.112"></a><span id="l83.112">   -moz-image-region: rect(60px 89px 89px 60px) !important;</span>
<a href="#l83.113"></a><span id="l83.113"> }</span>
<a href="#l83.114"></a><span id="l83.114"> </span>
<a href="#l83.115"></a><span id="l83.115"> #button-goforward {</span>
<a href="#l83.116"></a><span id="l83.116">   list-style-image: url(&quot;chrome://communicator/skin/icons/communicatoricons.png&quot;);</span>
<a href="#l83.117"></a><span id="l83.117">   -moz-image-region: rect(90px 29px 119px 0);</span>
<a href="#l83.118"></a><span id="l83.118"> }</span>
<a href="#l83.119"></a><span id="l83.119"> </span>
<a href="#l83.120"></a><span id="l83.120" class="difflineminus">-#button-goforward:hover:active {</span>
<a href="#l83.121"></a><span id="l83.121" class="difflineplus">+#button-goforward:hover:active,</span>
<a href="#l83.122"></a><span id="l83.122" class="difflineplus">+#button-goforward[open] {</span>
<a href="#l83.123"></a><span id="l83.123">   -moz-image-region: rect(90px 59px 119px 30px);</span>
<a href="#l83.124"></a><span id="l83.124"> }</span>
<a href="#l83.125"></a><span id="l83.125"> </span>
<a href="#l83.126"></a><span id="l83.126"> #button-goforward[disabled=&quot;true&quot;] {</span>
<a href="#l83.127"></a><span id="l83.127">   -moz-image-region: rect(90px 89px 119px 60px) !important;</span>
<a href="#l83.128"></a><span id="l83.128"> }</span>
<a href="#l83.129"></a><span id="l83.129"> </span>
<a href="#l83.130"></a><span id="l83.130"> #button-next {</span>
<a href="#l83.131"></a><span id="l83.131">   list-style-image: url(&quot;chrome://messenger/skin/icons/messengericons.png&quot;);</span>
<a href="#l83.132"></a><span id="l83.132">   -moz-image-region: rect(180px 29px 209px 0);</span>
<a href="#l83.133"></a><span id="l83.133"> }</span>
<a href="#l83.134"></a><span id="l83.134"> </span>
<a href="#l83.135"></a><span id="l83.135" class="difflineminus">-#button-next:hover:active {</span>
<a href="#l83.136"></a><span id="l83.136" class="difflineplus">+#button-next:hover:active,</span>
<a href="#l83.137"></a><span id="l83.137" class="difflineplus">+#button-next[open] {</span>
<a href="#l83.138"></a><span id="l83.138">   -moz-image-region: rect(180px 59px 209px 30px);</span>
<a href="#l83.139"></a><span id="l83.139" class="difflineminus">-} </span>
<a href="#l83.140"></a><span id="l83.140" class="difflineplus">+}</span>
<a href="#l83.141"></a><span id="l83.141"> </span>
<a href="#l83.142"></a><span id="l83.142"> #button-next[disabled=&quot;true&quot;] {</span>
<a href="#l83.143"></a><span id="l83.143">   -moz-image-region: rect(180px 89px 209px 60px) !important;</span>
<a href="#l83.144"></a><span id="l83.144" class="difflineminus">-} </span>
<a href="#l83.145"></a><span id="l83.145" class="difflineplus">+}</span>
<a href="#l83.146"></a><span id="l83.146"> </span>
<a href="#l83.147"></a><span id="l83.147"> #button-delete {</span>
<a href="#l83.148"></a><span id="l83.148">   list-style-image: url(&quot;chrome://messenger/skin/icons/messengericons.png&quot;);</span>
<a href="#l83.149"></a><span id="l83.149">   -moz-image-region: rect(0 29px 29px 0);</span>
<a href="#l83.150"></a><span id="l83.150"> }</span>
<a href="#l83.151"></a><span id="l83.151"> </span>
<a href="#l83.152"></a><span id="l83.152"> #button-delete:hover:active {</span>
<a href="#l83.153"></a><span id="l83.153">   -moz-image-region: rect(0 59px 29px 30px);</span>
<a href="#l83.154"></a><span id="l83.154" class="difflineat">@@ -179,23 +185,24 @@ toolbarpaletteitem &gt; #button-delete {</span>
<a href="#l83.155"></a><span id="l83.155">   display: -moz-box;</span>
<a href="#l83.156"></a><span id="l83.156"> }</span>
<a href="#l83.157"></a><span id="l83.157"> </span>
<a href="#l83.158"></a><span id="l83.158"> #button-mark {</span>
<a href="#l83.159"></a><span id="l83.159">   list-style-image: url(&quot;chrome://messenger/skin/icons/messengericons.png&quot;);</span>
<a href="#l83.160"></a><span id="l83.160">   -moz-image-region: rect(120px 29px 149px 0);</span>
<a href="#l83.161"></a><span id="l83.161"> }</span>
<a href="#l83.162"></a><span id="l83.162"> </span>
<a href="#l83.163"></a><span id="l83.163" class="difflineminus">-#button-mark:hover:active {</span>
<a href="#l83.164"></a><span id="l83.164" class="difflineplus">+#button-mark:hover:active,</span>
<a href="#l83.165"></a><span id="l83.165" class="difflineplus">+#button-mark[open] {</span>
<a href="#l83.166"></a><span id="l83.166">   -moz-image-region: rect(120px 59px 149px 30px);</span>
<a href="#l83.167"></a><span id="l83.167" class="difflineminus">-} </span>
<a href="#l83.168"></a><span id="l83.168" class="difflineplus">+}</span>
<a href="#l83.169"></a><span id="l83.169"> </span>
<a href="#l83.170"></a><span id="l83.170"> #button-mark[disabled=&quot;true&quot;] {</span>
<a href="#l83.171"></a><span id="l83.171">   -moz-image-region: rect(120px 89px 149px 60px) !important;</span>
<a href="#l83.172"></a><span id="l83.172" class="difflineminus">-} </span>
<a href="#l83.173"></a><span id="l83.173" class="difflineplus">+}</span>
<a href="#l83.174"></a><span id="l83.174"> </span>
<a href="#l83.175"></a><span id="l83.175"> #button-junk {</span>
<a href="#l83.176"></a><span id="l83.176">   list-style-image: url(&quot;chrome://messenger/skin/icons/messengericons.png&quot;);</span>
<a href="#l83.177"></a><span id="l83.177">   -moz-image-region: rect(360px 29px 389px 0);</span>
<a href="#l83.178"></a><span id="l83.178"> }</span>
<a href="#l83.179"></a><span id="l83.179"> </span>
<a href="#l83.180"></a><span id="l83.180"> #button-junk:hover:active {</span>
<a href="#l83.181"></a><span id="l83.181">   -moz-image-region: rect(360px 59px 389px 30px);</span>
<a href="#l83.182"></a><span id="l83.182" class="difflineat">@@ -205,17 +212,18 @@ toolbarpaletteitem &gt; #button-delete {</span>
<a href="#l83.183"></a><span id="l83.183">   -moz-image-region: rect(360px 89px 389px 60px) !important;</span>
<a href="#l83.184"></a><span id="l83.184"> }</span>
<a href="#l83.185"></a><span id="l83.185"> </span>
<a href="#l83.186"></a><span id="l83.186"> #button-print {</span>
<a href="#l83.187"></a><span id="l83.187">   list-style-image: url(&quot;chrome://communicator/skin/icons/communicatoricons.png&quot;);</span>
<a href="#l83.188"></a><span id="l83.188">   -moz-image-region: rect(0 29px 29px 0);</span>
<a href="#l83.189"></a><span id="l83.189"> }</span>
<a href="#l83.190"></a><span id="l83.190"> </span>
<a href="#l83.191"></a><span id="l83.191" class="difflineminus">-#button-print:hover:active {</span>
<a href="#l83.192"></a><span id="l83.192" class="difflineplus">+#button-print:hover:active,</span>
<a href="#l83.193"></a><span id="l83.193" class="difflineplus">+#button-print[open] {</span>
<a href="#l83.194"></a><span id="l83.194">   -moz-image-region: rect(0 59px 29px 30px);</span>
<a href="#l83.195"></a><span id="l83.195"> }</span>
<a href="#l83.196"></a><span id="l83.196"> </span>
<a href="#l83.197"></a><span id="l83.197"> #button-print[disabled=&quot;true&quot;] {</span>
<a href="#l83.198"></a><span id="l83.198">   -moz-image-region: rect(0 89px 29px 60px) !important;</span>
<a href="#l83.199"></a><span id="l83.199"> }</span>
<a href="#l83.200"></a><span id="l83.200"> </span>
<a href="#l83.201"></a><span id="l83.201"> #button-stop {</span>
<a href="#l83.202"></a><span id="l83.202" class="difflineat">@@ -233,30 +241,32 @@ toolbarpaletteitem &gt; #button-delete {</span>
<a href="#l83.203"></a><span id="l83.203"> </span>
<a href="#l83.204"></a><span id="l83.204"> /* ::::: small primary toolbar buttons ::::: */</span>
<a href="#l83.205"></a><span id="l83.205"> </span>
<a href="#l83.206"></a><span id="l83.206"> toolbar[iconsize=&quot;small&quot;] &gt; #button-getmsg {</span>
<a href="#l83.207"></a><span id="l83.207">   list-style-image: url(&quot;chrome://messenger/skin/icons/messengericons-small.png&quot;);</span>
<a href="#l83.208"></a><span id="l83.208">   -moz-image-region: rect(60px 19px 79px 0);</span>
<a href="#l83.209"></a><span id="l83.209"> }</span>
<a href="#l83.210"></a><span id="l83.210"> </span>
<a href="#l83.211"></a><span id="l83.211" class="difflineminus">-toolbar[iconsize=&quot;small&quot;] &gt; #button-getmsg:hover:active {</span>
<a href="#l83.212"></a><span id="l83.212" class="difflineplus">+toolbar[iconsize=&quot;small&quot;] &gt; #button-getmsg:hover:active,</span>
<a href="#l83.213"></a><span id="l83.213" class="difflineplus">+toolbar[iconsize=&quot;small&quot;] &gt; #button-getmsg[open] {</span>
<a href="#l83.214"></a><span id="l83.214">   -moz-image-region: rect(60px 39px 79px 20px);</span>
<a href="#l83.215"></a><span id="l83.215"> }</span>
<a href="#l83.216"></a><span id="l83.216"> </span>
<a href="#l83.217"></a><span id="l83.217"> toolbar[iconsize=&quot;small&quot;] &gt; #button-getmsg[disabled=&quot;true&quot;] {</span>
<a href="#l83.218"></a><span id="l83.218">   -moz-image-region: rect(60px 59px 79px 40px) !important;</span>
<a href="#l83.219"></a><span id="l83.219"> }</span>
<a href="#l83.220"></a><span id="l83.220"> </span>
<a href="#l83.221"></a><span id="l83.221"> toolbar[iconsize=&quot;small&quot;] &gt; #button-newmsg {</span>
<a href="#l83.222"></a><span id="l83.222">   list-style-image: url(&quot;chrome://messenger/skin/icons/messengericons-small.png&quot;);</span>
<a href="#l83.223"></a><span id="l83.223">   -moz-image-region: rect(100px 19px 119px 0);</span>
<a href="#l83.224"></a><span id="l83.224"> }</span>
<a href="#l83.225"></a><span id="l83.225"> </span>
<a href="#l83.226"></a><span id="l83.226" class="difflineminus">-toolbar[iconsize=&quot;small&quot;] &gt; #button-newmsg:hover:active {</span>
<a href="#l83.227"></a><span id="l83.227" class="difflineplus">+toolbar[iconsize=&quot;small&quot;] &gt; #button-newmsg:hover:active,</span>
<a href="#l83.228"></a><span id="l83.228" class="difflineplus">+toolbar[iconsize=&quot;small&quot;] &gt; #button-newmsg[open] {</span>
<a href="#l83.229"></a><span id="l83.229">   -moz-image-region: rect(100px 39px 119px 20px);</span>
<a href="#l83.230"></a><span id="l83.230"> }</span>
<a href="#l83.231"></a><span id="l83.231"> </span>
<a href="#l83.232"></a><span id="l83.232"> toolbar[iconsize=&quot;small&quot;] &gt; #button-newmsg[disabled=&quot;true&quot;] {</span>
<a href="#l83.233"></a><span id="l83.233">   -moz-image-region: rect(100px 59px 119px 40px) !important;</span>
<a href="#l83.234"></a><span id="l83.234"> }</span>
<a href="#l83.235"></a><span id="l83.235"> </span>
<a href="#l83.236"></a><span id="l83.236"> toolbar[iconsize=&quot;small&quot;] &gt; #button-reply {</span>
<a href="#l83.237"></a><span id="l83.237" class="difflineat">@@ -285,17 +295,18 @@ toolbar[iconsize=&quot;small&quot;] &gt; #button-repl</span>
<a href="#l83.238"></a><span id="l83.238">   -moz-image-region: rect(160px 59px 179px 40px) !important;</span>
<a href="#l83.239"></a><span id="l83.239"> }</span>
<a href="#l83.240"></a><span id="l83.240"> </span>
<a href="#l83.241"></a><span id="l83.241"> toolbar[iconsize=&quot;small&quot;] &gt; #button-forward {</span>
<a href="#l83.242"></a><span id="l83.242">   list-style-image: url(&quot;chrome://messenger/skin/icons/messengericons-small.png&quot;);</span>
<a href="#l83.243"></a><span id="l83.243">   -moz-image-region: rect(40px 19px 59px 0);</span>
<a href="#l83.244"></a><span id="l83.244"> }</span>
<a href="#l83.245"></a><span id="l83.245"> </span>
<a href="#l83.246"></a><span id="l83.246" class="difflineminus">-toolbar[iconsize=&quot;small&quot;] &gt; #button-forward:hover:active {</span>
<a href="#l83.247"></a><span id="l83.247" class="difflineplus">+toolbar[iconsize=&quot;small&quot;] &gt; #button-forward:hover:active,</span>
<a href="#l83.248"></a><span id="l83.248" class="difflineplus">+toolbar[iconsize=&quot;small&quot;] &gt; #button-forward[open] {</span>
<a href="#l83.249"></a><span id="l83.249">   -moz-image-region: rect(40px 39px 59px 20px);</span>
<a href="#l83.250"></a><span id="l83.250"> }</span>
<a href="#l83.251"></a><span id="l83.251"> </span>
<a href="#l83.252"></a><span id="l83.252"> toolbar[iconsize=&quot;small&quot;] &gt; #button-forward[disabled=&quot;true&quot;] {</span>
<a href="#l83.253"></a><span id="l83.253">   -moz-image-region: rect(40px 59px 59px 40px) !important;</span>
<a href="#l83.254"></a><span id="l83.254"> }</span>
<a href="#l83.255"></a><span id="l83.255"> </span>
<a href="#l83.256"></a><span id="l83.256"> toolbar[iconsize=&quot;small&quot;] &gt; #button-file {</span>
<a href="#l83.257"></a><span id="l83.257" class="difflineat">@@ -312,43 +323,46 @@ toolbar[iconsize=&quot;small&quot;] &gt; #button-file</span>
<a href="#l83.258"></a><span id="l83.258">   -moz-image-region: rect(20px 59px 39px 40px) !important;</span>
<a href="#l83.259"></a><span id="l83.259"> }</span>
<a href="#l83.260"></a><span id="l83.260"> </span>
<a href="#l83.261"></a><span id="l83.261"> toolbar[iconsize=&quot;small&quot;] &gt; #button-goback {</span>
<a href="#l83.262"></a><span id="l83.262">   list-style-image: url(&quot;chrome://communicator/skin/icons/communicatoricons-small.png&quot;);</span>
<a href="#l83.263"></a><span id="l83.263">   -moz-image-region: rect(40px 19px 59px 0);</span>
<a href="#l83.264"></a><span id="l83.264"> }</span>
<a href="#l83.265"></a><span id="l83.265"> </span>
<a href="#l83.266"></a><span id="l83.266" class="difflineminus">-toolbar[iconsize=&quot;small&quot;] &gt; #button-goback:hover:active {</span>
<a href="#l83.267"></a><span id="l83.267" class="difflineplus">+toolbar[iconsize=&quot;small&quot;] &gt; #button-goback:hover:active,</span>
<a href="#l83.268"></a><span id="l83.268" class="difflineplus">+toolbar[iconsize=&quot;small&quot;] &gt; #button-goback[open] {</span>
<a href="#l83.269"></a><span id="l83.269">   -moz-image-region: rect(40px 39px 59px 20px);</span>
<a href="#l83.270"></a><span id="l83.270"> }</span>
<a href="#l83.271"></a><span id="l83.271"> </span>
<a href="#l83.272"></a><span id="l83.272"> toolbar[iconsize=&quot;small&quot;] &gt; #button-goback[disabled=&quot;true&quot;] {</span>
<a href="#l83.273"></a><span id="l83.273">   -moz-image-region: rect(40px 59px 59px 40px) !important;</span>
<a href="#l83.274"></a><span id="l83.274"> }</span>
<a href="#l83.275"></a><span id="l83.275"> </span>
<a href="#l83.276"></a><span id="l83.276"> toolbar[iconsize=&quot;small&quot;] &gt; #button-goforward {</span>
<a href="#l83.277"></a><span id="l83.277">   list-style-image: url(&quot;chrome://communicator/skin/icons/communicatoricons-small.png&quot;);</span>
<a href="#l83.278"></a><span id="l83.278">   -moz-image-region: rect(60px 19px 79px 0);</span>
<a href="#l83.279"></a><span id="l83.279"> }</span>
<a href="#l83.280"></a><span id="l83.280"> </span>
<a href="#l83.281"></a><span id="l83.281" class="difflineminus">-toolbar[iconsize=&quot;small&quot;] &gt; #button-goforward:hover:active {</span>
<a href="#l83.282"></a><span id="l83.282" class="difflineplus">+toolbar[iconsize=&quot;small&quot;] &gt; #button-goforward:hover:active,</span>
<a href="#l83.283"></a><span id="l83.283" class="difflineplus">+toolbar[iconsize=&quot;small&quot;] &gt; #button-goforward[open] {</span>
<a href="#l83.284"></a><span id="l83.284">   -moz-image-region: rect(60px 39px 79px 20px);</span>
<a href="#l83.285"></a><span id="l83.285"> }</span>
<a href="#l83.286"></a><span id="l83.286"> </span>
<a href="#l83.287"></a><span id="l83.287"> toolbar[iconsize=&quot;small&quot;] &gt; #button-goforward[disabled=&quot;true&quot;] {</span>
<a href="#l83.288"></a><span id="l83.288">   -moz-image-region: rect(60px 59px 79px 40px) !important;</span>
<a href="#l83.289"></a><span id="l83.289"> }</span>
<a href="#l83.290"></a><span id="l83.290"> </span>
<a href="#l83.291"></a><span id="l83.291"> toolbar[iconsize=&quot;small&quot;] &gt; #button-next {</span>
<a href="#l83.292"></a><span id="l83.292">   list-style-image: url(&quot;chrome://messenger/skin/icons/messengericons-small.png&quot;);</span>
<a href="#l83.293"></a><span id="l83.293">   -moz-image-region: rect(120px 19px 139px 0);</span>
<a href="#l83.294"></a><span id="l83.294"> }</span>
<a href="#l83.295"></a><span id="l83.295"> </span>
<a href="#l83.296"></a><span id="l83.296" class="difflineminus">-toolbar[iconsize=&quot;small&quot;] &gt; #button-next:hover:active {</span>
<a href="#l83.297"></a><span id="l83.297" class="difflineplus">+toolbar[iconsize=&quot;small&quot;] &gt; #button-next:hover:active,</span>
<a href="#l83.298"></a><span id="l83.298" class="difflineplus">+toolbar[iconsize=&quot;small&quot;] &gt; #button-next[open] {</span>
<a href="#l83.299"></a><span id="l83.299">   -moz-image-region: rect(120px 39px 139px 20px);</span>
<a href="#l83.300"></a><span id="l83.300"> }</span>
<a href="#l83.301"></a><span id="l83.301"> </span>
<a href="#l83.302"></a><span id="l83.302"> toolbar[iconsize=&quot;small&quot;] &gt; #button-next[disabled=&quot;true&quot;] {</span>
<a href="#l83.303"></a><span id="l83.303">   -moz-image-region: rect(120px 59px 139px 40px) !important;</span>
<a href="#l83.304"></a><span id="l83.304"> }</span>
<a href="#l83.305"></a><span id="l83.305"> </span>
<a href="#l83.306"></a><span id="l83.306"> toolbar[iconsize=&quot;small&quot;] &gt; #button-delete {</span>
<a href="#l83.307"></a><span id="l83.307" class="difflineat">@@ -364,17 +378,18 @@ toolbar[iconsize=&quot;small&quot;] &gt; #button-dele</span>
<a href="#l83.308"></a><span id="l83.308">   -moz-image-region: rect(0 59px 19px 40px) !important;</span>
<a href="#l83.309"></a><span id="l83.309"> }</span>
<a href="#l83.310"></a><span id="l83.310"> </span>
<a href="#l83.311"></a><span id="l83.311"> toolbar[iconsize=&quot;small&quot;] &gt; #button-mark {</span>
<a href="#l83.312"></a><span id="l83.312">   list-style-image: url(&quot;chrome://messenger/skin/icons/messengericons-small.png&quot;);</span>
<a href="#l83.313"></a><span id="l83.313">   -moz-image-region: rect(80px 19px 99px 0);</span>
<a href="#l83.314"></a><span id="l83.314"> }</span>
<a href="#l83.315"></a><span id="l83.315"> </span>
<a href="#l83.316"></a><span id="l83.316" class="difflineminus">-toolbar[iconsize=&quot;small&quot;] &gt; #button-mark:hover:active {</span>
<a href="#l83.317"></a><span id="l83.317" class="difflineplus">+toolbar[iconsize=&quot;small&quot;] &gt; #button-mark:hover:active,</span>
<a href="#l83.318"></a><span id="l83.318" class="difflineplus">+toolbar[iconsize=&quot;small&quot;] &gt; #button-mark[open] {</span>
<a href="#l83.319"></a><span id="l83.319">   -moz-image-region: rect(80px 39px 99px 20px);</span>
<a href="#l83.320"></a><span id="l83.320"> }</span>
<a href="#l83.321"></a><span id="l83.321"> </span>
<a href="#l83.322"></a><span id="l83.322"> toolbar[iconsize=&quot;small&quot;] &gt; #button-mark[disabled=&quot;true&quot;] {</span>
<a href="#l83.323"></a><span id="l83.323">   -moz-image-region: rect(80px 59px 99px 40px) !important;</span>
<a href="#l83.324"></a><span id="l83.324"> }</span>
<a href="#l83.325"></a><span id="l83.325"> </span>
<a href="#l83.326"></a><span id="l83.326"> toolbar[iconsize=&quot;small&quot;] &gt; #button-junk &gt; #junk-deck &gt; .toolbarbutton-1 {</span>
<a href="#l83.327"></a><span id="l83.327" class="difflineat">@@ -390,17 +405,18 @@ toolbar[iconsize=&quot;small&quot;] &gt; #button-junk</span>
<a href="#l83.328"></a><span id="l83.328">   -moz-image-region: rect(240px 59px 259px 40px) !important;</span>
<a href="#l83.329"></a><span id="l83.329"> }</span>
<a href="#l83.330"></a><span id="l83.330"> </span>
<a href="#l83.331"></a><span id="l83.331"> toolbar[iconsize=&quot;small&quot;] &gt; #button-print {</span>
<a href="#l83.332"></a><span id="l83.332">   list-style-image: url(&quot;chrome://communicator/skin/icons/communicatoricons-small.png&quot;);</span>
<a href="#l83.333"></a><span id="l83.333">   -moz-image-region: rect(0 19px 19px 0);</span>
<a href="#l83.334"></a><span id="l83.334"> }</span>
<a href="#l83.335"></a><span id="l83.335"> </span>
<a href="#l83.336"></a><span id="l83.336" class="difflineminus">-toolbar[iconsize=&quot;small&quot;] &gt; #button-print:hover:active {</span>
<a href="#l83.337"></a><span id="l83.337" class="difflineplus">+toolbar[iconsize=&quot;small&quot;] &gt; #button-print:hover:active,</span>
<a href="#l83.338"></a><span id="l83.338" class="difflineplus">+toolbar[iconsize=&quot;small&quot;] &gt; #button-print[open] {</span>
<a href="#l83.339"></a><span id="l83.339">   -moz-image-region: rect(0 39px 19px 20px);</span>
<a href="#l83.340"></a><span id="l83.340"> }</span>
<a href="#l83.341"></a><span id="l83.341"> </span>
<a href="#l83.342"></a><span id="l83.342"> toolbar[iconsize=&quot;small&quot;] &gt; #button-print[disabled=&quot;true&quot;] {</span>
<a href="#l83.343"></a><span id="l83.343">   -moz-image-region: rect(0 59px 19px 40px) !important;</span>
<a href="#l83.344"></a><span id="l83.344"> }</span>
<a href="#l83.345"></a><span id="l83.345"> </span>
<a href="#l83.346"></a><span id="l83.346"> toolbar[iconsize=&quot;small&quot;] &gt; #button-stop {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l84.1"></a><span id="l84.1" class="difflineminus">--- a/suite/themes/classic/mac/messenger/smime/msgCompSMIMEOverlay.css</span>
<a href="#l84.2"></a><span id="l84.2" class="difflineplus">+++ b/suite/themes/classic/mac/messenger/smime/msgCompSMIMEOverlay.css</span>
<a href="#l84.3"></a><span id="l84.3" class="difflineat">@@ -41,17 +41,18 @@</span>
<a href="#l84.4"></a><span id="l84.4"> </span>
<a href="#l84.5"></a><span id="l84.5"> @namespace url(&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;);</span>
<a href="#l84.6"></a><span id="l84.6"> </span>
<a href="#l84.7"></a><span id="l84.7"> #button-security {</span>
<a href="#l84.8"></a><span id="l84.8">   list-style-image: url(&quot;chrome://messenger/skin/smime/icons/smimeicons.png&quot;);</span>
<a href="#l84.9"></a><span id="l84.9">   -moz-image-region: rect(0 29px 29px 0px);</span>
<a href="#l84.10"></a><span id="l84.10"> }</span>
<a href="#l84.11"></a><span id="l84.11"> </span>
<a href="#l84.12"></a><span id="l84.12" class="difflineminus">-#button-security:hover:active {</span>
<a href="#l84.13"></a><span id="l84.13" class="difflineplus">+#button-security:hover:active,</span>
<a href="#l84.14"></a><span id="l84.14" class="difflineplus">+#button-security[open] {</span>
<a href="#l84.15"></a><span id="l84.15">   -moz-image-region: rect(0 59px 29px 30px);</span>
<a href="#l84.16"></a><span id="l84.16"> }</span>
<a href="#l84.17"></a><span id="l84.17"> </span>
<a href="#l84.18"></a><span id="l84.18"> #button-security[disabled] {</span>
<a href="#l84.19"></a><span id="l84.19">   -moz-image-region: rect(0 89px 29px 60px) !important;</span>
<a href="#l84.20"></a><span id="l84.20"> }</span>
<a href="#l84.21"></a><span id="l84.21"> </span>
<a href="#l84.22"></a><span id="l84.22"> #msgcomposeWindow #signing-status {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l85.1"></a><span id="l85.1" class="difflineminus">--- a/suite/themes/classic/mac/navigator/navigator.css</span>
<a href="#l85.2"></a><span id="l85.2" class="difflineplus">+++ b/suite/themes/classic/mac/navigator/navigator.css</span>
<a href="#l85.3"></a><span id="l85.3" class="difflineat">@@ -61,30 +61,32 @@</span>
<a href="#l85.4"></a><span id="l85.4"> </span>
<a href="#l85.5"></a><span id="l85.5"> /* ::::: primary toolbar buttons ::::: */</span>
<a href="#l85.6"></a><span id="l85.6"> </span>
<a href="#l85.7"></a><span id="l85.7"> #back-button {</span>
<a href="#l85.8"></a><span id="l85.8">   list-style-image: url(&quot;chrome://communicator/skin/icons/communicatoricons.png&quot;);</span>
<a href="#l85.9"></a><span id="l85.9">   -moz-image-region: rect(60px 29px 89px 0);</span>
<a href="#l85.10"></a><span id="l85.10"> }</span>
<a href="#l85.11"></a><span id="l85.11"> </span>
<a href="#l85.12"></a><span id="l85.12" class="difflineminus">-#back-button:hover:active {</span>
<a href="#l85.13"></a><span id="l85.13" class="difflineplus">+#back-button:hover:active,</span>
<a href="#l85.14"></a><span id="l85.14" class="difflineplus">+#back-button[open] {</span>
<a href="#l85.15"></a><span id="l85.15">   -moz-image-region: rect(60px 59px 89px 30px);</span>
<a href="#l85.16"></a><span id="l85.16"> }</span>
<a href="#l85.17"></a><span id="l85.17"> </span>
<a href="#l85.18"></a><span id="l85.18"> #back-button[disabled=&quot;true&quot;] {</span>
<a href="#l85.19"></a><span id="l85.19">   -moz-image-region: rect(60px 89px 89px 60px) !important;</span>
<a href="#l85.20"></a><span id="l85.20"> }</span>
<a href="#l85.21"></a><span id="l85.21"> </span>
<a href="#l85.22"></a><span id="l85.22"> #forward-button {</span>
<a href="#l85.23"></a><span id="l85.23">   list-style-image: url(&quot;chrome://communicator/skin/icons/communicatoricons.png&quot;);</span>
<a href="#l85.24"></a><span id="l85.24">   -moz-image-region: rect(90px 29px 119px 0);</span>
<a href="#l85.25"></a><span id="l85.25"> }</span>
<a href="#l85.26"></a><span id="l85.26"> </span>
<a href="#l85.27"></a><span id="l85.27" class="difflineminus">-#forward-button:hover:active {</span>
<a href="#l85.28"></a><span id="l85.28" class="difflineplus">+#forward-button:hover:active,</span>
<a href="#l85.29"></a><span id="l85.29" class="difflineplus">+#forward-button[open] {</span>
<a href="#l85.30"></a><span id="l85.30">   -moz-image-region: rect(90px 59px 119px 30px);</span>
<a href="#l85.31"></a><span id="l85.31"> }</span>
<a href="#l85.32"></a><span id="l85.32"> </span>
<a href="#l85.33"></a><span id="l85.33"> #forward-button[disabled=&quot;true&quot;] {</span>
<a href="#l85.34"></a><span id="l85.34">   -moz-image-region: rect(90px 89px 119px 60px) !important;</span>
<a href="#l85.35"></a><span id="l85.35"> }</span>
<a href="#l85.36"></a><span id="l85.36"> </span>
<a href="#l85.37"></a><span id="l85.37"> #reload-button {</span>
<a href="#l85.38"></a><span id="l85.38" class="difflineat">@@ -113,17 +115,18 @@</span>
<a href="#l85.39"></a><span id="l85.39">   -moz-image-region: rect(30px 89px 59px 60px) !important;</span>
<a href="#l85.40"></a><span id="l85.40"> }</span>
<a href="#l85.41"></a><span id="l85.41"> </span>
<a href="#l85.42"></a><span id="l85.42"> #print-button {</span>
<a href="#l85.43"></a><span id="l85.43">   list-style-image: url(&quot;chrome://communicator/skin/icons/communicatoricons.png&quot;);</span>
<a href="#l85.44"></a><span id="l85.44">   -moz-image-region: rect(0 29px 29px 0);</span>
<a href="#l85.45"></a><span id="l85.45"> }</span>
<a href="#l85.46"></a><span id="l85.46"> </span>
<a href="#l85.47"></a><span id="l85.47" class="difflineminus">-#print-button:not([disabled=&quot;true&quot;]):hover:active {</span>
<a href="#l85.48"></a><span id="l85.48" class="difflineplus">+#print-button:hover:active,</span>
<a href="#l85.49"></a><span id="l85.49" class="difflineplus">+#print-button[open] {</span>
<a href="#l85.50"></a><span id="l85.50">   -moz-image-region: rect(0 59px 29px 30px);</span>
<a href="#l85.51"></a><span id="l85.51"> }</span>
<a href="#l85.52"></a><span id="l85.52"> </span>
<a href="#l85.53"></a><span id="l85.53"> #print-button[disabled=&quot;true&quot;] {</span>
<a href="#l85.54"></a><span id="l85.54">   -moz-image-region: rect(0 89px 29px 60px) !important;</span>
<a href="#l85.55"></a><span id="l85.55"> }</span>
<a href="#l85.56"></a><span id="l85.56"> </span>
<a href="#l85.57"></a><span id="l85.57"> #home-button {</span>
<a href="#l85.58"></a><span id="l85.58" class="difflineat">@@ -142,102 +145,93 @@</span>
<a href="#l85.59"></a><span id="l85.59"> /* ::::: small primary toolbar buttons ::::: */</span>
<a href="#l85.60"></a><span id="l85.60"> </span>
<a href="#l85.61"></a><span id="l85.61"> toolbar[iconsize=&quot;small&quot;] &gt; toolbarpaletteitem &gt; #back-button,</span>
<a href="#l85.62"></a><span id="l85.62"> toolbar[iconsize=&quot;small&quot;] &gt; #back-button {</span>
<a href="#l85.63"></a><span id="l85.63">   list-style-image: url(&quot;chrome://communicator/skin/icons/communicatoricons-small.png&quot;);</span>
<a href="#l85.64"></a><span id="l85.64">   -moz-image-region: rect(40px 19px 59px 0);</span>
<a href="#l85.65"></a><span id="l85.65"> }</span>
<a href="#l85.66"></a><span id="l85.66"> </span>
<a href="#l85.67"></a><span id="l85.67" class="difflineminus">-toolbar[iconsize=&quot;small&quot;] &gt; toolbarpaletteitem &gt; #back-button:hover:active,</span>
<a href="#l85.68"></a><span id="l85.68" class="difflineminus">-toolbar[iconsize=&quot;small&quot;] &gt; #back-button:hover:active {</span>
<a href="#l85.69"></a><span id="l85.69" class="difflineplus">+toolbar[iconsize=&quot;small&quot;] &gt; #back-button:hover:active,</span>
<a href="#l85.70"></a><span id="l85.70" class="difflineplus">+toolbar[iconsize=&quot;small&quot;] &gt; #back-button[open] {</span>
<a href="#l85.71"></a><span id="l85.71">   -moz-image-region: rect(40px 39px 59px 20px);</span>
<a href="#l85.72"></a><span id="l85.72"> }</span>
<a href="#l85.73"></a><span id="l85.73"> </span>
<a href="#l85.74"></a><span id="l85.74" class="difflineminus">-toolbar[iconsize=&quot;small&quot;] &gt; toolbarpaletteitem &gt; #back-button[disabled=&quot;true&quot;],</span>
<a href="#l85.75"></a><span id="l85.75"> toolbar[iconsize=&quot;small&quot;] &gt; #back-button[disabled=&quot;true&quot;] {</span>
<a href="#l85.76"></a><span id="l85.76">   -moz-image-region: rect(40px 59px 59px 40px) !important;</span>
<a href="#l85.77"></a><span id="l85.77"> }</span>
<a href="#l85.78"></a><span id="l85.78"> </span>
<a href="#l85.79"></a><span id="l85.79"> toolbar[iconsize=&quot;small&quot;] &gt; toolbarpaletteitem &gt; #forward-button,</span>
<a href="#l85.80"></a><span id="l85.80"> toolbar[iconsize=&quot;small&quot;] &gt; #forward-button {</span>
<a href="#l85.81"></a><span id="l85.81">   list-style-image: url(&quot;chrome://communicator/skin/icons/communicatoricons-small.png&quot;);</span>
<a href="#l85.82"></a><span id="l85.82">   -moz-image-region: rect(60px 19px 79px 0);</span>
<a href="#l85.83"></a><span id="l85.83"> }</span>
<a href="#l85.84"></a><span id="l85.84"> </span>
<a href="#l85.85"></a><span id="l85.85" class="difflineminus">-toolbar[iconsize=&quot;small&quot;] &gt; toolbarpaletteitem &gt; #forward-button:hover:active,</span>
<a href="#l85.86"></a><span id="l85.86" class="difflineminus">-toolbar[iconsize=&quot;small&quot;] &gt; #forward-button:hover:active {</span>
<a href="#l85.87"></a><span id="l85.87" class="difflineplus">+toolbar[iconsize=&quot;small&quot;] &gt; #forward-button:hover:active,</span>
<a href="#l85.88"></a><span id="l85.88" class="difflineplus">+toolbar[iconsize=&quot;small&quot;] &gt; #forward-button[open] {</span>
<a href="#l85.89"></a><span id="l85.89">   -moz-image-region: rect(60px 39px 79px 20px);</span>
<a href="#l85.90"></a><span id="l85.90"> }</span>
<a href="#l85.91"></a><span id="l85.91"> </span>
<a href="#l85.92"></a><span id="l85.92" class="difflineminus">-toolbar[iconsize=&quot;small&quot;] &gt; toolbarpaletteitem &gt; #forward-button[disabled=&quot;true&quot;],</span>
<a href="#l85.93"></a><span id="l85.93"> toolbar[iconsize=&quot;small&quot;] &gt; #forward-button[disabled=&quot;true&quot;] {</span>
<a href="#l85.94"></a><span id="l85.94">   -moz-image-region: rect(60px 59px 79px 40px) !important;</span>
<a href="#l85.95"></a><span id="l85.95"> }</span>
<a href="#l85.96"></a><span id="l85.96"> </span>
<a href="#l85.97"></a><span id="l85.97"> toolbar[iconsize=&quot;small&quot;] &gt; toolbarpaletteitem &gt; #reload-button,</span>
<a href="#l85.98"></a><span id="l85.98"> toolbar[iconsize=&quot;small&quot;] &gt; #reload-button {</span>
<a href="#l85.99"></a><span id="l85.99">   list-style-image: url(&quot;chrome://navigator/skin/icons/navigatoricons-small.png&quot;);</span>
<a href="#l85.100"></a><span id="l85.100">   -moz-image-region: rect(0 19px 19px 0);</span>
<a href="#l85.101"></a><span id="l85.101"> }</span>
<a href="#l85.102"></a><span id="l85.102"> </span>
<a href="#l85.103"></a><span id="l85.103" class="difflineminus">-toolbar[iconsize=&quot;small&quot;] &gt; toolbarpaletteitem &gt; #reload-button:hover:active,</span>
<a href="#l85.104"></a><span id="l85.104"> toolbar[iconsize=&quot;small&quot;] &gt; #reload-button:hover:active {</span>
<a href="#l85.105"></a><span id="l85.105">   -moz-image-region: rect(0 39px 19px 20px);</span>
<a href="#l85.106"></a><span id="l85.106"> }</span>
<a href="#l85.107"></a><span id="l85.107"> </span>
<a href="#l85.108"></a><span id="l85.108" class="difflineminus">-toolbar[iconsize=&quot;small&quot;] &gt; toolbarpaletteitem &gt; #reload-button[disabled=&quot;true&quot;],</span>
<a href="#l85.109"></a><span id="l85.109"> toolbar[iconsize=&quot;small&quot;] &gt; #reload-button[disabled=&quot;true&quot;] {</span>
<a href="#l85.110"></a><span id="l85.110">   -moz-image-region: rect(0 59px 19px 40px) !important;</span>
<a href="#l85.111"></a><span id="l85.111"> }</span>
<a href="#l85.112"></a><span id="l85.112"> </span>
<a href="#l85.113"></a><span id="l85.113"> toolbar[iconsize=&quot;small&quot;] &gt; toolbarpaletteitem &gt; #stop-button,</span>
<a href="#l85.114"></a><span id="l85.114"> toolbar[iconsize=&quot;small&quot;] &gt; #stop-button {</span>
<a href="#l85.115"></a><span id="l85.115">   list-style-image: url(&quot;chrome://communicator/skin/icons/communicatoricons-small.png&quot;);</span>
<a href="#l85.116"></a><span id="l85.116">   -moz-image-region: rect(20px 19px 39px 0);</span>
<a href="#l85.117"></a><span id="l85.117"> }</span>
<a href="#l85.118"></a><span id="l85.118"> </span>
<a href="#l85.119"></a><span id="l85.119" class="difflineminus">-toolbar[iconsize=&quot;small&quot;] &gt; toolbarpaletteitem &gt; #stop-button:hover:active,</span>
<a href="#l85.120"></a><span id="l85.120"> toolbar[iconsize=&quot;small&quot;] &gt; #stop-button:hover:active {</span>
<a href="#l85.121"></a><span id="l85.121">   -moz-image-region: rect(20px 39px 39px 20px);</span>
<a href="#l85.122"></a><span id="l85.122"> }</span>
<a href="#l85.123"></a><span id="l85.123"> </span>
<a href="#l85.124"></a><span id="l85.124" class="difflineminus">-toolbar[iconsize=&quot;small&quot;] &gt; toolbarpaletteitem &gt; #stop-button[disabled=&quot;true&quot;],</span>
<a href="#l85.125"></a><span id="l85.125"> toolbar[iconsize=&quot;small&quot;] &gt; #stop-button[disabled=&quot;true&quot;] {</span>
<a href="#l85.126"></a><span id="l85.126">   -moz-image-region: rect(20px 59px 39px 40px) !important;</span>
<a href="#l85.127"></a><span id="l85.127"> }</span>
<a href="#l85.128"></a><span id="l85.128"> </span>
<a href="#l85.129"></a><span id="l85.129"> toolbar[iconsize=&quot;small&quot;] &gt; toolbarpaletteitem &gt; #print-button,</span>
<a href="#l85.130"></a><span id="l85.130"> toolbar[iconsize=&quot;small&quot;] &gt; #print-button {</span>
<a href="#l85.131"></a><span id="l85.131">   list-style-image: url(&quot;chrome://communicator/skin/icons/communicatoricons-small.png&quot;);</span>
<a href="#l85.132"></a><span id="l85.132">   -moz-image-region: rect(0 19px 19px 0);</span>
<a href="#l85.133"></a><span id="l85.133"> }</span>
<a href="#l85.134"></a><span id="l85.134"> </span>
<a href="#l85.135"></a><span id="l85.135" class="difflineminus">-toolbar[iconsize=&quot;small&quot;] &gt; toolbarpaletteitem &gt; #print-button:hover:active,</span>
<a href="#l85.136"></a><span id="l85.136" class="difflineminus">-toolbar[iconsize=&quot;small&quot;] &gt; #print-button:hover:active {</span>
<a href="#l85.137"></a><span id="l85.137" class="difflineplus">+toolbar[iconsize=&quot;small&quot;] &gt; #print-button:hover:active,</span>
<a href="#l85.138"></a><span id="l85.138" class="difflineplus">+toolbar[iconsize=&quot;small&quot;] &gt; #print-button[open] {</span>
<a href="#l85.139"></a><span id="l85.139">   -moz-image-region: rect(0 39px 19px 20px);</span>
<a href="#l85.140"></a><span id="l85.140"> }</span>
<a href="#l85.141"></a><span id="l85.141"> </span>
<a href="#l85.142"></a><span id="l85.142" class="difflineminus">-toolbar[iconsize=&quot;small&quot;] &gt; toolbarpaletteitem &gt; #print-button[disabled=&quot;true&quot;],</span>
<a href="#l85.143"></a><span id="l85.143"> toolbar[iconsize=&quot;small&quot;] &gt; #print-button[disabled=&quot;true&quot;] {</span>
<a href="#l85.144"></a><span id="l85.144">   -moz-image-region: rect(0 59px 19px 40px) !important;</span>
<a href="#l85.145"></a><span id="l85.145"> }</span>
<a href="#l85.146"></a><span id="l85.146"> </span>
<a href="#l85.147"></a><span id="l85.147"> toolbar[iconsize=&quot;small&quot;] &gt; toolbarpaletteitem &gt; #home-button,</span>
<a href="#l85.148"></a><span id="l85.148"> toolbar[iconsize=&quot;small&quot;] &gt; #home-button {</span>
<a href="#l85.149"></a><span id="l85.149">   list-style-image: url(&quot;chrome://communicator/skin/icons/communicatoricons-small.png&quot;);</span>
<a href="#l85.150"></a><span id="l85.150">   -moz-image-region: rect(80px 19px 99px 0);</span>
<a href="#l85.151"></a><span id="l85.151"> }</span>
<a href="#l85.152"></a><span id="l85.152"> </span>
<a href="#l85.153"></a><span id="l85.153" class="difflineminus">-toolbar[iconsize=&quot;small&quot;] &gt; toolbarpaletteitem &gt; #home-button:hover:active,</span>
<a href="#l85.154"></a><span id="l85.154"> toolbar[iconsize=&quot;small&quot;] &gt; #home-button:hover:active {</span>
<a href="#l85.155"></a><span id="l85.155">   -moz-image-region: rect(80px 39px 99px 20px);</span>
<a href="#l85.156"></a><span id="l85.156"> }</span>
<a href="#l85.157"></a><span id="l85.157"> </span>
<a href="#l85.158"></a><span id="l85.158" class="difflineminus">-toolbar[iconsize=&quot;small&quot;] &gt; toolbarpaletteitem &gt; #home-button[disabled=&quot;true&quot;],</span>
<a href="#l85.159"></a><span id="l85.159"> toolbar[iconsize=&quot;small&quot;] &gt; #home-button[disabled=&quot;true&quot;] {</span>
<a href="#l85.160"></a><span id="l85.160">   -moz-image-region: rect(80px 59px 99px 40px) !important;</span>
<a href="#l85.161"></a><span id="l85.161"> }</span>
<a href="#l85.162"></a><span id="l85.162"> </span>
<a href="#l85.163"></a><span id="l85.163"> /* ::::: fullscreen window controls ::::: */</span>
<a href="#l85.164"></a><span id="l85.164"> </span>
<a href="#l85.165"></a><span id="l85.165"> #window-controls {</span>
<a href="#l85.166"></a><span id="l85.166">   -moz-box-align: center;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l86.1"></a><span id="l86.1" class="difflineminus">--- a/suite/themes/modern/communicator/preferences.css</span>
<a href="#l86.2"></a><span id="l86.2" class="difflineplus">+++ b/suite/themes/modern/communicator/preferences.css</span>
<a href="#l86.3"></a><span id="l86.3" class="difflineat">@@ -44,47 +44,8 @@</span>
<a href="#l86.4"></a><span id="l86.4"> prefwindow {</span>
<a href="#l86.5"></a><span id="l86.5">   padding: 7px 5px 5px;</span>
<a href="#l86.6"></a><span id="l86.6"> }</span>
<a href="#l86.7"></a><span id="l86.7"> </span>
<a href="#l86.8"></a><span id="l86.8"> prefpane,</span>
<a href="#l86.9"></a><span id="l86.9"> .prefWindow-dlgbuttons {</span>
<a href="#l86.10"></a><span id="l86.10">   padding: 0px;</span>
<a href="#l86.11"></a><span id="l86.11"> }</span>
<a href="#l86.12"></a><span id="l86.12" class="difflineminus">-</span>
<a href="#l86.13"></a><span id="l86.13" class="difflineminus">-/* File Field Widget */</span>
<a href="#l86.14"></a><span id="l86.14" class="difflineminus">-filefield {</span>
<a href="#l86.15"></a><span id="l86.15" class="difflineminus">-  margin: 2px 4px;</span>
<a href="#l86.16"></a><span id="l86.16" class="difflineminus">-  border: 2px solid;</span>
<a href="#l86.17"></a><span id="l86.17" class="difflineminus">-  -moz-border-top-colors: #BEC3D3 #5D616E;</span>
<a href="#l86.18"></a><span id="l86.18" class="difflineminus">-  -moz-border-right-colors: #F8FAFE #5D616E;</span>
<a href="#l86.19"></a><span id="l86.19" class="difflineminus">-  -moz-border-bottom-colors: #F8FAFE #5D616E;</span>
<a href="#l86.20"></a><span id="l86.20" class="difflineminus">-  -moz-border-left-colors: #BEC3D3 #5D616E;</span>
<a href="#l86.21"></a><span id="l86.21" class="difflineminus">-}</span>
<a href="#l86.22"></a><span id="l86.22" class="difflineminus">-</span>
<a href="#l86.23"></a><span id="l86.23" class="difflineminus">-.fileFieldContentBox {</span>
<a href="#l86.24"></a><span id="l86.24" class="difflineminus">-  background-color: #C7D0D9;</span>
<a href="#l86.25"></a><span id="l86.25" class="difflineminus">-}</span>
<a href="#l86.26"></a><span id="l86.26" class="difflineminus">-</span>
<a href="#l86.27"></a><span id="l86.27" class="difflineminus">-filefield[disabled=&quot;true&quot;] {</span>
<a href="#l86.28"></a><span id="l86.28" class="difflineminus">-  -moz-border-top-colors: #BEC3D3 #98A5B2;</span>
<a href="#l86.29"></a><span id="l86.29" class="difflineminus">-  -moz-border-right-colors: #F8FAFE #98A5B2;</span>
<a href="#l86.30"></a><span id="l86.30" class="difflineminus">-  -moz-border-bottom-colors: #F8FAFE #98A5B2;</span>
<a href="#l86.31"></a><span id="l86.31" class="difflineminus">-  -moz-border-left-colors: #BEC3D3 #98A5B2;</span>
<a href="#l86.32"></a><span id="l86.32" class="difflineminus">-}</span>
<a href="#l86.33"></a><span id="l86.33" class="difflineminus">-</span>
<a href="#l86.34"></a><span id="l86.34" class="difflineminus">-.fileFieldIcon[disabled=&quot;true&quot;] {</span>
<a href="#l86.35"></a><span id="l86.35" class="difflineminus">- opacity: 0.4;</span>
<a href="#l86.36"></a><span id="l86.36" class="difflineminus">-}</span>
<a href="#l86.37"></a><span id="l86.37" class="difflineminus">-</span>
<a href="#l86.38"></a><span id="l86.38" class="difflineminus">-.fileFieldIcon {</span>
<a href="#l86.39"></a><span id="l86.39" class="difflineminus">-  width: 16px;</span>
<a href="#l86.40"></a><span id="l86.40" class="difflineminus">-  height: 16px;</span>
<a href="#l86.41"></a><span id="l86.41" class="difflineminus">-  margin-top: 1px;</span>
<a href="#l86.42"></a><span id="l86.42" class="difflineminus">-  margin-bottom: 1px;</span>
<a href="#l86.43"></a><span id="l86.43" class="difflineminus">-  -moz-margin-start: 1px;</span>
<a href="#l86.44"></a><span id="l86.44" class="difflineminus">-  -moz-margin-end: 4px;</span>
<a href="#l86.45"></a><span id="l86.45" class="difflineminus">-}</span>
<a href="#l86.46"></a><span id="l86.46" class="difflineminus">-</span>
<a href="#l86.47"></a><span id="l86.47" class="difflineminus">-.fileFieldLabel {</span>
<a href="#l86.48"></a><span id="l86.48" class="difflineminus">-  border: none;</span>
<a href="#l86.49"></a><span id="l86.49" class="difflineminus">-  margin: 0px;</span>
<a href="#l86.50"></a><span id="l86.50" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l87.1"></a><span id="l87.1">copy from suite/themes/modern/communicator/preferences.css</span>
<a href="#l87.2"></a><span id="l87.2">copy to suite/themes/modern/global/filefield.css</span>
<a href="#l87.3"></a><span id="l87.3" class="difflineminus">--- a/suite/themes/modern/communicator/preferences.css</span>
<a href="#l87.4"></a><span id="l87.4" class="difflineplus">+++ b/suite/themes/modern/global/filefield.css</span>
<a href="#l87.5"></a><span id="l87.5" class="difflineat">@@ -6,55 +6,41 @@</span>
<a href="#l87.6"></a><span id="l87.6">  * the License. You may obtain a copy of the License at</span>
<a href="#l87.7"></a><span id="l87.7">  * http://www.mozilla.org/MPL/</span>
<a href="#l87.8"></a><span id="l87.8">  *</span>
<a href="#l87.9"></a><span id="l87.9">  * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l87.10"></a><span id="l87.10">  * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l87.11"></a><span id="l87.11">  * for the specific language governing rights and limitations under the</span>
<a href="#l87.12"></a><span id="l87.12">  * License.</span>
<a href="#l87.13"></a><span id="l87.13">  *</span>
<a href="#l87.14"></a><span id="l87.14" class="difflineminus">- * The Original Code is SeaMonkey prefwindow code.</span>
<a href="#l87.15"></a><span id="l87.15" class="difflineplus">+ * The Original Code is SeaMonkey filefield code.</span>
<a href="#l87.16"></a><span id="l87.16">  *</span>
<a href="#l87.17"></a><span id="l87.17">  * The Initial Developer of the Original Code is the SeaMonkey project.</span>
<a href="#l87.18"></a><span id="l87.18" class="difflineminus">- * Portions created by the Initial Developer are Copyright (C) 2007</span>
<a href="#l87.19"></a><span id="l87.19" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l87.20"></a><span id="l87.20">  * the Initial Developer. All Rights Reserved.</span>
<a href="#l87.21"></a><span id="l87.21">  *</span>
<a href="#l87.22"></a><span id="l87.22">  * Contributor(s):</span>
<a href="#l87.23"></a><span id="l87.23" class="difflineminus">- *   Karsten DÃ¼sterloh &lt;mnyromyr@tprac.de&gt;</span>
<a href="#l87.24"></a><span id="l87.24">  *   Ian Neal &lt;iann_bugzilla@blueyonder.co.uk&gt;</span>
<a href="#l87.25"></a><span id="l87.25">  *</span>
<a href="#l87.26"></a><span id="l87.26">  * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l87.27"></a><span id="l87.27">  * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l87.28"></a><span id="l87.28">  * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l87.29"></a><span id="l87.29">  * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l87.30"></a><span id="l87.30">  * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l87.31"></a><span id="l87.31">  * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l87.32"></a><span id="l87.32">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l87.33"></a><span id="l87.33">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l87.34"></a><span id="l87.34">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l87.35"></a><span id="l87.35">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l87.36"></a><span id="l87.36">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l87.37"></a><span id="l87.37">  *</span>
<a href="#l87.38"></a><span id="l87.38">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l87.39"></a><span id="l87.39"> </span>
<a href="#l87.40"></a><span id="l87.40" class="difflineminus">-/* Styles used by all preference windows and panes of SeaMonkey */</span>
<a href="#l87.41"></a><span id="l87.41" class="difflineminus">-</span>
<a href="#l87.42"></a><span id="l87.42"> @namespace url(&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;);</span>
<a href="#l87.43"></a><span id="l87.43"> </span>
<a href="#l87.44"></a><span id="l87.44" class="difflineminus">-/* ::::: Main Window ::::: */</span>
<a href="#l87.45"></a><span id="l87.45" class="difflineminus">-</span>
<a href="#l87.46"></a><span id="l87.46" class="difflineminus">-prefwindow {</span>
<a href="#l87.47"></a><span id="l87.47" class="difflineminus">-  padding: 7px 5px 5px;</span>
<a href="#l87.48"></a><span id="l87.48" class="difflineminus">-}</span>
<a href="#l87.49"></a><span id="l87.49" class="difflineminus">-</span>
<a href="#l87.50"></a><span id="l87.50" class="difflineminus">-prefpane,</span>
<a href="#l87.51"></a><span id="l87.51" class="difflineminus">-.prefWindow-dlgbuttons {</span>
<a href="#l87.52"></a><span id="l87.52" class="difflineminus">-  padding: 0px;</span>
<a href="#l87.53"></a><span id="l87.53" class="difflineminus">-}</span>
<a href="#l87.54"></a><span id="l87.54" class="difflineminus">-</span>
<a href="#l87.55"></a><span id="l87.55"> /* File Field Widget */</span>
<a href="#l87.56"></a><span id="l87.56"> filefield {</span>
<a href="#l87.57"></a><span id="l87.57">   margin: 2px 4px;</span>
<a href="#l87.58"></a><span id="l87.58">   border: 2px solid;</span>
<a href="#l87.59"></a><span id="l87.59">   -moz-border-top-colors: #BEC3D3 #5D616E;</span>
<a href="#l87.60"></a><span id="l87.60">   -moz-border-right-colors: #F8FAFE #5D616E;</span>
<a href="#l87.61"></a><span id="l87.61">   -moz-border-bottom-colors: #F8FAFE #5D616E;</span>
<a href="#l87.62"></a><span id="l87.62">   -moz-border-left-colors: #BEC3D3 #5D616E;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l88.1"></a><span id="l88.1" class="difflineminus">--- a/suite/themes/modern/global/scrollbox.css</span>
<a href="#l88.2"></a><span id="l88.2" class="difflineplus">+++ b/suite/themes/modern/global/scrollbox.css</span>
<a href="#l88.3"></a><span id="l88.3" class="difflineat">@@ -37,37 +37,92 @@</span>
<a href="#l88.4"></a><span id="l88.4"> </span>
<a href="#l88.5"></a><span id="l88.5"> /* ===== arrowscrollbox.css =============================================</span>
<a href="#l88.6"></a><span id="l88.6">   == Styles used by the XUL arrowscrollbox and related elements.</span>
<a href="#l88.7"></a><span id="l88.7">   ======================================================================= */</span>
<a href="#l88.8"></a><span id="l88.8"> </span>
<a href="#l88.9"></a><span id="l88.9"> @namespace url(&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;);</span>
<a href="#l88.10"></a><span id="l88.10"> </span>
<a href="#l88.11"></a><span id="l88.11"> /* ::::: auto-repeat button ::::: */</span>
<a href="#l88.12"></a><span id="l88.12" class="difflineminus">- </span>
<a href="#l88.13"></a><span id="l88.13" class="difflineplus">+</span>
<a href="#l88.14"></a><span id="l88.14"> autorepeatbutton {</span>
<a href="#l88.15"></a><span id="l88.15">   -moz-box-align: center;</span>
<a href="#l88.16"></a><span id="l88.16">   -moz-box-pack: center;</span>
<a href="#l88.17"></a><span id="l88.17">   margin-top: 1px;</span>
<a href="#l88.18"></a><span id="l88.18">   margin-bottom: 2px;</span>
<a href="#l88.19"></a><span id="l88.19">   -moz-margin-start: 1px;</span>
<a href="#l88.20"></a><span id="l88.20">   -moz-margin-end: 2px;</span>
<a href="#l88.21"></a><span id="l88.21">   border: 1px solid transparent;</span>
<a href="#l88.22"></a><span id="l88.22">   padding: 3px;</span>
<a href="#l88.23"></a><span id="l88.23"> }</span>
<a href="#l88.24"></a><span id="l88.24"> </span>
<a href="#l88.25"></a><span id="l88.25" class="difflineminus">-autorepeatbutton:hover {</span>
<a href="#l88.26"></a><span id="l88.26" class="difflineplus">+autorepeatbutton:not([disabled=&quot;true&quot;]):hover {</span>
<a href="#l88.27"></a><span id="l88.27">   margin: 1px;</span>
<a href="#l88.28"></a><span id="l88.28">   border: 1px inset #A5B2C2;</span>
<a href="#l88.29"></a><span id="l88.29">   padding-top: 4px;</span>
<a href="#l88.30"></a><span id="l88.30">   padding-bottom: 3px;</span>
<a href="#l88.31"></a><span id="l88.31">   -moz-padding-start: 4px;</span>
<a href="#l88.32"></a><span id="l88.32">   -moz-padding-end: 3px;</span>
<a href="#l88.33"></a><span id="l88.33">   background-color: #A5B2C2;</span>
<a href="#l88.34"></a><span id="l88.34"> }</span>
<a href="#l88.35"></a><span id="l88.35"> </span>
<a href="#l88.36"></a><span id="l88.36" class="difflineminus">-.autorepeatbutton-up {</span>
<a href="#l88.37"></a><span id="l88.37" class="difflineplus">+.scrollbutton-up,</span>
<a href="#l88.38"></a><span id="l88.38" class="difflineplus">+.scrollbutton-down {</span>
<a href="#l88.39"></a><span id="l88.39" class="difflineplus">+  -moz-box-align: center;</span>
<a href="#l88.40"></a><span id="l88.40" class="difflineplus">+  -moz-box-pack: center;</span>
<a href="#l88.41"></a><span id="l88.41" class="difflineplus">+}</span>
<a href="#l88.42"></a><span id="l88.42" class="difflineplus">+</span>
<a href="#l88.43"></a><span id="l88.43" class="difflineplus">+.scrollbutton-up &gt; .toolbarbutton-text,</span>
<a href="#l88.44"></a><span id="l88.44" class="difflineplus">+.scrollbutton-down &gt; .toolbarbutton-text {</span>
<a href="#l88.45"></a><span id="l88.45" class="difflineplus">+  display: none;</span>
<a href="#l88.46"></a><span id="l88.46" class="difflineplus">+}</span>
<a href="#l88.47"></a><span id="l88.47" class="difflineplus">+</span>
<a href="#l88.48"></a><span id="l88.48" class="difflineplus">+/* Vertical enabled */</span>
<a href="#l88.49"></a><span id="l88.49" class="difflineplus">+.autorepeatbutton-up,</span>
<a href="#l88.50"></a><span id="l88.50" class="difflineplus">+.scrollbutton-up {</span>
<a href="#l88.51"></a><span id="l88.51">   list-style-image: url(&quot;chrome://global/skin/arrow/arrow-up.gif&quot;)</span>
<a href="#l88.52"></a><span id="l88.52"> }</span>
<a href="#l88.53"></a><span id="l88.53"> </span>
<a href="#l88.54"></a><span id="l88.54" class="difflineminus">-.autorepeatbutton-down {</span>
<a href="#l88.55"></a><span id="l88.55" class="difflineplus">+.autorepeatbutton-down,</span>
<a href="#l88.56"></a><span id="l88.56" class="difflineplus">+.scrollbutton-down {</span>
<a href="#l88.57"></a><span id="l88.57">   list-style-image: url(&quot;chrome://global/skin/arrow/arrow-dn.gif&quot;)</span>
<a href="#l88.58"></a><span id="l88.58"> }</span>
<a href="#l88.59"></a><span id="l88.59" class="difflineplus">+</span>
<a href="#l88.60"></a><span id="l88.60" class="difflineplus">+/* Vertical disabled */</span>
<a href="#l88.61"></a><span id="l88.61" class="difflineplus">+.autorepeatbutton-up[disabled=&quot;true&quot;],</span>
<a href="#l88.62"></a><span id="l88.62" class="difflineplus">+.scrollbutton-up[disabled=&quot;true&quot;] {</span>
<a href="#l88.63"></a><span id="l88.63" class="difflineplus">+  list-style-image: url(&quot;chrome://global/skin/arrow/arrow-up-dis.gif&quot;);</span>
<a href="#l88.64"></a><span id="l88.64" class="difflineplus">+}</span>
<a href="#l88.65"></a><span id="l88.65" class="difflineplus">+</span>
<a href="#l88.66"></a><span id="l88.66" class="difflineplus">+.autorepeatbutton-down[disabled=&quot;true&quot;],</span>
<a href="#l88.67"></a><span id="l88.67" class="difflineplus">+.scrollbutton-down[disabled=&quot;true&quot;] {</span>
<a href="#l88.68"></a><span id="l88.68" class="difflineplus">+  list-style-image: url(&quot;chrome://global/skin/arrow/arrow-dn-dis.gif&quot;);</span>
<a href="#l88.69"></a><span id="l88.69" class="difflineplus">+}</span>
<a href="#l88.70"></a><span id="l88.70" class="difflineplus">+</span>
<a href="#l88.71"></a><span id="l88.71" class="difflineplus">+/* Horizontal enabled */</span>
<a href="#l88.72"></a><span id="l88.72" class="difflineplus">+.autorepeatbutton-up[orient=&quot;horizontal&quot;],</span>
<a href="#l88.73"></a><span id="l88.73" class="difflineplus">+.autorepeatbutton-down[orient=&quot;horizontal&quot;][chromedir=&quot;rtl&quot;],</span>
<a href="#l88.74"></a><span id="l88.74" class="difflineplus">+.scrollbutton-up[orient=&quot;horizontal&quot;],</span>
<a href="#l88.75"></a><span id="l88.75" class="difflineplus">+.scrollbutton-down[orient=&quot;horizontal&quot;][chromedir=&quot;rtl&quot;] {</span>
<a href="#l88.76"></a><span id="l88.76" class="difflineplus">+  list-style-image: url(&quot;chrome://global/skin/arrow/arrow-lft.gif&quot;);</span>
<a href="#l88.77"></a><span id="l88.77" class="difflineplus">+}</span>
<a href="#l88.78"></a><span id="l88.78" class="difflineplus">+</span>
<a href="#l88.79"></a><span id="l88.79" class="difflineplus">+.autorepeatbutton-down[orient=&quot;horizontal&quot;],</span>
<a href="#l88.80"></a><span id="l88.80" class="difflineplus">+.autorepeatbutton-up[orient=&quot;horizontal&quot;][chromedir=&quot;rtl&quot;],</span>
<a href="#l88.81"></a><span id="l88.81" class="difflineplus">+.scrollbutton-down[orient=&quot;horizontal&quot;],</span>
<a href="#l88.82"></a><span id="l88.82" class="difflineplus">+.scrollbutton-up[orient=&quot;horizontal&quot;][chromedir=&quot;rtl&quot;] {</span>
<a href="#l88.83"></a><span id="l88.83" class="difflineplus">+  list-style-image: url(&quot;chrome://global/skin/arrow/arrow-rit.gif&quot;);</span>
<a href="#l88.84"></a><span id="l88.84" class="difflineplus">+}</span>
<a href="#l88.85"></a><span id="l88.85" class="difflineplus">+</span>
<a href="#l88.86"></a><span id="l88.86" class="difflineplus">+ /* Horizontal disabled */</span>
<a href="#l88.87"></a><span id="l88.87" class="difflineplus">+.autorepeatbutton-up[orient=&quot;horizontal&quot;][disabled=&quot;true&quot;],</span>
<a href="#l88.88"></a><span id="l88.88" class="difflineplus">+.autorepeatbutton-down[orient=&quot;horizontal&quot;][chromedir=&quot;rtl&quot;][disabled=&quot;true&quot;],</span>
<a href="#l88.89"></a><span id="l88.89" class="difflineplus">+.scrollbutton-up[orient=&quot;horizontal&quot;][disabled=&quot;true&quot;],</span>
<a href="#l88.90"></a><span id="l88.90" class="difflineplus">+.scrollbutton-down[orient=&quot;horizontal&quot;][chromedir=&quot;rtl&quot;][disabled=&quot;true&quot;] {</span>
<a href="#l88.91"></a><span id="l88.91" class="difflineplus">+  list-style-image: url(&quot;chrome://global/skin/arrow/arrow-lft-dis.gif&quot;);</span>
<a href="#l88.92"></a><span id="l88.92" class="difflineplus">+}</span>
<a href="#l88.93"></a><span id="l88.93" class="difflineplus">+</span>
<a href="#l88.94"></a><span id="l88.94" class="difflineplus">+.autorepeatbutton-down[orient=&quot;horizontal&quot;][disabled=&quot;true&quot;],</span>
<a href="#l88.95"></a><span id="l88.95" class="difflineplus">+.autorepeatbutton-up[orient=&quot;horizontal&quot;][chromedir=&quot;rtl&quot;][disabled=&quot;true&quot;],</span>
<a href="#l88.96"></a><span id="l88.96" class="difflineplus">+.scrollbutton-down[orient=&quot;horizontal&quot;][disabled=&quot;true&quot;],</span>
<a href="#l88.97"></a><span id="l88.97" class="difflineplus">+.scrollbutton-up[orient=&quot;horizontal&quot;][chromedir=&quot;rtl&quot;][disabled=&quot;true&quot;] {</span>
<a href="#l88.98"></a><span id="l88.98" class="difflineplus">+  list-style-image: url(&quot;chrome://global/skin/arrow/arrow-rit-dis.gif&quot;);</span>
<a href="#l88.99"></a><span id="l88.99" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l89.1"></a><span id="l89.1" class="difflineminus">--- a/suite/themes/modern/global/textbox.css</span>
<a href="#l89.2"></a><span id="l89.2" class="difflineplus">+++ b/suite/themes/modern/global/textbox.css</span>
<a href="#l89.3"></a><span id="l89.3" class="difflineat">@@ -35,17 +35,17 @@</span>
<a href="#l89.4"></a><span id="l89.4">  *</span>
<a href="#l89.5"></a><span id="l89.5">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l89.6"></a><span id="l89.6"> </span>
<a href="#l89.7"></a><span id="l89.7"> /* ===== textbox.css ==================================================</span>
<a href="#l89.8"></a><span id="l89.8">   == Styles used by the XUL textbox element.</span>
<a href="#l89.9"></a><span id="l89.9">   ======================================================================= */</span>
<a href="#l89.10"></a><span id="l89.10"> </span>
<a href="#l89.11"></a><span id="l89.11"> @import url(&quot;chrome://global/content/autocomplete.css&quot;);</span>
<a href="#l89.12"></a><span id="l89.12" class="difflineminus">-  </span>
<a href="#l89.13"></a><span id="l89.13" class="difflineplus">+</span>
<a href="#l89.14"></a><span id="l89.14"> @namespace url(&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;);</span>
<a href="#l89.15"></a><span id="l89.15"> @namespace html url(&quot;http://www.w3.org/1999/xhtml&quot;); /* namespace for HTML elements */</span>
<a href="#l89.16"></a><span id="l89.16"> </span>
<a href="#l89.17"></a><span id="l89.17"> /* ::::: textbox ::::: */</span>
<a href="#l89.18"></a><span id="l89.18"> </span>
<a href="#l89.19"></a><span id="l89.19"> textbox {</span>
<a href="#l89.20"></a><span id="l89.20">   margin: 2px 4px;</span>
<a href="#l89.21"></a><span id="l89.21">   border: 2px solid;</span>
<a href="#l89.22"></a><span id="l89.22" class="difflineat">@@ -53,56 +53,61 @@ textbox {</span>
<a href="#l89.23"></a><span id="l89.23">   padding-bottom: 1px;</span>
<a href="#l89.24"></a><span id="l89.24">   -moz-padding-start: 2px;</span>
<a href="#l89.25"></a><span id="l89.25">   -moz-padding-end: 0px;</span>
<a href="#l89.26"></a><span id="l89.26">   background-color: #FFFFFF;</span>
<a href="#l89.27"></a><span id="l89.27">   color: #000000;</span>
<a href="#l89.28"></a><span id="l89.28">   font: inherit;</span>
<a href="#l89.29"></a><span id="l89.29"> }</span>
<a href="#l89.30"></a><span id="l89.30"> </span>
<a href="#l89.31"></a><span id="l89.31" class="difflineplus">+textbox[empty=&quot;true&quot;],</span>
<a href="#l89.32"></a><span id="l89.32" class="difflineplus">+textbox[isempty=&quot;true&quot;] {</span>
<a href="#l89.33"></a><span id="l89.33" class="difflineplus">+  color: #999999;</span>
<a href="#l89.34"></a><span id="l89.34" class="difflineplus">+}</span>
<a href="#l89.35"></a><span id="l89.35" class="difflineplus">+</span>
<a href="#l89.36"></a><span id="l89.36"> textbox,</span>
<a href="#l89.37"></a><span id="l89.37"> textbox[readonly=&quot;true&quot;][focused=&quot;true&quot;] {</span>
<a href="#l89.38"></a><span id="l89.38">   -moz-border-top-colors: #BEC3D3 #5D616E;</span>
<a href="#l89.39"></a><span id="l89.39">   -moz-border-right-colors: #F8FAFE #5D616E;</span>
<a href="#l89.40"></a><span id="l89.40">   -moz-border-bottom-colors: #F8FAFE #5D616E;</span>
<a href="#l89.41"></a><span id="l89.41">   -moz-border-left-colors: #BEC3D3 #5D616E;</span>
<a href="#l89.42"></a><span id="l89.42"> }</span>
<a href="#l89.43"></a><span id="l89.43"> </span>
<a href="#l89.44"></a><span id="l89.44" class="difflineminus">-html|*.textbox-input, </span>
<a href="#l89.45"></a><span id="l89.45" class="difflineplus">+html|*.textbox-input,</span>
<a href="#l89.46"></a><span id="l89.46"> html|*.textbox-textarea {</span>
<a href="#l89.47"></a><span id="l89.47">   cursor: text;</span>
<a href="#l89.48"></a><span id="l89.48">   margin: 0px !important;</span>
<a href="#l89.49"></a><span id="l89.49">   border: none !important;</span>
<a href="#l89.50"></a><span id="l89.50">   padding: 0px !important;</span>
<a href="#l89.51"></a><span id="l89.51">   background-color: inherit;</span>
<a href="#l89.52"></a><span id="l89.52">   color: inherit;</span>
<a href="#l89.53"></a><span id="l89.53">   font: inherit;</span>
<a href="#l89.54"></a><span id="l89.54"> }</span>
<a href="#l89.55"></a><span id="l89.55"> </span>
<a href="#l89.56"></a><span id="l89.56"> /* ..... focused state ..... */</span>
<a href="#l89.57"></a><span id="l89.57" class="difflineminus">-  </span>
<a href="#l89.58"></a><span id="l89.58" class="difflineplus">+</span>
<a href="#l89.59"></a><span id="l89.59"> textbox[focused=&quot;true&quot;] {</span>
<a href="#l89.60"></a><span id="l89.60">   -moz-border-top-colors: #98A5B2 #000000;</span>
<a href="#l89.61"></a><span id="l89.61">   -moz-border-right-colors: #98A5B2 #000000;</span>
<a href="#l89.62"></a><span id="l89.62">   -moz-border-bottom-colors: #98A5B2 #000000;</span>
<a href="#l89.63"></a><span id="l89.63">   -moz-border-left-colors: #98A5B2 #000000;</span>
<a href="#l89.64"></a><span id="l89.64"> }</span>
<a href="#l89.65"></a><span id="l89.65" class="difflineminus">-    </span>
<a href="#l89.66"></a><span id="l89.66" class="difflineplus">+</span>
<a href="#l89.67"></a><span id="l89.67"> /* ..... disabled state ..... */</span>
<a href="#l89.68"></a><span id="l89.68"> </span>
<a href="#l89.69"></a><span id="l89.69"> textbox[disabled=&quot;true&quot;] {</span>
<a href="#l89.70"></a><span id="l89.70">   -moz-border-top-colors: #BEC3D3 #98A5B2;</span>
<a href="#l89.71"></a><span id="l89.71">   -moz-border-right-colors: #F8FAFE #98A5B2;</span>
<a href="#l89.72"></a><span id="l89.72">   -moz-border-bottom-colors: #F8FAFE #98A5B2;</span>
<a href="#l89.73"></a><span id="l89.73">   -moz-border-left-colors: #BEC3D3 #98A5B2;</span>
<a href="#l89.74"></a><span id="l89.74">   background-color: #C7D0D9;</span>
<a href="#l89.75"></a><span id="l89.75">   color: #999999;</span>
<a href="#l89.76"></a><span id="l89.76">   cursor: default !important;</span>
<a href="#l89.77"></a><span id="l89.77" class="difflineminus">-} </span>
<a href="#l89.78"></a><span id="l89.78" class="difflineminus">-    </span>
<a href="#l89.79"></a><span id="l89.79" class="difflineplus">+}</span>
<a href="#l89.80"></a><span id="l89.80" class="difflineplus">+</span>
<a href="#l89.81"></a><span id="l89.81"> /* ..... readonly state ..... */</span>
<a href="#l89.82"></a><span id="l89.82"> </span>
<a href="#l89.83"></a><span id="l89.83"> textbox[readonly=&quot;true&quot;] {</span>
<a href="#l89.84"></a><span id="l89.84">   background-color: #C7D0D9;</span>
<a href="#l89.85"></a><span id="l89.85"> }</span>
<a href="#l89.86"></a><span id="l89.86"> </span>
<a href="#l89.87"></a><span id="l89.87"> /* ::::: plain textbox ::::: */</span>
<a href="#l89.88"></a><span id="l89.88"> </span>
<a href="#l89.89"></a><span id="l89.89" class="difflineat">@@ -123,25 +128,31 @@ textbox.plain {</span>
<a href="#l89.90"></a><span id="l89.90">   list-style-image: url(&quot;chrome://global/skin/icons/closebox.gif&quot;);</span>
<a href="#l89.91"></a><span id="l89.91"> }</span>
<a href="#l89.92"></a><span id="l89.92"> </span>
<a href="#l89.93"></a><span id="l89.93"> /* ::::: scrollable textbox ::::: */</span>
<a href="#l89.94"></a><span id="l89.94"> </span>
<a href="#l89.95"></a><span id="l89.95"> .scrollfield {</span>
<a href="#l89.96"></a><span id="l89.96">   border: none !important;</span>
<a href="#l89.97"></a><span id="l89.97">   margin: 0px;</span>
<a href="#l89.98"></a><span id="l89.98" class="difflineminus">-  margin-top: 1px;      </span>
<a href="#l89.99"></a><span id="l89.99" class="difflineplus">+  margin-top: 1px;</span>
<a href="#l89.100"></a><span id="l89.100">   padding: 0px !important;</span>
<a href="#l89.101"></a><span id="l89.101">   background: inherit;</span>
<a href="#l89.102"></a><span id="l89.102" class="difflineminus">-}    </span>
<a href="#l89.103"></a><span id="l89.103" class="difflineminus">-    </span>
<a href="#l89.104"></a><span id="l89.104" class="difflineplus">+}</span>
<a href="#l89.105"></a><span id="l89.105" class="difflineplus">+</span>
<a href="#l89.106"></a><span id="l89.106"> .scrollfield &gt; .textbox-internal-box {</span>
<a href="#l89.107"></a><span id="l89.107">   border: none !important;</span>
<a href="#l89.108"></a><span id="l89.108">   margin: 0px !important;</span>
<a href="#l89.109"></a><span id="l89.109">   padding: 0px !important;</span>
<a href="#l89.110"></a><span id="l89.110"> }</span>
<a href="#l89.111"></a><span id="l89.111"> </span>
<a href="#l89.112"></a><span id="l89.112"> /* ::::: inline-edit textbox ::::: */</span>
<a href="#l89.113"></a><span id="l89.113" class="difflineminus">-    </span>
<a href="#l89.114"></a><span id="l89.114" class="difflineplus">+</span>
<a href="#l89.115"></a><span id="l89.115"> .textbox-inline-edit {</span>
<a href="#l89.116"></a><span id="l89.116">   margin: 0px !important;</span>
<a href="#l89.117"></a><span id="l89.117">   border: 1px solid #000000 !important;</span>
<a href="#l89.118"></a><span id="l89.118"> }</span>
<a href="#l89.119"></a><span id="l89.119" class="difflineplus">+</span>
<a href="#l89.120"></a><span id="l89.120" class="difflineplus">+/* ::::: textboxes inside toolbarpaletteitems ::::: */</span>
<a href="#l89.121"></a><span id="l89.121" class="difflineplus">+</span>
<a href="#l89.122"></a><span id="l89.122" class="difflineplus">+toolbarpaletteitem &gt; toolbaritem &gt; textbox &gt; .textbox-input-box &gt; html|*.textbox-input {</span>
<a href="#l89.123"></a><span id="l89.123" class="difflineplus">+  visibility: hidden;</span>
<a href="#l89.124"></a><span id="l89.124" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l90.1"></a><span id="l90.1" class="difflineminus">--- a/suite/themes/modern/global/wizard.css</span>
<a href="#l90.2"></a><span id="l90.2" class="difflineplus">+++ b/suite/themes/modern/global/wizard.css</span>
<a href="#l90.3"></a><span id="l90.3" class="difflineat">@@ -31,35 +31,57 @@</span>
<a href="#l90.4"></a><span id="l90.4">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l90.5"></a><span id="l90.5">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l90.6"></a><span id="l90.6">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l90.7"></a><span id="l90.7">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l90.8"></a><span id="l90.8">  *</span>
<a href="#l90.9"></a><span id="l90.9">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l90.10"></a><span id="l90.10"> </span>
<a href="#l90.11"></a><span id="l90.11"> /* ===== wizard.css =====================================================</span>
<a href="#l90.12"></a><span id="l90.12" class="difflineminus">-  == Styles used by the wizards which contains buttons for stepping </span>
<a href="#l90.13"></a><span id="l90.13" class="difflineplus">+  == Styles used by the wizards which contains buttons for stepping</span>
<a href="#l90.14"></a><span id="l90.14">   == through a wizard.</span>
<a href="#l90.15"></a><span id="l90.15">   ======================================================================= */</span>
<a href="#l90.16"></a><span id="l90.16"> </span>
<a href="#l90.17"></a><span id="l90.17"> @namespace url(&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;);</span>
<a href="#l90.18"></a><span id="l90.18"> </span>
<a href="#l90.19"></a><span id="l90.19"> .wizard-header {</span>
<a href="#l90.20"></a><span id="l90.20">   border-top: 1px solid #94AACE;</span>
<a href="#l90.21"></a><span id="l90.21">   border-bottom: 1px solid #000000;</span>
<a href="#l90.22"></a><span id="l90.22">   padding: 10px 0px;</span>
<a href="#l90.23"></a><span id="l90.23">   background-color: #5B7693;</span>
<a href="#l90.24"></a><span id="l90.24">   color: #ffffff;</span>
<a href="#l90.25"></a><span id="l90.25"> }</span>
<a href="#l90.26"></a><span id="l90.26"> </span>
<a href="#l90.27"></a><span id="l90.27" class="difflineplus">+.wizard-header-description[value=&quot;&quot;] {</span>
<a href="#l90.28"></a><span id="l90.28" class="difflineplus">+  display: none;</span>
<a href="#l90.29"></a><span id="l90.29" class="difflineplus">+}</span>
<a href="#l90.30"></a><span id="l90.30" class="difflineplus">+</span>
<a href="#l90.31"></a><span id="l90.31"> .wizard-header-label {</span>
<a href="#l90.32"></a><span id="l90.32">   -moz-margin-start: 23px;</span>
<a href="#l90.33"></a><span id="l90.33">   font-weight: bold;</span>
<a href="#l90.34"></a><span id="l90.34"> }</span>
<a href="#l90.35"></a><span id="l90.35"> </span>
<a href="#l90.36"></a><span id="l90.36"> .wizard-header-description {</span>
<a href="#l90.37"></a><span id="l90.37">   -moz-margin-start: 44px;</span>
<a href="#l90.38"></a><span id="l90.38">   -moz-margin-end: 5px;</span>
<a href="#l90.39"></a><span id="l90.39"> }</span>
<a href="#l90.40"></a><span id="l90.40"> </span>
<a href="#l90.41"></a><span id="l90.41"> .wizard-page-box {</span>
<a href="#l90.42"></a><span id="l90.42">   margin: 10px 44px;</span>
<a href="#l90.43"></a><span id="l90.43"> }</span>
<a href="#l90.44"></a><span id="l90.44" class="difflineplus">+</span>
<a href="#l90.45"></a><span id="l90.45" class="difflineplus">+.wizard-buttons-separator {</span>
<a href="#l90.46"></a><span id="l90.46" class="difflineplus">+  margin-bottom: 0px !important;</span>
<a href="#l90.47"></a><span id="l90.47" class="difflineplus">+}</span>
<a href="#l90.48"></a><span id="l90.48" class="difflineplus">+</span>
<a href="#l90.49"></a><span id="l90.49" class="difflineplus">+.wizard-buttons-box-2,</span>
<a href="#l90.50"></a><span id="l90.50" class="difflineplus">+.wizard-buttons-btm {</span>
<a href="#l90.51"></a><span id="l90.51" class="difflineplus">+  padding: 5px;</span>
<a href="#l90.52"></a><span id="l90.52" class="difflineplus">+}</span>
<a href="#l90.53"></a><span id="l90.53" class="difflineplus">+</span>
<a href="#l90.54"></a><span id="l90.54" class="difflineplus">+.wizard-button[dlgtype=&quot;finish&quot;],</span>
<a href="#l90.55"></a><span id="l90.55" class="difflineplus">+.wizard-button[dlgtype=&quot;next&quot;] {</span>
<a href="#l90.56"></a><span id="l90.56" class="difflineplus">+  -moz-margin-start: 0px;</span>
<a href="#l90.57"></a><span id="l90.57" class="difflineplus">+}</span>
<a href="#l90.58"></a><span id="l90.58" class="difflineplus">+</span>
<a href="#l90.59"></a><span id="l90.59" class="difflineplus">+.wizard-button[dlgtype=&quot;back&quot;] {</span>
<a href="#l90.60"></a><span id="l90.60" class="difflineplus">+  -moz-margin-end: 0px;</span>
<a href="#l90.61"></a><span id="l90.61" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l91.1"></a><span id="l91.1" class="difflineminus">--- a/suite/themes/modern/jar.mn</span>
<a href="#l91.2"></a><span id="l91.2" class="difflineplus">+++ b/suite/themes/modern/jar.mn</span>
<a href="#l91.3"></a><span id="l91.3" class="difflineat">@@ -154,16 +154,17 @@ modern.jar:</span>
<a href="#l91.4"></a><span id="l91.4">   skin/modern/global/button.css                                    (global/button.css)</span>
<a href="#l91.5"></a><span id="l91.5">   skin/modern/global/checkbox.css                                  (global/checkbox.css)</span>
<a href="#l91.6"></a><span id="l91.6">   skin/modern/global/colorpicker.css                               (global/colorpicker.css)</span>
<a href="#l91.7"></a><span id="l91.7">   skin/modern/global/config.css                                    (global/config.css)</span>
<a href="#l91.8"></a><span id="l91.8">   skin/modern/global/customizeToolbar.css                          (global/customizeToolbar.css)</span>
<a href="#l91.9"></a><span id="l91.9">   skin/modern/global/datetimepicker.css                            (global/datetimepicker.css)</span>
<a href="#l91.10"></a><span id="l91.10">   skin/modern/global/dialog.css                                    (global/dialog.css)</span>
<a href="#l91.11"></a><span id="l91.11">   skin/modern/global/dropmarker.css                                (global/dropmarker.css)</span>
<a href="#l91.12"></a><span id="l91.12" class="difflineplus">+  skin/modern/global/filefield.css                                 (global/filefield.css)</span>
<a href="#l91.13"></a><span id="l91.13">   skin/modern/global/filepicker.css                                (global/filepicker.css)</span>
<a href="#l91.14"></a><span id="l91.14">   skin/modern/global/findBar.css                                   (global/findBar.css)</span>
<a href="#l91.15"></a><span id="l91.15">   skin/modern/global/global.css                                    (global/global.css)</span>
<a href="#l91.16"></a><span id="l91.16">   skin/modern/global/groupbox.css                                  (global/groupbox.css)</span>
<a href="#l91.17"></a><span id="l91.17">   skin/modern/global/listbox.css                                   (global/listbox.css)</span>
<a href="#l91.18"></a><span id="l91.18">   skin/modern/global/menu.css                                      (global/menu.css)</span>
<a href="#l91.19"></a><span id="l91.19">   skin/modern/global/menulist.css                                  (global/menulist.css)</span>
<a href="#l91.20"></a><span id="l91.20">   skin/modern/global/numberbox.css                                 (global/numberbox.css)</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

