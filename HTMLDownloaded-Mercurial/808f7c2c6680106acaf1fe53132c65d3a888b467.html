<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 29004:808f7c2c6680106acaf1fe53132c65d3a888b467</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 808f7c2c6680106acaf1fe53132c65d3a888b467" />
<meta property="og:url" content="/comm-central/rev/808f7c2c6680106acaf1fe53132c65d3a888b467" />
<meta property="og:description" content="Bug 1621841 - Update extensions prompts code to match Firefox. r=mkmelin" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 808f7c2c6680106acaf1fe53132c65d3a888b467 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/808f7c2c6680106acaf1fe53132c65d3a888b467">shortlog</a> |
<a href="/comm-central/log/808f7c2c6680106acaf1fe53132c65d3a888b467">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/808f7c2c6680106acaf1fe53132c65d3a888b467">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/808f7c2c6680106acaf1fe53132c65d3a888b467">files</a> |
changeset |
<a href="/comm-central/raw-rev/808f7c2c6680106acaf1fe53132c65d3a888b467">raw</a>  | <a href="/comm-central/archive/808f7c2c6680106acaf1fe53132c65d3a888b467.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1621841">Bug 1621841</a> - Update extensions prompts code to match Firefox. r=mkmelin
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#71;&#101;&#111;&#102;&#102;&#32;&#76;&#97;&#110;&#107;&#111;&#119;&#32;&#60;&#103;&#101;&#111;&#102;&#102;&#64;&#100;&#97;&#114;&#107;&#116;&#114;&#111;&#106;&#97;&#110;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 12 Mar 2020 15:48:21 +1300</td></tr>

<tr>
 <td>changeset 29004</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/808f7c2c6680106acaf1fe53132c65d3a888b467">808f7c2c6680106acaf1fe53132c65d3a888b467</a></td>
</tr>



<tr>
<td>parent 29003</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/2895f182a2d0a33359d755be5c5469e08e4795fb">2895f182a2d0a33359d755be5c5469e08e4795fb</a>
</td>
</tr>

<tr>
<td>child 29005</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/e3d50753c9d8a8ed8d5f65c14460267155ac4ec6">e3d50753c9d8a8ed8d5f65c14460267155ac4ec6</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=808f7c2c6680106acaf1fe53132c65d3a888b467">17151</a></td></tr>
<tr><td>push user</td><td>geoff@darktrojan.net</td></tr>
<tr><td>push date</td><td class="date age">Tue, 17 Mar 2020 22:05:59 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@a12bb1124869 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=a12bb1124869bc1562cf3763e1c8f59113c0cc2c">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=a12bb1124869bc1562cf3763e1c8f59113c0cc2c&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a12bb1124869bc1562cf3763e1c8f59113c0cc2c&newProject=comm-central&newRevision=808f7c2c6680106acaf1fe53132c65d3a888b467&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a12bb1124869bc1562cf3763e1c8f59113c0cc2c&newProject=comm-central&newRevision=808f7c2c6680106acaf1fe53132c65d3a888b467&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a12bb1124869bc1562cf3763e1c8f59113c0cc2c&newProject=comm-central&newRevision=808f7c2c6680106acaf1fe53132c65d3a888b467&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mkmelin%29&revcount=50">mkmelin</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1621841">1621841</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1621841">Bug 1621841</a> - Update extensions prompts code to match Firefox. r=mkmelin

This brings our code up-to-date with mozilla-central's ExtensionsUI.jsm and
browser-addons.js. I've pulled apart the implementations of gXPInstallObserver
and ExtensionsUI which were combined previously due to a lot of overlap. This
turned out to be a mistake from a maintainability point of view.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/808f7c2c6680106acaf1fe53132c65d3a888b467/mail/base/content/mainMailToolbox.inc.xhtml">mail/base/content/mainMailToolbox.inc.xhtml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/808f7c2c6680106acaf1fe53132c65d3a888b467/mail/base/content/mainMailToolbox.inc.xhtml">file</a> |
<a href="/comm-central/annotate/808f7c2c6680106acaf1fe53132c65d3a888b467/mail/base/content/mainMailToolbox.inc.xhtml">annotate</a> |
<a href="/comm-central/diff/808f7c2c6680106acaf1fe53132c65d3a888b467/mail/base/content/mainMailToolbox.inc.xhtml">diff</a> |
<a href="/comm-central/comparison/808f7c2c6680106acaf1fe53132c65d3a888b467/mail/base/content/mainMailToolbox.inc.xhtml">comparison</a> |
<a href="/comm-central/log/808f7c2c6680106acaf1fe53132c65d3a888b467/mail/base/content/mainMailToolbox.inc.xhtml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/808f7c2c6680106acaf1fe53132c65d3a888b467/mail/base/content/messenger.xhtml">mail/base/content/messenger.xhtml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/808f7c2c6680106acaf1fe53132c65d3a888b467/mail/base/content/messenger.xhtml">file</a> |
<a href="/comm-central/annotate/808f7c2c6680106acaf1fe53132c65d3a888b467/mail/base/content/messenger.xhtml">annotate</a> |
<a href="/comm-central/diff/808f7c2c6680106acaf1fe53132c65d3a888b467/mail/base/content/messenger.xhtml">diff</a> |
<a href="/comm-central/comparison/808f7c2c6680106acaf1fe53132c65d3a888b467/mail/base/content/messenger.xhtml">comparison</a> |
<a href="/comm-central/log/808f7c2c6680106acaf1fe53132c65d3a888b467/mail/base/content/messenger.xhtml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/808f7c2c6680106acaf1fe53132c65d3a888b467/mail/base/modules/ExtensionsUI.jsm">mail/base/modules/ExtensionsUI.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/808f7c2c6680106acaf1fe53132c65d3a888b467/mail/base/modules/ExtensionsUI.jsm">file</a> |
<a href="/comm-central/annotate/808f7c2c6680106acaf1fe53132c65d3a888b467/mail/base/modules/ExtensionsUI.jsm">annotate</a> |
<a href="/comm-central/diff/808f7c2c6680106acaf1fe53132c65d3a888b467/mail/base/modules/ExtensionsUI.jsm">diff</a> |
<a href="/comm-central/comparison/808f7c2c6680106acaf1fe53132c65d3a888b467/mail/base/modules/ExtensionsUI.jsm">comparison</a> |
<a href="/comm-central/log/808f7c2c6680106acaf1fe53132c65d3a888b467/mail/base/modules/ExtensionsUI.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/808f7c2c6680106acaf1fe53132c65d3a888b467/mail/components/MailGlue.jsm">mail/components/MailGlue.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/808f7c2c6680106acaf1fe53132c65d3a888b467/mail/components/MailGlue.jsm">file</a> |
<a href="/comm-central/annotate/808f7c2c6680106acaf1fe53132c65d3a888b467/mail/components/MailGlue.jsm">annotate</a> |
<a href="/comm-central/diff/808f7c2c6680106acaf1fe53132c65d3a888b467/mail/components/MailGlue.jsm">diff</a> |
<a href="/comm-central/comparison/808f7c2c6680106acaf1fe53132c65d3a888b467/mail/components/MailGlue.jsm">comparison</a> |
<a href="/comm-central/log/808f7c2c6680106acaf1fe53132c65d3a888b467/mail/components/MailGlue.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/808f7c2c6680106acaf1fe53132c65d3a888b467/mail/components/customizableui/content/panelUI.inc.xhtml">mail/components/customizableui/content/panelUI.inc.xhtml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/808f7c2c6680106acaf1fe53132c65d3a888b467/mail/components/customizableui/content/panelUI.inc.xhtml">file</a> |
<a href="/comm-central/annotate/808f7c2c6680106acaf1fe53132c65d3a888b467/mail/components/customizableui/content/panelUI.inc.xhtml">annotate</a> |
<a href="/comm-central/diff/808f7c2c6680106acaf1fe53132c65d3a888b467/mail/components/customizableui/content/panelUI.inc.xhtml">diff</a> |
<a href="/comm-central/comparison/808f7c2c6680106acaf1fe53132c65d3a888b467/mail/components/customizableui/content/panelUI.inc.xhtml">comparison</a> |
<a href="/comm-central/log/808f7c2c6680106acaf1fe53132c65d3a888b467/mail/components/customizableui/content/panelUI.inc.xhtml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/808f7c2c6680106acaf1fe53132c65d3a888b467/mail/components/customizableui/content/panelUI.js">mail/components/customizableui/content/panelUI.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/808f7c2c6680106acaf1fe53132c65d3a888b467/mail/components/customizableui/content/panelUI.js">file</a> |
<a href="/comm-central/annotate/808f7c2c6680106acaf1fe53132c65d3a888b467/mail/components/customizableui/content/panelUI.js">annotate</a> |
<a href="/comm-central/diff/808f7c2c6680106acaf1fe53132c65d3a888b467/mail/components/customizableui/content/panelUI.js">diff</a> |
<a href="/comm-central/comparison/808f7c2c6680106acaf1fe53132c65d3a888b467/mail/components/customizableui/content/panelUI.js">comparison</a> |
<a href="/comm-central/log/808f7c2c6680106acaf1fe53132c65d3a888b467/mail/components/customizableui/content/panelUI.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/808f7c2c6680106acaf1fe53132c65d3a888b467/mail/locales/en-US/chrome/messenger/addons.properties">mail/locales/en-US/chrome/messenger/addons.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/808f7c2c6680106acaf1fe53132c65d3a888b467/mail/locales/en-US/chrome/messenger/addons.properties">file</a> |
<a href="/comm-central/annotate/808f7c2c6680106acaf1fe53132c65d3a888b467/mail/locales/en-US/chrome/messenger/addons.properties">annotate</a> |
<a href="/comm-central/diff/808f7c2c6680106acaf1fe53132c65d3a888b467/mail/locales/en-US/chrome/messenger/addons.properties">diff</a> |
<a href="/comm-central/comparison/808f7c2c6680106acaf1fe53132c65d3a888b467/mail/locales/en-US/chrome/messenger/addons.properties">comparison</a> |
<a href="/comm-central/log/808f7c2c6680106acaf1fe53132c65d3a888b467/mail/locales/en-US/chrome/messenger/addons.properties">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/808f7c2c6680106acaf1fe53132c65d3a888b467/mail/themes/shared/customizableui/panelUI.css">mail/themes/shared/customizableui/panelUI.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/808f7c2c6680106acaf1fe53132c65d3a888b467/mail/themes/shared/customizableui/panelUI.css">file</a> |
<a href="/comm-central/annotate/808f7c2c6680106acaf1fe53132c65d3a888b467/mail/themes/shared/customizableui/panelUI.css">annotate</a> |
<a href="/comm-central/diff/808f7c2c6680106acaf1fe53132c65d3a888b467/mail/themes/shared/customizableui/panelUI.css">diff</a> |
<a href="/comm-central/comparison/808f7c2c6680106acaf1fe53132c65d3a888b467/mail/themes/shared/customizableui/panelUI.css">comparison</a> |
<a href="/comm-central/log/808f7c2c6680106acaf1fe53132c65d3a888b467/mail/themes/shared/customizableui/panelUI.css">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/base/content/mainMailToolbox.inc.xhtml</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/base/content/mainMailToolbox.inc.xhtml</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -305,16 +305,17 @@</span>
<a href="#l1.4"></a><span id="l1.4">     &lt;/toolbaritem&gt;</span>
<a href="#l1.5"></a><span id="l1.5">     &lt;toolbarbutton id=&quot;button-stop&quot;</span>
<a href="#l1.6"></a><span id="l1.6">                    class=&quot;toolbarbutton-1&quot;</span>
<a href="#l1.7"></a><span id="l1.7">                    label=&quot;&amp;stopButton.label;&quot;</span>
<a href="#l1.8"></a><span id="l1.8">                    tooltiptext=&quot;&amp;stopButton.tooltip;&quot;</span>
<a href="#l1.9"></a><span id="l1.9">                    command=&quot;cmd_stop&quot;/&gt;</span>
<a href="#l1.10"></a><span id="l1.10">     &lt;toolbarbutton id=&quot;button-appmenu&quot;</span>
<a href="#l1.11"></a><span id="l1.11">                    type=&quot;menu&quot;</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+                   badged=&quot;true&quot;</span>
<a href="#l1.13"></a><span id="l1.13">                    class=&quot;toolbarbutton-1 button-appmenu&quot;</span>
<a href="#l1.14"></a><span id="l1.14">                    label=&quot;&amp;appmenuButton.label;&quot;</span>
<a href="#l1.15"></a><span id="l1.15">                    tooltiptext=&quot;&amp;appmenuButton1.tooltip;&quot;/&gt;</span>
<a href="#l1.16"></a><span id="l1.16"> #ifdef MAIN_WINDOW</span>
<a href="#l1.17"></a><span id="l1.17">     &lt;!-- gloda search widget; provides global (message) searching.  --&gt;</span>
<a href="#l1.18"></a><span id="l1.18">     &lt;toolbaritem id=&quot;gloda-search&quot; insertafter=&quot;button-stop&quot;</span>
<a href="#l1.19"></a><span id="l1.19">                  title=&quot;&amp;glodaSearch.title;&quot;</span>
<a href="#l1.20"></a><span id="l1.20">                  align=&quot;center&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/base/content/messenger.xhtml</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/base/content/messenger.xhtml</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -475,16 +475,19 @@</span>
<a href="#l2.4"></a><span id="l2.4">     &lt;popupnotificationcontent id=&quot;addon-install-confirmation-content&quot; orient=&quot;vertical&quot;/&gt;</span>
<a href="#l2.5"></a><span id="l2.5">   &lt;/popupnotification&gt;</span>
<a href="#l2.6"></a><span id="l2.6"> </span>
<a href="#l2.7"></a><span id="l2.7">   &lt;popupnotification id=&quot;addon-webext-permissions-notification&quot; hidden=&quot;true&quot;&gt;</span>
<a href="#l2.8"></a><span id="l2.8">     &lt;popupnotificationcontent class=&quot;addon-webext-perm-notification-content&quot; orient=&quot;vertical&quot;&gt;</span>
<a href="#l2.9"></a><span id="l2.9">       &lt;description id=&quot;addon-webext-perm-text&quot; class=&quot;addon-webext-perm-text&quot;/&gt;</span>
<a href="#l2.10"></a><span id="l2.10">       &lt;label id=&quot;addon-webext-perm-intro&quot; class=&quot;addon-webext-perm-text&quot;/&gt;</span>
<a href="#l2.11"></a><span id="l2.11">       &lt;html:ul id=&quot;addon-webext-perm-list&quot; class=&quot;addon-webext-perm-list&quot;/&gt;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+      &lt;hbox&gt;</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+        &lt;label id=&quot;addon-webext-perm-info&quot; is=&quot;text-link&quot; class=&quot;popup-notification-learnmore-link&quot;/&gt;</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+      &lt;/hbox&gt;</span>
<a href="#l2.15"></a><span id="l2.15">     &lt;/popupnotificationcontent&gt;</span>
<a href="#l2.16"></a><span id="l2.16">   &lt;/popupnotification&gt;</span>
<a href="#l2.17"></a><span id="l2.17"> </span>
<a href="#l2.18"></a><span id="l2.18">   &lt;popupnotification id=&quot;addon-installed-notification&quot; hidden=&quot;true&quot;&gt;</span>
<a href="#l2.19"></a><span id="l2.19">     &lt;popupnotificationcontent class=&quot;addon-installed-notification-content&quot; orient=&quot;vertical&quot;&gt;</span>
<a href="#l2.20"></a><span id="l2.20">       &lt;html:ul id=&quot;addon-installed-list&quot; class=&quot;addon-installed-list&quot;/&gt;</span>
<a href="#l2.21"></a><span id="l2.21">     &lt;/popupnotificationcontent&gt;</span>
<a href="#l2.22"></a><span id="l2.22">   &lt;/popupnotification&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/base/modules/ExtensionsUI.jsm</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/base/modules/ExtensionsUI.jsm</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -1,49 +1,76 @@</span>
<a href="#l3.4"></a><span id="l3.4"> /* -*- indent-tabs-mode: nil; js-indent-level: 2 -*-</span>
<a href="#l3.5"></a><span id="l3.5">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l3.6"></a><span id="l3.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l3.7"></a><span id="l3.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l3.8"></a><span id="l3.8"> </span>
<a href="#l3.9"></a><span id="l3.9"> const EXPORTED_SYMBOLS = [&quot;ExtensionsUI&quot;];</span>
<a href="#l3.10"></a><span id="l3.10"> </span>
<a href="#l3.11"></a><span id="l3.11" class="difflineminus">-const ADDONS_PROPERTIES = &quot;chrome://messenger/locale/addons.properties&quot;;</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-const BRAND_PROPERTIES = &quot;chrome://branding/locale/brand.properties&quot;;</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-const DEFAULT_EXTENSION_ICON =</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-  &quot;chrome://mozapps/skin/extensions/extensionGeneric.svg&quot;;</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-const HTML_NS = &quot;http://www.w3.org/1999/xhtml&quot;;</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineminus">-</span>
<a href="#l3.17"></a><span id="l3.17"> const { XPCOMUtils } = ChromeUtils.import(</span>
<a href="#l3.18"></a><span id="l3.18">   &quot;resource://gre/modules/XPCOMUtils.jsm&quot;</span>
<a href="#l3.19"></a><span id="l3.19"> );</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+const { EventEmitter } = ChromeUtils.import(</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+  &quot;resource://gre/modules/EventEmitter.jsm&quot;</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+);</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+</span>
<a href="#l3.24"></a><span id="l3.24"> XPCOMUtils.defineLazyModuleGetters(this, {</span>
<a href="#l3.25"></a><span id="l3.25">   AddonManager: &quot;resource://gre/modules/AddonManager.jsm&quot;,</span>
<a href="#l3.26"></a><span id="l3.26">   AddonManagerPrivate: &quot;resource://gre/modules/AddonManager.jsm&quot;,</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+  AMTelemetry: &quot;resource://gre/modules/AddonManager.jsm&quot;,</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+  AppMenuNotifications: &quot;resource://gre/modules/AppMenuNotifications.jsm&quot;,</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineplus">+  BrowserUtils: &quot;resource://gre/modules/BrowserUtils.jsm&quot;,</span>
<a href="#l3.30"></a><span id="l3.30">   ExtensionData: &quot;resource://gre/modules/Extension.jsm&quot;,</span>
<a href="#l3.31"></a><span id="l3.31">   PluralForm: &quot;resource://gre/modules/PluralForm.jsm&quot;,</span>
<a href="#l3.32"></a><span id="l3.32">   Services: &quot;resource://gre/modules/Services.jsm&quot;,</span>
<a href="#l3.33"></a><span id="l3.33">   setTimeout: &quot;resource://gre/modules/Timer.jsm&quot;,</span>
<a href="#l3.34"></a><span id="l3.34">   StringBundle: &quot;resource:///modules/StringBundle.jsm&quot;,</span>
<a href="#l3.35"></a><span id="l3.35"> });</span>
<a href="#l3.36"></a><span id="l3.36"> </span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+const ADDONS_PROPERTIES = &quot;chrome://messenger/locale/addons.properties&quot;;</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+</span>
<a href="#l3.39"></a><span id="l3.39"> XPCOMUtils.defineLazyGetter(this, &quot;addonsBundle&quot;, function() {</span>
<a href="#l3.40"></a><span id="l3.40">   return new StringBundle(ADDONS_PROPERTIES);</span>
<a href="#l3.41"></a><span id="l3.41"> });</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineminus">-XPCOMUtils.defineLazyGetter(this, &quot;brandBundle&quot;, function() {</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineminus">-  return new StringBundle(BRAND_PROPERTIES);</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;brandShortName&quot;, function() {</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+  return new StringBundle(</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineplus">+    &quot;chrome://branding/locale/brand.properties&quot;</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+  ).getString(&quot;brandShortName&quot;);</span>
<a href="#l3.48"></a><span id="l3.48"> });</span>
<a href="#l3.49"></a><span id="l3.49"> </span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+XPCOMUtils.defineLazyPreferenceGetter(</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+  this,</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineplus">+  &quot;WEBEXT_PERMISSION_PROMPTS&quot;,</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineplus">+  &quot;extensions.webextPermissionPrompts&quot;,</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineplus">+  false</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineplus">+);</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineplus">+</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineplus">+const DEFAULT_EXTENSION_ICON =</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineplus">+  &quot;chrome://mozapps/skin/extensions/extensionGeneric.svg&quot;;</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineplus">+</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineplus">+const HTML_NS = &quot;http://www.w3.org/1999/xhtml&quot;;</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+</span>
<a href="#l3.62"></a><span id="l3.62"> function getTopWindow() {</span>
<a href="#l3.63"></a><span id="l3.63">   return Services.wm.getMostRecentWindow(&quot;mail:3pane&quot;);</span>
<a href="#l3.64"></a><span id="l3.64"> }</span>
<a href="#l3.65"></a><span id="l3.65"> </span>
<a href="#l3.66"></a><span id="l3.66"> function getNotification(id, browser) {</span>
<a href="#l3.67"></a><span id="l3.67">   return getTopWindow().PopupNotifications.getNotification(id, browser);</span>
<a href="#l3.68"></a><span id="l3.68"> }</span>
<a href="#l3.69"></a><span id="l3.69"> </span>
<a href="#l3.70"></a><span id="l3.70" class="difflineplus">+function getTabBrowser(browser) {</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineplus">+  while (browser.ownerGlobal.docShell.itemType !== Ci.nsIDocShell.typeChrome) {</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineplus">+    browser = browser.ownerGlobal.docShell.chromeEventHandler;</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineplus">+  }</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineplus">+  if (browser.getAttribute(&quot;webextension-view-type&quot;) == &quot;popup&quot;) {</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineplus">+    browser = browser.ownerGlobal.gBrowser.selectedBrowser;</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineplus">+  }</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineplus">+  return { browser, window: browser.ownerGlobal };</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineplus">+}</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineplus">+</span>
<a href="#l3.80"></a><span id="l3.80"> function showNotification(</span>
<a href="#l3.81"></a><span id="l3.81">   browser,</span>
<a href="#l3.82"></a><span id="l3.82">   id,</span>
<a href="#l3.83"></a><span id="l3.83">   message,</span>
<a href="#l3.84"></a><span id="l3.84">   anchorID,</span>
<a href="#l3.85"></a><span id="l3.85">   mainAction,</span>
<a href="#l3.86"></a><span id="l3.86">   secondaryActions,</span>
<a href="#l3.87"></a><span id="l3.87">   options</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineat">@@ -85,19 +112,25 @@ function removeNotificationOnEnd(notific</span>
<a href="#l3.89"></a><span id="l3.89">       onDownloadCancelled: maybeRemove,</span>
<a href="#l3.90"></a><span id="l3.90">       onDownloadFailed: maybeRemove,</span>
<a href="#l3.91"></a><span id="l3.91">       onInstallFailed: maybeRemove,</span>
<a href="#l3.92"></a><span id="l3.92">       onInstallEnded: maybeRemove,</span>
<a href="#l3.93"></a><span id="l3.93">     });</span>
<a href="#l3.94"></a><span id="l3.94">   }</span>
<a href="#l3.95"></a><span id="l3.95"> }</span>
<a href="#l3.96"></a><span id="l3.96"> </span>
<a href="#l3.97"></a><span id="l3.97" class="difflineplus">+/**</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineplus">+ * This object is Thunderbird's version of the same object in</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineplus">+ * browser/base/content/browser-addons.js. Firefox has one of these objects</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineplus">+ * per window but Thunderbird has only one total, because we simply pick the</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineplus">+ * most recent window for notifications, rather than the window related to a</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineplus">+ * particular tab.</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineplus">+ */</span>
<a href="#l3.104"></a><span id="l3.104"> var gXPInstallObserver = {</span>
<a href="#l3.105"></a><span id="l3.105">   pendingInstalls: new WeakMap(),</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineminus">-  pendingNotifications: new WeakMap(),</span>
<a href="#l3.107"></a><span id="l3.107"> </span>
<a href="#l3.108"></a><span id="l3.108">   showInstallConfirmation(browser, installInfo, height = undefined) {</span>
<a href="#l3.109"></a><span id="l3.109">     let document = getTopWindow().document;</span>
<a href="#l3.110"></a><span id="l3.110">     // If the confirmation notification is already open cache the installInfo</span>
<a href="#l3.111"></a><span id="l3.111">     // and the new confirmation will be shown later</span>
<a href="#l3.112"></a><span id="l3.112">     if (getNotification(&quot;addon-install-confirmation&quot;, browser)) {</span>
<a href="#l3.113"></a><span id="l3.113">       let pending = this.pendingInstalls.get(browser);</span>
<a href="#l3.114"></a><span id="l3.114">       if (pending) {</span>
<a href="#l3.115"></a><span id="l3.115" class="difflineat">@@ -133,16 +166,22 @@ var gXPInstallObserver = {</span>
<a href="#l3.116"></a><span id="l3.116">       hideClose: true,</span>
<a href="#l3.117"></a><span id="l3.117">     };</span>
<a href="#l3.118"></a><span id="l3.118"> </span>
<a href="#l3.119"></a><span id="l3.119">     let acceptInstallation = () =&gt; {</span>
<a href="#l3.120"></a><span id="l3.120">       for (let install of installInfo.installs) {</span>
<a href="#l3.121"></a><span id="l3.121">         install.install();</span>
<a href="#l3.122"></a><span id="l3.122">       }</span>
<a href="#l3.123"></a><span id="l3.123">       installInfo = null;</span>
<a href="#l3.124"></a><span id="l3.124" class="difflineplus">+</span>
<a href="#l3.125"></a><span id="l3.125" class="difflineplus">+      Services.telemetry</span>
<a href="#l3.126"></a><span id="l3.126" class="difflineplus">+        .getHistogramById(&quot;SECURITY_UI&quot;)</span>
<a href="#l3.127"></a><span id="l3.127" class="difflineplus">+        .add(</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineplus">+          Ci.nsISecurityUITelemetry.WARNING_CONFIRM_ADDON_INSTALL_CLICK_THROUGH</span>
<a href="#l3.129"></a><span id="l3.129" class="difflineplus">+        );</span>
<a href="#l3.130"></a><span id="l3.130">     };</span>
<a href="#l3.131"></a><span id="l3.131"> </span>
<a href="#l3.132"></a><span id="l3.132">     let cancelInstallation = () =&gt; {</span>
<a href="#l3.133"></a><span id="l3.133">       if (installInfo) {</span>
<a href="#l3.134"></a><span id="l3.134">         for (let install of installInfo.installs) {</span>
<a href="#l3.135"></a><span id="l3.135">           // The notification may have been closed because the add-ons got</span>
<a href="#l3.136"></a><span id="l3.136">           // cancelled elsewhere, only try to cancel those that are still</span>
<a href="#l3.137"></a><span id="l3.137">           // pending install.</span>
<a href="#l3.138"></a><span id="l3.138" class="difflineat">@@ -189,18 +228,16 @@ var gXPInstallObserver = {</span>
<a href="#l3.139"></a><span id="l3.139">     let messageString;</span>
<a href="#l3.140"></a><span id="l3.140">     let notification = document.getElementById(</span>
<a href="#l3.141"></a><span id="l3.141">       &quot;addon-install-confirmation-notification&quot;</span>
<a href="#l3.142"></a><span id="l3.142">     );</span>
<a href="#l3.143"></a><span id="l3.143">     messageString = addonsBundle.getString(&quot;addonConfirmInstall.message&quot;);</span>
<a href="#l3.144"></a><span id="l3.144">     notification.removeAttribute(&quot;warning&quot;);</span>
<a href="#l3.145"></a><span id="l3.145">     options.learnMoreURL += &quot;find-and-install-add-ons&quot;;</span>
<a href="#l3.146"></a><span id="l3.146"> </span>
<a href="#l3.147"></a><span id="l3.147" class="difflineminus">-    let brandShortName = brandBundle.getString(&quot;brandShortName&quot;);</span>
<a href="#l3.148"></a><span id="l3.148" class="difflineminus">-</span>
<a href="#l3.149"></a><span id="l3.149">     messageString = PluralForm.get(installInfo.installs.length, messageString);</span>
<a href="#l3.150"></a><span id="l3.150">     messageString = messageString.replace(&quot;#1&quot;, brandShortName);</span>
<a href="#l3.151"></a><span id="l3.151">     messageString = messageString.replace(&quot;#2&quot;, installInfo.installs.length);</span>
<a href="#l3.152"></a><span id="l3.152"> </span>
<a href="#l3.153"></a><span id="l3.153">     let action = {</span>
<a href="#l3.154"></a><span id="l3.154">       label: addonsBundle.getString(&quot;addonInstall.acceptButton2.label&quot;),</span>
<a href="#l3.155"></a><span id="l3.155">       accessKey: addonsBundle.getString(&quot;addonInstall.acceptButton2.accesskey&quot;),</span>
<a href="#l3.156"></a><span id="l3.156">       callback: acceptInstallation,</span>
<a href="#l3.157"></a><span id="l3.157" class="difflineat">@@ -221,158 +258,29 @@ var gXPInstallObserver = {</span>
<a href="#l3.158"></a><span id="l3.158">       &quot;addon-install-confirmation&quot;,</span>
<a href="#l3.159"></a><span id="l3.159">       messageString,</span>
<a href="#l3.160"></a><span id="l3.160">       anchorID,</span>
<a href="#l3.161"></a><span id="l3.161">       action,</span>
<a href="#l3.162"></a><span id="l3.162">       [secondaryAction],</span>
<a href="#l3.163"></a><span id="l3.163">       options</span>
<a href="#l3.164"></a><span id="l3.164">     );</span>
<a href="#l3.165"></a><span id="l3.165">     removeNotificationOnEnd(popup, installInfo.installs);</span>
<a href="#l3.166"></a><span id="l3.166" class="difflineplus">+</span>
<a href="#l3.167"></a><span id="l3.167" class="difflineplus">+    Services.telemetry</span>
<a href="#l3.168"></a><span id="l3.168" class="difflineplus">+      .getHistogramById(&quot;SECURITY_UI&quot;)</span>
<a href="#l3.169"></a><span id="l3.169" class="difflineplus">+      .add(Ci.nsISecurityUITelemetry.WARNING_CONFIRM_ADDON_INSTALL);</span>
<a href="#l3.170"></a><span id="l3.170">   },</span>
<a href="#l3.171"></a><span id="l3.171"> </span>
<a href="#l3.172"></a><span id="l3.172" class="difflineminus">-  async showPermissionsPrompt(browser, strings, icon) {</span>
<a href="#l3.173"></a><span id="l3.173" class="difflineminus">-    let window = getTopWindow();</span>
<a href="#l3.174"></a><span id="l3.174" class="difflineminus">-</span>
<a href="#l3.175"></a><span id="l3.175" class="difflineminus">-    // Wait for any pending prompts in this window to complete before</span>
<a href="#l3.176"></a><span id="l3.176" class="difflineminus">-    // showing the next one.</span>
<a href="#l3.177"></a><span id="l3.177" class="difflineminus">-    let pending;</span>
<a href="#l3.178"></a><span id="l3.178" class="difflineminus">-    while ((pending = this.pendingNotifications.get(window))) {</span>
<a href="#l3.179"></a><span id="l3.179" class="difflineminus">-      await pending;</span>
<a href="#l3.180"></a><span id="l3.180" class="difflineminus">-    }</span>
<a href="#l3.181"></a><span id="l3.181" class="difflineminus">-</span>
<a href="#l3.182"></a><span id="l3.182" class="difflineminus">-    let promise = new Promise(resolve =&gt; {</span>
<a href="#l3.183"></a><span id="l3.183" class="difflineminus">-      function eventCallback(topic) {</span>
<a href="#l3.184"></a><span id="l3.184" class="difflineminus">-        let doc = window.document;</span>
<a href="#l3.185"></a><span id="l3.185" class="difflineminus">-        if (topic == &quot;showing&quot;) {</span>
<a href="#l3.186"></a><span id="l3.186" class="difflineminus">-          let textEl = doc.getElementById(&quot;addon-webext-perm-text&quot;);</span>
<a href="#l3.187"></a><span id="l3.187" class="difflineminus">-          textEl.textContent = strings.text;</span>
<a href="#l3.188"></a><span id="l3.188" class="difflineminus">-          textEl.hidden = !strings.text;</span>
<a href="#l3.189"></a><span id="l3.189" class="difflineminus">-</span>
<a href="#l3.190"></a><span id="l3.190" class="difflineminus">-          let listIntroEl = doc.getElementById(&quot;addon-webext-perm-intro&quot;);</span>
<a href="#l3.191"></a><span id="l3.191" class="difflineminus">-          listIntroEl.textContent = strings.listIntro;</span>
<a href="#l3.192"></a><span id="l3.192" class="difflineminus">-          listIntroEl.hidden = strings.msgs.length == 0;</span>
<a href="#l3.193"></a><span id="l3.193" class="difflineminus">-</span>
<a href="#l3.194"></a><span id="l3.194" class="difflineminus">-          let list = doc.getElementById(&quot;addon-webext-perm-list&quot;);</span>
<a href="#l3.195"></a><span id="l3.195" class="difflineminus">-          while (list.lastChild) {</span>
<a href="#l3.196"></a><span id="l3.196" class="difflineminus">-            list.lastChild.remove();</span>
<a href="#l3.197"></a><span id="l3.197" class="difflineminus">-          }</span>
<a href="#l3.198"></a><span id="l3.198" class="difflineminus">-</span>
<a href="#l3.199"></a><span id="l3.199" class="difflineminus">-          for (let msg of strings.msgs) {</span>
<a href="#l3.200"></a><span id="l3.200" class="difflineminus">-            let item = doc.createElementNS(HTML_NS, &quot;li&quot;);</span>
<a href="#l3.201"></a><span id="l3.201" class="difflineminus">-            item.textContent = msg;</span>
<a href="#l3.202"></a><span id="l3.202" class="difflineminus">-            list.appendChild(item);</span>
<a href="#l3.203"></a><span id="l3.203" class="difflineminus">-          }</span>
<a href="#l3.204"></a><span id="l3.204" class="difflineminus">-        } else if (topic == &quot;swapping&quot;) {</span>
<a href="#l3.205"></a><span id="l3.205" class="difflineminus">-          return true;</span>
<a href="#l3.206"></a><span id="l3.206" class="difflineminus">-        }</span>
<a href="#l3.207"></a><span id="l3.207" class="difflineminus">-        if (topic == &quot;removed&quot;) {</span>
<a href="#l3.208"></a><span id="l3.208" class="difflineminus">-          Services.tm.dispatchToMainThread(() =&gt; {</span>
<a href="#l3.209"></a><span id="l3.209" class="difflineminus">-            resolve(false);</span>
<a href="#l3.210"></a><span id="l3.210" class="difflineminus">-          });</span>
<a href="#l3.211"></a><span id="l3.211" class="difflineminus">-        }</span>
<a href="#l3.212"></a><span id="l3.212" class="difflineminus">-        return false;</span>
<a href="#l3.213"></a><span id="l3.213" class="difflineminus">-      }</span>
<a href="#l3.214"></a><span id="l3.214" class="difflineminus">-</span>
<a href="#l3.215"></a><span id="l3.215" class="difflineminus">-      let popupOptions = {</span>
<a href="#l3.216"></a><span id="l3.216" class="difflineminus">-        hideClose: true,</span>
<a href="#l3.217"></a><span id="l3.217" class="difflineminus">-        popupIconURL: icon || DEFAULT_EXTENSION_ICON,</span>
<a href="#l3.218"></a><span id="l3.218" class="difflineminus">-        persistent: true,</span>
<a href="#l3.219"></a><span id="l3.219" class="difflineminus">-        eventCallback,</span>
<a href="#l3.220"></a><span id="l3.220" class="difflineminus">-        name: strings.addonName,</span>
<a href="#l3.221"></a><span id="l3.221" class="difflineminus">-        removeOnDismissal: true,</span>
<a href="#l3.222"></a><span id="l3.222" class="difflineminus">-      };</span>
<a href="#l3.223"></a><span id="l3.223" class="difflineminus">-</span>
<a href="#l3.224"></a><span id="l3.224" class="difflineminus">-      let action = {</span>
<a href="#l3.225"></a><span id="l3.225" class="difflineminus">-        label: strings.acceptText,</span>
<a href="#l3.226"></a><span id="l3.226" class="difflineminus">-        accessKey: strings.acceptKey,</span>
<a href="#l3.227"></a><span id="l3.227" class="difflineminus">-        callback: () =&gt; {</span>
<a href="#l3.228"></a><span id="l3.228" class="difflineminus">-          resolve(true);</span>
<a href="#l3.229"></a><span id="l3.229" class="difflineminus">-        },</span>
<a href="#l3.230"></a><span id="l3.230" class="difflineminus">-      };</span>
<a href="#l3.231"></a><span id="l3.231" class="difflineminus">-      let secondaryActions = [</span>
<a href="#l3.232"></a><span id="l3.232" class="difflineminus">-        {</span>
<a href="#l3.233"></a><span id="l3.233" class="difflineminus">-          label: strings.cancelText,</span>
<a href="#l3.234"></a><span id="l3.234" class="difflineminus">-          accessKey: strings.cancelKey,</span>
<a href="#l3.235"></a><span id="l3.235" class="difflineminus">-          callback: () =&gt; {</span>
<a href="#l3.236"></a><span id="l3.236" class="difflineminus">-            resolve(false);</span>
<a href="#l3.237"></a><span id="l3.237" class="difflineminus">-          },</span>
<a href="#l3.238"></a><span id="l3.238" class="difflineminus">-        },</span>
<a href="#l3.239"></a><span id="l3.239" class="difflineminus">-      ];</span>
<a href="#l3.240"></a><span id="l3.240" class="difflineminus">-</span>
<a href="#l3.241"></a><span id="l3.241" class="difflineminus">-      showNotification(</span>
<a href="#l3.242"></a><span id="l3.242" class="difflineminus">-        browser,</span>
<a href="#l3.243"></a><span id="l3.243" class="difflineminus">-        &quot;addon-webext-permissions&quot;,</span>
<a href="#l3.244"></a><span id="l3.244" class="difflineminus">-        strings.header,</span>
<a href="#l3.245"></a><span id="l3.245" class="difflineminus">-        &quot;addons-notification-icon&quot;,</span>
<a href="#l3.246"></a><span id="l3.246" class="difflineminus">-        action,</span>
<a href="#l3.247"></a><span id="l3.247" class="difflineminus">-        secondaryActions,</span>
<a href="#l3.248"></a><span id="l3.248" class="difflineminus">-        popupOptions</span>
<a href="#l3.249"></a><span id="l3.249" class="difflineminus">-      );</span>
<a href="#l3.250"></a><span id="l3.250" class="difflineminus">-    });</span>
<a href="#l3.251"></a><span id="l3.251" class="difflineminus">-</span>
<a href="#l3.252"></a><span id="l3.252" class="difflineminus">-    this.pendingNotifications.set(window, promise);</span>
<a href="#l3.253"></a><span id="l3.253" class="difflineminus">-    promise.finally(() =&gt; this.pendingNotifications.delete(window));</span>
<a href="#l3.254"></a><span id="l3.254" class="difflineminus">-    return promise;</span>
<a href="#l3.255"></a><span id="l3.255" class="difflineminus">-  },</span>
<a href="#l3.256"></a><span id="l3.256" class="difflineminus">-</span>
<a href="#l3.257"></a><span id="l3.257" class="difflineminus">-  async showInstallNotification(browser, addon) {</span>
<a href="#l3.258"></a><span id="l3.258" class="difflineminus">-    let window = getTopWindow();</span>
<a href="#l3.259"></a><span id="l3.259" class="difflineminus">-    let document = window.document;</span>
<a href="#l3.260"></a><span id="l3.260" class="difflineminus">-</span>
<a href="#l3.261"></a><span id="l3.261" class="difflineminus">-    let brandBundle = document.getElementById(&quot;bundle_brand&quot;);</span>
<a href="#l3.262"></a><span id="l3.262" class="difflineminus">-    let appName = brandBundle.getString(&quot;brandShortName&quot;);</span>
<a href="#l3.263"></a><span id="l3.263" class="difflineminus">-</span>
<a href="#l3.264"></a><span id="l3.264" class="difflineminus">-    let message = addonsBundle.getFormattedString(&quot;addonPostInstall.message1&quot;, [</span>
<a href="#l3.265"></a><span id="l3.265" class="difflineminus">-      &quot;&lt;&gt;&quot;,</span>
<a href="#l3.266"></a><span id="l3.266" class="difflineminus">-      appName,</span>
<a href="#l3.267"></a><span id="l3.267" class="difflineminus">-    ]);</span>
<a href="#l3.268"></a><span id="l3.268" class="difflineminus">-</span>
<a href="#l3.269"></a><span id="l3.269" class="difflineminus">-    let icon = DEFAULT_EXTENSION_ICON;</span>
<a href="#l3.270"></a><span id="l3.270" class="difflineminus">-    if (addon.isWebExtension) {</span>
<a href="#l3.271"></a><span id="l3.271" class="difflineminus">-      icon = AddonManager.getPreferredIconURL(addon, 32, window) || icon;</span>
<a href="#l3.272"></a><span id="l3.272" class="difflineminus">-    }</span>
<a href="#l3.273"></a><span id="l3.273" class="difflineminus">-</span>
<a href="#l3.274"></a><span id="l3.274" class="difflineminus">-    let options = {</span>
<a href="#l3.275"></a><span id="l3.275" class="difflineminus">-      hideClose: true,</span>
<a href="#l3.276"></a><span id="l3.276" class="difflineminus">-      timeout: Date.now() + 30000,</span>
<a href="#l3.277"></a><span id="l3.277" class="difflineminus">-      popupIconURL: icon,</span>
<a href="#l3.278"></a><span id="l3.278" class="difflineminus">-      name: addon.name,</span>
<a href="#l3.279"></a><span id="l3.279" class="difflineminus">-    };</span>
<a href="#l3.280"></a><span id="l3.280" class="difflineminus">-</span>
<a href="#l3.281"></a><span id="l3.281" class="difflineminus">-    let list = document.getElementById(&quot;addon-installed-list&quot;);</span>
<a href="#l3.282"></a><span id="l3.282" class="difflineminus">-    list.hidden = true;</span>
<a href="#l3.283"></a><span id="l3.283" class="difflineminus">-</span>
<a href="#l3.284"></a><span id="l3.284" class="difflineminus">-    this._showInstallNotification(browser, message, options);</span>
<a href="#l3.285"></a><span id="l3.285" class="difflineminus">-  },</span>
<a href="#l3.286"></a><span id="l3.286" class="difflineminus">-</span>
<a href="#l3.287"></a><span id="l3.287" class="difflineminus">-  _showInstallNotification(browser, message, options) {</span>
<a href="#l3.288"></a><span id="l3.288" class="difflineminus">-    showNotification(</span>
<a href="#l3.289"></a><span id="l3.289" class="difflineminus">-      browser,</span>
<a href="#l3.290"></a><span id="l3.290" class="difflineminus">-      &quot;addon-installed&quot;,</span>
<a href="#l3.291"></a><span id="l3.291" class="difflineminus">-      message,</span>
<a href="#l3.292"></a><span id="l3.292" class="difflineminus">-      &quot;addons-notification-icon&quot;,</span>
<a href="#l3.293"></a><span id="l3.293" class="difflineminus">-      {</span>
<a href="#l3.294"></a><span id="l3.294" class="difflineminus">-        label: addonsBundle.getString(&quot;addonPostInstall.okay.label&quot;),</span>
<a href="#l3.295"></a><span id="l3.295" class="difflineminus">-        accessKey: addonsBundle.getString(&quot;addonPostInstall.okay.accesskey&quot;),</span>
<a href="#l3.296"></a><span id="l3.296" class="difflineminus">-        callback: () =&gt; {},</span>
<a href="#l3.297"></a><span id="l3.297" class="difflineminus">-      },</span>
<a href="#l3.298"></a><span id="l3.298" class="difflineminus">-      null,</span>
<a href="#l3.299"></a><span id="l3.299" class="difflineminus">-      options</span>
<a href="#l3.300"></a><span id="l3.300" class="difflineminus">-    );</span>
<a href="#l3.301"></a><span id="l3.301" class="difflineminus">-  },</span>
<a href="#l3.302"></a><span id="l3.302" class="difflineminus">-</span>
<a href="#l3.303"></a><span id="l3.303" class="difflineminus">-  /* eslint-disable complexity */</span>
<a href="#l3.304"></a><span id="l3.304">   observe(subject, topic, data) {</span>
<a href="#l3.305"></a><span id="l3.305">     let installInfo = subject.wrappedJSObject;</span>
<a href="#l3.306"></a><span id="l3.306">     let browser = installInfo.browser || installInfo.target;</span>
<a href="#l3.307"></a><span id="l3.307">     let window = getTopWindow();</span>
<a href="#l3.308"></a><span id="l3.308"> </span>
<a href="#l3.309"></a><span id="l3.309">     const anchorID = &quot;addons-notification-icon&quot;;</span>
<a href="#l3.310"></a><span id="l3.310">     var messageString, action;</span>
<a href="#l3.311"></a><span id="l3.311" class="difflineminus">-    var brandShortName = brandBundle.getString(&quot;brandShortName&quot;);</span>
<a href="#l3.312"></a><span id="l3.312"> </span>
<a href="#l3.313"></a><span id="l3.313">     var notificationID = topic;</span>
<a href="#l3.314"></a><span id="l3.314">     // Make notifications persistent</span>
<a href="#l3.315"></a><span id="l3.315">     var options = {</span>
<a href="#l3.316"></a><span id="l3.316">       displayURI: installInfo.originatingURI,</span>
<a href="#l3.317"></a><span id="l3.317">       persistent: true,</span>
<a href="#l3.318"></a><span id="l3.318">       hideClose: true,</span>
<a href="#l3.319"></a><span id="l3.319">       timeout: Date.now() + 30000,</span>
<a href="#l3.320"></a><span id="l3.320" class="difflineat">@@ -423,67 +331,132 @@ var gXPInstallObserver = {</span>
<a href="#l3.321"></a><span id="l3.321">         break;</span>
<a href="#l3.322"></a><span id="l3.322">       }</span>
<a href="#l3.323"></a><span id="l3.323">       case &quot;addon-install-origin-blocked&quot;: {</span>
<a href="#l3.324"></a><span id="l3.324">         messageString = addonsBundle.getFormattedString(</span>
<a href="#l3.325"></a><span id="l3.325">           &quot;xpinstallPromptMessage&quot;,</span>
<a href="#l3.326"></a><span id="l3.326">           [brandShortName]</span>
<a href="#l3.327"></a><span id="l3.327">         );</span>
<a href="#l3.328"></a><span id="l3.328"> </span>
<a href="#l3.329"></a><span id="l3.329" class="difflineplus">+        if (Services.policies) {</span>
<a href="#l3.330"></a><span id="l3.330" class="difflineplus">+          let extensionSettings = Services.policies.getExtensionSettings(&quot;*&quot;);</span>
<a href="#l3.331"></a><span id="l3.331" class="difflineplus">+          if (</span>
<a href="#l3.332"></a><span id="l3.332" class="difflineplus">+            extensionSettings &amp;&amp;</span>
<a href="#l3.333"></a><span id="l3.333" class="difflineplus">+            &quot;blocked_install_message&quot; in extensionSettings</span>
<a href="#l3.334"></a><span id="l3.334" class="difflineplus">+          ) {</span>
<a href="#l3.335"></a><span id="l3.335" class="difflineplus">+            messageString += &quot; &quot; + extensionSettings.blocked_install_message;</span>
<a href="#l3.336"></a><span id="l3.336" class="difflineplus">+          }</span>
<a href="#l3.337"></a><span id="l3.337" class="difflineplus">+        }</span>
<a href="#l3.338"></a><span id="l3.338" class="difflineplus">+</span>
<a href="#l3.339"></a><span id="l3.339">         options.removeOnDismissal = true;</span>
<a href="#l3.340"></a><span id="l3.340">         options.persistent = false;</span>
<a href="#l3.341"></a><span id="l3.341"> </span>
<a href="#l3.342"></a><span id="l3.342" class="difflineplus">+        let secHistogram = Services.telemetry.getHistogramById(&quot;SECURITY_UI&quot;);</span>
<a href="#l3.343"></a><span id="l3.343" class="difflineplus">+        secHistogram.add(</span>
<a href="#l3.344"></a><span id="l3.344" class="difflineplus">+          Ci.nsISecurityUITelemetry.WARNING_ADDON_ASKING_PREVENTED</span>
<a href="#l3.345"></a><span id="l3.345" class="difflineplus">+        );</span>
<a href="#l3.346"></a><span id="l3.346">         let popup = showNotification(</span>
<a href="#l3.347"></a><span id="l3.347">           browser,</span>
<a href="#l3.348"></a><span id="l3.348">           notificationID,</span>
<a href="#l3.349"></a><span id="l3.349">           messageString,</span>
<a href="#l3.350"></a><span id="l3.350">           anchorID,</span>
<a href="#l3.351"></a><span id="l3.351">           null,</span>
<a href="#l3.352"></a><span id="l3.352">           null,</span>
<a href="#l3.353"></a><span id="l3.353">           options</span>
<a href="#l3.354"></a><span id="l3.354">         );</span>
<a href="#l3.355"></a><span id="l3.355">         removeNotificationOnEnd(popup, installInfo.installs);</span>
<a href="#l3.356"></a><span id="l3.356">         break;</span>
<a href="#l3.357"></a><span id="l3.357">       }</span>
<a href="#l3.358"></a><span id="l3.358">       case &quot;addon-install-blocked&quot;: {</span>
<a href="#l3.359"></a><span id="l3.359" class="difflineminus">-        messageString = addonsBundle.getFormattedString(</span>
<a href="#l3.360"></a><span id="l3.360" class="difflineminus">-          &quot;xpinstallPromptMessage&quot;,</span>
<a href="#l3.361"></a><span id="l3.361" class="difflineminus">-          [brandShortName]</span>
<a href="#l3.362"></a><span id="l3.362" class="difflineminus">-        );</span>
<a href="#l3.363"></a><span id="l3.363" class="difflineplus">+        let hasHost = !!options.displayURI;</span>
<a href="#l3.364"></a><span id="l3.364" class="difflineplus">+        if (hasHost) {</span>
<a href="#l3.365"></a><span id="l3.365" class="difflineplus">+          messageString = addonsBundle.getFormattedString(</span>
<a href="#l3.366"></a><span id="l3.366" class="difflineplus">+            &quot;xpinstallPromptMessage.header&quot;,</span>
<a href="#l3.367"></a><span id="l3.367" class="difflineplus">+            [&quot;&lt;&gt;&quot;]</span>
<a href="#l3.368"></a><span id="l3.368" class="difflineplus">+          );</span>
<a href="#l3.369"></a><span id="l3.369" class="difflineplus">+          options.name = options.displayURI.displayHost;</span>
<a href="#l3.370"></a><span id="l3.370" class="difflineplus">+        } else {</span>
<a href="#l3.371"></a><span id="l3.371" class="difflineplus">+          messageString = addonsBundle.getString(</span>
<a href="#l3.372"></a><span id="l3.372" class="difflineplus">+            &quot;xpinstallPromptMessage.header.unknown&quot;</span>
<a href="#l3.373"></a><span id="l3.373" class="difflineplus">+          );</span>
<a href="#l3.374"></a><span id="l3.374" class="difflineplus">+        }</span>
<a href="#l3.375"></a><span id="l3.375" class="difflineplus">+        // displayURI becomes it's own label, so we unset it for this panel.</span>
<a href="#l3.376"></a><span id="l3.376" class="difflineplus">+        // It will become part of the messageString above.</span>
<a href="#l3.377"></a><span id="l3.377" class="difflineplus">+        options.displayURI = undefined;</span>
<a href="#l3.378"></a><span id="l3.378"> </span>
<a href="#l3.379"></a><span id="l3.379" class="difflineplus">+        options.eventCallback = topic =&gt; {</span>
<a href="#l3.380"></a><span id="l3.380" class="difflineplus">+          if (topic !== &quot;showing&quot;) {</span>
<a href="#l3.381"></a><span id="l3.381" class="difflineplus">+            return;</span>
<a href="#l3.382"></a><span id="l3.382" class="difflineplus">+          }</span>
<a href="#l3.383"></a><span id="l3.383" class="difflineplus">+          let doc = browser.ownerDocument;</span>
<a href="#l3.384"></a><span id="l3.384" class="difflineplus">+          let message = doc.getElementById(&quot;addon-install-blocked-message&quot;);</span>
<a href="#l3.385"></a><span id="l3.385" class="difflineplus">+          // We must remove any prior use of this panel message in this window.</span>
<a href="#l3.386"></a><span id="l3.386" class="difflineplus">+          while (message.firstChild) {</span>
<a href="#l3.387"></a><span id="l3.387" class="difflineplus">+            message.firstChild.remove();</span>
<a href="#l3.388"></a><span id="l3.388" class="difflineplus">+          }</span>
<a href="#l3.389"></a><span id="l3.389" class="difflineplus">+          if (hasHost) {</span>
<a href="#l3.390"></a><span id="l3.390" class="difflineplus">+            let text = addonsBundle.getString(&quot;xpinstallPromptMessage.message&quot;);</span>
<a href="#l3.391"></a><span id="l3.391" class="difflineplus">+            let b = doc.createElementNS(&quot;http://www.w3.org/1999/xhtml&quot;, &quot;b&quot;);</span>
<a href="#l3.392"></a><span id="l3.392" class="difflineplus">+            b.textContent = options.name;</span>
<a href="#l3.393"></a><span id="l3.393" class="difflineplus">+            let fragment = BrowserUtils.getLocalizedFragment(doc, text, b);</span>
<a href="#l3.394"></a><span id="l3.394" class="difflineplus">+            message.appendChild(fragment);</span>
<a href="#l3.395"></a><span id="l3.395" class="difflineplus">+          } else {</span>
<a href="#l3.396"></a><span id="l3.396" class="difflineplus">+            message.textContent = addonsBundle.getString(</span>
<a href="#l3.397"></a><span id="l3.397" class="difflineplus">+              &quot;xpinstallPromptMessage.message.unknown&quot;</span>
<a href="#l3.398"></a><span id="l3.398" class="difflineplus">+            );</span>
<a href="#l3.399"></a><span id="l3.399" class="difflineplus">+          }</span>
<a href="#l3.400"></a><span id="l3.400" class="difflineplus">+          let learnMore = doc.getElementById(&quot;addon-install-blocked-info&quot;);</span>
<a href="#l3.401"></a><span id="l3.401" class="difflineplus">+          learnMore.textContent = addonsBundle.getString(</span>
<a href="#l3.402"></a><span id="l3.402" class="difflineplus">+            &quot;xpinstallPromptMessage.learnMore&quot;</span>
<a href="#l3.403"></a><span id="l3.403" class="difflineplus">+          );</span>
<a href="#l3.404"></a><span id="l3.404" class="difflineplus">+          learnMore.setAttribute(</span>
<a href="#l3.405"></a><span id="l3.405" class="difflineplus">+            &quot;href&quot;,</span>
<a href="#l3.406"></a><span id="l3.406" class="difflineplus">+            Services.urlFormatter.formatURLPref(&quot;app.support.baseURL&quot;) +</span>
<a href="#l3.407"></a><span id="l3.407" class="difflineplus">+              &quot;unlisted-extensions-risks&quot;</span>
<a href="#l3.408"></a><span id="l3.408" class="difflineplus">+          );</span>
<a href="#l3.409"></a><span id="l3.409" class="difflineplus">+        };</span>
<a href="#l3.410"></a><span id="l3.410" class="difflineplus">+</span>
<a href="#l3.411"></a><span id="l3.411" class="difflineplus">+        let secHistogram = Services.telemetry.getHistogramById(&quot;SECURITY_UI&quot;);</span>
<a href="#l3.412"></a><span id="l3.412">         action = {</span>
<a href="#l3.413"></a><span id="l3.413" class="difflineminus">-          label: addonsBundle.getString(&quot;xpinstallPromptAllowButton&quot;),</span>
<a href="#l3.414"></a><span id="l3.414" class="difflineplus">+          label: addonsBundle.getString(&quot;xpinstallPromptMessage.install&quot;),</span>
<a href="#l3.415"></a><span id="l3.415">           accessKey: addonsBundle.getString(</span>
<a href="#l3.416"></a><span id="l3.416" class="difflineminus">-            &quot;xpinstallPromptAllowButton.accesskey&quot;</span>
<a href="#l3.417"></a><span id="l3.417" class="difflineplus">+            &quot;xpinstallPromptMessage.install.accesskey&quot;</span>
<a href="#l3.418"></a><span id="l3.418">           ),</span>
<a href="#l3.419"></a><span id="l3.419">           callback() {</span>
<a href="#l3.420"></a><span id="l3.420" class="difflineplus">+            secHistogram.add(</span>
<a href="#l3.421"></a><span id="l3.421" class="difflineplus">+              Ci.nsISecurityUITelemetry</span>
<a href="#l3.422"></a><span id="l3.422" class="difflineplus">+                .WARNING_ADDON_ASKING_PREVENTED_CLICK_THROUGH</span>
<a href="#l3.423"></a><span id="l3.423" class="difflineplus">+            );</span>
<a href="#l3.424"></a><span id="l3.424">             installInfo.install();</span>
<a href="#l3.425"></a><span id="l3.425">           },</span>
<a href="#l3.426"></a><span id="l3.426">         };</span>
<a href="#l3.427"></a><span id="l3.427" class="difflineminus">-        let secondaryAction = {</span>
<a href="#l3.428"></a><span id="l3.428" class="difflineplus">+        let dontAllowAction = {</span>
<a href="#l3.429"></a><span id="l3.429">           label: addonsBundle.getString(&quot;xpinstallPromptMessage.dontAllow&quot;),</span>
<a href="#l3.430"></a><span id="l3.430">           accessKey: addonsBundle.getString(</span>
<a href="#l3.431"></a><span id="l3.431">             &quot;xpinstallPromptMessage.dontAllow.accesskey&quot;</span>
<a href="#l3.432"></a><span id="l3.432">           ),</span>
<a href="#l3.433"></a><span id="l3.433">           callback: () =&gt; {</span>
<a href="#l3.434"></a><span id="l3.434">             for (let install of installInfo.installs) {</span>
<a href="#l3.435"></a><span id="l3.435">               if (install.state != AddonManager.STATE_CANCELLED) {</span>
<a href="#l3.436"></a><span id="l3.436">                 install.cancel();</span>
<a href="#l3.437"></a><span id="l3.437">               }</span>
<a href="#l3.438"></a><span id="l3.438">             }</span>
<a href="#l3.439"></a><span id="l3.439">           },</span>
<a href="#l3.440"></a><span id="l3.440">         };</span>
<a href="#l3.441"></a><span id="l3.441"> </span>
<a href="#l3.442"></a><span id="l3.442" class="difflineplus">+        secHistogram.add(</span>
<a href="#l3.443"></a><span id="l3.443" class="difflineplus">+          Ci.nsISecurityUITelemetry.WARNING_ADDON_ASKING_PREVENTED</span>
<a href="#l3.444"></a><span id="l3.444" class="difflineplus">+        );</span>
<a href="#l3.445"></a><span id="l3.445">         let popup = showNotification(</span>
<a href="#l3.446"></a><span id="l3.446">           browser,</span>
<a href="#l3.447"></a><span id="l3.447">           notificationID,</span>
<a href="#l3.448"></a><span id="l3.448">           messageString,</span>
<a href="#l3.449"></a><span id="l3.449">           anchorID,</span>
<a href="#l3.450"></a><span id="l3.450">           action,</span>
<a href="#l3.451"></a><span id="l3.451" class="difflineminus">-          [secondaryAction],</span>
<a href="#l3.452"></a><span id="l3.452" class="difflineplus">+          [dontAllowAction],</span>
<a href="#l3.453"></a><span id="l3.453">           options</span>
<a href="#l3.454"></a><span id="l3.454">         );</span>
<a href="#l3.455"></a><span id="l3.455">         removeNotificationOnEnd(popup, installInfo.installs);</span>
<a href="#l3.456"></a><span id="l3.456">         break;</span>
<a href="#l3.457"></a><span id="l3.457">       }</span>
<a href="#l3.458"></a><span id="l3.458">       case &quot;addon-install-started&quot;: {</span>
<a href="#l3.459"></a><span id="l3.459">         let needsDownload = function(install) {</span>
<a href="#l3.460"></a><span id="l3.460">           return install.state != AddonManager.STATE_DOWNLOADED;</span>
<a href="#l3.461"></a><span id="l3.461" class="difflineat">@@ -503,35 +476,28 @@ var gXPInstallObserver = {</span>
<a href="#l3.462"></a><span id="l3.462">           &quot;#1&quot;,</span>
<a href="#l3.463"></a><span id="l3.463">           installInfo.installs.length</span>
<a href="#l3.464"></a><span id="l3.464">         );</span>
<a href="#l3.465"></a><span id="l3.465">         options.installs = installInfo.installs;</span>
<a href="#l3.466"></a><span id="l3.466">         options.contentWindow = browser.contentWindow;</span>
<a href="#l3.467"></a><span id="l3.467">         options.sourceURI = browser.currentURI;</span>
<a href="#l3.468"></a><span id="l3.468">         options.eventCallback = function(event) {</span>
<a href="#l3.469"></a><span id="l3.469">           switch (event) {</span>
<a href="#l3.470"></a><span id="l3.470" class="difflineminus">-            case &quot;shown&quot;:</span>
<a href="#l3.471"></a><span id="l3.471" class="difflineminus">-              let notificationElement = [...this.owner.panel.children].find(</span>
<a href="#l3.472"></a><span id="l3.472" class="difflineminus">-                n =&gt; n.notification == this</span>
<a href="#l3.473"></a><span id="l3.473" class="difflineminus">-              );</span>
<a href="#l3.474"></a><span id="l3.474" class="difflineminus">-              if (notificationElement) {</span>
<a href="#l3.475"></a><span id="l3.475" class="difflineminus">-                notificationElement.setAttribute(&quot;mainactiondisabled&quot;, &quot;true&quot;);</span>
<a href="#l3.476"></a><span id="l3.476" class="difflineminus">-              }</span>
<a href="#l3.477"></a><span id="l3.477" class="difflineminus">-              break;</span>
<a href="#l3.478"></a><span id="l3.478">             case &quot;removed&quot;:</span>
<a href="#l3.479"></a><span id="l3.479">               options.contentWindow = null;</span>
<a href="#l3.480"></a><span id="l3.480">               options.sourceURI = null;</span>
<a href="#l3.481"></a><span id="l3.481">               break;</span>
<a href="#l3.482"></a><span id="l3.482">           }</span>
<a href="#l3.483"></a><span id="l3.483">         };</span>
<a href="#l3.484"></a><span id="l3.484">         action = {</span>
<a href="#l3.485"></a><span id="l3.485">           label: addonsBundle.getString(&quot;addonInstall.acceptButton2.label&quot;),</span>
<a href="#l3.486"></a><span id="l3.486">           accessKey: addonsBundle.getString(</span>
<a href="#l3.487"></a><span id="l3.487">             &quot;addonInstall.acceptButton2.accesskey&quot;</span>
<a href="#l3.488"></a><span id="l3.488">           ),</span>
<a href="#l3.489"></a><span id="l3.489" class="difflineplus">+          disabled: true,</span>
<a href="#l3.490"></a><span id="l3.490">           callback: () =&gt; {},</span>
<a href="#l3.491"></a><span id="l3.491">         };</span>
<a href="#l3.492"></a><span id="l3.492">         let secondaryAction = {</span>
<a href="#l3.493"></a><span id="l3.493">           label: addonsBundle.getString(&quot;addonInstall.cancelButton.label&quot;),</span>
<a href="#l3.494"></a><span id="l3.494">           accessKey: addonsBundle.getString(</span>
<a href="#l3.495"></a><span id="l3.495">             &quot;addonInstall.cancelButton.accesskey&quot;</span>
<a href="#l3.496"></a><span id="l3.496">           ),</span>
<a href="#l3.497"></a><span id="l3.497">           callback: () =&gt; {</span>
<a href="#l3.498"></a><span id="l3.498" class="difflineat">@@ -573,31 +539,54 @@ var gXPInstallObserver = {</span>
<a href="#l3.499"></a><span id="l3.499">               install.sourceURI.host;</span>
<a href="#l3.500"></a><span id="l3.500">           }</span>
<a href="#l3.501"></a><span id="l3.501"> </span>
<a href="#l3.502"></a><span id="l3.502">           let error =</span>
<a href="#l3.503"></a><span id="l3.503">             host || install.error == 0</span>
<a href="#l3.504"></a><span id="l3.504">               ? &quot;addonInstallError&quot;</span>
<a href="#l3.505"></a><span id="l3.505">               : &quot;addonLocalInstallError&quot;;</span>
<a href="#l3.506"></a><span id="l3.506">           let args;</span>
<a href="#l3.507"></a><span id="l3.507" class="difflineminus">-</span>
<a href="#l3.508"></a><span id="l3.508" class="difflineminus">-          // Temporarily replace the usual warning message with this more-likely one.</span>
<a href="#l3.509"></a><span id="l3.509">           if (install.error &lt; 0) {</span>
<a href="#l3.510"></a><span id="l3.510">             error += install.error;</span>
<a href="#l3.511"></a><span id="l3.511">             args = [brandShortName, install.name];</span>
<a href="#l3.512"></a><span id="l3.512">           } else if (</span>
<a href="#l3.513"></a><span id="l3.513">             install.addon.blocklistState == Ci.nsIBlocklistService.STATE_BLOCKED</span>
<a href="#l3.514"></a><span id="l3.514">           ) {</span>
<a href="#l3.515"></a><span id="l3.515">             error += &quot;Blocklisted&quot;;</span>
<a href="#l3.516"></a><span id="l3.516">             args = [install.name];</span>
<a href="#l3.517"></a><span id="l3.517">           } else {</span>
<a href="#l3.518"></a><span id="l3.518">             error += &quot;Incompatible&quot;;</span>
<a href="#l3.519"></a><span id="l3.519">             args = [brandShortName, Services.appinfo.version, install.name];</span>
<a href="#l3.520"></a><span id="l3.520">           }</span>
<a href="#l3.521"></a><span id="l3.521"> </span>
<a href="#l3.522"></a><span id="l3.522" class="difflineplus">+          if (</span>
<a href="#l3.523"></a><span id="l3.523" class="difflineplus">+            install.addon &amp;&amp;</span>
<a href="#l3.524"></a><span id="l3.524" class="difflineplus">+            !Services.policies.mayInstallAddon(install.addon)</span>
<a href="#l3.525"></a><span id="l3.525" class="difflineplus">+          ) {</span>
<a href="#l3.526"></a><span id="l3.526" class="difflineplus">+            error = &quot;addonInstallBlockedByPolicy&quot;;</span>
<a href="#l3.527"></a><span id="l3.527" class="difflineplus">+            let extensionSettings = Services.policies.getExtensionSettings(</span>
<a href="#l3.528"></a><span id="l3.528" class="difflineplus">+              install.addon.id</span>
<a href="#l3.529"></a><span id="l3.529" class="difflineplus">+            );</span>
<a href="#l3.530"></a><span id="l3.530" class="difflineplus">+            let message = &quot;&quot;;</span>
<a href="#l3.531"></a><span id="l3.531" class="difflineplus">+            if (</span>
<a href="#l3.532"></a><span id="l3.532" class="difflineplus">+              extensionSettings &amp;&amp;</span>
<a href="#l3.533"></a><span id="l3.533" class="difflineplus">+              &quot;blocked_install_message&quot; in extensionSettings</span>
<a href="#l3.534"></a><span id="l3.534" class="difflineplus">+            ) {</span>
<a href="#l3.535"></a><span id="l3.535" class="difflineplus">+              message = &quot; &quot; + extensionSettings.blocked_install_message;</span>
<a href="#l3.536"></a><span id="l3.536" class="difflineplus">+            }</span>
<a href="#l3.537"></a><span id="l3.537" class="difflineplus">+            args = [install.name, install.addon.id, message];</span>
<a href="#l3.538"></a><span id="l3.538" class="difflineplus">+          }</span>
<a href="#l3.539"></a><span id="l3.539" class="difflineplus">+</span>
<a href="#l3.540"></a><span id="l3.540" class="difflineplus">+          // Add Learn More link when refusing to install an unsigned add-on</span>
<a href="#l3.541"></a><span id="l3.541" class="difflineplus">+          if (install.error == AddonManager.ERROR_SIGNEDSTATE_REQUIRED) {</span>
<a href="#l3.542"></a><span id="l3.542" class="difflineplus">+            options.learnMoreURL =</span>
<a href="#l3.543"></a><span id="l3.543" class="difflineplus">+              Services.urlFormatter.formatURLPref(&quot;app.support.baseURL&quot;) +</span>
<a href="#l3.544"></a><span id="l3.544" class="difflineplus">+              &quot;unsigned-addons&quot;;</span>
<a href="#l3.545"></a><span id="l3.545" class="difflineplus">+          }</span>
<a href="#l3.546"></a><span id="l3.546" class="difflineplus">+</span>
<a href="#l3.547"></a><span id="l3.547">           messageString = addonsBundle.getFormattedString(error, args);</span>
<a href="#l3.548"></a><span id="l3.548"> </span>
<a href="#l3.549"></a><span id="l3.549">           showNotification(</span>
<a href="#l3.550"></a><span id="l3.550">             browser,</span>
<a href="#l3.551"></a><span id="l3.551">             notificationID,</span>
<a href="#l3.552"></a><span id="l3.552">             messageString,</span>
<a href="#l3.553"></a><span id="l3.553">             anchorID,</span>
<a href="#l3.554"></a><span id="l3.554">             action,</span>
<a href="#l3.555"></a><span id="l3.555" class="difflineat">@@ -623,221 +612,554 @@ var gXPInstallObserver = {</span>
<a href="#l3.556"></a><span id="l3.556"> </span>
<a href="#l3.557"></a><span id="l3.557">           this._removeProgressNotification(browser);</span>
<a href="#l3.558"></a><span id="l3.558">           this.showInstallConfirmation(browser, installInfo, height);</span>
<a href="#l3.559"></a><span id="l3.559">         };</span>
<a href="#l3.560"></a><span id="l3.560"> </span>
<a href="#l3.561"></a><span id="l3.561">         let progressNotification = getNotification(&quot;addon-progress&quot;, browser);</span>
<a href="#l3.562"></a><span id="l3.562">         if (progressNotification) {</span>
<a href="#l3.563"></a><span id="l3.563">           let downloadDuration = Date.now() - progressNotification._startTime;</span>
<a href="#l3.564"></a><span id="l3.564" class="difflineminus">-          let securityDelay = Services.prefs.getIntPref(</span>
<a href="#l3.565"></a><span id="l3.565" class="difflineminus">-            &quot;security.dialog_enable_delay&quot;</span>
<a href="#l3.566"></a><span id="l3.566" class="difflineminus">-          );</span>
<a href="#l3.567"></a><span id="l3.567" class="difflineminus">-          if (securityDelay &gt; downloadDuration) {</span>
<a href="#l3.568"></a><span id="l3.568" class="difflineplus">+          let securityDelay =</span>
<a href="#l3.569"></a><span id="l3.569" class="difflineplus">+            Services.prefs.getIntPref(&quot;security.dialog_enable_delay&quot;) -</span>
<a href="#l3.570"></a><span id="l3.570" class="difflineplus">+            downloadDuration;</span>
<a href="#l3.571"></a><span id="l3.571" class="difflineplus">+          if (securityDelay &gt; 0) {</span>
<a href="#l3.572"></a><span id="l3.572">             setTimeout(() =&gt; {</span>
<a href="#l3.573"></a><span id="l3.573">               // The download may have been cancelled during the security delay</span>
<a href="#l3.574"></a><span id="l3.574">               if (getNotification(&quot;addon-progress&quot;, browser)) {</span>
<a href="#l3.575"></a><span id="l3.575">                 showNotification();</span>
<a href="#l3.576"></a><span id="l3.576">               }</span>
<a href="#l3.577"></a><span id="l3.577" class="difflineminus">-            }, securityDelay - downloadDuration);</span>
<a href="#l3.578"></a><span id="l3.578" class="difflineplus">+            }, securityDelay);</span>
<a href="#l3.579"></a><span id="l3.579">             break;</span>
<a href="#l3.580"></a><span id="l3.580">           }</span>
<a href="#l3.581"></a><span id="l3.581">         }</span>
<a href="#l3.582"></a><span id="l3.582">         showNotification();</span>
<a href="#l3.583"></a><span id="l3.583">         break;</span>
<a href="#l3.584"></a><span id="l3.584">       }</span>
<a href="#l3.585"></a><span id="l3.585">       case &quot;addon-install-complete&quot;: {</span>
<a href="#l3.586"></a><span id="l3.586" class="difflineminus">-        this.showInstallNotification(browser, installInfo.installs[0].addon);</span>
<a href="#l3.587"></a><span id="l3.587" class="difflineminus">-        break;</span>
<a href="#l3.588"></a><span id="l3.588" class="difflineminus">-      }</span>
<a href="#l3.589"></a><span id="l3.589" class="difflineminus">-      case &quot;webextension-permission-prompt&quot;: {</span>
<a href="#l3.590"></a><span id="l3.590" class="difflineminus">-        let { info } = subject.wrappedJSObject;</span>
<a href="#l3.591"></a><span id="l3.591" class="difflineminus">-</span>
<a href="#l3.592"></a><span id="l3.592" class="difflineminus">-        // Dismiss the progress notification.  Note that this is bad if</span>
<a href="#l3.593"></a><span id="l3.593" class="difflineminus">-        // there are multiple simultaneous installs happening, see</span>
<a href="#l3.594"></a><span id="l3.594" class="difflineminus">-        // bug 1329884 for a longer explanation.</span>
<a href="#l3.595"></a><span id="l3.595" class="difflineminus">-        let progressNotification = getNotification(&quot;addon-progress&quot;, browser);</span>
<a href="#l3.596"></a><span id="l3.596" class="difflineminus">-        if (progressNotification) {</span>
<a href="#l3.597"></a><span id="l3.597" class="difflineminus">-          progressNotification.remove();</span>
<a href="#l3.598"></a><span id="l3.598" class="difflineminus">-        }</span>
<a href="#l3.599"></a><span id="l3.599" class="difflineminus">-</span>
<a href="#l3.600"></a><span id="l3.600" class="difflineminus">-        // This is where we should check for unsigned extensions, but Thunderbird</span>
<a href="#l3.601"></a><span id="l3.601" class="difflineminus">-        // doesn't require signing, so we just skip checking.</span>
<a href="#l3.602"></a><span id="l3.602" class="difflineminus">-        info.unsigned = false;</span>
<a href="#l3.603"></a><span id="l3.603" class="difflineminus">-</span>
<a href="#l3.604"></a><span id="l3.604" class="difflineminus">-        let strings = this._buildStrings(info);</span>
<a href="#l3.605"></a><span id="l3.605" class="difflineminus">-</span>
<a href="#l3.606"></a><span id="l3.606" class="difflineminus">-        // If this is an update with no promptable permissions, just apply it</span>
<a href="#l3.607"></a><span id="l3.607" class="difflineminus">-        if (info.type == &quot;update&quot; &amp;&amp; strings.msgs.length == 0) {</span>
<a href="#l3.608"></a><span id="l3.608" class="difflineminus">-          info.resolve();</span>
<a href="#l3.609"></a><span id="l3.609" class="difflineminus">-          return;</span>
<a href="#l3.610"></a><span id="l3.610" class="difflineminus">-        }</span>
<a href="#l3.611"></a><span id="l3.611" class="difflineplus">+        let secondaryActions = null;</span>
<a href="#l3.612"></a><span id="l3.612" class="difflineplus">+        let numAddons = installInfo.installs.length;</span>
<a href="#l3.613"></a><span id="l3.613"> </span>
<a href="#l3.614"></a><span id="l3.614" class="difflineminus">-        let icon = info.unsigned</span>
<a href="#l3.615"></a><span id="l3.615" class="difflineminus">-          ? &quot;chrome://global/skin/icons/warning.svg&quot;</span>
<a href="#l3.616"></a><span id="l3.616" class="difflineminus">-          : info.icon;</span>
<a href="#l3.617"></a><span id="l3.617" class="difflineplus">+        if (numAddons == 1) {</span>
<a href="#l3.618"></a><span id="l3.618" class="difflineplus">+          messageString = addonsBundle.getFormattedString(&quot;addonInstalled&quot;, [</span>
<a href="#l3.619"></a><span id="l3.619" class="difflineplus">+            installInfo.installs[0].name,</span>
<a href="#l3.620"></a><span id="l3.620" class="difflineplus">+          ]);</span>
<a href="#l3.621"></a><span id="l3.621" class="difflineplus">+        } else {</span>
<a href="#l3.622"></a><span id="l3.622" class="difflineplus">+          messageString = addonsBundle.getString(&quot;addonsGenericInstalled&quot;);</span>
<a href="#l3.623"></a><span id="l3.623" class="difflineplus">+          messageString = PluralForm.get(numAddons, messageString);</span>
<a href="#l3.624"></a><span id="l3.624" class="difflineplus">+          messageString = messageString.replace(&quot;#1&quot;, numAddons);</span>
<a href="#l3.625"></a><span id="l3.625" class="difflineplus">+        }</span>
<a href="#l3.626"></a><span id="l3.626" class="difflineplus">+        action = null;</span>
<a href="#l3.627"></a><span id="l3.627"> </span>
<a href="#l3.628"></a><span id="l3.628" class="difflineminus">-        this.showPermissionsPrompt(browser, strings, icon).then(answer =&gt; {</span>
<a href="#l3.629"></a><span id="l3.629" class="difflineminus">-          if (answer) {</span>
<a href="#l3.630"></a><span id="l3.630" class="difflineminus">-            info.resolve();</span>
<a href="#l3.631"></a><span id="l3.631" class="difflineminus">-          } else {</span>
<a href="#l3.632"></a><span id="l3.632" class="difflineminus">-            info.reject();</span>
<a href="#l3.633"></a><span id="l3.633" class="difflineminus">-          }</span>
<a href="#l3.634"></a><span id="l3.634" class="difflineminus">-        });</span>
<a href="#l3.635"></a><span id="l3.635" class="difflineminus">-        break;</span>
<a href="#l3.636"></a><span id="l3.636" class="difflineminus">-      }</span>
<a href="#l3.637"></a><span id="l3.637" class="difflineminus">-      case &quot;webextension-update-permissions&quot;: {</span>
<a href="#l3.638"></a><span id="l3.638" class="difflineminus">-        let info = subject.wrappedJSObject;</span>
<a href="#l3.639"></a><span id="l3.639" class="difflineminus">-        info.type = &quot;update&quot;;</span>
<a href="#l3.640"></a><span id="l3.640" class="difflineminus">-        let strings = this._buildStrings(info);</span>
<a href="#l3.641"></a><span id="l3.641" class="difflineplus">+        options.removeOnDismissal = true;</span>
<a href="#l3.642"></a><span id="l3.642" class="difflineplus">+        options.persistent = false;</span>
<a href="#l3.643"></a><span id="l3.643"> </span>
<a href="#l3.644"></a><span id="l3.644" class="difflineminus">-        // If we don't prompt for any new permissions, just apply it.</span>
<a href="#l3.645"></a><span id="l3.645" class="difflineminus">-        if (strings.msgs.length == 0) {</span>
<a href="#l3.646"></a><span id="l3.646" class="difflineminus">-          info.resolve();</span>
<a href="#l3.647"></a><span id="l3.647" class="difflineminus">-          return;</span>
<a href="#l3.648"></a><span id="l3.648" class="difflineminus">-        }</span>
<a href="#l3.649"></a><span id="l3.649" class="difflineminus">-</span>
<a href="#l3.650"></a><span id="l3.650" class="difflineminus">-        this.showPermissionsPrompt(browser, strings, info.addon.iconURL).then(</span>
<a href="#l3.651"></a><span id="l3.651" class="difflineminus">-          answer =&gt; {</span>
<a href="#l3.652"></a><span id="l3.652" class="difflineminus">-            if (answer) {</span>
<a href="#l3.653"></a><span id="l3.653" class="difflineminus">-              info.resolve();</span>
<a href="#l3.654"></a><span id="l3.654" class="difflineminus">-            } else {</span>
<a href="#l3.655"></a><span id="l3.655" class="difflineminus">-              info.reject();</span>
<a href="#l3.656"></a><span id="l3.656" class="difflineminus">-            }</span>
<a href="#l3.657"></a><span id="l3.657" class="difflineminus">-          }</span>
<a href="#l3.658"></a><span id="l3.658" class="difflineplus">+        showNotification(</span>
<a href="#l3.659"></a><span id="l3.659" class="difflineplus">+          browser,</span>
<a href="#l3.660"></a><span id="l3.660" class="difflineplus">+          notificationID,</span>
<a href="#l3.661"></a><span id="l3.661" class="difflineplus">+          messageString,</span>
<a href="#l3.662"></a><span id="l3.662" class="difflineplus">+          anchorID,</span>
<a href="#l3.663"></a><span id="l3.663" class="difflineplus">+          action,</span>
<a href="#l3.664"></a><span id="l3.664" class="difflineplus">+          secondaryActions,</span>
<a href="#l3.665"></a><span id="l3.665" class="difflineplus">+          options</span>
<a href="#l3.666"></a><span id="l3.666">         );</span>
<a href="#l3.667"></a><span id="l3.667">         break;</span>
<a href="#l3.668"></a><span id="l3.668">       }</span>
<a href="#l3.669"></a><span id="l3.669" class="difflineminus">-      case &quot;webextension-install-notify&quot;: {</span>
<a href="#l3.670"></a><span id="l3.670" class="difflineminus">-        let { addon } = subject.wrappedJSObject;</span>
<a href="#l3.671"></a><span id="l3.671" class="difflineminus">-        this.showInstallNotification(browser, addon);</span>
<a href="#l3.672"></a><span id="l3.672" class="difflineminus">-        break;</span>
<a href="#l3.673"></a><span id="l3.673" class="difflineminus">-      }</span>
<a href="#l3.674"></a><span id="l3.674" class="difflineminus">-      case &quot;webextension-optional-permission-prompt&quot;: {</span>
<a href="#l3.675"></a><span id="l3.675" class="difflineminus">-        let { name, icon, permissions, resolve } = subject.wrappedJSObject;</span>
<a href="#l3.676"></a><span id="l3.676" class="difflineminus">-        let strings = this._buildStrings({</span>
<a href="#l3.677"></a><span id="l3.677" class="difflineminus">-          type: &quot;optional&quot;,</span>
<a href="#l3.678"></a><span id="l3.678" class="difflineminus">-          addon: { name },</span>
<a href="#l3.679"></a><span id="l3.679" class="difflineminus">-          permissions,</span>
<a href="#l3.680"></a><span id="l3.680" class="difflineminus">-        });</span>
<a href="#l3.681"></a><span id="l3.681" class="difflineminus">-</span>
<a href="#l3.682"></a><span id="l3.682" class="difflineminus">-        // If we don't have any promptable permissions, just proceed</span>
<a href="#l3.683"></a><span id="l3.683" class="difflineminus">-        if (strings.msgs.length == 0) {</span>
<a href="#l3.684"></a><span id="l3.684" class="difflineminus">-          resolve(true);</span>
<a href="#l3.685"></a><span id="l3.685" class="difflineminus">-          return;</span>
<a href="#l3.686"></a><span id="l3.686" class="difflineminus">-        }</span>
<a href="#l3.687"></a><span id="l3.687" class="difflineminus">-        resolve(this.showPermissionsPrompt(browser, strings, icon));</span>
<a href="#l3.688"></a><span id="l3.688" class="difflineminus">-        break;</span>
<a href="#l3.689"></a><span id="l3.689" class="difflineminus">-      }</span>
<a href="#l3.690"></a><span id="l3.690">     }</span>
<a href="#l3.691"></a><span id="l3.691">   },</span>
<a href="#l3.692"></a><span id="l3.692" class="difflineminus">-  /* eslint-enable complexity */</span>
<a href="#l3.693"></a><span id="l3.693" class="difflineminus">-</span>
<a href="#l3.694"></a><span id="l3.694" class="difflineminus">-  // Create a set of formatted strings for a permission prompt</span>
<a href="#l3.695"></a><span id="l3.695" class="difflineminus">-  _buildStrings(info) {</span>
<a href="#l3.696"></a><span id="l3.696" class="difflineminus">-    // This bundle isn't the same as addonsBundle.</span>
<a href="#l3.697"></a><span id="l3.697" class="difflineminus">-    let bundle = Services.strings.createBundle(ADDONS_PROPERTIES);</span>
<a href="#l3.698"></a><span id="l3.698" class="difflineminus">-    let appName = brandBundle.getString(&quot;brandShortName&quot;);</span>
<a href="#l3.699"></a><span id="l3.699" class="difflineminus">-    let info2 = Object.assign({ appName }, info);</span>
<a href="#l3.700"></a><span id="l3.700" class="difflineminus">-</span>
<a href="#l3.701"></a><span id="l3.701" class="difflineminus">-    let strings = ExtensionData.formatPermissionStrings(info2, bundle);</span>
<a href="#l3.702"></a><span id="l3.702" class="difflineminus">-    strings.addonName = info.addon.name;</span>
<a href="#l3.703"></a><span id="l3.703" class="difflineminus">-    return strings;</span>
<a href="#l3.704"></a><span id="l3.704" class="difflineminus">-  },</span>
<a href="#l3.705"></a><span id="l3.705"> </span>
<a href="#l3.706"></a><span id="l3.706">   _removeProgressNotification(browser) {</span>
<a href="#l3.707"></a><span id="l3.707">     let notification = getNotification(&quot;addon-progress&quot;, browser);</span>
<a href="#l3.708"></a><span id="l3.708">     if (notification) {</span>
<a href="#l3.709"></a><span id="l3.709">       notification.remove();</span>
<a href="#l3.710"></a><span id="l3.710">     }</span>
<a href="#l3.711"></a><span id="l3.711">   },</span>
<a href="#l3.712"></a><span id="l3.712" class="difflineminus">-</span>
<a href="#l3.713"></a><span id="l3.713" class="difflineminus">-  async _checkForSideloaded(browser) {</span>
<a href="#l3.714"></a><span id="l3.714" class="difflineminus">-    let sideloaded = await AddonManagerPrivate.getNewSideloads();</span>
<a href="#l3.715"></a><span id="l3.715" class="difflineminus">-    if (sideloaded.length == 0) {</span>
<a href="#l3.716"></a><span id="l3.716" class="difflineminus">-      return;</span>
<a href="#l3.717"></a><span id="l3.717" class="difflineminus">-    }</span>
<a href="#l3.718"></a><span id="l3.718" class="difflineminus">-</span>
<a href="#l3.719"></a><span id="l3.719" class="difflineminus">-    // Check if the user wants any sideloaded add-ons installed.</span>
<a href="#l3.720"></a><span id="l3.720" class="difflineminus">-</span>
<a href="#l3.721"></a><span id="l3.721" class="difflineminus">-    let enabled = [];</span>
<a href="#l3.722"></a><span id="l3.722" class="difflineminus">-    for (let addon of sideloaded) {</span>
<a href="#l3.723"></a><span id="l3.723" class="difflineminus">-      let strings = this._buildStrings({</span>
<a href="#l3.724"></a><span id="l3.724" class="difflineminus">-        addon,</span>
<a href="#l3.725"></a><span id="l3.725" class="difflineminus">-        permissions: addon.userPermissions,</span>
<a href="#l3.726"></a><span id="l3.726" class="difflineminus">-        type: &quot;sideload&quot;,</span>
<a href="#l3.727"></a><span id="l3.727" class="difflineminus">-      });</span>
<a href="#l3.728"></a><span id="l3.728" class="difflineminus">-      let answer = await this.showPermissionsPrompt(</span>
<a href="#l3.729"></a><span id="l3.729" class="difflineminus">-        browser,</span>
<a href="#l3.730"></a><span id="l3.730" class="difflineminus">-        strings,</span>
<a href="#l3.731"></a><span id="l3.731" class="difflineminus">-        addon.iconURL</span>
<a href="#l3.732"></a><span id="l3.732" class="difflineminus">-      );</span>
<a href="#l3.733"></a><span id="l3.733" class="difflineminus">-      if (answer) {</span>
<a href="#l3.734"></a><span id="l3.734" class="difflineminus">-        await addon.enable();</span>
<a href="#l3.735"></a><span id="l3.735" class="difflineminus">-        enabled.push(addon);</span>
<a href="#l3.736"></a><span id="l3.736" class="difflineminus">-      }</span>
<a href="#l3.737"></a><span id="l3.737" class="difflineminus">-    }</span>
<a href="#l3.738"></a><span id="l3.738" class="difflineminus">-</span>
<a href="#l3.739"></a><span id="l3.739" class="difflineminus">-    if (enabled.length == 0) {</span>
<a href="#l3.740"></a><span id="l3.740" class="difflineminus">-      return;</span>
<a href="#l3.741"></a><span id="l3.741" class="difflineminus">-    }</span>
<a href="#l3.742"></a><span id="l3.742" class="difflineminus">-</span>
<a href="#l3.743"></a><span id="l3.743" class="difflineminus">-    // Confirm sideloaded add-ons were installed and ask to restart if necessary.</span>
<a href="#l3.744"></a><span id="l3.744" class="difflineminus">-</span>
<a href="#l3.745"></a><span id="l3.745" class="difflineminus">-    if (enabled.length == 1) {</span>
<a href="#l3.746"></a><span id="l3.746" class="difflineminus">-      this.showInstallNotification(browser, enabled[0]);</span>
<a href="#l3.747"></a><span id="l3.747" class="difflineminus">-      return;</span>
<a href="#l3.748"></a><span id="l3.748" class="difflineminus">-    }</span>
<a href="#l3.749"></a><span id="l3.749" class="difflineminus">-</span>
<a href="#l3.750"></a><span id="l3.750" class="difflineminus">-    let document = getTopWindow().document;</span>
<a href="#l3.751"></a><span id="l3.751" class="difflineminus">-</span>
<a href="#l3.752"></a><span id="l3.752" class="difflineminus">-    let brandBundle = document.getElementById(&quot;bundle_brand&quot;);</span>
<a href="#l3.753"></a><span id="l3.753" class="difflineminus">-    let appName = brandBundle.getString(&quot;brandShortName&quot;);</span>
<a href="#l3.754"></a><span id="l3.754" class="difflineminus">-</span>
<a href="#l3.755"></a><span id="l3.755" class="difflineminus">-    let message = addonsBundle.getFormattedString(</span>
<a href="#l3.756"></a><span id="l3.756" class="difflineminus">-      &quot;addonPostInstall.multiple.message&quot;,</span>
<a href="#l3.757"></a><span id="l3.757" class="difflineminus">-      [appName]</span>
<a href="#l3.758"></a><span id="l3.758" class="difflineminus">-    );</span>
<a href="#l3.759"></a><span id="l3.759" class="difflineminus">-</span>
<a href="#l3.760"></a><span id="l3.760" class="difflineminus">-    let list = document.getElementById(&quot;addon-installed-list&quot;);</span>
<a href="#l3.761"></a><span id="l3.761" class="difflineminus">-    list.hidden = false;</span>
<a href="#l3.762"></a><span id="l3.762" class="difflineminus">-    while (list.lastChild) {</span>
<a href="#l3.763"></a><span id="l3.763" class="difflineminus">-      list.lastChild.remove();</span>
<a href="#l3.764"></a><span id="l3.764" class="difflineminus">-    }</span>
<a href="#l3.765"></a><span id="l3.765" class="difflineminus">-</span>
<a href="#l3.766"></a><span id="l3.766" class="difflineminus">-    for (let addon of enabled) {</span>
<a href="#l3.767"></a><span id="l3.767" class="difflineminus">-      let item = document.createElementNS(HTML_NS, &quot;li&quot;);</span>
<a href="#l3.768"></a><span id="l3.768" class="difflineminus">-      item.textContent = addon.name;</span>
<a href="#l3.769"></a><span id="l3.769" class="difflineminus">-      list.appendChild(item);</span>
<a href="#l3.770"></a><span id="l3.770" class="difflineminus">-    }</span>
<a href="#l3.771"></a><span id="l3.771" class="difflineminus">-</span>
<a href="#l3.772"></a><span id="l3.772" class="difflineminus">-    let options = {</span>
<a href="#l3.773"></a><span id="l3.773" class="difflineminus">-      popupIconURL: DEFAULT_EXTENSION_ICON,</span>
<a href="#l3.774"></a><span id="l3.774" class="difflineminus">-      hideClose: true,</span>
<a href="#l3.775"></a><span id="l3.775" class="difflineminus">-      timeout: Date.now() + 30000,</span>
<a href="#l3.776"></a><span id="l3.776" class="difflineminus">-    };</span>
<a href="#l3.777"></a><span id="l3.777" class="difflineminus">-</span>
<a href="#l3.778"></a><span id="l3.778" class="difflineminus">-    this._showInstallNotification(browser, message, options);</span>
<a href="#l3.779"></a><span id="l3.779" class="difflineminus">-  },</span>
<a href="#l3.780"></a><span id="l3.780"> };</span>
<a href="#l3.781"></a><span id="l3.781"> </span>
<a href="#l3.782"></a><span id="l3.782"> Services.obs.addObserver(gXPInstallObserver, &quot;addon-install-disabled&quot;);</span>
<a href="#l3.783"></a><span id="l3.783"> Services.obs.addObserver(gXPInstallObserver, &quot;addon-install-origin-blocked&quot;);</span>
<a href="#l3.784"></a><span id="l3.784"> Services.obs.addObserver(gXPInstallObserver, &quot;addon-install-blocked&quot;);</span>
<a href="#l3.785"></a><span id="l3.785"> Services.obs.addObserver(gXPInstallObserver, &quot;addon-install-started&quot;);</span>
<a href="#l3.786"></a><span id="l3.786"> Services.obs.addObserver(gXPInstallObserver, &quot;addon-install-failed&quot;);</span>
<a href="#l3.787"></a><span id="l3.787"> Services.obs.addObserver(gXPInstallObserver, &quot;addon-install-confirmation&quot;);</span>
<a href="#l3.788"></a><span id="l3.788"> Services.obs.addObserver(gXPInstallObserver, &quot;addon-install-complete&quot;);</span>
<a href="#l3.789"></a><span id="l3.789" class="difflineminus">-Services.obs.addObserver(gXPInstallObserver, &quot;webextension-permission-prompt&quot;);</span>
<a href="#l3.790"></a><span id="l3.790" class="difflineminus">-Services.obs.addObserver(gXPInstallObserver, &quot;webextension-update-permissions&quot;);</span>
<a href="#l3.791"></a><span id="l3.791" class="difflineminus">-Services.obs.addObserver(gXPInstallObserver, &quot;webextension-install-notify&quot;);</span>
<a href="#l3.792"></a><span id="l3.792" class="difflineminus">-Services.obs.addObserver(</span>
<a href="#l3.793"></a><span id="l3.793" class="difflineminus">-  gXPInstallObserver,</span>
<a href="#l3.794"></a><span id="l3.794" class="difflineminus">-  &quot;webextension-optional-permission-prompt&quot;</span>
<a href="#l3.795"></a><span id="l3.795" class="difflineminus">-);</span>
<a href="#l3.796"></a><span id="l3.796" class="difflineplus">+</span>
<a href="#l3.797"></a><span id="l3.797" class="difflineplus">+/**</span>
<a href="#l3.798"></a><span id="l3.798" class="difflineplus">+ * This object is Thunderbird's version of the same object in</span>
<a href="#l3.799"></a><span id="l3.799" class="difflineplus">+ * browser/modules/ExtensionsUI.jsm</span>
<a href="#l3.800"></a><span id="l3.800" class="difflineplus">+ */</span>
<a href="#l3.801"></a><span id="l3.801" class="difflineplus">+var ExtensionsUI = {</span>
<a href="#l3.802"></a><span id="l3.802" class="difflineplus">+  sideloaded: new Set(),</span>
<a href="#l3.803"></a><span id="l3.803" class="difflineplus">+  updates: new Set(),</span>
<a href="#l3.804"></a><span id="l3.804" class="difflineplus">+  sideloadListener: null,</span>
<a href="#l3.805"></a><span id="l3.805" class="difflineplus">+  histogram: null,</span>
<a href="#l3.806"></a><span id="l3.806" class="difflineplus">+</span>
<a href="#l3.807"></a><span id="l3.807" class="difflineplus">+  pendingNotifications: new WeakMap(),</span>
<a href="#l3.808"></a><span id="l3.808" class="difflineplus">+</span>
<a href="#l3.809"></a><span id="l3.809" class="difflineplus">+  async init() {</span>
<a href="#l3.810"></a><span id="l3.810" class="difflineplus">+    this.histogram = Services.telemetry.getHistogramById(</span>
<a href="#l3.811"></a><span id="l3.811" class="difflineplus">+      &quot;EXTENSION_INSTALL_PROMPT_RESULT&quot;</span>
<a href="#l3.812"></a><span id="l3.812" class="difflineplus">+    );</span>
<a href="#l3.813"></a><span id="l3.813" class="difflineplus">+</span>
<a href="#l3.814"></a><span id="l3.814" class="difflineplus">+    Services.obs.addObserver(this, &quot;webextension-permission-prompt&quot;);</span>
<a href="#l3.815"></a><span id="l3.815" class="difflineplus">+    Services.obs.addObserver(this, &quot;webextension-update-permissions&quot;);</span>
<a href="#l3.816"></a><span id="l3.816" class="difflineplus">+    Services.obs.addObserver(this, &quot;webextension-install-notify&quot;);</span>
<a href="#l3.817"></a><span id="l3.817" class="difflineplus">+    Services.obs.addObserver(this, &quot;webextension-optional-permission-prompt&quot;);</span>
<a href="#l3.818"></a><span id="l3.818" class="difflineplus">+    Services.obs.addObserver(this, &quot;webextension-defaultsearch-prompt&quot;);</span>
<a href="#l3.819"></a><span id="l3.819" class="difflineplus">+</span>
<a href="#l3.820"></a><span id="l3.820" class="difflineplus">+    this._checkForSideloaded();</span>
<a href="#l3.821"></a><span id="l3.821" class="difflineplus">+  },</span>
<a href="#l3.822"></a><span id="l3.822" class="difflineplus">+</span>
<a href="#l3.823"></a><span id="l3.823" class="difflineplus">+  async _checkForSideloaded() {</span>
<a href="#l3.824"></a><span id="l3.824" class="difflineplus">+    let sideloaded = await AddonManagerPrivate.getNewSideloads();</span>
<a href="#l3.825"></a><span id="l3.825" class="difflineplus">+</span>
<a href="#l3.826"></a><span id="l3.826" class="difflineplus">+    if (!sideloaded.length) {</span>
<a href="#l3.827"></a><span id="l3.827" class="difflineplus">+      // No new side-loads. We're done.</span>
<a href="#l3.828"></a><span id="l3.828" class="difflineplus">+      return;</span>
<a href="#l3.829"></a><span id="l3.829" class="difflineplus">+    }</span>
<a href="#l3.830"></a><span id="l3.830" class="difflineplus">+</span>
<a href="#l3.831"></a><span id="l3.831" class="difflineplus">+    // The ordering shouldn't matter, but tests depend on notifications</span>
<a href="#l3.832"></a><span id="l3.832" class="difflineplus">+    // happening in a specific order.</span>
<a href="#l3.833"></a><span id="l3.833" class="difflineplus">+    sideloaded.sort((a, b) =&gt; a.id.localeCompare(b.id));</span>
<a href="#l3.834"></a><span id="l3.834" class="difflineplus">+</span>
<a href="#l3.835"></a><span id="l3.835" class="difflineplus">+    if (WEBEXT_PERMISSION_PROMPTS) {</span>
<a href="#l3.836"></a><span id="l3.836" class="difflineplus">+      if (!this.sideloadListener) {</span>
<a href="#l3.837"></a><span id="l3.837" class="difflineplus">+        this.sideloadListener = {</span>
<a href="#l3.838"></a><span id="l3.838" class="difflineplus">+          onEnabled: addon =&gt; {</span>
<a href="#l3.839"></a><span id="l3.839" class="difflineplus">+            if (!this.sideloaded.has(addon)) {</span>
<a href="#l3.840"></a><span id="l3.840" class="difflineplus">+              return;</span>
<a href="#l3.841"></a><span id="l3.841" class="difflineplus">+            }</span>
<a href="#l3.842"></a><span id="l3.842" class="difflineplus">+</span>
<a href="#l3.843"></a><span id="l3.843" class="difflineplus">+            this.sideloaded.delete(addon);</span>
<a href="#l3.844"></a><span id="l3.844" class="difflineplus">+            this._updateNotifications();</span>
<a href="#l3.845"></a><span id="l3.845" class="difflineplus">+</span>
<a href="#l3.846"></a><span id="l3.846" class="difflineplus">+            if (this.sideloaded.size == 0) {</span>
<a href="#l3.847"></a><span id="l3.847" class="difflineplus">+              AddonManager.removeAddonListener(this.sideloadListener);</span>
<a href="#l3.848"></a><span id="l3.848" class="difflineplus">+              this.sideloadListener = null;</span>
<a href="#l3.849"></a><span id="l3.849" class="difflineplus">+            }</span>
<a href="#l3.850"></a><span id="l3.850" class="difflineplus">+          },</span>
<a href="#l3.851"></a><span id="l3.851" class="difflineplus">+        };</span>
<a href="#l3.852"></a><span id="l3.852" class="difflineplus">+        AddonManager.addAddonListener(this.sideloadListener);</span>
<a href="#l3.853"></a><span id="l3.853" class="difflineplus">+      }</span>
<a href="#l3.854"></a><span id="l3.854" class="difflineplus">+</span>
<a href="#l3.855"></a><span id="l3.855" class="difflineplus">+      for (let addon of sideloaded) {</span>
<a href="#l3.856"></a><span id="l3.856" class="difflineplus">+        this.sideloaded.add(addon);</span>
<a href="#l3.857"></a><span id="l3.857" class="difflineplus">+      }</span>
<a href="#l3.858"></a><span id="l3.858" class="difflineplus">+      this._updateNotifications();</span>
<a href="#l3.859"></a><span id="l3.859" class="difflineplus">+    }</span>
<a href="#l3.860"></a><span id="l3.860" class="difflineplus">+  },</span>
<a href="#l3.861"></a><span id="l3.861" class="difflineplus">+</span>
<a href="#l3.862"></a><span id="l3.862" class="difflineplus">+  _updateNotifications() {</span>
<a href="#l3.863"></a><span id="l3.863" class="difflineplus">+    if (this.sideloaded.size + this.updates.size == 0) {</span>
<a href="#l3.864"></a><span id="l3.864" class="difflineplus">+      AppMenuNotifications.removeNotification(&quot;addon-alert&quot;);</span>
<a href="#l3.865"></a><span id="l3.865" class="difflineplus">+    } else {</span>
<a href="#l3.866"></a><span id="l3.866" class="difflineplus">+      AppMenuNotifications.showBadgeOnlyNotification(&quot;addon-alert&quot;);</span>
<a href="#l3.867"></a><span id="l3.867" class="difflineplus">+    }</span>
<a href="#l3.868"></a><span id="l3.868" class="difflineplus">+    this.emit(&quot;change&quot;);</span>
<a href="#l3.869"></a><span id="l3.869" class="difflineplus">+  },</span>
<a href="#l3.870"></a><span id="l3.870" class="difflineplus">+</span>
<a href="#l3.871"></a><span id="l3.871" class="difflineplus">+  showSideloaded(tabbrowser, addon) {</span>
<a href="#l3.872"></a><span id="l3.872" class="difflineplus">+    addon.markAsSeen();</span>
<a href="#l3.873"></a><span id="l3.873" class="difflineplus">+    this.sideloaded.delete(addon);</span>
<a href="#l3.874"></a><span id="l3.874" class="difflineplus">+    this._updateNotifications();</span>
<a href="#l3.875"></a><span id="l3.875" class="difflineplus">+</span>
<a href="#l3.876"></a><span id="l3.876" class="difflineplus">+    let strings = this._buildStrings({</span>
<a href="#l3.877"></a><span id="l3.877" class="difflineplus">+      addon,</span>
<a href="#l3.878"></a><span id="l3.878" class="difflineplus">+      permissions: addon.userPermissions,</span>
<a href="#l3.879"></a><span id="l3.879" class="difflineplus">+      type: &quot;sideload&quot;,</span>
<a href="#l3.880"></a><span id="l3.880" class="difflineplus">+    });</span>
<a href="#l3.881"></a><span id="l3.881" class="difflineplus">+</span>
<a href="#l3.882"></a><span id="l3.882" class="difflineplus">+    AMTelemetry.recordManageEvent(addon, &quot;sideload_prompt&quot;, {</span>
<a href="#l3.883"></a><span id="l3.883" class="difflineplus">+      num_strings: strings.msgs.length,</span>
<a href="#l3.884"></a><span id="l3.884" class="difflineplus">+    });</span>
<a href="#l3.885"></a><span id="l3.885" class="difflineplus">+</span>
<a href="#l3.886"></a><span id="l3.886" class="difflineplus">+    this.showPermissionsPrompt(</span>
<a href="#l3.887"></a><span id="l3.887" class="difflineplus">+      tabbrowser,</span>
<a href="#l3.888"></a><span id="l3.888" class="difflineplus">+      strings,</span>
<a href="#l3.889"></a><span id="l3.889" class="difflineplus">+      addon.iconURL,</span>
<a href="#l3.890"></a><span id="l3.890" class="difflineplus">+      &quot;sideload&quot;</span>
<a href="#l3.891"></a><span id="l3.891" class="difflineplus">+    ).then(async answer =&gt; {</span>
<a href="#l3.892"></a><span id="l3.892" class="difflineplus">+      if (answer) {</span>
<a href="#l3.893"></a><span id="l3.893" class="difflineplus">+        await addon.enable();</span>
<a href="#l3.894"></a><span id="l3.894" class="difflineplus">+        this._updateNotifications();</span>
<a href="#l3.895"></a><span id="l3.895" class="difflineplus">+      }</span>
<a href="#l3.896"></a><span id="l3.896" class="difflineplus">+      this.emit(&quot;sideload-response&quot;);</span>
<a href="#l3.897"></a><span id="l3.897" class="difflineplus">+    });</span>
<a href="#l3.898"></a><span id="l3.898" class="difflineplus">+  },</span>
<a href="#l3.899"></a><span id="l3.899" class="difflineplus">+</span>
<a href="#l3.900"></a><span id="l3.900" class="difflineplus">+  showUpdate(browser, info) {</span>
<a href="#l3.901"></a><span id="l3.901" class="difflineplus">+    AMTelemetry.recordInstallEvent(info.install, {</span>
<a href="#l3.902"></a><span id="l3.902" class="difflineplus">+      step: &quot;permissions_prompt&quot;,</span>
<a href="#l3.903"></a><span id="l3.903" class="difflineplus">+      num_strings: info.strings.msgs.length,</span>
<a href="#l3.904"></a><span id="l3.904" class="difflineplus">+    });</span>
<a href="#l3.905"></a><span id="l3.905" class="difflineplus">+</span>
<a href="#l3.906"></a><span id="l3.906" class="difflineplus">+    this.showPermissionsPrompt(</span>
<a href="#l3.907"></a><span id="l3.907" class="difflineplus">+      browser,</span>
<a href="#l3.908"></a><span id="l3.908" class="difflineplus">+      info.strings,</span>
<a href="#l3.909"></a><span id="l3.909" class="difflineplus">+      info.addon.iconURL,</span>
<a href="#l3.910"></a><span id="l3.910" class="difflineplus">+      &quot;update&quot;</span>
<a href="#l3.911"></a><span id="l3.911" class="difflineplus">+    ).then(answer =&gt; {</span>
<a href="#l3.912"></a><span id="l3.912" class="difflineplus">+      if (answer) {</span>
<a href="#l3.913"></a><span id="l3.913" class="difflineplus">+        info.resolve();</span>
<a href="#l3.914"></a><span id="l3.914" class="difflineplus">+      } else {</span>
<a href="#l3.915"></a><span id="l3.915" class="difflineplus">+        info.reject();</span>
<a href="#l3.916"></a><span id="l3.916" class="difflineplus">+      }</span>
<a href="#l3.917"></a><span id="l3.917" class="difflineplus">+      // At the moment, this prompt will re-appear next time we do an update</span>
<a href="#l3.918"></a><span id="l3.918" class="difflineplus">+      // check.  See bug 1332360 for proposal to avoid this.</span>
<a href="#l3.919"></a><span id="l3.919" class="difflineplus">+      this.updates.delete(info);</span>
<a href="#l3.920"></a><span id="l3.920" class="difflineplus">+      this._updateNotifications();</span>
<a href="#l3.921"></a><span id="l3.921" class="difflineplus">+    });</span>
<a href="#l3.922"></a><span id="l3.922" class="difflineplus">+  },</span>
<a href="#l3.923"></a><span id="l3.923" class="difflineplus">+</span>
<a href="#l3.924"></a><span id="l3.924" class="difflineplus">+  observe(subject, topic, data) {</span>
<a href="#l3.925"></a><span id="l3.925" class="difflineplus">+    if (topic == &quot;webextension-permission-prompt&quot;) {</span>
<a href="#l3.926"></a><span id="l3.926" class="difflineplus">+      let { target, info } = subject.wrappedJSObject;</span>
<a href="#l3.927"></a><span id="l3.927" class="difflineplus">+</span>
<a href="#l3.928"></a><span id="l3.928" class="difflineplus">+      let { browser } = getTabBrowser(target);</span>
<a href="#l3.929"></a><span id="l3.929" class="difflineplus">+</span>
<a href="#l3.930"></a><span id="l3.930" class="difflineplus">+      // Dismiss the progress notification.  Note that this is bad if</span>
<a href="#l3.931"></a><span id="l3.931" class="difflineplus">+      // there are multiple simultaneous installs happening, see</span>
<a href="#l3.932"></a><span id="l3.932" class="difflineplus">+      // bug 1329884 for a longer explanation.</span>
<a href="#l3.933"></a><span id="l3.933" class="difflineplus">+      let progressNotification = getNotification(&quot;addon-progress&quot;, browser);</span>
<a href="#l3.934"></a><span id="l3.934" class="difflineplus">+      if (progressNotification) {</span>
<a href="#l3.935"></a><span id="l3.935" class="difflineplus">+        progressNotification.remove();</span>
<a href="#l3.936"></a><span id="l3.936" class="difflineplus">+      }</span>
<a href="#l3.937"></a><span id="l3.937" class="difflineplus">+</span>
<a href="#l3.938"></a><span id="l3.938" class="difflineplus">+      info.unsigned =</span>
<a href="#l3.939"></a><span id="l3.939" class="difflineplus">+        info.addon.signedState &lt;= AddonManager.SIGNEDSTATE_MISSING;</span>
<a href="#l3.940"></a><span id="l3.940" class="difflineplus">+      if (</span>
<a href="#l3.941"></a><span id="l3.941" class="difflineplus">+        info.unsigned &amp;&amp;</span>
<a href="#l3.942"></a><span id="l3.942" class="difflineplus">+        Cu.isInAutomation &amp;&amp;</span>
<a href="#l3.943"></a><span id="l3.943" class="difflineplus">+        Services.prefs.getBoolPref(&quot;extensions.ui.ignoreUnsigned&quot;, false)</span>
<a href="#l3.944"></a><span id="l3.944" class="difflineplus">+      ) {</span>
<a href="#l3.945"></a><span id="l3.945" class="difflineplus">+        info.unsigned = false;</span>
<a href="#l3.946"></a><span id="l3.946" class="difflineplus">+      }</span>
<a href="#l3.947"></a><span id="l3.947" class="difflineplus">+</span>
<a href="#l3.948"></a><span id="l3.948" class="difflineplus">+      let strings = this._buildStrings(info);</span>
<a href="#l3.949"></a><span id="l3.949" class="difflineplus">+</span>
<a href="#l3.950"></a><span id="l3.950" class="difflineplus">+      // If this is an update with no promptable permissions, just apply it</span>
<a href="#l3.951"></a><span id="l3.951" class="difflineplus">+      if (info.type == &quot;update&quot; &amp;&amp; !strings.msgs.length) {</span>
<a href="#l3.952"></a><span id="l3.952" class="difflineplus">+        info.resolve();</span>
<a href="#l3.953"></a><span id="l3.953" class="difflineplus">+        return;</span>
<a href="#l3.954"></a><span id="l3.954" class="difflineplus">+      }</span>
<a href="#l3.955"></a><span id="l3.955" class="difflineplus">+</span>
<a href="#l3.956"></a><span id="l3.956" class="difflineplus">+      let histkey;</span>
<a href="#l3.957"></a><span id="l3.957" class="difflineplus">+      if (info.type == &quot;sideload&quot;) {</span>
<a href="#l3.958"></a><span id="l3.958" class="difflineplus">+        histkey = &quot;sideload&quot;;</span>
<a href="#l3.959"></a><span id="l3.959" class="difflineplus">+      } else if (info.type == &quot;update&quot;) {</span>
<a href="#l3.960"></a><span id="l3.960" class="difflineplus">+        histkey = &quot;update&quot;;</span>
<a href="#l3.961"></a><span id="l3.961" class="difflineplus">+      } else if (info.source == &quot;AMO&quot;) {</span>
<a href="#l3.962"></a><span id="l3.962" class="difflineplus">+        histkey = &quot;installAmo&quot;;</span>
<a href="#l3.963"></a><span id="l3.963" class="difflineplus">+      } else if (info.source == &quot;local&quot;) {</span>
<a href="#l3.964"></a><span id="l3.964" class="difflineplus">+        histkey = &quot;installLocal&quot;;</span>
<a href="#l3.965"></a><span id="l3.965" class="difflineplus">+      } else {</span>
<a href="#l3.966"></a><span id="l3.966" class="difflineplus">+        histkey = &quot;installWeb&quot;;</span>
<a href="#l3.967"></a><span id="l3.967" class="difflineplus">+      }</span>
<a href="#l3.968"></a><span id="l3.968" class="difflineplus">+</span>
<a href="#l3.969"></a><span id="l3.969" class="difflineplus">+      if (info.type == &quot;sideload&quot;) {</span>
<a href="#l3.970"></a><span id="l3.970" class="difflineplus">+        AMTelemetry.recordManageEvent(info.addon, &quot;sideload_prompt&quot;, {</span>
<a href="#l3.971"></a><span id="l3.971" class="difflineplus">+          num_strings: strings.msgs.length,</span>
<a href="#l3.972"></a><span id="l3.972" class="difflineplus">+        });</span>
<a href="#l3.973"></a><span id="l3.973" class="difflineplus">+      } else {</span>
<a href="#l3.974"></a><span id="l3.974" class="difflineplus">+        AMTelemetry.recordInstallEvent(info.install, {</span>
<a href="#l3.975"></a><span id="l3.975" class="difflineplus">+          step: &quot;permissions_prompt&quot;,</span>
<a href="#l3.976"></a><span id="l3.976" class="difflineplus">+          num_strings: strings.msgs.length,</span>
<a href="#l3.977"></a><span id="l3.977" class="difflineplus">+        });</span>
<a href="#l3.978"></a><span id="l3.978" class="difflineplus">+      }</span>
<a href="#l3.979"></a><span id="l3.979" class="difflineplus">+</span>
<a href="#l3.980"></a><span id="l3.980" class="difflineplus">+      this.showPermissionsPrompt(browser, strings, info.icon, histkey).then(</span>
<a href="#l3.981"></a><span id="l3.981" class="difflineplus">+        answer =&gt; {</span>
<a href="#l3.982"></a><span id="l3.982" class="difflineplus">+          if (answer) {</span>
<a href="#l3.983"></a><span id="l3.983" class="difflineplus">+            info.resolve();</span>
<a href="#l3.984"></a><span id="l3.984" class="difflineplus">+          } else {</span>
<a href="#l3.985"></a><span id="l3.985" class="difflineplus">+            info.reject();</span>
<a href="#l3.986"></a><span id="l3.986" class="difflineplus">+          }</span>
<a href="#l3.987"></a><span id="l3.987" class="difflineplus">+        }</span>
<a href="#l3.988"></a><span id="l3.988" class="difflineplus">+      );</span>
<a href="#l3.989"></a><span id="l3.989" class="difflineplus">+    } else if (topic == &quot;webextension-update-permissions&quot;) {</span>
<a href="#l3.990"></a><span id="l3.990" class="difflineplus">+      let info = subject.wrappedJSObject;</span>
<a href="#l3.991"></a><span id="l3.991" class="difflineplus">+      info.type = &quot;update&quot;;</span>
<a href="#l3.992"></a><span id="l3.992" class="difflineplus">+      let strings = this._buildStrings(info);</span>
<a href="#l3.993"></a><span id="l3.993" class="difflineplus">+</span>
<a href="#l3.994"></a><span id="l3.994" class="difflineplus">+      // If we don't prompt for any new permissions, just apply it</span>
<a href="#l3.995"></a><span id="l3.995" class="difflineplus">+      if (!strings.msgs.length) {</span>
<a href="#l3.996"></a><span id="l3.996" class="difflineplus">+        info.resolve();</span>
<a href="#l3.997"></a><span id="l3.997" class="difflineplus">+        return;</span>
<a href="#l3.998"></a><span id="l3.998" class="difflineplus">+      }</span>
<a href="#l3.999"></a><span id="l3.999" class="difflineplus">+</span>
<a href="#l3.1000"></a><span id="l3.1000" class="difflineplus">+      let update = {</span>
<a href="#l3.1001"></a><span id="l3.1001" class="difflineplus">+        strings,</span>
<a href="#l3.1002"></a><span id="l3.1002" class="difflineplus">+        permissions: info.permissions,</span>
<a href="#l3.1003"></a><span id="l3.1003" class="difflineplus">+        install: info.install,</span>
<a href="#l3.1004"></a><span id="l3.1004" class="difflineplus">+        addon: info.addon,</span>
<a href="#l3.1005"></a><span id="l3.1005" class="difflineplus">+        resolve: info.resolve,</span>
<a href="#l3.1006"></a><span id="l3.1006" class="difflineplus">+        reject: info.reject,</span>
<a href="#l3.1007"></a><span id="l3.1007" class="difflineplus">+      };</span>
<a href="#l3.1008"></a><span id="l3.1008" class="difflineplus">+</span>
<a href="#l3.1009"></a><span id="l3.1009" class="difflineplus">+      this.updates.add(update);</span>
<a href="#l3.1010"></a><span id="l3.1010" class="difflineplus">+      this._updateNotifications();</span>
<a href="#l3.1011"></a><span id="l3.1011" class="difflineplus">+    } else if (topic == &quot;webextension-install-notify&quot;) {</span>
<a href="#l3.1012"></a><span id="l3.1012" class="difflineplus">+      let { target, addon, callback } = subject.wrappedJSObject;</span>
<a href="#l3.1013"></a><span id="l3.1013" class="difflineplus">+      this.showInstallNotification(target, addon).then(() =&gt; {</span>
<a href="#l3.1014"></a><span id="l3.1014" class="difflineplus">+        if (callback) {</span>
<a href="#l3.1015"></a><span id="l3.1015" class="difflineplus">+          callback();</span>
<a href="#l3.1016"></a><span id="l3.1016" class="difflineplus">+        }</span>
<a href="#l3.1017"></a><span id="l3.1017" class="difflineplus">+      });</span>
<a href="#l3.1018"></a><span id="l3.1018" class="difflineplus">+    } else if (topic == &quot;webextension-optional-permission-prompt&quot;) {</span>
<a href="#l3.1019"></a><span id="l3.1019" class="difflineplus">+      let {</span>
<a href="#l3.1020"></a><span id="l3.1020" class="difflineplus">+        browser,</span>
<a href="#l3.1021"></a><span id="l3.1021" class="difflineplus">+        name,</span>
<a href="#l3.1022"></a><span id="l3.1022" class="difflineplus">+        icon,</span>
<a href="#l3.1023"></a><span id="l3.1023" class="difflineplus">+        permissions,</span>
<a href="#l3.1024"></a><span id="l3.1024" class="difflineplus">+        resolve,</span>
<a href="#l3.1025"></a><span id="l3.1025" class="difflineplus">+      } = subject.wrappedJSObject;</span>
<a href="#l3.1026"></a><span id="l3.1026" class="difflineplus">+      let strings = this._buildStrings({</span>
<a href="#l3.1027"></a><span id="l3.1027" class="difflineplus">+        type: &quot;optional&quot;,</span>
<a href="#l3.1028"></a><span id="l3.1028" class="difflineplus">+        addon: { name },</span>
<a href="#l3.1029"></a><span id="l3.1029" class="difflineplus">+        permissions,</span>
<a href="#l3.1030"></a><span id="l3.1030" class="difflineplus">+      });</span>
<a href="#l3.1031"></a><span id="l3.1031"> </span>
<a href="#l3.1032"></a><span id="l3.1032" class="difflineminus">-var ExtensionsUI = {</span>
<a href="#l3.1033"></a><span id="l3.1033" class="difflineminus">-  checkForSideloadedExtensions() {</span>
<a href="#l3.1034"></a><span id="l3.1034" class="difflineminus">-    let win = Services.wm.getMostRecentWindow(&quot;mail:3pane&quot;);</span>
<a href="#l3.1035"></a><span id="l3.1035" class="difflineminus">-    let tabmail = win.document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l3.1036"></a><span id="l3.1036" class="difflineminus">-    gXPInstallObserver._checkForSideloaded(tabmail.selectedBrowser);</span>
<a href="#l3.1037"></a><span id="l3.1037" class="difflineplus">+      // If we don't have any promptable permissions, just proceed</span>
<a href="#l3.1038"></a><span id="l3.1038" class="difflineplus">+      if (!strings.msgs.length) {</span>
<a href="#l3.1039"></a><span id="l3.1039" class="difflineplus">+        resolve(true);</span>
<a href="#l3.1040"></a><span id="l3.1040" class="difflineplus">+        return;</span>
<a href="#l3.1041"></a><span id="l3.1041" class="difflineplus">+      }</span>
<a href="#l3.1042"></a><span id="l3.1042" class="difflineplus">+      resolve(this.showPermissionsPrompt(browser, strings, icon));</span>
<a href="#l3.1043"></a><span id="l3.1043" class="difflineplus">+    } else if (topic == &quot;webextension-defaultsearch-prompt&quot;) {</span>
<a href="#l3.1044"></a><span id="l3.1044" class="difflineplus">+      let {</span>
<a href="#l3.1045"></a><span id="l3.1045" class="difflineplus">+        browser,</span>
<a href="#l3.1046"></a><span id="l3.1046" class="difflineplus">+        name,</span>
<a href="#l3.1047"></a><span id="l3.1047" class="difflineplus">+        icon,</span>
<a href="#l3.1048"></a><span id="l3.1048" class="difflineplus">+        respond,</span>
<a href="#l3.1049"></a><span id="l3.1049" class="difflineplus">+        currentEngine,</span>
<a href="#l3.1050"></a><span id="l3.1050" class="difflineplus">+        newEngine,</span>
<a href="#l3.1051"></a><span id="l3.1051" class="difflineplus">+      } = subject.wrappedJSObject;</span>
<a href="#l3.1052"></a><span id="l3.1052" class="difflineplus">+</span>
<a href="#l3.1053"></a><span id="l3.1053" class="difflineplus">+      let bundle = Services.strings.createBundle(ADDONS_PROPERTIES);</span>
<a href="#l3.1054"></a><span id="l3.1054" class="difflineplus">+</span>
<a href="#l3.1055"></a><span id="l3.1055" class="difflineplus">+      let strings = {};</span>
<a href="#l3.1056"></a><span id="l3.1056" class="difflineplus">+      strings.acceptText = bundle.GetStringFromName(</span>
<a href="#l3.1057"></a><span id="l3.1057" class="difflineplus">+        &quot;webext.defaultSearchYes.label&quot;</span>
<a href="#l3.1058"></a><span id="l3.1058" class="difflineplus">+      );</span>
<a href="#l3.1059"></a><span id="l3.1059" class="difflineplus">+      strings.acceptKey = bundle.GetStringFromName(</span>
<a href="#l3.1060"></a><span id="l3.1060" class="difflineplus">+        &quot;webext.defaultSearchYes.accessKey&quot;</span>
<a href="#l3.1061"></a><span id="l3.1061" class="difflineplus">+      );</span>
<a href="#l3.1062"></a><span id="l3.1062" class="difflineplus">+      strings.cancelText = bundle.GetStringFromName(</span>
<a href="#l3.1063"></a><span id="l3.1063" class="difflineplus">+        &quot;webext.defaultSearchNo.label&quot;</span>
<a href="#l3.1064"></a><span id="l3.1064" class="difflineplus">+      );</span>
<a href="#l3.1065"></a><span id="l3.1065" class="difflineplus">+      strings.cancelKey = bundle.GetStringFromName(</span>
<a href="#l3.1066"></a><span id="l3.1066" class="difflineplus">+        &quot;webext.defaultSearchNo.accessKey&quot;</span>
<a href="#l3.1067"></a><span id="l3.1067" class="difflineplus">+      );</span>
<a href="#l3.1068"></a><span id="l3.1068" class="difflineplus">+      strings.addonName = name;</span>
<a href="#l3.1069"></a><span id="l3.1069" class="difflineplus">+      strings.text = bundle.formatStringFromName(</span>
<a href="#l3.1070"></a><span id="l3.1070" class="difflineplus">+        &quot;webext.defaultSearch.description&quot;,</span>
<a href="#l3.1071"></a><span id="l3.1071" class="difflineplus">+        [&quot;&lt;&gt;&quot;, currentEngine, newEngine]</span>
<a href="#l3.1072"></a><span id="l3.1072" class="difflineplus">+      );</span>
<a href="#l3.1073"></a><span id="l3.1073" class="difflineplus">+</span>
<a href="#l3.1074"></a><span id="l3.1074" class="difflineplus">+      this.showDefaultSearchPrompt(browser, strings, icon).then(respond);</span>
<a href="#l3.1075"></a><span id="l3.1075" class="difflineplus">+    }</span>
<a href="#l3.1076"></a><span id="l3.1076" class="difflineplus">+  },</span>
<a href="#l3.1077"></a><span id="l3.1077" class="difflineplus">+</span>
<a href="#l3.1078"></a><span id="l3.1078" class="difflineplus">+  // Create a set of formatted strings for a permission prompt</span>
<a href="#l3.1079"></a><span id="l3.1079" class="difflineplus">+  _buildStrings(info) {</span>
<a href="#l3.1080"></a><span id="l3.1080" class="difflineplus">+    let bundle = Services.strings.createBundle(ADDONS_PROPERTIES);</span>
<a href="#l3.1081"></a><span id="l3.1081" class="difflineplus">+    let info2 = Object.assign({ appName: brandShortName }, info);</span>
<a href="#l3.1082"></a><span id="l3.1082" class="difflineplus">+</span>
<a href="#l3.1083"></a><span id="l3.1083" class="difflineplus">+    let strings = ExtensionData.formatPermissionStrings(info2, bundle, {</span>
<a href="#l3.1084"></a><span id="l3.1084" class="difflineplus">+      collapseOrigins: true,</span>
<a href="#l3.1085"></a><span id="l3.1085" class="difflineplus">+    });</span>
<a href="#l3.1086"></a><span id="l3.1086" class="difflineplus">+    // Silence the unsigned add-on warning. We can't stop</span>
<a href="#l3.1087"></a><span id="l3.1087" class="difflineplus">+    // formatPermissionStrings returning this string without changing it in</span>
<a href="#l3.1088"></a><span id="l3.1088" class="difflineplus">+    // addons.properties, and it might be wanted in future.</span>
<a href="#l3.1089"></a><span id="l3.1089" class="difflineplus">+    if (</span>
<a href="#l3.1090"></a><span id="l3.1090" class="difflineplus">+      strings.text == bundle.GetStringFromName(&quot;webextPerms.unsignedWarning&quot;)</span>
<a href="#l3.1091"></a><span id="l3.1091" class="difflineplus">+    ) {</span>
<a href="#l3.1092"></a><span id="l3.1092" class="difflineplus">+      strings.text = &quot;&quot;;</span>
<a href="#l3.1093"></a><span id="l3.1093" class="difflineplus">+    }</span>
<a href="#l3.1094"></a><span id="l3.1094" class="difflineplus">+    strings.addonName = info.addon.name;</span>
<a href="#l3.1095"></a><span id="l3.1095" class="difflineplus">+    strings.learnMore = addonsBundle.getString(&quot;webextPerms.learnMore&quot;);</span>
<a href="#l3.1096"></a><span id="l3.1096" class="difflineplus">+    return strings;</span>
<a href="#l3.1097"></a><span id="l3.1097" class="difflineplus">+  },</span>
<a href="#l3.1098"></a><span id="l3.1098" class="difflineplus">+</span>
<a href="#l3.1099"></a><span id="l3.1099" class="difflineplus">+  async showPermissionsPrompt(target, strings, icon, histkey) {</span>
<a href="#l3.1100"></a><span id="l3.1100" class="difflineplus">+    let { browser, window } = getTabBrowser(target);</span>
<a href="#l3.1101"></a><span id="l3.1101" class="difflineplus">+</span>
<a href="#l3.1102"></a><span id="l3.1102" class="difflineplus">+    // Wait for any pending prompts in this window to complete before</span>
<a href="#l3.1103"></a><span id="l3.1103" class="difflineplus">+    // showing the next one.</span>
<a href="#l3.1104"></a><span id="l3.1104" class="difflineplus">+    let pending;</span>
<a href="#l3.1105"></a><span id="l3.1105" class="difflineplus">+    while ((pending = this.pendingNotifications.get(window))) {</span>
<a href="#l3.1106"></a><span id="l3.1106" class="difflineplus">+      await pending;</span>
<a href="#l3.1107"></a><span id="l3.1107" class="difflineplus">+    }</span>
<a href="#l3.1108"></a><span id="l3.1108" class="difflineplus">+</span>
<a href="#l3.1109"></a><span id="l3.1109" class="difflineplus">+    let promise = new Promise(resolve =&gt; {</span>
<a href="#l3.1110"></a><span id="l3.1110" class="difflineplus">+      function eventCallback(topic) {</span>
<a href="#l3.1111"></a><span id="l3.1111" class="difflineplus">+        let doc = window.document;</span>
<a href="#l3.1112"></a><span id="l3.1112" class="difflineplus">+        if (topic == &quot;showing&quot;) {</span>
<a href="#l3.1113"></a><span id="l3.1113" class="difflineplus">+          let textEl = doc.getElementById(&quot;addon-webext-perm-text&quot;);</span>
<a href="#l3.1114"></a><span id="l3.1114" class="difflineplus">+          textEl.textContent = strings.text;</span>
<a href="#l3.1115"></a><span id="l3.1115" class="difflineplus">+          textEl.hidden = !strings.text;</span>
<a href="#l3.1116"></a><span id="l3.1116" class="difflineplus">+</span>
<a href="#l3.1117"></a><span id="l3.1117" class="difflineplus">+          let listIntroEl = doc.getElementById(&quot;addon-webext-perm-intro&quot;);</span>
<a href="#l3.1118"></a><span id="l3.1118" class="difflineplus">+          listIntroEl.textContent = strings.listIntro;</span>
<a href="#l3.1119"></a><span id="l3.1119" class="difflineplus">+          listIntroEl.hidden = !strings.msgs.length;</span>
<a href="#l3.1120"></a><span id="l3.1120" class="difflineplus">+</span>
<a href="#l3.1121"></a><span id="l3.1121" class="difflineplus">+          let listInfoEl = doc.getElementById(&quot;addon-webext-perm-info&quot;);</span>
<a href="#l3.1122"></a><span id="l3.1122" class="difflineplus">+          listInfoEl.textContent = strings.learnMore;</span>
<a href="#l3.1123"></a><span id="l3.1123" class="difflineplus">+          listInfoEl.href =</span>
<a href="#l3.1124"></a><span id="l3.1124" class="difflineplus">+            Services.urlFormatter.formatURLPref(&quot;app.support.baseURL&quot;) +</span>
<a href="#l3.1125"></a><span id="l3.1125" class="difflineplus">+            &quot;extension-permissions&quot;;</span>
<a href="#l3.1126"></a><span id="l3.1126" class="difflineplus">+          listInfoEl.hidden = !strings.msgs.length;</span>
<a href="#l3.1127"></a><span id="l3.1127" class="difflineplus">+</span>
<a href="#l3.1128"></a><span id="l3.1128" class="difflineplus">+          let list = doc.getElementById(&quot;addon-webext-perm-list&quot;);</span>
<a href="#l3.1129"></a><span id="l3.1129" class="difflineplus">+          while (list.firstChild) {</span>
<a href="#l3.1130"></a><span id="l3.1130" class="difflineplus">+            list.firstChild.remove();</span>
<a href="#l3.1131"></a><span id="l3.1131" class="difflineplus">+          }</span>
<a href="#l3.1132"></a><span id="l3.1132" class="difflineplus">+</span>
<a href="#l3.1133"></a><span id="l3.1133" class="difflineplus">+          for (let msg of strings.msgs) {</span>
<a href="#l3.1134"></a><span id="l3.1134" class="difflineplus">+            let item = doc.createElementNS(HTML_NS, &quot;li&quot;);</span>
<a href="#l3.1135"></a><span id="l3.1135" class="difflineplus">+            item.textContent = msg;</span>
<a href="#l3.1136"></a><span id="l3.1136" class="difflineplus">+            list.appendChild(item);</span>
<a href="#l3.1137"></a><span id="l3.1137" class="difflineplus">+          }</span>
<a href="#l3.1138"></a><span id="l3.1138" class="difflineplus">+        } else if (topic == &quot;swapping&quot;) {</span>
<a href="#l3.1139"></a><span id="l3.1139" class="difflineplus">+          return true;</span>
<a href="#l3.1140"></a><span id="l3.1140" class="difflineplus">+        }</span>
<a href="#l3.1141"></a><span id="l3.1141" class="difflineplus">+        if (topic == &quot;removed&quot;) {</span>
<a href="#l3.1142"></a><span id="l3.1142" class="difflineplus">+          Services.tm.dispatchToMainThread(() =&gt; {</span>
<a href="#l3.1143"></a><span id="l3.1143" class="difflineplus">+            resolve(false);</span>
<a href="#l3.1144"></a><span id="l3.1144" class="difflineplus">+          });</span>
<a href="#l3.1145"></a><span id="l3.1145" class="difflineplus">+        }</span>
<a href="#l3.1146"></a><span id="l3.1146" class="difflineplus">+        return false;</span>
<a href="#l3.1147"></a><span id="l3.1147" class="difflineplus">+      }</span>
<a href="#l3.1148"></a><span id="l3.1148" class="difflineplus">+</span>
<a href="#l3.1149"></a><span id="l3.1149" class="difflineplus">+      let popupOptions = {</span>
<a href="#l3.1150"></a><span id="l3.1150" class="difflineplus">+        hideClose: true,</span>
<a href="#l3.1151"></a><span id="l3.1151" class="difflineplus">+        popupIconURL: icon || DEFAULT_EXTENSION_ICON,</span>
<a href="#l3.1152"></a><span id="l3.1152" class="difflineplus">+        persistent: true,</span>
<a href="#l3.1153"></a><span id="l3.1153" class="difflineplus">+        eventCallback,</span>
<a href="#l3.1154"></a><span id="l3.1154" class="difflineplus">+        name: strings.addonName,</span>
<a href="#l3.1155"></a><span id="l3.1155" class="difflineplus">+        removeOnDismissal: true,</span>
<a href="#l3.1156"></a><span id="l3.1156" class="difflineplus">+      };</span>
<a href="#l3.1157"></a><span id="l3.1157" class="difflineplus">+</span>
<a href="#l3.1158"></a><span id="l3.1158" class="difflineplus">+      let action = {</span>
<a href="#l3.1159"></a><span id="l3.1159" class="difflineplus">+        label: strings.acceptText,</span>
<a href="#l3.1160"></a><span id="l3.1160" class="difflineplus">+        accessKey: strings.acceptKey,</span>
<a href="#l3.1161"></a><span id="l3.1161" class="difflineplus">+        callback: () =&gt; {</span>
<a href="#l3.1162"></a><span id="l3.1162" class="difflineplus">+          if (histkey) {</span>
<a href="#l3.1163"></a><span id="l3.1163" class="difflineplus">+            this.histogram.add(histkey + &quot;Accepted&quot;);</span>
<a href="#l3.1164"></a><span id="l3.1164" class="difflineplus">+          }</span>
<a href="#l3.1165"></a><span id="l3.1165" class="difflineplus">+          resolve(true);</span>
<a href="#l3.1166"></a><span id="l3.1166" class="difflineplus">+        },</span>
<a href="#l3.1167"></a><span id="l3.1167" class="difflineplus">+      };</span>
<a href="#l3.1168"></a><span id="l3.1168" class="difflineplus">+      let secondaryActions = [</span>
<a href="#l3.1169"></a><span id="l3.1169" class="difflineplus">+        {</span>
<a href="#l3.1170"></a><span id="l3.1170" class="difflineplus">+          label: strings.cancelText,</span>
<a href="#l3.1171"></a><span id="l3.1171" class="difflineplus">+          accessKey: strings.cancelKey,</span>
<a href="#l3.1172"></a><span id="l3.1172" class="difflineplus">+          callback: () =&gt; {</span>
<a href="#l3.1173"></a><span id="l3.1173" class="difflineplus">+            if (histkey) {</span>
<a href="#l3.1174"></a><span id="l3.1174" class="difflineplus">+              this.histogram.add(histkey + &quot;Rejected&quot;);</span>
<a href="#l3.1175"></a><span id="l3.1175" class="difflineplus">+            }</span>
<a href="#l3.1176"></a><span id="l3.1176" class="difflineplus">+            resolve(false);</span>
<a href="#l3.1177"></a><span id="l3.1177" class="difflineplus">+          },</span>
<a href="#l3.1178"></a><span id="l3.1178" class="difflineplus">+        },</span>
<a href="#l3.1179"></a><span id="l3.1179" class="difflineplus">+      ];</span>
<a href="#l3.1180"></a><span id="l3.1180" class="difflineplus">+</span>
<a href="#l3.1181"></a><span id="l3.1181" class="difflineplus">+      showNotification(</span>
<a href="#l3.1182"></a><span id="l3.1182" class="difflineplus">+        browser,</span>
<a href="#l3.1183"></a><span id="l3.1183" class="difflineplus">+        &quot;addon-webext-permissions&quot;,</span>
<a href="#l3.1184"></a><span id="l3.1184" class="difflineplus">+        strings.header,</span>
<a href="#l3.1185"></a><span id="l3.1185" class="difflineplus">+        &quot;addons-notification-icon&quot;,</span>
<a href="#l3.1186"></a><span id="l3.1186" class="difflineplus">+        action,</span>
<a href="#l3.1187"></a><span id="l3.1187" class="difflineplus">+        secondaryActions,</span>
<a href="#l3.1188"></a><span id="l3.1188" class="difflineplus">+        popupOptions</span>
<a href="#l3.1189"></a><span id="l3.1189" class="difflineplus">+      );</span>
<a href="#l3.1190"></a><span id="l3.1190" class="difflineplus">+    });</span>
<a href="#l3.1191"></a><span id="l3.1191" class="difflineplus">+</span>
<a href="#l3.1192"></a><span id="l3.1192" class="difflineplus">+    this.pendingNotifications.set(window, promise);</span>
<a href="#l3.1193"></a><span id="l3.1193" class="difflineplus">+    promise.finally(() =&gt; this.pendingNotifications.delete(window));</span>
<a href="#l3.1194"></a><span id="l3.1194" class="difflineplus">+    return promise;</span>
<a href="#l3.1195"></a><span id="l3.1195" class="difflineplus">+  },</span>
<a href="#l3.1196"></a><span id="l3.1196" class="difflineplus">+</span>
<a href="#l3.1197"></a><span id="l3.1197" class="difflineplus">+  showDefaultSearchPrompt(target, strings, icon) {</span>
<a href="#l3.1198"></a><span id="l3.1198" class="difflineplus">+    return new Promise(resolve =&gt; {</span>
<a href="#l3.1199"></a><span id="l3.1199" class="difflineplus">+      let popupOptions = {</span>
<a href="#l3.1200"></a><span id="l3.1200" class="difflineplus">+        hideClose: true,</span>
<a href="#l3.1201"></a><span id="l3.1201" class="difflineplus">+        popupIconURL: icon || DEFAULT_EXTENSION_ICON,</span>
<a href="#l3.1202"></a><span id="l3.1202" class="difflineplus">+        persistent: true,</span>
<a href="#l3.1203"></a><span id="l3.1203" class="difflineplus">+        removeOnDismissal: true,</span>
<a href="#l3.1204"></a><span id="l3.1204" class="difflineplus">+        eventCallback(topic) {</span>
<a href="#l3.1205"></a><span id="l3.1205" class="difflineplus">+          if (topic == &quot;removed&quot;) {</span>
<a href="#l3.1206"></a><span id="l3.1206" class="difflineplus">+            resolve(false);</span>
<a href="#l3.1207"></a><span id="l3.1207" class="difflineplus">+          }</span>
<a href="#l3.1208"></a><span id="l3.1208" class="difflineplus">+        },</span>
<a href="#l3.1209"></a><span id="l3.1209" class="difflineplus">+        name: strings.addonName,</span>
<a href="#l3.1210"></a><span id="l3.1210" class="difflineplus">+      };</span>
<a href="#l3.1211"></a><span id="l3.1211" class="difflineplus">+</span>
<a href="#l3.1212"></a><span id="l3.1212" class="difflineplus">+      let action = {</span>
<a href="#l3.1213"></a><span id="l3.1213" class="difflineplus">+        label: strings.acceptText,</span>
<a href="#l3.1214"></a><span id="l3.1214" class="difflineplus">+        accessKey: strings.acceptKey,</span>
<a href="#l3.1215"></a><span id="l3.1215" class="difflineplus">+        disableHighlight: true,</span>
<a href="#l3.1216"></a><span id="l3.1216" class="difflineplus">+        callback: () =&gt; {</span>
<a href="#l3.1217"></a><span id="l3.1217" class="difflineplus">+          resolve(true);</span>
<a href="#l3.1218"></a><span id="l3.1218" class="difflineplus">+        },</span>
<a href="#l3.1219"></a><span id="l3.1219" class="difflineplus">+      };</span>
<a href="#l3.1220"></a><span id="l3.1220" class="difflineplus">+      let secondaryActions = [</span>
<a href="#l3.1221"></a><span id="l3.1221" class="difflineplus">+        {</span>
<a href="#l3.1222"></a><span id="l3.1222" class="difflineplus">+          label: strings.cancelText,</span>
<a href="#l3.1223"></a><span id="l3.1223" class="difflineplus">+          accessKey: strings.cancelKey,</span>
<a href="#l3.1224"></a><span id="l3.1224" class="difflineplus">+          callback: () =&gt; {</span>
<a href="#l3.1225"></a><span id="l3.1225" class="difflineplus">+            resolve(false);</span>
<a href="#l3.1226"></a><span id="l3.1226" class="difflineplus">+          },</span>
<a href="#l3.1227"></a><span id="l3.1227" class="difflineplus">+        },</span>
<a href="#l3.1228"></a><span id="l3.1228" class="difflineplus">+      ];</span>
<a href="#l3.1229"></a><span id="l3.1229" class="difflineplus">+</span>
<a href="#l3.1230"></a><span id="l3.1230" class="difflineplus">+      let { browser } = getTabBrowser(target);</span>
<a href="#l3.1231"></a><span id="l3.1231" class="difflineplus">+      showNotification(</span>
<a href="#l3.1232"></a><span id="l3.1232" class="difflineplus">+        browser,</span>
<a href="#l3.1233"></a><span id="l3.1233" class="difflineplus">+        &quot;addon-webext-defaultsearch&quot;,</span>
<a href="#l3.1234"></a><span id="l3.1234" class="difflineplus">+        strings.text,</span>
<a href="#l3.1235"></a><span id="l3.1235" class="difflineplus">+        &quot;addons-notification-icon&quot;,</span>
<a href="#l3.1236"></a><span id="l3.1236" class="difflineplus">+        action,</span>
<a href="#l3.1237"></a><span id="l3.1237" class="difflineplus">+        secondaryActions,</span>
<a href="#l3.1238"></a><span id="l3.1238" class="difflineplus">+        popupOptions</span>
<a href="#l3.1239"></a><span id="l3.1239" class="difflineplus">+      );</span>
<a href="#l3.1240"></a><span id="l3.1240" class="difflineplus">+    });</span>
<a href="#l3.1241"></a><span id="l3.1241" class="difflineplus">+  },</span>
<a href="#l3.1242"></a><span id="l3.1242" class="difflineplus">+</span>
<a href="#l3.1243"></a><span id="l3.1243" class="difflineplus">+  async showInstallNotification(target, addon) {</span>
<a href="#l3.1244"></a><span id="l3.1244" class="difflineplus">+    let { browser, window } = getTabBrowser(target);</span>
<a href="#l3.1245"></a><span id="l3.1245" class="difflineplus">+    let document = window.document;</span>
<a href="#l3.1246"></a><span id="l3.1246" class="difflineplus">+</span>
<a href="#l3.1247"></a><span id="l3.1247" class="difflineplus">+    let message = addonsBundle.getFormattedString(&quot;addonPostInstall.message1&quot;, [</span>
<a href="#l3.1248"></a><span id="l3.1248" class="difflineplus">+      &quot;&lt;&gt;&quot;,</span>
<a href="#l3.1249"></a><span id="l3.1249" class="difflineplus">+      brandShortName,</span>
<a href="#l3.1250"></a><span id="l3.1250" class="difflineplus">+    ]);</span>
<a href="#l3.1251"></a><span id="l3.1251" class="difflineplus">+</span>
<a href="#l3.1252"></a><span id="l3.1252" class="difflineplus">+    let icon = DEFAULT_EXTENSION_ICON;</span>
<a href="#l3.1253"></a><span id="l3.1253" class="difflineplus">+    if (addon.isWebExtension) {</span>
<a href="#l3.1254"></a><span id="l3.1254" class="difflineplus">+      icon = AddonManager.getPreferredIconURL(addon, 32, window) || icon;</span>
<a href="#l3.1255"></a><span id="l3.1255" class="difflineplus">+    }</span>
<a href="#l3.1256"></a><span id="l3.1256" class="difflineplus">+</span>
<a href="#l3.1257"></a><span id="l3.1257" class="difflineplus">+    let options = {</span>
<a href="#l3.1258"></a><span id="l3.1258" class="difflineplus">+      hideClose: true,</span>
<a href="#l3.1259"></a><span id="l3.1259" class="difflineplus">+      timeout: Date.now() + 30000,</span>
<a href="#l3.1260"></a><span id="l3.1260" class="difflineplus">+      popupIconURL: icon,</span>
<a href="#l3.1261"></a><span id="l3.1261" class="difflineplus">+      name: addon.name,</span>
<a href="#l3.1262"></a><span id="l3.1262" class="difflineplus">+    };</span>
<a href="#l3.1263"></a><span id="l3.1263" class="difflineplus">+</span>
<a href="#l3.1264"></a><span id="l3.1264" class="difflineplus">+    let list = document.getElementById(&quot;addon-installed-list&quot;);</span>
<a href="#l3.1265"></a><span id="l3.1265" class="difflineplus">+    list.hidden = true;</span>
<a href="#l3.1266"></a><span id="l3.1266" class="difflineplus">+</span>
<a href="#l3.1267"></a><span id="l3.1267" class="difflineplus">+    showNotification(</span>
<a href="#l3.1268"></a><span id="l3.1268" class="difflineplus">+      browser,</span>
<a href="#l3.1269"></a><span id="l3.1269" class="difflineplus">+      &quot;addon-installed&quot;,</span>
<a href="#l3.1270"></a><span id="l3.1270" class="difflineplus">+      message,</span>
<a href="#l3.1271"></a><span id="l3.1271" class="difflineplus">+      &quot;addons-notification-icon&quot;,</span>
<a href="#l3.1272"></a><span id="l3.1272" class="difflineplus">+      {</span>
<a href="#l3.1273"></a><span id="l3.1273" class="difflineplus">+        label: addonsBundle.getString(&quot;addonPostInstall.okay.label&quot;),</span>
<a href="#l3.1274"></a><span id="l3.1274" class="difflineplus">+        accessKey: addonsBundle.getString(&quot;addonPostInstall.okay.accesskey&quot;),</span>
<a href="#l3.1275"></a><span id="l3.1275" class="difflineplus">+        callback: () =&gt; {},</span>
<a href="#l3.1276"></a><span id="l3.1276" class="difflineplus">+      },</span>
<a href="#l3.1277"></a><span id="l3.1277" class="difflineplus">+      null,</span>
<a href="#l3.1278"></a><span id="l3.1278" class="difflineplus">+      options</span>
<a href="#l3.1279"></a><span id="l3.1279" class="difflineplus">+    );</span>
<a href="#l3.1280"></a><span id="l3.1280">   },</span>
<a href="#l3.1281"></a><span id="l3.1281"> };</span>
<a href="#l3.1282"></a><span id="l3.1282" class="difflineplus">+</span>
<a href="#l3.1283"></a><span id="l3.1283" class="difflineplus">+EventEmitter.decorate(ExtensionsUI);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/components/MailGlue.jsm</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/components/MailGlue.jsm</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -258,17 +258,17 @@ MailGlue.prototype = {</span>
<a href="#l4.4"></a><span id="l4.4">         &quot;resource:///modules/WindowsJumpLists.jsm&quot;</span>
<a href="#l4.5"></a><span id="l4.5">       );</span>
<a href="#l4.6"></a><span id="l4.6">       WinTaskbarJumpList.startup();</span>
<a href="#l4.7"></a><span id="l4.7">     }</span>
<a href="#l4.8"></a><span id="l4.8"> </span>
<a href="#l4.9"></a><span id="l4.9">     const { ExtensionsUI } = ChromeUtils.import(</span>
<a href="#l4.10"></a><span id="l4.10">       &quot;resource:///modules/ExtensionsUI.jsm&quot;</span>
<a href="#l4.11"></a><span id="l4.11">     );</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-    ExtensionsUI.checkForSideloadedExtensions();</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+    ExtensionsUI.init();</span>
<a href="#l4.14"></a><span id="l4.14"> </span>
<a href="#l4.15"></a><span id="l4.15">     // If the application has been updated, look for any extensions that may</span>
<a href="#l4.16"></a><span id="l4.16">     // have been disabled by the update, and check for newer versions of those</span>
<a href="#l4.17"></a><span id="l4.17">     // extensions.</span>
<a href="#l4.18"></a><span id="l4.18">     let currentVersion = Services.appinfo.version;</span>
<a href="#l4.19"></a><span id="l4.19">     if (this.previousVersion != &quot;0&quot; &amp;&amp; this.previousVersion != currentVersion) {</span>
<a href="#l4.20"></a><span id="l4.20">       let { AddonManager } = ChromeUtils.import(</span>
<a href="#l4.21"></a><span id="l4.21">         &quot;resource://gre/modules/AddonManager.jsm&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/components/customizableui/content/panelUI.inc.xhtml</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/components/customizableui/content/panelUI.inc.xhtml</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -15,16 +15,24 @@</span>
<a href="#l5.4"></a><span id="l5.4">                   viewCacheId=&quot;appMenu-viewCache&quot;&gt;</span>
<a href="#l5.5"></a><span id="l5.5"> </span>
<a href="#l5.6"></a><span id="l5.6">     &lt;!-- Main Appmenu View --&gt;</span>
<a href="#l5.7"></a><span id="l5.7">     &lt;panelview id=&quot;appMenu-mainView&quot; class=&quot;PanelUI-subView&quot;</span>
<a href="#l5.8"></a><span id="l5.8">                descriptionheightworkaround=&quot;true&quot;&gt;</span>
<a href="#l5.9"></a><span id="l5.9">       &lt;vbox id=&quot;appMenu-mainViewItems&quot;</span>
<a href="#l5.10"></a><span id="l5.10">             class=&quot;panel-subview-body&quot;&gt;</span>
<a href="#l5.11"></a><span id="l5.11">         &lt;vbox id=&quot;appMenu-addon-banners&quot;/&gt;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+        &lt;toolbarbutton class=&quot;panel-banner-item&quot;</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+                       label-update-available=&quot;updateAvailable.panelUI.label&quot;</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+                       label-update-manual=&quot;updateManual.panelUI.label&quot;</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+                       label-update-unsupported=&quot;updateUnsupported.panelUI.label&quot;</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+                       label-update-restart=&quot;updateRestart.panelUI.label2&quot;</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+                       oncommand=&quot;PanelUI._onBannerItemSelected(event)&quot;</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+                       wrap=&quot;true&quot;</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+                       hidden=&quot;true&quot;/&gt;</span>
<a href="#l5.20"></a><span id="l5.20">         &lt;toolbarbutton id=&quot;appmenu_new&quot;</span>
<a href="#l5.21"></a><span id="l5.21">                        class=&quot;subviewbutton subviewbutton-iconic subviewbutton-nav&quot;</span>
<a href="#l5.22"></a><span id="l5.22">                        label=&quot;&amp;newMenu.label;&quot;</span>
<a href="#l5.23"></a><span id="l5.23">                        closemenu=&quot;none&quot;</span>
<a href="#l5.24"></a><span id="l5.24">                        oncommand=&quot;PanelUI.showSubView('appMenu-newView', this)&quot;/&gt;</span>
<a href="#l5.25"></a><span id="l5.25">         &lt;toolbarbutton id=&quot;appmenu_msgAttachmentMenu&quot;</span>
<a href="#l5.26"></a><span id="l5.26">                        class=&quot;subviewbutton subviewbutton-iconic subviewbutton-nav&quot;</span>
<a href="#l5.27"></a><span id="l5.27">                        label=&quot;&amp;openAttachmentListCmd.label;&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/components/customizableui/content/panelUI.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/components/customizableui/content/panelUI.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -6,24 +6,29 @@</span>
<a href="#l6.4"></a><span id="l6.4">   currentAttachments CustomizableUI ExtensionParent ExtensionSupport FullScreen</span>
<a href="#l6.5"></a><span id="l6.5">   getIconForAttachment goUpdateAttachmentCommands initAddonPrefsMenu</span>
<a href="#l6.6"></a><span id="l6.6">   initAppMenuPopup InitAppmenuViewBodyMenu InitAppMessageMenu</span>
<a href="#l6.7"></a><span id="l6.7">   InitAppmenuViewMessagesMenu InitAppFolderViewsMenu InitAppViewSortByMenu</span>
<a href="#l6.8"></a><span id="l6.8">   InitMessageTags InitRecentlyClosedTabsPopup InitViewFolderViewsMenu</span>
<a href="#l6.9"></a><span id="l6.9">   InitViewHeadersMenu InitViewLayoutStyleMenu MozXULElement msgWindow</span>
<a href="#l6.10"></a><span id="l6.10">   onViewToolbarsPopupShowing RefreshCustomViewsPopup RefreshTagsPopup</span>
<a href="#l6.11"></a><span id="l6.11">   RefreshViewPopup SanitizeAttachmentDisplayName Services ShortcutUtils</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-  UpdateCharsetMenu updateEditUIVisibility UpdateFullZoomMenu XPCOMUtils */</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+  StringBundle UpdateCharsetMenu updateEditUIVisibility UpdateFullZoomMenu</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+  XPCOMUtils */</span>
<a href="#l6.15"></a><span id="l6.15"> </span>
<a href="#l6.16"></a><span id="l6.16"> ChromeUtils.defineModuleGetter(</span>
<a href="#l6.17"></a><span id="l6.17">   this,</span>
<a href="#l6.18"></a><span id="l6.18">   &quot;AppMenuNotifications&quot;,</span>
<a href="#l6.19"></a><span id="l6.19">   &quot;resource://gre/modules/AppMenuNotifications.jsm&quot;</span>
<a href="#l6.20"></a><span id="l6.20"> );</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineminus">-</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+ChromeUtils.defineModuleGetter(</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineplus">+  this,</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineplus">+  &quot;ExtensionsUI&quot;,</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineplus">+  &quot;resource:///modules/ExtensionsUI.jsm&quot;</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineplus">+);</span>
<a href="#l6.27"></a><span id="l6.27"> ChromeUtils.defineModuleGetter(</span>
<a href="#l6.28"></a><span id="l6.28">   this,</span>
<a href="#l6.29"></a><span id="l6.29">   &quot;PanelMultiView&quot;,</span>
<a href="#l6.30"></a><span id="l6.30">   &quot;resource:///modules/PanelMultiView.jsm&quot;</span>
<a href="#l6.31"></a><span id="l6.31"> );</span>
<a href="#l6.32"></a><span id="l6.32"> </span>
<a href="#l6.33"></a><span id="l6.33"> // Needed for character encoding subviews.</span>
<a href="#l6.34"></a><span id="l6.34"> XPCOMUtils.defineLazyGetter(this, &quot;gBundle&quot;, function() {</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineat">@@ -51,16 +56,17 @@ const PanelUI = {</span>
<a href="#l6.36"></a><span id="l6.36">    */</span>
<a href="#l6.37"></a><span id="l6.37">   get kElements() {</span>
<a href="#l6.38"></a><span id="l6.38">     return {</span>
<a href="#l6.39"></a><span id="l6.39">       mainView: &quot;appMenu-mainView&quot;,</span>
<a href="#l6.40"></a><span id="l6.40">       multiView: &quot;appMenu-multiView&quot;,</span>
<a href="#l6.41"></a><span id="l6.41">       menuButtonMail: &quot;button-appmenu&quot;,</span>
<a href="#l6.42"></a><span id="l6.42">       menuButtonChat: &quot;button-chat-appmenu&quot;,</span>
<a href="#l6.43"></a><span id="l6.43">       panel: &quot;appMenu-popup&quot;,</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineplus">+      addonNotificationContainer: &quot;appMenu-addon-banners&quot;,</span>
<a href="#l6.45"></a><span id="l6.45">       navbar: &quot;mail-bar3&quot;,</span>
<a href="#l6.46"></a><span id="l6.46">     };</span>
<a href="#l6.47"></a><span id="l6.47">   },</span>
<a href="#l6.48"></a><span id="l6.48"> </span>
<a href="#l6.49"></a><span id="l6.49">   /**</span>
<a href="#l6.50"></a><span id="l6.50">    * Used for the View / Text Encoding view.</span>
<a href="#l6.51"></a><span id="l6.51">    * Not ideal: copied from: mozilla-central/toolkit/modules/CharsetMenu.jsm</span>
<a href="#l6.52"></a><span id="l6.52">    * This set contains encodings that are in the Encoding Standard, except:</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineat">@@ -483,22 +489,16 @@ const PanelUI = {</span>
<a href="#l6.54"></a><span id="l6.54">       &quot;toolbarseparator&quot;</span>
<a href="#l6.55"></a><span id="l6.55">     );</span>
<a href="#l6.56"></a><span id="l6.56">   },</span>
<a href="#l6.57"></a><span id="l6.57"> </span>
<a href="#l6.58"></a><span id="l6.58">   get isReady() {</span>
<a href="#l6.59"></a><span id="l6.59">     return !!this._isReady;</span>
<a href="#l6.60"></a><span id="l6.60">   },</span>
<a href="#l6.61"></a><span id="l6.61"> </span>
<a href="#l6.62"></a><span id="l6.62" class="difflineminus">-  get isNotificationPanelOpen() {</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineminus">-    let panelState = this.notificationPanel.state;</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineminus">-</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineminus">-    return panelState == &quot;showing&quot; || panelState == &quot;open&quot;;</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineminus">-  },</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineminus">-</span>
<a href="#l6.68"></a><span id="l6.68">   /**</span>
<a href="#l6.69"></a><span id="l6.69">    * Registering the menu panel is done lazily for performance reasons. This</span>
<a href="#l6.70"></a><span id="l6.70">    * method is exposed so that CustomizationMode can force panel-readyness in the</span>
<a href="#l6.71"></a><span id="l6.71">    * event that customization mode is started before the panel has been opened</span>
<a href="#l6.72"></a><span id="l6.72">    * by the user.</span>
<a href="#l6.73"></a><span id="l6.73">    *</span>
<a href="#l6.74"></a><span id="l6.74">    * @param aCustomizing (optional) set to true if this was called while entering</span>
<a href="#l6.75"></a><span id="l6.75">    *        customization mode. If that's the case, we trust that customization</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineat">@@ -1066,164 +1066,80 @@ const PanelUI = {</span>
<a href="#l6.77"></a><span id="l6.77">       { x: tooltipId },</span>
<a href="#l6.78"></a><span id="l6.78">       &quot;x&quot;,</span>
<a href="#l6.79"></a><span id="l6.79">       stringArgs</span>
<a href="#l6.80"></a><span id="l6.80">     );</span>
<a href="#l6.81"></a><span id="l6.81">     let quitButton = document.getElementById(&quot;PanelUI-quit&quot;);</span>
<a href="#l6.82"></a><span id="l6.82">     quitButton.setAttribute(&quot;tooltiptext&quot;, tooltipString);</span>
<a href="#l6.83"></a><span id="l6.83">   },</span>
<a href="#l6.84"></a><span id="l6.84"> </span>
<a href="#l6.85"></a><span id="l6.85" class="difflineminus">-  _hidePopup() {</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineminus">-    if (this.isNotificationPanelOpen) {</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineminus">-      this.notificationPanel.hidePopup();</span>
<a href="#l6.88"></a><span id="l6.88" class="difflineminus">-    }</span>
<a href="#l6.89"></a><span id="l6.89" class="difflineminus">-  },</span>
<a href="#l6.90"></a><span id="l6.90" class="difflineminus">-</span>
<a href="#l6.91"></a><span id="l6.91">   _updateNotifications(notificationsChanged) {</span>
<a href="#l6.92"></a><span id="l6.92">     let notifications = this._notifications;</span>
<a href="#l6.93"></a><span id="l6.93">     if (!notifications || !notifications.length) {</span>
<a href="#l6.94"></a><span id="l6.94">       if (notificationsChanged) {</span>
<a href="#l6.95"></a><span id="l6.95">         this._clearAllNotifications();</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineminus">-        this._hidePopup();</span>
<a href="#l6.97"></a><span id="l6.97">       }</span>
<a href="#l6.98"></a><span id="l6.98">       return;</span>
<a href="#l6.99"></a><span id="l6.99">     }</span>
<a href="#l6.100"></a><span id="l6.100"> </span>
<a href="#l6.101"></a><span id="l6.101">     if (</span>
<a href="#l6.102"></a><span id="l6.102">       (window.fullScreen &amp;&amp; FullScreen.navToolboxHidden) ||</span>
<a href="#l6.103"></a><span id="l6.103">       document.fullscreenElement</span>
<a href="#l6.104"></a><span id="l6.104">     ) {</span>
<a href="#l6.105"></a><span id="l6.105" class="difflineminus">-      this._hidePopup();</span>
<a href="#l6.106"></a><span id="l6.106">       return;</span>
<a href="#l6.107"></a><span id="l6.107">     }</span>
<a href="#l6.108"></a><span id="l6.108"> </span>
<a href="#l6.109"></a><span id="l6.109">     let doorhangers = notifications.filter(</span>
<a href="#l6.110"></a><span id="l6.110">       n =&gt; !n.dismissed &amp;&amp; !n.options.badgeOnly</span>
<a href="#l6.111"></a><span id="l6.111">     );</span>
<a href="#l6.112"></a><span id="l6.112"> </span>
<a href="#l6.113"></a><span id="l6.113">     if (this.panel.state == &quot;showing&quot; || this.panel.state == &quot;open&quot;) {</span>
<a href="#l6.114"></a><span id="l6.114">       // If the menu is already showing, then we need to dismiss all notifications</span>
<a href="#l6.115"></a><span id="l6.115">       // since we don't want their doorhangers competing for attention</span>
<a href="#l6.116"></a><span id="l6.116">       doorhangers.forEach(n =&gt; {</span>
<a href="#l6.117"></a><span id="l6.117">         n.dismissed = true;</span>
<a href="#l6.118"></a><span id="l6.118">         if (n.options.onDismissed) {</span>
<a href="#l6.119"></a><span id="l6.119">           n.options.onDismissed(window);</span>
<a href="#l6.120"></a><span id="l6.120">         }</span>
<a href="#l6.121"></a><span id="l6.121">       });</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineminus">-      this._hidePopup();</span>
<a href="#l6.123"></a><span id="l6.123">       this._clearBadge();</span>
<a href="#l6.124"></a><span id="l6.124">       if (!notifications[0].options.badgeOnly) {</span>
<a href="#l6.125"></a><span id="l6.125">         this._showBannerItem(notifications[0]);</span>
<a href="#l6.126"></a><span id="l6.126">       }</span>
<a href="#l6.127"></a><span id="l6.127">     } else if (doorhangers.length &gt; 0) {</span>
<a href="#l6.128"></a><span id="l6.128">       // Only show the doorhanger if the window is focused and not fullscreen</span>
<a href="#l6.129"></a><span id="l6.129">       if (</span>
<a href="#l6.130"></a><span id="l6.130">         (window.fullScreen &amp;&amp; this.autoHideToolbarInFullScreen) ||</span>
<a href="#l6.131"></a><span id="l6.131">         Services.focus.activeWindow !== window</span>
<a href="#l6.132"></a><span id="l6.132">       ) {</span>
<a href="#l6.133"></a><span id="l6.133" class="difflineminus">-        this._hidePopup();</span>
<a href="#l6.134"></a><span id="l6.134">         this._showBadge(doorhangers[0]);</span>
<a href="#l6.135"></a><span id="l6.135">         this._showBannerItem(doorhangers[0]);</span>
<a href="#l6.136"></a><span id="l6.136">       } else {</span>
<a href="#l6.137"></a><span id="l6.137">         this._clearBadge();</span>
<a href="#l6.138"></a><span id="l6.138" class="difflineminus">-        this._showNotificationPanel(doorhangers[0]);</span>
<a href="#l6.139"></a><span id="l6.139">       }</span>
<a href="#l6.140"></a><span id="l6.140">     } else {</span>
<a href="#l6.141"></a><span id="l6.141" class="difflineminus">-      this._hidePopup();</span>
<a href="#l6.142"></a><span id="l6.142">       this._showBadge(notifications[0]);</span>
<a href="#l6.143"></a><span id="l6.143">       this._showBannerItem(notifications[0]);</span>
<a href="#l6.144"></a><span id="l6.144">     }</span>
<a href="#l6.145"></a><span id="l6.145">   },</span>
<a href="#l6.146"></a><span id="l6.146"> </span>
<a href="#l6.147"></a><span id="l6.147" class="difflineminus">-  _showNotificationPanel(notification) {</span>
<a href="#l6.148"></a><span id="l6.148" class="difflineminus">-    this._refreshNotificationPanel(notification);</span>
<a href="#l6.149"></a><span id="l6.149" class="difflineminus">-</span>
<a href="#l6.150"></a><span id="l6.150" class="difflineminus">-    if (this.isNotificationPanelOpen) {</span>
<a href="#l6.151"></a><span id="l6.151" class="difflineminus">-      return;</span>
<a href="#l6.152"></a><span id="l6.152" class="difflineminus">-    }</span>
<a href="#l6.153"></a><span id="l6.153" class="difflineminus">-</span>
<a href="#l6.154"></a><span id="l6.154" class="difflineminus">-    if (notification.options.beforeShowDoorhanger) {</span>
<a href="#l6.155"></a><span id="l6.155" class="difflineminus">-      notification.options.beforeShowDoorhanger(document);</span>
<a href="#l6.156"></a><span id="l6.156" class="difflineminus">-    }</span>
<a href="#l6.157"></a><span id="l6.157" class="difflineminus">-</span>
<a href="#l6.158"></a><span id="l6.158" class="difflineminus">-    let anchor = this._getPanelAnchor(this.menuButton);</span>
<a href="#l6.159"></a><span id="l6.159" class="difflineminus">-</span>
<a href="#l6.160"></a><span id="l6.160" class="difflineminus">-    this.notificationPanel.hidden = false;</span>
<a href="#l6.161"></a><span id="l6.161" class="difflineminus">-</span>
<a href="#l6.162"></a><span id="l6.162" class="difflineminus">-    // Insert Fluent files when needed before notification is opened</span>
<a href="#l6.163"></a><span id="l6.163" class="difflineminus">-    MozXULElement.insertFTLIfNeeded(&quot;branding/brand.ftl&quot;);</span>
<a href="#l6.164"></a><span id="l6.164" class="difflineminus">-    MozXULElement.insertFTLIfNeeded(&quot;browser/appMenuNotifications.ftl&quot;);</span>
<a href="#l6.165"></a><span id="l6.165" class="difflineminus">-</span>
<a href="#l6.166"></a><span id="l6.166" class="difflineminus">-    // After Fluent files are loaded into document replace data-lazy-l10n-ids with actual ones</span>
<a href="#l6.167"></a><span id="l6.167" class="difflineminus">-    document</span>
<a href="#l6.168"></a><span id="l6.168" class="difflineminus">-      .getElementById(&quot;appMenu-notification-popup&quot;)</span>
<a href="#l6.169"></a><span id="l6.169" class="difflineminus">-      .querySelectorAll(&quot;[data-lazy-l10n-id]&quot;)</span>
<a href="#l6.170"></a><span id="l6.170" class="difflineminus">-      .forEach(el =&gt; {</span>
<a href="#l6.171"></a><span id="l6.171" class="difflineminus">-        el.setAttribute(&quot;data-l10n-id&quot;, el.getAttribute(&quot;data-lazy-l10n-id&quot;));</span>
<a href="#l6.172"></a><span id="l6.172" class="difflineminus">-        el.removeAttribute(&quot;data-lazy-l10n-id&quot;);</span>
<a href="#l6.173"></a><span id="l6.173" class="difflineminus">-      });</span>
<a href="#l6.174"></a><span id="l6.174" class="difflineminus">-</span>
<a href="#l6.175"></a><span id="l6.175" class="difflineminus">-    this.notificationPanel.openPopup(anchor, &quot;bottomcenter topright&quot;);</span>
<a href="#l6.176"></a><span id="l6.176" class="difflineminus">-  },</span>
<a href="#l6.177"></a><span id="l6.177" class="difflineminus">-</span>
<a href="#l6.178"></a><span id="l6.178" class="difflineminus">-  _clearNotificationPanel() {</span>
<a href="#l6.179"></a><span id="l6.179" class="difflineminus">-    for (let popupnotification of this.notificationPanel.children) {</span>
<a href="#l6.180"></a><span id="l6.180" class="difflineminus">-      popupnotification.hidden = true;</span>
<a href="#l6.181"></a><span id="l6.181" class="difflineminus">-      popupnotification.notification = null;</span>
<a href="#l6.182"></a><span id="l6.182" class="difflineminus">-    }</span>
<a href="#l6.183"></a><span id="l6.183" class="difflineminus">-  },</span>
<a href="#l6.184"></a><span id="l6.184" class="difflineminus">-</span>
<a href="#l6.185"></a><span id="l6.185">   _clearAllNotifications() {</span>
<a href="#l6.186"></a><span id="l6.186" class="difflineminus">-    this._clearNotificationPanel();</span>
<a href="#l6.187"></a><span id="l6.187">     this._clearBadge();</span>
<a href="#l6.188"></a><span id="l6.188">     this._clearBannerItem();</span>
<a href="#l6.189"></a><span id="l6.189">   },</span>
<a href="#l6.190"></a><span id="l6.190"> </span>
<a href="#l6.191"></a><span id="l6.191">   _formatDescriptionMessage(n) {</span>
<a href="#l6.192"></a><span id="l6.192">     let text = {};</span>
<a href="#l6.193"></a><span id="l6.193">     let array = n.options.message.split(&quot;&lt;&gt;&quot;);</span>
<a href="#l6.194"></a><span id="l6.194">     text.start = array[0] || &quot;&quot;;</span>
<a href="#l6.195"></a><span id="l6.195">     text.name = n.options.name || &quot;&quot;;</span>
<a href="#l6.196"></a><span id="l6.196">     text.end = array[1] || &quot;&quot;;</span>
<a href="#l6.197"></a><span id="l6.197">     return text;</span>
<a href="#l6.198"></a><span id="l6.198">   },</span>
<a href="#l6.199"></a><span id="l6.199"> </span>
<a href="#l6.200"></a><span id="l6.200" class="difflineminus">-  _refreshNotificationPanel(notification) {</span>
<a href="#l6.201"></a><span id="l6.201" class="difflineminus">-    this._clearNotificationPanel();</span>
<a href="#l6.202"></a><span id="l6.202" class="difflineminus">-</span>
<a href="#l6.203"></a><span id="l6.203" class="difflineminus">-    let popupnotificationID = this._getPopupId(notification);</span>
<a href="#l6.204"></a><span id="l6.204" class="difflineminus">-    let popupnotification = document.getElementById(popupnotificationID);</span>
<a href="#l6.205"></a><span id="l6.205" class="difflineminus">-</span>
<a href="#l6.206"></a><span id="l6.206" class="difflineminus">-    popupnotification.setAttribute(&quot;id&quot;, popupnotificationID);</span>
<a href="#l6.207"></a><span id="l6.207" class="difflineminus">-    popupnotification.setAttribute(</span>
<a href="#l6.208"></a><span id="l6.208" class="difflineminus">-      &quot;buttoncommand&quot;,</span>
<a href="#l6.209"></a><span id="l6.209" class="difflineminus">-      &quot;PanelUI._onNotificationButtonEvent(event, 'buttoncommand');&quot;</span>
<a href="#l6.210"></a><span id="l6.210" class="difflineminus">-    );</span>
<a href="#l6.211"></a><span id="l6.211" class="difflineminus">-    popupnotification.setAttribute(</span>
<a href="#l6.212"></a><span id="l6.212" class="difflineminus">-      &quot;secondarybuttoncommand&quot;,</span>
<a href="#l6.213"></a><span id="l6.213" class="difflineminus">-      &quot;PanelUI._onNotificationButtonEvent(event, 'secondarybuttoncommand');&quot;</span>
<a href="#l6.214"></a><span id="l6.214" class="difflineminus">-    );</span>
<a href="#l6.215"></a><span id="l6.215" class="difflineminus">-</span>
<a href="#l6.216"></a><span id="l6.216" class="difflineminus">-    if (notification.options.message) {</span>
<a href="#l6.217"></a><span id="l6.217" class="difflineminus">-      let desc = this._formatDescriptionMessage(notification);</span>
<a href="#l6.218"></a><span id="l6.218" class="difflineminus">-      popupnotification.setAttribute(&quot;label&quot;, desc.start);</span>
<a href="#l6.219"></a><span id="l6.219" class="difflineminus">-      popupnotification.setAttribute(&quot;name&quot;, desc.name);</span>
<a href="#l6.220"></a><span id="l6.220" class="difflineminus">-      popupnotification.setAttribute(&quot;endlabel&quot;, desc.end);</span>
<a href="#l6.221"></a><span id="l6.221" class="difflineminus">-    }</span>
<a href="#l6.222"></a><span id="l6.222" class="difflineminus">-    if (notification.options.onRefresh) {</span>
<a href="#l6.223"></a><span id="l6.223" class="difflineminus">-      notification.options.onRefresh(window);</span>
<a href="#l6.224"></a><span id="l6.224" class="difflineminus">-    }</span>
<a href="#l6.225"></a><span id="l6.225" class="difflineminus">-    if (notification.options.popupIconURL) {</span>
<a href="#l6.226"></a><span id="l6.226" class="difflineminus">-      popupnotification.setAttribute(&quot;icon&quot;, notification.options.popupIconURL);</span>
<a href="#l6.227"></a><span id="l6.227" class="difflineminus">-    }</span>
<a href="#l6.228"></a><span id="l6.228" class="difflineminus">-</span>
<a href="#l6.229"></a><span id="l6.229" class="difflineminus">-    popupnotification.notification = notification;</span>
<a href="#l6.230"></a><span id="l6.230" class="difflineminus">-    popupnotification.show();</span>
<a href="#l6.231"></a><span id="l6.231" class="difflineminus">-  },</span>
<a href="#l6.232"></a><span id="l6.232" class="difflineminus">-</span>
<a href="#l6.233"></a><span id="l6.233">   _showBadge(notification) {</span>
<a href="#l6.234"></a><span id="l6.234">     let badgeStatus = this._getBadgeStatus(notification);</span>
<a href="#l6.235"></a><span id="l6.235">     this.menuButton.setAttribute(&quot;badge-status&quot;, badgeStatus);</span>
<a href="#l6.236"></a><span id="l6.236">   },</span>
<a href="#l6.237"></a><span id="l6.237"> </span>
<a href="#l6.238"></a><span id="l6.238">   // &quot;Banner item&quot; here refers to an item in the hamburger panel menu. They will</span>
<a href="#l6.239"></a><span id="l6.239">   // typically show up as a colored row in the panel.</span>
<a href="#l6.240"></a><span id="l6.240">   _showBannerItem(notification) {</span>
<a href="#l6.241"></a><span id="l6.241" class="difflineat">@@ -1331,8 +1247,100 @@ function getLocale() {</span>
<a href="#l6.242"></a><span id="l6.242"> }</span>
<a href="#l6.243"></a><span id="l6.243"> </span>
<a href="#l6.244"></a><span id="l6.244"> /**</span>
<a href="#l6.245"></a><span id="l6.245">  * Given a DOM node inside a &lt;popupnotification&gt;, return the parent &lt;popupnotification&gt;.</span>
<a href="#l6.246"></a><span id="l6.246">  */</span>
<a href="#l6.247"></a><span id="l6.247"> function getNotificationFromElement(aElement) {</span>
<a href="#l6.248"></a><span id="l6.248">   return aElement.closest(&quot;popupnotification&quot;);</span>
<a href="#l6.249"></a><span id="l6.249"> }</span>
<a href="#l6.250"></a><span id="l6.250" class="difflineplus">+</span>
<a href="#l6.251"></a><span id="l6.251" class="difflineplus">+/**</span>
<a href="#l6.252"></a><span id="l6.252" class="difflineplus">+ * This object is Thunderbird's version of the same object in</span>
<a href="#l6.253"></a><span id="l6.253" class="difflineplus">+ * browser/base/content/browser-addons.js.</span>
<a href="#l6.254"></a><span id="l6.254" class="difflineplus">+ */</span>
<a href="#l6.255"></a><span id="l6.255" class="difflineplus">+var gExtensionsNotifications = {</span>
<a href="#l6.256"></a><span id="l6.256" class="difflineplus">+  initialized: false,</span>
<a href="#l6.257"></a><span id="l6.257" class="difflineplus">+  init() {</span>
<a href="#l6.258"></a><span id="l6.258" class="difflineplus">+    this.updateAlerts();</span>
<a href="#l6.259"></a><span id="l6.259" class="difflineplus">+    this.boundUpdate = this.updateAlerts.bind(this);</span>
<a href="#l6.260"></a><span id="l6.260" class="difflineplus">+    ExtensionsUI.on(&quot;change&quot;, this.boundUpdate);</span>
<a href="#l6.261"></a><span id="l6.261" class="difflineplus">+    this.initialized = true;</span>
<a href="#l6.262"></a><span id="l6.262" class="difflineplus">+  },</span>
<a href="#l6.263"></a><span id="l6.263" class="difflineplus">+</span>
<a href="#l6.264"></a><span id="l6.264" class="difflineplus">+  uninit() {</span>
<a href="#l6.265"></a><span id="l6.265" class="difflineplus">+    // uninit() can race ahead of init() in some cases, if that happens,</span>
<a href="#l6.266"></a><span id="l6.266" class="difflineplus">+    // we have no handler to remove.</span>
<a href="#l6.267"></a><span id="l6.267" class="difflineplus">+    if (!this.initialized) {</span>
<a href="#l6.268"></a><span id="l6.268" class="difflineplus">+      return;</span>
<a href="#l6.269"></a><span id="l6.269" class="difflineplus">+    }</span>
<a href="#l6.270"></a><span id="l6.270" class="difflineplus">+    ExtensionsUI.off(&quot;change&quot;, this.boundUpdate);</span>
<a href="#l6.271"></a><span id="l6.271" class="difflineplus">+  },</span>
<a href="#l6.272"></a><span id="l6.272" class="difflineplus">+</span>
<a href="#l6.273"></a><span id="l6.273" class="difflineplus">+  _createAddonButton(text, icon, callback) {</span>
<a href="#l6.274"></a><span id="l6.274" class="difflineplus">+    let button = document.createXULElement(&quot;toolbarbutton&quot;);</span>
<a href="#l6.275"></a><span id="l6.275" class="difflineplus">+    button.setAttribute(&quot;label&quot;, text);</span>
<a href="#l6.276"></a><span id="l6.276" class="difflineplus">+    button.setAttribute(&quot;tooltiptext&quot;, text);</span>
<a href="#l6.277"></a><span id="l6.277" class="difflineplus">+    const DEFAULT_EXTENSION_ICON =</span>
<a href="#l6.278"></a><span id="l6.278" class="difflineplus">+      &quot;chrome://mozapps/skin/extensions/extensionGeneric.svg&quot;;</span>
<a href="#l6.279"></a><span id="l6.279" class="difflineplus">+    button.setAttribute(&quot;image&quot;, icon || DEFAULT_EXTENSION_ICON);</span>
<a href="#l6.280"></a><span id="l6.280" class="difflineplus">+    button.className = &quot;addon-banner-item&quot;;</span>
<a href="#l6.281"></a><span id="l6.281" class="difflineplus">+</span>
<a href="#l6.282"></a><span id="l6.282" class="difflineplus">+    button.addEventListener(&quot;command&quot;, callback);</span>
<a href="#l6.283"></a><span id="l6.283" class="difflineplus">+    PanelUI.addonNotificationContainer.appendChild(button);</span>
<a href="#l6.284"></a><span id="l6.284" class="difflineplus">+  },</span>
<a href="#l6.285"></a><span id="l6.285" class="difflineplus">+</span>
<a href="#l6.286"></a><span id="l6.286" class="difflineplus">+  updateAlerts() {</span>
<a href="#l6.287"></a><span id="l6.287" class="difflineplus">+    let tabmail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l6.288"></a><span id="l6.288" class="difflineplus">+    let sideloaded = ExtensionsUI.sideloaded;</span>
<a href="#l6.289"></a><span id="l6.289" class="difflineplus">+    let updates = ExtensionsUI.updates;</span>
<a href="#l6.290"></a><span id="l6.290" class="difflineplus">+    let bundle = new StringBundle(</span>
<a href="#l6.291"></a><span id="l6.291" class="difflineplus">+      &quot;chrome://messenger/locale/addons.properties&quot;</span>
<a href="#l6.292"></a><span id="l6.292" class="difflineplus">+    );</span>
<a href="#l6.293"></a><span id="l6.293" class="difflineplus">+</span>
<a href="#l6.294"></a><span id="l6.294" class="difflineplus">+    let container = PanelUI.addonNotificationContainer;</span>
<a href="#l6.295"></a><span id="l6.295" class="difflineplus">+</span>
<a href="#l6.296"></a><span id="l6.296" class="difflineplus">+    while (container.firstChild) {</span>
<a href="#l6.297"></a><span id="l6.297" class="difflineplus">+      container.firstChild.remove();</span>
<a href="#l6.298"></a><span id="l6.298" class="difflineplus">+    }</span>
<a href="#l6.299"></a><span id="l6.299" class="difflineplus">+</span>
<a href="#l6.300"></a><span id="l6.300" class="difflineplus">+    let items = 0;</span>
<a href="#l6.301"></a><span id="l6.301" class="difflineplus">+    for (let update of updates) {</span>
<a href="#l6.302"></a><span id="l6.302" class="difflineplus">+      if (++items &gt; 4) {</span>
<a href="#l6.303"></a><span id="l6.303" class="difflineplus">+        break;</span>
<a href="#l6.304"></a><span id="l6.304" class="difflineplus">+      }</span>
<a href="#l6.305"></a><span id="l6.305" class="difflineplus">+      let text = bundle.getFormattedString(&quot;webextPerms.updateMenuItem&quot;, [</span>
<a href="#l6.306"></a><span id="l6.306" class="difflineplus">+        update.addon.name,</span>
<a href="#l6.307"></a><span id="l6.307" class="difflineplus">+      ]);</span>
<a href="#l6.308"></a><span id="l6.308" class="difflineplus">+      this._createAddonButton(text, update.addon.iconURL, evt =&gt; {</span>
<a href="#l6.309"></a><span id="l6.309" class="difflineplus">+        ExtensionsUI.showUpdate(tabmail.selectedBrowser, update);</span>
<a href="#l6.310"></a><span id="l6.310" class="difflineplus">+      });</span>
<a href="#l6.311"></a><span id="l6.311" class="difflineplus">+    }</span>
<a href="#l6.312"></a><span id="l6.312" class="difflineplus">+</span>
<a href="#l6.313"></a><span id="l6.313" class="difflineplus">+    let appName;</span>
<a href="#l6.314"></a><span id="l6.314" class="difflineplus">+    for (let addon of sideloaded) {</span>
<a href="#l6.315"></a><span id="l6.315" class="difflineplus">+      if (++items &gt; 4) {</span>
<a href="#l6.316"></a><span id="l6.316" class="difflineplus">+        break;</span>
<a href="#l6.317"></a><span id="l6.317" class="difflineplus">+      }</span>
<a href="#l6.318"></a><span id="l6.318" class="difflineplus">+      if (!appName) {</span>
<a href="#l6.319"></a><span id="l6.319" class="difflineplus">+        let brandBundle = document.getElementById(&quot;bundle_brand&quot;);</span>
<a href="#l6.320"></a><span id="l6.320" class="difflineplus">+        appName = brandBundle.getString(&quot;brandShortName&quot;);</span>
<a href="#l6.321"></a><span id="l6.321" class="difflineplus">+      }</span>
<a href="#l6.322"></a><span id="l6.322" class="difflineplus">+</span>
<a href="#l6.323"></a><span id="l6.323" class="difflineplus">+      let text = bundle.getFormattedString(&quot;webextPerms.sideloadMenuItem&quot;, [</span>
<a href="#l6.324"></a><span id="l6.324" class="difflineplus">+        addon.name,</span>
<a href="#l6.325"></a><span id="l6.325" class="difflineplus">+        appName,</span>
<a href="#l6.326"></a><span id="l6.326" class="difflineplus">+      ]);</span>
<a href="#l6.327"></a><span id="l6.327" class="difflineplus">+      this._createAddonButton(text, addon.iconURL, evt =&gt; {</span>
<a href="#l6.328"></a><span id="l6.328" class="difflineplus">+        // We need to hide the main menu manually because the toolbarbutton is</span>
<a href="#l6.329"></a><span id="l6.329" class="difflineplus">+        // removed immediately while processing this event, and PanelUI is</span>
<a href="#l6.330"></a><span id="l6.330" class="difflineplus">+        // unable to identify which panel should be closed automatically.</span>
<a href="#l6.331"></a><span id="l6.331" class="difflineplus">+        PanelUI.hide();</span>
<a href="#l6.332"></a><span id="l6.332" class="difflineplus">+        ExtensionsUI.showSideloaded(tabmail.selectedBrowser, addon);</span>
<a href="#l6.333"></a><span id="l6.333" class="difflineplus">+      });</span>
<a href="#l6.334"></a><span id="l6.334" class="difflineplus">+    }</span>
<a href="#l6.335"></a><span id="l6.335" class="difflineplus">+  },</span>
<a href="#l6.336"></a><span id="l6.336" class="difflineplus">+};</span>
<a href="#l6.337"></a><span id="l6.337" class="difflineplus">+</span>
<a href="#l6.338"></a><span id="l6.338" class="difflineplus">+addEventListener(&quot;load&quot;, () =&gt; gExtensionsNotifications.init(), { once: true });</span>
<a href="#l6.339"></a><span id="l6.339" class="difflineplus">+addEventListener(&quot;unload&quot;, () =&gt; gExtensionsNotifications.uninit(), {</span>
<a href="#l6.340"></a><span id="l6.340" class="difflineplus">+  once: true,</span>
<a href="#l6.341"></a><span id="l6.341" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/addons.properties</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/addons.properties</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -1,21 +1,45 @@</span>
<a href="#l7.4"></a><span id="l7.4" class="difflineplus">+# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l7.5"></a><span id="l7.5" class="difflineplus">+# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l7.6"></a><span id="l7.6" class="difflineplus">+# file, you can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l7.7"></a><span id="l7.7" class="difflineplus">+</span>
<a href="#l7.8"></a><span id="l7.8"> xpinstallPromptMessage=%S prevented this site from asking you to install software on your computer.</span>
<a href="#l7.9"></a><span id="l7.9" class="difflineplus">+# LOCALIZATION NOTE (xpinstallPromptMessage.header)</span>
<a href="#l7.10"></a><span id="l7.10" class="difflineplus">+# The string contains the hostname of the site the add-on is being installed from.</span>
<a href="#l7.11"></a><span id="l7.11" class="difflineplus">+xpinstallPromptMessage.header=Allow %S to install an add-on?</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+xpinstallPromptMessage.message=You are attempting to install an add-on from %S. Make sure you trust this site before continuing.</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+xpinstallPromptMessage.header.unknown=Allow an unknown site to install an add-on?</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+xpinstallPromptMessage.message.unknown=You are attempting to install an add-on from an unknown site. Make sure you trust this site before continuing.</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+xpinstallPromptMessage.learnMore=Learn more about installing add-ons safely</span>
<a href="#l7.16"></a><span id="l7.16"> xpinstallPromptMessage.dontAllow=Don’t Allow</span>
<a href="#l7.17"></a><span id="l7.17"> xpinstallPromptMessage.dontAllow.accesskey=D</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineminus">-xpinstallPromptAllowButton=Allow</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+xpinstallPromptMessage.neverAllow=Never Allow</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+xpinstallPromptMessage.neverAllow.accesskey=N</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+# Accessibility Note:</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineplus">+# Be sure you do not choose an accesskey that is used elsewhere in the active context (e.g. main menu bar, submenu of the warning popup button)</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineplus">+# See https://website-archive.mozilla.org/www.mozilla.org/access/access/keyboard/ for details</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineplus">+xpinstallPromptMessage.install=Continue to Installation</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineplus">+xpinstallPromptMessage.install.accesskey=C</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineplus">+</span>
<a href="#l7.27"></a><span id="l7.27"> # Accessibility Note:</span>
<a href="#l7.28"></a><span id="l7.28"> # Be sure you do not choose an accesskey that is used elsewhere in the active context (e.g. main menu bar, submenu of the warning popup button)</span>
<a href="#l7.29"></a><span id="l7.29"> # See http://www.mozilla.org/access/keyboard/accesskey for details</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineminus">-xpinstallPromptAllowButton.accesskey=A</span>
<a href="#l7.31"></a><span id="l7.31"> xpinstallDisabledMessageLocked=Software installation has been disabled by your system administrator.</span>
<a href="#l7.32"></a><span id="l7.32"> xpinstallDisabledMessage=Software installation is currently disabled. Click Enable and try again.</span>
<a href="#l7.33"></a><span id="l7.33"> xpinstallDisabledButton=Enable</span>
<a href="#l7.34"></a><span id="l7.34"> xpinstallDisabledButton.accesskey=n</span>
<a href="#l7.35"></a><span id="l7.35"> </span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+# LOCALIZATION NOTE (addonInstallBlockedByPolicy)</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+# This message is shown when the installation of an add-on is blocked by</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineplus">+# enterprise policy. %1$S is replaced by the name of the add-on.</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineplus">+# %2$S is replaced by the ID of add-on. %3$S is a custom message that</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+# the administration can add to the message.</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineplus">+addonInstallBlockedByPolicy=%1$S (%2$S) is blocked by your system administrator.%3$S</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineplus">+</span>
<a href="#l7.43"></a><span id="l7.43"> # LOCALIZATION NOTE (addonPostInstall.message1)</span>
<a href="#l7.44"></a><span id="l7.44"> # %1$S is replaced with the localized named of the extension that was</span>
<a href="#l7.45"></a><span id="l7.45"> # just installed.</span>
<a href="#l7.46"></a><span id="l7.46"> # %2$S is replaced with the localized name of the application.</span>
<a href="#l7.47"></a><span id="l7.47"> addonPostInstall.message1=%1$S has been added to %2$S.</span>
<a href="#l7.48"></a><span id="l7.48"> # LOCALIZATION NOTE (addonPostInstall.multiple.message1)</span>
<a href="#l7.49"></a><span id="l7.49"> # %1$S is replaced with the localized name of the application.</span>
<a href="#l7.50"></a><span id="l7.50"> addonPostInstall.multiple.message=These add-ons have been added to %1$S:</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mail/themes/shared/customizableui/panelUI.css</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mail/themes/shared/customizableui/panelUI.css</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -1,12 +1,14 @@</span>
<a href="#l8.4"></a><span id="l8.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l8.5"></a><span id="l8.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l8.6"></a><span id="l8.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l8.7"></a><span id="l8.7"> </span>
<a href="#l8.8"></a><span id="l8.8" class="difflineplus">+%filter substitution</span>
<a href="#l8.9"></a><span id="l8.9" class="difflineplus">+</span>
<a href="#l8.10"></a><span id="l8.10"> :root {</span>
<a href="#l8.11"></a><span id="l8.11">   --menu-panel-width: 22.35em;</span>
<a href="#l8.12"></a><span id="l8.12">   --wide-menu-panel-width: 29em;</span>
<a href="#l8.13"></a><span id="l8.13">   --standalone-subview-width: 30em;</span>
<a href="#l8.14"></a><span id="l8.14">   --panel-palette-icon-size: 16px;</span>
<a href="#l8.15"></a><span id="l8.15"> </span>
<a href="#l8.16"></a><span id="l8.16">   /* XXXgijs This is the ugliest bit of code I think I've ever written for Mozilla.</span>
<a href="#l8.17"></a><span id="l8.17">   Basically, the [extra 0.1px in the 1.1px] is there to avoid CSS rounding errors</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineat">@@ -1325,8 +1327,159 @@ toolbarpaletteitem[place=&quot;menu-panel&quot;] &gt;</span>
<a href="#l8.19"></a><span id="l8.19"> </span>
<a href="#l8.20"></a><span id="l8.20"> .subviewbutton.download:-moz-any([canShow],[canRetry]) &gt; .action-button:not(:-moz-any([disabled],[open],:active)):-moz-any(:hover,:focus) {</span>
<a href="#l8.21"></a><span id="l8.21">   background-color: var(--arrowpanel-dimmed-further);</span>
<a href="#l8.22"></a><span id="l8.22"> }</span>
<a href="#l8.23"></a><span id="l8.23"> </span>
<a href="#l8.24"></a><span id="l8.24"> .subviewbutton.download:-moz-any([canShow],[canRetry]) &gt; .action-button:not([disabled]):-moz-any([open],:hover:active) {</span>
<a href="#l8.25"></a><span id="l8.25">   background-color: var(--arrowpanel-dimmed-even-further);</span>
<a href="#l8.26"></a><span id="l8.26"> }</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineplus">+</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineplus">+%define menuPanelWidth 22.35em</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineplus">+%define appmenuWarningBackgroundColor #FFEFBF</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineplus">+%define appmenuWarningBackgroundColorHover #FFE8A2</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineplus">+%define appmenuWarningBackgroundColorActive #FFE38F</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+%define appmenuWarningColor black</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+%define appmenuWarningBorderColor hsl(45,100%,77%)</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineplus">+%define appmenuWarningBackgroundColorBrightText hsla(55,100%,50%,.1)</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineplus">+%define appmenuWarningBackgroundColorHoverBrightText hsla(55,100%,50%,.15)</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineplus">+%define appmenuWarningBackgroundColorActiveBrightText hsla(55,100%,50%,.2)</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineplus">+%define appmenuWarningColorBrightText #F9F9FA</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineplus">+</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineplus">+.button-appmenu[badge-status] &gt; .toolbarbutton-badge-stack &gt; .toolbarbutton-badge {</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineplus">+  display: -moz-box;</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineplus">+  height: 10px;</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineplus">+  width: 10px;</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineplus">+  background-size: contain;</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineplus">+  border: none;</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineplus">+}</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineplus">+</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineplus">+.button-appmenu[badge-status=&quot;addon-alert&quot;] &gt; .toolbarbutton-badge-stack &gt; .toolbarbutton-badge {</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineplus">+  height: 13px;</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineplus">+  background: url(chrome://browser/skin/warning.svg) center / contain no-repeat transparent;</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+  box-shadow: none;</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineplus">+  border-radius: 0;</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineplus">+  /* Use the included fallbacks defined in the SVG file instead of inheriting from .toolbarbutton-1. */</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineplus">+  -moz-context-properties: none;</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineplus">+}</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineplus">+</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineplus">+.button-appmenu[badge-status] &gt; .toolbarbutton-badge-stack &gt; .toolbarbutton-badge:-moz-window-inactive {</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineplus">+  filter: grayscale(100%);</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineplus">+}</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineplus">+</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineplus">+#nav-bar[brighttext] .button-appmenu[badge-status=&quot;addon-alert&quot;] &gt; .toolbarbutton-badge-stack &gt; .toolbarbutton-badge {</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineplus">+  -moz-context-properties: fill, stroke;</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineplus">+  fill: #FFE900;</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineplus">+  stroke: transparent;</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineplus">+}</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineplus">+</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineplus">+.addon-banner-item::after,</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineplus">+.panel-banner-item::after {</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineplus">+  content: &quot;&quot;;</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineplus">+  width: 16px;</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineplus">+  height: 16px;</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineplus">+  margin-inline-start: 10px;</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineplus">+  margin-inline-end: 12px;</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineplus">+  display: -moz-box;</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineplus">+}</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineplus">+</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineplus">+.addon-banner-item {</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineplus">+  background-color: @appmenuWarningBackgroundColor@;</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineplus">+  color: @appmenuWarningColor@;</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineplus">+  /* Force border to override `.addon-banner-item` selector below */</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineplus">+  border-top: 1px solid @appmenuWarningBorderColor@ !important;</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineplus">+  display: flex;</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineplus">+  flex: 1 1 0%;</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineplus">+  width: calc(@menuPanelWidth@ + 30px);</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineplus">+  padding-inline-start: 15px;</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineplus">+  border-inline-start-style: none;</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineplus">+  -moz-image-region: rect(0, 16px, 16px, 0);</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineplus">+}</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineplus">+</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineplus">+.addon-banner-item:last-child {</span>
<a href="#l8.91"></a><span id="l8.91" class="difflineplus">+  border-bottom: 1px solid @appmenuWarningBorderColor@;</span>
<a href="#l8.92"></a><span id="l8.92" class="difflineplus">+}</span>
<a href="#l8.93"></a><span id="l8.93" class="difflineplus">+</span>
<a href="#l8.94"></a><span id="l8.94" class="difflineplus">+.addon-banner-item:focus,</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineplus">+.addon-banner-item:hover {</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineplus">+  background-color: @appmenuWarningBackgroundColorHover@;</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineplus">+}</span>
<a href="#l8.98"></a><span id="l8.98" class="difflineplus">+</span>
<a href="#l8.99"></a><span id="l8.99" class="difflineplus">+.addon-banner-item:hover:active {</span>
<a href="#l8.100"></a><span id="l8.100" class="difflineplus">+  background-color: @appmenuWarningBackgroundColorActive@;</span>
<a href="#l8.101"></a><span id="l8.101" class="difflineplus">+}</span>
<a href="#l8.102"></a><span id="l8.102" class="difflineplus">+</span>
<a href="#l8.103"></a><span id="l8.103" class="difflineplus">+.addon-banner-item &gt; .toolbarbutton-icon {</span>
<a href="#l8.104"></a><span id="l8.104" class="difflineplus">+  width: 16px;</span>
<a href="#l8.105"></a><span id="l8.105" class="difflineplus">+  height: 16px;</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineplus">+}</span>
<a href="#l8.107"></a><span id="l8.107" class="difflineplus">+</span>
<a href="#l8.108"></a><span id="l8.108" class="difflineplus">+.addon-banner-item::after {</span>
<a href="#l8.109"></a><span id="l8.109" class="difflineplus">+  background: url(chrome://browser/skin/warning.svg) no-repeat center;</span>
<a href="#l8.110"></a><span id="l8.110" class="difflineplus">+}</span>
<a href="#l8.111"></a><span id="l8.111" class="difflineplus">+</span>
<a href="#l8.112"></a><span id="l8.112" class="difflineplus">+:root[lwt-popup-brighttext] .addon-banner-item::after {</span>
<a href="#l8.113"></a><span id="l8.113" class="difflineplus">+  -moz-context-properties: fill, stroke;</span>
<a href="#l8.114"></a><span id="l8.114" class="difflineplus">+  fill: #FFE900;</span>
<a href="#l8.115"></a><span id="l8.115" class="difflineplus">+  stroke: transparent;</span>
<a href="#l8.116"></a><span id="l8.116" class="difflineplus">+}</span>
<a href="#l8.117"></a><span id="l8.117" class="difflineplus">+</span>
<a href="#l8.118"></a><span id="l8.118" class="difflineplus">+.addon-banner-item {</span>
<a href="#l8.119"></a><span id="l8.119" class="difflineplus">+  margin: 0;</span>
<a href="#l8.120"></a><span id="l8.120" class="difflineplus">+  padding: 11px 0;</span>
<a href="#l8.121"></a><span id="l8.121" class="difflineplus">+  box-sizing: border-box;</span>
<a href="#l8.122"></a><span id="l8.122" class="difflineplus">+  min-height: 40px;</span>
<a href="#l8.123"></a><span id="l8.123" class="difflineplus">+  -moz-appearance: none;</span>
<a href="#l8.124"></a><span id="l8.124" class="difflineplus">+  box-shadow: none;</span>
<a href="#l8.125"></a><span id="l8.125" class="difflineplus">+  border: none;</span>
<a href="#l8.126"></a><span id="l8.126" class="difflineplus">+  border-radius: 0;</span>
<a href="#l8.127"></a><span id="l8.127" class="difflineplus">+  transition: background-color;</span>
<a href="#l8.128"></a><span id="l8.128" class="difflineplus">+  -moz-box-orient: horizontal;</span>
<a href="#l8.129"></a><span id="l8.129" class="difflineplus">+}</span>
<a href="#l8.130"></a><span id="l8.130" class="difflineplus">+</span>
<a href="#l8.131"></a><span id="l8.131" class="difflineplus">+#appMenu-addon-banners:not(:empty) + .panel-banner-item {</span>
<a href="#l8.132"></a><span id="l8.132" class="difflineplus">+  /* Overlap the .addon-banner-item border so there's one border. */</span>
<a href="#l8.133"></a><span id="l8.133" class="difflineplus">+  margin-top: -1px;</span>
<a href="#l8.134"></a><span id="l8.134" class="difflineplus">+}</span>
<a href="#l8.135"></a><span id="l8.135" class="difflineplus">+</span>
<a href="#l8.136"></a><span id="l8.136" class="difflineplus">+#appMenu-addon-banners &gt; .addon-banner-item {</span>
<a href="#l8.137"></a><span id="l8.137" class="difflineplus">+  padding-inline-start: 12px;</span>
<a href="#l8.138"></a><span id="l8.138" class="difflineplus">+}</span>
<a href="#l8.139"></a><span id="l8.139" class="difflineplus">+</span>
<a href="#l8.140"></a><span id="l8.140" class="difflineplus">+.addon-banner-item &gt; .toolbarbutton-text,</span>
<a href="#l8.141"></a><span id="l8.141" class="difflineplus">+.panel-banner-item &gt; .toolbarbutton-text {</span>
<a href="#l8.142"></a><span id="l8.142" class="difflineplus">+  margin: 0;</span>
<a href="#l8.143"></a><span id="l8.143" class="difflineplus">+  padding: 0 6px;</span>
<a href="#l8.144"></a><span id="l8.144" class="difflineplus">+  text-align: start;</span>
<a href="#l8.145"></a><span id="l8.145" class="difflineplus">+}</span>
<a href="#l8.146"></a><span id="l8.146" class="difflineplus">+</span>
<a href="#l8.147"></a><span id="l8.147" class="difflineplus">+.addon-banner-item &gt; .toolbarbutton-icon,</span>
<a href="#l8.148"></a><span id="l8.148" class="difflineplus">+.panel-banner-item &gt; .toolbarbutton-icon {</span>
<a href="#l8.149"></a><span id="l8.149" class="difflineplus">+  margin-inline-end: 0;</span>
<a href="#l8.150"></a><span id="l8.150" class="difflineplus">+}</span>
<a href="#l8.151"></a><span id="l8.151" class="difflineplus">+</span>
<a href="#l8.152"></a><span id="l8.152" class="difflineplus">+.addon-banner-item {</span>
<a href="#l8.153"></a><span id="l8.153" class="difflineplus">+  flex: 1;</span>
<a href="#l8.154"></a><span id="l8.154" class="difflineplus">+  padding-inline-start: 15px;</span>
<a href="#l8.155"></a><span id="l8.155" class="difflineplus">+  border-inline-start-style: none;</span>
<a href="#l8.156"></a><span id="l8.156" class="difflineplus">+}</span>
<a href="#l8.157"></a><span id="l8.157" class="difflineplus">+</span>
<a href="#l8.158"></a><span id="l8.158" class="difflineplus">+:root[lwt-popup-brighttext] .addon-banner-item {</span>
<a href="#l8.159"></a><span id="l8.159" class="difflineplus">+  color: @appmenuWarningColorBrightText@;</span>
<a href="#l8.160"></a><span id="l8.160" class="difflineplus">+  background: @appmenuWarningBackgroundColorBrightText@;</span>
<a href="#l8.161"></a><span id="l8.161" class="difflineplus">+  /* override `.addon-banner-item` border-top !important defined above */</span>
<a href="#l8.162"></a><span id="l8.162" class="difflineplus">+  border: 0 !important;</span>
<a href="#l8.163"></a><span id="l8.163" class="difflineplus">+}</span>
<a href="#l8.164"></a><span id="l8.164" class="difflineplus">+</span>
<a href="#l8.165"></a><span id="l8.165" class="difflineplus">+:root[lwt-popup-brighttext] .addon-banner-item:hover,</span>
<a href="#l8.166"></a><span id="l8.166" class="difflineplus">+:root[lwt-popup-brighttext] .addon-banner-item:focus {</span>
<a href="#l8.167"></a><span id="l8.167" class="difflineplus">+  background: @appmenuWarningBackgroundColorHoverBrightText@;</span>
<a href="#l8.168"></a><span id="l8.168" class="difflineplus">+}</span>
<a href="#l8.169"></a><span id="l8.169" class="difflineplus">+</span>
<a href="#l8.170"></a><span id="l8.170" class="difflineplus">+:root[lwt-popup-brighttext] .addon-banner-item:hover:active,</span>
<a href="#l8.171"></a><span id="l8.171" class="difflineplus">+:root[lwt-popup-brighttext] .addon-banner-item:focus:active {</span>
<a href="#l8.172"></a><span id="l8.172" class="difflineplus">+  background: @appmenuWarningBackgroundColorActiveBrightText@;</span>
<a href="#l8.173"></a><span id="l8.173" class="difflineplus">+}</span>
<a href="#l8.174"></a><span id="l8.174" class="difflineplus">+</span>
<a href="#l8.175"></a><span id="l8.175" class="difflineplus">+.addon-banner-item &gt; .toolbarbutton-text {</span>
<a href="#l8.176"></a><span id="l8.176" class="difflineplus">+  padding-inline-start: 8px; /* See '.subviewbutton-iconic &gt; .toolbarbutton-text' rule above. */</span>
<a href="#l8.177"></a><span id="l8.177" class="difflineplus">+}</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:31Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

