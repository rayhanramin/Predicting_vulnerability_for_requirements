<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 29975:b6d81f685df438f37780c53f8ed8af8a7294785c</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ b6d81f685df438f37780c53f8ed8af8a7294785c" />
<meta property="og:url" content="/comm-central/rev/b6d81f685df438f37780c53f8ed8af8a7294785c" />
<meta property="og:description" content="Bug 1647671 - Update RNP to snapshot from 2020-06-19. r=rjl" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / b6d81f685df438f37780c53f8ed8af8a7294785c 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/b6d81f685df438f37780c53f8ed8af8a7294785c">shortlog</a> |
<a href="/comm-central/log/b6d81f685df438f37780c53f8ed8af8a7294785c">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/b6d81f685df438f37780c53f8ed8af8a7294785c">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/b6d81f685df438f37780c53f8ed8af8a7294785c">files</a> |
changeset |
<a href="/comm-central/raw-rev/b6d81f685df438f37780c53f8ed8af8a7294785c">raw</a>  | <a href="/comm-central/archive/b6d81f685df438f37780c53f8ed8af8a7294785c.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1647671">Bug 1647671</a> - Update RNP to snapshot from 2020-06-19. r=rjl
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#75;&#97;&#105;&#32;&#69;&#110;&#103;&#101;&#114;&#116;&#32;&#60;&#107;&#97;&#105;&#101;&#64;&#107;&#117;&#105;&#120;&#46;&#100;&#101;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 23 Jun 2020 12:32:22 +0200</td></tr>

<tr>
 <td>changeset 29975</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/b6d81f685df438f37780c53f8ed8af8a7294785c">b6d81f685df438f37780c53f8ed8af8a7294785c</a></td>
</tr>



<tr>
<td>parent 29974</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/b935cc4f10fec4af2b0cd0bcffaaf951cf86f1e7">b935cc4f10fec4af2b0cd0bcffaaf951cf86f1e7</a>
</td>
</tr>

<tr>
<td>child 29976</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/552a164af0b8555a33e9a4107445e6e3a3364301">552a164af0b8555a33e9a4107445e6e3a3364301</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=b6d81f685df438f37780c53f8ed8af8a7294785c">17623</a></td></tr>
<tr><td>push user</td><td>kaie@kuix.de</td></tr>
<tr><td>push date</td><td class="date age">Thu, 25 Jun 2020 11:05:48 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@b53a6d2d9d11 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=b53a6d2d9d111b19b1e29538cf1125fc24a34501">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=b53a6d2d9d111b19b1e29538cf1125fc24a34501&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b53a6d2d9d111b19b1e29538cf1125fc24a34501&newProject=comm-central&newRevision=b6d81f685df438f37780c53f8ed8af8a7294785c&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b53a6d2d9d111b19b1e29538cf1125fc24a34501&newProject=comm-central&newRevision=b6d81f685df438f37780c53f8ed8af8a7294785c&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b53a6d2d9d111b19b1e29538cf1125fc24a34501&newProject=comm-central&newRevision=b6d81f685df438f37780c53f8ed8af8a7294785c&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28rjl%29&revcount=50">rjl</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1647671">1647671</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1647671">Bug 1647671</a> - Update RNP to snapshot from 2020-06-19. r=rjl

Differential Revision: <a href="https://phabricator.services.mozilla.com/D80628">https://phabricator.services.mozilla.com/D80628</a></div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/README.rnp">third_party/README.rnp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/README.rnp">file</a> |
<a href="/comm-central/annotate/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/README.rnp">annotate</a> |
<a href="/comm-central/diff/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/README.rnp">diff</a> |
<a href="/comm-central/comparison/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/README.rnp">comparison</a> |
<a href="/comm-central/log/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/README.rnp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/include/rekey/rnp_key_store.h">third_party/rnp/include/rekey/rnp_key_store.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/include/rekey/rnp_key_store.h">file</a> |
<a href="/comm-central/annotate/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/include/rekey/rnp_key_store.h">annotate</a> |
<a href="/comm-central/diff/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/include/rekey/rnp_key_store.h">diff</a> |
<a href="/comm-central/comparison/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/include/rekey/rnp_key_store.h">comparison</a> |
<a href="/comm-central/log/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/include/rekey/rnp_key_store.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/include/rnp/rnp.h">third_party/rnp/include/rnp/rnp.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/include/rnp/rnp.h">file</a> |
<a href="/comm-central/annotate/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/include/rnp/rnp.h">annotate</a> |
<a href="/comm-central/diff/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/include/rnp/rnp.h">diff</a> |
<a href="/comm-central/comparison/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/include/rnp/rnp.h">comparison</a> |
<a href="/comm-central/log/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/include/rnp/rnp.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/examples/sign.c">third_party/rnp/src/examples/sign.c</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/examples/sign.c">file</a> |
<a href="/comm-central/annotate/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/examples/sign.c">annotate</a> |
<a href="/comm-central/diff/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/examples/sign.c">diff</a> |
<a href="/comm-central/comparison/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/examples/sign.c">comparison</a> |
<a href="/comm-central/log/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/examples/sign.c">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/lib/CMakeLists.txt">third_party/rnp/src/lib/CMakeLists.txt</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/lib/CMakeLists.txt">file</a> |
<a href="/comm-central/annotate/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/lib/CMakeLists.txt">annotate</a> |
<a href="/comm-central/diff/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/lib/CMakeLists.txt">diff</a> |
<a href="/comm-central/comparison/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/lib/CMakeLists.txt">comparison</a> |
<a href="/comm-central/log/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/lib/CMakeLists.txt">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/lib/config.h.in">third_party/rnp/src/lib/config.h.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/lib/config.h.in">file</a> |
<a href="/comm-central/annotate/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/lib/config.h.in">annotate</a> |
<a href="/comm-central/diff/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/lib/config.h.in">diff</a> |
<a href="/comm-central/comparison/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/lib/config.h.in">comparison</a> |
<a href="/comm-central/log/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/lib/config.h.in">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/lib/ffi-priv-types.h">third_party/rnp/src/lib/ffi-priv-types.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/lib/ffi-priv-types.h">file</a> |
<a href="/comm-central/annotate/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/lib/ffi-priv-types.h">annotate</a> |
<a href="/comm-central/diff/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/lib/ffi-priv-types.h">diff</a> |
<a href="/comm-central/comparison/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/lib/ffi-priv-types.h">comparison</a> |
<a href="/comm-central/log/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/lib/ffi-priv-types.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/lib/pgp-key.cpp">third_party/rnp/src/lib/pgp-key.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/lib/pgp-key.cpp">file</a> |
<a href="/comm-central/annotate/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/lib/pgp-key.cpp">annotate</a> |
<a href="/comm-central/diff/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/lib/pgp-key.cpp">diff</a> |
<a href="/comm-central/comparison/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/lib/pgp-key.cpp">comparison</a> |
<a href="/comm-central/log/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/lib/pgp-key.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/lib/pgp-key.h">third_party/rnp/src/lib/pgp-key.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/lib/pgp-key.h">file</a> |
<a href="/comm-central/annotate/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/lib/pgp-key.h">annotate</a> |
<a href="/comm-central/diff/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/lib/pgp-key.h">diff</a> |
<a href="/comm-central/comparison/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/lib/pgp-key.h">comparison</a> |
<a href="/comm-central/log/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/lib/pgp-key.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/lib/rnp.cpp">third_party/rnp/src/lib/rnp.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/lib/rnp.cpp">file</a> |
<a href="/comm-central/annotate/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/lib/rnp.cpp">annotate</a> |
<a href="/comm-central/diff/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/lib/rnp.cpp">diff</a> |
<a href="/comm-central/comparison/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/lib/rnp.cpp">comparison</a> |
<a href="/comm-central/log/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/lib/rnp.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/lib/utils.h">third_party/rnp/src/lib/utils.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/lib/utils.h">file</a> |
<a href="/comm-central/annotate/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/lib/utils.h">annotate</a> |
<a href="/comm-central/diff/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/lib/utils.h">diff</a> |
<a href="/comm-central/comparison/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/lib/utils.h">comparison</a> |
<a href="/comm-central/log/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/lib/utils.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/lib/version.h">third_party/rnp/src/lib/version.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/lib/version.h">file</a> |
<a href="/comm-central/annotate/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/lib/version.h">annotate</a> |
<a href="/comm-central/diff/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/lib/version.h">diff</a> |
<a href="/comm-central/comparison/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/lib/version.h">comparison</a> |
<a href="/comm-central/log/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/lib/version.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/librekey/key_store_pgp.cpp">third_party/rnp/src/librekey/key_store_pgp.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/librekey/key_store_pgp.cpp">file</a> |
<a href="/comm-central/annotate/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/librekey/key_store_pgp.cpp">annotate</a> |
<a href="/comm-central/diff/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/librekey/key_store_pgp.cpp">diff</a> |
<a href="/comm-central/comparison/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/librekey/key_store_pgp.cpp">comparison</a> |
<a href="/comm-central/log/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/librekey/key_store_pgp.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/librekey/rnp_key_store.cpp">third_party/rnp/src/librekey/rnp_key_store.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/librekey/rnp_key_store.cpp">file</a> |
<a href="/comm-central/annotate/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/librekey/rnp_key_store.cpp">annotate</a> |
<a href="/comm-central/diff/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/librekey/rnp_key_store.cpp">diff</a> |
<a href="/comm-central/comparison/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/librekey/rnp_key_store.cpp">comparison</a> |
<a href="/comm-central/log/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/librekey/rnp_key_store.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/librepgp/stream-parse.cpp">third_party/rnp/src/librepgp/stream-parse.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/librepgp/stream-parse.cpp">file</a> |
<a href="/comm-central/annotate/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/librepgp/stream-parse.cpp">annotate</a> |
<a href="/comm-central/diff/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/librepgp/stream-parse.cpp">diff</a> |
<a href="/comm-central/comparison/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/librepgp/stream-parse.cpp">comparison</a> |
<a href="/comm-central/log/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/librepgp/stream-parse.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/librepgp/stream-parse.h">third_party/rnp/src/librepgp/stream-parse.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/librepgp/stream-parse.h">file</a> |
<a href="/comm-central/annotate/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/librepgp/stream-parse.h">annotate</a> |
<a href="/comm-central/diff/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/librepgp/stream-parse.h">diff</a> |
<a href="/comm-central/comparison/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/librepgp/stream-parse.h">comparison</a> |
<a href="/comm-central/log/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/librepgp/stream-parse.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/rnp/CMakeLists.txt">third_party/rnp/src/rnp/CMakeLists.txt</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/rnp/CMakeLists.txt">file</a> |
<a href="/comm-central/annotate/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/rnp/CMakeLists.txt">annotate</a> |
<a href="/comm-central/diff/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/rnp/CMakeLists.txt">diff</a> |
<a href="/comm-central/comparison/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/rnp/CMakeLists.txt">comparison</a> |
<a href="/comm-central/log/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/rnp/CMakeLists.txt">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/rnp/fficli.cpp">third_party/rnp/src/rnp/fficli.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/rnp/fficli.cpp">file</a> |
<a href="/comm-central/annotate/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/rnp/fficli.cpp">annotate</a> |
<a href="/comm-central/diff/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/rnp/fficli.cpp">diff</a> |
<a href="/comm-central/comparison/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/rnp/fficli.cpp">comparison</a> |
<a href="/comm-central/log/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/rnp/fficli.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/rnp/fficli.h">third_party/rnp/src/rnp/fficli.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/rnp/fficli.h">file</a> |
<a href="/comm-central/annotate/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/rnp/fficli.h">annotate</a> |
<a href="/comm-central/diff/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/rnp/fficli.h">diff</a> |
<a href="/comm-central/comparison/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/rnp/fficli.h">comparison</a> |
<a href="/comm-central/log/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/rnp/fficli.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/rnpkeys/CMakeLists.txt">third_party/rnp/src/rnpkeys/CMakeLists.txt</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/rnpkeys/CMakeLists.txt">file</a> |
<a href="/comm-central/annotate/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/rnpkeys/CMakeLists.txt">annotate</a> |
<a href="/comm-central/diff/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/rnpkeys/CMakeLists.txt">diff</a> |
<a href="/comm-central/comparison/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/rnpkeys/CMakeLists.txt">comparison</a> |
<a href="/comm-central/log/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/rnpkeys/CMakeLists.txt">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/rnpkeys/tui.cpp">third_party/rnp/src/rnpkeys/tui.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/rnpkeys/tui.cpp">file</a> |
<a href="/comm-central/annotate/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/rnpkeys/tui.cpp">annotate</a> |
<a href="/comm-central/diff/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/rnpkeys/tui.cpp">diff</a> |
<a href="/comm-central/comparison/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/rnpkeys/tui.cpp">comparison</a> |
<a href="/comm-central/log/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/rnpkeys/tui.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/tests/CMakeLists.txt">third_party/rnp/src/tests/CMakeLists.txt</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/tests/CMakeLists.txt">file</a> |
<a href="/comm-central/annotate/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/tests/CMakeLists.txt">annotate</a> |
<a href="/comm-central/diff/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/tests/CMakeLists.txt">diff</a> |
<a href="/comm-central/comparison/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/tests/CMakeLists.txt">comparison</a> |
<a href="/comm-central/log/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/tests/CMakeLists.txt">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/tests/data/test_messages/message.txt.enc-3key-2p">third_party/rnp/src/tests/data/test_messages/message.txt.enc-3key-2p</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/tests/data/test_messages/message.txt.enc-3key-2p">file</a> |
<a href="/comm-central/annotate/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/tests/data/test_messages/message.txt.enc-3key-2p">annotate</a> |
<a href="/comm-central/diff/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/tests/data/test_messages/message.txt.enc-3key-2p">diff</a> |
<a href="/comm-central/comparison/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/tests/data/test_messages/message.txt.enc-3key-2p">comparison</a> |
<a href="/comm-central/log/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/tests/data/test_messages/message.txt.enc-3key-2p">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/tests/data/test_messages/message.txt.enc-aead-eax">third_party/rnp/src/tests/data/test_messages/message.txt.enc-aead-eax</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/tests/data/test_messages/message.txt.enc-aead-eax">file</a> |
<a href="/comm-central/annotate/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/tests/data/test_messages/message.txt.enc-aead-eax">annotate</a> |
<a href="/comm-central/diff/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/tests/data/test_messages/message.txt.enc-aead-eax">diff</a> |
<a href="/comm-central/comparison/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/tests/data/test_messages/message.txt.enc-aead-eax">comparison</a> |
<a href="/comm-central/log/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/tests/data/test_messages/message.txt.enc-aead-eax">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/tests/data/test_messages/message.txt.enc-aead-eax-malf">third_party/rnp/src/tests/data/test_messages/message.txt.enc-aead-eax-malf</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/tests/data/test_messages/message.txt.enc-aead-eax-malf">file</a> |
<a href="/comm-central/annotate/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/tests/data/test_messages/message.txt.enc-aead-eax-malf">annotate</a> |
<a href="/comm-central/diff/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/tests/data/test_messages/message.txt.enc-aead-eax-malf">diff</a> |
<a href="/comm-central/comparison/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/tests/data/test_messages/message.txt.enc-aead-eax-malf">comparison</a> |
<a href="/comm-central/log/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/tests/data/test_messages/message.txt.enc-aead-eax-malf">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/tests/data/test_messages/message.txt.enc-aead-ocb">third_party/rnp/src/tests/data/test_messages/message.txt.enc-aead-ocb</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/tests/data/test_messages/message.txt.enc-aead-ocb">file</a> |
<a href="/comm-central/annotate/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/tests/data/test_messages/message.txt.enc-aead-ocb">annotate</a> |
<a href="/comm-central/diff/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/tests/data/test_messages/message.txt.enc-aead-ocb">diff</a> |
<a href="/comm-central/comparison/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/tests/data/test_messages/message.txt.enc-aead-ocb">comparison</a> |
<a href="/comm-central/log/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/tests/data/test_messages/message.txt.enc-aead-ocb">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/tests/data/test_messages/message.txt.enc-aead-ocb-malf">third_party/rnp/src/tests/data/test_messages/message.txt.enc-aead-ocb-malf</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/tests/data/test_messages/message.txt.enc-aead-ocb-malf">file</a> |
<a href="/comm-central/annotate/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/tests/data/test_messages/message.txt.enc-aead-ocb-malf">annotate</a> |
<a href="/comm-central/diff/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/tests/data/test_messages/message.txt.enc-aead-ocb-malf">diff</a> |
<a href="/comm-central/comparison/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/tests/data/test_messages/message.txt.enc-aead-ocb-malf">comparison</a> |
<a href="/comm-central/log/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/tests/data/test_messages/message.txt.enc-aead-ocb-malf">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/tests/data/test_messages/message.txt.enc-mdc">third_party/rnp/src/tests/data/test_messages/message.txt.enc-mdc</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/tests/data/test_messages/message.txt.enc-mdc">file</a> |
<a href="/comm-central/annotate/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/tests/data/test_messages/message.txt.enc-mdc">annotate</a> |
<a href="/comm-central/diff/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/tests/data/test_messages/message.txt.enc-mdc">diff</a> |
<a href="/comm-central/comparison/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/tests/data/test_messages/message.txt.enc-mdc">comparison</a> |
<a href="/comm-central/log/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/tests/data/test_messages/message.txt.enc-mdc">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/tests/data/test_messages/message.txt.enc-no-mdc">third_party/rnp/src/tests/data/test_messages/message.txt.enc-no-mdc</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/tests/data/test_messages/message.txt.enc-no-mdc">file</a> |
<a href="/comm-central/annotate/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/tests/data/test_messages/message.txt.enc-no-mdc">annotate</a> |
<a href="/comm-central/diff/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/tests/data/test_messages/message.txt.enc-no-mdc">diff</a> |
<a href="/comm-central/comparison/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/tests/data/test_messages/message.txt.enc-no-mdc">comparison</a> |
<a href="/comm-central/log/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/tests/data/test_messages/message.txt.enc-no-mdc">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/tests/ffi.cpp">third_party/rnp/src/tests/ffi.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/tests/ffi.cpp">file</a> |
<a href="/comm-central/annotate/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/tests/ffi.cpp">annotate</a> |
<a href="/comm-central/diff/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/tests/ffi.cpp">diff</a> |
<a href="/comm-central/comparison/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/tests/ffi.cpp">comparison</a> |
<a href="/comm-central/log/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/tests/ffi.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/tests/issues/1171.cpp">third_party/rnp/src/tests/issues/1171.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/tests/issues/1171.cpp">file</a> |
<a href="/comm-central/annotate/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/tests/issues/1171.cpp">annotate</a> |
<a href="/comm-central/diff/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/tests/issues/1171.cpp">diff</a> |
<a href="/comm-central/comparison/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/tests/issues/1171.cpp">comparison</a> |
<a href="/comm-central/log/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/tests/issues/1171.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/tests/rnp_tests.h">third_party/rnp/src/tests/rnp_tests.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/tests/rnp_tests.h">file</a> |
<a href="/comm-central/annotate/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/tests/rnp_tests.h">annotate</a> |
<a href="/comm-central/diff/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/tests/rnp_tests.h">diff</a> |
<a href="/comm-central/comparison/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/tests/rnp_tests.h">comparison</a> |
<a href="/comm-central/log/b6d81f685df438f37780c53f8ed8af8a7294785c/third_party/rnp/src/tests/rnp_tests.h">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/third_party/README.rnp</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/third_party/README.rnp</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -1,12 +1,12 @@</span>
<a href="#l1.4"></a><span id="l1.4"> Directory ./rnp contains a copy of rnp which has been obtained from:</span>
<a href="#l1.5"></a><span id="l1.5"> https://github.com/rnpgp/rnp</span>
<a href="#l1.6"></a><span id="l1.6"> </span>
<a href="#l1.7"></a><span id="l1.7" class="difflineminus">-[commit b9335cee8cb346b567b8bfdb93e851618c6deb4a]</span>
<a href="#l1.8"></a><span id="l1.8" class="difflineplus">+[commit ac07057820ece92ddab52536f4a78d7d5bb71ba7]</span>
<a href="#l1.9"></a><span id="l1.9"> </span>
<a href="#l1.10"></a><span id="l1.10"> For licensing information, please refer to the included documentation.</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12"> To update this copy, run &quot;update_rnp.sh&quot; in this directory from this directory</span>
<a href="#l1.13"></a><span id="l1.13"> within a complete build tree (including mozilla-central) as &quot;mach python&quot; is</span>
<a href="#l1.14"></a><span id="l1.14"> used.</span>
<a href="#l1.15"></a><span id="l1.15"> </span>
<a href="#l1.16"></a><span id="l1.16"> update_rnp.sh will generate rnp/src/lib/version.h from rnp/src/lib/version.h.in</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/third_party/rnp/include/rekey/rnp_key_store.h</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/third_party/rnp/include/rekey/rnp_key_store.h</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -201,17 +201,17 @@ pgp_sig_import_status_t rnp_key_store_im</span>
<a href="#l2.4"></a><span id="l2.4">  * @param sig signature to import.</span>
<a href="#l2.5"></a><span id="l2.5">  * @param status signature import status will be put here, if not NULL.</span>
<a href="#l2.6"></a><span id="l2.6">  * @return pointer to the key to which this signature belongs (or NULL if key was not found)</span>
<a href="#l2.7"></a><span id="l2.7">  */</span>
<a href="#l2.8"></a><span id="l2.8"> pgp_key_t *rnp_key_store_import_signature(rnp_key_store_t *        keyring,</span>
<a href="#l2.9"></a><span id="l2.9">                                           const pgp_signature_t *  sig,</span>
<a href="#l2.10"></a><span id="l2.10">                                           pgp_sig_import_status_t *status);</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-bool rnp_key_store_remove_key(rnp_key_store_t *, const pgp_key_t *);</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+bool rnp_key_store_remove_key(rnp_key_store_t *, const pgp_key_t *, bool);</span>
<a href="#l2.14"></a><span id="l2.14"> </span>
<a href="#l2.15"></a><span id="l2.15"> pgp_key_t *rnp_key_store_get_key_by_id(rnp_key_store_t *, const unsigned char *, pgp_key_t *);</span>
<a href="#l2.16"></a><span id="l2.16"> </span>
<a href="#l2.17"></a><span id="l2.17"> bool rnp_key_store_get_key_grip(const pgp_key_material_t *, pgp_key_grip_t &amp;grip);</span>
<a href="#l2.18"></a><span id="l2.18"> </span>
<a href="#l2.19"></a><span id="l2.19"> const pgp_key_t *rnp_key_store_get_key_by_grip(const rnp_key_store_t *,</span>
<a href="#l2.20"></a><span id="l2.20">                                                const pgp_key_grip_t &amp;);</span>
<a href="#l2.21"></a><span id="l2.21"> pgp_key_t *      rnp_key_store_get_key_by_grip(rnp_key_store_t *, const pgp_key_grip_t &amp;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/third_party/rnp/include/rnp/rnp.h</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/third_party/rnp/include/rnp/rnp.h</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -41,16 +41,17 @@ typedef uint32_t rnp_result_t;</span>
<a href="#l3.4"></a><span id="l3.4"> </span>
<a href="#l3.5"></a><span id="l3.5"> #define RNP_KEY_EXPORT_ARMORED (1U &lt;&lt; 0)</span>
<a href="#l3.6"></a><span id="l3.6"> #define RNP_KEY_EXPORT_PUBLIC (1U &lt;&lt; 1)</span>
<a href="#l3.7"></a><span id="l3.7"> #define RNP_KEY_EXPORT_SECRET (1U &lt;&lt; 2)</span>
<a href="#l3.8"></a><span id="l3.8"> #define RNP_KEY_EXPORT_SUBKEYS (1U &lt;&lt; 3)</span>
<a href="#l3.9"></a><span id="l3.9"> </span>
<a href="#l3.10"></a><span id="l3.10"> #define RNP_KEY_REMOVE_PUBLIC (1U &lt;&lt; 0)</span>
<a href="#l3.11"></a><span id="l3.11"> #define RNP_KEY_REMOVE_SECRET (1U &lt;&lt; 1)</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+#define RNP_KEY_REMOVE_SUBKEYS (1U &lt;&lt; 2)</span>
<a href="#l3.13"></a><span id="l3.13"> </span>
<a href="#l3.14"></a><span id="l3.14"> #define RNP_KEY_UNLOAD_PUBLIC (1U &lt;&lt; 0)</span>
<a href="#l3.15"></a><span id="l3.15"> #define RNP_KEY_UNLOAD_SECRET (1U &lt;&lt; 1)</span>
<a href="#l3.16"></a><span id="l3.16"> </span>
<a href="#l3.17"></a><span id="l3.17"> /**</span>
<a href="#l3.18"></a><span id="l3.18">  * Flags for optional details to include in JSON.</span>
<a href="#l3.19"></a><span id="l3.19">  */</span>
<a href="#l3.20"></a><span id="l3.20"> #define RNP_JSON_PUBLIC_MPIS (1U &lt;&lt; 0)</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineat">@@ -165,16 +166,18 @@ typedef struct rnp_op_generate_st *     </span>
<a href="#l3.22"></a><span id="l3.22"> typedef struct rnp_op_sign_st *            rnp_op_sign_t;</span>
<a href="#l3.23"></a><span id="l3.23"> typedef struct rnp_op_sign_signature_st *  rnp_op_sign_signature_t;</span>
<a href="#l3.24"></a><span id="l3.24"> typedef struct rnp_op_verify_st *          rnp_op_verify_t;</span>
<a href="#l3.25"></a><span id="l3.25"> typedef struct rnp_op_verify_signature_st *rnp_op_verify_signature_t;</span>
<a href="#l3.26"></a><span id="l3.26"> typedef struct rnp_op_encrypt_st *         rnp_op_encrypt_t;</span>
<a href="#l3.27"></a><span id="l3.27"> typedef struct rnp_identifier_iterator_st *rnp_identifier_iterator_t;</span>
<a href="#l3.28"></a><span id="l3.28"> typedef struct rnp_uid_handle_st *         rnp_uid_handle_t;</span>
<a href="#l3.29"></a><span id="l3.29"> typedef struct rnp_signature_handle_st *   rnp_signature_handle_t;</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+typedef struct rnp_recipient_handle_st *   rnp_recipient_handle_t;</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+typedef struct rnp_symenc_handle_st *      rnp_symenc_handle_t;</span>
<a href="#l3.32"></a><span id="l3.32"> </span>
<a href="#l3.33"></a><span id="l3.33"> /* Callbacks */</span>
<a href="#l3.34"></a><span id="l3.34"> /**</span>
<a href="#l3.35"></a><span id="l3.35">  * @brief Callback, used to read data from the source.</span>
<a href="#l3.36"></a><span id="l3.36">  *</span>
<a href="#l3.37"></a><span id="l3.37">  * @param app_ctx custom parameter, passed back to the function.</span>
<a href="#l3.38"></a><span id="l3.38">  * @param buf on successfull call data should be put here. Cannot be NULL,</span>
<a href="#l3.39"></a><span id="l3.39">  *            and must be capable to store at least len bytes.</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineat">@@ -879,17 +882,18 @@ rnp_result_t rnp_key_revoke(rnp_key_hand</span>
<a href="#l3.41"></a><span id="l3.41">                             const char *     hash,</span>
<a href="#l3.42"></a><span id="l3.42">                             const char *     code,</span>
<a href="#l3.43"></a><span id="l3.43">                             const char *     reason);</span>
<a href="#l3.44"></a><span id="l3.44"> </span>
<a href="#l3.45"></a><span id="l3.45"> /** remove a key from keyring(s)</span>
<a href="#l3.46"></a><span id="l3.46">  *  Note: you need to call rnp_save_keys() to write updated keyring(s) out.</span>
<a href="#l3.47"></a><span id="l3.47">  *        Other handles of the same key should not be used after this call.</span>
<a href="#l3.48"></a><span id="l3.48">  * @param key pointer to the key handle.</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineminus">- * @param flags see RNP_KEY_REMOVE_* constants.</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+ * @param flags see RNP_KEY_REMOVE_* constants. Flag RNP_REMOVE_SUBKEYS will work only for</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+ *              primary key, and remove all of it's subkeys as well.</span>
<a href="#l3.52"></a><span id="l3.52">  * @return RNP_SUCCESS or error code if failed.</span>
<a href="#l3.53"></a><span id="l3.53">  */</span>
<a href="#l3.54"></a><span id="l3.54"> rnp_result_t rnp_key_remove(rnp_key_handle_t key, uint32_t flags);</span>
<a href="#l3.55"></a><span id="l3.55"> </span>
<a href="#l3.56"></a><span id="l3.56"> /** guess contents of the OpenPGP data stream.</span>
<a href="#l3.57"></a><span id="l3.57">  *</span>
<a href="#l3.58"></a><span id="l3.58">  * @param input stream with data. Must be opened and cannot be NULL.</span>
<a href="#l3.59"></a><span id="l3.59">  * @param contents string with guessed data format will be stored here.</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineat">@@ -1635,16 +1639,183 @@ rnp_result_t rnp_op_verify_get_signature</span>
<a href="#l3.61"></a><span id="l3.61">  *  @param filename pointer to the filename. On success caller is responsible for freeing it</span>
<a href="#l3.62"></a><span id="l3.62">  *                  via the rnp_buffer_free function call. May be NULL if this information is</span>
<a href="#l3.63"></a><span id="l3.63">  *                  not needed.</span>
<a href="#l3.64"></a><span id="l3.64">  *  @param mtime file modification time will be stored here on success. May be NULL.</span>
<a href="#l3.65"></a><span id="l3.65">  *  @return RNP_SUCCESS if call succeeded.</span>
<a href="#l3.66"></a><span id="l3.66">  */</span>
<a href="#l3.67"></a><span id="l3.67"> rnp_result_t rnp_op_verify_get_file_info(rnp_op_verify_t op, char **filename, uint32_t *mtime);</span>
<a href="#l3.68"></a><span id="l3.68"> </span>
<a href="#l3.69"></a><span id="l3.69" class="difflineplus">+/**</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineplus">+ * @brief Get data protection (encryption) mode, used in processed message.</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineplus">+ *</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineplus">+ * @param op opaque verification context. Must be initialized and have execute() called on it.</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineplus">+ * @param mode on success string with mode will be stored here. Caller is responsible for</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineplus">+ *             freeing it using the rnp_buffer_free() call. May be NULL if information is not</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineplus">+ * needed. Currently defined values are as following:</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineplus">+ *             - none : message was not protected/encrypted</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineplus">+ *             - cfb : message was encrypted in CFB mode without the MDC</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineplus">+ *             - cfb-mdc : message was encrypted in CFB mode and protected with MDC</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineplus">+ *             - aead-ocb : message was encrypted in AEAD-OCB mode</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineplus">+ *             - aead-eax : message was encrypted in AEAD-EAX mode</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineplus">+ * @param cipher symmetric cipher, used for data encryption. May be NULL if information is not</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineplus">+ *               needed. Must be freed by rnp_buffer_free() call.</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineplus">+ * @param valid true if message integrity protection was used (i.e. MDC or AEAD), and it was</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineplus">+ *              validated successfully. Otherwise (even for raw cfb mode) will be false. May be</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineplus">+ *              NULL if information is not needed.</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineplus">+ * @return RNP_SUCCESS if call succeeded, or error code otherwise.</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineplus">+ */</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineplus">+rnp_result_t rnp_op_verify_get_protection_info(rnp_op_verify_t op,</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineplus">+                                               char **         mode,</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineplus">+                                               char **         cipher,</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineplus">+                                               bool *          valid);</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineplus">+</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineplus">+/**</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineplus">+ * @brief Get number of public keys (recipients) to whom message was encrypted to.</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineplus">+ *</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineplus">+ * @param op opaque verification context. Must be initialized and have execute() called on it.</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineplus">+ * @param count on success number of keys will be stored here. Cannot be NULL.</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineplus">+ * @return RNP_SUCCESS if call succeeded, or error code otherwise.</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineplus">+ */</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineplus">+rnp_result_t rnp_op_verify_get_recipient_count(rnp_op_verify_t op, size_t *count);</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineplus">+</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineplus">+/**</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineplus">+ * @brief Get the recipient's handle, used to decrypt message.</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineplus">+ *</span>
<a href="#l3.105"></a><span id="l3.105" class="difflineplus">+ * @param op opaque verification context. Must be initialized and have execute() called on it.</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineplus">+ * @param recipient pointer to the opaque handle context. Cannot be NULL. If recipient's key</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineplus">+ *                  was used to decrypt a message then handle will be stored here, otherwise</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineplus">+ *                  it will be set to NULL.</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineplus">+ * @return RNP_SUCCESS if call succeeded, or error code otherwise.</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineplus">+ */</span>
<a href="#l3.111"></a><span id="l3.111" class="difflineplus">+rnp_result_t rnp_op_verify_get_used_recipient(rnp_op_verify_t         op,</span>
<a href="#l3.112"></a><span id="l3.112" class="difflineplus">+                                              rnp_recipient_handle_t *recipient);</span>
<a href="#l3.113"></a><span id="l3.113" class="difflineplus">+</span>
<a href="#l3.114"></a><span id="l3.114" class="difflineplus">+/**</span>
<a href="#l3.115"></a><span id="l3.115" class="difflineplus">+ * @brief Get the recipient's handle by index.</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineplus">+ *</span>
<a href="#l3.117"></a><span id="l3.117" class="difflineplus">+ * @param op opaque verification context. Must be initialized and have execute() called on it.</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineplus">+ * @param idx zero-based index in array.</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineplus">+ * @param recipient pointer to the opaque handle context. Cannot be NULL. On success handle</span>
<a href="#l3.120"></a><span id="l3.120" class="difflineplus">+ *                  will be stored here.</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineplus">+ * @return RNP_SUCCESS if call succeeded, or error code otherwise.</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineplus">+ */</span>
<a href="#l3.123"></a><span id="l3.123" class="difflineplus">+rnp_result_t rnp_op_verify_get_recipient_at(rnp_op_verify_t         op,</span>
<a href="#l3.124"></a><span id="l3.124" class="difflineplus">+                                            size_t                  idx,</span>
<a href="#l3.125"></a><span id="l3.125" class="difflineplus">+                                            rnp_recipient_handle_t *recipient);</span>
<a href="#l3.126"></a><span id="l3.126" class="difflineplus">+</span>
<a href="#l3.127"></a><span id="l3.127" class="difflineplus">+/**</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineplus">+ * @brief Get recipient's keyid.</span>
<a href="#l3.129"></a><span id="l3.129" class="difflineplus">+ *</span>
<a href="#l3.130"></a><span id="l3.130" class="difflineplus">+ * @param recipient recipient's handle, obtained via rnp_op_verify_get_used_recipient() or</span>
<a href="#l3.131"></a><span id="l3.131" class="difflineplus">+ *                  rnp_op_verify_get_recipient_at() function call. Cannot be NULL.</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineplus">+ * @param keyid on success pointer to NULL-terminated string with hex-encoded keyid will be</span>
<a href="#l3.133"></a><span id="l3.133" class="difflineplus">+ *              stored here. Cannot be NULL. Must be freed using the rnp_buffer_destroy().</span>
<a href="#l3.134"></a><span id="l3.134" class="difflineplus">+ * @return RNP_SUCCESS if call succeeded, or error code otherwise.</span>
<a href="#l3.135"></a><span id="l3.135" class="difflineplus">+ */</span>
<a href="#l3.136"></a><span id="l3.136" class="difflineplus">+rnp_result_t rnp_recipient_get_keyid(rnp_recipient_handle_t recipient, char **keyid);</span>
<a href="#l3.137"></a><span id="l3.137" class="difflineplus">+</span>
<a href="#l3.138"></a><span id="l3.138" class="difflineplus">+/**</span>
<a href="#l3.139"></a><span id="l3.139" class="difflineplus">+ * @brief Get recipient's key algorithm.</span>
<a href="#l3.140"></a><span id="l3.140" class="difflineplus">+ *</span>
<a href="#l3.141"></a><span id="l3.141" class="difflineplus">+ * @param recipient recipient's handle, obtained via rnp_op_verify_get_used_recipient() or</span>
<a href="#l3.142"></a><span id="l3.142" class="difflineplus">+ *                  rnp_op_verify_get_recipient_at() function call. Cannot be NULL.</span>
<a href="#l3.143"></a><span id="l3.143" class="difflineplus">+ * @param alg on success pointer to NULL-terminated string with algorithm will be stored here.</span>
<a href="#l3.144"></a><span id="l3.144" class="difflineplus">+ *            Cannot be NULL. Must be freed using the rnp_buffer_destroy().</span>
<a href="#l3.145"></a><span id="l3.145" class="difflineplus">+ * @return RNP_SUCCESS if call succeeded, or error code otherwise.</span>
<a href="#l3.146"></a><span id="l3.146" class="difflineplus">+ */</span>
<a href="#l3.147"></a><span id="l3.147" class="difflineplus">+rnp_result_t rnp_recipient_get_alg(rnp_recipient_handle_t recipient, char **alg);</span>
<a href="#l3.148"></a><span id="l3.148" class="difflineplus">+</span>
<a href="#l3.149"></a><span id="l3.149" class="difflineplus">+/**</span>
<a href="#l3.150"></a><span id="l3.150" class="difflineplus">+ * @brief Get number of symenc entries (i.e. passwords), to which message was encrypted.</span>
<a href="#l3.151"></a><span id="l3.151" class="difflineplus">+ *</span>
<a href="#l3.152"></a><span id="l3.152" class="difflineplus">+ * @param op opaque verification context. Must be initialized and have execute() called on it.</span>
<a href="#l3.153"></a><span id="l3.153" class="difflineplus">+ * @param count on success number of keys will be stored here. Cannot be NULL.</span>
<a href="#l3.154"></a><span id="l3.154" class="difflineplus">+ * @return RNP_SUCCESS if call succeeded, or error code otherwise.</span>
<a href="#l3.155"></a><span id="l3.155" class="difflineplus">+ */</span>
<a href="#l3.156"></a><span id="l3.156" class="difflineplus">+rnp_result_t rnp_op_verify_get_symenc_count(rnp_op_verify_t op, size_t *count);</span>
<a href="#l3.157"></a><span id="l3.157" class="difflineplus">+</span>
<a href="#l3.158"></a><span id="l3.158" class="difflineplus">+/**</span>
<a href="#l3.159"></a><span id="l3.159" class="difflineplus">+ * @brief Get the symenc handle, used to decrypt a message.</span>
<a href="#l3.160"></a><span id="l3.160" class="difflineplus">+ *</span>
<a href="#l3.161"></a><span id="l3.161" class="difflineplus">+ * @param op opaque verification context. Must be initialized and have execute() called on it.</span>
<a href="#l3.162"></a><span id="l3.162" class="difflineplus">+ * @param symenc pointer to the opaque symenc context. Cannot be NULL. If password was used to</span>
<a href="#l3.163"></a><span id="l3.163" class="difflineplus">+ *               decrypt a message then handle will be stored here, otherwise it will be set to</span>
<a href="#l3.164"></a><span id="l3.164" class="difflineplus">+ *               NULL.</span>
<a href="#l3.165"></a><span id="l3.165" class="difflineplus">+ * @return RNP_SUCCESS if call succeeded, or error code otherwise.</span>
<a href="#l3.166"></a><span id="l3.166" class="difflineplus">+ */</span>
<a href="#l3.167"></a><span id="l3.167" class="difflineplus">+rnp_result_t rnp_op_verify_get_used_symenc(rnp_op_verify_t op, rnp_symenc_handle_t *symenc);</span>
<a href="#l3.168"></a><span id="l3.168" class="difflineplus">+</span>
<a href="#l3.169"></a><span id="l3.169" class="difflineplus">+/**</span>
<a href="#l3.170"></a><span id="l3.170" class="difflineplus">+ * @brief Get the symenc handle by index.</span>
<a href="#l3.171"></a><span id="l3.171" class="difflineplus">+ *</span>
<a href="#l3.172"></a><span id="l3.172" class="difflineplus">+ * @param op opaque verification context. Must be initialized and have execute() called on it.</span>
<a href="#l3.173"></a><span id="l3.173" class="difflineplus">+ * @param idx zero-based index in array.</span>
<a href="#l3.174"></a><span id="l3.174" class="difflineplus">+ * @param symenc pointer to the opaque handle context. Cannot be NULL. On success handle</span>
<a href="#l3.175"></a><span id="l3.175" class="difflineplus">+ *               will be stored here.</span>
<a href="#l3.176"></a><span id="l3.176" class="difflineplus">+ * @return RNP_SUCCESS if call succeeded, or error code otherwise.</span>
<a href="#l3.177"></a><span id="l3.177" class="difflineplus">+ */</span>
<a href="#l3.178"></a><span id="l3.178" class="difflineplus">+rnp_result_t rnp_op_verify_get_symenc_at(rnp_op_verify_t      op,</span>
<a href="#l3.179"></a><span id="l3.179" class="difflineplus">+                                         size_t               idx,</span>
<a href="#l3.180"></a><span id="l3.180" class="difflineplus">+                                         rnp_symenc_handle_t *symenc);</span>
<a href="#l3.181"></a><span id="l3.181" class="difflineplus">+</span>
<a href="#l3.182"></a><span id="l3.182" class="difflineplus">+/**</span>
<a href="#l3.183"></a><span id="l3.183" class="difflineplus">+ * @brief Get the symmetric cipher, used to encrypt data encryption key.</span>
<a href="#l3.184"></a><span id="l3.184" class="difflineplus">+ *        Note: if message is encrypted with only one passphrase and without public keys, then</span>
<a href="#l3.185"></a><span id="l3.185" class="difflineplus">+ *        key, derived from password, may be used to encrypt the whole message.</span>
<a href="#l3.186"></a><span id="l3.186" class="difflineplus">+ * @param symenc opaque handle, cannot be NULL.</span>
<a href="#l3.187"></a><span id="l3.187" class="difflineplus">+ * @param cipher NULL-terminated string with cipher's name will be stored here. Cannot be NULL.</span>
<a href="#l3.188"></a><span id="l3.188" class="difflineplus">+ *               Must be freed using the rnp_buffer_destroy().</span>
<a href="#l3.189"></a><span id="l3.189" class="difflineplus">+ * @return RNP_SUCCESS if call succeeded, or error code otherwise.</span>
<a href="#l3.190"></a><span id="l3.190" class="difflineplus">+ */</span>
<a href="#l3.191"></a><span id="l3.191" class="difflineplus">+rnp_result_t rnp_symenc_get_cipher(rnp_symenc_handle_t symenc, char **cipher);</span>
<a href="#l3.192"></a><span id="l3.192" class="difflineplus">+</span>
<a href="#l3.193"></a><span id="l3.193" class="difflineplus">+/**</span>
<a href="#l3.194"></a><span id="l3.194" class="difflineplus">+ * @brief Get AEAD algorithm if it was used to encrypt data encryption key.</span>
<a href="#l3.195"></a><span id="l3.195" class="difflineplus">+ *</span>
<a href="#l3.196"></a><span id="l3.196" class="difflineplus">+ * @param symenc opaque handle, cannot be NULL.</span>
<a href="#l3.197"></a><span id="l3.197" class="difflineplus">+ * @param alg NULL-terminated string with AEAD algorithm name will be stored here. If AEAD was</span>
<a href="#l3.198"></a><span id="l3.198" class="difflineplus">+ *            not used then it will contain string 'None'. Must be freed using the</span>
<a href="#l3.199"></a><span id="l3.199" class="difflineplus">+ *            rnp_buffer_destroy().</span>
<a href="#l3.200"></a><span id="l3.200" class="difflineplus">+ * @return RNP_SUCCESS if call succeeded, or error code otherwise.</span>
<a href="#l3.201"></a><span id="l3.201" class="difflineplus">+ */</span>
<a href="#l3.202"></a><span id="l3.202" class="difflineplus">+rnp_result_t rnp_symenc_get_aead_alg(rnp_symenc_handle_t symenc, char **alg);</span>
<a href="#l3.203"></a><span id="l3.203" class="difflineplus">+</span>
<a href="#l3.204"></a><span id="l3.204" class="difflineplus">+/**</span>
<a href="#l3.205"></a><span id="l3.205" class="difflineplus">+ * @brief Get hash algorithm, used to derive key from the passphrase.</span>
<a href="#l3.206"></a><span id="l3.206" class="difflineplus">+ *</span>
<a href="#l3.207"></a><span id="l3.207" class="difflineplus">+ * @param symenc opaque handle, cannot be NULL.</span>
<a href="#l3.208"></a><span id="l3.208" class="difflineplus">+ * @param alg NULL-terminated string with hash algorithm name will be stored here. Cannot be</span>
<a href="#l3.209"></a><span id="l3.209" class="difflineplus">+ *            NULL. Must be freed using the rnp_buffer_destroy().</span>
<a href="#l3.210"></a><span id="l3.210" class="difflineplus">+ * @return RNP_SUCCESS if call succeeded, or error code otherwise.</span>
<a href="#l3.211"></a><span id="l3.211" class="difflineplus">+ */</span>
<a href="#l3.212"></a><span id="l3.212" class="difflineplus">+rnp_result_t rnp_symenc_get_hash_alg(rnp_symenc_handle_t symenc, char **alg);</span>
<a href="#l3.213"></a><span id="l3.213" class="difflineplus">+</span>
<a href="#l3.214"></a><span id="l3.214" class="difflineplus">+/**</span>
<a href="#l3.215"></a><span id="l3.215" class="difflineplus">+ * @brief Get string-to-key type, used to derive password.</span>
<a href="#l3.216"></a><span id="l3.216" class="difflineplus">+ *</span>
<a href="#l3.217"></a><span id="l3.217" class="difflineplus">+ * @param symenc opaque handle, cannot be NULL.</span>
<a href="#l3.218"></a><span id="l3.218" class="difflineplus">+ * @param type NULL-terminated string with s2k type will be stored here. Currently following</span>
<a href="#l3.219"></a><span id="l3.219" class="difflineplus">+ *             types are available: 'Simple', 'Salted', 'Iterated and salted'. Please note that</span>
<a href="#l3.220"></a><span id="l3.220" class="difflineplus">+ *             first two are considered weak and should not be used. Must be freed using the</span>
<a href="#l3.221"></a><span id="l3.221" class="difflineplus">+ *             rnp_buffer_destroy().</span>
<a href="#l3.222"></a><span id="l3.222" class="difflineplus">+ * @return RNP_SUCCESS if call succeeded, or error code otherwise.</span>
<a href="#l3.223"></a><span id="l3.223" class="difflineplus">+ */</span>
<a href="#l3.224"></a><span id="l3.224" class="difflineplus">+rnp_result_t rnp_symenc_get_s2k_type(rnp_symenc_handle_t symenc, char **type);</span>
<a href="#l3.225"></a><span id="l3.225" class="difflineplus">+</span>
<a href="#l3.226"></a><span id="l3.226" class="difflineplus">+/**</span>
<a href="#l3.227"></a><span id="l3.227" class="difflineplus">+ * @brief Get number of iterations in iterated-and-salted S2K, if it was used.</span>
<a href="#l3.228"></a><span id="l3.228" class="difflineplus">+ *</span>
<a href="#l3.229"></a><span id="l3.229" class="difflineplus">+ * @param symenc opaque handle, cannot be NULL.</span>
<a href="#l3.230"></a><span id="l3.230" class="difflineplus">+ * @param iterations on success number of iterations will be stored here. Cannot be NULL.</span>
<a href="#l3.231"></a><span id="l3.231" class="difflineplus">+ *                   If non-iterated s2k was used then will be set to 0.</span>
<a href="#l3.232"></a><span id="l3.232" class="difflineplus">+ * @return RNP_SUCCESS if call succeeded, or error code otherwise.</span>
<a href="#l3.233"></a><span id="l3.233" class="difflineplus">+ */</span>
<a href="#l3.234"></a><span id="l3.234" class="difflineplus">+rnp_result_t rnp_symenc_get_s2k_iterations(rnp_symenc_handle_t symenc, uint32_t *iterations);</span>
<a href="#l3.235"></a><span id="l3.235" class="difflineplus">+</span>
<a href="#l3.236"></a><span id="l3.236"> /** @brief Free resources allocated in verification context.</span>
<a href="#l3.237"></a><span id="l3.237">  *  @param op opaque verification context. Must be initialized.</span>
<a href="#l3.238"></a><span id="l3.238">  *  @return RNP_SUCCESS if call succeeded.</span>
<a href="#l3.239"></a><span id="l3.239">  */</span>
<a href="#l3.240"></a><span id="l3.240"> rnp_result_t rnp_op_verify_destroy(rnp_op_verify_t op);</span>
<a href="#l3.241"></a><span id="l3.241"> </span>
<a href="#l3.242"></a><span id="l3.242"> /** @brief Get signature verification status.</span>
<a href="#l3.243"></a><span id="l3.243">  *  @param sig opaque signature context obtained via rnp_op_verify_get_signature_at call.</span>
<a href="#l3.244"></a><span id="l3.244" class="difflineat">@@ -2096,18 +2267,16 @@ rnp_result_t rnp_identifier_iterator_nex</span>
<a href="#l3.245"></a><span id="l3.245">  *  @param it the iterator object</span>
<a href="#l3.246"></a><span id="l3.246">  *  @return RNP_SUCCESS on success, or any other value on error</span>
<a href="#l3.247"></a><span id="l3.247">  */</span>
<a href="#l3.248"></a><span id="l3.248"> rnp_result_t rnp_identifier_iterator_destroy(rnp_identifier_iterator_t it);</span>
<a href="#l3.249"></a><span id="l3.249"> </span>
<a href="#l3.250"></a><span id="l3.250"> #if defined(__cplusplus)</span>
<a href="#l3.251"></a><span id="l3.251"> }</span>
<a href="#l3.252"></a><span id="l3.252"> </span>
<a href="#l3.253"></a><span id="l3.253" class="difflineminus">-#include &quot;utils.h&quot;</span>
<a href="#l3.254"></a><span id="l3.254" class="difflineminus">-</span>
<a href="#l3.255"></a><span id="l3.255"> #endif</span>
<a href="#l3.256"></a><span id="l3.256"> </span>
<a href="#l3.257"></a><span id="l3.257"> /** Algorithm Strings</span>
<a href="#l3.258"></a><span id="l3.258">  */</span>
<a href="#l3.259"></a><span id="l3.259"> #ifndef RNP_ALGNAME_PLAINTEXT</span>
<a href="#l3.260"></a><span id="l3.260"> </span>
<a href="#l3.261"></a><span id="l3.261"> #define RNP_ALGNAME_PLAINTEXT &quot;PLAINTEXT&quot;</span>
<a href="#l3.262"></a><span id="l3.262"> #define RNP_ALGNAME_RSA &quot;RSA&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/third_party/rnp/src/examples/sign.c</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/third_party/rnp/src/examples/sign.c</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -20,17 +20,16 @@</span>
<a href="#l4.4"></a><span id="l4.4">  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR</span>
<a href="#l4.5"></a><span id="l4.5">  * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER</span>
<a href="#l4.6"></a><span id="l4.6">  * CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,</span>
<a href="#l4.7"></a><span id="l4.7">  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF</span>
<a href="#l4.8"></a><span id="l4.8">  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<a href="#l4.9"></a><span id="l4.9">  */</span>
<a href="#l4.10"></a><span id="l4.10"> </span>
<a href="#l4.11"></a><span id="l4.11"> #include &lt;rnp/rnp.h&gt;</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-#include &lt;repgp/repgp_def.h&gt;</span>
<a href="#l4.13"></a><span id="l4.13"> #include &lt;string.h&gt;</span>
<a href="#l4.14"></a><span id="l4.14"> #include &lt;time.h&gt;</span>
<a href="#l4.15"></a><span id="l4.15"> </span>
<a href="#l4.16"></a><span id="l4.16"> #define RNP_SUCCESS 0</span>
<a href="#l4.17"></a><span id="l4.17"> </span>
<a href="#l4.18"></a><span id="l4.18"> /* sample pass provider implementation, which always return 'password' */</span>
<a href="#l4.19"></a><span id="l4.19"> static bool</span>
<a href="#l4.20"></a><span id="l4.20"> example_pass_provider(rnp_ffi_t        ffi,</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineat">@@ -161,9 +160,9 @@ finish:</span>
<a href="#l4.22"></a><span id="l4.22">     rnp_ffi_destroy(ffi);</span>
<a href="#l4.23"></a><span id="l4.23">     return result;</span>
<a href="#l4.24"></a><span id="l4.24"> }</span>
<a href="#l4.25"></a><span id="l4.25"> </span>
<a href="#l4.26"></a><span id="l4.26"> int</span>
<a href="#l4.27"></a><span id="l4.27"> main(int argc, char **argv)</span>
<a href="#l4.28"></a><span id="l4.28"> {</span>
<a href="#l4.29"></a><span id="l4.29">     return ffi_sign();</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineminus">-}</span>
<a href="#l4.31"></a><span id="l4.31">\ No newline at end of file</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/third_party/rnp/src/lib/CMakeLists.txt</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/third_party/rnp/src/lib/CMakeLists.txt</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -201,27 +201,27 @@ endif()</span>
<a href="#l5.4"></a><span id="l5.4"> </span>
<a href="#l5.5"></a><span id="l5.5"> # install headers</span>
<a href="#l5.6"></a><span id="l5.6"> install(</span>
<a href="#l5.7"></a><span id="l5.7">   FILES</span>
<a href="#l5.8"></a><span id="l5.8">     &quot;${PROJECT_SOURCE_DIR}/include/rnp/rnp.h&quot;</span>
<a href="#l5.9"></a><span id="l5.9">   COMPONENT</span>
<a href="#l5.10"></a><span id="l5.10">     development</span>
<a href="#l5.11"></a><span id="l5.11">   DESTINATION</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-    &quot;${CMAKE_INSTALL_INCLUDEDIR}/${LIBRNP_INCLUDEDIR}&quot;</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+    &quot;${CMAKE_INSTALL_INCLUDEDIR}/${LIBRNP_INCLUDEDIR}/rnp&quot;</span>
<a href="#l5.14"></a><span id="l5.14">   RENAME</span>
<a href="#l5.15"></a><span id="l5.15">     rnp.h</span>
<a href="#l5.16"></a><span id="l5.16"> )</span>
<a href="#l5.17"></a><span id="l5.17"> install(</span>
<a href="#l5.18"></a><span id="l5.18">   FILES</span>
<a href="#l5.19"></a><span id="l5.19">     &quot;${PROJECT_SOURCE_DIR}/include/rnp/rnp_err.h&quot;</span>
<a href="#l5.20"></a><span id="l5.20">   COMPONENT</span>
<a href="#l5.21"></a><span id="l5.21">     development</span>
<a href="#l5.22"></a><span id="l5.22">   DESTINATION</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineminus">-    &quot;${CMAKE_INSTALL_INCLUDEDIR}/${LIBRNP_INCLUDEDIR}&quot;</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineplus">+    &quot;${CMAKE_INSTALL_INCLUDEDIR}/${LIBRNP_INCLUDEDIR}/rnp&quot;</span>
<a href="#l5.25"></a><span id="l5.25">   RENAME</span>
<a href="#l5.26"></a><span id="l5.26">     rnp_err.h</span>
<a href="#l5.27"></a><span id="l5.27"> )</span>
<a href="#l5.28"></a><span id="l5.28"> </span>
<a href="#l5.29"></a><span id="l5.29"> # .cmake installs</span>
<a href="#l5.30"></a><span id="l5.30"> set(INSTALL_CMAKEDIR &quot;${CMAKE_INSTALL_LIBDIR}/cmake/rnp&quot;)</span>
<a href="#l5.31"></a><span id="l5.31"> </span>
<a href="#l5.32"></a><span id="l5.32"> install(EXPORT rnp-targets</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineat">@@ -244,19 +244,64 @@ write_basic_package_version_file(rnp-con</span>
<a href="#l5.34"></a><span id="l5.34"> install (</span>
<a href="#l5.35"></a><span id="l5.35">   FILES</span>
<a href="#l5.36"></a><span id="l5.36">     &quot;${CMAKE_CURRENT_BINARY_DIR}/rnp-config.cmake&quot;</span>
<a href="#l5.37"></a><span id="l5.37">     &quot;${CMAKE_CURRENT_BINARY_DIR}/rnp-config-version.cmake&quot;</span>
<a href="#l5.38"></a><span id="l5.38">   DESTINATION &quot;${INSTALL_CMAKEDIR}&quot;</span>
<a href="#l5.39"></a><span id="l5.39">   COMPONENT development</span>
<a href="#l5.40"></a><span id="l5.40"> )</span>
<a href="#l5.41"></a><span id="l5.41"> </span>
<a href="#l5.42"></a><span id="l5.42" class="difflineplus">+function(get_linked_libs libsvar dirsvar tgt)</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineplus">+  get_target_property(imported ${tgt} IMPORTED)</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineplus">+  list(APPEND visited_targets ${tgt})</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineplus">+  if (imported)</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineplus">+    get_target_property(linkedlibs ${tgt} INTERFACE_LINK_LIBRARIES)</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineplus">+  else()</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineplus">+    get_target_property(linkedlibs ${tgt} LINK_LIBRARIES)</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineplus">+  endif()</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineplus">+  set(libs)</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineplus">+  foreach (lib ${linkedlibs})</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineplus">+    if (TARGET ${lib})</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineplus">+      list(FIND visited_targets ${lib} visited)</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineplus">+      if (${visited} EQUAL -1)</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineplus">+        # library</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineplus">+        get_target_property(liblocation ${lib} LOCATION)</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineplus">+        get_filename_component(linkedlib ${liblocation} NAME_WE)</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineplus">+        string(REGEX REPLACE &quot;^${CMAKE_SHARED_LIBRARY_PREFIX}&quot; &quot;&quot; linkedlib ${linkedlib})</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineplus">+        get_linked_libs(linkedlibs libdirs ${lib})</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineplus">+        list(APPEND libs ${linkedlib} ${linkedlibs})</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineplus">+        # directory</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineplus">+        get_filename_component(libdir ${liblocation} DIRECTORY)</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineplus">+        list(FIND ${dirsvar} ${libdir} seendir)</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineplus">+        if (${seendir} EQUAL -1)</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineplus">+          list(APPEND ${dirsvar} ${libdir} ${libdirs})</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineplus">+        endif()</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineplus">+      endif()</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineplus">+    endif()</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineplus">+  endforeach()</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineplus">+  set(visited_targets ${visited_targets} PARENT_SCOPE)</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineplus">+  set(${libsvar} ${libs} PARENT_SCOPE)</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineplus">+  set(${dirsvar} ${${dirsvar}} PARENT_SCOPE)</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineplus">+endfunction()</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineplus">+</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineplus">+get_linked_libs(libs dirs librnp)</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineplus">+set(linkercmd)</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineplus">+foreach (dir ${dirs})</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineplus">+  string(APPEND linkercmd &quot;-L${dir} &quot;)</span>
<a href="#l5.79"></a><span id="l5.79" class="difflineplus">+endforeach()</span>
<a href="#l5.80"></a><span id="l5.80" class="difflineplus">+foreach (lib ${libs})</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineplus">+  string(APPEND linkercmd &quot;-l${lib} &quot;)</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineplus">+endforeach()</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineplus">+string(STRIP &quot;${linkercmd}&quot; linkercmd)</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineplus">+set(LIBRNP_PRIVATE_LIBS ${linkercmd})</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineplus">+</span>
<a href="#l5.86"></a><span id="l5.86"> # create a pkgconfig .pc too</span>
<a href="#l5.87"></a><span id="l5.87"> find_package(PkgConfig)</span>
<a href="#l5.88"></a><span id="l5.88"> if (PKG_CONFIG_FOUND)</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineplus">+  get_target_property(LIBRNP_OUTPUT_NAME librnp OUTPUT_NAME)</span>
<a href="#l5.90"></a><span id="l5.90">   configure_file(</span>
<a href="#l5.91"></a><span id="l5.91">     &quot;${PROJECT_SOURCE_DIR}/cmake/librnp.pc.in&quot;</span>
<a href="#l5.92"></a><span id="l5.92">     &quot;${PROJECT_BINARY_DIR}/librnp-${PROJECT_VERSION_MAJOR}.pc&quot;</span>
<a href="#l5.93"></a><span id="l5.93">     @ONLY</span>
<a href="#l5.94"></a><span id="l5.94">   )</span>
<a href="#l5.95"></a><span id="l5.95">   install(</span>
<a href="#l5.96"></a><span id="l5.96">     FILES &quot;${PROJECT_BINARY_DIR}/librnp-${PROJECT_VERSION_MAJOR}.pc&quot;</span>
<a href="#l5.97"></a><span id="l5.97">     DESTINATION &quot;${CMAKE_INSTALL_LIBDIR}/pkgconfig&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/third_party/rnp/src/lib/config.h.in</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/third_party/rnp/src/lib/config.h.in</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -19,17 +19,17 @@</span>
<a href="#l6.4"></a><span id="l6.4">  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF</span>
<a href="#l6.5"></a><span id="l6.5">  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS</span>
<a href="#l6.6"></a><span id="l6.6">  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN</span>
<a href="#l6.7"></a><span id="l6.7">  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)</span>
<a href="#l6.8"></a><span id="l6.8">  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE</span>
<a href="#l6.9"></a><span id="l6.9">  * POSSIBILITY OF SUCH DAMAGE.</span>
<a href="#l6.10"></a><span id="l6.10">  */</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-#define PACKAGE_STRING    &quot;rnp 0.13.1+git20200609.b9335cee.MZLA&quot;</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+#define PACKAGE_STRING    &quot;rnp 0.13.1+git20200619.ac070578.MZLA&quot;</span>
<a href="#l6.14"></a><span id="l6.14"> #define PACKAGE_BUGREPORT &quot;https://bugzilla.mozilla.org/enter_bug.cgi?product=Thunderbird&quot;</span>
<a href="#l6.15"></a><span id="l6.15"> </span>
<a href="#l6.16"></a><span id="l6.16"> #undef HAVE_BZLIB_H</span>
<a href="#l6.17"></a><span id="l6.17"> #undef HAVE_ZLIB_H</span>
<a href="#l6.18"></a><span id="l6.18"> </span>
<a href="#l6.19"></a><span id="l6.19"> #undef HAVE_FCNTL_H</span>
<a href="#l6.20"></a><span id="l6.20"> #undef HAVE_INTTYPES_H</span>
<a href="#l6.21"></a><span id="l6.21"> #undef HAVE_LIMITS_H</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineat">@@ -43,8 +43,15 @@</span>
<a href="#l6.23"></a><span id="l6.23"> #undef HAVE_UNISTD_H</span>
<a href="#l6.24"></a><span id="l6.24"> #undef HAVE_SYS_WAIT_H</span>
<a href="#l6.25"></a><span id="l6.25"> #undef HAVE_MKDTEMP</span>
<a href="#l6.26"></a><span id="l6.26"> #undef HAVE_REALPATH</span>
<a href="#l6.27"></a><span id="l6.27"> #undef HAVE_O_BINARY</span>
<a href="#l6.28"></a><span id="l6.28"> #undef HAVE__O_BINARY</span>
<a href="#l6.29"></a><span id="l6.29"> #undef HAVE__TEMPNAM</span>
<a href="#l6.30"></a><span id="l6.30"> </span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+/* Macro _GLIBCXX_USE_CXX11_ABI was first introduced with GCC 5.0, which</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+ * we assume to be bundled with a sane implementation of std::regex. */</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+#if !defined(__GNUC__) || defined(_GLIBCXX_USE_CXX11_ABI)</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+#define RNP_USE_STD_REGEX 1</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+#endif</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineplus">+</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/third_party/rnp/src/lib/ffi-priv-types.h</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/third_party/rnp/src/lib/ffi-priv-types.h</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -44,16 +44,31 @@ struct rnp_uid_handle_st {</span>
<a href="#l7.4"></a><span id="l7.4"> </span>
<a href="#l7.5"></a><span id="l7.5"> struct rnp_signature_handle_st {</span>
<a href="#l7.6"></a><span id="l7.6">     rnp_ffi_t     ffi;</span>
<a href="#l7.7"></a><span id="l7.7">     pgp_key_t *   key;</span>
<a href="#l7.8"></a><span id="l7.8">     pgp_subsig_t *sig;</span>
<a href="#l7.9"></a><span id="l7.9">     bool          own_sig;</span>
<a href="#l7.10"></a><span id="l7.10"> };</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+struct rnp_recipient_handle_st {</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+    rnp_ffi_t        ffi;</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+    uint8_t          keyid[PGP_KEY_ID_SIZE];</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+    pgp_pubkey_alg_t palg;</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+};</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+struct rnp_symenc_handle_st {</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+    rnp_ffi_t           ffi;</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+    pgp_symm_alg_t      alg;</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+    pgp_hash_alg_t      halg;</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineplus">+    pgp_s2k_specifier_t s2k_type;</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineplus">+    uint32_t            iterations;</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineplus">+    pgp_aead_alg_t      aalg;</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineplus">+};</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineplus">+</span>
<a href="#l7.27"></a><span id="l7.27"> struct rnp_ffi_st {</span>
<a href="#l7.28"></a><span id="l7.28">     FILE *                  errs;</span>
<a href="#l7.29"></a><span id="l7.29">     rnp_key_store_t *       pubring;</span>
<a href="#l7.30"></a><span id="l7.30">     rnp_key_store_t *       secring;</span>
<a href="#l7.31"></a><span id="l7.31">     rnp_get_key_cb          getkeycb;</span>
<a href="#l7.32"></a><span id="l7.32">     void *                  getkeycb_ctx;</span>
<a href="#l7.33"></a><span id="l7.33">     rnp_password_cb         getpasscb;</span>
<a href="#l7.34"></a><span id="l7.34">     void *                  getpasscb_ctx;</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineat">@@ -127,16 +142,29 @@ struct rnp_op_verify_st {</span>
<a href="#l7.36"></a><span id="l7.36">     rnp_input_t  detached_input; /* for detached signature will be source file/data */</span>
<a href="#l7.37"></a><span id="l7.37">     rnp_output_t output;</span>
<a href="#l7.38"></a><span id="l7.38">     rnp_ctx_t    rnpctx;</span>
<a href="#l7.39"></a><span id="l7.39">     /* these fields are filled after operation execution */</span>
<a href="#l7.40"></a><span id="l7.40">     rnp_op_verify_signature_t signatures;</span>
<a href="#l7.41"></a><span id="l7.41">     size_t                    signature_count;</span>
<a href="#l7.42"></a><span id="l7.42">     char *                    filename;</span>
<a href="#l7.43"></a><span id="l7.43">     uint32_t                  file_mtime;</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+    /* encryption information */</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineplus">+    bool           encrypted;</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineplus">+    bool           mdc;</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineplus">+    bool           validated;</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineplus">+    pgp_aead_alg_t aead;</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineplus">+    pgp_symm_alg_t salg;</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineplus">+    /* recipient/symenc information */</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineplus">+    rnp_recipient_handle_t recipients;</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineplus">+    size_t                 recipient_count;</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineplus">+    rnp_recipient_handle_t used_recipient;</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineplus">+    rnp_symenc_handle_t    symencs;</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineplus">+    size_t                 symenc_count;</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineplus">+    rnp_symenc_handle_t    used_symenc;</span>
<a href="#l7.57"></a><span id="l7.57"> };</span>
<a href="#l7.58"></a><span id="l7.58"> </span>
<a href="#l7.59"></a><span id="l7.59"> struct rnp_op_encrypt_st {</span>
<a href="#l7.60"></a><span id="l7.60">     rnp_ffi_t    ffi;</span>
<a href="#l7.61"></a><span id="l7.61">     rnp_input_t  input;</span>
<a href="#l7.62"></a><span id="l7.62">     rnp_output_t output;</span>
<a href="#l7.63"></a><span id="l7.63">     rnp_ctx_t    rnpctx;</span>
<a href="#l7.64"></a><span id="l7.64">     list         signatures;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/third_party/rnp/src/lib/pgp-key.cpp</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/third_party/rnp/src/lib/pgp-key.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -1305,16 +1305,25 @@ pgp_key_add_subkey_grip(pgp_key_t *key, </span>
<a href="#l8.4"></a><span id="l8.4">         key-&gt;subkey_grips.push_back(grip);</span>
<a href="#l8.5"></a><span id="l8.5">         return true;</span>
<a href="#l8.6"></a><span id="l8.6">     } catch (const std::exception &amp;e) {</span>
<a href="#l8.7"></a><span id="l8.7">         RNP_LOG(&quot;%s&quot;, e.what());</span>
<a href="#l8.8"></a><span id="l8.8">         return false;</span>
<a href="#l8.9"></a><span id="l8.9">     }</span>
<a href="#l8.10"></a><span id="l8.10"> }</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+void</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+pgp_key_remove_subkey_grip(pgp_key_t *key, const pgp_key_grip_t &amp;grip)</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+{</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+    auto it = std::find(key-&gt;subkey_grips.begin(), key-&gt;subkey_grips.end(), grip);</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+    if (it != key-&gt;subkey_grips.end()) {</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+        key-&gt;subkey_grips.erase(it);</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+    }</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+}</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineplus">+</span>
<a href="#l8.21"></a><span id="l8.21"> const pgp_key_grip_t &amp;</span>
<a href="#l8.22"></a><span id="l8.22"> pgp_key_get_subkey_grip(const pgp_key_t *key, size_t idx)</span>
<a href="#l8.23"></a><span id="l8.23"> {</span>
<a href="#l8.24"></a><span id="l8.24">     return key-&gt;subkey_grips[idx];</span>
<a href="#l8.25"></a><span id="l8.25"> }</span>
<a href="#l8.26"></a><span id="l8.26"> </span>
<a href="#l8.27"></a><span id="l8.27"> pgp_key_t *</span>
<a href="#l8.28"></a><span id="l8.28"> pgp_key_get_subkey(const pgp_key_t *key, rnp_key_store_t *store, size_t idx)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/third_party/rnp/src/lib/pgp-key.h</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/third_party/rnp/src/lib/pgp-key.h</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -323,16 +323,24 @@ size_t pgp_key_get_subkey_count(const pg</span>
<a href="#l9.4"></a><span id="l9.4">  *</span>
<a href="#l9.5"></a><span id="l9.5">  * @param key key pointer to the primary key</span>
<a href="#l9.6"></a><span id="l9.6">  * @param grip subkey's grip.</span>
<a href="#l9.7"></a><span id="l9.7">  * @return true if succeeded (grip already exists in list or added), or false otherwise.</span>
<a href="#l9.8"></a><span id="l9.8">  */</span>
<a href="#l9.9"></a><span id="l9.9"> bool pgp_key_add_subkey_grip(pgp_key_t *key, const pgp_key_grip_t &amp;grip);</span>
<a href="#l9.10"></a><span id="l9.10"> </span>
<a href="#l9.11"></a><span id="l9.11"> /**</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+ * @brief Remove subkey grip from key's list.</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+ *</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+ * @param key key pointer to the primary key</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+ * @param grip subkey's grip.</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+ */</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+void pgp_key_remove_subkey_grip(pgp_key_t *key, const pgp_key_grip_t &amp;grip);</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineplus">+/**</span>
<a href="#l9.20"></a><span id="l9.20">  * @brief Get the pgp key's subkey grip</span>
<a href="#l9.21"></a><span id="l9.21">  *</span>
<a href="#l9.22"></a><span id="l9.22">  * @param key key pointer to the primary key</span>
<a href="#l9.23"></a><span id="l9.23">  * @param idx index of the subkey</span>
<a href="#l9.24"></a><span id="l9.24">  * @return grip or throws std::out_of_range exception</span>
<a href="#l9.25"></a><span id="l9.25">  */</span>
<a href="#l9.26"></a><span id="l9.26"> const pgp_key_grip_t &amp;pgp_key_get_subkey_grip(const pgp_key_t *key, size_t idx);</span>
<a href="#l9.27"></a><span id="l9.27"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/third_party/rnp/src/lib/rnp.cpp</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/third_party/rnp/src/lib/rnp.cpp</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -192,16 +192,21 @@ static const pgp_map_t hash_alg_map[] = </span>
<a href="#l10.4"></a><span id="l10.4">                                          {PGP_HASH_SHA384, RNP_ALGNAME_SHA384},</span>
<a href="#l10.5"></a><span id="l10.5">                                          {PGP_HASH_SHA512, RNP_ALGNAME_SHA512},</span>
<a href="#l10.6"></a><span id="l10.6">                                          {PGP_HASH_SHA224, RNP_ALGNAME_SHA224},</span>
<a href="#l10.7"></a><span id="l10.7">                                          {PGP_HASH_SHA3_256, RNP_ALGNAME_SHA3_256},</span>
<a href="#l10.8"></a><span id="l10.8">                                          {PGP_HASH_SHA3_512, RNP_ALGNAME_SHA3_512},</span>
<a href="#l10.9"></a><span id="l10.9">                                          {PGP_HASH_SM3, RNP_ALGNAME_SM3},</span>
<a href="#l10.10"></a><span id="l10.10">                                          {PGP_HASH_CRC24, RNP_ALGNAME_CRC24}};</span>
<a href="#l10.11"></a><span id="l10.11"> </span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+static const pgp_map_t s2k_type_map[] = {</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+  {PGP_S2KS_SIMPLE, &quot;Simple&quot;},</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+  {PGP_S2KS_SALTED, &quot;Salted&quot;},</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+  {PGP_S2KS_ITERATED_AND_SALTED, &quot;Iterated and salted&quot;}};</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+</span>
<a href="#l10.17"></a><span id="l10.17"> static const pgp_bit_map_t key_usage_map[] = {{PGP_KF_SIGN, &quot;sign&quot;},</span>
<a href="#l10.18"></a><span id="l10.18">                                               {PGP_KF_CERTIFY, &quot;certify&quot;},</span>
<a href="#l10.19"></a><span id="l10.19">                                               {PGP_KF_ENCRYPT, &quot;encrypt&quot;},</span>
<a href="#l10.20"></a><span id="l10.20">                                               {PGP_KF_AUTH, &quot;authenticate&quot;}};</span>
<a href="#l10.21"></a><span id="l10.21"> </span>
<a href="#l10.22"></a><span id="l10.22"> static const pgp_bit_map_t key_flags_map[] = {{PGP_KF_SPLIT, &quot;split&quot;},</span>
<a href="#l10.23"></a><span id="l10.23">                                               {PGP_KF_SHARED, &quot;shared&quot;}};</span>
<a href="#l10.24"></a><span id="l10.24"> </span>
<a href="#l10.25"></a><span id="l10.25" class="difflineat">@@ -366,16 +371,53 @@ parse_ks_format(pgp_key_store_format_t *</span>
<a href="#l10.26"></a><span id="l10.26">     } else if (!strcmp(format, RNP_KEYSTORE_G10)) {</span>
<a href="#l10.27"></a><span id="l10.27">         *key_store_format = PGP_KEY_STORE_G10;</span>
<a href="#l10.28"></a><span id="l10.28">     } else {</span>
<a href="#l10.29"></a><span id="l10.29">         return false;</span>
<a href="#l10.30"></a><span id="l10.30">     }</span>
<a href="#l10.31"></a><span id="l10.31">     return true;</span>
<a href="#l10.32"></a><span id="l10.32"> }</span>
<a href="#l10.33"></a><span id="l10.33"> </span>
<a href="#l10.34"></a><span id="l10.34" class="difflineplus">+static rnp_result_t</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineplus">+hex_encode_value(const uint8_t *value, size_t len, char **res, rnp_hex_format_t format)</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineplus">+{</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineplus">+    size_t hex_len = len * 2 + 1;</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineplus">+    *res = (char *) malloc(hex_len);</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineplus">+    if (!*res) {</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineplus">+        return RNP_ERROR_OUT_OF_MEMORY;</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineplus">+    }</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineplus">+    if (!rnp_hex_encode(value, len, *res, hex_len, format)) {</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineplus">+        free(*res);</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineplus">+        *res = NULL;</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineplus">+        return RNP_ERROR_GENERIC;</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineplus">+    }</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineplus">+    return RNP_SUCCESS;</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineplus">+}</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineplus">+</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineplus">+static rnp_result_t</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineplus">+get_map_value(const pgp_map_t *map, size_t msize, int val, char **res)</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineplus">+{</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineplus">+    const char *str = NULL;</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineplus">+    for (size_t i = 0; i &lt; msize; i++) {</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineplus">+        if (map[i].type == val) {</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineplus">+            str = map[i].string;</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineplus">+            break;</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineplus">+        }</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineplus">+    }</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineplus">+    if (!str) {</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineplus">+        return RNP_ERROR_BAD_PARAMETERS;</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineplus">+    }</span>
<a href="#l10.63"></a><span id="l10.63" class="difflineplus">+    char *strcp = strdup(str);</span>
<a href="#l10.64"></a><span id="l10.64" class="difflineplus">+    if (!strcp) {</span>
<a href="#l10.65"></a><span id="l10.65" class="difflineplus">+        return RNP_ERROR_OUT_OF_MEMORY;</span>
<a href="#l10.66"></a><span id="l10.66" class="difflineplus">+    }</span>
<a href="#l10.67"></a><span id="l10.67" class="difflineplus">+    *res = strcp;</span>
<a href="#l10.68"></a><span id="l10.68" class="difflineplus">+    return RNP_SUCCESS;</span>
<a href="#l10.69"></a><span id="l10.69" class="difflineplus">+}</span>
<a href="#l10.70"></a><span id="l10.70" class="difflineplus">+</span>
<a href="#l10.71"></a><span id="l10.71"> rnp_result_t</span>
<a href="#l10.72"></a><span id="l10.72"> rnp_ffi_create(rnp_ffi_t *ffi, const char *pub_format, const char *sec_format)</span>
<a href="#l10.73"></a><span id="l10.73"> {</span>
<a href="#l10.74"></a><span id="l10.74">     struct rnp_ffi_st *ob = NULL;</span>
<a href="#l10.75"></a><span id="l10.75">     rnp_result_t       ret = RNP_ERROR_GENERIC;</span>
<a href="#l10.76"></a><span id="l10.76"> </span>
<a href="#l10.77"></a><span id="l10.77">     // checks</span>
<a href="#l10.78"></a><span id="l10.78">     if (!ffi || !pub_format || !sec_format) {</span>
<a href="#l10.79"></a><span id="l10.79" class="difflineat">@@ -2660,16 +2702,112 @@ rnp_verify_dest_provider(pgp_parse_handl</span>
<a href="#l10.80"></a><span id="l10.80">     rnp_op_verify_t op = (rnp_op_verify_t) handler-&gt;param;</span>
<a href="#l10.81"></a><span id="l10.81">     *dst = &amp;(op-&gt;output-&gt;dst);</span>
<a href="#l10.82"></a><span id="l10.82">     *closedst = false;</span>
<a href="#l10.83"></a><span id="l10.83">     op-&gt;filename = filename ? strdup(filename) : NULL;</span>
<a href="#l10.84"></a><span id="l10.84"> </span>
<a href="#l10.85"></a><span id="l10.85">     return true;</span>
<a href="#l10.86"></a><span id="l10.86"> }</span>
<a href="#l10.87"></a><span id="l10.87"> </span>
<a href="#l10.88"></a><span id="l10.88" class="difflineplus">+static void</span>
<a href="#l10.89"></a><span id="l10.89" class="difflineplus">+recipient_handle_from_pk_sesskey(rnp_recipient_handle_t  handle,</span>
<a href="#l10.90"></a><span id="l10.90" class="difflineplus">+                                 const pgp_pk_sesskey_t &amp;sesskey)</span>
<a href="#l10.91"></a><span id="l10.91" class="difflineplus">+{</span>
<a href="#l10.92"></a><span id="l10.92" class="difflineplus">+    memcpy(handle-&gt;keyid, sesskey.key_id, PGP_KEY_ID_SIZE);</span>
<a href="#l10.93"></a><span id="l10.93" class="difflineplus">+    handle-&gt;palg = sesskey.alg;</span>
<a href="#l10.94"></a><span id="l10.94" class="difflineplus">+}</span>
<a href="#l10.95"></a><span id="l10.95" class="difflineplus">+</span>
<a href="#l10.96"></a><span id="l10.96" class="difflineplus">+static void</span>
<a href="#l10.97"></a><span id="l10.97" class="difflineplus">+symenc_handle_from_sk_sesskey(rnp_symenc_handle_t handle, const pgp_sk_sesskey_t &amp;sesskey)</span>
<a href="#l10.98"></a><span id="l10.98" class="difflineplus">+{</span>
<a href="#l10.99"></a><span id="l10.99" class="difflineplus">+    handle-&gt;alg = sesskey.alg;</span>
<a href="#l10.100"></a><span id="l10.100" class="difflineplus">+    handle-&gt;halg = sesskey.s2k.hash_alg;</span>
<a href="#l10.101"></a><span id="l10.101" class="difflineplus">+    handle-&gt;s2k_type = sesskey.s2k.specifier;</span>
<a href="#l10.102"></a><span id="l10.102" class="difflineplus">+    if (sesskey.s2k.specifier == PGP_S2KS_ITERATED_AND_SALTED) {</span>
<a href="#l10.103"></a><span id="l10.103" class="difflineplus">+        handle-&gt;iterations = pgp_s2k_decode_iterations(sesskey.s2k.iterations);</span>
<a href="#l10.104"></a><span id="l10.104" class="difflineplus">+    } else {</span>
<a href="#l10.105"></a><span id="l10.105" class="difflineplus">+        handle-&gt;iterations = 1;</span>
<a href="#l10.106"></a><span id="l10.106" class="difflineplus">+    }</span>
<a href="#l10.107"></a><span id="l10.107" class="difflineplus">+    handle-&gt;aalg = sesskey.aalg;</span>
<a href="#l10.108"></a><span id="l10.108" class="difflineplus">+}</span>
<a href="#l10.109"></a><span id="l10.109" class="difflineplus">+</span>
<a href="#l10.110"></a><span id="l10.110" class="difflineplus">+static void</span>
<a href="#l10.111"></a><span id="l10.111" class="difflineplus">+rnp_verify_on_recipients(const std::vector&lt;pgp_pk_sesskey_t&gt; &amp;recipients,</span>
<a href="#l10.112"></a><span id="l10.112" class="difflineplus">+                         const std::vector&lt;pgp_sk_sesskey_t&gt; &amp;passwords,</span>
<a href="#l10.113"></a><span id="l10.113" class="difflineplus">+                         void *                               param)</span>
<a href="#l10.114"></a><span id="l10.114" class="difflineplus">+{</span>
<a href="#l10.115"></a><span id="l10.115" class="difflineplus">+    rnp_op_verify_t op = (rnp_op_verify_t) param;</span>
<a href="#l10.116"></a><span id="l10.116" class="difflineplus">+    if (!recipients.empty()) {</span>
<a href="#l10.117"></a><span id="l10.117" class="difflineplus">+        op-&gt;recipients =</span>
<a href="#l10.118"></a><span id="l10.118" class="difflineplus">+          (rnp_recipient_handle_t) calloc(recipients.size(), sizeof(*op-&gt;recipients));</span>
<a href="#l10.119"></a><span id="l10.119" class="difflineplus">+        if (!op-&gt;recipients) {</span>
<a href="#l10.120"></a><span id="l10.120" class="difflineplus">+            FFI_LOG(op-&gt;ffi, &quot;allocation failed&quot;);</span>
<a href="#l10.121"></a><span id="l10.121" class="difflineplus">+            return;</span>
<a href="#l10.122"></a><span id="l10.122" class="difflineplus">+        }</span>
<a href="#l10.123"></a><span id="l10.123" class="difflineplus">+        for (size_t i = 0; i &lt; recipients.size(); i++) {</span>
<a href="#l10.124"></a><span id="l10.124" class="difflineplus">+            recipient_handle_from_pk_sesskey(&amp;op-&gt;recipients[i], recipients[i]);</span>
<a href="#l10.125"></a><span id="l10.125" class="difflineplus">+        }</span>
<a href="#l10.126"></a><span id="l10.126" class="difflineplus">+    }</span>
<a href="#l10.127"></a><span id="l10.127" class="difflineplus">+    op-&gt;recipient_count = recipients.size();</span>
<a href="#l10.128"></a><span id="l10.128" class="difflineplus">+</span>
<a href="#l10.129"></a><span id="l10.129" class="difflineplus">+    if (!passwords.empty()) {</span>
<a href="#l10.130"></a><span id="l10.130" class="difflineplus">+        op-&gt;symencs = (rnp_symenc_handle_t) calloc(passwords.size(), sizeof(*op-&gt;symencs));</span>
<a href="#l10.131"></a><span id="l10.131" class="difflineplus">+        if (!op-&gt;symencs) {</span>
<a href="#l10.132"></a><span id="l10.132" class="difflineplus">+            FFI_LOG(op-&gt;ffi, &quot;allocation failed&quot;);</span>
<a href="#l10.133"></a><span id="l10.133" class="difflineplus">+            return;</span>
<a href="#l10.134"></a><span id="l10.134" class="difflineplus">+        }</span>
<a href="#l10.135"></a><span id="l10.135" class="difflineplus">+        for (size_t i = 0; i &lt; passwords.size(); i++) {</span>
<a href="#l10.136"></a><span id="l10.136" class="difflineplus">+            symenc_handle_from_sk_sesskey(&amp;op-&gt;symencs[i], passwords[i]);</span>
<a href="#l10.137"></a><span id="l10.137" class="difflineplus">+        }</span>
<a href="#l10.138"></a><span id="l10.138" class="difflineplus">+    }</span>
<a href="#l10.139"></a><span id="l10.139" class="difflineplus">+    op-&gt;symenc_count = passwords.size();</span>
<a href="#l10.140"></a><span id="l10.140" class="difflineplus">+}</span>
<a href="#l10.141"></a><span id="l10.141" class="difflineplus">+</span>
<a href="#l10.142"></a><span id="l10.142" class="difflineplus">+static void</span>
<a href="#l10.143"></a><span id="l10.143" class="difflineplus">+rnp_verify_on_decryption_start(pgp_pk_sesskey_t *pubenc, pgp_sk_sesskey_t *symenc, void *param)</span>
<a href="#l10.144"></a><span id="l10.144" class="difflineplus">+{</span>
<a href="#l10.145"></a><span id="l10.145" class="difflineplus">+    rnp_op_verify_t op = (rnp_op_verify_t) param;</span>
<a href="#l10.146"></a><span id="l10.146" class="difflineplus">+    if (pubenc) {</span>
<a href="#l10.147"></a><span id="l10.147" class="difflineplus">+        op-&gt;used_recipient = (rnp_recipient_handle_t) calloc(1, sizeof(*op-&gt;used_recipient));</span>
<a href="#l10.148"></a><span id="l10.148" class="difflineplus">+        if (!op-&gt;used_recipient) {</span>
<a href="#l10.149"></a><span id="l10.149" class="difflineplus">+            FFI_LOG(op-&gt;ffi, &quot;allocation failed&quot;);</span>
<a href="#l10.150"></a><span id="l10.150" class="difflineplus">+            return;</span>
<a href="#l10.151"></a><span id="l10.151" class="difflineplus">+        }</span>
<a href="#l10.152"></a><span id="l10.152" class="difflineplus">+        recipient_handle_from_pk_sesskey(op-&gt;used_recipient, *pubenc);</span>
<a href="#l10.153"></a><span id="l10.153" class="difflineplus">+        return;</span>
<a href="#l10.154"></a><span id="l10.154" class="difflineplus">+    }</span>
<a href="#l10.155"></a><span id="l10.155" class="difflineplus">+    if (symenc) {</span>
<a href="#l10.156"></a><span id="l10.156" class="difflineplus">+        op-&gt;used_symenc = (rnp_symenc_handle_t) calloc(1, sizeof(*op-&gt;used_symenc));</span>
<a href="#l10.157"></a><span id="l10.157" class="difflineplus">+        if (!op-&gt;used_symenc) {</span>
<a href="#l10.158"></a><span id="l10.158" class="difflineplus">+            FFI_LOG(op-&gt;ffi, &quot;allocation failed&quot;);</span>
<a href="#l10.159"></a><span id="l10.159" class="difflineplus">+            return;</span>
<a href="#l10.160"></a><span id="l10.160" class="difflineplus">+        }</span>
<a href="#l10.161"></a><span id="l10.161" class="difflineplus">+        symenc_handle_from_sk_sesskey(op-&gt;used_symenc, *symenc);</span>
<a href="#l10.162"></a><span id="l10.162" class="difflineplus">+        return;</span>
<a href="#l10.163"></a><span id="l10.163" class="difflineplus">+    }</span>
<a href="#l10.164"></a><span id="l10.164" class="difflineplus">+    FFI_LOG(op-&gt;ffi, &quot;Warning! Both pubenc and symenc are NULL.&quot;);</span>
<a href="#l10.165"></a><span id="l10.165" class="difflineplus">+}</span>
<a href="#l10.166"></a><span id="l10.166" class="difflineplus">+</span>
<a href="#l10.167"></a><span id="l10.167" class="difflineplus">+static void</span>
<a href="#l10.168"></a><span id="l10.168" class="difflineplus">+rnp_verify_on_decryption_info(bool mdc, pgp_aead_alg_t aead, pgp_symm_alg_t salg, void *param)</span>
<a href="#l10.169"></a><span id="l10.169" class="difflineplus">+{</span>
<a href="#l10.170"></a><span id="l10.170" class="difflineplus">+    rnp_op_verify_t op = (rnp_op_verify_t) param;</span>
<a href="#l10.171"></a><span id="l10.171" class="difflineplus">+    op-&gt;mdc = mdc;</span>
<a href="#l10.172"></a><span id="l10.172" class="difflineplus">+    op-&gt;aead = aead;</span>
<a href="#l10.173"></a><span id="l10.173" class="difflineplus">+    op-&gt;salg = salg;</span>
<a href="#l10.174"></a><span id="l10.174" class="difflineplus">+    op-&gt;encrypted = true;</span>
<a href="#l10.175"></a><span id="l10.175" class="difflineplus">+}</span>
<a href="#l10.176"></a><span id="l10.176" class="difflineplus">+</span>
<a href="#l10.177"></a><span id="l10.177" class="difflineplus">+static void</span>
<a href="#l10.178"></a><span id="l10.178" class="difflineplus">+rnp_verify_on_decryption_done(bool validated, void *param)</span>
<a href="#l10.179"></a><span id="l10.179" class="difflineplus">+{</span>
<a href="#l10.180"></a><span id="l10.180" class="difflineplus">+    rnp_op_verify_t op = (rnp_op_verify_t) param;</span>
<a href="#l10.181"></a><span id="l10.181" class="difflineplus">+    op-&gt;validated = validated;</span>
<a href="#l10.182"></a><span id="l10.182" class="difflineplus">+}</span>
<a href="#l10.183"></a><span id="l10.183" class="difflineplus">+</span>
<a href="#l10.184"></a><span id="l10.184"> rnp_result_t</span>
<a href="#l10.185"></a><span id="l10.185"> rnp_op_verify_create(rnp_op_verify_t *op,</span>
<a href="#l10.186"></a><span id="l10.186">                      rnp_ffi_t        ffi,</span>
<a href="#l10.187"></a><span id="l10.187">                      rnp_input_t      input,</span>
<a href="#l10.188"></a><span id="l10.188">                      rnp_output_t     output)</span>
<a href="#l10.189"></a><span id="l10.189"> {</span>
<a href="#l10.190"></a><span id="l10.190">     if (!op || !ffi || !input) {</span>
<a href="#l10.191"></a><span id="l10.191">         return RNP_ERROR_NULL_POINTER;</span>
<a href="#l10.192"></a><span id="l10.192" class="difflineat">@@ -2716,16 +2854,20 @@ rnp_op_verify_execute(rnp_op_verify_t op</span>
<a href="#l10.193"></a><span id="l10.193"> {</span>
<a href="#l10.194"></a><span id="l10.194">     pgp_parse_handler_t handler;</span>
<a href="#l10.195"></a><span id="l10.195"> </span>
<a href="#l10.196"></a><span id="l10.196">     handler.password_provider = &amp;op-&gt;ffi-&gt;pass_provider;</span>
<a href="#l10.197"></a><span id="l10.197">     handler.key_provider = &amp;op-&gt;ffi-&gt;key_provider;</span>
<a href="#l10.198"></a><span id="l10.198">     handler.on_signatures = rnp_op_verify_on_signatures;</span>
<a href="#l10.199"></a><span id="l10.199">     handler.src_provider = rnp_verify_src_provider;</span>
<a href="#l10.200"></a><span id="l10.200">     handler.dest_provider = rnp_verify_dest_provider;</span>
<a href="#l10.201"></a><span id="l10.201" class="difflineplus">+    handler.on_recipients = rnp_verify_on_recipients;</span>
<a href="#l10.202"></a><span id="l10.202" class="difflineplus">+    handler.on_decryption_start = rnp_verify_on_decryption_start;</span>
<a href="#l10.203"></a><span id="l10.203" class="difflineplus">+    handler.on_decryption_info = rnp_verify_on_decryption_info;</span>
<a href="#l10.204"></a><span id="l10.204" class="difflineplus">+    handler.on_decryption_done = rnp_verify_on_decryption_done;</span>
<a href="#l10.205"></a><span id="l10.205">     handler.param = op;</span>
<a href="#l10.206"></a><span id="l10.206">     handler.ctx = &amp;op-&gt;rnpctx;</span>
<a href="#l10.207"></a><span id="l10.207"> </span>
<a href="#l10.208"></a><span id="l10.208">     rnp_result_t ret = process_pgp_source(&amp;handler, &amp;op-&gt;input-&gt;src);</span>
<a href="#l10.209"></a><span id="l10.209">     if (op-&gt;output) {</span>
<a href="#l10.210"></a><span id="l10.210">         dst_flush(&amp;op-&gt;output-&gt;dst);</span>
<a href="#l10.211"></a><span id="l10.211">         op-&gt;output-&gt;keep = ret == RNP_SUCCESS;</span>
<a href="#l10.212"></a><span id="l10.212">     }</span>
<a href="#l10.213"></a><span id="l10.213" class="difflineat">@@ -2768,26 +2910,220 @@ rnp_op_verify_get_file_info(rnp_op_verif</span>
<a href="#l10.214"></a><span id="l10.214">             *filename = strdup(op-&gt;filename);</span>
<a href="#l10.215"></a><span id="l10.215">         } else {</span>
<a href="#l10.216"></a><span id="l10.216">             *filename = NULL;</span>
<a href="#l10.217"></a><span id="l10.217">         }</span>
<a href="#l10.218"></a><span id="l10.218">     }</span>
<a href="#l10.219"></a><span id="l10.219">     return RNP_SUCCESS;</span>
<a href="#l10.220"></a><span id="l10.220"> }</span>
<a href="#l10.221"></a><span id="l10.221"> </span>
<a href="#l10.222"></a><span id="l10.222" class="difflineplus">+static const char *</span>
<a href="#l10.223"></a><span id="l10.223" class="difflineplus">+get_protection_mode(rnp_op_verify_t op)</span>
<a href="#l10.224"></a><span id="l10.224" class="difflineplus">+{</span>
<a href="#l10.225"></a><span id="l10.225" class="difflineplus">+    if (!op-&gt;encrypted) {</span>
<a href="#l10.226"></a><span id="l10.226" class="difflineplus">+        return &quot;none&quot;;</span>
<a href="#l10.227"></a><span id="l10.227" class="difflineplus">+    }</span>
<a href="#l10.228"></a><span id="l10.228" class="difflineplus">+    if (op-&gt;mdc) {</span>
<a href="#l10.229"></a><span id="l10.229" class="difflineplus">+        return &quot;cfb-mdc&quot;;</span>
<a href="#l10.230"></a><span id="l10.230" class="difflineplus">+    }</span>
<a href="#l10.231"></a><span id="l10.231" class="difflineplus">+    if (op-&gt;aead == PGP_AEAD_NONE) {</span>
<a href="#l10.232"></a><span id="l10.232" class="difflineplus">+        return &quot;cfb&quot;;</span>
<a href="#l10.233"></a><span id="l10.233" class="difflineplus">+    }</span>
<a href="#l10.234"></a><span id="l10.234" class="difflineplus">+    switch (op-&gt;aead) {</span>
<a href="#l10.235"></a><span id="l10.235" class="difflineplus">+    case PGP_AEAD_EAX:</span>
<a href="#l10.236"></a><span id="l10.236" class="difflineplus">+        return &quot;aead-eax&quot;;</span>
<a href="#l10.237"></a><span id="l10.237" class="difflineplus">+    case PGP_AEAD_OCB:</span>
<a href="#l10.238"></a><span id="l10.238" class="difflineplus">+        return &quot;aead-ocb&quot;;</span>
<a href="#l10.239"></a><span id="l10.239" class="difflineplus">+    default:</span>
<a href="#l10.240"></a><span id="l10.240" class="difflineplus">+        return &quot;aead-unknown&quot;;</span>
<a href="#l10.241"></a><span id="l10.241" class="difflineplus">+    }</span>
<a href="#l10.242"></a><span id="l10.242" class="difflineplus">+}</span>
<a href="#l10.243"></a><span id="l10.243" class="difflineplus">+</span>
<a href="#l10.244"></a><span id="l10.244" class="difflineplus">+static const char *</span>
<a href="#l10.245"></a><span id="l10.245" class="difflineplus">+get_protection_cipher(rnp_op_verify_t op)</span>
<a href="#l10.246"></a><span id="l10.246" class="difflineplus">+{</span>
<a href="#l10.247"></a><span id="l10.247" class="difflineplus">+    if (!op-&gt;encrypted) {</span>
<a href="#l10.248"></a><span id="l10.248" class="difflineplus">+        return &quot;none&quot;;</span>
<a href="#l10.249"></a><span id="l10.249" class="difflineplus">+    }</span>
<a href="#l10.250"></a><span id="l10.250" class="difflineplus">+    const char *str = &quot;unknown&quot;;</span>
<a href="#l10.251"></a><span id="l10.251" class="difflineplus">+    ARRAY_LOOKUP_BY_ID(symm_alg_map, type, string, op-&gt;salg, str);</span>
<a href="#l10.252"></a><span id="l10.252" class="difflineplus">+    return str;</span>
<a href="#l10.253"></a><span id="l10.253" class="difflineplus">+}</span>
<a href="#l10.254"></a><span id="l10.254" class="difflineplus">+</span>
<a href="#l10.255"></a><span id="l10.255" class="difflineplus">+rnp_result_t</span>
<a href="#l10.256"></a><span id="l10.256" class="difflineplus">+rnp_op_verify_get_protection_info(rnp_op_verify_t op, char **mode, char **cipher, bool *valid)</span>
<a href="#l10.257"></a><span id="l10.257" class="difflineplus">+{</span>
<a href="#l10.258"></a><span id="l10.258" class="difflineplus">+    if (!op || (!mode &amp;&amp; !cipher &amp;&amp; !valid)) {</span>
<a href="#l10.259"></a><span id="l10.259" class="difflineplus">+        return RNP_ERROR_NULL_POINTER;</span>
<a href="#l10.260"></a><span id="l10.260" class="difflineplus">+    }</span>
<a href="#l10.261"></a><span id="l10.261" class="difflineplus">+</span>
<a href="#l10.262"></a><span id="l10.262" class="difflineplus">+    if (mode) {</span>
<a href="#l10.263"></a><span id="l10.263" class="difflineplus">+        *mode = strdup(get_protection_mode(op));</span>
<a href="#l10.264"></a><span id="l10.264" class="difflineplus">+        if (!*mode) {</span>
<a href="#l10.265"></a><span id="l10.265" class="difflineplus">+            return RNP_ERROR_OUT_OF_MEMORY;</span>
<a href="#l10.266"></a><span id="l10.266" class="difflineplus">+        }</span>
<a href="#l10.267"></a><span id="l10.267" class="difflineplus">+    }</span>
<a href="#l10.268"></a><span id="l10.268" class="difflineplus">+    if (cipher) {</span>
<a href="#l10.269"></a><span id="l10.269" class="difflineplus">+        *cipher = strdup(get_protection_cipher(op));</span>
<a href="#l10.270"></a><span id="l10.270" class="difflineplus">+        if (!*cipher) {</span>
<a href="#l10.271"></a><span id="l10.271" class="difflineplus">+            return RNP_ERROR_OUT_OF_MEMORY;</span>
<a href="#l10.272"></a><span id="l10.272" class="difflineplus">+        }</span>
<a href="#l10.273"></a><span id="l10.273" class="difflineplus">+    }</span>
<a href="#l10.274"></a><span id="l10.274" class="difflineplus">+    if (valid) {</span>
<a href="#l10.275"></a><span id="l10.275" class="difflineplus">+        *valid = op-&gt;validated;</span>
<a href="#l10.276"></a><span id="l10.276" class="difflineplus">+    }</span>
<a href="#l10.277"></a><span id="l10.277" class="difflineplus">+    return RNP_SUCCESS;</span>
<a href="#l10.278"></a><span id="l10.278" class="difflineplus">+}</span>
<a href="#l10.279"></a><span id="l10.279" class="difflineplus">+</span>
<a href="#l10.280"></a><span id="l10.280" class="difflineplus">+rnp_result_t</span>
<a href="#l10.281"></a><span id="l10.281" class="difflineplus">+rnp_op_verify_get_recipient_count(rnp_op_verify_t op, size_t *count)</span>
<a href="#l10.282"></a><span id="l10.282" class="difflineplus">+{</span>
<a href="#l10.283"></a><span id="l10.283" class="difflineplus">+    if (!op || !count) {</span>
<a href="#l10.284"></a><span id="l10.284" class="difflineplus">+        return RNP_ERROR_NULL_POINTER;</span>
<a href="#l10.285"></a><span id="l10.285" class="difflineplus">+    }</span>
<a href="#l10.286"></a><span id="l10.286" class="difflineplus">+    *count = op-&gt;recipient_count;</span>
<a href="#l10.287"></a><span id="l10.287" class="difflineplus">+    return RNP_SUCCESS;</span>
<a href="#l10.288"></a><span id="l10.288" class="difflineplus">+}</span>
<a href="#l10.289"></a><span id="l10.289" class="difflineplus">+</span>
<a href="#l10.290"></a><span id="l10.290" class="difflineplus">+rnp_result_t</span>
<a href="#l10.291"></a><span id="l10.291" class="difflineplus">+rnp_op_verify_get_used_recipient(rnp_op_verify_t op, rnp_recipient_handle_t *recipient)</span>
<a href="#l10.292"></a><span id="l10.292" class="difflineplus">+{</span>
<a href="#l10.293"></a><span id="l10.293" class="difflineplus">+    if (!op || !recipient) {</span>
<a href="#l10.294"></a><span id="l10.294" class="difflineplus">+        return RNP_ERROR_NULL_POINTER;</span>
<a href="#l10.295"></a><span id="l10.295" class="difflineplus">+    }</span>
<a href="#l10.296"></a><span id="l10.296" class="difflineplus">+    *recipient = op-&gt;used_recipient;</span>
<a href="#l10.297"></a><span id="l10.297" class="difflineplus">+    return RNP_SUCCESS;</span>
<a href="#l10.298"></a><span id="l10.298" class="difflineplus">+}</span>
<a href="#l10.299"></a><span id="l10.299" class="difflineplus">+</span>
<a href="#l10.300"></a><span id="l10.300" class="difflineplus">+rnp_result_t</span>
<a href="#l10.301"></a><span id="l10.301" class="difflineplus">+rnp_op_verify_get_recipient_at(rnp_op_verify_t         op,</span>
<a href="#l10.302"></a><span id="l10.302" class="difflineplus">+                               size_t                  idx,</span>
<a href="#l10.303"></a><span id="l10.303" class="difflineplus">+                               rnp_recipient_handle_t *recipient)</span>
<a href="#l10.304"></a><span id="l10.304" class="difflineplus">+{</span>
<a href="#l10.305"></a><span id="l10.305" class="difflineplus">+    if (!op || !recipient) {</span>
<a href="#l10.306"></a><span id="l10.306" class="difflineplus">+        return RNP_ERROR_NULL_POINTER;</span>
<a href="#l10.307"></a><span id="l10.307" class="difflineplus">+    }</span>
<a href="#l10.308"></a><span id="l10.308" class="difflineplus">+    if (idx &gt;= op-&gt;recipient_count) {</span>
<a href="#l10.309"></a><span id="l10.309" class="difflineplus">+        return RNP_ERROR_BAD_PARAMETERS;</span>
<a href="#l10.310"></a><span id="l10.310" class="difflineplus">+    }</span>
<a href="#l10.311"></a><span id="l10.311" class="difflineplus">+    *recipient = &amp;op-&gt;recipients[idx];</span>
<a href="#l10.312"></a><span id="l10.312" class="difflineplus">+    return RNP_SUCCESS;</span>
<a href="#l10.313"></a><span id="l10.313" class="difflineplus">+}</span>
<a href="#l10.314"></a><span id="l10.314" class="difflineplus">+</span>
<a href="#l10.315"></a><span id="l10.315" class="difflineplus">+rnp_result_t</span>
<a href="#l10.316"></a><span id="l10.316" class="difflineplus">+rnp_recipient_get_keyid(rnp_recipient_handle_t recipient, char **keyid)</span>
<a href="#l10.317"></a><span id="l10.317" class="difflineplus">+{</span>
<a href="#l10.318"></a><span id="l10.318" class="difflineplus">+    if (!recipient || !keyid) {</span>
<a href="#l10.319"></a><span id="l10.319" class="difflineplus">+        return RNP_ERROR_NULL_POINTER;</span>
<a href="#l10.320"></a><span id="l10.320" class="difflineplus">+    }</span>
<a href="#l10.321"></a><span id="l10.321" class="difflineplus">+    return hex_encode_value(recipient-&gt;keyid, PGP_KEY_ID_SIZE, keyid, RNP_HEX_UPPERCASE);</span>
<a href="#l10.322"></a><span id="l10.322" class="difflineplus">+}</span>
<a href="#l10.323"></a><span id="l10.323" class="difflineplus">+</span>
<a href="#l10.324"></a><span id="l10.324" class="difflineplus">+rnp_result_t</span>
<a href="#l10.325"></a><span id="l10.325" class="difflineplus">+rnp_recipient_get_alg(rnp_recipient_handle_t recipient, char **alg)</span>
<a href="#l10.326"></a><span id="l10.326" class="difflineplus">+{</span>
<a href="#l10.327"></a><span id="l10.327" class="difflineplus">+    if (!recipient || !alg) {</span>
<a href="#l10.328"></a><span id="l10.328" class="difflineplus">+        return RNP_ERROR_NULL_POINTER;</span>
<a href="#l10.329"></a><span id="l10.329" class="difflineplus">+    }</span>
<a href="#l10.330"></a><span id="l10.330" class="difflineplus">+    return get_map_value(pubkey_alg_map, ARRAY_SIZE(pubkey_alg_map), recipient-&gt;palg, alg);</span>
<a href="#l10.331"></a><span id="l10.331" class="difflineplus">+}</span>
<a href="#l10.332"></a><span id="l10.332" class="difflineplus">+</span>
<a href="#l10.333"></a><span id="l10.333" class="difflineplus">+rnp_result_t</span>
<a href="#l10.334"></a><span id="l10.334" class="difflineplus">+rnp_op_verify_get_symenc_count(rnp_op_verify_t op, size_t *count)</span>
<a href="#l10.335"></a><span id="l10.335" class="difflineplus">+{</span>
<a href="#l10.336"></a><span id="l10.336" class="difflineplus">+    if (!op || !count) {</span>
<a href="#l10.337"></a><span id="l10.337" class="difflineplus">+        return RNP_ERROR_NULL_POINTER;</span>
<a href="#l10.338"></a><span id="l10.338" class="difflineplus">+    }</span>
<a href="#l10.339"></a><span id="l10.339" class="difflineplus">+    *count = op-&gt;symenc_count;</span>
<a href="#l10.340"></a><span id="l10.340" class="difflineplus">+    return RNP_SUCCESS;</span>
<a href="#l10.341"></a><span id="l10.341" class="difflineplus">+}</span>
<a href="#l10.342"></a><span id="l10.342" class="difflineplus">+</span>
<a href="#l10.343"></a><span id="l10.343" class="difflineplus">+rnp_result_t</span>
<a href="#l10.344"></a><span id="l10.344" class="difflineplus">+rnp_op_verify_get_used_symenc(rnp_op_verify_t op, rnp_symenc_handle_t *symenc)</span>
<a href="#l10.345"></a><span id="l10.345" class="difflineplus">+{</span>
<a href="#l10.346"></a><span id="l10.346" class="difflineplus">+    if (!op || !symenc) {</span>
<a href="#l10.347"></a><span id="l10.347" class="difflineplus">+        return RNP_ERROR_NULL_POINTER;</span>
<a href="#l10.348"></a><span id="l10.348" class="difflineplus">+    }</span>
<a href="#l10.349"></a><span id="l10.349" class="difflineplus">+    *symenc = op-&gt;used_symenc;</span>
<a href="#l10.350"></a><span id="l10.350" class="difflineplus">+    return RNP_SUCCESS;</span>
<a href="#l10.351"></a><span id="l10.351" class="difflineplus">+}</span>
<a href="#l10.352"></a><span id="l10.352" class="difflineplus">+</span>
<a href="#l10.353"></a><span id="l10.353" class="difflineplus">+rnp_result_t</span>
<a href="#l10.354"></a><span id="l10.354" class="difflineplus">+rnp_op_verify_get_symenc_at(rnp_op_verify_t op, size_t idx, rnp_symenc_handle_t *symenc)</span>
<a href="#l10.355"></a><span id="l10.355" class="difflineplus">+{</span>
<a href="#l10.356"></a><span id="l10.356" class="difflineplus">+    if (!op || !symenc) {</span>
<a href="#l10.357"></a><span id="l10.357" class="difflineplus">+        return RNP_ERROR_NULL_POINTER;</span>
<a href="#l10.358"></a><span id="l10.358" class="difflineplus">+    }</span>
<a href="#l10.359"></a><span id="l10.359" class="difflineplus">+    if (idx &gt;= op-&gt;symenc_count) {</span>
<a href="#l10.360"></a><span id="l10.360" class="difflineplus">+        return RNP_ERROR_BAD_PARAMETERS;</span>
<a href="#l10.361"></a><span id="l10.361" class="difflineplus">+    }</span>
<a href="#l10.362"></a><span id="l10.362" class="difflineplus">+    *symenc = &amp;op-&gt;symencs[idx];</span>
<a href="#l10.363"></a><span id="l10.363" class="difflineplus">+    return RNP_SUCCESS;</span>
<a href="#l10.364"></a><span id="l10.364" class="difflineplus">+}</span>
<a href="#l10.365"></a><span id="l10.365" class="difflineplus">+</span>
<a href="#l10.366"></a><span id="l10.366" class="difflineplus">+rnp_result_t</span>
<a href="#l10.367"></a><span id="l10.367" class="difflineplus">+rnp_symenc_get_cipher(rnp_symenc_handle_t symenc, char **cipher)</span>
<a href="#l10.368"></a><span id="l10.368" class="difflineplus">+{</span>
<a href="#l10.369"></a><span id="l10.369" class="difflineplus">+    if (!symenc || !cipher) {</span>
<a href="#l10.370"></a><span id="l10.370" class="difflineplus">+        return RNP_ERROR_NULL_POINTER;</span>
<a href="#l10.371"></a><span id="l10.371" class="difflineplus">+    }</span>
<a href="#l10.372"></a><span id="l10.372" class="difflineplus">+    return get_map_value(symm_alg_map, ARRAY_SIZE(symm_alg_map), symenc-&gt;alg, cipher);</span>
<a href="#l10.373"></a><span id="l10.373" class="difflineplus">+}</span>
<a href="#l10.374"></a><span id="l10.374" class="difflineplus">+</span>
<a href="#l10.375"></a><span id="l10.375" class="difflineplus">+rnp_result_t</span>
<a href="#l10.376"></a><span id="l10.376" class="difflineplus">+rnp_symenc_get_aead_alg(rnp_symenc_handle_t symenc, char **alg)</span>
<a href="#l10.377"></a><span id="l10.377" class="difflineplus">+{</span>
<a href="#l10.378"></a><span id="l10.378" class="difflineplus">+    if (!symenc || !alg) {</span>
<a href="#l10.379"></a><span id="l10.379" class="difflineplus">+        return RNP_ERROR_NULL_POINTER;</span>
<a href="#l10.380"></a><span id="l10.380" class="difflineplus">+    }</span>
<a href="#l10.381"></a><span id="l10.381" class="difflineplus">+    return get_map_value(aead_alg_map, ARRAY_SIZE(aead_alg_map), symenc-&gt;aalg, alg);</span>
<a href="#l10.382"></a><span id="l10.382" class="difflineplus">+}</span>
<a href="#l10.383"></a><span id="l10.383" class="difflineplus">+</span>
<a href="#l10.384"></a><span id="l10.384" class="difflineplus">+rnp_result_t</span>
<a href="#l10.385"></a><span id="l10.385" class="difflineplus">+rnp_symenc_get_hash_alg(rnp_symenc_handle_t symenc, char **alg)</span>
<a href="#l10.386"></a><span id="l10.386" class="difflineplus">+{</span>
<a href="#l10.387"></a><span id="l10.387" class="difflineplus">+    if (!symenc || !alg) {</span>
<a href="#l10.388"></a><span id="l10.388" class="difflineplus">+        return RNP_ERROR_NULL_POINTER;</span>
<a href="#l10.389"></a><span id="l10.389" class="difflineplus">+    }</span>
<a href="#l10.390"></a><span id="l10.390" class="difflineplus">+    return get_map_value(hash_alg_map, ARRAY_SIZE(hash_alg_map), symenc-&gt;halg, alg);</span>
<a href="#l10.391"></a><span id="l10.391" class="difflineplus">+}</span>
<a href="#l10.392"></a><span id="l10.392" class="difflineplus">+</span>
<a href="#l10.393"></a><span id="l10.393" class="difflineplus">+rnp_result_t</span>
<a href="#l10.394"></a><span id="l10.394" class="difflineplus">+rnp_symenc_get_s2k_type(rnp_symenc_handle_t symenc, char **type)</span>
<a href="#l10.395"></a><span id="l10.395" class="difflineplus">+{</span>
<a href="#l10.396"></a><span id="l10.396" class="difflineplus">+    if (!symenc || !type) {</span>
<a href="#l10.397"></a><span id="l10.397" class="difflineplus">+        return RNP_ERROR_NULL_POINTER;</span>
<a href="#l10.398"></a><span id="l10.398" class="difflineplus">+    }</span>
<a href="#l10.399"></a><span id="l10.399" class="difflineplus">+    return get_map_value(s2k_type_map, ARRAY_SIZE(s2k_type_map), symenc-&gt;s2k_type, type);</span>
<a href="#l10.400"></a><span id="l10.400" class="difflineplus">+}</span>
<a href="#l10.401"></a><span id="l10.401" class="difflineplus">+</span>
<a href="#l10.402"></a><span id="l10.402" class="difflineplus">+rnp_result_t</span>
<a href="#l10.403"></a><span id="l10.403" class="difflineplus">+rnp_symenc_get_s2k_iterations(rnp_symenc_handle_t symenc, uint32_t *iterations)</span>
<a href="#l10.404"></a><span id="l10.404" class="difflineplus">+{</span>
<a href="#l10.405"></a><span id="l10.405" class="difflineplus">+    if (!symenc || !iterations) {</span>
<a href="#l10.406"></a><span id="l10.406" class="difflineplus">+        return RNP_ERROR_NULL_POINTER;</span>
<a href="#l10.407"></a><span id="l10.407" class="difflineplus">+    }</span>
<a href="#l10.408"></a><span id="l10.408" class="difflineplus">+    *iterations = symenc-&gt;iterations;</span>
<a href="#l10.409"></a><span id="l10.409" class="difflineplus">+    return RNP_SUCCESS;</span>
<a href="#l10.410"></a><span id="l10.410" class="difflineplus">+}</span>
<a href="#l10.411"></a><span id="l10.411" class="difflineplus">+</span>
<a href="#l10.412"></a><span id="l10.412"> rnp_result_t</span>
<a href="#l10.413"></a><span id="l10.413"> rnp_op_verify_destroy(rnp_op_verify_t op)</span>
<a href="#l10.414"></a><span id="l10.414"> {</span>
<a href="#l10.415"></a><span id="l10.415">     if (op) {</span>
<a href="#l10.416"></a><span id="l10.416">         rnp_ctx_free(&amp;op-&gt;rnpctx);</span>
<a href="#l10.417"></a><span id="l10.417">         for (size_t i = 0; i &lt; op-&gt;signature_count; i++) {</span>
<a href="#l10.418"></a><span id="l10.418">             free_signature(&amp;op-&gt;signatures[i].sig_pkt);</span>
<a href="#l10.419"></a><span id="l10.419">         }</span>
<a href="#l10.420"></a><span id="l10.420">         free(op-&gt;signatures);</span>
<a href="#l10.421"></a><span id="l10.421">         free(op-&gt;filename);</span>
<a href="#l10.422"></a><span id="l10.422" class="difflineplus">+        free(op-&gt;recipients);</span>
<a href="#l10.423"></a><span id="l10.423" class="difflineplus">+        free(op-&gt;used_recipient);</span>
<a href="#l10.424"></a><span id="l10.424" class="difflineplus">+        free(op-&gt;symencs);</span>
<a href="#l10.425"></a><span id="l10.425" class="difflineplus">+        free(op-&gt;used_symenc);</span>
<a href="#l10.426"></a><span id="l10.426">         free(op);</span>
<a href="#l10.427"></a><span id="l10.427">     }</span>
<a href="#l10.428"></a><span id="l10.428">     return RNP_SUCCESS;</span>
<a href="#l10.429"></a><span id="l10.429"> }</span>
<a href="#l10.430"></a><span id="l10.430"> </span>
<a href="#l10.431"></a><span id="l10.431"> rnp_result_t</span>
<a href="#l10.432"></a><span id="l10.432"> rnp_op_verify_signature_get_status(rnp_op_verify_signature_t sig)</span>
<a href="#l10.433"></a><span id="l10.433"> {</span>
<a href="#l10.434"></a><span id="l10.434" class="difflineat">@@ -2832,24 +3168,17 @@ rnp_op_verify_signature_get_handle(rnp_o</span>
<a href="#l10.435"></a><span id="l10.435"> }</span>
<a href="#l10.436"></a><span id="l10.436"> </span>
<a href="#l10.437"></a><span id="l10.437"> rnp_result_t</span>
<a href="#l10.438"></a><span id="l10.438"> rnp_op_verify_signature_get_hash(rnp_op_verify_signature_t sig, char **hash)</span>
<a href="#l10.439"></a><span id="l10.439"> {</span>
<a href="#l10.440"></a><span id="l10.440">     if (!sig || !hash) {</span>
<a href="#l10.441"></a><span id="l10.441">         return RNP_ERROR_NULL_POINTER;</span>
<a href="#l10.442"></a><span id="l10.442">     }</span>
<a href="#l10.443"></a><span id="l10.443" class="difflineminus">-</span>
<a href="#l10.444"></a><span id="l10.444" class="difflineminus">-    const char *hname = NULL;</span>
<a href="#l10.445"></a><span id="l10.445" class="difflineminus">-    ARRAY_LOOKUP_BY_ID(hash_alg_map, type, string, sig-&gt;sig_pkt.halg, hname);</span>
<a href="#l10.446"></a><span id="l10.446" class="difflineminus">-    if (hname) {</span>
<a href="#l10.447"></a><span id="l10.447" class="difflineminus">-        *hash = strdup(hname);</span>
<a href="#l10.448"></a><span id="l10.448" class="difflineminus">-        return RNP_SUCCESS;</span>
<a href="#l10.449"></a><span id="l10.449" class="difflineminus">-    }</span>
<a href="#l10.450"></a><span id="l10.450" class="difflineminus">-    return RNP_ERROR_BAD_STATE;</span>
<a href="#l10.451"></a><span id="l10.451" class="difflineplus">+    return get_map_value(hash_alg_map, ARRAY_SIZE(hash_alg_map), sig-&gt;sig_pkt.halg, hash);</span>
<a href="#l10.452"></a><span id="l10.452"> }</span>
<a href="#l10.453"></a><span id="l10.453"> </span>
<a href="#l10.454"></a><span id="l10.454"> rnp_result_t</span>
<a href="#l10.455"></a><span id="l10.455"> rnp_op_verify_signature_get_key(rnp_op_verify_signature_t sig, rnp_key_handle_t *key)</span>
<a href="#l10.456"></a><span id="l10.456"> {</span>
<a href="#l10.457"></a><span id="l10.457">     rnp_ffi_t        ffi = sig-&gt;ffi;</span>
<a href="#l10.458"></a><span id="l10.458">     pgp_key_search_t search;</span>
<a href="#l10.459"></a><span id="l10.459"> </span>
<a href="#l10.460"></a><span id="l10.460" class="difflineat">@@ -3330,38 +3659,60 @@ rnp_key_revoke(</span>
<a href="#l10.461"></a><span id="l10.461"> }</span>
<a href="#l10.462"></a><span id="l10.462"> </span>
<a href="#l10.463"></a><span id="l10.463"> rnp_result_t</span>
<a href="#l10.464"></a><span id="l10.464"> rnp_key_remove(rnp_key_handle_t key, uint32_t flags)</span>
<a href="#l10.465"></a><span id="l10.465"> {</span>
<a href="#l10.466"></a><span id="l10.466">     if (!key || !key-&gt;ffi) {</span>
<a href="#l10.467"></a><span id="l10.467">         return RNP_ERROR_NULL_POINTER;</span>
<a href="#l10.468"></a><span id="l10.468">     }</span>
<a href="#l10.469"></a><span id="l10.469" class="difflineminus">-    if (flags == 0) {</span>
<a href="#l10.470"></a><span id="l10.470" class="difflineplus">+    bool pub = false;</span>
<a href="#l10.471"></a><span id="l10.471" class="difflineplus">+    if (flags &amp; RNP_KEY_REMOVE_PUBLIC) {</span>
<a href="#l10.472"></a><span id="l10.472" class="difflineplus">+        pub = true;</span>
<a href="#l10.473"></a><span id="l10.473" class="difflineplus">+        flags &amp;= ~RNP_KEY_REMOVE_PUBLIC;</span>
<a href="#l10.474"></a><span id="l10.474" class="difflineplus">+    }</span>
<a href="#l10.475"></a><span id="l10.475" class="difflineplus">+    bool sec = false;</span>
<a href="#l10.476"></a><span id="l10.476" class="difflineplus">+    if (flags &amp; RNP_KEY_REMOVE_SECRET) {</span>
<a href="#l10.477"></a><span id="l10.477" class="difflineplus">+        sec = true;</span>
<a href="#l10.478"></a><span id="l10.478" class="difflineplus">+        flags &amp;= ~RNP_KEY_REMOVE_SECRET;</span>
<a href="#l10.479"></a><span id="l10.479" class="difflineplus">+    }</span>
<a href="#l10.480"></a><span id="l10.480" class="difflineplus">+    bool sub = false;</span>
<a href="#l10.481"></a><span id="l10.481" class="difflineplus">+    if (flags &amp; RNP_KEY_REMOVE_SUBKEYS) {</span>
<a href="#l10.482"></a><span id="l10.482" class="difflineplus">+        sub = true;</span>
<a href="#l10.483"></a><span id="l10.483" class="difflineplus">+        flags &amp;= ~RNP_KEY_REMOVE_SUBKEYS;</span>
<a href="#l10.484"></a><span id="l10.484" class="difflineplus">+    }</span>
<a href="#l10.485"></a><span id="l10.485" class="difflineplus">+    if (flags) {</span>
<a href="#l10.486"></a><span id="l10.486" class="difflineplus">+        FFI_LOG(key-&gt;ffi, &quot;Unknown flags: %&quot; PRIu32, flags);</span>
<a href="#l10.487"></a><span id="l10.487">         return RNP_ERROR_BAD_PARAMETERS;</span>
<a href="#l10.488"></a><span id="l10.488">     }</span>
<a href="#l10.489"></a><span id="l10.489" class="difflineminus">-    if (flags &amp; RNP_KEY_REMOVE_PUBLIC) {</span>
<a href="#l10.490"></a><span id="l10.490" class="difflineplus">+    if (!pub &amp;&amp; !sec) {</span>
<a href="#l10.491"></a><span id="l10.491" class="difflineplus">+        return RNP_ERROR_BAD_PARAMETERS;</span>
<a href="#l10.492"></a><span id="l10.492" class="difflineplus">+    }</span>
<a href="#l10.493"></a><span id="l10.493" class="difflineplus">+    if (sub &amp;&amp; pgp_key_is_subkey(get_key_prefer_public(key))) {</span>
<a href="#l10.494"></a><span id="l10.494" class="difflineplus">+        return RNP_ERROR_BAD_PARAMETERS;</span>
<a href="#l10.495"></a><span id="l10.495" class="difflineplus">+    }</span>
<a href="#l10.496"></a><span id="l10.496" class="difflineplus">+</span>
<a href="#l10.497"></a><span id="l10.497" class="difflineplus">+    if (pub) {</span>
<a href="#l10.498"></a><span id="l10.498">         if (!key-&gt;ffi-&gt;pubring || !key-&gt;pub) {</span>
<a href="#l10.499"></a><span id="l10.499">             return RNP_ERROR_BAD_PARAMETERS;</span>
<a href="#l10.500"></a><span id="l10.500">         }</span>
<a href="#l10.501"></a><span id="l10.501" class="difflineminus">-        if (!rnp_key_store_remove_key(key-&gt;ffi-&gt;pubring, key-&gt;pub)) {</span>
<a href="#l10.502"></a><span id="l10.502" class="difflineplus">+        if (!rnp_key_store_remove_key(key-&gt;ffi-&gt;pubring, key-&gt;pub, sub)) {</span>
<a href="#l10.503"></a><span id="l10.503">             return RNP_ERROR_KEY_NOT_FOUND;</span>
<a href="#l10.504"></a><span id="l10.504">         }</span>
<a href="#l10.505"></a><span id="l10.505">         key-&gt;pub = NULL;</span>
<a href="#l10.506"></a><span id="l10.506">     }</span>
<a href="#l10.507"></a><span id="l10.507" class="difflineminus">-    if (flags &amp; RNP_KEY_REMOVE_SECRET) {</span>
<a href="#l10.508"></a><span id="l10.508" class="difflineplus">+    if (sec) {</span>
<a href="#l10.509"></a><span id="l10.509">         if (!key-&gt;ffi-&gt;secring || !key-&gt;sec) {</span>
<a href="#l10.510"></a><span id="l10.510">             return RNP_ERROR_BAD_PARAMETERS;</span>
<a href="#l10.511"></a><span id="l10.511">         }</span>
<a href="#l10.512"></a><span id="l10.512" class="difflineminus">-        if (!rnp_key_store_remove_key(key-&gt;ffi-&gt;secring, key-&gt;sec)) {</span>
<a href="#l10.513"></a><span id="l10.513" class="difflineplus">+        if (!rnp_key_store_remove_key(key-&gt;ffi-&gt;secring, key-&gt;sec, sub)) {</span>
<a href="#l10.514"></a><span id="l10.514">             return RNP_ERROR_KEY_NOT_FOUND;</span>
<a href="#l10.515"></a><span id="l10.515">         }</span>
<a href="#l10.516"></a><span id="l10.516">         key-&gt;sec = NULL;</span>
<a href="#l10.517"></a><span id="l10.517">     }</span>
<a href="#l10.518"></a><span id="l10.518" class="difflineminus">-</span>
<a href="#l10.519"></a><span id="l10.519">     return RNP_SUCCESS;</span>
<a href="#l10.520"></a><span id="l10.520"> }</span>
<a href="#l10.521"></a><span id="l10.521"> </span>
<a href="#l10.522"></a><span id="l10.522"> static bool</span>
<a href="#l10.523"></a><span id="l10.523"> pk_alg_allows_custom_curve(pgp_pubkey_alg_t pkalg)</span>
<a href="#l10.524"></a><span id="l10.524"> {</span>
<a href="#l10.525"></a><span id="l10.525">     switch (pkalg) {</span>
<a href="#l10.526"></a><span id="l10.526">     case PGP_PKA_ECDH:</span>
<a href="#l10.527"></a><span id="l10.527" class="difflineat">@@ -4683,21 +5034,21 @@ rnp_op_generate_execute(rnp_op_generate_</span>
<a href="#l10.528"></a><span id="l10.528">     ret = RNP_SUCCESS;</span>
<a href="#l10.529"></a><span id="l10.529"> done:</span>
<a href="#l10.530"></a><span id="l10.530">     if (op-&gt;password) {</span>
<a href="#l10.531"></a><span id="l10.531">         pgp_forget(op-&gt;password, strlen(op-&gt;password) + 1);</span>
<a href="#l10.532"></a><span id="l10.532">         free(op-&gt;password);</span>
<a href="#l10.533"></a><span id="l10.533">         op-&gt;password = NULL;</span>
<a href="#l10.534"></a><span id="l10.534">     }</span>
<a href="#l10.535"></a><span id="l10.535">     if (ret &amp;&amp; op-&gt;gen_pub) {</span>
<a href="#l10.536"></a><span id="l10.536" class="difflineminus">-        rnp_key_store_remove_key(op-&gt;ffi-&gt;pubring, op-&gt;gen_pub);</span>
<a href="#l10.537"></a><span id="l10.537" class="difflineplus">+        rnp_key_store_remove_key(op-&gt;ffi-&gt;pubring, op-&gt;gen_pub, false);</span>
<a href="#l10.538"></a><span id="l10.538">         op-&gt;gen_pub = NULL;</span>
<a href="#l10.539"></a><span id="l10.539">     }</span>
<a href="#l10.540"></a><span id="l10.540">     if (ret &amp;&amp; op-&gt;gen_sec) {</span>
<a href="#l10.541"></a><span id="l10.541" class="difflineminus">-        rnp_key_store_remove_key(op-&gt;ffi-&gt;secring, op-&gt;gen_sec);</span>
<a href="#l10.542"></a><span id="l10.542" class="difflineplus">+        rnp_key_store_remove_key(op-&gt;ffi-&gt;secring, op-&gt;gen_sec, false);</span>
<a href="#l10.543"></a><span id="l10.543">         op-&gt;gen_sec = NULL;</span>
<a href="#l10.544"></a><span id="l10.544">     }</span>
<a href="#l10.545"></a><span id="l10.545">     return ret;</span>
<a href="#l10.546"></a><span id="l10.546"> }</span>
<a href="#l10.547"></a><span id="l10.547"> </span>
<a href="#l10.548"></a><span id="l10.548"> rnp_result_t</span>
<a href="#l10.549"></a><span id="l10.549"> rnp_op_generate_get_key(rnp_op_generate_t op, rnp_key_handle_t *handle)</span>
<a href="#l10.550"></a><span id="l10.550"> {</span>
<a href="#l10.551"></a><span id="l10.551" class="difflineat">@@ -5043,51 +5394,30 @@ rnp_result_t</span>
<a href="#l10.552"></a><span id="l10.552"> rnp_signature_get_alg(rnp_signature_handle_t handle, char **alg)</span>
<a href="#l10.553"></a><span id="l10.553"> {</span>
<a href="#l10.554"></a><span id="l10.554">     if (!handle || !alg) {</span>
<a href="#l10.555"></a><span id="l10.555">         return RNP_ERROR_NULL_POINTER;</span>
<a href="#l10.556"></a><span id="l10.556">     }</span>
<a href="#l10.557"></a><span id="l10.557">     if (!handle-&gt;sig) {</span>
<a href="#l10.558"></a><span id="l10.558">         return RNP_ERROR_BAD_PARAMETERS;</span>
<a href="#l10.559"></a><span id="l10.559">     }</span>
<a href="#l10.560"></a><span id="l10.560" class="difflineminus">-    const char *str = NULL;</span>
<a href="#l10.561"></a><span id="l10.561" class="difflineminus">-    ARRAY_LOOKUP_BY_ID(pubkey_alg_map, type, string, handle-&gt;sig-&gt;sig.palg, str);</span>
<a href="#l10.562"></a><span id="l10.562" class="difflineminus">-    if (!str) {</span>
<a href="#l10.563"></a><span id="l10.563" class="difflineminus">-        return RNP_ERROR_BAD_PARAMETERS;</span>
<a href="#l10.564"></a><span id="l10.564" class="difflineminus">-    }</span>
<a href="#l10.565"></a><span id="l10.565" class="difflineminus">-    char *algcp = strdup(str);</span>
<a href="#l10.566"></a><span id="l10.566" class="difflineminus">-    if (!algcp) {</span>
<a href="#l10.567"></a><span id="l10.567" class="difflineminus">-        return RNP_ERROR_OUT_OF_MEMORY;</span>
<a href="#l10.568"></a><span id="l10.568" class="difflineminus">-    }</span>
<a href="#l10.569"></a><span id="l10.569" class="difflineminus">-</span>
<a href="#l10.570"></a><span id="l10.570" class="difflineminus">-    *alg = algcp;</span>
<a href="#l10.571"></a><span id="l10.571" class="difflineminus">-    return RNP_SUCCESS;</span>
<a href="#l10.572"></a><span id="l10.572" class="difflineplus">+    return get_map_value(</span>
<a href="#l10.573"></a><span id="l10.573" class="difflineplus">+      pubkey_alg_map, ARRAY_SIZE(pubkey_alg_map), handle-&gt;sig-&gt;sig.palg, alg);</span>
<a href="#l10.574"></a><span id="l10.574"> }</span>
<a href="#l10.575"></a><span id="l10.575"> </span>
<a href="#l10.576"></a><span id="l10.576"> rnp_result_t</span>
<a href="#l10.577"></a><span id="l10.577"> rnp_signature_get_hash_alg(rnp_signature_handle_t handle, char **alg)</span>
<a href="#l10.578"></a><span id="l10.578"> {</span>
<a href="#l10.579"></a><span id="l10.579">     if (!handle || !alg) {</span>
<a href="#l10.580"></a><span id="l10.580">         return RNP_ERROR_NULL_POINTER;</span>
<a href="#l10.581"></a><span id="l10.581">     }</span>
<a href="#l10.582"></a><span id="l10.582">     if (!handle-&gt;sig) {</span>
<a href="#l10.583"></a><span id="l10.583">         return RNP_ERROR_BAD_PARAMETERS;</span>
<a href="#l10.584"></a><span id="l10.584">     }</span>
<a href="#l10.585"></a><span id="l10.585" class="difflineminus">-    const char *str = NULL;</span>
<a href="#l10.586"></a><span id="l10.586" class="difflineminus">-    ARRAY_LOOKUP_BY_ID(hash_alg_map, type, string, handle-&gt;sig-&gt;sig.halg, str);</span>
<a href="#l10.587"></a><span id="l10.587" class="difflineminus">-    if (!str) {</span>
<a href="#l10.588"></a><span id="l10.588" class="difflineminus">-        return RNP_ERROR_BAD_PARAMETERS;</span>
<a href="#l10.589"></a><span id="l10.589" class="difflineminus">-    }</span>
<a href="#l10.590"></a><span id="l10.590" class="difflineminus">-    char *algcp = strdup(str);</span>
<a href="#l10.591"></a><span id="l10.591" class="difflineminus">-    if (!algcp) {</span>
<a href="#l10.592"></a><span id="l10.592" class="difflineminus">-        return RNP_ERROR_OUT_OF_MEMORY;</span>
<a href="#l10.593"></a><span id="l10.593" class="difflineminus">-    }</span>
<a href="#l10.594"></a><span id="l10.594" class="difflineminus">-</span>
<a href="#l10.595"></a><span id="l10.595" class="difflineminus">-    *alg = algcp;</span>
<a href="#l10.596"></a><span id="l10.596" class="difflineminus">-    return RNP_SUCCESS;</span>
<a href="#l10.597"></a><span id="l10.597" class="difflineplus">+    return get_map_value(hash_alg_map, ARRAY_SIZE(hash_alg_map), handle-&gt;sig-&gt;sig.halg, alg);</span>
<a href="#l10.598"></a><span id="l10.598"> }</span>
<a href="#l10.599"></a><span id="l10.599"> </span>
<a href="#l10.600"></a><span id="l10.600"> rnp_result_t</span>
<a href="#l10.601"></a><span id="l10.601"> rnp_signature_get_creation(rnp_signature_handle_t handle, uint32_t *create)</span>
<a href="#l10.602"></a><span id="l10.602"> {</span>
<a href="#l10.603"></a><span id="l10.603">     if (!handle || !create) {</span>
<a href="#l10.604"></a><span id="l10.604">         return RNP_ERROR_NULL_POINTER;</span>
<a href="#l10.605"></a><span id="l10.605">     }</span>
<a href="#l10.606"></a><span id="l10.606" class="difflineat">@@ -5108,28 +5438,17 @@ rnp_signature_get_keyid(rnp_signature_ha</span>
<a href="#l10.607"></a><span id="l10.607">         return RNP_ERROR_BAD_PARAMETERS;</span>
<a href="#l10.608"></a><span id="l10.608">     }</span>
<a href="#l10.609"></a><span id="l10.609">     uint8_t keyid[PGP_KEY_ID_SIZE] = {0};</span>
<a href="#l10.610"></a><span id="l10.610">     if (!signature_get_keyid(&amp;handle-&gt;sig-&gt;sig, keyid)) {</span>
<a href="#l10.611"></a><span id="l10.611">         *result = NULL;</span>
<a href="#l10.612"></a><span id="l10.612">         return RNP_SUCCESS;</span>
<a href="#l10.613"></a><span id="l10.613">     }</span>
<a href="#l10.614"></a><span id="l10.614"> </span>
<a href="#l10.615"></a><span id="l10.615" class="difflineminus">-    size_t hex_len = PGP_KEY_ID_SIZE * 2 + 1;</span>
<a href="#l10.616"></a><span id="l10.616" class="difflineminus">-    *result = (char *) malloc(hex_len);</span>
<a href="#l10.617"></a><span id="l10.617" class="difflineminus">-    if (!*result) {</span>
<a href="#l10.618"></a><span id="l10.618" class="difflineminus">-        return RNP_ERROR_OUT_OF_MEMORY;</span>
<a href="#l10.619"></a><span id="l10.619" class="difflineminus">-    }</span>
<a href="#l10.620"></a><span id="l10.620" class="difflineminus">-</span>
<a href="#l10.621"></a><span id="l10.621" class="difflineminus">-    if (!rnp_hex_encode(keyid, PGP_KEY_ID_SIZE, *result, hex_len, RNP_HEX_UPPERCASE)) {</span>
<a href="#l10.622"></a><span id="l10.622" class="difflineminus">-        free(*result);</span>
<a href="#l10.623"></a><span id="l10.623" class="difflineminus">-        *result = NULL;</span>
<a href="#l10.624"></a><span id="l10.624" class="difflineminus">-        return RNP_ERROR_GENERIC;</span>
<a href="#l10.625"></a><span id="l10.625" class="difflineminus">-    }</span>
<a href="#l10.626"></a><span id="l10.626" class="difflineminus">-    return RNP_SUCCESS;</span>
<a href="#l10.627"></a><span id="l10.627" class="difflineplus">+    return hex_encode_value(keyid, PGP_KEY_ID_SIZE, result, RNP_HEX_UPPERCASE);</span>
<a href="#l10.628"></a><span id="l10.628"> }</span>
<a href="#l10.629"></a><span id="l10.629"> </span>
<a href="#l10.630"></a><span id="l10.630"> rnp_result_t</span>
<a href="#l10.631"></a><span id="l10.631"> rnp_signature_get_signer(rnp_signature_handle_t sig, rnp_key_handle_t *key)</span>
<a href="#l10.632"></a><span id="l10.632"> {</span>
<a href="#l10.633"></a><span id="l10.633">     char *       keyid = NULL;</span>
<a href="#l10.634"></a><span id="l10.634">     rnp_result_t ret = rnp_signature_get_keyid(sig, &amp;keyid);</span>
<a href="#l10.635"></a><span id="l10.635">     if (ret) {</span>
<a href="#l10.636"></a><span id="l10.636" class="difflineat">@@ -5238,31 +5557,19 @@ rnp_key_get_subkey_at(rnp_key_handle_t h</span>
<a href="#l10.637"></a><span id="l10.637"> }</span>
<a href="#l10.638"></a><span id="l10.638"> </span>
<a href="#l10.639"></a><span id="l10.639"> rnp_result_t</span>
<a href="#l10.640"></a><span id="l10.640"> rnp_key_get_alg(rnp_key_handle_t handle, char **alg)</span>
<a href="#l10.641"></a><span id="l10.641"> {</span>
<a href="#l10.642"></a><span id="l10.642">     if (!handle || !alg) {</span>
<a href="#l10.643"></a><span id="l10.643">         return RNP_ERROR_NULL_POINTER;</span>
<a href="#l10.644"></a><span id="l10.644">     }</span>
<a href="#l10.645"></a><span id="l10.645" class="difflineminus">-    pgp_key_t * key = get_key_prefer_public(handle);</span>
<a href="#l10.646"></a><span id="l10.646" class="difflineminus">-    const char *str = NULL;</span>
<a href="#l10.647"></a><span id="l10.647" class="difflineminus">-</span>
<a href="#l10.648"></a><span id="l10.648" class="difflineminus">-    ARRAY_LOOKUP_BY_ID(pubkey_alg_map, type, string, pgp_key_get_alg(key), str);</span>
<a href="#l10.649"></a><span id="l10.649" class="difflineminus">-    if (!str) {</span>
<a href="#l10.650"></a><span id="l10.650" class="difflineminus">-        return RNP_ERROR_BAD_PARAMETERS;</span>
<a href="#l10.651"></a><span id="l10.651" class="difflineminus">-    }</span>
<a href="#l10.652"></a><span id="l10.652" class="difflineminus">-</span>
<a href="#l10.653"></a><span id="l10.653" class="difflineminus">-    char *algcp = strdup(str);</span>
<a href="#l10.654"></a><span id="l10.654" class="difflineminus">-    if (!algcp) {</span>
<a href="#l10.655"></a><span id="l10.655" class="difflineminus">-        return RNP_ERROR_OUT_OF_MEMORY;</span>
<a href="#l10.656"></a><span id="l10.656" class="difflineminus">-    }</span>
<a href="#l10.657"></a><span id="l10.657" class="difflineminus">-</span>
<a href="#l10.658"></a><span id="l10.658" class="difflineminus">-    *alg = algcp;</span>
<a href="#l10.659"></a><span id="l10.659" class="difflineminus">-    return RNP_SUCCESS;</span>
<a href="#l10.660"></a><span id="l10.660" class="difflineplus">+    pgp_key_t *key = get_key_prefer_public(handle);</span>
<a href="#l10.661"></a><span id="l10.661" class="difflineplus">+    return get_map_value(</span>
<a href="#l10.662"></a><span id="l10.662" class="difflineplus">+      pubkey_alg_map, ARRAY_SIZE(pubkey_alg_map), pgp_key_get_alg(key), alg);</span>
<a href="#l10.663"></a><span id="l10.663"> }</span>
<a href="#l10.664"></a><span id="l10.664"> </span>
<a href="#l10.665"></a><span id="l10.665"> rnp_result_t</span>
<a href="#l10.666"></a><span id="l10.666"> rnp_key_get_bits(rnp_key_handle_t handle, uint32_t *bits)</span>
<a href="#l10.667"></a><span id="l10.667"> {</span>
<a href="#l10.668"></a><span id="l10.668">     if (!handle || !bits) {</span>
<a href="#l10.669"></a><span id="l10.669">         return RNP_ERROR_NULL_POINTER;</span>
<a href="#l10.670"></a><span id="l10.670">     }</span>
<a href="#l10.671"></a><span id="l10.671" class="difflineat">@@ -5311,105 +5618,63 @@ rnp_key_get_curve(rnp_key_handle_t handl</span>
<a href="#l10.672"></a><span id="l10.672">     }</span>
<a href="#l10.673"></a><span id="l10.673">     *curve = curvenamecp;</span>
<a href="#l10.674"></a><span id="l10.674">     return RNP_SUCCESS;</span>
<a href="#l10.675"></a><span id="l10.675"> }</span>
<a href="#l10.676"></a><span id="l10.676"> </span>
<a href="#l10.677"></a><span id="l10.677"> rnp_result_t</span>
<a href="#l10.678"></a><span id="l10.678"> rnp_key_get_fprint(rnp_key_handle_t handle, char **fprint)</span>
<a href="#l10.679"></a><span id="l10.679"> {</span>
<a href="#l10.680"></a><span id="l10.680" class="difflineminus">-    if (handle == NULL || fprint == NULL)</span>
<a href="#l10.681"></a><span id="l10.681" class="difflineminus">-        return RNP_ERROR_NULL_POINTER;</span>
<a href="#l10.682"></a><span id="l10.682" class="difflineminus">-</span>
<a href="#l10.683"></a><span id="l10.683" class="difflineminus">-    size_t hex_len = PGP_FINGERPRINT_HEX_SIZE + 1;</span>
<a href="#l10.684"></a><span id="l10.684" class="difflineminus">-    *fprint = (char *) malloc(hex_len);</span>
<a href="#l10.685"></a><span id="l10.685" class="difflineminus">-    if (*fprint == NULL)</span>
<a href="#l10.686"></a><span id="l10.686" class="difflineminus">-        return RNP_ERROR_OUT_OF_MEMORY;</span>
<a href="#l10.687"></a><span id="l10.687" class="difflineminus">-</span>
<a href="#l10.688"></a><span id="l10.688" class="difflineminus">-    pgp_key_t *key = get_key_prefer_public(handle);</span>
<a href="#l10.689"></a><span id="l10.689" class="difflineminus">-    if (!rnp_hex_encode(pgp_key_get_fp(key)-&gt;fingerprint,</span>
<a href="#l10.690"></a><span id="l10.690" class="difflineminus">-                        pgp_key_get_fp(key)-&gt;length,</span>
<a href="#l10.691"></a><span id="l10.691" class="difflineminus">-                        *fprint,</span>
<a href="#l10.692"></a><span id="l10.692" class="difflineminus">-                        hex_len,</span>
<a href="#l10.693"></a><span id="l10.693" class="difflineminus">-                        RNP_HEX_UPPERCASE)) {</span>
<a href="#l10.694"></a><span id="l10.694" class="difflineminus">-        return RNP_ERROR_GENERIC;</span>
<a href="#l10.695"></a><span id="l10.695" class="difflineminus">-    }</span>
<a href="#l10.696"></a><span id="l10.696" class="difflineminus">-    return RNP_SUCCESS;</span>
<a href="#l10.697"></a><span id="l10.697" class="difflineplus">+    if (!handle || !fprint) {</span>
<a href="#l10.698"></a><span id="l10.698" class="difflineplus">+        return RNP_ERROR_NULL_POINTER;</span>
<a href="#l10.699"></a><span id="l10.699" class="difflineplus">+    }</span>
<a href="#l10.700"></a><span id="l10.700" class="difflineplus">+</span>
<a href="#l10.701"></a><span id="l10.701" class="difflineplus">+    const pgp_fingerprint_t *fp = pgp_key_get_fp(get_key_prefer_public(handle));</span>
<a href="#l10.702"></a><span id="l10.702" class="difflineplus">+    return hex_encode_value(fp-&gt;fingerprint, fp-&gt;length, fprint, RNP_HEX_UPPERCASE);</span>
<a href="#l10.703"></a><span id="l10.703"> }</span>
<a href="#l10.704"></a><span id="l10.704"> </span>
<a href="#l10.705"></a><span id="l10.705"> rnp_result_t</span>
<a href="#l10.706"></a><span id="l10.706"> rnp_key_get_keyid(rnp_key_handle_t handle, char **keyid)</span>
<a href="#l10.707"></a><span id="l10.707"> {</span>
<a href="#l10.708"></a><span id="l10.708" class="difflineminus">-    if (handle == NULL || keyid == NULL)</span>
<a href="#l10.709"></a><span id="l10.709" class="difflineminus">-        return RNP_ERROR_NULL_POINTER;</span>
<a href="#l10.710"></a><span id="l10.710" class="difflineminus">-</span>
<a href="#l10.711"></a><span id="l10.711" class="difflineminus">-    size_t hex_len = PGP_KEY_ID_SIZE * 2 + 1;</span>
<a href="#l10.712"></a><span id="l10.712" class="difflineminus">-    *keyid = (char *) malloc(hex_len);</span>
<a href="#l10.713"></a><span id="l10.713" class="difflineminus">-    if (*keyid == NULL)</span>
<a href="#l10.714"></a><span id="l10.714" class="difflineminus">-        return RNP_ERROR_OUT_OF_MEMORY;</span>
<a href="#l10.715"></a><span id="l10.715" class="difflineplus">+    if (!handle || !keyid) {</span>
<a href="#l10.716"></a><span id="l10.716" class="difflineplus">+        return RNP_ERROR_NULL_POINTER;</span>
<a href="#l10.717"></a><span id="l10.717" class="difflineplus">+    }</span>
<a href="#l10.718"></a><span id="l10.718"> </span>
<a href="#l10.719"></a><span id="l10.719">     pgp_key_t *key = get_key_prefer_public(handle);</span>
<a href="#l10.720"></a><span id="l10.720" class="difflineminus">-    if (!rnp_hex_encode(</span>
<a href="#l10.721"></a><span id="l10.721" class="difflineminus">-          pgp_key_get_keyid(key), PGP_KEY_ID_SIZE, *keyid, hex_len, RNP_HEX_UPPERCASE)) {</span>
<a href="#l10.722"></a><span id="l10.722" class="difflineminus">-        return RNP_ERROR_GENERIC;</span>
<a href="#l10.723"></a><span id="l10.723" class="difflineminus">-    }</span>
<a href="#l10.724"></a><span id="l10.724" class="difflineminus">-    return RNP_SUCCESS;</span>
<a href="#l10.725"></a><span id="l10.725" class="difflineplus">+    return hex_encode_value(pgp_key_get_keyid(key), PGP_KEY_ID_SIZE, keyid, RNP_HEX_UPPERCASE);</span>
<a href="#l10.726"></a><span id="l10.726"> }</span>
<a href="#l10.727"></a><span id="l10.727"> </span>
<a href="#l10.728"></a><span id="l10.728"> rnp_result_t</span>
<a href="#l10.729"></a><span id="l10.729"> rnp_key_get_grip(rnp_key_handle_t handle, char **grip)</span>
<a href="#l10.730"></a><span id="l10.730"> {</span>
<a href="#l10.731"></a><span id="l10.731" class="difflineminus">-    if (handle == NULL || grip == NULL)</span>
<a href="#l10.732"></a><span id="l10.732" class="difflineminus">-        return RNP_ERROR_NULL_POINTER;</span>
<a href="#l10.733"></a><span id="l10.733" class="difflineminus">-</span>
<a href="#l10.734"></a><span id="l10.734" class="difflineminus">-    size_t hex_len = PGP_KEY_GRIP_SIZE * 2 + 1;</span>
<a href="#l10.735"></a><span id="l10.735" class="difflineminus">-    *grip = (char *) malloc(hex_len);</span>
<a href="#l10.736"></a><span id="l10.736" class="difflineminus">-    if (*grip == NULL)</span>
<a href="#l10.737"></a><span id="l10.737" class="difflineminus">-        return RNP_ERROR_OUT_OF_MEMORY;</span>
<a href="#l10.738"></a><span id="l10.738" class="difflineminus">-</span>
<a href="#l10.739"></a><span id="l10.739" class="difflineminus">-    pgp_key_t *key = get_key_prefer_public(handle);</span>
<a href="#l10.740"></a><span id="l10.740" class="difflineminus">-    if (!rnp_hex_encode(pgp_key_get_grip(key).data(),</span>
<a href="#l10.741"></a><span id="l10.741" class="difflineminus">-                        pgp_key_get_grip(key).size(),</span>
<a href="#l10.742"></a><span id="l10.742" class="difflineminus">-                        *grip,</span>
<a href="#l10.743"></a><span id="l10.743" class="difflineminus">-                        hex_len,</span>
<a href="#l10.744"></a><span id="l10.744" class="difflineminus">-                        RNP_HEX_UPPERCASE)) {</span>
<a href="#l10.745"></a><span id="l10.745" class="difflineminus">-        return RNP_ERROR_GENERIC;</span>
<a href="#l10.746"></a><span id="l10.746" class="difflineminus">-    }</span>
<a href="#l10.747"></a><span id="l10.747" class="difflineminus">-    return RNP_SUCCESS;</span>
<a href="#l10.748"></a><span id="l10.748" class="difflineplus">+    if (!handle || !grip) {</span>
<a href="#l10.749"></a><span id="l10.749" class="difflineplus">+        return RNP_ERROR_NULL_POINTER;</span>
<a href="#l10.750"></a><span id="l10.750" class="difflineplus">+    }</span>
<a href="#l10.751"></a><span id="l10.751" class="difflineplus">+</span>
<a href="#l10.752"></a><span id="l10.752" class="difflineplus">+    const pgp_key_grip_t &amp;kgrip = pgp_key_get_grip(get_key_prefer_public(handle));</span>
<a href="#l10.753"></a><span id="l10.753" class="difflineplus">+    return hex_encode_value(kgrip.data(), kgrip.size(), grip, RNP_HEX_UPPERCASE);</span>
<a href="#l10.754"></a><span id="l10.754"> }</span>
<a href="#l10.755"></a><span id="l10.755"> </span>
<a href="#l10.756"></a><span id="l10.756"> rnp_result_t</span>
<a href="#l10.757"></a><span id="l10.757"> rnp_key_get_primary_grip(rnp_key_handle_t handle, char **grip)</span>
<a href="#l10.758"></a><span id="l10.758"> {</span>
<a href="#l10.759"></a><span id="l10.759" class="difflineminus">-    if (handle == NULL || grip == NULL) {</span>
<a href="#l10.760"></a><span id="l10.760" class="difflineplus">+    if (!handle || !grip) {</span>
<a href="#l10.761"></a><span id="l10.761">         return RNP_ERROR_NULL_POINTER;</span>
<a href="#l10.762"></a><span id="l10.762">     }</span>
<a href="#l10.763"></a><span id="l10.763"> </span>
<a href="#l10.764"></a><span id="l10.764">     pgp_key_t *key = get_key_prefer_public(handle);</span>
<a href="#l10.765"></a><span id="l10.765">     if (!pgp_key_is_subkey(key)) {</span>
<a href="#l10.766"></a><span id="l10.766">         return RNP_ERROR_BAD_PARAMETERS;</span>
<a href="#l10.767"></a><span id="l10.767">     }</span>
<a href="#l10.768"></a><span id="l10.768">     if (!pgp_key_has_primary_grip(key)) {</span>
<a href="#l10.769"></a><span id="l10.769">         *grip = NULL;</span>
<a href="#l10.770"></a><span id="l10.770">         return RNP_SUCCESS;</span>
<a href="#l10.771"></a><span id="l10.771">     }</span>
<a href="#l10.772"></a><span id="l10.772" class="difflineminus">-    size_t hex_len = PGP_KEY_GRIP_SIZE * 2 + 1;</span>
<a href="#l10.773"></a><span id="l10.773" class="difflineminus">-    *grip = (char *) malloc(hex_len);</span>
<a href="#l10.774"></a><span id="l10.774" class="difflineminus">-    if (*grip == NULL) {</span>
<a href="#l10.775"></a><span id="l10.775" class="difflineminus">-        return RNP_ERROR_OUT_OF_MEMORY;</span>
<a href="#l10.776"></a><span id="l10.776" class="difflineminus">-    }</span>
<a href="#l10.777"></a><span id="l10.777" class="difflineminus">-    if (!rnp_hex_encode(pgp_key_get_primary_grip(key).data(),</span>
<a href="#l10.778"></a><span id="l10.778" class="difflineminus">-                        pgp_key_get_primary_grip(key).size(),</span>
<a href="#l10.779"></a><span id="l10.779" class="difflineminus">-                        *grip,</span>
<a href="#l10.780"></a><span id="l10.780" class="difflineminus">-                        hex_len,</span>
<a href="#l10.781"></a><span id="l10.781" class="difflineminus">-                        RNP_HEX_UPPERCASE)) {</span>
<a href="#l10.782"></a><span id="l10.782" class="difflineminus">-        free(*grip);</span>
<a href="#l10.783"></a><span id="l10.783" class="difflineminus">-        return RNP_ERROR_GENERIC;</span>
<a href="#l10.784"></a><span id="l10.784" class="difflineminus">-    }</span>
<a href="#l10.785"></a><span id="l10.785" class="difflineminus">-    return RNP_SUCCESS;</span>
<a href="#l10.786"></a><span id="l10.786" class="difflineplus">+    const pgp_key_grip_t &amp;pgrip = pgp_key_get_primary_grip(key);</span>
<a href="#l10.787"></a><span id="l10.787" class="difflineplus">+    return hex_encode_value(pgrip.data(), pgrip.size(), grip, RNP_HEX_UPPERCASE);</span>
<a href="#l10.788"></a><span id="l10.788"> }</span>
<a href="#l10.789"></a><span id="l10.789"> </span>
<a href="#l10.790"></a><span id="l10.790"> rnp_result_t</span>
<a href="#l10.791"></a><span id="l10.791"> rnp_key_allows_usage(rnp_key_handle_t handle, const char *usage, bool *result)</span>
<a href="#l10.792"></a><span id="l10.792"> {</span>
<a href="#l10.793"></a><span id="l10.793">     if (!handle || !usage || !result) {</span>
<a href="#l10.794"></a><span id="l10.794">         return RNP_ERROR_NULL_POINTER;</span>
<a href="#l10.795"></a><span id="l10.795">     }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/third_party/rnp/src/lib/utils.h</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/third_party/rnp/src/lib/utils.h</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -202,22 +202,16 @@ STORE64BE(uint8_t x[8], uint64_t y)</span>
<a href="#l11.4"></a><span id="l11.4">     x[6] = (uint8_t)(y &gt;&gt; 8) &amp; 0xff;</span>
<a href="#l11.5"></a><span id="l11.5">     x[7] = (uint8_t)(y &gt;&gt; 0) &amp; 0xff;</span>
<a href="#l11.6"></a><span id="l11.6"> }</span>
<a href="#l11.7"></a><span id="l11.7"> </span>
<a href="#l11.8"></a><span id="l11.8"> #ifndef MAX</span>
<a href="#l11.9"></a><span id="l11.9"> #define MAX(a, b) (((a) &gt; (b)) ? (a) : (b))</span>
<a href="#l11.10"></a><span id="l11.10"> #endif</span>
<a href="#l11.11"></a><span id="l11.11"> </span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-/* Macro _GLIBCXX_USE_CXX11_ABI was first introduced with GCC 5.0, which</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">- * we assume to be bundled with a sane implementation of std::regex. */</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineminus">-#if !defined(__GNUC__) || defined(_GLIBCXX_USE_CXX11_ABI)</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineminus">-#define RNP_USE_STD_REGEX 1</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineminus">-#endif</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineminus">-</span>
<a href="#l11.18"></a><span id="l11.18"> inline char *</span>
<a href="#l11.19"></a><span id="l11.19"> getenv_logname(void)</span>
<a href="#l11.20"></a><span id="l11.20"> {</span>
<a href="#l11.21"></a><span id="l11.21">     char *name = getenv(&quot;LOGNAME&quot;);</span>
<a href="#l11.22"></a><span id="l11.22">     if (!name) {</span>
<a href="#l11.23"></a><span id="l11.23">         name = getenv(&quot;USER&quot;);</span>
<a href="#l11.24"></a><span id="l11.24">     }</span>
<a href="#l11.25"></a><span id="l11.25">     return name;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/third_party/rnp/src/lib/version.h</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/third_party/rnp/src/lib/version.h</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -23,19 +23,19 @@</span>
<a href="#l12.4"></a><span id="l12.4">  * POSSIBILITY OF SUCH DAMAGE.</span>
<a href="#l12.5"></a><span id="l12.5">  */</span>
<a href="#l12.6"></a><span id="l12.6"> </span>
<a href="#l12.7"></a><span id="l12.7"> #define RNP_VERSION_MAJOR 0</span>
<a href="#l12.8"></a><span id="l12.8"> #define RNP_VERSION_MINOR 13</span>
<a href="#l12.9"></a><span id="l12.9"> #define RNP_VERSION_PATCH 1</span>
<a href="#l12.10"></a><span id="l12.10"> </span>
<a href="#l12.11"></a><span id="l12.11"> #define RNP_VERSION_STRING &quot;0.13.1&quot;</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-#define RNP_VERSION_STRING_FULL &quot;0.13.1+git20200609.b9335cee.MZLA&quot;</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+#define RNP_VERSION_STRING_FULL &quot;0.13.1+git20200619.ac070578.MZLA&quot;</span>
<a href="#l12.14"></a><span id="l12.14"> </span>
<a href="#l12.15"></a><span id="l12.15" class="difflineminus">-#define RNP_VERSION_COMMIT_TIMESTAMP 1591722904</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineplus">+#define RNP_VERSION_COMMIT_TIMESTAMP 1592576776</span>
<a href="#l12.17"></a><span id="l12.17"> </span>
<a href="#l12.18"></a><span id="l12.18"> // using a 32-bit version with 10 bits per component</span>
<a href="#l12.19"></a><span id="l12.19"> #define RNP_VERSION_COMPONENT_MASK 0x3ff</span>
<a href="#l12.20"></a><span id="l12.20"> #define RNP_VERSION_MAJOR_SHIFT 20</span>
<a href="#l12.21"></a><span id="l12.21"> #define RNP_VERSION_MINOR_SHIFT 10</span>
<a href="#l12.22"></a><span id="l12.22"> #define RNP_VERSION_PATCH_SHIFT 0</span>
<a href="#l12.23"></a><span id="l12.23"> #define RNP_VERSION_CODE_FOR(major, minor, patch)                        \</span>
<a href="#l12.24"></a><span id="l12.24">     (((major &amp; RNP_VERSION_COMPONENT_MASK) &lt;&lt; RNP_VERSION_MAJOR_SHIFT) | \</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/third_party/rnp/src/librekey/key_store_pgp.cpp</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/third_party/rnp/src/librekey/key_store_pgp.cpp</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -183,17 +183,17 @@ rnp_key_store_add_transferable_key(rnp_k</span>
<a href="#l13.4"></a><span id="l13.4">     }</span>
<a href="#l13.5"></a><span id="l13.5"> </span>
<a href="#l13.6"></a><span id="l13.6">     /* now validate/refresh the whole key with subkeys */</span>
<a href="#l13.7"></a><span id="l13.7">     keyring-&gt;disable_validation = false;</span>
<a href="#l13.8"></a><span id="l13.8">     pgp_key_revalidate_updated(addkey, keyring);</span>
<a href="#l13.9"></a><span id="l13.9">     return true;</span>
<a href="#l13.10"></a><span id="l13.10"> error:</span>
<a href="#l13.11"></a><span id="l13.11">     /* during key addition all fields are copied so will be cleaned below */</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-    rnp_key_store_remove_key(keyring, addkey);</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+    rnp_key_store_remove_key(keyring, addkey, false);</span>
<a href="#l13.14"></a><span id="l13.14">     return false;</span>
<a href="#l13.15"></a><span id="l13.15"> }</span>
<a href="#l13.16"></a><span id="l13.16"> </span>
<a href="#l13.17"></a><span id="l13.17"> bool</span>
<a href="#l13.18"></a><span id="l13.18"> rnp_key_from_transferable_key(pgp_key_t *key, pgp_transferable_key_t *tkey)</span>
<a href="#l13.19"></a><span id="l13.19"> {</span>
<a href="#l13.20"></a><span id="l13.20">     *key = {};</span>
<a href="#l13.21"></a><span id="l13.21">     /* create key */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/third_party/rnp/src/librekey/rnp_key_store.cpp</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/third_party/rnp/src/librekey/rnp_key_store.cpp</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -35,16 +35,17 @@</span>
<a href="#l14.4"></a><span id="l14.4"> #include &lt;assert.h&gt;</span>
<a href="#l14.5"></a><span id="l14.5"> #include &lt;stdio.h&gt;</span>
<a href="#l14.6"></a><span id="l14.6"> #include &lt;string.h&gt;</span>
<a href="#l14.7"></a><span id="l14.7"> #include &lt;stdint.h&gt;</span>
<a href="#l14.8"></a><span id="l14.8"> #include &lt;stdlib.h&gt;</span>
<a href="#l14.9"></a><span id="l14.9"> #include &lt;dirent.h&gt;</span>
<a href="#l14.10"></a><span id="l14.10"> #include &lt;errno.h&gt;</span>
<a href="#l14.11"></a><span id="l14.11"> #include &lt;algorithm&gt;</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineplus">+#include &lt;stdexcept&gt;</span>
<a href="#l14.13"></a><span id="l14.13"> </span>
<a href="#l14.14"></a><span id="l14.14"> #include &lt;rnp/rnp_sdk.h&gt;</span>
<a href="#l14.15"></a><span id="l14.15"> #include &lt;rekey/rnp_key_store.h&gt;</span>
<a href="#l14.16"></a><span id="l14.16"> #include &lt;librepgp/stream-packet.h&gt;</span>
<a href="#l14.17"></a><span id="l14.17"> </span>
<a href="#l14.18"></a><span id="l14.18"> #include &quot;key_store_pgp.h&quot;</span>
<a href="#l14.19"></a><span id="l14.19"> #include &quot;key_store_kbx.h&quot;</span>
<a href="#l14.20"></a><span id="l14.20"> #include &quot;key_store_g10.h&quot;</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineat">@@ -671,25 +672,50 @@ rnp_key_store_import_signature(rnp_key_s</span>
<a href="#l14.22"></a><span id="l14.22">         *status = PGP_SIG_IMPORT_STATUS_UNKNOWN_KEY;</span>
<a href="#l14.23"></a><span id="l14.23">         return NULL;</span>
<a href="#l14.24"></a><span id="l14.24">     }</span>
<a href="#l14.25"></a><span id="l14.25">     *status = rnp_key_store_import_key_signature(keyring, res_key, sig);</span>
<a href="#l14.26"></a><span id="l14.26">     return res_key;</span>
<a href="#l14.27"></a><span id="l14.27"> }</span>
<a href="#l14.28"></a><span id="l14.28"> </span>
<a href="#l14.29"></a><span id="l14.29"> bool</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineminus">-rnp_key_store_remove_key(rnp_key_store_t *keyring, const pgp_key_t *key)</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineplus">+rnp_key_store_remove_key(rnp_key_store_t *keyring, const pgp_key_t *key, bool subkeys)</span>
<a href="#l14.32"></a><span id="l14.32"> {</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineminus">-    keyring-&gt;keybygrip.erase(pgp_key_get_grip(key));</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineminus">-    size_t oldsize = keyring-&gt;keys.size();</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineminus">-    keyring-&gt;keys.erase(std::remove_if(keyring-&gt;keys.begin(),</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineminus">-                                       keyring-&gt;keys.end(),</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineminus">-                                       [key](pgp_key_t &amp;_key) { return key == &amp;_key; }));</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineplus">+    auto it = keyring-&gt;keybygrip.find(pgp_key_get_grip(key));</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineplus">+    if (it == keyring-&gt;keybygrip.end()) {</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineplus">+        return false;</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineplus">+    }</span>
<a href="#l14.42"></a><span id="l14.42"> </span>
<a href="#l14.43"></a><span id="l14.43" class="difflineminus">-    return oldsize != keyring-&gt;keys.size();</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineplus">+    /* cleanup primary_grip (or subkey)/subkey_grips */</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineplus">+    if (pgp_key_is_primary_key(key) &amp;&amp; pgp_key_get_subkey_count(key)) {</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineplus">+        for (size_t i = 0; i &lt; pgp_key_get_subkey_count(key); i++) {</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineplus">+            auto it = keyring-&gt;keybygrip.find(pgp_key_get_subkey_grip(key, i));</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineplus">+            if (it == keyring-&gt;keybygrip.end()) {</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineplus">+                continue;</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineplus">+            }</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineplus">+            /* if subkeys are deleted then no need to update grips */</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineplus">+            if (subkeys) {</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineplus">+                keyring-&gt;keys.erase(it-&gt;second);</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineplus">+                keyring-&gt;keybygrip.erase(it);</span>
<a href="#l14.55"></a><span id="l14.55" class="difflineplus">+                continue;</span>
<a href="#l14.56"></a><span id="l14.56" class="difflineplus">+            }</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineplus">+            it-&gt;second-&gt;primary_grip = {};</span>
<a href="#l14.58"></a><span id="l14.58" class="difflineplus">+            it-&gt;second-&gt;primary_grip_set = false;</span>
<a href="#l14.59"></a><span id="l14.59" class="difflineplus">+        }</span>
<a href="#l14.60"></a><span id="l14.60" class="difflineplus">+    }</span>
<a href="#l14.61"></a><span id="l14.61" class="difflineplus">+    if (pgp_key_is_subkey(key) &amp;&amp; pgp_key_has_primary_grip(key)) {</span>
<a href="#l14.62"></a><span id="l14.62" class="difflineplus">+        pgp_key_t *primary = rnp_key_store_get_primary_key(keyring, key);</span>
<a href="#l14.63"></a><span id="l14.63" class="difflineplus">+        if (primary) {</span>
<a href="#l14.64"></a><span id="l14.64" class="difflineplus">+            pgp_key_remove_subkey_grip(primary, pgp_key_get_grip(key));</span>
<a href="#l14.65"></a><span id="l14.65" class="difflineplus">+        }</span>
<a href="#l14.66"></a><span id="l14.66" class="difflineplus">+    }</span>
<a href="#l14.67"></a><span id="l14.67" class="difflineplus">+</span>
<a href="#l14.68"></a><span id="l14.68" class="difflineplus">+    keyring-&gt;keys.erase(it-&gt;second);</span>
<a href="#l14.69"></a><span id="l14.69" class="difflineplus">+    keyring-&gt;keybygrip.erase(it);</span>
<a href="#l14.70"></a><span id="l14.70" class="difflineplus">+    return true;</span>
<a href="#l14.71"></a><span id="l14.71"> }</span>
<a href="#l14.72"></a><span id="l14.72"> </span>
<a href="#l14.73"></a><span id="l14.73"> /**</span>
<a href="#l14.74"></a><span id="l14.74">    \ingroup HighLevel_KeyringFind</span>
<a href="#l14.75"></a><span id="l14.75"> </span>
<a href="#l14.76"></a><span id="l14.76">    \brief Finds key in keyring from its Key ID</span>
<a href="#l14.77"></a><span id="l14.77"> </span>
<a href="#l14.78"></a><span id="l14.78">    \param keyring Keyring to be searched</span>
<a href="#l14.79"></a><span id="l14.79" class="difflineat">@@ -726,22 +752,21 @@ rnp_key_store_get_key_by_id(rnp_key_stor</span>
<a href="#l14.80"></a><span id="l14.80">                  pgp_key_get_keyid(&amp;key) + PGP_KEY_ID_SIZE / 2, keyid, PGP_KEY_ID_SIZE / 2);</span>
<a href="#l14.81"></a><span id="l14.81">     });</span>
<a href="#l14.82"></a><span id="l14.82">     return (it == keyring-&gt;keys.end()) ? NULL : &amp;(*it);</span>
<a href="#l14.83"></a><span id="l14.83"> }</span>
<a href="#l14.84"></a><span id="l14.84"> </span>
<a href="#l14.85"></a><span id="l14.85"> const pgp_key_t *</span>
<a href="#l14.86"></a><span id="l14.86"> rnp_key_store_get_key_by_grip(const rnp_key_store_t *keyring, const pgp_key_grip_t &amp;grip)</span>
<a href="#l14.87"></a><span id="l14.87"> {</span>
<a href="#l14.88"></a><span id="l14.88" class="difflineminus">-    try {</span>
<a href="#l14.89"></a><span id="l14.89" class="difflineminus">-        return &amp;*keyring-&gt;keybygrip.at(grip);</span>
<a href="#l14.90"></a><span id="l14.90" class="difflineminus">-    } catch (const std::exception &amp;e) {</span>
<a href="#l14.91"></a><span id="l14.91" class="difflineminus">-        RNP_LOG(&quot;%s&quot;, e.what());</span>
<a href="#l14.92"></a><span id="l14.92" class="difflineplus">+    auto it = keyring-&gt;keybygrip.find(grip);</span>
<a href="#l14.93"></a><span id="l14.93" class="difflineplus">+    if (it == keyring-&gt;keybygrip.end()) {</span>
<a href="#l14.94"></a><span id="l14.94">         return NULL;</span>
<a href="#l14.95"></a><span id="l14.95">     }</span>
<a href="#l14.96"></a><span id="l14.96" class="difflineplus">+    return &amp;*it-&gt;second;</span>
<a href="#l14.97"></a><span id="l14.97"> }</span>
<a href="#l14.98"></a><span id="l14.98"> </span>
<a href="#l14.99"></a><span id="l14.99"> pgp_key_t *</span>
<a href="#l14.100"></a><span id="l14.100"> rnp_key_store_get_key_by_grip(rnp_key_store_t *keyring, const pgp_key_grip_t &amp;grip)</span>
<a href="#l14.101"></a><span id="l14.101"> {</span>
<a href="#l14.102"></a><span id="l14.102">     auto it = keyring-&gt;keybygrip.find(grip);</span>
<a href="#l14.103"></a><span id="l14.103">     if (it == keyring-&gt;keybygrip.end()) {</span>
<a href="#l14.104"></a><span id="l14.104">         return NULL;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/third_party/rnp/src/librepgp/stream-parse.cpp</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/third_party/rnp/src/librepgp/stream-parse.cpp</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -77,51 +77,53 @@ typedef struct pgp_source_packet_param_t</span>
<a href="#l15.4"></a><span id="l15.4">     bool          partial;                  /* partial length packet */</span>
<a href="#l15.5"></a><span id="l15.5">     bool          indeterminate;            /* indeterminate length packet */</span>
<a href="#l15.6"></a><span id="l15.6">     uint8_t       hdr[PGP_MAX_HEADER_SIZE]; /* PGP packet header, needed for AEAD */</span>
<a href="#l15.7"></a><span id="l15.7">     size_t        hdrlen;                   /* length of the header */</span>
<a href="#l15.8"></a><span id="l15.8">     size_t        len; /* packet body length if non-partial and non-indeterminate */</span>
<a href="#l15.9"></a><span id="l15.9"> } pgp_source_packet_param_t;</span>
<a href="#l15.10"></a><span id="l15.10"> </span>
<a href="#l15.11"></a><span id="l15.11"> typedef struct pgp_source_encrypted_param_t {</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-    pgp_source_packet_param_t pkt;            /* underlying packet-related params */</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">-    list                      symencs;        /* array of sym-encrypted session keys */</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineminus">-    list                      pubencs;        /* array of pk-encrypted session keys */</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineminus">-    bool                      has_mdc;        /* encrypted with mdc, i.e. tag 18 */</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineminus">-    bool                      mdc_validated;  /* mdc was validated already */</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineminus">-    bool                      aead;           /* AEAD encrypted data packet, tag 20 */</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineminus">-    bool                      aead_validated; /* we read and validated last chunk */</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineminus">-    pgp_crypt_t               decrypt;        /* decrypting crypto */</span>
<a href="#l15.20"></a><span id="l15.20" class="difflineminus">-    pgp_hash_t                mdc;            /* mdc SHA1 hash */</span>
<a href="#l15.21"></a><span id="l15.21" class="difflineminus">-    size_t                    chunklen;       /* size of AEAD chunk in bytes */</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineminus">-    size_t                    chunkin;        /* number of bytes read from the current chunk */</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineminus">-    size_t                    chunkidx;       /* index of the current chunk */</span>
<a href="#l15.24"></a><span id="l15.24" class="difflineminus">-    uint8_t                   cache[PGP_AEAD_CACHE_LEN]; /* read cache */</span>
<a href="#l15.25"></a><span id="l15.25" class="difflineminus">-    size_t                    cachelen;                  /* number of bytes in the cache */</span>
<a href="#l15.26"></a><span id="l15.26" class="difflineminus">-    size_t                    cachepos; /* index of first unread byte in the cache */</span>
<a href="#l15.27"></a><span id="l15.27" class="difflineminus">-    pgp_aead_hdr_t            aead_hdr; /* AEAD encryption parameters */</span>
<a href="#l15.28"></a><span id="l15.28" class="difflineminus">-    uint8_t                   aead_ad[PGP_AEAD_MAX_AD_LEN]; /* additional data */</span>
<a href="#l15.29"></a><span id="l15.29" class="difflineminus">-    size_t                    aead_adlen;                   /* length of the additional data */</span>
<a href="#l15.30"></a><span id="l15.30" class="difflineplus">+    pgp_source_packet_param_t     pkt;            /* underlying packet-related params */</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineplus">+    std::vector&lt;pgp_sk_sesskey_t&gt; symencs;        /* array of sym-encrypted session keys */</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineplus">+    std::vector&lt;pgp_pk_sesskey_t&gt; pubencs;        /* array of pk-encrypted session keys */</span>
<a href="#l15.33"></a><span id="l15.33" class="difflineplus">+    bool                          has_mdc;        /* encrypted with mdc, i.e. tag 18 */</span>
<a href="#l15.34"></a><span id="l15.34" class="difflineplus">+    bool                          mdc_validated;  /* mdc was validated already */</span>
<a href="#l15.35"></a><span id="l15.35" class="difflineplus">+    bool                          aead;           /* AEAD encrypted data packet, tag 20 */</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineplus">+    bool                          aead_validated; /* we read and validated last chunk */</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineplus">+    pgp_crypt_t                   decrypt;        /* decrypting crypto */</span>
<a href="#l15.38"></a><span id="l15.38" class="difflineplus">+    pgp_hash_t                    mdc;            /* mdc SHA1 hash */</span>
<a href="#l15.39"></a><span id="l15.39" class="difflineplus">+    size_t                        chunklen;       /* size of AEAD chunk in bytes */</span>
<a href="#l15.40"></a><span id="l15.40" class="difflineplus">+    size_t                        chunkin;  /* number of bytes read from the current chunk */</span>
<a href="#l15.41"></a><span id="l15.41" class="difflineplus">+    size_t                        chunkidx; /* index of the current chunk */</span>
<a href="#l15.42"></a><span id="l15.42" class="difflineplus">+    uint8_t                       cache[PGP_AEAD_CACHE_LEN]; /* read cache */</span>
<a href="#l15.43"></a><span id="l15.43" class="difflineplus">+    size_t                        cachelen;                  /* number of bytes in the cache */</span>
<a href="#l15.44"></a><span id="l15.44" class="difflineplus">+    size_t                        cachepos; /* index of first unread byte in the cache */</span>
<a href="#l15.45"></a><span id="l15.45" class="difflineplus">+    pgp_aead_hdr_t                aead_hdr; /* AEAD encryption parameters */</span>
<a href="#l15.46"></a><span id="l15.46" class="difflineplus">+    uint8_t                       aead_ad[PGP_AEAD_MAX_AD_LEN]; /* additional data */</span>
<a href="#l15.47"></a><span id="l15.47" class="difflineplus">+    size_t                        aead_adlen; /* length of the additional data */</span>
<a href="#l15.48"></a><span id="l15.48" class="difflineplus">+    pgp_symm_alg_t                salg;       /* data encryption algorithm */</span>
<a href="#l15.49"></a><span id="l15.49" class="difflineplus">+    pgp_parse_handler_t *         handler;    /* parsing handler with callbacks */</span>
<a href="#l15.50"></a><span id="l15.50"> } pgp_source_encrypted_param_t;</span>
<a href="#l15.51"></a><span id="l15.51"> </span>
<a href="#l15.52"></a><span id="l15.52"> typedef struct pgp_source_signed_param_t {</span>
<a href="#l15.53"></a><span id="l15.53" class="difflineminus">-    pgp_processing_ctx_t *ctx;             /* processing context */</span>
<a href="#l15.54"></a><span id="l15.54" class="difflineminus">-    pgp_source_t *        readsrc;         /* source to read from */</span>
<a href="#l15.55"></a><span id="l15.55" class="difflineminus">-    bool                  detached;        /* detached signature */</span>
<a href="#l15.56"></a><span id="l15.56" class="difflineminus">-    bool                  cleartext;       /* source is cleartext signed */</span>
<a href="#l15.57"></a><span id="l15.57" class="difflineminus">-    bool                  clr_eod;         /* cleartext data is over */</span>
<a href="#l15.58"></a><span id="l15.58" class="difflineminus">-    bool                  clr_fline;       /* first line of the cleartext */</span>
<a href="#l15.59"></a><span id="l15.59" class="difflineminus">-    bool                  clr_mline;       /* in the middle of the very long line */</span>
<a href="#l15.60"></a><span id="l15.60" class="difflineminus">-    uint8_t               out[CT_BUF_LEN]; /* cleartext output cache for easier parsing */</span>
<a href="#l15.61"></a><span id="l15.61" class="difflineminus">-    size_t                outlen;          /* total bytes in out */</span>
<a href="#l15.62"></a><span id="l15.62" class="difflineminus">-    size_t                outpos;          /* offset of first available byte in out */</span>
<a href="#l15.63"></a><span id="l15.63" class="difflineminus">-    list                  onepasses;       /* list of one-pass singatures */</span>
<a href="#l15.64"></a><span id="l15.64" class="difflineminus">-    list                  sigs;            /* list of signatures */</span>
<a href="#l15.65"></a><span id="l15.65" class="difflineminus">-    list                  hashes;          /* hash contexts */</span>
<a href="#l15.66"></a><span id="l15.66" class="difflineminus">-    list                  siginfos;        /* signature validation info */</span>
<a href="#l15.67"></a><span id="l15.67" class="difflineplus">+    pgp_parse_handler_t *handler;         /* parsing handler with callbacks */</span>
<a href="#l15.68"></a><span id="l15.68" class="difflineplus">+    pgp_source_t *       readsrc;         /* source to read from */</span>
<a href="#l15.69"></a><span id="l15.69" class="difflineplus">+    bool                 detached;        /* detached signature */</span>
<a href="#l15.70"></a><span id="l15.70" class="difflineplus">+    bool                 cleartext;       /* source is cleartext signed */</span>
<a href="#l15.71"></a><span id="l15.71" class="difflineplus">+    bool                 clr_eod;         /* cleartext data is over */</span>
<a href="#l15.72"></a><span id="l15.72" class="difflineplus">+    bool                 clr_fline;       /* first line of the cleartext */</span>
<a href="#l15.73"></a><span id="l15.73" class="difflineplus">+    bool                 clr_mline;       /* in the middle of the very long line */</span>
<a href="#l15.74"></a><span id="l15.74" class="difflineplus">+    uint8_t              out[CT_BUF_LEN]; /* cleartext output cache for easier parsing */</span>
<a href="#l15.75"></a><span id="l15.75" class="difflineplus">+    size_t               outlen;          /* total bytes in out */</span>
<a href="#l15.76"></a><span id="l15.76" class="difflineplus">+    size_t               outpos;          /* offset of first available byte in out */</span>
<a href="#l15.77"></a><span id="l15.77" class="difflineplus">+    list                 onepasses;       /* list of one-pass singatures */</span>
<a href="#l15.78"></a><span id="l15.78" class="difflineplus">+    list                 sigs;            /* list of signatures */</span>
<a href="#l15.79"></a><span id="l15.79" class="difflineplus">+    list                 hashes;          /* hash contexts */</span>
<a href="#l15.80"></a><span id="l15.80" class="difflineplus">+    list                 siginfos;        /* signature validation info */</span>
<a href="#l15.81"></a><span id="l15.81"> } pgp_source_signed_param_t;</span>
<a href="#l15.82"></a><span id="l15.82"> </span>
<a href="#l15.83"></a><span id="l15.83"> typedef struct pgp_source_compressed_param_t {</span>
<a href="#l15.84"></a><span id="l15.84">     pgp_source_packet_param_t pkt; /* underlying packet-related params */</span>
<a href="#l15.85"></a><span id="l15.85">     pgp_compression_type_t    alg;</span>
<a href="#l15.86"></a><span id="l15.86">     union {</span>
<a href="#l15.87"></a><span id="l15.87">         z_stream  z;</span>
<a href="#l15.88"></a><span id="l15.88">         bz_stream bz;</span>
<a href="#l15.89"></a><span id="l15.89" class="difflineat">@@ -681,16 +683,23 @@ encrypted_src_read_cfb(pgp_source_t *src</span>
<a href="#l15.90"></a><span id="l15.90">     return true;</span>
<a href="#l15.91"></a><span id="l15.91"> }</span>
<a href="#l15.92"></a><span id="l15.92"> </span>
<a href="#l15.93"></a><span id="l15.93"> static rnp_result_t</span>
<a href="#l15.94"></a><span id="l15.94"> encrypted_src_finish(pgp_source_t *src)</span>
<a href="#l15.95"></a><span id="l15.95"> {</span>
<a href="#l15.96"></a><span id="l15.96">     pgp_source_encrypted_param_t *param = (pgp_source_encrypted_param_t *) src-&gt;param;</span>
<a href="#l15.97"></a><span id="l15.97"> </span>
<a href="#l15.98"></a><span id="l15.98" class="difflineplus">+    /* report to the handler that decryption is finished */</span>
<a href="#l15.99"></a><span id="l15.99" class="difflineplus">+    if (param-&gt;handler-&gt;on_decryption_done) {</span>
<a href="#l15.100"></a><span id="l15.100" class="difflineplus">+        bool validated =</span>
<a href="#l15.101"></a><span id="l15.101" class="difflineplus">+          (param-&gt;has_mdc &amp;&amp; param-&gt;mdc_validated) || (param-&gt;aead &amp;&amp; param-&gt;aead_validated);</span>
<a href="#l15.102"></a><span id="l15.102" class="difflineplus">+        param-&gt;handler-&gt;on_decryption_done(validated, param-&gt;handler-&gt;param);</span>
<a href="#l15.103"></a><span id="l15.103" class="difflineplus">+    }</span>
<a href="#l15.104"></a><span id="l15.104" class="difflineplus">+</span>
<a href="#l15.105"></a><span id="l15.105">     if (param-&gt;aead) {</span>
<a href="#l15.106"></a><span id="l15.106">         if (!param-&gt;aead_validated) {</span>
<a href="#l15.107"></a><span id="l15.107">             RNP_LOG(&quot;aead last chunk was not validated&quot;);</span>
<a href="#l15.108"></a><span id="l15.108">             return RNP_ERROR_BAD_STATE;</span>
<a href="#l15.109"></a><span id="l15.109">         }</span>
<a href="#l15.110"></a><span id="l15.110">         return RNP_SUCCESS;</span>
<a href="#l15.111"></a><span id="l15.111">     }</span>
<a href="#l15.112"></a><span id="l15.112"> </span>
<a href="#l15.113"></a><span id="l15.113" class="difflineat">@@ -705,18 +714,19 @@ encrypted_src_finish(pgp_source_t *src)</span>
<a href="#l15.114"></a><span id="l15.114"> static void</span>
<a href="#l15.115"></a><span id="l15.115"> encrypted_src_close(pgp_source_t *src)</span>
<a href="#l15.116"></a><span id="l15.116"> {</span>
<a href="#l15.117"></a><span id="l15.117">     pgp_source_encrypted_param_t *param = (pgp_source_encrypted_param_t *) src-&gt;param;</span>
<a href="#l15.118"></a><span id="l15.118">     if (!param) {</span>
<a href="#l15.119"></a><span id="l15.119">         return;</span>
<a href="#l15.120"></a><span id="l15.120">     }</span>
<a href="#l15.121"></a><span id="l15.121"> </span>
<a href="#l15.122"></a><span id="l15.122" class="difflineminus">-    list_destroy(&amp;param-&gt;symencs);</span>
<a href="#l15.123"></a><span id="l15.123" class="difflineminus">-    list_destroy(&amp;param-&gt;pubencs);</span>
<a href="#l15.124"></a><span id="l15.124" class="difflineplus">+    /* to be removed once pgp_source_t is migrated to C++ */</span>
<a href="#l15.125"></a><span id="l15.125" class="difflineplus">+    param-&gt;symencs.~vector();</span>
<a href="#l15.126"></a><span id="l15.126" class="difflineplus">+    param-&gt;pubencs.~vector();</span>
<a href="#l15.127"></a><span id="l15.127"> </span>
<a href="#l15.128"></a><span id="l15.128">     if (param-&gt;pkt.partial) {</span>
<a href="#l15.129"></a><span id="l15.129">         src_close(param-&gt;pkt.readsrc);</span>
<a href="#l15.130"></a><span id="l15.130">         free(param-&gt;pkt.readsrc);</span>
<a href="#l15.131"></a><span id="l15.131">         param-&gt;pkt.readsrc = NULL;</span>
<a href="#l15.132"></a><span id="l15.132">     }</span>
<a href="#l15.133"></a><span id="l15.133"> </span>
<a href="#l15.134"></a><span id="l15.134">     if (param-&gt;aead) {</span>
<a href="#l15.135"></a><span id="l15.135" class="difflineat">@@ -925,50 +935,50 @@ signed_src_finish(pgp_source_t *src)</span>
<a href="#l15.136"></a><span id="l15.136">         /* Get the key id */</span>
<a href="#l15.137"></a><span id="l15.137">         if (!signature_get_keyid(sinfo-&gt;sig, keyctx.search.by.keyid)) {</span>
<a href="#l15.138"></a><span id="l15.138">             RNP_LOG(&quot;cannot get signer's key id from signature&quot;);</span>
<a href="#l15.139"></a><span id="l15.139">             sinfo-&gt;unknown = true;</span>
<a href="#l15.140"></a><span id="l15.140">             continue;</span>
<a href="#l15.141"></a><span id="l15.141">         }</span>
<a href="#l15.142"></a><span id="l15.142"> </span>
<a href="#l15.143"></a><span id="l15.143">         /* Get the public key */</span>
<a href="#l15.144"></a><span id="l15.144" class="difflineminus">-        if (!(key = pgp_request_key(param-&gt;ctx-&gt;handler.key_provider, &amp;keyctx))) {</span>
<a href="#l15.145"></a><span id="l15.145" class="difflineplus">+        if (!(key = pgp_request_key(param-&gt;handler-&gt;key_provider, &amp;keyctx))) {</span>
<a href="#l15.146"></a><span id="l15.146">             // fallback to secret key</span>
<a href="#l15.147"></a><span id="l15.147">             keyctx.secret = true;</span>
<a href="#l15.148"></a><span id="l15.148" class="difflineminus">-            if (!(key = pgp_request_key(param-&gt;ctx-&gt;handler.key_provider, &amp;keyctx))) {</span>
<a href="#l15.149"></a><span id="l15.149" class="difflineplus">+            if (!(key = pgp_request_key(param-&gt;handler-&gt;key_provider, &amp;keyctx))) {</span>
<a href="#l15.150"></a><span id="l15.150">                 RNP_LOG(&quot;signer's key not found&quot;);</span>
<a href="#l15.151"></a><span id="l15.151">                 sinfo-&gt;no_signer = true;</span>
<a href="#l15.152"></a><span id="l15.152">                 continue;</span>
<a href="#l15.153"></a><span id="l15.153">             }</span>
<a href="#l15.154"></a><span id="l15.154">         }</span>
<a href="#l15.155"></a><span id="l15.155">         sinfo-&gt;signer = key;</span>
<a href="#l15.156"></a><span id="l15.156">         /* validate signature */</span>
<a href="#l15.157"></a><span id="l15.157">         signed_validate_signature(param, sinfo);</span>
<a href="#l15.158"></a><span id="l15.158">     }</span>
<a href="#l15.159"></a><span id="l15.159"> </span>
<a href="#l15.160"></a><span id="l15.160">     /* checking the validation results */</span>
<a href="#l15.161"></a><span id="l15.161">     ret = RNP_SUCCESS;</span>
<a href="#l15.162"></a><span id="l15.162">     for (list_item *si = list_front(param-&gt;siginfos); si; si = list_next(si)) {</span>
<a href="#l15.163"></a><span id="l15.163">         sinfo = (pgp_signature_info_t *) si;</span>
<a href="#l15.164"></a><span id="l15.164">         sinfos[sinfoc++] = *sinfo;</span>
<a href="#l15.165"></a><span id="l15.165"> </span>
<a href="#l15.166"></a><span id="l15.166" class="difflineminus">-        if (sinfo-&gt;no_signer &amp;&amp; param-&gt;ctx-&gt;handler.ctx-&gt;discard) {</span>
<a href="#l15.167"></a><span id="l15.167" class="difflineplus">+        if (sinfo-&gt;no_signer &amp;&amp; param-&gt;handler-&gt;ctx-&gt;discard) {</span>
<a href="#l15.168"></a><span id="l15.168">             /* if output is discarded then we interested in verification */</span>
<a href="#l15.169"></a><span id="l15.169">             ret = RNP_ERROR_SIGNATURE_INVALID;</span>
<a href="#l15.170"></a><span id="l15.170">             continue;</span>
<a href="#l15.171"></a><span id="l15.171">         }</span>
<a href="#l15.172"></a><span id="l15.172">         if (!sinfo-&gt;no_signer &amp;&amp; (!sinfo-&gt;valid || (sinfo-&gt;expired))) {</span>
<a href="#l15.173"></a><span id="l15.173">             /* do not report error if signer not found */</span>
<a href="#l15.174"></a><span id="l15.174">             ret = RNP_ERROR_SIGNATURE_INVALID;</span>
<a href="#l15.175"></a><span id="l15.175">         }</span>
<a href="#l15.176"></a><span id="l15.176">     }</span>
<a href="#l15.177"></a><span id="l15.177"> </span>
<a href="#l15.178"></a><span id="l15.178">     /* call the callback with signature infos */</span>
<a href="#l15.179"></a><span id="l15.179" class="difflineminus">-    if (param-&gt;ctx-&gt;handler.on_signatures) {</span>
<a href="#l15.180"></a><span id="l15.180" class="difflineminus">-        param-&gt;ctx-&gt;handler.on_signatures(sinfos, sinfoc, param-&gt;ctx-&gt;handler.param);</span>
<a href="#l15.181"></a><span id="l15.181" class="difflineplus">+    if (param-&gt;handler-&gt;on_signatures) {</span>
<a href="#l15.182"></a><span id="l15.182" class="difflineplus">+        param-&gt;handler-&gt;on_signatures(sinfos, sinfoc, param-&gt;handler-&gt;param);</span>
<a href="#l15.183"></a><span id="l15.183">     }</span>
<a href="#l15.184"></a><span id="l15.184"> </span>
<a href="#l15.185"></a><span id="l15.185">     free(sinfos);</span>
<a href="#l15.186"></a><span id="l15.186">     return ret;</span>
<a href="#l15.187"></a><span id="l15.187"> }</span>
<a href="#l15.188"></a><span id="l15.188"> </span>
<a href="#l15.189"></a><span id="l15.189"> /*</span>
<a href="#l15.190"></a><span id="l15.190">  * str is a string to tokenize.</span>
<a href="#l15.191"></a><span id="l15.191" class="difflineat">@@ -1360,17 +1370,19 @@ encrypted_try_key(pgp_source_encrypted_p</span>
<a href="#l15.192"></a><span id="l15.192"> </span>
<a href="#l15.193"></a><span id="l15.193">     if (!param-&gt;aead) {</span>
<a href="#l15.194"></a><span id="l15.194">         /* Decrypt header */</span>
<a href="#l15.195"></a><span id="l15.195">         res = encrypted_decrypt_cfb_header(param, salg, &amp;decbuf[1]);</span>
<a href="#l15.196"></a><span id="l15.196">     } else {</span>
<a href="#l15.197"></a><span id="l15.197">         /* Start AEAD decrypting, assuming we have correct key */</span>
<a href="#l15.198"></a><span id="l15.198">         res = encrypted_start_aead(param, salg, &amp;decbuf[1]);</span>
<a href="#l15.199"></a><span id="l15.199">     }</span>
<a href="#l15.200"></a><span id="l15.200" class="difflineminus">-</span>
<a href="#l15.201"></a><span id="l15.201" class="difflineplus">+    if (res) {</span>
<a href="#l15.202"></a><span id="l15.202" class="difflineplus">+        param-&gt;salg = salg;</span>
<a href="#l15.203"></a><span id="l15.203" class="difflineplus">+    }</span>
<a href="#l15.204"></a><span id="l15.204"> finish:</span>
<a href="#l15.205"></a><span id="l15.205">     pgp_forget(&amp;checksum, sizeof(checksum));</span>
<a href="#l15.206"></a><span id="l15.206">     pgp_forget(decbuf, sizeof(decbuf));</span>
<a href="#l15.207"></a><span id="l15.207"> </span>
<a href="#l15.208"></a><span id="l15.208">     return res;</span>
<a href="#l15.209"></a><span id="l15.209"> }</span>
<a href="#l15.210"></a><span id="l15.210"> </span>
<a href="#l15.211"></a><span id="l15.211"> static bool</span>
<a href="#l15.212"></a><span id="l15.212" class="difflineat">@@ -1395,83 +1407,81 @@ encrypted_try_password(pgp_source_encryp</span>
<a href="#l15.213"></a><span id="l15.213">     pgp_symm_alg_t alg;</span>
<a href="#l15.214"></a><span id="l15.214">     uint8_t        keybuf[PGP_MAX_KEY_SIZE + 1];</span>
<a href="#l15.215"></a><span id="l15.215">     uint8_t        nonce[PGP_AEAD_MAX_NONCE_LEN];</span>
<a href="#l15.216"></a><span id="l15.216">     size_t         keysize;</span>
<a href="#l15.217"></a><span id="l15.217">     bool           keyavail = false; /* tried password at least once */</span>
<a href="#l15.218"></a><span id="l15.218">     bool           decres;</span>
<a href="#l15.219"></a><span id="l15.219">     int            res;</span>
<a href="#l15.220"></a><span id="l15.220"> </span>
<a href="#l15.221"></a><span id="l15.221" class="difflineminus">-    for (list_item *se = list_front(param-&gt;symencs); se; se = list_next(se)) {</span>
<a href="#l15.222"></a><span id="l15.222" class="difflineplus">+    for (auto &amp;skey : param-&gt;symencs) {</span>
<a href="#l15.223"></a><span id="l15.223">         /* deriving symmetric key from password */</span>
<a href="#l15.224"></a><span id="l15.224" class="difflineminus">-        pgp_sk_sesskey_t *skey = (pgp_sk_sesskey_t *) se;</span>
<a href="#l15.225"></a><span id="l15.225" class="difflineminus">-</span>
<a href="#l15.226"></a><span id="l15.226" class="difflineminus">-        keysize = pgp_key_size(skey-&gt;alg);</span>
<a href="#l15.227"></a><span id="l15.227" class="difflineminus">-        if (!keysize || !pgp_s2k_derive_key(&amp;skey-&gt;s2k, password, keybuf, keysize)) {</span>
<a href="#l15.228"></a><span id="l15.228" class="difflineplus">+        keysize = pgp_key_size(skey.alg);</span>
<a href="#l15.229"></a><span id="l15.229" class="difflineplus">+        if (!keysize || !pgp_s2k_derive_key(&amp;skey.s2k, password, keybuf, keysize)) {</span>
<a href="#l15.230"></a><span id="l15.230">             continue;</span>
<a href="#l15.231"></a><span id="l15.231">         }</span>
<a href="#l15.232"></a><span id="l15.232">         RNP_DHEX(&quot;derived key: &quot;, keybuf, keysize);</span>
<a href="#l15.233"></a><span id="l15.233"> </span>
<a href="#l15.234"></a><span id="l15.234" class="difflineminus">-        if (skey-&gt;version == PGP_SKSK_V4) {</span>
<a href="#l15.235"></a><span id="l15.235" class="difflineplus">+        if (skey.version == PGP_SKSK_V4) {</span>
<a href="#l15.236"></a><span id="l15.236">             /* v4 symmetrically-encrypted session key */</span>
<a href="#l15.237"></a><span id="l15.237" class="difflineminus">-            if (skey-&gt;enckeylen &gt; 0) {</span>
<a href="#l15.238"></a><span id="l15.238" class="difflineplus">+            if (skey.enckeylen &gt; 0) {</span>
<a href="#l15.239"></a><span id="l15.239">                 /* decrypting session key */</span>
<a href="#l15.240"></a><span id="l15.240" class="difflineminus">-                if (!pgp_cipher_cfb_start(&amp;crypt, skey-&gt;alg, keybuf, NULL)) {</span>
<a href="#l15.241"></a><span id="l15.241" class="difflineplus">+                if (!pgp_cipher_cfb_start(&amp;crypt, skey.alg, keybuf, NULL)) {</span>
<a href="#l15.242"></a><span id="l15.242">                     continue;</span>
<a href="#l15.243"></a><span id="l15.243">                 }</span>
<a href="#l15.244"></a><span id="l15.244"> </span>
<a href="#l15.245"></a><span id="l15.245" class="difflineminus">-                pgp_cipher_cfb_decrypt(&amp;crypt, keybuf, skey-&gt;enckey, skey-&gt;enckeylen);</span>
<a href="#l15.246"></a><span id="l15.246" class="difflineplus">+                pgp_cipher_cfb_decrypt(&amp;crypt, keybuf, skey.enckey, skey.enckeylen);</span>
<a href="#l15.247"></a><span id="l15.247">                 pgp_cipher_cfb_finish(&amp;crypt);</span>
<a href="#l15.248"></a><span id="l15.248"> </span>
<a href="#l15.249"></a><span id="l15.249">                 alg = (pgp_symm_alg_t) keybuf[0];</span>
<a href="#l15.250"></a><span id="l15.250">                 keysize = pgp_key_size(alg);</span>
<a href="#l15.251"></a><span id="l15.251" class="difflineminus">-                if (!keysize || (keysize + 1 != skey-&gt;enckeylen)) {</span>
<a href="#l15.252"></a><span id="l15.252" class="difflineplus">+                if (!keysize || (keysize + 1 != skey.enckeylen)) {</span>
<a href="#l15.253"></a><span id="l15.253">                     continue;</span>
<a href="#l15.254"></a><span id="l15.254">                 }</span>
<a href="#l15.255"></a><span id="l15.255">                 memmove(keybuf, keybuf + 1, keysize);</span>
<a href="#l15.256"></a><span id="l15.256">             } else {</span>
<a href="#l15.257"></a><span id="l15.257" class="difflineminus">-                alg = (pgp_symm_alg_t) skey-&gt;alg;</span>
<a href="#l15.258"></a><span id="l15.258" class="difflineplus">+                alg = (pgp_symm_alg_t) skey.alg;</span>
<a href="#l15.259"></a><span id="l15.259">             }</span>
<a href="#l15.260"></a><span id="l15.260"> </span>
<a href="#l15.261"></a><span id="l15.261">             if (!pgp_block_size(alg)) {</span>
<a href="#l15.262"></a><span id="l15.262">                 continue;</span>
<a href="#l15.263"></a><span id="l15.263">             }</span>
<a href="#l15.264"></a><span id="l15.264"> </span>
<a href="#l15.265"></a><span id="l15.265">             keyavail = true;</span>
<a href="#l15.266"></a><span id="l15.266" class="difflineminus">-        } else if (skey-&gt;version == PGP_SKSK_V5) {</span>
<a href="#l15.267"></a><span id="l15.267" class="difflineplus">+        } else if (skey.version == PGP_SKSK_V5) {</span>
<a href="#l15.268"></a><span id="l15.268">             /* v5 AEAD-encrypted session key */</span>
<a href="#l15.269"></a><span id="l15.269" class="difflineminus">-            size_t taglen = pgp_cipher_aead_tag_len(skey-&gt;aalg);</span>
<a href="#l15.270"></a><span id="l15.270" class="difflineplus">+            size_t taglen = pgp_cipher_aead_tag_len(skey.aalg);</span>
<a href="#l15.271"></a><span id="l15.271">             size_t noncelen;</span>
<a href="#l15.272"></a><span id="l15.272"> </span>
<a href="#l15.273"></a><span id="l15.273" class="difflineminus">-            if (!taglen || (keysize != skey-&gt;enckeylen - taglen)) {</span>
<a href="#l15.274"></a><span id="l15.274" class="difflineplus">+            if (!taglen || (keysize != skey.enckeylen - taglen)) {</span>
<a href="#l15.275"></a><span id="l15.275">                 continue;</span>
<a href="#l15.276"></a><span id="l15.276">             }</span>
<a href="#l15.277"></a><span id="l15.277" class="difflineminus">-            alg = skey-&gt;alg;</span>
<a href="#l15.278"></a><span id="l15.278" class="difflineplus">+            alg = skey.alg;</span>
<a href="#l15.279"></a><span id="l15.279"> </span>
<a href="#l15.280"></a><span id="l15.280">             /* initialize cipher */</span>
<a href="#l15.281"></a><span id="l15.281" class="difflineminus">-            if (!pgp_cipher_aead_init(&amp;crypt, skey-&gt;alg, skey-&gt;aalg, keybuf, true)) {</span>
<a href="#l15.282"></a><span id="l15.282" class="difflineplus">+            if (!pgp_cipher_aead_init(&amp;crypt, skey.alg, skey.aalg, keybuf, true)) {</span>
<a href="#l15.283"></a><span id="l15.283">                 continue;</span>
<a href="#l15.284"></a><span id="l15.284">             }</span>
<a href="#l15.285"></a><span id="l15.285"> </span>
<a href="#l15.286"></a><span id="l15.286">             /* set additional data */</span>
<a href="#l15.287"></a><span id="l15.287" class="difflineminus">-            if (!encrypted_sesk_set_ad(&amp;crypt, skey)) {</span>
<a href="#l15.288"></a><span id="l15.288" class="difflineplus">+            if (!encrypted_sesk_set_ad(&amp;crypt, &amp;skey)) {</span>
<a href="#l15.289"></a><span id="l15.289">                 RNP_LOG(&quot;failed to set ad&quot;);</span>
<a href="#l15.290"></a><span id="l15.290">                 continue;</span>
<a href="#l15.291"></a><span id="l15.291">             }</span>
<a href="#l15.292"></a><span id="l15.292"> </span>
<a href="#l15.293"></a><span id="l15.293">             /* calculate nonce */</span>
<a href="#l15.294"></a><span id="l15.294" class="difflineminus">-            noncelen = pgp_cipher_aead_nonce(skey-&gt;aalg, skey-&gt;iv, nonce, 0);</span>
<a href="#l15.295"></a><span id="l15.295" class="difflineplus">+            noncelen = pgp_cipher_aead_nonce(skey.aalg, skey.iv, nonce, 0);</span>
<a href="#l15.296"></a><span id="l15.296"> </span>
<a href="#l15.297"></a><span id="l15.297">             RNP_DHEX(&quot;nonce: &quot;, nonce, noncelen);</span>
<a href="#l15.298"></a><span id="l15.298" class="difflineminus">-            RNP_DHEX(&quot;encrypted key: &quot;, skey-&gt;enckey, skey-&gt;enckeylen);</span>
<a href="#l15.299"></a><span id="l15.299" class="difflineplus">+            RNP_DHEX(&quot;encrypted key: &quot;, skey.enckey, skey.enckeylen);</span>
<a href="#l15.300"></a><span id="l15.300"> </span>
<a href="#l15.301"></a><span id="l15.301">             /* start cipher, decrypt key and verify tag */</span>
<a href="#l15.302"></a><span id="l15.302">             keyavail = pgp_cipher_aead_start(&amp;crypt, nonce, noncelen);</span>
<a href="#l15.303"></a><span id="l15.303" class="difflineminus">-            decres = keyavail &amp;&amp;</span>
<a href="#l15.304"></a><span id="l15.304" class="difflineminus">-                     pgp_cipher_aead_finish(&amp;crypt, keybuf, skey-&gt;enckey, skey-&gt;enckeylen);</span>
<a href="#l15.305"></a><span id="l15.305" class="difflineplus">+            decres =</span>
<a href="#l15.306"></a><span id="l15.306" class="difflineplus">+              keyavail &amp;&amp; pgp_cipher_aead_finish(&amp;crypt, keybuf, skey.enckey, skey.enckeylen);</span>
<a href="#l15.307"></a><span id="l15.307"> </span>
<a href="#l15.308"></a><span id="l15.308">             if (decres) {</span>
<a href="#l15.309"></a><span id="l15.309">                 RNP_DHEX(&quot;decrypted key: &quot;, keybuf, pgp_key_size(param-&gt;aead_hdr.ealg));</span>
<a href="#l15.310"></a><span id="l15.310">             }</span>
<a href="#l15.311"></a><span id="l15.311"> </span>
<a href="#l15.312"></a><span id="l15.312">             pgp_cipher_aead_destroy(&amp;crypt);</span>
<a href="#l15.313"></a><span id="l15.313"> </span>
<a href="#l15.314"></a><span id="l15.314">             /* we have decrypted key so let's start decryption */</span>
<a href="#l15.315"></a><span id="l15.315" class="difflineat">@@ -1485,17 +1495,22 @@ encrypted_try_password(pgp_source_encryp</span>
<a href="#l15.316"></a><span id="l15.316">         /* Decrypt header for CFB */</span>
<a href="#l15.317"></a><span id="l15.317">         if (!param-&gt;aead &amp;&amp; !encrypted_decrypt_cfb_header(param, alg, keybuf)) {</span>
<a href="#l15.318"></a><span id="l15.318">             continue;</span>
<a href="#l15.319"></a><span id="l15.319">         }</span>
<a href="#l15.320"></a><span id="l15.320">         if (param-&gt;aead &amp;&amp; !encrypted_start_aead(param, param-&gt;aead_hdr.ealg, keybuf)) {</span>
<a href="#l15.321"></a><span id="l15.321">             continue;</span>
<a href="#l15.322"></a><span id="l15.322">         }</span>
<a href="#l15.323"></a><span id="l15.323"> </span>
<a href="#l15.324"></a><span id="l15.324" class="difflineplus">+        param-&gt;salg = param-&gt;aead ? param-&gt;aead_hdr.ealg : alg;</span>
<a href="#l15.325"></a><span id="l15.325">         res = 1;</span>
<a href="#l15.326"></a><span id="l15.326" class="difflineplus">+        /* inform handler that we used this symenc */</span>
<a href="#l15.327"></a><span id="l15.327" class="difflineplus">+        if (param-&gt;handler-&gt;on_decryption_start) {</span>
<a href="#l15.328"></a><span id="l15.328" class="difflineplus">+            param-&gt;handler-&gt;on_decryption_start(NULL, &amp;skey, param-&gt;handler-&gt;param);</span>
<a href="#l15.329"></a><span id="l15.329" class="difflineplus">+        }</span>
<a href="#l15.330"></a><span id="l15.330">         goto finish;</span>
<a href="#l15.331"></a><span id="l15.331">     }</span>
<a href="#l15.332"></a><span id="l15.332"> </span>
<a href="#l15.333"></a><span id="l15.333">     if (!keyavail) {</span>
<a href="#l15.334"></a><span id="l15.334">         RNP_LOG(&quot;no supported sk available&quot;);</span>
<a href="#l15.335"></a><span id="l15.335">         res = -1;</span>
<a href="#l15.336"></a><span id="l15.336">         goto finish;</span>
<a href="#l15.337"></a><span id="l15.337">     }</span>
<a href="#l15.338"></a><span id="l15.338" class="difflineat">@@ -1769,26 +1784,30 @@ encrypted_read_packet_data(pgp_source_en</span>
<a href="#l15.339"></a><span id="l15.339">             return RNP_ERROR_READ;</span>
<a href="#l15.340"></a><span id="l15.340">         }</span>
<a href="#l15.341"></a><span id="l15.341">         ptype = get_packet_type(ptag);</span>
<a href="#l15.342"></a><span id="l15.342"> </span>
<a href="#l15.343"></a><span id="l15.343">         if (ptype == PGP_PKT_SK_SESSION_KEY) {</span>
<a href="#l15.344"></a><span id="l15.344">             if ((errcode = stream_parse_sk_sesskey(param-&gt;pkt.readsrc, &amp;skey))) {</span>
<a href="#l15.345"></a><span id="l15.345">                 return errcode;</span>
<a href="#l15.346"></a><span id="l15.346">             }</span>
<a href="#l15.347"></a><span id="l15.347" class="difflineminus">-</span>
<a href="#l15.348"></a><span id="l15.348" class="difflineminus">-            if (!list_append(&amp;param-&gt;symencs, &amp;skey, sizeof(skey))) {</span>
<a href="#l15.349"></a><span id="l15.349" class="difflineplus">+            try {</span>
<a href="#l15.350"></a><span id="l15.350" class="difflineplus">+                param-&gt;symencs.push_back(skey);</span>
<a href="#l15.351"></a><span id="l15.351" class="difflineplus">+            } catch (const std::exception &amp;e) {</span>
<a href="#l15.352"></a><span id="l15.352" class="difflineplus">+                RNP_LOG(&quot;%s&quot;, e.what());</span>
<a href="#l15.353"></a><span id="l15.353">                 return RNP_ERROR_OUT_OF_MEMORY;</span>
<a href="#l15.354"></a><span id="l15.354">             }</span>
<a href="#l15.355"></a><span id="l15.355">         } else if (ptype == PGP_PKT_PK_SESSION_KEY) {</span>
<a href="#l15.356"></a><span id="l15.356">             if ((errcode = stream_parse_pk_sesskey(param-&gt;pkt.readsrc, &amp;pkey))) {</span>
<a href="#l15.357"></a><span id="l15.357">                 return errcode;</span>
<a href="#l15.358"></a><span id="l15.358">             }</span>
<a href="#l15.359"></a><span id="l15.359" class="difflineminus">-</span>
<a href="#l15.360"></a><span id="l15.360" class="difflineminus">-            if (!list_append(&amp;param-&gt;pubencs, &amp;pkey, sizeof(pkey))) {</span>
<a href="#l15.361"></a><span id="l15.361" class="difflineplus">+            try {</span>
<a href="#l15.362"></a><span id="l15.362" class="difflineplus">+                param-&gt;pubencs.push_back(pkey);</span>
<a href="#l15.363"></a><span id="l15.363" class="difflineplus">+            } catch (const std::exception &amp;e) {</span>
<a href="#l15.364"></a><span id="l15.364" class="difflineplus">+                RNP_LOG(&quot;%s&quot;, e.what());</span>
<a href="#l15.365"></a><span id="l15.365">                 return RNP_ERROR_OUT_OF_MEMORY;</span>
<a href="#l15.366"></a><span id="l15.366">             }</span>
<a href="#l15.367"></a><span id="l15.367">         } else if ((ptype == PGP_PKT_SE_DATA) || (ptype == PGP_PKT_SE_IP_DATA) ||</span>
<a href="#l15.368"></a><span id="l15.368">                    (ptype == PGP_PKT_AEAD_ENCRYPTED)) {</span>
<a href="#l15.369"></a><span id="l15.369">             break;</span>
<a href="#l15.370"></a><span id="l15.370">         } else {</span>
<a href="#l15.371"></a><span id="l15.371">             RNP_LOG(&quot;unknown packet type: %d&quot;, ptype);</span>
<a href="#l15.372"></a><span id="l15.372">             return RNP_ERROR_BAD_FORMAT;</span>
<a href="#l15.373"></a><span id="l15.373" class="difflineat">@@ -1844,114 +1863,120 @@ encrypted_read_packet_data(pgp_source_en</span>
<a href="#l15.374"></a><span id="l15.374">         param-&gt;has_mdc = true;</span>
<a href="#l15.375"></a><span id="l15.375">         param-&gt;mdc_validated = false;</span>
<a href="#l15.376"></a><span id="l15.376">     }</span>
<a href="#l15.377"></a><span id="l15.377"> </span>
<a href="#l15.378"></a><span id="l15.378">     return RNP_SUCCESS;</span>
<a href="#l15.379"></a><span id="l15.379"> }</span>
<a href="#l15.380"></a><span id="l15.380"> </span>
<a href="#l15.381"></a><span id="l15.381"> static rnp_result_t</span>
<a href="#l15.382"></a><span id="l15.382" class="difflineminus">-init_encrypted_src(pgp_processing_ctx_t *ctx, pgp_source_t *src, pgp_source_t *readsrc)</span>
<a href="#l15.383"></a><span id="l15.383" class="difflineplus">+init_encrypted_src(pgp_parse_handler_t *handler, pgp_source_t *src, pgp_source_t *readsrc)</span>
<a href="#l15.384"></a><span id="l15.384"> {</span>
<a href="#l15.385"></a><span id="l15.385">     rnp_result_t                  errcode = RNP_ERROR_GENERIC;</span>
<a href="#l15.386"></a><span id="l15.386">     pgp_source_encrypted_param_t *param;</span>
<a href="#l15.387"></a><span id="l15.387">     pgp_key_t *                   seckey = NULL;</span>
<a href="#l15.388"></a><span id="l15.388" class="difflineminus">-    pgp_key_request_ctx_t         keyctx;</span>
<a href="#l15.389"></a><span id="l15.389">     pgp_key_pkt_t *               decrypted_seckey = NULL;</span>
<a href="#l15.390"></a><span id="l15.390">     char                          password[MAX_PASSWORD_LENGTH] = {0};</span>
<a href="#l15.391"></a><span id="l15.391">     int                           intres;</span>
<a href="#l15.392"></a><span id="l15.392">     bool                          have_key = false;</span>
<a href="#l15.393"></a><span id="l15.393"> </span>
<a href="#l15.394"></a><span id="l15.394">     if (!init_src_common(src, sizeof(*param))) {</span>
<a href="#l15.395"></a><span id="l15.395">         return RNP_ERROR_OUT_OF_MEMORY;</span>
<a href="#l15.396"></a><span id="l15.396">     }</span>
<a href="#l15.397"></a><span id="l15.397">     param = (pgp_source_encrypted_param_t *) src-&gt;param;</span>
<a href="#l15.398"></a><span id="l15.398">     param-&gt;pkt.readsrc = readsrc;</span>
<a href="#l15.399"></a><span id="l15.399" class="difflineplus">+    param-&gt;handler = handler;</span>
<a href="#l15.400"></a><span id="l15.400"> </span>
<a href="#l15.401"></a><span id="l15.401">     src-&gt;close = encrypted_src_close;</span>
<a href="#l15.402"></a><span id="l15.402">     src-&gt;finish = encrypted_src_finish;</span>
<a href="#l15.403"></a><span id="l15.403">     src-&gt;type = PGP_STREAM_ENCRYPTED;</span>
<a href="#l15.404"></a><span id="l15.404"> </span>
<a href="#l15.405"></a><span id="l15.405">     /* Read the packet-related information */</span>
<a href="#l15.406"></a><span id="l15.406">     errcode = encrypted_read_packet_data(param);</span>
<a href="#l15.407"></a><span id="l15.407">     if (errcode != RNP_SUCCESS) {</span>
<a href="#l15.408"></a><span id="l15.408">         goto finish;</span>
<a href="#l15.409"></a><span id="l15.409">     }</span>
<a href="#l15.410"></a><span id="l15.410"> </span>
<a href="#l15.411"></a><span id="l15.411">     src-&gt;read = param-&gt;aead ? encrypted_src_read_aead : encrypted_src_read_cfb;</span>
<a href="#l15.412"></a><span id="l15.412"> </span>
<a href="#l15.413"></a><span id="l15.413">     /* Obtaining the symmetric key */</span>
<a href="#l15.414"></a><span id="l15.414">     have_key = false;</span>
<a href="#l15.415"></a><span id="l15.415"> </span>
<a href="#l15.416"></a><span id="l15.416" class="difflineminus">-    if (!ctx-&gt;handler.password_provider) {</span>
<a href="#l15.417"></a><span id="l15.417" class="difflineplus">+    if (!handler-&gt;password_provider) {</span>
<a href="#l15.418"></a><span id="l15.418">         RNP_LOG(&quot;no password provider&quot;);</span>
<a href="#l15.419"></a><span id="l15.419">         errcode = RNP_ERROR_BAD_PARAMETERS;</span>
<a href="#l15.420"></a><span id="l15.420">         goto finish;</span>
<a href="#l15.421"></a><span id="l15.421">     }</span>
<a href="#l15.422"></a><span id="l15.422"> </span>
<a href="#l15.423"></a><span id="l15.423" class="difflineplus">+    /* informing handler about the available pubencs/symencs */</span>
<a href="#l15.424"></a><span id="l15.424" class="difflineplus">+    if (handler-&gt;on_recipients) {</span>
<a href="#l15.425"></a><span id="l15.425" class="difflineplus">+        handler-&gt;on_recipients(param-&gt;pubencs, param-&gt;symencs, handler-&gt;param);</span>
<a href="#l15.426"></a><span id="l15.426" class="difflineplus">+    }</span>
<a href="#l15.427"></a><span id="l15.427" class="difflineplus">+</span>
<a href="#l15.428"></a><span id="l15.428">     /* Trying public-key decryption */</span>
<a href="#l15.429"></a><span id="l15.429" class="difflineminus">-    if (list_length(param-&gt;pubencs) &gt; 0) {</span>
<a href="#l15.430"></a><span id="l15.430" class="difflineminus">-        if (!ctx-&gt;handler.key_provider) {</span>
<a href="#l15.431"></a><span id="l15.431" class="difflineplus">+    if (!param-&gt;pubencs.empty()) {</span>
<a href="#l15.432"></a><span id="l15.432" class="difflineplus">+        if (!handler-&gt;key_provider) {</span>
<a href="#l15.433"></a><span id="l15.433">             RNP_LOG(&quot;no key provider&quot;);</span>
<a href="#l15.434"></a><span id="l15.434">             errcode = RNP_ERROR_BAD_PARAMETERS;</span>
<a href="#l15.435"></a><span id="l15.435">             goto finish;</span>
<a href="#l15.436"></a><span id="l15.436">         }</span>
<a href="#l15.437"></a><span id="l15.437"> </span>
<a href="#l15.438"></a><span id="l15.438" class="difflineplus">+        pgp_key_request_ctx_t keyctx = {};</span>
<a href="#l15.439"></a><span id="l15.439">         keyctx.op = PGP_OP_DECRYPT_SYM;</span>
<a href="#l15.440"></a><span id="l15.440">         keyctx.secret = true;</span>
<a href="#l15.441"></a><span id="l15.441">         keyctx.search.type = PGP_KEY_SEARCH_KEYID;</span>
<a href="#l15.442"></a><span id="l15.442"> </span>
<a href="#l15.443"></a><span id="l15.443" class="difflineminus">-        for (list_item *pe = list_front(param-&gt;pubencs); pe; pe = list_next(pe)) {</span>
<a href="#l15.444"></a><span id="l15.444" class="difflineminus">-            memcpy(keyctx.search.by.keyid,</span>
<a href="#l15.445"></a><span id="l15.445" class="difflineminus">-                   ((pgp_pk_sesskey_t *) pe)-&gt;key_id,</span>
<a href="#l15.446"></a><span id="l15.446" class="difflineminus">-                   sizeof(keyctx.search.by.keyid));</span>
<a href="#l15.447"></a><span id="l15.447" class="difflineplus">+        for (auto &amp;pubenc : param-&gt;pubencs) {</span>
<a href="#l15.448"></a><span id="l15.448" class="difflineplus">+            memcpy(keyctx.search.by.keyid, pubenc.key_id, sizeof(keyctx.search.by.keyid));</span>
<a href="#l15.449"></a><span id="l15.449">             /* Get the key if any */</span>
<a href="#l15.450"></a><span id="l15.450" class="difflineminus">-            if (!(seckey = pgp_request_key(ctx-&gt;handler.key_provider, &amp;keyctx))) {</span>
<a href="#l15.451"></a><span id="l15.451" class="difflineplus">+            if (!(seckey = pgp_request_key(handler-&gt;key_provider, &amp;keyctx))) {</span>
<a href="#l15.452"></a><span id="l15.452">                 errcode = RNP_ERROR_NO_SUITABLE_KEY;</span>
<a href="#l15.453"></a><span id="l15.453">                 continue;</span>
<a href="#l15.454"></a><span id="l15.454">             }</span>
<a href="#l15.455"></a><span id="l15.455">             /* Decrypt key */</span>
<a href="#l15.456"></a><span id="l15.456">             if (pgp_key_is_encrypted(seckey)) {</span>
<a href="#l15.457"></a><span id="l15.457">                 pgp_password_ctx_t pass_ctx{.op = PGP_OP_DECRYPT, .key = seckey};</span>
<a href="#l15.458"></a><span id="l15.458">                 decrypted_seckey =</span>
<a href="#l15.459"></a><span id="l15.459" class="difflineminus">-                  pgp_decrypt_seckey(seckey, ctx-&gt;handler.password_provider, &amp;pass_ctx);</span>
<a href="#l15.460"></a><span id="l15.460" class="difflineplus">+                  pgp_decrypt_seckey(seckey, handler-&gt;password_provider, &amp;pass_ctx);</span>
<a href="#l15.461"></a><span id="l15.461">                 if (!decrypted_seckey) {</span>
<a href="#l15.462"></a><span id="l15.462">                     errcode = RNP_ERROR_BAD_PASSWORD;</span>
<a href="#l15.463"></a><span id="l15.463">                     continue;</span>
<a href="#l15.464"></a><span id="l15.464">                 }</span>
<a href="#l15.465"></a><span id="l15.465">             } else {</span>
<a href="#l15.466"></a><span id="l15.466">                 decrypted_seckey = &amp;(seckey-&gt;pkt);</span>
<a href="#l15.467"></a><span id="l15.467">             }</span>
<a href="#l15.468"></a><span id="l15.468"> </span>
<a href="#l15.469"></a><span id="l15.469">             /* Try to initialize the decryption */</span>
<a href="#l15.470"></a><span id="l15.470" class="difflineminus">-            if (encrypted_try_key(param,</span>
<a href="#l15.471"></a><span id="l15.471" class="difflineminus">-                                  (pgp_pk_sesskey_t *) pe,</span>
<a href="#l15.472"></a><span id="l15.472" class="difflineminus">-                                  decrypted_seckey,</span>
<a href="#l15.473"></a><span id="l15.473" class="difflineminus">-                                  rnp_ctx_rng_handle(ctx-&gt;handler.ctx))) {</span>
<a href="#l15.474"></a><span id="l15.474" class="difflineplus">+            if (encrypted_try_key(</span>
<a href="#l15.475"></a><span id="l15.475" class="difflineplus">+                  param, &amp;pubenc, decrypted_seckey, rnp_ctx_rng_handle(handler-&gt;ctx))) {</span>
<a href="#l15.476"></a><span id="l15.476">                 have_key = true;</span>
<a href="#l15.477"></a><span id="l15.477" class="difflineplus">+                /* inform handler that we used this pubenc */</span>
<a href="#l15.478"></a><span id="l15.478" class="difflineplus">+                if (handler-&gt;on_decryption_start) {</span>
<a href="#l15.479"></a><span id="l15.479" class="difflineplus">+                    handler-&gt;on_decryption_start(&amp;pubenc, NULL, handler-&gt;param);</span>
<a href="#l15.480"></a><span id="l15.480" class="difflineplus">+                }</span>
<a href="#l15.481"></a><span id="l15.481">             }</span>
<a href="#l15.482"></a><span id="l15.482"> </span>
<a href="#l15.483"></a><span id="l15.483">             /* Destroy decrypted key */</span>
<a href="#l15.484"></a><span id="l15.484">             if (pgp_key_is_encrypted(seckey)) {</span>
<a href="#l15.485"></a><span id="l15.485">                 free_key_pkt(decrypted_seckey);</span>
<a href="#l15.486"></a><span id="l15.486">                 free(decrypted_seckey);</span>
<a href="#l15.487"></a><span id="l15.487">                 decrypted_seckey = NULL;</span>
<a href="#l15.488"></a><span id="l15.488">             }</span>
<a href="#l15.489"></a><span id="l15.489"> </span>
<a href="#l15.490"></a><span id="l15.490">             if (have_key) {</span>
<a href="#l15.491"></a><span id="l15.491">                 break;</span>
<a href="#l15.492"></a><span id="l15.492">             }</span>
<a href="#l15.493"></a><span id="l15.493">         }</span>
<a href="#l15.494"></a><span id="l15.494">     }</span>
<a href="#l15.495"></a><span id="l15.495"> </span>
<a href="#l15.496"></a><span id="l15.496">     /* Trying password-based decryption */</span>
<a href="#l15.497"></a><span id="l15.497" class="difflineminus">-    if (!have_key &amp;&amp; (list_length(param-&gt;symencs) &gt; 0)) {</span>
<a href="#l15.498"></a><span id="l15.498" class="difflineplus">+    if (!have_key &amp;&amp; !param-&gt;symencs.empty()) {</span>
<a href="#l15.499"></a><span id="l15.499">         pgp_password_ctx_t pass_ctx{.op = PGP_OP_DECRYPT_SYM, .key = NULL};</span>
<a href="#l15.500"></a><span id="l15.500">         if (!pgp_request_password(</span>
<a href="#l15.501"></a><span id="l15.501" class="difflineminus">-              ctx-&gt;handler.password_provider, &amp;pass_ctx, password, sizeof(password))) {</span>
<a href="#l15.502"></a><span id="l15.502" class="difflineplus">+              handler-&gt;password_provider, &amp;pass_ctx, password, sizeof(password))) {</span>
<a href="#l15.503"></a><span id="l15.503">             errcode = RNP_ERROR_BAD_PASSWORD;</span>
<a href="#l15.504"></a><span id="l15.504">             goto finish;</span>
<a href="#l15.505"></a><span id="l15.505">         }</span>
<a href="#l15.506"></a><span id="l15.506"> </span>
<a href="#l15.507"></a><span id="l15.507">         intres = encrypted_try_password(param, password);</span>
<a href="#l15.508"></a><span id="l15.508">         if (intres &gt; 0) {</span>
<a href="#l15.509"></a><span id="l15.509">             have_key = true;</span>
<a href="#l15.510"></a><span id="l15.510">         } else if (intres &lt; 0) {</span>
<a href="#l15.511"></a><span id="l15.511" class="difflineat">@@ -1964,23 +1989,27 @@ init_encrypted_src(pgp_processing_ctx_t </span>
<a href="#l15.512"></a><span id="l15.512">     if (!have_key) {</span>
<a href="#l15.513"></a><span id="l15.513">         RNP_LOG(&quot;failed to obtain decrypting key or password&quot;);</span>
<a href="#l15.514"></a><span id="l15.514">         if (!errcode) {</span>
<a href="#l15.515"></a><span id="l15.515">             errcode = RNP_ERROR_NO_SUITABLE_KEY;</span>
<a href="#l15.516"></a><span id="l15.516">         }</span>
<a href="#l15.517"></a><span id="l15.517">         goto finish;</span>
<a href="#l15.518"></a><span id="l15.518">     }</span>
<a href="#l15.519"></a><span id="l15.519"> </span>
<a href="#l15.520"></a><span id="l15.520" class="difflineplus">+    /* report decryption start to the handler */</span>
<a href="#l15.521"></a><span id="l15.521" class="difflineplus">+    if (handler-&gt;on_decryption_info) {</span>
<a href="#l15.522"></a><span id="l15.522" class="difflineplus">+        handler-&gt;on_decryption_info(</span>
<a href="#l15.523"></a><span id="l15.523" class="difflineplus">+          param-&gt;has_mdc, param-&gt;aead_hdr.aalg, param-&gt;salg, handler-&gt;param);</span>
<a href="#l15.524"></a><span id="l15.524" class="difflineplus">+    }</span>
<a href="#l15.525"></a><span id="l15.525">     errcode = RNP_SUCCESS;</span>
<a href="#l15.526"></a><span id="l15.526"> finish:</span>
<a href="#l15.527"></a><span id="l15.527">     if (errcode != RNP_SUCCESS) {</span>
<a href="#l15.528"></a><span id="l15.528">         src_close(src);</span>
<a href="#l15.529"></a><span id="l15.529">     }</span>
<a href="#l15.530"></a><span id="l15.530">     pgp_forget(password, sizeof(password));</span>
<a href="#l15.531"></a><span id="l15.531" class="difflineminus">-</span>
<a href="#l15.532"></a><span id="l15.532">     return errcode;</span>
<a href="#l15.533"></a><span id="l15.533"> }</span>
<a href="#l15.534"></a><span id="l15.534"> </span>
<a href="#l15.535"></a><span id="l15.535"> static rnp_result_t</span>
<a href="#l15.536"></a><span id="l15.536"> init_cleartext_signed_src(pgp_source_t *src)</span>
<a href="#l15.537"></a><span id="l15.537"> {</span>
<a href="#l15.538"></a><span id="l15.538">     char                       buf[64];</span>
<a href="#l15.539"></a><span id="l15.539">     size_t                     hdrlen = strlen(ST_CLEAR_BEGIN);</span>
<a href="#l15.540"></a><span id="l15.540" class="difflineat">@@ -2009,17 +2038,17 @@ init_cleartext_signed_src(pgp_source_t *</span>
<a href="#l15.541"></a><span id="l15.541">     }</span>
<a href="#l15.542"></a><span id="l15.542"> </span>
<a href="#l15.543"></a><span id="l15.543">     /* now we are good to go */</span>
<a href="#l15.544"></a><span id="l15.544">     param-&gt;clr_fline = true;</span>
<a href="#l15.545"></a><span id="l15.545">     return RNP_SUCCESS;</span>
<a href="#l15.546"></a><span id="l15.546"> }</span>
<a href="#l15.547"></a><span id="l15.547"> </span>
<a href="#l15.548"></a><span id="l15.548"> static rnp_result_t</span>
<a href="#l15.549"></a><span id="l15.549" class="difflineminus">-init_signed_src(pgp_processing_ctx_t *ctx, pgp_source_t *src, pgp_source_t *readsrc)</span>
<a href="#l15.550"></a><span id="l15.550" class="difflineplus">+init_signed_src(pgp_parse_handler_t *handler, pgp_source_t *src, pgp_source_t *readsrc)</span>
<a href="#l15.551"></a><span id="l15.551"> {</span>
<a href="#l15.552"></a><span id="l15.552">     rnp_result_t               errcode = RNP_ERROR_GENERIC;</span>
<a href="#l15.553"></a><span id="l15.553">     pgp_source_signed_param_t *param;</span>
<a href="#l15.554"></a><span id="l15.554">     uint8_t                    ptag;</span>
<a href="#l15.555"></a><span id="l15.555">     int                        ptype;</span>
<a href="#l15.556"></a><span id="l15.556">     pgp_one_pass_sig_t         onepass = {0};</span>
<a href="#l15.557"></a><span id="l15.557">     pgp_signature_t *          sig = NULL;</span>
<a href="#l15.558"></a><span id="l15.558">     bool                       cleartext;</span>
<a href="#l15.559"></a><span id="l15.559" class="difflineat">@@ -2027,25 +2056,25 @@ init_signed_src(pgp_processing_ctx_t *ct</span>
<a href="#l15.560"></a><span id="l15.560">     if (!init_src_common(src, sizeof(*param))) {</span>
<a href="#l15.561"></a><span id="l15.561">         return RNP_ERROR_OUT_OF_MEMORY;</span>
<a href="#l15.562"></a><span id="l15.562">     }</span>
<a href="#l15.563"></a><span id="l15.563"> </span>
<a href="#l15.564"></a><span id="l15.564">     cleartext = is_cleartext_source(readsrc);</span>
<a href="#l15.565"></a><span id="l15.565"> </span>
<a href="#l15.566"></a><span id="l15.566">     param = (pgp_source_signed_param_t *) src-&gt;param;</span>
<a href="#l15.567"></a><span id="l15.567">     param-&gt;readsrc = readsrc;</span>
<a href="#l15.568"></a><span id="l15.568" class="difflineminus">-    param-&gt;ctx = ctx;</span>
<a href="#l15.569"></a><span id="l15.569" class="difflineplus">+    param-&gt;handler = handler;</span>
<a href="#l15.570"></a><span id="l15.570">     param-&gt;cleartext = cleartext;</span>
<a href="#l15.571"></a><span id="l15.571">     src-&gt;read = cleartext ? cleartext_src_read : signed_src_read;</span>
<a href="#l15.572"></a><span id="l15.572">     src-&gt;close = signed_src_close;</span>
<a href="#l15.573"></a><span id="l15.573">     src-&gt;finish = signed_src_finish;</span>
<a href="#l15.574"></a><span id="l15.574">     src-&gt;type = cleartext ? PGP_STREAM_CLEARTEXT : PGP_STREAM_SIGNED;</span>
<a href="#l15.575"></a><span id="l15.575"> </span>
<a href="#l15.576"></a><span id="l15.576">     /* we need key provider to validate signatures */</span>
<a href="#l15.577"></a><span id="l15.577" class="difflineminus">-    if (!ctx-&gt;handler.key_provider) {</span>
<a href="#l15.578"></a><span id="l15.578" class="difflineplus">+    if (!handler-&gt;key_provider) {</span>
<a href="#l15.579"></a><span id="l15.579">         RNP_LOG(&quot;no key provider&quot;);</span>
<a href="#l15.580"></a><span id="l15.580">         errcode = RNP_ERROR_BAD_PARAMETERS;</span>
<a href="#l15.581"></a><span id="l15.581">         goto finish;</span>
<a href="#l15.582"></a><span id="l15.582">     }</span>
<a href="#l15.583"></a><span id="l15.583"> </span>
<a href="#l15.584"></a><span id="l15.584">     if (cleartext) {</span>
<a href="#l15.585"></a><span id="l15.585">         errcode = init_cleartext_signed_src(src);</span>
<a href="#l15.586"></a><span id="l15.586">         goto finish;</span>
<a href="#l15.587"></a><span id="l15.587" class="difflineat">@@ -2158,21 +2187,21 @@ init_packet_sequence(pgp_processing_ctx_</span>
<a href="#l15.588"></a><span id="l15.588">             return RNP_ERROR_BAD_FORMAT;</span>
<a href="#l15.589"></a><span id="l15.589">         }</span>
<a href="#l15.590"></a><span id="l15.590"> </span>
<a href="#l15.591"></a><span id="l15.591">         memset(&amp;psrc, 0, sizeof(psrc));</span>
<a href="#l15.592"></a><span id="l15.592"> </span>
<a href="#l15.593"></a><span id="l15.593">         switch (type) {</span>
<a href="#l15.594"></a><span id="l15.594">         case PGP_PKT_PK_SESSION_KEY:</span>
<a href="#l15.595"></a><span id="l15.595">         case PGP_PKT_SK_SESSION_KEY:</span>
<a href="#l15.596"></a><span id="l15.596" class="difflineminus">-            ret = init_encrypted_src(ctx, &amp;psrc, lsrc);</span>
<a href="#l15.597"></a><span id="l15.597" class="difflineplus">+            ret = init_encrypted_src(&amp;ctx-&gt;handler, &amp;psrc, lsrc);</span>
<a href="#l15.598"></a><span id="l15.598">             break;</span>
<a href="#l15.599"></a><span id="l15.599">         case PGP_PKT_ONE_PASS_SIG:</span>
<a href="#l15.600"></a><span id="l15.600">         case PGP_PKT_SIGNATURE:</span>
<a href="#l15.601"></a><span id="l15.601" class="difflineminus">-            ret = init_signed_src(ctx, &amp;psrc, lsrc);</span>
<a href="#l15.602"></a><span id="l15.602" class="difflineplus">+            ret = init_signed_src(&amp;ctx-&gt;handler, &amp;psrc, lsrc);</span>
<a href="#l15.603"></a><span id="l15.603">             break;</span>
<a href="#l15.604"></a><span id="l15.604">         case PGP_PKT_COMPRESSED:</span>
<a href="#l15.605"></a><span id="l15.605">             ret = init_compressed_src(&amp;psrc, lsrc);</span>
<a href="#l15.606"></a><span id="l15.606">             break;</span>
<a href="#l15.607"></a><span id="l15.607">         case PGP_PKT_LITDATA:</span>
<a href="#l15.608"></a><span id="l15.608">             if ((lsrc-&gt;type != PGP_STREAM_ENCRYPTED) &amp;&amp; (lsrc-&gt;type != PGP_STREAM_SIGNED) &amp;&amp;</span>
<a href="#l15.609"></a><span id="l15.609">                 (lsrc-&gt;type != PGP_STREAM_COMPRESSED)) {</span>
<a href="#l15.610"></a><span id="l15.610">                 RNP_LOG(&quot;unexpected literal pkt&quot;);</span>
<a href="#l15.611"></a><span id="l15.611" class="difflineat">@@ -2212,17 +2241,17 @@ init_packet_sequence(pgp_processing_ctx_</span>
<a href="#l15.612"></a><span id="l15.612"> }</span>
<a href="#l15.613"></a><span id="l15.613"> </span>
<a href="#l15.614"></a><span id="l15.614"> static rnp_result_t</span>
<a href="#l15.615"></a><span id="l15.615"> init_cleartext_sequence(pgp_processing_ctx_t *ctx, pgp_source_t *src)</span>
<a href="#l15.616"></a><span id="l15.616"> {</span>
<a href="#l15.617"></a><span id="l15.617">     pgp_source_t clrsrc = {0};</span>
<a href="#l15.618"></a><span id="l15.618">     rnp_result_t res;</span>
<a href="#l15.619"></a><span id="l15.619"> </span>
<a href="#l15.620"></a><span id="l15.620" class="difflineminus">-    if ((res = init_signed_src(ctx, &amp;clrsrc, src))) {</span>
<a href="#l15.621"></a><span id="l15.621" class="difflineplus">+    if ((res = init_signed_src(&amp;ctx-&gt;handler, &amp;clrsrc, src))) {</span>
<a href="#l15.622"></a><span id="l15.622">         return res;</span>
<a href="#l15.623"></a><span id="l15.623">     }</span>
<a href="#l15.624"></a><span id="l15.624"> </span>
<a href="#l15.625"></a><span id="l15.625">     if (!list_append(&amp;ctx-&gt;sources, &amp;clrsrc, sizeof(clrsrc))) {</span>
<a href="#l15.626"></a><span id="l15.626">         RNP_LOG(&quot;allocation failed&quot;);</span>
<a href="#l15.627"></a><span id="l15.627">         return RNP_ERROR_OUT_OF_MEMORY;</span>
<a href="#l15.628"></a><span id="l15.628">     }</span>
<a href="#l15.629"></a><span id="l15.629"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/third_party/rnp/src/librepgp/stream-parse.h</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/third_party/rnp/src/librepgp/stream-parse.h</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -38,26 +38,42 @@ typedef struct pgp_parse_handler_t  pgp_</span>
<a href="#l16.4"></a><span id="l16.4"> typedef struct pgp_signature_info_t pgp_signature_info_t;</span>
<a href="#l16.5"></a><span id="l16.5"> typedef bool                        pgp_destination_func_t(pgp_parse_handler_t *handler,</span>
<a href="#l16.6"></a><span id="l16.6">                                                            pgp_dest_t **        dst,</span>
<a href="#l16.7"></a><span id="l16.7">                                                            bool *               closedst,</span>
<a href="#l16.8"></a><span id="l16.8">                                                            const char *         filename);</span>
<a href="#l16.9"></a><span id="l16.9"> typedef bool pgp_source_func_t(pgp_parse_handler_t *handler, pgp_source_t *src);</span>
<a href="#l16.10"></a><span id="l16.10"> typedef void pgp_signatures_func_t(pgp_signature_info_t *sigs, int count, void *param);</span>
<a href="#l16.11"></a><span id="l16.11"> </span>
<a href="#l16.12"></a><span id="l16.12" class="difflineplus">+typedef void pgp_on_recipients_func_t(const std::vector&lt;pgp_pk_sesskey_t&gt; &amp;recipients,</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+                                      const std::vector&lt;pgp_sk_sesskey_t&gt; &amp;passwords,</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineplus">+                                      void *                               param);</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineplus">+typedef void pgp_decryption_start_func_t(pgp_pk_sesskey_t *pubenc,</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineplus">+                                         pgp_sk_sesskey_t *symenc,</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineplus">+                                         void *            param);</span>
<a href="#l16.18"></a><span id="l16.18" class="difflineplus">+typedef void pgp_decryption_info_func_t(bool           mdc,</span>
<a href="#l16.19"></a><span id="l16.19" class="difflineplus">+                                        pgp_aead_alg_t aead,</span>
<a href="#l16.20"></a><span id="l16.20" class="difflineplus">+                                        pgp_symm_alg_t salg,</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineplus">+                                        void *         param);</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineplus">+typedef void pgp_decryption_done_func_t(bool validated, void *param);</span>
<a href="#l16.23"></a><span id="l16.23" class="difflineplus">+</span>
<a href="#l16.24"></a><span id="l16.24"> /* handler used to return needed information during pgp source processing */</span>
<a href="#l16.25"></a><span id="l16.25"> typedef struct pgp_parse_handler_t {</span>
<a href="#l16.26"></a><span id="l16.26">     pgp_password_provider_t *password_provider; /* if NULL then default will be used */</span>
<a href="#l16.27"></a><span id="l16.27">     pgp_key_provider_t *     key_provider; /* must be set when key is required, i.e. during</span>
<a href="#l16.28"></a><span id="l16.28">                                               signing/verification/public key encryption and</span>
<a href="#l16.29"></a><span id="l16.29">                                               deryption */</span>
<a href="#l16.30"></a><span id="l16.30">     pgp_destination_func_t *dest_provider; /* called when destination stream is required */</span>
<a href="#l16.31"></a><span id="l16.31">     pgp_source_func_t *     src_provider;  /* required to provider source during the detached</span>
<a href="#l16.32"></a><span id="l16.32">                                               signature verification */</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineminus">-    pgp_signatures_func_t *on_signatures;  /* for signature verification results */</span>
<a href="#l16.34"></a><span id="l16.34" class="difflineplus">+    pgp_on_recipients_func_t *   on_recipients;       /* called before decryption start */</span>
<a href="#l16.35"></a><span id="l16.35" class="difflineplus">+    pgp_decryption_start_func_t *on_decryption_start; /* called when decryption key obtained */</span>
<a href="#l16.36"></a><span id="l16.36" class="difflineplus">+    pgp_decryption_info_func_t * on_decryption_info;  /* called when decryption is started */</span>
<a href="#l16.37"></a><span id="l16.37" class="difflineplus">+    pgp_decryption_done_func_t * on_decryption_done;  /* called when decryption is finished */</span>
<a href="#l16.38"></a><span id="l16.38" class="difflineplus">+    pgp_signatures_func_t *      on_signatures;       /* for signature verification results */</span>
<a href="#l16.39"></a><span id="l16.39"> </span>
<a href="#l16.40"></a><span id="l16.40">     rnp_ctx_t *ctx;   /* operation context */</span>
<a href="#l16.41"></a><span id="l16.41">     void *     param; /* additional parameters */</span>
<a href="#l16.42"></a><span id="l16.42"> } pgp_parse_handler_t;</span>
<a href="#l16.43"></a><span id="l16.43"> </span>
<a href="#l16.44"></a><span id="l16.44"> /* @brief Process the OpenPGP source: file, memory, stdin</span>
<a href="#l16.45"></a><span id="l16.45">  * Function will parse input data, provided by any source conforming to pgp_source_t,</span>
<a href="#l16.46"></a><span id="l16.46">  * autodetecting whether it is armored, cleartext or binary.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/third_party/rnp/src/rnp/CMakeLists.txt</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/third_party/rnp/src/rnp/CMakeLists.txt</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -35,15 +35,19 @@ target_include_directories(rnp</span>
<a href="#l17.4"></a><span id="l17.4"> )</span>
<a href="#l17.5"></a><span id="l17.5"> </span>
<a href="#l17.6"></a><span id="l17.6"> target_link_libraries(rnp</span>
<a href="#l17.7"></a><span id="l17.7">   PRIVATE</span>
<a href="#l17.8"></a><span id="l17.8">     librnp</span>
<a href="#l17.9"></a><span id="l17.9">     JSON-C::JSON-C</span>
<a href="#l17.10"></a><span id="l17.10"> )</span>
<a href="#l17.11"></a><span id="l17.11"> </span>
<a href="#l17.12"></a><span id="l17.12" class="difflineplus">+if (WIN32 AND CMAKE_CXX_COMPILER_ID STREQUAL &quot;GNU&quot;)</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+  target_link_libraries(rnp PRIVATE regex)</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineplus">+endif()</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineplus">+</span>
<a href="#l17.16"></a><span id="l17.16"> include(GNUInstallDirs)</span>
<a href="#l17.17"></a><span id="l17.17"> install(TARGETS rnp</span>
<a href="#l17.18"></a><span id="l17.18">   RUNTIME</span>
<a href="#l17.19"></a><span id="l17.19">     DESTINATION &quot;${CMAKE_INSTALL_BINDIR}&quot;</span>
<a href="#l17.20"></a><span id="l17.20">     COMPONENT cli</span>
<a href="#l17.21"></a><span id="l17.21"> )</span>
<a href="#l17.22"></a><span id="l17.22"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/third_party/rnp/src/rnp/fficli.cpp</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/third_party/rnp/src/rnp/fficli.cpp</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -41,16 +41,17 @@</span>
<a href="#l18.4"></a><span id="l18.4"> #ifndef _WIN32</span>
<a href="#l18.5"></a><span id="l18.5"> #include &lt;termios.h&gt;</span>
<a href="#l18.6"></a><span id="l18.6"> #include &lt;sys/resource.h&gt;</span>
<a href="#l18.7"></a><span id="l18.7"> #endif</span>
<a href="#l18.8"></a><span id="l18.8"> </span>
<a href="#l18.9"></a><span id="l18.9"> #include &lt;time.h&gt;</span>
<a href="#l18.10"></a><span id="l18.10"> #include &quot;config.h&quot;</span>
<a href="#l18.11"></a><span id="l18.11"> #include &quot;fficli.h&quot;</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineplus">+#include &quot;utils.h&quot;</span>
<a href="#l18.13"></a><span id="l18.13"> </span>
<a href="#l18.14"></a><span id="l18.14"> // must be placed after include &quot;utils.h&quot;</span>
<a href="#l18.15"></a><span id="l18.15"> #ifndef RNP_USE_STD_REGEX</span>
<a href="#l18.16"></a><span id="l18.16"> #include &lt;regex.h&gt;</span>
<a href="#l18.17"></a><span id="l18.17"> #else</span>
<a href="#l18.18"></a><span id="l18.18"> #include &lt;regex&gt;</span>
<a href="#l18.19"></a><span id="l18.19"> #endif</span>
<a href="#l18.20"></a><span id="l18.20"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/third_party/rnp/src/rnp/fficli.h</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/third_party/rnp/src/rnp/fficli.h</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -147,11 +147,9 @@ bool        rnp_casecmp(const std::strin</span>
<a href="#l19.4"></a><span id="l19.4">         (void) fprintf((stderr), &quot;\n&quot;);        \</span>
<a href="#l19.5"></a><span id="l19.5">     } while (0)</span>
<a href="#l19.6"></a><span id="l19.6"> </span>
<a href="#l19.7"></a><span id="l19.7"> #define EXT_ASC (&quot;.asc&quot;)</span>
<a href="#l19.8"></a><span id="l19.8"> #define EXT_SIG (&quot;.sig&quot;)</span>
<a href="#l19.9"></a><span id="l19.9"> #define EXT_PGP (&quot;.pgp&quot;)</span>
<a href="#l19.10"></a><span id="l19.10"> #define EXT_GPG (&quot;.gpg&quot;)</span>
<a href="#l19.11"></a><span id="l19.11"> </span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-char *rnp_strip_eol(char *s);</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineminus">-</span>
<a href="#l19.14"></a><span id="l19.14"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/third_party/rnp/src/rnpkeys/CMakeLists.txt</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/third_party/rnp/src/rnpkeys/CMakeLists.txt</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -41,14 +41,18 @@ target_include_directories(rnpkeys</span>
<a href="#l20.4"></a><span id="l20.4"> )</span>
<a href="#l20.5"></a><span id="l20.5"> </span>
<a href="#l20.6"></a><span id="l20.6"> target_link_libraries(rnpkeys</span>
<a href="#l20.7"></a><span id="l20.7">   PRIVATE</span>
<a href="#l20.8"></a><span id="l20.8">     librnp</span>
<a href="#l20.9"></a><span id="l20.9">     JSON-C::JSON-C</span>
<a href="#l20.10"></a><span id="l20.10"> )</span>
<a href="#l20.11"></a><span id="l20.11"> </span>
<a href="#l20.12"></a><span id="l20.12" class="difflineplus">+if (WIN32 AND CMAKE_CXX_COMPILER_ID STREQUAL &quot;GNU&quot;)</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+  target_link_libraries(rnpkeys PRIVATE regex)</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineplus">+endif()</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineplus">+</span>
<a href="#l20.16"></a><span id="l20.16"> include(GNUInstallDirs)</span>
<a href="#l20.17"></a><span id="l20.17"> install(TARGETS rnpkeys</span>
<a href="#l20.18"></a><span id="l20.18">   RUNTIME</span>
<a href="#l20.19"></a><span id="l20.19">     DESTINATION &quot;${CMAKE_INSTALL_BINDIR}&quot;</span>
<a href="#l20.20"></a><span id="l20.20">     COMPONENT cli</span>
<a href="#l20.21"></a><span id="l20.21"> )</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/third_party/rnp/src/rnpkeys/tui.cpp</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/third_party/rnp/src/rnpkeys/tui.cpp</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -1,13 +1,14 @@</span>
<a href="#l21.4"></a><span id="l21.4"> #include &lt;unistd.h&gt;</span>
<a href="#l21.5"></a><span id="l21.5"> #include &lt;errno.h&gt;</span>
<a href="#l21.6"></a><span id="l21.6"> #include &quot;rnp/rnpcfg.h&quot;</span>
<a href="#l21.7"></a><span id="l21.7"> #include &quot;rnpkeys.h&quot;</span>
<a href="#l21.8"></a><span id="l21.8"> #include &quot;defaults.h&quot;</span>
<a href="#l21.9"></a><span id="l21.9" class="difflineplus">+#include &quot;utils.h&quot;</span>
<a href="#l21.10"></a><span id="l21.10"> </span>
<a href="#l21.11"></a><span id="l21.11"> /* -----------------------------------------------------------------------------</span>
<a href="#l21.12"></a><span id="l21.12">  * @brief   Reads input from file pointer and converts it securelly to ints</span>
<a href="#l21.13"></a><span id="l21.13">  *          Partially based on ERR34-C from SEI CERT C Coding Standarad</span>
<a href="#l21.14"></a><span id="l21.14">  *</span>
<a href="#l21.15"></a><span id="l21.15">  * @param   fp          pointer to opened pipe</span>
<a href="#l21.16"></a><span id="l21.16">  * @param   result[out] result read from file pointer and converted to int</span>
<a href="#l21.17"></a><span id="l21.17">  *</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/third_party/rnp/src/tests/CMakeLists.txt</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/third_party/rnp/src/tests/CMakeLists.txt</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -89,31 +89,34 @@ add_executable(rnp_tests</span>
<a href="#l22.4"></a><span id="l22.4">   streams.cpp</span>
<a href="#l22.5"></a><span id="l22.5">   support.cpp</span>
<a href="#l22.6"></a><span id="l22.6">   user-prefs.cpp</span>
<a href="#l22.7"></a><span id="l22.7">   utils-hex2bin.cpp</span>
<a href="#l22.8"></a><span id="l22.8">   utils-list.cpp</span>
<a href="#l22.9"></a><span id="l22.9">   utils-rnpcfg.cpp</span>
<a href="#l22.10"></a><span id="l22.10">   issues/1030.cpp</span>
<a href="#l22.11"></a><span id="l22.11">   issues/1115.cpp</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineplus">+  issues/1171.cpp</span>
<a href="#l22.13"></a><span id="l22.13"> )</span>
<a href="#l22.14"></a><span id="l22.14"> </span>
<a href="#l22.15"></a><span id="l22.15"> target_include_directories(rnp_tests</span>
<a href="#l22.16"></a><span id="l22.16">   PRIVATE</span>
<a href="#l22.17"></a><span id="l22.17">     &quot;${PROJECT_SOURCE_DIR}/src&quot;</span>
<a href="#l22.18"></a><span id="l22.18">     &quot;${PROJECT_SOURCE_DIR}/src/lib&quot;</span>
<a href="#l22.19"></a><span id="l22.19"> )</span>
<a href="#l22.20"></a><span id="l22.20"> </span>
<a href="#l22.21"></a><span id="l22.21"> target_link_libraries(rnp_tests</span>
<a href="#l22.22"></a><span id="l22.22">   PRIVATE</span>
<a href="#l22.23"></a><span id="l22.23">     librnp</span>
<a href="#l22.24"></a><span id="l22.24">     JSON-C::JSON-C</span>
<a href="#l22.25"></a><span id="l22.25">     gtest_main</span>
<a href="#l22.26"></a><span id="l22.26"> )</span>
<a href="#l22.27"></a><span id="l22.27" class="difflineminus">-</span>
<a href="#l22.28"></a><span id="l22.28" class="difflineplus">+if (WIN32 AND CMAKE_CXX_COMPILER_ID STREQUAL &quot;GNU&quot;)</span>
<a href="#l22.29"></a><span id="l22.29" class="difflineplus">+  target_link_libraries(rnp_tests PRIVATE regex)</span>
<a href="#l22.30"></a><span id="l22.30" class="difflineplus">+endif()</span>
<a href="#l22.31"></a><span id="l22.31"> target_compile_definitions(rnp_tests</span>
<a href="#l22.32"></a><span id="l22.32">   PRIVATE</span>
<a href="#l22.33"></a><span id="l22.33">     RNP_RUN_TESTS</span>
<a href="#l22.34"></a><span id="l22.34"> )</span>
<a href="#l22.35"></a><span id="l22.35"> </span>
<a href="#l22.36"></a><span id="l22.36"> if (WIN32)</span>
<a href="#l22.37"></a><span id="l22.37">   add_custom_command(TARGET rnp_tests POST_BUILD</span>
<a href="#l22.38"></a><span id="l22.38">     COMMAND ${CMAKE_COMMAND} -E copy_if_different &quot;$&lt;TARGET_FILE:librnp&gt;&quot; &quot;$&lt;TARGET_FILE_DIR:rnp_tests&gt;&quot;)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1">new file mode 100644</span>
<a href="#l23.2"></a><span id="l23.2">index e69de29bb2d1d6434b8b29ae775ad8c2e48c5391..f3d3b1bd416079356d87d8e133044e2233d9750c</span>
<a href="#l23.3"></a><span id="l23.3">GIT binary patch
literal 826
zc$@(`1I7Hoi~}ClKILz%!%YDL|9U&lt;q$wT1YqH-_^(btK0Oz#cxW#7T{%OQjsGRuB&lt;
zXu%;T8e#|Ca`D=JJv&lt;iXQ_jL{re+Jq-R;6*{Z*#M3p{G)wzbgVnkEDv0qcu^5V+kT
zS)u=C%;hfsw&gt;|f=dA-Wzz#d&lt;cqlqNmX(B!aUlTtsOrq60qgp|aR3-xZg29XfiUqiz
zty&lt;pE0R#VZQ*{+rI!|CTpI$DbpcyBUPWV7$&lt;v9kg!AORk?Rr=D)I?j?WgJxP_nviF
zwqe&gt;1Mf8wy$o`hN+0tG1VGlE(sZ=GsVDQpY%l!&gt;NqZf^tyy8$AeWzdvpy_?z(Rb{z
zsBxPP=0(C%xv!q3C3y2vX*!H4UFk0oYiVBTc@Fo%z)k~HP+F5}N|z201OSa*OH?O9
zFT#wlZH_iLC4EwbT*y0mEi;=B^fT&amp;BpX}R&lt;Q^u@hLk&lt;&amp;=^Hq=&lt;v7!$vDDAeD=kODW
zLzZ*Zi(;+EBdq!%UX8a#s;?&gt;A+ps!%+q)l{hb&lt;2EB9nH~4RIU1LrXHKV`}EZOwDGi
z+iiJ-EU9N9E56{CQ43|dn(qVtCCEup%Ff35sDocS^hUO=18#|`V2=o&lt;CEJE&gt;ppXVv
zR6S&amp;wl~NLa&amp;z^NAq0IZZUf#-eOQu$O8a$;K-+NmGwAiGNHki*b34!KgzQr?Pc#;0H
zmleb;(_4!OWI-y~gVTjh@9&lt;|E_S2ul6uRQrUdwKkEZHwYm^=#UDpS51!!85~0|&gt;uD
z7C&amp;CT6j{ErZ&lt;G_5A#D`m64pLur#f;#&amp;Wqt(!y$HDS-33rl|bHR!!85~0|&lt;s$Fzjf0
zI!(FbnCI{d&lt;&lt;8x2134{FgjrDr3UYuMTx%F)0VE`M7qQPH(yIaFr&lt;fFj43X$Zpo{1%
z9In5h6a&amp;77M+@EzRZ(zde-MXXE#f08;y&lt;RePY1GBI&gt;5}rYAH?Z(W|x_lOA9KVr(Va
z_&lt;5`u+`LXjZ=V66iHF_0qkOUfo&lt;ZB*0q{pKq+SNL)Tz-g0BV&lt;EQ*weex&gt;IPc5i=Az
z{EtAjb0v`ztZGv*jLIz7LA2*1a$K7~8t&amp;A4K@jlAe7)Dg`{ae3xxpt3S(rm&lt;&amp;L3Em
E^;Jxa*#H0l</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1">new file mode 100644</span>
<a href="#l24.2"></a><span id="l24.2">index e69de29bb2d1d6434b8b29ae775ad8c2e48c5391..9935fa93efb3b631cd4ab05dfacc2e39a3b0a058</span>
<a href="#l24.3"></a><span id="l24.3">GIT binary patch
literal 468
zc$@*$0W1E&amp;i~}ClKILz%!%YDM0I|9s?v0q5_O&lt;^7&gt;TA1hTqewCS(eRlthc#7nD!MI
ztj89y4d9PTDVh-7O@{vDuk{UXWv?4pu_-OCD5v0^F=y5m9AX7e1R$aMU5lK~f6d@a
zgW}zV*cLw=7#2Di|NIeoYvjwMD@KAO*JIJEAzJl7TR9}OCxG&amp;`_jF{|OT$hD2&gt;}BL
z;6nw5B#D5ez7{P;j-Ri&amp;n)_en&lt;8yx4zO%Qzw&lt;Z_i@$mom#)_&lt;oA&lt;q4&gt;QUOEAjG5sq
zeXzxAcAe3NrqnSxR$^9As*?qD#?-(w0SN&amp;BG!O(o+`zQ9!hQd;;PTa2bOc=_;WJE7
z8MSWtaYyw*%U0T*3*F4VT)gU^)?HyKlgKw5VGKSV_&lt;&lt;I&lt;zklf&amp;wVq9d79ukOvIKq2
z;!;A)Eu(pE!gFD%&gt;UvpO^7ivOzGf?Tn|hOjjz8aC&gt;}40oi-`x(&gt;T;F5IkKffXcE?E
zWpCQJGhkzom`+|h5w_{ZET!&gt;&gt;qt&amp;7OZNP=r5hNz0G&gt;y?~{C@-QM28n%K&lt;vW~hGLc^
zc(&amp;D9581$|9Xy~xy%vOxomPHPX|-ChM%g62A$@~wc6*3p8=woM2um7`G7jIkw~8Ud
KgRrRSk1*tB6zF6C</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1">new file mode 100644</span>
<a href="#l25.2"></a><span id="l25.2">index e69de29bb2d1d6434b8b29ae775ad8c2e48c5391..132d15f726aa615947452fb58e908db55b9ec099</span>
<a href="#l25.3"></a><span id="l25.3">GIT binary patch
literal 468
zc$@*$0W1E&amp;i~}ClKILz%!%YDM0I|9s?v0q5_O&lt;^7&gt;TA1hTqewCS(eRlthc#7nD!MI
ztj89y4d9PTDVh-7O@{vDuk{UXWv?4pu_-OCD5v0^F=y5m9AX7e1R$aMU5lK~f6d@a
zgW}zV*cLw=7#2Di|NIeoYvjwMD@KAO*JIJEAzJl7TR9}OCxG&amp;`_jF{|OT$hD2&gt;}BL
z;6nw5B#D5ez7{P;j-Ri&amp;n)_en&lt;8yx4zO%Qzw&lt;Z_i@$mom#)_&lt;oA&lt;q4&gt;QUOEAjG5sq
zeXzxAcAe3NrqnSxR$^9As*?qD#?-(w0SN&amp;BG!O(o+`zQ9!hQd;;PTa2bOc=_;WJE7
z8MSWtaYyw*%U0T*3*F4VT)gU^)?HyKlgKw5VGKSV_&lt;&lt;I&lt;zklf&amp;wVq9d79ukOvIKq2
z;!;A)Eu(pE!gFD%&gt;UvpO^7ivOzGf?Tn|hOjjz8aC&gt;}40oi-`x(&gt;T;F5IkKffXcE?E
zWpCQJGhkzom`+|h5w_{ZET!&gt;&gt;qt&amp;7OZNP=r5hNz0G&gt;y?~{C@-QM28n%K&lt;vW~hGLc^
zc(&amp;D9581$|9Xy~xy%vOxomPHPX|-ChM%g62A$@~wc6*3p8=woM2um7`G7jIkw~8Xe
KgRrRSk1*tB9q45M</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1">new file mode 100644</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineminus">--- /dev/null</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineplus">+++ b/third_party/rnp/src/tests/data/test_messages/message.txt.enc-aead-ocb</span>
<a href="#l26.4"></a><span id="l26.4" class="difflineat">@@ -0,0 +1,1 @@</span>
<a href="#l26.5"></a><span id="l26.5" class="difflineplus">+ET#\Y{!tBg7%GZ,&quot;R9\&gt;']BV?A]qb8jdsu~fy Aw)JZ:] -acqs1Q3kw:yHH]4[UK[r&gt;*U}&gt;IK^8,V}I /b-/^M/3J9A5-$2*e9r@-;u</span>
<a href="#l26.6"></a><span id="l26.6">\ No newline at end of file</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1">new file mode 100644</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineminus">--- /dev/null</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineplus">+++ b/third_party/rnp/src/tests/data/test_messages/message.txt.enc-aead-ocb-malf</span>
<a href="#l27.4"></a><span id="l27.4" class="difflineat">@@ -0,0 +1,1 @@</span>
<a href="#l27.5"></a><span id="l27.5" class="difflineplus">+ET#\Y{!tBg7%GZ,&quot;R9\&gt;']BV?A]qb8jdsu~fy Aw)JZ:] -acqs1Q3kw:yHH]4[UK[r&gt;*U}&gt;IK^8,V}I /b-/^M/3J9A5-$2*e9r@-;u</span>
<a href="#l27.6"></a><span id="l27.6">\ No newline at end of file</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1">new file mode 100644</span>
<a href="#l28.2"></a><span id="l28.2">index e69de29bb2d1d6434b8b29ae775ad8c2e48c5391..c9461ea7cab7aceb05ba36dd921e33b21a2c78ec</span>
<a href="#l28.3"></a><span id="l28.3">GIT binary patch
literal 320
zc$@)10l)r)j01`VxSy?B-q8UB0L0H`?!Bfc;Yp#L)~1xzRcId5&gt;J@~W1Uxmxs+rw(
zubZA=AC)Jga=j1^&lt;_P;ofC`_5ZWvX!$a$LXol@lew4+ifCkKj(iSun1&lt;KRB&amp;UIa-=
zaLK&amp;pF`iHYv(0p6Fiz_2S9JyRtGqZTtyf7CSH;=niNS!KU_KE*zNqnG%+jy{;Ub-x
z)R+H8Zc2~n==C0nLfh$58(ipwtIHEPKD2YhhPZc1`&amp;kCyJWJlvET(42r{kX`(V`&lt;X
zsD5Jo`o2fT)@LUyDqPhlh!X*PBunW`9&gt;{_U=Z&gt;AvX+7d#0MO2N8ukfz6B?!PGyu9&lt;
zIOg0B+ltx@&gt;I3iwvE9Bmu#WU*Vbv52+Rw;t(WudMCm+Gx)l={-x5v#(ct&gt;w)^dIpK
SzNo4&lt;$`UlA4P8J)??`UtWukBZ</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1">new file mode 100644</span>
<a href="#l29.2"></a><span id="l29.2">index e69de29bb2d1d6434b8b29ae775ad8c2e48c5391..2eeeb17dcbc5dab1d8c2d45e2c6d2004287e6064</span>
<a href="#l29.3"></a><span id="l29.3">GIT binary patch
literal 296
zc$@(!0oVS7j01`VxSy?B-q8UB0FV~Qo=!7wvw+js-xrjpY3b)bJ8qL34^-o=NB$tz
zziRRE`40yasZT+JhNQXwPAp91UW4bhEDOzjv7%ngS^QX!Rym_wPFBQcH;ml|RodZm
zu-yTYaqXX#R||^oS=m8P8YY+`6cIwc^{vlV&gt;oC1cDzfbFAGfQoc{~&lt;&amp;dC8dmruhO6
z2d-&amp;2{EDVT1wOW0+#))2s1M=OhX_Sv04&amp;5kw8-HKmcJb|L$}j0v^0}KN{t)~D*sPS
zrH)f?`8usKPRYJ_*6LE26A+#FAsq@gwJNX&amp;b2#{6=Z%gfh*q0VJ4(v$;3H3M;@&gt;vI
udsX#k9k%X|tDc7WhqyP*ZE}+tB_b3VG?djze|TmHlMzF_2lLg}jKk8Q#E(e;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/third_party/rnp/src/tests/ffi.cpp</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/third_party/rnp/src/tests/ffi.cpp</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -6828,16 +6828,549 @@ TEST_F(rnp_tests, test_ffi_op_verify_sig</span>
<a href="#l30.4"></a><span id="l30.4">     assert_rnp_success(rnp_op_verify_get_signature_count(verify, &amp;sigcount));</span>
<a href="#l30.5"></a><span id="l30.5">     assert_int_equal(sigcount, 0);</span>
<a href="#l30.6"></a><span id="l30.6">     rnp_op_verify_destroy(verify);</span>
<a href="#l30.7"></a><span id="l30.7">     rnp_input_destroy(input);</span>
<a href="#l30.8"></a><span id="l30.8">     rnp_output_destroy(output);</span>
<a href="#l30.9"></a><span id="l30.9">     rnp_ffi_destroy(ffi);</span>
<a href="#l30.10"></a><span id="l30.10"> }</span>
<a href="#l30.11"></a><span id="l30.11"> </span>
<a href="#l30.12"></a><span id="l30.12" class="difflineplus">+TEST_F(rnp_tests, test_ffi_op_verify_get_protection_info)</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineplus">+{</span>
<a href="#l30.14"></a><span id="l30.14" class="difflineplus">+    rnp_ffi_t    ffi = NULL;</span>
<a href="#l30.15"></a><span id="l30.15" class="difflineplus">+    rnp_input_t  input = NULL;</span>
<a href="#l30.16"></a><span id="l30.16" class="difflineplus">+    rnp_output_t output = NULL;</span>
<a href="#l30.17"></a><span id="l30.17" class="difflineplus">+</span>
<a href="#l30.18"></a><span id="l30.18" class="difflineplus">+    // init ffi</span>
<a href="#l30.19"></a><span id="l30.19" class="difflineplus">+    test_ffi_init(&amp;ffi);</span>
<a href="#l30.20"></a><span id="l30.20" class="difflineplus">+    assert_rnp_success(rnp_ffi_set_pass_provider(ffi, getpasscb, (void *) &quot;password&quot;));</span>
<a href="#l30.21"></a><span id="l30.21" class="difflineplus">+</span>
<a href="#l30.22"></a><span id="l30.22" class="difflineplus">+    /* message just signed */</span>
<a href="#l30.23"></a><span id="l30.23" class="difflineplus">+    assert_rnp_success(rnp_input_from_path(&amp;input, &quot;data/test_messages/message.txt.signed&quot;));</span>
<a href="#l30.24"></a><span id="l30.24" class="difflineplus">+    assert_rnp_success(rnp_output_to_null(&amp;output));</span>
<a href="#l30.25"></a><span id="l30.25" class="difflineplus">+    rnp_op_verify_t verify = NULL;</span>
<a href="#l30.26"></a><span id="l30.26" class="difflineplus">+    assert_rnp_success(rnp_op_verify_create(&amp;verify, ffi, input, output));</span>
<a href="#l30.27"></a><span id="l30.27" class="difflineplus">+    assert_rnp_success(rnp_op_verify_execute(verify));</span>
<a href="#l30.28"></a><span id="l30.28" class="difflineplus">+    char *mode = NULL;</span>
<a href="#l30.29"></a><span id="l30.29" class="difflineplus">+    char *cipher = NULL;</span>
<a href="#l30.30"></a><span id="l30.30" class="difflineplus">+    bool  valid = true;</span>
<a href="#l30.31"></a><span id="l30.31" class="difflineplus">+    assert_rnp_failure(rnp_op_verify_get_protection_info(NULL, &amp;mode, &amp;cipher, &amp;valid));</span>
<a href="#l30.32"></a><span id="l30.32" class="difflineplus">+    assert_rnp_success(rnp_op_verify_get_protection_info(verify, &amp;mode, NULL, NULL));</span>
<a href="#l30.33"></a><span id="l30.33" class="difflineplus">+    assert_int_equal(strcmp(mode, &quot;none&quot;), 0);</span>
<a href="#l30.34"></a><span id="l30.34" class="difflineplus">+    rnp_buffer_destroy(mode);</span>
<a href="#l30.35"></a><span id="l30.35" class="difflineplus">+    assert_rnp_success(rnp_op_verify_get_protection_info(verify, NULL, &amp;cipher, NULL));</span>
<a href="#l30.36"></a><span id="l30.36" class="difflineplus">+    assert_int_equal(strcmp(cipher, &quot;none&quot;), 0);</span>
<a href="#l30.37"></a><span id="l30.37" class="difflineplus">+    rnp_buffer_destroy(cipher);</span>
<a href="#l30.38"></a><span id="l30.38" class="difflineplus">+    valid = true;</span>
<a href="#l30.39"></a><span id="l30.39" class="difflineplus">+    assert_rnp_success(rnp_op_verify_get_protection_info(verify, NULL, NULL, &amp;valid));</span>
<a href="#l30.40"></a><span id="l30.40" class="difflineplus">+    assert_false(valid);</span>
<a href="#l30.41"></a><span id="l30.41" class="difflineplus">+    assert_rnp_failure(rnp_op_verify_get_protection_info(verify, NULL, NULL, NULL));</span>
<a href="#l30.42"></a><span id="l30.42" class="difflineplus">+    assert_rnp_success(rnp_op_verify_get_protection_info(verify, &amp;mode, &amp;cipher, &amp;valid));</span>
<a href="#l30.43"></a><span id="l30.43" class="difflineplus">+    assert_int_equal(strcmp(mode, &quot;none&quot;), 0);</span>
<a href="#l30.44"></a><span id="l30.44" class="difflineplus">+    assert_int_equal(strcmp(cipher, &quot;none&quot;), 0);</span>
<a href="#l30.45"></a><span id="l30.45" class="difflineplus">+    assert_false(valid);</span>
<a href="#l30.46"></a><span id="l30.46" class="difflineplus">+    rnp_buffer_destroy(mode);</span>
<a href="#l30.47"></a><span id="l30.47" class="difflineplus">+    rnp_buffer_destroy(cipher);</span>
<a href="#l30.48"></a><span id="l30.48" class="difflineplus">+    rnp_op_verify_destroy(verify);</span>
<a href="#l30.49"></a><span id="l30.49" class="difflineplus">+    rnp_input_destroy(input);</span>
<a href="#l30.50"></a><span id="l30.50" class="difflineplus">+    rnp_output_destroy(output);</span>
<a href="#l30.51"></a><span id="l30.51" class="difflineplus">+</span>
<a href="#l30.52"></a><span id="l30.52" class="difflineplus">+    /* message without MDC */</span>
<a href="#l30.53"></a><span id="l30.53" class="difflineplus">+    assert_rnp_success(</span>
<a href="#l30.54"></a><span id="l30.54" class="difflineplus">+      rnp_input_from_path(&amp;input, &quot;data/test_messages/message.txt.enc-no-mdc&quot;));</span>
<a href="#l30.55"></a><span id="l30.55" class="difflineplus">+    assert_rnp_success(rnp_output_to_null(&amp;output));</span>
<a href="#l30.56"></a><span id="l30.56" class="difflineplus">+    assert_rnp_success(rnp_op_verify_create(&amp;verify, ffi, input, output));</span>
<a href="#l30.57"></a><span id="l30.57" class="difflineplus">+    assert_rnp_success(rnp_op_verify_execute(verify));</span>
<a href="#l30.58"></a><span id="l30.58" class="difflineplus">+    mode = NULL;</span>
<a href="#l30.59"></a><span id="l30.59" class="difflineplus">+    cipher = NULL;</span>
<a href="#l30.60"></a><span id="l30.60" class="difflineplus">+    valid = true;</span>
<a href="#l30.61"></a><span id="l30.61" class="difflineplus">+    assert_rnp_success(rnp_op_verify_get_protection_info(verify, &amp;mode, &amp;cipher, &amp;valid));</span>
<a href="#l30.62"></a><span id="l30.62" class="difflineplus">+    assert_int_equal(strcmp(mode, &quot;cfb&quot;), 0);</span>
<a href="#l30.63"></a><span id="l30.63" class="difflineplus">+    assert_int_equal(strcmp(cipher, &quot;AES256&quot;), 0);</span>
<a href="#l30.64"></a><span id="l30.64" class="difflineplus">+    assert_false(valid);</span>
<a href="#l30.65"></a><span id="l30.65" class="difflineplus">+    rnp_buffer_destroy(mode);</span>
<a href="#l30.66"></a><span id="l30.66" class="difflineplus">+    rnp_buffer_destroy(cipher);</span>
<a href="#l30.67"></a><span id="l30.67" class="difflineplus">+    rnp_op_verify_destroy(verify);</span>
<a href="#l30.68"></a><span id="l30.68" class="difflineplus">+    rnp_input_destroy(input);</span>
<a href="#l30.69"></a><span id="l30.69" class="difflineplus">+    rnp_output_destroy(output);</span>
<a href="#l30.70"></a><span id="l30.70" class="difflineplus">+</span>
<a href="#l30.71"></a><span id="l30.71" class="difflineplus">+    /* message with MDC */</span>
<a href="#l30.72"></a><span id="l30.72" class="difflineplus">+    assert_rnp_success(rnp_input_from_path(&amp;input, &quot;data/test_messages/message.txt.enc-mdc&quot;));</span>
<a href="#l30.73"></a><span id="l30.73" class="difflineplus">+    assert_rnp_success(rnp_output_to_null(&amp;output));</span>
<a href="#l30.74"></a><span id="l30.74" class="difflineplus">+    assert_rnp_success(rnp_op_verify_create(&amp;verify, ffi, input, output));</span>
<a href="#l30.75"></a><span id="l30.75" class="difflineplus">+    assert_rnp_success(rnp_op_verify_execute(verify));</span>
<a href="#l30.76"></a><span id="l30.76" class="difflineplus">+    mode = NULL;</span>
<a href="#l30.77"></a><span id="l30.77" class="difflineplus">+    cipher = NULL;</span>
<a href="#l30.78"></a><span id="l30.78" class="difflineplus">+    valid = false;</span>
<a href="#l30.79"></a><span id="l30.79" class="difflineplus">+    assert_rnp_success(rnp_op_verify_get_protection_info(verify, &amp;mode, &amp;cipher, &amp;valid));</span>
<a href="#l30.80"></a><span id="l30.80" class="difflineplus">+    assert_int_equal(strcmp(mode, &quot;cfb-mdc&quot;), 0);</span>
<a href="#l30.81"></a><span id="l30.81" class="difflineplus">+    assert_int_equal(strcmp(cipher, &quot;AES256&quot;), 0);</span>
<a href="#l30.82"></a><span id="l30.82" class="difflineplus">+    assert_true(valid);</span>
<a href="#l30.83"></a><span id="l30.83" class="difflineplus">+    rnp_buffer_destroy(mode);</span>
<a href="#l30.84"></a><span id="l30.84" class="difflineplus">+    rnp_buffer_destroy(cipher);</span>
<a href="#l30.85"></a><span id="l30.85" class="difflineplus">+    rnp_op_verify_destroy(verify);</span>
<a href="#l30.86"></a><span id="l30.86" class="difflineplus">+    rnp_input_destroy(input);</span>
<a href="#l30.87"></a><span id="l30.87" class="difflineplus">+    rnp_output_destroy(output);</span>
<a href="#l30.88"></a><span id="l30.88" class="difflineplus">+</span>
<a href="#l30.89"></a><span id="l30.89" class="difflineplus">+    /* message with AEAD-OCB */</span>
<a href="#l30.90"></a><span id="l30.90" class="difflineplus">+    assert_rnp_success(</span>
<a href="#l30.91"></a><span id="l30.91" class="difflineplus">+      rnp_input_from_path(&amp;input, &quot;data/test_messages/message.txt.enc-aead-ocb&quot;));</span>
<a href="#l30.92"></a><span id="l30.92" class="difflineplus">+    assert_rnp_success(rnp_output_to_null(&amp;output));</span>
<a href="#l30.93"></a><span id="l30.93" class="difflineplus">+    assert_rnp_success(rnp_op_verify_create(&amp;verify, ffi, input, output));</span>
<a href="#l30.94"></a><span id="l30.94" class="difflineplus">+    assert_rnp_success(rnp_op_verify_execute(verify));</span>
<a href="#l30.95"></a><span id="l30.95" class="difflineplus">+    mode = NULL;</span>
<a href="#l30.96"></a><span id="l30.96" class="difflineplus">+    cipher = NULL;</span>
<a href="#l30.97"></a><span id="l30.97" class="difflineplus">+    valid = false;</span>
<a href="#l30.98"></a><span id="l30.98" class="difflineplus">+    assert_rnp_success(rnp_op_verify_get_protection_info(verify, &amp;mode, &amp;cipher, &amp;valid));</span>
<a href="#l30.99"></a><span id="l30.99" class="difflineplus">+    assert_int_equal(strcmp(mode, &quot;aead-ocb&quot;), 0);</span>
<a href="#l30.100"></a><span id="l30.100" class="difflineplus">+    assert_int_equal(strcmp(cipher, &quot;CAMELLIA192&quot;), 0);</span>
<a href="#l30.101"></a><span id="l30.101" class="difflineplus">+    assert_true(valid);</span>
<a href="#l30.102"></a><span id="l30.102" class="difflineplus">+    rnp_buffer_destroy(mode);</span>
<a href="#l30.103"></a><span id="l30.103" class="difflineplus">+    rnp_buffer_destroy(cipher);</span>
<a href="#l30.104"></a><span id="l30.104" class="difflineplus">+    rnp_op_verify_destroy(verify);</span>
<a href="#l30.105"></a><span id="l30.105" class="difflineplus">+    rnp_input_destroy(input);</span>
<a href="#l30.106"></a><span id="l30.106" class="difflineplus">+    rnp_output_destroy(output);</span>
<a href="#l30.107"></a><span id="l30.107" class="difflineplus">+</span>
<a href="#l30.108"></a><span id="l30.108" class="difflineplus">+    /* modified message with AEAD-OCB */</span>
<a href="#l30.109"></a><span id="l30.109" class="difflineplus">+    assert_rnp_success(</span>
<a href="#l30.110"></a><span id="l30.110" class="difflineplus">+      rnp_input_from_path(&amp;input, &quot;data/test_messages/message.txt.enc-aead-ocb-malf&quot;));</span>
<a href="#l30.111"></a><span id="l30.111" class="difflineplus">+    assert_rnp_success(rnp_output_to_null(&amp;output));</span>
<a href="#l30.112"></a><span id="l30.112" class="difflineplus">+    assert_rnp_success(rnp_op_verify_create(&amp;verify, ffi, input, output));</span>
<a href="#l30.113"></a><span id="l30.113" class="difflineplus">+    assert_rnp_failure(rnp_op_verify_execute(verify));</span>
<a href="#l30.114"></a><span id="l30.114" class="difflineplus">+    mode = NULL;</span>
<a href="#l30.115"></a><span id="l30.115" class="difflineplus">+    cipher = NULL;</span>
<a href="#l30.116"></a><span id="l30.116" class="difflineplus">+    valid = false;</span>
<a href="#l30.117"></a><span id="l30.117" class="difflineplus">+    assert_rnp_success(rnp_op_verify_get_protection_info(verify, &amp;mode, &amp;cipher, &amp;valid));</span>
<a href="#l30.118"></a><span id="l30.118" class="difflineplus">+    assert_int_equal(strcmp(mode, &quot;aead-ocb&quot;), 0);</span>
<a href="#l30.119"></a><span id="l30.119" class="difflineplus">+    assert_int_equal(strcmp(cipher, &quot;CAMELLIA192&quot;), 0);</span>
<a href="#l30.120"></a><span id="l30.120" class="difflineplus">+    assert_false(valid);</span>
<a href="#l30.121"></a><span id="l30.121" class="difflineplus">+    rnp_buffer_destroy(mode);</span>
<a href="#l30.122"></a><span id="l30.122" class="difflineplus">+    rnp_buffer_destroy(cipher);</span>
<a href="#l30.123"></a><span id="l30.123" class="difflineplus">+    rnp_op_verify_destroy(verify);</span>
<a href="#l30.124"></a><span id="l30.124" class="difflineplus">+    rnp_input_destroy(input);</span>
<a href="#l30.125"></a><span id="l30.125" class="difflineplus">+    rnp_output_destroy(output);</span>
<a href="#l30.126"></a><span id="l30.126" class="difflineplus">+</span>
<a href="#l30.127"></a><span id="l30.127" class="difflineplus">+    /* message with AEAD-EAX */</span>
<a href="#l30.128"></a><span id="l30.128" class="difflineplus">+    assert_rnp_success(</span>
<a href="#l30.129"></a><span id="l30.129" class="difflineplus">+      rnp_input_from_path(&amp;input, &quot;data/test_messages/message.txt.enc-aead-eax&quot;));</span>
<a href="#l30.130"></a><span id="l30.130" class="difflineplus">+    assert_rnp_success(rnp_output_to_null(&amp;output));</span>
<a href="#l30.131"></a><span id="l30.131" class="difflineplus">+    assert_rnp_success(rnp_op_verify_create(&amp;verify, ffi, input, output));</span>
<a href="#l30.132"></a><span id="l30.132" class="difflineplus">+    assert_rnp_success(rnp_op_verify_execute(verify));</span>
<a href="#l30.133"></a><span id="l30.133" class="difflineplus">+    mode = NULL;</span>
<a href="#l30.134"></a><span id="l30.134" class="difflineplus">+    cipher = NULL;</span>
<a href="#l30.135"></a><span id="l30.135" class="difflineplus">+    valid = false;</span>
<a href="#l30.136"></a><span id="l30.136" class="difflineplus">+    assert_rnp_success(rnp_op_verify_get_protection_info(verify, &amp;mode, &amp;cipher, &amp;valid));</span>
<a href="#l30.137"></a><span id="l30.137" class="difflineplus">+    assert_int_equal(strcmp(mode, &quot;aead-eax&quot;), 0);</span>
<a href="#l30.138"></a><span id="l30.138" class="difflineplus">+    assert_int_equal(strcmp(cipher, &quot;AES256&quot;), 0);</span>
<a href="#l30.139"></a><span id="l30.139" class="difflineplus">+    assert_true(valid);</span>
<a href="#l30.140"></a><span id="l30.140" class="difflineplus">+    rnp_buffer_destroy(mode);</span>
<a href="#l30.141"></a><span id="l30.141" class="difflineplus">+    rnp_buffer_destroy(cipher);</span>
<a href="#l30.142"></a><span id="l30.142" class="difflineplus">+    rnp_op_verify_destroy(verify);</span>
<a href="#l30.143"></a><span id="l30.143" class="difflineplus">+    rnp_input_destroy(input);</span>
<a href="#l30.144"></a><span id="l30.144" class="difflineplus">+    rnp_output_destroy(output);</span>
<a href="#l30.145"></a><span id="l30.145" class="difflineplus">+</span>
<a href="#l30.146"></a><span id="l30.146" class="difflineplus">+    /* modified message with AEAD-EAX */</span>
<a href="#l30.147"></a><span id="l30.147" class="difflineplus">+    assert_rnp_success(</span>
<a href="#l30.148"></a><span id="l30.148" class="difflineplus">+      rnp_input_from_path(&amp;input, &quot;data/test_messages/message.txt.enc-aead-eax-malf&quot;));</span>
<a href="#l30.149"></a><span id="l30.149" class="difflineplus">+    assert_rnp_success(rnp_output_to_null(&amp;output));</span>
<a href="#l30.150"></a><span id="l30.150" class="difflineplus">+    assert_rnp_success(rnp_op_verify_create(&amp;verify, ffi, input, output));</span>
<a href="#l30.151"></a><span id="l30.151" class="difflineplus">+    assert_rnp_failure(rnp_op_verify_execute(verify));</span>
<a href="#l30.152"></a><span id="l30.152" class="difflineplus">+    mode = NULL;</span>
<a href="#l30.153"></a><span id="l30.153" class="difflineplus">+    cipher = NULL;</span>
<a href="#l30.154"></a><span id="l30.154" class="difflineplus">+    valid = false;</span>
<a href="#l30.155"></a><span id="l30.155" class="difflineplus">+    assert_rnp_success(rnp_op_verify_get_protection_info(verify, &amp;mode, &amp;cipher, &amp;valid));</span>
<a href="#l30.156"></a><span id="l30.156" class="difflineplus">+    assert_int_equal(strcmp(mode, &quot;aead-eax&quot;), 0);</span>
<a href="#l30.157"></a><span id="l30.157" class="difflineplus">+    assert_int_equal(strcmp(cipher, &quot;AES256&quot;), 0);</span>
<a href="#l30.158"></a><span id="l30.158" class="difflineplus">+    assert_false(valid);</span>
<a href="#l30.159"></a><span id="l30.159" class="difflineplus">+    rnp_buffer_destroy(mode);</span>
<a href="#l30.160"></a><span id="l30.160" class="difflineplus">+    rnp_buffer_destroy(cipher);</span>
<a href="#l30.161"></a><span id="l30.161" class="difflineplus">+    rnp_op_verify_destroy(verify);</span>
<a href="#l30.162"></a><span id="l30.162" class="difflineplus">+    rnp_input_destroy(input);</span>
<a href="#l30.163"></a><span id="l30.163" class="difflineplus">+    rnp_output_destroy(output);</span>
<a href="#l30.164"></a><span id="l30.164" class="difflineplus">+</span>
<a href="#l30.165"></a><span id="l30.165" class="difflineplus">+    rnp_ffi_destroy(ffi);</span>
<a href="#l30.166"></a><span id="l30.166" class="difflineplus">+}</span>
<a href="#l30.167"></a><span id="l30.167" class="difflineplus">+</span>
<a href="#l30.168"></a><span id="l30.168" class="difflineplus">+static bool</span>
<a href="#l30.169"></a><span id="l30.169" class="difflineplus">+getpasscb_for_key(rnp_ffi_t        ffi,</span>
<a href="#l30.170"></a><span id="l30.170" class="difflineplus">+                  void *           app_ctx,</span>
<a href="#l30.171"></a><span id="l30.171" class="difflineplus">+                  rnp_key_handle_t key,</span>
<a href="#l30.172"></a><span id="l30.172" class="difflineplus">+                  const char *     pgp_context,</span>
<a href="#l30.173"></a><span id="l30.173" class="difflineplus">+                  char *           buf,</span>
<a href="#l30.174"></a><span id="l30.174" class="difflineplus">+                  size_t           buf_len)</span>
<a href="#l30.175"></a><span id="l30.175" class="difflineplus">+{</span>
<a href="#l30.176"></a><span id="l30.176" class="difflineplus">+    if (!key) {</span>
<a href="#l30.177"></a><span id="l30.177" class="difflineplus">+        return false;</span>
<a href="#l30.178"></a><span id="l30.178" class="difflineplus">+    }</span>
<a href="#l30.179"></a><span id="l30.179" class="difflineplus">+    char *keyid = NULL;</span>
<a href="#l30.180"></a><span id="l30.180" class="difflineplus">+    rnp_key_get_keyid(key, &amp;keyid);</span>
<a href="#l30.181"></a><span id="l30.181" class="difflineplus">+    const char *pass = &quot;password&quot;;</span>
<a href="#l30.182"></a><span id="l30.182" class="difflineplus">+    if (strcmp(keyid, (const char *) app_ctx) != 0) {</span>
<a href="#l30.183"></a><span id="l30.183" class="difflineplus">+        pass = &quot;wrongpassword&quot;;</span>
<a href="#l30.184"></a><span id="l30.184" class="difflineplus">+    }</span>
<a href="#l30.185"></a><span id="l30.185" class="difflineplus">+    rnp_buffer_destroy(keyid);</span>
<a href="#l30.186"></a><span id="l30.186" class="difflineplus">+    strcpy(buf, pass);</span>
<a href="#l30.187"></a><span id="l30.187" class="difflineplus">+    return true;</span>
<a href="#l30.188"></a><span id="l30.188" class="difflineplus">+}</span>
<a href="#l30.189"></a><span id="l30.189" class="difflineplus">+</span>
<a href="#l30.190"></a><span id="l30.190" class="difflineplus">+TEST_F(rnp_tests, test_ffi_op_verify_recipients_info)</span>
<a href="#l30.191"></a><span id="l30.191" class="difflineplus">+{</span>
<a href="#l30.192"></a><span id="l30.192" class="difflineplus">+    rnp_ffi_t    ffi = NULL;</span>
<a href="#l30.193"></a><span id="l30.193" class="difflineplus">+    rnp_input_t  input = NULL;</span>
<a href="#l30.194"></a><span id="l30.194" class="difflineplus">+    rnp_output_t output = NULL;</span>
<a href="#l30.195"></a><span id="l30.195" class="difflineplus">+</span>
<a href="#l30.196"></a><span id="l30.196" class="difflineplus">+    // init ffi</span>
<a href="#l30.197"></a><span id="l30.197" class="difflineplus">+    test_ffi_init(&amp;ffi);</span>
<a href="#l30.198"></a><span id="l30.198" class="difflineplus">+    assert_rnp_success(rnp_ffi_set_pass_provider(ffi, getpasscb, (void *) &quot;password&quot;));</span>
<a href="#l30.199"></a><span id="l30.199" class="difflineplus">+</span>
<a href="#l30.200"></a><span id="l30.200" class="difflineplus">+    /* message just signed */</span>
<a href="#l30.201"></a><span id="l30.201" class="difflineplus">+    assert_rnp_success(rnp_input_from_path(&amp;input, &quot;data/test_messages/message.txt.signed&quot;));</span>
<a href="#l30.202"></a><span id="l30.202" class="difflineplus">+    assert_rnp_success(rnp_output_to_null(&amp;output));</span>
<a href="#l30.203"></a><span id="l30.203" class="difflineplus">+    rnp_op_verify_t verify = NULL;</span>
<a href="#l30.204"></a><span id="l30.204" class="difflineplus">+    assert_rnp_success(rnp_op_verify_create(&amp;verify, ffi, input, output));</span>
<a href="#l30.205"></a><span id="l30.205" class="difflineplus">+    assert_rnp_success(rnp_op_verify_execute(verify));</span>
<a href="#l30.206"></a><span id="l30.206" class="difflineplus">+    /* rnp_op_verify_get_recipient_count */</span>
<a href="#l30.207"></a><span id="l30.207" class="difflineplus">+    assert_rnp_failure(rnp_op_verify_get_recipient_count(verify, NULL));</span>
<a href="#l30.208"></a><span id="l30.208" class="difflineplus">+    size_t count = 255;</span>
<a href="#l30.209"></a><span id="l30.209" class="difflineplus">+    assert_rnp_failure(rnp_op_verify_get_recipient_count(NULL, &amp;count));</span>
<a href="#l30.210"></a><span id="l30.210" class="difflineplus">+    assert_rnp_success(rnp_op_verify_get_recipient_count(verify, &amp;count));</span>
<a href="#l30.211"></a><span id="l30.211" class="difflineplus">+    assert_int_equal(count, 0);</span>
<a href="#l30.212"></a><span id="l30.212" class="difflineplus">+    /* rnp_op_verify_get_recipient_at */</span>
<a href="#l30.213"></a><span id="l30.213" class="difflineplus">+    rnp_recipient_handle_t recipient = NULL;</span>
<a href="#l30.214"></a><span id="l30.214" class="difflineplus">+    assert_rnp_failure(rnp_op_verify_get_recipient_at(NULL, 0, &amp;recipient));</span>
<a href="#l30.215"></a><span id="l30.215" class="difflineplus">+    assert_rnp_failure(rnp_op_verify_get_recipient_at(verify, 0, NULL));</span>
<a href="#l30.216"></a><span id="l30.216" class="difflineplus">+    assert_rnp_failure(rnp_op_verify_get_recipient_at(verify, 0, &amp;recipient));</span>
<a href="#l30.217"></a><span id="l30.217" class="difflineplus">+    assert_rnp_failure(rnp_op_verify_get_recipient_at(verify, 10, &amp;recipient));</span>
<a href="#l30.218"></a><span id="l30.218" class="difflineplus">+    /* rnp_op_verify_get_used_recipient */</span>
<a href="#l30.219"></a><span id="l30.219" class="difflineplus">+    assert_rnp_failure(rnp_op_verify_get_used_recipient(NULL, &amp;recipient));</span>
<a href="#l30.220"></a><span id="l30.220" class="difflineplus">+    assert_rnp_failure(rnp_op_verify_get_used_recipient(verify, NULL));</span>
<a href="#l30.221"></a><span id="l30.221" class="difflineplus">+    assert_rnp_success(rnp_op_verify_get_used_recipient(verify, &amp;recipient));</span>
<a href="#l30.222"></a><span id="l30.222" class="difflineplus">+    assert_null(recipient);</span>
<a href="#l30.223"></a><span id="l30.223" class="difflineplus">+    /* rnp_op_verify_get_symenc_count */</span>
<a href="#l30.224"></a><span id="l30.224" class="difflineplus">+    assert_rnp_failure(rnp_op_verify_get_symenc_count(verify, NULL));</span>
<a href="#l30.225"></a><span id="l30.225" class="difflineplus">+    count = 255;</span>
<a href="#l30.226"></a><span id="l30.226" class="difflineplus">+    assert_rnp_failure(rnp_op_verify_get_symenc_count(NULL, &amp;count));</span>
<a href="#l30.227"></a><span id="l30.227" class="difflineplus">+    assert_rnp_success(rnp_op_verify_get_symenc_count(verify, &amp;count));</span>
<a href="#l30.228"></a><span id="l30.228" class="difflineplus">+    assert_int_equal(count, 0);</span>
<a href="#l30.229"></a><span id="l30.229" class="difflineplus">+    /* rnp_op_verify_get_symenc_at */</span>
<a href="#l30.230"></a><span id="l30.230" class="difflineplus">+    rnp_symenc_handle_t symenc = NULL;</span>
<a href="#l30.231"></a><span id="l30.231" class="difflineplus">+    assert_rnp_failure(rnp_op_verify_get_symenc_at(NULL, 0, &amp;symenc));</span>
<a href="#l30.232"></a><span id="l30.232" class="difflineplus">+    assert_rnp_failure(rnp_op_verify_get_symenc_at(verify, 0, NULL));</span>
<a href="#l30.233"></a><span id="l30.233" class="difflineplus">+    assert_rnp_failure(rnp_op_verify_get_symenc_at(verify, 0, &amp;symenc));</span>
<a href="#l30.234"></a><span id="l30.234" class="difflineplus">+    assert_rnp_failure(rnp_op_verify_get_symenc_at(verify, 10, &amp;symenc));</span>
<a href="#l30.235"></a><span id="l30.235" class="difflineplus">+    /* rnp_op_verify_get_used_symenc */</span>
<a href="#l30.236"></a><span id="l30.236" class="difflineplus">+    assert_rnp_failure(rnp_op_verify_get_used_symenc(NULL, &amp;symenc));</span>
<a href="#l30.237"></a><span id="l30.237" class="difflineplus">+    assert_rnp_failure(rnp_op_verify_get_used_symenc(verify, NULL));</span>
<a href="#l30.238"></a><span id="l30.238" class="difflineplus">+    assert_rnp_success(rnp_op_verify_get_used_symenc(verify, &amp;symenc));</span>
<a href="#l30.239"></a><span id="l30.239" class="difflineplus">+    assert_null(symenc);</span>
<a href="#l30.240"></a><span id="l30.240" class="difflineplus">+    rnp_op_verify_destroy(verify);</span>
<a href="#l30.241"></a><span id="l30.241" class="difflineplus">+    rnp_input_destroy(input);</span>
<a href="#l30.242"></a><span id="l30.242" class="difflineplus">+    rnp_output_destroy(output);</span>
<a href="#l30.243"></a><span id="l30.243" class="difflineplus">+</span>
<a href="#l30.244"></a><span id="l30.244" class="difflineplus">+    /* message without MDC: single recipient */</span>
<a href="#l30.245"></a><span id="l30.245" class="difflineplus">+    assert_rnp_success(</span>
<a href="#l30.246"></a><span id="l30.246" class="difflineplus">+      rnp_input_from_path(&amp;input, &quot;data/test_messages/message.txt.enc-no-mdc&quot;));</span>
<a href="#l30.247"></a><span id="l30.247" class="difflineplus">+    assert_rnp_success(rnp_output_to_null(&amp;output));</span>
<a href="#l30.248"></a><span id="l30.248" class="difflineplus">+    assert_rnp_success(rnp_op_verify_create(&amp;verify, ffi, input, output));</span>
<a href="#l30.249"></a><span id="l30.249" class="difflineplus">+    assert_rnp_success(rnp_op_verify_execute(verify));</span>
<a href="#l30.250"></a><span id="l30.250" class="difflineplus">+    assert_rnp_success(rnp_op_verify_get_recipient_count(verify, &amp;count));</span>
<a href="#l30.251"></a><span id="l30.251" class="difflineplus">+    assert_int_equal(count, 1);</span>
<a href="#l30.252"></a><span id="l30.252" class="difflineplus">+    assert_rnp_failure(rnp_op_verify_get_recipient_at(verify, 1, &amp;recipient));</span>
<a href="#l30.253"></a><span id="l30.253" class="difflineplus">+    assert_rnp_success(rnp_op_verify_get_recipient_at(verify, 0, &amp;recipient));</span>
<a href="#l30.254"></a><span id="l30.254" class="difflineplus">+    assert_non_null(recipient);</span>
<a href="#l30.255"></a><span id="l30.255" class="difflineplus">+    char *alg = NULL;</span>
<a href="#l30.256"></a><span id="l30.256" class="difflineplus">+    assert_rnp_failure(rnp_recipient_get_alg(NULL, &amp;alg));</span>
<a href="#l30.257"></a><span id="l30.257" class="difflineplus">+    assert_rnp_failure(rnp_recipient_get_alg(recipient, NULL));</span>
<a href="#l30.258"></a><span id="l30.258" class="difflineplus">+    assert_rnp_success(rnp_recipient_get_alg(recipient, &amp;alg));</span>
<a href="#l30.259"></a><span id="l30.259" class="difflineplus">+    assert_string_equal(alg, &quot;RSA&quot;);</span>
<a href="#l30.260"></a><span id="l30.260" class="difflineplus">+    rnp_buffer_destroy(alg);</span>
<a href="#l30.261"></a><span id="l30.261" class="difflineplus">+    char *keyid = NULL;</span>
<a href="#l30.262"></a><span id="l30.262" class="difflineplus">+    assert_rnp_failure(rnp_recipient_get_keyid(NULL, &amp;keyid));</span>
<a href="#l30.263"></a><span id="l30.263" class="difflineplus">+    assert_rnp_failure(rnp_recipient_get_keyid(recipient, NULL));</span>
<a href="#l30.264"></a><span id="l30.264" class="difflineplus">+    assert_rnp_success(rnp_recipient_get_keyid(recipient, &amp;keyid));</span>
<a href="#l30.265"></a><span id="l30.265" class="difflineplus">+    assert_string_equal(keyid, &quot;8A05B89FAD5ADED1&quot;);</span>
<a href="#l30.266"></a><span id="l30.266" class="difflineplus">+    rnp_buffer_destroy(keyid);</span>
<a href="#l30.267"></a><span id="l30.267" class="difflineplus">+    recipient = NULL;</span>
<a href="#l30.268"></a><span id="l30.268" class="difflineplus">+    assert_rnp_success(rnp_op_verify_get_used_recipient(verify, &amp;recipient));</span>
<a href="#l30.269"></a><span id="l30.269" class="difflineplus">+    assert_non_null(recipient);</span>
<a href="#l30.270"></a><span id="l30.270" class="difflineplus">+    alg = NULL;</span>
<a href="#l30.271"></a><span id="l30.271" class="difflineplus">+    assert_rnp_success(rnp_recipient_get_alg(recipient, &amp;alg));</span>
<a href="#l30.272"></a><span id="l30.272" class="difflineplus">+    assert_string_equal(alg, &quot;RSA&quot;);</span>
<a href="#l30.273"></a><span id="l30.273" class="difflineplus">+    rnp_buffer_destroy(alg);</span>
<a href="#l30.274"></a><span id="l30.274" class="difflineplus">+    keyid = NULL;</span>
<a href="#l30.275"></a><span id="l30.275" class="difflineplus">+    assert_rnp_success(rnp_recipient_get_keyid(recipient, &amp;keyid));</span>
<a href="#l30.276"></a><span id="l30.276" class="difflineplus">+    assert_string_equal(keyid, &quot;8A05B89FAD5ADED1&quot;);</span>
<a href="#l30.277"></a><span id="l30.277" class="difflineplus">+    rnp_buffer_destroy(keyid);</span>
<a href="#l30.278"></a><span id="l30.278" class="difflineplus">+    assert_rnp_success(rnp_op_verify_get_symenc_count(verify, &amp;count));</span>
<a href="#l30.279"></a><span id="l30.279" class="difflineplus">+    assert_int_equal(count, 0);</span>
<a href="#l30.280"></a><span id="l30.280" class="difflineplus">+    rnp_op_verify_destroy(verify);</span>
<a href="#l30.281"></a><span id="l30.281" class="difflineplus">+    rnp_input_destroy(input);</span>
<a href="#l30.282"></a><span id="l30.282" class="difflineplus">+    rnp_output_destroy(output);</span>
<a href="#l30.283"></a><span id="l30.283" class="difflineplus">+</span>
<a href="#l30.284"></a><span id="l30.284" class="difflineplus">+    /* message with AEAD-OCB: single password */</span>
<a href="#l30.285"></a><span id="l30.285" class="difflineplus">+    assert_rnp_success(</span>
<a href="#l30.286"></a><span id="l30.286" class="difflineplus">+      rnp_input_from_path(&amp;input, &quot;data/test_messages/message.txt.enc-aead-ocb&quot;));</span>
<a href="#l30.287"></a><span id="l30.287" class="difflineplus">+    assert_rnp_success(rnp_output_to_null(&amp;output));</span>
<a href="#l30.288"></a><span id="l30.288" class="difflineplus">+    assert_rnp_success(rnp_op_verify_create(&amp;verify, ffi, input, output));</span>
<a href="#l30.289"></a><span id="l30.289" class="difflineplus">+    assert_rnp_success(rnp_op_verify_execute(verify));</span>
<a href="#l30.290"></a><span id="l30.290" class="difflineplus">+    count = 255;</span>
<a href="#l30.291"></a><span id="l30.291" class="difflineplus">+    assert_rnp_success(rnp_op_verify_get_recipient_count(verify, &amp;count));</span>
<a href="#l30.292"></a><span id="l30.292" class="difflineplus">+    assert_int_equal(count, 0);</span>
<a href="#l30.293"></a><span id="l30.293" class="difflineplus">+    assert_rnp_success(rnp_op_verify_get_symenc_count(verify, &amp;count));</span>
<a href="#l30.294"></a><span id="l30.294" class="difflineplus">+    assert_int_equal(count, 1);</span>
<a href="#l30.295"></a><span id="l30.295" class="difflineplus">+    assert_rnp_failure(rnp_op_verify_get_symenc_at(verify, 1, &amp;symenc));</span>
<a href="#l30.296"></a><span id="l30.296" class="difflineplus">+    assert_rnp_success(rnp_op_verify_get_symenc_at(verify, 0, &amp;symenc));</span>
<a href="#l30.297"></a><span id="l30.297" class="difflineplus">+    assert_non_null(symenc);</span>
<a href="#l30.298"></a><span id="l30.298" class="difflineplus">+    char *cipher = NULL;</span>
<a href="#l30.299"></a><span id="l30.299" class="difflineplus">+    assert_rnp_failure(rnp_symenc_get_cipher(symenc, NULL));</span>
<a href="#l30.300"></a><span id="l30.300" class="difflineplus">+    assert_rnp_success(rnp_symenc_get_cipher(symenc, &amp;cipher));</span>
<a href="#l30.301"></a><span id="l30.301" class="difflineplus">+    assert_string_equal(cipher, &quot;CAMELLIA192&quot;);</span>
<a href="#l30.302"></a><span id="l30.302" class="difflineplus">+    rnp_buffer_destroy(cipher);</span>
<a href="#l30.303"></a><span id="l30.303" class="difflineplus">+    char *aead = NULL;</span>
<a href="#l30.304"></a><span id="l30.304" class="difflineplus">+    assert_rnp_failure(rnp_symenc_get_aead_alg(symenc, NULL));</span>
<a href="#l30.305"></a><span id="l30.305" class="difflineplus">+    assert_rnp_success(rnp_symenc_get_aead_alg(symenc, &amp;aead));</span>
<a href="#l30.306"></a><span id="l30.306" class="difflineplus">+    assert_string_equal(aead, &quot;OCB&quot;);</span>
<a href="#l30.307"></a><span id="l30.307" class="difflineplus">+    rnp_buffer_destroy(aead);</span>
<a href="#l30.308"></a><span id="l30.308" class="difflineplus">+    char *hash = NULL;</span>
<a href="#l30.309"></a><span id="l30.309" class="difflineplus">+    assert_rnp_failure(rnp_symenc_get_hash_alg(symenc, NULL));</span>
<a href="#l30.310"></a><span id="l30.310" class="difflineplus">+    assert_rnp_success(rnp_symenc_get_hash_alg(symenc, &amp;hash));</span>
<a href="#l30.311"></a><span id="l30.311" class="difflineplus">+    assert_string_equal(hash, &quot;SHA1&quot;);</span>
<a href="#l30.312"></a><span id="l30.312" class="difflineplus">+    rnp_buffer_destroy(hash);</span>
<a href="#l30.313"></a><span id="l30.313" class="difflineplus">+    char *s2k = NULL;</span>
<a href="#l30.314"></a><span id="l30.314" class="difflineplus">+    assert_rnp_failure(rnp_symenc_get_s2k_type(symenc, NULL));</span>
<a href="#l30.315"></a><span id="l30.315" class="difflineplus">+    assert_rnp_success(rnp_symenc_get_s2k_type(symenc, &amp;s2k));</span>
<a href="#l30.316"></a><span id="l30.316" class="difflineplus">+    assert_string_equal(s2k, &quot;Iterated and salted&quot;);</span>
<a href="#l30.317"></a><span id="l30.317" class="difflineplus">+    rnp_buffer_destroy(s2k);</span>
<a href="#l30.318"></a><span id="l30.318" class="difflineplus">+    uint32_t iterations = 0;</span>
<a href="#l30.319"></a><span id="l30.319" class="difflineplus">+    assert_rnp_failure(rnp_symenc_get_s2k_iterations(symenc, NULL));</span>
<a href="#l30.320"></a><span id="l30.320" class="difflineplus">+    assert_rnp_success(rnp_symenc_get_s2k_iterations(symenc, &amp;iterations));</span>
<a href="#l30.321"></a><span id="l30.321" class="difflineplus">+    assert_int_equal(iterations, 30408704);</span>
<a href="#l30.322"></a><span id="l30.322" class="difflineplus">+    assert_rnp_success(rnp_op_verify_get_used_symenc(verify, &amp;symenc));</span>
<a href="#l30.323"></a><span id="l30.323" class="difflineplus">+    assert_non_null(symenc);</span>
<a href="#l30.324"></a><span id="l30.324" class="difflineplus">+    cipher = NULL;</span>
<a href="#l30.325"></a><span id="l30.325" class="difflineplus">+    assert_rnp_success(rnp_symenc_get_cipher(symenc, &amp;cipher));</span>
<a href="#l30.326"></a><span id="l30.326" class="difflineplus">+    assert_string_equal(cipher, &quot;CAMELLIA192&quot;);</span>
<a href="#l30.327"></a><span id="l30.327" class="difflineplus">+    rnp_buffer_destroy(cipher);</span>
<a href="#l30.328"></a><span id="l30.328" class="difflineplus">+    aead = NULL;</span>
<a href="#l30.329"></a><span id="l30.329" class="difflineplus">+    assert_rnp_success(rnp_symenc_get_aead_alg(symenc, &amp;aead));</span>
<a href="#l30.330"></a><span id="l30.330" class="difflineplus">+    assert_string_equal(aead, &quot;OCB&quot;);</span>
<a href="#l30.331"></a><span id="l30.331" class="difflineplus">+    rnp_buffer_destroy(aead);</span>
<a href="#l30.332"></a><span id="l30.332" class="difflineplus">+    hash = NULL;</span>
<a href="#l30.333"></a><span id="l30.333" class="difflineplus">+    assert_rnp_success(rnp_symenc_get_hash_alg(symenc, &amp;hash));</span>
<a href="#l30.334"></a><span id="l30.334" class="difflineplus">+    assert_string_equal(hash, &quot;SHA1&quot;);</span>
<a href="#l30.335"></a><span id="l30.335" class="difflineplus">+    rnp_buffer_destroy(hash);</span>
<a href="#l30.336"></a><span id="l30.336" class="difflineplus">+    s2k = NULL;</span>
<a href="#l30.337"></a><span id="l30.337" class="difflineplus">+    assert_rnp_success(rnp_symenc_get_s2k_type(symenc, &amp;s2k));</span>
<a href="#l30.338"></a><span id="l30.338" class="difflineplus">+    assert_string_equal(s2k, &quot;Iterated and salted&quot;);</span>
<a href="#l30.339"></a><span id="l30.339" class="difflineplus">+    rnp_buffer_destroy(s2k);</span>
<a href="#l30.340"></a><span id="l30.340" class="difflineplus">+    iterations = 0;</span>
<a href="#l30.341"></a><span id="l30.341" class="difflineplus">+    assert_rnp_success(rnp_symenc_get_s2k_iterations(symenc, &amp;iterations));</span>
<a href="#l30.342"></a><span id="l30.342" class="difflineplus">+    assert_int_equal(iterations, 30408704);</span>
<a href="#l30.343"></a><span id="l30.343" class="difflineplus">+    rnp_op_verify_destroy(verify);</span>
<a href="#l30.344"></a><span id="l30.344" class="difflineplus">+    rnp_input_destroy(input);</span>
<a href="#l30.345"></a><span id="l30.345" class="difflineplus">+    rnp_output_destroy(output);</span>
<a href="#l30.346"></a><span id="l30.346" class="difflineplus">+</span>
<a href="#l30.347"></a><span id="l30.347" class="difflineplus">+    /* modified message with AEAD-EAX: one recipient and one password, decrypt with recipient</span>
<a href="#l30.348"></a><span id="l30.348" class="difflineplus">+     */</span>
<a href="#l30.349"></a><span id="l30.349" class="difflineplus">+    assert_rnp_success(</span>
<a href="#l30.350"></a><span id="l30.350" class="difflineplus">+      rnp_input_from_path(&amp;input, &quot;data/test_messages/message.txt.enc-aead-eax-malf&quot;));</span>
<a href="#l30.351"></a><span id="l30.351" class="difflineplus">+    assert_rnp_success(rnp_output_to_null(&amp;output));</span>
<a href="#l30.352"></a><span id="l30.352" class="difflineplus">+    assert_rnp_success(rnp_op_verify_create(&amp;verify, ffi, input, output));</span>
<a href="#l30.353"></a><span id="l30.353" class="difflineplus">+    assert_rnp_failure(rnp_op_verify_execute(verify));</span>
<a href="#l30.354"></a><span id="l30.354" class="difflineplus">+    count = 255;</span>
<a href="#l30.355"></a><span id="l30.355" class="difflineplus">+    assert_rnp_success(rnp_op_verify_get_recipient_count(verify, &amp;count));</span>
<a href="#l30.356"></a><span id="l30.356" class="difflineplus">+    assert_int_equal(count, 1);</span>
<a href="#l30.357"></a><span id="l30.357" class="difflineplus">+    assert_rnp_success(rnp_op_verify_get_recipient_at(verify, 0, &amp;recipient));</span>
<a href="#l30.358"></a><span id="l30.358" class="difflineplus">+    assert_non_null(recipient);</span>
<a href="#l30.359"></a><span id="l30.359" class="difflineplus">+    alg = NULL;</span>
<a href="#l30.360"></a><span id="l30.360" class="difflineplus">+    assert_rnp_success(rnp_recipient_get_alg(recipient, &amp;alg));</span>
<a href="#l30.361"></a><span id="l30.361" class="difflineplus">+    assert_string_equal(alg, &quot;RSA&quot;);</span>
<a href="#l30.362"></a><span id="l30.362" class="difflineplus">+    rnp_buffer_destroy(alg);</span>
<a href="#l30.363"></a><span id="l30.363" class="difflineplus">+    keyid = NULL;</span>
<a href="#l30.364"></a><span id="l30.364" class="difflineplus">+    assert_rnp_success(rnp_recipient_get_keyid(recipient, &amp;keyid));</span>
<a href="#l30.365"></a><span id="l30.365" class="difflineplus">+    assert_string_equal(keyid, &quot;1ED63EE56FADC34D&quot;);</span>
<a href="#l30.366"></a><span id="l30.366" class="difflineplus">+    rnp_buffer_destroy(keyid);</span>
<a href="#l30.367"></a><span id="l30.367" class="difflineplus">+    recipient = NULL;</span>
<a href="#l30.368"></a><span id="l30.368" class="difflineplus">+    assert_rnp_success(rnp_op_verify_get_used_recipient(verify, &amp;recipient));</span>
<a href="#l30.369"></a><span id="l30.369" class="difflineplus">+    assert_non_null(recipient);</span>
<a href="#l30.370"></a><span id="l30.370" class="difflineplus">+    assert_rnp_success(rnp_recipient_get_alg(recipient, &amp;alg));</span>
<a href="#l30.371"></a><span id="l30.371" class="difflineplus">+    assert_string_equal(alg, &quot;RSA&quot;);</span>
<a href="#l30.372"></a><span id="l30.372" class="difflineplus">+    rnp_buffer_destroy(alg);</span>
<a href="#l30.373"></a><span id="l30.373" class="difflineplus">+    assert_rnp_success(rnp_recipient_get_keyid(recipient, &amp;keyid));</span>
<a href="#l30.374"></a><span id="l30.374" class="difflineplus">+    assert_string_equal(keyid, &quot;1ED63EE56FADC34D&quot;);</span>
<a href="#l30.375"></a><span id="l30.375" class="difflineplus">+    rnp_buffer_destroy(keyid);</span>
<a href="#l30.376"></a><span id="l30.376" class="difflineplus">+    assert_rnp_success(rnp_op_verify_get_used_recipient(verify, &amp;recipient));</span>
<a href="#l30.377"></a><span id="l30.377" class="difflineplus">+    assert_non_null(recipient);</span>
<a href="#l30.378"></a><span id="l30.378" class="difflineplus">+    alg = NULL;</span>
<a href="#l30.379"></a><span id="l30.379" class="difflineplus">+    assert_rnp_success(rnp_recipient_get_alg(recipient, &amp;alg));</span>
<a href="#l30.380"></a><span id="l30.380" class="difflineplus">+    assert_string_equal(alg, &quot;RSA&quot;);</span>
<a href="#l30.381"></a><span id="l30.381" class="difflineplus">+    rnp_buffer_destroy(alg);</span>
<a href="#l30.382"></a><span id="l30.382" class="difflineplus">+    keyid = NULL;</span>
<a href="#l30.383"></a><span id="l30.383" class="difflineplus">+    assert_rnp_success(rnp_recipient_get_keyid(recipient, &amp;keyid));</span>
<a href="#l30.384"></a><span id="l30.384" class="difflineplus">+    assert_string_equal(keyid, &quot;1ED63EE56FADC34D&quot;);</span>
<a href="#l30.385"></a><span id="l30.385" class="difflineplus">+    rnp_buffer_destroy(keyid);</span>
<a href="#l30.386"></a><span id="l30.386" class="difflineplus">+    recipient = NULL;</span>
<a href="#l30.387"></a><span id="l30.387" class="difflineplus">+    assert_rnp_success(rnp_op_verify_get_used_recipient(verify, &amp;recipient));</span>
<a href="#l30.388"></a><span id="l30.388" class="difflineplus">+    assert_non_null(recipient);</span>
<a href="#l30.389"></a><span id="l30.389" class="difflineplus">+    assert_rnp_success(rnp_recipient_get_alg(recipient, &amp;alg));</span>
<a href="#l30.390"></a><span id="l30.390" class="difflineplus">+    assert_string_equal(alg, &quot;RSA&quot;);</span>
<a href="#l30.391"></a><span id="l30.391" class="difflineplus">+    rnp_buffer_destroy(alg);</span>
<a href="#l30.392"></a><span id="l30.392" class="difflineplus">+    assert_rnp_success(rnp_recipient_get_keyid(recipient, &amp;keyid));</span>
<a href="#l30.393"></a><span id="l30.393" class="difflineplus">+    assert_string_equal(keyid, &quot;1ED63EE56FADC34D&quot;);</span>
<a href="#l30.394"></a><span id="l30.394" class="difflineplus">+    rnp_buffer_destroy(keyid);</span>
<a href="#l30.395"></a><span id="l30.395" class="difflineplus">+</span>
<a href="#l30.396"></a><span id="l30.396" class="difflineplus">+    count = 255;</span>
<a href="#l30.397"></a><span id="l30.397" class="difflineplus">+    assert_rnp_success(rnp_op_verify_get_symenc_count(verify, &amp;count));</span>
<a href="#l30.398"></a><span id="l30.398" class="difflineplus">+    assert_int_equal(count, 1);</span>
<a href="#l30.399"></a><span id="l30.399" class="difflineplus">+    assert_rnp_success(rnp_op_verify_get_symenc_at(verify, 0, &amp;symenc));</span>
<a href="#l30.400"></a><span id="l30.400" class="difflineplus">+    assert_non_null(symenc);</span>
<a href="#l30.401"></a><span id="l30.401" class="difflineplus">+    cipher = NULL;</span>
<a href="#l30.402"></a><span id="l30.402" class="difflineplus">+    assert_rnp_success(rnp_symenc_get_cipher(symenc, &amp;cipher));</span>
<a href="#l30.403"></a><span id="l30.403" class="difflineplus">+    assert_string_equal(cipher, &quot;AES256&quot;);</span>
<a href="#l30.404"></a><span id="l30.404" class="difflineplus">+    rnp_buffer_destroy(cipher);</span>
<a href="#l30.405"></a><span id="l30.405" class="difflineplus">+    aead = NULL;</span>
<a href="#l30.406"></a><span id="l30.406" class="difflineplus">+    assert_rnp_success(rnp_symenc_get_aead_alg(symenc, &amp;aead));</span>
<a href="#l30.407"></a><span id="l30.407" class="difflineplus">+    assert_string_equal(aead, &quot;EAX&quot;);</span>
<a href="#l30.408"></a><span id="l30.408" class="difflineplus">+    rnp_buffer_destroy(aead);</span>
<a href="#l30.409"></a><span id="l30.409" class="difflineplus">+    hash = NULL;</span>
<a href="#l30.410"></a><span id="l30.410" class="difflineplus">+    assert_rnp_success(rnp_symenc_get_hash_alg(symenc, &amp;hash));</span>
<a href="#l30.411"></a><span id="l30.411" class="difflineplus">+    assert_string_equal(hash, &quot;SHA256&quot;);</span>
<a href="#l30.412"></a><span id="l30.412" class="difflineplus">+    rnp_buffer_destroy(hash);</span>
<a href="#l30.413"></a><span id="l30.413" class="difflineplus">+    s2k = NULL;</span>
<a href="#l30.414"></a><span id="l30.414" class="difflineplus">+    assert_rnp_success(rnp_symenc_get_s2k_type(symenc, &amp;s2k));</span>
<a href="#l30.415"></a><span id="l30.415" class="difflineplus">+    assert_string_equal(s2k, &quot;Iterated and salted&quot;);</span>
<a href="#l30.416"></a><span id="l30.416" class="difflineplus">+    rnp_buffer_destroy(s2k);</span>
<a href="#l30.417"></a><span id="l30.417" class="difflineplus">+    iterations = 0;</span>
<a href="#l30.418"></a><span id="l30.418" class="difflineplus">+    assert_rnp_success(rnp_symenc_get_s2k_iterations(symenc, &amp;iterations));</span>
<a href="#l30.419"></a><span id="l30.419" class="difflineplus">+    assert_int_equal(iterations, 3932160);</span>
<a href="#l30.420"></a><span id="l30.420" class="difflineplus">+    assert_rnp_success(rnp_op_verify_get_used_symenc(verify, &amp;symenc));</span>
<a href="#l30.421"></a><span id="l30.421" class="difflineplus">+    assert_null(symenc);</span>
<a href="#l30.422"></a><span id="l30.422" class="difflineplus">+    rnp_op_verify_destroy(verify);</span>
<a href="#l30.423"></a><span id="l30.423" class="difflineplus">+    rnp_input_destroy(input);</span>
<a href="#l30.424"></a><span id="l30.424" class="difflineplus">+    rnp_output_destroy(output);</span>
<a href="#l30.425"></a><span id="l30.425" class="difflineplus">+</span>
<a href="#l30.426"></a><span id="l30.426" class="difflineplus">+    /* message with AEAD-EAX: one recipient and one password, decrypt with password */</span>
<a href="#l30.427"></a><span id="l30.427" class="difflineplus">+    assert_rnp_success(rnp_unload_keys(ffi, RNP_KEY_UNLOAD_SECRET));</span>
<a href="#l30.428"></a><span id="l30.428" class="difflineplus">+    assert_rnp_success(</span>
<a href="#l30.429"></a><span id="l30.429" class="difflineplus">+      rnp_input_from_path(&amp;input, &quot;data/test_messages/message.txt.enc-aead-eax&quot;));</span>
<a href="#l30.430"></a><span id="l30.430" class="difflineplus">+    assert_rnp_success(rnp_output_to_null(&amp;output));</span>
<a href="#l30.431"></a><span id="l30.431" class="difflineplus">+    assert_rnp_success(rnp_op_verify_create(&amp;verify, ffi, input, output));</span>
<a href="#l30.432"></a><span id="l30.432" class="difflineplus">+    assert_rnp_success(rnp_op_verify_execute(verify));</span>
<a href="#l30.433"></a><span id="l30.433" class="difflineplus">+    count = 255;</span>
<a href="#l30.434"></a><span id="l30.434" class="difflineplus">+    assert_rnp_success(rnp_op_verify_get_recipient_count(verify, &amp;count));</span>
<a href="#l30.435"></a><span id="l30.435" class="difflineplus">+    assert_int_equal(count, 1);</span>
<a href="#l30.436"></a><span id="l30.436" class="difflineplus">+    assert_rnp_success(rnp_op_verify_get_used_recipient(verify, &amp;recipient));</span>
<a href="#l30.437"></a><span id="l30.437" class="difflineplus">+    assert_null(recipient);</span>
<a href="#l30.438"></a><span id="l30.438" class="difflineplus">+    count = 255;</span>
<a href="#l30.439"></a><span id="l30.439" class="difflineplus">+    assert_rnp_success(rnp_op_verify_get_symenc_count(verify, &amp;count));</span>
<a href="#l30.440"></a><span id="l30.440" class="difflineplus">+    assert_int_equal(count, 1);</span>
<a href="#l30.441"></a><span id="l30.441" class="difflineplus">+    assert_rnp_success(rnp_op_verify_get_symenc_at(verify, 0, &amp;symenc));</span>
<a href="#l30.442"></a><span id="l30.442" class="difflineplus">+    assert_non_null(symenc);</span>
<a href="#l30.443"></a><span id="l30.443" class="difflineplus">+    assert_rnp_success(rnp_op_verify_get_used_symenc(verify, &amp;symenc));</span>
<a href="#l30.444"></a><span id="l30.444" class="difflineplus">+    assert_non_null(symenc);</span>
<a href="#l30.445"></a><span id="l30.445" class="difflineplus">+    cipher = NULL;</span>
<a href="#l30.446"></a><span id="l30.446" class="difflineplus">+    assert_rnp_success(rnp_symenc_get_cipher(symenc, &amp;cipher));</span>
<a href="#l30.447"></a><span id="l30.447" class="difflineplus">+    assert_string_equal(cipher, &quot;AES256&quot;);</span>
<a href="#l30.448"></a><span id="l30.448" class="difflineplus">+    rnp_buffer_destroy(cipher);</span>
<a href="#l30.449"></a><span id="l30.449" class="difflineplus">+    aead = NULL;</span>
<a href="#l30.450"></a><span id="l30.450" class="difflineplus">+    assert_rnp_success(rnp_symenc_get_aead_alg(symenc, &amp;aead));</span>
<a href="#l30.451"></a><span id="l30.451" class="difflineplus">+    assert_string_equal(aead, &quot;EAX&quot;);</span>
<a href="#l30.452"></a><span id="l30.452" class="difflineplus">+    rnp_buffer_destroy(aead);</span>
<a href="#l30.453"></a><span id="l30.453" class="difflineplus">+    hash = NULL;</span>
<a href="#l30.454"></a><span id="l30.454" class="difflineplus">+    assert_rnp_success(rnp_symenc_get_hash_alg(symenc, &amp;hash));</span>
<a href="#l30.455"></a><span id="l30.455" class="difflineplus">+    assert_string_equal(hash, &quot;SHA256&quot;);</span>
<a href="#l30.456"></a><span id="l30.456" class="difflineplus">+    rnp_buffer_destroy(hash);</span>
<a href="#l30.457"></a><span id="l30.457" class="difflineplus">+    s2k = NULL;</span>
<a href="#l30.458"></a><span id="l30.458" class="difflineplus">+    assert_rnp_success(rnp_symenc_get_s2k_type(symenc, &amp;s2k));</span>
<a href="#l30.459"></a><span id="l30.459" class="difflineplus">+    assert_string_equal(s2k, &quot;Iterated and salted&quot;);</span>
<a href="#l30.460"></a><span id="l30.460" class="difflineplus">+    rnp_buffer_destroy(s2k);</span>
<a href="#l30.461"></a><span id="l30.461" class="difflineplus">+    iterations = 0;</span>
<a href="#l30.462"></a><span id="l30.462" class="difflineplus">+    assert_rnp_success(rnp_symenc_get_s2k_iterations(symenc, &amp;iterations));</span>
<a href="#l30.463"></a><span id="l30.463" class="difflineplus">+    assert_int_equal(iterations, 3932160);</span>
<a href="#l30.464"></a><span id="l30.464" class="difflineplus">+    rnp_op_verify_destroy(verify);</span>
<a href="#l30.465"></a><span id="l30.465" class="difflineplus">+    rnp_input_destroy(input);</span>
<a href="#l30.466"></a><span id="l30.466" class="difflineplus">+    rnp_output_destroy(output);</span>
<a href="#l30.467"></a><span id="l30.467" class="difflineplus">+</span>
<a href="#l30.468"></a><span id="l30.468" class="difflineplus">+    /* message encrypted to 3 recipients and 2 passwords: password1, password2 */</span>
<a href="#l30.469"></a><span id="l30.469" class="difflineplus">+    assert_rnp_success(rnp_ffi_set_pass_provider(ffi, getpasscb, (void *) &quot;wrongpassword&quot;));</span>
<a href="#l30.470"></a><span id="l30.470" class="difflineplus">+    assert_rnp_success(rnp_input_from_path(&amp;input, &quot;data/keyrings/1/secring.gpg&quot;));</span>
<a href="#l30.471"></a><span id="l30.471" class="difflineplus">+    assert_rnp_success(rnp_import_keys(ffi, input, RNP_LOAD_SAVE_SECRET_KEYS, NULL));</span>
<a href="#l30.472"></a><span id="l30.472" class="difflineplus">+    rnp_input_destroy(input);</span>
<a href="#l30.473"></a><span id="l30.473" class="difflineplus">+    assert_rnp_success(</span>
<a href="#l30.474"></a><span id="l30.474" class="difflineplus">+      rnp_input_from_path(&amp;input, &quot;data/test_messages/message.txt.enc-3key-2p&quot;));</span>
<a href="#l30.475"></a><span id="l30.475" class="difflineplus">+    assert_rnp_success(rnp_output_to_null(&amp;output));</span>
<a href="#l30.476"></a><span id="l30.476" class="difflineplus">+    assert_rnp_success(rnp_op_verify_create(&amp;verify, ffi, input, output));</span>
<a href="#l30.477"></a><span id="l30.477" class="difflineplus">+    assert_rnp_failure(rnp_op_verify_execute(verify));</span>
<a href="#l30.478"></a><span id="l30.478" class="difflineplus">+    count = 255;</span>
<a href="#l30.479"></a><span id="l30.479" class="difflineplus">+    assert_rnp_success(rnp_op_verify_get_recipient_count(verify, &amp;count));</span>
<a href="#l30.480"></a><span id="l30.480" class="difflineplus">+    assert_int_equal(count, 3);</span>
<a href="#l30.481"></a><span id="l30.481" class="difflineplus">+    assert_rnp_success(rnp_op_verify_get_recipient_at(verify, 0, &amp;recipient));</span>
<a href="#l30.482"></a><span id="l30.482" class="difflineplus">+    assert_rnp_success(rnp_recipient_get_keyid(recipient, &amp;keyid));</span>
<a href="#l30.483"></a><span id="l30.483" class="difflineplus">+    assert_string_equal(keyid, &quot;1ED63EE56FADC34D&quot;);</span>
<a href="#l30.484"></a><span id="l30.484" class="difflineplus">+    rnp_buffer_destroy(keyid);</span>
<a href="#l30.485"></a><span id="l30.485" class="difflineplus">+    assert_rnp_success(rnp_op_verify_get_recipient_at(verify, 1, &amp;recipient));</span>
<a href="#l30.486"></a><span id="l30.486" class="difflineplus">+    assert_rnp_success(rnp_recipient_get_keyid(recipient, &amp;keyid));</span>
<a href="#l30.487"></a><span id="l30.487" class="difflineplus">+    assert_string_equal(keyid, &quot;8A05B89FAD5ADED1&quot;);</span>
<a href="#l30.488"></a><span id="l30.488" class="difflineplus">+    rnp_buffer_destroy(keyid);</span>
<a href="#l30.489"></a><span id="l30.489" class="difflineplus">+    assert_rnp_success(rnp_op_verify_get_recipient_at(verify, 2, &amp;recipient));</span>
<a href="#l30.490"></a><span id="l30.490" class="difflineplus">+    assert_rnp_success(rnp_recipient_get_keyid(recipient, &amp;keyid));</span>
<a href="#l30.491"></a><span id="l30.491" class="difflineplus">+    assert_string_equal(keyid, &quot;54505A936A4A970E&quot;);</span>
<a href="#l30.492"></a><span id="l30.492" class="difflineplus">+    rnp_buffer_destroy(keyid);</span>
<a href="#l30.493"></a><span id="l30.493" class="difflineplus">+    assert_rnp_success(rnp_op_verify_get_used_recipient(verify, &amp;recipient));</span>
<a href="#l30.494"></a><span id="l30.494" class="difflineplus">+    assert_null(recipient);</span>
<a href="#l30.495"></a><span id="l30.495" class="difflineplus">+    count = 255;</span>
<a href="#l30.496"></a><span id="l30.496" class="difflineplus">+    assert_rnp_success(rnp_op_verify_get_symenc_count(verify, &amp;count));</span>
<a href="#l30.497"></a><span id="l30.497" class="difflineplus">+    assert_int_equal(count, 2);</span>
<a href="#l30.498"></a><span id="l30.498" class="difflineplus">+    assert_rnp_success(rnp_op_verify_get_symenc_at(verify, 0, &amp;symenc));</span>
<a href="#l30.499"></a><span id="l30.499" class="difflineplus">+    assert_rnp_success(rnp_symenc_get_s2k_iterations(symenc, &amp;iterations));</span>
<a href="#l30.500"></a><span id="l30.500" class="difflineplus">+    assert_int_equal(iterations, 3932160);</span>
<a href="#l30.501"></a><span id="l30.501" class="difflineplus">+    assert_rnp_success(rnp_op_verify_get_symenc_at(verify, 1, &amp;symenc));</span>
<a href="#l30.502"></a><span id="l30.502" class="difflineplus">+    assert_rnp_success(rnp_symenc_get_s2k_iterations(symenc, &amp;iterations));</span>
<a href="#l30.503"></a><span id="l30.503" class="difflineplus">+    assert_int_equal(iterations, 3276800);</span>
<a href="#l30.504"></a><span id="l30.504" class="difflineplus">+    assert_rnp_success(rnp_op_verify_get_used_symenc(verify, &amp;symenc));</span>
<a href="#l30.505"></a><span id="l30.505" class="difflineplus">+    assert_null(symenc);</span>
<a href="#l30.506"></a><span id="l30.506" class="difflineplus">+    rnp_op_verify_destroy(verify);</span>
<a href="#l30.507"></a><span id="l30.507" class="difflineplus">+    rnp_input_destroy(input);</span>
<a href="#l30.508"></a><span id="l30.508" class="difflineplus">+    rnp_output_destroy(output);</span>
<a href="#l30.509"></a><span id="l30.509" class="difflineplus">+</span>
<a href="#l30.510"></a><span id="l30.510" class="difflineplus">+    assert_rnp_success(rnp_ffi_set_pass_provider(ffi, getpasscb, (void *) &quot;password2&quot;));</span>
<a href="#l30.511"></a><span id="l30.511" class="difflineplus">+    assert_rnp_success(</span>
<a href="#l30.512"></a><span id="l30.512" class="difflineplus">+      rnp_input_from_path(&amp;input, &quot;data/test_messages/message.txt.enc-3key-2p&quot;));</span>
<a href="#l30.513"></a><span id="l30.513" class="difflineplus">+    assert_rnp_success(rnp_output_to_null(&amp;output));</span>
<a href="#l30.514"></a><span id="l30.514" class="difflineplus">+    assert_rnp_success(rnp_op_verify_create(&amp;verify, ffi, input, output));</span>
<a href="#l30.515"></a><span id="l30.515" class="difflineplus">+    assert_rnp_success(rnp_op_verify_execute(verify));</span>
<a href="#l30.516"></a><span id="l30.516" class="difflineplus">+    assert_rnp_success(rnp_op_verify_get_used_symenc(verify, &amp;symenc));</span>
<a href="#l30.517"></a><span id="l30.517" class="difflineplus">+    assert_rnp_success(rnp_symenc_get_s2k_iterations(symenc, &amp;iterations));</span>
<a href="#l30.518"></a><span id="l30.518" class="difflineplus">+    assert_rnp_success(rnp_op_verify_get_used_recipient(verify, &amp;recipient));</span>
<a href="#l30.519"></a><span id="l30.519" class="difflineplus">+    assert_null(recipient);</span>
<a href="#l30.520"></a><span id="l30.520" class="difflineplus">+    assert_int_equal(iterations, 3276800);</span>
<a href="#l30.521"></a><span id="l30.521" class="difflineplus">+    rnp_op_verify_destroy(verify);</span>
<a href="#l30.522"></a><span id="l30.522" class="difflineplus">+    rnp_input_destroy(input);</span>
<a href="#l30.523"></a><span id="l30.523" class="difflineplus">+    rnp_output_destroy(output);</span>
<a href="#l30.524"></a><span id="l30.524" class="difflineplus">+</span>
<a href="#l30.525"></a><span id="l30.525" class="difflineplus">+    assert_rnp_success(</span>
<a href="#l30.526"></a><span id="l30.526" class="difflineplus">+      rnp_ffi_set_pass_provider(ffi, getpasscb_for_key, (void *) &quot;8A05B89FAD5ADED1&quot;));</span>
<a href="#l30.527"></a><span id="l30.527" class="difflineplus">+    assert_rnp_success(</span>
<a href="#l30.528"></a><span id="l30.528" class="difflineplus">+      rnp_input_from_path(&amp;input, &quot;data/test_messages/message.txt.enc-3key-2p&quot;));</span>
<a href="#l30.529"></a><span id="l30.529" class="difflineplus">+    assert_rnp_success(rnp_output_to_null(&amp;output));</span>
<a href="#l30.530"></a><span id="l30.530" class="difflineplus">+    assert_rnp_success(rnp_op_verify_create(&amp;verify, ffi, input, output));</span>
<a href="#l30.531"></a><span id="l30.531" class="difflineplus">+    assert_rnp_success(rnp_op_verify_execute(verify));</span>
<a href="#l30.532"></a><span id="l30.532" class="difflineplus">+    assert_rnp_success(rnp_op_verify_get_used_symenc(verify, &amp;symenc));</span>
<a href="#l30.533"></a><span id="l30.533" class="difflineplus">+    assert_null(symenc);</span>
<a href="#l30.534"></a><span id="l30.534" class="difflineplus">+    assert_rnp_success(rnp_op_verify_get_used_recipient(verify, &amp;recipient));</span>
<a href="#l30.535"></a><span id="l30.535" class="difflineplus">+    assert_rnp_success(rnp_recipient_get_keyid(recipient, &amp;keyid));</span>
<a href="#l30.536"></a><span id="l30.536" class="difflineplus">+    assert_string_equal(keyid, &quot;8A05B89FAD5ADED1&quot;);</span>
<a href="#l30.537"></a><span id="l30.537" class="difflineplus">+    rnp_buffer_destroy(keyid);</span>
<a href="#l30.538"></a><span id="l30.538" class="difflineplus">+    rnp_op_verify_destroy(verify);</span>
<a href="#l30.539"></a><span id="l30.539" class="difflineplus">+    rnp_input_destroy(input);</span>
<a href="#l30.540"></a><span id="l30.540" class="difflineplus">+    rnp_output_destroy(output);</span>
<a href="#l30.541"></a><span id="l30.541" class="difflineplus">+</span>
<a href="#l30.542"></a><span id="l30.542" class="difflineplus">+    rnp_ffi_destroy(ffi);</span>
<a href="#l30.543"></a><span id="l30.543" class="difflineplus">+}</span>
<a href="#l30.544"></a><span id="l30.544" class="difflineplus">+</span>
<a href="#l30.545"></a><span id="l30.545"> static bool</span>
<a href="#l30.546"></a><span id="l30.546"> check_import_sigs(rnp_ffi_t ffi, json_object **jso, json_object **sigarr, const char *sigpath)</span>
<a href="#l30.547"></a><span id="l30.547"> {</span>
<a href="#l30.548"></a><span id="l30.548">     rnp_input_t input = NULL;</span>
<a href="#l30.549"></a><span id="l30.549">     if (rnp_input_from_path(&amp;input, sigpath)) {</span>
<a href="#l30.550"></a><span id="l30.550">         return false;</span>
<a href="#l30.551"></a><span id="l30.551">     }</span>
<a href="#l30.552"></a><span id="l30.552">     bool  res = false;</span>
<a href="#l30.553"></a><span id="l30.553" class="difflineat">@@ -7855,8 +8388,172 @@ TEST_F(rnp_tests, test_ffi_key_import_ed</span>
<a href="#l30.554"></a><span id="l30.554">     rnp_buffer_destroy(results);</span>
<a href="#l30.555"></a><span id="l30.555">     revoked = false;</span>
<a href="#l30.556"></a><span id="l30.556">     assert_rnp_success(rnp_key_is_revoked(key, &amp;revoked));</span>
<a href="#l30.557"></a><span id="l30.557">     assert_true(revoked);</span>
<a href="#l30.558"></a><span id="l30.558">     rnp_key_handle_destroy(key);</span>
<a href="#l30.559"></a><span id="l30.559"> </span>
<a href="#l30.560"></a><span id="l30.560">     rnp_ffi_destroy(ffi);</span>
<a href="#l30.561"></a><span id="l30.561"> }</span>
<a href="#l30.562"></a><span id="l30.562" class="difflineplus">+</span>
<a href="#l30.563"></a><span id="l30.563" class="difflineplus">+TEST_F(rnp_tests, test_ffi_key_remove)</span>
<a href="#l30.564"></a><span id="l30.564" class="difflineplus">+{</span>
<a href="#l30.565"></a><span id="l30.565" class="difflineplus">+    rnp_ffi_t ffi = NULL;</span>
<a href="#l30.566"></a><span id="l30.566" class="difflineplus">+    test_ffi_init(&amp;ffi);</span>
<a href="#l30.567"></a><span id="l30.567" class="difflineplus">+</span>
<a href="#l30.568"></a><span id="l30.568" class="difflineplus">+    rnp_key_handle_t key0 = NULL;</span>
<a href="#l30.569"></a><span id="l30.569" class="difflineplus">+    rnp_key_handle_t key0_sub0 = NULL;</span>
<a href="#l30.570"></a><span id="l30.570" class="difflineplus">+    rnp_key_handle_t key0_sub1 = NULL;</span>
<a href="#l30.571"></a><span id="l30.571" class="difflineplus">+    rnp_key_handle_t key0_sub2 = NULL;</span>
<a href="#l30.572"></a><span id="l30.572" class="difflineplus">+    assert_rnp_success(rnp_locate_key(ffi, &quot;keyid&quot;, &quot;7bc6709b15c23a4a&quot;, &amp;key0));</span>
<a href="#l30.573"></a><span id="l30.573" class="difflineplus">+    assert_rnp_success(rnp_locate_key(ffi, &quot;keyid&quot;, &quot;1ed63ee56fadc34d&quot;, &amp;key0_sub0));</span>
<a href="#l30.574"></a><span id="l30.574" class="difflineplus">+    assert_rnp_success(rnp_locate_key(ffi, &quot;keyid&quot;, &quot;1d7e8a5393c997a8&quot;, &amp;key0_sub1));</span>
<a href="#l30.575"></a><span id="l30.575" class="difflineplus">+    assert_rnp_success(rnp_locate_key(ffi, &quot;keyid&quot;, &quot;8a05b89fad5aded1&quot;, &amp;key0_sub2));</span>
<a href="#l30.576"></a><span id="l30.576" class="difflineplus">+</span>
<a href="#l30.577"></a><span id="l30.577" class="difflineplus">+    /* edge cases */</span>
<a href="#l30.578"></a><span id="l30.578" class="difflineplus">+    assert_rnp_failure(rnp_key_remove(NULL, RNP_KEY_REMOVE_PUBLIC));</span>
<a href="#l30.579"></a><span id="l30.579" class="difflineplus">+    assert_rnp_failure(rnp_key_remove(key0, 0));</span>
<a href="#l30.580"></a><span id="l30.580" class="difflineplus">+    /* make sure we correctly remove public and secret keys */</span>
<a href="#l30.581"></a><span id="l30.581" class="difflineplus">+    bool pub = false;</span>
<a href="#l30.582"></a><span id="l30.582" class="difflineplus">+    assert_rnp_success(rnp_key_have_public(key0_sub2, &amp;pub));</span>
<a href="#l30.583"></a><span id="l30.583" class="difflineplus">+    assert_true(pub);</span>
<a href="#l30.584"></a><span id="l30.584" class="difflineplus">+    bool sec = false;</span>
<a href="#l30.585"></a><span id="l30.585" class="difflineplus">+    assert_rnp_success(rnp_key_have_secret(key0_sub2, &amp;sec));</span>
<a href="#l30.586"></a><span id="l30.586" class="difflineplus">+    assert_true(sec);</span>
<a href="#l30.587"></a><span id="l30.587" class="difflineplus">+    assert_rnp_success(rnp_key_remove(key0_sub2, RNP_KEY_REMOVE_PUBLIC));</span>
<a href="#l30.588"></a><span id="l30.588" class="difflineplus">+    pub = true;</span>
<a href="#l30.589"></a><span id="l30.589" class="difflineplus">+    assert_rnp_success(rnp_key_have_public(key0_sub2, &amp;pub));</span>
<a href="#l30.590"></a><span id="l30.590" class="difflineplus">+    assert_false(pub);</span>
<a href="#l30.591"></a><span id="l30.591" class="difflineplus">+    sec = false;</span>
<a href="#l30.592"></a><span id="l30.592" class="difflineplus">+    assert_rnp_success(rnp_key_have_secret(key0_sub2, &amp;sec));</span>
<a href="#l30.593"></a><span id="l30.593" class="difflineplus">+    assert_true(sec);</span>
<a href="#l30.594"></a><span id="l30.594" class="difflineplus">+    assert_rnp_failure(rnp_key_remove(key0_sub2, RNP_KEY_REMOVE_PUBLIC));</span>
<a href="#l30.595"></a><span id="l30.595" class="difflineplus">+    rnp_key_handle_destroy(key0_sub2);</span>
<a href="#l30.596"></a><span id="l30.596" class="difflineplus">+    /* locate it back */</span>
<a href="#l30.597"></a><span id="l30.597" class="difflineplus">+    assert_rnp_success(rnp_locate_key(ffi, &quot;keyid&quot;, &quot;8a05b89fad5aded1&quot;, &amp;key0_sub2));</span>
<a href="#l30.598"></a><span id="l30.598" class="difflineplus">+    assert_non_null(key0_sub2);</span>
<a href="#l30.599"></a><span id="l30.599" class="difflineplus">+    pub = true;</span>
<a href="#l30.600"></a><span id="l30.600" class="difflineplus">+    assert_rnp_success(rnp_key_have_public(key0_sub2, &amp;pub));</span>
<a href="#l30.601"></a><span id="l30.601" class="difflineplus">+    assert_false(pub);</span>
<a href="#l30.602"></a><span id="l30.602" class="difflineplus">+    sec = false;</span>
<a href="#l30.603"></a><span id="l30.603" class="difflineplus">+    assert_rnp_success(rnp_key_have_secret(key0_sub2, &amp;sec));</span>
<a href="#l30.604"></a><span id="l30.604" class="difflineplus">+    assert_true(sec);</span>
<a href="#l30.605"></a><span id="l30.605" class="difflineplus">+</span>
<a href="#l30.606"></a><span id="l30.606" class="difflineplus">+    pub = false;</span>
<a href="#l30.607"></a><span id="l30.607" class="difflineplus">+    assert_rnp_success(rnp_key_have_public(key0_sub0, &amp;pub));</span>
<a href="#l30.608"></a><span id="l30.608" class="difflineplus">+    assert_true(pub);</span>
<a href="#l30.609"></a><span id="l30.609" class="difflineplus">+    sec = false;</span>
<a href="#l30.610"></a><span id="l30.610" class="difflineplus">+    assert_rnp_success(rnp_key_have_secret(key0_sub0, &amp;sec));</span>
<a href="#l30.611"></a><span id="l30.611" class="difflineplus">+    assert_true(sec);</span>
<a href="#l30.612"></a><span id="l30.612" class="difflineplus">+    assert_rnp_success(rnp_key_remove(key0_sub0, RNP_KEY_REMOVE_SECRET));</span>
<a href="#l30.613"></a><span id="l30.613" class="difflineplus">+    pub = false;</span>
<a href="#l30.614"></a><span id="l30.614" class="difflineplus">+    assert_rnp_success(rnp_key_have_public(key0_sub0, &amp;pub));</span>
<a href="#l30.615"></a><span id="l30.615" class="difflineplus">+    assert_true(pub);</span>
<a href="#l30.616"></a><span id="l30.616" class="difflineplus">+    sec = true;</span>
<a href="#l30.617"></a><span id="l30.617" class="difflineplus">+    assert_rnp_success(rnp_key_have_secret(key0_sub0, &amp;sec));</span>
<a href="#l30.618"></a><span id="l30.618" class="difflineplus">+    assert_false(sec);</span>
<a href="#l30.619"></a><span id="l30.619" class="difflineplus">+    assert_rnp_failure(rnp_key_remove(key0_sub0, RNP_KEY_REMOVE_SECRET));</span>
<a href="#l30.620"></a><span id="l30.620" class="difflineplus">+    rnp_key_handle_destroy(key0_sub0);</span>
<a href="#l30.621"></a><span id="l30.621" class="difflineplus">+    assert_rnp_success(rnp_locate_key(ffi, &quot;keyid&quot;, &quot;1ed63ee56fadc34d&quot;, &amp;key0_sub0));</span>
<a href="#l30.622"></a><span id="l30.622" class="difflineplus">+    assert_non_null(key0_sub0);</span>
<a href="#l30.623"></a><span id="l30.623" class="difflineplus">+</span>
<a href="#l30.624"></a><span id="l30.624" class="difflineplus">+    size_t count = 0;</span>
<a href="#l30.625"></a><span id="l30.625" class="difflineplus">+    assert_rnp_success(rnp_get_public_key_count(ffi, &amp;count));</span>
<a href="#l30.626"></a><span id="l30.626" class="difflineplus">+    assert_int_equal(count, 6);</span>
<a href="#l30.627"></a><span id="l30.627" class="difflineplus">+    count = 0;</span>
<a href="#l30.628"></a><span id="l30.628" class="difflineplus">+    assert_rnp_success(rnp_get_secret_key_count(ffi, &amp;count));</span>
<a href="#l30.629"></a><span id="l30.629" class="difflineplus">+    assert_int_equal(count, 6);</span>
<a href="#l30.630"></a><span id="l30.630" class="difflineplus">+</span>
<a href="#l30.631"></a><span id="l30.631" class="difflineplus">+    /* while there are 2 public and 1 secret subkey, this calculates only public */</span>
<a href="#l30.632"></a><span id="l30.632" class="difflineplus">+    assert_rnp_success(rnp_key_get_subkey_count(key0, &amp;count));</span>
<a href="#l30.633"></a><span id="l30.633" class="difflineplus">+    assert_int_equal(count, 2);</span>
<a href="#l30.634"></a><span id="l30.634" class="difflineplus">+</span>
<a href="#l30.635"></a><span id="l30.635" class="difflineplus">+    assert_rnp_success(rnp_key_remove(key0_sub0, RNP_KEY_REMOVE_PUBLIC));</span>
<a href="#l30.636"></a><span id="l30.636" class="difflineplus">+    assert_rnp_success(rnp_key_get_subkey_count(key0, &amp;count));</span>
<a href="#l30.637"></a><span id="l30.637" class="difflineplus">+    assert_int_equal(count, 1);</span>
<a href="#l30.638"></a><span id="l30.638" class="difflineplus">+    count = 0;</span>
<a href="#l30.639"></a><span id="l30.639" class="difflineplus">+    assert_rnp_success(rnp_get_public_key_count(ffi, &amp;count));</span>
<a href="#l30.640"></a><span id="l30.640" class="difflineplus">+    assert_int_equal(count, 5);</span>
<a href="#l30.641"></a><span id="l30.641" class="difflineplus">+    assert_rnp_success(rnp_get_secret_key_count(ffi, &amp;count));</span>
<a href="#l30.642"></a><span id="l30.642" class="difflineplus">+    assert_int_equal(count, 6);</span>
<a href="#l30.643"></a><span id="l30.643" class="difflineplus">+</span>
<a href="#l30.644"></a><span id="l30.644" class="difflineplus">+    assert_rnp_success(rnp_key_remove(key0_sub2, RNP_KEY_REMOVE_SECRET));</span>
<a href="#l30.645"></a><span id="l30.645" class="difflineplus">+    assert_rnp_success(rnp_key_get_subkey_count(key0, &amp;count));</span>
<a href="#l30.646"></a><span id="l30.646" class="difflineplus">+    assert_int_equal(count, 1);</span>
<a href="#l30.647"></a><span id="l30.647" class="difflineplus">+    assert_rnp_success(rnp_get_secret_key_count(ffi, &amp;count));</span>
<a href="#l30.648"></a><span id="l30.648" class="difflineplus">+    assert_int_equal(count, 5);</span>
<a href="#l30.649"></a><span id="l30.649" class="difflineplus">+</span>
<a href="#l30.650"></a><span id="l30.650" class="difflineplus">+    assert_rnp_success(rnp_key_remove(key0, RNP_KEY_REMOVE_PUBLIC | RNP_KEY_REMOVE_SECRET));</span>
<a href="#l30.651"></a><span id="l30.651" class="difflineplus">+    assert_rnp_success(rnp_get_public_key_count(ffi, &amp;count));</span>
<a href="#l30.652"></a><span id="l30.652" class="difflineplus">+    assert_int_equal(count, 4);</span>
<a href="#l30.653"></a><span id="l30.653" class="difflineplus">+    assert_rnp_success(rnp_get_secret_key_count(ffi, &amp;count));</span>
<a href="#l30.654"></a><span id="l30.654" class="difflineplus">+    assert_int_equal(count, 4);</span>
<a href="#l30.655"></a><span id="l30.655" class="difflineplus">+</span>
<a href="#l30.656"></a><span id="l30.656" class="difflineplus">+    rnp_key_handle_destroy(key0_sub1);</span>
<a href="#l30.657"></a><span id="l30.657" class="difflineplus">+    /* key0_sub1 should be left in keyring */</span>
<a href="#l30.658"></a><span id="l30.658" class="difflineplus">+    assert_rnp_success(rnp_locate_key(ffi, &quot;keyid&quot;, &quot;1d7e8a5393c997a8&quot;, &amp;key0_sub1));</span>
<a href="#l30.659"></a><span id="l30.659" class="difflineplus">+    pub = false;</span>
<a href="#l30.660"></a><span id="l30.660" class="difflineplus">+    assert_rnp_success(rnp_key_have_public(key0_sub1, &amp;pub));</span>
<a href="#l30.661"></a><span id="l30.661" class="difflineplus">+    assert_true(pub);</span>
<a href="#l30.662"></a><span id="l30.662" class="difflineplus">+    sec = false;</span>
<a href="#l30.663"></a><span id="l30.663" class="difflineplus">+    assert_rnp_success(rnp_key_have_secret(key0_sub1, &amp;sec));</span>
<a href="#l30.664"></a><span id="l30.664" class="difflineplus">+    assert_true(sec);</span>
<a href="#l30.665"></a><span id="l30.665" class="difflineplus">+</span>
<a href="#l30.666"></a><span id="l30.666" class="difflineplus">+    rnp_key_handle_destroy(key0);</span>
<a href="#l30.667"></a><span id="l30.667" class="difflineplus">+    rnp_key_handle_destroy(key0_sub0);</span>
<a href="#l30.668"></a><span id="l30.668" class="difflineplus">+    rnp_key_handle_destroy(key0_sub1);</span>
<a href="#l30.669"></a><span id="l30.669" class="difflineplus">+    rnp_key_handle_destroy(key0_sub2);</span>
<a href="#l30.670"></a><span id="l30.670" class="difflineplus">+</span>
<a href="#l30.671"></a><span id="l30.671" class="difflineplus">+    /* let's import keys back */</span>
<a href="#l30.672"></a><span id="l30.672" class="difflineplus">+    rnp_input_t input = NULL;</span>
<a href="#l30.673"></a><span id="l30.673" class="difflineplus">+    assert_rnp_success(rnp_input_from_path(&amp;input, &quot;data/keyrings/1/pubring.gpg&quot;));</span>
<a href="#l30.674"></a><span id="l30.674" class="difflineplus">+    assert_rnp_success(rnp_import_keys(ffi, input, RNP_LOAD_SAVE_PUBLIC_KEYS, NULL));</span>
<a href="#l30.675"></a><span id="l30.675" class="difflineplus">+    rnp_input_destroy(input);</span>
<a href="#l30.676"></a><span id="l30.676" class="difflineplus">+    assert_rnp_success(rnp_input_from_path(&amp;input, &quot;data/keyrings/1/secring.gpg&quot;));</span>
<a href="#l30.677"></a><span id="l30.677" class="difflineplus">+    assert_rnp_success(rnp_import_keys(ffi, input, RNP_LOAD_SAVE_SECRET_KEYS, NULL));</span>
<a href="#l30.678"></a><span id="l30.678" class="difflineplus">+    rnp_input_destroy(input);</span>
<a href="#l30.679"></a><span id="l30.679" class="difflineplus">+</span>
<a href="#l30.680"></a><span id="l30.680" class="difflineplus">+    assert_rnp_success(rnp_get_public_key_count(ffi, &amp;count));</span>
<a href="#l30.681"></a><span id="l30.681" class="difflineplus">+    assert_int_equal(count, 7);</span>
<a href="#l30.682"></a><span id="l30.682" class="difflineplus">+    assert_rnp_success(rnp_get_secret_key_count(ffi, &amp;count));</span>
<a href="#l30.683"></a><span id="l30.683" class="difflineplus">+    assert_int_equal(count, 7);</span>
<a href="#l30.684"></a><span id="l30.684" class="difflineplus">+</span>
<a href="#l30.685"></a><span id="l30.685" class="difflineplus">+    /* now try to remove the whole key */</span>
<a href="#l30.686"></a><span id="l30.686" class="difflineplus">+    assert_rnp_success(rnp_locate_key(ffi, &quot;keyid&quot;, &quot;7bc6709b15c23a4a&quot;, &amp;key0));</span>
<a href="#l30.687"></a><span id="l30.687" class="difflineplus">+    assert_rnp_success(rnp_locate_key(ffi, &quot;keyid&quot;, &quot;1ed63ee56fadc34d&quot;, &amp;key0_sub0));</span>
<a href="#l30.688"></a><span id="l30.688" class="difflineplus">+</span>
<a href="#l30.689"></a><span id="l30.689" class="difflineplus">+    assert_rnp_failure(</span>
<a href="#l30.690"></a><span id="l30.690" class="difflineplus">+      rnp_key_remove(key0_sub0, RNP_KEY_REMOVE_SECRET | RNP_KEY_REMOVE_SUBKEYS));</span>
<a href="#l30.691"></a><span id="l30.691" class="difflineplus">+    assert_rnp_success(rnp_key_remove(key0_sub0, RNP_KEY_REMOVE_SECRET));</span>
<a href="#l30.692"></a><span id="l30.692" class="difflineplus">+    assert_rnp_success(rnp_key_remove(key0_sub0, RNP_KEY_REMOVE_PUBLIC));</span>
<a href="#l30.693"></a><span id="l30.693" class="difflineplus">+</span>
<a href="#l30.694"></a><span id="l30.694" class="difflineplus">+    assert_rnp_success(rnp_get_public_key_count(ffi, &amp;count));</span>
<a href="#l30.695"></a><span id="l30.695" class="difflineplus">+    assert_int_equal(count, 6);</span>
<a href="#l30.696"></a><span id="l30.696" class="difflineplus">+    assert_rnp_success(rnp_get_secret_key_count(ffi, &amp;count));</span>
<a href="#l30.697"></a><span id="l30.697" class="difflineplus">+    assert_int_equal(count, 6);</span>
<a href="#l30.698"></a><span id="l30.698" class="difflineplus">+</span>
<a href="#l30.699"></a><span id="l30.699" class="difflineplus">+    assert_rnp_success(rnp_key_remove(key0, RNP_KEY_REMOVE_SECRET | RNP_KEY_REMOVE_SUBKEYS));</span>
<a href="#l30.700"></a><span id="l30.700" class="difflineplus">+    assert_rnp_success(rnp_get_public_key_count(ffi, &amp;count));</span>
<a href="#l30.701"></a><span id="l30.701" class="difflineplus">+    assert_int_equal(count, 6);</span>
<a href="#l30.702"></a><span id="l30.702" class="difflineplus">+    assert_rnp_success(rnp_get_secret_key_count(ffi, &amp;count));</span>
<a href="#l30.703"></a><span id="l30.703" class="difflineplus">+    assert_int_equal(count, 3);</span>
<a href="#l30.704"></a><span id="l30.704" class="difflineplus">+</span>
<a href="#l30.705"></a><span id="l30.705" class="difflineplus">+    assert_rnp_success(rnp_key_remove(key0, RNP_KEY_REMOVE_PUBLIC | RNP_KEY_REMOVE_SUBKEYS));</span>
<a href="#l30.706"></a><span id="l30.706" class="difflineplus">+    assert_rnp_success(rnp_get_public_key_count(ffi, &amp;count));</span>
<a href="#l30.707"></a><span id="l30.707" class="difflineplus">+    assert_int_equal(count, 3);</span>
<a href="#l30.708"></a><span id="l30.708" class="difflineplus">+    assert_rnp_success(rnp_get_secret_key_count(ffi, &amp;count));</span>
<a href="#l30.709"></a><span id="l30.709" class="difflineplus">+    assert_int_equal(count, 3);</span>
<a href="#l30.710"></a><span id="l30.710" class="difflineplus">+</span>
<a href="#l30.711"></a><span id="l30.711" class="difflineplus">+    rnp_key_handle_destroy(key0);</span>
<a href="#l30.712"></a><span id="l30.712" class="difflineplus">+    rnp_key_handle_destroy(key0_sub0);</span>
<a href="#l30.713"></a><span id="l30.713" class="difflineplus">+</span>
<a href="#l30.714"></a><span id="l30.714" class="difflineplus">+    /* delete the second key all at once */</span>
<a href="#l30.715"></a><span id="l30.715" class="difflineplus">+    assert_rnp_success(rnp_locate_key(ffi, &quot;keyid&quot;, &quot;2fcadf05ffa501bb&quot;, &amp;key0));</span>
<a href="#l30.716"></a><span id="l30.716" class="difflineplus">+    assert_rnp_success(rnp_key_remove(</span>
<a href="#l30.717"></a><span id="l30.717" class="difflineplus">+      key0, RNP_KEY_REMOVE_PUBLIC | RNP_KEY_REMOVE_SECRET | RNP_KEY_REMOVE_SUBKEYS));</span>
<a href="#l30.718"></a><span id="l30.718" class="difflineplus">+    assert_rnp_success(rnp_get_public_key_count(ffi, &amp;count));</span>
<a href="#l30.719"></a><span id="l30.719" class="difflineplus">+    assert_int_equal(count, 0);</span>
<a href="#l30.720"></a><span id="l30.720" class="difflineplus">+    assert_rnp_success(rnp_get_secret_key_count(ffi, &amp;count));</span>
<a href="#l30.721"></a><span id="l30.721" class="difflineplus">+    assert_int_equal(count, 0);</span>
<a href="#l30.722"></a><span id="l30.722" class="difflineplus">+    rnp_key_handle_destroy(key0);</span>
<a href="#l30.723"></a><span id="l30.723" class="difflineplus">+</span>
<a href="#l30.724"></a><span id="l30.724" class="difflineplus">+    rnp_ffi_destroy(ffi);</span>
<a href="#l30.725"></a><span id="l30.725" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1">new file mode 100644</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineminus">--- /dev/null</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineplus">+++ b/third_party/rnp/src/tests/issues/1171.cpp</span>
<a href="#l31.4"></a><span id="l31.4" class="difflineat">@@ -0,0 +1,74 @@</span>
<a href="#l31.5"></a><span id="l31.5" class="difflineplus">+/*</span>
<a href="#l31.6"></a><span id="l31.6" class="difflineplus">+ * Copyright (c) 2020 [Ribose Inc](https://www.ribose.com).</span>
<a href="#l31.7"></a><span id="l31.7" class="difflineplus">+ * All rights reserved.</span>
<a href="#l31.8"></a><span id="l31.8" class="difflineplus">+ *</span>
<a href="#l31.9"></a><span id="l31.9" class="difflineplus">+ * Redistribution and use in source and binary forms, with or without modification,</span>
<a href="#l31.10"></a><span id="l31.10" class="difflineplus">+ * are permitted provided that the following conditions are met:</span>
<a href="#l31.11"></a><span id="l31.11" class="difflineplus">+ *</span>
<a href="#l31.12"></a><span id="l31.12" class="difflineplus">+ * 1.  Redistributions of source code must retain the above copyright notice,</span>
<a href="#l31.13"></a><span id="l31.13" class="difflineplus">+ *     this list of conditions and the following disclaimer.</span>
<a href="#l31.14"></a><span id="l31.14" class="difflineplus">+ *</span>
<a href="#l31.15"></a><span id="l31.15" class="difflineplus">+ * 2.  Redistributions in binary form must reproduce the above copyright notice,</span>
<a href="#l31.16"></a><span id="l31.16" class="difflineplus">+ *     this list of conditions and the following disclaimer in the documentation</span>
<a href="#l31.17"></a><span id="l31.17" class="difflineplus">+ *     and/or other materials provided with the distribution.</span>
<a href="#l31.18"></a><span id="l31.18" class="difflineplus">+ *</span>
<a href="#l31.19"></a><span id="l31.19" class="difflineplus">+ * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND</span>
<a href="#l31.20"></a><span id="l31.20" class="difflineplus">+ * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED</span>
<a href="#l31.21"></a><span id="l31.21" class="difflineplus">+ * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE</span>
<a href="#l31.22"></a><span id="l31.22" class="difflineplus">+ * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE</span>
<a href="#l31.23"></a><span id="l31.23" class="difflineplus">+ * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</span>
<a href="#l31.24"></a><span id="l31.24" class="difflineplus">+ * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR</span>
<a href="#l31.25"></a><span id="l31.25" class="difflineplus">+ * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER</span>
<a href="#l31.26"></a><span id="l31.26" class="difflineplus">+ * CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,</span>
<a href="#l31.27"></a><span id="l31.27" class="difflineplus">+ * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF</span>
<a href="#l31.28"></a><span id="l31.28" class="difflineplus">+ * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<a href="#l31.29"></a><span id="l31.29" class="difflineplus">+ */</span>
<a href="#l31.30"></a><span id="l31.30" class="difflineplus">+</span>
<a href="#l31.31"></a><span id="l31.31" class="difflineplus">+#include &quot;../rnp_tests.h&quot;</span>
<a href="#l31.32"></a><span id="l31.32" class="difflineplus">+#include &quot;../support.h&quot;</span>
<a href="#l31.33"></a><span id="l31.33" class="difflineplus">+#include &lt;librepgp/stream-ctx.h&gt;</span>
<a href="#l31.34"></a><span id="l31.34" class="difflineplus">+#include &quot;pgp-key.h&quot;</span>
<a href="#l31.35"></a><span id="l31.35" class="difflineplus">+#include &quot;ffi-priv-types.h&quot;</span>
<a href="#l31.36"></a><span id="l31.36" class="difflineplus">+</span>
<a href="#l31.37"></a><span id="l31.37" class="difflineplus">+TEST_F(rnp_tests, test_issue_1171_key_import_and_remove)</span>
<a href="#l31.38"></a><span id="l31.38" class="difflineplus">+{</span>
<a href="#l31.39"></a><span id="l31.39" class="difflineplus">+    rnp_ffi_t ffi = NULL;</span>
<a href="#l31.40"></a><span id="l31.40" class="difflineplus">+    assert_rnp_success(rnp_ffi_create(&amp;ffi, &quot;GPG&quot;, &quot;GPG&quot;));</span>
<a href="#l31.41"></a><span id="l31.41" class="difflineplus">+</span>
<a href="#l31.42"></a><span id="l31.42" class="difflineplus">+    rnp_input_t input = NULL;</span>
<a href="#l31.43"></a><span id="l31.43" class="difflineplus">+    assert_rnp_success(</span>
<a href="#l31.44"></a><span id="l31.44" class="difflineplus">+      rnp_input_from_path(&amp;input, &quot;data/test_key_validity/alice-sub-pub.pgp&quot;));</span>
<a href="#l31.45"></a><span id="l31.45" class="difflineplus">+    assert_rnp_success(rnp_import_keys(ffi, input, RNP_LOAD_SAVE_PUBLIC_KEYS, NULL));</span>
<a href="#l31.46"></a><span id="l31.46" class="difflineplus">+    rnp_input_destroy(input);</span>
<a href="#l31.47"></a><span id="l31.47" class="difflineplus">+</span>
<a href="#l31.48"></a><span id="l31.48" class="difflineplus">+    rnp_key_handle_t key = NULL;</span>
<a href="#l31.49"></a><span id="l31.49" class="difflineplus">+    assert_rnp_success(</span>
<a href="#l31.50"></a><span id="l31.50" class="difflineplus">+      rnp_locate_key(ffi, &quot;grip&quot;, &quot;3E3D52A346F0AD47754611B078117C240ED237E9&quot;, &amp;key));</span>
<a href="#l31.51"></a><span id="l31.51" class="difflineplus">+    assert_non_null(key);</span>
<a href="#l31.52"></a><span id="l31.52" class="difflineplus">+    assert_rnp_success(rnp_key_remove(key, RNP_KEY_REMOVE_PUBLIC));</span>
<a href="#l31.53"></a><span id="l31.53" class="difflineplus">+    assert_rnp_success(rnp_key_handle_destroy(key));</span>
<a href="#l31.54"></a><span id="l31.54" class="difflineplus">+</span>
<a href="#l31.55"></a><span id="l31.55" class="difflineplus">+    assert_rnp_success(</span>
<a href="#l31.56"></a><span id="l31.56" class="difflineplus">+      rnp_locate_key(ffi, &quot;grip&quot;, &quot;3E3D52A346F0AD47754611B078117C240ED237E9&quot;, &amp;key));</span>
<a href="#l31.57"></a><span id="l31.57" class="difflineplus">+    assert_null(key);</span>
<a href="#l31.58"></a><span id="l31.58" class="difflineplus">+</span>
<a href="#l31.59"></a><span id="l31.59" class="difflineplus">+    assert_rnp_success(</span>
<a href="#l31.60"></a><span id="l31.60" class="difflineplus">+      rnp_locate_key(ffi, &quot;grip&quot;, &quot;128E494F41F107E119AA1EEF7850C375A804341C&quot;, &amp;key));</span>
<a href="#l31.61"></a><span id="l31.61" class="difflineplus">+    assert_non_null(key);</span>
<a href="#l31.62"></a><span id="l31.62" class="difflineplus">+    uint32_t bits = 0;</span>
<a href="#l31.63"></a><span id="l31.63" class="difflineplus">+    assert_rnp_success(rnp_key_get_bits(key, &amp;bits));</span>
<a href="#l31.64"></a><span id="l31.64" class="difflineplus">+    assert_int_equal(bits, 256);</span>
<a href="#l31.65"></a><span id="l31.65" class="difflineplus">+</span>
<a href="#l31.66"></a><span id="l31.66" class="difflineplus">+    /* directly use rnp_key_store_get_key_by_grip() which caused crash */</span>
<a href="#l31.67"></a><span id="l31.67" class="difflineplus">+    pgp_key_t *subkey =</span>
<a href="#l31.68"></a><span id="l31.68" class="difflineplus">+      rnp_key_store_get_key_by_grip(ffi-&gt;pubring, pgp_key_get_grip(key-&gt;pub));</span>
<a href="#l31.69"></a><span id="l31.69" class="difflineplus">+    assert_int_equal(pgp_key_get_bits(subkey), 256);</span>
<a href="#l31.70"></a><span id="l31.70" class="difflineplus">+    assert_rnp_success(rnp_key_handle_destroy(key));</span>
<a href="#l31.71"></a><span id="l31.71" class="difflineplus">+</span>
<a href="#l31.72"></a><span id="l31.72" class="difflineplus">+    assert_rnp_success(</span>
<a href="#l31.73"></a><span id="l31.73" class="difflineplus">+      rnp_input_from_path(&amp;input, &quot;data/test_key_validity/alice-sub-pub.pgp&quot;));</span>
<a href="#l31.74"></a><span id="l31.74" class="difflineplus">+    assert_rnp_success(rnp_import_keys(ffi, input, RNP_LOAD_SAVE_PUBLIC_KEYS, NULL));</span>
<a href="#l31.75"></a><span id="l31.75" class="difflineplus">+    rnp_input_destroy(input);</span>
<a href="#l31.76"></a><span id="l31.76" class="difflineplus">+</span>
<a href="#l31.77"></a><span id="l31.77" class="difflineplus">+    rnp_ffi_destroy(ffi);</span>
<a href="#l31.78"></a><span id="l31.78" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/third_party/rnp/src/tests/rnp_tests.h</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/third_party/rnp/src/tests/rnp_tests.h</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -272,16 +272,20 @@ void test_ffi_op_set_hash(void **state);</span>
<a href="#l32.4"></a><span id="l32.4"> void test_ffi_op_set_compression(void **state);</span>
<a href="#l32.5"></a><span id="l32.5"> </span>
<a href="#l32.6"></a><span id="l32.6"> void test_ffi_aead_params(void **state);</span>
<a href="#l32.7"></a><span id="l32.7"> </span>
<a href="#l32.8"></a><span id="l32.8"> void test_ffi_detached_verify_input(void **state);</span>
<a href="#l32.9"></a><span id="l32.9"> </span>
<a href="#l32.10"></a><span id="l32.10"> void test_ffi_op_verify_sig_count(void **state);</span>
<a href="#l32.11"></a><span id="l32.11"> </span>
<a href="#l32.12"></a><span id="l32.12" class="difflineplus">+void test_ffi_op_verify_get_protection_info(void **state);</span>
<a href="#l32.13"></a><span id="l32.13" class="difflineplus">+</span>
<a href="#l32.14"></a><span id="l32.14" class="difflineplus">+void test_ffi_op_verify_recipients_info(void **state);</span>
<a href="#l32.15"></a><span id="l32.15" class="difflineplus">+</span>
<a href="#l32.16"></a><span id="l32.16"> void test_ffi_import_signatures(void **state);</span>
<a href="#l32.17"></a><span id="l32.17"> </span>
<a href="#l32.18"></a><span id="l32.18"> void test_ffi_export_revocation(void **state);</span>
<a href="#l32.19"></a><span id="l32.19"> </span>
<a href="#l32.20"></a><span id="l32.20"> void test_ffi_secret_sig_import(void **state);</span>
<a href="#l32.21"></a><span id="l32.21"> </span>
<a href="#l32.22"></a><span id="l32.22"> void test_ffi_rnp_request_password(void **state);</span>
<a href="#l32.23"></a><span id="l32.23"> </span>
<a href="#l32.24"></a><span id="l32.24" class="difflineat">@@ -290,16 +294,18 @@ void test_ffi_key_revoke(void **state);</span>
<a href="#l32.25"></a><span id="l32.25"> void test_ffi_set_key_expiry(void **state);</span>
<a href="#l32.26"></a><span id="l32.26"> </span>
<a href="#l32.27"></a><span id="l32.27"> void test_ffi_mdc_8k_boundary(void **state);</span>
<a href="#l32.28"></a><span id="l32.28"> </span>
<a href="#l32.29"></a><span id="l32.29"> void test_ffi_decrypt_wrong_mpi_bits(void **state);</span>
<a href="#l32.30"></a><span id="l32.30"> </span>
<a href="#l32.31"></a><span id="l32.31"> void test_ffi_key_import_edge_cases(void **state);</span>
<a href="#l32.32"></a><span id="l32.32"> </span>
<a href="#l32.33"></a><span id="l32.33" class="difflineplus">+void test_ffi_key_remove(void **state);</span>
<a href="#l32.34"></a><span id="l32.34" class="difflineplus">+</span>
<a href="#l32.35"></a><span id="l32.35"> void test_dsa_roundtrip(void **state);</span>
<a href="#l32.36"></a><span id="l32.36"> </span>
<a href="#l32.37"></a><span id="l32.37"> void test_dsa_verify_negative(void **state);</span>
<a href="#l32.38"></a><span id="l32.38"> </span>
<a href="#l32.39"></a><span id="l32.39"> void test_stream_memory(void **state);</span>
<a href="#l32.40"></a><span id="l32.40"> </span>
<a href="#l32.41"></a><span id="l32.41"> void test_stream_memory_discard(void **state);</span>
<a href="#l32.42"></a><span id="l32.42"> </span>
<a href="#l32.43"></a><span id="l32.43" class="difflineat">@@ -364,16 +370,20 @@ void test_partial_length_zero_last_chunk</span>
<a href="#l32.44"></a><span id="l32.44"> void test_partial_length_largest(void **state);</span>
<a href="#l32.45"></a><span id="l32.45"> </span>
<a href="#l32.46"></a><span id="l32.46"> void test_partial_length_first_packet_length(void **state);</span>
<a href="#l32.47"></a><span id="l32.47"> </span>
<a href="#l32.48"></a><span id="l32.48"> void test_kbx_nsigs(void **state);</span>
<a href="#l32.49"></a><span id="l32.49"> </span>
<a href="#l32.50"></a><span id="l32.50"> void test_issue_1115(void **state);</span>
<a href="#l32.51"></a><span id="l32.51"> </span>
<a href="#l32.52"></a><span id="l32.52" class="difflineplus">+void issue_1030_rnpkeys_secret_keys_unprotected(void **state);</span>
<a href="#l32.53"></a><span id="l32.53" class="difflineplus">+</span>
<a href="#l32.54"></a><span id="l32.54" class="difflineplus">+void test_issue_1171_key_import_and_remove(void **state);</span>
<a href="#l32.55"></a><span id="l32.55" class="difflineplus">+</span>
<a href="#l32.56"></a><span id="l32.56"> void test_log_switch(void **state);</span>
<a href="#l32.57"></a><span id="l32.57"> </span>
<a href="#l32.58"></a><span id="l32.58"> #define assert_true(a) EXPECT_TRUE((a))</span>
<a href="#l32.59"></a><span id="l32.59"> #define assert_false(a) EXPECT_FALSE((a))</span>
<a href="#l32.60"></a><span id="l32.60"> #define assert_string_equal(a, b) EXPECT_STREQ((a), (b))</span>
<a href="#l32.61"></a><span id="l32.61"> #define assert_int_equal(a, b) EXPECT_EQ((a), (b))</span>
<a href="#l32.62"></a><span id="l32.62"> #define assert_int_not_equal(a, b) EXPECT_NE((a), (b))</span>
<a href="#l32.63"></a><span id="l32.63"> #define assert_non_null(a) EXPECT_NE((a), nullptr)</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

