<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 26679:369d4b8f0f0b2dfd6c841971f52ab007c066e455</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 369d4b8f0f0b2dfd6c841971f52ab007c066e455" />
<meta property="og:url" content="/comm-central/rev/369d4b8f0f0b2dfd6c841971f52ab007c066e455" />
<meta property="og:description" content="Bug 1546364 - Reformat to Google coding style in mailnews/base/src (part 5). rs=reformat" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 369d4b8f0f0b2dfd6c841971f52ab007c066e455 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/369d4b8f0f0b2dfd6c841971f52ab007c066e455">shortlog</a> |
<a href="/comm-central/log/369d4b8f0f0b2dfd6c841971f52ab007c066e455">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/369d4b8f0f0b2dfd6c841971f52ab007c066e455">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/369d4b8f0f0b2dfd6c841971f52ab007c066e455">files</a> |
changeset |
<a href="/comm-central/raw-rev/369d4b8f0f0b2dfd6c841971f52ab007c066e455">raw</a>  | <a href="/comm-central/archive/369d4b8f0f0b2dfd6c841971f52ab007c066e455.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1546364">Bug 1546364</a> - Reformat to Google coding style in mailnews/base/src (part 5). rs=reformat
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#111;&#114;&#103;&#32;&#75;&#32;&#60;&#106;&#111;&#114;&#103;&#107;&#64;&#106;&#111;&#114;&#103;&#107;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 20 May 2019 15:11:42 +0200</td></tr>

<tr>
 <td>changeset 26679</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/369d4b8f0f0b2dfd6c841971f52ab007c066e455">369d4b8f0f0b2dfd6c841971f52ab007c066e455</a></td>
</tr>



<tr>
<td>parent 26678</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/e31269a0705e566877a300ac634ba511c1fef0f5">e31269a0705e566877a300ac634ba511c1fef0f5</a>
</td>
</tr>

<tr>
<td>child 26680</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/1ab5b794ee034948b7ff08ac7761c8e44c18039f">1ab5b794ee034948b7ff08ac7761c8e44c18039f</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=369d4b8f0f0b2dfd6c841971f52ab007c066e455">15943</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Mon, 20 May 2019 13:40:41 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@1fb0d1a549f3 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=1fb0d1a549f3dd9562f6404be18ca14573eac527">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=1fb0d1a549f3dd9562f6404be18ca14573eac527&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=1fb0d1a549f3dd9562f6404be18ca14573eac527&newProject=comm-central&newRevision=369d4b8f0f0b2dfd6c841971f52ab007c066e455&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=1fb0d1a549f3dd9562f6404be18ca14573eac527&newProject=comm-central&newRevision=369d4b8f0f0b2dfd6c841971f52ab007c066e455&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=1fb0d1a549f3dd9562f6404be18ca14573eac527&newProject=comm-central&newRevision=369d4b8f0f0b2dfd6c841971f52ab007c066e455&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28reformat%29&revcount=50">reformat</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1546364">1546364</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1546364">Bug 1546364</a> - Reformat to Google coding style in mailnews/base/src (part 5). rs=reformat
# ignore-this-changeset</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgSearchDBView.cpp">mailnews/base/src/nsMsgSearchDBView.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgSearchDBView.cpp">file</a> |
<a href="/comm-central/annotate/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgSearchDBView.cpp">annotate</a> |
<a href="/comm-central/diff/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgSearchDBView.cpp">diff</a> |
<a href="/comm-central/comparison/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgSearchDBView.cpp">comparison</a> |
<a href="/comm-central/log/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgSearchDBView.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgSearchDBView.h">mailnews/base/src/nsMsgSearchDBView.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgSearchDBView.h">file</a> |
<a href="/comm-central/annotate/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgSearchDBView.h">annotate</a> |
<a href="/comm-central/diff/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgSearchDBView.h">diff</a> |
<a href="/comm-central/comparison/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgSearchDBView.h">comparison</a> |
<a href="/comm-central/log/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgSearchDBView.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgSpecialViews.cpp">mailnews/base/src/nsMsgSpecialViews.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgSpecialViews.cpp">file</a> |
<a href="/comm-central/annotate/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgSpecialViews.cpp">annotate</a> |
<a href="/comm-central/diff/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgSpecialViews.cpp">diff</a> |
<a href="/comm-central/comparison/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgSpecialViews.cpp">comparison</a> |
<a href="/comm-central/log/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgSpecialViews.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgSpecialViews.h">mailnews/base/src/nsMsgSpecialViews.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgSpecialViews.h">file</a> |
<a href="/comm-central/annotate/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgSpecialViews.h">annotate</a> |
<a href="/comm-central/diff/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgSpecialViews.h">diff</a> |
<a href="/comm-central/comparison/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgSpecialViews.h">comparison</a> |
<a href="/comm-central/log/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgSpecialViews.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgStatusFeedback.cpp">mailnews/base/src/nsMsgStatusFeedback.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgStatusFeedback.cpp">file</a> |
<a href="/comm-central/annotate/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgStatusFeedback.cpp">annotate</a> |
<a href="/comm-central/diff/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgStatusFeedback.cpp">diff</a> |
<a href="/comm-central/comparison/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgStatusFeedback.cpp">comparison</a> |
<a href="/comm-central/log/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgStatusFeedback.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgStatusFeedback.h">mailnews/base/src/nsMsgStatusFeedback.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgStatusFeedback.h">file</a> |
<a href="/comm-central/annotate/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgStatusFeedback.h">annotate</a> |
<a href="/comm-central/diff/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgStatusFeedback.h">diff</a> |
<a href="/comm-central/comparison/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgStatusFeedback.h">comparison</a> |
<a href="/comm-central/log/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgStatusFeedback.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgTagService.cpp">mailnews/base/src/nsMsgTagService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgTagService.cpp">file</a> |
<a href="/comm-central/annotate/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgTagService.cpp">annotate</a> |
<a href="/comm-central/diff/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgTagService.cpp">diff</a> |
<a href="/comm-central/comparison/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgTagService.cpp">comparison</a> |
<a href="/comm-central/log/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgTagService.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgTagService.h">mailnews/base/src/nsMsgTagService.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgTagService.h">file</a> |
<a href="/comm-central/annotate/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgTagService.h">annotate</a> |
<a href="/comm-central/diff/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgTagService.h">diff</a> |
<a href="/comm-central/comparison/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgTagService.h">comparison</a> |
<a href="/comm-central/log/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgTagService.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgThreadedDBView.cpp">mailnews/base/src/nsMsgThreadedDBView.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgThreadedDBView.cpp">file</a> |
<a href="/comm-central/annotate/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgThreadedDBView.cpp">annotate</a> |
<a href="/comm-central/diff/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgThreadedDBView.cpp">diff</a> |
<a href="/comm-central/comparison/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgThreadedDBView.cpp">comparison</a> |
<a href="/comm-central/log/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgThreadedDBView.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgThreadedDBView.h">mailnews/base/src/nsMsgThreadedDBView.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgThreadedDBView.h">file</a> |
<a href="/comm-central/annotate/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgThreadedDBView.h">annotate</a> |
<a href="/comm-central/diff/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgThreadedDBView.h">diff</a> |
<a href="/comm-central/comparison/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgThreadedDBView.h">comparison</a> |
<a href="/comm-central/log/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgThreadedDBView.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgWindow.cpp">mailnews/base/src/nsMsgWindow.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgWindow.cpp">file</a> |
<a href="/comm-central/annotate/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgWindow.cpp">annotate</a> |
<a href="/comm-central/diff/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgWindow.cpp">diff</a> |
<a href="/comm-central/comparison/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgWindow.cpp">comparison</a> |
<a href="/comm-central/log/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgWindow.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgWindow.h">mailnews/base/src/nsMsgWindow.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgWindow.h">file</a> |
<a href="/comm-central/annotate/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgWindow.h">annotate</a> |
<a href="/comm-central/diff/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgWindow.h">diff</a> |
<a href="/comm-central/comparison/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgWindow.h">comparison</a> |
<a href="/comm-central/log/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgWindow.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgXFViewThread.cpp">mailnews/base/src/nsMsgXFViewThread.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgXFViewThread.cpp">file</a> |
<a href="/comm-central/annotate/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgXFViewThread.cpp">annotate</a> |
<a href="/comm-central/diff/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgXFViewThread.cpp">diff</a> |
<a href="/comm-central/comparison/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgXFViewThread.cpp">comparison</a> |
<a href="/comm-central/log/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgXFViewThread.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgXFViewThread.h">mailnews/base/src/nsMsgXFViewThread.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgXFViewThread.h">file</a> |
<a href="/comm-central/annotate/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgXFViewThread.h">annotate</a> |
<a href="/comm-central/diff/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgXFViewThread.h">diff</a> |
<a href="/comm-central/comparison/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgXFViewThread.h">comparison</a> |
<a href="/comm-central/log/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgXFViewThread.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgXFVirtualFolderDBView.cpp">mailnews/base/src/nsMsgXFVirtualFolderDBView.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgXFVirtualFolderDBView.cpp">file</a> |
<a href="/comm-central/annotate/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgXFVirtualFolderDBView.cpp">annotate</a> |
<a href="/comm-central/diff/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgXFVirtualFolderDBView.cpp">diff</a> |
<a href="/comm-central/comparison/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgXFVirtualFolderDBView.cpp">comparison</a> |
<a href="/comm-central/log/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgXFVirtualFolderDBView.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgXFVirtualFolderDBView.h">mailnews/base/src/nsMsgXFVirtualFolderDBView.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgXFVirtualFolderDBView.h">file</a> |
<a href="/comm-central/annotate/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgXFVirtualFolderDBView.h">annotate</a> |
<a href="/comm-central/diff/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgXFVirtualFolderDBView.h">diff</a> |
<a href="/comm-central/comparison/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgXFVirtualFolderDBView.h">comparison</a> |
<a href="/comm-central/log/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsMsgXFVirtualFolderDBView.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsSpamSettings.cpp">mailnews/base/src/nsSpamSettings.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsSpamSettings.cpp">file</a> |
<a href="/comm-central/annotate/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsSpamSettings.cpp">annotate</a> |
<a href="/comm-central/diff/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsSpamSettings.cpp">diff</a> |
<a href="/comm-central/comparison/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsSpamSettings.cpp">comparison</a> |
<a href="/comm-central/log/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsSpamSettings.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsSpamSettings.h">mailnews/base/src/nsSpamSettings.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsSpamSettings.h">file</a> |
<a href="/comm-central/annotate/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsSpamSettings.h">annotate</a> |
<a href="/comm-central/diff/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsSpamSettings.h">diff</a> |
<a href="/comm-central/comparison/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsSpamSettings.h">comparison</a> |
<a href="/comm-central/log/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsSpamSettings.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsStatusBarBiffManager.cpp">mailnews/base/src/nsStatusBarBiffManager.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsStatusBarBiffManager.cpp">file</a> |
<a href="/comm-central/annotate/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsStatusBarBiffManager.cpp">annotate</a> |
<a href="/comm-central/diff/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsStatusBarBiffManager.cpp">diff</a> |
<a href="/comm-central/comparison/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsStatusBarBiffManager.cpp">comparison</a> |
<a href="/comm-central/log/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsStatusBarBiffManager.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsStatusBarBiffManager.h">mailnews/base/src/nsStatusBarBiffManager.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsStatusBarBiffManager.h">file</a> |
<a href="/comm-central/annotate/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsStatusBarBiffManager.h">annotate</a> |
<a href="/comm-central/diff/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsStatusBarBiffManager.h">diff</a> |
<a href="/comm-central/comparison/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsStatusBarBiffManager.h">comparison</a> |
<a href="/comm-central/log/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsStatusBarBiffManager.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsSubscribableServer.cpp">mailnews/base/src/nsSubscribableServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsSubscribableServer.cpp">file</a> |
<a href="/comm-central/annotate/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsSubscribableServer.cpp">annotate</a> |
<a href="/comm-central/diff/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsSubscribableServer.cpp">diff</a> |
<a href="/comm-central/comparison/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsSubscribableServer.cpp">comparison</a> |
<a href="/comm-central/log/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsSubscribableServer.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsSubscribableServer.h">mailnews/base/src/nsSubscribableServer.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsSubscribableServer.h">file</a> |
<a href="/comm-central/annotate/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsSubscribableServer.h">annotate</a> |
<a href="/comm-central/diff/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsSubscribableServer.h">diff</a> |
<a href="/comm-central/comparison/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsSubscribableServer.h">comparison</a> |
<a href="/comm-central/log/369d4b8f0f0b2dfd6c841971f52ab007c066e455/mailnews/base/src/nsSubscribableServer.h">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/base/src/nsMsgSearchDBView.cpp</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgSearchDBView.cpp</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -22,680 +22,592 @@</span>
<a href="#l1.4"></a><span id="l1.4"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l1.5"></a><span id="l1.5"> #include &quot;nsMsgMessageFlags.h&quot;</span>
<a href="#l1.6"></a><span id="l1.6"> #include &quot;nsIMsgSearchSession.h&quot;</span>
<a href="#l1.7"></a><span id="l1.7"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l1.8"></a><span id="l1.8"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l1.9"></a><span id="l1.9"> </span>
<a href="#l1.10"></a><span id="l1.10"> static bool gReferenceOnlyThreading;</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-nsMsgSearchDBView::nsMsgSearchDBView()</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-{</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+nsMsgSearchDBView::nsMsgSearchDBView() {</span>
<a href="#l1.15"></a><span id="l1.15">   // Don't try to display messages for the search pane.</span>
<a href="#l1.16"></a><span id="l1.16">   mSuppressMsgDisplay = true;</span>
<a href="#l1.17"></a><span id="l1.17">   m_totalMessagesInView = 0;</span>
<a href="#l1.18"></a><span id="l1.18">   m_nextThreadId = 1;</span>
<a href="#l1.19"></a><span id="l1.19"> }</span>
<a href="#l1.20"></a><span id="l1.20"> </span>
<a href="#l1.21"></a><span id="l1.21" class="difflineminus">-nsMsgSearchDBView::~nsMsgSearchDBView()</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineminus">-{</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineminus">-}</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineplus">+nsMsgSearchDBView::~nsMsgSearchDBView() {}</span>
<a href="#l1.25"></a><span id="l1.25"> </span>
<a href="#l1.26"></a><span id="l1.26"> NS_IMPL_ISUPPORTS_INHERITED(nsMsgSearchDBView, nsMsgDBView, nsIMsgDBView,</span>
<a href="#l1.27"></a><span id="l1.27">                             nsIMsgCopyServiceListener, nsIMsgSearchNotify)</span>
<a href="#l1.28"></a><span id="l1.28"> </span>
<a href="#l1.29"></a><span id="l1.29"> NS_IMETHODIMP</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineminus">-nsMsgSearchDBView::Open(nsIMsgFolder *folder,</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-                        nsMsgViewSortTypeValue sortType,</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+nsMsgSearchDBView::Open(nsIMsgFolder *folder, nsMsgViewSortTypeValue sortType,</span>
<a href="#l1.33"></a><span id="l1.33">                         nsMsgViewSortOrderValue sortOrder,</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineminus">-                        nsMsgViewFlagsTypeValue viewFlags,</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineminus">-                        int32_t *pCount)</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineminus">-{</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+                        nsMsgViewFlagsTypeValue viewFlags, int32_t *pCount) {</span>
<a href="#l1.38"></a><span id="l1.38">   // DBViewWrapper.jsm likes to create search views with a sort order</span>
<a href="#l1.39"></a><span id="l1.39">   // of byNone, in order to have the order be the order the search results</span>
<a href="#l1.40"></a><span id="l1.40">   // are returned. But this doesn't work with threaded view, so make the</span>
<a href="#l1.41"></a><span id="l1.41">   // sort order be byDate if we're threaded.</span>
<a href="#l1.42"></a><span id="l1.42"> </span>
<a href="#l1.43"></a><span id="l1.43">   if (viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay &amp;&amp;</span>
<a href="#l1.44"></a><span id="l1.44">       sortType == nsMsgViewSortType::byNone)</span>
<a href="#l1.45"></a><span id="l1.45">     sortType = nsMsgViewSortType::byDate;</span>
<a href="#l1.46"></a><span id="l1.46"> </span>
<a href="#l1.47"></a><span id="l1.47" class="difflineminus">-  nsresult rv = nsMsgDBView::Open(folder, sortType, sortOrder, viewFlags, pCount);</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineplus">+  nsresult rv =</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineplus">+      nsMsgDBView::Open(folder, sortType, sortOrder, viewFlags, pCount);</span>
<a href="#l1.50"></a><span id="l1.50">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.51"></a><span id="l1.51"> </span>
<a href="#l1.52"></a><span id="l1.52" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineplus">+      do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l1.55"></a><span id="l1.55">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.56"></a><span id="l1.56">   prefBranch-&gt;GetBoolPref(&quot;mail.strict_threading&quot;, &amp;gReferenceOnlyThreading);</span>
<a href="#l1.57"></a><span id="l1.57"> </span>
<a href="#l1.58"></a><span id="l1.58">   // Our sort is automatically valid because we have no contents at this point!</span>
<a href="#l1.59"></a><span id="l1.59">   m_sortValid = true;</span>
<a href="#l1.60"></a><span id="l1.60"> </span>
<a href="#l1.61"></a><span id="l1.61" class="difflineminus">-  if (pCount)</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineminus">-    *pCount = 0;</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineplus">+  if (pCount) *pCount = 0;</span>
<a href="#l1.64"></a><span id="l1.64"> </span>
<a href="#l1.65"></a><span id="l1.65">   m_folder = nullptr;</span>
<a href="#l1.66"></a><span id="l1.66">   return rv;</span>
<a href="#l1.67"></a><span id="l1.67"> }</span>
<a href="#l1.68"></a><span id="l1.68"> </span>
<a href="#l1.69"></a><span id="l1.69"> NS_IMETHODIMP</span>
<a href="#l1.70"></a><span id="l1.70"> nsMsgSearchDBView::CloneDBView(nsIMessenger *aMessengerInstance,</span>
<a href="#l1.71"></a><span id="l1.71">                                nsIMsgWindow *aMsgWindow,</span>
<a href="#l1.72"></a><span id="l1.72">                                nsIMsgDBViewCommandUpdater *aCmdUpdater,</span>
<a href="#l1.73"></a><span id="l1.73" class="difflineminus">-                               nsIMsgDBView **_retval)</span>
<a href="#l1.74"></a><span id="l1.74" class="difflineminus">-{</span>
<a href="#l1.75"></a><span id="l1.75" class="difflineminus">-  nsMsgSearchDBView* newMsgDBView = new nsMsgSearchDBView();</span>
<a href="#l1.76"></a><span id="l1.76" class="difflineminus">-  nsresult rv = CopyDBView(newMsgDBView, aMessengerInstance, aMsgWindow, aCmdUpdater);</span>
<a href="#l1.77"></a><span id="l1.77" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineplus">+                               nsIMsgDBView **_retval) {</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineplus">+  nsMsgSearchDBView *newMsgDBView = new nsMsgSearchDBView();</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineplus">+  nsresult rv =</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineplus">+      CopyDBView(newMsgDBView, aMessengerInstance, aMsgWindow, aCmdUpdater);</span>
<a href="#l1.82"></a><span id="l1.82" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.83"></a><span id="l1.83"> </span>
<a href="#l1.84"></a><span id="l1.84">   NS_IF_ADDREF(*_retval = newMsgDBView);</span>
<a href="#l1.85"></a><span id="l1.85">   return NS_OK;</span>
<a href="#l1.86"></a><span id="l1.86"> }</span>
<a href="#l1.87"></a><span id="l1.87"> </span>
<a href="#l1.88"></a><span id="l1.88"> NS_IMETHODIMP</span>
<a href="#l1.89"></a><span id="l1.89"> nsMsgSearchDBView::CopyDBView(nsMsgDBView *aNewMsgDBView,</span>
<a href="#l1.90"></a><span id="l1.90">                               nsIMessenger *aMessengerInstance,</span>
<a href="#l1.91"></a><span id="l1.91">                               nsIMsgWindow *aMsgWindow,</span>
<a href="#l1.92"></a><span id="l1.92" class="difflineminus">-                              nsIMsgDBViewCommandUpdater *aCmdUpdater)</span>
<a href="#l1.93"></a><span id="l1.93" class="difflineminus">-{</span>
<a href="#l1.94"></a><span id="l1.94" class="difflineminus">-  nsMsgGroupView::CopyDBView(aNewMsgDBView, aMessengerInstance, aMsgWindow, aCmdUpdater);</span>
<a href="#l1.95"></a><span id="l1.95" class="difflineminus">-  nsMsgSearchDBView* newMsgDBView = (nsMsgSearchDBView *) aNewMsgDBView;</span>
<a href="#l1.96"></a><span id="l1.96" class="difflineplus">+                              nsIMsgDBViewCommandUpdater *aCmdUpdater) {</span>
<a href="#l1.97"></a><span id="l1.97" class="difflineplus">+  nsMsgGroupView::CopyDBView(aNewMsgDBView, aMessengerInstance, aMsgWindow,</span>
<a href="#l1.98"></a><span id="l1.98" class="difflineplus">+                             aCmdUpdater);</span>
<a href="#l1.99"></a><span id="l1.99" class="difflineplus">+  nsMsgSearchDBView *newMsgDBView = (nsMsgSearchDBView *)aNewMsgDBView;</span>
<a href="#l1.100"></a><span id="l1.100"> </span>
<a href="#l1.101"></a><span id="l1.101">   // Now copy all of our private member data.</span>
<a href="#l1.102"></a><span id="l1.102">   newMsgDBView-&gt;mDestFolder = mDestFolder;</span>
<a href="#l1.103"></a><span id="l1.103">   newMsgDBView-&gt;mCommand = mCommand;</span>
<a href="#l1.104"></a><span id="l1.104">   newMsgDBView-&gt;mTotalIndices = mTotalIndices;</span>
<a href="#l1.105"></a><span id="l1.105">   newMsgDBView-&gt;mCurIndex = mCurIndex;</span>
<a href="#l1.106"></a><span id="l1.106">   newMsgDBView-&gt;m_folders.InsertObjectsAt(m_folders, 0);</span>
<a href="#l1.107"></a><span id="l1.107">   newMsgDBView-&gt;m_curCustomColumn = m_curCustomColumn;</span>
<a href="#l1.108"></a><span id="l1.108">   newMsgDBView-&gt;m_hdrsForEachFolder.InsertObjectsAt(m_hdrsForEachFolder, 0);</span>
<a href="#l1.109"></a><span id="l1.109" class="difflineminus">-  newMsgDBView-&gt;m_uniqueFoldersSelected.InsertObjectsAt(m_uniqueFoldersSelected, 0);</span>
<a href="#l1.110"></a><span id="l1.110" class="difflineplus">+  newMsgDBView-&gt;m_uniqueFoldersSelected.InsertObjectsAt(m_uniqueFoldersSelected,</span>
<a href="#l1.111"></a><span id="l1.111" class="difflineplus">+                                                        0);</span>
<a href="#l1.112"></a><span id="l1.112"> </span>
<a href="#l1.113"></a><span id="l1.113">   int32_t count = m_dbToUseList.Count();</span>
<a href="#l1.114"></a><span id="l1.114" class="difflineminus">-  for(int32_t i = 0; i &lt; count; i++)</span>
<a href="#l1.115"></a><span id="l1.115" class="difflineminus">-  {</span>
<a href="#l1.116"></a><span id="l1.116" class="difflineplus">+  for (int32_t i = 0; i &lt; count; i++) {</span>
<a href="#l1.117"></a><span id="l1.117">     newMsgDBView-&gt;m_dbToUseList.AppendObject(m_dbToUseList[i]);</span>
<a href="#l1.118"></a><span id="l1.118">     // Register the new view with the database so it gets notifications.</span>
<a href="#l1.119"></a><span id="l1.119">     m_dbToUseList[i]-&gt;AddListener(newMsgDBView);</span>
<a href="#l1.120"></a><span id="l1.120">   }</span>
<a href="#l1.121"></a><span id="l1.121" class="difflineminus">-  if (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay)</span>
<a href="#l1.122"></a><span id="l1.122" class="difflineminus">-  {</span>
<a href="#l1.123"></a><span id="l1.123" class="difflineplus">+  if (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay) {</span>
<a href="#l1.124"></a><span id="l1.124">     // We need to clone the thread and msg hdr hash tables.</span>
<a href="#l1.125"></a><span id="l1.125">     for (auto iter = m_threadsTable.Iter(); !iter.Done(); iter.Next()) {</span>
<a href="#l1.126"></a><span id="l1.126">       newMsgDBView-&gt;m_threadsTable.Put(iter.Key(), iter.UserData());</span>
<a href="#l1.127"></a><span id="l1.127">     }</span>
<a href="#l1.128"></a><span id="l1.128">     for (auto iter = m_hdrsTable.Iter(); !iter.Done(); iter.Next()) {</span>
<a href="#l1.129"></a><span id="l1.129">       newMsgDBView-&gt;m_hdrsTable.Put(iter.Key(), iter.UserData());</span>
<a href="#l1.130"></a><span id="l1.130">     }</span>
<a href="#l1.131"></a><span id="l1.131">   }</span>
<a href="#l1.132"></a><span id="l1.132"> </span>
<a href="#l1.133"></a><span id="l1.133">   return NS_OK;</span>
<a href="#l1.134"></a><span id="l1.134"> }</span>
<a href="#l1.135"></a><span id="l1.135"> </span>
<a href="#l1.136"></a><span id="l1.136"> NS_IMETHODIMP</span>
<a href="#l1.137"></a><span id="l1.137" class="difflineminus">-nsMsgSearchDBView::Close()</span>
<a href="#l1.138"></a><span id="l1.138" class="difflineminus">-{</span>
<a href="#l1.139"></a><span id="l1.139" class="difflineplus">+nsMsgSearchDBView::Close() {</span>
<a href="#l1.140"></a><span id="l1.140">   int32_t count = m_dbToUseList.Count();</span>
<a href="#l1.141"></a><span id="l1.141"> </span>
<a href="#l1.142"></a><span id="l1.142" class="difflineminus">-  for(int32_t i = 0; i &lt; count; i++)</span>
<a href="#l1.143"></a><span id="l1.143" class="difflineminus">-    m_dbToUseList[i]-&gt;RemoveListener(this);</span>
<a href="#l1.144"></a><span id="l1.144" class="difflineplus">+  for (int32_t i = 0; i &lt; count; i++) m_dbToUseList[i]-&gt;RemoveListener(this);</span>
<a href="#l1.145"></a><span id="l1.145"> </span>
<a href="#l1.146"></a><span id="l1.146">   m_dbToUseList.Clear();</span>
<a href="#l1.147"></a><span id="l1.147"> </span>
<a href="#l1.148"></a><span id="l1.148">   return nsMsgGroupView::Close();</span>
<a href="#l1.149"></a><span id="l1.149"> }</span>
<a href="#l1.150"></a><span id="l1.150"> </span>
<a href="#l1.151"></a><span id="l1.151" class="difflineminus">-void nsMsgSearchDBView::InternalClose()</span>
<a href="#l1.152"></a><span id="l1.152" class="difflineminus">-{</span>
<a href="#l1.153"></a><span id="l1.153" class="difflineplus">+void nsMsgSearchDBView::InternalClose() {</span>
<a href="#l1.154"></a><span id="l1.154">   m_threadsTable.Clear();</span>
<a href="#l1.155"></a><span id="l1.155">   m_hdrsTable.Clear();</span>
<a href="#l1.156"></a><span id="l1.156">   nsMsgGroupView::InternalClose();</span>
<a href="#l1.157"></a><span id="l1.157">   m_folders.Clear();</span>
<a href="#l1.158"></a><span id="l1.158"> }</span>
<a href="#l1.159"></a><span id="l1.159"> </span>
<a href="#l1.160"></a><span id="l1.160"> NS_IMETHODIMP</span>
<a href="#l1.161"></a><span id="l1.161" class="difflineminus">-nsMsgSearchDBView::GetCellText(int32_t aRow,</span>
<a href="#l1.162"></a><span id="l1.162" class="difflineminus">-                               nsTreeColumn* aCol,</span>
<a href="#l1.163"></a><span id="l1.163" class="difflineminus">-                               nsAString&amp; aValue)</span>
<a href="#l1.164"></a><span id="l1.164" class="difflineminus">-{</span>
<a href="#l1.165"></a><span id="l1.165" class="difflineplus">+nsMsgSearchDBView::GetCellText(int32_t aRow, nsTreeColumn *aCol,</span>
<a href="#l1.166"></a><span id="l1.166" class="difflineplus">+                               nsAString &amp;aValue) {</span>
<a href="#l1.167"></a><span id="l1.167">   NS_ENSURE_TRUE(IsValidIndex(aRow), NS_MSG_INVALID_DBVIEW_INDEX);</span>
<a href="#l1.168"></a><span id="l1.168">   NS_ENSURE_ARG_POINTER(aCol);</span>
<a href="#l1.169"></a><span id="l1.169"> </span>
<a href="#l1.170"></a><span id="l1.170" class="difflineminus">-  const nsAString&amp; colID = aCol-&gt;GetId();</span>
<a href="#l1.171"></a><span id="l1.171" class="difflineplus">+  const nsAString &amp;colID = aCol-&gt;GetId();</span>
<a href="#l1.172"></a><span id="l1.172">   // The only thing we contribute is location; dummy rows have no location, so</span>
<a href="#l1.173"></a><span id="l1.173">   // bail in that case. Otherwise, check if we are dealing with 'location'.</span>
<a href="#l1.174"></a><span id="l1.174">   // 'location', need to check for &quot;lo&quot; not just &quot;l&quot; to avoid &quot;label&quot; column.</span>
<a href="#l1.175"></a><span id="l1.175" class="difflineminus">-  if (!(m_flags[aRow] &amp; MSG_VIEW_FLAG_DUMMY) &amp;&amp;</span>
<a href="#l1.176"></a><span id="l1.176" class="difflineminus">-      colID.Length() &gt;= 2 &amp;&amp;</span>
<a href="#l1.177"></a><span id="l1.177" class="difflineplus">+  if (!(m_flags[aRow] &amp; MSG_VIEW_FLAG_DUMMY) &amp;&amp; colID.Length() &gt;= 2 &amp;&amp;</span>
<a href="#l1.178"></a><span id="l1.178">       colID.First() == 'l' &amp;&amp; colID.CharAt(1) == 'o')</span>
<a href="#l1.179"></a><span id="l1.179">     return FetchLocation(aRow, aValue);</span>
<a href="#l1.180"></a><span id="l1.180">   else</span>
<a href="#l1.181"></a><span id="l1.181">     return nsMsgGroupView::GetCellText(aRow, aCol, aValue);</span>
<a href="#l1.182"></a><span id="l1.182"> }</span>
<a href="#l1.183"></a><span id="l1.183"> </span>
<a href="#l1.184"></a><span id="l1.184" class="difflineminus">-nsresult</span>
<a href="#l1.185"></a><span id="l1.185" class="difflineminus">-nsMsgSearchDBView::HashHdr(nsIMsgDBHdr *msgHdr,</span>
<a href="#l1.186"></a><span id="l1.186" class="difflineminus">-                           nsString&amp; aHashKey)</span>
<a href="#l1.187"></a><span id="l1.187" class="difflineminus">-{</span>
<a href="#l1.188"></a><span id="l1.188" class="difflineminus">-  if (m_sortType == nsMsgViewSortType::byLocation)</span>
<a href="#l1.189"></a><span id="l1.189" class="difflineminus">-  {</span>
<a href="#l1.190"></a><span id="l1.190" class="difflineplus">+nsresult nsMsgSearchDBView::HashHdr(nsIMsgDBHdr *msgHdr, nsString &amp;aHashKey) {</span>
<a href="#l1.191"></a><span id="l1.191" class="difflineplus">+  if (m_sortType == nsMsgViewSortType::byLocation) {</span>
<a href="#l1.192"></a><span id="l1.192">     aHashKey.Truncate();</span>
<a href="#l1.193"></a><span id="l1.193">     nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l1.194"></a><span id="l1.194">     msgHdr-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l1.195"></a><span id="l1.195">     return folder-&gt;GetPrettyName(aHashKey);</span>
<a href="#l1.196"></a><span id="l1.196">   }</span>
<a href="#l1.197"></a><span id="l1.197"> </span>
<a href="#l1.198"></a><span id="l1.198">   return nsMsgGroupView::HashHdr(msgHdr, aHashKey);</span>
<a href="#l1.199"></a><span id="l1.199"> }</span>
<a href="#l1.200"></a><span id="l1.200"> </span>
<a href="#l1.201"></a><span id="l1.201" class="difflineminus">-nsresult</span>
<a href="#l1.202"></a><span id="l1.202" class="difflineminus">-nsMsgSearchDBView::FetchLocation(int32_t aRow,</span>
<a href="#l1.203"></a><span id="l1.203" class="difflineminus">-                                 nsAString&amp; aLocationString)</span>
<a href="#l1.204"></a><span id="l1.204" class="difflineminus">-{</span>
<a href="#l1.205"></a><span id="l1.205" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFolder&gt; folder;</span>
<a href="#l1.206"></a><span id="l1.206" class="difflineplus">+nsresult nsMsgSearchDBView::FetchLocation(int32_t aRow,</span>
<a href="#l1.207"></a><span id="l1.207" class="difflineplus">+                                          nsAString &amp;aLocationString) {</span>
<a href="#l1.208"></a><span id="l1.208" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l1.209"></a><span id="l1.209">   nsresult rv = GetFolderForViewIndex(aRow, getter_AddRefs(folder));</span>
<a href="#l1.210"></a><span id="l1.210" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.211"></a><span id="l1.211" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.212"></a><span id="l1.212">   return folder-&gt;GetPrettyName(aLocationString);</span>
<a href="#l1.213"></a><span id="l1.213"> }</span>
<a href="#l1.214"></a><span id="l1.214"> </span>
<a href="#l1.215"></a><span id="l1.215" class="difflineminus">-nsresult</span>
<a href="#l1.216"></a><span id="l1.216" class="difflineminus">-nsMsgSearchDBView::OnNewHeader(nsIMsgDBHdr *newHdr,</span>
<a href="#l1.217"></a><span id="l1.217" class="difflineminus">-                               nsMsgKey aParentKey,</span>
<a href="#l1.218"></a><span id="l1.218" class="difflineminus">-                               bool /*ensureListed*/)</span>
<a href="#l1.219"></a><span id="l1.219" class="difflineminus">-{</span>
<a href="#l1.220"></a><span id="l1.220" class="difflineminus">-   return NS_OK;</span>
<a href="#l1.221"></a><span id="l1.221" class="difflineplus">+nsresult nsMsgSearchDBView::OnNewHeader(nsIMsgDBHdr *newHdr,</span>
<a href="#l1.222"></a><span id="l1.222" class="difflineplus">+                                        nsMsgKey aParentKey,</span>
<a href="#l1.223"></a><span id="l1.223" class="difflineplus">+                                        bool /*ensureListed*/) {</span>
<a href="#l1.224"></a><span id="l1.224" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.225"></a><span id="l1.225"> }</span>
<a href="#l1.226"></a><span id="l1.226"> </span>
<a href="#l1.227"></a><span id="l1.227"> NS_IMETHODIMP</span>
<a href="#l1.228"></a><span id="l1.228" class="difflineminus">-nsMsgSearchDBView::OnHdrDeleted(nsIMsgDBHdr *aHdrDeleted,</span>
<a href="#l1.229"></a><span id="l1.229" class="difflineminus">-                                nsMsgKey aParentKey,</span>
<a href="#l1.230"></a><span id="l1.230" class="difflineplus">+nsMsgSearchDBView::OnHdrDeleted(nsIMsgDBHdr *aHdrDeleted, nsMsgKey aParentKey,</span>
<a href="#l1.231"></a><span id="l1.231">                                 int32_t aFlags,</span>
<a href="#l1.232"></a><span id="l1.232" class="difflineminus">-                                nsIDBChangeListener *aInstigator)</span>
<a href="#l1.233"></a><span id="l1.233" class="difflineminus">-{</span>
<a href="#l1.234"></a><span id="l1.234" class="difflineplus">+                                nsIDBChangeListener *aInstigator) {</span>
<a href="#l1.235"></a><span id="l1.235">   if (m_viewFlags &amp; nsMsgViewFlagsType::kGroupBySort)</span>
<a href="#l1.236"></a><span id="l1.236" class="difflineminus">-    return nsMsgGroupView::OnHdrDeleted(aHdrDeleted, aParentKey, aFlags, aInstigator);</span>
<a href="#l1.237"></a><span id="l1.237" class="difflineplus">+    return nsMsgGroupView::OnHdrDeleted(aHdrDeleted, aParentKey, aFlags,</span>
<a href="#l1.238"></a><span id="l1.238" class="difflineplus">+                                        aInstigator);</span>
<a href="#l1.239"></a><span id="l1.239"> </span>
<a href="#l1.240"></a><span id="l1.240" class="difflineminus">-  if (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay)</span>
<a href="#l1.241"></a><span id="l1.241" class="difflineminus">-  {</span>
<a href="#l1.242"></a><span id="l1.242" class="difflineplus">+  if (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay) {</span>
<a href="#l1.243"></a><span id="l1.243">     nsMsgViewIndex deletedIndex = FindHdr(aHdrDeleted);</span>
<a href="#l1.244"></a><span id="l1.244">     uint32_t savedFlags = 0;</span>
<a href="#l1.245"></a><span id="l1.245" class="difflineminus">-    if (deletedIndex != nsMsgViewIndex_None)</span>
<a href="#l1.246"></a><span id="l1.246" class="difflineminus">-    {</span>
<a href="#l1.247"></a><span id="l1.247" class="difflineplus">+    if (deletedIndex != nsMsgViewIndex_None) {</span>
<a href="#l1.248"></a><span id="l1.248">       savedFlags = m_flags[deletedIndex];</span>
<a href="#l1.249"></a><span id="l1.249">       RemoveByIndex(deletedIndex);</span>
<a href="#l1.250"></a><span id="l1.250">     }</span>
<a href="#l1.251"></a><span id="l1.251"> </span>
<a href="#l1.252"></a><span id="l1.252">     nsCOMPtr&lt;nsIMsgThread&gt; thread;</span>
<a href="#l1.253"></a><span id="l1.253">     GetXFThreadFromMsgHdr(aHdrDeleted, getter_AddRefs(thread));</span>
<a href="#l1.254"></a><span id="l1.254" class="difflineminus">-    if (thread)</span>
<a href="#l1.255"></a><span id="l1.255" class="difflineminus">-    {</span>
<a href="#l1.256"></a><span id="l1.256" class="difflineminus">-      nsMsgXFViewThread *viewThread = static_cast&lt;nsMsgXFViewThread*&gt;(thread.get());</span>
<a href="#l1.257"></a><span id="l1.257" class="difflineplus">+    if (thread) {</span>
<a href="#l1.258"></a><span id="l1.258" class="difflineplus">+      nsMsgXFViewThread *viewThread =</span>
<a href="#l1.259"></a><span id="l1.259" class="difflineplus">+          static_cast&lt;nsMsgXFViewThread *&gt;(thread.get());</span>
<a href="#l1.260"></a><span id="l1.260">       viewThread-&gt;RemoveChildHdr(aHdrDeleted, nullptr);</span>
<a href="#l1.261"></a><span id="l1.261" class="difflineminus">-      if (deletedIndex == nsMsgViewIndex_None &amp;&amp; viewThread-&gt;MsgCount() == 1)</span>
<a href="#l1.262"></a><span id="l1.262" class="difflineminus">-      {</span>
<a href="#l1.263"></a><span id="l1.263" class="difflineplus">+      if (deletedIndex == nsMsgViewIndex_None &amp;&amp; viewThread-&gt;MsgCount() == 1) {</span>
<a href="#l1.264"></a><span id="l1.264">         // Remove the last child of a collapsed thread. Need to find the root,</span>
<a href="#l1.265"></a><span id="l1.265">         // and remove the thread flags on it.</span>
<a href="#l1.266"></a><span id="l1.266">         nsCOMPtr&lt;nsIMsgDBHdr&gt; rootHdr;</span>
<a href="#l1.267"></a><span id="l1.267">         thread-&gt;GetRootHdr(nullptr, getter_AddRefs(rootHdr));</span>
<a href="#l1.268"></a><span id="l1.268" class="difflineminus">-        if (rootHdr)</span>
<a href="#l1.269"></a><span id="l1.269" class="difflineminus">-        {</span>
<a href="#l1.270"></a><span id="l1.270" class="difflineplus">+        if (rootHdr) {</span>
<a href="#l1.271"></a><span id="l1.271">           nsMsgViewIndex threadIndex = GetThreadRootIndex(rootHdr);</span>
<a href="#l1.272"></a><span id="l1.272">           if (IsValidIndex(threadIndex))</span>
<a href="#l1.273"></a><span id="l1.273" class="difflineminus">-            AndExtraFlag(threadIndex, ~(MSG_VIEW_FLAG_ISTHREAD |</span>
<a href="#l1.274"></a><span id="l1.274" class="difflineminus">-                                        nsMsgMessageFlags::Elided |</span>
<a href="#l1.275"></a><span id="l1.275" class="difflineminus">-                                        MSG_VIEW_FLAG_HASCHILDREN));</span>
<a href="#l1.276"></a><span id="l1.276" class="difflineplus">+            AndExtraFlag(threadIndex,</span>
<a href="#l1.277"></a><span id="l1.277" class="difflineplus">+                         ~(MSG_VIEW_FLAG_ISTHREAD | nsMsgMessageFlags::Elided |</span>
<a href="#l1.278"></a><span id="l1.278" class="difflineplus">+                           MSG_VIEW_FLAG_HASCHILDREN));</span>
<a href="#l1.279"></a><span id="l1.279">         }</span>
<a href="#l1.280"></a><span id="l1.280" class="difflineminus">-      }</span>
<a href="#l1.281"></a><span id="l1.281" class="difflineminus">-      else if (savedFlags &amp; MSG_VIEW_FLAG_HASCHILDREN)</span>
<a href="#l1.282"></a><span id="l1.282" class="difflineminus">-      {</span>
<a href="#l1.283"></a><span id="l1.283" class="difflineminus">-        if (savedFlags &amp; nsMsgMessageFlags::Elided)</span>
<a href="#l1.284"></a><span id="l1.284" class="difflineminus">-        {</span>
<a href="#l1.285"></a><span id="l1.285" class="difflineplus">+      } else if (savedFlags &amp; MSG_VIEW_FLAG_HASCHILDREN) {</span>
<a href="#l1.286"></a><span id="l1.286" class="difflineplus">+        if (savedFlags &amp; nsMsgMessageFlags::Elided) {</span>
<a href="#l1.287"></a><span id="l1.287">           nsCOMPtr&lt;nsIMsgDBHdr&gt; rootHdr;</span>
<a href="#l1.288"></a><span id="l1.288">           nsresult rv = thread-&gt;GetRootHdr(nullptr, getter_AddRefs(rootHdr));</span>
<a href="#l1.289"></a><span id="l1.289">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.290"></a><span id="l1.290">           nsMsgKey msgKey;</span>
<a href="#l1.291"></a><span id="l1.291">           uint32_t msgFlags;</span>
<a href="#l1.292"></a><span id="l1.292">           rootHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l1.293"></a><span id="l1.293">           rootHdr-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l1.294"></a><span id="l1.294">           // Promote the new thread root.</span>
<a href="#l1.295"></a><span id="l1.295">           if (viewThread-&gt;MsgCount() &gt; 1)</span>
<a href="#l1.296"></a><span id="l1.296" class="difflineminus">-            msgFlags |= MSG_VIEW_FLAG_ISTHREAD |</span>
<a href="#l1.297"></a><span id="l1.297" class="difflineminus">-                        nsMsgMessageFlags::Elided |</span>
<a href="#l1.298"></a><span id="l1.298" class="difflineplus">+            msgFlags |= MSG_VIEW_FLAG_ISTHREAD | nsMsgMessageFlags::Elided |</span>
<a href="#l1.299"></a><span id="l1.299">                         MSG_VIEW_FLAG_HASCHILDREN;</span>
<a href="#l1.300"></a><span id="l1.300">           InsertMsgHdrAt(deletedIndex, rootHdr, msgKey, msgFlags, 0);</span>
<a href="#l1.301"></a><span id="l1.301">           if (!m_deletingRows)</span>
<a href="#l1.302"></a><span id="l1.302" class="difflineminus">-            NoteChange(deletedIndex, 1, nsMsgViewNotificationCode::insertOrDelete);</span>
<a href="#l1.303"></a><span id="l1.303" class="difflineminus">-        }</span>
<a href="#l1.304"></a><span id="l1.304" class="difflineminus">-        else if (viewThread-&gt;MsgCount() &gt; 1)</span>
<a href="#l1.305"></a><span id="l1.305" class="difflineminus">-        {</span>
<a href="#l1.306"></a><span id="l1.306" class="difflineminus">-          OrExtraFlag(deletedIndex, MSG_VIEW_FLAG_ISTHREAD |</span>
<a href="#l1.307"></a><span id="l1.307" class="difflineminus">-                                    MSG_VIEW_FLAG_HASCHILDREN);</span>
<a href="#l1.308"></a><span id="l1.308" class="difflineplus">+            NoteChange(deletedIndex, 1,</span>
<a href="#l1.309"></a><span id="l1.309" class="difflineplus">+                       nsMsgViewNotificationCode::insertOrDelete);</span>
<a href="#l1.310"></a><span id="l1.310" class="difflineplus">+        } else if (viewThread-&gt;MsgCount() &gt; 1) {</span>
<a href="#l1.311"></a><span id="l1.311" class="difflineplus">+          OrExtraFlag(deletedIndex,</span>
<a href="#l1.312"></a><span id="l1.312" class="difflineplus">+                      MSG_VIEW_FLAG_ISTHREAD | MSG_VIEW_FLAG_HASCHILDREN);</span>
<a href="#l1.313"></a><span id="l1.313">         }</span>
<a href="#l1.314"></a><span id="l1.314">       }</span>
<a href="#l1.315"></a><span id="l1.315">     }</span>
<a href="#l1.316"></a><span id="l1.316" class="difflineminus">-  }</span>
<a href="#l1.317"></a><span id="l1.317" class="difflineminus">-  else</span>
<a href="#l1.318"></a><span id="l1.318" class="difflineminus">-  {</span>
<a href="#l1.319"></a><span id="l1.319" class="difflineminus">-    return nsMsgDBView::OnHdrDeleted(aHdrDeleted, aParentKey, aFlags, aInstigator);</span>
<a href="#l1.320"></a><span id="l1.320" class="difflineplus">+  } else {</span>
<a href="#l1.321"></a><span id="l1.321" class="difflineplus">+    return nsMsgDBView::OnHdrDeleted(aHdrDeleted, aParentKey, aFlags,</span>
<a href="#l1.322"></a><span id="l1.322" class="difflineplus">+                                     aInstigator);</span>
<a href="#l1.323"></a><span id="l1.323">   }</span>
<a href="#l1.324"></a><span id="l1.324"> </span>
<a href="#l1.325"></a><span id="l1.325">   return NS_OK;</span>
<a href="#l1.326"></a><span id="l1.326"> }</span>
<a href="#l1.327"></a><span id="l1.327"> </span>
<a href="#l1.328"></a><span id="l1.328"> NS_IMETHODIMP</span>
<a href="#l1.329"></a><span id="l1.329"> nsMsgSearchDBView::OnHdrFlagsChanged(nsIMsgDBHdr *aHdrChanged,</span>
<a href="#l1.330"></a><span id="l1.330" class="difflineminus">-                                     uint32_t aOldFlags,</span>
<a href="#l1.331"></a><span id="l1.331" class="difflineminus">-                                     uint32_t aNewFlags,</span>
<a href="#l1.332"></a><span id="l1.332" class="difflineminus">-                                     nsIDBChangeListener *aInstigator)</span>
<a href="#l1.333"></a><span id="l1.333" class="difflineminus">-{</span>
<a href="#l1.334"></a><span id="l1.334" class="difflineplus">+                                     uint32_t aOldFlags, uint32_t aNewFlags,</span>
<a href="#l1.335"></a><span id="l1.335" class="difflineplus">+                                     nsIDBChangeListener *aInstigator) {</span>
<a href="#l1.336"></a><span id="l1.336">   // Defer to base class if we're grouped or not threaded at all.</span>
<a href="#l1.337"></a><span id="l1.337">   if (m_viewFlags &amp; nsMsgViewFlagsType::kGroupBySort ||</span>
<a href="#l1.338"></a><span id="l1.338" class="difflineminus">-      !(m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay))</span>
<a href="#l1.339"></a><span id="l1.339" class="difflineminus">-  {</span>
<a href="#l1.340"></a><span id="l1.340" class="difflineminus">-    return nsMsgGroupView::OnHdrFlagsChanged(aHdrChanged, aOldFlags,</span>
<a href="#l1.341"></a><span id="l1.341" class="difflineminus">-                                             aNewFlags, aInstigator);</span>
<a href="#l1.342"></a><span id="l1.342" class="difflineplus">+      !(m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay)) {</span>
<a href="#l1.343"></a><span id="l1.343" class="difflineplus">+    return nsMsgGroupView::OnHdrFlagsChanged(aHdrChanged, aOldFlags, aNewFlags,</span>
<a href="#l1.344"></a><span id="l1.344" class="difflineplus">+                                             aInstigator);</span>
<a href="#l1.345"></a><span id="l1.345">   }</span>
<a href="#l1.346"></a><span id="l1.346"> </span>
<a href="#l1.347"></a><span id="l1.347" class="difflineminus">-  nsCOMPtr &lt;nsIMsgThread&gt; thread;</span>
<a href="#l1.348"></a><span id="l1.348" class="difflineplus">+  nsCOMPtr&lt;nsIMsgThread&gt; thread;</span>
<a href="#l1.349"></a><span id="l1.349">   bool foundMessageId;</span>
<a href="#l1.350"></a><span id="l1.350">   // Check if the hdr that changed is in a xf thread, and if the read flag</span>
<a href="#l1.351"></a><span id="l1.351">   // changed, update the thread unread count. GetXFThreadFromMsgHdr returns</span>
<a href="#l1.352"></a><span id="l1.352">   // the thread the header does or would belong to, so we need to also</span>
<a href="#l1.353"></a><span id="l1.353">   // check that the header is actually in the thread.</span>
<a href="#l1.354"></a><span id="l1.354">   GetXFThreadFromMsgHdr(aHdrChanged, getter_AddRefs(thread), &amp;foundMessageId);</span>
<a href="#l1.355"></a><span id="l1.355" class="difflineminus">-  if (foundMessageId)</span>
<a href="#l1.356"></a><span id="l1.356" class="difflineminus">-  {</span>
<a href="#l1.357"></a><span id="l1.357" class="difflineminus">-    nsMsgXFViewThread *viewThread = static_cast&lt;nsMsgXFViewThread*&gt;(thread.get());</span>
<a href="#l1.358"></a><span id="l1.358" class="difflineminus">-    if (viewThread-&gt;HdrIndex(aHdrChanged) != -1)</span>
<a href="#l1.359"></a><span id="l1.359" class="difflineminus">-    {</span>
<a href="#l1.360"></a><span id="l1.360" class="difflineplus">+  if (foundMessageId) {</span>
<a href="#l1.361"></a><span id="l1.361" class="difflineplus">+    nsMsgXFViewThread *viewThread =</span>
<a href="#l1.362"></a><span id="l1.362" class="difflineplus">+        static_cast&lt;nsMsgXFViewThread *&gt;(thread.get());</span>
<a href="#l1.363"></a><span id="l1.363" class="difflineplus">+    if (viewThread-&gt;HdrIndex(aHdrChanged) != -1) {</span>
<a href="#l1.364"></a><span id="l1.364">       uint32_t deltaFlags = (aOldFlags ^ aNewFlags);</span>
<a href="#l1.365"></a><span id="l1.365">       if (deltaFlags &amp; nsMsgMessageFlags::Read)</span>
<a href="#l1.366"></a><span id="l1.366">         thread-&gt;MarkChildRead(aNewFlags &amp; nsMsgMessageFlags::Read);</span>
<a href="#l1.367"></a><span id="l1.367">     }</span>
<a href="#l1.368"></a><span id="l1.368">   }</span>
<a href="#l1.369"></a><span id="l1.369"> </span>
<a href="#l1.370"></a><span id="l1.370" class="difflineminus">-  return nsMsgDBView::OnHdrFlagsChanged(aHdrChanged, aOldFlags, aNewFlags, aInstigator);</span>
<a href="#l1.371"></a><span id="l1.371" class="difflineplus">+  return nsMsgDBView::OnHdrFlagsChanged(aHdrChanged, aOldFlags, aNewFlags,</span>
<a href="#l1.372"></a><span id="l1.372" class="difflineplus">+                                        aInstigator);</span>
<a href="#l1.373"></a><span id="l1.373"> }</span>
<a href="#l1.374"></a><span id="l1.374"> </span>
<a href="#l1.375"></a><span id="l1.375" class="difflineminus">-void nsMsgSearchDBView::InsertMsgHdrAt(nsMsgViewIndex index,</span>
<a href="#l1.376"></a><span id="l1.376" class="difflineminus">-                                       nsIMsgDBHdr *hdr,</span>
<a href="#l1.377"></a><span id="l1.377" class="difflineminus">-                                       nsMsgKey msgKey,</span>
<a href="#l1.378"></a><span id="l1.378" class="difflineminus">-                                       uint32_t flags,</span>
<a href="#l1.379"></a><span id="l1.379" class="difflineminus">-                                       uint32_t level)</span>
<a href="#l1.380"></a><span id="l1.380" class="difflineminus">-{</span>
<a href="#l1.381"></a><span id="l1.381" class="difflineminus">-  if ((int32_t) index &lt; 0)</span>
<a href="#l1.382"></a><span id="l1.382" class="difflineminus">-  {</span>
<a href="#l1.383"></a><span id="l1.383" class="difflineplus">+void nsMsgSearchDBView::InsertMsgHdrAt(nsMsgViewIndex index, nsIMsgDBHdr *hdr,</span>
<a href="#l1.384"></a><span id="l1.384" class="difflineplus">+                                       nsMsgKey msgKey, uint32_t flags,</span>
<a href="#l1.385"></a><span id="l1.385" class="difflineplus">+                                       uint32_t level) {</span>
<a href="#l1.386"></a><span id="l1.386" class="difflineplus">+  if ((int32_t)index &lt; 0) {</span>
<a href="#l1.387"></a><span id="l1.387">     NS_ERROR(&quot;invalid insert index&quot;);</span>
<a href="#l1.388"></a><span id="l1.388">     index = 0;</span>
<a href="#l1.389"></a><span id="l1.389">     level = 0;</span>
<a href="#l1.390"></a><span id="l1.390" class="difflineminus">-  }</span>
<a href="#l1.391"></a><span id="l1.391" class="difflineminus">-  else if (index &gt; m_keys.Length())</span>
<a href="#l1.392"></a><span id="l1.392" class="difflineminus">-  {</span>
<a href="#l1.393"></a><span id="l1.393" class="difflineplus">+  } else if (index &gt; m_keys.Length()) {</span>
<a href="#l1.394"></a><span id="l1.394">     NS_ERROR(&quot;inserting past end of array&quot;);</span>
<a href="#l1.395"></a><span id="l1.395">     index = m_keys.Length();</span>
<a href="#l1.396"></a><span id="l1.396">   }</span>
<a href="#l1.397"></a><span id="l1.397"> </span>
<a href="#l1.398"></a><span id="l1.398">   m_keys.InsertElementAt(index, msgKey);</span>
<a href="#l1.399"></a><span id="l1.399">   m_flags.InsertElementAt(index, flags);</span>
<a href="#l1.400"></a><span id="l1.400">   m_levels.InsertElementAt(index, level);</span>
<a href="#l1.401"></a><span id="l1.401">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l1.402"></a><span id="l1.402">   hdr-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l1.403"></a><span id="l1.403">   m_folders.InsertObjectAt(folder, index);</span>
<a href="#l1.404"></a><span id="l1.404"> }</span>
<a href="#l1.405"></a><span id="l1.405"> </span>
<a href="#l1.406"></a><span id="l1.406" class="difflineminus">-void nsMsgSearchDBView::SetMsgHdrAt(nsIMsgDBHdr *hdr,</span>
<a href="#l1.407"></a><span id="l1.407" class="difflineminus">-                                    nsMsgViewIndex index,</span>
<a href="#l1.408"></a><span id="l1.408" class="difflineminus">-                                    nsMsgKey msgKey,</span>
<a href="#l1.409"></a><span id="l1.409" class="difflineminus">-                                    uint32_t flags,</span>
<a href="#l1.410"></a><span id="l1.410" class="difflineminus">-                                    uint32_t level)</span>
<a href="#l1.411"></a><span id="l1.411" class="difflineminus">-{</span>
<a href="#l1.412"></a><span id="l1.412" class="difflineplus">+void nsMsgSearchDBView::SetMsgHdrAt(nsIMsgDBHdr *hdr, nsMsgViewIndex index,</span>
<a href="#l1.413"></a><span id="l1.413" class="difflineplus">+                                    nsMsgKey msgKey, uint32_t flags,</span>
<a href="#l1.414"></a><span id="l1.414" class="difflineplus">+                                    uint32_t level) {</span>
<a href="#l1.415"></a><span id="l1.415">   m_keys[index] = msgKey;</span>
<a href="#l1.416"></a><span id="l1.416">   m_flags[index] = flags;</span>
<a href="#l1.417"></a><span id="l1.417">   m_levels[index] = level;</span>
<a href="#l1.418"></a><span id="l1.418">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l1.419"></a><span id="l1.419">   hdr-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l1.420"></a><span id="l1.420">   m_folders.ReplaceObjectAt(folder, index);</span>
<a href="#l1.421"></a><span id="l1.421"> }</span>
<a href="#l1.422"></a><span id="l1.422"> </span>
<a href="#l1.423"></a><span id="l1.423"> bool nsMsgSearchDBView::InsertEmptyRows(nsMsgViewIndex viewIndex,</span>
<a href="#l1.424"></a><span id="l1.424" class="difflineminus">-                                        int32_t numRows)</span>
<a href="#l1.425"></a><span id="l1.425" class="difflineminus">-{</span>
<a href="#l1.426"></a><span id="l1.426" class="difflineminus">-  for (int32_t i = 0; i &lt; numRows; i++)</span>
<a href="#l1.427"></a><span id="l1.427" class="difflineminus">-  {</span>
<a href="#l1.428"></a><span id="l1.428" class="difflineminus">-    if (!m_folders.InsertObjectAt(nullptr, viewIndex + i))</span>
<a href="#l1.429"></a><span id="l1.429" class="difflineminus">-      return false;</span>
<a href="#l1.430"></a><span id="l1.430" class="difflineplus">+                                        int32_t numRows) {</span>
<a href="#l1.431"></a><span id="l1.431" class="difflineplus">+  for (int32_t i = 0; i &lt; numRows; i++) {</span>
<a href="#l1.432"></a><span id="l1.432" class="difflineplus">+    if (!m_folders.InsertObjectAt(nullptr, viewIndex + i)) return false;</span>
<a href="#l1.433"></a><span id="l1.433">   }</span>
<a href="#l1.434"></a><span id="l1.434"> </span>
<a href="#l1.435"></a><span id="l1.435">   return nsMsgDBView::InsertEmptyRows(viewIndex, numRows);</span>
<a href="#l1.436"></a><span id="l1.436"> }</span>
<a href="#l1.437"></a><span id="l1.437"> </span>
<a href="#l1.438"></a><span id="l1.438" class="difflineminus">-void nsMsgSearchDBView::RemoveRows(nsMsgViewIndex viewIndex,</span>
<a href="#l1.439"></a><span id="l1.439" class="difflineminus">-                                   int32_t numRows)</span>
<a href="#l1.440"></a><span id="l1.440" class="difflineminus">-{</span>
<a href="#l1.441"></a><span id="l1.441" class="difflineplus">+void nsMsgSearchDBView::RemoveRows(nsMsgViewIndex viewIndex, int32_t numRows) {</span>
<a href="#l1.442"></a><span id="l1.442">   nsMsgDBView::RemoveRows(viewIndex, numRows);</span>
<a href="#l1.443"></a><span id="l1.443" class="difflineminus">-  for (int32_t i = 0; i &lt; numRows; i++)</span>
<a href="#l1.444"></a><span id="l1.444" class="difflineminus">-    m_folders.RemoveObjectAt(viewIndex);</span>
<a href="#l1.445"></a><span id="l1.445" class="difflineplus">+  for (int32_t i = 0; i &lt; numRows; i++) m_folders.RemoveObjectAt(viewIndex);</span>
<a href="#l1.446"></a><span id="l1.446"> }</span>
<a href="#l1.447"></a><span id="l1.447"> </span>
<a href="#l1.448"></a><span id="l1.448" class="difflineminus">-nsresult</span>
<a href="#l1.449"></a><span id="l1.449" class="difflineminus">-nsMsgSearchDBView::GetMsgHdrForViewIndex(nsMsgViewIndex index,</span>
<a href="#l1.450"></a><span id="l1.450" class="difflineminus">-                                         nsIMsgDBHdr **msgHdr)</span>
<a href="#l1.451"></a><span id="l1.451" class="difflineminus">-{</span>
<a href="#l1.452"></a><span id="l1.452" class="difflineplus">+nsresult nsMsgSearchDBView::GetMsgHdrForViewIndex(nsMsgViewIndex index,</span>
<a href="#l1.453"></a><span id="l1.453" class="difflineplus">+                                                  nsIMsgDBHdr **msgHdr) {</span>
<a href="#l1.454"></a><span id="l1.454">   nsresult rv = NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.455"></a><span id="l1.455" class="difflineminus">-  if (index == nsMsgViewIndex_None || index &gt;= (uint32_t) m_folders.Count())</span>
<a href="#l1.456"></a><span id="l1.456" class="difflineplus">+  if (index == nsMsgViewIndex_None || index &gt;= (uint32_t)m_folders.Count())</span>
<a href="#l1.457"></a><span id="l1.457">     return rv;</span>
<a href="#l1.458"></a><span id="l1.458"> </span>
<a href="#l1.459"></a><span id="l1.459">   nsIMsgFolder *folder = m_folders[index];</span>
<a href="#l1.460"></a><span id="l1.460" class="difflineminus">-  if (folder)</span>
<a href="#l1.461"></a><span id="l1.461" class="difflineminus">-  {</span>
<a href="#l1.462"></a><span id="l1.462" class="difflineminus">-    nsCOMPtr &lt;nsIMsgDatabase&gt; db;</span>
<a href="#l1.463"></a><span id="l1.463" class="difflineplus">+  if (folder) {</span>
<a href="#l1.464"></a><span id="l1.464" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l1.465"></a><span id="l1.465">     rv = folder-&gt;GetMsgDatabase(getter_AddRefs(db));</span>
<a href="#l1.466"></a><span id="l1.466">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.467"></a><span id="l1.467" class="difflineminus">-    if (db)</span>
<a href="#l1.468"></a><span id="l1.468" class="difflineminus">-      rv = db-&gt;GetMsgHdrForKey(m_keys[index], msgHdr);</span>
<a href="#l1.469"></a><span id="l1.469" class="difflineplus">+    if (db) rv = db-&gt;GetMsgHdrForKey(m_keys[index], msgHdr);</span>
<a href="#l1.470"></a><span id="l1.470">   }</span>
<a href="#l1.471"></a><span id="l1.471"> </span>
<a href="#l1.472"></a><span id="l1.472">   return rv;</span>
<a href="#l1.473"></a><span id="l1.473"> }</span>
<a href="#l1.474"></a><span id="l1.474"> </span>
<a href="#l1.475"></a><span id="l1.475"> NS_IMETHODIMP</span>
<a href="#l1.476"></a><span id="l1.476"> nsMsgSearchDBView::GetFolderForViewIndex(nsMsgViewIndex index,</span>
<a href="#l1.477"></a><span id="l1.477" class="difflineminus">-                                         nsIMsgFolder **aFolder)</span>
<a href="#l1.478"></a><span id="l1.478" class="difflineminus">-{</span>
<a href="#l1.479"></a><span id="l1.479" class="difflineplus">+                                         nsIMsgFolder **aFolder) {</span>
<a href="#l1.480"></a><span id="l1.480">   NS_ENSURE_ARG_POINTER(aFolder);</span>
<a href="#l1.481"></a><span id="l1.481"> </span>
<a href="#l1.482"></a><span id="l1.482" class="difflineminus">-  if (index == nsMsgViewIndex_None || index &gt;= (uint32_t) m_folders.Count())</span>
<a href="#l1.483"></a><span id="l1.483" class="difflineplus">+  if (index == nsMsgViewIndex_None || index &gt;= (uint32_t)m_folders.Count())</span>
<a href="#l1.484"></a><span id="l1.484">     return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.485"></a><span id="l1.485"> </span>
<a href="#l1.486"></a><span id="l1.486">   NS_IF_ADDREF(*aFolder = m_folders[index]);</span>
<a href="#l1.487"></a><span id="l1.487">   return *aFolder ? NS_OK : NS_ERROR_NULL_POINTER;</span>
<a href="#l1.488"></a><span id="l1.488"> }</span>
<a href="#l1.489"></a><span id="l1.489"> </span>
<a href="#l1.490"></a><span id="l1.490" class="difflineminus">-nsresult</span>
<a href="#l1.491"></a><span id="l1.491" class="difflineminus">-nsMsgSearchDBView::GetDBForViewIndex(nsMsgViewIndex index,</span>
<a href="#l1.492"></a><span id="l1.492" class="difflineminus">-                                     nsIMsgDatabase **db)</span>
<a href="#l1.493"></a><span id="l1.493" class="difflineminus">-{</span>
<a href="#l1.494"></a><span id="l1.494" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFolder&gt; aFolder;</span>
<a href="#l1.495"></a><span id="l1.495" class="difflineplus">+nsresult nsMsgSearchDBView::GetDBForViewIndex(nsMsgViewIndex index,</span>
<a href="#l1.496"></a><span id="l1.496" class="difflineplus">+                                              nsIMsgDatabase **db) {</span>
<a href="#l1.497"></a><span id="l1.497" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; aFolder;</span>
<a href="#l1.498"></a><span id="l1.498">   nsresult rv = GetFolderForViewIndex(index, getter_AddRefs(aFolder));</span>
<a href="#l1.499"></a><span id="l1.499">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.500"></a><span id="l1.500">   return aFolder-&gt;GetMsgDatabase(db);</span>
<a href="#l1.501"></a><span id="l1.501"> }</span>
<a href="#l1.502"></a><span id="l1.502"> </span>
<a href="#l1.503"></a><span id="l1.503" class="difflineminus">-nsresult</span>
<a href="#l1.504"></a><span id="l1.504" class="difflineminus">-nsMsgSearchDBView::AddHdrFromFolder(nsIMsgDBHdr *msgHdr,</span>
<a href="#l1.505"></a><span id="l1.505" class="difflineminus">-                                    nsIMsgFolder *folder)</span>
<a href="#l1.506"></a><span id="l1.506" class="difflineminus">-{</span>
<a href="#l1.507"></a><span id="l1.507" class="difflineplus">+nsresult nsMsgSearchDBView::AddHdrFromFolder(nsIMsgDBHdr *msgHdr,</span>
<a href="#l1.508"></a><span id="l1.508" class="difflineplus">+                                             nsIMsgFolder *folder) {</span>
<a href="#l1.509"></a><span id="l1.509">   if (m_viewFlags &amp; nsMsgViewFlagsType::kGroupBySort)</span>
<a href="#l1.510"></a><span id="l1.510">     return nsMsgGroupView::OnNewHeader(msgHdr, nsMsgKey_None, true);</span>
<a href="#l1.511"></a><span id="l1.511"> </span>
<a href="#l1.512"></a><span id="l1.512">   nsMsgKey msgKey;</span>
<a href="#l1.513"></a><span id="l1.513">   uint32_t msgFlags;</span>
<a href="#l1.514"></a><span id="l1.514">   msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l1.515"></a><span id="l1.515">   msgHdr-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l1.516"></a><span id="l1.516"> </span>
<a href="#l1.517"></a><span id="l1.517" class="difflineminus">-  if (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay)</span>
<a href="#l1.518"></a><span id="l1.518" class="difflineminus">-  {</span>
<a href="#l1.519"></a><span id="l1.519" class="difflineplus">+  if (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay) {</span>
<a href="#l1.520"></a><span id="l1.520">     nsCOMPtr&lt;nsIMsgThread&gt; thread;</span>
<a href="#l1.521"></a><span id="l1.521">     nsCOMPtr&lt;nsIMsgDBHdr&gt; threadRoot;</span>
<a href="#l1.522"></a><span id="l1.522">     // If we find an xf thread in the hash table corresponding to the new msg's</span>
<a href="#l1.523"></a><span id="l1.523">     // message id, a previous header must be a reference child of the new</span>
<a href="#l1.524"></a><span id="l1.524">     // message, which means we need to reparent later.</span>
<a href="#l1.525"></a><span id="l1.525">     bool msgIsReferredTo;</span>
<a href="#l1.526"></a><span id="l1.526">     GetXFThreadFromMsgHdr(msgHdr, getter_AddRefs(thread), &amp;msgIsReferredTo);</span>
<a href="#l1.527"></a><span id="l1.527">     bool newThread = !thread;</span>
<a href="#l1.528"></a><span id="l1.528">     nsMsgXFViewThread *viewThread;</span>
<a href="#l1.529"></a><span id="l1.529" class="difflineminus">-    if (!thread)</span>
<a href="#l1.530"></a><span id="l1.530" class="difflineminus">-    {</span>
<a href="#l1.531"></a><span id="l1.531" class="difflineplus">+    if (!thread) {</span>
<a href="#l1.532"></a><span id="l1.532">       viewThread = new nsMsgXFViewThread(this, m_nextThreadId++);</span>
<a href="#l1.533"></a><span id="l1.533" class="difflineminus">-      if (!viewThread)</span>
<a href="#l1.534"></a><span id="l1.534" class="difflineminus">-        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l1.535"></a><span id="l1.535" class="difflineplus">+      if (!viewThread) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l1.536"></a><span id="l1.536"> </span>
<a href="#l1.537"></a><span id="l1.537">       thread = viewThread;</span>
<a href="#l1.538"></a><span id="l1.538" class="difflineminus">-    }</span>
<a href="#l1.539"></a><span id="l1.539" class="difflineminus">-    else</span>
<a href="#l1.540"></a><span id="l1.540" class="difflineminus">-    {</span>
<a href="#l1.541"></a><span id="l1.541" class="difflineminus">-      viewThread = static_cast&lt;nsMsgXFViewThread*&gt;(thread.get());</span>
<a href="#l1.542"></a><span id="l1.542" class="difflineplus">+    } else {</span>
<a href="#l1.543"></a><span id="l1.543" class="difflineplus">+      viewThread = static_cast&lt;nsMsgXFViewThread *&gt;(thread.get());</span>
<a href="#l1.544"></a><span id="l1.544">       thread-&gt;GetChildHdrAt(0, getter_AddRefs(threadRoot));</span>
<a href="#l1.545"></a><span id="l1.545">     }</span>
<a href="#l1.546"></a><span id="l1.546"> </span>
<a href="#l1.547"></a><span id="l1.547">     AddMsgToHashTables(msgHdr, thread);</span>
<a href="#l1.548"></a><span id="l1.548">     nsCOMPtr&lt;nsIMsgDBHdr&gt; parent;</span>
<a href="#l1.549"></a><span id="l1.549">     uint32_t posInThread;</span>
<a href="#l1.550"></a><span id="l1.550">     // We need to move threads in order to keep ourselves sorted</span>
<a href="#l1.551"></a><span id="l1.551">     // correctly.  We want the index of the original thread...we can do this by</span>
<a href="#l1.552"></a><span id="l1.552">     // getting the root header before we add the new header, and finding that.</span>
<a href="#l1.553"></a><span id="l1.553" class="difflineminus">-    if (newThread || !viewThread-&gt;MsgCount())</span>
<a href="#l1.554"></a><span id="l1.554" class="difflineminus">-    {</span>
<a href="#l1.555"></a><span id="l1.555" class="difflineplus">+    if (newThread || !viewThread-&gt;MsgCount()) {</span>
<a href="#l1.556"></a><span id="l1.556">       viewThread-&gt;AddHdr(msgHdr, false, posInThread, getter_AddRefs(parent));</span>
<a href="#l1.557"></a><span id="l1.557">       nsMsgViewIndex insertIndex = GetIndexForThread(msgHdr);</span>
<a href="#l1.558"></a><span id="l1.558">       NS_ASSERTION(insertIndex == m_levels.Length() ||</span>
<a href="#l1.559"></a><span id="l1.559" class="difflineminus">-                   (IsValidIndex(insertIndex) &amp;&amp; !m_levels[insertIndex]),</span>
<a href="#l1.560"></a><span id="l1.560" class="difflineplus">+                       (IsValidIndex(insertIndex) &amp;&amp; !m_levels[insertIndex]),</span>
<a href="#l1.561"></a><span id="l1.561">                    &quot;inserting into middle of thread&quot;);</span>
<a href="#l1.562"></a><span id="l1.562">       if (insertIndex == nsMsgViewIndex_None)</span>
<a href="#l1.563"></a><span id="l1.563">         return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.564"></a><span id="l1.564"> </span>
<a href="#l1.565"></a><span id="l1.565">       if (!(m_viewFlags &amp; nsMsgViewFlagsType::kExpandAll))</span>
<a href="#l1.566"></a><span id="l1.566">         msgFlags |= nsMsgMessageFlags::Elided;</span>
<a href="#l1.567"></a><span id="l1.567"> </span>
<a href="#l1.568"></a><span id="l1.568">       InsertMsgHdrAt(insertIndex, msgHdr, msgKey, msgFlags, 0);</span>
<a href="#l1.569"></a><span id="l1.569">       NoteChange(insertIndex, 1, nsMsgViewNotificationCode::insertOrDelete);</span>
<a href="#l1.570"></a><span id="l1.570" class="difflineminus">-    }</span>
<a href="#l1.571"></a><span id="l1.571" class="difflineminus">-    else</span>
<a href="#l1.572"></a><span id="l1.572" class="difflineminus">-    {</span>
<a href="#l1.573"></a><span id="l1.573" class="difflineplus">+    } else {</span>
<a href="#l1.574"></a><span id="l1.574">       // Get the thread root index before we add the header, because adding</span>
<a href="#l1.575"></a><span id="l1.575">       // the header can change the sort position.</span>
<a href="#l1.576"></a><span id="l1.576">       nsMsgViewIndex threadIndex = GetThreadRootIndex(threadRoot);</span>
<a href="#l1.577"></a><span id="l1.577" class="difflineminus">-      viewThread-&gt;AddHdr(msgHdr, msgIsReferredTo, posInThread, getter_AddRefs(parent));</span>
<a href="#l1.578"></a><span id="l1.578" class="difflineminus">-      if (!IsValidIndex(threadIndex))</span>
<a href="#l1.579"></a><span id="l1.579" class="difflineminus">-      {</span>
<a href="#l1.580"></a><span id="l1.580" class="difflineplus">+      viewThread-&gt;AddHdr(msgHdr, msgIsReferredTo, posInThread,</span>
<a href="#l1.581"></a><span id="l1.581" class="difflineplus">+                         getter_AddRefs(parent));</span>
<a href="#l1.582"></a><span id="l1.582" class="difflineplus">+      if (!IsValidIndex(threadIndex)) {</span>
<a href="#l1.583"></a><span id="l1.583">         NS_ERROR(&quot;couldn't find thread index for newly inserted header&quot;);</span>
<a href="#l1.584"></a><span id="l1.584">         // Not really OK, but not failure exactly.</span>
<a href="#l1.585"></a><span id="l1.585">         return NS_OK;</span>
<a href="#l1.586"></a><span id="l1.586">       }</span>
<a href="#l1.587"></a><span id="l1.587"> </span>
<a href="#l1.588"></a><span id="l1.588" class="difflineminus">-      NS_ASSERTION(!m_levels[threadIndex], &quot;threadRoot incorrect, or level incorrect&quot;);</span>
<a href="#l1.589"></a><span id="l1.589" class="difflineplus">+      NS_ASSERTION(!m_levels[threadIndex],</span>
<a href="#l1.590"></a><span id="l1.590" class="difflineplus">+                   &quot;threadRoot incorrect, or level incorrect&quot;);</span>
<a href="#l1.591"></a><span id="l1.591"> </span>
<a href="#l1.592"></a><span id="l1.592">       bool moveThread = false;</span>
<a href="#l1.593"></a><span id="l1.593" class="difflineminus">-      if (m_sortType == nsMsgViewSortType::byDate)</span>
<a href="#l1.594"></a><span id="l1.594" class="difflineminus">-      {</span>
<a href="#l1.595"></a><span id="l1.595" class="difflineplus">+      if (m_sortType == nsMsgViewSortType::byDate) {</span>
<a href="#l1.596"></a><span id="l1.596">         uint32_t newestMsgInThread = 0, msgDate = 0;</span>
<a href="#l1.597"></a><span id="l1.597">         viewThread-&gt;GetNewestMsgDate(&amp;newestMsgInThread);</span>
<a href="#l1.598"></a><span id="l1.598">         msgHdr-&gt;GetDateInSeconds(&amp;msgDate);</span>
<a href="#l1.599"></a><span id="l1.599">         moveThread = (msgDate == newestMsgInThread);</span>
<a href="#l1.600"></a><span id="l1.600">       }</span>
<a href="#l1.601"></a><span id="l1.601"> </span>
<a href="#l1.602"></a><span id="l1.602" class="difflineminus">-      OrExtraFlag(threadIndex, MSG_VIEW_FLAG_HASCHILDREN | MSG_VIEW_FLAG_ISTHREAD);</span>
<a href="#l1.603"></a><span id="l1.603" class="difflineminus">-      if (!(m_flags[threadIndex] &amp; nsMsgMessageFlags::Elided))</span>
<a href="#l1.604"></a><span id="l1.604" class="difflineminus">-      {</span>
<a href="#l1.605"></a><span id="l1.605" class="difflineminus">-        if (parent)</span>
<a href="#l1.606"></a><span id="l1.606" class="difflineminus">-        {</span>
<a href="#l1.607"></a><span id="l1.607" class="difflineplus">+      OrExtraFlag(threadIndex,</span>
<a href="#l1.608"></a><span id="l1.608" class="difflineplus">+                  MSG_VIEW_FLAG_HASCHILDREN | MSG_VIEW_FLAG_ISTHREAD);</span>
<a href="#l1.609"></a><span id="l1.609" class="difflineplus">+      if (!(m_flags[threadIndex] &amp; nsMsgMessageFlags::Elided)) {</span>
<a href="#l1.610"></a><span id="l1.610" class="difflineplus">+        if (parent) {</span>
<a href="#l1.611"></a><span id="l1.611">           // Since we know posInThread, we just want to insert the new hdr</span>
<a href="#l1.612"></a><span id="l1.612">           // at threadIndex + posInThread, and then rebuild the view until we</span>
<a href="#l1.613"></a><span id="l1.613">           // get to a sibling of the new hdr.</span>
<a href="#l1.614"></a><span id="l1.614">           uint8_t newMsgLevel = viewThread-&gt;ChildLevelAt(posInThread);</span>
<a href="#l1.615"></a><span id="l1.615">           InsertMsgHdrAt(threadIndex + posInThread, msgHdr, msgKey, msgFlags,</span>
<a href="#l1.616"></a><span id="l1.616">                          newMsgLevel);</span>
<a href="#l1.617"></a><span id="l1.617"> </span>
<a href="#l1.618"></a><span id="l1.618" class="difflineminus">-          NoteChange(threadIndex + posInThread, 1, nsMsgViewNotificationCode::insertOrDelete);</span>
<a href="#l1.619"></a><span id="l1.619" class="difflineplus">+          NoteChange(threadIndex + posInThread, 1,</span>
<a href="#l1.620"></a><span id="l1.620" class="difflineplus">+                     nsMsgViewNotificationCode::insertOrDelete);</span>
<a href="#l1.621"></a><span id="l1.621">           for (nsMsgViewIndex viewIndex = threadIndex + ++posInThread;</span>
<a href="#l1.622"></a><span id="l1.622">                posInThread &lt; viewThread-&gt;MsgCount() &amp;&amp;</span>
<a href="#l1.623"></a><span id="l1.623" class="difflineminus">-               viewThread-&gt;ChildLevelAt(posInThread) &gt; newMsgLevel; viewIndex++)</span>
<a href="#l1.624"></a><span id="l1.624" class="difflineminus">-          {</span>
<a href="#l1.625"></a><span id="l1.625" class="difflineplus">+               viewThread-&gt;ChildLevelAt(posInThread) &gt; newMsgLevel;</span>
<a href="#l1.626"></a><span id="l1.626" class="difflineplus">+               viewIndex++) {</span>
<a href="#l1.627"></a><span id="l1.627">             m_levels[viewIndex] = viewThread-&gt;ChildLevelAt(posInThread++);</span>
<a href="#l1.628"></a><span id="l1.628">           }</span>
<a href="#l1.629"></a><span id="l1.629"> </span>
<a href="#l1.630"></a><span id="l1.630" class="difflineminus">-        }</span>
<a href="#l1.631"></a><span id="l1.631" class="difflineminus">-        else</span>
<a href="#l1.632"></a><span id="l1.632" class="difflineminus">-        {</span>
<a href="#l1.633"></a><span id="l1.633" class="difflineplus">+        } else {</span>
<a href="#l1.634"></a><span id="l1.634">           // The new header is the root, so we need to adjust all the children.</span>
<a href="#l1.635"></a><span id="l1.635">           InsertMsgHdrAt(threadIndex, msgHdr, msgKey, msgFlags, 0);</span>
<a href="#l1.636"></a><span id="l1.636"> </span>
<a href="#l1.637"></a><span id="l1.637">           NoteChange(threadIndex, 1, nsMsgViewNotificationCode::insertOrDelete);</span>
<a href="#l1.638"></a><span id="l1.638">           nsMsgViewIndex i;</span>
<a href="#l1.639"></a><span id="l1.639">           for (i = threadIndex + 1;</span>
<a href="#l1.640"></a><span id="l1.640">                i &lt; m_keys.Length() &amp;&amp; (i == threadIndex + 1 || m_levels[i]);</span>
<a href="#l1.641"></a><span id="l1.641">                i++)</span>
<a href="#l1.642"></a><span id="l1.642">             m_levels[i] = m_levels[i] + 1;</span>
<a href="#l1.643"></a><span id="l1.643">           // Turn off thread flags on old root.</span>
<a href="#l1.644"></a><span id="l1.644" class="difflineminus">-          AndExtraFlag(threadIndex + 1, ~(MSG_VIEW_FLAG_ISTHREAD |</span>
<a href="#l1.645"></a><span id="l1.645" class="difflineminus">-                                          nsMsgMessageFlags::Elided |</span>
<a href="#l1.646"></a><span id="l1.646" class="difflineminus">-                                          MSG_VIEW_FLAG_HASCHILDREN));</span>
<a href="#l1.647"></a><span id="l1.647" class="difflineplus">+          AndExtraFlag(threadIndex + 1,</span>
<a href="#l1.648"></a><span id="l1.648" class="difflineplus">+                       ~(MSG_VIEW_FLAG_ISTHREAD | nsMsgMessageFlags::Elided |</span>
<a href="#l1.649"></a><span id="l1.649" class="difflineplus">+                         MSG_VIEW_FLAG_HASCHILDREN));</span>
<a href="#l1.650"></a><span id="l1.650"> </span>
<a href="#l1.651"></a><span id="l1.651">           NoteChange(threadIndex + 1, i - threadIndex + 1,</span>
<a href="#l1.652"></a><span id="l1.652">                      nsMsgViewNotificationCode::changed);</span>
<a href="#l1.653"></a><span id="l1.653">         }</span>
<a href="#l1.654"></a><span id="l1.654" class="difflineminus">-      }</span>
<a href="#l1.655"></a><span id="l1.655" class="difflineminus">-      else if (!parent)</span>
<a href="#l1.656"></a><span id="l1.656" class="difflineminus">-      {</span>
<a href="#l1.657"></a><span id="l1.657" class="difflineplus">+      } else if (!parent) {</span>
<a href="#l1.658"></a><span id="l1.658">         // New parent came into collapsed thread.</span>
<a href="#l1.659"></a><span id="l1.659">         nsCOMPtr&lt;nsIMsgFolder&gt; msgFolder;</span>
<a href="#l1.660"></a><span id="l1.660">         msgHdr-&gt;GetFolder(getter_AddRefs(msgFolder));</span>
<a href="#l1.661"></a><span id="l1.661">         m_keys[threadIndex] = msgKey;</span>
<a href="#l1.662"></a><span id="l1.662">         m_folders.ReplaceObjectAt(msgFolder, threadIndex);</span>
<a href="#l1.663"></a><span id="l1.663">         m_flags[threadIndex] = msgFlags | MSG_VIEW_FLAG_ISTHREAD |</span>
<a href="#l1.664"></a><span id="l1.664" class="difflineminus">-                                          nsMsgMessageFlags::Elided |</span>
<a href="#l1.665"></a><span id="l1.665" class="difflineminus">-                                          MSG_VIEW_FLAG_HASCHILDREN;</span>
<a href="#l1.666"></a><span id="l1.666" class="difflineplus">+                               nsMsgMessageFlags::Elided |</span>
<a href="#l1.667"></a><span id="l1.667" class="difflineplus">+                               MSG_VIEW_FLAG_HASCHILDREN;</span>
<a href="#l1.668"></a><span id="l1.668">         NoteChange(threadIndex, 1, nsMsgViewNotificationCode::changed);</span>
<a href="#l1.669"></a><span id="l1.669" class="difflineminus">-</span>
<a href="#l1.670"></a><span id="l1.670">       }</span>
<a href="#l1.671"></a><span id="l1.671"> </span>
<a href="#l1.672"></a><span id="l1.672" class="difflineminus">-      if (moveThread)</span>
<a href="#l1.673"></a><span id="l1.673" class="difflineminus">-        MoveThreadAt(threadIndex);</span>
<a href="#l1.674"></a><span id="l1.674" class="difflineplus">+      if (moveThread) MoveThreadAt(threadIndex);</span>
<a href="#l1.675"></a><span id="l1.675">     }</span>
<a href="#l1.676"></a><span id="l1.676" class="difflineminus">-  }</span>
<a href="#l1.677"></a><span id="l1.677" class="difflineminus">-  else</span>
<a href="#l1.678"></a><span id="l1.678" class="difflineminus">-  {</span>
<a href="#l1.679"></a><span id="l1.679" class="difflineplus">+  } else {</span>
<a href="#l1.680"></a><span id="l1.680">     m_folders.AppendObject(folder);</span>
<a href="#l1.681"></a><span id="l1.681">     // nsMsgKey_None means it's not a valid hdr.</span>
<a href="#l1.682"></a><span id="l1.682" class="difflineminus">-    if (msgKey != nsMsgKey_None)</span>
<a href="#l1.683"></a><span id="l1.683" class="difflineminus">-    {</span>
<a href="#l1.684"></a><span id="l1.684" class="difflineplus">+    if (msgKey != nsMsgKey_None) {</span>
<a href="#l1.685"></a><span id="l1.685">       msgHdr-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l1.686"></a><span id="l1.686">       m_keys.AppendElement(msgKey);</span>
<a href="#l1.687"></a><span id="l1.687">       m_levels.AppendElement(0);</span>
<a href="#l1.688"></a><span id="l1.688">       m_flags.AppendElement(msgFlags);</span>
<a href="#l1.689"></a><span id="l1.689">       NoteChange(GetSize() - 1, 1, nsMsgViewNotificationCode::insertOrDelete);</span>
<a href="#l1.690"></a><span id="l1.690">     }</span>
<a href="#l1.691"></a><span id="l1.691">   }</span>
<a href="#l1.692"></a><span id="l1.692"> </span>
<a href="#l1.693"></a><span id="l1.693">   return NS_OK;</span>
<a href="#l1.694"></a><span id="l1.694" class="difflineminus">-  }</span>
<a href="#l1.695"></a><span id="l1.695" class="difflineplus">+}</span>
<a href="#l1.696"></a><span id="l1.696"> </span>
<a href="#l1.697"></a><span id="l1.697"> // This method removes the thread at threadIndex from the view</span>
<a href="#l1.698"></a><span id="l1.698"> // and puts it back in its new position, determined by the sort order.</span>
<a href="#l1.699"></a><span id="l1.699"> // And, if the selection is affected, save and restore the selection.</span>
<a href="#l1.700"></a><span id="l1.700" class="difflineminus">-void nsMsgSearchDBView::MoveThreadAt(nsMsgViewIndex threadIndex)</span>
<a href="#l1.701"></a><span id="l1.701" class="difflineminus">-{</span>
<a href="#l1.702"></a><span id="l1.702" class="difflineplus">+void nsMsgSearchDBView::MoveThreadAt(nsMsgViewIndex threadIndex) {</span>
<a href="#l1.703"></a><span id="l1.703">   bool updatesSuppressed = mSuppressChangeNotification;</span>
<a href="#l1.704"></a><span id="l1.704">   // Turn off tree notifications so that we don't reload the current message.</span>
<a href="#l1.705"></a><span id="l1.705" class="difflineminus">-  if (!updatesSuppressed)</span>
<a href="#l1.706"></a><span id="l1.706" class="difflineminus">-    SetSuppressChangeNotifications(true);</span>
<a href="#l1.707"></a><span id="l1.707" class="difflineplus">+  if (!updatesSuppressed) SetSuppressChangeNotifications(true);</span>
<a href="#l1.708"></a><span id="l1.708"> </span>
<a href="#l1.709"></a><span id="l1.709">   nsCOMPtr&lt;nsIMsgDBHdr&gt; threadHdr;</span>
<a href="#l1.710"></a><span id="l1.710">   GetMsgHdrForViewIndex(threadIndex, getter_AddRefs(threadHdr));</span>
<a href="#l1.711"></a><span id="l1.711"> </span>
<a href="#l1.712"></a><span id="l1.712">   uint32_t saveFlags = m_flags[threadIndex];</span>
<a href="#l1.713"></a><span id="l1.713">   bool threadIsExpanded = !(saveFlags &amp; nsMsgMessageFlags::Elided);</span>
<a href="#l1.714"></a><span id="l1.714">   int32_t childCount = 0;</span>
<a href="#l1.715"></a><span id="l1.715">   nsMsgKey preservedKey;</span>
<a href="#l1.716"></a><span id="l1.716">   AutoTArray&lt;nsMsgKey, 1&gt; preservedSelection;</span>
<a href="#l1.717"></a><span id="l1.717">   int32_t selectionCount;</span>
<a href="#l1.718"></a><span id="l1.718">   int32_t currentIndex;</span>
<a href="#l1.719"></a><span id="l1.719" class="difflineminus">-  bool hasSelection = mTree &amp;&amp; mTreeSelection &amp;&amp;</span>
<a href="#l1.720"></a><span id="l1.720" class="difflineminus">-                      ((NS_SUCCEEDED(mTreeSelection-&gt;GetCurrentIndex(&amp;currentIndex)) &amp;&amp;</span>
<a href="#l1.721"></a><span id="l1.721" class="difflineminus">-                        currentIndex &gt;= 0 &amp;&amp; (uint32_t)currentIndex &lt; GetSize()) ||</span>
<a href="#l1.722"></a><span id="l1.722" class="difflineminus">-                       (NS_SUCCEEDED(mTreeSelection-&gt;GetRangeCount(&amp;selectionCount)) &amp;&amp;</span>
<a href="#l1.723"></a><span id="l1.723" class="difflineminus">-                        selectionCount &gt; 0));</span>
<a href="#l1.724"></a><span id="l1.724" class="difflineminus">-  if (hasSelection)</span>
<a href="#l1.725"></a><span id="l1.725" class="difflineminus">-    SaveAndClearSelection(&amp;preservedKey, preservedSelection);</span>
<a href="#l1.726"></a><span id="l1.726" class="difflineplus">+  bool hasSelection =</span>
<a href="#l1.727"></a><span id="l1.727" class="difflineplus">+      mTree &amp;&amp; mTreeSelection &amp;&amp;</span>
<a href="#l1.728"></a><span id="l1.728" class="difflineplus">+      ((NS_SUCCEEDED(mTreeSelection-&gt;GetCurrentIndex(&amp;currentIndex)) &amp;&amp;</span>
<a href="#l1.729"></a><span id="l1.729" class="difflineplus">+        currentIndex &gt;= 0 &amp;&amp; (uint32_t)currentIndex &lt; GetSize()) ||</span>
<a href="#l1.730"></a><span id="l1.730" class="difflineplus">+       (NS_SUCCEEDED(mTreeSelection-&gt;GetRangeCount(&amp;selectionCount)) &amp;&amp;</span>
<a href="#l1.731"></a><span id="l1.731" class="difflineplus">+        selectionCount &gt; 0));</span>
<a href="#l1.732"></a><span id="l1.732" class="difflineplus">+  if (hasSelection) SaveAndClearSelection(&amp;preservedKey, preservedSelection);</span>
<a href="#l1.733"></a><span id="l1.733"> </span>
<a href="#l1.734"></a><span id="l1.734" class="difflineminus">-  if (threadIsExpanded)</span>
<a href="#l1.735"></a><span id="l1.735" class="difflineminus">-  {</span>
<a href="#l1.736"></a><span id="l1.736" class="difflineplus">+  if (threadIsExpanded) {</span>
<a href="#l1.737"></a><span id="l1.737">     ExpansionDelta(threadIndex, &amp;childCount);</span>
<a href="#l1.738"></a><span id="l1.738">     childCount = -childCount;</span>
<a href="#l1.739"></a><span id="l1.739">   }</span>
<a href="#l1.740"></a><span id="l1.740"> </span>
<a href="#l1.741"></a><span id="l1.741">   nsTArray&lt;nsMsgKey&gt; threadKeys;</span>
<a href="#l1.742"></a><span id="l1.742">   nsTArray&lt;uint32_t&gt; threadFlags;</span>
<a href="#l1.743"></a><span id="l1.743">   nsTArray&lt;uint8_t&gt; threadLevels;</span>
<a href="#l1.744"></a><span id="l1.744">   nsCOMArray&lt;nsIMsgFolder&gt; threadFolders;</span>
<a href="#l1.745"></a><span id="l1.745"> </span>
<a href="#l1.746"></a><span id="l1.746" class="difflineminus">-  if (threadIsExpanded)</span>
<a href="#l1.747"></a><span id="l1.747" class="difflineminus">-  {</span>
<a href="#l1.748"></a><span id="l1.748" class="difflineplus">+  if (threadIsExpanded) {</span>
<a href="#l1.749"></a><span id="l1.749">     threadKeys.SetCapacity(childCount);</span>
<a href="#l1.750"></a><span id="l1.750">     threadFlags.SetCapacity(childCount);</span>
<a href="#l1.751"></a><span id="l1.751">     threadLevels.SetCapacity(childCount);</span>
<a href="#l1.752"></a><span id="l1.752">     threadFolders.SetCapacity(childCount);</span>
<a href="#l1.753"></a><span id="l1.753">     for (nsMsgViewIndex index = threadIndex + 1;</span>
<a href="#l1.754"></a><span id="l1.754" class="difflineminus">-         index &lt; (nsMsgViewIndex) GetSize() &amp;&amp; m_levels[index];</span>
<a href="#l1.755"></a><span id="l1.755" class="difflineminus">-         index++)</span>
<a href="#l1.756"></a><span id="l1.756" class="difflineminus">-    {</span>
<a href="#l1.757"></a><span id="l1.757" class="difflineplus">+         index &lt; (nsMsgViewIndex)GetSize() &amp;&amp; m_levels[index]; index++) {</span>
<a href="#l1.758"></a><span id="l1.758">       threadKeys.AppendElement(m_keys[index]);</span>
<a href="#l1.759"></a><span id="l1.759">       threadFlags.AppendElement(m_flags[index]);</span>
<a href="#l1.760"></a><span id="l1.760">       threadLevels.AppendElement(m_levels[index]);</span>
<a href="#l1.761"></a><span id="l1.761">       threadFolders.AppendObject(m_folders[index]);</span>
<a href="#l1.762"></a><span id="l1.762">     }</span>
<a href="#l1.763"></a><span id="l1.763"> </span>
<a href="#l1.764"></a><span id="l1.764">     uint32_t collapseCount;</span>
<a href="#l1.765"></a><span id="l1.765">     CollapseByIndex(threadIndex, &amp;collapseCount);</span>
<a href="#l1.766"></a><span id="l1.766">   }</span>
<a href="#l1.767"></a><span id="l1.767"> </span>
<a href="#l1.768"></a><span id="l1.768">   nsMsgDBView::RemoveByIndex(threadIndex);</span>
<a href="#l1.769"></a><span id="l1.769">   m_folders.RemoveObjectAt(threadIndex);</span>
<a href="#l1.770"></a><span id="l1.770">   nsMsgViewIndex newIndex = GetIndexForThread(threadHdr);</span>
<a href="#l1.771"></a><span id="l1.771">   NS_ASSERTION(newIndex == m_levels.Length() ||</span>
<a href="#l1.772"></a><span id="l1.772" class="difflineminus">-               (IsValidIndex(newIndex) &amp;&amp; !m_levels[newIndex]),</span>
<a href="#l1.773"></a><span id="l1.773" class="difflineplus">+                   (IsValidIndex(newIndex) &amp;&amp; !m_levels[newIndex]),</span>
<a href="#l1.774"></a><span id="l1.774">                &quot;inserting into middle of thread&quot;);</span>
<a href="#l1.775"></a><span id="l1.775" class="difflineminus">-  if (newIndex == nsMsgViewIndex_None)</span>
<a href="#l1.776"></a><span id="l1.776" class="difflineminus">-    newIndex = 0;</span>
<a href="#l1.777"></a><span id="l1.777" class="difflineplus">+  if (newIndex == nsMsgViewIndex_None) newIndex = 0;</span>
<a href="#l1.778"></a><span id="l1.778"> </span>
<a href="#l1.779"></a><span id="l1.779">   nsMsgKey msgKey;</span>
<a href="#l1.780"></a><span id="l1.780">   uint32_t msgFlags;</span>
<a href="#l1.781"></a><span id="l1.781">   threadHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l1.782"></a><span id="l1.782">   threadHdr-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l1.783"></a><span id="l1.783">   InsertMsgHdrAt(newIndex, threadHdr, msgKey, msgFlags, 0);</span>
<a href="#l1.784"></a><span id="l1.784"> </span>
<a href="#l1.785"></a><span id="l1.785" class="difflineminus">-  if (threadIsExpanded)</span>
<a href="#l1.786"></a><span id="l1.786" class="difflineminus">-  {</span>
<a href="#l1.787"></a><span id="l1.787" class="difflineplus">+  if (threadIsExpanded) {</span>
<a href="#l1.788"></a><span id="l1.788">     m_keys.InsertElementsAt(newIndex + 1, threadKeys);</span>
<a href="#l1.789"></a><span id="l1.789">     m_flags.InsertElementsAt(newIndex + 1, threadFlags);</span>
<a href="#l1.790"></a><span id="l1.790">     m_levels.InsertElementsAt(newIndex + 1, threadLevels);</span>
<a href="#l1.791"></a><span id="l1.791">     m_folders.InsertObjectsAt(threadFolders, newIndex + 1);</span>
<a href="#l1.792"></a><span id="l1.792">   }</span>
<a href="#l1.793"></a><span id="l1.793"> </span>
<a href="#l1.794"></a><span id="l1.794">   m_flags[newIndex] = saveFlags;</span>
<a href="#l1.795"></a><span id="l1.795">   // Unfreeze selection.</span>
<a href="#l1.796"></a><span id="l1.796" class="difflineminus">-  if (hasSelection)</span>
<a href="#l1.797"></a><span id="l1.797" class="difflineminus">-    RestoreSelection(preservedKey, preservedSelection);</span>
<a href="#l1.798"></a><span id="l1.798" class="difflineplus">+  if (hasSelection) RestoreSelection(preservedKey, preservedSelection);</span>
<a href="#l1.799"></a><span id="l1.799"> </span>
<a href="#l1.800"></a><span id="l1.800" class="difflineminus">-  if (!updatesSuppressed)</span>
<a href="#l1.801"></a><span id="l1.801" class="difflineminus">-    SetSuppressChangeNotifications(false);</span>
<a href="#l1.802"></a><span id="l1.802" class="difflineplus">+  if (!updatesSuppressed) SetSuppressChangeNotifications(false);</span>
<a href="#l1.803"></a><span id="l1.803"> </span>
<a href="#l1.804"></a><span id="l1.804">   nsMsgViewIndex lowIndex = threadIndex &lt; newIndex ? threadIndex : newIndex;</span>
<a href="#l1.805"></a><span id="l1.805">   nsMsgViewIndex highIndex = lowIndex == threadIndex ? newIndex : threadIndex;</span>
<a href="#l1.806"></a><span id="l1.806">   NoteChange(lowIndex, highIndex - lowIndex + childCount + 1,</span>
<a href="#l1.807"></a><span id="l1.807">              nsMsgViewNotificationCode::changed);</span>
<a href="#l1.808"></a><span id="l1.808"> }</span>
<a href="#l1.809"></a><span id="l1.809"> </span>
<a href="#l1.810"></a><span id="l1.810" class="difflineminus">-nsresult</span>
<a href="#l1.811"></a><span id="l1.811" class="difflineminus">-nsMsgSearchDBView::GetMessageEnumerator(nsISimpleEnumerator **enumerator)</span>
<a href="#l1.812"></a><span id="l1.812" class="difflineminus">-{</span>
<a href="#l1.813"></a><span id="l1.813" class="difflineplus">+nsresult nsMsgSearchDBView::GetMessageEnumerator(</span>
<a href="#l1.814"></a><span id="l1.814" class="difflineplus">+    nsISimpleEnumerator **enumerator) {</span>
<a href="#l1.815"></a><span id="l1.815">   // We do not have an m_db, so the default behavior (in nsMsgDBView) is not</span>
<a href="#l1.816"></a><span id="l1.816">   // what we want (it will crash).  We just want someone to enumerate the</span>
<a href="#l1.817"></a><span id="l1.817">   // headers that we already have.  Conveniently, nsMsgDBView already knows</span>
<a href="#l1.818"></a><span id="l1.818">   // how to do this with its view enumerator, so we just use that.</span>
<a href="#l1.819"></a><span id="l1.819">   return nsMsgDBView::GetViewEnumerator(enumerator);</span>
<a href="#l1.820"></a><span id="l1.820"> }</span>
<a href="#l1.821"></a><span id="l1.821"> </span>
<a href="#l1.822"></a><span id="l1.822" class="difflineminus">-nsresult</span>
<a href="#l1.823"></a><span id="l1.823" class="difflineminus">-nsMsgSearchDBView::InsertHdrFromFolder(nsIMsgDBHdr *msgHdr,</span>
<a href="#l1.824"></a><span id="l1.824" class="difflineminus">-                                       nsIMsgFolder *folder)</span>
<a href="#l1.825"></a><span id="l1.825" class="difflineminus">-{</span>
<a href="#l1.826"></a><span id="l1.826" class="difflineplus">+nsresult nsMsgSearchDBView::InsertHdrFromFolder(nsIMsgDBHdr *msgHdr,</span>
<a href="#l1.827"></a><span id="l1.827" class="difflineplus">+                                                nsIMsgFolder *folder) {</span>
<a href="#l1.828"></a><span id="l1.828">   nsMsgViewIndex insertIndex = nsMsgViewIndex_None;</span>
<a href="#l1.829"></a><span id="l1.829">   // Threaded view always needs to go through AddHdrFromFolder since</span>
<a href="#l1.830"></a><span id="l1.830">   // it handles the xf view thread object creation.</span>
<a href="#l1.831"></a><span id="l1.831" class="difflineminus">-  if (! (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay))</span>
<a href="#l1.832"></a><span id="l1.832" class="difflineplus">+  if (!(m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay))</span>
<a href="#l1.833"></a><span id="l1.833">     insertIndex = GetInsertIndex(msgHdr);</span>
<a href="#l1.834"></a><span id="l1.834"> </span>
<a href="#l1.835"></a><span id="l1.835">   if (insertIndex == nsMsgViewIndex_None)</span>
<a href="#l1.836"></a><span id="l1.836">     return AddHdrFromFolder(msgHdr, folder);</span>
<a href="#l1.837"></a><span id="l1.837"> </span>
<a href="#l1.838"></a><span id="l1.838">   nsMsgKey msgKey;</span>
<a href="#l1.839"></a><span id="l1.839">   uint32_t msgFlags;</span>
<a href="#l1.840"></a><span id="l1.840">   msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l1.841"></a><span id="l1.841" class="difflineat">@@ -704,138 +616,122 @@ nsMsgSearchDBView::InsertHdrFromFolder(n</span>
<a href="#l1.842"></a><span id="l1.842"> </span>
<a href="#l1.843"></a><span id="l1.843">   // The call to NoteChange() has to happen after we add the key as</span>
<a href="#l1.844"></a><span id="l1.844">   // NoteChange() will call RowCountChanged() which will call our GetRowCount().</span>
<a href="#l1.845"></a><span id="l1.845">   NoteChange(insertIndex, 1, nsMsgViewNotificationCode::insertOrDelete);</span>
<a href="#l1.846"></a><span id="l1.846">   return NS_OK;</span>
<a href="#l1.847"></a><span id="l1.847"> }</span>
<a href="#l1.848"></a><span id="l1.848"> </span>
<a href="#l1.849"></a><span id="l1.849"> NS_IMETHODIMP</span>
<a href="#l1.850"></a><span id="l1.850" class="difflineminus">-nsMsgSearchDBView::OnSearchHit(nsIMsgDBHdr* aMsgHdr,</span>
<a href="#l1.851"></a><span id="l1.851" class="difflineminus">-                               nsIMsgFolder *folder)</span>
<a href="#l1.852"></a><span id="l1.852" class="difflineminus">-{</span>
<a href="#l1.853"></a><span id="l1.853" class="difflineplus">+nsMsgSearchDBView::OnSearchHit(nsIMsgDBHdr *aMsgHdr, nsIMsgFolder *folder) {</span>
<a href="#l1.854"></a><span id="l1.854">   NS_ENSURE_ARG(aMsgHdr);</span>
<a href="#l1.855"></a><span id="l1.855">   NS_ENSURE_ARG(folder);</span>
<a href="#l1.856"></a><span id="l1.856"> </span>
<a href="#l1.857"></a><span id="l1.857" class="difflineminus">-  if (m_folders.IndexOf(folder) &lt; 0 )</span>
<a href="#l1.858"></a><span id="l1.858" class="difflineplus">+  if (m_folders.IndexOf(folder) &lt; 0)</span>
<a href="#l1.859"></a><span id="l1.859">   // Do this just for new folder.</span>
<a href="#l1.860"></a><span id="l1.860">   {</span>
<a href="#l1.861"></a><span id="l1.861">     nsCOMPtr&lt;nsIMsgDatabase&gt; dbToUse;</span>
<a href="#l1.862"></a><span id="l1.862">     nsCOMPtr&lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l1.863"></a><span id="l1.863" class="difflineminus">-    folder-&gt;GetDBFolderInfoAndDB(getter_AddRefs(folderInfo), getter_AddRefs(dbToUse));</span>
<a href="#l1.864"></a><span id="l1.864" class="difflineminus">-    if (dbToUse)</span>
<a href="#l1.865"></a><span id="l1.865" class="difflineminus">-    {</span>
<a href="#l1.866"></a><span id="l1.866" class="difflineplus">+    folder-&gt;GetDBFolderInfoAndDB(getter_AddRefs(folderInfo),</span>
<a href="#l1.867"></a><span id="l1.867" class="difflineplus">+                                 getter_AddRefs(dbToUse));</span>
<a href="#l1.868"></a><span id="l1.868" class="difflineplus">+    if (dbToUse) {</span>
<a href="#l1.869"></a><span id="l1.869">       dbToUse-&gt;AddListener(this);</span>
<a href="#l1.870"></a><span id="l1.870">       m_dbToUseList.AppendObject(dbToUse);</span>
<a href="#l1.871"></a><span id="l1.871">     }</span>
<a href="#l1.872"></a><span id="l1.872">   }</span>
<a href="#l1.873"></a><span id="l1.873"> </span>
<a href="#l1.874"></a><span id="l1.874">   m_totalMessagesInView++;</span>
<a href="#l1.875"></a><span id="l1.875">   if (m_sortValid)</span>
<a href="#l1.876"></a><span id="l1.876">     return InsertHdrFromFolder(aMsgHdr, folder);</span>
<a href="#l1.877"></a><span id="l1.877">   else</span>
<a href="#l1.878"></a><span id="l1.878">     return AddHdrFromFolder(aMsgHdr, folder);</span>
<a href="#l1.879"></a><span id="l1.879"> }</span>
<a href="#l1.880"></a><span id="l1.880"> </span>
<a href="#l1.881"></a><span id="l1.881"> NS_IMETHODIMP</span>
<a href="#l1.882"></a><span id="l1.882" class="difflineminus">-nsMsgSearchDBView::OnSearchDone(nsresult status)</span>
<a href="#l1.883"></a><span id="l1.883" class="difflineminus">-{</span>
<a href="#l1.884"></a><span id="l1.884" class="difflineplus">+nsMsgSearchDBView::OnSearchDone(nsresult status) {</span>
<a href="#l1.885"></a><span id="l1.885">   // We want to set imap delete model once the search is over because setting</span>
<a href="#l1.886"></a><span id="l1.886">   // next message after deletion will happen before deleting the message and</span>
<a href="#l1.887"></a><span id="l1.887">   // search scope can change with every search.</span>
<a href="#l1.888"></a><span id="l1.888"> </span>
<a href="#l1.889"></a><span id="l1.889">   // Set to default in case it is non-imap folder.</span>
<a href="#l1.890"></a><span id="l1.890">   mDeleteModel = nsMsgImapDeleteModels::MoveToTrash;</span>
<a href="#l1.891"></a><span id="l1.891">   nsIMsgFolder *curFolder = m_folders.SafeObjectAt(0);</span>
<a href="#l1.892"></a><span id="l1.892" class="difflineminus">-  if (curFolder)</span>
<a href="#l1.893"></a><span id="l1.893" class="difflineminus">-    GetImapDeleteModel(curFolder);</span>
<a href="#l1.894"></a><span id="l1.894" class="difflineplus">+  if (curFolder) GetImapDeleteModel(curFolder);</span>
<a href="#l1.895"></a><span id="l1.895"> </span>
<a href="#l1.896"></a><span id="l1.896">   return NS_OK;</span>
<a href="#l1.897"></a><span id="l1.897"> }</span>
<a href="#l1.898"></a><span id="l1.898"> </span>
<a href="#l1.899"></a><span id="l1.899"> // For now also acts as a way of resetting the search datasource.</span>
<a href="#l1.900"></a><span id="l1.900"> NS_IMETHODIMP</span>
<a href="#l1.901"></a><span id="l1.901" class="difflineminus">-nsMsgSearchDBView::OnNewSearch()</span>
<a href="#l1.902"></a><span id="l1.902" class="difflineminus">-{</span>
<a href="#l1.903"></a><span id="l1.903" class="difflineplus">+nsMsgSearchDBView::OnNewSearch() {</span>
<a href="#l1.904"></a><span id="l1.904">   int32_t oldSize = GetSize();</span>
<a href="#l1.905"></a><span id="l1.905"> </span>
<a href="#l1.906"></a><span id="l1.906">   int32_t count = m_dbToUseList.Count();</span>
<a href="#l1.907"></a><span id="l1.907" class="difflineminus">-  for(int32_t j = 0; j &lt; count; j++)</span>
<a href="#l1.908"></a><span id="l1.908" class="difflineminus">-    m_dbToUseList[j]-&gt;RemoveListener(this);</span>
<a href="#l1.909"></a><span id="l1.909" class="difflineplus">+  for (int32_t j = 0; j &lt; count; j++) m_dbToUseList[j]-&gt;RemoveListener(this);</span>
<a href="#l1.910"></a><span id="l1.910"> </span>
<a href="#l1.911"></a><span id="l1.911">   m_dbToUseList.Clear();</span>
<a href="#l1.912"></a><span id="l1.912">   m_folders.Clear();</span>
<a href="#l1.913"></a><span id="l1.913">   m_keys.Clear();</span>
<a href="#l1.914"></a><span id="l1.914">   m_levels.Clear();</span>
<a href="#l1.915"></a><span id="l1.915">   m_flags.Clear();</span>
<a href="#l1.916"></a><span id="l1.916">   m_totalMessagesInView = 0;</span>
<a href="#l1.917"></a><span id="l1.917"> </span>
<a href="#l1.918"></a><span id="l1.918">   // Needs to happen after we remove the keys, since RowCountChanged() will</span>
<a href="#l1.919"></a><span id="l1.919">   // call our GetRowCount().</span>
<a href="#l1.920"></a><span id="l1.920" class="difflineminus">-  if (mTree)</span>
<a href="#l1.921"></a><span id="l1.921" class="difflineminus">-    mTree-&gt;RowCountChanged(0, -oldSize);</span>
<a href="#l1.922"></a><span id="l1.922" class="difflineplus">+  if (mTree) mTree-&gt;RowCountChanged(0, -oldSize);</span>
<a href="#l1.923"></a><span id="l1.923"> </span>
<a href="#l1.924"></a><span id="l1.924" class="difflineminus">-//    mSearchResults-&gt;Clear();</span>
<a href="#l1.925"></a><span id="l1.925" class="difflineminus">-    return NS_OK;</span>
<a href="#l1.926"></a><span id="l1.926" class="difflineplus">+  // mSearchResults-&gt;Clear();</span>
<a href="#l1.927"></a><span id="l1.927" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.928"></a><span id="l1.928"> }</span>
<a href="#l1.929"></a><span id="l1.929"> </span>
<a href="#l1.930"></a><span id="l1.930" class="difflineminus">-NS_IMETHODIMP nsMsgSearchDBView::GetViewType(nsMsgViewTypeValue *aViewType)</span>
<a href="#l1.931"></a><span id="l1.931" class="difflineminus">-{</span>
<a href="#l1.932"></a><span id="l1.932" class="difflineplus">+NS_IMETHODIMP nsMsgSearchDBView::GetViewType(nsMsgViewTypeValue *aViewType) {</span>
<a href="#l1.933"></a><span id="l1.933">   NS_ENSURE_ARG_POINTER(aViewType);</span>
<a href="#l1.934"></a><span id="l1.934">   *aViewType = nsMsgViewType::eShowSearch;</span>
<a href="#l1.935"></a><span id="l1.935">   return NS_OK;</span>
<a href="#l1.936"></a><span id="l1.936"> }</span>
<a href="#l1.937"></a><span id="l1.937"> </span>
<a href="#l1.938"></a><span id="l1.938"> NS_IMETHODIMP</span>
<a href="#l1.939"></a><span id="l1.939" class="difflineminus">-nsMsgSearchDBView::SetSearchSession(nsIMsgSearchSession *aSession)</span>
<a href="#l1.940"></a><span id="l1.940" class="difflineminus">-{</span>
<a href="#l1.941"></a><span id="l1.941" class="difflineplus">+nsMsgSearchDBView::SetSearchSession(nsIMsgSearchSession *aSession) {</span>
<a href="#l1.942"></a><span id="l1.942">   m_searchSession = do_GetWeakReference(aSession);</span>
<a href="#l1.943"></a><span id="l1.943">   return NS_OK;</span>
<a href="#l1.944"></a><span id="l1.944"> }</span>
<a href="#l1.945"></a><span id="l1.945"> </span>
<a href="#l1.946"></a><span id="l1.946" class="difflineminus">-NS_IMETHODIMP nsMsgSearchDBView::OnAnnouncerGoingAway(nsIDBChangeAnnouncer *instigator)</span>
<a href="#l1.947"></a><span id="l1.947" class="difflineminus">-{</span>
<a href="#l1.948"></a><span id="l1.948" class="difflineplus">+NS_IMETHODIMP nsMsgSearchDBView::OnAnnouncerGoingAway(</span>
<a href="#l1.949"></a><span id="l1.949" class="difflineplus">+    nsIDBChangeAnnouncer *instigator) {</span>
<a href="#l1.950"></a><span id="l1.950">   nsIMsgDatabase *db = static_cast&lt;nsIMsgDatabase *&gt;(instigator);</span>
<a href="#l1.951"></a><span id="l1.951" class="difflineminus">-  if (db)</span>
<a href="#l1.952"></a><span id="l1.952" class="difflineminus">-  {</span>
<a href="#l1.953"></a><span id="l1.953" class="difflineplus">+  if (db) {</span>
<a href="#l1.954"></a><span id="l1.954">     db-&gt;RemoveListener(this);</span>
<a href="#l1.955"></a><span id="l1.955">     m_dbToUseList.RemoveObject(db);</span>
<a href="#l1.956"></a><span id="l1.956">   }</span>
<a href="#l1.957"></a><span id="l1.957"> </span>
<a href="#l1.958"></a><span id="l1.958">   return NS_OK;</span>
<a href="#l1.959"></a><span id="l1.959"> }</span>
<a href="#l1.960"></a><span id="l1.960"> </span>
<a href="#l1.961"></a><span id="l1.961" class="difflineminus">-nsCOMArray&lt;nsIMsgFolder&gt;* nsMsgSearchDBView::GetFolders()</span>
<a href="#l1.962"></a><span id="l1.962" class="difflineminus">-{</span>
<a href="#l1.963"></a><span id="l1.963" class="difflineminus">-  return &amp;m_folders;</span>
<a href="#l1.964"></a><span id="l1.964" class="difflineminus">-}</span>
<a href="#l1.965"></a><span id="l1.965" class="difflineplus">+nsCOMArray&lt;nsIMsgFolder&gt; *nsMsgSearchDBView::GetFolders() { return &amp;m_folders; }</span>
<a href="#l1.966"></a><span id="l1.966"> </span>
<a href="#l1.967"></a><span id="l1.967"> NS_IMETHODIMP</span>
<a href="#l1.968"></a><span id="l1.968" class="difflineminus">-nsMsgSearchDBView::GetCommandStatus(nsMsgViewCommandTypeValue command,</span>
<a href="#l1.969"></a><span id="l1.969" class="difflineminus">-                                    bool *selectable_p,</span>
<a href="#l1.970"></a><span id="l1.970" class="difflineminus">-                                    nsMsgViewCommandCheckStateValue *selected_p)</span>
<a href="#l1.971"></a><span id="l1.971" class="difflineminus">-{</span>
<a href="#l1.972"></a><span id="l1.972" class="difflineplus">+nsMsgSearchDBView::GetCommandStatus(</span>
<a href="#l1.973"></a><span id="l1.973" class="difflineplus">+    nsMsgViewCommandTypeValue command, bool *selectable_p,</span>
<a href="#l1.974"></a><span id="l1.974" class="difflineplus">+    nsMsgViewCommandCheckStateValue *selected_p) {</span>
<a href="#l1.975"></a><span id="l1.975">   if (command != nsMsgViewCommandType::runJunkControls)</span>
<a href="#l1.976"></a><span id="l1.976">     return nsMsgDBView::GetCommandStatus(command, selectable_p, selected_p);</span>
<a href="#l1.977"></a><span id="l1.977"> </span>
<a href="#l1.978"></a><span id="l1.978">   *selectable_p = false;</span>
<a href="#l1.979"></a><span id="l1.979">   return NS_OK;</span>
<a href="#l1.980"></a><span id="l1.980"> }</span>
<a href="#l1.981"></a><span id="l1.981"> </span>
<a href="#l1.982"></a><span id="l1.982"> NS_IMETHODIMP</span>
<a href="#l1.983"></a><span id="l1.983"> nsMsgSearchDBView::DoCommandWithFolder(nsMsgViewCommandTypeValue command,</span>
<a href="#l1.984"></a><span id="l1.984" class="difflineminus">-                                       nsIMsgFolder *destFolder)</span>
<a href="#l1.985"></a><span id="l1.985" class="difflineminus">-{</span>
<a href="#l1.986"></a><span id="l1.986" class="difflineplus">+                                       nsIMsgFolder *destFolder) {</span>
<a href="#l1.987"></a><span id="l1.987">   mCommand = command;</span>
<a href="#l1.988"></a><span id="l1.988">   mDestFolder = destFolder;</span>
<a href="#l1.989"></a><span id="l1.989">   return nsMsgDBView::DoCommandWithFolder(command, destFolder);</span>
<a href="#l1.990"></a><span id="l1.990"> }</span>
<a href="#l1.991"></a><span id="l1.991"> </span>
<a href="#l1.992"></a><span id="l1.992" class="difflineminus">-NS_IMETHODIMP nsMsgSearchDBView::DoCommand(nsMsgViewCommandTypeValue command)</span>
<a href="#l1.993"></a><span id="l1.993" class="difflineminus">-{</span>
<a href="#l1.994"></a><span id="l1.994" class="difflineplus">+NS_IMETHODIMP nsMsgSearchDBView::DoCommand(nsMsgViewCommandTypeValue command) {</span>
<a href="#l1.995"></a><span id="l1.995">   mCommand = command;</span>
<a href="#l1.996"></a><span id="l1.996">   if (command == nsMsgViewCommandType::deleteMsg ||</span>
<a href="#l1.997"></a><span id="l1.997">       command == nsMsgViewCommandType::deleteNoTrash ||</span>
<a href="#l1.998"></a><span id="l1.998">       command == nsMsgViewCommandType::selectAll ||</span>
<a href="#l1.999"></a><span id="l1.999">       command == nsMsgViewCommandType::selectThread ||</span>
<a href="#l1.1000"></a><span id="l1.1000">       command == nsMsgViewCommandType::selectFlagged ||</span>
<a href="#l1.1001"></a><span id="l1.1001">       command == nsMsgViewCommandType::expandAll ||</span>
<a href="#l1.1002"></a><span id="l1.1002">       command == nsMsgViewCommandType::collapseAll)</span>
<a href="#l1.1003"></a><span id="l1.1003" class="difflineat">@@ -851,709 +747,602 @@ NS_IMETHODIMP nsMsgSearchDBView::DoComma</span>
<a href="#l1.1004"></a><span id="l1.1004">   // We need to break apart the selection by folders, and then call</span>
<a href="#l1.1005"></a><span id="l1.1005">   // ApplyCommandToIndices with the command and the indices in the</span>
<a href="#l1.1006"></a><span id="l1.1006">   // selection that are from that folder.</span>
<a href="#l1.1007"></a><span id="l1.1007"> </span>
<a href="#l1.1008"></a><span id="l1.1008">   mozilla::UniquePtr&lt;nsTArray&lt;uint32_t&gt;[]&gt; indexArrays;</span>
<a href="#l1.1009"></a><span id="l1.1009">   int32_t numArrays;</span>
<a href="#l1.1010"></a><span id="l1.1010">   rv = PartitionSelectionByFolder(indices, numIndices, indexArrays, &amp;numArrays);</span>
<a href="#l1.1011"></a><span id="l1.1011">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.1012"></a><span id="l1.1012" class="difflineminus">-  for (int32_t folderIndex = 0; folderIndex &lt; numArrays; folderIndex++)</span>
<a href="#l1.1013"></a><span id="l1.1013" class="difflineminus">-  {</span>
<a href="#l1.1014"></a><span id="l1.1014" class="difflineminus">-    rv = ApplyCommandToIndices(command, (indexArrays.get())[folderIndex].Elements(), indexArrays[folderIndex].Length());</span>
<a href="#l1.1015"></a><span id="l1.1015" class="difflineplus">+  for (int32_t folderIndex = 0; folderIndex &lt; numArrays; folderIndex++) {</span>
<a href="#l1.1016"></a><span id="l1.1016" class="difflineplus">+    rv = ApplyCommandToIndices(command,</span>
<a href="#l1.1017"></a><span id="l1.1017" class="difflineplus">+                               (indexArrays.get())[folderIndex].Elements(),</span>
<a href="#l1.1018"></a><span id="l1.1018" class="difflineplus">+                               indexArrays[folderIndex].Length());</span>
<a href="#l1.1019"></a><span id="l1.1019">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.1020"></a><span id="l1.1020">   }</span>
<a href="#l1.1021"></a><span id="l1.1021"> </span>
<a href="#l1.1022"></a><span id="l1.1022">   return rv;</span>
<a href="#l1.1023"></a><span id="l1.1023"> }</span>
<a href="#l1.1024"></a><span id="l1.1024"> </span>
<a href="#l1.1025"></a><span id="l1.1025"> // This method removes the specified line from the view, and adjusts the</span>
<a href="#l1.1026"></a><span id="l1.1026"> // various flags and levels of affected messages.</span>
<a href="#l1.1027"></a><span id="l1.1027" class="difflineminus">-nsresult nsMsgSearchDBView::RemoveByIndex(nsMsgViewIndex index)</span>
<a href="#l1.1028"></a><span id="l1.1028" class="difflineminus">-{</span>
<a href="#l1.1029"></a><span id="l1.1029" class="difflineminus">-  if (!IsValidIndex(index))</span>
<a href="#l1.1030"></a><span id="l1.1030" class="difflineminus">-    return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.1031"></a><span id="l1.1031" class="difflineplus">+nsresult nsMsgSearchDBView::RemoveByIndex(nsMsgViewIndex index) {</span>
<a href="#l1.1032"></a><span id="l1.1032" class="difflineplus">+  if (!IsValidIndex(index)) return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.1033"></a><span id="l1.1033"> </span>
<a href="#l1.1034"></a><span id="l1.1034" class="difflineminus">-  if (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay)</span>
<a href="#l1.1035"></a><span id="l1.1035" class="difflineminus">-  {</span>
<a href="#l1.1036"></a><span id="l1.1036" class="difflineplus">+  if (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay) {</span>
<a href="#l1.1037"></a><span id="l1.1037">     nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.1038"></a><span id="l1.1038">     nsCOMPtr&lt;nsIMsgThread&gt; thread;</span>
<a href="#l1.1039"></a><span id="l1.1039">     nsresult rv = GetMsgHdrForViewIndex(index, getter_AddRefs(msgHdr));</span>
<a href="#l1.1040"></a><span id="l1.1040">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.1041"></a><span id="l1.1041"> </span>
<a href="#l1.1042"></a><span id="l1.1042">     GetXFThreadFromMsgHdr(msgHdr, getter_AddRefs(thread));</span>
<a href="#l1.1043"></a><span id="l1.1043" class="difflineminus">-    if (thread)</span>
<a href="#l1.1044"></a><span id="l1.1044" class="difflineminus">-    {</span>
<a href="#l1.1045"></a><span id="l1.1045" class="difflineminus">-      nsMsgXFViewThread *viewThread = static_cast&lt;nsMsgXFViewThread*&gt;(thread.get());</span>
<a href="#l1.1046"></a><span id="l1.1046" class="difflineminus">-      if (viewThread-&gt;MsgCount() == 2)</span>
<a href="#l1.1047"></a><span id="l1.1047" class="difflineminus">-      {</span>
<a href="#l1.1048"></a><span id="l1.1048" class="difflineplus">+    if (thread) {</span>
<a href="#l1.1049"></a><span id="l1.1049" class="difflineplus">+      nsMsgXFViewThread *viewThread =</span>
<a href="#l1.1050"></a><span id="l1.1050" class="difflineplus">+          static_cast&lt;nsMsgXFViewThread *&gt;(thread.get());</span>
<a href="#l1.1051"></a><span id="l1.1051" class="difflineplus">+      if (viewThread-&gt;MsgCount() == 2) {</span>
<a href="#l1.1052"></a><span id="l1.1052">         // If we removed the next to last message in the thread,</span>
<a href="#l1.1053"></a><span id="l1.1053">         // we need to adjust the flags on the first message in the thread.</span>
<a href="#l1.1054"></a><span id="l1.1054" class="difflineminus">-        nsMsgViewIndex threadIndex = m_levels[index] ? index -1 : index;</span>
<a href="#l1.1055"></a><span id="l1.1055" class="difflineminus">-        if (threadIndex != nsMsgViewIndex_None)</span>
<a href="#l1.1056"></a><span id="l1.1056" class="difflineminus">-        {</span>
<a href="#l1.1057"></a><span id="l1.1057" class="difflineminus">-          AndExtraFlag(threadIndex, ~(MSG_VIEW_FLAG_ISTHREAD |</span>
<a href="#l1.1058"></a><span id="l1.1058" class="difflineminus">-                                      nsMsgMessageFlags::Elided |</span>
<a href="#l1.1059"></a><span id="l1.1059" class="difflineminus">-                                      MSG_VIEW_FLAG_HASCHILDREN));</span>
<a href="#l1.1060"></a><span id="l1.1060" class="difflineplus">+        nsMsgViewIndex threadIndex = m_levels[index] ? index - 1 : index;</span>
<a href="#l1.1061"></a><span id="l1.1061" class="difflineplus">+        if (threadIndex != nsMsgViewIndex_None) {</span>
<a href="#l1.1062"></a><span id="l1.1062" class="difflineplus">+          AndExtraFlag(threadIndex,</span>
<a href="#l1.1063"></a><span id="l1.1063" class="difflineplus">+                       ~(MSG_VIEW_FLAG_ISTHREAD | nsMsgMessageFlags::Elided |</span>
<a href="#l1.1064"></a><span id="l1.1064" class="difflineplus">+                         MSG_VIEW_FLAG_HASCHILDREN));</span>
<a href="#l1.1065"></a><span id="l1.1065">           m_levels[threadIndex] = 0;</span>
<a href="#l1.1066"></a><span id="l1.1066">           NoteChange(threadIndex, 1, nsMsgViewNotificationCode::changed);</span>
<a href="#l1.1067"></a><span id="l1.1067">         }</span>
<a href="#l1.1068"></a><span id="l1.1068">       }</span>
<a href="#l1.1069"></a><span id="l1.1069"> </span>
<a href="#l1.1070"></a><span id="l1.1070">       // Bump up the level of all the descendents of the message</span>
<a href="#l1.1071"></a><span id="l1.1071">       // that was removed, if the thread was expanded.</span>
<a href="#l1.1072"></a><span id="l1.1072">       uint8_t removedLevel = m_levels[index];</span>
<a href="#l1.1073"></a><span id="l1.1073">       nsMsgViewIndex i = index + 1;</span>
<a href="#l1.1074"></a><span id="l1.1074" class="difflineminus">-      if (i &lt; m_levels.Length() &amp;&amp; m_levels[i] &gt; removedLevel)</span>
<a href="#l1.1075"></a><span id="l1.1075" class="difflineminus">-      {</span>
<a href="#l1.1076"></a><span id="l1.1076" class="difflineplus">+      if (i &lt; m_levels.Length() &amp;&amp; m_levels[i] &gt; removedLevel) {</span>
<a href="#l1.1077"></a><span id="l1.1077">         // Promote the child of the removed message.</span>
<a href="#l1.1078"></a><span id="l1.1078">         uint8_t promotedLevel = m_levels[i];</span>
<a href="#l1.1079"></a><span id="l1.1079">         m_levels[i] = promotedLevel - 1;</span>
<a href="#l1.1080"></a><span id="l1.1080">         i++;</span>
<a href="#l1.1081"></a><span id="l1.1081">         // Now promote all the children of the promoted message.</span>
<a href="#l1.1082"></a><span id="l1.1082">         for (; i &lt; m_levels.Length() &amp;&amp; m_levels[i] &gt; promotedLevel; i++)</span>
<a href="#l1.1083"></a><span id="l1.1083">           m_levels[i] = m_levels[i] - 1;</span>
<a href="#l1.1084"></a><span id="l1.1084">       }</span>
<a href="#l1.1085"></a><span id="l1.1085">     }</span>
<a href="#l1.1086"></a><span id="l1.1086">   }</span>
<a href="#l1.1087"></a><span id="l1.1087"> </span>
<a href="#l1.1088"></a><span id="l1.1088">   m_folders.RemoveObjectAt(index);</span>
<a href="#l1.1089"></a><span id="l1.1089">   return nsMsgDBView::RemoveByIndex(index);</span>
<a href="#l1.1090"></a><span id="l1.1090"> }</span>
<a href="#l1.1091"></a><span id="l1.1091"> </span>
<a href="#l1.1092"></a><span id="l1.1092" class="difflineminus">-nsresult</span>
<a href="#l1.1093"></a><span id="l1.1093" class="difflineminus">-nsMsgSearchDBView::DeleteMessages(nsIMsgWindow *window,</span>
<a href="#l1.1094"></a><span id="l1.1094" class="difflineminus">-                                  nsMsgViewIndex *indices,</span>
<a href="#l1.1095"></a><span id="l1.1095" class="difflineminus">-                                  int32_t numIndices,</span>
<a href="#l1.1096"></a><span id="l1.1096" class="difflineminus">-                                  bool deleteStorage)</span>
<a href="#l1.1097"></a><span id="l1.1097" class="difflineminus">-{</span>
<a href="#l1.1098"></a><span id="l1.1098" class="difflineminus">-   nsresult rv = GetFoldersAndHdrsForSelection(indices, numIndices);</span>
<a href="#l1.1099"></a><span id="l1.1099" class="difflineminus">-   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.1100"></a><span id="l1.1100" class="difflineminus">-   if (mDeleteModel != nsMsgImapDeleteModels::MoveToTrash)</span>
<a href="#l1.1101"></a><span id="l1.1101" class="difflineminus">-     deleteStorage = true;</span>
<a href="#l1.1102"></a><span id="l1.1102" class="difflineplus">+nsresult nsMsgSearchDBView::DeleteMessages(nsIMsgWindow *window,</span>
<a href="#l1.1103"></a><span id="l1.1103" class="difflineplus">+                                           nsMsgViewIndex *indices,</span>
<a href="#l1.1104"></a><span id="l1.1104" class="difflineplus">+                                           int32_t numIndices,</span>
<a href="#l1.1105"></a><span id="l1.1105" class="difflineplus">+                                           bool deleteStorage) {</span>
<a href="#l1.1106"></a><span id="l1.1106" class="difflineplus">+  nsresult rv = GetFoldersAndHdrsForSelection(indices, numIndices);</span>
<a href="#l1.1107"></a><span id="l1.1107" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.1108"></a><span id="l1.1108" class="difflineplus">+  if (mDeleteModel != nsMsgImapDeleteModels::MoveToTrash) deleteStorage = true;</span>
<a href="#l1.1109"></a><span id="l1.1109"> </span>
<a href="#l1.1110"></a><span id="l1.1110" class="difflineminus">-  if (mDeleteModel != nsMsgImapDeleteModels::IMAPDelete)</span>
<a href="#l1.1111"></a><span id="l1.1111" class="difflineminus">-    m_deletingRows = true;</span>
<a href="#l1.1112"></a><span id="l1.1112" class="difflineplus">+  if (mDeleteModel != nsMsgImapDeleteModels::IMAPDelete) m_deletingRows = true;</span>
<a href="#l1.1113"></a><span id="l1.1113"> </span>
<a href="#l1.1114"></a><span id="l1.1114">   // Remember the deleted messages in case the user undoes the delete,</span>
<a href="#l1.1115"></a><span id="l1.1115">   // and we want to restore the hdr to the view, even if it no</span>
<a href="#l1.1116"></a><span id="l1.1116">   // longer matches the search criteria.</span>
<a href="#l1.1117"></a><span id="l1.1117" class="difflineminus">-  for (nsMsgViewIndex i = 0; i &lt; (nsMsgViewIndex) numIndices; i++)</span>
<a href="#l1.1118"></a><span id="l1.1118" class="difflineminus">-  {</span>
<a href="#l1.1119"></a><span id="l1.1119" class="difflineplus">+  for (nsMsgViewIndex i = 0; i &lt; (nsMsgViewIndex)numIndices; i++) {</span>
<a href="#l1.1120"></a><span id="l1.1120">     nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.1121"></a><span id="l1.1121" class="difflineminus">-    (void) GetMsgHdrForViewIndex(indices[i], getter_AddRefs(msgHdr));</span>
<a href="#l1.1122"></a><span id="l1.1122" class="difflineminus">-    if (msgHdr)</span>
<a href="#l1.1123"></a><span id="l1.1123" class="difflineminus">-      RememberDeletedMsgHdr(msgHdr);</span>
<a href="#l1.1124"></a><span id="l1.1124" class="difflineplus">+    (void)GetMsgHdrForViewIndex(indices[i], getter_AddRefs(msgHdr));</span>
<a href="#l1.1125"></a><span id="l1.1125" class="difflineplus">+    if (msgHdr) RememberDeletedMsgHdr(msgHdr);</span>
<a href="#l1.1126"></a><span id="l1.1126"> </span>
<a href="#l1.1127"></a><span id="l1.1127">     // If we are deleting rows, save off the view indices.</span>
<a href="#l1.1128"></a><span id="l1.1128" class="difflineminus">-    if (m_deletingRows)</span>
<a href="#l1.1129"></a><span id="l1.1129" class="difflineminus">-      mIndicesToNoteChange.AppendElement(indices[i]);</span>
<a href="#l1.1130"></a><span id="l1.1130" class="difflineminus">-</span>
<a href="#l1.1131"></a><span id="l1.1131" class="difflineplus">+    if (m_deletingRows) mIndicesToNoteChange.AppendElement(indices[i]);</span>
<a href="#l1.1132"></a><span id="l1.1132">   }</span>
<a href="#l1.1133"></a><span id="l1.1133">   rv = deleteStorage ? ProcessRequestsInAllFolders(window)</span>
<a href="#l1.1134"></a><span id="l1.1134">                      : ProcessRequestsInOneFolder(window);</span>
<a href="#l1.1135"></a><span id="l1.1135" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l1.1136"></a><span id="l1.1136" class="difflineminus">-    m_deletingRows = false;</span>
<a href="#l1.1137"></a><span id="l1.1137" class="difflineplus">+  if (NS_FAILED(rv)) m_deletingRows = false;</span>
<a href="#l1.1138"></a><span id="l1.1138"> </span>
<a href="#l1.1139"></a><span id="l1.1139">   return rv;</span>
<a href="#l1.1140"></a><span id="l1.1140"> }</span>
<a href="#l1.1141"></a><span id="l1.1141"> </span>
<a href="#l1.1142"></a><span id="l1.1142" class="difflineminus">-nsresult</span>
<a href="#l1.1143"></a><span id="l1.1143" class="difflineminus">-nsMsgSearchDBView::CopyMessages(nsIMsgWindow *window,</span>
<a href="#l1.1144"></a><span id="l1.1144" class="difflineminus">-                                nsMsgViewIndex *indices,</span>
<a href="#l1.1145"></a><span id="l1.1145" class="difflineminus">-                                int32_t numIndices,</span>
<a href="#l1.1146"></a><span id="l1.1146" class="difflineminus">-                                bool isMove,</span>
<a href="#l1.1147"></a><span id="l1.1147" class="difflineminus">-                                nsIMsgFolder *destFolder)</span>
<a href="#l1.1148"></a><span id="l1.1148" class="difflineminus">-{</span>
<a href="#l1.1149"></a><span id="l1.1149" class="difflineplus">+nsresult nsMsgSearchDBView::CopyMessages(nsIMsgWindow *window,</span>
<a href="#l1.1150"></a><span id="l1.1150" class="difflineplus">+                                         nsMsgViewIndex *indices,</span>
<a href="#l1.1151"></a><span id="l1.1151" class="difflineplus">+                                         int32_t numIndices, bool isMove,</span>
<a href="#l1.1152"></a><span id="l1.1152" class="difflineplus">+                                         nsIMsgFolder *destFolder) {</span>
<a href="#l1.1153"></a><span id="l1.1153">   GetFoldersAndHdrsForSelection(indices, numIndices);</span>
<a href="#l1.1154"></a><span id="l1.1154">   return ProcessRequestsInOneFolder(window);</span>
<a href="#l1.1155"></a><span id="l1.1155"> }</span>
<a href="#l1.1156"></a><span id="l1.1156"> </span>
<a href="#l1.1157"></a><span id="l1.1157" class="difflineminus">-nsresult</span>
<a href="#l1.1158"></a><span id="l1.1158" class="difflineminus">-nsMsgSearchDBView::PartitionSelectionByFolder(nsMsgViewIndex *indices,</span>
<a href="#l1.1159"></a><span id="l1.1159" class="difflineminus">-                                              int32_t numIndices,</span>
<a href="#l1.1160"></a><span id="l1.1160" class="difflineminus">-                                              mozilla::UniquePtr&lt;nsTArray&lt;uint32_t&gt;[]&gt; &amp;indexArrays,</span>
<a href="#l1.1161"></a><span id="l1.1161" class="difflineminus">-                                              int32_t *numArrays)</span>
<a href="#l1.1162"></a><span id="l1.1162" class="difflineminus">-{</span>
<a href="#l1.1163"></a><span id="l1.1163" class="difflineplus">+nsresult nsMsgSearchDBView::PartitionSelectionByFolder(</span>
<a href="#l1.1164"></a><span id="l1.1164" class="difflineplus">+    nsMsgViewIndex *indices, int32_t numIndices,</span>
<a href="#l1.1165"></a><span id="l1.1165" class="difflineplus">+    mozilla::UniquePtr&lt;nsTArray&lt;uint32_t&gt;[]&gt; &amp;indexArrays, int32_t *numArrays) {</span>
<a href="#l1.1166"></a><span id="l1.1166">   nsMsgViewIndex i;</span>
<a href="#l1.1167"></a><span id="l1.1167">   int32_t folderIndex;</span>
<a href="#l1.1168"></a><span id="l1.1168">   nsCOMArray&lt;nsIMsgFolder&gt; uniqueFoldersSelected;</span>
<a href="#l1.1169"></a><span id="l1.1169">   nsTArray&lt;uint32_t&gt; numIndicesSelected;</span>
<a href="#l1.1170"></a><span id="l1.1170">   mCurIndex = 0;</span>
<a href="#l1.1171"></a><span id="l1.1171"> </span>
<a href="#l1.1172"></a><span id="l1.1172">   // Build unique folder list based on headers selected by the user.</span>
<a href="#l1.1173"></a><span id="l1.1173" class="difflineminus">-  for (i = 0; i &lt; (nsMsgViewIndex) numIndices; i++)</span>
<a href="#l1.1174"></a><span id="l1.1174" class="difflineminus">-  {</span>
<a href="#l1.1175"></a><span id="l1.1175" class="difflineplus">+  for (i = 0; i &lt; (nsMsgViewIndex)numIndices; i++) {</span>
<a href="#l1.1176"></a><span id="l1.1176">     nsIMsgFolder *curFolder = m_folders[indices[i]];</span>
<a href="#l1.1177"></a><span id="l1.1177">     folderIndex = uniqueFoldersSelected.IndexOf(curFolder);</span>
<a href="#l1.1178"></a><span id="l1.1178" class="difflineminus">-    if (folderIndex &lt; 0)</span>
<a href="#l1.1179"></a><span id="l1.1179" class="difflineminus">-    {</span>
<a href="#l1.1180"></a><span id="l1.1180" class="difflineplus">+    if (folderIndex &lt; 0) {</span>
<a href="#l1.1181"></a><span id="l1.1181">       uniqueFoldersSelected.AppendObject(curFolder);</span>
<a href="#l1.1182"></a><span id="l1.1182">       numIndicesSelected.AppendElement(1);</span>
<a href="#l1.1183"></a><span id="l1.1183" class="difflineminus">-    }</span>
<a href="#l1.1184"></a><span id="l1.1184" class="difflineminus">-    else</span>
<a href="#l1.1185"></a><span id="l1.1185" class="difflineminus">-    {</span>
<a href="#l1.1186"></a><span id="l1.1186" class="difflineplus">+    } else {</span>
<a href="#l1.1187"></a><span id="l1.1187">       numIndicesSelected[folderIndex]++;</span>
<a href="#l1.1188"></a><span id="l1.1188">     }</span>
<a href="#l1.1189"></a><span id="l1.1189">   }</span>
<a href="#l1.1190"></a><span id="l1.1190"> </span>
<a href="#l1.1191"></a><span id="l1.1191">   int32_t numFolders = uniqueFoldersSelected.Count();</span>
<a href="#l1.1192"></a><span id="l1.1192">   indexArrays = mozilla::MakeUnique&lt;nsTArray&lt;uint32_t&gt;[]&gt;(numFolders);</span>
<a href="#l1.1193"></a><span id="l1.1193">   *numArrays = numFolders;</span>
<a href="#l1.1194"></a><span id="l1.1194">   NS_ENSURE_TRUE(indexArrays, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l1.1195"></a><span id="l1.1195" class="difflineminus">-  for (folderIndex = 0; folderIndex &lt; numFolders; folderIndex++)</span>
<a href="#l1.1196"></a><span id="l1.1196" class="difflineminus">-  {</span>
<a href="#l1.1197"></a><span id="l1.1197" class="difflineminus">-    (indexArrays.get())[folderIndex].SetCapacity(numIndicesSelected[folderIndex]);</span>
<a href="#l1.1198"></a><span id="l1.1198" class="difflineplus">+  for (folderIndex = 0; folderIndex &lt; numFolders; folderIndex++) {</span>
<a href="#l1.1199"></a><span id="l1.1199" class="difflineplus">+    (indexArrays.get())[folderIndex].SetCapacity(</span>
<a href="#l1.1200"></a><span id="l1.1200" class="difflineplus">+        numIndicesSelected[folderIndex]);</span>
<a href="#l1.1201"></a><span id="l1.1201">   }</span>
<a href="#l1.1202"></a><span id="l1.1202" class="difflineminus">-  for (i = 0; i &lt; (nsMsgViewIndex) numIndices; i++)</span>
<a href="#l1.1203"></a><span id="l1.1203" class="difflineminus">-  {</span>
<a href="#l1.1204"></a><span id="l1.1204" class="difflineplus">+  for (i = 0; i &lt; (nsMsgViewIndex)numIndices; i++) {</span>
<a href="#l1.1205"></a><span id="l1.1205">     nsIMsgFolder *curFolder = m_folders[indices[i]];</span>
<a href="#l1.1206"></a><span id="l1.1206">     int32_t folderIndex = uniqueFoldersSelected.IndexOf(curFolder);</span>
<a href="#l1.1207"></a><span id="l1.1207">     (indexArrays.get())[folderIndex].AppendElement(indices[i]);</span>
<a href="#l1.1208"></a><span id="l1.1208">   }</span>
<a href="#l1.1209"></a><span id="l1.1209">   return NS_OK;</span>
<a href="#l1.1210"></a><span id="l1.1210"> }</span>
<a href="#l1.1211"></a><span id="l1.1211"> </span>
<a href="#l1.1212"></a><span id="l1.1212" class="difflineminus">-nsresult</span>
<a href="#l1.1213"></a><span id="l1.1213" class="difflineminus">-nsMsgSearchDBView::GetFoldersAndHdrsForSelection(nsMsgViewIndex *indices,</span>
<a href="#l1.1214"></a><span id="l1.1214" class="difflineminus">-                                                 int32_t numIndices)</span>
<a href="#l1.1215"></a><span id="l1.1215" class="difflineminus">-{</span>
<a href="#l1.1216"></a><span id="l1.1216" class="difflineplus">+nsresult nsMsgSearchDBView::GetFoldersAndHdrsForSelection(</span>
<a href="#l1.1217"></a><span id="l1.1217" class="difflineplus">+    nsMsgViewIndex *indices, int32_t numIndices) {</span>
<a href="#l1.1218"></a><span id="l1.1218">   nsresult rv = NS_OK;</span>
<a href="#l1.1219"></a><span id="l1.1219">   mCurIndex = 0;</span>
<a href="#l1.1220"></a><span id="l1.1220">   m_uniqueFoldersSelected.Clear();</span>
<a href="#l1.1221"></a><span id="l1.1221">   m_hdrsForEachFolder.Clear();</span>
<a href="#l1.1222"></a><span id="l1.1222"> </span>
<a href="#l1.1223"></a><span id="l1.1223" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; messages(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l1.1224"></a><span id="l1.1224" class="difflineplus">+  nsCOMPtr&lt;nsIMutableArray&gt; messages(</span>
<a href="#l1.1225"></a><span id="l1.1225" class="difflineplus">+      do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l1.1226"></a><span id="l1.1226">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.1227"></a><span id="l1.1227">   rv = GetHeadersFromSelection(indices, numIndices, messages);</span>
<a href="#l1.1228"></a><span id="l1.1228">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.1229"></a><span id="l1.1229">   uint32_t numMsgs;</span>
<a href="#l1.1230"></a><span id="l1.1230">   messages-&gt;GetLength(&amp;numMsgs);</span>
<a href="#l1.1231"></a><span id="l1.1231"> </span>
<a href="#l1.1232"></a><span id="l1.1232">   uint32_t i;</span>
<a href="#l1.1233"></a><span id="l1.1233">   // Build unique folder list based on headers selected by the user.</span>
<a href="#l1.1234"></a><span id="l1.1234" class="difflineminus">-  for (i = 0; i &lt; numMsgs; i++)</span>
<a href="#l1.1235"></a><span id="l1.1235" class="difflineminus">-  {</span>
<a href="#l1.1236"></a><span id="l1.1236" class="difflineplus">+  for (i = 0; i &lt; numMsgs; i++) {</span>
<a href="#l1.1237"></a><span id="l1.1237">     nsCOMPtr&lt;nsIMsgDBHdr&gt; hdr = do_QueryElementAt(messages, i, &amp;rv);</span>
<a href="#l1.1238"></a><span id="l1.1238" class="difflineminus">-    if (hdr)</span>
<a href="#l1.1239"></a><span id="l1.1239" class="difflineminus">-    {</span>
<a href="#l1.1240"></a><span id="l1.1240" class="difflineplus">+    if (hdr) {</span>
<a href="#l1.1241"></a><span id="l1.1241">       nsCOMPtr&lt;nsIMsgFolder&gt; curFolder;</span>
<a href="#l1.1242"></a><span id="l1.1242">       hdr-&gt;GetFolder(getter_AddRefs(curFolder));</span>
<a href="#l1.1243"></a><span id="l1.1243">       if (m_uniqueFoldersSelected.IndexOf(curFolder) &lt; 0)</span>
<a href="#l1.1244"></a><span id="l1.1244">         m_uniqueFoldersSelected.AppendObject(curFolder);</span>
<a href="#l1.1245"></a><span id="l1.1245">     }</span>
<a href="#l1.1246"></a><span id="l1.1246">   }</span>
<a href="#l1.1247"></a><span id="l1.1247"> </span>
<a href="#l1.1248"></a><span id="l1.1248">   // Group the headers selected by each folder.</span>
<a href="#l1.1249"></a><span id="l1.1249">   uint32_t numFolders = m_uniqueFoldersSelected.Count();</span>
<a href="#l1.1250"></a><span id="l1.1250" class="difflineminus">-  for (uint32_t folderIndex = 0; folderIndex &lt; numFolders; folderIndex++)</span>
<a href="#l1.1251"></a><span id="l1.1251" class="difflineminus">-  {</span>
<a href="#l1.1252"></a><span id="l1.1252" class="difflineplus">+  for (uint32_t folderIndex = 0; folderIndex &lt; numFolders; folderIndex++) {</span>
<a href="#l1.1253"></a><span id="l1.1253">     nsIMsgFolder *curFolder = m_uniqueFoldersSelected[folderIndex];</span>
<a href="#l1.1254"></a><span id="l1.1254" class="difflineminus">-    nsCOMPtr&lt;nsIMutableArray&gt; msgHdrsForOneFolder(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l1.1255"></a><span id="l1.1255" class="difflineplus">+    nsCOMPtr&lt;nsIMutableArray&gt; msgHdrsForOneFolder(</span>
<a href="#l1.1256"></a><span id="l1.1256" class="difflineplus">+        do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l1.1257"></a><span id="l1.1257">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.1258"></a><span id="l1.1258" class="difflineminus">-    for (i = 0; i &lt; numMsgs; i++)</span>
<a href="#l1.1259"></a><span id="l1.1259" class="difflineminus">-    {</span>
<a href="#l1.1260"></a><span id="l1.1260" class="difflineplus">+    for (i = 0; i &lt; numMsgs; i++) {</span>
<a href="#l1.1261"></a><span id="l1.1261">       nsCOMPtr&lt;nsIMsgDBHdr&gt; hdr = do_QueryElementAt(messages, i, &amp;rv);</span>
<a href="#l1.1262"></a><span id="l1.1262" class="difflineminus">-      if (hdr)</span>
<a href="#l1.1263"></a><span id="l1.1263" class="difflineminus">-      {</span>
<a href="#l1.1264"></a><span id="l1.1264" class="difflineplus">+      if (hdr) {</span>
<a href="#l1.1265"></a><span id="l1.1265">         nsCOMPtr&lt;nsIMsgFolder&gt; msgFolder;</span>
<a href="#l1.1266"></a><span id="l1.1266">         hdr-&gt;GetFolder(getter_AddRefs(msgFolder));</span>
<a href="#l1.1267"></a><span id="l1.1267" class="difflineminus">-        if (NS_SUCCEEDED(rv) &amp;&amp; msgFolder &amp;&amp; msgFolder == curFolder)</span>
<a href="#l1.1268"></a><span id="l1.1268" class="difflineminus">-        {</span>
<a href="#l1.1269"></a><span id="l1.1269" class="difflineplus">+        if (NS_SUCCEEDED(rv) &amp;&amp; msgFolder &amp;&amp; msgFolder == curFolder) {</span>
<a href="#l1.1270"></a><span id="l1.1270">           nsCOMPtr&lt;nsISupports&gt; hdrSupports = do_QueryInterface(hdr);</span>
<a href="#l1.1271"></a><span id="l1.1271">           msgHdrsForOneFolder-&gt;AppendElement(hdrSupports);</span>
<a href="#l1.1272"></a><span id="l1.1272">         }</span>
<a href="#l1.1273"></a><span id="l1.1273">       }</span>
<a href="#l1.1274"></a><span id="l1.1274">     }</span>
<a href="#l1.1275"></a><span id="l1.1275"> </span>
<a href="#l1.1276"></a><span id="l1.1276">     m_hdrsForEachFolder.AppendElement(msgHdrsForOneFolder);</span>
<a href="#l1.1277"></a><span id="l1.1277">   }</span>
<a href="#l1.1278"></a><span id="l1.1278"> </span>
<a href="#l1.1279"></a><span id="l1.1279">   return rv;</span>
<a href="#l1.1280"></a><span id="l1.1280"> }</span>
<a href="#l1.1281"></a><span id="l1.1281"> </span>
<a href="#l1.1282"></a><span id="l1.1282" class="difflineminus">-nsresult</span>
<a href="#l1.1283"></a><span id="l1.1283" class="difflineminus">-nsMsgSearchDBView::ApplyCommandToIndicesWithFolder(nsMsgViewCommandTypeValue command,</span>
<a href="#l1.1284"></a><span id="l1.1284" class="difflineminus">-                                                   nsMsgViewIndex* indices,</span>
<a href="#l1.1285"></a><span id="l1.1285" class="difflineminus">-                                                   int32_t numIndices,</span>
<a href="#l1.1286"></a><span id="l1.1286" class="difflineminus">-                                                   nsIMsgFolder *destFolder)</span>
<a href="#l1.1287"></a><span id="l1.1287" class="difflineminus">-{</span>
<a href="#l1.1288"></a><span id="l1.1288" class="difflineplus">+nsresult nsMsgSearchDBView::ApplyCommandToIndicesWithFolder(</span>
<a href="#l1.1289"></a><span id="l1.1289" class="difflineplus">+    nsMsgViewCommandTypeValue command, nsMsgViewIndex *indices,</span>
<a href="#l1.1290"></a><span id="l1.1290" class="difflineplus">+    int32_t numIndices, nsIMsgFolder *destFolder) {</span>
<a href="#l1.1291"></a><span id="l1.1291">   mCommand = command;</span>
<a href="#l1.1292"></a><span id="l1.1292">   mDestFolder = destFolder;</span>
<a href="#l1.1293"></a><span id="l1.1293">   return nsMsgDBView::ApplyCommandToIndicesWithFolder(command, indices,</span>
<a href="#l1.1294"></a><span id="l1.1294">                                                       numIndices, destFolder);</span>
<a href="#l1.1295"></a><span id="l1.1295"> }</span>
<a href="#l1.1296"></a><span id="l1.1296"> </span>
<a href="#l1.1297"></a><span id="l1.1297"> // nsIMsgCopyServiceListener methods</span>
<a href="#l1.1298"></a><span id="l1.1298"> </span>
<a href="#l1.1299"></a><span id="l1.1299"> NS_IMETHODIMP</span>
<a href="#l1.1300"></a><span id="l1.1300" class="difflineminus">-nsMsgSearchDBView::OnStartCopy()</span>
<a href="#l1.1301"></a><span id="l1.1301" class="difflineminus">-{</span>
<a href="#l1.1302"></a><span id="l1.1302" class="difflineminus">-  return NS_OK;</span>
<a href="#l1.1303"></a><span id="l1.1303" class="difflineminus">-}</span>
<a href="#l1.1304"></a><span id="l1.1304" class="difflineplus">+nsMsgSearchDBView::OnStartCopy() { return NS_OK; }</span>
<a href="#l1.1305"></a><span id="l1.1305"> </span>
<a href="#l1.1306"></a><span id="l1.1306"> NS_IMETHODIMP</span>
<a href="#l1.1307"></a><span id="l1.1307" class="difflineminus">-nsMsgSearchDBView::OnProgress(uint32_t aProgress,</span>
<a href="#l1.1308"></a><span id="l1.1308" class="difflineminus">-                              uint32_t aProgressMax)</span>
<a href="#l1.1309"></a><span id="l1.1309" class="difflineminus">-{</span>
<a href="#l1.1310"></a><span id="l1.1310" class="difflineplus">+nsMsgSearchDBView::OnProgress(uint32_t aProgress, uint32_t aProgressMax) {</span>
<a href="#l1.1311"></a><span id="l1.1311">   return NS_OK;</span>
<a href="#l1.1312"></a><span id="l1.1312"> }</span>
<a href="#l1.1313"></a><span id="l1.1313"> </span>
<a href="#l1.1314"></a><span id="l1.1314"> // Believe it or not, these next two are msgcopyservice listener methods!</span>
<a href="#l1.1315"></a><span id="l1.1315"> NS_IMETHODIMP</span>
<a href="#l1.1316"></a><span id="l1.1316" class="difflineminus">-nsMsgSearchDBView::SetMessageKey(nsMsgKey aMessageKey)</span>
<a href="#l1.1317"></a><span id="l1.1317" class="difflineminus">-{</span>
<a href="#l1.1318"></a><span id="l1.1318" class="difflineminus">-  return NS_OK;</span>
<a href="#l1.1319"></a><span id="l1.1319" class="difflineminus">-}</span>
<a href="#l1.1320"></a><span id="l1.1320" class="difflineplus">+nsMsgSearchDBView::SetMessageKey(nsMsgKey aMessageKey) { return NS_OK; }</span>
<a href="#l1.1321"></a><span id="l1.1321"> </span>
<a href="#l1.1322"></a><span id="l1.1322"> NS_IMETHODIMP</span>
<a href="#l1.1323"></a><span id="l1.1323" class="difflineminus">-nsMsgSearchDBView::GetMessageId(nsACString&amp; messageId)</span>
<a href="#l1.1324"></a><span id="l1.1324" class="difflineminus">-{</span>
<a href="#l1.1325"></a><span id="l1.1325" class="difflineminus">-  return NS_OK;</span>
<a href="#l1.1326"></a><span id="l1.1326" class="difflineminus">-}</span>
<a href="#l1.1327"></a><span id="l1.1327" class="difflineplus">+nsMsgSearchDBView::GetMessageId(nsACString &amp;messageId) { return NS_OK; }</span>
<a href="#l1.1328"></a><span id="l1.1328"> </span>
<a href="#l1.1329"></a><span id="l1.1329"> NS_IMETHODIMP</span>
<a href="#l1.1330"></a><span id="l1.1330" class="difflineminus">-nsMsgSearchDBView::OnStopCopy(nsresult aStatus)</span>
<a href="#l1.1331"></a><span id="l1.1331" class="difflineminus">-{</span>
<a href="#l1.1332"></a><span id="l1.1332" class="difflineminus">-  if (NS_SUCCEEDED(aStatus))</span>
<a href="#l1.1333"></a><span id="l1.1333" class="difflineminus">-  {</span>
<a href="#l1.1334"></a><span id="l1.1334" class="difflineplus">+nsMsgSearchDBView::OnStopCopy(nsresult aStatus) {</span>
<a href="#l1.1335"></a><span id="l1.1335" class="difflineplus">+  if (NS_SUCCEEDED(aStatus)) {</span>
<a href="#l1.1336"></a><span id="l1.1336">     mCurIndex++;</span>
<a href="#l1.1337"></a><span id="l1.1337" class="difflineminus">-    if ((int32_t) mCurIndex &lt; m_uniqueFoldersSelected.Count())</span>
<a href="#l1.1338"></a><span id="l1.1338" class="difflineminus">-    {</span>
<a href="#l1.1339"></a><span id="l1.1339" class="difflineplus">+    if ((int32_t)mCurIndex &lt; m_uniqueFoldersSelected.Count()) {</span>
<a href="#l1.1340"></a><span id="l1.1340">       nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow(do_QueryReferent(mMsgWindowWeak));</span>
<a href="#l1.1341"></a><span id="l1.1341">       ProcessRequestsInOneFolder(msgWindow);</span>
<a href="#l1.1342"></a><span id="l1.1342">     }</span>
<a href="#l1.1343"></a><span id="l1.1343">   }</span>
<a href="#l1.1344"></a><span id="l1.1344"> </span>
<a href="#l1.1345"></a><span id="l1.1345">   return NS_OK;</span>
<a href="#l1.1346"></a><span id="l1.1346"> }</span>
<a href="#l1.1347"></a><span id="l1.1347"> </span>
<a href="#l1.1348"></a><span id="l1.1348"> // End nsIMsgCopyServiceListener methods.</span>
<a href="#l1.1349"></a><span id="l1.1349"> </span>
<a href="#l1.1350"></a><span id="l1.1350" class="difflineminus">-nsresult nsMsgSearchDBView::ProcessRequestsInOneFolder(nsIMsgWindow *window)</span>
<a href="#l1.1351"></a><span id="l1.1351" class="difflineminus">-{</span>
<a href="#l1.1352"></a><span id="l1.1352" class="difflineplus">+nsresult nsMsgSearchDBView::ProcessRequestsInOneFolder(nsIMsgWindow *window) {</span>
<a href="#l1.1353"></a><span id="l1.1353">   nsresult rv = NS_OK;</span>
<a href="#l1.1354"></a><span id="l1.1354"> </span>
<a href="#l1.1355"></a><span id="l1.1355">   // Folder operations like copy/move are not implemented for .eml files.</span>
<a href="#l1.1356"></a><span id="l1.1356" class="difflineminus">-  if (m_uniqueFoldersSelected.Count() == 0)</span>
<a href="#l1.1357"></a><span id="l1.1357" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l1.1358"></a><span id="l1.1358" class="difflineplus">+  if (m_uniqueFoldersSelected.Count() == 0) return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l1.1359"></a><span id="l1.1359"> </span>
<a href="#l1.1360"></a><span id="l1.1360">   nsIMsgFolder *curFolder = m_uniqueFoldersSelected[mCurIndex];</span>
<a href="#l1.1361"></a><span id="l1.1361">   NS_ASSERTION(curFolder, &quot;curFolder is null&quot;);</span>
<a href="#l1.1362"></a><span id="l1.1362">   nsCOMPtr&lt;nsIMutableArray&gt; messageArray = m_hdrsForEachFolder[mCurIndex];</span>
<a href="#l1.1363"></a><span id="l1.1363">   NS_ASSERTION(messageArray, &quot;messageArray is null&quot;);</span>
<a href="#l1.1364"></a><span id="l1.1364"> </span>
<a href="#l1.1365"></a><span id="l1.1365">   // called for delete with trash, copy and move</span>
<a href="#l1.1366"></a><span id="l1.1366">   if (mCommand == nsMsgViewCommandType::deleteMsg)</span>
<a href="#l1.1367"></a><span id="l1.1367">     curFolder-&gt;DeleteMessages(messageArray, window, false /* delete storage */,</span>
<a href="#l1.1368"></a><span id="l1.1368">                               false /* is move*/, this, true /*allowUndo*/);</span>
<a href="#l1.1369"></a><span id="l1.1369" class="difflineminus">-  else</span>
<a href="#l1.1370"></a><span id="l1.1370" class="difflineminus">-  {</span>
<a href="#l1.1371"></a><span id="l1.1371" class="difflineplus">+  else {</span>
<a href="#l1.1372"></a><span id="l1.1372">     NS_ASSERTION(!(curFolder == mDestFolder),</span>
<a href="#l1.1373"></a><span id="l1.1373">                  &quot;The source folder and the destination folder are the same&quot;);</span>
<a href="#l1.1374"></a><span id="l1.1374" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; curFolder != mDestFolder)</span>
<a href="#l1.1375"></a><span id="l1.1375" class="difflineminus">-    {</span>
<a href="#l1.1376"></a><span id="l1.1376" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; curFolder != mDestFolder) {</span>
<a href="#l1.1377"></a><span id="l1.1377">       nsCOMPtr&lt;nsIMsgCopyService&gt; copyService =</span>
<a href="#l1.1378"></a><span id="l1.1378" class="difflineminus">-        do_GetService(NS_MSGCOPYSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l1.1379"></a><span id="l1.1379" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l1.1380"></a><span id="l1.1380" class="difflineminus">-      {</span>
<a href="#l1.1381"></a><span id="l1.1381" class="difflineplus">+          do_GetService(NS_MSGCOPYSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l1.1382"></a><span id="l1.1382" class="difflineplus">+      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l1.1383"></a><span id="l1.1383">         if (mCommand == nsMsgViewCommandType::moveMessages)</span>
<a href="#l1.1384"></a><span id="l1.1384">           copyService-&gt;CopyMessages(curFolder, messageArray, mDestFolder,</span>
<a href="#l1.1385"></a><span id="l1.1385" class="difflineminus">-                                    true /* isMove */, this, window, true /*allowUndo*/);</span>
<a href="#l1.1386"></a><span id="l1.1386" class="difflineplus">+                                    true /* isMove */, this, window,</span>
<a href="#l1.1387"></a><span id="l1.1387" class="difflineplus">+                                    true /*allowUndo*/);</span>
<a href="#l1.1388"></a><span id="l1.1388">         else if (mCommand == nsMsgViewCommandType::copyMessages)</span>
<a href="#l1.1389"></a><span id="l1.1389">           copyService-&gt;CopyMessages(curFolder, messageArray, mDestFolder,</span>
<a href="#l1.1390"></a><span id="l1.1390" class="difflineminus">-                                    false /* isMove */, this, window, true /*allowUndo*/);</span>
<a href="#l1.1391"></a><span id="l1.1391" class="difflineplus">+                                    false /* isMove */, this, window,</span>
<a href="#l1.1392"></a><span id="l1.1392" class="difflineplus">+                                    true /*allowUndo*/);</span>
<a href="#l1.1393"></a><span id="l1.1393">       }</span>
<a href="#l1.1394"></a><span id="l1.1394">     }</span>
<a href="#l1.1395"></a><span id="l1.1395">   }</span>
<a href="#l1.1396"></a><span id="l1.1396"> </span>
<a href="#l1.1397"></a><span id="l1.1397">   return rv;</span>
<a href="#l1.1398"></a><span id="l1.1398"> }</span>
<a href="#l1.1399"></a><span id="l1.1399"> </span>
<a href="#l1.1400"></a><span id="l1.1400" class="difflineminus">-nsresult</span>
<a href="#l1.1401"></a><span id="l1.1401" class="difflineminus">-nsMsgSearchDBView::ProcessRequestsInAllFolders(nsIMsgWindow *window)</span>
<a href="#l1.1402"></a><span id="l1.1402" class="difflineminus">-{</span>
<a href="#l1.1403"></a><span id="l1.1403" class="difflineplus">+nsresult nsMsgSearchDBView::ProcessRequestsInAllFolders(nsIMsgWindow *window) {</span>
<a href="#l1.1404"></a><span id="l1.1404">   uint32_t numFolders = m_uniqueFoldersSelected.Count();</span>
<a href="#l1.1405"></a><span id="l1.1405" class="difflineminus">-  for (uint32_t folderIndex = 0; folderIndex &lt; numFolders; folderIndex++)</span>
<a href="#l1.1406"></a><span id="l1.1406" class="difflineminus">-  {</span>
<a href="#l1.1407"></a><span id="l1.1407" class="difflineplus">+  for (uint32_t folderIndex = 0; folderIndex &lt; numFolders; folderIndex++) {</span>
<a href="#l1.1408"></a><span id="l1.1408">     nsIMsgFolder *curFolder = m_uniqueFoldersSelected[folderIndex];</span>
<a href="#l1.1409"></a><span id="l1.1409" class="difflineminus">-    NS_ASSERTION (curFolder, &quot;curFolder is null&quot;);</span>
<a href="#l1.1410"></a><span id="l1.1410" class="difflineplus">+    NS_ASSERTION(curFolder, &quot;curFolder is null&quot;);</span>
<a href="#l1.1411"></a><span id="l1.1411"> </span>
<a href="#l1.1412"></a><span id="l1.1412">     nsCOMPtr&lt;nsIMutableArray&gt; messageArray = m_hdrsForEachFolder[folderIndex];</span>
<a href="#l1.1413"></a><span id="l1.1413">     NS_ASSERTION(messageArray, &quot;messageArray is null&quot;);</span>
<a href="#l1.1414"></a><span id="l1.1414"> </span>
<a href="#l1.1415"></a><span id="l1.1415" class="difflineminus">-    curFolder-&gt;DeleteMessages(messageArray, window,</span>
<a href="#l1.1416"></a><span id="l1.1416" class="difflineminus">-                              true /* delete storage */,</span>
<a href="#l1.1417"></a><span id="l1.1417" class="difflineminus">-                              false /* is move*/,</span>
<a href="#l1.1418"></a><span id="l1.1418" class="difflineminus">-                              nullptr/*copyServListener*/,</span>
<a href="#l1.1419"></a><span id="l1.1419" class="difflineminus">-                              false /*allowUndo*/ );</span>
<a href="#l1.1420"></a><span id="l1.1420" class="difflineplus">+    curFolder-&gt;DeleteMessages(messageArray, window, true /* delete storage */,</span>
<a href="#l1.1421"></a><span id="l1.1421" class="difflineplus">+                              false /* is move*/, nullptr /*copyServListener*/,</span>
<a href="#l1.1422"></a><span id="l1.1422" class="difflineplus">+                              false /*allowUndo*/);</span>
<a href="#l1.1423"></a><span id="l1.1423">   }</span>
<a href="#l1.1424"></a><span id="l1.1424"> </span>
<a href="#l1.1425"></a><span id="l1.1425">   return NS_OK;</span>
<a href="#l1.1426"></a><span id="l1.1426"> }</span>
<a href="#l1.1427"></a><span id="l1.1427"> </span>
<a href="#l1.1428"></a><span id="l1.1428"> NS_IMETHODIMP nsMsgSearchDBView::Sort(nsMsgViewSortTypeValue sortType,</span>
<a href="#l1.1429"></a><span id="l1.1429" class="difflineminus">-                                      nsMsgViewSortOrderValue sortOrder)</span>
<a href="#l1.1430"></a><span id="l1.1430" class="difflineminus">-{</span>
<a href="#l1.1431"></a><span id="l1.1431" class="difflineplus">+                                      nsMsgViewSortOrderValue sortOrder) {</span>
<a href="#l1.1432"></a><span id="l1.1432">   if (!m_checkedCustomColumns &amp;&amp; CustomColumnsInSortAndNotRegistered())</span>
<a href="#l1.1433"></a><span id="l1.1433">     return NS_OK;</span>
<a href="#l1.1434"></a><span id="l1.1434"> </span>
<a href="#l1.1435"></a><span id="l1.1435">   int32_t rowCountBeforeSort = GetSize();</span>
<a href="#l1.1436"></a><span id="l1.1436"> </span>
<a href="#l1.1437"></a><span id="l1.1437" class="difflineminus">-  if (!rowCountBeforeSort)</span>
<a href="#l1.1438"></a><span id="l1.1438" class="difflineminus">-    return NS_OK;</span>
<a href="#l1.1439"></a><span id="l1.1439" class="difflineplus">+  if (!rowCountBeforeSort) return NS_OK;</span>
<a href="#l1.1440"></a><span id="l1.1440"> </span>
<a href="#l1.1441"></a><span id="l1.1441">   if (m_viewFlags &amp; (nsMsgViewFlagsType::kThreadedDisplay |</span>
<a href="#l1.1442"></a><span id="l1.1442" class="difflineminus">-                     nsMsgViewFlagsType::kGroupBySort))</span>
<a href="#l1.1443"></a><span id="l1.1443" class="difflineminus">-  {</span>
<a href="#l1.1444"></a><span id="l1.1444" class="difflineplus">+                     nsMsgViewFlagsType::kGroupBySort)) {</span>
<a href="#l1.1445"></a><span id="l1.1445">     // ### This forgets which threads were expanded, and is sub-optimal</span>
<a href="#l1.1446"></a><span id="l1.1446">     // since it rebuilds the thread objects.</span>
<a href="#l1.1447"></a><span id="l1.1447">     m_sortType = sortType;</span>
<a href="#l1.1448"></a><span id="l1.1448">     m_sortOrder = sortOrder;</span>
<a href="#l1.1449"></a><span id="l1.1449">     return RebuildView(m_viewFlags);</span>
<a href="#l1.1450"></a><span id="l1.1450">   }</span>
<a href="#l1.1451"></a><span id="l1.1451"> </span>
<a href="#l1.1452"></a><span id="l1.1452">   nsMsgKey preservedKey;</span>
<a href="#l1.1453"></a><span id="l1.1453">   AutoTArray&lt;nsMsgKey, 1&gt; preservedSelection;</span>
<a href="#l1.1454"></a><span id="l1.1454">   SaveAndClearSelection(&amp;preservedKey, preservedSelection);</span>
<a href="#l1.1455"></a><span id="l1.1455"> </span>
<a href="#l1.1456"></a><span id="l1.1456" class="difflineminus">-  nsresult rv = nsMsgDBView::Sort(sortType,sortOrder);</span>
<a href="#l1.1457"></a><span id="l1.1457" class="difflineplus">+  nsresult rv = nsMsgDBView::Sort(sortType, sortOrder);</span>
<a href="#l1.1458"></a><span id="l1.1458">   // The sort may have changed the number of rows before we restore the</span>
<a href="#l1.1459"></a><span id="l1.1459">   // selection, tell the tree do this before we call restore selection.</span>
<a href="#l1.1460"></a><span id="l1.1460">   // This is safe when there is no selection.</span>
<a href="#l1.1461"></a><span id="l1.1461">   rv = AdjustRowCount(rowCountBeforeSort, GetSize());</span>
<a href="#l1.1462"></a><span id="l1.1462"> </span>
<a href="#l1.1463"></a><span id="l1.1463">   RestoreSelection(preservedKey, preservedSelection);</span>
<a href="#l1.1464"></a><span id="l1.1464" class="difflineminus">-  if (mTree)</span>
<a href="#l1.1465"></a><span id="l1.1465" class="difflineminus">-    mTree-&gt;Invalidate();</span>
<a href="#l1.1466"></a><span id="l1.1466" class="difflineplus">+  if (mTree) mTree-&gt;Invalidate();</span>
<a href="#l1.1467"></a><span id="l1.1467"> </span>
<a href="#l1.1468"></a><span id="l1.1468" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.1469"></a><span id="l1.1469" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.1470"></a><span id="l1.1470">   return rv;</span>
<a href="#l1.1471"></a><span id="l1.1471"> }</span>
<a href="#l1.1472"></a><span id="l1.1472"> </span>
<a href="#l1.1473"></a><span id="l1.1473"> // If nothing selected, return an NS_ERROR.</span>
<a href="#l1.1474"></a><span id="l1.1474"> NS_IMETHODIMP</span>
<a href="#l1.1475"></a><span id="l1.1475" class="difflineminus">-nsMsgSearchDBView::GetHdrForFirstSelectedMessage(nsIMsgDBHdr **hdr)</span>
<a href="#l1.1476"></a><span id="l1.1476" class="difflineminus">-{</span>
<a href="#l1.1477"></a><span id="l1.1477" class="difflineplus">+nsMsgSearchDBView::GetHdrForFirstSelectedMessage(nsIMsgDBHdr **hdr) {</span>
<a href="#l1.1478"></a><span id="l1.1478">   NS_ENSURE_ARG_POINTER(hdr);</span>
<a href="#l1.1479"></a><span id="l1.1479">   int32_t index;</span>
<a href="#l1.1480"></a><span id="l1.1480"> </span>
<a href="#l1.1481"></a><span id="l1.1481" class="difflineminus">-  if (!mTreeSelection)</span>
<a href="#l1.1482"></a><span id="l1.1482" class="difflineminus">-  {</span>
<a href="#l1.1483"></a><span id="l1.1483" class="difflineplus">+  if (!mTreeSelection) {</span>
<a href="#l1.1484"></a><span id="l1.1484">     // We're in standalone mode, so use the message view index to get the</span>
<a href="#l1.1485"></a><span id="l1.1485">     // header. We can't use the key here because we don't have an m_db.</span>
<a href="#l1.1486"></a><span id="l1.1486">     index = m_currentlyDisplayedViewIndex;</span>
<a href="#l1.1487"></a><span id="l1.1487" class="difflineminus">-  }</span>
<a href="#l1.1488"></a><span id="l1.1488" class="difflineminus">-  else</span>
<a href="#l1.1489"></a><span id="l1.1489" class="difflineminus">-  {</span>
<a href="#l1.1490"></a><span id="l1.1490" class="difflineplus">+  } else {</span>
<a href="#l1.1491"></a><span id="l1.1491">     nsresult rv = mTreeSelection-&gt;GetCurrentIndex(&amp;index);</span>
<a href="#l1.1492"></a><span id="l1.1492">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.1493"></a><span id="l1.1493">   }</span>
<a href="#l1.1494"></a><span id="l1.1494"> </span>
<a href="#l1.1495"></a><span id="l1.1495">   return GetMsgHdrForViewIndex(index, hdr);</span>
<a href="#l1.1496"></a><span id="l1.1496"> }</span>
<a href="#l1.1497"></a><span id="l1.1497"> </span>
<a href="#l1.1498"></a><span id="l1.1498"> NS_IMETHODIMP</span>
<a href="#l1.1499"></a><span id="l1.1499"> nsMsgSearchDBView::OpenWithHdrs(nsISimpleEnumerator *aHeaders,</span>
<a href="#l1.1500"></a><span id="l1.1500">                                 nsMsgViewSortTypeValue aSortType,</span>
<a href="#l1.1501"></a><span id="l1.1501">                                 nsMsgViewSortOrderValue aSortOrder,</span>
<a href="#l1.1502"></a><span id="l1.1502">                                 nsMsgViewFlagsTypeValue aViewFlags,</span>
<a href="#l1.1503"></a><span id="l1.1503" class="difflineminus">-                                int32_t *aCount)</span>
<a href="#l1.1504"></a><span id="l1.1504" class="difflineminus">-{</span>
<a href="#l1.1505"></a><span id="l1.1505" class="difflineplus">+                                int32_t *aCount) {</span>
<a href="#l1.1506"></a><span id="l1.1506">   if (aViewFlags &amp; nsMsgViewFlagsType::kGroupBySort)</span>
<a href="#l1.1507"></a><span id="l1.1507">     return nsMsgGroupView::OpenWithHdrs(aHeaders, aSortType, aSortOrder,</span>
<a href="#l1.1508"></a><span id="l1.1508">                                         aViewFlags, aCount);</span>
<a href="#l1.1509"></a><span id="l1.1509"> </span>
<a href="#l1.1510"></a><span id="l1.1510">   m_sortType = aSortType;</span>
<a href="#l1.1511"></a><span id="l1.1511">   m_sortOrder = aSortOrder;</span>
<a href="#l1.1512"></a><span id="l1.1512">   m_viewFlags = aViewFlags;</span>
<a href="#l1.1513"></a><span id="l1.1513">   SaveSortInfo(m_sortType, m_sortOrder);</span>
<a href="#l1.1514"></a><span id="l1.1514"> </span>
<a href="#l1.1515"></a><span id="l1.1515">   bool hasMore;</span>
<a href="#l1.1516"></a><span id="l1.1516">   nsCOMPtr&lt;nsISupports&gt; supports;</span>
<a href="#l1.1517"></a><span id="l1.1517">   nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.1518"></a><span id="l1.1518">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l1.1519"></a><span id="l1.1519">   nsresult rv = NS_OK;</span>
<a href="#l1.1520"></a><span id="l1.1520">   while (NS_SUCCEEDED(rv) &amp;&amp;</span>
<a href="#l1.1521"></a><span id="l1.1521" class="difflineminus">-         NS_SUCCEEDED(rv = aHeaders-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp;</span>
<a href="#l1.1522"></a><span id="l1.1522" class="difflineminus">-         hasMore)</span>
<a href="#l1.1523"></a><span id="l1.1523" class="difflineminus">-  {</span>
<a href="#l1.1524"></a><span id="l1.1524" class="difflineplus">+         NS_SUCCEEDED(rv = aHeaders-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore) {</span>
<a href="#l1.1525"></a><span id="l1.1525">     rv = aHeaders-&gt;GetNext(getter_AddRefs(supports));</span>
<a href="#l1.1526"></a><span id="l1.1526" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; supports)</span>
<a href="#l1.1527"></a><span id="l1.1527" class="difflineminus">-    {</span>
<a href="#l1.1528"></a><span id="l1.1528" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; supports) {</span>
<a href="#l1.1529"></a><span id="l1.1529">       msgHdr = do_QueryInterface(supports);</span>
<a href="#l1.1530"></a><span id="l1.1530">       msgHdr-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l1.1531"></a><span id="l1.1531">       AddHdrFromFolder(msgHdr, folder);</span>
<a href="#l1.1532"></a><span id="l1.1532">     }</span>
<a href="#l1.1533"></a><span id="l1.1533">   }</span>
<a href="#l1.1534"></a><span id="l1.1534"> </span>
<a href="#l1.1535"></a><span id="l1.1535">   *aCount = m_keys.Length();</span>
<a href="#l1.1536"></a><span id="l1.1536">   return rv;</span>
<a href="#l1.1537"></a><span id="l1.1537"> }</span>
<a href="#l1.1538"></a><span id="l1.1538"> </span>
<a href="#l1.1539"></a><span id="l1.1539" class="difflineminus">-nsresult</span>
<a href="#l1.1540"></a><span id="l1.1540" class="difflineminus">-nsMsgSearchDBView::GetFolderFromMsgURI(const char *aMsgURI,</span>
<a href="#l1.1541"></a><span id="l1.1541" class="difflineminus">-                                       nsIMsgFolder **aFolder)</span>
<a href="#l1.1542"></a><span id="l1.1542" class="difflineminus">-{</span>
<a href="#l1.1543"></a><span id="l1.1543" class="difflineminus">-  nsCOMPtr &lt;nsIMsgMessageService&gt; msgMessageService;</span>
<a href="#l1.1544"></a><span id="l1.1544" class="difflineminus">-  nsresult rv = GetMessageServiceFromURI(nsDependentCString(aMsgURI), getter_AddRefs(msgMessageService));</span>
<a href="#l1.1545"></a><span id="l1.1545" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.1546"></a><span id="l1.1546" class="difflineplus">+nsresult nsMsgSearchDBView::GetFolderFromMsgURI(const char *aMsgURI,</span>
<a href="#l1.1547"></a><span id="l1.1547" class="difflineplus">+                                                nsIMsgFolder **aFolder) {</span>
<a href="#l1.1548"></a><span id="l1.1548" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMessageService&gt; msgMessageService;</span>
<a href="#l1.1549"></a><span id="l1.1549" class="difflineplus">+  nsresult rv = GetMessageServiceFromURI(nsDependentCString(aMsgURI),</span>
<a href="#l1.1550"></a><span id="l1.1550" class="difflineplus">+                                         getter_AddRefs(msgMessageService));</span>
<a href="#l1.1551"></a><span id="l1.1551" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.1552"></a><span id="l1.1552"> </span>
<a href="#l1.1553"></a><span id="l1.1553" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.1554"></a><span id="l1.1554" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.1555"></a><span id="l1.1555">   rv = msgMessageService-&gt;MessageURIToMsgHdr(aMsgURI, getter_AddRefs(msgHdr));</span>
<a href="#l1.1556"></a><span id="l1.1556" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.1557"></a><span id="l1.1557" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.1558"></a><span id="l1.1558"> </span>
<a href="#l1.1559"></a><span id="l1.1559">   return msgHdr-&gt;GetFolder(aFolder);</span>
<a href="#l1.1560"></a><span id="l1.1560"> }</span>
<a href="#l1.1561"></a><span id="l1.1561"> </span>
<a href="#l1.1562"></a><span id="l1.1562" class="difflineminus">-nsMsgViewIndex</span>
<a href="#l1.1563"></a><span id="l1.1563" class="difflineminus">-nsMsgSearchDBView::FindHdr(nsIMsgDBHdr *msgHdr,</span>
<a href="#l1.1564"></a><span id="l1.1564" class="difflineminus">-                           nsMsgViewIndex startIndex,</span>
<a href="#l1.1565"></a><span id="l1.1565" class="difflineminus">-                           bool allowDummy)</span>
<a href="#l1.1566"></a><span id="l1.1566" class="difflineminus">-{</span>
<a href="#l1.1567"></a><span id="l1.1567" class="difflineplus">+nsMsgViewIndex nsMsgSearchDBView::FindHdr(nsIMsgDBHdr *msgHdr,</span>
<a href="#l1.1568"></a><span id="l1.1568" class="difflineplus">+                                          nsMsgViewIndex startIndex,</span>
<a href="#l1.1569"></a><span id="l1.1569" class="difflineplus">+                                          bool allowDummy) {</span>
<a href="#l1.1570"></a><span id="l1.1570">   nsCOMPtr&lt;nsIMsgDBHdr&gt; curHdr;</span>
<a href="#l1.1571"></a><span id="l1.1571">   uint32_t index;</span>
<a href="#l1.1572"></a><span id="l1.1572">   // It would be nice to take advantage of sorted views when possible.</span>
<a href="#l1.1573"></a><span id="l1.1573" class="difflineminus">-  for (index = startIndex; index &lt; GetSize(); index++)</span>
<a href="#l1.1574"></a><span id="l1.1574" class="difflineminus">-  {</span>
<a href="#l1.1575"></a><span id="l1.1575" class="difflineplus">+  for (index = startIndex; index &lt; GetSize(); index++) {</span>
<a href="#l1.1576"></a><span id="l1.1576">     GetMsgHdrForViewIndex(index, getter_AddRefs(curHdr));</span>
<a href="#l1.1577"></a><span id="l1.1577">     if (curHdr == msgHdr &amp;&amp;</span>
<a href="#l1.1578"></a><span id="l1.1578" class="difflineminus">-        (allowDummy ||</span>
<a href="#l1.1579"></a><span id="l1.1579" class="difflineminus">-         !(m_flags[index] &amp; MSG_VIEW_FLAG_DUMMY) ||</span>
<a href="#l1.1580"></a><span id="l1.1580" class="difflineplus">+        (allowDummy || !(m_flags[index] &amp; MSG_VIEW_FLAG_DUMMY) ||</span>
<a href="#l1.1581"></a><span id="l1.1581">          (m_flags[index] &amp; nsMsgMessageFlags::Elided)))</span>
<a href="#l1.1582"></a><span id="l1.1582">       break;</span>
<a href="#l1.1583"></a><span id="l1.1583">   }</span>
<a href="#l1.1584"></a><span id="l1.1584"> </span>
<a href="#l1.1585"></a><span id="l1.1585">   return index &lt; GetSize() ? index : nsMsgViewIndex_None;</span>
<a href="#l1.1586"></a><span id="l1.1586"> }</span>
<a href="#l1.1587"></a><span id="l1.1587"> </span>
<a href="#l1.1588"></a><span id="l1.1588"> // This method looks for the XF thread that corresponds to this message hdr,</span>
<a href="#l1.1589"></a><span id="l1.1589"> // first by looking up the message id, then references, and finally, if subject</span>
<a href="#l1.1590"></a><span id="l1.1590"> // threading is turned on, the subject.</span>
<a href="#l1.1591"></a><span id="l1.1591" class="difflineminus">-nsresult</span>
<a href="#l1.1592"></a><span id="l1.1592" class="difflineminus">-nsMsgSearchDBView::GetXFThreadFromMsgHdr(nsIMsgDBHdr *msgHdr,</span>
<a href="#l1.1593"></a><span id="l1.1593" class="difflineminus">-                                         nsIMsgThread **pThread,</span>
<a href="#l1.1594"></a><span id="l1.1594" class="difflineminus">-                                         bool *foundByMessageId)</span>
<a href="#l1.1595"></a><span id="l1.1595" class="difflineminus">-{</span>
<a href="#l1.1596"></a><span id="l1.1596" class="difflineplus">+nsresult nsMsgSearchDBView::GetXFThreadFromMsgHdr(nsIMsgDBHdr *msgHdr,</span>
<a href="#l1.1597"></a><span id="l1.1597" class="difflineplus">+                                                  nsIMsgThread **pThread,</span>
<a href="#l1.1598"></a><span id="l1.1598" class="difflineplus">+                                                  bool *foundByMessageId) {</span>
<a href="#l1.1599"></a><span id="l1.1599">   NS_ENSURE_ARG_POINTER(pThread);</span>
<a href="#l1.1600"></a><span id="l1.1600"> </span>
<a href="#l1.1601"></a><span id="l1.1601">   nsAutoCString messageId;</span>
<a href="#l1.1602"></a><span id="l1.1602">   msgHdr-&gt;GetMessageId(getter_Copies(messageId));</span>
<a href="#l1.1603"></a><span id="l1.1603">   *pThread = nullptr;</span>
<a href="#l1.1604"></a><span id="l1.1604">   m_threadsTable.Get(messageId, pThread);</span>
<a href="#l1.1605"></a><span id="l1.1605">   // The caller may want to know if we found the thread by the msgHdr's</span>
<a href="#l1.1606"></a><span id="l1.1606">   // messageId.</span>
<a href="#l1.1607"></a><span id="l1.1607" class="difflineminus">-  if (foundByMessageId)</span>
<a href="#l1.1608"></a><span id="l1.1608" class="difflineminus">-    *foundByMessageId = *pThread != nullptr;</span>
<a href="#l1.1609"></a><span id="l1.1609" class="difflineplus">+  if (foundByMessageId) *foundByMessageId = *pThread != nullptr;</span>
<a href="#l1.1610"></a><span id="l1.1610"> </span>
<a href="#l1.1611"></a><span id="l1.1611" class="difflineminus">-  if (!*pThread)</span>
<a href="#l1.1612"></a><span id="l1.1612" class="difflineminus">-  {</span>
<a href="#l1.1613"></a><span id="l1.1613" class="difflineplus">+  if (!*pThread) {</span>
<a href="#l1.1614"></a><span id="l1.1614">     uint16_t numReferences = 0;</span>
<a href="#l1.1615"></a><span id="l1.1615">     msgHdr-&gt;GetNumReferences(&amp;numReferences);</span>
<a href="#l1.1616"></a><span id="l1.1616" class="difflineminus">-    for (int32_t i = numReferences - 1; i &gt;= 0  &amp;&amp; !*pThread; i--)</span>
<a href="#l1.1617"></a><span id="l1.1617" class="difflineminus">-    {</span>
<a href="#l1.1618"></a><span id="l1.1618" class="difflineplus">+    for (int32_t i = numReferences - 1; i &gt;= 0 &amp;&amp; !*pThread; i--) {</span>
<a href="#l1.1619"></a><span id="l1.1619">       nsAutoCString reference;</span>
<a href="#l1.1620"></a><span id="l1.1620">       msgHdr-&gt;GetStringReference(i, reference);</span>
<a href="#l1.1621"></a><span id="l1.1621" class="difflineminus">-      if (reference.IsEmpty())</span>
<a href="#l1.1622"></a><span id="l1.1622" class="difflineminus">-        break;</span>
<a href="#l1.1623"></a><span id="l1.1623" class="difflineplus">+      if (reference.IsEmpty()) break;</span>
<a href="#l1.1624"></a><span id="l1.1624"> </span>
<a href="#l1.1625"></a><span id="l1.1625">       m_threadsTable.Get(reference, pThread);</span>
<a href="#l1.1626"></a><span id="l1.1626">     }</span>
<a href="#l1.1627"></a><span id="l1.1627">   }</span>
<a href="#l1.1628"></a><span id="l1.1628"> </span>
<a href="#l1.1629"></a><span id="l1.1629">   // If we're threading by subject, and we couldn't find the thread by ref,</span>
<a href="#l1.1630"></a><span id="l1.1630">   // just treat subject as an other ref.</span>
<a href="#l1.1631"></a><span id="l1.1631" class="difflineminus">-  if (!*pThread &amp;&amp; !gReferenceOnlyThreading)</span>
<a href="#l1.1632"></a><span id="l1.1632" class="difflineminus">-  {</span>
<a href="#l1.1633"></a><span id="l1.1633" class="difflineplus">+  if (!*pThread &amp;&amp; !gReferenceOnlyThreading) {</span>
<a href="#l1.1634"></a><span id="l1.1634">     nsCString subject;</span>
<a href="#l1.1635"></a><span id="l1.1635">     msgHdr-&gt;GetSubject(getter_Copies(subject));</span>
<a href="#l1.1636"></a><span id="l1.1636">     // This is the raw rfc822 subject header, so this is OK.</span>
<a href="#l1.1637"></a><span id="l1.1637">     m_threadsTable.Get(subject, pThread);</span>
<a href="#l1.1638"></a><span id="l1.1638">   }</span>
<a href="#l1.1639"></a><span id="l1.1639"> </span>
<a href="#l1.1640"></a><span id="l1.1640">   return (*pThread) ? NS_OK : NS_ERROR_FAILURE;</span>
<a href="#l1.1641"></a><span id="l1.1641"> }</span>
<a href="#l1.1642"></a><span id="l1.1642"> </span>
<a href="#l1.1643"></a><span id="l1.1643"> bool nsMsgSearchDBView::GetMsgHdrFromHash(nsCString &amp;reference,</span>
<a href="#l1.1644"></a><span id="l1.1644" class="difflineminus">-                                          nsIMsgDBHdr **hdr)</span>
<a href="#l1.1645"></a><span id="l1.1645" class="difflineminus">-{</span>
<a href="#l1.1646"></a><span id="l1.1646" class="difflineplus">+                                          nsIMsgDBHdr **hdr) {</span>
<a href="#l1.1647"></a><span id="l1.1647">   return m_hdrsTable.Get(reference, hdr);</span>
<a href="#l1.1648"></a><span id="l1.1648"> }</span>
<a href="#l1.1649"></a><span id="l1.1649"> </span>
<a href="#l1.1650"></a><span id="l1.1650"> bool nsMsgSearchDBView::GetThreadFromHash(nsCString &amp;reference,</span>
<a href="#l1.1651"></a><span id="l1.1651" class="difflineminus">-                                          nsIMsgThread **thread)</span>
<a href="#l1.1652"></a><span id="l1.1652" class="difflineminus">-{</span>
<a href="#l1.1653"></a><span id="l1.1653" class="difflineplus">+                                          nsIMsgThread **thread) {</span>
<a href="#l1.1654"></a><span id="l1.1654">   return m_threadsTable.Get(reference, thread);</span>
<a href="#l1.1655"></a><span id="l1.1655"> }</span>
<a href="#l1.1656"></a><span id="l1.1656"> </span>
<a href="#l1.1657"></a><span id="l1.1657" class="difflineminus">-nsresult</span>
<a href="#l1.1658"></a><span id="l1.1658" class="difflineminus">-nsMsgSearchDBView::AddRefToHash(nsCString &amp;reference,</span>
<a href="#l1.1659"></a><span id="l1.1659" class="difflineminus">-                                nsIMsgThread *thread)</span>
<a href="#l1.1660"></a><span id="l1.1660" class="difflineminus">-{</span>
<a href="#l1.1661"></a><span id="l1.1661" class="difflineplus">+nsresult nsMsgSearchDBView::AddRefToHash(nsCString &amp;reference,</span>
<a href="#l1.1662"></a><span id="l1.1662" class="difflineplus">+                                         nsIMsgThread *thread) {</span>
<a href="#l1.1663"></a><span id="l1.1663">   // Check if this reference is already is associated with a thread;</span>
<a href="#l1.1664"></a><span id="l1.1664">   // If so, don't overwrite that association.</span>
<a href="#l1.1665"></a><span id="l1.1665">   nsCOMPtr&lt;nsIMsgThread&gt; oldThread;</span>
<a href="#l1.1666"></a><span id="l1.1666">   m_threadsTable.Get(reference, getter_AddRefs(oldThread));</span>
<a href="#l1.1667"></a><span id="l1.1667" class="difflineminus">-  if (oldThread)</span>
<a href="#l1.1668"></a><span id="l1.1668" class="difflineminus">-    return NS_OK;</span>
<a href="#l1.1669"></a><span id="l1.1669" class="difflineplus">+  if (oldThread) return NS_OK;</span>
<a href="#l1.1670"></a><span id="l1.1670"> </span>
<a href="#l1.1671"></a><span id="l1.1671">   m_threadsTable.Put(reference, thread);</span>
<a href="#l1.1672"></a><span id="l1.1672">   return NS_OK;</span>
<a href="#l1.1673"></a><span id="l1.1673"> }</span>
<a href="#l1.1674"></a><span id="l1.1674"> </span>
<a href="#l1.1675"></a><span id="l1.1675" class="difflineminus">-nsresult</span>
<a href="#l1.1676"></a><span id="l1.1676" class="difflineminus">-nsMsgSearchDBView::AddMsgToHashTables(nsIMsgDBHdr *msgHdr,</span>
<a href="#l1.1677"></a><span id="l1.1677" class="difflineminus">-                                      nsIMsgThread *thread)</span>
<a href="#l1.1678"></a><span id="l1.1678" class="difflineminus">-{</span>
<a href="#l1.1679"></a><span id="l1.1679" class="difflineplus">+nsresult nsMsgSearchDBView::AddMsgToHashTables(nsIMsgDBHdr *msgHdr,</span>
<a href="#l1.1680"></a><span id="l1.1680" class="difflineplus">+                                               nsIMsgThread *thread) {</span>
<a href="#l1.1681"></a><span id="l1.1681">   NS_ENSURE_ARG_POINTER(msgHdr);</span>
<a href="#l1.1682"></a><span id="l1.1682"> </span>
<a href="#l1.1683"></a><span id="l1.1683">   uint16_t numReferences = 0;</span>
<a href="#l1.1684"></a><span id="l1.1684">   nsresult rv;</span>
<a href="#l1.1685"></a><span id="l1.1685"> </span>
<a href="#l1.1686"></a><span id="l1.1686">   msgHdr-&gt;GetNumReferences(&amp;numReferences);</span>
<a href="#l1.1687"></a><span id="l1.1687" class="difflineminus">-  for (int32_t i = 0; i &lt; numReferences; i++)</span>
<a href="#l1.1688"></a><span id="l1.1688" class="difflineminus">-  {</span>
<a href="#l1.1689"></a><span id="l1.1689" class="difflineplus">+  for (int32_t i = 0; i &lt; numReferences; i++) {</span>
<a href="#l1.1690"></a><span id="l1.1690">     nsAutoCString reference;</span>
<a href="#l1.1691"></a><span id="l1.1691">     msgHdr-&gt;GetStringReference(i, reference);</span>
<a href="#l1.1692"></a><span id="l1.1692" class="difflineminus">-    if (reference.IsEmpty())</span>
<a href="#l1.1693"></a><span id="l1.1693" class="difflineminus">-      break;</span>
<a href="#l1.1694"></a><span id="l1.1694" class="difflineplus">+    if (reference.IsEmpty()) break;</span>
<a href="#l1.1695"></a><span id="l1.1695"> </span>
<a href="#l1.1696"></a><span id="l1.1696">     rv = AddRefToHash(reference, thread);</span>
<a href="#l1.1697"></a><span id="l1.1697">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.1698"></a><span id="l1.1698">   }</span>
<a href="#l1.1699"></a><span id="l1.1699"> </span>
<a href="#l1.1700"></a><span id="l1.1700">   nsCString messageId;</span>
<a href="#l1.1701"></a><span id="l1.1701">   msgHdr-&gt;GetMessageId(getter_Copies(messageId));</span>
<a href="#l1.1702"></a><span id="l1.1702">   m_hdrsTable.Put(messageId, msgHdr);</span>
<a href="#l1.1703"></a><span id="l1.1703" class="difflineminus">-  if (!gReferenceOnlyThreading)</span>
<a href="#l1.1704"></a><span id="l1.1704" class="difflineminus">-  {</span>
<a href="#l1.1705"></a><span id="l1.1705" class="difflineplus">+  if (!gReferenceOnlyThreading) {</span>
<a href="#l1.1706"></a><span id="l1.1706">     nsCString subject;</span>
<a href="#l1.1707"></a><span id="l1.1707">     msgHdr-&gt;GetSubject(getter_Copies(subject));</span>
<a href="#l1.1708"></a><span id="l1.1708">     // if we're threading by subject, just treat subject as an other ref.</span>
<a href="#l1.1709"></a><span id="l1.1709">     AddRefToHash(subject, thread);</span>
<a href="#l1.1710"></a><span id="l1.1710">   }</span>
<a href="#l1.1711"></a><span id="l1.1711"> </span>
<a href="#l1.1712"></a><span id="l1.1712">   return AddRefToHash(messageId, thread);</span>
<a href="#l1.1713"></a><span id="l1.1713"> }</span>
<a href="#l1.1714"></a><span id="l1.1714"> </span>
<a href="#l1.1715"></a><span id="l1.1715" class="difflineminus">-nsresult</span>
<a href="#l1.1716"></a><span id="l1.1716" class="difflineminus">-nsMsgSearchDBView::RemoveRefFromHash(nsCString &amp;reference)</span>
<a href="#l1.1717"></a><span id="l1.1717" class="difflineminus">-{</span>
<a href="#l1.1718"></a><span id="l1.1718" class="difflineplus">+nsresult nsMsgSearchDBView::RemoveRefFromHash(nsCString &amp;reference) {</span>
<a href="#l1.1719"></a><span id="l1.1719">   m_threadsTable.Remove(reference);</span>
<a href="#l1.1720"></a><span id="l1.1720">   return NS_OK;</span>
<a href="#l1.1721"></a><span id="l1.1721"> }</span>
<a href="#l1.1722"></a><span id="l1.1722"> </span>
<a href="#l1.1723"></a><span id="l1.1723" class="difflineminus">-nsresult</span>
<a href="#l1.1724"></a><span id="l1.1724" class="difflineminus">-nsMsgSearchDBView::RemoveMsgFromHashTables(nsIMsgDBHdr *msgHdr)</span>
<a href="#l1.1725"></a><span id="l1.1725" class="difflineminus">-{</span>
<a href="#l1.1726"></a><span id="l1.1726" class="difflineplus">+nsresult nsMsgSearchDBView::RemoveMsgFromHashTables(nsIMsgDBHdr *msgHdr) {</span>
<a href="#l1.1727"></a><span id="l1.1727">   NS_ENSURE_ARG_POINTER(msgHdr);</span>
<a href="#l1.1728"></a><span id="l1.1728"> </span>
<a href="#l1.1729"></a><span id="l1.1729">   uint16_t numReferences = 0;</span>
<a href="#l1.1730"></a><span id="l1.1730">   nsresult rv = NS_OK;</span>
<a href="#l1.1731"></a><span id="l1.1731"> </span>
<a href="#l1.1732"></a><span id="l1.1732">   msgHdr-&gt;GetNumReferences(&amp;numReferences);</span>
<a href="#l1.1733"></a><span id="l1.1733"> </span>
<a href="#l1.1734"></a><span id="l1.1734" class="difflineminus">-  for (int32_t i = 0; i &lt; numReferences; i++)</span>
<a href="#l1.1735"></a><span id="l1.1735" class="difflineminus">-  {</span>
<a href="#l1.1736"></a><span id="l1.1736" class="difflineplus">+  for (int32_t i = 0; i &lt; numReferences; i++) {</span>
<a href="#l1.1737"></a><span id="l1.1737">     nsAutoCString reference;</span>
<a href="#l1.1738"></a><span id="l1.1738">     msgHdr-&gt;GetStringReference(i, reference);</span>
<a href="#l1.1739"></a><span id="l1.1739" class="difflineminus">-    if (reference.IsEmpty())</span>
<a href="#l1.1740"></a><span id="l1.1740" class="difflineminus">-      break;</span>
<a href="#l1.1741"></a><span id="l1.1741" class="difflineplus">+    if (reference.IsEmpty()) break;</span>
<a href="#l1.1742"></a><span id="l1.1742"> </span>
<a href="#l1.1743"></a><span id="l1.1743">     rv = RemoveRefFromHash(reference);</span>
<a href="#l1.1744"></a><span id="l1.1744" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l1.1745"></a><span id="l1.1745" class="difflineminus">-      break;</span>
<a href="#l1.1746"></a><span id="l1.1746" class="difflineplus">+    if (NS_FAILED(rv)) break;</span>
<a href="#l1.1747"></a><span id="l1.1747">   }</span>
<a href="#l1.1748"></a><span id="l1.1748"> </span>
<a href="#l1.1749"></a><span id="l1.1749">   nsCString messageId;</span>
<a href="#l1.1750"></a><span id="l1.1750">   msgHdr-&gt;GetMessageId(getter_Copies(messageId));</span>
<a href="#l1.1751"></a><span id="l1.1751">   m_hdrsTable.Remove(messageId);</span>
<a href="#l1.1752"></a><span id="l1.1752">   RemoveRefFromHash(messageId);</span>
<a href="#l1.1753"></a><span id="l1.1753" class="difflineminus">-  if (!gReferenceOnlyThreading)</span>
<a href="#l1.1754"></a><span id="l1.1754" class="difflineminus">-  {</span>
<a href="#l1.1755"></a><span id="l1.1755" class="difflineplus">+  if (!gReferenceOnlyThreading) {</span>
<a href="#l1.1756"></a><span id="l1.1756">     nsCString subject;</span>
<a href="#l1.1757"></a><span id="l1.1757">     msgHdr-&gt;GetSubject(getter_Copies(subject));</span>
<a href="#l1.1758"></a><span id="l1.1758">     // If we're threading by subject, just treat subject as an other ref.</span>
<a href="#l1.1759"></a><span id="l1.1759">     RemoveRefFromHash(subject);</span>
<a href="#l1.1760"></a><span id="l1.1760">   }</span>
<a href="#l1.1761"></a><span id="l1.1761"> </span>
<a href="#l1.1762"></a><span id="l1.1762">   return rv;</span>
<a href="#l1.1763"></a><span id="l1.1763"> }</span>
<a href="#l1.1764"></a><span id="l1.1764"> </span>
<a href="#l1.1765"></a><span id="l1.1765" class="difflineminus">-nsMsgGroupThread *nsMsgSearchDBView::CreateGroupThread(nsIMsgDatabase * /* db */)</span>
<a href="#l1.1766"></a><span id="l1.1766" class="difflineminus">-{</span>
<a href="#l1.1767"></a><span id="l1.1767" class="difflineplus">+nsMsgGroupThread *nsMsgSearchDBView::CreateGroupThread(</span>
<a href="#l1.1768"></a><span id="l1.1768" class="difflineplus">+    nsIMsgDatabase * /* db */) {</span>
<a href="#l1.1769"></a><span id="l1.1769">   return new nsMsgXFGroupThread();</span>
<a href="#l1.1770"></a><span id="l1.1770"> }</span>
<a href="#l1.1771"></a><span id="l1.1771"> </span>
<a href="#l1.1772"></a><span id="l1.1772"> NS_IMETHODIMP</span>
<a href="#l1.1773"></a><span id="l1.1773"> nsMsgSearchDBView::GetThreadContainingMsgHdr(nsIMsgDBHdr *msgHdr,</span>
<a href="#l1.1774"></a><span id="l1.1774" class="difflineminus">-                                             nsIMsgThread **pThread)</span>
<a href="#l1.1775"></a><span id="l1.1775" class="difflineminus">-{</span>
<a href="#l1.1776"></a><span id="l1.1776" class="difflineplus">+                                             nsIMsgThread **pThread) {</span>
<a href="#l1.1777"></a><span id="l1.1777">   if (m_viewFlags &amp; nsMsgViewFlagsType::kGroupBySort)</span>
<a href="#l1.1778"></a><span id="l1.1778">     return nsMsgGroupView::GetThreadContainingMsgHdr(msgHdr, pThread);</span>
<a href="#l1.1779"></a><span id="l1.1779">   else if (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay)</span>
<a href="#l1.1780"></a><span id="l1.1780">     return GetXFThreadFromMsgHdr(msgHdr, pThread);</span>
<a href="#l1.1781"></a><span id="l1.1781"> </span>
<a href="#l1.1782"></a><span id="l1.1782">   // If not threaded, use the real thread.</span>
<a href="#l1.1783"></a><span id="l1.1783">   nsCOMPtr&lt;nsIMsgDatabase&gt; msgDB;</span>
<a href="#l1.1784"></a><span id="l1.1784">   nsresult rv = GetDBForHeader(msgHdr, getter_AddRefs(msgDB));</span>
<a href="#l1.1785"></a><span id="l1.1785">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.1786"></a><span id="l1.1786">   return msgDB-&gt;GetThreadContainingMsgHdr(msgHdr, pThread);</span>
<a href="#l1.1787"></a><span id="l1.1787"> }</span>
<a href="#l1.1788"></a><span id="l1.1788"> </span>
<a href="#l1.1789"></a><span id="l1.1789" class="difflineminus">-nsresult</span>
<a href="#l1.1790"></a><span id="l1.1790" class="difflineminus">-nsMsgSearchDBView::ListIdsInThread(nsIMsgThread *threadHdr,</span>
<a href="#l1.1791"></a><span id="l1.1791" class="difflineminus">-                                   nsMsgViewIndex startOfThreadViewIndex,</span>
<a href="#l1.1792"></a><span id="l1.1792" class="difflineminus">-                                   uint32_t *pNumListed)</span>
<a href="#l1.1793"></a><span id="l1.1793" class="difflineminus">-{</span>
<a href="#l1.1794"></a><span id="l1.1794" class="difflineplus">+nsresult nsMsgSearchDBView::ListIdsInThread(</span>
<a href="#l1.1795"></a><span id="l1.1795" class="difflineplus">+    nsIMsgThread *threadHdr, nsMsgViewIndex startOfThreadViewIndex,</span>
<a href="#l1.1796"></a><span id="l1.1796" class="difflineplus">+    uint32_t *pNumListed) {</span>
<a href="#l1.1797"></a><span id="l1.1797">   NS_ENSURE_ARG_POINTER(threadHdr);</span>
<a href="#l1.1798"></a><span id="l1.1798">   NS_ENSURE_ARG_POINTER(pNumListed);</span>
<a href="#l1.1799"></a><span id="l1.1799"> </span>
<a href="#l1.1800"></a><span id="l1.1800">   // These children ids should be in thread order.</span>
<a href="#l1.1801"></a><span id="l1.1801">   uint32_t i;</span>
<a href="#l1.1802"></a><span id="l1.1802">   nsMsgViewIndex viewIndex = startOfThreadViewIndex + 1;</span>
<a href="#l1.1803"></a><span id="l1.1803">   *pNumListed = 0;</span>
<a href="#l1.1804"></a><span id="l1.1804"> </span>
<a href="#l1.1805"></a><span id="l1.1805">   uint32_t numChildren;</span>
<a href="#l1.1806"></a><span id="l1.1806">   threadHdr-&gt;GetNumChildren(&amp;numChildren);</span>
<a href="#l1.1807"></a><span id="l1.1807">   NS_ASSERTION(numChildren, &quot;Empty thread in view/db&quot;);</span>
<a href="#l1.1808"></a><span id="l1.1808" class="difflineminus">-  if (!numChildren)</span>
<a href="#l1.1809"></a><span id="l1.1809" class="difflineminus">-    return NS_OK;</span>
<a href="#l1.1810"></a><span id="l1.1810" class="difflineplus">+  if (!numChildren) return NS_OK;</span>
<a href="#l1.1811"></a><span id="l1.1811"> </span>
<a href="#l1.1812"></a><span id="l1.1812">   // Account for the existing thread root.</span>
<a href="#l1.1813"></a><span id="l1.1813">   numChildren--;</span>
<a href="#l1.1814"></a><span id="l1.1814" class="difflineminus">-  if (!InsertEmptyRows(viewIndex, numChildren))</span>
<a href="#l1.1815"></a><span id="l1.1815" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l1.1816"></a><span id="l1.1816" class="difflineplus">+  if (!InsertEmptyRows(viewIndex, numChildren)) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l1.1817"></a><span id="l1.1817"> </span>
<a href="#l1.1818"></a><span id="l1.1818">   bool threadedView = m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay &amp;&amp;</span>
<a href="#l1.1819"></a><span id="l1.1819">                       !(m_viewFlags &amp; nsMsgViewFlagsType::kGroupBySort);</span>
<a href="#l1.1820"></a><span id="l1.1820">   nsMsgXFViewThread *viewThread;</span>
<a href="#l1.1821"></a><span id="l1.1821" class="difflineminus">-  if (threadedView)</span>
<a href="#l1.1822"></a><span id="l1.1822" class="difflineminus">-    viewThread = static_cast&lt;nsMsgXFViewThread*&gt;(threadHdr);</span>
<a href="#l1.1823"></a><span id="l1.1823" class="difflineplus">+  if (threadedView) viewThread = static_cast&lt;nsMsgXFViewThread *&gt;(threadHdr);</span>
<a href="#l1.1824"></a><span id="l1.1824"> </span>
<a href="#l1.1825"></a><span id="l1.1825" class="difflineminus">-  for (i = 1; i &lt;= numChildren; i++)</span>
<a href="#l1.1826"></a><span id="l1.1826" class="difflineminus">-  {</span>
<a href="#l1.1827"></a><span id="l1.1827" class="difflineplus">+  for (i = 1; i &lt;= numChildren; i++) {</span>
<a href="#l1.1828"></a><span id="l1.1828">     nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.1829"></a><span id="l1.1829">     threadHdr-&gt;GetChildHdrAt(i, getter_AddRefs(msgHdr));</span>
<a href="#l1.1830"></a><span id="l1.1830"> </span>
<a href="#l1.1831"></a><span id="l1.1831" class="difflineminus">-    if (msgHdr)</span>
<a href="#l1.1832"></a><span id="l1.1832" class="difflineminus">-    {</span>
<a href="#l1.1833"></a><span id="l1.1833" class="difflineplus">+    if (msgHdr) {</span>
<a href="#l1.1834"></a><span id="l1.1834">       nsMsgKey msgKey;</span>
<a href="#l1.1835"></a><span id="l1.1835">       uint32_t msgFlags;</span>
<a href="#l1.1836"></a><span id="l1.1836">       msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l1.1837"></a><span id="l1.1837">       msgHdr-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l1.1838"></a><span id="l1.1838">       uint8_t level = (threadedView) ? viewThread-&gt;ChildLevelAt(i) : 1;</span>
<a href="#l1.1839"></a><span id="l1.1839">       SetMsgHdrAt(msgHdr, viewIndex, msgKey, msgFlags &amp; ~MSG_VIEW_FLAGS, level);</span>
<a href="#l1.1840"></a><span id="l1.1840">       (*pNumListed)++;</span>
<a href="#l1.1841"></a><span id="l1.1841">       viewIndex++;</span>
<a href="#l1.1842"></a><span id="l1.1842">     }</span>
<a href="#l1.1843"></a><span id="l1.1843">   }</span>
<a href="#l1.1844"></a><span id="l1.1844"> </span>
<a href="#l1.1845"></a><span id="l1.1845">   return NS_OK;</span>
<a href="#l1.1846"></a><span id="l1.1846"> }</span>
<a href="#l1.1847"></a><span id="l1.1847"> </span>
<a href="#l1.1848"></a><span id="l1.1848"> NS_IMETHODIMP</span>
<a href="#l1.1849"></a><span id="l1.1849" class="difflineminus">-nsMsgSearchDBView::GetNumMsgsInView(int32_t *aNumMsgs)</span>
<a href="#l1.1850"></a><span id="l1.1850" class="difflineminus">-{</span>
<a href="#l1.1851"></a><span id="l1.1851" class="difflineplus">+nsMsgSearchDBView::GetNumMsgsInView(int32_t *aNumMsgs) {</span>
<a href="#l1.1852"></a><span id="l1.1852">   NS_ENSURE_ARG_POINTER(aNumMsgs);</span>
<a href="#l1.1853"></a><span id="l1.1853">   *aNumMsgs = m_totalMessagesInView;</span>
<a href="#l1.1854"></a><span id="l1.1854">   return NS_OK;</span>
<a href="#l1.1855"></a><span id="l1.1855"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/base/src/nsMsgSearchDBView.h</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgSearchDBView.h</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -12,157 +12,164 @@</span>
<a href="#l2.4"></a><span id="l2.4"> #include &quot;nsIMsgSearchNotify.h&quot;</span>
<a href="#l2.5"></a><span id="l2.5"> #include &quot;nsMsgXFViewThread.h&quot;</span>
<a href="#l2.6"></a><span id="l2.6"> #include &quot;nsCOMArray.h&quot;</span>
<a href="#l2.7"></a><span id="l2.7"> #include &quot;mozilla/UniquePtr.h&quot;</span>
<a href="#l2.8"></a><span id="l2.8"> #include &quot;nsIWeakReferenceUtils.h&quot;</span>
<a href="#l2.9"></a><span id="l2.9"> </span>
<a href="#l2.10"></a><span id="l2.10"> class nsMsgSearchDBView : public nsMsgGroupView,</span>
<a href="#l2.11"></a><span id="l2.11">                           public nsIMsgCopyServiceListener,</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-                          public nsIMsgSearchNotify</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-{</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-public:</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+                          public nsIMsgSearchNotify {</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+ public:</span>
<a href="#l2.17"></a><span id="l2.17">   nsMsgSearchDBView();</span>
<a href="#l2.18"></a><span id="l2.18"> </span>
<a href="#l2.19"></a><span id="l2.19">   // these are tied together pretty intimately</span>
<a href="#l2.20"></a><span id="l2.20">   friend class nsMsgXFViewThread;</span>
<a href="#l2.21"></a><span id="l2.21"> </span>
<a href="#l2.22"></a><span id="l2.22">   NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l2.23"></a><span id="l2.23">   NS_DECL_NSIMSGSEARCHNOTIFY</span>
<a href="#l2.24"></a><span id="l2.24">   NS_DECL_NSIMSGCOPYSERVICELISTENER</span>
<a href="#l2.25"></a><span id="l2.25"> </span>
<a href="#l2.26"></a><span id="l2.26">   NS_IMETHOD SetSearchSession(nsIMsgSearchSession *aSearchSession) override;</span>
<a href="#l2.27"></a><span id="l2.27"> </span>
<a href="#l2.28"></a><span id="l2.28">   virtual const char *GetViewName(void) override { return &quot;SearchView&quot;; }</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineminus">-  NS_IMETHOD Open(nsIMsgFolder *folder,</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineminus">-                  nsMsgViewSortTypeValue sortType,</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+  NS_IMETHOD Open(nsIMsgFolder *folder, nsMsgViewSortTypeValue sortType,</span>
<a href="#l2.32"></a><span id="l2.32">                   nsMsgViewSortOrderValue sortOrder,</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineminus">-                  nsMsgViewFlagsTypeValue viewFlags,</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineminus">-                  int32_t *pCount) override;</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+                  nsMsgViewFlagsTypeValue viewFlags, int32_t *pCount) override;</span>
<a href="#l2.36"></a><span id="l2.36">   NS_IMETHOD CloneDBView(nsIMessenger *aMessengerInstance,</span>
<a href="#l2.37"></a><span id="l2.37">                          nsIMsgWindow *aMsgWindow,</span>
<a href="#l2.38"></a><span id="l2.38">                          nsIMsgDBViewCommandUpdater *aCmdUpdater,</span>
<a href="#l2.39"></a><span id="l2.39">                          nsIMsgDBView **_retval) override;</span>
<a href="#l2.40"></a><span id="l2.40">   NS_IMETHOD CopyDBView(nsMsgDBView *aNewMsgDBView,</span>
<a href="#l2.41"></a><span id="l2.41">                         nsIMessenger *aMessengerInstance,</span>
<a href="#l2.42"></a><span id="l2.42">                         nsIMsgWindow *aMsgWindow,</span>
<a href="#l2.43"></a><span id="l2.43">                         nsIMsgDBViewCommandUpdater *aCmdUpdater) override;</span>
<a href="#l2.44"></a><span id="l2.44">   NS_IMETHOD Close() override;</span>
<a href="#l2.45"></a><span id="l2.45">   NS_IMETHOD GetViewType(nsMsgViewTypeValue *aViewType) override;</span>
<a href="#l2.46"></a><span id="l2.46">   NS_IMETHOD Sort(nsMsgViewSortTypeValue sortType,</span>
<a href="#l2.47"></a><span id="l2.47">                   nsMsgViewSortOrderValue sortOrder) override;</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineminus">-  NS_IMETHOD GetCommandStatus(nsMsgViewCommandTypeValue command,</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineminus">-                              bool *selectable_p,</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineminus">-                              nsMsgViewCommandCheckStateValue *selected_p) override;</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+  NS_IMETHOD GetCommandStatus(</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineplus">+      nsMsgViewCommandTypeValue command, bool *selectable_p,</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineplus">+      nsMsgViewCommandCheckStateValue *selected_p) override;</span>
<a href="#l2.54"></a><span id="l2.54">   NS_IMETHOD DoCommand(nsMsgViewCommandTypeValue command) override;</span>
<a href="#l2.55"></a><span id="l2.55">   NS_IMETHOD DoCommandWithFolder(nsMsgViewCommandTypeValue command,</span>
<a href="#l2.56"></a><span id="l2.56">                                  nsIMsgFolder *destFolder) override;</span>
<a href="#l2.57"></a><span id="l2.57">   NS_IMETHOD GetHdrForFirstSelectedMessage(nsIMsgDBHdr **hdr) override;</span>
<a href="#l2.58"></a><span id="l2.58">   NS_IMETHOD OpenWithHdrs(nsISimpleEnumerator *aHeaders,</span>
<a href="#l2.59"></a><span id="l2.59">                           nsMsgViewSortTypeValue aSortType,</span>
<a href="#l2.60"></a><span id="l2.60">                           nsMsgViewSortOrderValue aSortOrder,</span>
<a href="#l2.61"></a><span id="l2.61">                           nsMsgViewFlagsTypeValue aViewFlags,</span>
<a href="#l2.62"></a><span id="l2.62">                           int32_t *aCount) override;</span>
<a href="#l2.63"></a><span id="l2.63">   NS_IMETHOD OnHdrDeleted(nsIMsgDBHdr *aHdrDeleted, nsMsgKey aParentKey,</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineminus">-                          int32_t aFlags, nsIDBChangeListener *aInstigator) override;</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineplus">+                          int32_t aFlags,</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineplus">+                          nsIDBChangeListener *aInstigator) override;</span>
<a href="#l2.67"></a><span id="l2.67">   NS_IMETHOD OnHdrFlagsChanged(nsIMsgDBHdr *aHdrChanged, uint32_t aOldFlags,</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineminus">-                               uint32_t aNewFlags, nsIDBChangeListener *aInstigator) override;</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineplus">+                               uint32_t aNewFlags,</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineplus">+                               nsIDBChangeListener *aInstigator) override;</span>
<a href="#l2.71"></a><span id="l2.71">   NS_IMETHOD GetNumMsgsInView(int32_t *aNumMsgs) override;</span>
<a href="#l2.72"></a><span id="l2.72">   // override to get location</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineminus">-  NS_IMETHOD GetCellText(int32_t aRow, nsTreeColumn* aCol, nsAString&amp; aValue) override;</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineminus">-  virtual nsresult GetMsgHdrForViewIndex(nsMsgViewIndex index, nsIMsgDBHdr **msgHdr) override;</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineminus">-  virtual nsresult OnNewHeader(nsIMsgDBHdr *newHdr,</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineminus">-                               nsMsgKey parentKey,</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineplus">+  NS_IMETHOD GetCellText(int32_t aRow, nsTreeColumn *aCol,</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineplus">+                         nsAString &amp;aValue) override;</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineplus">+  virtual nsresult GetMsgHdrForViewIndex(nsMsgViewIndex index,</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineplus">+                                         nsIMsgDBHdr **msgHdr) override;</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineplus">+  virtual nsresult OnNewHeader(nsIMsgDBHdr *newHdr, nsMsgKey parentKey,</span>
<a href="#l2.82"></a><span id="l2.82">                                bool ensureListed) override;</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineminus">-  NS_IMETHOD GetFolderForViewIndex(nsMsgViewIndex index, nsIMsgFolder **folder) override;</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineplus">+  NS_IMETHOD GetFolderForViewIndex(nsMsgViewIndex index,</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineplus">+                                   nsIMsgFolder **folder) override;</span>
<a href="#l2.86"></a><span id="l2.86"> </span>
<a href="#l2.87"></a><span id="l2.87">   NS_IMETHOD OnAnnouncerGoingAway(nsIDBChangeAnnouncer *instigator) override;</span>
<a href="#l2.88"></a><span id="l2.88"> </span>
<a href="#l2.89"></a><span id="l2.89" class="difflineminus">-  virtual nsCOMArray&lt;nsIMsgFolder&gt;* GetFolders() override;</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineminus">-  virtual nsresult GetFolderFromMsgURI(const char *aMsgURI, nsIMsgFolder **aFolder) override;</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineplus">+  virtual nsCOMArray&lt;nsIMsgFolder&gt; *GetFolders() override;</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineplus">+  virtual nsresult GetFolderFromMsgURI(const char *aMsgURI,</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineplus">+                                       nsIMsgFolder **aFolder) override;</span>
<a href="#l2.94"></a><span id="l2.94"> </span>
<a href="#l2.95"></a><span id="l2.95" class="difflineminus">-  NS_IMETHOD GetThreadContainingMsgHdr(nsIMsgDBHdr *msgHdr, nsIMsgThread **pThread) override;</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineplus">+  NS_IMETHOD GetThreadContainingMsgHdr(nsIMsgDBHdr *msgHdr,</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineplus">+                                       nsIMsgThread **pThread) override;</span>
<a href="#l2.98"></a><span id="l2.98"> </span>
<a href="#l2.99"></a><span id="l2.99" class="difflineminus">-protected:</span>
<a href="#l2.100"></a><span id="l2.100" class="difflineplus">+ protected:</span>
<a href="#l2.101"></a><span id="l2.101">   virtual ~nsMsgSearchDBView();</span>
<a href="#l2.102"></a><span id="l2.102">   virtual void InternalClose() override;</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineminus">-  virtual nsresult HashHdr(nsIMsgDBHdr *msgHdr, nsString&amp; aHashKey) override;</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineplus">+  virtual nsresult HashHdr(nsIMsgDBHdr *msgHdr, nsString &amp;aHashKey) override;</span>
<a href="#l2.105"></a><span id="l2.105">   virtual nsresult ListIdsInThread(nsIMsgThread *threadHdr,</span>
<a href="#l2.106"></a><span id="l2.106">                                    nsMsgViewIndex startOfThreadViewIndex,</span>
<a href="#l2.107"></a><span id="l2.107">                                    uint32_t *pNumListed) override;</span>
<a href="#l2.108"></a><span id="l2.108" class="difflineminus">-  nsresult FetchLocation(int32_t aRow, nsAString&amp; aLocationString);</span>
<a href="#l2.109"></a><span id="l2.109" class="difflineplus">+  nsresult FetchLocation(int32_t aRow, nsAString &amp;aLocationString);</span>
<a href="#l2.110"></a><span id="l2.110">   virtual nsresult AddHdrFromFolder(nsIMsgDBHdr *msgHdr, nsIMsgFolder *folder);</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineminus">-  virtual nsresult GetDBForViewIndex(nsMsgViewIndex index, nsIMsgDatabase **db) override;</span>
<a href="#l2.112"></a><span id="l2.112" class="difflineplus">+  virtual nsresult GetDBForViewIndex(nsMsgViewIndex index,</span>
<a href="#l2.113"></a><span id="l2.113" class="difflineplus">+                                     nsIMsgDatabase **db) override;</span>
<a href="#l2.114"></a><span id="l2.114">   virtual nsresult RemoveByIndex(nsMsgViewIndex index) override;</span>
<a href="#l2.115"></a><span id="l2.115" class="difflineminus">-  virtual nsresult CopyMessages(nsIMsgWindow *window,</span>
<a href="#l2.116"></a><span id="l2.116" class="difflineminus">-                                nsMsgViewIndex *indices,</span>
<a href="#l2.117"></a><span id="l2.117" class="difflineminus">-                                int32_t numIndices,</span>
<a href="#l2.118"></a><span id="l2.118" class="difflineminus">-                                bool isMove,</span>
<a href="#l2.119"></a><span id="l2.119" class="difflineplus">+  virtual nsresult CopyMessages(nsIMsgWindow *window, nsMsgViewIndex *indices,</span>
<a href="#l2.120"></a><span id="l2.120" class="difflineplus">+                                int32_t numIndices, bool isMove,</span>
<a href="#l2.121"></a><span id="l2.121">                                 nsIMsgFolder *destFolder) override;</span>
<a href="#l2.122"></a><span id="l2.122" class="difflineminus">-  virtual nsresult DeleteMessages(nsIMsgWindow *window,</span>
<a href="#l2.123"></a><span id="l2.123" class="difflineminus">-                                  nsMsgViewIndex *indices,</span>
<a href="#l2.124"></a><span id="l2.124" class="difflineplus">+  virtual nsresult DeleteMessages(nsIMsgWindow *window, nsMsgViewIndex *indices,</span>
<a href="#l2.125"></a><span id="l2.125">                                   int32_t numIndices,</span>
<a href="#l2.126"></a><span id="l2.126">                                   bool deleteStorage) override;</span>
<a href="#l2.127"></a><span id="l2.127">   virtual void InsertMsgHdrAt(nsMsgViewIndex index, nsIMsgDBHdr *hdr,</span>
<a href="#l2.128"></a><span id="l2.128" class="difflineminus">-                              nsMsgKey msgKey, uint32_t flags, uint32_t level) override;</span>
<a href="#l2.129"></a><span id="l2.129" class="difflineplus">+                              nsMsgKey msgKey, uint32_t flags,</span>
<a href="#l2.130"></a><span id="l2.130" class="difflineplus">+                              uint32_t level) override;</span>
<a href="#l2.131"></a><span id="l2.131">   virtual void SetMsgHdrAt(nsIMsgDBHdr *hdr, nsMsgViewIndex index,</span>
<a href="#l2.132"></a><span id="l2.132" class="difflineminus">-                           nsMsgKey msgKey, uint32_t flags, uint32_t level) override;</span>
<a href="#l2.133"></a><span id="l2.133" class="difflineminus">-  virtual bool InsertEmptyRows(nsMsgViewIndex viewIndex, int32_t numRows) override;</span>
<a href="#l2.134"></a><span id="l2.134" class="difflineplus">+                           nsMsgKey msgKey, uint32_t flags,</span>
<a href="#l2.135"></a><span id="l2.135" class="difflineplus">+                           uint32_t level) override;</span>
<a href="#l2.136"></a><span id="l2.136" class="difflineplus">+  virtual bool InsertEmptyRows(nsMsgViewIndex viewIndex,</span>
<a href="#l2.137"></a><span id="l2.137" class="difflineplus">+                               int32_t numRows) override;</span>
<a href="#l2.138"></a><span id="l2.138">   virtual void RemoveRows(nsMsgViewIndex viewIndex, int32_t numRows) override;</span>
<a href="#l2.139"></a><span id="l2.139" class="difflineminus">-  virtual nsMsgViewIndex FindHdr(nsIMsgDBHdr *msgHdr, nsMsgViewIndex startIndex = 0,</span>
<a href="#l2.140"></a><span id="l2.140" class="difflineminus">-                                 bool allowDummy=false) override;</span>
<a href="#l2.141"></a><span id="l2.141" class="difflineminus">-  nsresult GetFoldersAndHdrsForSelection(nsMsgViewIndex *indices, int32_t numIndices);</span>
<a href="#l2.142"></a><span id="l2.142" class="difflineplus">+  virtual nsMsgViewIndex FindHdr(nsIMsgDBHdr *msgHdr,</span>
<a href="#l2.143"></a><span id="l2.143" class="difflineplus">+                                 nsMsgViewIndex startIndex = 0,</span>
<a href="#l2.144"></a><span id="l2.144" class="difflineplus">+                                 bool allowDummy = false) override;</span>
<a href="#l2.145"></a><span id="l2.145" class="difflineplus">+  nsresult GetFoldersAndHdrsForSelection(nsMsgViewIndex *indices,</span>
<a href="#l2.146"></a><span id="l2.146" class="difflineplus">+                                         int32_t numIndices);</span>
<a href="#l2.147"></a><span id="l2.147">   nsresult GroupSearchResultsByFolder();</span>
<a href="#l2.148"></a><span id="l2.148" class="difflineminus">-  nsresult PartitionSelectionByFolder(nsMsgViewIndex *indices,</span>
<a href="#l2.149"></a><span id="l2.149" class="difflineminus">-                                      int32_t numIndices,</span>
<a href="#l2.150"></a><span id="l2.150" class="difflineminus">-                                      mozilla::UniquePtr&lt;nsTArray&lt;uint32_t&gt;[]&gt; &amp;indexArrays,</span>
<a href="#l2.151"></a><span id="l2.151" class="difflineminus">-                                      int32_t *numArrays);</span>
<a href="#l2.152"></a><span id="l2.152" class="difflineplus">+  nsresult PartitionSelectionByFolder(</span>
<a href="#l2.153"></a><span id="l2.153" class="difflineplus">+      nsMsgViewIndex *indices, int32_t numIndices,</span>
<a href="#l2.154"></a><span id="l2.154" class="difflineplus">+      mozilla::UniquePtr&lt;nsTArray&lt;uint32_t&gt;[]&gt; &amp;indexArrays,</span>
<a href="#l2.155"></a><span id="l2.155" class="difflineplus">+      int32_t *numArrays);</span>
<a href="#l2.156"></a><span id="l2.156"> </span>
<a href="#l2.157"></a><span id="l2.157" class="difflineminus">-  virtual nsresult ApplyCommandToIndicesWithFolder(nsMsgViewCommandTypeValue command,</span>
<a href="#l2.158"></a><span id="l2.158" class="difflineminus">-                                                   nsMsgViewIndex* indices,</span>
<a href="#l2.159"></a><span id="l2.159" class="difflineminus">-                                                   int32_t numIndices,</span>
<a href="#l2.160"></a><span id="l2.160" class="difflineminus">-                                                   nsIMsgFolder *destFolder) override;</span>
<a href="#l2.161"></a><span id="l2.161" class="difflineplus">+  virtual nsresult ApplyCommandToIndicesWithFolder(</span>
<a href="#l2.162"></a><span id="l2.162" class="difflineplus">+      nsMsgViewCommandTypeValue command, nsMsgViewIndex *indices,</span>
<a href="#l2.163"></a><span id="l2.163" class="difflineplus">+      int32_t numIndices, nsIMsgFolder *destFolder) override;</span>
<a href="#l2.164"></a><span id="l2.164">   void MoveThreadAt(nsMsgViewIndex threadIndex);</span>
<a href="#l2.165"></a><span id="l2.165"> </span>
<a href="#l2.166"></a><span id="l2.166" class="difflineminus">-  virtual nsresult GetMessageEnumerator(nsISimpleEnumerator **enumerator) override;</span>
<a href="#l2.167"></a><span id="l2.167" class="difflineminus">-  virtual nsresult InsertHdrFromFolder(nsIMsgDBHdr *msgHdr, nsIMsgFolder *folder);</span>
<a href="#l2.168"></a><span id="l2.168" class="difflineplus">+  virtual nsresult GetMessageEnumerator(</span>
<a href="#l2.169"></a><span id="l2.169" class="difflineplus">+      nsISimpleEnumerator **enumerator) override;</span>
<a href="#l2.170"></a><span id="l2.170" class="difflineplus">+  virtual nsresult InsertHdrFromFolder(nsIMsgDBHdr *msgHdr,</span>
<a href="#l2.171"></a><span id="l2.171" class="difflineplus">+                                       nsIMsgFolder *folder);</span>
<a href="#l2.172"></a><span id="l2.172"> </span>
<a href="#l2.173"></a><span id="l2.173">   nsCOMArray&lt;nsIMsgFolder&gt; m_folders;</span>
<a href="#l2.174"></a><span id="l2.174">   nsCOMArray&lt;nsIMutableArray&gt; m_hdrsForEachFolder;</span>
<a href="#l2.175"></a><span id="l2.175">   nsCOMArray&lt;nsIMsgFolder&gt; m_uniqueFoldersSelected;</span>
<a href="#l2.176"></a><span id="l2.176">   uint32_t mCurIndex;</span>
<a href="#l2.177"></a><span id="l2.177"> </span>
<a href="#l2.178"></a><span id="l2.178" class="difflineminus">-  nsMsgViewIndex* mIndicesForChainedDeleteAndFile;</span>
<a href="#l2.179"></a><span id="l2.179" class="difflineplus">+  nsMsgViewIndex *mIndicesForChainedDeleteAndFile;</span>
<a href="#l2.180"></a><span id="l2.180">   int32_t mTotalIndices;</span>
<a href="#l2.181"></a><span id="l2.181">   nsCOMArray&lt;nsIMsgDatabase&gt; m_dbToUseList;</span>
<a href="#l2.182"></a><span id="l2.182">   nsMsgViewCommandTypeValue mCommand;</span>
<a href="#l2.183"></a><span id="l2.183" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFolder&gt; mDestFolder;</span>
<a href="#l2.184"></a><span id="l2.184" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; mDestFolder;</span>
<a href="#l2.185"></a><span id="l2.185">   nsWeakPtr m_searchSession;</span>
<a href="#l2.186"></a><span id="l2.186"> </span>
<a href="#l2.187"></a><span id="l2.187">   nsresult ProcessRequestsInOneFolder(nsIMsgWindow *window);</span>
<a href="#l2.188"></a><span id="l2.188">   nsresult ProcessRequestsInAllFolders(nsIMsgWindow *window);</span>
<a href="#l2.189"></a><span id="l2.189">   // these are for doing threading of the search hits</span>
<a href="#l2.190"></a><span id="l2.190"> </span>
<a href="#l2.191"></a><span id="l2.191">   // used for assigning thread id's to xfview threads.</span>
<a href="#l2.192"></a><span id="l2.192">   nsMsgKey m_nextThreadId;</span>
<a href="#l2.193"></a><span id="l2.193">   // this maps message-ids and reference message ids to</span>
<a href="#l2.194"></a><span id="l2.194">   // the corresponding nsMsgXFViewThread object. If we're</span>
<a href="#l2.195"></a><span id="l2.195">   // doing subject threading, we would throw subjects</span>
<a href="#l2.196"></a><span id="l2.196">   // into the same table.</span>
<a href="#l2.197"></a><span id="l2.197" class="difflineminus">-  nsInterfaceHashtable &lt;nsCStringHashKey, nsIMsgThread&gt; m_threadsTable;</span>
<a href="#l2.198"></a><span id="l2.198" class="difflineplus">+  nsInterfaceHashtable&lt;nsCStringHashKey, nsIMsgThread&gt; m_threadsTable;</span>
<a href="#l2.199"></a><span id="l2.199"> </span>
<a href="#l2.200"></a><span id="l2.200">   // map message-ids to msg hdrs in the view, used for threading.</span>
<a href="#l2.201"></a><span id="l2.201" class="difflineminus">-  nsInterfaceHashtable &lt;nsCStringHashKey, nsIMsgDBHdr&gt; m_hdrsTable;</span>
<a href="#l2.202"></a><span id="l2.202" class="difflineplus">+  nsInterfaceHashtable&lt;nsCStringHashKey, nsIMsgDBHdr&gt; m_hdrsTable;</span>
<a href="#l2.203"></a><span id="l2.203">   uint32_t m_totalMessagesInView;</span>
<a href="#l2.204"></a><span id="l2.204"> </span>
<a href="#l2.205"></a><span id="l2.205">   virtual nsMsgGroupThread *CreateGroupThread(nsIMsgDatabase *db) override;</span>
<a href="#l2.206"></a><span id="l2.206">   nsresult GetXFThreadFromMsgHdr(nsIMsgDBHdr *msgHdr, nsIMsgThread **pThread,</span>
<a href="#l2.207"></a><span id="l2.207">                                  bool *foundByMessageId = nullptr);</span>
<a href="#l2.208"></a><span id="l2.208" class="difflineminus">-  bool     GetThreadFromHash(nsCString &amp;reference, nsIMsgThread **thread);</span>
<a href="#l2.209"></a><span id="l2.209" class="difflineminus">-  bool     GetMsgHdrFromHash(nsCString &amp;reference, nsIMsgDBHdr **hdr);</span>
<a href="#l2.210"></a><span id="l2.210" class="difflineplus">+  bool GetThreadFromHash(nsCString &amp;reference, nsIMsgThread **thread);</span>
<a href="#l2.211"></a><span id="l2.211" class="difflineplus">+  bool GetMsgHdrFromHash(nsCString &amp;reference, nsIMsgDBHdr **hdr);</span>
<a href="#l2.212"></a><span id="l2.212">   nsresult AddRefToHash(nsCString &amp;reference, nsIMsgThread *thread);</span>
<a href="#l2.213"></a><span id="l2.213">   nsresult AddMsgToHashTables(nsIMsgDBHdr *msgHdr, nsIMsgThread *thread);</span>
<a href="#l2.214"></a><span id="l2.214">   nsresult RemoveRefFromHash(nsCString &amp;reference);</span>
<a href="#l2.215"></a><span id="l2.215">   nsresult RemoveMsgFromHashTables(nsIMsgDBHdr *msgHdr);</span>
<a href="#l2.216"></a><span id="l2.216">   nsresult InitRefHash();</span>
<a href="#l2.217"></a><span id="l2.217"> };</span>
<a href="#l2.218"></a><span id="l2.218"> </span>
<a href="#l2.219"></a><span id="l2.219"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/base/src/nsMsgSpecialViews.cpp</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgSpecialViews.cpp</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -4,168 +4,160 @@</span>
<a href="#l3.4"></a><span id="l3.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l3.5"></a><span id="l3.5"> </span>
<a href="#l3.6"></a><span id="l3.6"> #include &quot;msgCore.h&quot;</span>
<a href="#l3.7"></a><span id="l3.7"> #include &quot;nsMsgSpecialViews.h&quot;</span>
<a href="#l3.8"></a><span id="l3.8"> #include &quot;nsIMsgThread.h&quot;</span>
<a href="#l3.9"></a><span id="l3.9"> #include &quot;nsMsgMessageFlags.h&quot;</span>
<a href="#l3.10"></a><span id="l3.10"> </span>
<a href="#l3.11"></a><span id="l3.11"> nsMsgThreadsWithUnreadDBView::nsMsgThreadsWithUnreadDBView()</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-: m_totalUnwantedMessagesInView(0)</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-{</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+    : m_totalUnwantedMessagesInView(0) {}</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+nsMsgThreadsWithUnreadDBView::~nsMsgThreadsWithUnreadDBView() {}</span>
<a href="#l3.17"></a><span id="l3.17"> </span>
<a href="#l3.18"></a><span id="l3.18" class="difflineminus">-}</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineminus">-</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineminus">-nsMsgThreadsWithUnreadDBView::~nsMsgThreadsWithUnreadDBView()</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineminus">-{</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+NS_IMETHODIMP nsMsgThreadsWithUnreadDBView::GetViewType(</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+    nsMsgViewTypeValue *aViewType) {</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aViewType);</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+  *aViewType = nsMsgViewType::eShowThreadsWithUnread;</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+  return NS_OK;</span>
<a href="#l3.27"></a><span id="l3.27"> }</span>
<a href="#l3.28"></a><span id="l3.28"> </span>
<a href="#l3.29"></a><span id="l3.29" class="difflineminus">-NS_IMETHODIMP nsMsgThreadsWithUnreadDBView::GetViewType(nsMsgViewTypeValue *aViewType)</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineminus">-{</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aViewType);</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineminus">-    *aViewType = nsMsgViewType::eShowThreadsWithUnread;</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineminus">-    return NS_OK;</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineminus">-}</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineminus">-</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineminus">-bool nsMsgThreadsWithUnreadDBView::WantsThisThread(nsIMsgThread *threadHdr)</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineminus">-{</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineminus">-  if (threadHdr)</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineminus">-  {</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+bool nsMsgThreadsWithUnreadDBView::WantsThisThread(nsIMsgThread *threadHdr) {</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+  if (threadHdr) {</span>
<a href="#l3.42"></a><span id="l3.42">     uint32_t numNewChildren;</span>
<a href="#l3.43"></a><span id="l3.43"> </span>
<a href="#l3.44"></a><span id="l3.44">     threadHdr-&gt;GetNumUnreadChildren(&amp;numNewChildren);</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineminus">-    if (numNewChildren &gt; 0)</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineminus">-      return true;</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+    if (numNewChildren &gt; 0) return true;</span>
<a href="#l3.48"></a><span id="l3.48">     uint32_t numChildren;</span>
<a href="#l3.49"></a><span id="l3.49">     threadHdr-&gt;GetNumChildren(&amp;numChildren);</span>
<a href="#l3.50"></a><span id="l3.50">     m_totalUnwantedMessagesInView += numChildren;</span>
<a href="#l3.51"></a><span id="l3.51">   }</span>
<a href="#l3.52"></a><span id="l3.52">   return false;</span>
<a href="#l3.53"></a><span id="l3.53"> }</span>
<a href="#l3.54"></a><span id="l3.54"> </span>
<a href="#l3.55"></a><span id="l3.55" class="difflineminus">-nsresult nsMsgThreadsWithUnreadDBView::AddMsgToThreadNotInView(nsIMsgThread *threadHdr, nsIMsgDBHdr *msgHdr, bool ensureListed)</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineminus">-{</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineplus">+nsresult nsMsgThreadsWithUnreadDBView::AddMsgToThreadNotInView(</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineplus">+    nsIMsgThread *threadHdr, nsIMsgDBHdr *msgHdr, bool ensureListed) {</span>
<a href="#l3.59"></a><span id="l3.59">   nsresult rv = NS_OK;</span>
<a href="#l3.60"></a><span id="l3.60"> </span>
<a href="#l3.61"></a><span id="l3.61" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDBHdr&gt; parentHdr;</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; parentHdr;</span>
<a href="#l3.63"></a><span id="l3.63">   uint32_t msgFlags;</span>
<a href="#l3.64"></a><span id="l3.64">   msgHdr-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l3.65"></a><span id="l3.65">   GetFirstMessageHdrToDisplayInThread(threadHdr, getter_AddRefs(parentHdr));</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineminus">-  if (parentHdr &amp;&amp; (ensureListed || !(msgFlags &amp; nsMsgMessageFlags::Read)))</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineminus">-  {</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineplus">+  if (parentHdr &amp;&amp; (ensureListed || !(msgFlags &amp; nsMsgMessageFlags::Read))) {</span>
<a href="#l3.69"></a><span id="l3.69">     nsMsgKey key;</span>
<a href="#l3.70"></a><span id="l3.70">     uint32_t numMsgsInThread;</span>
<a href="#l3.71"></a><span id="l3.71">     rv = AddHdr(parentHdr);</span>
<a href="#l3.72"></a><span id="l3.72">     threadHdr-&gt;GetNumChildren(&amp;numMsgsInThread);</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineminus">-    if (numMsgsInThread &gt; 1)</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineminus">-    {</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineplus">+    if (numMsgsInThread &gt; 1) {</span>
<a href="#l3.76"></a><span id="l3.76">       parentHdr-&gt;GetMessageKey(&amp;key);</span>
<a href="#l3.77"></a><span id="l3.77">       nsMsgViewIndex viewIndex = FindViewIndex(key);</span>
<a href="#l3.78"></a><span id="l3.78">       if (viewIndex != nsMsgViewIndex_None)</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineminus">-        OrExtraFlag(viewIndex, nsMsgMessageFlags::Elided | MSG_VIEW_FLAG_HASCHILDREN);</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineplus">+        OrExtraFlag(viewIndex,</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineplus">+                    nsMsgMessageFlags::Elided | MSG_VIEW_FLAG_HASCHILDREN);</span>
<a href="#l3.82"></a><span id="l3.82">     }</span>
<a href="#l3.83"></a><span id="l3.83">     m_totalUnwantedMessagesInView -= numMsgsInThread;</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineminus">-  }</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineminus">-  else</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineplus">+  } else</span>
<a href="#l3.87"></a><span id="l3.87">     m_totalUnwantedMessagesInView++;</span>
<a href="#l3.88"></a><span id="l3.88">   return rv;</span>
<a href="#l3.89"></a><span id="l3.89"> }</span>
<a href="#l3.90"></a><span id="l3.90"> </span>
<a href="#l3.91"></a><span id="l3.91"> NS_IMETHODIMP</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineminus">-nsMsgThreadsWithUnreadDBView::CloneDBView(nsIMessenger *aMessengerInstance, nsIMsgWindow *aMsgWindow, nsIMsgDBViewCommandUpdater *aCmdUpdater, nsIMsgDBView **_retval)</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineminus">-{</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineminus">-  nsMsgThreadsWithUnreadDBView* newMsgDBView = new nsMsgThreadsWithUnreadDBView();</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineminus">-  nsresult rv = CopyDBView(newMsgDBView, aMessengerInstance, aMsgWindow, aCmdUpdater);</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineplus">+nsMsgThreadsWithUnreadDBView::CloneDBView(</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineplus">+    nsIMessenger *aMessengerInstance, nsIMsgWindow *aMsgWindow,</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineplus">+    nsIMsgDBViewCommandUpdater *aCmdUpdater, nsIMsgDBView **_retval) {</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineplus">+  nsMsgThreadsWithUnreadDBView *newMsgDBView =</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineplus">+      new nsMsgThreadsWithUnreadDBView();</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineplus">+  nsresult rv =</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineplus">+      CopyDBView(newMsgDBView, aMessengerInstance, aMsgWindow, aCmdUpdater);</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.105"></a><span id="l3.105"> </span>
<a href="#l3.106"></a><span id="l3.106">   NS_IF_ADDREF(*_retval = newMsgDBView);</span>
<a href="#l3.107"></a><span id="l3.107">   return NS_OK;</span>
<a href="#l3.108"></a><span id="l3.108"> }</span>
<a href="#l3.109"></a><span id="l3.109"> </span>
<a href="#l3.110"></a><span id="l3.110" class="difflineminus">-NS_IMETHODIMP nsMsgThreadsWithUnreadDBView::GetNumMsgsInView(int32_t *aNumMsgs)</span>
<a href="#l3.111"></a><span id="l3.111" class="difflineminus">-{</span>
<a href="#l3.112"></a><span id="l3.112" class="difflineplus">+NS_IMETHODIMP nsMsgThreadsWithUnreadDBView::GetNumMsgsInView(</span>
<a href="#l3.113"></a><span id="l3.113" class="difflineplus">+    int32_t *aNumMsgs) {</span>
<a href="#l3.114"></a><span id="l3.114">   nsresult rv = nsMsgDBView::GetNumMsgsInView(aNumMsgs);</span>
<a href="#l3.115"></a><span id="l3.115">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.116"></a><span id="l3.116">   *aNumMsgs = *aNumMsgs - m_totalUnwantedMessagesInView;</span>
<a href="#l3.117"></a><span id="l3.117">   return rv;</span>
<a href="#l3.118"></a><span id="l3.118"> }</span>
<a href="#l3.119"></a><span id="l3.119"> </span>
<a href="#l3.120"></a><span id="l3.120"> nsMsgWatchedThreadsWithUnreadDBView::nsMsgWatchedThreadsWithUnreadDBView()</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineminus">-: m_totalUnwantedMessagesInView(0)</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineminus">-{</span>
<a href="#l3.123"></a><span id="l3.123" class="difflineplus">+    : m_totalUnwantedMessagesInView(0) {}</span>
<a href="#l3.124"></a><span id="l3.124" class="difflineplus">+</span>
<a href="#l3.125"></a><span id="l3.125" class="difflineplus">+NS_IMETHODIMP nsMsgWatchedThreadsWithUnreadDBView::GetViewType(</span>
<a href="#l3.126"></a><span id="l3.126" class="difflineplus">+    nsMsgViewTypeValue *aViewType) {</span>
<a href="#l3.127"></a><span id="l3.127" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aViewType);</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineplus">+  *aViewType = nsMsgViewType::eShowWatchedThreadsWithUnread;</span>
<a href="#l3.129"></a><span id="l3.129" class="difflineplus">+  return NS_OK;</span>
<a href="#l3.130"></a><span id="l3.130"> }</span>
<a href="#l3.131"></a><span id="l3.131"> </span>
<a href="#l3.132"></a><span id="l3.132" class="difflineminus">-NS_IMETHODIMP nsMsgWatchedThreadsWithUnreadDBView::GetViewType(nsMsgViewTypeValue *aViewType)</span>
<a href="#l3.133"></a><span id="l3.133" class="difflineminus">-{</span>
<a href="#l3.134"></a><span id="l3.134" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aViewType);</span>
<a href="#l3.135"></a><span id="l3.135" class="difflineminus">-    *aViewType = nsMsgViewType::eShowWatchedThreadsWithUnread;</span>
<a href="#l3.136"></a><span id="l3.136" class="difflineminus">-    return NS_OK;</span>
<a href="#l3.137"></a><span id="l3.137" class="difflineminus">-}</span>
<a href="#l3.138"></a><span id="l3.138" class="difflineminus">-</span>
<a href="#l3.139"></a><span id="l3.139" class="difflineminus">-bool nsMsgWatchedThreadsWithUnreadDBView::WantsThisThread(nsIMsgThread *threadHdr)</span>
<a href="#l3.140"></a><span id="l3.140" class="difflineminus">-{</span>
<a href="#l3.141"></a><span id="l3.141" class="difflineminus">-  if (threadHdr)</span>
<a href="#l3.142"></a><span id="l3.142" class="difflineminus">-  {</span>
<a href="#l3.143"></a><span id="l3.143" class="difflineplus">+bool nsMsgWatchedThreadsWithUnreadDBView::WantsThisThread(</span>
<a href="#l3.144"></a><span id="l3.144" class="difflineplus">+    nsIMsgThread *threadHdr) {</span>
<a href="#l3.145"></a><span id="l3.145" class="difflineplus">+  if (threadHdr) {</span>
<a href="#l3.146"></a><span id="l3.146">     uint32_t numNewChildren;</span>
<a href="#l3.147"></a><span id="l3.147">     uint32_t threadFlags;</span>
<a href="#l3.148"></a><span id="l3.148"> </span>
<a href="#l3.149"></a><span id="l3.149">     threadHdr-&gt;GetNumUnreadChildren(&amp;numNewChildren);</span>
<a href="#l3.150"></a><span id="l3.150">     threadHdr-&gt;GetFlags(&amp;threadFlags);</span>
<a href="#l3.151"></a><span id="l3.151">     if (numNewChildren &gt; 0 &amp;&amp; (threadFlags &amp; nsMsgMessageFlags::Watched) != 0)</span>
<a href="#l3.152"></a><span id="l3.152">       return true;</span>
<a href="#l3.153"></a><span id="l3.153">     uint32_t numChildren;</span>
<a href="#l3.154"></a><span id="l3.154">     threadHdr-&gt;GetNumChildren(&amp;numChildren);</span>
<a href="#l3.155"></a><span id="l3.155">     m_totalUnwantedMessagesInView += numChildren;</span>
<a href="#l3.156"></a><span id="l3.156">   }</span>
<a href="#l3.157"></a><span id="l3.157">   return false;</span>
<a href="#l3.158"></a><span id="l3.158"> }</span>
<a href="#l3.159"></a><span id="l3.159"> </span>
<a href="#l3.160"></a><span id="l3.160" class="difflineminus">-nsresult nsMsgWatchedThreadsWithUnreadDBView::AddMsgToThreadNotInView(nsIMsgThread *threadHdr, nsIMsgDBHdr *msgHdr, bool ensureListed)</span>
<a href="#l3.161"></a><span id="l3.161" class="difflineminus">-{</span>
<a href="#l3.162"></a><span id="l3.162" class="difflineplus">+nsresult nsMsgWatchedThreadsWithUnreadDBView::AddMsgToThreadNotInView(</span>
<a href="#l3.163"></a><span id="l3.163" class="difflineplus">+    nsIMsgThread *threadHdr, nsIMsgDBHdr *msgHdr, bool ensureListed) {</span>
<a href="#l3.164"></a><span id="l3.164">   nsresult rv = NS_OK;</span>
<a href="#l3.165"></a><span id="l3.165">   uint32_t threadFlags;</span>
<a href="#l3.166"></a><span id="l3.166">   uint32_t msgFlags;</span>
<a href="#l3.167"></a><span id="l3.167">   msgHdr-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l3.168"></a><span id="l3.168">   threadHdr-&gt;GetFlags(&amp;threadFlags);</span>
<a href="#l3.169"></a><span id="l3.169" class="difflineminus">-  if (threadFlags &amp; nsMsgMessageFlags::Watched)</span>
<a href="#l3.170"></a><span id="l3.170" class="difflineminus">-  {</span>
<a href="#l3.171"></a><span id="l3.171" class="difflineminus">-    nsCOMPtr &lt;nsIMsgDBHdr&gt; parentHdr;</span>
<a href="#l3.172"></a><span id="l3.172" class="difflineplus">+  if (threadFlags &amp; nsMsgMessageFlags::Watched) {</span>
<a href="#l3.173"></a><span id="l3.173" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDBHdr&gt; parentHdr;</span>
<a href="#l3.174"></a><span id="l3.174">     GetFirstMessageHdrToDisplayInThread(threadHdr, getter_AddRefs(parentHdr));</span>
<a href="#l3.175"></a><span id="l3.175" class="difflineminus">-    if (parentHdr &amp;&amp; (ensureListed || !(msgFlags &amp; nsMsgMessageFlags::Read)))</span>
<a href="#l3.176"></a><span id="l3.176" class="difflineminus">-    {</span>
<a href="#l3.177"></a><span id="l3.177" class="difflineplus">+    if (parentHdr &amp;&amp; (ensureListed || !(msgFlags &amp; nsMsgMessageFlags::Read))) {</span>
<a href="#l3.178"></a><span id="l3.178">       uint32_t numChildren;</span>
<a href="#l3.179"></a><span id="l3.179">       threadHdr-&gt;GetNumChildren(&amp;numChildren);</span>
<a href="#l3.180"></a><span id="l3.180">       rv = AddHdr(parentHdr);</span>
<a href="#l3.181"></a><span id="l3.181" class="difflineminus">-      if (numChildren &gt; 1)</span>
<a href="#l3.182"></a><span id="l3.182" class="difflineminus">-      {</span>
<a href="#l3.183"></a><span id="l3.183" class="difflineplus">+      if (numChildren &gt; 1) {</span>
<a href="#l3.184"></a><span id="l3.184">         nsMsgKey key;</span>
<a href="#l3.185"></a><span id="l3.185">         parentHdr-&gt;GetMessageKey(&amp;key);</span>
<a href="#l3.186"></a><span id="l3.186">         nsMsgViewIndex viewIndex = FindViewIndex(key);</span>
<a href="#l3.187"></a><span id="l3.187">         if (viewIndex != nsMsgViewIndex_None)</span>
<a href="#l3.188"></a><span id="l3.188" class="difflineminus">-          OrExtraFlag(viewIndex, nsMsgMessageFlags::Elided | MSG_VIEW_FLAG_ISTHREAD | MSG_VIEW_FLAG_HASCHILDREN | nsMsgMessageFlags::Watched);</span>
<a href="#l3.189"></a><span id="l3.189" class="difflineplus">+          OrExtraFlag(viewIndex, nsMsgMessageFlags::Elided |</span>
<a href="#l3.190"></a><span id="l3.190" class="difflineplus">+                                     MSG_VIEW_FLAG_ISTHREAD |</span>
<a href="#l3.191"></a><span id="l3.191" class="difflineplus">+                                     MSG_VIEW_FLAG_HASCHILDREN |</span>
<a href="#l3.192"></a><span id="l3.192" class="difflineplus">+                                     nsMsgMessageFlags::Watched);</span>
<a href="#l3.193"></a><span id="l3.193">       }</span>
<a href="#l3.194"></a><span id="l3.194">       m_totalUnwantedMessagesInView -= numChildren;</span>
<a href="#l3.195"></a><span id="l3.195">       return rv;</span>
<a href="#l3.196"></a><span id="l3.196">     }</span>
<a href="#l3.197"></a><span id="l3.197">   }</span>
<a href="#l3.198"></a><span id="l3.198">   m_totalUnwantedMessagesInView++;</span>
<a href="#l3.199"></a><span id="l3.199">   return rv;</span>
<a href="#l3.200"></a><span id="l3.200"> }</span>
<a href="#l3.201"></a><span id="l3.201"> </span>
<a href="#l3.202"></a><span id="l3.202"> NS_IMETHODIMP</span>
<a href="#l3.203"></a><span id="l3.203" class="difflineminus">-nsMsgWatchedThreadsWithUnreadDBView::CloneDBView(nsIMessenger *aMessengerInstance, nsIMsgWindow *aMsgWindow, nsIMsgDBViewCommandUpdater *aCmdUpdater, nsIMsgDBView **_retval)</span>
<a href="#l3.204"></a><span id="l3.204" class="difflineminus">-{</span>
<a href="#l3.205"></a><span id="l3.205" class="difflineminus">-  nsMsgWatchedThreadsWithUnreadDBView* newMsgDBView = new nsMsgWatchedThreadsWithUnreadDBView();</span>
<a href="#l3.206"></a><span id="l3.206" class="difflineminus">-  nsresult rv = CopyDBView(newMsgDBView, aMessengerInstance, aMsgWindow, aCmdUpdater);</span>
<a href="#l3.207"></a><span id="l3.207" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l3.208"></a><span id="l3.208" class="difflineplus">+nsMsgWatchedThreadsWithUnreadDBView::CloneDBView(</span>
<a href="#l3.209"></a><span id="l3.209" class="difflineplus">+    nsIMessenger *aMessengerInstance, nsIMsgWindow *aMsgWindow,</span>
<a href="#l3.210"></a><span id="l3.210" class="difflineplus">+    nsIMsgDBViewCommandUpdater *aCmdUpdater, nsIMsgDBView **_retval) {</span>
<a href="#l3.211"></a><span id="l3.211" class="difflineplus">+  nsMsgWatchedThreadsWithUnreadDBView *newMsgDBView =</span>
<a href="#l3.212"></a><span id="l3.212" class="difflineplus">+      new nsMsgWatchedThreadsWithUnreadDBView();</span>
<a href="#l3.213"></a><span id="l3.213" class="difflineplus">+  nsresult rv =</span>
<a href="#l3.214"></a><span id="l3.214" class="difflineplus">+      CopyDBView(newMsgDBView, aMessengerInstance, aMsgWindow, aCmdUpdater);</span>
<a href="#l3.215"></a><span id="l3.215" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.216"></a><span id="l3.216"> </span>
<a href="#l3.217"></a><span id="l3.217">   NS_IF_ADDREF(*_retval = newMsgDBView);</span>
<a href="#l3.218"></a><span id="l3.218">   return NS_OK;</span>
<a href="#l3.219"></a><span id="l3.219"> }</span>
<a href="#l3.220"></a><span id="l3.220"> </span>
<a href="#l3.221"></a><span id="l3.221"> NS_IMETHODIMP</span>
<a href="#l3.222"></a><span id="l3.222" class="difflineminus">-nsMsgWatchedThreadsWithUnreadDBView::GetNumMsgsInView(int32_t *aNumMsgs)</span>
<a href="#l3.223"></a><span id="l3.223" class="difflineminus">-{</span>
<a href="#l3.224"></a><span id="l3.224" class="difflineplus">+nsMsgWatchedThreadsWithUnreadDBView::GetNumMsgsInView(int32_t *aNumMsgs) {</span>
<a href="#l3.225"></a><span id="l3.225">   nsresult rv = nsMsgDBView::GetNumMsgsInView(aNumMsgs);</span>
<a href="#l3.226"></a><span id="l3.226">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.227"></a><span id="l3.227">   *aNumMsgs = *aNumMsgs - m_totalUnwantedMessagesInView;</span>
<a href="#l3.228"></a><span id="l3.228">   return rv;</span>
<a href="#l3.229"></a><span id="l3.229"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/base/src/nsMsgSpecialViews.h</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgSpecialViews.h</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -4,70 +4,79 @@</span>
<a href="#l4.4"></a><span id="l4.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l4.5"></a><span id="l4.5"> </span>
<a href="#l4.6"></a><span id="l4.6"> #ifndef _nsMsgSpecialViews_H_</span>
<a href="#l4.7"></a><span id="l4.7"> #define _nsMsgSpecialViews_H_</span>
<a href="#l4.8"></a><span id="l4.8"> </span>
<a href="#l4.9"></a><span id="l4.9"> #include &quot;mozilla/Attributes.h&quot;</span>
<a href="#l4.10"></a><span id="l4.10"> #include &quot;nsMsgThreadedDBView.h&quot;</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-class nsMsgThreadsWithUnreadDBView : public nsMsgThreadedDBView</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-{</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-public:</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+class nsMsgThreadsWithUnreadDBView : public nsMsgThreadedDBView {</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+ public:</span>
<a href="#l4.17"></a><span id="l4.17">   nsMsgThreadsWithUnreadDBView();</span>
<a href="#l4.18"></a><span id="l4.18">   virtual ~nsMsgThreadsWithUnreadDBView();</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineminus">-  virtual const char * GetViewName(void) override {return &quot;ThreadsWithUnreadView&quot;; }</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineminus">-  NS_IMETHOD CloneDBView(nsIMessenger *aMessengerInstance, nsIMsgWindow *aMsgWindow, nsIMsgDBViewCommandUpdater *aCommandUpdater, nsIMsgDBView **_retval) override;</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+  virtual const char *GetViewName(void) override {</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+    return &quot;ThreadsWithUnreadView&quot;;</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+  }</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+  NS_IMETHOD CloneDBView(nsIMessenger *aMessengerInstance,</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+                         nsIMsgWindow *aMsgWindow,</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineplus">+                         nsIMsgDBViewCommandUpdater *aCommandUpdater,</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineplus">+                         nsIMsgDBView **_retval) override;</span>
<a href="#l4.28"></a><span id="l4.28">   NS_IMETHOD GetViewType(nsMsgViewTypeValue *aViewType) override;</span>
<a href="#l4.29"></a><span id="l4.29">   NS_IMETHOD GetNumMsgsInView(int32_t *aNumMsgs) override;</span>
<a href="#l4.30"></a><span id="l4.30">   virtual bool WantsThisThread(nsIMsgThread *threadHdr) override;</span>
<a href="#l4.31"></a><span id="l4.31"> </span>
<a href="#l4.32"></a><span id="l4.32" class="difflineminus">-protected:</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineminus">-  virtual nsresult AddMsgToThreadNotInView(nsIMsgThread *threadHdr, nsIMsgDBHdr *msgHdr, bool ensureListed) override;</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+ protected:</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+  virtual nsresult AddMsgToThreadNotInView(nsIMsgThread *threadHdr,</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+                                           nsIMsgDBHdr *msgHdr,</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+                                           bool ensureListed) override;</span>
<a href="#l4.38"></a><span id="l4.38">   uint32_t m_totalUnwantedMessagesInView;</span>
<a href="#l4.39"></a><span id="l4.39"> };</span>
<a href="#l4.40"></a><span id="l4.40"> </span>
<a href="#l4.41"></a><span id="l4.41" class="difflineminus">-class nsMsgWatchedThreadsWithUnreadDBView : public nsMsgThreadedDBView</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineminus">-{</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineminus">-public:</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineminus">-  nsMsgWatchedThreadsWithUnreadDBView ();</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+class nsMsgWatchedThreadsWithUnreadDBView : public nsMsgThreadedDBView {</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+ public:</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+  nsMsgWatchedThreadsWithUnreadDBView();</span>
<a href="#l4.48"></a><span id="l4.48">   NS_IMETHOD GetViewType(nsMsgViewTypeValue *aViewType) override;</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineminus">-  NS_IMETHOD CloneDBView(nsIMessenger *aMessengerInstance, nsIMsgWindow *aMsgWindow,</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineplus">+  NS_IMETHOD CloneDBView(nsIMessenger *aMessengerInstance,</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+                         nsIMsgWindow *aMsgWindow,</span>
<a href="#l4.52"></a><span id="l4.52">                          nsIMsgDBViewCommandUpdater *aCommandUpdater,</span>
<a href="#l4.53"></a><span id="l4.53">                          nsIMsgDBView **_retval) override;</span>
<a href="#l4.54"></a><span id="l4.54">   NS_IMETHOD GetNumMsgsInView(int32_t *aNumMsgs) override;</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineminus">-  virtual const char *GetViewName(void) override { return &quot;WatchedThreadsWithUnreadView&quot;; }</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineplus">+  virtual const char *GetViewName(void) override {</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+    return &quot;WatchedThreadsWithUnreadView&quot;;</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineplus">+  }</span>
<a href="#l4.59"></a><span id="l4.59">   virtual bool WantsThisThread(nsIMsgThread *threadHdr) override;</span>
<a href="#l4.60"></a><span id="l4.60"> </span>
<a href="#l4.61"></a><span id="l4.61" class="difflineminus">-protected:</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineminus">-  virtual nsresult AddMsgToThreadNotInView(nsIMsgThread *threadHdr, nsIMsgDBHdr *msgHdr, bool ensureListed) override;</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineplus">+ protected:</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineplus">+  virtual nsresult AddMsgToThreadNotInView(nsIMsgThread *threadHdr,</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineplus">+                                           nsIMsgDBHdr *msgHdr,</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineplus">+                                           bool ensureListed) override;</span>
<a href="#l4.67"></a><span id="l4.67">   uint32_t m_totalUnwantedMessagesInView;</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineminus">-</span>
<a href="#l4.69"></a><span id="l4.69"> };</span>
<a href="#l4.70"></a><span id="l4.70"> #ifdef DOING_CACHELESS_VIEW</span>
<a href="#l4.71"></a><span id="l4.71"> // This view will initially be used for cacheless IMAP.</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineminus">-class nsMsgCachelessView : public nsMsgDBView</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineminus">-{</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineminus">-public:</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineplus">+class nsMsgCachelessView : public nsMsgDBView {</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineplus">+ public:</span>
<a href="#l4.77"></a><span id="l4.77">   nsMsgCachelessView();</span>
<a href="#l4.78"></a><span id="l4.78">   NS_IMETHOD GetViewType(nsMsgViewTypeValue *aViewType);</span>
<a href="#l4.79"></a><span id="l4.79">   virtual ~nsMsgCachelessView();</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineminus">-  virtual const char * GetViewName(void) {return &quot;nsMsgCachelessView&quot;; }</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineminus">-  NS_IMETHOD Open(nsIMsgFolder *folder, nsMsgViewSortTypeValue viewType, int32_t *count);</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineminus">-  nsresult SetViewSize(int32_t setSize); // Override</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineminus">-  virtual nsresult AddNewMessages() ;</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineplus">+  virtual const char *GetViewName(void) { return &quot;nsMsgCachelessView&quot;; }</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineplus">+  NS_IMETHOD Open(nsIMsgFolder *folder, nsMsgViewSortTypeValue viewType,</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineplus">+                  int32_t *count);</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineplus">+  nsresult SetViewSize(int32_t setSize);  // Override</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineplus">+  virtual nsresult AddNewMessages();</span>
<a href="#l4.89"></a><span id="l4.89">   virtual nsresult AddHdr(nsIMsgDBHdr *msgHdr);</span>
<a href="#l4.90"></a><span id="l4.90">   // for news, xover line, potentially, for IMAP, imap line...</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineminus">-  virtual nsresult AddHdrFromServerLine(char *line, nsMsgKey *msgId) ;</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineplus">+  virtual nsresult AddHdrFromServerLine(char *line, nsMsgKey *msgId);</span>
<a href="#l4.93"></a><span id="l4.93">   virtual void SetInitialSortState(void);</span>
<a href="#l4.94"></a><span id="l4.94">   virtual nsresult Init(uint32_t *pCount);</span>
<a href="#l4.95"></a><span id="l4.95"> </span>
<a href="#l4.96"></a><span id="l4.96" class="difflineminus">-protected:</span>
<a href="#l4.97"></a><span id="l4.97" class="difflineminus">-  void        ClearPendingIds();</span>
<a href="#l4.98"></a><span id="l4.98" class="difflineplus">+ protected:</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineplus">+  void ClearPendingIds();</span>
<a href="#l4.100"></a><span id="l4.100"> </span>
<a href="#l4.101"></a><span id="l4.101" class="difflineminus">-  nsIMsgFolder   *m_folder;</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineminus">-  nsMsgViewIndex  m_curStartSeq;</span>
<a href="#l4.103"></a><span id="l4.103" class="difflineminus">-  nsMsgViewIndex  m_curEndSeq;</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineminus">-  bool            m_sizeInitialized;</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineplus">+  nsIMsgFolder *m_folder;</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineplus">+  nsMsgViewIndex m_curStartSeq;</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineplus">+  nsMsgViewIndex m_curEndSeq;</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineplus">+  bool m_sizeInitialized;</span>
<a href="#l4.109"></a><span id="l4.109"> };</span>
<a href="#l4.110"></a><span id="l4.110"> </span>
<a href="#l4.111"></a><span id="l4.111"> #endif /* DOING_CACHELESS_VIEW */</span>
<a href="#l4.112"></a><span id="l4.112"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/base/src/nsMsgStatusFeedback.cpp</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgStatusFeedback.cpp</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -21,285 +21,252 @@</span>
<a href="#l5.4"></a><span id="l5.4"> #include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l5.5"></a><span id="l5.5"> #include &quot;nsMsgDBFolder.h&quot;</span>
<a href="#l5.6"></a><span id="l5.6"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l5.7"></a><span id="l5.7"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l5.8"></a><span id="l5.8"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l5.9"></a><span id="l5.9"> </span>
<a href="#l5.10"></a><span id="l5.10"> #define MSGFEEDBACK_TIMER_INTERVAL 500</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-nsMsgStatusFeedback::nsMsgStatusFeedback() :</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-  m_lastPercent(0),</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineminus">-  m_lastProgressTime(0)</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineminus">-{</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+nsMsgStatusFeedback::nsMsgStatusFeedback()</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+    : m_lastPercent(0), m_lastProgressTime(0) {</span>
<a href="#l5.18"></a><span id="l5.18">   nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineminus">-    mozilla::services::GetStringBundleService();</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+      mozilla::services::GetStringBundleService();</span>
<a href="#l5.21"></a><span id="l5.21"> </span>
<a href="#l5.22"></a><span id="l5.22">   if (bundleService)</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineminus">-    bundleService-&gt;CreateBundle(&quot;chrome://messenger/locale/messenger.properties&quot;,</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineminus">-                                getter_AddRefs(mBundle));</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineplus">+    bundleService-&gt;CreateBundle(</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineplus">+        &quot;chrome://messenger/locale/messenger.properties&quot;,</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineplus">+        getter_AddRefs(mBundle));</span>
<a href="#l5.28"></a><span id="l5.28"> }</span>
<a href="#l5.29"></a><span id="l5.29"> </span>
<a href="#l5.30"></a><span id="l5.30" class="difflineminus">-nsMsgStatusFeedback::~nsMsgStatusFeedback()</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineminus">-{</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineminus">-  mBundle = nullptr;</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineminus">-}</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineplus">+nsMsgStatusFeedback::~nsMsgStatusFeedback() { mBundle = nullptr; }</span>
<a href="#l5.35"></a><span id="l5.35"> </span>
<a href="#l5.36"></a><span id="l5.36"> NS_IMPL_ISUPPORTS(nsMsgStatusFeedback, nsIMsgStatusFeedback,</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineminus">-  nsIProgressEventSink, nsIWebProgressListener, nsISupportsWeakReference)</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineplus">+                  nsIProgressEventSink, nsIWebProgressListener,</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineplus">+                  nsISupportsWeakReference)</span>
<a href="#l5.40"></a><span id="l5.40"> </span>
<a href="#l5.41"></a><span id="l5.41"> //////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l5.42"></a><span id="l5.42"> // nsMsgStatusFeedback::nsIWebProgressListener</span>
<a href="#l5.43"></a><span id="l5.43"> //////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l5.44"></a><span id="l5.44"> </span>
<a href="#l5.45"></a><span id="l5.45"> NS_IMETHODIMP</span>
<a href="#l5.46"></a><span id="l5.46"> nsMsgStatusFeedback::OnProgressChange(nsIWebProgress* aWebProgress,</span>
<a href="#l5.47"></a><span id="l5.47">                                       nsIRequest* aRequest,</span>
<a href="#l5.48"></a><span id="l5.48">                                       int32_t aCurSelfProgress,</span>
<a href="#l5.49"></a><span id="l5.49">                                       int32_t aMaxSelfProgress,</span>
<a href="#l5.50"></a><span id="l5.50">                                       int32_t aCurTotalProgress,</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineminus">-                                      int32_t aMaxTotalProgress)</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineminus">-{</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineplus">+                                      int32_t aMaxTotalProgress) {</span>
<a href="#l5.54"></a><span id="l5.54">   int32_t percentage = 0;</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineminus">-  if (aMaxTotalProgress &gt; 0)</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineminus">-  {</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineminus">-    percentage =  (aCurTotalProgress * 100) / aMaxTotalProgress;</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineminus">-    if (percentage)</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineminus">-      ShowProgress(percentage);</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineplus">+  if (aMaxTotalProgress &gt; 0) {</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineplus">+    percentage = (aCurTotalProgress * 100) / aMaxTotalProgress;</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineplus">+    if (percentage) ShowProgress(percentage);</span>
<a href="#l5.63"></a><span id="l5.63">   }</span>
<a href="#l5.64"></a><span id="l5.64"> </span>
<a href="#l5.65"></a><span id="l5.65" class="difflineminus">-   return NS_OK;</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.67"></a><span id="l5.67"> }</span>
<a href="#l5.68"></a><span id="l5.68"> </span>
<a href="#l5.69"></a><span id="l5.69"> NS_IMETHODIMP</span>
<a href="#l5.70"></a><span id="l5.70"> nsMsgStatusFeedback::OnStateChange(nsIWebProgress* aWebProgress,</span>
<a href="#l5.71"></a><span id="l5.71">                                    nsIRequest* aRequest,</span>
<a href="#l5.72"></a><span id="l5.72">                                    uint32_t aProgressStateFlags,</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineminus">-                                   nsresult aStatus)</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineminus">-{</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineplus">+                                   nsresult aStatus) {</span>
<a href="#l5.76"></a><span id="l5.76">   nsresult rv;</span>
<a href="#l5.77"></a><span id="l5.77"> </span>
<a href="#l5.78"></a><span id="l5.78">   NS_ENSURE_TRUE(mBundle, NS_ERROR_NULL_POINTER);</span>
<a href="#l5.79"></a><span id="l5.79" class="difflineminus">-  if (aProgressStateFlags &amp; STATE_IS_NETWORK)</span>
<a href="#l5.80"></a><span id="l5.80" class="difflineminus">-  {</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineminus">-    if (aProgressStateFlags &amp; STATE_START)</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineminus">-    {</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineplus">+  if (aProgressStateFlags &amp; STATE_IS_NETWORK) {</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineplus">+    if (aProgressStateFlags &amp; STATE_START) {</span>
<a href="#l5.85"></a><span id="l5.85">       m_lastPercent = 0;</span>
<a href="#l5.86"></a><span id="l5.86">       StartMeteors();</span>
<a href="#l5.87"></a><span id="l5.87">       nsString loadingDocument;</span>
<a href="#l5.88"></a><span id="l5.88">       rv = mBundle-&gt;GetStringFromName(&quot;documentLoading&quot;, loadingDocument);</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l5.90"></a><span id="l5.90" class="difflineminus">-        ShowStatusString(loadingDocument);</span>
<a href="#l5.91"></a><span id="l5.91" class="difflineminus">-    }</span>
<a href="#l5.92"></a><span id="l5.92" class="difflineminus">-    else if (aProgressStateFlags &amp; STATE_STOP)</span>
<a href="#l5.93"></a><span id="l5.93" class="difflineminus">-    {</span>
<a href="#l5.94"></a><span id="l5.94" class="difflineminus">-      // if we are loading message for display purposes, this STATE_STOP notification is</span>
<a href="#l5.95"></a><span id="l5.95" class="difflineminus">-      // the only notification we get when layout is actually done rendering the message. We need</span>
<a href="#l5.96"></a><span id="l5.96" class="difflineminus">-      // to fire the appropriate msgHdrSink notification in this particular case.</span>
<a href="#l5.97"></a><span id="l5.97" class="difflineplus">+      if (NS_SUCCEEDED(rv)) ShowStatusString(loadingDocument);</span>
<a href="#l5.98"></a><span id="l5.98" class="difflineplus">+    } else if (aProgressStateFlags &amp; STATE_STOP) {</span>
<a href="#l5.99"></a><span id="l5.99" class="difflineplus">+      // if we are loading message for display purposes, this STATE_STOP</span>
<a href="#l5.100"></a><span id="l5.100" class="difflineplus">+      // notification is the only notification we get when layout is actually</span>
<a href="#l5.101"></a><span id="l5.101" class="difflineplus">+      // done rendering the message. We need to fire the appropriate msgHdrSink</span>
<a href="#l5.102"></a><span id="l5.102" class="difflineplus">+      // notification in this particular case.</span>
<a href="#l5.103"></a><span id="l5.103">       nsCOMPtr&lt;nsIChannel&gt; channel = do_QueryInterface(aRequest);</span>
<a href="#l5.104"></a><span id="l5.104" class="difflineminus">-      if (channel)</span>
<a href="#l5.105"></a><span id="l5.105" class="difflineminus">-      {</span>
<a href="#l5.106"></a><span id="l5.106" class="difflineplus">+      if (channel) {</span>
<a href="#l5.107"></a><span id="l5.107">         nsCOMPtr&lt;nsIURI&gt; uri;</span>
<a href="#l5.108"></a><span id="l5.108">         channel-&gt;GetURI(getter_AddRefs(uri));</span>
<a href="#l5.109"></a><span id="l5.109" class="difflineminus">-        nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl (do_QueryInterface(uri));</span>
<a href="#l5.110"></a><span id="l5.110" class="difflineminus">-        if (mailnewsUrl)</span>
<a href="#l5.111"></a><span id="l5.111" class="difflineminus">-        {</span>
<a href="#l5.112"></a><span id="l5.112" class="difflineplus">+        nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl(do_QueryInterface(uri));</span>
<a href="#l5.113"></a><span id="l5.113" class="difflineplus">+        if (mailnewsUrl) {</span>
<a href="#l5.114"></a><span id="l5.114">           // get the url type</span>
<a href="#l5.115"></a><span id="l5.115">           bool messageDisplayUrl;</span>
<a href="#l5.116"></a><span id="l5.116" class="difflineminus">-          mailnewsUrl-&gt;IsUrlType(nsIMsgMailNewsUrl::eDisplay, &amp;messageDisplayUrl);</span>
<a href="#l5.117"></a><span id="l5.117" class="difflineplus">+          mailnewsUrl-&gt;IsUrlType(nsIMsgMailNewsUrl::eDisplay,</span>
<a href="#l5.118"></a><span id="l5.118" class="difflineplus">+                                 &amp;messageDisplayUrl);</span>
<a href="#l5.119"></a><span id="l5.119"> </span>
<a href="#l5.120"></a><span id="l5.120" class="difflineminus">-          if (messageDisplayUrl)</span>
<a href="#l5.121"></a><span id="l5.121" class="difflineminus">-          {</span>
<a href="#l5.122"></a><span id="l5.122" class="difflineplus">+          if (messageDisplayUrl) {</span>
<a href="#l5.123"></a><span id="l5.123">             // get the header sink</span>
<a href="#l5.124"></a><span id="l5.124">             nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l5.125"></a><span id="l5.125">             mailnewsUrl-&gt;GetMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l5.126"></a><span id="l5.126" class="difflineminus">-            if (msgWindow)</span>
<a href="#l5.127"></a><span id="l5.127" class="difflineminus">-            {</span>
<a href="#l5.128"></a><span id="l5.128" class="difflineplus">+            if (msgWindow) {</span>
<a href="#l5.129"></a><span id="l5.129">               nsCOMPtr&lt;nsIMsgHeaderSink&gt; hdrSink;</span>
<a href="#l5.130"></a><span id="l5.130">               msgWindow-&gt;GetMsgHeaderSink(getter_AddRefs(hdrSink));</span>
<a href="#l5.131"></a><span id="l5.131" class="difflineminus">-              if (hdrSink)</span>
<a href="#l5.132"></a><span id="l5.132" class="difflineminus">-                hdrSink-&gt;OnEndMsgDownload(mailnewsUrl);</span>
<a href="#l5.133"></a><span id="l5.133" class="difflineplus">+              if (hdrSink) hdrSink-&gt;OnEndMsgDownload(mailnewsUrl);</span>
<a href="#l5.134"></a><span id="l5.134">             }</span>
<a href="#l5.135"></a><span id="l5.135">             // get the folder and notify that the msg has been loaded. We're</span>
<a href="#l5.136"></a><span id="l5.136">             // using NotifyPropertyFlagChanged. To be completely consistent,</span>
<a href="#l5.137"></a><span id="l5.137">             // we'd send a similar notification that the old message was</span>
<a href="#l5.138"></a><span id="l5.138">             // unloaded.</span>
<a href="#l5.139"></a><span id="l5.139" class="difflineminus">-            nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l5.140"></a><span id="l5.140" class="difflineminus">-            nsCOMPtr &lt;nsIMsgFolder&gt; msgFolder;</span>
<a href="#l5.141"></a><span id="l5.141" class="difflineplus">+            nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l5.142"></a><span id="l5.142" class="difflineplus">+            nsCOMPtr&lt;nsIMsgFolder&gt; msgFolder;</span>
<a href="#l5.143"></a><span id="l5.143">             mailnewsUrl-&gt;GetFolder(getter_AddRefs(msgFolder));</span>
<a href="#l5.144"></a><span id="l5.144" class="difflineminus">-            nsCOMPtr &lt;nsIMsgMessageUrl&gt; msgUrl = do_QueryInterface(mailnewsUrl);</span>
<a href="#l5.145"></a><span id="l5.145" class="difflineminus">-            if (msgUrl)</span>
<a href="#l5.146"></a><span id="l5.146" class="difflineminus">-            {</span>
<a href="#l5.147"></a><span id="l5.147" class="difflineplus">+            nsCOMPtr&lt;nsIMsgMessageUrl&gt; msgUrl = do_QueryInterface(mailnewsUrl);</span>
<a href="#l5.148"></a><span id="l5.148" class="difflineplus">+            if (msgUrl) {</span>
<a href="#l5.149"></a><span id="l5.149">               // not sending this notification is not a fatal error...</span>
<a href="#l5.150"></a><span id="l5.150" class="difflineminus">-              (void) msgUrl-&gt;GetMessageHeader(getter_AddRefs(msgHdr));</span>
<a href="#l5.151"></a><span id="l5.151" class="difflineplus">+              (void)msgUrl-&gt;GetMessageHeader(getter_AddRefs(msgHdr));</span>
<a href="#l5.152"></a><span id="l5.152">               if (msgFolder &amp;&amp; msgHdr)</span>
<a href="#l5.153"></a><span id="l5.153">                 msgFolder-&gt;NotifyPropertyFlagChanged(msgHdr, kMsgLoaded, 0, 1);</span>
<a href="#l5.154"></a><span id="l5.154">             }</span>
<a href="#l5.155"></a><span id="l5.155">           }</span>
<a href="#l5.156"></a><span id="l5.156">         }</span>
<a href="#l5.157"></a><span id="l5.157">       }</span>
<a href="#l5.158"></a><span id="l5.158">       StopMeteors();</span>
<a href="#l5.159"></a><span id="l5.159">       nsString documentDone;</span>
<a href="#l5.160"></a><span id="l5.160">       rv = mBundle-&gt;GetStringFromName(&quot;documentDone&quot;, documentDone);</span>
<a href="#l5.161"></a><span id="l5.161" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l5.162"></a><span id="l5.162" class="difflineminus">-        ShowStatusString(documentDone);</span>
<a href="#l5.163"></a><span id="l5.163" class="difflineplus">+      if (NS_SUCCEEDED(rv)) ShowStatusString(documentDone);</span>
<a href="#l5.164"></a><span id="l5.164">     }</span>
<a href="#l5.165"></a><span id="l5.165">   }</span>
<a href="#l5.166"></a><span id="l5.166">   return NS_OK;</span>
<a href="#l5.167"></a><span id="l5.167"> }</span>
<a href="#l5.168"></a><span id="l5.168"> </span>
<a href="#l5.169"></a><span id="l5.169" class="difflineminus">-NS_IMETHODIMP nsMsgStatusFeedback::OnLocationChange(nsIWebProgress* aWebProgress,</span>
<a href="#l5.170"></a><span id="l5.170" class="difflineminus">-                                                    nsIRequest* aRequest,</span>
<a href="#l5.171"></a><span id="l5.171" class="difflineminus">-                                                    nsIURI* aLocation,</span>
<a href="#l5.172"></a><span id="l5.172" class="difflineminus">-                                                    uint32_t aFlags)</span>
<a href="#l5.173"></a><span id="l5.173" class="difflineminus">-{</span>
<a href="#l5.174"></a><span id="l5.174" class="difflineminus">-   return NS_OK;</span>
<a href="#l5.175"></a><span id="l5.175" class="difflineplus">+NS_IMETHODIMP nsMsgStatusFeedback::OnLocationChange(</span>
<a href="#l5.176"></a><span id="l5.176" class="difflineplus">+    nsIWebProgress* aWebProgress, nsIRequest* aRequest, nsIURI* aLocation,</span>
<a href="#l5.177"></a><span id="l5.177" class="difflineplus">+    uint32_t aFlags) {</span>
<a href="#l5.178"></a><span id="l5.178" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.179"></a><span id="l5.179"> }</span>
<a href="#l5.180"></a><span id="l5.180"> </span>
<a href="#l5.181"></a><span id="l5.181"> NS_IMETHODIMP</span>
<a href="#l5.182"></a><span id="l5.182"> nsMsgStatusFeedback::OnStatusChange(nsIWebProgress* aWebProgress,</span>
<a href="#l5.183"></a><span id="l5.183" class="difflineminus">-                                    nsIRequest* aRequest,</span>
<a href="#l5.184"></a><span id="l5.184" class="difflineminus">-                                    nsresult aStatus,</span>
<a href="#l5.185"></a><span id="l5.185" class="difflineminus">-                                    const char16_t* aMessage)</span>
<a href="#l5.186"></a><span id="l5.186" class="difflineminus">-{</span>
<a href="#l5.187"></a><span id="l5.187" class="difflineminus">-    return NS_OK;</span>
<a href="#l5.188"></a><span id="l5.188" class="difflineminus">-}</span>
<a href="#l5.189"></a><span id="l5.189" class="difflineminus">-</span>
<a href="#l5.190"></a><span id="l5.190" class="difflineminus">-</span>
<a href="#l5.191"></a><span id="l5.191" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l5.192"></a><span id="l5.192" class="difflineminus">-nsMsgStatusFeedback::OnSecurityChange(nsIWebProgress *aWebProgress,</span>
<a href="#l5.193"></a><span id="l5.193" class="difflineminus">-                                    nsIRequest *aRequest,</span>
<a href="#l5.194"></a><span id="l5.194" class="difflineminus">-                                    uint32_t state)</span>
<a href="#l5.195"></a><span id="l5.195" class="difflineminus">-{</span>
<a href="#l5.196"></a><span id="l5.196" class="difflineminus">-    return NS_OK;</span>
<a href="#l5.197"></a><span id="l5.197" class="difflineplus">+                                    nsIRequest* aRequest, nsresult aStatus,</span>
<a href="#l5.198"></a><span id="l5.198" class="difflineplus">+                                    const char16_t* aMessage) {</span>
<a href="#l5.199"></a><span id="l5.199" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.200"></a><span id="l5.200"> }</span>
<a href="#l5.201"></a><span id="l5.201"> </span>
<a href="#l5.202"></a><span id="l5.202"> NS_IMETHODIMP</span>
<a href="#l5.203"></a><span id="l5.203" class="difflineminus">-nsMsgStatusFeedback::OnContentBlockingEvent(nsIWebProgress *aWebProgress,</span>
<a href="#l5.204"></a><span id="l5.204" class="difflineminus">-                                            nsIRequest *aRequest, uint32_t aEvent)</span>
<a href="#l5.205"></a><span id="l5.205" class="difflineminus">-{</span>
<a href="#l5.206"></a><span id="l5.206" class="difflineplus">+nsMsgStatusFeedback::OnSecurityChange(nsIWebProgress* aWebProgress,</span>
<a href="#l5.207"></a><span id="l5.207" class="difflineplus">+                                      nsIRequest* aRequest, uint32_t state) {</span>
<a href="#l5.208"></a><span id="l5.208" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.209"></a><span id="l5.209" class="difflineplus">+}</span>
<a href="#l5.210"></a><span id="l5.210" class="difflineplus">+</span>
<a href="#l5.211"></a><span id="l5.211" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l5.212"></a><span id="l5.212" class="difflineplus">+nsMsgStatusFeedback::OnContentBlockingEvent(nsIWebProgress* aWebProgress,</span>
<a href="#l5.213"></a><span id="l5.213" class="difflineplus">+                                            nsIRequest* aRequest,</span>
<a href="#l5.214"></a><span id="l5.214" class="difflineplus">+                                            uint32_t aEvent) {</span>
<a href="#l5.215"></a><span id="l5.215">   return NS_OK;</span>
<a href="#l5.216"></a><span id="l5.216"> }</span>
<a href="#l5.217"></a><span id="l5.217"> </span>
<a href="#l5.218"></a><span id="l5.218"> NS_IMETHODIMP</span>
<a href="#l5.219"></a><span id="l5.219" class="difflineminus">-nsMsgStatusFeedback::ShowStatusString(const nsAString&amp; aStatus)</span>
<a href="#l5.220"></a><span id="l5.220" class="difflineminus">-{</span>
<a href="#l5.221"></a><span id="l5.221" class="difflineminus">-  nsCOMPtr&lt;nsIMsgStatusFeedback&gt; jsStatusFeedback(do_QueryReferent(mJSStatusFeedbackWeak));</span>
<a href="#l5.222"></a><span id="l5.222" class="difflineminus">-  if (jsStatusFeedback)</span>
<a href="#l5.223"></a><span id="l5.223" class="difflineminus">-    jsStatusFeedback-&gt;ShowStatusString(aStatus);</span>
<a href="#l5.224"></a><span id="l5.224" class="difflineplus">+nsMsgStatusFeedback::ShowStatusString(const nsAString&amp; aStatus) {</span>
<a href="#l5.225"></a><span id="l5.225" class="difflineplus">+  nsCOMPtr&lt;nsIMsgStatusFeedback&gt; jsStatusFeedback(</span>
<a href="#l5.226"></a><span id="l5.226" class="difflineplus">+      do_QueryReferent(mJSStatusFeedbackWeak));</span>
<a href="#l5.227"></a><span id="l5.227" class="difflineplus">+  if (jsStatusFeedback) jsStatusFeedback-&gt;ShowStatusString(aStatus);</span>
<a href="#l5.228"></a><span id="l5.228">   return NS_OK;</span>
<a href="#l5.229"></a><span id="l5.229"> }</span>
<a href="#l5.230"></a><span id="l5.230"> </span>
<a href="#l5.231"></a><span id="l5.231"> NS_IMETHODIMP</span>
<a href="#l5.232"></a><span id="l5.232" class="difflineminus">-nsMsgStatusFeedback::SetStatusString(const nsAString&amp; aStatus)</span>
<a href="#l5.233"></a><span id="l5.233" class="difflineminus">-{</span>
<a href="#l5.234"></a><span id="l5.234" class="difflineminus">-  nsCOMPtr&lt;nsIMsgStatusFeedback&gt; jsStatusFeedback(do_QueryReferent(mJSStatusFeedbackWeak));</span>
<a href="#l5.235"></a><span id="l5.235" class="difflineminus">-  if (jsStatusFeedback)</span>
<a href="#l5.236"></a><span id="l5.236" class="difflineminus">-    jsStatusFeedback-&gt;SetStatusString(aStatus);</span>
<a href="#l5.237"></a><span id="l5.237" class="difflineplus">+nsMsgStatusFeedback::SetStatusString(const nsAString&amp; aStatus) {</span>
<a href="#l5.238"></a><span id="l5.238" class="difflineplus">+  nsCOMPtr&lt;nsIMsgStatusFeedback&gt; jsStatusFeedback(</span>
<a href="#l5.239"></a><span id="l5.239" class="difflineplus">+      do_QueryReferent(mJSStatusFeedbackWeak));</span>
<a href="#l5.240"></a><span id="l5.240" class="difflineplus">+  if (jsStatusFeedback) jsStatusFeedback-&gt;SetStatusString(aStatus);</span>
<a href="#l5.241"></a><span id="l5.241">   return NS_OK;</span>
<a href="#l5.242"></a><span id="l5.242"> }</span>
<a href="#l5.243"></a><span id="l5.243"> </span>
<a href="#l5.244"></a><span id="l5.244"> NS_IMETHODIMP</span>
<a href="#l5.245"></a><span id="l5.245" class="difflineminus">-nsMsgStatusFeedback::ShowProgress(int32_t aPercentage)</span>
<a href="#l5.246"></a><span id="l5.246" class="difflineminus">-{</span>
<a href="#l5.247"></a><span id="l5.247" class="difflineminus">-  // if the percentage hasn't changed...OR if we are going from 0 to 100% in one step</span>
<a href="#l5.248"></a><span id="l5.248" class="difflineminus">-  // then don't bother....just fall out....</span>
<a href="#l5.249"></a><span id="l5.249" class="difflineminus">-  if (aPercentage == m_lastPercent || (m_lastPercent == 0 &amp;&amp; aPercentage &gt;= 100))</span>
<a href="#l5.250"></a><span id="l5.250" class="difflineplus">+nsMsgStatusFeedback::ShowProgress(int32_t aPercentage) {</span>
<a href="#l5.251"></a><span id="l5.251" class="difflineplus">+  // if the percentage hasn't changed...OR if we are going from 0 to 100% in one</span>
<a href="#l5.252"></a><span id="l5.252" class="difflineplus">+  // step then don't bother....just fall out....</span>
<a href="#l5.253"></a><span id="l5.253" class="difflineplus">+  if (aPercentage == m_lastPercent ||</span>
<a href="#l5.254"></a><span id="l5.254" class="difflineplus">+      (m_lastPercent == 0 &amp;&amp; aPercentage &gt;= 100))</span>
<a href="#l5.255"></a><span id="l5.255">     return NS_OK;</span>
<a href="#l5.256"></a><span id="l5.256"> </span>
<a href="#l5.257"></a><span id="l5.257">   m_lastPercent = aPercentage;</span>
<a href="#l5.258"></a><span id="l5.258"> </span>
<a href="#l5.259"></a><span id="l5.259">   int64_t nowMS = 0;</span>
<a href="#l5.260"></a><span id="l5.260">   if (aPercentage &lt; 100)  // always need to do 100%</span>
<a href="#l5.261"></a><span id="l5.261">   {</span>
<a href="#l5.262"></a><span id="l5.262">     nowMS = PR_IntervalToMilliseconds(PR_IntervalNow());</span>
<a href="#l5.263"></a><span id="l5.263" class="difflineminus">-    if (nowMS &lt; m_lastProgressTime + 250)</span>
<a href="#l5.264"></a><span id="l5.264" class="difflineminus">-      return NS_OK;</span>
<a href="#l5.265"></a><span id="l5.265" class="difflineplus">+    if (nowMS &lt; m_lastProgressTime + 250) return NS_OK;</span>
<a href="#l5.266"></a><span id="l5.266">   }</span>
<a href="#l5.267"></a><span id="l5.267"> </span>
<a href="#l5.268"></a><span id="l5.268">   m_lastProgressTime = nowMS;</span>
<a href="#l5.269"></a><span id="l5.269" class="difflineminus">-  nsCOMPtr&lt;nsIMsgStatusFeedback&gt; jsStatusFeedback(do_QueryReferent(mJSStatusFeedbackWeak));</span>
<a href="#l5.270"></a><span id="l5.270" class="difflineminus">-  if (jsStatusFeedback)</span>
<a href="#l5.271"></a><span id="l5.271" class="difflineminus">-    jsStatusFeedback-&gt;ShowProgress(aPercentage);</span>
<a href="#l5.272"></a><span id="l5.272" class="difflineplus">+  nsCOMPtr&lt;nsIMsgStatusFeedback&gt; jsStatusFeedback(</span>
<a href="#l5.273"></a><span id="l5.273" class="difflineplus">+      do_QueryReferent(mJSStatusFeedbackWeak));</span>
<a href="#l5.274"></a><span id="l5.274" class="difflineplus">+  if (jsStatusFeedback) jsStatusFeedback-&gt;ShowProgress(aPercentage);</span>
<a href="#l5.275"></a><span id="l5.275">   return NS_OK;</span>
<a href="#l5.276"></a><span id="l5.276"> }</span>
<a href="#l5.277"></a><span id="l5.277"> </span>
<a href="#l5.278"></a><span id="l5.278"> NS_IMETHODIMP</span>
<a href="#l5.279"></a><span id="l5.279" class="difflineminus">-nsMsgStatusFeedback::StartMeteors()</span>
<a href="#l5.280"></a><span id="l5.280" class="difflineminus">-{</span>
<a href="#l5.281"></a><span id="l5.281" class="difflineminus">-  nsCOMPtr&lt;nsIMsgStatusFeedback&gt; jsStatusFeedback(do_QueryReferent(mJSStatusFeedbackWeak));</span>
<a href="#l5.282"></a><span id="l5.282" class="difflineminus">-  if (jsStatusFeedback)</span>
<a href="#l5.283"></a><span id="l5.283" class="difflineminus">-    jsStatusFeedback-&gt;StartMeteors();</span>
<a href="#l5.284"></a><span id="l5.284" class="difflineplus">+nsMsgStatusFeedback::StartMeteors() {</span>
<a href="#l5.285"></a><span id="l5.285" class="difflineplus">+  nsCOMPtr&lt;nsIMsgStatusFeedback&gt; jsStatusFeedback(</span>
<a href="#l5.286"></a><span id="l5.286" class="difflineplus">+      do_QueryReferent(mJSStatusFeedbackWeak));</span>
<a href="#l5.287"></a><span id="l5.287" class="difflineplus">+  if (jsStatusFeedback) jsStatusFeedback-&gt;StartMeteors();</span>
<a href="#l5.288"></a><span id="l5.288">   return NS_OK;</span>
<a href="#l5.289"></a><span id="l5.289"> }</span>
<a href="#l5.290"></a><span id="l5.290"> </span>
<a href="#l5.291"></a><span id="l5.291"> NS_IMETHODIMP</span>
<a href="#l5.292"></a><span id="l5.292" class="difflineminus">-nsMsgStatusFeedback::StopMeteors()</span>
<a href="#l5.293"></a><span id="l5.293" class="difflineminus">-{</span>
<a href="#l5.294"></a><span id="l5.294" class="difflineminus">-  nsCOMPtr&lt;nsIMsgStatusFeedback&gt; jsStatusFeedback(do_QueryReferent(mJSStatusFeedbackWeak));</span>
<a href="#l5.295"></a><span id="l5.295" class="difflineminus">-  if (jsStatusFeedback)</span>
<a href="#l5.296"></a><span id="l5.296" class="difflineminus">-    jsStatusFeedback-&gt;StopMeteors();</span>
<a href="#l5.297"></a><span id="l5.297" class="difflineplus">+nsMsgStatusFeedback::StopMeteors() {</span>
<a href="#l5.298"></a><span id="l5.298" class="difflineplus">+  nsCOMPtr&lt;nsIMsgStatusFeedback&gt; jsStatusFeedback(</span>
<a href="#l5.299"></a><span id="l5.299" class="difflineplus">+      do_QueryReferent(mJSStatusFeedbackWeak));</span>
<a href="#l5.300"></a><span id="l5.300" class="difflineplus">+  if (jsStatusFeedback) jsStatusFeedback-&gt;StopMeteors();</span>
<a href="#l5.301"></a><span id="l5.301">   return NS_OK;</span>
<a href="#l5.302"></a><span id="l5.302"> }</span>
<a href="#l5.303"></a><span id="l5.303"> </span>
<a href="#l5.304"></a><span id="l5.304" class="difflineminus">-NS_IMETHODIMP nsMsgStatusFeedback::SetWrappedStatusFeedback(nsIMsgStatusFeedback * aJSStatusFeedback)</span>
<a href="#l5.305"></a><span id="l5.305" class="difflineminus">-{</span>
<a href="#l5.306"></a><span id="l5.306" class="difflineplus">+NS_IMETHODIMP nsMsgStatusFeedback::SetWrappedStatusFeedback(</span>
<a href="#l5.307"></a><span id="l5.307" class="difflineplus">+    nsIMsgStatusFeedback* aJSStatusFeedback) {</span>
<a href="#l5.308"></a><span id="l5.308">   NS_ENSURE_ARG_POINTER(aJSStatusFeedback);</span>
<a href="#l5.309"></a><span id="l5.309">   mJSStatusFeedbackWeak = do_GetWeakReference(aJSStatusFeedback);</span>
<a href="#l5.310"></a><span id="l5.310">   return NS_OK;</span>
<a href="#l5.311"></a><span id="l5.311"> }</span>
<a href="#l5.312"></a><span id="l5.312"> </span>
<a href="#l5.313"></a><span id="l5.313" class="difflineminus">-NS_IMETHODIMP nsMsgStatusFeedback::OnProgress(nsIRequest *request, nsISupports* ctxt,</span>
<a href="#l5.314"></a><span id="l5.314" class="difflineminus">-                                              int64_t aProgress, int64_t aProgressMax)</span>
<a href="#l5.315"></a><span id="l5.315" class="difflineminus">-{</span>
<a href="#l5.316"></a><span id="l5.316" class="difflineplus">+NS_IMETHODIMP nsMsgStatusFeedback::OnProgress(nsIRequest* request,</span>
<a href="#l5.317"></a><span id="l5.317" class="difflineplus">+                                              nsISupports* ctxt,</span>
<a href="#l5.318"></a><span id="l5.318" class="difflineplus">+                                              int64_t aProgress,</span>
<a href="#l5.319"></a><span id="l5.319" class="difflineplus">+                                              int64_t aProgressMax) {</span>
<a href="#l5.320"></a><span id="l5.320">   // XXX: What should the nsIWebProgress be?</span>
<a href="#l5.321"></a><span id="l5.321">   // XXX: this truncates 64-bit to 32-bit</span>
<a href="#l5.322"></a><span id="l5.322" class="difflineminus">-  return OnProgressChange(nullptr, request, int32_t(aProgress), int32_t(aProgressMax),</span>
<a href="#l5.323"></a><span id="l5.323" class="difflineminus">-                          int32_t(aProgress) /* current total progress */, int32_t(aProgressMax) /* max total progress */);</span>
<a href="#l5.324"></a><span id="l5.324" class="difflineplus">+  return OnProgressChange(nullptr, request, int32_t(aProgress),</span>
<a href="#l5.325"></a><span id="l5.325" class="difflineplus">+                          int32_t(aProgressMax),</span>
<a href="#l5.326"></a><span id="l5.326" class="difflineplus">+                          int32_t(aProgress) /* current total progress */,</span>
<a href="#l5.327"></a><span id="l5.327" class="difflineplus">+                          int32_t(aProgressMax) /* max total progress */);</span>
<a href="#l5.328"></a><span id="l5.328"> }</span>
<a href="#l5.329"></a><span id="l5.329"> </span>
<a href="#l5.330"></a><span id="l5.330" class="difflineminus">-NS_IMETHODIMP nsMsgStatusFeedback::OnStatus(nsIRequest *request, nsISupports* ctxt,</span>
<a href="#l5.331"></a><span id="l5.331" class="difflineminus">-                                            nsresult aStatus, const char16_t* aStatusArg)</span>
<a href="#l5.332"></a><span id="l5.332" class="difflineminus">-{</span>
<a href="#l5.333"></a><span id="l5.333" class="difflineplus">+NS_IMETHODIMP nsMsgStatusFeedback::OnStatus(nsIRequest* request,</span>
<a href="#l5.334"></a><span id="l5.334" class="difflineplus">+                                            nsISupports* ctxt, nsresult aStatus,</span>
<a href="#l5.335"></a><span id="l5.335" class="difflineplus">+                                            const char16_t* aStatusArg) {</span>
<a href="#l5.336"></a><span id="l5.336">   nsresult rv;</span>
<a href="#l5.337"></a><span id="l5.337">   nsCOMPtr&lt;nsIURI&gt; uri;</span>
<a href="#l5.338"></a><span id="l5.338">   nsString accountName;</span>
<a href="#l5.339"></a><span id="l5.339">   // fetching account name from nsIRequest</span>
<a href="#l5.340"></a><span id="l5.340">   nsCOMPtr&lt;nsIChannel&gt; aChannel = do_QueryInterface(request);</span>
<a href="#l5.341"></a><span id="l5.341">   rv = aChannel-&gt;GetURI(getter_AddRefs(uri));</span>
<a href="#l5.342"></a><span id="l5.342">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.343"></a><span id="l5.343">   nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; url(do_QueryInterface(uri));</span>
<a href="#l5.344"></a><span id="l5.344" class="difflineminus">-  if (url)</span>
<a href="#l5.345"></a><span id="l5.345" class="difflineminus">-  {</span>
<a href="#l5.346"></a><span id="l5.346" class="difflineplus">+  if (url) {</span>
<a href="#l5.347"></a><span id="l5.347">     nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l5.348"></a><span id="l5.348">     url-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l5.349"></a><span id="l5.349" class="difflineminus">-    if (server)</span>
<a href="#l5.350"></a><span id="l5.350" class="difflineminus">-      server-&gt;GetPrettyName(accountName);</span>
<a href="#l5.351"></a><span id="l5.351" class="difflineplus">+    if (server) server-&gt;GetPrettyName(accountName);</span>
<a href="#l5.352"></a><span id="l5.352">   }</span>
<a href="#l5.353"></a><span id="l5.353"> </span>
<a href="#l5.354"></a><span id="l5.354">   // forming the status message</span>
<a href="#l5.355"></a><span id="l5.355">   nsCOMPtr&lt;nsIStringBundleService&gt; sbs =</span>
<a href="#l5.356"></a><span id="l5.356" class="difflineminus">-    mozilla::services::GetStringBundleService();</span>
<a href="#l5.357"></a><span id="l5.357" class="difflineplus">+      mozilla::services::GetStringBundleService();</span>
<a href="#l5.358"></a><span id="l5.358">   NS_ENSURE_TRUE(sbs, NS_ERROR_UNEXPECTED);</span>
<a href="#l5.359"></a><span id="l5.359">   nsString str;</span>
<a href="#l5.360"></a><span id="l5.360">   rv = sbs-&gt;FormatStatusMessage(aStatus, aStatusArg, str);</span>
<a href="#l5.361"></a><span id="l5.361">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.362"></a><span id="l5.362"> </span>
<a href="#l5.363"></a><span id="l5.363" class="difflineminus">-  // prefixing the account name to the status message if status message isn't blank</span>
<a href="#l5.364"></a><span id="l5.364" class="difflineminus">-  // and doesn't already contain the account name.</span>
<a href="#l5.365"></a><span id="l5.365" class="difflineplus">+  // prefixing the account name to the status message if status message isn't</span>
<a href="#l5.366"></a><span id="l5.366" class="difflineplus">+  // blank and doesn't already contain the account name.</span>
<a href="#l5.367"></a><span id="l5.367">   nsString statusMessage;</span>
<a href="#l5.368"></a><span id="l5.368" class="difflineminus">-  if (!str.IsEmpty() &amp;&amp; str.Find(accountName) == kNotFound)</span>
<a href="#l5.369"></a><span id="l5.369" class="difflineminus">-  {</span>
<a href="#l5.370"></a><span id="l5.370" class="difflineplus">+  if (!str.IsEmpty() &amp;&amp; str.Find(accountName) == kNotFound) {</span>
<a href="#l5.371"></a><span id="l5.371">     nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l5.372"></a><span id="l5.372">     rv = sbs-&gt;CreateBundle(MSGS_URL, getter_AddRefs(bundle));</span>
<a href="#l5.373"></a><span id="l5.373" class="difflineminus">-    const char16_t *params[] = { accountName.get(),</span>
<a href="#l5.374"></a><span id="l5.374" class="difflineminus">-                                  str.get() };</span>
<a href="#l5.375"></a><span id="l5.375" class="difflineminus">-    rv = bundle-&gt;FormatStringFromName(</span>
<a href="#l5.376"></a><span id="l5.376" class="difflineminus">-      &quot;statusMessage&quot;,</span>
<a href="#l5.377"></a><span id="l5.377" class="difflineminus">-      params, 2, statusMessage);</span>
<a href="#l5.378"></a><span id="l5.378" class="difflineplus">+    const char16_t* params[] = {accountName.get(), str.get()};</span>
<a href="#l5.379"></a><span id="l5.379" class="difflineplus">+    rv =</span>
<a href="#l5.380"></a><span id="l5.380" class="difflineplus">+        bundle-&gt;FormatStringFromName(&quot;statusMessage&quot;, params, 2, statusMessage);</span>
<a href="#l5.381"></a><span id="l5.381">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.382"></a><span id="l5.382" class="difflineminus">-  }</span>
<a href="#l5.383"></a><span id="l5.383" class="difflineminus">-  else</span>
<a href="#l5.384"></a><span id="l5.384" class="difflineminus">-  {</span>
<a href="#l5.385"></a><span id="l5.385" class="difflineplus">+  } else {</span>
<a href="#l5.386"></a><span id="l5.386">     statusMessage.Assign(str);</span>
<a href="#l5.387"></a><span id="l5.387">   }</span>
<a href="#l5.388"></a><span id="l5.388">   return ShowStatusString(statusMessage);</span>
<a href="#l5.389"></a><span id="l5.389"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/base/src/nsMsgStatusFeedback.h</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgStatusFeedback.h</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -14,36 +14,35 @@</span>
<a href="#l6.4"></a><span id="l6.4"> #include &quot;nsIProgressEventSink.h&quot;</span>
<a href="#l6.5"></a><span id="l6.5"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l6.6"></a><span id="l6.6"> #include &quot;nsWeakReference.h&quot;</span>
<a href="#l6.7"></a><span id="l6.7"> #include &quot;nsIWeakReferenceUtils.h&quot;</span>
<a href="#l6.8"></a><span id="l6.8"> </span>
<a href="#l6.9"></a><span id="l6.9"> class nsMsgStatusFeedback : public nsIMsgStatusFeedback,</span>
<a href="#l6.10"></a><span id="l6.10">                             public nsIProgressEventSink,</span>
<a href="#l6.11"></a><span id="l6.11">                             public nsIWebProgressListener,</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-                            public nsSupportsWeakReference</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-{</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-public:</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+                            public nsSupportsWeakReference {</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+ public:</span>
<a href="#l6.17"></a><span id="l6.17">   nsMsgStatusFeedback();</span>
<a href="#l6.18"></a><span id="l6.18"> </span>
<a href="#l6.19"></a><span id="l6.19">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l6.20"></a><span id="l6.20">   NS_DECL_NSIMSGSTATUSFEEDBACK</span>
<a href="#l6.21"></a><span id="l6.21">   NS_DECL_NSIWEBPROGRESSLISTENER</span>
<a href="#l6.22"></a><span id="l6.22">   NS_DECL_NSIPROGRESSEVENTSINK</span>
<a href="#l6.23"></a><span id="l6.23"> </span>
<a href="#l6.24"></a><span id="l6.24" class="difflineminus">-protected:</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineplus">+ protected:</span>
<a href="#l6.26"></a><span id="l6.26">   virtual ~nsMsgStatusFeedback();</span>
<a href="#l6.27"></a><span id="l6.27"> </span>
<a href="#l6.28"></a><span id="l6.28" class="difflineminus">-  bool             m_meteorsSpinning;</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineminus">-  int32_t          m_lastPercent;</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineminus">-  int64_t          m_lastProgressTime;</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+  bool m_meteorsSpinning;</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+  int32_t m_lastPercent;</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+  int64_t m_lastProgressTime;</span>
<a href="#l6.34"></a><span id="l6.34"> </span>
<a href="#l6.35"></a><span id="l6.35">   void BeginObserving();</span>
<a href="#l6.36"></a><span id="l6.36">   void EndObserving();</span>
<a href="#l6.37"></a><span id="l6.37"> </span>
<a href="#l6.38"></a><span id="l6.38">   // the JS status feedback implementation object...eventually this object</span>
<a href="#l6.39"></a><span id="l6.39">   // will replace this very C++ class you are looking at.</span>
<a href="#l6.40"></a><span id="l6.40">   nsWeakPtr mJSStatusFeedbackWeak;</span>
<a href="#l6.41"></a><span id="l6.41"> </span>
<a href="#l6.42"></a><span id="l6.42">   nsCOMPtr&lt;nsIStringBundle&gt; mBundle;</span>
<a href="#l6.43"></a><span id="l6.43"> };</span>
<a href="#l6.44"></a><span id="l6.44"> </span>
<a href="#l6.45"></a><span id="l6.45" class="difflineminus">-#endif // _nsMsgStatusFeedback_h</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineplus">+#endif  // _nsMsgStatusFeedback_h</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/base/src/nsMsgTagService.cpp</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgTagService.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -5,530 +5,466 @@</span>
<a href="#l7.4"></a><span id="l7.4"> </span>
<a href="#l7.5"></a><span id="l7.5"> #include &quot;msgCore.h&quot;</span>
<a href="#l7.6"></a><span id="l7.6"> #include &quot;nsMsgTagService.h&quot;</span>
<a href="#l7.7"></a><span id="l7.7"> #include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l7.8"></a><span id="l7.8"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l7.9"></a><span id="l7.9"> #include &quot;nsISupportsPrimitives.h&quot;</span>
<a href="#l7.10"></a><span id="l7.10"> #include &quot;nsMsgI18N.h&quot;</span>
<a href="#l7.11"></a><span id="l7.11"> #include &quot;nsIPrefLocalizedString.h&quot;</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-#include &quot;nsMsgDBView.h&quot; // for labels migration</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+#include &quot;nsMsgDBView.h&quot;  // for labels migration</span>
<a href="#l7.14"></a><span id="l7.14"> #include &quot;nsQuickSort.h&quot;</span>
<a href="#l7.15"></a><span id="l7.15"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l7.16"></a><span id="l7.16"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l7.17"></a><span id="l7.17"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l7.18"></a><span id="l7.18"> #include &quot;nsMemory.h&quot;</span>
<a href="#l7.19"></a><span id="l7.19"> </span>
<a href="#l7.20"></a><span id="l7.20"> #define STRLEN(s) (sizeof(s) - 1)</span>
<a href="#l7.21"></a><span id="l7.21"> </span>
<a href="#l7.22"></a><span id="l7.22" class="difflineminus">-#define TAG_PREF_VERSION        &quot;version&quot;</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineminus">-#define TAG_PREF_SUFFIX_TAG     &quot;.tag&quot;</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineminus">-#define TAG_PREF_SUFFIX_COLOR   &quot;.color&quot;</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineplus">+#define TAG_PREF_VERSION &quot;version&quot;</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineplus">+#define TAG_PREF_SUFFIX_TAG &quot;.tag&quot;</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineplus">+#define TAG_PREF_SUFFIX_COLOR &quot;.color&quot;</span>
<a href="#l7.28"></a><span id="l7.28"> #define TAG_PREF_SUFFIX_ORDINAL &quot;.ordinal&quot;</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineminus">-#define TAG_CMP_LESSER          -1</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineminus">-#define TAG_CMP_EQUAL           0</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-#define TAG_CMP_GREATER         1</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+#define TAG_CMP_LESSER -1</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+#define TAG_CMP_EQUAL 0</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+#define TAG_CMP_GREATER 1</span>
<a href="#l7.35"></a><span id="l7.35"> </span>
<a href="#l7.36"></a><span id="l7.36"> static bool gMigratingKeys = false;</span>
<a href="#l7.37"></a><span id="l7.37"> </span>
<a href="#l7.38"></a><span id="l7.38"> // comparison functions for nsQuickSort</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineminus">-static int</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineminus">-CompareMsgTagKeys(const void* aTagPref1, const void* aTagPref2)</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineminus">-{</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineminus">-  return strcmp(*static_cast&lt;const char* const*&gt;(aTagPref1),</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineminus">-                *static_cast&lt;const char* const*&gt;(aTagPref2));</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+static int CompareMsgTagKeys(const void *aTagPref1, const void *aTagPref2) {</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineplus">+  return strcmp(*static_cast&lt;const char *const *&gt;(aTagPref1),</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineplus">+                *static_cast&lt;const char *const *&gt;(aTagPref2));</span>
<a href="#l7.47"></a><span id="l7.47"> }</span>
<a href="#l7.48"></a><span id="l7.48"> </span>
<a href="#l7.49"></a><span id="l7.49" class="difflineminus">-static int</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineminus">-CompareMsgTags(const void* aTagPref1, const void* aTagPref2)</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineminus">-{</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineplus">+static int CompareMsgTags(const void *aTagPref1, const void *aTagPref2) {</span>
<a href="#l7.53"></a><span id="l7.53">   // Sort nsMsgTag objects by ascending order, using their ordinal or key.</span>
<a href="#l7.54"></a><span id="l7.54">   // The &quot;smallest&quot; value will be first in the sorted array,</span>
<a href="#l7.55"></a><span id="l7.55">   // thus being the most important element.</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineminus">-  nsMsgTag *element1 = *(nsMsgTag**) aTagPref1;</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineminus">-  nsMsgTag *element2 = *(nsMsgTag**) aTagPref2;</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineplus">+  nsMsgTag *element1 = *(nsMsgTag **)aTagPref1;</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineplus">+  nsMsgTag *element2 = *(nsMsgTag **)aTagPref2;</span>
<a href="#l7.60"></a><span id="l7.60"> </span>
<a href="#l7.61"></a><span id="l7.61">   // if we have only one element, it wins</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineminus">-  if (!element1 &amp;&amp; !element2)</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineminus">-    return TAG_CMP_EQUAL;</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineminus">-  if (!element2)</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineminus">-    return TAG_CMP_LESSER;</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineminus">-  if (!element1)</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineminus">-    return TAG_CMP_GREATER;</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineplus">+  if (!element1 &amp;&amp; !element2) return TAG_CMP_EQUAL;</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineplus">+  if (!element2) return TAG_CMP_LESSER;</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineplus">+  if (!element1) return TAG_CMP_GREATER;</span>
<a href="#l7.71"></a><span id="l7.71"> </span>
<a href="#l7.72"></a><span id="l7.72">   // only use the key if the ordinal is not defined or empty</span>
<a href="#l7.73"></a><span id="l7.73">   nsAutoCString value1, value2;</span>
<a href="#l7.74"></a><span id="l7.74">   element1-&gt;GetOrdinal(value1);</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineminus">-  if (value1.IsEmpty())</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineminus">-    element1-&gt;GetKey(value1);</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineplus">+  if (value1.IsEmpty()) element1-&gt;GetKey(value1);</span>
<a href="#l7.78"></a><span id="l7.78">   element2-&gt;GetOrdinal(value2);</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineminus">-  if (value2.IsEmpty())</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineminus">-    element2-&gt;GetKey(value2);</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineplus">+  if (value2.IsEmpty()) element2-&gt;GetKey(value2);</span>
<a href="#l7.82"></a><span id="l7.82"> </span>
<a href="#l7.83"></a><span id="l7.83">   return strcmp(value1.get(), value2.get());</span>
<a href="#l7.84"></a><span id="l7.84"> }</span>
<a href="#l7.85"></a><span id="l7.85"> </span>
<a href="#l7.86"></a><span id="l7.86" class="difflineminus">-</span>
<a href="#l7.87"></a><span id="l7.87"> //</span>
<a href="#l7.88"></a><span id="l7.88"> //  nsMsgTag</span>
<a href="#l7.89"></a><span id="l7.89"> //</span>
<a href="#l7.90"></a><span id="l7.90"> NS_IMPL_ISUPPORTS(nsMsgTag, nsIMsgTag)</span>
<a href="#l7.91"></a><span id="l7.91"> </span>
<a href="#l7.92"></a><span id="l7.92" class="difflineminus">-nsMsgTag::nsMsgTag(const nsACString &amp;aKey,</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineminus">-                   const nsAString  &amp;aTag,</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineminus">-                   const nsACString &amp;aColor,</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineminus">-                   const nsACString &amp;aOrdinal)</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineminus">-: mTag(aTag),</span>
<a href="#l7.97"></a><span id="l7.97" class="difflineminus">-  mKey(aKey),</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineminus">-  mColor(aColor),</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineminus">-  mOrdinal(aOrdinal)</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineminus">-{</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineminus">-}</span>
<a href="#l7.102"></a><span id="l7.102" class="difflineplus">+nsMsgTag::nsMsgTag(const nsACString &amp;aKey, const nsAString &amp;aTag,</span>
<a href="#l7.103"></a><span id="l7.103" class="difflineplus">+                   const nsACString &amp;aColor, const nsACString &amp;aOrdinal)</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineplus">+    : mTag(aTag), mKey(aKey), mColor(aColor), mOrdinal(aOrdinal) {}</span>
<a href="#l7.105"></a><span id="l7.105"> </span>
<a href="#l7.106"></a><span id="l7.106" class="difflineminus">-nsMsgTag::~nsMsgTag()</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineminus">-{</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineminus">-}</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineplus">+nsMsgTag::~nsMsgTag() {}</span>
<a href="#l7.110"></a><span id="l7.110"> </span>
<a href="#l7.111"></a><span id="l7.111"> /* readonly attribute ACString key; */</span>
<a href="#l7.112"></a><span id="l7.112" class="difflineminus">-NS_IMETHODIMP nsMsgTag::GetKey(nsACString &amp; aKey)</span>
<a href="#l7.113"></a><span id="l7.113" class="difflineminus">-{</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineplus">+NS_IMETHODIMP nsMsgTag::GetKey(nsACString &amp;aKey) {</span>
<a href="#l7.115"></a><span id="l7.115">   aKey = mKey;</span>
<a href="#l7.116"></a><span id="l7.116">   return NS_OK;</span>
<a href="#l7.117"></a><span id="l7.117"> }</span>
<a href="#l7.118"></a><span id="l7.118"> </span>
<a href="#l7.119"></a><span id="l7.119"> /* readonly attribute AString tag; */</span>
<a href="#l7.120"></a><span id="l7.120" class="difflineminus">-NS_IMETHODIMP nsMsgTag::GetTag(nsAString &amp; aTag)</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineminus">-{</span>
<a href="#l7.122"></a><span id="l7.122" class="difflineplus">+NS_IMETHODIMP nsMsgTag::GetTag(nsAString &amp;aTag) {</span>
<a href="#l7.123"></a><span id="l7.123">   aTag = mTag;</span>
<a href="#l7.124"></a><span id="l7.124">   return NS_OK;</span>
<a href="#l7.125"></a><span id="l7.125"> }</span>
<a href="#l7.126"></a><span id="l7.126"> </span>
<a href="#l7.127"></a><span id="l7.127"> /* readonly attribute ACString color; */</span>
<a href="#l7.128"></a><span id="l7.128" class="difflineminus">-NS_IMETHODIMP nsMsgTag::GetColor(nsACString &amp; aColor)</span>
<a href="#l7.129"></a><span id="l7.129" class="difflineminus">-{</span>
<a href="#l7.130"></a><span id="l7.130" class="difflineplus">+NS_IMETHODIMP nsMsgTag::GetColor(nsACString &amp;aColor) {</span>
<a href="#l7.131"></a><span id="l7.131">   aColor = mColor;</span>
<a href="#l7.132"></a><span id="l7.132">   return NS_OK;</span>
<a href="#l7.133"></a><span id="l7.133"> }</span>
<a href="#l7.134"></a><span id="l7.134"> </span>
<a href="#l7.135"></a><span id="l7.135"> /* readonly attribute ACString ordinal; */</span>
<a href="#l7.136"></a><span id="l7.136" class="difflineminus">-NS_IMETHODIMP nsMsgTag::GetOrdinal(nsACString &amp; aOrdinal)</span>
<a href="#l7.137"></a><span id="l7.137" class="difflineminus">-{</span>
<a href="#l7.138"></a><span id="l7.138" class="difflineplus">+NS_IMETHODIMP nsMsgTag::GetOrdinal(nsACString &amp;aOrdinal) {</span>
<a href="#l7.139"></a><span id="l7.139">   aOrdinal = mOrdinal;</span>
<a href="#l7.140"></a><span id="l7.140">   return NS_OK;</span>
<a href="#l7.141"></a><span id="l7.141"> }</span>
<a href="#l7.142"></a><span id="l7.142"> </span>
<a href="#l7.143"></a><span id="l7.143" class="difflineminus">-</span>
<a href="#l7.144"></a><span id="l7.144"> //</span>
<a href="#l7.145"></a><span id="l7.145"> //  nsMsgTagService</span>
<a href="#l7.146"></a><span id="l7.146"> //</span>
<a href="#l7.147"></a><span id="l7.147"> NS_IMPL_ISUPPORTS(nsMsgTagService, nsIMsgTagService)</span>
<a href="#l7.148"></a><span id="l7.148"> </span>
<a href="#l7.149"></a><span id="l7.149" class="difflineminus">-nsMsgTagService::nsMsgTagService()</span>
<a href="#l7.150"></a><span id="l7.150" class="difflineminus">-{</span>
<a href="#l7.151"></a><span id="l7.151" class="difflineplus">+nsMsgTagService::nsMsgTagService() {</span>
<a href="#l7.152"></a><span id="l7.152">   m_tagPrefBranch = nullptr;</span>
<a href="#l7.153"></a><span id="l7.153" class="difflineminus">-  nsCOMPtr&lt;nsIPrefService&gt; prefService(do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l7.154"></a><span id="l7.154" class="difflineplus">+  nsCOMPtr&lt;nsIPrefService&gt; prefService(</span>
<a href="#l7.155"></a><span id="l7.155" class="difflineplus">+      do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l7.156"></a><span id="l7.156">   if (prefService)</span>
<a href="#l7.157"></a><span id="l7.157">     prefService-&gt;GetBranch(&quot;mailnews.tags.&quot;, getter_AddRefs(m_tagPrefBranch));</span>
<a href="#l7.158"></a><span id="l7.158">   // need to figure out how to migrate the tags only once.</span>
<a href="#l7.159"></a><span id="l7.159">   MigrateLabelsToTags();</span>
<a href="#l7.160"></a><span id="l7.160">   RefreshKeyCache();</span>
<a href="#l7.161"></a><span id="l7.161"> }</span>
<a href="#l7.162"></a><span id="l7.162"> </span>
<a href="#l7.163"></a><span id="l7.163" class="difflineminus">-nsMsgTagService::~nsMsgTagService()</span>
<a href="#l7.164"></a><span id="l7.164" class="difflineminus">-{</span>
<a href="#l7.165"></a><span id="l7.165" class="difflineminus">-  /* destructor code */</span>
<a href="#l7.166"></a><span id="l7.166" class="difflineminus">-}</span>
<a href="#l7.167"></a><span id="l7.167" class="difflineplus">+nsMsgTagService::~nsMsgTagService() {} /* destructor code */</span>
<a href="#l7.168"></a><span id="l7.168"> </span>
<a href="#l7.169"></a><span id="l7.169"> /* wstring getTagForKey (in string key); */</span>
<a href="#l7.170"></a><span id="l7.170" class="difflineminus">-NS_IMETHODIMP nsMsgTagService::GetTagForKey(const nsACString &amp;key, nsAString &amp;_retval)</span>
<a href="#l7.171"></a><span id="l7.171" class="difflineminus">-{</span>
<a href="#l7.172"></a><span id="l7.172" class="difflineplus">+NS_IMETHODIMP nsMsgTagService::GetTagForKey(const nsACString &amp;key,</span>
<a href="#l7.173"></a><span id="l7.173" class="difflineplus">+                                            nsAString &amp;_retval) {</span>
<a href="#l7.174"></a><span id="l7.174">   nsAutoCString prefName(key);</span>
<a href="#l7.175"></a><span id="l7.175" class="difflineminus">-  if (!gMigratingKeys)</span>
<a href="#l7.176"></a><span id="l7.176" class="difflineminus">-    ToLowerCase(prefName);</span>
<a href="#l7.177"></a><span id="l7.177" class="difflineplus">+  if (!gMigratingKeys) ToLowerCase(prefName);</span>
<a href="#l7.178"></a><span id="l7.178">   prefName.AppendLiteral(TAG_PREF_SUFFIX_TAG);</span>
<a href="#l7.179"></a><span id="l7.179">   return GetUnicharPref(prefName.get(), _retval);</span>
<a href="#l7.180"></a><span id="l7.180"> }</span>
<a href="#l7.181"></a><span id="l7.181"> </span>
<a href="#l7.182"></a><span id="l7.182"> /* void setTagForKey (in string key); */</span>
<a href="#l7.183"></a><span id="l7.183" class="difflineminus">-NS_IMETHODIMP nsMsgTagService::SetTagForKey(const nsACString &amp;key, const nsAString &amp;tag )</span>
<a href="#l7.184"></a><span id="l7.184" class="difflineminus">-{</span>
<a href="#l7.185"></a><span id="l7.185" class="difflineplus">+NS_IMETHODIMP nsMsgTagService::SetTagForKey(const nsACString &amp;key,</span>
<a href="#l7.186"></a><span id="l7.186" class="difflineplus">+                                            const nsAString &amp;tag) {</span>
<a href="#l7.187"></a><span id="l7.187">   nsAutoCString prefName(key);</span>
<a href="#l7.188"></a><span id="l7.188">   ToLowerCase(prefName);</span>
<a href="#l7.189"></a><span id="l7.189">   prefName.AppendLiteral(TAG_PREF_SUFFIX_TAG);</span>
<a href="#l7.190"></a><span id="l7.190">   return SetUnicharPref(prefName.get(), tag);</span>
<a href="#l7.191"></a><span id="l7.191"> }</span>
<a href="#l7.192"></a><span id="l7.192"> </span>
<a href="#l7.193"></a><span id="l7.193"> /* void getKeyForTag (in wstring tag); */</span>
<a href="#l7.194"></a><span id="l7.194" class="difflineminus">-NS_IMETHODIMP nsMsgTagService::GetKeyForTag(const nsAString &amp;aTag, nsACString &amp;aKey)</span>
<a href="#l7.195"></a><span id="l7.195" class="difflineminus">-{</span>
<a href="#l7.196"></a><span id="l7.196" class="difflineplus">+NS_IMETHODIMP nsMsgTagService::GetKeyForTag(const nsAString &amp;aTag,</span>
<a href="#l7.197"></a><span id="l7.197" class="difflineplus">+                                            nsACString &amp;aKey) {</span>
<a href="#l7.198"></a><span id="l7.198">   uint32_t count;</span>
<a href="#l7.199"></a><span id="l7.199">   char **prefList;</span>
<a href="#l7.200"></a><span id="l7.200">   nsresult rv = m_tagPrefBranch-&gt;GetChildList(&quot;&quot;, &amp;count, &amp;prefList);</span>
<a href="#l7.201"></a><span id="l7.201">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.202"></a><span id="l7.202">   // traverse the list, and look for a pref with the desired tag value.</span>
<a href="#l7.203"></a><span id="l7.203" class="difflineminus">-  for (uint32_t i = count; i--;)</span>
<a href="#l7.204"></a><span id="l7.204" class="difflineminus">-  {</span>
<a href="#l7.205"></a><span id="l7.205" class="difflineplus">+  for (uint32_t i = count; i--;) {</span>
<a href="#l7.206"></a><span id="l7.206">     // We are returned the tag prefs in the form &quot;&lt;key&gt;.&lt;tag_data_type&gt;&quot;, but</span>
<a href="#l7.207"></a><span id="l7.207">     // since we only want the tags, just check that the string ends with &quot;tag&quot;.</span>
<a href="#l7.208"></a><span id="l7.208">     nsDependentCString prefName(prefList[i]);</span>
<a href="#l7.209"></a><span id="l7.209" class="difflineminus">-    if (StringEndsWith(prefName, NS_LITERAL_CSTRING(TAG_PREF_SUFFIX_TAG)))</span>
<a href="#l7.210"></a><span id="l7.210" class="difflineminus">-    {</span>
<a href="#l7.211"></a><span id="l7.211" class="difflineplus">+    if (StringEndsWith(prefName, NS_LITERAL_CSTRING(TAG_PREF_SUFFIX_TAG))) {</span>
<a href="#l7.212"></a><span id="l7.212">       nsAutoString curTag;</span>
<a href="#l7.213"></a><span id="l7.213">       GetUnicharPref(prefList[i], curTag);</span>
<a href="#l7.214"></a><span id="l7.214" class="difflineminus">-      if (aTag.Equals(curTag))</span>
<a href="#l7.215"></a><span id="l7.215" class="difflineminus">-      {</span>
<a href="#l7.216"></a><span id="l7.216" class="difflineminus">-        aKey = Substring(prefName, 0, prefName.Length() - STRLEN(TAG_PREF_SUFFIX_TAG));</span>
<a href="#l7.217"></a><span id="l7.217" class="difflineplus">+      if (aTag.Equals(curTag)) {</span>
<a href="#l7.218"></a><span id="l7.218" class="difflineplus">+        aKey = Substring(prefName, 0,</span>
<a href="#l7.219"></a><span id="l7.219" class="difflineplus">+                         prefName.Length() - STRLEN(TAG_PREF_SUFFIX_TAG));</span>
<a href="#l7.220"></a><span id="l7.220">         break;</span>
<a href="#l7.221"></a><span id="l7.221">       }</span>
<a href="#l7.222"></a><span id="l7.222">     }</span>
<a href="#l7.223"></a><span id="l7.223">   }</span>
<a href="#l7.224"></a><span id="l7.224">   NS_FREE_XPCOM_ALLOCATED_POINTER_ARRAY(count, prefList);</span>
<a href="#l7.225"></a><span id="l7.225">   ToLowerCase(aKey);</span>
<a href="#l7.226"></a><span id="l7.226">   return NS_OK;</span>
<a href="#l7.227"></a><span id="l7.227"> }</span>
<a href="#l7.228"></a><span id="l7.228"> </span>
<a href="#l7.229"></a><span id="l7.229"> /* ACString getTopKey (in ACString keylist); */</span>
<a href="#l7.230"></a><span id="l7.230" class="difflineminus">-NS_IMETHODIMP nsMsgTagService::GetTopKey(const nsACString &amp; keyList, nsACString &amp; _retval)</span>
<a href="#l7.231"></a><span id="l7.231" class="difflineminus">-{</span>
<a href="#l7.232"></a><span id="l7.232" class="difflineplus">+NS_IMETHODIMP nsMsgTagService::GetTopKey(const nsACString &amp;keyList,</span>
<a href="#l7.233"></a><span id="l7.233" class="difflineplus">+                                         nsACString &amp;_retval) {</span>
<a href="#l7.234"></a><span id="l7.234">   _retval.Truncate();</span>
<a href="#l7.235"></a><span id="l7.235">   // find the most important key</span>
<a href="#l7.236"></a><span id="l7.236">   nsTArray&lt;nsCString&gt; keyArray;</span>
<a href="#l7.237"></a><span id="l7.237">   ParseString(keyList, ' ', keyArray);</span>
<a href="#l7.238"></a><span id="l7.238">   uint32_t keyCount = keyArray.Length();</span>
<a href="#l7.239"></a><span id="l7.239">   nsCString *topKey = nullptr, *key, topOrdinal, ordinal;</span>
<a href="#l7.240"></a><span id="l7.240" class="difflineminus">-  for (uint32_t i = 0; i &lt; keyCount; ++i)</span>
<a href="#l7.241"></a><span id="l7.241" class="difflineminus">-  {</span>
<a href="#l7.242"></a><span id="l7.242" class="difflineplus">+  for (uint32_t i = 0; i &lt; keyCount; ++i) {</span>
<a href="#l7.243"></a><span id="l7.243">     key = &amp;keyArray[i];</span>
<a href="#l7.244"></a><span id="l7.244" class="difflineminus">-    if (key-&gt;IsEmpty())</span>
<a href="#l7.245"></a><span id="l7.245" class="difflineminus">-      continue;</span>
<a href="#l7.246"></a><span id="l7.246" class="difflineplus">+    if (key-&gt;IsEmpty()) continue;</span>
<a href="#l7.247"></a><span id="l7.247"> </span>
<a href="#l7.248"></a><span id="l7.248">     // ignore unknown keywords</span>
<a href="#l7.249"></a><span id="l7.249">     nsAutoString tagValue;</span>
<a href="#l7.250"></a><span id="l7.250">     nsresult rv = GetTagForKey(*key, tagValue);</span>
<a href="#l7.251"></a><span id="l7.251" class="difflineminus">-    if (NS_FAILED(rv) || tagValue.IsEmpty())</span>
<a href="#l7.252"></a><span id="l7.252" class="difflineminus">-      continue;</span>
<a href="#l7.253"></a><span id="l7.253" class="difflineplus">+    if (NS_FAILED(rv) || tagValue.IsEmpty()) continue;</span>
<a href="#l7.254"></a><span id="l7.254"> </span>
<a href="#l7.255"></a><span id="l7.255">     // new top key, judged by ordinal order?</span>
<a href="#l7.256"></a><span id="l7.256">     rv = GetOrdinalForKey(*key, ordinal);</span>
<a href="#l7.257"></a><span id="l7.257" class="difflineminus">-    if (NS_FAILED(rv) || ordinal.IsEmpty())</span>
<a href="#l7.258"></a><span id="l7.258" class="difflineminus">-      ordinal = *key;</span>
<a href="#l7.259"></a><span id="l7.259" class="difflineminus">-    if ((ordinal &lt; topOrdinal) || topOrdinal.IsEmpty())</span>
<a href="#l7.260"></a><span id="l7.260" class="difflineminus">-    {</span>
<a href="#l7.261"></a><span id="l7.261" class="difflineplus">+    if (NS_FAILED(rv) || ordinal.IsEmpty()) ordinal = *key;</span>
<a href="#l7.262"></a><span id="l7.262" class="difflineplus">+    if ((ordinal &lt; topOrdinal) || topOrdinal.IsEmpty()) {</span>
<a href="#l7.263"></a><span id="l7.263">       topOrdinal = ordinal;</span>
<a href="#l7.264"></a><span id="l7.264" class="difflineminus">-      topKey = key; // copy actual result key only once - later</span>
<a href="#l7.265"></a><span id="l7.265" class="difflineplus">+      topKey = key;  // copy actual result key only once - later</span>
<a href="#l7.266"></a><span id="l7.266">     }</span>
<a href="#l7.267"></a><span id="l7.267">   }</span>
<a href="#l7.268"></a><span id="l7.268">   // return the most important key - if any</span>
<a href="#l7.269"></a><span id="l7.269" class="difflineminus">-  if (topKey)</span>
<a href="#l7.270"></a><span id="l7.270" class="difflineminus">-    _retval = *topKey;</span>
<a href="#l7.271"></a><span id="l7.271" class="difflineplus">+  if (topKey) _retval = *topKey;</span>
<a href="#l7.272"></a><span id="l7.272">   return NS_OK;</span>
<a href="#l7.273"></a><span id="l7.273"> }</span>
<a href="#l7.274"></a><span id="l7.274"> </span>
<a href="#l7.275"></a><span id="l7.275" class="difflineminus">-/* void addTagForKey (in string key, in wstring tag, in string color, in string ordinal); */</span>
<a href="#l7.276"></a><span id="l7.276" class="difflineplus">+/* void addTagForKey (in string key, in wstring tag, in string color, in string</span>
<a href="#l7.277"></a><span id="l7.277" class="difflineplus">+ * ordinal); */</span>
<a href="#l7.278"></a><span id="l7.278"> NS_IMETHODIMP nsMsgTagService::AddTagForKey(const nsACString &amp;key,</span>
<a href="#l7.279"></a><span id="l7.279" class="difflineminus">-                                            const nsAString  &amp;tag,</span>
<a href="#l7.280"></a><span id="l7.280" class="difflineplus">+                                            const nsAString &amp;tag,</span>
<a href="#l7.281"></a><span id="l7.281">                                             const nsACString &amp;color,</span>
<a href="#l7.282"></a><span id="l7.282" class="difflineminus">-                                            const nsACString &amp;ordinal)</span>
<a href="#l7.283"></a><span id="l7.283" class="difflineminus">-{</span>
<a href="#l7.284"></a><span id="l7.284" class="difflineplus">+                                            const nsACString &amp;ordinal) {</span>
<a href="#l7.285"></a><span id="l7.285">   nsAutoCString prefName(key);</span>
<a href="#l7.286"></a><span id="l7.286">   ToLowerCase(prefName);</span>
<a href="#l7.287"></a><span id="l7.287">   prefName.AppendLiteral(TAG_PREF_SUFFIX_TAG);</span>
<a href="#l7.288"></a><span id="l7.288">   nsresult rv = SetUnicharPref(prefName.get(), tag);</span>
<a href="#l7.289"></a><span id="l7.289">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.290"></a><span id="l7.290">   rv = SetColorForKey(key, color);</span>
<a href="#l7.291"></a><span id="l7.291">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.292"></a><span id="l7.292">   rv = RefreshKeyCache();</span>
<a href="#l7.293"></a><span id="l7.293">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.294"></a><span id="l7.294">   return SetOrdinalForKey(key, ordinal);</span>
<a href="#l7.295"></a><span id="l7.295"> }</span>
<a href="#l7.296"></a><span id="l7.296"> </span>
<a href="#l7.297"></a><span id="l7.297"> /* void addTag (in wstring tag, in long color); */</span>
<a href="#l7.298"></a><span id="l7.298" class="difflineminus">-NS_IMETHODIMP nsMsgTagService::AddTag(const nsAString  &amp;tag,</span>
<a href="#l7.299"></a><span id="l7.299" class="difflineplus">+NS_IMETHODIMP nsMsgTagService::AddTag(const nsAString &amp;tag,</span>
<a href="#l7.300"></a><span id="l7.300">                                       const nsACString &amp;color,</span>
<a href="#l7.301"></a><span id="l7.301" class="difflineminus">-                                      const nsACString &amp;ordinal)</span>
<a href="#l7.302"></a><span id="l7.302" class="difflineminus">-{</span>
<a href="#l7.303"></a><span id="l7.303" class="difflineplus">+                                      const nsACString &amp;ordinal) {</span>
<a href="#l7.304"></a><span id="l7.304">   // figure out key from tag. Apply transformation stripping out</span>
<a href="#l7.305"></a><span id="l7.305">   // illegal characters like &lt;SP&gt; and then convert to imap mod utf7.</span>
<a href="#l7.306"></a><span id="l7.306">   // Then, check if we have a tag with that key yet, and if so,</span>
<a href="#l7.307"></a><span id="l7.307">   // make it unique by appending A, AA, etc.</span>
<a href="#l7.308"></a><span id="l7.308">   // Should we use an iterator?</span>
<a href="#l7.309"></a><span id="l7.309">   nsAutoString transformedTag(tag);</span>
<a href="#l7.310"></a><span id="l7.310">   MsgReplaceChar(transformedTag, &quot; ()/{%*&lt;&gt;\\\&quot;&quot;, '_');</span>
<a href="#l7.311"></a><span id="l7.311">   nsAutoCString key;</span>
<a href="#l7.312"></a><span id="l7.312">   CopyUTF16toMUTF7(transformedTag, key);</span>
<a href="#l7.313"></a><span id="l7.313">   // We have an imap server that converts keys to upper case so we're going</span>
<a href="#l7.314"></a><span id="l7.314">   // to normalize all keys to lower case (upper case looks ugly in prefs.js)</span>
<a href="#l7.315"></a><span id="l7.315">   ToLowerCase(key);</span>
<a href="#l7.316"></a><span id="l7.316">   nsAutoCString prefName(key);</span>
<a href="#l7.317"></a><span id="l7.317" class="difflineminus">-  while (true)</span>
<a href="#l7.318"></a><span id="l7.318" class="difflineminus">-  {</span>
<a href="#l7.319"></a><span id="l7.319" class="difflineplus">+  while (true) {</span>
<a href="#l7.320"></a><span id="l7.320">     nsAutoString tagValue;</span>
<a href="#l7.321"></a><span id="l7.321">     nsresult rv = GetTagForKey(prefName, tagValue);</span>
<a href="#l7.322"></a><span id="l7.322">     if (NS_FAILED(rv) || tagValue.IsEmpty() || tagValue.Equals(tag))</span>
<a href="#l7.323"></a><span id="l7.323">       return AddTagForKey(prefName, tag, color, ordinal);</span>
<a href="#l7.324"></a><span id="l7.324">     prefName.Append('A');</span>
<a href="#l7.325"></a><span id="l7.325">   }</span>
<a href="#l7.326"></a><span id="l7.326">   NS_ASSERTION(false, &quot;can't get here&quot;);</span>
<a href="#l7.327"></a><span id="l7.327">   return NS_ERROR_FAILURE;</span>
<a href="#l7.328"></a><span id="l7.328"> }</span>
<a href="#l7.329"></a><span id="l7.329"> </span>
<a href="#l7.330"></a><span id="l7.330"> /* long getColorForKey (in string key); */</span>
<a href="#l7.331"></a><span id="l7.331" class="difflineminus">-NS_IMETHODIMP nsMsgTagService::GetColorForKey(const nsACString &amp;key, nsACString  &amp;_retval)</span>
<a href="#l7.332"></a><span id="l7.332" class="difflineminus">-{</span>
<a href="#l7.333"></a><span id="l7.333" class="difflineplus">+NS_IMETHODIMP nsMsgTagService::GetColorForKey(const nsACString &amp;key,</span>
<a href="#l7.334"></a><span id="l7.334" class="difflineplus">+                                              nsACString &amp;_retval) {</span>
<a href="#l7.335"></a><span id="l7.335">   nsAutoCString prefName(key);</span>
<a href="#l7.336"></a><span id="l7.336" class="difflineminus">-  if (!gMigratingKeys)</span>
<a href="#l7.337"></a><span id="l7.337" class="difflineminus">-    ToLowerCase(prefName);</span>
<a href="#l7.338"></a><span id="l7.338" class="difflineplus">+  if (!gMigratingKeys) ToLowerCase(prefName);</span>
<a href="#l7.339"></a><span id="l7.339">   prefName.AppendLiteral(TAG_PREF_SUFFIX_COLOR);</span>
<a href="#l7.340"></a><span id="l7.340">   nsCString color;</span>
<a href="#l7.341"></a><span id="l7.341">   nsresult rv = m_tagPrefBranch-&gt;GetCharPref(prefName.get(), color);</span>
<a href="#l7.342"></a><span id="l7.342" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l7.343"></a><span id="l7.343" class="difflineminus">-    _retval = color;</span>
<a href="#l7.344"></a><span id="l7.344" class="difflineplus">+  if (NS_SUCCEEDED(rv)) _retval = color;</span>
<a href="#l7.345"></a><span id="l7.345">   return NS_OK;</span>
<a href="#l7.346"></a><span id="l7.346"> }</span>
<a href="#l7.347"></a><span id="l7.347"> </span>
<a href="#l7.348"></a><span id="l7.348"> /* long getSelectorForKey (in ACString key, out AString selector); */</span>
<a href="#l7.349"></a><span id="l7.349" class="difflineminus">-NS_IMETHODIMP nsMsgTagService::GetSelectorForKey(const nsACString &amp;key, nsAString &amp;_retval)</span>
<a href="#l7.350"></a><span id="l7.350" class="difflineminus">-{</span>
<a href="#l7.351"></a><span id="l7.351" class="difflineplus">+NS_IMETHODIMP nsMsgTagService::GetSelectorForKey(const nsACString &amp;key,</span>
<a href="#l7.352"></a><span id="l7.352" class="difflineplus">+                                                 nsAString &amp;_retval) {</span>
<a href="#l7.353"></a><span id="l7.353">   // Our keys are the result of MUTF-7 encoding. For CSS selectors we need</span>
<a href="#l7.354"></a><span id="l7.354">   // to reduce this to 0-9A-Za-z_ with a leading alpha character.</span>
<a href="#l7.355"></a><span id="l7.355">   // We encode non-alphanumeric characters using _ as an escape character</span>
<a href="#l7.356"></a><span id="l7.356">   // and start with a leading T in all cases. This way users defining tags</span>
<a href="#l7.357"></a><span id="l7.357">   // &quot;selected&quot; or &quot;focus&quot; don't collide with inbuilt &quot;selected&quot; or &quot;focus&quot;.</span>
<a href="#l7.358"></a><span id="l7.358"> </span>
<a href="#l7.359"></a><span id="l7.359">   // Calculate length of selector string.</span>
<a href="#l7.360"></a><span id="l7.360">   const char *in = key.BeginReading();</span>
<a href="#l7.361"></a><span id="l7.361">   size_t outLen = 1;</span>
<a href="#l7.362"></a><span id="l7.362">   while (*in) {</span>
<a href="#l7.363"></a><span id="l7.363" class="difflineminus">-    if (('0' &lt;= *in &amp;&amp; *in &lt;= '9') ||</span>
<a href="#l7.364"></a><span id="l7.364" class="difflineminus">-        ('A' &lt;= *in &amp;&amp; *in &lt;= 'Z') ||</span>
<a href="#l7.365"></a><span id="l7.365" class="difflineplus">+    if (('0' &lt;= *in &amp;&amp; *in &lt;= '9') || ('A' &lt;= *in &amp;&amp; *in &lt;= 'Z') ||</span>
<a href="#l7.366"></a><span id="l7.366">         ('a' &lt;= *in &amp;&amp; *in &lt;= 'z')) {</span>
<a href="#l7.367"></a><span id="l7.367">       outLen++;</span>
<a href="#l7.368"></a><span id="l7.368">     } else {</span>
<a href="#l7.369"></a><span id="l7.369">       outLen += 3;</span>
<a href="#l7.370"></a><span id="l7.370">     }</span>
<a href="#l7.371"></a><span id="l7.371">     in++;</span>
<a href="#l7.372"></a><span id="l7.372">   }</span>
<a href="#l7.373"></a><span id="l7.373"> </span>
<a href="#l7.374"></a><span id="l7.374">   // Now fill selector string.</span>
<a href="#l7.375"></a><span id="l7.375">   _retval.SetCapacity(outLen);</span>
<a href="#l7.376"></a><span id="l7.376">   _retval.Assign('T');</span>
<a href="#l7.377"></a><span id="l7.377">   in = key.BeginReading();</span>
<a href="#l7.378"></a><span id="l7.378">   while (*in) {</span>
<a href="#l7.379"></a><span id="l7.379" class="difflineminus">-    if (('0' &lt;= *in &amp;&amp; *in &lt;= '9') ||</span>
<a href="#l7.380"></a><span id="l7.380" class="difflineminus">-        ('A' &lt;= *in &amp;&amp; *in &lt;= 'Z') ||</span>
<a href="#l7.381"></a><span id="l7.381" class="difflineplus">+    if (('0' &lt;= *in &amp;&amp; *in &lt;= '9') || ('A' &lt;= *in &amp;&amp; *in &lt;= 'Z') ||</span>
<a href="#l7.382"></a><span id="l7.382">         ('a' &lt;= *in &amp;&amp; *in &lt;= 'z')) {</span>
<a href="#l7.383"></a><span id="l7.383">       _retval.Append(*in);</span>
<a href="#l7.384"></a><span id="l7.384">     } else {</span>
<a href="#l7.385"></a><span id="l7.385">       _retval.AppendPrintf(&quot;_%02x&quot;, *in);</span>
<a href="#l7.386"></a><span id="l7.386">     }</span>
<a href="#l7.387"></a><span id="l7.387">     in++;</span>
<a href="#l7.388"></a><span id="l7.388">   }</span>
<a href="#l7.389"></a><span id="l7.389"> </span>
<a href="#l7.390"></a><span id="l7.390">   return NS_OK;</span>
<a href="#l7.391"></a><span id="l7.391"> }</span>
<a href="#l7.392"></a><span id="l7.392"> </span>
<a href="#l7.393"></a><span id="l7.393"> /* void setColorForKey (in ACString key, in ACString color); */</span>
<a href="#l7.394"></a><span id="l7.394" class="difflineminus">-NS_IMETHODIMP nsMsgTagService::SetColorForKey(const nsACString &amp; key, const nsACString &amp; color)</span>
<a href="#l7.395"></a><span id="l7.395" class="difflineminus">-{</span>
<a href="#l7.396"></a><span id="l7.396" class="difflineplus">+NS_IMETHODIMP nsMsgTagService::SetColorForKey(const nsACString &amp;key,</span>
<a href="#l7.397"></a><span id="l7.397" class="difflineplus">+                                              const nsACString &amp;color) {</span>
<a href="#l7.398"></a><span id="l7.398">   nsAutoCString prefName(key);</span>
<a href="#l7.399"></a><span id="l7.399">   ToLowerCase(prefName);</span>
<a href="#l7.400"></a><span id="l7.400">   prefName.AppendLiteral(TAG_PREF_SUFFIX_COLOR);</span>
<a href="#l7.401"></a><span id="l7.401" class="difflineminus">-  if (color.IsEmpty())</span>
<a href="#l7.402"></a><span id="l7.402" class="difflineminus">-  {</span>
<a href="#l7.403"></a><span id="l7.403" class="difflineplus">+  if (color.IsEmpty()) {</span>
<a href="#l7.404"></a><span id="l7.404">     m_tagPrefBranch-&gt;ClearUserPref(prefName.get());</span>
<a href="#l7.405"></a><span id="l7.405">     return NS_OK;</span>
<a href="#l7.406"></a><span id="l7.406">   }</span>
<a href="#l7.407"></a><span id="l7.407">   return m_tagPrefBranch-&gt;SetCharPref(prefName.get(), color);</span>
<a href="#l7.408"></a><span id="l7.408"> }</span>
<a href="#l7.409"></a><span id="l7.409"> </span>
<a href="#l7.410"></a><span id="l7.410"> /* ACString getOrdinalForKey (in ACString key); */</span>
<a href="#l7.411"></a><span id="l7.411" class="difflineminus">-NS_IMETHODIMP nsMsgTagService::GetOrdinalForKey(const nsACString &amp; key, nsACString &amp; _retval)</span>
<a href="#l7.412"></a><span id="l7.412" class="difflineminus">-{</span>
<a href="#l7.413"></a><span id="l7.413" class="difflineplus">+NS_IMETHODIMP nsMsgTagService::GetOrdinalForKey(const nsACString &amp;key,</span>
<a href="#l7.414"></a><span id="l7.414" class="difflineplus">+                                                nsACString &amp;_retval) {</span>
<a href="#l7.415"></a><span id="l7.415">   nsAutoCString prefName(key);</span>
<a href="#l7.416"></a><span id="l7.416" class="difflineminus">-  if (!gMigratingKeys)</span>
<a href="#l7.417"></a><span id="l7.417" class="difflineminus">-    ToLowerCase(prefName);</span>
<a href="#l7.418"></a><span id="l7.418" class="difflineplus">+  if (!gMigratingKeys) ToLowerCase(prefName);</span>
<a href="#l7.419"></a><span id="l7.419">   prefName.AppendLiteral(TAG_PREF_SUFFIX_ORDINAL);</span>
<a href="#l7.420"></a><span id="l7.420">   nsCString ordinal;</span>
<a href="#l7.421"></a><span id="l7.421">   nsresult rv = m_tagPrefBranch-&gt;GetCharPref(prefName.get(), ordinal);</span>
<a href="#l7.422"></a><span id="l7.422">   _retval = ordinal;</span>
<a href="#l7.423"></a><span id="l7.423">   return rv;</span>
<a href="#l7.424"></a><span id="l7.424"> }</span>
<a href="#l7.425"></a><span id="l7.425"> </span>
<a href="#l7.426"></a><span id="l7.426"> /* void setOrdinalForKey (in ACString key, in ACString ordinal); */</span>
<a href="#l7.427"></a><span id="l7.427" class="difflineminus">-NS_IMETHODIMP nsMsgTagService::SetOrdinalForKey(const nsACString &amp; key, const nsACString &amp; ordinal)</span>
<a href="#l7.428"></a><span id="l7.428" class="difflineminus">-{</span>
<a href="#l7.429"></a><span id="l7.429" class="difflineplus">+NS_IMETHODIMP nsMsgTagService::SetOrdinalForKey(const nsACString &amp;key,</span>
<a href="#l7.430"></a><span id="l7.430" class="difflineplus">+                                                const nsACString &amp;ordinal) {</span>
<a href="#l7.431"></a><span id="l7.431">   nsAutoCString prefName(key);</span>
<a href="#l7.432"></a><span id="l7.432">   ToLowerCase(prefName);</span>
<a href="#l7.433"></a><span id="l7.433">   prefName.AppendLiteral(TAG_PREF_SUFFIX_ORDINAL);</span>
<a href="#l7.434"></a><span id="l7.434" class="difflineminus">-  if (ordinal.IsEmpty())</span>
<a href="#l7.435"></a><span id="l7.435" class="difflineminus">-  {</span>
<a href="#l7.436"></a><span id="l7.436" class="difflineplus">+  if (ordinal.IsEmpty()) {</span>
<a href="#l7.437"></a><span id="l7.437">     m_tagPrefBranch-&gt;ClearUserPref(prefName.get());</span>
<a href="#l7.438"></a><span id="l7.438">     return NS_OK;</span>
<a href="#l7.439"></a><span id="l7.439">   }</span>
<a href="#l7.440"></a><span id="l7.440">   return m_tagPrefBranch-&gt;SetCharPref(prefName.get(), ordinal);</span>
<a href="#l7.441"></a><span id="l7.441"> }</span>
<a href="#l7.442"></a><span id="l7.442"> </span>
<a href="#l7.443"></a><span id="l7.443"> /* void deleteTag (in wstring tag); */</span>
<a href="#l7.444"></a><span id="l7.444" class="difflineminus">-NS_IMETHODIMP nsMsgTagService::DeleteKey(const nsACString &amp;key)</span>
<a href="#l7.445"></a><span id="l7.445" class="difflineminus">-{</span>
<a href="#l7.446"></a><span id="l7.446" class="difflineplus">+NS_IMETHODIMP nsMsgTagService::DeleteKey(const nsACString &amp;key) {</span>
<a href="#l7.447"></a><span id="l7.447">   // clear the associated prefs</span>
<a href="#l7.448"></a><span id="l7.448">   nsAutoCString prefName(key);</span>
<a href="#l7.449"></a><span id="l7.449" class="difflineminus">-  if (!gMigratingKeys)</span>
<a href="#l7.450"></a><span id="l7.450" class="difflineminus">-    ToLowerCase(prefName);</span>
<a href="#l7.451"></a><span id="l7.451" class="difflineplus">+  if (!gMigratingKeys) ToLowerCase(prefName);</span>
<a href="#l7.452"></a><span id="l7.452">   nsresult rv = m_tagPrefBranch-&gt;DeleteBranch(prefName.get());</span>
<a href="#l7.453"></a><span id="l7.453">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.454"></a><span id="l7.454">   return RefreshKeyCache();</span>
<a href="#l7.455"></a><span id="l7.455"> }</span>
<a href="#l7.456"></a><span id="l7.456"> </span>
<a href="#l7.457"></a><span id="l7.457" class="difflineminus">-/* void getAllTags (out unsigned long count, [array, size_is (count), retval] out nsIMsgTag tagArray); */</span>
<a href="#l7.458"></a><span id="l7.458" class="difflineminus">-NS_IMETHODIMP nsMsgTagService::GetAllTags(uint32_t *aCount, nsIMsgTag ***aTagArray)</span>
<a href="#l7.459"></a><span id="l7.459" class="difflineminus">-{</span>
<a href="#l7.460"></a><span id="l7.460" class="difflineplus">+/* void getAllTags (out unsigned long count, [array, size_is (count), retval]</span>
<a href="#l7.461"></a><span id="l7.461" class="difflineplus">+ * out nsIMsgTag tagArray); */</span>
<a href="#l7.462"></a><span id="l7.462" class="difflineplus">+NS_IMETHODIMP nsMsgTagService::GetAllTags(uint32_t *aCount,</span>
<a href="#l7.463"></a><span id="l7.463" class="difflineplus">+                                          nsIMsgTag ***aTagArray) {</span>
<a href="#l7.464"></a><span id="l7.464">   NS_ENSURE_ARG_POINTER(aCount);</span>
<a href="#l7.465"></a><span id="l7.465">   NS_ENSURE_ARG_POINTER(aTagArray);</span>
<a href="#l7.466"></a><span id="l7.466"> </span>
<a href="#l7.467"></a><span id="l7.467">   // preset harmless default values</span>
<a href="#l7.468"></a><span id="l7.468">   *aCount = 0;</span>
<a href="#l7.469"></a><span id="l7.469">   *aTagArray = nullptr;</span>
<a href="#l7.470"></a><span id="l7.470"> </span>
<a href="#l7.471"></a><span id="l7.471">   // get the actual tag definitions</span>
<a href="#l7.472"></a><span id="l7.472">   nsresult rv;</span>
<a href="#l7.473"></a><span id="l7.473">   uint32_t prefCount;</span>
<a href="#l7.474"></a><span id="l7.474">   char **prefList;</span>
<a href="#l7.475"></a><span id="l7.475">   rv = m_tagPrefBranch-&gt;GetChildList(&quot;&quot;, &amp;prefCount, &amp;prefList);</span>
<a href="#l7.476"></a><span id="l7.476">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.477"></a><span id="l7.477">   // sort them by key for ease of processing</span>
<a href="#l7.478"></a><span id="l7.478" class="difflineminus">-  qsort(prefList, prefCount, sizeof(char*), CompareMsgTagKeys);</span>
<a href="#l7.479"></a><span id="l7.479" class="difflineplus">+  qsort(prefList, prefCount, sizeof(char *), CompareMsgTagKeys);</span>
<a href="#l7.480"></a><span id="l7.480"> </span>
<a href="#l7.481"></a><span id="l7.481">   // build an array of nsIMsgTag elements from the orderered list</span>
<a href="#l7.482"></a><span id="l7.482">   // it's at max the same size as the preflist, but usually only about half</span>
<a href="#l7.483"></a><span id="l7.483" class="difflineminus">-  nsIMsgTag** tagArray = (nsIMsgTag**) moz_xmalloc(sizeof(nsIMsgTag*) * prefCount);</span>
<a href="#l7.484"></a><span id="l7.484" class="difflineplus">+  nsIMsgTag **tagArray =</span>
<a href="#l7.485"></a><span id="l7.485" class="difflineplus">+      (nsIMsgTag **)moz_xmalloc(sizeof(nsIMsgTag *) * prefCount);</span>
<a href="#l7.486"></a><span id="l7.486"> </span>
<a href="#l7.487"></a><span id="l7.487" class="difflineminus">-  if (!tagArray)</span>
<a href="#l7.488"></a><span id="l7.488" class="difflineminus">-  {</span>
<a href="#l7.489"></a><span id="l7.489" class="difflineplus">+  if (!tagArray) {</span>
<a href="#l7.490"></a><span id="l7.490">     NS_FREE_XPCOM_ALLOCATED_POINTER_ARRAY(prefCount, prefList);</span>
<a href="#l7.491"></a><span id="l7.491">     return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l7.492"></a><span id="l7.492">   }</span>
<a href="#l7.493"></a><span id="l7.493">   uint32_t currentTagIndex = 0;</span>
<a href="#l7.494"></a><span id="l7.494">   nsMsgTag *newMsgTag;</span>
<a href="#l7.495"></a><span id="l7.495">   nsString tag;</span>
<a href="#l7.496"></a><span id="l7.496">   nsCString lastKey, color, ordinal;</span>
<a href="#l7.497"></a><span id="l7.497" class="difflineminus">-  for (uint32_t i = prefCount; i--;)</span>
<a href="#l7.498"></a><span id="l7.498" class="difflineminus">-  {</span>
<a href="#l7.499"></a><span id="l7.499" class="difflineplus">+  for (uint32_t i = prefCount; i--;) {</span>
<a href="#l7.500"></a><span id="l7.500">     // extract just the key from &lt;key&gt;.&lt;info=tag|color|ordinal&gt;</span>
<a href="#l7.501"></a><span id="l7.501">     char *info = strrchr(prefList[i], '.');</span>
<a href="#l7.502"></a><span id="l7.502" class="difflineminus">-    if (info)</span>
<a href="#l7.503"></a><span id="l7.503" class="difflineminus">-    {</span>
<a href="#l7.504"></a><span id="l7.504" class="difflineplus">+    if (info) {</span>
<a href="#l7.505"></a><span id="l7.505">       nsAutoCString key(Substring(prefList[i], info));</span>
<a href="#l7.506"></a><span id="l7.506" class="difflineminus">-      if (key != lastKey)</span>
<a href="#l7.507"></a><span id="l7.507" class="difflineminus">-      {</span>
<a href="#l7.508"></a><span id="l7.508" class="difflineminus">-        if (!key.IsEmpty())</span>
<a href="#l7.509"></a><span id="l7.509" class="difflineminus">-        {</span>
<a href="#l7.510"></a><span id="l7.510" class="difflineplus">+      if (key != lastKey) {</span>
<a href="#l7.511"></a><span id="l7.511" class="difflineplus">+        if (!key.IsEmpty()) {</span>
<a href="#l7.512"></a><span id="l7.512">           // .tag MUST exist (but may be empty)</span>
<a href="#l7.513"></a><span id="l7.513">           rv = GetTagForKey(key, tag);</span>
<a href="#l7.514"></a><span id="l7.514" class="difflineminus">-          if (NS_SUCCEEDED(rv))</span>
<a href="#l7.515"></a><span id="l7.515" class="difflineminus">-          {</span>
<a href="#l7.516"></a><span id="l7.516" class="difflineplus">+          if (NS_SUCCEEDED(rv)) {</span>
<a href="#l7.517"></a><span id="l7.517">             // .color MAY exist</span>
<a href="#l7.518"></a><span id="l7.518">             color.Truncate();</span>
<a href="#l7.519"></a><span id="l7.519">             GetColorForKey(key, color);</span>
<a href="#l7.520"></a><span id="l7.520">             // .ordinal MAY exist</span>
<a href="#l7.521"></a><span id="l7.521">             rv = GetOrdinalForKey(key, ordinal);</span>
<a href="#l7.522"></a><span id="l7.522" class="difflineminus">-            if (NS_FAILED(rv))</span>
<a href="#l7.523"></a><span id="l7.523" class="difflineminus">-              ordinal.Truncate();</span>
<a href="#l7.524"></a><span id="l7.524" class="difflineplus">+            if (NS_FAILED(rv)) ordinal.Truncate();</span>
<a href="#l7.525"></a><span id="l7.525">             // store the tag info in our array</span>
<a href="#l7.526"></a><span id="l7.526">             newMsgTag = new nsMsgTag(key, tag, color, ordinal);</span>
<a href="#l7.527"></a><span id="l7.527" class="difflineminus">-            if (!newMsgTag)</span>
<a href="#l7.528"></a><span id="l7.528" class="difflineminus">-            {</span>
<a href="#l7.529"></a><span id="l7.529" class="difflineplus">+            if (!newMsgTag) {</span>
<a href="#l7.530"></a><span id="l7.530">               NS_FREE_XPCOM_ISUPPORTS_POINTER_ARRAY(currentTagIndex, tagArray);</span>
<a href="#l7.531"></a><span id="l7.531">               NS_FREE_XPCOM_ALLOCATED_POINTER_ARRAY(prefCount, prefList);</span>
<a href="#l7.532"></a><span id="l7.532">               return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l7.533"></a><span id="l7.533">             }</span>
<a href="#l7.534"></a><span id="l7.534">             NS_ADDREF(tagArray[currentTagIndex++] = newMsgTag);</span>
<a href="#l7.535"></a><span id="l7.535">           }</span>
<a href="#l7.536"></a><span id="l7.536">         }</span>
<a href="#l7.537"></a><span id="l7.537">         lastKey = key;</span>
<a href="#l7.538"></a><span id="l7.538">       }</span>
<a href="#l7.539"></a><span id="l7.539">     }</span>
<a href="#l7.540"></a><span id="l7.540">   }</span>
<a href="#l7.541"></a><span id="l7.541">   NS_FREE_XPCOM_ALLOCATED_POINTER_ARRAY(prefCount, prefList);</span>
<a href="#l7.542"></a><span id="l7.542"> </span>
<a href="#l7.543"></a><span id="l7.543">   // sort the non-null entries by ordinal</span>
<a href="#l7.544"></a><span id="l7.544" class="difflineminus">-  qsort(tagArray, currentTagIndex, sizeof(nsMsgTag*), CompareMsgTags);</span>
<a href="#l7.545"></a><span id="l7.545" class="difflineplus">+  qsort(tagArray, currentTagIndex, sizeof(nsMsgTag *), CompareMsgTags);</span>
<a href="#l7.546"></a><span id="l7.546"> </span>
<a href="#l7.547"></a><span id="l7.547">   // All done, now return the values (the idl's size_is(count) parameter</span>
<a href="#l7.548"></a><span id="l7.548">   // ensures that the array is cut accordingly).</span>
<a href="#l7.549"></a><span id="l7.549">   *aCount = currentTagIndex;</span>
<a href="#l7.550"></a><span id="l7.550">   *aTagArray = tagArray;</span>
<a href="#l7.551"></a><span id="l7.551"> </span>
<a href="#l7.552"></a><span id="l7.552">   return NS_OK;</span>
<a href="#l7.553"></a><span id="l7.553"> }</span>
<a href="#l7.554"></a><span id="l7.554"> </span>
<a href="#l7.555"></a><span id="l7.555"> nsresult nsMsgTagService::SetUnicharPref(const char *prefName,</span>
<a href="#l7.556"></a><span id="l7.556" class="difflineminus">-                              const nsAString &amp;val)</span>
<a href="#l7.557"></a><span id="l7.557" class="difflineminus">-{</span>
<a href="#l7.558"></a><span id="l7.558" class="difflineplus">+                                         const nsAString &amp;val) {</span>
<a href="#l7.559"></a><span id="l7.559">   nsresult rv = NS_OK;</span>
<a href="#l7.560"></a><span id="l7.560" class="difflineminus">-  if (!val.IsEmpty())</span>
<a href="#l7.561"></a><span id="l7.561" class="difflineminus">-  {</span>
<a href="#l7.562"></a><span id="l7.562" class="difflineplus">+  if (!val.IsEmpty()) {</span>
<a href="#l7.563"></a><span id="l7.563">     rv = m_tagPrefBranch-&gt;SetStringPref(prefName, NS_ConvertUTF16toUTF8(val));</span>
<a href="#l7.564"></a><span id="l7.564" class="difflineminus">-  }</span>
<a href="#l7.565"></a><span id="l7.565" class="difflineminus">-  else</span>
<a href="#l7.566"></a><span id="l7.566" class="difflineminus">-  {</span>
<a href="#l7.567"></a><span id="l7.567" class="difflineplus">+  } else {</span>
<a href="#l7.568"></a><span id="l7.568">     m_tagPrefBranch-&gt;ClearUserPref(prefName);</span>
<a href="#l7.569"></a><span id="l7.569">   }</span>
<a href="#l7.570"></a><span id="l7.570">   return rv;</span>
<a href="#l7.571"></a><span id="l7.571"> }</span>
<a href="#l7.572"></a><span id="l7.572"> </span>
<a href="#l7.573"></a><span id="l7.573"> nsresult nsMsgTagService::GetUnicharPref(const char *prefName,</span>
<a href="#l7.574"></a><span id="l7.574" class="difflineminus">-                              nsAString &amp;prefValue)</span>
<a href="#l7.575"></a><span id="l7.575" class="difflineminus">-{</span>
<a href="#l7.576"></a><span id="l7.576" class="difflineplus">+                                         nsAString &amp;prefValue) {</span>
<a href="#l7.577"></a><span id="l7.577">   nsCString valueUtf8;</span>
<a href="#l7.578"></a><span id="l7.578" class="difflineminus">-  nsresult rv = m_tagPrefBranch-&gt;GetStringPref(prefName, EmptyCString(), 0, valueUtf8);</span>
<a href="#l7.579"></a><span id="l7.579" class="difflineplus">+  nsresult rv =</span>
<a href="#l7.580"></a><span id="l7.580" class="difflineplus">+      m_tagPrefBranch-&gt;GetStringPref(prefName, EmptyCString(), 0, valueUtf8);</span>
<a href="#l7.581"></a><span id="l7.581">   CopyUTF8toUTF16(valueUtf8, prefValue);</span>
<a href="#l7.582"></a><span id="l7.582">   return rv;</span>
<a href="#l7.583"></a><span id="l7.583"> }</span>
<a href="#l7.584"></a><span id="l7.584"> </span>
<a href="#l7.585"></a><span id="l7.585" class="difflineminus">-</span>
<a href="#l7.586"></a><span id="l7.586" class="difflineminus">-nsresult nsMsgTagService::MigrateLabelsToTags()</span>
<a href="#l7.587"></a><span id="l7.587" class="difflineminus">-{</span>
<a href="#l7.588"></a><span id="l7.588" class="difflineplus">+nsresult nsMsgTagService::MigrateLabelsToTags() {</span>
<a href="#l7.589"></a><span id="l7.589">   nsCString prefString;</span>
<a href="#l7.590"></a><span id="l7.590"> </span>
<a href="#l7.591"></a><span id="l7.591">   int32_t prefVersion = 0;</span>
<a href="#l7.592"></a><span id="l7.592">   nsresult rv = m_tagPrefBranch-&gt;GetIntPref(TAG_PREF_VERSION, &amp;prefVersion);</span>
<a href="#l7.593"></a><span id="l7.593">   if (NS_SUCCEEDED(rv) &amp;&amp; prefVersion &gt; 1)</span>
<a href="#l7.594"></a><span id="l7.594">     return rv;</span>
<a href="#l7.595"></a><span id="l7.595" class="difflineminus">-  else if (prefVersion == 1)</span>
<a href="#l7.596"></a><span id="l7.596" class="difflineminus">-  {</span>
<a href="#l7.597"></a><span id="l7.597" class="difflineplus">+  else if (prefVersion == 1) {</span>
<a href="#l7.598"></a><span id="l7.598">     gMigratingKeys = true;</span>
<a href="#l7.599"></a><span id="l7.599" class="difflineminus">-  // need to convert the keys to lower case</span>
<a href="#l7.600"></a><span id="l7.600" class="difflineplus">+    // need to convert the keys to lower case</span>
<a href="#l7.601"></a><span id="l7.601">     nsIMsgTag **tagArray;</span>
<a href="#l7.602"></a><span id="l7.602">     uint32_t numTags;</span>
<a href="#l7.603"></a><span id="l7.603">     GetAllTags(&amp;numTags, &amp;tagArray);</span>
<a href="#l7.604"></a><span id="l7.604" class="difflineminus">-    for (uint32_t tagIndex = 0; tagIndex &lt; numTags; tagIndex++)</span>
<a href="#l7.605"></a><span id="l7.605" class="difflineminus">-    {</span>
<a href="#l7.606"></a><span id="l7.606" class="difflineplus">+    for (uint32_t tagIndex = 0; tagIndex &lt; numTags; tagIndex++) {</span>
<a href="#l7.607"></a><span id="l7.607">       nsAutoCString key, color, ordinal;</span>
<a href="#l7.608"></a><span id="l7.608">       nsAutoString tagStr;</span>
<a href="#l7.609"></a><span id="l7.609">       nsIMsgTag *tag = tagArray[tagIndex];</span>
<a href="#l7.610"></a><span id="l7.610">       tag-&gt;GetKey(key);</span>
<a href="#l7.611"></a><span id="l7.611">       tag-&gt;GetTag(tagStr);</span>
<a href="#l7.612"></a><span id="l7.612">       tag-&gt;GetOrdinal(ordinal);</span>
<a href="#l7.613"></a><span id="l7.613">       tag-&gt;GetColor(color);</span>
<a href="#l7.614"></a><span id="l7.614">       DeleteKey(key);</span>
<a href="#l7.615"></a><span id="l7.615">       ToLowerCase(key);</span>
<a href="#l7.616"></a><span id="l7.616">       AddTagForKey(key, tagStr, color, ordinal);</span>
<a href="#l7.617"></a><span id="l7.617">     }</span>
<a href="#l7.618"></a><span id="l7.618">     NS_FREE_XPCOM_ISUPPORTS_POINTER_ARRAY(numTags, tagArray);</span>
<a href="#l7.619"></a><span id="l7.619">     gMigratingKeys = false;</span>
<a href="#l7.620"></a><span id="l7.620" class="difflineminus">-  }</span>
<a href="#l7.621"></a><span id="l7.621" class="difflineminus">-  else</span>
<a href="#l7.622"></a><span id="l7.622" class="difflineminus">-  {</span>
<a href="#l7.623"></a><span id="l7.623" class="difflineplus">+  } else {</span>
<a href="#l7.624"></a><span id="l7.624">     nsCOMPtr&lt;nsIPrefBranch&gt; prefRoot(do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l7.625"></a><span id="l7.625">     nsCOMPtr&lt;nsIPrefLocalizedString&gt; pls;</span>
<a href="#l7.626"></a><span id="l7.626">     nsString ucsval;</span>
<a href="#l7.627"></a><span id="l7.627">     nsAutoCString labelKey(&quot;$label1&quot;);</span>
<a href="#l7.628"></a><span id="l7.628" class="difflineminus">-    for(int32_t i = 0; i &lt; PREF_LABELS_MAX; )</span>
<a href="#l7.629"></a><span id="l7.629" class="difflineminus">-    {</span>
<a href="#l7.630"></a><span id="l7.630" class="difflineplus">+    for (int32_t i = 0; i &lt; PREF_LABELS_MAX;) {</span>
<a href="#l7.631"></a><span id="l7.631">       prefString.Assign(PREF_LABELS_DESCRIPTION);</span>
<a href="#l7.632"></a><span id="l7.632">       prefString.AppendInt(i + 1);</span>
<a href="#l7.633"></a><span id="l7.633">       rv = prefRoot-&gt;GetComplexValue(prefString.get(),</span>
<a href="#l7.634"></a><span id="l7.634">                                      NS_GET_IID(nsIPrefLocalizedString),</span>
<a href="#l7.635"></a><span id="l7.635">                                      getter_AddRefs(pls));</span>
<a href="#l7.636"></a><span id="l7.636">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.637"></a><span id="l7.637">       pls-&gt;ToString(getter_Copies(ucsval));</span>
<a href="#l7.638"></a><span id="l7.638"> </span>
<a href="#l7.639"></a><span id="l7.639" class="difflineat">@@ -542,34 +478,32 @@ nsresult nsMsgTagService::MigrateLabelsT</span>
<a href="#l7.640"></a><span id="l7.640">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.641"></a><span id="l7.641">       labelKey.SetCharAt(++i + '1', 6);</span>
<a href="#l7.642"></a><span id="l7.642">     }</span>
<a href="#l7.643"></a><span id="l7.643">   }</span>
<a href="#l7.644"></a><span id="l7.644">   m_tagPrefBranch-&gt;SetIntPref(TAG_PREF_VERSION, 2);</span>
<a href="#l7.645"></a><span id="l7.645">   return rv;</span>
<a href="#l7.646"></a><span id="l7.646"> }</span>
<a href="#l7.647"></a><span id="l7.647"> </span>
<a href="#l7.648"></a><span id="l7.648" class="difflineminus">-NS_IMETHODIMP nsMsgTagService::IsValidKey(const nsACString &amp;aKey, bool *aResult)</span>
<a href="#l7.649"></a><span id="l7.649" class="difflineminus">-{</span>
<a href="#l7.650"></a><span id="l7.650" class="difflineplus">+NS_IMETHODIMP nsMsgTagService::IsValidKey(const nsACString &amp;aKey,</span>
<a href="#l7.651"></a><span id="l7.651" class="difflineplus">+                                          bool *aResult) {</span>
<a href="#l7.652"></a><span id="l7.652">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l7.653"></a><span id="l7.653">   *aResult = m_keys.Contains(aKey);</span>
<a href="#l7.654"></a><span id="l7.654">   return NS_OK;</span>
<a href="#l7.655"></a><span id="l7.655"> }</span>
<a href="#l7.656"></a><span id="l7.656"> </span>
<a href="#l7.657"></a><span id="l7.657"> // refresh the local tag key array m_keys from preferences</span>
<a href="#l7.658"></a><span id="l7.658" class="difflineminus">-nsresult nsMsgTagService::RefreshKeyCache()</span>
<a href="#l7.659"></a><span id="l7.659" class="difflineminus">-{</span>
<a href="#l7.660"></a><span id="l7.660" class="difflineplus">+nsresult nsMsgTagService::RefreshKeyCache() {</span>
<a href="#l7.661"></a><span id="l7.661">   nsIMsgTag **tagArray;</span>
<a href="#l7.662"></a><span id="l7.662">   uint32_t numTags;</span>
<a href="#l7.663"></a><span id="l7.663">   nsresult rv = GetAllTags(&amp;numTags, &amp;tagArray);</span>
<a href="#l7.664"></a><span id="l7.664">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.665"></a><span id="l7.665">   m_keys.Clear();</span>
<a href="#l7.666"></a><span id="l7.666"> </span>
<a href="#l7.667"></a><span id="l7.667" class="difflineminus">-  for (uint32_t tagIndex = 0; tagIndex &lt; numTags; tagIndex++)</span>
<a href="#l7.668"></a><span id="l7.668" class="difflineminus">-  {</span>
<a href="#l7.669"></a><span id="l7.669" class="difflineplus">+  for (uint32_t tagIndex = 0; tagIndex &lt; numTags; tagIndex++) {</span>
<a href="#l7.670"></a><span id="l7.670">     nsIMsgTag *tag = tagArray[tagIndex];</span>
<a href="#l7.671"></a><span id="l7.671">     if (!tag) {</span>
<a href="#l7.672"></a><span id="l7.672">       rv = NS_ERROR_FAILURE;</span>
<a href="#l7.673"></a><span id="l7.673">       break;</span>
<a href="#l7.674"></a><span id="l7.674">     }</span>
<a href="#l7.675"></a><span id="l7.675">     nsAutoCString key;</span>
<a href="#l7.676"></a><span id="l7.676">     tag-&gt;GetKey(key);</span>
<a href="#l7.677"></a><span id="l7.677">     if (!m_keys.InsertElementAt(tagIndex, key)) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/base/src/nsMsgTagService.h</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgTagService.h</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -7,51 +7,44 @@</span>
<a href="#l8.4"></a><span id="l8.4"> #define nsMsgTagService_h__</span>
<a href="#l8.5"></a><span id="l8.5"> </span>
<a href="#l8.6"></a><span id="l8.6"> #include &quot;nsIMsgTagService.h&quot;</span>
<a href="#l8.7"></a><span id="l8.7"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l8.8"></a><span id="l8.8"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l8.9"></a><span id="l8.9"> #include &quot;nsString.h&quot;</span>
<a href="#l8.10"></a><span id="l8.10"> #include &quot;nsTArray.h&quot;</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-class nsMsgTag final : public nsIMsgTag</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-{</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineminus">-public:</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+class nsMsgTag final : public nsIMsgTag {</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+ public:</span>
<a href="#l8.17"></a><span id="l8.17">   NS_DECL_ISUPPORTS</span>
<a href="#l8.18"></a><span id="l8.18">   NS_DECL_NSIMSGTAG</span>
<a href="#l8.19"></a><span id="l8.19"> </span>
<a href="#l8.20"></a><span id="l8.20" class="difflineminus">-  nsMsgTag(const nsACString &amp;aKey,</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineminus">-           const nsAString  &amp;aTag,</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineminus">-           const nsACString &amp;aColor,</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineminus">-           const nsACString &amp;aOrdinal);</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+  nsMsgTag(const nsACString &amp;aKey, const nsAString &amp;aTag,</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineplus">+           const nsACString &amp;aColor, const nsACString &amp;aOrdinal);</span>
<a href="#l8.26"></a><span id="l8.26"> </span>
<a href="#l8.27"></a><span id="l8.27" class="difflineminus">-protected:</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineplus">+ protected:</span>
<a href="#l8.29"></a><span id="l8.29">   ~nsMsgTag();</span>
<a href="#l8.30"></a><span id="l8.30"> </span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-  nsString  mTag;</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+  nsString mTag;</span>
<a href="#l8.33"></a><span id="l8.33">   nsCString mKey, mColor, mOrdinal;</span>
<a href="#l8.34"></a><span id="l8.34"> };</span>
<a href="#l8.35"></a><span id="l8.35"> </span>
<a href="#l8.36"></a><span id="l8.36" class="difflineminus">-</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineminus">-class nsMsgTagService final : public nsIMsgTagService</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineminus">-{</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineminus">-public:</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineplus">+class nsMsgTagService final : public nsIMsgTagService {</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineplus">+ public:</span>
<a href="#l8.42"></a><span id="l8.42">   NS_DECL_ISUPPORTS</span>
<a href="#l8.43"></a><span id="l8.43">   NS_DECL_NSIMSGTAGSERVICE</span>
<a href="#l8.44"></a><span id="l8.44"> </span>
<a href="#l8.45"></a><span id="l8.45">   nsMsgTagService();</span>
<a href="#l8.46"></a><span id="l8.46"> </span>
<a href="#l8.47"></a><span id="l8.47" class="difflineminus">-private:</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineplus">+ private:</span>
<a href="#l8.49"></a><span id="l8.49">   ~nsMsgTagService();</span>
<a href="#l8.50"></a><span id="l8.50"> </span>
<a href="#l8.51"></a><span id="l8.51" class="difflineminus">-protected:</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineminus">-  nsresult SetUnicharPref(const char *prefName,</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineminus">-                          const nsAString &amp;prefValue);</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineminus">-  nsresult GetUnicharPref(const char *prefName,</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineminus">-                          nsAString &amp;prefValue);</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineplus">+ protected:</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineplus">+  nsresult SetUnicharPref(const char *prefName, const nsAString &amp;prefValue);</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineplus">+  nsresult GetUnicharPref(const char *prefName, nsAString &amp;prefValue);</span>
<a href="#l8.59"></a><span id="l8.59">   nsresult MigrateLabelsToTags();</span>
<a href="#l8.60"></a><span id="l8.60">   nsresult RefreshKeyCache();</span>
<a href="#l8.61"></a><span id="l8.61"> </span>
<a href="#l8.62"></a><span id="l8.62">   nsCOMPtr&lt;nsIPrefBranch&gt; m_tagPrefBranch;</span>
<a href="#l8.63"></a><span id="l8.63">   nsTArray&lt;nsCString&gt; m_keys;</span>
<a href="#l8.64"></a><span id="l8.64"> };</span>
<a href="#l8.65"></a><span id="l8.65"> </span>
<a href="#l8.66"></a><span id="l8.66"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/base/src/nsMsgThreadedDBView.cpp</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgThreadedDBView.cpp</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -7,316 +7,266 @@</span>
<a href="#l9.4"></a><span id="l9.4"> #include &quot;nsMsgThreadedDBView.h&quot;</span>
<a href="#l9.5"></a><span id="l9.5"> #include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l9.6"></a><span id="l9.6"> #include &quot;nsIMsgThread.h&quot;</span>
<a href="#l9.7"></a><span id="l9.7"> #include &quot;nsIDBFolderInfo.h&quot;</span>
<a href="#l9.8"></a><span id="l9.8"> #include &quot;nsIMsgSearchSession.h&quot;</span>
<a href="#l9.9"></a><span id="l9.9"> #include &quot;nsMsgMessageFlags.h&quot;</span>
<a href="#l9.10"></a><span id="l9.10"> </span>
<a href="#l9.11"></a><span id="l9.11"> // Allocate this more to avoid reallocation on new mail.</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-#define MSGHDR_CACHE_LOOK_AHEAD_SIZE  25</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+#define MSGHDR_CACHE_LOOK_AHEAD_SIZE 25</span>
<a href="#l9.14"></a><span id="l9.14"> // Max msghdr cache entries.</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineminus">-#define MSGHDR_CACHE_MAX_SIZE         8192</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineminus">-#define MSGHDR_CACHE_DEFAULT_SIZE     100</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+#define MSGHDR_CACHE_MAX_SIZE 8192</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+#define MSGHDR_CACHE_DEFAULT_SIZE 100</span>
<a href="#l9.19"></a><span id="l9.19"> </span>
<a href="#l9.20"></a><span id="l9.20" class="difflineminus">-nsMsgThreadedDBView::nsMsgThreadedDBView()</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineminus">-{</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineplus">+nsMsgThreadedDBView::nsMsgThreadedDBView() {</span>
<a href="#l9.23"></a><span id="l9.23">   /* member initializers and constructor code */</span>
<a href="#l9.24"></a><span id="l9.24">   m_havePrevView = false;</span>
<a href="#l9.25"></a><span id="l9.25"> }</span>
<a href="#l9.26"></a><span id="l9.26"> </span>
<a href="#l9.27"></a><span id="l9.27" class="difflineminus">-nsMsgThreadedDBView::~nsMsgThreadedDBView()</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineminus">-{</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineminus">-  /* destructor code */</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineminus">-}</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineplus">+nsMsgThreadedDBView::~nsMsgThreadedDBView() {} /* destructor code */</span>
<a href="#l9.32"></a><span id="l9.32"> </span>
<a href="#l9.33"></a><span id="l9.33"> NS_IMETHODIMP</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineminus">-nsMsgThreadedDBView::Open(nsIMsgFolder *folder,</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineminus">-                          nsMsgViewSortTypeValue sortType,</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineplus">+nsMsgThreadedDBView::Open(nsIMsgFolder *folder, nsMsgViewSortTypeValue sortType,</span>
<a href="#l9.37"></a><span id="l9.37">                           nsMsgViewSortOrderValue sortOrder,</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineminus">-                          nsMsgViewFlagsTypeValue viewFlags,</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineminus">-                          int32_t *pCount)</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineminus">-{</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineminus">-  nsresult rv = nsMsgDBView::Open(folder, sortType, sortOrder, viewFlags, pCount);</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineplus">+                          nsMsgViewFlagsTypeValue viewFlags, int32_t *pCount) {</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineplus">+  nsresult rv =</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineplus">+      nsMsgDBView::Open(folder, sortType, sortOrder, viewFlags, pCount);</span>
<a href="#l9.45"></a><span id="l9.45">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.46"></a><span id="l9.46"> </span>
<a href="#l9.47"></a><span id="l9.47" class="difflineminus">-  if (!m_db)</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineplus">+  if (!m_db) return NS_ERROR_NULL_POINTER;</span>
<a href="#l9.50"></a><span id="l9.50"> </span>
<a href="#l9.51"></a><span id="l9.51">   // Preset msg hdr cache size for performance reason.</span>
<a href="#l9.52"></a><span id="l9.52">   int32_t totalMessages, unreadMessages;</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineminus">-  nsCOMPtr &lt;nsIDBFolderInfo&gt; dbFolderInfo;</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineplus">+  nsCOMPtr&lt;nsIDBFolderInfo&gt; dbFolderInfo;</span>
<a href="#l9.55"></a><span id="l9.55">   PersistFolderInfo(getter_AddRefs(dbFolderInfo));</span>
<a href="#l9.56"></a><span id="l9.56">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.57"></a><span id="l9.57"> </span>
<a href="#l9.58"></a><span id="l9.58">   // Save off sort type and order, view type and flags.</span>
<a href="#l9.59"></a><span id="l9.59">   dbFolderInfo-&gt;GetNumUnreadMessages(&amp;unreadMessages);</span>
<a href="#l9.60"></a><span id="l9.60">   dbFolderInfo-&gt;GetNumMessages(&amp;totalMessages);</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineminus">-  if (m_viewFlags &amp; nsMsgViewFlagsType::kUnreadOnly)</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineminus">-  {</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineplus">+  if (m_viewFlags &amp; nsMsgViewFlagsType::kUnreadOnly) {</span>
<a href="#l9.64"></a><span id="l9.64">     // Set unread msg size + extra entries to avoid reallocation on new mail.</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineminus">-    totalMessages = (uint32_t)unreadMessages+MSGHDR_CACHE_LOOK_AHEAD_SIZE;</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineminus">-  }</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineminus">-  else</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineminus">-  {</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineplus">+    totalMessages = (uint32_t)unreadMessages + MSGHDR_CACHE_LOOK_AHEAD_SIZE;</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineplus">+  } else {</span>
<a href="#l9.71"></a><span id="l9.71">     if (totalMessages &gt; MSGHDR_CACHE_MAX_SIZE)</span>
<a href="#l9.72"></a><span id="l9.72">       // Use max default.</span>
<a href="#l9.73"></a><span id="l9.73">       totalMessages = MSGHDR_CACHE_MAX_SIZE;</span>
<a href="#l9.74"></a><span id="l9.74">     else if (totalMessages &gt; 0)</span>
<a href="#l9.75"></a><span id="l9.75">       // Allocate extra entries to avoid reallocation on new mail.</span>
<a href="#l9.76"></a><span id="l9.76">       totalMessages += MSGHDR_CACHE_LOOK_AHEAD_SIZE;</span>
<a href="#l9.77"></a><span id="l9.77">   }</span>
<a href="#l9.78"></a><span id="l9.78"> </span>
<a href="#l9.79"></a><span id="l9.79">   // If total messages is 0, then we probably don't have any idea how many</span>
<a href="#l9.80"></a><span id="l9.80">   // headers are in the db so we have no business setting the cache size.</span>
<a href="#l9.81"></a><span id="l9.81" class="difflineminus">-  if (totalMessages &gt; 0)</span>
<a href="#l9.82"></a><span id="l9.82" class="difflineminus">-    m_db-&gt;SetMsgHdrCacheSize((uint32_t)totalMessages);</span>
<a href="#l9.83"></a><span id="l9.83" class="difflineplus">+  if (totalMessages &gt; 0) m_db-&gt;SetMsgHdrCacheSize((uint32_t)totalMessages);</span>
<a href="#l9.84"></a><span id="l9.84"> </span>
<a href="#l9.85"></a><span id="l9.85" class="difflineminus">-  if (pCount)</span>
<a href="#l9.86"></a><span id="l9.86" class="difflineminus">-    *pCount = 0;</span>
<a href="#l9.87"></a><span id="l9.87" class="difflineplus">+  if (pCount) *pCount = 0;</span>
<a href="#l9.88"></a><span id="l9.88"> </span>
<a href="#l9.89"></a><span id="l9.89">   rv = InitThreadedView(pCount);</span>
<a href="#l9.90"></a><span id="l9.90"> </span>
<a href="#l9.91"></a><span id="l9.91">   // This is a hack, but we're trying to find a way to correct</span>
<a href="#l9.92"></a><span id="l9.92">   // incorrect total and unread msg counts w/o paying a big</span>
<a href="#l9.93"></a><span id="l9.93">   // performance penalty. So, if we're not threaded, just add</span>
<a href="#l9.94"></a><span id="l9.94">   // up the total and unread messages in the view and see if that</span>
<a href="#l9.95"></a><span id="l9.95">   // matches what the db totals say. Except ignored threads are</span>
<a href="#l9.96"></a><span id="l9.96">   // going to throw us off...hmm. Unless we just look at the</span>
<a href="#l9.97"></a><span id="l9.97">   // unread counts which is what mostly tweaks people anyway...</span>
<a href="#l9.98"></a><span id="l9.98">   int32_t unreadMsgsInView = 0;</span>
<a href="#l9.99"></a><span id="l9.99" class="difflineminus">-  if (!(m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay))</span>
<a href="#l9.100"></a><span id="l9.100" class="difflineminus">-  {</span>
<a href="#l9.101"></a><span id="l9.101" class="difflineminus">-    for (uint32_t i = m_flags.Length(); i &gt; 0; )</span>
<a href="#l9.102"></a><span id="l9.102" class="difflineminus">-    {</span>
<a href="#l9.103"></a><span id="l9.103" class="difflineminus">-      if (!(m_flags[--i] &amp; nsMsgMessageFlags::Read))</span>
<a href="#l9.104"></a><span id="l9.104" class="difflineminus">-        ++unreadMsgsInView;</span>
<a href="#l9.105"></a><span id="l9.105" class="difflineplus">+  if (!(m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay)) {</span>
<a href="#l9.106"></a><span id="l9.106" class="difflineplus">+    for (uint32_t i = m_flags.Length(); i &gt; 0;) {</span>
<a href="#l9.107"></a><span id="l9.107" class="difflineplus">+      if (!(m_flags[--i] &amp; nsMsgMessageFlags::Read)) ++unreadMsgsInView;</span>
<a href="#l9.108"></a><span id="l9.108">     }</span>
<a href="#l9.109"></a><span id="l9.109"> </span>
<a href="#l9.110"></a><span id="l9.110" class="difflineminus">-    if (unreadMessages != unreadMsgsInView)</span>
<a href="#l9.111"></a><span id="l9.111" class="difflineminus">-      m_db-&gt;SyncCounts();</span>
<a href="#l9.112"></a><span id="l9.112" class="difflineplus">+    if (unreadMessages != unreadMsgsInView) m_db-&gt;SyncCounts();</span>
<a href="#l9.113"></a><span id="l9.113">   }</span>
<a href="#l9.114"></a><span id="l9.114"> </span>
<a href="#l9.115"></a><span id="l9.115">   m_db-&gt;SetMsgHdrCacheSize(MSGHDR_CACHE_DEFAULT_SIZE);</span>
<a href="#l9.116"></a><span id="l9.116"> </span>
<a href="#l9.117"></a><span id="l9.117">   return rv;</span>
<a href="#l9.118"></a><span id="l9.118"> }</span>
<a href="#l9.119"></a><span id="l9.119"> </span>
<a href="#l9.120"></a><span id="l9.120"> NS_IMETHODIMP</span>
<a href="#l9.121"></a><span id="l9.121" class="difflineminus">-nsMsgThreadedDBView::Close()</span>
<a href="#l9.122"></a><span id="l9.122" class="difflineminus">-{</span>
<a href="#l9.123"></a><span id="l9.123" class="difflineminus">-  return nsMsgDBView::Close();</span>
<a href="#l9.124"></a><span id="l9.124" class="difflineminus">-}</span>
<a href="#l9.125"></a><span id="l9.125" class="difflineplus">+nsMsgThreadedDBView::Close() { return nsMsgDBView::Close(); }</span>
<a href="#l9.126"></a><span id="l9.126"> </span>
<a href="#l9.127"></a><span id="l9.127" class="difflineminus">-nsresult</span>
<a href="#l9.128"></a><span id="l9.128" class="difflineminus">-nsMsgThreadedDBView::InitThreadedView(int32_t *pCount)</span>
<a href="#l9.129"></a><span id="l9.129" class="difflineminus">-{</span>
<a href="#l9.130"></a><span id="l9.130" class="difflineplus">+nsresult nsMsgThreadedDBView::InitThreadedView(int32_t *pCount) {</span>
<a href="#l9.131"></a><span id="l9.131">   nsresult rv;</span>
<a href="#l9.132"></a><span id="l9.132"> </span>
<a href="#l9.133"></a><span id="l9.133">   m_keys.Clear();</span>
<a href="#l9.134"></a><span id="l9.134">   m_flags.Clear();</span>
<a href="#l9.135"></a><span id="l9.135">   m_levels.Clear();</span>
<a href="#l9.136"></a><span id="l9.136">   m_prevKeys.Clear();</span>
<a href="#l9.137"></a><span id="l9.137">   m_prevFlags.Clear();</span>
<a href="#l9.138"></a><span id="l9.138">   m_prevLevels.Clear();</span>
<a href="#l9.139"></a><span id="l9.139">   m_havePrevView = false;</span>
<a href="#l9.140"></a><span id="l9.140">   nsresult getSortrv = NS_OK;</span>
<a href="#l9.141"></a><span id="l9.141">   // XXX TODO m_db-&gt;GetSortInfo(&amp;sortType, &amp;sortOrder);</span>
<a href="#l9.142"></a><span id="l9.142"> </span>
<a href="#l9.143"></a><span id="l9.143">   // List all the ids into m_keys.</span>
<a href="#l9.144"></a><span id="l9.144">   nsMsgKey startMsg = 0;</span>
<a href="#l9.145"></a><span id="l9.145" class="difflineminus">-  do</span>
<a href="#l9.146"></a><span id="l9.146" class="difflineminus">-  {</span>
<a href="#l9.147"></a><span id="l9.147" class="difflineplus">+  do {</span>
<a href="#l9.148"></a><span id="l9.148">     const int32_t kIdChunkSize = 400;</span>
<a href="#l9.149"></a><span id="l9.149" class="difflineminus">-    int32_t  numListed = 0;</span>
<a href="#l9.150"></a><span id="l9.150" class="difflineplus">+    int32_t numListed = 0;</span>
<a href="#l9.151"></a><span id="l9.151">     nsMsgKey idArray[kIdChunkSize];</span>
<a href="#l9.152"></a><span id="l9.152" class="difflineminus">-    int32_t  flagArray[kIdChunkSize];</span>
<a href="#l9.153"></a><span id="l9.153" class="difflineminus">-    char     levelArray[kIdChunkSize];</span>
<a href="#l9.154"></a><span id="l9.154" class="difflineplus">+    int32_t flagArray[kIdChunkSize];</span>
<a href="#l9.155"></a><span id="l9.155" class="difflineplus">+    char levelArray[kIdChunkSize];</span>
<a href="#l9.156"></a><span id="l9.156"> </span>
<a href="#l9.157"></a><span id="l9.157" class="difflineminus">-    rv = ListThreadIds(&amp;startMsg,</span>
<a href="#l9.158"></a><span id="l9.158" class="difflineminus">-                       (m_viewFlags &amp; nsMsgViewFlagsType::kUnreadOnly) != 0,</span>
<a href="#l9.159"></a><span id="l9.159" class="difflineminus">-                       idArray,</span>
<a href="#l9.160"></a><span id="l9.160" class="difflineminus">-                       flagArray,</span>
<a href="#l9.161"></a><span id="l9.161" class="difflineminus">-                       levelArray,</span>
<a href="#l9.162"></a><span id="l9.162" class="difflineminus">-                       kIdChunkSize,</span>
<a href="#l9.163"></a><span id="l9.163" class="difflineminus">-                       &amp;numListed,</span>
<a href="#l9.164"></a><span id="l9.164" class="difflineminus">-                       nullptr);</span>
<a href="#l9.165"></a><span id="l9.165" class="difflineplus">+    rv = ListThreadIds(</span>
<a href="#l9.166"></a><span id="l9.166" class="difflineplus">+        &amp;startMsg, (m_viewFlags &amp; nsMsgViewFlagsType::kUnreadOnly) != 0,</span>
<a href="#l9.167"></a><span id="l9.167" class="difflineplus">+        idArray, flagArray, levelArray, kIdChunkSize, &amp;numListed, nullptr);</span>
<a href="#l9.168"></a><span id="l9.168"> </span>
<a href="#l9.169"></a><span id="l9.169" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l9.170"></a><span id="l9.170" class="difflineminus">-    {</span>
<a href="#l9.171"></a><span id="l9.171" class="difflineminus">-      int32_t numAdded = AddKeys(idArray, flagArray, levelArray, m_sortType, numListed);</span>
<a href="#l9.172"></a><span id="l9.172" class="difflineminus">-      if (pCount)</span>
<a href="#l9.173"></a><span id="l9.173" class="difflineminus">-        *pCount += numAdded;</span>
<a href="#l9.174"></a><span id="l9.174" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l9.175"></a><span id="l9.175" class="difflineplus">+      int32_t numAdded =</span>
<a href="#l9.176"></a><span id="l9.176" class="difflineplus">+          AddKeys(idArray, flagArray, levelArray, m_sortType, numListed);</span>
<a href="#l9.177"></a><span id="l9.177" class="difflineplus">+      if (pCount) *pCount += numAdded;</span>
<a href="#l9.178"></a><span id="l9.178">     }</span>
<a href="#l9.179"></a><span id="l9.179"> </span>
<a href="#l9.180"></a><span id="l9.180">   } while (NS_SUCCEEDED(rv) &amp;&amp; startMsg != nsMsgKey_None);</span>
<a href="#l9.181"></a><span id="l9.181"> </span>
<a href="#l9.182"></a><span id="l9.182" class="difflineminus">-  if (NS_SUCCEEDED(getSortrv))</span>
<a href="#l9.183"></a><span id="l9.183" class="difflineminus">-  {</span>
<a href="#l9.184"></a><span id="l9.184" class="difflineplus">+  if (NS_SUCCEEDED(getSortrv)) {</span>
<a href="#l9.185"></a><span id="l9.185">     rv = InitSort(m_sortType, m_sortOrder);</span>
<a href="#l9.186"></a><span id="l9.186">     SaveSortInfo(m_sortType, m_sortOrder);</span>
<a href="#l9.187"></a><span id="l9.187" class="difflineminus">-</span>
<a href="#l9.188"></a><span id="l9.188">   }</span>
<a href="#l9.189"></a><span id="l9.189"> </span>
<a href="#l9.190"></a><span id="l9.190">   return rv;</span>
<a href="#l9.191"></a><span id="l9.191"> }</span>
<a href="#l9.192"></a><span id="l9.192"> </span>
<a href="#l9.193"></a><span id="l9.193" class="difflineminus">-nsresult</span>
<a href="#l9.194"></a><span id="l9.194" class="difflineminus">-nsMsgThreadedDBView::SortThreads(nsMsgViewSortTypeValue sortType,</span>
<a href="#l9.195"></a><span id="l9.195" class="difflineminus">-                                 nsMsgViewSortOrderValue sortOrder)</span>
<a href="#l9.196"></a><span id="l9.196" class="difflineminus">-{</span>
<a href="#l9.197"></a><span id="l9.197" class="difflineplus">+nsresult nsMsgThreadedDBView::SortThreads(nsMsgViewSortTypeValue sortType,</span>
<a href="#l9.198"></a><span id="l9.198" class="difflineplus">+                                          nsMsgViewSortOrderValue sortOrder) {</span>
<a href="#l9.199"></a><span id="l9.199">   NS_ASSERTION(m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay,</span>
<a href="#l9.200"></a><span id="l9.200">                &quot;trying to sort unthreaded threads&quot;);</span>
<a href="#l9.201"></a><span id="l9.201"> </span>
<a href="#l9.202"></a><span id="l9.202">   uint32_t numThreads = 0;</span>
<a href="#l9.203"></a><span id="l9.203">   // The idea here is that copy the current view, then build up an m_keys and</span>
<a href="#l9.204"></a><span id="l9.204">   // m_flags array of just the top level messages in the view, and then call</span>
<a href="#l9.205"></a><span id="l9.205">   // nsMsgDBView::Sort(sortType, sortOrder).</span>
<a href="#l9.206"></a><span id="l9.206">   // Then, we expand the threads in the result array that were expanded in the</span>
<a href="#l9.207"></a><span id="l9.207">   // original view (perhaps by copying from the original view, but more likely</span>
<a href="#l9.208"></a><span id="l9.208">   // just be calling expand).</span>
<a href="#l9.209"></a><span id="l9.209" class="difflineminus">-  for (uint32_t i = 0; i &lt; m_keys.Length(); i++)</span>
<a href="#l9.210"></a><span id="l9.210" class="difflineminus">-  {</span>
<a href="#l9.211"></a><span id="l9.211" class="difflineminus">-    if (m_flags[i] &amp; MSG_VIEW_FLAG_ISTHREAD)</span>
<a href="#l9.212"></a><span id="l9.212" class="difflineminus">-    {</span>
<a href="#l9.213"></a><span id="l9.213" class="difflineminus">-      if (numThreads &lt; i)</span>
<a href="#l9.214"></a><span id="l9.214" class="difflineminus">-      {</span>
<a href="#l9.215"></a><span id="l9.215" class="difflineplus">+  for (uint32_t i = 0; i &lt; m_keys.Length(); i++) {</span>
<a href="#l9.216"></a><span id="l9.216" class="difflineplus">+    if (m_flags[i] &amp; MSG_VIEW_FLAG_ISTHREAD) {</span>
<a href="#l9.217"></a><span id="l9.217" class="difflineplus">+      if (numThreads &lt; i) {</span>
<a href="#l9.218"></a><span id="l9.218">         m_keys[numThreads] = m_keys[i];</span>
<a href="#l9.219"></a><span id="l9.219">         m_flags[numThreads] = m_flags[i];</span>
<a href="#l9.220"></a><span id="l9.220">       }</span>
<a href="#l9.221"></a><span id="l9.221"> </span>
<a href="#l9.222"></a><span id="l9.222">       m_levels[numThreads] = 0;</span>
<a href="#l9.223"></a><span id="l9.223">       numThreads++;</span>
<a href="#l9.224"></a><span id="l9.224">     }</span>
<a href="#l9.225"></a><span id="l9.225">   }</span>
<a href="#l9.226"></a><span id="l9.226"> </span>
<a href="#l9.227"></a><span id="l9.227">   m_keys.SetLength(numThreads);</span>
<a href="#l9.228"></a><span id="l9.228">   m_flags.SetLength(numThreads);</span>
<a href="#l9.229"></a><span id="l9.229">   m_levels.SetLength(numThreads);</span>
<a href="#l9.230"></a><span id="l9.230" class="difflineminus">-  //m_viewFlags &amp;= ~nsMsgViewFlagsType::kThreadedDisplay;</span>
<a href="#l9.231"></a><span id="l9.231" class="difflineminus">-  m_sortType = nsMsgViewSortType::byNone; // sort from scratch</span>
<a href="#l9.232"></a><span id="l9.232" class="difflineplus">+  // m_viewFlags &amp;= ~nsMsgViewFlagsType::kThreadedDisplay;</span>
<a href="#l9.233"></a><span id="l9.233" class="difflineplus">+  m_sortType = nsMsgViewSortType::byNone;  // sort from scratch</span>
<a href="#l9.234"></a><span id="l9.234">   nsMsgDBView::Sort(sortType, sortOrder);</span>
<a href="#l9.235"></a><span id="l9.235">   m_viewFlags |= nsMsgViewFlagsType::kThreadedDisplay;</span>
<a href="#l9.236"></a><span id="l9.236">   SetSuppressChangeNotifications(true);</span>
<a href="#l9.237"></a><span id="l9.237"> </span>
<a href="#l9.238"></a><span id="l9.238">   // Loop through the original array, for each thread that's expanded,</span>
<a href="#l9.239"></a><span id="l9.239">   // find it in the new array and expand the thread. We have to update</span>
<a href="#l9.240"></a><span id="l9.240">   // MSG_VIEW_FLAG_HAS_CHILDREN because we may be going from a flat sort,</span>
<a href="#l9.241"></a><span id="l9.241">   // which doesn't maintain that flag, to a threaded sort, which requires</span>
<a href="#l9.242"></a><span id="l9.242">   // that flag.</span>
<a href="#l9.243"></a><span id="l9.243" class="difflineminus">-  for (uint32_t j = 0; j &lt; m_keys.Length(); j++)</span>
<a href="#l9.244"></a><span id="l9.244" class="difflineminus">-  {</span>
<a href="#l9.245"></a><span id="l9.245" class="difflineplus">+  for (uint32_t j = 0; j &lt; m_keys.Length(); j++) {</span>
<a href="#l9.246"></a><span id="l9.246">     uint32_t flags = m_flags[j];</span>
<a href="#l9.247"></a><span id="l9.247" class="difflineminus">-    if ((flags &amp; (MSG_VIEW_FLAG_HASCHILDREN |</span>
<a href="#l9.248"></a><span id="l9.248" class="difflineminus">-                  nsMsgMessageFlags::Elided)) == MSG_VIEW_FLAG_HASCHILDREN)</span>
<a href="#l9.249"></a><span id="l9.249" class="difflineminus">-    {</span>
<a href="#l9.250"></a><span id="l9.250" class="difflineplus">+    if ((flags &amp; (MSG_VIEW_FLAG_HASCHILDREN | nsMsgMessageFlags::Elided)) ==</span>
<a href="#l9.251"></a><span id="l9.251" class="difflineplus">+        MSG_VIEW_FLAG_HASCHILDREN) {</span>
<a href="#l9.252"></a><span id="l9.252">       uint32_t numExpanded;</span>
<a href="#l9.253"></a><span id="l9.253">       m_flags[j] = flags | nsMsgMessageFlags::Elided;</span>
<a href="#l9.254"></a><span id="l9.254">       ExpandByIndex(j, &amp;numExpanded);</span>
<a href="#l9.255"></a><span id="l9.255">       j += numExpanded;</span>
<a href="#l9.256"></a><span id="l9.256">       if (numExpanded &gt; 0)</span>
<a href="#l9.257"></a><span id="l9.257">         m_flags[j - numExpanded] = flags | MSG_VIEW_FLAG_HASCHILDREN;</span>
<a href="#l9.258"></a><span id="l9.258" class="difflineminus">-    }</span>
<a href="#l9.259"></a><span id="l9.259" class="difflineminus">-    else if (flags &amp; MSG_VIEW_FLAG_ISTHREAD &amp;&amp;</span>
<a href="#l9.260"></a><span id="l9.260" class="difflineminus">-             !(flags &amp; MSG_VIEW_FLAG_HASCHILDREN))</span>
<a href="#l9.261"></a><span id="l9.261" class="difflineminus">-    {</span>
<a href="#l9.262"></a><span id="l9.262" class="difflineminus">-      nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l9.263"></a><span id="l9.263" class="difflineminus">-      nsCOMPtr &lt;nsIMsgThread&gt; pThread;</span>
<a href="#l9.264"></a><span id="l9.264" class="difflineplus">+    } else if (flags &amp; MSG_VIEW_FLAG_ISTHREAD &amp;&amp;</span>
<a href="#l9.265"></a><span id="l9.265" class="difflineplus">+               !(flags &amp; MSG_VIEW_FLAG_HASCHILDREN)) {</span>
<a href="#l9.266"></a><span id="l9.266" class="difflineplus">+      nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l9.267"></a><span id="l9.267" class="difflineplus">+      nsCOMPtr&lt;nsIMsgThread&gt; pThread;</span>
<a href="#l9.268"></a><span id="l9.268">       m_db-&gt;GetMsgHdrForKey(m_keys[j], getter_AddRefs(msgHdr));</span>
<a href="#l9.269"></a><span id="l9.269" class="difflineminus">-      if (msgHdr)</span>
<a href="#l9.270"></a><span id="l9.270" class="difflineminus">-      {</span>
<a href="#l9.271"></a><span id="l9.271" class="difflineplus">+      if (msgHdr) {</span>
<a href="#l9.272"></a><span id="l9.272">         m_db-&gt;GetThreadContainingMsgHdr(msgHdr, getter_AddRefs(pThread));</span>
<a href="#l9.273"></a><span id="l9.273" class="difflineminus">-        if (pThread)</span>
<a href="#l9.274"></a><span id="l9.274" class="difflineminus">-        {</span>
<a href="#l9.275"></a><span id="l9.275" class="difflineplus">+        if (pThread) {</span>
<a href="#l9.276"></a><span id="l9.276">           uint32_t numChildren;</span>
<a href="#l9.277"></a><span id="l9.277">           pThread-&gt;GetNumChildren(&amp;numChildren);</span>
<a href="#l9.278"></a><span id="l9.278">           if (numChildren &gt; 1)</span>
<a href="#l9.279"></a><span id="l9.279" class="difflineminus">-            m_flags[j] = flags | MSG_VIEW_FLAG_HASCHILDREN | nsMsgMessageFlags::Elided;</span>
<a href="#l9.280"></a><span id="l9.280" class="difflineplus">+            m_flags[j] =</span>
<a href="#l9.281"></a><span id="l9.281" class="difflineplus">+                flags | MSG_VIEW_FLAG_HASCHILDREN | nsMsgMessageFlags::Elided;</span>
<a href="#l9.282"></a><span id="l9.282">         }</span>
<a href="#l9.283"></a><span id="l9.283">       }</span>
<a href="#l9.284"></a><span id="l9.284">     }</span>
<a href="#l9.285"></a><span id="l9.285">   }</span>
<a href="#l9.286"></a><span id="l9.286"> </span>
<a href="#l9.287"></a><span id="l9.287">   SetSuppressChangeNotifications(false);</span>
<a href="#l9.288"></a><span id="l9.288"> </span>
<a href="#l9.289"></a><span id="l9.289">   return NS_OK;</span>
<a href="#l9.290"></a><span id="l9.290"> }</span>
<a href="#l9.291"></a><span id="l9.291"> </span>
<a href="#l9.292"></a><span id="l9.292" class="difflineminus">-int32_t</span>
<a href="#l9.293"></a><span id="l9.293" class="difflineminus">-nsMsgThreadedDBView::AddKeys(nsMsgKey *pKeys,</span>
<a href="#l9.294"></a><span id="l9.294" class="difflineminus">-                             int32_t *pFlags,</span>
<a href="#l9.295"></a><span id="l9.295" class="difflineminus">-                             const char *pLevels,</span>
<a href="#l9.296"></a><span id="l9.296" class="difflineminus">-                             nsMsgViewSortTypeValue sortType,</span>
<a href="#l9.297"></a><span id="l9.297" class="difflineminus">-                             int32_t numKeysToAdd)</span>
<a href="#l9.298"></a><span id="l9.298" class="difflineminus">-{</span>
<a href="#l9.299"></a><span id="l9.299" class="difflineplus">+int32_t nsMsgThreadedDBView::AddKeys(nsMsgKey *pKeys, int32_t *pFlags,</span>
<a href="#l9.300"></a><span id="l9.300" class="difflineplus">+                                     const char *pLevels,</span>
<a href="#l9.301"></a><span id="l9.301" class="difflineplus">+                                     nsMsgViewSortTypeValue sortType,</span>
<a href="#l9.302"></a><span id="l9.302" class="difflineplus">+                                     int32_t numKeysToAdd) {</span>
<a href="#l9.303"></a><span id="l9.303">   int32_t numAdded = 0;</span>
<a href="#l9.304"></a><span id="l9.304">   // Allocate enough space first to avoid memory allocation/deallocation.</span>
<a href="#l9.305"></a><span id="l9.305">   m_keys.SetCapacity(m_keys.Length() + numKeysToAdd);</span>
<a href="#l9.306"></a><span id="l9.306">   m_flags.SetCapacity(m_flags.Length() + numKeysToAdd);</span>
<a href="#l9.307"></a><span id="l9.307">   m_levels.SetCapacity(m_levels.Length() + numKeysToAdd);</span>
<a href="#l9.308"></a><span id="l9.308" class="difflineminus">-  for (int32_t i = 0; i &lt; numKeysToAdd; i++)</span>
<a href="#l9.309"></a><span id="l9.309" class="difflineminus">-  {</span>
<a href="#l9.310"></a><span id="l9.310" class="difflineplus">+  for (int32_t i = 0; i &lt; numKeysToAdd; i++) {</span>
<a href="#l9.311"></a><span id="l9.311">     int32_t threadFlag = pFlags[i];</span>
<a href="#l9.312"></a><span id="l9.312">     int32_t flag = threadFlag;</span>
<a href="#l9.313"></a><span id="l9.313"> </span>
<a href="#l9.314"></a><span id="l9.314">     // Skip ignored threads.</span>
<a href="#l9.315"></a><span id="l9.315" class="difflineminus">-    if ((threadFlag &amp; nsMsgMessageFlags::Ignored) &amp;&amp; !(m_viewFlags &amp; nsMsgViewFlagsType::kShowIgnored))</span>
<a href="#l9.316"></a><span id="l9.316" class="difflineplus">+    if ((threadFlag &amp; nsMsgMessageFlags::Ignored) &amp;&amp;</span>
<a href="#l9.317"></a><span id="l9.317" class="difflineplus">+        !(m_viewFlags &amp; nsMsgViewFlagsType::kShowIgnored))</span>
<a href="#l9.318"></a><span id="l9.318">       continue;</span>
<a href="#l9.319"></a><span id="l9.319"> </span>
<a href="#l9.320"></a><span id="l9.320">     // Skip ignored subthreads</span>
<a href="#l9.321"></a><span id="l9.321" class="difflineminus">-    nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l9.322"></a><span id="l9.322" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l9.323"></a><span id="l9.323">     m_db-&gt;GetMsgHdrForKey(pKeys[i], getter_AddRefs(msgHdr));</span>
<a href="#l9.324"></a><span id="l9.324" class="difflineminus">-    if (!(m_viewFlags &amp; nsMsgViewFlagsType::kShowIgnored))</span>
<a href="#l9.325"></a><span id="l9.325" class="difflineminus">-    {</span>
<a href="#l9.326"></a><span id="l9.326" class="difflineplus">+    if (!(m_viewFlags &amp; nsMsgViewFlagsType::kShowIgnored)) {</span>
<a href="#l9.327"></a><span id="l9.327">       bool killed;</span>
<a href="#l9.328"></a><span id="l9.328">       msgHdr-&gt;GetIsKilled(&amp;killed);</span>
<a href="#l9.329"></a><span id="l9.329" class="difflineminus">-      if (killed)</span>
<a href="#l9.330"></a><span id="l9.330" class="difflineminus">-        continue;</span>
<a href="#l9.331"></a><span id="l9.331" class="difflineplus">+      if (killed) continue;</span>
<a href="#l9.332"></a><span id="l9.332">     }</span>
<a href="#l9.333"></a><span id="l9.333"> </span>
<a href="#l9.334"></a><span id="l9.334">     // By default, make threads collapsed unless we're only viewing new msgs.</span>
<a href="#l9.335"></a><span id="l9.335"> </span>
<a href="#l9.336"></a><span id="l9.336" class="difflineminus">-    if (flag &amp; MSG_VIEW_FLAG_HASCHILDREN)</span>
<a href="#l9.337"></a><span id="l9.337" class="difflineminus">-      flag |= nsMsgMessageFlags::Elided;</span>
<a href="#l9.338"></a><span id="l9.338" class="difflineplus">+    if (flag &amp; MSG_VIEW_FLAG_HASCHILDREN) flag |= nsMsgMessageFlags::Elided;</span>
<a href="#l9.339"></a><span id="l9.339"> </span>
<a href="#l9.340"></a><span id="l9.340">     // Should this be persistent? Doesn't seem to need to be.</span>
<a href="#l9.341"></a><span id="l9.341">     flag |= MSG_VIEW_FLAG_ISTHREAD;</span>
<a href="#l9.342"></a><span id="l9.342">     m_keys.AppendElement(pKeys[i]);</span>
<a href="#l9.343"></a><span id="l9.343">     m_flags.AppendElement(flag);</span>
<a href="#l9.344"></a><span id="l9.344">     m_levels.AppendElement(pLevels[i]);</span>
<a href="#l9.345"></a><span id="l9.345">     numAdded++;</span>
<a href="#l9.346"></a><span id="l9.346"> </span>
<a href="#l9.347"></a><span id="l9.347">     // We expand as we build the view, which allows us to insert at the end</span>
<a href="#l9.348"></a><span id="l9.348">     // of the key array, instead of the middle, and is much faster.</span>
<a href="#l9.349"></a><span id="l9.349">     if ((!(m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay) ||</span>
<a href="#l9.350"></a><span id="l9.350">          m_viewFlags &amp; nsMsgViewFlagsType::kExpandAll) &amp;&amp;</span>
<a href="#l9.351"></a><span id="l9.351" class="difflineminus">-        flag &amp; nsMsgMessageFlags::Elided)</span>
<a href="#l9.352"></a><span id="l9.352" class="difflineminus">-    {</span>
<a href="#l9.353"></a><span id="l9.353" class="difflineminus">-       ExpandByIndex(m_keys.Length() - 1, NULL);</span>
<a href="#l9.354"></a><span id="l9.354" class="difflineplus">+        flag &amp; nsMsgMessageFlags::Elided) {</span>
<a href="#l9.355"></a><span id="l9.355" class="difflineplus">+      ExpandByIndex(m_keys.Length() - 1, NULL);</span>
<a href="#l9.356"></a><span id="l9.356">     }</span>
<a href="#l9.357"></a><span id="l9.357">   }</span>
<a href="#l9.358"></a><span id="l9.358"> </span>
<a href="#l9.359"></a><span id="l9.359">   return numAdded;</span>
<a href="#l9.360"></a><span id="l9.360"> }</span>
<a href="#l9.361"></a><span id="l9.361"> </span>
<a href="#l9.362"></a><span id="l9.362"> NS_IMETHODIMP</span>
<a href="#l9.363"></a><span id="l9.363"> nsMsgThreadedDBView::Sort(nsMsgViewSortTypeValue sortType,</span>
<a href="#l9.364"></a><span id="l9.364" class="difflineminus">-                          nsMsgViewSortOrderValue sortOrder)</span>
<a href="#l9.365"></a><span id="l9.365" class="difflineminus">-{</span>
<a href="#l9.366"></a><span id="l9.366" class="difflineplus">+                          nsMsgViewSortOrderValue sortOrder) {</span>
<a href="#l9.367"></a><span id="l9.367">   nsresult rv;</span>
<a href="#l9.368"></a><span id="l9.368"> </span>
<a href="#l9.369"></a><span id="l9.369">   int32_t rowCountBeforeSort = GetSize();</span>
<a href="#l9.370"></a><span id="l9.370"> </span>
<a href="#l9.371"></a><span id="l9.371" class="difflineminus">-  if (!rowCountBeforeSort)</span>
<a href="#l9.372"></a><span id="l9.372" class="difflineminus">-  {</span>
<a href="#l9.373"></a><span id="l9.373" class="difflineplus">+  if (!rowCountBeforeSort) {</span>
<a href="#l9.374"></a><span id="l9.374">     // Still need to setup our flags even when no articles - bug 98183.</span>
<a href="#l9.375"></a><span id="l9.375">     m_sortType = sortType;</span>
<a href="#l9.376"></a><span id="l9.376">     if (sortType == nsMsgViewSortType::byThread &amp;&amp;</span>
<a href="#l9.377"></a><span id="l9.377" class="difflineminus">-        !(m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay))</span>
<a href="#l9.378"></a><span id="l9.378" class="difflineminus">-    {</span>
<a href="#l9.379"></a><span id="l9.379" class="difflineplus">+        !(m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay)) {</span>
<a href="#l9.380"></a><span id="l9.380">       SetViewFlags(m_viewFlags | nsMsgViewFlagsType::kThreadedDisplay);</span>
<a href="#l9.381"></a><span id="l9.381">     }</span>
<a href="#l9.382"></a><span id="l9.382"> </span>
<a href="#l9.383"></a><span id="l9.383">     SaveSortInfo(sortType, sortOrder);</span>
<a href="#l9.384"></a><span id="l9.384">     return NS_OK;</span>
<a href="#l9.385"></a><span id="l9.385">   }</span>
<a href="#l9.386"></a><span id="l9.386"> </span>
<a href="#l9.387"></a><span id="l9.387">   if (!m_checkedCustomColumns &amp;&amp; CustomColumnsInSortAndNotRegistered())</span>
<a href="#l9.388"></a><span id="l9.388" class="difflineat">@@ -324,276 +274,232 @@ nsMsgThreadedDBView::Sort(nsMsgViewSortT</span>
<a href="#l9.389"></a><span id="l9.389"> </span>
<a href="#l9.390"></a><span id="l9.390">   // Sort threads by sort order.</span>
<a href="#l9.391"></a><span id="l9.391">   bool sortThreads = m_viewFlags &amp; (nsMsgViewFlagsType::kThreadedDisplay |</span>
<a href="#l9.392"></a><span id="l9.392">                                     nsMsgViewFlagsType::kGroupBySort);</span>
<a href="#l9.393"></a><span id="l9.393"> </span>
<a href="#l9.394"></a><span id="l9.394">   // If sort type is by thread, and we're already threaded, change sort type</span>
<a href="#l9.395"></a><span id="l9.395">   // to byId.</span>
<a href="#l9.396"></a><span id="l9.396">   if (sortType == nsMsgViewSortType::byThread &amp;&amp;</span>
<a href="#l9.397"></a><span id="l9.397" class="difflineminus">-      (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay) != 0)</span>
<a href="#l9.398"></a><span id="l9.398" class="difflineminus">-  {</span>
<a href="#l9.399"></a><span id="l9.399" class="difflineplus">+      (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay) != 0) {</span>
<a href="#l9.400"></a><span id="l9.400">     sortType = nsMsgViewSortType::byId;</span>
<a href="#l9.401"></a><span id="l9.401">   }</span>
<a href="#l9.402"></a><span id="l9.402"> </span>
<a href="#l9.403"></a><span id="l9.403">   nsMsgKey preservedKey;</span>
<a href="#l9.404"></a><span id="l9.404">   AutoTArray&lt;nsMsgKey, 1&gt; preservedSelection;</span>
<a href="#l9.405"></a><span id="l9.405">   SaveAndClearSelection(&amp;preservedKey, preservedSelection);</span>
<a href="#l9.406"></a><span id="l9.406">   // If the client wants us to forget our cached id arrays, they</span>
<a href="#l9.407"></a><span id="l9.407">   // should build a new view. If this isn't good enough, we</span>
<a href="#l9.408"></a><span id="l9.408">   // need a method to do that.</span>
<a href="#l9.409"></a><span id="l9.409" class="difflineminus">-  if (sortType != m_sortType || !m_sortValid || sortThreads)</span>
<a href="#l9.410"></a><span id="l9.410" class="difflineminus">-  {</span>
<a href="#l9.411"></a><span id="l9.411" class="difflineplus">+  if (sortType != m_sortType || !m_sortValid || sortThreads) {</span>
<a href="#l9.412"></a><span id="l9.412">     SaveSortInfo(sortType, sortOrder);</span>
<a href="#l9.413"></a><span id="l9.413" class="difflineminus">-    if (sortType == nsMsgViewSortType::byThread)</span>
<a href="#l9.414"></a><span id="l9.414" class="difflineminus">-    {</span>
<a href="#l9.415"></a><span id="l9.415" class="difflineplus">+    if (sortType == nsMsgViewSortType::byThread) {</span>
<a href="#l9.416"></a><span id="l9.416">       m_sortType = sortType;</span>
<a href="#l9.417"></a><span id="l9.417">       m_viewFlags |= nsMsgViewFlagsType::kThreadedDisplay;</span>
<a href="#l9.418"></a><span id="l9.418">       m_viewFlags &amp;= ~nsMsgViewFlagsType::kGroupBySort;</span>
<a href="#l9.419"></a><span id="l9.419" class="difflineminus">-      if ( m_havePrevView)</span>
<a href="#l9.420"></a><span id="l9.420" class="difflineminus">-      {</span>
<a href="#l9.421"></a><span id="l9.421" class="difflineplus">+      if (m_havePrevView) {</span>
<a href="#l9.422"></a><span id="l9.422">         // Restore saved id array and flags array.</span>
<a href="#l9.423"></a><span id="l9.423">         m_keys = m_prevKeys;</span>
<a href="#l9.424"></a><span id="l9.424">         m_flags = m_prevFlags;</span>
<a href="#l9.425"></a><span id="l9.425">         m_levels = m_prevLevels;</span>
<a href="#l9.426"></a><span id="l9.426">         m_sortValid = true;</span>
<a href="#l9.427"></a><span id="l9.427"> </span>
<a href="#l9.428"></a><span id="l9.428">         // The sort may have changed the number of rows</span>
<a href="#l9.429"></a><span id="l9.429">         // before we restore the selection, tell the tree</span>
<a href="#l9.430"></a><span id="l9.430">         // do this before we call restore selection</span>
<a href="#l9.431"></a><span id="l9.431">         // this is safe when there is no selection.</span>
<a href="#l9.432"></a><span id="l9.432">         rv = AdjustRowCount(rowCountBeforeSort, GetSize());</span>
<a href="#l9.433"></a><span id="l9.433"> </span>
<a href="#l9.434"></a><span id="l9.434">         RestoreSelection(preservedKey, preservedSelection);</span>
<a href="#l9.435"></a><span id="l9.435" class="difflineminus">-        if (mTree)</span>
<a href="#l9.436"></a><span id="l9.436" class="difflineminus">-          mTree-&gt;Invalidate();</span>
<a href="#l9.437"></a><span id="l9.437" class="difflineplus">+        if (mTree) mTree-&gt;Invalidate();</span>
<a href="#l9.438"></a><span id="l9.438"> </span>
<a href="#l9.439"></a><span id="l9.439">         return NS_OK;</span>
<a href="#l9.440"></a><span id="l9.440" class="difflineminus">-      }</span>
<a href="#l9.441"></a><span id="l9.441" class="difflineminus">-      else</span>
<a href="#l9.442"></a><span id="l9.442" class="difflineminus">-      {</span>
<a href="#l9.443"></a><span id="l9.443" class="difflineplus">+      } else {</span>
<a href="#l9.444"></a><span id="l9.444">         // Set sort info in anticipation of what Init will do.</span>
<a href="#l9.445"></a><span id="l9.445">         // Build up thread list.</span>
<a href="#l9.446"></a><span id="l9.446">         InitThreadedView(nullptr);</span>
<a href="#l9.447"></a><span id="l9.447">         if (sortOrder != nsMsgViewSortOrder::ascending)</span>
<a href="#l9.448"></a><span id="l9.448">           Sort(sortType, sortOrder);</span>
<a href="#l9.449"></a><span id="l9.449"> </span>
<a href="#l9.450"></a><span id="l9.450">         // The sort may have changed the number of rows</span>
<a href="#l9.451"></a><span id="l9.451">         // before we update the selection, tell the tree</span>
<a href="#l9.452"></a><span id="l9.452">         // do this before we call restore selection</span>
<a href="#l9.453"></a><span id="l9.453">         // this is safe when there is no selection.</span>
<a href="#l9.454"></a><span id="l9.454">         rv = AdjustRowCount(rowCountBeforeSort, GetSize());</span>
<a href="#l9.455"></a><span id="l9.455"> </span>
<a href="#l9.456"></a><span id="l9.456">         RestoreSelection(preservedKey, preservedSelection);</span>
<a href="#l9.457"></a><span id="l9.457" class="difflineminus">-        if (mTree)</span>
<a href="#l9.458"></a><span id="l9.458" class="difflineminus">-          mTree-&gt;Invalidate();</span>
<a href="#l9.459"></a><span id="l9.459" class="difflineplus">+        if (mTree) mTree-&gt;Invalidate();</span>
<a href="#l9.460"></a><span id="l9.460"> </span>
<a href="#l9.461"></a><span id="l9.461">         return NS_OK;</span>
<a href="#l9.462"></a><span id="l9.462">       }</span>
<a href="#l9.463"></a><span id="l9.463" class="difflineminus">-    }</span>
<a href="#l9.464"></a><span id="l9.464" class="difflineminus">-    else if (sortType  != nsMsgViewSortType::byThread &amp;&amp;</span>
<a href="#l9.465"></a><span id="l9.465" class="difflineminus">-             (m_sortType == nsMsgViewSortType::byThread  || sortThreads)</span>
<a href="#l9.466"></a><span id="l9.466" class="difflineminus">-             /* &amp;&amp; !m_havePrevView*/)</span>
<a href="#l9.467"></a><span id="l9.467" class="difflineminus">-    {</span>
<a href="#l9.468"></a><span id="l9.468" class="difflineminus">-      if (sortThreads)</span>
<a href="#l9.469"></a><span id="l9.469" class="difflineminus">-      {</span>
<a href="#l9.470"></a><span id="l9.470" class="difflineplus">+    } else if (sortType != nsMsgViewSortType::byThread &amp;&amp;</span>
<a href="#l9.471"></a><span id="l9.471" class="difflineplus">+               (m_sortType == nsMsgViewSortType::byThread || sortThreads)</span>
<a href="#l9.472"></a><span id="l9.472" class="difflineplus">+               /* &amp;&amp; !m_havePrevView*/) {</span>
<a href="#l9.473"></a><span id="l9.473" class="difflineplus">+      if (sortThreads) {</span>
<a href="#l9.474"></a><span id="l9.474">         SortThreads(sortType, sortOrder);</span>
<a href="#l9.475"></a><span id="l9.475">         // Hack so base class won't do anything.</span>
<a href="#l9.476"></a><span id="l9.476">         sortType = nsMsgViewSortType::byThread;</span>
<a href="#l9.477"></a><span id="l9.477" class="difflineminus">-      }</span>
<a href="#l9.478"></a><span id="l9.478" class="difflineminus">-      else</span>
<a href="#l9.479"></a><span id="l9.479" class="difflineminus">-      {</span>
<a href="#l9.480"></a><span id="l9.480" class="difflineplus">+      } else {</span>
<a href="#l9.481"></a><span id="l9.481">         // Going from SortByThread to non-thread sort - must build new key,</span>
<a href="#l9.482"></a><span id="l9.482">         // level, and flags arrays.</span>
<a href="#l9.483"></a><span id="l9.483">         m_prevKeys = m_keys;</span>
<a href="#l9.484"></a><span id="l9.484">         m_prevFlags = m_flags;</span>
<a href="#l9.485"></a><span id="l9.485">         m_prevLevels = m_levels;</span>
<a href="#l9.486"></a><span id="l9.486">         // Do this before we sort, so that we'll use the cheap method</span>
<a href="#l9.487"></a><span id="l9.487">         // of expanding.</span>
<a href="#l9.488"></a><span id="l9.488" class="difflineminus">-        m_viewFlags &amp;= ~(nsMsgViewFlagsType::kThreadedDisplay | nsMsgViewFlagsType::kGroupBySort);</span>
<a href="#l9.489"></a><span id="l9.489" class="difflineplus">+        m_viewFlags &amp;= ~(nsMsgViewFlagsType::kThreadedDisplay |</span>
<a href="#l9.490"></a><span id="l9.490" class="difflineplus">+                         nsMsgViewFlagsType::kGroupBySort);</span>
<a href="#l9.491"></a><span id="l9.491">         ExpandAll();</span>
<a href="#l9.492"></a><span id="l9.492">         // m_idArray.RemoveAll();</span>
<a href="#l9.493"></a><span id="l9.493">         // m_flags.Clear();</span>
<a href="#l9.494"></a><span id="l9.494">         m_havePrevView = true;</span>
<a href="#l9.495"></a><span id="l9.495">       }</span>
<a href="#l9.496"></a><span id="l9.496">     }</span>
<a href="#l9.497"></a><span id="l9.497" class="difflineminus">-  }</span>
<a href="#l9.498"></a><span id="l9.498" class="difflineminus">-  else if (m_sortOrder != sortOrder)</span>
<a href="#l9.499"></a><span id="l9.499" class="difflineminus">-  {</span>
<a href="#l9.500"></a><span id="l9.500" class="difflineplus">+  } else if (m_sortOrder != sortOrder) {</span>
<a href="#l9.501"></a><span id="l9.501">     // Check for toggling the sort.</span>
<a href="#l9.502"></a><span id="l9.502">     nsMsgDBView::Sort(sortType, sortOrder);</span>
<a href="#l9.503"></a><span id="l9.503">   }</span>
<a href="#l9.504"></a><span id="l9.504"> </span>
<a href="#l9.505"></a><span id="l9.505" class="difflineminus">-  if (!sortThreads)</span>
<a href="#l9.506"></a><span id="l9.506" class="difflineminus">-  {</span>
<a href="#l9.507"></a><span id="l9.507" class="difflineplus">+  if (!sortThreads) {</span>
<a href="#l9.508"></a><span id="l9.508">     // Call the base class in case we're not sorting by thread.</span>
<a href="#l9.509"></a><span id="l9.509">     rv = nsMsgDBView::Sort(sortType, sortOrder);</span>
<a href="#l9.510"></a><span id="l9.510">     SaveSortInfo(sortType, sortOrder);</span>
<a href="#l9.511"></a><span id="l9.511">   }</span>
<a href="#l9.512"></a><span id="l9.512"> </span>
<a href="#l9.513"></a><span id="l9.513">   // The sort may have changed the number of rows</span>
<a href="#l9.514"></a><span id="l9.514">   // before we restore the selection, tell the tree</span>
<a href="#l9.515"></a><span id="l9.515">   // do this before we call restore selection</span>
<a href="#l9.516"></a><span id="l9.516">   // this is safe when there is no selection.</span>
<a href="#l9.517"></a><span id="l9.517">   rv = AdjustRowCount(rowCountBeforeSort, GetSize());</span>
<a href="#l9.518"></a><span id="l9.518"> </span>
<a href="#l9.519"></a><span id="l9.519">   RestoreSelection(preservedKey, preservedSelection);</span>
<a href="#l9.520"></a><span id="l9.520" class="difflineminus">-  if (mTree)</span>
<a href="#l9.521"></a><span id="l9.521" class="difflineminus">-    mTree-&gt;Invalidate();</span>
<a href="#l9.522"></a><span id="l9.522" class="difflineplus">+  if (mTree) mTree-&gt;Invalidate();</span>
<a href="#l9.523"></a><span id="l9.523"> </span>
<a href="#l9.524"></a><span id="l9.524" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l9.525"></a><span id="l9.525" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.526"></a><span id="l9.526">   return NS_OK;</span>
<a href="#l9.527"></a><span id="l9.527"> }</span>
<a href="#l9.528"></a><span id="l9.528"> </span>
<a href="#l9.529"></a><span id="l9.529"> // List the ids of the top-level thread ids starting at id == startMsg.</span>
<a href="#l9.530"></a><span id="l9.530"> // This actually returns the ids of the first message in each thread.</span>
<a href="#l9.531"></a><span id="l9.531" class="difflineminus">-nsresult</span>
<a href="#l9.532"></a><span id="l9.532" class="difflineminus">-nsMsgThreadedDBView::ListThreadIds(nsMsgKey *startMsg,</span>
<a href="#l9.533"></a><span id="l9.533" class="difflineminus">-                                   bool unreadOnly,</span>
<a href="#l9.534"></a><span id="l9.534" class="difflineminus">-                                   nsMsgKey *pOutput,</span>
<a href="#l9.535"></a><span id="l9.535" class="difflineminus">-                                   int32_t *pFlags,</span>
<a href="#l9.536"></a><span id="l9.536" class="difflineminus">-                                   char *pLevels,</span>
<a href="#l9.537"></a><span id="l9.537" class="difflineminus">-                                   int32_t numToList,</span>
<a href="#l9.538"></a><span id="l9.538" class="difflineminus">-                                   int32_t *pNumListed,</span>
<a href="#l9.539"></a><span id="l9.539" class="difflineminus">-                                   int32_t *pTotalHeaders)</span>
<a href="#l9.540"></a><span id="l9.540" class="difflineminus">-{</span>
<a href="#l9.541"></a><span id="l9.541" class="difflineplus">+nsresult nsMsgThreadedDBView::ListThreadIds(nsMsgKey *startMsg, bool unreadOnly,</span>
<a href="#l9.542"></a><span id="l9.542" class="difflineplus">+                                            nsMsgKey *pOutput, int32_t *pFlags,</span>
<a href="#l9.543"></a><span id="l9.543" class="difflineplus">+                                            char *pLevels, int32_t numToList,</span>
<a href="#l9.544"></a><span id="l9.544" class="difflineplus">+                                            int32_t *pNumListed,</span>
<a href="#l9.545"></a><span id="l9.545" class="difflineplus">+                                            int32_t *pTotalHeaders) {</span>
<a href="#l9.546"></a><span id="l9.546">   nsresult rv = NS_OK;</span>
<a href="#l9.547"></a><span id="l9.547">   // N.B..don't ret before assigning numListed to *pNumListed.</span>
<a href="#l9.548"></a><span id="l9.548">   int32_t numListed = 0;</span>
<a href="#l9.549"></a><span id="l9.549"> </span>
<a href="#l9.550"></a><span id="l9.550" class="difflineminus">-  if (*startMsg &gt; 0)</span>
<a href="#l9.551"></a><span id="l9.551" class="difflineminus">-  {</span>
<a href="#l9.552"></a><span id="l9.552" class="difflineplus">+  if (*startMsg &gt; 0) {</span>
<a href="#l9.553"></a><span id="l9.553">     // For now, we'll just have to rely on the caller leaving</span>
<a href="#l9.554"></a><span id="l9.554">     // the iterator in the right place.</span>
<a href="#l9.555"></a><span id="l9.555">     NS_ASSERTION(m_threadEnumerator != nullptr, &quot;where's our iterator?&quot;);</span>
<a href="#l9.556"></a><span id="l9.556" class="difflineminus">-  }</span>
<a href="#l9.557"></a><span id="l9.557" class="difflineminus">-  else</span>
<a href="#l9.558"></a><span id="l9.558" class="difflineminus">-  {</span>
<a href="#l9.559"></a><span id="l9.559" class="difflineplus">+  } else {</span>
<a href="#l9.560"></a><span id="l9.560">     NS_ASSERTION(m_db, &quot;no db&quot;);</span>
<a href="#l9.561"></a><span id="l9.561" class="difflineminus">-    if (!m_db)</span>
<a href="#l9.562"></a><span id="l9.562" class="difflineminus">-      return NS_ERROR_UNEXPECTED;</span>
<a href="#l9.563"></a><span id="l9.563" class="difflineplus">+    if (!m_db) return NS_ERROR_UNEXPECTED;</span>
<a href="#l9.564"></a><span id="l9.564"> </span>
<a href="#l9.565"></a><span id="l9.565">     rv = m_db-&gt;EnumerateThreads(getter_AddRefs(m_threadEnumerator));</span>
<a href="#l9.566"></a><span id="l9.566">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.567"></a><span id="l9.567">   }</span>
<a href="#l9.568"></a><span id="l9.568"> </span>
<a href="#l9.569"></a><span id="l9.569">   bool hasMore = false;</span>
<a href="#l9.570"></a><span id="l9.570"> </span>
<a href="#l9.571"></a><span id="l9.571" class="difflineminus">-  nsCOMPtr &lt;nsIMsgThread&gt; threadHdr ;</span>
<a href="#l9.572"></a><span id="l9.572" class="difflineplus">+  nsCOMPtr&lt;nsIMsgThread&gt; threadHdr;</span>
<a href="#l9.573"></a><span id="l9.573">   int32_t threadsRemoved = 0;</span>
<a href="#l9.574"></a><span id="l9.574">   while (numListed &lt; numToList &amp;&amp;</span>
<a href="#l9.575"></a><span id="l9.575">          NS_SUCCEEDED(rv = m_threadEnumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp;</span>
<a href="#l9.576"></a><span id="l9.576" class="difflineminus">-         hasMore)</span>
<a href="#l9.577"></a><span id="l9.577" class="difflineminus">-  {</span>
<a href="#l9.578"></a><span id="l9.578" class="difflineminus">-    nsCOMPtr &lt;nsISupports&gt; supports;</span>
<a href="#l9.579"></a><span id="l9.579" class="difflineplus">+         hasMore) {</span>
<a href="#l9.580"></a><span id="l9.580" class="difflineplus">+    nsCOMPtr&lt;nsISupports&gt; supports;</span>
<a href="#l9.581"></a><span id="l9.581">     rv = m_threadEnumerator-&gt;GetNext(getter_AddRefs(supports));</span>
<a href="#l9.582"></a><span id="l9.582" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l9.583"></a><span id="l9.583" class="difflineminus">-    {</span>
<a href="#l9.584"></a><span id="l9.584" class="difflineplus">+    if (NS_FAILED(rv)) {</span>
<a href="#l9.585"></a><span id="l9.585">       threadHdr = nullptr;</span>
<a href="#l9.586"></a><span id="l9.586">       break;</span>
<a href="#l9.587"></a><span id="l9.587">     }</span>
<a href="#l9.588"></a><span id="l9.588"> </span>
<a href="#l9.589"></a><span id="l9.589">     threadHdr = do_QueryInterface(supports);</span>
<a href="#l9.590"></a><span id="l9.590" class="difflineminus">-    if (!threadHdr)</span>
<a href="#l9.591"></a><span id="l9.591" class="difflineminus">-      break;</span>
<a href="#l9.592"></a><span id="l9.592" class="difflineplus">+    if (!threadHdr) break;</span>
<a href="#l9.593"></a><span id="l9.593"> </span>
<a href="#l9.594"></a><span id="l9.594" class="difflineminus">-    nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l9.595"></a><span id="l9.595" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l9.596"></a><span id="l9.596">     uint32_t numChildren;</span>
<a href="#l9.597"></a><span id="l9.597">     if (unreadOnly)</span>
<a href="#l9.598"></a><span id="l9.598">       threadHdr-&gt;GetNumUnreadChildren(&amp;numChildren);</span>
<a href="#l9.599"></a><span id="l9.599">     else</span>
<a href="#l9.600"></a><span id="l9.600">       threadHdr-&gt;GetNumChildren(&amp;numChildren);</span>
<a href="#l9.601"></a><span id="l9.601"> </span>
<a href="#l9.602"></a><span id="l9.602">     uint32_t threadFlags;</span>
<a href="#l9.603"></a><span id="l9.603">     threadHdr-&gt;GetFlags(&amp;threadFlags);</span>
<a href="#l9.604"></a><span id="l9.604" class="difflineminus">-    if (numChildren != 0)</span>
<a href="#l9.605"></a><span id="l9.605" class="difflineminus">-    {</span>
<a href="#l9.606"></a><span id="l9.606" class="difflineplus">+    if (numChildren != 0) {</span>
<a href="#l9.607"></a><span id="l9.607">       // Not an empty thread.</span>
<a href="#l9.608"></a><span id="l9.608">       int32_t unusedRootIndex;</span>
<a href="#l9.609"></a><span id="l9.609" class="difflineminus">-      if (pTotalHeaders)</span>
<a href="#l9.610"></a><span id="l9.610" class="difflineminus">-        *pTotalHeaders += numChildren;</span>
<a href="#l9.611"></a><span id="l9.611" class="difflineplus">+      if (pTotalHeaders) *pTotalHeaders += numChildren;</span>
<a href="#l9.612"></a><span id="l9.612"> </span>
<a href="#l9.613"></a><span id="l9.613">       if (unreadOnly)</span>
<a href="#l9.614"></a><span id="l9.614">         rv = threadHdr-&gt;GetFirstUnreadChild(getter_AddRefs(msgHdr));</span>
<a href="#l9.615"></a><span id="l9.615">       else</span>
<a href="#l9.616"></a><span id="l9.616">         rv = threadHdr-&gt;GetRootHdr(&amp;unusedRootIndex, getter_AddRefs(msgHdr));</span>
<a href="#l9.617"></a><span id="l9.617"> </span>
<a href="#l9.618"></a><span id="l9.618" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; msgHdr != nullptr &amp;&amp; WantsThisThread(threadHdr))</span>
<a href="#l9.619"></a><span id="l9.619" class="difflineminus">-      {</span>
<a href="#l9.620"></a><span id="l9.620" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; msgHdr != nullptr &amp;&amp; WantsThisThread(threadHdr)) {</span>
<a href="#l9.621"></a><span id="l9.621">         uint32_t msgFlags;</span>
<a href="#l9.622"></a><span id="l9.622">         uint32_t newMsgFlags;</span>
<a href="#l9.623"></a><span id="l9.623">         nsMsgKey msgKey;</span>
<a href="#l9.624"></a><span id="l9.624">         msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l9.625"></a><span id="l9.625">         msgHdr-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l9.626"></a><span id="l9.626">         // Turn off high byte of msg flags - used for view flags.</span>
<a href="#l9.627"></a><span id="l9.627">         msgFlags &amp;= ~MSG_VIEW_FLAGS;</span>
<a href="#l9.628"></a><span id="l9.628">         pOutput[numListed] = msgKey;</span>
<a href="#l9.629"></a><span id="l9.629">         pLevels[numListed] = 0;</span>
<a href="#l9.630"></a><span id="l9.630">         // Turn off these flags on msg hdr - they belong in thread.</span>
<a href="#l9.631"></a><span id="l9.631">         msgHdr-&gt;AndFlags(~(nsMsgMessageFlags::Watched), &amp;newMsgFlags);</span>
<a href="#l9.632"></a><span id="l9.632">         AdjustReadFlag(msgHdr, &amp;msgFlags);</span>
<a href="#l9.633"></a><span id="l9.633">         // Try adding in MSG_VIEW_FLAG_ISTHREAD flag for unreadonly view.</span>
<a href="#l9.634"></a><span id="l9.634">         pFlags[numListed] = msgFlags | MSG_VIEW_FLAG_ISTHREAD | threadFlags;</span>
<a href="#l9.635"></a><span id="l9.635" class="difflineminus">-        if (numChildren &gt; 1)</span>
<a href="#l9.636"></a><span id="l9.636" class="difflineminus">-          pFlags[numListed] |= MSG_VIEW_FLAG_HASCHILDREN;</span>
<a href="#l9.637"></a><span id="l9.637" class="difflineplus">+        if (numChildren &gt; 1) pFlags[numListed] |= MSG_VIEW_FLAG_HASCHILDREN;</span>
<a href="#l9.638"></a><span id="l9.638"> </span>
<a href="#l9.639"></a><span id="l9.639">         numListed++;</span>
<a href="#l9.640"></a><span id="l9.640" class="difflineminus">-      }</span>
<a href="#l9.641"></a><span id="l9.641" class="difflineminus">-      else</span>
<a href="#l9.642"></a><span id="l9.642" class="difflineminus">-      {</span>
<a href="#l9.643"></a><span id="l9.643" class="difflineplus">+      } else {</span>
<a href="#l9.644"></a><span id="l9.644">         NS_ASSERTION(NS_SUCCEEDED(rv) &amp;&amp; msgHdr,</span>
<a href="#l9.645"></a><span id="l9.645">                      &quot;couldn't get header for some reason&quot;);</span>
<a href="#l9.646"></a><span id="l9.646">       }</span>
<a href="#l9.647"></a><span id="l9.647" class="difflineminus">-    }</span>
<a href="#l9.648"></a><span id="l9.648" class="difflineminus">-    else if (threadsRemoved &lt; 10 &amp;&amp;</span>
<a href="#l9.649"></a><span id="l9.649" class="difflineminus">-             !(threadFlags &amp; (nsMsgMessageFlags::Watched |</span>
<a href="#l9.650"></a><span id="l9.650" class="difflineminus">-                              nsMsgMessageFlags::Ignored)))</span>
<a href="#l9.651"></a><span id="l9.651" class="difflineminus">-    {</span>
<a href="#l9.652"></a><span id="l9.652" class="difflineplus">+    } else if (threadsRemoved &lt; 10 &amp;&amp;</span>
<a href="#l9.653"></a><span id="l9.653" class="difflineplus">+               !(threadFlags &amp;</span>
<a href="#l9.654"></a><span id="l9.654" class="difflineplus">+                 (nsMsgMessageFlags::Watched | nsMsgMessageFlags::Ignored))) {</span>
<a href="#l9.655"></a><span id="l9.655">       // ### remove thread.</span>
<a href="#l9.656"></a><span id="l9.656">       // Don't want to remove all empty threads first time around as it will</span>
<a href="#l9.657"></a><span id="l9.657">       // choke performance for upgrade.</span>
<a href="#l9.658"></a><span id="l9.658">       threadsRemoved++;</span>
<a href="#l9.659"></a><span id="l9.659"> #ifdef DEBUG_bienvenu</span>
<a href="#l9.660"></a><span id="l9.660">       printf(&quot;removing empty non-ignored non-watched thread\n&quot;);</span>
<a href="#l9.661"></a><span id="l9.661"> #endif</span>
<a href="#l9.662"></a><span id="l9.662">     }</span>
<a href="#l9.663"></a><span id="l9.663">   }</span>
<a href="#l9.664"></a><span id="l9.664"> </span>
<a href="#l9.665"></a><span id="l9.665" class="difflineminus">-  if (hasMore &amp;&amp; threadHdr)</span>
<a href="#l9.666"></a><span id="l9.666" class="difflineminus">-  {</span>
<a href="#l9.667"></a><span id="l9.667" class="difflineplus">+  if (hasMore &amp;&amp; threadHdr) {</span>
<a href="#l9.668"></a><span id="l9.668">     threadHdr-&gt;GetThreadKey(startMsg);</span>
<a href="#l9.669"></a><span id="l9.669" class="difflineminus">-  }</span>
<a href="#l9.670"></a><span id="l9.670" class="difflineminus">-  else</span>
<a href="#l9.671"></a><span id="l9.671" class="difflineminus">-  {</span>
<a href="#l9.672"></a><span id="l9.672" class="difflineplus">+  } else {</span>
<a href="#l9.673"></a><span id="l9.673">     *startMsg = nsMsgKey_None;</span>
<a href="#l9.674"></a><span id="l9.674" class="difflineminus">-    nsCOMPtr &lt;nsIDBChangeListener&gt; dbListener = do_QueryInterface(m_threadEnumerator);</span>
<a href="#l9.675"></a><span id="l9.675" class="difflineplus">+    nsCOMPtr&lt;nsIDBChangeListener&gt; dbListener =</span>
<a href="#l9.676"></a><span id="l9.676" class="difflineplus">+        do_QueryInterface(m_threadEnumerator);</span>
<a href="#l9.677"></a><span id="l9.677">     // This is needed to make the thread enumerator release its reference</span>
<a href="#l9.678"></a><span id="l9.678">     // to the db.</span>
<a href="#l9.679"></a><span id="l9.679" class="difflineminus">-    if (dbListener)</span>
<a href="#l9.680"></a><span id="l9.680" class="difflineminus">-      dbListener-&gt;OnAnnouncerGoingAway(nullptr);</span>
<a href="#l9.681"></a><span id="l9.681" class="difflineplus">+    if (dbListener) dbListener-&gt;OnAnnouncerGoingAway(nullptr);</span>
<a href="#l9.682"></a><span id="l9.682"> </span>
<a href="#l9.683"></a><span id="l9.683">     m_threadEnumerator = nullptr;</span>
<a href="#l9.684"></a><span id="l9.684">   }</span>
<a href="#l9.685"></a><span id="l9.685"> </span>
<a href="#l9.686"></a><span id="l9.686">   *pNumListed = numListed;</span>
<a href="#l9.687"></a><span id="l9.687">   return rv;</span>
<a href="#l9.688"></a><span id="l9.688"> }</span>
<a href="#l9.689"></a><span id="l9.689"> </span>
<a href="#l9.690"></a><span id="l9.690" class="difflineminus">-void</span>
<a href="#l9.691"></a><span id="l9.691" class="difflineminus">-nsMsgThreadedDBView::OnExtraFlagChanged(nsMsgViewIndex index,</span>
<a href="#l9.692"></a><span id="l9.692" class="difflineminus">-                                        uint32_t extraFlag)</span>
<a href="#l9.693"></a><span id="l9.693" class="difflineminus">-{</span>
<a href="#l9.694"></a><span id="l9.694" class="difflineminus">-  if (IsValidIndex(index))</span>
<a href="#l9.695"></a><span id="l9.695" class="difflineminus">-  {</span>
<a href="#l9.696"></a><span id="l9.696" class="difflineminus">-    if (m_havePrevView)</span>
<a href="#l9.697"></a><span id="l9.697" class="difflineminus">-    {</span>
<a href="#l9.698"></a><span id="l9.698" class="difflineplus">+void nsMsgThreadedDBView::OnExtraFlagChanged(nsMsgViewIndex index,</span>
<a href="#l9.699"></a><span id="l9.699" class="difflineplus">+                                             uint32_t extraFlag) {</span>
<a href="#l9.700"></a><span id="l9.700" class="difflineplus">+  if (IsValidIndex(index)) {</span>
<a href="#l9.701"></a><span id="l9.701" class="difflineplus">+    if (m_havePrevView) {</span>
<a href="#l9.702"></a><span id="l9.702">       nsMsgKey keyChanged = m_keys[index];</span>
<a href="#l9.703"></a><span id="l9.703">       nsMsgViewIndex prevViewIndex = m_prevKeys.IndexOf(keyChanged);</span>
<a href="#l9.704"></a><span id="l9.704" class="difflineminus">-      if (prevViewIndex != nsMsgViewIndex_None)</span>
<a href="#l9.705"></a><span id="l9.705" class="difflineminus">-      {</span>
<a href="#l9.706"></a><span id="l9.706" class="difflineplus">+      if (prevViewIndex != nsMsgViewIndex_None) {</span>
<a href="#l9.707"></a><span id="l9.707">         uint32_t prevFlag = m_prevFlags[prevViewIndex];</span>
<a href="#l9.708"></a><span id="l9.708">         // Don't want to change the elided bit, or has children or is thread.</span>
<a href="#l9.709"></a><span id="l9.709">         if (prevFlag &amp; nsMsgMessageFlags::Elided)</span>
<a href="#l9.710"></a><span id="l9.710">           extraFlag |= nsMsgMessageFlags::Elided;</span>
<a href="#l9.711"></a><span id="l9.711">         else</span>
<a href="#l9.712"></a><span id="l9.712">           extraFlag &amp;= ~nsMsgMessageFlags::Elided;</span>
<a href="#l9.713"></a><span id="l9.713"> </span>
<a href="#l9.714"></a><span id="l9.714">         if (prevFlag &amp; MSG_VIEW_FLAG_ISTHREAD)</span>
<a href="#l9.715"></a><span id="l9.715" class="difflineat">@@ -612,106 +518,87 @@ nsMsgThreadedDBView::OnExtraFlagChanged(</span>
<a href="#l9.716"></a><span id="l9.716">     }</span>
<a href="#l9.717"></a><span id="l9.717">   }</span>
<a href="#l9.718"></a><span id="l9.718"> </span>
<a href="#l9.719"></a><span id="l9.719">   // We don't really know what's changed, but to be on the safe side, set the</span>
<a href="#l9.720"></a><span id="l9.720">   // sort invalid so that reverse sort will pick it up.</span>
<a href="#l9.721"></a><span id="l9.721">   if (m_sortType == nsMsgViewSortType::byStatus ||</span>
<a href="#l9.722"></a><span id="l9.722">       m_sortType == nsMsgViewSortType::byFlagged ||</span>
<a href="#l9.723"></a><span id="l9.723">       m_sortType == nsMsgViewSortType::byUnread ||</span>
<a href="#l9.724"></a><span id="l9.724" class="difflineminus">-      m_sortType == nsMsgViewSortType::byPriority)</span>
<a href="#l9.725"></a><span id="l9.725" class="difflineminus">-  {</span>
<a href="#l9.726"></a><span id="l9.726" class="difflineplus">+      m_sortType == nsMsgViewSortType::byPriority) {</span>
<a href="#l9.727"></a><span id="l9.727">     m_sortValid = false;</span>
<a href="#l9.728"></a><span id="l9.728">   }</span>
<a href="#l9.729"></a><span id="l9.729"> }</span>
<a href="#l9.730"></a><span id="l9.730"> </span>
<a href="#l9.731"></a><span id="l9.731" class="difflineminus">-void</span>
<a href="#l9.732"></a><span id="l9.732" class="difflineminus">-nsMsgThreadedDBView::OnHeaderAddedOrDeleted()</span>
<a href="#l9.733"></a><span id="l9.733" class="difflineminus">-{</span>
<a href="#l9.734"></a><span id="l9.734" class="difflineminus">-  ClearPrevIdArray();</span>
<a href="#l9.735"></a><span id="l9.735" class="difflineminus">-}</span>
<a href="#l9.736"></a><span id="l9.736" class="difflineplus">+void nsMsgThreadedDBView::OnHeaderAddedOrDeleted() { ClearPrevIdArray(); }</span>
<a href="#l9.737"></a><span id="l9.737"> </span>
<a href="#l9.738"></a><span id="l9.738" class="difflineminus">-void</span>
<a href="#l9.739"></a><span id="l9.739" class="difflineminus">-nsMsgThreadedDBView::ClearPrevIdArray()</span>
<a href="#l9.740"></a><span id="l9.740" class="difflineminus">-{</span>
<a href="#l9.741"></a><span id="l9.741" class="difflineplus">+void nsMsgThreadedDBView::ClearPrevIdArray() {</span>
<a href="#l9.742"></a><span id="l9.742">   m_prevKeys.Clear();</span>
<a href="#l9.743"></a><span id="l9.743">   m_prevLevels.Clear();</span>
<a href="#l9.744"></a><span id="l9.744">   m_prevFlags.Clear();</span>
<a href="#l9.745"></a><span id="l9.745">   m_havePrevView = false;</span>
<a href="#l9.746"></a><span id="l9.746"> }</span>
<a href="#l9.747"></a><span id="l9.747"> </span>
<a href="#l9.748"></a><span id="l9.748" class="difflineminus">-nsresult</span>
<a href="#l9.749"></a><span id="l9.749" class="difflineminus">-nsMsgThreadedDBView::InitSort(nsMsgViewSortTypeValue sortType,</span>
<a href="#l9.750"></a><span id="l9.750" class="difflineminus">-                              nsMsgViewSortOrderValue sortOrder)</span>
<a href="#l9.751"></a><span id="l9.751" class="difflineminus">-{</span>
<a href="#l9.752"></a><span id="l9.752" class="difflineplus">+nsresult nsMsgThreadedDBView::InitSort(nsMsgViewSortTypeValue sortType,</span>
<a href="#l9.753"></a><span id="l9.753" class="difflineplus">+                                       nsMsgViewSortOrderValue sortOrder) {</span>
<a href="#l9.754"></a><span id="l9.754">   // Nothing to do.</span>
<a href="#l9.755"></a><span id="l9.755" class="difflineminus">-  if (m_viewFlags &amp; nsMsgViewFlagsType::kGroupBySort)</span>
<a href="#l9.756"></a><span id="l9.756" class="difflineminus">-    return NS_OK;</span>
<a href="#l9.757"></a><span id="l9.757" class="difflineplus">+  if (m_viewFlags &amp; nsMsgViewFlagsType::kGroupBySort) return NS_OK;</span>
<a href="#l9.758"></a><span id="l9.758"> </span>
<a href="#l9.759"></a><span id="l9.759" class="difflineminus">-  if (sortType == nsMsgViewSortType::byThread)</span>
<a href="#l9.760"></a><span id="l9.760" class="difflineminus">-  {</span>
<a href="#l9.761"></a><span id="l9.761" class="difflineplus">+  if (sortType == nsMsgViewSortType::byThread) {</span>
<a href="#l9.762"></a><span id="l9.762">     // Sort top level threads by id.</span>
<a href="#l9.763"></a><span id="l9.763">     nsMsgDBView::Sort(nsMsgViewSortType::byId, sortOrder);</span>
<a href="#l9.764"></a><span id="l9.764">     m_sortType = nsMsgViewSortType::byThread;</span>
<a href="#l9.765"></a><span id="l9.765">     m_viewFlags |= nsMsgViewFlagsType::kThreadedDisplay;</span>
<a href="#l9.766"></a><span id="l9.766">     m_viewFlags &amp;= ~nsMsgViewFlagsType::kGroupBySort;</span>
<a href="#l9.767"></a><span id="l9.767">     // Persist the view flags.</span>
<a href="#l9.768"></a><span id="l9.768">     SetViewFlags(m_viewFlags);</span>
<a href="#l9.769"></a><span id="l9.769">     // m_db-&gt;SetSortInfo(m_sortType, sortOrder);</span>
<a href="#l9.770"></a><span id="l9.770">   }</span>
<a href="#l9.771"></a><span id="l9.771" class="difflineminus">-//  else</span>
<a href="#l9.772"></a><span id="l9.772" class="difflineminus">-//    m_viewFlags &amp;= ~nsMsgViewFlagsType::kThreadedDisplay;</span>
<a href="#l9.773"></a><span id="l9.773" class="difflineminus">-</span>
<a href="#l9.774"></a><span id="l9.774" class="difflineplus">+  //  else</span>
<a href="#l9.775"></a><span id="l9.775" class="difflineplus">+  //    m_viewFlags &amp;= ~nsMsgViewFlagsType::kThreadedDisplay;</span>
<a href="#l9.776"></a><span id="l9.776"> </span>
<a href="#l9.777"></a><span id="l9.777">   // By default, the unread only view should have all threads expanded.</span>
<a href="#l9.778"></a><span id="l9.778" class="difflineminus">-  if ((m_viewFlags &amp; (nsMsgViewFlagsType::kUnreadOnly |</span>
<a href="#l9.779"></a><span id="l9.779" class="difflineminus">-                      nsMsgViewFlagsType::kExpandAll)) &amp;&amp;</span>
<a href="#l9.780"></a><span id="l9.780" class="difflineminus">-      (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay))</span>
<a href="#l9.781"></a><span id="l9.781" class="difflineminus">-  {</span>
<a href="#l9.782"></a><span id="l9.782" class="difflineplus">+  if ((m_viewFlags &amp;</span>
<a href="#l9.783"></a><span id="l9.783" class="difflineplus">+       (nsMsgViewFlagsType::kUnreadOnly | nsMsgViewFlagsType::kExpandAll)) &amp;&amp;</span>
<a href="#l9.784"></a><span id="l9.784" class="difflineplus">+      (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay)) {</span>
<a href="#l9.785"></a><span id="l9.785">     ExpandAll();</span>
<a href="#l9.786"></a><span id="l9.786">   }</span>
<a href="#l9.787"></a><span id="l9.787"> </span>
<a href="#l9.788"></a><span id="l9.788" class="difflineminus">-  if (!(m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay))</span>
<a href="#l9.789"></a><span id="l9.789" class="difflineminus">-  {</span>
<a href="#l9.790"></a><span id="l9.790" class="difflineplus">+  if (!(m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay)) {</span>
<a href="#l9.791"></a><span id="l9.791">     // For now, expand all and do a flat sort.</span>
<a href="#l9.792"></a><span id="l9.792">     ExpandAll();</span>
<a href="#l9.793"></a><span id="l9.793">   }</span>
<a href="#l9.794"></a><span id="l9.794"> </span>
<a href="#l9.795"></a><span id="l9.795">   Sort(sortType, sortOrder);</span>
<a href="#l9.796"></a><span id="l9.796" class="difflineminus">-  if (sortType != nsMsgViewSortType::byThread)</span>
<a href="#l9.797"></a><span id="l9.797" class="difflineminus">-  {</span>
<a href="#l9.798"></a><span id="l9.798" class="difflineplus">+  if (sortType != nsMsgViewSortType::byThread) {</span>
<a href="#l9.799"></a><span id="l9.799">     // Forget prev view, since it has everything expanded.</span>
<a href="#l9.800"></a><span id="l9.800">     ClearPrevIdArray();</span>
<a href="#l9.801"></a><span id="l9.801">   }</span>
<a href="#l9.802"></a><span id="l9.802"> </span>
<a href="#l9.803"></a><span id="l9.803">   return NS_OK;</span>
<a href="#l9.804"></a><span id="l9.804"> }</span>
<a href="#l9.805"></a><span id="l9.805"> </span>
<a href="#l9.806"></a><span id="l9.806" class="difflineminus">-nsresult</span>
<a href="#l9.807"></a><span id="l9.807" class="difflineminus">-nsMsgThreadedDBView::OnNewHeader(nsIMsgDBHdr *newHdr,</span>
<a href="#l9.808"></a><span id="l9.808" class="difflineminus">-                                 nsMsgKey aParentKey,</span>
<a href="#l9.809"></a><span id="l9.809" class="difflineminus">-                                 bool ensureListed)</span>
<a href="#l9.810"></a><span id="l9.810" class="difflineminus">-{</span>
<a href="#l9.811"></a><span id="l9.811" class="difflineplus">+nsresult nsMsgThreadedDBView::OnNewHeader(nsIMsgDBHdr *newHdr,</span>
<a href="#l9.812"></a><span id="l9.812" class="difflineplus">+                                          nsMsgKey aParentKey,</span>
<a href="#l9.813"></a><span id="l9.813" class="difflineplus">+                                          bool ensureListed) {</span>
<a href="#l9.814"></a><span id="l9.814">   if (m_viewFlags &amp; nsMsgViewFlagsType::kGroupBySort)</span>
<a href="#l9.815"></a><span id="l9.815">     return nsMsgGroupView::OnNewHeader(newHdr, aParentKey, ensureListed);</span>
<a href="#l9.816"></a><span id="l9.816"> </span>
<a href="#l9.817"></a><span id="l9.817">   NS_ENSURE_TRUE(newHdr, NS_MSG_MESSAGE_NOT_FOUND);</span>
<a href="#l9.818"></a><span id="l9.818"> </span>
<a href="#l9.819"></a><span id="l9.819">   nsMsgKey newKey;</span>
<a href="#l9.820"></a><span id="l9.820">   newHdr-&gt;GetMessageKey(&amp;newKey);</span>
<a href="#l9.821"></a><span id="l9.821"> </span>
<a href="#l9.822"></a><span id="l9.822">   // Views can override this behaviour, which is to append to view.</span>
<a href="#l9.823"></a><span id="l9.823">   // This is the mail behaviour, but threaded views want</span>
<a href="#l9.824"></a><span id="l9.824">   // to insert in order...</span>
<a href="#l9.825"></a><span id="l9.825">   uint32_t msgFlags;</span>
<a href="#l9.826"></a><span id="l9.826">   newHdr-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l9.827"></a><span id="l9.827" class="difflineminus">-  if (m_viewFlags &amp; nsMsgViewFlagsType::kUnreadOnly &amp;&amp;</span>
<a href="#l9.828"></a><span id="l9.828" class="difflineminus">-      !ensureListed &amp;&amp;</span>
<a href="#l9.829"></a><span id="l9.829" class="difflineminus">-      msgFlags &amp; nsMsgMessageFlags::Read)</span>
<a href="#l9.830"></a><span id="l9.830" class="difflineminus">-  {</span>
<a href="#l9.831"></a><span id="l9.831" class="difflineplus">+  if (m_viewFlags &amp; nsMsgViewFlagsType::kUnreadOnly &amp;&amp; !ensureListed &amp;&amp;</span>
<a href="#l9.832"></a><span id="l9.832" class="difflineplus">+      msgFlags &amp; nsMsgMessageFlags::Read) {</span>
<a href="#l9.833"></a><span id="l9.833">     return NS_OK;</span>
<a href="#l9.834"></a><span id="l9.834">   }</span>
<a href="#l9.835"></a><span id="l9.835"> </span>
<a href="#l9.836"></a><span id="l9.836">   // Currently, we only add the header in a threaded view if it's a thread.</span>
<a href="#l9.837"></a><span id="l9.837">   // We used to check if this was the first header in the thread, but that's</span>
<a href="#l9.838"></a><span id="l9.838">   // a bit harder in the unreadOnly view. But we'll catch it below.</span>
<a href="#l9.839"></a><span id="l9.839"> </span>
<a href="#l9.840"></a><span id="l9.840">   // If not threaded display just add it to the view.</span>
<a href="#l9.841"></a><span id="l9.841" class="difflineat">@@ -719,80 +606,71 @@ nsMsgThreadedDBView::OnNewHeader(nsIMsgD</span>
<a href="#l9.842"></a><span id="l9.842">     return AddHdr(newHdr);</span>
<a href="#l9.843"></a><span id="l9.843"> </span>
<a href="#l9.844"></a><span id="l9.844">   // Need to find the thread we added this to so we can change the hasnew flag</span>
<a href="#l9.845"></a><span id="l9.845">   // added message to existing thread, but not to view.</span>
<a href="#l9.846"></a><span id="l9.846">   // Fix flags on thread header.</span>
<a href="#l9.847"></a><span id="l9.847">   int32_t threadCount;</span>
<a href="#l9.848"></a><span id="l9.848">   uint32_t threadFlags;</span>
<a href="#l9.849"></a><span id="l9.849">   bool moveThread = false;</span>
<a href="#l9.850"></a><span id="l9.850" class="difflineminus">-  nsMsgViewIndex threadIndex = ThreadIndexOfMsg(newKey, nsMsgViewIndex_None,</span>
<a href="#l9.851"></a><span id="l9.851" class="difflineminus">-                                                &amp;threadCount, &amp;threadFlags);</span>
<a href="#l9.852"></a><span id="l9.852" class="difflineplus">+  nsMsgViewIndex threadIndex =</span>
<a href="#l9.853"></a><span id="l9.853" class="difflineplus">+      ThreadIndexOfMsg(newKey, nsMsgViewIndex_None, &amp;threadCount, &amp;threadFlags);</span>
<a href="#l9.854"></a><span id="l9.854">   bool threadRootIsDisplayed = false;</span>
<a href="#l9.855"></a><span id="l9.855"> </span>
<a href="#l9.856"></a><span id="l9.856" class="difflineminus">-  nsCOMPtr &lt;nsIMsgThread&gt; threadHdr;</span>
<a href="#l9.857"></a><span id="l9.857" class="difflineplus">+  nsCOMPtr&lt;nsIMsgThread&gt; threadHdr;</span>
<a href="#l9.858"></a><span id="l9.858">   m_db-&gt;GetThreadContainingMsgHdr(newHdr, getter_AddRefs(threadHdr));</span>
<a href="#l9.859"></a><span id="l9.859" class="difflineminus">-  if (threadHdr &amp;&amp; m_sortType == nsMsgViewSortType::byDate)</span>
<a href="#l9.860"></a><span id="l9.860" class="difflineminus">-  {</span>
<a href="#l9.861"></a><span id="l9.861" class="difflineplus">+  if (threadHdr &amp;&amp; m_sortType == nsMsgViewSortType::byDate) {</span>
<a href="#l9.862"></a><span id="l9.862">     uint32_t newestMsgInThread = 0, msgDate = 0;</span>
<a href="#l9.863"></a><span id="l9.863">     threadHdr-&gt;GetNewestMsgDate(&amp;newestMsgInThread);</span>
<a href="#l9.864"></a><span id="l9.864">     newHdr-&gt;GetDateInSeconds(&amp;msgDate);</span>
<a href="#l9.865"></a><span id="l9.865">     moveThread = (msgDate == newestMsgInThread);</span>
<a href="#l9.866"></a><span id="l9.866">   }</span>
<a href="#l9.867"></a><span id="l9.867"> </span>
<a href="#l9.868"></a><span id="l9.868" class="difflineminus">-  if (threadIndex != nsMsgViewIndex_None)</span>
<a href="#l9.869"></a><span id="l9.869" class="difflineminus">-  {</span>
<a href="#l9.870"></a><span id="l9.870" class="difflineplus">+  if (threadIndex != nsMsgViewIndex_None) {</span>
<a href="#l9.871"></a><span id="l9.871">     threadRootIsDisplayed = (m_currentlyDisplayedViewIndex == threadIndex);</span>
<a href="#l9.872"></a><span id="l9.872">     uint32_t flags = m_flags[threadIndex];</span>
<a href="#l9.873"></a><span id="l9.873" class="difflineminus">-    if (!(flags &amp; MSG_VIEW_FLAG_HASCHILDREN))</span>
<a href="#l9.874"></a><span id="l9.874" class="difflineminus">-    {</span>
<a href="#l9.875"></a><span id="l9.875" class="difflineplus">+    if (!(flags &amp; MSG_VIEW_FLAG_HASCHILDREN)) {</span>
<a href="#l9.876"></a><span id="l9.876">       flags |= MSG_VIEW_FLAG_HASCHILDREN | MSG_VIEW_FLAG_ISTHREAD;</span>
<a href="#l9.877"></a><span id="l9.877">       if (!(m_viewFlags &amp; nsMsgViewFlagsType::kUnreadOnly))</span>
<a href="#l9.878"></a><span id="l9.878">         flags |= nsMsgMessageFlags::Elided;</span>
<a href="#l9.879"></a><span id="l9.879"> </span>
<a href="#l9.880"></a><span id="l9.880">       m_flags[threadIndex] = flags;</span>
<a href="#l9.881"></a><span id="l9.881">     }</span>
<a href="#l9.882"></a><span id="l9.882"> </span>
<a href="#l9.883"></a><span id="l9.883" class="difflineminus">-    if (!(flags &amp; nsMsgMessageFlags::Elided))</span>
<a href="#l9.884"></a><span id="l9.884" class="difflineminus">-    {</span>
<a href="#l9.885"></a><span id="l9.885" class="difflineplus">+    if (!(flags &amp; nsMsgMessageFlags::Elided)) {</span>
<a href="#l9.886"></a><span id="l9.886">       // Thread is expanded.</span>
<a href="#l9.887"></a><span id="l9.887">       // Insert child into thread.</span>
<a href="#l9.888"></a><span id="l9.888">       // Levels of other hdrs may have changed!</span>
<a href="#l9.889"></a><span id="l9.889">       uint32_t newFlags = msgFlags;</span>
<a href="#l9.890"></a><span id="l9.890">       int32_t level = 0;</span>
<a href="#l9.891"></a><span id="l9.891">       nsMsgViewIndex insertIndex = threadIndex;</span>
<a href="#l9.892"></a><span id="l9.892" class="difflineminus">-      if (aParentKey == nsMsgKey_None)</span>
<a href="#l9.893"></a><span id="l9.893" class="difflineminus">-      {</span>
<a href="#l9.894"></a><span id="l9.894" class="difflineplus">+      if (aParentKey == nsMsgKey_None) {</span>
<a href="#l9.895"></a><span id="l9.895">         newFlags |= MSG_VIEW_FLAG_ISTHREAD | MSG_VIEW_FLAG_HASCHILDREN;</span>
<a href="#l9.896"></a><span id="l9.896" class="difflineminus">-      }</span>
<a href="#l9.897"></a><span id="l9.897" class="difflineminus">-      else</span>
<a href="#l9.898"></a><span id="l9.898" class="difflineminus">-      {</span>
<a href="#l9.899"></a><span id="l9.899" class="difflineminus">-        nsMsgViewIndex parentIndex = FindParentInThread(aParentKey, threadIndex);</span>
<a href="#l9.900"></a><span id="l9.900" class="difflineplus">+      } else {</span>
<a href="#l9.901"></a><span id="l9.901" class="difflineplus">+        nsMsgViewIndex parentIndex =</span>
<a href="#l9.902"></a><span id="l9.902" class="difflineplus">+            FindParentInThread(aParentKey, threadIndex);</span>
<a href="#l9.903"></a><span id="l9.903">         level = m_levels[parentIndex] + 1;</span>
<a href="#l9.904"></a><span id="l9.904">         insertIndex = GetInsertInfoForNewHdr(newHdr, parentIndex, level);</span>
<a href="#l9.905"></a><span id="l9.905">       }</span>
<a href="#l9.906"></a><span id="l9.906"> </span>
<a href="#l9.907"></a><span id="l9.907">       InsertMsgHdrAt(insertIndex, newHdr, newKey, newFlags, level);</span>
<a href="#l9.908"></a><span id="l9.908">       // The call to NoteChange() has to happen after we add the key as</span>
<a href="#l9.909"></a><span id="l9.909">       // NoteChange() will call RowCountChanged() which will call our</span>
<a href="#l9.910"></a><span id="l9.910">       // GetRowCount().</span>
<a href="#l9.911"></a><span id="l9.911">       NoteChange(insertIndex, 1, nsMsgViewNotificationCode::insertOrDelete);</span>
<a href="#l9.912"></a><span id="l9.912"> </span>
<a href="#l9.913"></a><span id="l9.913" class="difflineminus">-      if (aParentKey == nsMsgKey_None)</span>
<a href="#l9.914"></a><span id="l9.914" class="difflineminus">-      {</span>
<a href="#l9.915"></a><span id="l9.915" class="difflineplus">+      if (aParentKey == nsMsgKey_None) {</span>
<a href="#l9.916"></a><span id="l9.916">         // this header is the new king! try collapsing the existing thread,</span>
<a href="#l9.917"></a><span id="l9.917">         // removing it, installing this header as king, and expanding it.</span>
<a href="#l9.918"></a><span id="l9.918">         CollapseByIndex(threadIndex, nullptr);</span>
<a href="#l9.919"></a><span id="l9.919">         // call base class, so child won't get promoted.</span>
<a href="#l9.920"></a><span id="l9.920">         // nsMsgDBView::RemoveByIndex(threadIndex);</span>
<a href="#l9.921"></a><span id="l9.921">         ExpandByIndex(threadIndex, nullptr);</span>
<a href="#l9.922"></a><span id="l9.922">       }</span>
<a href="#l9.923"></a><span id="l9.923" class="difflineminus">-    }</span>
<a href="#l9.924"></a><span id="l9.924" class="difflineminus">-    else if (aParentKey == nsMsgKey_None)</span>
<a href="#l9.925"></a><span id="l9.925" class="difflineminus">-    {</span>
<a href="#l9.926"></a><span id="l9.926" class="difflineplus">+    } else if (aParentKey == nsMsgKey_None) {</span>
<a href="#l9.927"></a><span id="l9.927">       // if we have a collapsed thread which just got a new</span>
<a href="#l9.928"></a><span id="l9.928">       // top of thread, change the keys array.</span>
<a href="#l9.929"></a><span id="l9.929">       m_keys[threadIndex] = newKey;</span>
<a href="#l9.930"></a><span id="l9.930">     }</span>
<a href="#l9.931"></a><span id="l9.931"> </span>
<a href="#l9.932"></a><span id="l9.932">     // If this message is new, the thread is collapsed, it is the</span>
<a href="#l9.933"></a><span id="l9.933">     // root and it was displayed, expand it so that the user does</span>
<a href="#l9.934"></a><span id="l9.934">     // not find that their message has magically turned into a summary.</span>
<a href="#l9.935"></a><span id="l9.935" class="difflineat">@@ -801,32 +679,28 @@ nsMsgThreadedDBView::OnNewHeader(nsIMsgD</span>
<a href="#l9.936"></a><span id="l9.936">         threadRootIsDisplayed)</span>
<a href="#l9.937"></a><span id="l9.937">       ExpandByIndex(threadIndex, nullptr);</span>
<a href="#l9.938"></a><span id="l9.938"> </span>
<a href="#l9.939"></a><span id="l9.939">     if (moveThread)</span>
<a href="#l9.940"></a><span id="l9.940">       MoveThreadAt(threadIndex);</span>
<a href="#l9.941"></a><span id="l9.941">     else</span>
<a href="#l9.942"></a><span id="l9.942">       // note change, to update the parent thread's unread and total counts</span>
<a href="#l9.943"></a><span id="l9.943">       NoteChange(threadIndex, 1, nsMsgViewNotificationCode::changed);</span>
<a href="#l9.944"></a><span id="l9.944" class="difflineminus">-  }</span>
<a href="#l9.945"></a><span id="l9.945" class="difflineminus">-  else if (threadHdr)</span>
<a href="#l9.946"></a><span id="l9.946" class="difflineminus">-  {</span>
<a href="#l9.947"></a><span id="l9.947" class="difflineplus">+  } else if (threadHdr) {</span>
<a href="#l9.948"></a><span id="l9.948">     // Adding msg to thread that's not in view.</span>
<a href="#l9.949"></a><span id="l9.949">     AddMsgToThreadNotInView(threadHdr, newHdr, ensureListed);</span>
<a href="#l9.950"></a><span id="l9.950">   }</span>
<a href="#l9.951"></a><span id="l9.951"> </span>
<a href="#l9.952"></a><span id="l9.952">   return NS_OK;</span>
<a href="#l9.953"></a><span id="l9.953"> }</span>
<a href="#l9.954"></a><span id="l9.954"> </span>
<a href="#l9.955"></a><span id="l9.955"> NS_IMETHODIMP</span>
<a href="#l9.956"></a><span id="l9.956" class="difflineminus">-nsMsgThreadedDBView::OnParentChanged (nsMsgKey aKeyChanged,</span>
<a href="#l9.957"></a><span id="l9.957" class="difflineminus">-                                      nsMsgKey oldParent,</span>
<a href="#l9.958"></a><span id="l9.958" class="difflineminus">-                                      nsMsgKey newParent,</span>
<a href="#l9.959"></a><span id="l9.959" class="difflineminus">-                                      nsIDBChangeListener *aInstigator)</span>
<a href="#l9.960"></a><span id="l9.960" class="difflineminus">-{</span>
<a href="#l9.961"></a><span id="l9.961" class="difflineplus">+nsMsgThreadedDBView::OnParentChanged(nsMsgKey aKeyChanged, nsMsgKey oldParent,</span>
<a href="#l9.962"></a><span id="l9.962" class="difflineplus">+                                     nsMsgKey newParent,</span>
<a href="#l9.963"></a><span id="l9.963" class="difflineplus">+                                     nsIDBChangeListener *aInstigator) {</span>
<a href="#l9.964"></a><span id="l9.964">   // We need to adjust the level of the hdr whose parent changed, and</span>
<a href="#l9.965"></a><span id="l9.965">   // invalidate that row, iff we're in threaded mode.</span>
<a href="#l9.966"></a><span id="l9.966"> #if 0</span>
<a href="#l9.967"></a><span id="l9.967">   // This code never runs due to the if (false) and Clang complains about it</span>
<a href="#l9.968"></a><span id="l9.968">   // so it is ifdefed out for now.</span>
<a href="#l9.969"></a><span id="l9.969">   if (false &amp;&amp; m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay)</span>
<a href="#l9.970"></a><span id="l9.970">   {</span>
<a href="#l9.971"></a><span id="l9.971">     nsMsgViewIndex childIndex = FindViewIndex(aKeyChanged);</span>
<a href="#l9.972"></a><span id="l9.972" class="difflineat">@@ -858,309 +732,262 @@ nsMsgThreadedDBView::OnParentChanged (ns</span>
<a href="#l9.973"></a><span id="l9.973"> </span>
<a href="#l9.974"></a><span id="l9.974">       NoteChange(childIndex, 1, nsMsgViewNotificationCode::changed);</span>
<a href="#l9.975"></a><span id="l9.975">     }</span>
<a href="#l9.976"></a><span id="l9.976">   }</span>
<a href="#l9.977"></a><span id="l9.977"> #endif</span>
<a href="#l9.978"></a><span id="l9.978">   return NS_OK;</span>
<a href="#l9.979"></a><span id="l9.979"> }</span>
<a href="#l9.980"></a><span id="l9.980"> </span>
<a href="#l9.981"></a><span id="l9.981" class="difflineminus">-nsMsgViewIndex</span>
<a href="#l9.982"></a><span id="l9.982" class="difflineminus">-nsMsgThreadedDBView::GetInsertInfoForNewHdr(nsIMsgDBHdr *newHdr,</span>
<a href="#l9.983"></a><span id="l9.983" class="difflineminus">-                                            nsMsgViewIndex parentIndex,</span>
<a href="#l9.984"></a><span id="l9.984" class="difflineminus">-                                            int32_t targetLevel)</span>
<a href="#l9.985"></a><span id="l9.985" class="difflineminus">-{</span>
<a href="#l9.986"></a><span id="l9.986" class="difflineplus">+nsMsgViewIndex nsMsgThreadedDBView::GetInsertInfoForNewHdr(</span>
<a href="#l9.987"></a><span id="l9.987" class="difflineplus">+    nsIMsgDBHdr *newHdr, nsMsgViewIndex parentIndex, int32_t targetLevel) {</span>
<a href="#l9.988"></a><span id="l9.988">   uint32_t viewSize = GetSize();</span>
<a href="#l9.989"></a><span id="l9.989" class="difflineminus">-  while (++parentIndex &lt; viewSize)</span>
<a href="#l9.990"></a><span id="l9.990" class="difflineminus">-  {</span>
<a href="#l9.991"></a><span id="l9.991" class="difflineplus">+  while (++parentIndex &lt; viewSize) {</span>
<a href="#l9.992"></a><span id="l9.992">     // Loop until we find a message at a level less than or equal to the</span>
<a href="#l9.993"></a><span id="l9.993">     // parent level</span>
<a href="#l9.994"></a><span id="l9.994" class="difflineminus">-    if (m_levels[parentIndex] &lt; targetLevel)</span>
<a href="#l9.995"></a><span id="l9.995" class="difflineminus">-      break;</span>
<a href="#l9.996"></a><span id="l9.996" class="difflineplus">+    if (m_levels[parentIndex] &lt; targetLevel) break;</span>
<a href="#l9.997"></a><span id="l9.997">   }</span>
<a href="#l9.998"></a><span id="l9.998"> </span>
<a href="#l9.999"></a><span id="l9.999">   return parentIndex;</span>
<a href="#l9.1000"></a><span id="l9.1000"> }</span>
<a href="#l9.1001"></a><span id="l9.1001"> </span>
<a href="#l9.1002"></a><span id="l9.1002"> // This method removes the thread at threadIndex from the view</span>
<a href="#l9.1003"></a><span id="l9.1003"> // and puts it back in its new position, determined by the sort order.</span>
<a href="#l9.1004"></a><span id="l9.1004"> // And, if the selection is affected, save and restore the selection.</span>
<a href="#l9.1005"></a><span id="l9.1005" class="difflineminus">-void</span>
<a href="#l9.1006"></a><span id="l9.1006" class="difflineminus">-nsMsgThreadedDBView::MoveThreadAt(nsMsgViewIndex threadIndex)</span>
<a href="#l9.1007"></a><span id="l9.1007" class="difflineminus">-{</span>
<a href="#l9.1008"></a><span id="l9.1008" class="difflineplus">+void nsMsgThreadedDBView::MoveThreadAt(nsMsgViewIndex threadIndex) {</span>
<a href="#l9.1009"></a><span id="l9.1009">   // We need to check if the thread is collapsed or not...</span>
<a href="#l9.1010"></a><span id="l9.1010">   // We want to turn off tree notifications so that we don't</span>
<a href="#l9.1011"></a><span id="l9.1011">   // reload the current message.</span>
<a href="#l9.1012"></a><span id="l9.1012">   // We also need to invalidate the range between where the thread was</span>
<a href="#l9.1013"></a><span id="l9.1013">   // and where it ended up.</span>
<a href="#l9.1014"></a><span id="l9.1014">   bool changesDisabled = mSuppressChangeNotification;</span>
<a href="#l9.1015"></a><span id="l9.1015" class="difflineminus">-  if (!changesDisabled)</span>
<a href="#l9.1016"></a><span id="l9.1016" class="difflineminus">-    SetSuppressChangeNotifications(true);</span>
<a href="#l9.1017"></a><span id="l9.1017" class="difflineplus">+  if (!changesDisabled) SetSuppressChangeNotifications(true);</span>
<a href="#l9.1018"></a><span id="l9.1018"> </span>
<a href="#l9.1019"></a><span id="l9.1019" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDBHdr&gt; threadHdr;</span>
<a href="#l9.1020"></a><span id="l9.1020" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; threadHdr;</span>
<a href="#l9.1021"></a><span id="l9.1021"> </span>
<a href="#l9.1022"></a><span id="l9.1022">   GetMsgHdrForViewIndex(threadIndex, getter_AddRefs(threadHdr));</span>
<a href="#l9.1023"></a><span id="l9.1023">   int32_t childCount = 0;</span>
<a href="#l9.1024"></a><span id="l9.1024"> </span>
<a href="#l9.1025"></a><span id="l9.1025">   nsMsgKey preservedKey;</span>
<a href="#l9.1026"></a><span id="l9.1026">   AutoTArray&lt;nsMsgKey, 1&gt; preservedSelection;</span>
<a href="#l9.1027"></a><span id="l9.1027">   int32_t selectionCount;</span>
<a href="#l9.1028"></a><span id="l9.1028">   int32_t currentIndex;</span>
<a href="#l9.1029"></a><span id="l9.1029" class="difflineminus">-  bool hasSelection = mTree &amp;&amp; mTreeSelection &amp;&amp;</span>
<a href="#l9.1030"></a><span id="l9.1030" class="difflineminus">-                      ((NS_SUCCEEDED(mTreeSelection-&gt;GetCurrentIndex(&amp;currentIndex)) &amp;&amp;</span>
<a href="#l9.1031"></a><span id="l9.1031" class="difflineminus">-                        currentIndex &gt;= 0 &amp;&amp; (uint32_t)currentIndex &lt; GetSize()) ||</span>
<a href="#l9.1032"></a><span id="l9.1032" class="difflineminus">-                       (NS_SUCCEEDED(mTreeSelection-&gt;GetRangeCount(&amp;selectionCount)) &amp;&amp;</span>
<a href="#l9.1033"></a><span id="l9.1033" class="difflineminus">-                        selectionCount &gt; 0));</span>
<a href="#l9.1034"></a><span id="l9.1034" class="difflineminus">-  if (hasSelection)</span>
<a href="#l9.1035"></a><span id="l9.1035" class="difflineminus">-    SaveAndClearSelection(&amp;preservedKey, preservedSelection);</span>
<a href="#l9.1036"></a><span id="l9.1036" class="difflineplus">+  bool hasSelection =</span>
<a href="#l9.1037"></a><span id="l9.1037" class="difflineplus">+      mTree &amp;&amp; mTreeSelection &amp;&amp;</span>
<a href="#l9.1038"></a><span id="l9.1038" class="difflineplus">+      ((NS_SUCCEEDED(mTreeSelection-&gt;GetCurrentIndex(&amp;currentIndex)) &amp;&amp;</span>
<a href="#l9.1039"></a><span id="l9.1039" class="difflineplus">+        currentIndex &gt;= 0 &amp;&amp; (uint32_t)currentIndex &lt; GetSize()) ||</span>
<a href="#l9.1040"></a><span id="l9.1040" class="difflineplus">+       (NS_SUCCEEDED(mTreeSelection-&gt;GetRangeCount(&amp;selectionCount)) &amp;&amp;</span>
<a href="#l9.1041"></a><span id="l9.1041" class="difflineplus">+        selectionCount &gt; 0));</span>
<a href="#l9.1042"></a><span id="l9.1042" class="difflineplus">+  if (hasSelection) SaveAndClearSelection(&amp;preservedKey, preservedSelection);</span>
<a href="#l9.1043"></a><span id="l9.1043"> </span>
<a href="#l9.1044"></a><span id="l9.1044">   uint32_t saveFlags = m_flags[threadIndex];</span>
<a href="#l9.1045"></a><span id="l9.1045">   bool threadIsExpanded = !(saveFlags &amp; nsMsgMessageFlags::Elided);</span>
<a href="#l9.1046"></a><span id="l9.1046"> </span>
<a href="#l9.1047"></a><span id="l9.1047" class="difflineminus">-  if (threadIsExpanded)</span>
<a href="#l9.1048"></a><span id="l9.1048" class="difflineminus">-  {</span>
<a href="#l9.1049"></a><span id="l9.1049" class="difflineplus">+  if (threadIsExpanded) {</span>
<a href="#l9.1050"></a><span id="l9.1050">     ExpansionDelta(threadIndex, &amp;childCount);</span>
<a href="#l9.1051"></a><span id="l9.1051">     childCount = -childCount;</span>
<a href="#l9.1052"></a><span id="l9.1052">   }</span>
<a href="#l9.1053"></a><span id="l9.1053"> </span>
<a href="#l9.1054"></a><span id="l9.1054">   nsTArray&lt;nsMsgKey&gt; threadKeys;</span>
<a href="#l9.1055"></a><span id="l9.1055">   nsTArray&lt;uint32_t&gt; threadFlags;</span>
<a href="#l9.1056"></a><span id="l9.1056">   nsTArray&lt;uint8_t&gt; threadLevels;</span>
<a href="#l9.1057"></a><span id="l9.1057"> </span>
<a href="#l9.1058"></a><span id="l9.1058" class="difflineminus">-  if (threadIsExpanded)</span>
<a href="#l9.1059"></a><span id="l9.1059" class="difflineminus">-  {</span>
<a href="#l9.1060"></a><span id="l9.1060" class="difflineplus">+  if (threadIsExpanded) {</span>
<a href="#l9.1061"></a><span id="l9.1061">     threadKeys.SetCapacity(childCount);</span>
<a href="#l9.1062"></a><span id="l9.1062">     threadFlags.SetCapacity(childCount);</span>
<a href="#l9.1063"></a><span id="l9.1063">     threadLevels.SetCapacity(childCount);</span>
<a href="#l9.1064"></a><span id="l9.1064">     for (nsMsgViewIndex index = threadIndex + 1;</span>
<a href="#l9.1065"></a><span id="l9.1065" class="difflineminus">-         index &lt; GetSize() &amp;&amp; m_levels[index];</span>
<a href="#l9.1066"></a><span id="l9.1066" class="difflineminus">-         index++)</span>
<a href="#l9.1067"></a><span id="l9.1067" class="difflineminus">-    {</span>
<a href="#l9.1068"></a><span id="l9.1068" class="difflineplus">+         index &lt; GetSize() &amp;&amp; m_levels[index]; index++) {</span>
<a href="#l9.1069"></a><span id="l9.1069">       threadKeys.AppendElement(m_keys[index]);</span>
<a href="#l9.1070"></a><span id="l9.1070">       threadFlags.AppendElement(m_flags[index]);</span>
<a href="#l9.1071"></a><span id="l9.1071">       threadLevels.AppendElement(m_levels[index]);</span>
<a href="#l9.1072"></a><span id="l9.1072">     }</span>
<a href="#l9.1073"></a><span id="l9.1073"> </span>
<a href="#l9.1074"></a><span id="l9.1074">     uint32_t collapseCount;</span>
<a href="#l9.1075"></a><span id="l9.1075">     CollapseByIndex(threadIndex, &amp;collapseCount);</span>
<a href="#l9.1076"></a><span id="l9.1076">   }</span>
<a href="#l9.1077"></a><span id="l9.1077"> </span>
<a href="#l9.1078"></a><span id="l9.1078">   nsMsgDBView::RemoveByIndex(threadIndex);</span>
<a href="#l9.1079"></a><span id="l9.1079">   nsMsgViewIndex newIndex = nsMsgViewIndex_None;</span>
<a href="#l9.1080"></a><span id="l9.1080">   AddHdr(threadHdr, &amp;newIndex);</span>
<a href="#l9.1081"></a><span id="l9.1081"> </span>
<a href="#l9.1082"></a><span id="l9.1082">   // AddHdr doesn't always set newIndex, and getting it to do so</span>
<a href="#l9.1083"></a><span id="l9.1083">   // is going to require some refactoring.</span>
<a href="#l9.1084"></a><span id="l9.1084" class="difflineminus">-  if (newIndex == nsMsgViewIndex_None)</span>
<a href="#l9.1085"></a><span id="l9.1085" class="difflineminus">-    newIndex = FindHdr(threadHdr);</span>
<a href="#l9.1086"></a><span id="l9.1086" class="difflineplus">+  if (newIndex == nsMsgViewIndex_None) newIndex = FindHdr(threadHdr);</span>
<a href="#l9.1087"></a><span id="l9.1087"> </span>
<a href="#l9.1088"></a><span id="l9.1088" class="difflineminus">-  if (threadIsExpanded)</span>
<a href="#l9.1089"></a><span id="l9.1089" class="difflineminus">-  {</span>
<a href="#l9.1090"></a><span id="l9.1090" class="difflineplus">+  if (threadIsExpanded) {</span>
<a href="#l9.1091"></a><span id="l9.1091">     m_keys.InsertElementsAt(newIndex + 1, threadKeys);</span>
<a href="#l9.1092"></a><span id="l9.1092">     m_flags.InsertElementsAt(newIndex + 1, threadFlags);</span>
<a href="#l9.1093"></a><span id="l9.1093">     m_levels.InsertElementsAt(newIndex + 1, threadLevels);</span>
<a href="#l9.1094"></a><span id="l9.1094">   }</span>
<a href="#l9.1095"></a><span id="l9.1095"> </span>
<a href="#l9.1096"></a><span id="l9.1096" class="difflineminus">-  if (newIndex == nsMsgViewIndex_None)</span>
<a href="#l9.1097"></a><span id="l9.1097" class="difflineminus">-  {</span>
<a href="#l9.1098"></a><span id="l9.1098" class="difflineminus">-     NS_WARNING(&quot;newIndex=-1 in MoveThreadAt&quot;);</span>
<a href="#l9.1099"></a><span id="l9.1099" class="difflineminus">-     newIndex = 0;</span>
<a href="#l9.1100"></a><span id="l9.1100" class="difflineplus">+  if (newIndex == nsMsgViewIndex_None) {</span>
<a href="#l9.1101"></a><span id="l9.1101" class="difflineplus">+    NS_WARNING(&quot;newIndex=-1 in MoveThreadAt&quot;);</span>
<a href="#l9.1102"></a><span id="l9.1102" class="difflineplus">+    newIndex = 0;</span>
<a href="#l9.1103"></a><span id="l9.1103">   }</span>
<a href="#l9.1104"></a><span id="l9.1104"> </span>
<a href="#l9.1105"></a><span id="l9.1105">   m_flags[newIndex] = saveFlags;</span>
<a href="#l9.1106"></a><span id="l9.1106">   // Unfreeze selection.</span>
<a href="#l9.1107"></a><span id="l9.1107" class="difflineminus">-  if (hasSelection)</span>
<a href="#l9.1108"></a><span id="l9.1108" class="difflineminus">-    RestoreSelection(preservedKey, preservedSelection);</span>
<a href="#l9.1109"></a><span id="l9.1109" class="difflineplus">+  if (hasSelection) RestoreSelection(preservedKey, preservedSelection);</span>
<a href="#l9.1110"></a><span id="l9.1110"> </span>
<a href="#l9.1111"></a><span id="l9.1111" class="difflineminus">-  if (!changesDisabled)</span>
<a href="#l9.1112"></a><span id="l9.1112" class="difflineminus">-    SetSuppressChangeNotifications(false);</span>
<a href="#l9.1113"></a><span id="l9.1113" class="difflineplus">+  if (!changesDisabled) SetSuppressChangeNotifications(false);</span>
<a href="#l9.1114"></a><span id="l9.1114"> </span>
<a href="#l9.1115"></a><span id="l9.1115">   nsMsgViewIndex lowIndex = threadIndex &lt; newIndex ? threadIndex : newIndex;</span>
<a href="#l9.1116"></a><span id="l9.1116">   nsMsgViewIndex highIndex = lowIndex == threadIndex ? newIndex : threadIndex;</span>
<a href="#l9.1117"></a><span id="l9.1117"> </span>
<a href="#l9.1118"></a><span id="l9.1118">   NoteChange(lowIndex, highIndex - lowIndex + childCount + 1,</span>
<a href="#l9.1119"></a><span id="l9.1119">              nsMsgViewNotificationCode::changed);</span>
<a href="#l9.1120"></a><span id="l9.1120"> }</span>
<a href="#l9.1121"></a><span id="l9.1121"> </span>
<a href="#l9.1122"></a><span id="l9.1122" class="difflineminus">-nsresult</span>
<a href="#l9.1123"></a><span id="l9.1123" class="difflineminus">-nsMsgThreadedDBView::AddMsgToThreadNotInView(nsIMsgThread *threadHdr,</span>
<a href="#l9.1124"></a><span id="l9.1124" class="difflineminus">-                                             nsIMsgDBHdr *msgHdr,</span>
<a href="#l9.1125"></a><span id="l9.1125" class="difflineminus">-                                             bool ensureListed)</span>
<a href="#l9.1126"></a><span id="l9.1126" class="difflineminus">-{</span>
<a href="#l9.1127"></a><span id="l9.1127" class="difflineplus">+nsresult nsMsgThreadedDBView::AddMsgToThreadNotInView(nsIMsgThread *threadHdr,</span>
<a href="#l9.1128"></a><span id="l9.1128" class="difflineplus">+                                                      nsIMsgDBHdr *msgHdr,</span>
<a href="#l9.1129"></a><span id="l9.1129" class="difflineplus">+                                                      bool ensureListed) {</span>
<a href="#l9.1130"></a><span id="l9.1130">   nsresult rv = NS_OK;</span>
<a href="#l9.1131"></a><span id="l9.1131">   uint32_t threadFlags;</span>
<a href="#l9.1132"></a><span id="l9.1132">   threadHdr-&gt;GetFlags(&amp;threadFlags);</span>
<a href="#l9.1133"></a><span id="l9.1133" class="difflineminus">-  if (!(threadFlags &amp; nsMsgMessageFlags::Ignored))</span>
<a href="#l9.1134"></a><span id="l9.1134" class="difflineminus">-  {</span>
<a href="#l9.1135"></a><span id="l9.1135" class="difflineplus">+  if (!(threadFlags &amp; nsMsgMessageFlags::Ignored)) {</span>
<a href="#l9.1136"></a><span id="l9.1136">     bool msgKilled;</span>
<a href="#l9.1137"></a><span id="l9.1137">     msgHdr-&gt;GetIsKilled(&amp;msgKilled);</span>
<a href="#l9.1138"></a><span id="l9.1138" class="difflineminus">-    if (!msgKilled)</span>
<a href="#l9.1139"></a><span id="l9.1139" class="difflineminus">-      rv = nsMsgDBView::AddHdr(msgHdr);</span>
<a href="#l9.1140"></a><span id="l9.1140" class="difflineplus">+    if (!msgKilled) rv = nsMsgDBView::AddHdr(msgHdr);</span>
<a href="#l9.1141"></a><span id="l9.1141">   }</span>
<a href="#l9.1142"></a><span id="l9.1142"> </span>
<a href="#l9.1143"></a><span id="l9.1143">   return rv;</span>
<a href="#l9.1144"></a><span id="l9.1144"> }</span>
<a href="#l9.1145"></a><span id="l9.1145"> </span>
<a href="#l9.1146"></a><span id="l9.1146"> // This method just removes the specified line from the view. It does</span>
<a href="#l9.1147"></a><span id="l9.1147"> // NOT delete it from the database.</span>
<a href="#l9.1148"></a><span id="l9.1148" class="difflineminus">-nsresult</span>
<a href="#l9.1149"></a><span id="l9.1149" class="difflineminus">-nsMsgThreadedDBView::RemoveByIndex(nsMsgViewIndex index)</span>
<a href="#l9.1150"></a><span id="l9.1150" class="difflineminus">-{</span>
<a href="#l9.1151"></a><span id="l9.1151" class="difflineplus">+nsresult nsMsgThreadedDBView::RemoveByIndex(nsMsgViewIndex index) {</span>
<a href="#l9.1152"></a><span id="l9.1152">   nsresult rv = NS_OK;</span>
<a href="#l9.1153"></a><span id="l9.1153">   int32_t flags;</span>
<a href="#l9.1154"></a><span id="l9.1154"> </span>
<a href="#l9.1155"></a><span id="l9.1155" class="difflineminus">-  if (!IsValidIndex(index))</span>
<a href="#l9.1156"></a><span id="l9.1156" class="difflineminus">-    return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l9.1157"></a><span id="l9.1157" class="difflineplus">+  if (!IsValidIndex(index)) return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l9.1158"></a><span id="l9.1158"> </span>
<a href="#l9.1159"></a><span id="l9.1159">   OnHeaderAddedOrDeleted();</span>
<a href="#l9.1160"></a><span id="l9.1160"> </span>
<a href="#l9.1161"></a><span id="l9.1161">   flags = m_flags[index];</span>
<a href="#l9.1162"></a><span id="l9.1162"> </span>
<a href="#l9.1163"></a><span id="l9.1163">   if (!(m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay))</span>
<a href="#l9.1164"></a><span id="l9.1164">     return nsMsgDBView::RemoveByIndex(index);</span>
<a href="#l9.1165"></a><span id="l9.1165"> </span>
<a href="#l9.1166"></a><span id="l9.1166">   nsCOMPtr&lt;nsIMsgThread&gt; threadHdr;</span>
<a href="#l9.1167"></a><span id="l9.1167">   GetThreadContainingIndex(index, getter_AddRefs(threadHdr));</span>
<a href="#l9.1168"></a><span id="l9.1168">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.1169"></a><span id="l9.1169">   uint32_t numThreadChildren = 0;</span>
<a href="#l9.1170"></a><span id="l9.1170">   // If we can't get a thread, it's already deleted and thus has 0 children.</span>
<a href="#l9.1171"></a><span id="l9.1171" class="difflineminus">-  if (threadHdr)</span>
<a href="#l9.1172"></a><span id="l9.1172" class="difflineminus">-    threadHdr-&gt;GetNumChildren(&amp;numThreadChildren);</span>
<a href="#l9.1173"></a><span id="l9.1173" class="difflineplus">+  if (threadHdr) threadHdr-&gt;GetNumChildren(&amp;numThreadChildren);</span>
<a href="#l9.1174"></a><span id="l9.1174"> </span>
<a href="#l9.1175"></a><span id="l9.1175">   // Check if we're the top level msg in the thread, and we're not collapsed.</span>
<a href="#l9.1176"></a><span id="l9.1176">   if ((flags &amp; MSG_VIEW_FLAG_ISTHREAD) &amp;&amp;</span>
<a href="#l9.1177"></a><span id="l9.1177">       !(flags &amp; nsMsgMessageFlags::Elided) &amp;&amp;</span>
<a href="#l9.1178"></a><span id="l9.1178" class="difflineminus">-      (flags &amp; MSG_VIEW_FLAG_HASCHILDREN))</span>
<a href="#l9.1179"></a><span id="l9.1179" class="difflineminus">-  {</span>
<a href="#l9.1180"></a><span id="l9.1180" class="difflineplus">+      (flags &amp; MSG_VIEW_FLAG_HASCHILDREN)) {</span>
<a href="#l9.1181"></a><span id="l9.1181">     // Fix flags on thread header - newly promoted message should have</span>
<a href="#l9.1182"></a><span id="l9.1182">     // flags set correctly.</span>
<a href="#l9.1183"></a><span id="l9.1183" class="difflineminus">-    if (threadHdr)</span>
<a href="#l9.1184"></a><span id="l9.1184" class="difflineminus">-    {</span>
<a href="#l9.1185"></a><span id="l9.1185" class="difflineplus">+    if (threadHdr) {</span>
<a href="#l9.1186"></a><span id="l9.1186">       nsMsgDBView::RemoveByIndex(index);</span>
<a href="#l9.1187"></a><span id="l9.1187">       nsCOMPtr&lt;nsIMsgThread&gt; nextThreadHdr;</span>
<a href="#l9.1188"></a><span id="l9.1188">       // Above RemoveByIndex may now make index out of bounds.</span>
<a href="#l9.1189"></a><span id="l9.1189" class="difflineminus">-      if (IsValidIndex(index) &amp;&amp; numThreadChildren &gt; 0)</span>
<a href="#l9.1190"></a><span id="l9.1190" class="difflineminus">-      {</span>
<a href="#l9.1191"></a><span id="l9.1191" class="difflineplus">+      if (IsValidIndex(index) &amp;&amp; numThreadChildren &gt; 0) {</span>
<a href="#l9.1192"></a><span id="l9.1192">         // unreadOnly</span>
<a href="#l9.1193"></a><span id="l9.1193">         nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l9.1194"></a><span id="l9.1194">         rv = threadHdr-&gt;GetChildHdrAt(0, getter_AddRefs(msgHdr));</span>
<a href="#l9.1195"></a><span id="l9.1195" class="difflineminus">-        if (msgHdr != nullptr)</span>
<a href="#l9.1196"></a><span id="l9.1196" class="difflineminus">-        {</span>
<a href="#l9.1197"></a><span id="l9.1197" class="difflineplus">+        if (msgHdr != nullptr) {</span>
<a href="#l9.1198"></a><span id="l9.1198">           uint32_t flag = 0;</span>
<a href="#l9.1199"></a><span id="l9.1199">           msgHdr-&gt;GetFlags(&amp;flag);</span>
<a href="#l9.1200"></a><span id="l9.1200">           if (numThreadChildren &gt; 1)</span>
<a href="#l9.1201"></a><span id="l9.1201">             flag |= MSG_VIEW_FLAG_ISTHREAD | MSG_VIEW_FLAG_HASCHILDREN;</span>
<a href="#l9.1202"></a><span id="l9.1202"> </span>
<a href="#l9.1203"></a><span id="l9.1203">           m_flags[index] = flag;</span>
<a href="#l9.1204"></a><span id="l9.1204">           m_levels[index] = 0;</span>
<a href="#l9.1205"></a><span id="l9.1205">         }</span>
<a href="#l9.1206"></a><span id="l9.1206">       }</span>
<a href="#l9.1207"></a><span id="l9.1207">     }</span>
<a href="#l9.1208"></a><span id="l9.1208"> </span>
<a href="#l9.1209"></a><span id="l9.1209">     return rv;</span>
<a href="#l9.1210"></a><span id="l9.1210" class="difflineminus">-  }</span>
<a href="#l9.1211"></a><span id="l9.1211" class="difflineminus">-  else if (!(flags &amp; MSG_VIEW_FLAG_ISTHREAD))</span>
<a href="#l9.1212"></a><span id="l9.1212" class="difflineminus">-  {</span>
<a href="#l9.1213"></a><span id="l9.1213" class="difflineplus">+  } else if (!(flags &amp; MSG_VIEW_FLAG_ISTHREAD)) {</span>
<a href="#l9.1214"></a><span id="l9.1214">     // We're not deleting the top level msg, but top level msg might be the</span>
<a href="#l9.1215"></a><span id="l9.1215">     // only msg in thread now.</span>
<a href="#l9.1216"></a><span id="l9.1216" class="difflineminus">-    if (threadHdr &amp;&amp; numThreadChildren == 1)</span>
<a href="#l9.1217"></a><span id="l9.1217" class="difflineminus">-    {</span>
<a href="#l9.1218"></a><span id="l9.1218" class="difflineplus">+    if (threadHdr &amp;&amp; numThreadChildren == 1) {</span>
<a href="#l9.1219"></a><span id="l9.1219">       nsMsgKey msgKey;</span>
<a href="#l9.1220"></a><span id="l9.1220">       rv = threadHdr-&gt;GetChildKeyAt(0, &amp;msgKey);</span>
<a href="#l9.1221"></a><span id="l9.1221" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l9.1222"></a><span id="l9.1222" class="difflineminus">-      {</span>
<a href="#l9.1223"></a><span id="l9.1223" class="difflineplus">+      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l9.1224"></a><span id="l9.1224">         nsMsgViewIndex threadIndex = FindViewIndex(msgKey);</span>
<a href="#l9.1225"></a><span id="l9.1225" class="difflineminus">-        if (IsValidIndex(threadIndex))</span>
<a href="#l9.1226"></a><span id="l9.1226" class="difflineminus">-        {</span>
<a href="#l9.1227"></a><span id="l9.1227" class="difflineplus">+        if (IsValidIndex(threadIndex)) {</span>
<a href="#l9.1228"></a><span id="l9.1228">           uint32_t flags = m_flags[threadIndex];</span>
<a href="#l9.1229"></a><span id="l9.1229" class="difflineminus">-          flags &amp;= ~(MSG_VIEW_FLAG_ISTHREAD |</span>
<a href="#l9.1230"></a><span id="l9.1230" class="difflineminus">-                     nsMsgMessageFlags::Elided |</span>
<a href="#l9.1231"></a><span id="l9.1231" class="difflineplus">+          flags &amp;= ~(MSG_VIEW_FLAG_ISTHREAD | nsMsgMessageFlags::Elided |</span>
<a href="#l9.1232"></a><span id="l9.1232">                      MSG_VIEW_FLAG_HASCHILDREN);</span>
<a href="#l9.1233"></a><span id="l9.1233">           m_flags[threadIndex] = flags;</span>
<a href="#l9.1234"></a><span id="l9.1234">           NoteChange(threadIndex, 1, nsMsgViewNotificationCode::changed);</span>
<a href="#l9.1235"></a><span id="l9.1235">         }</span>
<a href="#l9.1236"></a><span id="l9.1236">       }</span>
<a href="#l9.1237"></a><span id="l9.1237" class="difflineminus">-</span>
<a href="#l9.1238"></a><span id="l9.1238">     }</span>
<a href="#l9.1239"></a><span id="l9.1239"> </span>
<a href="#l9.1240"></a><span id="l9.1240">     return nsMsgDBView::RemoveByIndex(index);</span>
<a href="#l9.1241"></a><span id="l9.1241">   }</span>
<a href="#l9.1242"></a><span id="l9.1242"> </span>
<a href="#l9.1243"></a><span id="l9.1243">   // Deleting collapsed thread header is special case. Child will be promoted,</span>
<a href="#l9.1244"></a><span id="l9.1244">   // so just tell FE that line changed, not that it was deleted.</span>
<a href="#l9.1245"></a><span id="l9.1245">   // Header has already been deleted from thread.</span>
<a href="#l9.1246"></a><span id="l9.1246" class="difflineminus">-  if (threadHdr &amp;&amp; numThreadChildren &gt; 0)</span>
<a href="#l9.1247"></a><span id="l9.1247" class="difflineminus">-  {</span>
<a href="#l9.1248"></a><span id="l9.1248" class="difflineplus">+  if (threadHdr &amp;&amp; numThreadChildren &gt; 0) {</span>
<a href="#l9.1249"></a><span id="l9.1249">     // Change the id array and flags array to reflect the child header.</span>
<a href="#l9.1250"></a><span id="l9.1250">     // If we're not deleting the header, we want the second header,</span>
<a href="#l9.1251"></a><span id="l9.1251">     // Otherwise, the first one (which just got promoted).</span>
<a href="#l9.1252"></a><span id="l9.1252">     nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l9.1253"></a><span id="l9.1253">     rv = threadHdr-&gt;GetChildHdrAt(0, getter_AddRefs(msgHdr));</span>
<a href="#l9.1254"></a><span id="l9.1254" class="difflineminus">-    if (msgHdr != nullptr)</span>
<a href="#l9.1255"></a><span id="l9.1255" class="difflineminus">-    {</span>
<a href="#l9.1256"></a><span id="l9.1256" class="difflineplus">+    if (msgHdr != nullptr) {</span>
<a href="#l9.1257"></a><span id="l9.1257">       msgHdr-&gt;GetMessageKey(&amp;m_keys[index]);</span>
<a href="#l9.1258"></a><span id="l9.1258">       uint32_t flag = 0;</span>
<a href="#l9.1259"></a><span id="l9.1259">       msgHdr-&gt;GetFlags(&amp;flag);</span>
<a href="#l9.1260"></a><span id="l9.1260">       flag |= MSG_VIEW_FLAG_ISTHREAD;</span>
<a href="#l9.1261"></a><span id="l9.1261"> </span>
<a href="#l9.1262"></a><span id="l9.1262">       // If only hdr in thread (with one about to be deleted).</span>
<a href="#l9.1263"></a><span id="l9.1263" class="difflineminus">-      if (numThreadChildren == 1)</span>
<a href="#l9.1264"></a><span id="l9.1264" class="difflineminus">-      {</span>
<a href="#l9.1265"></a><span id="l9.1265" class="difflineplus">+      if (numThreadChildren == 1) {</span>
<a href="#l9.1266"></a><span id="l9.1266">         // Adjust flags.</span>
<a href="#l9.1267"></a><span id="l9.1267" class="difflineminus">-        flag &amp;=  ~MSG_VIEW_FLAG_HASCHILDREN;</span>
<a href="#l9.1268"></a><span id="l9.1268" class="difflineplus">+        flag &amp;= ~MSG_VIEW_FLAG_HASCHILDREN;</span>
<a href="#l9.1269"></a><span id="l9.1269">         flag &amp;= ~nsMsgMessageFlags::Elided;</span>
<a href="#l9.1270"></a><span id="l9.1270">         // Tell FE that thread header needs to be repainted.</span>
<a href="#l9.1271"></a><span id="l9.1271">         NoteChange(index, 1, nsMsgViewNotificationCode::changed);</span>
<a href="#l9.1272"></a><span id="l9.1272" class="difflineminus">-      }</span>
<a href="#l9.1273"></a><span id="l9.1273" class="difflineminus">-      else</span>
<a href="#l9.1274"></a><span id="l9.1274" class="difflineminus">-      {</span>
<a href="#l9.1275"></a><span id="l9.1275" class="difflineplus">+      } else {</span>
<a href="#l9.1276"></a><span id="l9.1276">         flag |= MSG_VIEW_FLAG_HASCHILDREN;</span>
<a href="#l9.1277"></a><span id="l9.1277">         flag |= nsMsgMessageFlags::Elided;</span>
<a href="#l9.1278"></a><span id="l9.1278">       }</span>
<a href="#l9.1279"></a><span id="l9.1279"> </span>
<a href="#l9.1280"></a><span id="l9.1280">       m_flags[index] = flag;</span>
<a href="#l9.1281"></a><span id="l9.1281">       mIndicesToNoteChange.RemoveElement(index);</span>
<a href="#l9.1282"></a><span id="l9.1282" class="difflineminus">-    }</span>
<a href="#l9.1283"></a><span id="l9.1283" class="difflineminus">-    else</span>
<a href="#l9.1284"></a><span id="l9.1284" class="difflineminus">-    {</span>
<a href="#l9.1285"></a><span id="l9.1285" class="difflineplus">+    } else {</span>
<a href="#l9.1286"></a><span id="l9.1286">       NS_ASSERTION(false, &quot;couldn't find thread child&quot;);</span>
<a href="#l9.1287"></a><span id="l9.1287">     }</span>
<a href="#l9.1288"></a><span id="l9.1288"> </span>
<a href="#l9.1289"></a><span id="l9.1289">     NoteChange(index, 1, nsMsgViewNotificationCode::changed);</span>
<a href="#l9.1290"></a><span id="l9.1290" class="difflineminus">-  }</span>
<a href="#l9.1291"></a><span id="l9.1291" class="difflineminus">-  else</span>
<a href="#l9.1292"></a><span id="l9.1292" class="difflineminus">-  {</span>
<a href="#l9.1293"></a><span id="l9.1293" class="difflineplus">+  } else {</span>
<a href="#l9.1294"></a><span id="l9.1294">     // We may have deleted a whole, collapsed thread - if so,</span>
<a href="#l9.1295"></a><span id="l9.1295">     // ensure that the current index will be noted as changed.</span>
<a href="#l9.1296"></a><span id="l9.1296">     if (!mIndicesToNoteChange.Contains(index))</span>
<a href="#l9.1297"></a><span id="l9.1297">       mIndicesToNoteChange.AppendElement(index);</span>
<a href="#l9.1298"></a><span id="l9.1298"> </span>
<a href="#l9.1299"></a><span id="l9.1299">     rv = nsMsgDBView::RemoveByIndex(index);</span>
<a href="#l9.1300"></a><span id="l9.1300">   }</span>
<a href="#l9.1301"></a><span id="l9.1301"> </span>
<a href="#l9.1302"></a><span id="l9.1302">   return rv;</span>
<a href="#l9.1303"></a><span id="l9.1303"> }</span>
<a href="#l9.1304"></a><span id="l9.1304"> </span>
<a href="#l9.1305"></a><span id="l9.1305"> NS_IMETHODIMP</span>
<a href="#l9.1306"></a><span id="l9.1306" class="difflineminus">-nsMsgThreadedDBView::GetViewType(nsMsgViewTypeValue *aViewType)</span>
<a href="#l9.1307"></a><span id="l9.1307" class="difflineminus">-{</span>
<a href="#l9.1308"></a><span id="l9.1308" class="difflineplus">+nsMsgThreadedDBView::GetViewType(nsMsgViewTypeValue *aViewType) {</span>
<a href="#l9.1309"></a><span id="l9.1309">   NS_ENSURE_ARG_POINTER(aViewType);</span>
<a href="#l9.1310"></a><span id="l9.1310">   *aViewType = nsMsgViewType::eShowAllThreads;</span>
<a href="#l9.1311"></a><span id="l9.1311">   return NS_OK;</span>
<a href="#l9.1312"></a><span id="l9.1312"> }</span>
<a href="#l9.1313"></a><span id="l9.1313"> </span>
<a href="#l9.1314"></a><span id="l9.1314"> NS_IMETHODIMP</span>
<a href="#l9.1315"></a><span id="l9.1315"> nsMsgThreadedDBView::CloneDBView(nsIMessenger *aMessengerInstance,</span>
<a href="#l9.1316"></a><span id="l9.1316">                                  nsIMsgWindow *aMsgWindow,</span>
<a href="#l9.1317"></a><span id="l9.1317">                                  nsIMsgDBViewCommandUpdater *aCmdUpdater,</span>
<a href="#l9.1318"></a><span id="l9.1318" class="difflineminus">-                                 nsIMsgDBView **_retval)</span>
<a href="#l9.1319"></a><span id="l9.1319" class="difflineminus">-{</span>
<a href="#l9.1320"></a><span id="l9.1320" class="difflineminus">-  nsMsgThreadedDBView* newMsgDBView = new nsMsgThreadedDBView();</span>
<a href="#l9.1321"></a><span id="l9.1321" class="difflineplus">+                                 nsIMsgDBView **_retval) {</span>
<a href="#l9.1322"></a><span id="l9.1322" class="difflineplus">+  nsMsgThreadedDBView *newMsgDBView = new nsMsgThreadedDBView();</span>
<a href="#l9.1323"></a><span id="l9.1323"> </span>
<a href="#l9.1324"></a><span id="l9.1324" class="difflineminus">-  if (!newMsgDBView)</span>
<a href="#l9.1325"></a><span id="l9.1325" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l9.1326"></a><span id="l9.1326" class="difflineplus">+  if (!newMsgDBView) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l9.1327"></a><span id="l9.1327"> </span>
<a href="#l9.1328"></a><span id="l9.1328" class="difflineminus">-  nsresult rv = CopyDBView(newMsgDBView, aMessengerInstance, aMsgWindow, aCmdUpdater);</span>
<a href="#l9.1329"></a><span id="l9.1329" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l9.1330"></a><span id="l9.1330" class="difflineplus">+  nsresult rv =</span>
<a href="#l9.1331"></a><span id="l9.1331" class="difflineplus">+      CopyDBView(newMsgDBView, aMessengerInstance, aMsgWindow, aCmdUpdater);</span>
<a href="#l9.1332"></a><span id="l9.1332" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.1333"></a><span id="l9.1333"> </span>
<a href="#l9.1334"></a><span id="l9.1334">   NS_IF_ADDREF(*_retval = newMsgDBView);</span>
<a href="#l9.1335"></a><span id="l9.1335">   return NS_OK;</span>
<a href="#l9.1336"></a><span id="l9.1336"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/base/src/nsMsgThreadedDBView.h</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgThreadedDBView.h</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -4,48 +4,65 @@</span>
<a href="#l10.4"></a><span id="l10.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l10.5"></a><span id="l10.5"> </span>
<a href="#l10.6"></a><span id="l10.6"> #ifndef _nsMsgThreadedDBView_H_</span>
<a href="#l10.7"></a><span id="l10.7"> #define _nsMsgThreadedDBView_H_</span>
<a href="#l10.8"></a><span id="l10.8"> </span>
<a href="#l10.9"></a><span id="l10.9"> #include &quot;mozilla/Attributes.h&quot;</span>
<a href="#l10.10"></a><span id="l10.10"> #include &quot;nsMsgGroupView.h&quot;</span>
<a href="#l10.11"></a><span id="l10.11"> </span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-class nsMsgThreadedDBView : public nsMsgGroupView</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-{</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineminus">-public:</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+class nsMsgThreadedDBView : public nsMsgGroupView {</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+ public:</span>
<a href="#l10.17"></a><span id="l10.17">   nsMsgThreadedDBView();</span>
<a href="#l10.18"></a><span id="l10.18">   virtual ~nsMsgThreadedDBView();</span>
<a href="#l10.19"></a><span id="l10.19"> </span>
<a href="#l10.20"></a><span id="l10.20" class="difflineminus">-  NS_IMETHOD Open(nsIMsgFolder *folder, nsMsgViewSortTypeValue sortType, nsMsgViewSortOrderValue sortOrder, nsMsgViewFlagsTypeValue viewFlags, int32_t *pCount) override;</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineminus">-  NS_IMETHOD CloneDBView(nsIMessenger *aMessengerInstance, nsIMsgWindow *aMsgWindow, nsIMsgDBViewCommandUpdater *aCommandUpdater, nsIMsgDBView **_retval) override;</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineplus">+  NS_IMETHOD Open(nsIMsgFolder *folder, nsMsgViewSortTypeValue sortType,</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineplus">+                  nsMsgViewSortOrderValue sortOrder,</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineplus">+                  nsMsgViewFlagsTypeValue viewFlags, int32_t *pCount) override;</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineplus">+  NS_IMETHOD CloneDBView(nsIMessenger *aMessengerInstance,</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineplus">+                         nsIMsgWindow *aMsgWindow,</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineplus">+                         nsIMsgDBViewCommandUpdater *aCommandUpdater,</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineplus">+                         nsIMsgDBView **_retval) override;</span>
<a href="#l10.29"></a><span id="l10.29">   NS_IMETHOD Close() override;</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineminus">-  int32_t AddKeys(nsMsgKey *pKeys, int32_t *pFlags, const char *pLevels, nsMsgViewSortTypeValue sortType, int32_t numKeysToAdd);</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineminus">-  NS_IMETHOD Sort(nsMsgViewSortTypeValue sortType, nsMsgViewSortOrderValue sortOrder) override;</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineplus">+  int32_t AddKeys(nsMsgKey *pKeys, int32_t *pFlags, const char *pLevels,</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineplus">+                  nsMsgViewSortTypeValue sortType, int32_t numKeysToAdd);</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineplus">+  NS_IMETHOD Sort(nsMsgViewSortTypeValue sortType,</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineplus">+                  nsMsgViewSortOrderValue sortOrder) override;</span>
<a href="#l10.36"></a><span id="l10.36">   NS_IMETHOD GetViewType(nsMsgViewTypeValue *aViewType) override;</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineminus">-  NS_IMETHOD OnParentChanged (nsMsgKey aKeyChanged, nsMsgKey oldParent, nsMsgKey newParent, nsIDBChangeListener *aInstigator) override;</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineplus">+  NS_IMETHOD OnParentChanged(nsMsgKey aKeyChanged, nsMsgKey oldParent,</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineplus">+                             nsMsgKey newParent,</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineplus">+                             nsIDBChangeListener *aInstigator) override;</span>
<a href="#l10.41"></a><span id="l10.41"> </span>
<a href="#l10.42"></a><span id="l10.42" class="difflineminus">-protected:</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineplus">+ protected:</span>
<a href="#l10.44"></a><span id="l10.44">   virtual const char *GetViewName(void) override { return &quot;ThreadedDBView&quot;; }</span>
<a href="#l10.45"></a><span id="l10.45">   nsresult InitThreadedView(int32_t *pCount);</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineminus">-  virtual nsresult OnNewHeader(nsIMsgDBHdr *newHdr, nsMsgKey aParentKey, bool ensureListed) override;</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineminus">-  virtual nsresult AddMsgToThreadNotInView(nsIMsgThread *threadHdr, nsIMsgDBHdr *msgHdr, bool ensureListed);</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineminus">-  nsresult ListThreadIds(nsMsgKey *startMsg, bool unreadOnly, nsMsgKey *pOutput, int32_t *pFlags, char *pLevels,</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineminus">-                        int32_t numToList, int32_t *pNumListed, int32_t *pTotalHeaders);</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineminus">-  nsresult InitSort(nsMsgViewSortTypeValue sortType, nsMsgViewSortOrderValue sortOrder);</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineminus">-  virtual nsresult SortThreads(nsMsgViewSortTypeValue sortType, nsMsgViewSortOrderValue sortOrder);</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineminus">-  virtual void  OnExtraFlagChanged(nsMsgViewIndex index, uint32_t extraFlag) override;</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineplus">+  virtual nsresult OnNewHeader(nsIMsgDBHdr *newHdr, nsMsgKey aParentKey,</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineplus">+                               bool ensureListed) override;</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineplus">+  virtual nsresult AddMsgToThreadNotInView(nsIMsgThread *threadHdr,</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineplus">+                                           nsIMsgDBHdr *msgHdr,</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineplus">+                                           bool ensureListed);</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineplus">+  nsresult ListThreadIds(nsMsgKey *startMsg, bool unreadOnly, nsMsgKey *pOutput,</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineplus">+                         int32_t *pFlags, char *pLevels, int32_t numToList,</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineplus">+                         int32_t *pNumListed, int32_t *pTotalHeaders);</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineplus">+  nsresult InitSort(nsMsgViewSortTypeValue sortType,</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineplus">+                    nsMsgViewSortOrderValue sortOrder);</span>
<a href="#l10.63"></a><span id="l10.63" class="difflineplus">+  virtual nsresult SortThreads(nsMsgViewSortTypeValue sortType,</span>
<a href="#l10.64"></a><span id="l10.64" class="difflineplus">+                               nsMsgViewSortOrderValue sortOrder);</span>
<a href="#l10.65"></a><span id="l10.65" class="difflineplus">+  virtual void OnExtraFlagChanged(nsMsgViewIndex index,</span>
<a href="#l10.66"></a><span id="l10.66" class="difflineplus">+                                  uint32_t extraFlag) override;</span>
<a href="#l10.67"></a><span id="l10.67">   virtual void OnHeaderAddedOrDeleted() override;</span>
<a href="#l10.68"></a><span id="l10.68" class="difflineminus">-  void    ClearPrevIdArray();</span>
<a href="#l10.69"></a><span id="l10.69" class="difflineplus">+  void ClearPrevIdArray();</span>
<a href="#l10.70"></a><span id="l10.70">   virtual nsresult RemoveByIndex(nsMsgViewIndex index) override;</span>
<a href="#l10.71"></a><span id="l10.71" class="difflineminus">-  nsMsgViewIndex GetInsertInfoForNewHdr(nsIMsgDBHdr *newHdr, nsMsgViewIndex threadIndex, int32_t targetLevel);</span>
<a href="#l10.72"></a><span id="l10.72" class="difflineplus">+  nsMsgViewIndex GetInsertInfoForNewHdr(nsIMsgDBHdr *newHdr,</span>
<a href="#l10.73"></a><span id="l10.73" class="difflineplus">+                                        nsMsgViewIndex threadIndex,</span>
<a href="#l10.74"></a><span id="l10.74" class="difflineplus">+                                        int32_t targetLevel);</span>
<a href="#l10.75"></a><span id="l10.75">   void MoveThreadAt(nsMsgViewIndex threadIndex);</span>
<a href="#l10.76"></a><span id="l10.76"> </span>
<a href="#l10.77"></a><span id="l10.77">   // these are used to save off the previous view so that bopping back and forth</span>
<a href="#l10.78"></a><span id="l10.78">   // between two views is quick (e.g., threaded and flat sorted by date).</span>
<a href="#l10.79"></a><span id="l10.79" class="difflineminus">-  bool            m_havePrevView;</span>
<a href="#l10.80"></a><span id="l10.80" class="difflineminus">-  nsTArray&lt;nsMsgKey&gt; m_prevKeys;   //this is used for caching non-threaded view.</span>
<a href="#l10.81"></a><span id="l10.81" class="difflineplus">+  bool m_havePrevView;</span>
<a href="#l10.82"></a><span id="l10.82" class="difflineplus">+  nsTArray&lt;nsMsgKey&gt; m_prevKeys;  // this is used for caching non-threaded view.</span>
<a href="#l10.83"></a><span id="l10.83">   nsTArray&lt;uint32_t&gt; m_prevFlags;</span>
<a href="#l10.84"></a><span id="l10.84" class="difflineminus">-  nsTArray&lt;uint8_t&gt;  m_prevLevels;</span>
<a href="#l10.85"></a><span id="l10.85" class="difflineminus">-  nsCOMPtr &lt;nsISimpleEnumerator&gt; m_threadEnumerator;</span>
<a href="#l10.86"></a><span id="l10.86" class="difflineplus">+  nsTArray&lt;uint8_t&gt; m_prevLevels;</span>
<a href="#l10.87"></a><span id="l10.87" class="difflineplus">+  nsCOMPtr&lt;nsISimpleEnumerator&gt; m_threadEnumerator;</span>
<a href="#l10.88"></a><span id="l10.88"> };</span>
<a href="#l10.89"></a><span id="l10.89"> </span>
<a href="#l10.90"></a><span id="l10.90"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/base/src/nsMsgWindow.cpp</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgWindow.cpp</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -32,504 +32,473 @@</span>
<a href="#l11.4"></a><span id="l11.4"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l11.5"></a><span id="l11.5"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l11.6"></a><span id="l11.6"> #include &quot;nsIAuthPrompt.h&quot;</span>
<a href="#l11.7"></a><span id="l11.7"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l11.8"></a><span id="l11.8"> #include &quot;mozilla/TransactionManager.h&quot;</span>
<a href="#l11.9"></a><span id="l11.9"> #include &quot;mozilla/dom/LoadURIOptionsBinding.h&quot;</span>
<a href="#l11.10"></a><span id="l11.10"> #include &quot;mozilla/Components.h&quot;</span>
<a href="#l11.11"></a><span id="l11.11"> </span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-NS_IMPL_ISUPPORTS(nsMsgWindow,</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-                              nsIMsgWindow,</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineminus">-                              nsIURIContentListener,</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineminus">-                              nsISupportsWeakReference,</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineminus">-                              nsIMsgWindowTest)</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineplus">+NS_IMPL_ISUPPORTS(nsMsgWindow, nsIMsgWindow, nsIURIContentListener,</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineplus">+                  nsISupportsWeakReference, nsIMsgWindowTest)</span>
<a href="#l11.19"></a><span id="l11.19"> </span>
<a href="#l11.20"></a><span id="l11.20" class="difflineminus">-nsMsgWindow::nsMsgWindow()</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineminus">-{</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineplus">+nsMsgWindow::nsMsgWindow() {</span>
<a href="#l11.23"></a><span id="l11.23">   mCharsetOverride = false;</span>
<a href="#l11.24"></a><span id="l11.24">   m_stopped = false;</span>
<a href="#l11.25"></a><span id="l11.25"> }</span>
<a href="#l11.26"></a><span id="l11.26"> </span>
<a href="#l11.27"></a><span id="l11.27" class="difflineminus">-nsMsgWindow::~nsMsgWindow()</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineminus">-{</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineminus">-  CloseWindow();</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineminus">-}</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineplus">+nsMsgWindow::~nsMsgWindow() { CloseWindow(); }</span>
<a href="#l11.32"></a><span id="l11.32"> </span>
<a href="#l11.33"></a><span id="l11.33" class="difflineminus">-nsresult nsMsgWindow::Init()</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineminus">-{</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineplus">+nsresult nsMsgWindow::Init() {</span>
<a href="#l11.36"></a><span id="l11.36">   // register ourselves as a content listener with the uri dispatcher service</span>
<a href="#l11.37"></a><span id="l11.37">   nsresult rv;</span>
<a href="#l11.38"></a><span id="l11.38">   nsCOMPtr&lt;nsIURILoader&gt; dispatcher = mozilla::components::URILoader::Service();</span>
<a href="#l11.39"></a><span id="l11.39">   NS_ENSURE_TRUE(dispatcher, NS_ERROR_UNEXPECTED);</span>
<a href="#l11.40"></a><span id="l11.40"> </span>
<a href="#l11.41"></a><span id="l11.41">   rv = dispatcher-&gt;RegisterContentListener(this);</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineminus">-    return rv;</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l11.45"></a><span id="l11.45"> </span>
<a href="#l11.46"></a><span id="l11.46">   // create Undo/Redo Transaction Manager</span>
<a href="#l11.47"></a><span id="l11.47">   mTransactionManager = new mozilla::TransactionManager();</span>
<a href="#l11.48"></a><span id="l11.48">   return mTransactionManager-&gt;SetMaxTransactionCount(-1);</span>
<a href="#l11.49"></a><span id="l11.49"> }</span>
<a href="#l11.50"></a><span id="l11.50"> </span>
<a href="#l11.51"></a><span id="l11.51" class="difflineminus">-NS_IMETHODIMP nsMsgWindow::GetMessageWindowDocShell(nsIDocShell ** aDocShell)</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineminus">-{</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineplus">+NS_IMETHODIMP nsMsgWindow::GetMessageWindowDocShell(nsIDocShell **aDocShell) {</span>
<a href="#l11.54"></a><span id="l11.54">   *aDocShell = nullptr;</span>
<a href="#l11.55"></a><span id="l11.55">   nsCOMPtr&lt;nsIDocShell&gt; docShell(do_QueryReferent(mMessageWindowDocShellWeak));</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineminus">-  if (!docShell)</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineminus">-  {</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineminus">-    // if we don't have a docshell, then we need to look up the message pane docshell</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineplus">+  if (!docShell) {</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineplus">+    // if we don't have a docshell, then we need to look up the message pane</span>
<a href="#l11.61"></a><span id="l11.61" class="difflineplus">+    // docshell</span>
<a href="#l11.62"></a><span id="l11.62">     nsCOMPtr&lt;nsIDocShell&gt; rootShell(do_QueryReferent(mRootDocShellWeak));</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineminus">-    if (rootShell)</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineminus">-    {</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineplus">+    if (rootShell) {</span>
<a href="#l11.66"></a><span id="l11.66">       nsCOMPtr&lt;nsIDocShellTreeItem&gt; msgDocShellItem;</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineminus">-      if(rootShell)</span>
<a href="#l11.68"></a><span id="l11.68" class="difflineminus">-         rootShell-&gt;FindChildWithName(NS_LITERAL_STRING(&quot;messagepane&quot;),</span>
<a href="#l11.69"></a><span id="l11.69" class="difflineminus">-                                      true, false, nullptr, nullptr,</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineminus">-                                      getter_AddRefs(msgDocShellItem));</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineplus">+      if (rootShell)</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineplus">+        rootShell-&gt;FindChildWithName(NS_LITERAL_STRING(&quot;messagepane&quot;), true,</span>
<a href="#l11.73"></a><span id="l11.73" class="difflineplus">+                                     false, nullptr, nullptr,</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineplus">+                                     getter_AddRefs(msgDocShellItem));</span>
<a href="#l11.75"></a><span id="l11.75">       NS_ENSURE_TRUE(msgDocShellItem, NS_ERROR_FAILURE);</span>
<a href="#l11.76"></a><span id="l11.76">       docShell = do_QueryInterface(msgDocShellItem);</span>
<a href="#l11.77"></a><span id="l11.77" class="difflineminus">-      // we don't own mMessageWindowDocShell so don't try to keep a reference to it!</span>
<a href="#l11.78"></a><span id="l11.78" class="difflineplus">+      // we don't own mMessageWindowDocShell so don't try to keep a reference to</span>
<a href="#l11.79"></a><span id="l11.79" class="difflineplus">+      // it!</span>
<a href="#l11.80"></a><span id="l11.80">       mMessageWindowDocShellWeak = do_GetWeakReference(docShell);</span>
<a href="#l11.81"></a><span id="l11.81">     }</span>
<a href="#l11.82"></a><span id="l11.82">   }</span>
<a href="#l11.83"></a><span id="l11.83">   docShell.forget(aDocShell);</span>
<a href="#l11.84"></a><span id="l11.84">   return NS_OK;</span>
<a href="#l11.85"></a><span id="l11.85"> }</span>
<a href="#l11.86"></a><span id="l11.86"> </span>
<a href="#l11.87"></a><span id="l11.87" class="difflineminus">-NS_IMETHODIMP nsMsgWindow::CloseWindow()</span>
<a href="#l11.88"></a><span id="l11.88" class="difflineminus">-{</span>
<a href="#l11.89"></a><span id="l11.89" class="difflineplus">+NS_IMETHODIMP nsMsgWindow::CloseWindow() {</span>
<a href="#l11.90"></a><span id="l11.90">   nsCOMPtr&lt;nsIURILoader&gt; dispatcher = mozilla::components::URILoader::Service();</span>
<a href="#l11.91"></a><span id="l11.91" class="difflineminus">-  if (dispatcher) // on shut down it's possible dispatcher will be null.</span>
<a href="#l11.92"></a><span id="l11.92" class="difflineplus">+  if (dispatcher)  // on shut down it's possible dispatcher will be null.</span>
<a href="#l11.93"></a><span id="l11.93">     dispatcher-&gt;UnRegisterContentListener(this);</span>
<a href="#l11.94"></a><span id="l11.94"> </span>
<a href="#l11.95"></a><span id="l11.95">   mMsgWindowCommands = nullptr;</span>
<a href="#l11.96"></a><span id="l11.96">   mStatusFeedback = nullptr;</span>
<a href="#l11.97"></a><span id="l11.97"> </span>
<a href="#l11.98"></a><span id="l11.98">   StopUrls();</span>
<a href="#l11.99"></a><span id="l11.99"> </span>
<a href="#l11.100"></a><span id="l11.100" class="difflineminus">-  nsCOMPtr&lt;nsIDocShell&gt; messagePaneDocShell(do_QueryReferent(mMessageWindowDocShellWeak));</span>
<a href="#l11.101"></a><span id="l11.101" class="difflineminus">-  if (messagePaneDocShell)</span>
<a href="#l11.102"></a><span id="l11.102" class="difflineminus">-  {</span>
<a href="#l11.103"></a><span id="l11.103" class="difflineminus">-    nsCOMPtr&lt;nsIURIContentListener&gt; listener(do_GetInterface(messagePaneDocShell));</span>
<a href="#l11.104"></a><span id="l11.104" class="difflineminus">-    if (listener)</span>
<a href="#l11.105"></a><span id="l11.105" class="difflineminus">-      listener-&gt;SetParentContentListener(nullptr);</span>
<a href="#l11.106"></a><span id="l11.106" class="difflineplus">+  nsCOMPtr&lt;nsIDocShell&gt; messagePaneDocShell(</span>
<a href="#l11.107"></a><span id="l11.107" class="difflineplus">+      do_QueryReferent(mMessageWindowDocShellWeak));</span>
<a href="#l11.108"></a><span id="l11.108" class="difflineplus">+  if (messagePaneDocShell) {</span>
<a href="#l11.109"></a><span id="l11.109" class="difflineplus">+    nsCOMPtr&lt;nsIURIContentListener&gt; listener(</span>
<a href="#l11.110"></a><span id="l11.110" class="difflineplus">+        do_GetInterface(messagePaneDocShell));</span>
<a href="#l11.111"></a><span id="l11.111" class="difflineplus">+    if (listener) listener-&gt;SetParentContentListener(nullptr);</span>
<a href="#l11.112"></a><span id="l11.112">     SetRootDocShell(nullptr);</span>
<a href="#l11.113"></a><span id="l11.113">     mMessageWindowDocShellWeak = nullptr;</span>
<a href="#l11.114"></a><span id="l11.114">   }</span>
<a href="#l11.115"></a><span id="l11.115"> </span>
<a href="#l11.116"></a><span id="l11.116">   // in case nsMsgWindow leaks, make sure other stuff doesn't leak.</span>
<a href="#l11.117"></a><span id="l11.117">   mTransactionManager = nullptr;</span>
<a href="#l11.118"></a><span id="l11.118">   return NS_OK;</span>
<a href="#l11.119"></a><span id="l11.119"> }</span>
<a href="#l11.120"></a><span id="l11.120"> </span>
<a href="#l11.121"></a><span id="l11.121" class="difflineminus">-NS_IMETHODIMP nsMsgWindow::GetStatusFeedback(nsIMsgStatusFeedback **aStatusFeedback)</span>
<a href="#l11.122"></a><span id="l11.122" class="difflineminus">-{</span>
<a href="#l11.123"></a><span id="l11.123" class="difflineplus">+NS_IMETHODIMP nsMsgWindow::GetStatusFeedback(</span>
<a href="#l11.124"></a><span id="l11.124" class="difflineplus">+    nsIMsgStatusFeedback **aStatusFeedback) {</span>
<a href="#l11.125"></a><span id="l11.125">   NS_ENSURE_ARG_POINTER(aStatusFeedback);</span>
<a href="#l11.126"></a><span id="l11.126">   NS_IF_ADDREF(*aStatusFeedback = mStatusFeedback);</span>
<a href="#l11.127"></a><span id="l11.127">   return NS_OK;</span>
<a href="#l11.128"></a><span id="l11.128"> }</span>
<a href="#l11.129"></a><span id="l11.129"> </span>
<a href="#l11.130"></a><span id="l11.130" class="difflineminus">-NS_IMETHODIMP nsMsgWindow::SetStatusFeedback(nsIMsgStatusFeedback * aStatusFeedback)</span>
<a href="#l11.131"></a><span id="l11.131" class="difflineminus">-{</span>
<a href="#l11.132"></a><span id="l11.132" class="difflineplus">+NS_IMETHODIMP nsMsgWindow::SetStatusFeedback(</span>
<a href="#l11.133"></a><span id="l11.133" class="difflineplus">+    nsIMsgStatusFeedback *aStatusFeedback) {</span>
<a href="#l11.134"></a><span id="l11.134">   mStatusFeedback = aStatusFeedback;</span>
<a href="#l11.135"></a><span id="l11.135">   nsCOMPtr&lt;nsIDocShell&gt; messageWindowDocShell;</span>
<a href="#l11.136"></a><span id="l11.136">   GetMessageWindowDocShell(getter_AddRefs(messageWindowDocShell));</span>
<a href="#l11.137"></a><span id="l11.137"> </span>
<a href="#l11.138"></a><span id="l11.138">   // register our status feedback object as a web progress listener</span>
<a href="#l11.139"></a><span id="l11.139">   nsCOMPtr&lt;nsIWebProgress&gt; webProgress(do_GetInterface(messageWindowDocShell));</span>
<a href="#l11.140"></a><span id="l11.140" class="difflineminus">-  if (webProgress &amp;&amp; mStatusFeedback &amp;&amp; messageWindowDocShell)</span>
<a href="#l11.141"></a><span id="l11.141" class="difflineminus">-  {</span>
<a href="#l11.142"></a><span id="l11.142" class="difflineminus">-    nsCOMPtr&lt;nsIWebProgressListener&gt; webProgressListener = do_QueryInterface(mStatusFeedback);</span>
<a href="#l11.143"></a><span id="l11.143" class="difflineminus">-    webProgress-&gt;AddProgressListener(webProgressListener, nsIWebProgress::NOTIFY_ALL);</span>
<a href="#l11.144"></a><span id="l11.144" class="difflineplus">+  if (webProgress &amp;&amp; mStatusFeedback &amp;&amp; messageWindowDocShell) {</span>
<a href="#l11.145"></a><span id="l11.145" class="difflineplus">+    nsCOMPtr&lt;nsIWebProgressListener&gt; webProgressListener =</span>
<a href="#l11.146"></a><span id="l11.146" class="difflineplus">+        do_QueryInterface(mStatusFeedback);</span>
<a href="#l11.147"></a><span id="l11.147" class="difflineplus">+    webProgress-&gt;AddProgressListener(webProgressListener,</span>
<a href="#l11.148"></a><span id="l11.148" class="difflineplus">+                                     nsIWebProgress::NOTIFY_ALL);</span>
<a href="#l11.149"></a><span id="l11.149">   }</span>
<a href="#l11.150"></a><span id="l11.150">   return NS_OK;</span>
<a href="#l11.151"></a><span id="l11.151"> }</span>
<a href="#l11.152"></a><span id="l11.152"> </span>
<a href="#l11.153"></a><span id="l11.153" class="difflineminus">-NS_IMETHODIMP nsMsgWindow::SetWindowCommands(nsIMsgWindowCommands * aMsgWindowCommands)</span>
<a href="#l11.154"></a><span id="l11.154" class="difflineminus">-{</span>
<a href="#l11.155"></a><span id="l11.155" class="difflineplus">+NS_IMETHODIMP nsMsgWindow::SetWindowCommands(</span>
<a href="#l11.156"></a><span id="l11.156" class="difflineplus">+    nsIMsgWindowCommands *aMsgWindowCommands) {</span>
<a href="#l11.157"></a><span id="l11.157">   mMsgWindowCommands = aMsgWindowCommands;</span>
<a href="#l11.158"></a><span id="l11.158">   return NS_OK;</span>
<a href="#l11.159"></a><span id="l11.159"> }</span>
<a href="#l11.160"></a><span id="l11.160"> </span>
<a href="#l11.161"></a><span id="l11.161" class="difflineminus">-NS_IMETHODIMP nsMsgWindow::GetWindowCommands(nsIMsgWindowCommands **aMsgWindowCommands)</span>
<a href="#l11.162"></a><span id="l11.162" class="difflineminus">-{</span>
<a href="#l11.163"></a><span id="l11.163" class="difflineplus">+NS_IMETHODIMP nsMsgWindow::GetWindowCommands(</span>
<a href="#l11.164"></a><span id="l11.164" class="difflineplus">+    nsIMsgWindowCommands **aMsgWindowCommands) {</span>
<a href="#l11.165"></a><span id="l11.165">   NS_ENSURE_ARG_POINTER(aMsgWindowCommands);</span>
<a href="#l11.166"></a><span id="l11.166">   NS_IF_ADDREF(*aMsgWindowCommands = mMsgWindowCommands);</span>
<a href="#l11.167"></a><span id="l11.167">   return NS_OK;</span>
<a href="#l11.168"></a><span id="l11.168"> }</span>
<a href="#l11.169"></a><span id="l11.169"> </span>
<a href="#l11.170"></a><span id="l11.170" class="difflineminus">-NS_IMETHODIMP nsMsgWindow::GetMsgHeaderSink(nsIMsgHeaderSink * *aMsgHdrSink)</span>
<a href="#l11.171"></a><span id="l11.171" class="difflineminus">-{</span>
<a href="#l11.172"></a><span id="l11.172" class="difflineplus">+NS_IMETHODIMP nsMsgWindow::GetMsgHeaderSink(nsIMsgHeaderSink **aMsgHdrSink) {</span>
<a href="#l11.173"></a><span id="l11.173">   NS_ENSURE_ARG_POINTER(aMsgHdrSink);</span>
<a href="#l11.174"></a><span id="l11.174">   NS_IF_ADDREF(*aMsgHdrSink = mMsgHeaderSink);</span>
<a href="#l11.175"></a><span id="l11.175">   return NS_OK;</span>
<a href="#l11.176"></a><span id="l11.176"> }</span>
<a href="#l11.177"></a><span id="l11.177"> </span>
<a href="#l11.178"></a><span id="l11.178" class="difflineminus">-NS_IMETHODIMP nsMsgWindow::SetMsgHeaderSink(nsIMsgHeaderSink * aMsgHdrSink)</span>
<a href="#l11.179"></a><span id="l11.179" class="difflineminus">-{</span>
<a href="#l11.180"></a><span id="l11.180" class="difflineplus">+NS_IMETHODIMP nsMsgWindow::SetMsgHeaderSink(nsIMsgHeaderSink *aMsgHdrSink) {</span>
<a href="#l11.181"></a><span id="l11.181">   mMsgHeaderSink = aMsgHdrSink;</span>
<a href="#l11.182"></a><span id="l11.182">   return NS_OK;</span>
<a href="#l11.183"></a><span id="l11.183"> }</span>
<a href="#l11.184"></a><span id="l11.184"> </span>
<a href="#l11.185"></a><span id="l11.185" class="difflineminus">-NS_IMETHODIMP nsMsgWindow::GetTransactionManager(nsITransactionManager * *aTransactionManager)</span>
<a href="#l11.186"></a><span id="l11.186" class="difflineminus">-{</span>
<a href="#l11.187"></a><span id="l11.187" class="difflineplus">+NS_IMETHODIMP nsMsgWindow::GetTransactionManager(</span>
<a href="#l11.188"></a><span id="l11.188" class="difflineplus">+    nsITransactionManager **aTransactionManager) {</span>
<a href="#l11.189"></a><span id="l11.189">   NS_ENSURE_ARG_POINTER(aTransactionManager);</span>
<a href="#l11.190"></a><span id="l11.190">   NS_IF_ADDREF(*aTransactionManager = mTransactionManager);</span>
<a href="#l11.191"></a><span id="l11.191">   return NS_OK;</span>
<a href="#l11.192"></a><span id="l11.192"> }</span>
<a href="#l11.193"></a><span id="l11.193"> </span>
<a href="#l11.194"></a><span id="l11.194" class="difflineminus">-NS_IMETHODIMP nsMsgWindow::SetTransactionManager(nsITransactionManager * aTransactionManager)</span>
<a href="#l11.195"></a><span id="l11.195" class="difflineminus">-{</span>
<a href="#l11.196"></a><span id="l11.196" class="difflineplus">+NS_IMETHODIMP nsMsgWindow::SetTransactionManager(</span>
<a href="#l11.197"></a><span id="l11.197" class="difflineplus">+    nsITransactionManager *aTransactionManager) {</span>
<a href="#l11.198"></a><span id="l11.198">   mTransactionManager = aTransactionManager;</span>
<a href="#l11.199"></a><span id="l11.199">   return NS_OK;</span>
<a href="#l11.200"></a><span id="l11.200"> }</span>
<a href="#l11.201"></a><span id="l11.201"> </span>
<a href="#l11.202"></a><span id="l11.202" class="difflineminus">-NS_IMETHODIMP nsMsgWindow::GetOpenFolder(nsIMsgFolder * *aOpenFolder)</span>
<a href="#l11.203"></a><span id="l11.203" class="difflineminus">-{</span>
<a href="#l11.204"></a><span id="l11.204" class="difflineplus">+NS_IMETHODIMP nsMsgWindow::GetOpenFolder(nsIMsgFolder **aOpenFolder) {</span>
<a href="#l11.205"></a><span id="l11.205">   NS_ENSURE_ARG_POINTER(aOpenFolder);</span>
<a href="#l11.206"></a><span id="l11.206">   NS_IF_ADDREF(*aOpenFolder = mOpenFolder);</span>
<a href="#l11.207"></a><span id="l11.207">   return NS_OK;</span>
<a href="#l11.208"></a><span id="l11.208"> }</span>
<a href="#l11.209"></a><span id="l11.209"> </span>
<a href="#l11.210"></a><span id="l11.210" class="difflineminus">-NS_IMETHODIMP nsMsgWindow::SetOpenFolder(nsIMsgFolder * aOpenFolder)</span>
<a href="#l11.211"></a><span id="l11.211" class="difflineminus">-{</span>
<a href="#l11.212"></a><span id="l11.212" class="difflineplus">+NS_IMETHODIMP nsMsgWindow::SetOpenFolder(nsIMsgFolder *aOpenFolder) {</span>
<a href="#l11.213"></a><span id="l11.213">   mOpenFolder = aOpenFolder;</span>
<a href="#l11.214"></a><span id="l11.214">   return NS_OK;</span>
<a href="#l11.215"></a><span id="l11.215"> }</span>
<a href="#l11.216"></a><span id="l11.216"> </span>
<a href="#l11.217"></a><span id="l11.217" class="difflineminus">-NS_IMETHODIMP nsMsgWindow::GetRootDocShell(nsIDocShell * *aDocShell)</span>
<a href="#l11.218"></a><span id="l11.218" class="difflineminus">-{</span>
<a href="#l11.219"></a><span id="l11.219" class="difflineplus">+NS_IMETHODIMP nsMsgWindow::GetRootDocShell(nsIDocShell **aDocShell) {</span>
<a href="#l11.220"></a><span id="l11.220">   if (mRootDocShellWeak)</span>
<a href="#l11.221"></a><span id="l11.221">     CallQueryReferent(mRootDocShellWeak.get(), aDocShell);</span>
<a href="#l11.222"></a><span id="l11.222">   else</span>
<a href="#l11.223"></a><span id="l11.223">     *aDocShell = nullptr;</span>
<a href="#l11.224"></a><span id="l11.224">   return NS_OK;</span>
<a href="#l11.225"></a><span id="l11.225"> }</span>
<a href="#l11.226"></a><span id="l11.226"> </span>
<a href="#l11.227"></a><span id="l11.227" class="difflineminus">-NS_IMETHODIMP nsMsgWindow::GetAuthPrompt(nsIAuthPrompt * *aAuthPrompt)</span>
<a href="#l11.228"></a><span id="l11.228" class="difflineminus">-{</span>
<a href="#l11.229"></a><span id="l11.229" class="difflineplus">+NS_IMETHODIMP nsMsgWindow::GetAuthPrompt(nsIAuthPrompt **aAuthPrompt) {</span>
<a href="#l11.230"></a><span id="l11.230">   NS_ENSURE_ARG_POINTER(aAuthPrompt);</span>
<a href="#l11.231"></a><span id="l11.231"> </span>
<a href="#l11.232"></a><span id="l11.232">   // testing only</span>
<a href="#l11.233"></a><span id="l11.233" class="difflineminus">-  if (mAuthPrompt)</span>
<a href="#l11.234"></a><span id="l11.234" class="difflineminus">-  {</span>
<a href="#l11.235"></a><span id="l11.235" class="difflineplus">+  if (mAuthPrompt) {</span>
<a href="#l11.236"></a><span id="l11.236">     NS_ADDREF(*aAuthPrompt = mAuthPrompt);</span>
<a href="#l11.237"></a><span id="l11.237">     return NS_OK;</span>
<a href="#l11.238"></a><span id="l11.238">   }</span>
<a href="#l11.239"></a><span id="l11.239"> </span>
<a href="#l11.240"></a><span id="l11.240" class="difflineminus">-  if (!mRootDocShellWeak)</span>
<a href="#l11.241"></a><span id="l11.241" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l11.242"></a><span id="l11.242" class="difflineplus">+  if (!mRootDocShellWeak) return NS_ERROR_FAILURE;</span>
<a href="#l11.243"></a><span id="l11.243"> </span>
<a href="#l11.244"></a><span id="l11.244">   nsresult rv;</span>
<a href="#l11.245"></a><span id="l11.245" class="difflineminus">-  nsCOMPtr&lt;nsIDocShell&gt; docShell(do_QueryReferent(mRootDocShellWeak.get(), &amp;rv));</span>
<a href="#l11.246"></a><span id="l11.246" class="difflineplus">+  nsCOMPtr&lt;nsIDocShell&gt; docShell(</span>
<a href="#l11.247"></a><span id="l11.247" class="difflineplus">+      do_QueryReferent(mRootDocShellWeak.get(), &amp;rv));</span>
<a href="#l11.248"></a><span id="l11.248">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.249"></a><span id="l11.249"> </span>
<a href="#l11.250"></a><span id="l11.250">   nsCOMPtr&lt;nsIAuthPrompt&gt; prompt = do_GetInterface(docShell, &amp;rv);</span>
<a href="#l11.251"></a><span id="l11.251">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.252"></a><span id="l11.252"> </span>
<a href="#l11.253"></a><span id="l11.253">   prompt.forget(aAuthPrompt);</span>
<a href="#l11.254"></a><span id="l11.254"> </span>
<a href="#l11.255"></a><span id="l11.255">   return rv;</span>
<a href="#l11.256"></a><span id="l11.256"> }</span>
<a href="#l11.257"></a><span id="l11.257"> </span>
<a href="#l11.258"></a><span id="l11.258" class="difflineminus">-NS_IMETHODIMP nsMsgWindow::SetAuthPrompt(nsIAuthPrompt* aAuthPrompt)</span>
<a href="#l11.259"></a><span id="l11.259" class="difflineminus">-{</span>
<a href="#l11.260"></a><span id="l11.260" class="difflineplus">+NS_IMETHODIMP nsMsgWindow::SetAuthPrompt(nsIAuthPrompt *aAuthPrompt) {</span>
<a href="#l11.261"></a><span id="l11.261">   mAuthPrompt = aAuthPrompt;</span>
<a href="#l11.262"></a><span id="l11.262">   return NS_OK;</span>
<a href="#l11.263"></a><span id="l11.263"> }</span>
<a href="#l11.264"></a><span id="l11.264"> </span>
<a href="#l11.265"></a><span id="l11.265" class="difflineminus">-NS_IMETHODIMP nsMsgWindow::SetRootDocShell(nsIDocShell * aDocShell)</span>
<a href="#l11.266"></a><span id="l11.266" class="difflineminus">-{</span>
<a href="#l11.267"></a><span id="l11.267" class="difflineplus">+NS_IMETHODIMP nsMsgWindow::SetRootDocShell(nsIDocShell *aDocShell) {</span>
<a href="#l11.268"></a><span id="l11.268">   nsresult rv;</span>
<a href="#l11.269"></a><span id="l11.269">   nsCOMPtr&lt;nsIWebProgressListener&gt; contentPolicyListener =</span>
<a href="#l11.270"></a><span id="l11.270" class="difflineminus">-    do_GetService(NS_MSGCONTENTPOLICY_CONTRACTID, &amp;rv);</span>
<a href="#l11.271"></a><span id="l11.271" class="difflineplus">+      do_GetService(NS_MSGCONTENTPOLICY_CONTRACTID, &amp;rv);</span>
<a href="#l11.272"></a><span id="l11.272">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.273"></a><span id="l11.273"> </span>
<a href="#l11.274"></a><span id="l11.274">   // remove the content policy webProgressListener from the root doc shell</span>
<a href="#l11.275"></a><span id="l11.275">   // we're currently holding, so we don't keep listening for loads that</span>
<a href="#l11.276"></a><span id="l11.276">   // we don't care about</span>
<a href="#l11.277"></a><span id="l11.277">   if (mRootDocShellWeak) {</span>
<a href="#l11.278"></a><span id="l11.278">     nsCOMPtr&lt;nsIWebProgress&gt; oldWebProgress =</span>
<a href="#l11.279"></a><span id="l11.279" class="difflineminus">-      do_QueryReferent(mRootDocShellWeak, &amp;rv);</span>
<a href="#l11.280"></a><span id="l11.280" class="difflineplus">+        do_QueryReferent(mRootDocShellWeak, &amp;rv);</span>
<a href="#l11.281"></a><span id="l11.281">     if (NS_SUCCEEDED(rv)) {</span>
<a href="#l11.282"></a><span id="l11.282">       rv = oldWebProgress-&gt;RemoveProgressListener(contentPolicyListener);</span>
<a href="#l11.283"></a><span id="l11.283">       NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed to remove old progress listener&quot;);</span>
<a href="#l11.284"></a><span id="l11.284">     }</span>
<a href="#l11.285"></a><span id="l11.285">   }</span>
<a href="#l11.286"></a><span id="l11.286"> </span>
<a href="#l11.287"></a><span id="l11.287">   // Query for the doc shell and release it</span>
<a href="#l11.288"></a><span id="l11.288">   mRootDocShellWeak = nullptr;</span>
<a href="#l11.289"></a><span id="l11.289" class="difflineminus">-  if (aDocShell)</span>
<a href="#l11.290"></a><span id="l11.290" class="difflineminus">-  {</span>
<a href="#l11.291"></a><span id="l11.291" class="difflineplus">+  if (aDocShell) {</span>
<a href="#l11.292"></a><span id="l11.292">     mRootDocShellWeak = do_GetWeakReference(aDocShell);</span>
<a href="#l11.293"></a><span id="l11.293"> </span>
<a href="#l11.294"></a><span id="l11.294">     nsCOMPtr&lt;nsIDocShell&gt; messagePaneDocShell;</span>
<a href="#l11.295"></a><span id="l11.295">     GetMessageWindowDocShell(getter_AddRefs(messagePaneDocShell));</span>
<a href="#l11.296"></a><span id="l11.296" class="difflineminus">-    nsCOMPtr&lt;nsIURIContentListener&gt; listener(do_GetInterface(messagePaneDocShell));</span>
<a href="#l11.297"></a><span id="l11.297" class="difflineminus">-    if (listener)</span>
<a href="#l11.298"></a><span id="l11.298" class="difflineminus">-      listener-&gt;SetParentContentListener(this);</span>
<a href="#l11.299"></a><span id="l11.299" class="difflineplus">+    nsCOMPtr&lt;nsIURIContentListener&gt; listener(</span>
<a href="#l11.300"></a><span id="l11.300" class="difflineplus">+        do_GetInterface(messagePaneDocShell));</span>
<a href="#l11.301"></a><span id="l11.301" class="difflineplus">+    if (listener) listener-&gt;SetParentContentListener(this);</span>
<a href="#l11.302"></a><span id="l11.302"> </span>
<a href="#l11.303"></a><span id="l11.303">     // set the contentPolicy webProgressListener on the root docshell for this</span>
<a href="#l11.304"></a><span id="l11.304">     // window so that it can allow JavaScript for non-message content</span>
<a href="#l11.305"></a><span id="l11.305">     nsCOMPtr&lt;nsIWebProgress&gt; docShellProgress =</span>
<a href="#l11.306"></a><span id="l11.306" class="difflineminus">-      do_QueryInterface(aDocShell, &amp;rv);</span>
<a href="#l11.307"></a><span id="l11.307" class="difflineplus">+        do_QueryInterface(aDocShell, &amp;rv);</span>
<a href="#l11.308"></a><span id="l11.308">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.309"></a><span id="l11.309"> </span>
<a href="#l11.310"></a><span id="l11.310">     rv = docShellProgress-&gt;AddProgressListener(contentPolicyListener,</span>
<a href="#l11.311"></a><span id="l11.311">                                                nsIWebProgress::NOTIFY_LOCATION);</span>
<a href="#l11.312"></a><span id="l11.312">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.313"></a><span id="l11.313">   }</span>
<a href="#l11.314"></a><span id="l11.314">   return NS_OK;</span>
<a href="#l11.315"></a><span id="l11.315"> }</span>
<a href="#l11.316"></a><span id="l11.316"> </span>
<a href="#l11.317"></a><span id="l11.317" class="difflineminus">-NS_IMETHODIMP nsMsgWindow::GetMailCharacterSet(nsACString&amp; aMailCharacterSet)</span>
<a href="#l11.318"></a><span id="l11.318" class="difflineminus">-{</span>
<a href="#l11.319"></a><span id="l11.319" class="difflineplus">+NS_IMETHODIMP nsMsgWindow::GetMailCharacterSet(nsACString &amp;aMailCharacterSet) {</span>
<a href="#l11.320"></a><span id="l11.320">   aMailCharacterSet = mMailCharacterSet;</span>
<a href="#l11.321"></a><span id="l11.321">   return NS_OK;</span>
<a href="#l11.322"></a><span id="l11.322"> }</span>
<a href="#l11.323"></a><span id="l11.323"> </span>
<a href="#l11.324"></a><span id="l11.324" class="difflineminus">-NS_IMETHODIMP nsMsgWindow::SetMailCharacterSet(const nsACString&amp; aMailCharacterSet)</span>
<a href="#l11.325"></a><span id="l11.325" class="difflineminus">-{</span>
<a href="#l11.326"></a><span id="l11.326" class="difflineplus">+NS_IMETHODIMP nsMsgWindow::SetMailCharacterSet(</span>
<a href="#l11.327"></a><span id="l11.327" class="difflineplus">+    const nsACString &amp;aMailCharacterSet) {</span>
<a href="#l11.328"></a><span id="l11.328">   mMailCharacterSet.Assign(aMailCharacterSet);</span>
<a href="#l11.329"></a><span id="l11.329"> </span>
<a href="#l11.330"></a><span id="l11.330" class="difflineminus">-  // Convert to a canonical charset name instead of using the charset name from the message header as is.</span>
<a href="#l11.331"></a><span id="l11.331" class="difflineminus">-  // This is needed for charset menu item to have a check mark correctly.</span>
<a href="#l11.332"></a><span id="l11.332" class="difflineplus">+  // Convert to a canonical charset name instead of using the charset name from</span>
<a href="#l11.333"></a><span id="l11.333" class="difflineplus">+  // the message header as is. This is needed for charset menu item to have a</span>
<a href="#l11.334"></a><span id="l11.334" class="difflineplus">+  // check mark correctly.</span>
<a href="#l11.335"></a><span id="l11.335">   nsresult rv;</span>
<a href="#l11.336"></a><span id="l11.336" class="difflineminus">-  nsCOMPtr &lt;nsICharsetConverterManager&gt; ccm =</span>
<a href="#l11.337"></a><span id="l11.337" class="difflineminus">-    do_GetService(NS_CHARSETCONVERTERMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l11.338"></a><span id="l11.338" class="difflineplus">+  nsCOMPtr&lt;nsICharsetConverterManager&gt; ccm =</span>
<a href="#l11.339"></a><span id="l11.339" class="difflineplus">+      do_GetService(NS_CHARSETCONVERTERMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l11.340"></a><span id="l11.340">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.341"></a><span id="l11.341"> </span>
<a href="#l11.342"></a><span id="l11.342">   return ccm-&gt;GetCharsetAlias(PromiseFlatCString(aMailCharacterSet).get(),</span>
<a href="#l11.343"></a><span id="l11.343">                               mMailCharacterSet);</span>
<a href="#l11.344"></a><span id="l11.344"> }</span>
<a href="#l11.345"></a><span id="l11.345"> </span>
<a href="#l11.346"></a><span id="l11.346" class="difflineminus">-NS_IMETHODIMP nsMsgWindow::GetCharsetOverride(bool *aCharsetOverride)</span>
<a href="#l11.347"></a><span id="l11.347" class="difflineminus">-{</span>
<a href="#l11.348"></a><span id="l11.348" class="difflineplus">+NS_IMETHODIMP nsMsgWindow::GetCharsetOverride(bool *aCharsetOverride) {</span>
<a href="#l11.349"></a><span id="l11.349">   NS_ENSURE_ARG_POINTER(aCharsetOverride);</span>
<a href="#l11.350"></a><span id="l11.350">   *aCharsetOverride = mCharsetOverride;</span>
<a href="#l11.351"></a><span id="l11.351">   return NS_OK;</span>
<a href="#l11.352"></a><span id="l11.352"> }</span>
<a href="#l11.353"></a><span id="l11.353"> </span>
<a href="#l11.354"></a><span id="l11.354" class="difflineminus">-NS_IMETHODIMP nsMsgWindow::SetCharsetOverride(bool aCharsetOverride)</span>
<a href="#l11.355"></a><span id="l11.355" class="difflineminus">-{</span>
<a href="#l11.356"></a><span id="l11.356" class="difflineplus">+NS_IMETHODIMP nsMsgWindow::SetCharsetOverride(bool aCharsetOverride) {</span>
<a href="#l11.357"></a><span id="l11.357">   mCharsetOverride = aCharsetOverride;</span>
<a href="#l11.358"></a><span id="l11.358">   return NS_OK;</span>
<a href="#l11.359"></a><span id="l11.359"> }</span>
<a href="#l11.360"></a><span id="l11.360"> </span>
<a href="#l11.361"></a><span id="l11.361" class="difflineminus">-NS_IMETHODIMP nsMsgWindow::GetDomWindow(mozIDOMWindowProxy **aWindow)</span>
<a href="#l11.362"></a><span id="l11.362" class="difflineminus">-{</span>
<a href="#l11.363"></a><span id="l11.363" class="difflineplus">+NS_IMETHODIMP nsMsgWindow::GetDomWindow(mozIDOMWindowProxy **aWindow) {</span>
<a href="#l11.364"></a><span id="l11.364">   NS_ENSURE_ARG_POINTER(aWindow);</span>
<a href="#l11.365"></a><span id="l11.365">   if (mDomWindow)</span>
<a href="#l11.366"></a><span id="l11.366">     CallQueryReferent(mDomWindow.get(), aWindow);</span>
<a href="#l11.367"></a><span id="l11.367">   else</span>
<a href="#l11.368"></a><span id="l11.368">     *aWindow = nullptr;</span>
<a href="#l11.369"></a><span id="l11.369">   return NS_OK;</span>
<a href="#l11.370"></a><span id="l11.370"> }</span>
<a href="#l11.371"></a><span id="l11.371"> </span>
<a href="#l11.372"></a><span id="l11.372" class="difflineminus">-NS_IMETHODIMP nsMsgWindow::SetDomWindow(mozIDOMWindowProxy * aWindow)</span>
<a href="#l11.373"></a><span id="l11.373" class="difflineminus">-{</span>
<a href="#l11.374"></a><span id="l11.374" class="difflineplus">+NS_IMETHODIMP nsMsgWindow::SetDomWindow(mozIDOMWindowProxy *aWindow) {</span>
<a href="#l11.375"></a><span id="l11.375">   NS_ENSURE_ARG_POINTER(aWindow);</span>
<a href="#l11.376"></a><span id="l11.376">   mDomWindow = do_GetWeakReference(aWindow);</span>
<a href="#l11.377"></a><span id="l11.377"> </span>
<a href="#l11.378"></a><span id="l11.378">   nsCOMPtr&lt;nsPIDOMWindowOuter&gt; win = nsPIDOMWindowOuter::From(aWindow);</span>
<a href="#l11.379"></a><span id="l11.379">   nsIDocShell *docShell = nullptr;</span>
<a href="#l11.380"></a><span id="l11.380" class="difflineminus">-  if (win)</span>
<a href="#l11.381"></a><span id="l11.381" class="difflineminus">-    docShell = win-&gt;GetDocShell();</span>
<a href="#l11.382"></a><span id="l11.382" class="difflineplus">+  if (win) docShell = win-&gt;GetDocShell();</span>
<a href="#l11.383"></a><span id="l11.383"> </span>
<a href="#l11.384"></a><span id="l11.384">   nsCOMPtr&lt;nsIDocShellTreeItem&gt; docShellAsItem(docShell);</span>
<a href="#l11.385"></a><span id="l11.385"> </span>
<a href="#l11.386"></a><span id="l11.386" class="difflineminus">-  if(docShellAsItem)</span>
<a href="#l11.387"></a><span id="l11.387" class="difflineminus">-  {</span>
<a href="#l11.388"></a><span id="l11.388" class="difflineplus">+  if (docShellAsItem) {</span>
<a href="#l11.389"></a><span id="l11.389">     nsCOMPtr&lt;nsIDocShellTreeItem&gt; rootAsItem;</span>
<a href="#l11.390"></a><span id="l11.390">     docShellAsItem-&gt;GetSameTypeRootTreeItem(getter_AddRefs(rootAsItem));</span>
<a href="#l11.391"></a><span id="l11.391"> </span>
<a href="#l11.392"></a><span id="l11.392">     nsCOMPtr&lt;nsIDocShell&gt; rootAsShell(do_QueryInterface(rootAsItem));</span>
<a href="#l11.393"></a><span id="l11.393">     SetRootDocShell(rootAsShell);</span>
<a href="#l11.394"></a><span id="l11.394"> </span>
<a href="#l11.395"></a><span id="l11.395">     // force ourselves to figure out the message pane</span>
<a href="#l11.396"></a><span id="l11.396">     nsCOMPtr&lt;nsIDocShell&gt; messageWindowDocShell;</span>
<a href="#l11.397"></a><span id="l11.397">     GetMessageWindowDocShell(getter_AddRefs(messageWindowDocShell));</span>
<a href="#l11.398"></a><span id="l11.398">   }</span>
<a href="#l11.399"></a><span id="l11.399"> </span>
<a href="#l11.400"></a><span id="l11.400">   return NS_OK;</span>
<a href="#l11.401"></a><span id="l11.401"> }</span>
<a href="#l11.402"></a><span id="l11.402"> </span>
<a href="#l11.403"></a><span id="l11.403" class="difflineminus">-NS_IMETHODIMP nsMsgWindow::SetNotificationCallbacks(nsIInterfaceRequestor * aNotificationCallbacks)</span>
<a href="#l11.404"></a><span id="l11.404" class="difflineminus">-{</span>
<a href="#l11.405"></a><span id="l11.405" class="difflineplus">+NS_IMETHODIMP nsMsgWindow::SetNotificationCallbacks(</span>
<a href="#l11.406"></a><span id="l11.406" class="difflineplus">+    nsIInterfaceRequestor *aNotificationCallbacks) {</span>
<a href="#l11.407"></a><span id="l11.407">   mNotificationCallbacks = aNotificationCallbacks;</span>
<a href="#l11.408"></a><span id="l11.408">   return NS_OK;</span>
<a href="#l11.409"></a><span id="l11.409"> }</span>
<a href="#l11.410"></a><span id="l11.410"> </span>
<a href="#l11.411"></a><span id="l11.411" class="difflineminus">-NS_IMETHODIMP nsMsgWindow::GetNotificationCallbacks(nsIInterfaceRequestor **aNotificationCallbacks)</span>
<a href="#l11.412"></a><span id="l11.412" class="difflineminus">-{</span>
<a href="#l11.413"></a><span id="l11.413" class="difflineplus">+NS_IMETHODIMP nsMsgWindow::GetNotificationCallbacks(</span>
<a href="#l11.414"></a><span id="l11.414" class="difflineplus">+    nsIInterfaceRequestor **aNotificationCallbacks) {</span>
<a href="#l11.415"></a><span id="l11.415">   NS_ENSURE_ARG_POINTER(aNotificationCallbacks);</span>
<a href="#l11.416"></a><span id="l11.416">   NS_IF_ADDREF(*aNotificationCallbacks = mNotificationCallbacks);</span>
<a href="#l11.417"></a><span id="l11.417">   return NS_OK;</span>
<a href="#l11.418"></a><span id="l11.418"> }</span>
<a href="#l11.419"></a><span id="l11.419"> </span>
<a href="#l11.420"></a><span id="l11.420" class="difflineminus">-NS_IMETHODIMP nsMsgWindow::StopUrls()</span>
<a href="#l11.421"></a><span id="l11.421" class="difflineminus">-{</span>
<a href="#l11.422"></a><span id="l11.422" class="difflineplus">+NS_IMETHODIMP nsMsgWindow::StopUrls() {</span>
<a href="#l11.423"></a><span id="l11.423">   m_stopped = true;</span>
<a href="#l11.424"></a><span id="l11.424">   nsCOMPtr&lt;nsIWebNavigation&gt; webnav(do_QueryReferent(mRootDocShellWeak));</span>
<a href="#l11.425"></a><span id="l11.425" class="difflineminus">-  return webnav ? webnav-&gt;Stop(nsIWebNavigation::STOP_NETWORK) : NS_ERROR_FAILURE;</span>
<a href="#l11.426"></a><span id="l11.426" class="difflineplus">+  return webnav ? webnav-&gt;Stop(nsIWebNavigation::STOP_NETWORK)</span>
<a href="#l11.427"></a><span id="l11.427" class="difflineplus">+                : NS_ERROR_FAILURE;</span>
<a href="#l11.428"></a><span id="l11.428"> }</span>
<a href="#l11.429"></a><span id="l11.429"> </span>
<a href="#l11.430"></a><span id="l11.430"> // nsIURIContentListener support</span>
<a href="#l11.431"></a><span id="l11.431" class="difflineminus">-NS_IMETHODIMP nsMsgWindow::OnStartURIOpen(nsIURI* aURI, bool* aAbortOpen)</span>
<a href="#l11.432"></a><span id="l11.432" class="difflineminus">-{</span>
<a href="#l11.433"></a><span id="l11.433" class="difflineplus">+NS_IMETHODIMP nsMsgWindow::OnStartURIOpen(nsIURI *aURI, bool *aAbortOpen) {</span>
<a href="#l11.434"></a><span id="l11.434">   return NS_OK;</span>
<a href="#l11.435"></a><span id="l11.435"> }</span>
<a href="#l11.436"></a><span id="l11.436"> </span>
<a href="#l11.437"></a><span id="l11.437" class="difflineminus">-NS_IMETHODIMP nsMsgWindow::DoContent(const nsACString&amp; aContentType, bool aIsContentPreferred,</span>
<a href="#l11.438"></a><span id="l11.438" class="difflineminus">-                                     nsIRequest *request, nsIStreamListener **aContentHandler, bool *aAbortProcess)</span>
<a href="#l11.439"></a><span id="l11.439" class="difflineminus">-{</span>
<a href="#l11.440"></a><span id="l11.440" class="difflineminus">-  if (!aContentType.IsEmpty())</span>
<a href="#l11.441"></a><span id="l11.441" class="difflineminus">-  {</span>
<a href="#l11.442"></a><span id="l11.442" class="difflineplus">+NS_IMETHODIMP nsMsgWindow::DoContent(const nsACString &amp;aContentType,</span>
<a href="#l11.443"></a><span id="l11.443" class="difflineplus">+                                     bool aIsContentPreferred,</span>
<a href="#l11.444"></a><span id="l11.444" class="difflineplus">+                                     nsIRequest *request,</span>
<a href="#l11.445"></a><span id="l11.445" class="difflineplus">+                                     nsIStreamListener **aContentHandler,</span>
<a href="#l11.446"></a><span id="l11.446" class="difflineplus">+                                     bool *aAbortProcess) {</span>
<a href="#l11.447"></a><span id="l11.447" class="difflineplus">+  if (!aContentType.IsEmpty()) {</span>
<a href="#l11.448"></a><span id="l11.448">     // forward the DoContent call to our docshell</span>
<a href="#l11.449"></a><span id="l11.449">     nsCOMPtr&lt;nsIDocShell&gt; messageWindowDocShell;</span>
<a href="#l11.450"></a><span id="l11.450">     GetMessageWindowDocShell(getter_AddRefs(messageWindowDocShell));</span>
<a href="#l11.451"></a><span id="l11.451" class="difflineminus">-    nsCOMPtr&lt;nsIURIContentListener&gt; ctnListener = do_QueryInterface(messageWindowDocShell);</span>
<a href="#l11.452"></a><span id="l11.452" class="difflineminus">-    if (ctnListener)</span>
<a href="#l11.453"></a><span id="l11.453" class="difflineminus">-    {</span>
<a href="#l11.454"></a><span id="l11.454" class="difflineminus">-        nsCOMPtr&lt;nsIChannel&gt; aChannel = do_QueryInterface(request);</span>
<a href="#l11.455"></a><span id="l11.455" class="difflineminus">-        if (!aChannel) return NS_ERROR_FAILURE;</span>
<a href="#l11.456"></a><span id="l11.456" class="difflineplus">+    nsCOMPtr&lt;nsIURIContentListener&gt; ctnListener =</span>
<a href="#l11.457"></a><span id="l11.457" class="difflineplus">+        do_QueryInterface(messageWindowDocShell);</span>
<a href="#l11.458"></a><span id="l11.458" class="difflineplus">+    if (ctnListener) {</span>
<a href="#l11.459"></a><span id="l11.459" class="difflineplus">+      nsCOMPtr&lt;nsIChannel&gt; aChannel = do_QueryInterface(request);</span>
<a href="#l11.460"></a><span id="l11.460" class="difflineplus">+      if (!aChannel) return NS_ERROR_FAILURE;</span>
<a href="#l11.461"></a><span id="l11.461"> </span>
<a href="#l11.462"></a><span id="l11.462" class="difflineminus">-      // get the url for the channel...let's hope it is a mailnews url so we can set our msg hdr sink on it..</span>
<a href="#l11.463"></a><span id="l11.463" class="difflineminus">-      // right now, this is the only way I can think of to force the msg hdr sink into the mime converter so it can</span>
<a href="#l11.464"></a><span id="l11.464" class="difflineplus">+      // get the url for the channel...let's hope it is a mailnews url so we can</span>
<a href="#l11.465"></a><span id="l11.465" class="difflineplus">+      // set our msg hdr sink on it.. right now, this is the only way I can</span>
<a href="#l11.466"></a><span id="l11.466" class="difflineplus">+      // think of to force the msg hdr sink into the mime converter so it can</span>
<a href="#l11.467"></a><span id="l11.467">       // get too it later...</span>
<a href="#l11.468"></a><span id="l11.468">       nsCOMPtr&lt;nsIURI&gt; uri;</span>
<a href="#l11.469"></a><span id="l11.469">       aChannel-&gt;GetURI(getter_AddRefs(uri));</span>
<a href="#l11.470"></a><span id="l11.470" class="difflineminus">-      if (uri)</span>
<a href="#l11.471"></a><span id="l11.471" class="difflineminus">-      {</span>
<a href="#l11.472"></a><span id="l11.472" class="difflineplus">+      if (uri) {</span>
<a href="#l11.473"></a><span id="l11.473">         nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl(do_QueryInterface(uri));</span>
<a href="#l11.474"></a><span id="l11.474" class="difflineminus">-        if (mailnewsUrl)</span>
<a href="#l11.475"></a><span id="l11.475" class="difflineminus">-          mailnewsUrl-&gt;SetMsgWindow(this);</span>
<a href="#l11.476"></a><span id="l11.476" class="difflineplus">+        if (mailnewsUrl) mailnewsUrl-&gt;SetMsgWindow(this);</span>
<a href="#l11.477"></a><span id="l11.477">       }</span>
<a href="#l11.478"></a><span id="l11.478" class="difflineminus">-      return ctnListener-&gt;DoContent(aContentType, aIsContentPreferred, request, aContentHandler, aAbortProcess);</span>
<a href="#l11.479"></a><span id="l11.479" class="difflineplus">+      return ctnListener-&gt;DoContent(aContentType, aIsContentPreferred, request,</span>
<a href="#l11.480"></a><span id="l11.480" class="difflineplus">+                                    aContentHandler, aAbortProcess);</span>
<a href="#l11.481"></a><span id="l11.481">     }</span>
<a href="#l11.482"></a><span id="l11.482">   }</span>
<a href="#l11.483"></a><span id="l11.483">   return NS_OK;</span>
<a href="#l11.484"></a><span id="l11.484"> }</span>
<a href="#l11.485"></a><span id="l11.485"> </span>
<a href="#l11.486"></a><span id="l11.486"> NS_IMETHODIMP</span>
<a href="#l11.487"></a><span id="l11.487" class="difflineminus">-nsMsgWindow::IsPreferred(const char * aContentType,</span>
<a href="#l11.488"></a><span id="l11.488" class="difflineminus">-                         char ** aDesiredContentType,</span>
<a href="#l11.489"></a><span id="l11.489" class="difflineminus">-                         bool * aCanHandleContent)</span>
<a href="#l11.490"></a><span id="l11.490" class="difflineminus">-{</span>
<a href="#l11.491"></a><span id="l11.491" class="difflineplus">+nsMsgWindow::IsPreferred(const char *aContentType, char **aDesiredContentType,</span>
<a href="#l11.492"></a><span id="l11.492" class="difflineplus">+                         bool *aCanHandleContent) {</span>
<a href="#l11.493"></a><span id="l11.493">   *aCanHandleContent = false;</span>
<a href="#l11.494"></a><span id="l11.494">   return NS_OK;</span>
<a href="#l11.495"></a><span id="l11.495"> }</span>
<a href="#l11.496"></a><span id="l11.496"> </span>
<a href="#l11.497"></a><span id="l11.497" class="difflineminus">-NS_IMETHODIMP nsMsgWindow::CanHandleContent(const char * aContentType,</span>
<a href="#l11.498"></a><span id="l11.498" class="difflineplus">+NS_IMETHODIMP nsMsgWindow::CanHandleContent(const char *aContentType,</span>
<a href="#l11.499"></a><span id="l11.499">                                             bool aIsContentPreferred,</span>
<a href="#l11.500"></a><span id="l11.500" class="difflineminus">-                                            char ** aDesiredContentType,</span>
<a href="#l11.501"></a><span id="l11.501" class="difflineminus">-                                            bool * aCanHandleContent)</span>
<a href="#l11.502"></a><span id="l11.502" class="difflineplus">+                                            char **aDesiredContentType,</span>
<a href="#l11.503"></a><span id="l11.503" class="difflineplus">+                                            bool *aCanHandleContent)</span>
<a href="#l11.504"></a><span id="l11.504"> </span>
<a href="#l11.505"></a><span id="l11.505"> {</span>
<a href="#l11.506"></a><span id="l11.506">   // the mail window knows nothing about the default content types</span>
<a href="#l11.507"></a><span id="l11.507">   // its docshell can handle...ask the content area if it can handle</span>
<a href="#l11.508"></a><span id="l11.508">   // the content type...</span>
<a href="#l11.509"></a><span id="l11.509"> </span>
<a href="#l11.510"></a><span id="l11.510">   nsCOMPtr&lt;nsIDocShell&gt; messageWindowDocShell;</span>
<a href="#l11.511"></a><span id="l11.511">   GetMessageWindowDocShell(getter_AddRefs(messageWindowDocShell));</span>
<a href="#l11.512"></a><span id="l11.512" class="difflineminus">-  nsCOMPtr&lt;nsIURIContentListener&gt; ctnListener (do_GetInterface(messageWindowDocShell));</span>
<a href="#l11.513"></a><span id="l11.513" class="difflineplus">+  nsCOMPtr&lt;nsIURIContentListener&gt; ctnListener(</span>
<a href="#l11.514"></a><span id="l11.514" class="difflineplus">+      do_GetInterface(messageWindowDocShell));</span>
<a href="#l11.515"></a><span id="l11.515">   if (ctnListener)</span>
<a href="#l11.516"></a><span id="l11.516">     return ctnListener-&gt;CanHandleContent(aContentType, aIsContentPreferred,</span>
<a href="#l11.517"></a><span id="l11.517" class="difflineminus">-                                         aDesiredContentType, aCanHandleContent);</span>
<a href="#l11.518"></a><span id="l11.518" class="difflineplus">+                                         aDesiredContentType,</span>
<a href="#l11.519"></a><span id="l11.519" class="difflineplus">+                                         aCanHandleContent);</span>
<a href="#l11.520"></a><span id="l11.520">   else</span>
<a href="#l11.521"></a><span id="l11.521">     *aCanHandleContent = false;</span>
<a href="#l11.522"></a><span id="l11.522">   return NS_OK;</span>
<a href="#l11.523"></a><span id="l11.523"> }</span>
<a href="#l11.524"></a><span id="l11.524"> </span>
<a href="#l11.525"></a><span id="l11.525" class="difflineminus">-NS_IMETHODIMP nsMsgWindow::GetParentContentListener(nsIURIContentListener** aParent)</span>
<a href="#l11.526"></a><span id="l11.526" class="difflineminus">-{</span>
<a href="#l11.527"></a><span id="l11.527" class="difflineplus">+NS_IMETHODIMP nsMsgWindow::GetParentContentListener(</span>
<a href="#l11.528"></a><span id="l11.528" class="difflineplus">+    nsIURIContentListener **aParent) {</span>
<a href="#l11.529"></a><span id="l11.529">   NS_ENSURE_ARG_POINTER(aParent);</span>
<a href="#l11.530"></a><span id="l11.530">   *aParent = nullptr;</span>
<a href="#l11.531"></a><span id="l11.531">   return NS_OK;</span>
<a href="#l11.532"></a><span id="l11.532"> }</span>
<a href="#l11.533"></a><span id="l11.533"> </span>
<a href="#l11.534"></a><span id="l11.534" class="difflineminus">-NS_IMETHODIMP nsMsgWindow::SetParentContentListener(nsIURIContentListener* aParent)</span>
<a href="#l11.535"></a><span id="l11.535" class="difflineminus">-{</span>
<a href="#l11.536"></a><span id="l11.536" class="difflineplus">+NS_IMETHODIMP nsMsgWindow::SetParentContentListener(</span>
<a href="#l11.537"></a><span id="l11.537" class="difflineplus">+    nsIURIContentListener *aParent) {</span>
<a href="#l11.538"></a><span id="l11.538">   return NS_OK;</span>
<a href="#l11.539"></a><span id="l11.539"> }</span>
<a href="#l11.540"></a><span id="l11.540"> </span>
<a href="#l11.541"></a><span id="l11.541" class="difflineminus">-NS_IMETHODIMP nsMsgWindow::GetLoadCookie(nsISupports ** aLoadCookie)</span>
<a href="#l11.542"></a><span id="l11.542" class="difflineminus">-{</span>
<a href="#l11.543"></a><span id="l11.543" class="difflineplus">+NS_IMETHODIMP nsMsgWindow::GetLoadCookie(nsISupports **aLoadCookie) {</span>
<a href="#l11.544"></a><span id="l11.544">   NS_ENSURE_ARG_POINTER(aLoadCookie);</span>
<a href="#l11.545"></a><span id="l11.545">   *aLoadCookie = nullptr;</span>
<a href="#l11.546"></a><span id="l11.546">   return NS_OK;</span>
<a href="#l11.547"></a><span id="l11.547"> }</span>
<a href="#l11.548"></a><span id="l11.548"> </span>
<a href="#l11.549"></a><span id="l11.549" class="difflineminus">-NS_IMETHODIMP nsMsgWindow::SetLoadCookie(nsISupports * aLoadCookie)</span>
<a href="#l11.550"></a><span id="l11.550" class="difflineminus">-{</span>
<a href="#l11.551"></a><span id="l11.551" class="difflineplus">+NS_IMETHODIMP nsMsgWindow::SetLoadCookie(nsISupports *aLoadCookie) {</span>
<a href="#l11.552"></a><span id="l11.552">   return NS_OK;</span>
<a href="#l11.553"></a><span id="l11.553"> }</span>
<a href="#l11.554"></a><span id="l11.554"> </span>
<a href="#l11.555"></a><span id="l11.555" class="difflineminus">-NS_IMETHODIMP nsMsgWindow::GetPromptDialog(nsIPrompt **aPrompt)</span>
<a href="#l11.556"></a><span id="l11.556" class="difflineminus">-{</span>
<a href="#l11.557"></a><span id="l11.557" class="difflineplus">+NS_IMETHODIMP nsMsgWindow::GetPromptDialog(nsIPrompt **aPrompt) {</span>
<a href="#l11.558"></a><span id="l11.558">   NS_ENSURE_ARG_POINTER(aPrompt);</span>
<a href="#l11.559"></a><span id="l11.559"> </span>
<a href="#l11.560"></a><span id="l11.560">   // testing only</span>
<a href="#l11.561"></a><span id="l11.561" class="difflineminus">-  if (mPromptDialog)</span>
<a href="#l11.562"></a><span id="l11.562" class="difflineminus">-  {</span>
<a href="#l11.563"></a><span id="l11.563" class="difflineplus">+  if (mPromptDialog) {</span>
<a href="#l11.564"></a><span id="l11.564">     NS_ADDREF(*aPrompt = mPromptDialog);</span>
<a href="#l11.565"></a><span id="l11.565">     return NS_OK;</span>
<a href="#l11.566"></a><span id="l11.566">   }</span>
<a href="#l11.567"></a><span id="l11.567"> </span>
<a href="#l11.568"></a><span id="l11.568">   nsresult rv;</span>
<a href="#l11.569"></a><span id="l11.569">   nsCOMPtr&lt;nsIDocShell&gt; rootShell(do_QueryReferent(mRootDocShellWeak, &amp;rv));</span>
<a href="#l11.570"></a><span id="l11.570" class="difflineminus">-  if (rootShell)</span>
<a href="#l11.571"></a><span id="l11.571" class="difflineminus">-  {</span>
<a href="#l11.572"></a><span id="l11.572" class="difflineplus">+  if (rootShell) {</span>
<a href="#l11.573"></a><span id="l11.573">     nsCOMPtr&lt;nsIPrompt&gt; dialog;</span>
<a href="#l11.574"></a><span id="l11.574">     dialog = do_GetInterface(rootShell, &amp;rv);</span>
<a href="#l11.575"></a><span id="l11.575">     dialog.forget(aPrompt);</span>
<a href="#l11.576"></a><span id="l11.576">   }</span>
<a href="#l11.577"></a><span id="l11.577">   return rv;</span>
<a href="#l11.578"></a><span id="l11.578"> }</span>
<a href="#l11.579"></a><span id="l11.579"> </span>
<a href="#l11.580"></a><span id="l11.580" class="difflineminus">-NS_IMETHODIMP nsMsgWindow::SetPromptDialog(nsIPrompt* aPromptDialog)</span>
<a href="#l11.581"></a><span id="l11.581" class="difflineminus">-{</span>
<a href="#l11.582"></a><span id="l11.582" class="difflineplus">+NS_IMETHODIMP nsMsgWindow::SetPromptDialog(nsIPrompt *aPromptDialog) {</span>
<a href="#l11.583"></a><span id="l11.583">   mPromptDialog = aPromptDialog;</span>
<a href="#l11.584"></a><span id="l11.584">   return NS_OK;</span>
<a href="#l11.585"></a><span id="l11.585"> }</span>
<a href="#l11.586"></a><span id="l11.586"> </span>
<a href="#l11.587"></a><span id="l11.587"> NS_IMETHODIMP</span>
<a href="#l11.588"></a><span id="l11.588" class="difflineminus">-nsMsgWindow::DisplayURIInMessagePane(const nsAString&amp; uri, bool clearMsgHdr, nsIPrincipal *principal)</span>
<a href="#l11.589"></a><span id="l11.589" class="difflineminus">-{</span>
<a href="#l11.590"></a><span id="l11.590" class="difflineminus">-  if (clearMsgHdr &amp;&amp; mMsgWindowCommands)</span>
<a href="#l11.591"></a><span id="l11.591" class="difflineminus">-    mMsgWindowCommands-&gt;ClearMsgPane();</span>
<a href="#l11.592"></a><span id="l11.592" class="difflineplus">+nsMsgWindow::DisplayURIInMessagePane(const nsAString &amp;uri, bool clearMsgHdr,</span>
<a href="#l11.593"></a><span id="l11.593" class="difflineplus">+                                     nsIPrincipal *principal) {</span>
<a href="#l11.594"></a><span id="l11.594" class="difflineplus">+  if (clearMsgHdr &amp;&amp; mMsgWindowCommands) mMsgWindowCommands-&gt;ClearMsgPane();</span>
<a href="#l11.595"></a><span id="l11.595"> </span>
<a href="#l11.596"></a><span id="l11.596" class="difflineminus">-  nsCOMPtr &lt;nsIDocShell&gt; docShell;</span>
<a href="#l11.597"></a><span id="l11.597" class="difflineplus">+  nsCOMPtr&lt;nsIDocShell&gt; docShell;</span>
<a href="#l11.598"></a><span id="l11.598">   GetMessageWindowDocShell(getter_AddRefs(docShell));</span>
<a href="#l11.599"></a><span id="l11.599">   NS_ENSURE_TRUE(docShell, NS_ERROR_FAILURE);</span>
<a href="#l11.600"></a><span id="l11.600"> </span>
<a href="#l11.601"></a><span id="l11.601">   nsCOMPtr&lt;nsIWebNavigation&gt; webNav(do_QueryInterface(docShell));</span>
<a href="#l11.602"></a><span id="l11.602">   NS_ENSURE_TRUE(webNav, NS_ERROR_FAILURE);</span>
<a href="#l11.603"></a><span id="l11.603"> </span>
<a href="#l11.604"></a><span id="l11.604">   mozilla::dom::LoadURIOptions loadURIOptions;</span>
<a href="#l11.605"></a><span id="l11.605">   loadURIOptions.mTriggeringPrincipal = principal;</span>
<a href="#l11.606"></a><span id="l11.606">   return webNav-&gt;LoadURI(uri, loadURIOptions);</span>
<a href="#l11.607"></a><span id="l11.607"> }</span>
<a href="#l11.608"></a><span id="l11.608"> </span>
<a href="#l11.609"></a><span id="l11.609"> NS_IMETHODIMP</span>
<a href="#l11.610"></a><span id="l11.610" class="difflineminus">-nsMsgWindow::DisplayHTMLInMessagePane(const nsAString&amp; title, const nsAString&amp; body, bool clearMsgHdr)</span>
<a href="#l11.611"></a><span id="l11.611" class="difflineminus">-{</span>
<a href="#l11.612"></a><span id="l11.612" class="difflineplus">+nsMsgWindow::DisplayHTMLInMessagePane(const nsAString &amp;title,</span>
<a href="#l11.613"></a><span id="l11.613" class="difflineplus">+                                      const nsAString &amp;body, bool clearMsgHdr) {</span>
<a href="#l11.614"></a><span id="l11.614">   nsString htmlStr;</span>
<a href="#l11.615"></a><span id="l11.615" class="difflineminus">-  htmlStr.AppendLiteral(u&quot;&lt;html&gt;&lt;head&gt;&lt;meta http-equiv=\&quot;Content-Type\&quot; content=\&quot;text/html; charset=UTF-8\&quot;&gt;&lt;/head&gt;&lt;body&gt;&quot;);</span>
<a href="#l11.616"></a><span id="l11.616" class="difflineplus">+  htmlStr.AppendLiteral(</span>
<a href="#l11.617"></a><span id="l11.617" class="difflineplus">+      u&quot;&lt;html&gt;&lt;head&gt;&lt;meta http-equiv=\&quot;Content-Type\&quot; content=\&quot;text/html; &quot;</span>
<a href="#l11.618"></a><span id="l11.618" class="difflineplus">+      u&quot;charset=UTF-8\&quot;&gt;&lt;/head&gt;&lt;body&gt;&quot;);</span>
<a href="#l11.619"></a><span id="l11.619">   htmlStr.Append(body);</span>
<a href="#l11.620"></a><span id="l11.620">   htmlStr.AppendLiteral(u&quot;&lt;/body&gt;&lt;/html&gt;&quot;);</span>
<a href="#l11.621"></a><span id="l11.621"> </span>
<a href="#l11.622"></a><span id="l11.622" class="difflineminus">-  char *encodedHtml = PL_Base64Encode(NS_ConvertUTF16toUTF8(htmlStr).get(), 0, nullptr);</span>
<a href="#l11.623"></a><span id="l11.623" class="difflineminus">-  if (!encodedHtml)</span>
<a href="#l11.624"></a><span id="l11.624" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l11.625"></a><span id="l11.625" class="difflineplus">+  char *encodedHtml =</span>
<a href="#l11.626"></a><span id="l11.626" class="difflineplus">+      PL_Base64Encode(NS_ConvertUTF16toUTF8(htmlStr).get(), 0, nullptr);</span>
<a href="#l11.627"></a><span id="l11.627" class="difflineplus">+  if (!encodedHtml) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l11.628"></a><span id="l11.628"> </span>
<a href="#l11.629"></a><span id="l11.629">   nsCString dataSpec;</span>
<a href="#l11.630"></a><span id="l11.630">   dataSpec = &quot;data:text/html;base64,&quot;;</span>
<a href="#l11.631"></a><span id="l11.631">   dataSpec += encodedHtml;</span>
<a href="#l11.632"></a><span id="l11.632"> </span>
<a href="#l11.633"></a><span id="l11.633">   PR_FREEIF(encodedHtml);</span>
<a href="#l11.634"></a><span id="l11.634"> </span>
<a href="#l11.635"></a><span id="l11.635" class="difflineminus">-  return DisplayURIInMessagePane(NS_ConvertASCIItoUTF16(dataSpec),</span>
<a href="#l11.636"></a><span id="l11.636" class="difflineminus">-                                 clearMsgHdr, nsContentUtils::GetSystemPrincipal());</span>
<a href="#l11.637"></a><span id="l11.637" class="difflineplus">+  return DisplayURIInMessagePane(NS_ConvertASCIItoUTF16(dataSpec), clearMsgHdr,</span>
<a href="#l11.638"></a><span id="l11.638" class="difflineplus">+                                 nsContentUtils::GetSystemPrincipal());</span>
<a href="#l11.639"></a><span id="l11.639"> }</span>
<a href="#l11.640"></a><span id="l11.640"> </span>
<a href="#l11.641"></a><span id="l11.641"> NS_IMPL_GETSET(nsMsgWindow, Stopped, bool, m_stopped)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/base/src/nsMsgWindow.h</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgWindow.h</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -16,30 +16,27 @@</span>
<a href="#l12.4"></a><span id="l12.4"> #include &quot;nsIMimeMiscStatus.h&quot;</span>
<a href="#l12.5"></a><span id="l12.5"> #include &quot;nsWeakReference.h&quot;</span>
<a href="#l12.6"></a><span id="l12.6"> #include &quot;nsIWeakReferenceUtils.h&quot;</span>
<a href="#l12.7"></a><span id="l12.7"> #include &quot;nsIInterfaceRequestor.h&quot;</span>
<a href="#l12.8"></a><span id="l12.8"> </span>
<a href="#l12.9"></a><span id="l12.9"> class nsMsgWindow : public nsIMsgWindow,</span>
<a href="#l12.10"></a><span id="l12.10">                     public nsIURIContentListener,</span>
<a href="#l12.11"></a><span id="l12.11">                     public nsIMsgWindowTest,</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-                    public nsSupportsWeakReference</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">-{</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineminus">-</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineminus">-public:</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineminus">-</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineplus">+                    public nsSupportsWeakReference {</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineplus">+ public:</span>
<a href="#l12.19"></a><span id="l12.19">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l12.20"></a><span id="l12.20"> </span>
<a href="#l12.21"></a><span id="l12.21">   nsMsgWindow();</span>
<a href="#l12.22"></a><span id="l12.22">   nsresult Init();</span>
<a href="#l12.23"></a><span id="l12.23">   NS_DECL_NSIMSGWINDOW</span>
<a href="#l12.24"></a><span id="l12.24">   NS_DECL_NSIURICONTENTLISTENER</span>
<a href="#l12.25"></a><span id="l12.25">   NS_DECL_NSIMSGWINDOWTEST</span>
<a href="#l12.26"></a><span id="l12.26"> </span>
<a href="#l12.27"></a><span id="l12.27" class="difflineminus">-protected:</span>
<a href="#l12.28"></a><span id="l12.28" class="difflineplus">+ protected:</span>
<a href="#l12.29"></a><span id="l12.29">   virtual ~nsMsgWindow();</span>
<a href="#l12.30"></a><span id="l12.30">   nsCOMPtr&lt;nsIMsgHeaderSink&gt; mMsgHeaderSink;</span>
<a href="#l12.31"></a><span id="l12.31">   nsCOMPtr&lt;nsIMsgStatusFeedback&gt; mStatusFeedback;</span>
<a href="#l12.32"></a><span id="l12.32">   nsCOMPtr&lt;nsITransactionManager&gt; mTransactionManager;</span>
<a href="#l12.33"></a><span id="l12.33">   nsCOMPtr&lt;nsIMsgFolder&gt; mOpenFolder;</span>
<a href="#l12.34"></a><span id="l12.34">   nsCOMPtr&lt;nsIMsgWindowCommands&gt; mMsgWindowCommands;</span>
<a href="#l12.35"></a><span id="l12.35">   // These are used by the backend protocol code to attach</span>
<a href="#l12.36"></a><span id="l12.36">   // notification callbacks to channels, e.g., nsIBadCertListner2.</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineat">@@ -50,13 +47,13 @@ protected:</span>
<a href="#l12.38"></a><span id="l12.38">   nsCOMPtr&lt;nsIAuthPrompt&gt; mAuthPrompt;</span>
<a href="#l12.39"></a><span id="l12.39"> </span>
<a href="#l12.40"></a><span id="l12.40">   // let's not make this a strong ref - we don't own it.</span>
<a href="#l12.41"></a><span id="l12.41">   nsWeakPtr mRootDocShellWeak;</span>
<a href="#l12.42"></a><span id="l12.42">   nsWeakPtr mMessageWindowDocShellWeak;</span>
<a href="#l12.43"></a><span id="l12.43">   nsWeakPtr mDomWindow;</span>
<a href="#l12.44"></a><span id="l12.44"> </span>
<a href="#l12.45"></a><span id="l12.45">   nsCString mMailCharacterSet;</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineminus">-  bool      mCharsetOverride;</span>
<a href="#l12.47"></a><span id="l12.47" class="difflineminus">-  bool      m_stopped;</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineplus">+  bool mCharsetOverride;</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineplus">+  bool m_stopped;</span>
<a href="#l12.50"></a><span id="l12.50"> };</span>
<a href="#l12.51"></a><span id="l12.51"> </span>
<a href="#l12.52"></a><span id="l12.52"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/base/src/nsMsgXFViewThread.cpp</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgXFViewThread.cpp</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -6,539 +6,443 @@</span>
<a href="#l13.4"></a><span id="l13.4"> #include &quot;msgCore.h&quot;</span>
<a href="#l13.5"></a><span id="l13.5"> #include &quot;nsMsgXFViewThread.h&quot;</span>
<a href="#l13.6"></a><span id="l13.6"> #include &quot;nsMsgSearchDBView.h&quot;</span>
<a href="#l13.7"></a><span id="l13.7"> #include &quot;nsMsgMessageFlags.h&quot;</span>
<a href="#l13.8"></a><span id="l13.8"> </span>
<a href="#l13.9"></a><span id="l13.9"> NS_IMPL_ISUPPORTS(nsMsgXFViewThread, nsIMsgThread)</span>
<a href="#l13.10"></a><span id="l13.10"> </span>
<a href="#l13.11"></a><span id="l13.11"> nsMsgXFViewThread::nsMsgXFViewThread(nsMsgSearchDBView *view,</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-                                     nsMsgKey threadId)</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-{</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+                                     nsMsgKey threadId) {</span>
<a href="#l13.15"></a><span id="l13.15">   m_numUnreadChildren = 0;</span>
<a href="#l13.16"></a><span id="l13.16">   m_numChildren = 0;</span>
<a href="#l13.17"></a><span id="l13.17">   m_flags = 0;</span>
<a href="#l13.18"></a><span id="l13.18">   m_newestMsgDate = 0;</span>
<a href="#l13.19"></a><span id="l13.19">   m_view = view;</span>
<a href="#l13.20"></a><span id="l13.20">   m_threadId = threadId;</span>
<a href="#l13.21"></a><span id="l13.21"> }</span>
<a href="#l13.22"></a><span id="l13.22"> </span>
<a href="#l13.23"></a><span id="l13.23" class="difflineminus">-nsMsgXFViewThread::~nsMsgXFViewThread()</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineminus">-{</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineminus">-}</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineplus">+nsMsgXFViewThread::~nsMsgXFViewThread() {}</span>
<a href="#l13.27"></a><span id="l13.27"> </span>
<a href="#l13.28"></a><span id="l13.28"> NS_IMETHODIMP</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineminus">-nsMsgXFViewThread::SetThreadKey(nsMsgKey threadKey)</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineminus">-{</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineplus">+nsMsgXFViewThread::SetThreadKey(nsMsgKey threadKey) {</span>
<a href="#l13.32"></a><span id="l13.32">   m_threadId = threadKey;</span>
<a href="#l13.33"></a><span id="l13.33">   return NS_OK;</span>
<a href="#l13.34"></a><span id="l13.34"> }</span>
<a href="#l13.35"></a><span id="l13.35"> </span>
<a href="#l13.36"></a><span id="l13.36"> NS_IMETHODIMP</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineminus">-nsMsgXFViewThread::GetThreadKey(nsMsgKey *aResult)</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineminus">-{</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineplus">+nsMsgXFViewThread::GetThreadKey(nsMsgKey *aResult) {</span>
<a href="#l13.40"></a><span id="l13.40">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l13.41"></a><span id="l13.41">   *aResult = m_threadId;</span>
<a href="#l13.42"></a><span id="l13.42">   return NS_OK;</span>
<a href="#l13.43"></a><span id="l13.43"> }</span>
<a href="#l13.44"></a><span id="l13.44"> </span>
<a href="#l13.45"></a><span id="l13.45"> NS_IMETHODIMP</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineminus">-nsMsgXFViewThread::GetFlags(uint32_t *aFlags)</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineminus">-{</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineplus">+nsMsgXFViewThread::GetFlags(uint32_t *aFlags) {</span>
<a href="#l13.49"></a><span id="l13.49">   NS_ENSURE_ARG_POINTER(aFlags);</span>
<a href="#l13.50"></a><span id="l13.50">   *aFlags = m_flags;</span>
<a href="#l13.51"></a><span id="l13.51">   return NS_OK;</span>
<a href="#l13.52"></a><span id="l13.52"> }</span>
<a href="#l13.53"></a><span id="l13.53"> </span>
<a href="#l13.54"></a><span id="l13.54"> NS_IMETHODIMP</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineminus">-nsMsgXFViewThread::SetFlags(uint32_t aFlags)</span>
<a href="#l13.56"></a><span id="l13.56" class="difflineminus">-{</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineplus">+nsMsgXFViewThread::SetFlags(uint32_t aFlags) {</span>
<a href="#l13.58"></a><span id="l13.58">   m_flags = aFlags;</span>
<a href="#l13.59"></a><span id="l13.59">   return NS_OK;</span>
<a href="#l13.60"></a><span id="l13.60"> }</span>
<a href="#l13.61"></a><span id="l13.61"> </span>
<a href="#l13.62"></a><span id="l13.62"> NS_IMETHODIMP</span>
<a href="#l13.63"></a><span id="l13.63" class="difflineminus">-nsMsgXFViewThread::SetSubject(const nsACString&amp; aSubject)</span>
<a href="#l13.64"></a><span id="l13.64" class="difflineminus">-{</span>
<a href="#l13.65"></a><span id="l13.65" class="difflineplus">+nsMsgXFViewThread::SetSubject(const nsACString &amp;aSubject) {</span>
<a href="#l13.66"></a><span id="l13.66">   NS_ASSERTION(false, &quot;shouldn't call this&quot;);</span>
<a href="#l13.67"></a><span id="l13.67">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l13.68"></a><span id="l13.68"> }</span>
<a href="#l13.69"></a><span id="l13.69"> </span>
<a href="#l13.70"></a><span id="l13.70"> NS_IMETHODIMP</span>
<a href="#l13.71"></a><span id="l13.71" class="difflineminus">-nsMsgXFViewThread::GetSubject(nsACString&amp; result)</span>
<a href="#l13.72"></a><span id="l13.72" class="difflineminus">-{</span>
<a href="#l13.73"></a><span id="l13.73" class="difflineplus">+nsMsgXFViewThread::GetSubject(nsACString &amp;result) {</span>
<a href="#l13.74"></a><span id="l13.74">   NS_ASSERTION(false, &quot;shouldn't call this&quot;);</span>
<a href="#l13.75"></a><span id="l13.75">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l13.76"></a><span id="l13.76"> }</span>
<a href="#l13.77"></a><span id="l13.77"> </span>
<a href="#l13.78"></a><span id="l13.78"> NS_IMETHODIMP</span>
<a href="#l13.79"></a><span id="l13.79" class="difflineminus">-nsMsgXFViewThread::GetNumChildren(uint32_t *aNumChildren)</span>
<a href="#l13.80"></a><span id="l13.80" class="difflineminus">-{</span>
<a href="#l13.81"></a><span id="l13.81" class="difflineplus">+nsMsgXFViewThread::GetNumChildren(uint32_t *aNumChildren) {</span>
<a href="#l13.82"></a><span id="l13.82">   NS_ENSURE_ARG_POINTER(aNumChildren);</span>
<a href="#l13.83"></a><span id="l13.83">   *aNumChildren = m_keys.Length();</span>
<a href="#l13.84"></a><span id="l13.84">   return NS_OK;</span>
<a href="#l13.85"></a><span id="l13.85"> }</span>
<a href="#l13.86"></a><span id="l13.86"> </span>
<a href="#l13.87"></a><span id="l13.87"> NS_IMETHODIMP</span>
<a href="#l13.88"></a><span id="l13.88" class="difflineminus">-nsMsgXFViewThread::GetNumUnreadChildren (uint32_t *aNumUnreadChildren)</span>
<a href="#l13.89"></a><span id="l13.89" class="difflineminus">-{</span>
<a href="#l13.90"></a><span id="l13.90" class="difflineplus">+nsMsgXFViewThread::GetNumUnreadChildren(uint32_t *aNumUnreadChildren) {</span>
<a href="#l13.91"></a><span id="l13.91">   NS_ENSURE_ARG_POINTER(aNumUnreadChildren);</span>
<a href="#l13.92"></a><span id="l13.92">   *aNumUnreadChildren = m_numUnreadChildren;</span>
<a href="#l13.93"></a><span id="l13.93">   return NS_OK;</span>
<a href="#l13.94"></a><span id="l13.94"> }</span>
<a href="#l13.95"></a><span id="l13.95"> </span>
<a href="#l13.96"></a><span id="l13.96"> NS_IMETHODIMP</span>
<a href="#l13.97"></a><span id="l13.97" class="difflineminus">-nsMsgXFViewThread::AddChild(nsIMsgDBHdr *aNewHdr,</span>
<a href="#l13.98"></a><span id="l13.98" class="difflineminus">-                            nsIMsgDBHdr *aInReplyTo,</span>
<a href="#l13.99"></a><span id="l13.99" class="difflineplus">+nsMsgXFViewThread::AddChild(nsIMsgDBHdr *aNewHdr, nsIMsgDBHdr *aInReplyTo,</span>
<a href="#l13.100"></a><span id="l13.100">                             bool aThreadInThread,</span>
<a href="#l13.101"></a><span id="l13.101" class="difflineminus">-                            nsIDBChangeAnnouncer *aAnnouncer)</span>
<a href="#l13.102"></a><span id="l13.102" class="difflineminus">-{</span>
<a href="#l13.103"></a><span id="l13.103" class="difflineplus">+                            nsIDBChangeAnnouncer *aAnnouncer) {</span>
<a href="#l13.104"></a><span id="l13.104">   uint32_t whereInserted;</span>
<a href="#l13.105"></a><span id="l13.105">   return AddHdr(aNewHdr, false, whereInserted, nullptr);</span>
<a href="#l13.106"></a><span id="l13.106"> }</span>
<a href="#l13.107"></a><span id="l13.107"> </span>
<a href="#l13.108"></a><span id="l13.108"> // Returns the parent of the newly added header. If reparentChildren</span>
<a href="#l13.109"></a><span id="l13.109"> // is true, we believe that the new header is a parent of an existing</span>
<a href="#l13.110"></a><span id="l13.110"> // header, and we should find it, and reparent it.</span>
<a href="#l13.111"></a><span id="l13.111" class="difflineminus">-nsresult</span>
<a href="#l13.112"></a><span id="l13.112" class="difflineminus">-nsMsgXFViewThread::AddHdr(nsIMsgDBHdr *newHdr,</span>
<a href="#l13.113"></a><span id="l13.113" class="difflineminus">-                          bool reparentChildren,</span>
<a href="#l13.114"></a><span id="l13.114" class="difflineminus">-                          uint32_t &amp;whereInserted,</span>
<a href="#l13.115"></a><span id="l13.115" class="difflineminus">-                          nsIMsgDBHdr **outParent)</span>
<a href="#l13.116"></a><span id="l13.116" class="difflineminus">-{</span>
<a href="#l13.117"></a><span id="l13.117" class="difflineplus">+nsresult nsMsgXFViewThread::AddHdr(nsIMsgDBHdr *newHdr, bool reparentChildren,</span>
<a href="#l13.118"></a><span id="l13.118" class="difflineplus">+                                   uint32_t &amp;whereInserted,</span>
<a href="#l13.119"></a><span id="l13.119" class="difflineplus">+                                   nsIMsgDBHdr **outParent) {</span>
<a href="#l13.120"></a><span id="l13.120">   nsCOMPtr&lt;nsIMsgFolder&gt; newHdrFolder;</span>
<a href="#l13.121"></a><span id="l13.121">   newHdr-&gt;GetFolder(getter_AddRefs(newHdrFolder));</span>
<a href="#l13.122"></a><span id="l13.122"> </span>
<a href="#l13.123"></a><span id="l13.123">   uint32_t newHdrFlags = 0;</span>
<a href="#l13.124"></a><span id="l13.124">   uint32_t msgDate;</span>
<a href="#l13.125"></a><span id="l13.125">   nsMsgKey newHdrKey = 0;</span>
<a href="#l13.126"></a><span id="l13.126"> </span>
<a href="#l13.127"></a><span id="l13.127">   newHdr-&gt;GetMessageKey(&amp;newHdrKey);</span>
<a href="#l13.128"></a><span id="l13.128">   newHdr-&gt;GetDateInSeconds(&amp;msgDate);</span>
<a href="#l13.129"></a><span id="l13.129">   newHdr-&gt;GetFlags(&amp;newHdrFlags);</span>
<a href="#l13.130"></a><span id="l13.130" class="difflineminus">-  if (msgDate &gt; m_newestMsgDate)</span>
<a href="#l13.131"></a><span id="l13.131" class="difflineminus">-    SetNewestMsgDate(msgDate);</span>
<a href="#l13.132"></a><span id="l13.132" class="difflineplus">+  if (msgDate &gt; m_newestMsgDate) SetNewestMsgDate(msgDate);</span>
<a href="#l13.133"></a><span id="l13.133"> </span>
<a href="#l13.134"></a><span id="l13.134">   if (newHdrFlags &amp; nsMsgMessageFlags::Watched)</span>
<a href="#l13.135"></a><span id="l13.135">     SetFlags(m_flags | nsMsgMessageFlags::Watched);</span>
<a href="#l13.136"></a><span id="l13.136"> </span>
<a href="#l13.137"></a><span id="l13.137">   ChangeChildCount(1);</span>
<a href="#l13.138"></a><span id="l13.138" class="difflineminus">-  if (! (newHdrFlags &amp; nsMsgMessageFlags::Read))</span>
<a href="#l13.139"></a><span id="l13.139" class="difflineminus">-    ChangeUnreadChildCount(1);</span>
<a href="#l13.140"></a><span id="l13.140" class="difflineplus">+  if (!(newHdrFlags &amp; nsMsgMessageFlags::Read)) ChangeUnreadChildCount(1);</span>
<a href="#l13.141"></a><span id="l13.141"> </span>
<a href="#l13.142"></a><span id="l13.142" class="difflineminus">-  if (m_numChildren == 1)</span>
<a href="#l13.143"></a><span id="l13.143" class="difflineminus">-  {</span>
<a href="#l13.144"></a><span id="l13.144" class="difflineplus">+  if (m_numChildren == 1) {</span>
<a href="#l13.145"></a><span id="l13.145">     m_keys.InsertElementAt(0, newHdrKey);</span>
<a href="#l13.146"></a><span id="l13.146">     m_levels.InsertElementAt(0, 0);</span>
<a href="#l13.147"></a><span id="l13.147">     m_folders.InsertObjectAt(newHdrFolder, 0);</span>
<a href="#l13.148"></a><span id="l13.148" class="difflineminus">-    if (outParent)</span>
<a href="#l13.149"></a><span id="l13.149" class="difflineminus">-      *outParent = nullptr;</span>
<a href="#l13.150"></a><span id="l13.150" class="difflineplus">+    if (outParent) *outParent = nullptr;</span>
<a href="#l13.151"></a><span id="l13.151"> </span>
<a href="#l13.152"></a><span id="l13.152">     whereInserted = 0;</span>
<a href="#l13.153"></a><span id="l13.153">     return NS_OK;</span>
<a href="#l13.154"></a><span id="l13.154">   }</span>
<a href="#l13.155"></a><span id="l13.155"> </span>
<a href="#l13.156"></a><span id="l13.156">   // Find our parent, if any, in the thread. Starting at the newest</span>
<a href="#l13.157"></a><span id="l13.157">   // reference, and working our way back, see if we've mapped that reference</span>
<a href="#l13.158"></a><span id="l13.158">   // to this thread.</span>
<a href="#l13.159"></a><span id="l13.159">   uint16_t numReferences;</span>
<a href="#l13.160"></a><span id="l13.160">   newHdr-&gt;GetNumReferences(&amp;numReferences);</span>
<a href="#l13.161"></a><span id="l13.161">   nsCOMPtr&lt;nsIMsgDBHdr&gt; parent;</span>
<a href="#l13.162"></a><span id="l13.162">   int32_t parentIndex = -1;</span>
<a href="#l13.163"></a><span id="l13.163"> </span>
<a href="#l13.164"></a><span id="l13.164" class="difflineminus">-  for (int32_t i = numReferences - 1; i &gt;= 0;  i--)</span>
<a href="#l13.165"></a><span id="l13.165" class="difflineminus">-  {</span>
<a href="#l13.166"></a><span id="l13.166" class="difflineplus">+  for (int32_t i = numReferences - 1; i &gt;= 0; i--) {</span>
<a href="#l13.167"></a><span id="l13.167">     nsAutoCString reference;</span>
<a href="#l13.168"></a><span id="l13.168">     newHdr-&gt;GetStringReference(i, reference);</span>
<a href="#l13.169"></a><span id="l13.169" class="difflineminus">-    if (reference.IsEmpty())</span>
<a href="#l13.170"></a><span id="l13.170" class="difflineminus">-      break;</span>
<a href="#l13.171"></a><span id="l13.171" class="difflineplus">+    if (reference.IsEmpty()) break;</span>
<a href="#l13.172"></a><span id="l13.172"> </span>
<a href="#l13.173"></a><span id="l13.173">     // I could look for the thread from the reference, but getting</span>
<a href="#l13.174"></a><span id="l13.174">     // the header directly should be fine. If it's not, that means</span>
<a href="#l13.175"></a><span id="l13.175">     // that the parent isn't in this thread, though it should be.</span>
<a href="#l13.176"></a><span id="l13.176">     m_view-&gt;GetMsgHdrFromHash(reference, getter_AddRefs(parent));</span>
<a href="#l13.177"></a><span id="l13.177" class="difflineminus">-    if (parent)</span>
<a href="#l13.178"></a><span id="l13.178" class="difflineminus">-    {</span>
<a href="#l13.179"></a><span id="l13.179" class="difflineplus">+    if (parent) {</span>
<a href="#l13.180"></a><span id="l13.180">       parentIndex = HdrIndex(parent);</span>
<a href="#l13.181"></a><span id="l13.181" class="difflineminus">-      if (parentIndex == -1)</span>
<a href="#l13.182"></a><span id="l13.182" class="difflineminus">-      {</span>
<a href="#l13.183"></a><span id="l13.183" class="difflineplus">+      if (parentIndex == -1) {</span>
<a href="#l13.184"></a><span id="l13.184">         NS_ERROR(&quot;how did we get in the wrong thread?&quot;);</span>
<a href="#l13.185"></a><span id="l13.185">         parent = nullptr;</span>
<a href="#l13.186"></a><span id="l13.186">       }</span>
<a href="#l13.187"></a><span id="l13.187"> </span>
<a href="#l13.188"></a><span id="l13.188">       break;</span>
<a href="#l13.189"></a><span id="l13.189">     }</span>
<a href="#l13.190"></a><span id="l13.190">   }</span>
<a href="#l13.191"></a><span id="l13.191"> </span>
<a href="#l13.192"></a><span id="l13.192" class="difflineminus">-  if (parent)</span>
<a href="#l13.193"></a><span id="l13.193" class="difflineminus">-  {</span>
<a href="#l13.194"></a><span id="l13.194" class="difflineplus">+  if (parent) {</span>
<a href="#l13.195"></a><span id="l13.195">     uint32_t parentLevel = m_levels[parentIndex];</span>
<a href="#l13.196"></a><span id="l13.196">     nsMsgKey parentKey;</span>
<a href="#l13.197"></a><span id="l13.197">     parent-&gt;GetMessageKey(&amp;parentKey);</span>
<a href="#l13.198"></a><span id="l13.198">     nsCOMPtr&lt;nsIMsgFolder&gt; parentFolder;</span>
<a href="#l13.199"></a><span id="l13.199">     parent-&gt;GetFolder(getter_AddRefs(parentFolder));</span>
<a href="#l13.200"></a><span id="l13.200"> </span>
<a href="#l13.201"></a><span id="l13.201" class="difflineminus">-    if (outParent)</span>
<a href="#l13.202"></a><span id="l13.202" class="difflineminus">-      parent.forget(outParent);</span>
<a href="#l13.203"></a><span id="l13.203" class="difflineplus">+    if (outParent) parent.forget(outParent);</span>
<a href="#l13.204"></a><span id="l13.204"> </span>
<a href="#l13.205"></a><span id="l13.205">     // Iterate over our parents' children until we find one we're older than,</span>
<a href="#l13.206"></a><span id="l13.206">     // and insert ourselves before it, or as the last child. In other words,</span>
<a href="#l13.207"></a><span id="l13.207">     // insert, sorted by date.</span>
<a href="#l13.208"></a><span id="l13.208">     uint32_t msgDate, childDate;</span>
<a href="#l13.209"></a><span id="l13.209">     newHdr-&gt;GetDateInSeconds(&amp;msgDate);</span>
<a href="#l13.210"></a><span id="l13.210">     nsCOMPtr&lt;nsIMsgDBHdr&gt; child;</span>
<a href="#l13.211"></a><span id="l13.211">     nsMsgViewIndex i;</span>
<a href="#l13.212"></a><span id="l13.212">     nsMsgViewIndex insertIndex = m_keys.Length();</span>
<a href="#l13.213"></a><span id="l13.213">     uint32_t insertLevel = parentLevel + 1;</span>
<a href="#l13.214"></a><span id="l13.214">     for (i = parentIndex;</span>
<a href="#l13.215"></a><span id="l13.215">          i &lt; m_keys.Length() &amp;&amp;</span>
<a href="#l13.216"></a><span id="l13.216" class="difflineminus">-           (i == (nsMsgViewIndex)parentIndex || m_levels[i] &gt;= parentLevel);</span>
<a href="#l13.217"></a><span id="l13.217" class="difflineminus">-         i++)</span>
<a href="#l13.218"></a><span id="l13.218" class="difflineminus">-    {</span>
<a href="#l13.219"></a><span id="l13.219" class="difflineplus">+         (i == (nsMsgViewIndex)parentIndex || m_levels[i] &gt;= parentLevel);</span>
<a href="#l13.220"></a><span id="l13.220" class="difflineplus">+         i++) {</span>
<a href="#l13.221"></a><span id="l13.221">       GetChildHdrAt(i, getter_AddRefs(child));</span>
<a href="#l13.222"></a><span id="l13.222" class="difflineminus">-      if (child)</span>
<a href="#l13.223"></a><span id="l13.223" class="difflineminus">-      {</span>
<a href="#l13.224"></a><span id="l13.224" class="difflineminus">-        if (reparentChildren &amp;&amp; IsHdrParentOf(newHdr, child))</span>
<a href="#l13.225"></a><span id="l13.225" class="difflineminus">-        {</span>
<a href="#l13.226"></a><span id="l13.226" class="difflineplus">+      if (child) {</span>
<a href="#l13.227"></a><span id="l13.227" class="difflineplus">+        if (reparentChildren &amp;&amp; IsHdrParentOf(newHdr, child)) {</span>
<a href="#l13.228"></a><span id="l13.228">           insertIndex = i;</span>
<a href="#l13.229"></a><span id="l13.229">           // Bump all the children of the current child, and the child.</span>
<a href="#l13.230"></a><span id="l13.230">           nsMsgViewIndex j = insertIndex;</span>
<a href="#l13.231"></a><span id="l13.231">           uint8_t childLevel = m_levels[insertIndex];</span>
<a href="#l13.232"></a><span id="l13.232" class="difflineminus">-          do</span>
<a href="#l13.233"></a><span id="l13.233" class="difflineminus">-          {</span>
<a href="#l13.234"></a><span id="l13.234" class="difflineplus">+          do {</span>
<a href="#l13.235"></a><span id="l13.235">             m_levels[j] = m_levels[j] + 1;</span>
<a href="#l13.236"></a><span id="l13.236">             j++;</span>
<a href="#l13.237"></a><span id="l13.237" class="difflineminus">-          }</span>
<a href="#l13.238"></a><span id="l13.238" class="difflineminus">-          while (j &lt; m_keys.Length() &amp;&amp; m_levels[j] &gt; childLevel);</span>
<a href="#l13.239"></a><span id="l13.239" class="difflineplus">+          } while (j &lt; m_keys.Length() &amp;&amp; m_levels[j] &gt; childLevel);</span>
<a href="#l13.240"></a><span id="l13.240">           break;</span>
<a href="#l13.241"></a><span id="l13.241" class="difflineminus">-        }</span>
<a href="#l13.242"></a><span id="l13.242" class="difflineminus">-        else if (m_levels[i] == parentLevel + 1)</span>
<a href="#l13.243"></a><span id="l13.243" class="difflineminus">-        {</span>
<a href="#l13.244"></a><span id="l13.244" class="difflineplus">+        } else if (m_levels[i] == parentLevel + 1) {</span>
<a href="#l13.245"></a><span id="l13.245">           // Possible sibling.</span>
<a href="#l13.246"></a><span id="l13.246">           child-&gt;GetDateInSeconds(&amp;childDate);</span>
<a href="#l13.247"></a><span id="l13.247" class="difflineminus">-          if (msgDate &lt; childDate)</span>
<a href="#l13.248"></a><span id="l13.248" class="difflineminus">-          {</span>
<a href="#l13.249"></a><span id="l13.249" class="difflineplus">+          if (msgDate &lt; childDate) {</span>
<a href="#l13.250"></a><span id="l13.250">             // If we think we need to reparent, remember this insert index,</span>
<a href="#l13.251"></a><span id="l13.251">             // but keep looking for children.</span>
<a href="#l13.252"></a><span id="l13.252">             insertIndex = i;</span>
<a href="#l13.253"></a><span id="l13.253">             insertLevel = m_levels[i];</span>
<a href="#l13.254"></a><span id="l13.254">             // If the sibling we're inserting after has children, we need</span>
<a href="#l13.255"></a><span id="l13.255">             // to go after the children.</span>
<a href="#l13.256"></a><span id="l13.256">             while (insertIndex + 1 &lt; m_keys.Length() &amp;&amp;</span>
<a href="#l13.257"></a><span id="l13.257" class="difflineminus">-                   m_levels[insertIndex + 1] &gt; insertLevel)</span>
<a href="#l13.258"></a><span id="l13.258" class="difflineminus">-            {</span>
<a href="#l13.259"></a><span id="l13.259" class="difflineplus">+                   m_levels[insertIndex + 1] &gt; insertLevel) {</span>
<a href="#l13.260"></a><span id="l13.260">               insertIndex++;</span>
<a href="#l13.261"></a><span id="l13.261">             }</span>
<a href="#l13.262"></a><span id="l13.262"> </span>
<a href="#l13.263"></a><span id="l13.263" class="difflineminus">-            if (!reparentChildren)</span>
<a href="#l13.264"></a><span id="l13.264" class="difflineminus">-              break;</span>
<a href="#l13.265"></a><span id="l13.265" class="difflineplus">+            if (!reparentChildren) break;</span>
<a href="#l13.266"></a><span id="l13.266">           }</span>
<a href="#l13.267"></a><span id="l13.267">         }</span>
<a href="#l13.268"></a><span id="l13.268">       }</span>
<a href="#l13.269"></a><span id="l13.269">     }</span>
<a href="#l13.270"></a><span id="l13.270"> </span>
<a href="#l13.271"></a><span id="l13.271">     m_keys.InsertElementAt(insertIndex, newHdrKey);</span>
<a href="#l13.272"></a><span id="l13.272">     m_levels.InsertElementAt(insertIndex, insertLevel);</span>
<a href="#l13.273"></a><span id="l13.273">     m_folders.InsertObjectAt(newHdrFolder, insertIndex);</span>
<a href="#l13.274"></a><span id="l13.274">     whereInserted = insertIndex;</span>
<a href="#l13.275"></a><span id="l13.275" class="difflineminus">-  }</span>
<a href="#l13.276"></a><span id="l13.276" class="difflineminus">-  else</span>
<a href="#l13.277"></a><span id="l13.277" class="difflineminus">-  {</span>
<a href="#l13.278"></a><span id="l13.278" class="difflineminus">-    if (outParent)</span>
<a href="#l13.279"></a><span id="l13.279" class="difflineminus">-      *outParent = nullptr;</span>
<a href="#l13.280"></a><span id="l13.280" class="difflineplus">+  } else {</span>
<a href="#l13.281"></a><span id="l13.281" class="difflineplus">+    if (outParent) *outParent = nullptr;</span>
<a href="#l13.282"></a><span id="l13.282"> </span>
<a href="#l13.283"></a><span id="l13.283">     nsCOMPtr&lt;nsIMsgDBHdr&gt; rootHdr;</span>
<a href="#l13.284"></a><span id="l13.284">     GetChildHdrAt(0, getter_AddRefs(rootHdr));</span>
<a href="#l13.285"></a><span id="l13.285">     // If the new header is a parent of the root then it should be promoted.</span>
<a href="#l13.286"></a><span id="l13.286" class="difflineminus">-    if (rootHdr &amp;&amp; IsHdrParentOf(newHdr, rootHdr))</span>
<a href="#l13.287"></a><span id="l13.287" class="difflineminus">-    {</span>
<a href="#l13.288"></a><span id="l13.288" class="difflineplus">+    if (rootHdr &amp;&amp; IsHdrParentOf(newHdr, rootHdr)) {</span>
<a href="#l13.289"></a><span id="l13.289">       m_keys.InsertElementAt(0, newHdrKey);</span>
<a href="#l13.290"></a><span id="l13.290">       m_levels.InsertElementAt(0, 0);</span>
<a href="#l13.291"></a><span id="l13.291">       m_folders.InsertObjectAt(newHdrFolder, 0);</span>
<a href="#l13.292"></a><span id="l13.292">       whereInserted = 0;</span>
<a href="#l13.293"></a><span id="l13.293">       // Adjust level of old root hdr and its children</span>
<a href="#l13.294"></a><span id="l13.294">       for (nsMsgViewIndex i = 1; i &lt; m_keys.Length(); i++)</span>
<a href="#l13.295"></a><span id="l13.295">         m_levels[i] = m_levels[1] + 1;</span>
<a href="#l13.296"></a><span id="l13.296" class="difflineminus">-    }</span>
<a href="#l13.297"></a><span id="l13.297" class="difflineminus">-    else</span>
<a href="#l13.298"></a><span id="l13.298" class="difflineminus">-    {</span>
<a href="#l13.299"></a><span id="l13.299" class="difflineplus">+    } else {</span>
<a href="#l13.300"></a><span id="l13.300">       m_keys.AppendElement(newHdrKey);</span>
<a href="#l13.301"></a><span id="l13.301">       m_levels.AppendElement(1);</span>
<a href="#l13.302"></a><span id="l13.302">       m_folders.AppendObject(newHdrFolder);</span>
<a href="#l13.303"></a><span id="l13.303" class="difflineminus">-      if (outParent)</span>
<a href="#l13.304"></a><span id="l13.304" class="difflineminus">-        rootHdr.forget(outParent);</span>
<a href="#l13.305"></a><span id="l13.305" class="difflineplus">+      if (outParent) rootHdr.forget(outParent);</span>
<a href="#l13.306"></a><span id="l13.306"> </span>
<a href="#l13.307"></a><span id="l13.307" class="difflineminus">-      whereInserted = m_keys.Length() -1;</span>
<a href="#l13.308"></a><span id="l13.308" class="difflineplus">+      whereInserted = m_keys.Length() - 1;</span>
<a href="#l13.309"></a><span id="l13.309">     }</span>
<a href="#l13.310"></a><span id="l13.310">   }</span>
<a href="#l13.311"></a><span id="l13.311"> </span>
<a href="#l13.312"></a><span id="l13.312">   // ### TODO handle the case where the root header starts</span>
<a href="#l13.313"></a><span id="l13.313">   // with Re, and the new one doesn't, and is earlier. In that</span>
<a href="#l13.314"></a><span id="l13.314">   // case, we want to promote the new header to root.</span>
<a href="#l13.315"></a><span id="l13.315" class="difflineminus">-</span>
<a href="#l13.316"></a><span id="l13.316" class="difflineminus">-//  PRTime newHdrDate;</span>
<a href="#l13.317"></a><span id="l13.317" class="difflineminus">-//  newHdr-&gt;GetDate(&amp;newHdrDate);</span>
<a href="#l13.318"></a><span id="l13.318" class="difflineminus">-</span>
<a href="#l13.319"></a><span id="l13.319" class="difflineminus">-//  if (numChildren &gt; 0 &amp;&amp; !(newHdrFlags &amp; nsMsgMessageFlags::HasRe))</span>
<a href="#l13.320"></a><span id="l13.320" class="difflineminus">-//  {</span>
<a href="#l13.321"></a><span id="l13.321" class="difflineminus">-//    PRTime topLevelHdrDate;</span>
<a href="#l13.322"></a><span id="l13.322" class="difflineminus">-</span>
<a href="#l13.323"></a><span id="l13.323" class="difflineminus">-//    nsCOMPtr&lt;nsIMsgDBHdr&gt; topLevelHdr;</span>
<a href="#l13.324"></a><span id="l13.324" class="difflineminus">-//    rv = GetRootHdr(nullptr, getter_AddRefs(topLevelHdr));</span>
<a href="#l13.325"></a><span id="l13.325" class="difflineminus">-//    if (NS_SUCCEEDED(rv) &amp;&amp; topLevelHdr)</span>
<a href="#l13.326"></a><span id="l13.326" class="difflineminus">-//    {</span>
<a href="#l13.327"></a><span id="l13.327" class="difflineminus">-//      topLevelHdr-&gt;GetDate(&amp;topLevelHdrDate);</span>
<a href="#l13.328"></a><span id="l13.328" class="difflineminus">-//      if (newHdrDate &lt; topLevelHdrDate)</span>
<a href="#l13.329"></a><span id="l13.329" class="difflineminus">-</span>
<a href="#l13.330"></a><span id="l13.330" class="difflineminus">-//    }</span>
<a href="#l13.331"></a><span id="l13.331" class="difflineminus">-//  }</span>
<a href="#l13.332"></a><span id="l13.332" class="difflineplus">+  //  PRTime newHdrDate;</span>
<a href="#l13.333"></a><span id="l13.333" class="difflineplus">+  //  newHdr-&gt;GetDate(&amp;newHdrDate);</span>
<a href="#l13.334"></a><span id="l13.334" class="difflineplus">+  //  if (numChildren &gt; 0 &amp;&amp; !(newHdrFlags &amp; nsMsgMessageFlags::HasRe)) {</span>
<a href="#l13.335"></a><span id="l13.335" class="difflineplus">+  //    PRTime topLevelHdrDate;</span>
<a href="#l13.336"></a><span id="l13.336" class="difflineplus">+  //    nsCOMPtr&lt;nsIMsgDBHdr&gt; topLevelHdr;</span>
<a href="#l13.337"></a><span id="l13.337" class="difflineplus">+  //    rv = GetRootHdr(nullptr, getter_AddRefs(topLevelHdr));</span>
<a href="#l13.338"></a><span id="l13.338" class="difflineplus">+  //    if (NS_SUCCEEDED(rv) &amp;&amp; topLevelHdr) {</span>
<a href="#l13.339"></a><span id="l13.339" class="difflineplus">+  //      topLevelHdr-&gt;GetDate(&amp;topLevelHdrDate);</span>
<a href="#l13.340"></a><span id="l13.340" class="difflineplus">+  //      if (newHdrDate &lt; topLevelHdrDate) ?? and now ??</span>
<a href="#l13.341"></a><span id="l13.341" class="difflineplus">+  //    }</span>
<a href="#l13.342"></a><span id="l13.342" class="difflineplus">+  //  }</span>
<a href="#l13.343"></a><span id="l13.343"> </span>
<a href="#l13.344"></a><span id="l13.344">   return NS_OK;</span>
<a href="#l13.345"></a><span id="l13.345"> }</span>
<a href="#l13.346"></a><span id="l13.346"> </span>
<a href="#l13.347"></a><span id="l13.347"> NS_IMETHODIMP</span>
<a href="#l13.348"></a><span id="l13.348" class="difflineminus">-nsMsgXFViewThread::GetChildHdrAt(uint32_t aIndex,</span>
<a href="#l13.349"></a><span id="l13.349" class="difflineminus">-                                 nsIMsgDBHdr **aResult)</span>
<a href="#l13.350"></a><span id="l13.350" class="difflineminus">-{</span>
<a href="#l13.351"></a><span id="l13.351" class="difflineminus">-  if (aIndex &gt;= m_keys.Length())</span>
<a href="#l13.352"></a><span id="l13.352" class="difflineminus">-    return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l13.353"></a><span id="l13.353" class="difflineplus">+nsMsgXFViewThread::GetChildHdrAt(uint32_t aIndex, nsIMsgDBHdr **aResult) {</span>
<a href="#l13.354"></a><span id="l13.354" class="difflineplus">+  if (aIndex &gt;= m_keys.Length()) return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l13.355"></a><span id="l13.355"> </span>
<a href="#l13.356"></a><span id="l13.356">   nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l13.357"></a><span id="l13.357">   nsresult rv = m_folders[aIndex]-&gt;GetMsgDatabase(getter_AddRefs(db));</span>
<a href="#l13.358"></a><span id="l13.358">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.359"></a><span id="l13.359">   return db-&gt;GetMsgHdrForKey(m_keys[aIndex], aResult);</span>
<a href="#l13.360"></a><span id="l13.360"> }</span>
<a href="#l13.361"></a><span id="l13.361"> </span>
<a href="#l13.362"></a><span id="l13.362"> NS_IMETHODIMP</span>
<a href="#l13.363"></a><span id="l13.363" class="difflineminus">-nsMsgXFViewThread::RemoveChildAt(uint32_t aIndex)</span>
<a href="#l13.364"></a><span id="l13.364" class="difflineminus">-{</span>
<a href="#l13.365"></a><span id="l13.365" class="difflineplus">+nsMsgXFViewThread::RemoveChildAt(uint32_t aIndex) {</span>
<a href="#l13.366"></a><span id="l13.366">   m_keys.RemoveElementAt(aIndex);</span>
<a href="#l13.367"></a><span id="l13.367">   m_levels.RemoveElementAt(aIndex);</span>
<a href="#l13.368"></a><span id="l13.368">   m_folders.RemoveObjectAt(aIndex);</span>
<a href="#l13.369"></a><span id="l13.369">   return NS_OK;</span>
<a href="#l13.370"></a><span id="l13.370"> }</span>
<a href="#l13.371"></a><span id="l13.371"> </span>
<a href="#l13.372"></a><span id="l13.372"> NS_IMETHODIMP</span>
<a href="#l13.373"></a><span id="l13.373"> nsMsgXFViewThread::RemoveChildHdr(nsIMsgDBHdr *child,</span>
<a href="#l13.374"></a><span id="l13.374" class="difflineminus">-                                  nsIDBChangeAnnouncer *announcer)</span>
<a href="#l13.375"></a><span id="l13.375" class="difflineminus">-{</span>
<a href="#l13.376"></a><span id="l13.376" class="difflineplus">+                                  nsIDBChangeAnnouncer *announcer) {</span>
<a href="#l13.377"></a><span id="l13.377">   NS_ENSURE_ARG_POINTER(child);</span>
<a href="#l13.378"></a><span id="l13.378">   nsMsgKey msgKey;</span>
<a href="#l13.379"></a><span id="l13.379">   uint32_t msgFlags;</span>
<a href="#l13.380"></a><span id="l13.380">   child-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l13.381"></a><span id="l13.381">   child-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l13.382"></a><span id="l13.382">   nsCOMPtr&lt;nsIMsgFolder&gt; msgFolder;</span>
<a href="#l13.383"></a><span id="l13.383">   child-&gt;GetFolder(getter_AddRefs(msgFolder));</span>
<a href="#l13.384"></a><span id="l13.384">   // If this was the newest msg, clear the newest msg date so we'll recalc.</span>
<a href="#l13.385"></a><span id="l13.385">   uint32_t date;</span>
<a href="#l13.386"></a><span id="l13.386">   child-&gt;GetDateInSeconds(&amp;date);</span>
<a href="#l13.387"></a><span id="l13.387" class="difflineminus">-  if (date == m_newestMsgDate)</span>
<a href="#l13.388"></a><span id="l13.388" class="difflineminus">-    SetNewestMsgDate(0);</span>
<a href="#l13.389"></a><span id="l13.389" class="difflineplus">+  if (date == m_newestMsgDate) SetNewestMsgDate(0);</span>
<a href="#l13.390"></a><span id="l13.390"> </span>
<a href="#l13.391"></a><span id="l13.391" class="difflineminus">-  for (uint32_t childIndex = 0; childIndex &lt; m_keys.Length(); childIndex++)</span>
<a href="#l13.392"></a><span id="l13.392" class="difflineminus">-  {</span>
<a href="#l13.393"></a><span id="l13.393" class="difflineminus">-    if (m_keys[childIndex] == msgKey &amp;&amp; m_folders[childIndex] == msgFolder)</span>
<a href="#l13.394"></a><span id="l13.394" class="difflineminus">-    {</span>
<a href="#l13.395"></a><span id="l13.395" class="difflineplus">+  for (uint32_t childIndex = 0; childIndex &lt; m_keys.Length(); childIndex++) {</span>
<a href="#l13.396"></a><span id="l13.396" class="difflineplus">+    if (m_keys[childIndex] == msgKey &amp;&amp; m_folders[childIndex] == msgFolder) {</span>
<a href="#l13.397"></a><span id="l13.397">       uint8_t levelRemoved = m_keys[childIndex];</span>
<a href="#l13.398"></a><span id="l13.398">       // Adjust the levels of all the children of this header.</span>
<a href="#l13.399"></a><span id="l13.399">       nsMsgViewIndex i;</span>
<a href="#l13.400"></a><span id="l13.400">       for (i = childIndex + 1;</span>
<a href="#l13.401"></a><span id="l13.401" class="difflineminus">-           i &lt; m_keys.Length() &amp;&amp; m_levels[i] &gt; levelRemoved;</span>
<a href="#l13.402"></a><span id="l13.402" class="difflineminus">-           i++)</span>
<a href="#l13.403"></a><span id="l13.403" class="difflineminus">-      {</span>
<a href="#l13.404"></a><span id="l13.404" class="difflineplus">+           i &lt; m_keys.Length() &amp;&amp; m_levels[i] &gt; levelRemoved; i++) {</span>
<a href="#l13.405"></a><span id="l13.405">         m_levels[i] = m_levels[i] - 1;</span>
<a href="#l13.406"></a><span id="l13.406">       }</span>
<a href="#l13.407"></a><span id="l13.407"> </span>
<a href="#l13.408"></a><span id="l13.408">       m_view-&gt;NoteChange(childIndex + 1, i - childIndex + 1,</span>
<a href="#l13.409"></a><span id="l13.409">                          nsMsgViewNotificationCode::changed);</span>
<a href="#l13.410"></a><span id="l13.410">       m_keys.RemoveElementAt(childIndex);</span>
<a href="#l13.411"></a><span id="l13.411">       m_levels.RemoveElementAt(childIndex);</span>
<a href="#l13.412"></a><span id="l13.412">       m_folders.RemoveObjectAt(childIndex);</span>
<a href="#l13.413"></a><span id="l13.413" class="difflineminus">-      if (!(msgFlags &amp; nsMsgMessageFlags::Read))</span>
<a href="#l13.414"></a><span id="l13.414" class="difflineminus">-        ChangeUnreadChildCount(-1);</span>
<a href="#l13.415"></a><span id="l13.415" class="difflineplus">+      if (!(msgFlags &amp; nsMsgMessageFlags::Read)) ChangeUnreadChildCount(-1);</span>
<a href="#l13.416"></a><span id="l13.416"> </span>
<a href="#l13.417"></a><span id="l13.417">       ChangeChildCount(-1);</span>
<a href="#l13.418"></a><span id="l13.418">       return NS_OK;</span>
<a href="#l13.419"></a><span id="l13.419">     }</span>
<a href="#l13.420"></a><span id="l13.420">   }</span>
<a href="#l13.421"></a><span id="l13.421"> </span>
<a href="#l13.422"></a><span id="l13.422">   return NS_ERROR_FAILURE;</span>
<a href="#l13.423"></a><span id="l13.423"> }</span>
<a href="#l13.424"></a><span id="l13.424"> </span>
<a href="#l13.425"></a><span id="l13.425"> NS_IMETHODIMP</span>
<a href="#l13.426"></a><span id="l13.426" class="difflineminus">-nsMsgXFViewThread::GetRootHdr(int32_t *aResultIndex,</span>
<a href="#l13.427"></a><span id="l13.427" class="difflineminus">-                              nsIMsgDBHdr **aResult)</span>
<a href="#l13.428"></a><span id="l13.428" class="difflineminus">-{</span>
<a href="#l13.429"></a><span id="l13.429" class="difflineplus">+nsMsgXFViewThread::GetRootHdr(int32_t *aResultIndex, nsIMsgDBHdr **aResult) {</span>
<a href="#l13.430"></a><span id="l13.430">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l13.431"></a><span id="l13.431" class="difflineminus">-  if (aResultIndex)</span>
<a href="#l13.432"></a><span id="l13.432" class="difflineminus">-    *aResultIndex = 0;</span>
<a href="#l13.433"></a><span id="l13.433" class="difflineplus">+  if (aResultIndex) *aResultIndex = 0;</span>
<a href="#l13.434"></a><span id="l13.434"> </span>
<a href="#l13.435"></a><span id="l13.435">   return GetChildHdrAt(0, aResult);</span>
<a href="#l13.436"></a><span id="l13.436"> }</span>
<a href="#l13.437"></a><span id="l13.437"> </span>
<a href="#l13.438"></a><span id="l13.438"> NS_IMETHODIMP</span>
<a href="#l13.439"></a><span id="l13.439" class="difflineminus">-nsMsgXFViewThread::GetChildKeyAt(uint32_t aIndex,</span>
<a href="#l13.440"></a><span id="l13.440" class="difflineminus">-                                 nsMsgKey *aResult)</span>
<a href="#l13.441"></a><span id="l13.441" class="difflineminus">-{</span>
<a href="#l13.442"></a><span id="l13.442" class="difflineplus">+nsMsgXFViewThread::GetChildKeyAt(uint32_t aIndex, nsMsgKey *aResult) {</span>
<a href="#l13.443"></a><span id="l13.443">   NS_ASSERTION(false, &quot;shouldn't call this&quot;);</span>
<a href="#l13.444"></a><span id="l13.444">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l13.445"></a><span id="l13.445"> }</span>
<a href="#l13.446"></a><span id="l13.446"> </span>
<a href="#l13.447"></a><span id="l13.447"> NS_IMETHODIMP</span>
<a href="#l13.448"></a><span id="l13.448" class="difflineminus">-nsMsgXFViewThread::GetChild(nsMsgKey msgKey,</span>
<a href="#l13.449"></a><span id="l13.449" class="difflineminus">-                            nsIMsgDBHdr **aResult)</span>
<a href="#l13.450"></a><span id="l13.450" class="difflineminus">-{</span>
<a href="#l13.451"></a><span id="l13.451" class="difflineplus">+nsMsgXFViewThread::GetChild(nsMsgKey msgKey, nsIMsgDBHdr **aResult) {</span>
<a href="#l13.452"></a><span id="l13.452">   NS_ASSERTION(false, &quot;shouldn't call this&quot;);</span>
<a href="#l13.453"></a><span id="l13.453">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l13.454"></a><span id="l13.454"> }</span>
<a href="#l13.455"></a><span id="l13.455"> </span>
<a href="#l13.456"></a><span id="l13.456" class="difflineminus">-</span>
<a href="#l13.457"></a><span id="l13.457" class="difflineminus">-int32_t</span>
<a href="#l13.458"></a><span id="l13.458" class="difflineminus">-nsMsgXFViewThread::HdrIndex(nsIMsgDBHdr *hdr)</span>
<a href="#l13.459"></a><span id="l13.459" class="difflineminus">-{</span>
<a href="#l13.460"></a><span id="l13.460" class="difflineplus">+int32_t nsMsgXFViewThread::HdrIndex(nsIMsgDBHdr *hdr) {</span>
<a href="#l13.461"></a><span id="l13.461">   nsMsgKey msgKey;</span>
<a href="#l13.462"></a><span id="l13.462">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l13.463"></a><span id="l13.463">   hdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l13.464"></a><span id="l13.464">   hdr-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l13.465"></a><span id="l13.465" class="difflineminus">-  for (uint32_t i = 0; i &lt; m_keys.Length(); i++)</span>
<a href="#l13.466"></a><span id="l13.466" class="difflineminus">-  {</span>
<a href="#l13.467"></a><span id="l13.467" class="difflineminus">-    if (m_keys[i] == msgKey &amp;&amp; m_folders[i] == folder)</span>
<a href="#l13.468"></a><span id="l13.468" class="difflineminus">-      return i;</span>
<a href="#l13.469"></a><span id="l13.469" class="difflineplus">+  for (uint32_t i = 0; i &lt; m_keys.Length(); i++) {</span>
<a href="#l13.470"></a><span id="l13.470" class="difflineplus">+    if (m_keys[i] == msgKey &amp;&amp; m_folders[i] == folder) return i;</span>
<a href="#l13.471"></a><span id="l13.471">   }</span>
<a href="#l13.472"></a><span id="l13.472"> </span>
<a href="#l13.473"></a><span id="l13.473">   return -1;</span>
<a href="#l13.474"></a><span id="l13.474"> }</span>
<a href="#l13.475"></a><span id="l13.475"> </span>
<a href="#l13.476"></a><span id="l13.476" class="difflineminus">-void</span>
<a href="#l13.477"></a><span id="l13.477" class="difflineminus">-nsMsgXFViewThread::ChangeUnreadChildCount(int32_t delta)</span>
<a href="#l13.478"></a><span id="l13.478" class="difflineminus">-{</span>
<a href="#l13.479"></a><span id="l13.479" class="difflineplus">+void nsMsgXFViewThread::ChangeUnreadChildCount(int32_t delta) {</span>
<a href="#l13.480"></a><span id="l13.480">   m_numUnreadChildren += delta;</span>
<a href="#l13.481"></a><span id="l13.481"> }</span>
<a href="#l13.482"></a><span id="l13.482"> </span>
<a href="#l13.483"></a><span id="l13.483" class="difflineminus">-void</span>
<a href="#l13.484"></a><span id="l13.484" class="difflineminus">-nsMsgXFViewThread::ChangeChildCount(int32_t delta)</span>
<a href="#l13.485"></a><span id="l13.485" class="difflineminus">-{</span>
<a href="#l13.486"></a><span id="l13.486" class="difflineplus">+void nsMsgXFViewThread::ChangeChildCount(int32_t delta) {</span>
<a href="#l13.487"></a><span id="l13.487">   m_numChildren += delta;</span>
<a href="#l13.488"></a><span id="l13.488"> }</span>
<a href="#l13.489"></a><span id="l13.489"> </span>
<a href="#l13.490"></a><span id="l13.490" class="difflineminus">-bool</span>
<a href="#l13.491"></a><span id="l13.491" class="difflineminus">-nsMsgXFViewThread::IsHdrParentOf(nsIMsgDBHdr *possibleParent,</span>
<a href="#l13.492"></a><span id="l13.492" class="difflineminus">-                                 nsIMsgDBHdr *possibleChild)</span>
<a href="#l13.493"></a><span id="l13.493" class="difflineminus">-{</span>
<a href="#l13.494"></a><span id="l13.494" class="difflineplus">+bool nsMsgXFViewThread::IsHdrParentOf(nsIMsgDBHdr *possibleParent,</span>
<a href="#l13.495"></a><span id="l13.495" class="difflineplus">+                                      nsIMsgDBHdr *possibleChild) {</span>
<a href="#l13.496"></a><span id="l13.496">   uint16_t referenceToCheck = 0;</span>
<a href="#l13.497"></a><span id="l13.497">   possibleChild-&gt;GetNumReferences(&amp;referenceToCheck);</span>
<a href="#l13.498"></a><span id="l13.498">   nsAutoCString reference;</span>
<a href="#l13.499"></a><span id="l13.499"> </span>
<a href="#l13.500"></a><span id="l13.500">   nsCString messageId;</span>
<a href="#l13.501"></a><span id="l13.501">   possibleParent-&gt;GetMessageId(getter_Copies(messageId));</span>
<a href="#l13.502"></a><span id="l13.502"> </span>
<a href="#l13.503"></a><span id="l13.503" class="difflineminus">-  while (referenceToCheck &gt; 0)</span>
<a href="#l13.504"></a><span id="l13.504" class="difflineminus">-  {</span>
<a href="#l13.505"></a><span id="l13.505" class="difflineplus">+  while (referenceToCheck &gt; 0) {</span>
<a href="#l13.506"></a><span id="l13.506">     possibleChild-&gt;GetStringReference(referenceToCheck - 1, reference);</span>
<a href="#l13.507"></a><span id="l13.507"> </span>
<a href="#l13.508"></a><span id="l13.508" class="difflineminus">-    if (reference.Equals(messageId))</span>
<a href="#l13.509"></a><span id="l13.509" class="difflineminus">-      return true;</span>
<a href="#l13.510"></a><span id="l13.510" class="difflineplus">+    if (reference.Equals(messageId)) return true;</span>
<a href="#l13.511"></a><span id="l13.511"> </span>
<a href="#l13.512"></a><span id="l13.512">     // If reference didn't match, check if this ref is for a non-existent</span>
<a href="#l13.513"></a><span id="l13.513">     // header. If it is, continue looking at ancestors.</span>
<a href="#l13.514"></a><span id="l13.514">     nsCOMPtr&lt;nsIMsgDBHdr&gt; refHdr;</span>
<a href="#l13.515"></a><span id="l13.515">     m_view-&gt;GetMsgHdrFromHash(reference, getter_AddRefs(refHdr));</span>
<a href="#l13.516"></a><span id="l13.516" class="difflineminus">-    if (refHdr)</span>
<a href="#l13.517"></a><span id="l13.517" class="difflineminus">-      break;</span>
<a href="#l13.518"></a><span id="l13.518" class="difflineplus">+    if (refHdr) break;</span>
<a href="#l13.519"></a><span id="l13.519"> </span>
<a href="#l13.520"></a><span id="l13.520">     referenceToCheck--;</span>
<a href="#l13.521"></a><span id="l13.521">   }</span>
<a href="#l13.522"></a><span id="l13.522"> </span>
<a href="#l13.523"></a><span id="l13.523">   return false;</span>
<a href="#l13.524"></a><span id="l13.524"> }</span>
<a href="#l13.525"></a><span id="l13.525"> </span>
<a href="#l13.526"></a><span id="l13.526"> NS_IMETHODIMP</span>
<a href="#l13.527"></a><span id="l13.527" class="difflineminus">-nsMsgXFViewThread::GetNewestMsgDate(uint32_t *aResult)</span>
<a href="#l13.528"></a><span id="l13.528" class="difflineminus">-{</span>
<a href="#l13.529"></a><span id="l13.529" class="difflineplus">+nsMsgXFViewThread::GetNewestMsgDate(uint32_t *aResult) {</span>
<a href="#l13.530"></a><span id="l13.530">   // If this hasn't been set, figure it out by enumerating the msgs in the</span>
<a href="#l13.531"></a><span id="l13.531">   // thread.</span>
<a href="#l13.532"></a><span id="l13.532" class="difflineminus">-  if (!m_newestMsgDate)</span>
<a href="#l13.533"></a><span id="l13.533" class="difflineminus">-  {</span>
<a href="#l13.534"></a><span id="l13.534" class="difflineplus">+  if (!m_newestMsgDate) {</span>
<a href="#l13.535"></a><span id="l13.535">     uint32_t numChildren;</span>
<a href="#l13.536"></a><span id="l13.536">     nsresult rv = NS_OK;</span>
<a href="#l13.537"></a><span id="l13.537"> </span>
<a href="#l13.538"></a><span id="l13.538">     GetNumChildren(&amp;numChildren);</span>
<a href="#l13.539"></a><span id="l13.539"> </span>
<a href="#l13.540"></a><span id="l13.540" class="difflineminus">-    if ((int32_t) numChildren &lt; 0)</span>
<a href="#l13.541"></a><span id="l13.541" class="difflineminus">-      numChildren = 0;</span>
<a href="#l13.542"></a><span id="l13.542" class="difflineplus">+    if ((int32_t)numChildren &lt; 0) numChildren = 0;</span>
<a href="#l13.543"></a><span id="l13.543"> </span>
<a href="#l13.544"></a><span id="l13.544" class="difflineminus">-    for (uint32_t childIndex = 0; childIndex &lt; numChildren; childIndex++)</span>
<a href="#l13.545"></a><span id="l13.545" class="difflineminus">-    {</span>
<a href="#l13.546"></a><span id="l13.546" class="difflineplus">+    for (uint32_t childIndex = 0; childIndex &lt; numChildren; childIndex++) {</span>
<a href="#l13.547"></a><span id="l13.547">       nsCOMPtr&lt;nsIMsgDBHdr&gt; child;</span>
<a href="#l13.548"></a><span id="l13.548">       rv = GetChildHdrAt(childIndex, getter_AddRefs(child));</span>
<a href="#l13.549"></a><span id="l13.549" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; child)</span>
<a href="#l13.550"></a><span id="l13.550" class="difflineminus">-      {</span>
<a href="#l13.551"></a><span id="l13.551" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; child) {</span>
<a href="#l13.552"></a><span id="l13.552">         uint32_t msgDate;</span>
<a href="#l13.553"></a><span id="l13.553">         child-&gt;GetDateInSeconds(&amp;msgDate);</span>
<a href="#l13.554"></a><span id="l13.554" class="difflineminus">-        if (msgDate &gt; m_newestMsgDate)</span>
<a href="#l13.555"></a><span id="l13.555" class="difflineminus">-          m_newestMsgDate = msgDate;</span>
<a href="#l13.556"></a><span id="l13.556" class="difflineplus">+        if (msgDate &gt; m_newestMsgDate) m_newestMsgDate = msgDate;</span>
<a href="#l13.557"></a><span id="l13.557">       }</span>
<a href="#l13.558"></a><span id="l13.558">     }</span>
<a href="#l13.559"></a><span id="l13.559">   }</span>
<a href="#l13.560"></a><span id="l13.560"> </span>
<a href="#l13.561"></a><span id="l13.561">   *aResult = m_newestMsgDate;</span>
<a href="#l13.562"></a><span id="l13.562">   return NS_OK;</span>
<a href="#l13.563"></a><span id="l13.563"> }</span>
<a href="#l13.564"></a><span id="l13.564"> </span>
<a href="#l13.565"></a><span id="l13.565"> NS_IMETHODIMP</span>
<a href="#l13.566"></a><span id="l13.566" class="difflineminus">-nsMsgXFViewThread::SetNewestMsgDate(uint32_t aNewestMsgDate)</span>
<a href="#l13.567"></a><span id="l13.567" class="difflineminus">-{</span>
<a href="#l13.568"></a><span id="l13.568" class="difflineplus">+nsMsgXFViewThread::SetNewestMsgDate(uint32_t aNewestMsgDate) {</span>
<a href="#l13.569"></a><span id="l13.569">   m_newestMsgDate = aNewestMsgDate;</span>
<a href="#l13.570"></a><span id="l13.570">   return NS_OK;</span>
<a href="#l13.571"></a><span id="l13.571"> }</span>
<a href="#l13.572"></a><span id="l13.572"> </span>
<a href="#l13.573"></a><span id="l13.573"> NS_IMETHODIMP</span>
<a href="#l13.574"></a><span id="l13.574" class="difflineminus">-nsMsgXFViewThread::MarkChildRead(bool aRead)</span>
<a href="#l13.575"></a><span id="l13.575" class="difflineminus">-{</span>
<a href="#l13.576"></a><span id="l13.576" class="difflineplus">+nsMsgXFViewThread::MarkChildRead(bool aRead) {</span>
<a href="#l13.577"></a><span id="l13.577">   ChangeUnreadChildCount(aRead ? -1 : 1);</span>
<a href="#l13.578"></a><span id="l13.578">   return NS_OK;</span>
<a href="#l13.579"></a><span id="l13.579"> }</span>
<a href="#l13.580"></a><span id="l13.580"> </span>
<a href="#l13.581"></a><span id="l13.581"> NS_IMETHODIMP</span>
<a href="#l13.582"></a><span id="l13.582" class="difflineminus">-nsMsgXFViewThread::GetFirstUnreadChild(nsIMsgDBHdr **aResult)</span>
<a href="#l13.583"></a><span id="l13.583" class="difflineminus">-{</span>
<a href="#l13.584"></a><span id="l13.584" class="difflineplus">+nsMsgXFViewThread::GetFirstUnreadChild(nsIMsgDBHdr **aResult) {</span>
<a href="#l13.585"></a><span id="l13.585">   NS_ENSURE_ARG(aResult);</span>
<a href="#l13.586"></a><span id="l13.586">   uint32_t numChildren;</span>
<a href="#l13.587"></a><span id="l13.587">   nsresult rv = NS_OK;</span>
<a href="#l13.588"></a><span id="l13.588"> </span>
<a href="#l13.589"></a><span id="l13.589">   GetNumChildren(&amp;numChildren);</span>
<a href="#l13.590"></a><span id="l13.590"> </span>
<a href="#l13.591"></a><span id="l13.591" class="difflineminus">-  if ((int32_t) numChildren &lt; 0)</span>
<a href="#l13.592"></a><span id="l13.592" class="difflineminus">-    numChildren = 0;</span>
<a href="#l13.593"></a><span id="l13.593" class="difflineplus">+  if ((int32_t)numChildren &lt; 0) numChildren = 0;</span>
<a href="#l13.594"></a><span id="l13.594"> </span>
<a href="#l13.595"></a><span id="l13.595" class="difflineminus">-  for (uint32_t childIndex = 0; childIndex &lt; numChildren; childIndex++)</span>
<a href="#l13.596"></a><span id="l13.596" class="difflineminus">-  {</span>
<a href="#l13.597"></a><span id="l13.597" class="difflineplus">+  for (uint32_t childIndex = 0; childIndex &lt; numChildren; childIndex++) {</span>
<a href="#l13.598"></a><span id="l13.598">     nsCOMPtr&lt;nsIMsgDBHdr&gt; child;</span>
<a href="#l13.599"></a><span id="l13.599">     rv = GetChildHdrAt(childIndex, getter_AddRefs(child));</span>
<a href="#l13.600"></a><span id="l13.600" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; child)</span>
<a href="#l13.601"></a><span id="l13.601" class="difflineminus">-    {</span>
<a href="#l13.602"></a><span id="l13.602" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; child) {</span>
<a href="#l13.603"></a><span id="l13.603">       nsMsgKey msgKey;</span>
<a href="#l13.604"></a><span id="l13.604">       child-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l13.605"></a><span id="l13.605"> </span>
<a href="#l13.606"></a><span id="l13.606">       bool isRead;</span>
<a href="#l13.607"></a><span id="l13.607">       nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l13.608"></a><span id="l13.608">       nsresult rv = m_folders[childIndex]-&gt;GetMsgDatabase(getter_AddRefs(db));</span>
<a href="#l13.609"></a><span id="l13.609" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l13.610"></a><span id="l13.610" class="difflineminus">-        rv = db-&gt;IsRead(msgKey, &amp;isRead);</span>
<a href="#l13.611"></a><span id="l13.611" class="difflineplus">+      if (NS_SUCCEEDED(rv)) rv = db-&gt;IsRead(msgKey, &amp;isRead);</span>
<a href="#l13.612"></a><span id="l13.612"> </span>
<a href="#l13.613"></a><span id="l13.613" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; !isRead)</span>
<a href="#l13.614"></a><span id="l13.614" class="difflineminus">-      {</span>
<a href="#l13.615"></a><span id="l13.615" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; !isRead) {</span>
<a href="#l13.616"></a><span id="l13.616">         child.forget(aResult);</span>
<a href="#l13.617"></a><span id="l13.617">         break;</span>
<a href="#l13.618"></a><span id="l13.618">       }</span>
<a href="#l13.619"></a><span id="l13.619">     }</span>
<a href="#l13.620"></a><span id="l13.620">   }</span>
<a href="#l13.621"></a><span id="l13.621"> </span>
<a href="#l13.622"></a><span id="l13.622">   return rv;</span>
<a href="#l13.623"></a><span id="l13.623"> }</span>
<a href="#l13.624"></a><span id="l13.624"> </span>
<a href="#l13.625"></a><span id="l13.625"> NS_IMETHODIMP</span>
<a href="#l13.626"></a><span id="l13.626"> nsMsgXFViewThread::EnumerateMessages(nsMsgKey aParentKey,</span>
<a href="#l13.627"></a><span id="l13.627" class="difflineminus">-                                     nsISimpleEnumerator **aResult)</span>
<a href="#l13.628"></a><span id="l13.628" class="difflineminus">-{</span>
<a href="#l13.629"></a><span id="l13.629" class="difflineplus">+                                     nsISimpleEnumerator **aResult) {</span>
<a href="#l13.630"></a><span id="l13.630">   NS_ERROR(&quot;shouldn't call this&quot;);</span>
<a href="#l13.631"></a><span id="l13.631">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l13.632"></a><span id="l13.632"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/base/src/nsMsgXFViewThread.h</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgXFViewThread.h</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -11,44 +11,41 @@</span>
<a href="#l14.4"></a><span id="l14.4"> #include &quot;MailNewsTypes.h&quot;</span>
<a href="#l14.5"></a><span id="l14.5"> #include &quot;nsTArray.h&quot;</span>
<a href="#l14.6"></a><span id="l14.6"> #include &quot;nsIMsgDatabase.h&quot;</span>
<a href="#l14.7"></a><span id="l14.7"> #include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l14.8"></a><span id="l14.8"> #include &quot;nsMsgDBView.h&quot;</span>
<a href="#l14.9"></a><span id="l14.9"> </span>
<a href="#l14.10"></a><span id="l14.10"> class nsMsgSearchDBView;</span>
<a href="#l14.11"></a><span id="l14.11"> </span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-class nsMsgXFViewThread : public nsIMsgThread</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineminus">-{</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineminus">-public:</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineminus">-</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineplus">+class nsMsgXFViewThread : public nsIMsgThread {</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineplus">+ public:</span>
<a href="#l14.18"></a><span id="l14.18">   nsMsgXFViewThread(nsMsgSearchDBView *view, nsMsgKey threadId);</span>
<a href="#l14.19"></a><span id="l14.19"> </span>
<a href="#l14.20"></a><span id="l14.20">   NS_DECL_NSIMSGTHREAD</span>
<a href="#l14.21"></a><span id="l14.21">   NS_DECL_ISUPPORTS</span>
<a href="#l14.22"></a><span id="l14.22"> </span>
<a href="#l14.23"></a><span id="l14.23" class="difflineminus">-  bool      IsHdrParentOf(nsIMsgDBHdr *possibleParent,</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineminus">-                          nsIMsgDBHdr *possibleChild);</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineplus">+  bool IsHdrParentOf(nsIMsgDBHdr *possibleParent, nsIMsgDBHdr *possibleChild);</span>
<a href="#l14.26"></a><span id="l14.26"> </span>
<a href="#l14.27"></a><span id="l14.27" class="difflineminus">-  void      ChangeUnreadChildCount(int32_t delta);</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineminus">-  void      ChangeChildCount(int32_t delta);</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineplus">+  void ChangeUnreadChildCount(int32_t delta);</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineplus">+  void ChangeChildCount(int32_t delta);</span>
<a href="#l14.31"></a><span id="l14.31"> </span>
<a href="#l14.32"></a><span id="l14.32" class="difflineminus">-  nsresult  AddHdr(nsIMsgDBHdr *newHdr, bool reparentChildren,</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineminus">-                   uint32_t &amp;whereInserted, nsIMsgDBHdr **outParent);</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineminus">-  int32_t   HdrIndex(nsIMsgDBHdr *hdr);</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineminus">-  uint32_t  ChildLevelAt(uint32_t msgIndex) {return m_levels[msgIndex];}</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineminus">-  uint32_t  MsgCount() {return m_numChildren;};</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineplus">+  nsresult AddHdr(nsIMsgDBHdr *newHdr, bool reparentChildren,</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineplus">+                  uint32_t &amp;whereInserted, nsIMsgDBHdr **outParent);</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineplus">+  int32_t HdrIndex(nsIMsgDBHdr *hdr);</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineplus">+  uint32_t ChildLevelAt(uint32_t msgIndex) { return m_levels[msgIndex]; }</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineplus">+  uint32_t MsgCount() { return m_numChildren; };</span>
<a href="#l14.42"></a><span id="l14.42"> </span>
<a href="#l14.43"></a><span id="l14.43" class="difflineminus">-protected:</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineplus">+ protected:</span>
<a href="#l14.45"></a><span id="l14.45">   virtual ~nsMsgXFViewThread();</span>
<a href="#l14.46"></a><span id="l14.46"> </span>
<a href="#l14.47"></a><span id="l14.47">   nsMsgSearchDBView *m_view;</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineminus">-  uint32_t        m_numUnreadChildren;</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineminus">-  uint32_t        m_numChildren;</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineminus">-  uint32_t        m_flags;</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineminus">-  uint32_t        m_newestMsgDate;</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineminus">-  nsMsgKey        m_threadId;</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineplus">+  uint32_t m_numUnreadChildren;</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineplus">+  uint32_t m_numChildren;</span>
<a href="#l14.55"></a><span id="l14.55" class="difflineplus">+  uint32_t m_flags;</span>
<a href="#l14.56"></a><span id="l14.56" class="difflineplus">+  uint32_t m_newestMsgDate;</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineplus">+  nsMsgKey m_threadId;</span>
<a href="#l14.58"></a><span id="l14.58">   nsTArray&lt;nsMsgKey&gt; m_keys;</span>
<a href="#l14.59"></a><span id="l14.59">   nsCOMArray&lt;nsIMsgFolder&gt; m_folders;</span>
<a href="#l14.60"></a><span id="l14.60">   nsTArray&lt;uint8_t&gt; m_levels;</span>
<a href="#l14.61"></a><span id="l14.61"> };</span>
<a href="#l14.62"></a><span id="l14.62"> </span>
<a href="#l14.63"></a><span id="l14.63"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/base/src/nsMsgXFVirtualFolderDBView.cpp</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgXFVirtualFolderDBView.cpp</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -14,561 +14,496 @@</span>
<a href="#l15.4"></a><span id="l15.4"> #include &quot;nsICopyMsgStreamListener.h&quot;</span>
<a href="#l15.5"></a><span id="l15.5"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l15.6"></a><span id="l15.6"> #include &quot;nsIMsgSearchSession.h&quot;</span>
<a href="#l15.7"></a><span id="l15.7"> #include &quot;nsMsgDBCID.h&quot;</span>
<a href="#l15.8"></a><span id="l15.8"> #include &quot;nsMsgMessageFlags.h&quot;</span>
<a href="#l15.9"></a><span id="l15.9"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l15.10"></a><span id="l15.10"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l15.11"></a><span id="l15.11"> </span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-nsMsgXFVirtualFolderDBView::nsMsgXFVirtualFolderDBView()</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">-{</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineplus">+nsMsgXFVirtualFolderDBView::nsMsgXFVirtualFolderDBView() {</span>
<a href="#l15.15"></a><span id="l15.15">   mSuppressMsgDisplay = false;</span>
<a href="#l15.16"></a><span id="l15.16">   m_doingSearch = false;</span>
<a href="#l15.17"></a><span id="l15.17">   m_doingQuickSearch = false;</span>
<a href="#l15.18"></a><span id="l15.18">   m_totalMessagesInView = 0;</span>
<a href="#l15.19"></a><span id="l15.19"> }</span>
<a href="#l15.20"></a><span id="l15.20"> </span>
<a href="#l15.21"></a><span id="l15.21" class="difflineminus">-nsMsgXFVirtualFolderDBView::~nsMsgXFVirtualFolderDBView()</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineminus">-{</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineminus">-}</span>
<a href="#l15.24"></a><span id="l15.24" class="difflineplus">+nsMsgXFVirtualFolderDBView::~nsMsgXFVirtualFolderDBView() {}</span>
<a href="#l15.25"></a><span id="l15.25"> </span>
<a href="#l15.26"></a><span id="l15.26"> NS_IMETHODIMP</span>
<a href="#l15.27"></a><span id="l15.27"> nsMsgXFVirtualFolderDBView::Open(nsIMsgFolder *folder,</span>
<a href="#l15.28"></a><span id="l15.28">                                  nsMsgViewSortTypeValue sortType,</span>
<a href="#l15.29"></a><span id="l15.29">                                  nsMsgViewSortOrderValue sortOrder,</span>
<a href="#l15.30"></a><span id="l15.30">                                  nsMsgViewFlagsTypeValue viewFlags,</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineminus">-                                 int32_t *pCount)</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineminus">-{</span>
<a href="#l15.33"></a><span id="l15.33" class="difflineplus">+                                 int32_t *pCount) {</span>
<a href="#l15.34"></a><span id="l15.34">   m_viewFolder = folder;</span>
<a href="#l15.35"></a><span id="l15.35" class="difflineminus">-  return nsMsgSearchDBView::Open(folder, sortType, sortOrder, viewFlags, pCount);</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineplus">+  return nsMsgSearchDBView::Open(folder, sortType, sortOrder, viewFlags,</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineplus">+                                 pCount);</span>
<a href="#l15.38"></a><span id="l15.38"> }</span>
<a href="#l15.39"></a><span id="l15.39"> </span>
<a href="#l15.40"></a><span id="l15.40" class="difflineminus">-void</span>
<a href="#l15.41"></a><span id="l15.41" class="difflineminus">-nsMsgXFVirtualFolderDBView::RemovePendingDBListeners()</span>
<a href="#l15.42"></a><span id="l15.42" class="difflineminus">-{</span>
<a href="#l15.43"></a><span id="l15.43" class="difflineplus">+void nsMsgXFVirtualFolderDBView::RemovePendingDBListeners() {</span>
<a href="#l15.44"></a><span id="l15.44">   nsresult rv;</span>
<a href="#l15.45"></a><span id="l15.45">   nsCOMPtr&lt;nsIMsgDBService&gt; msgDBService =</span>
<a href="#l15.46"></a><span id="l15.46" class="difflineminus">-    do_GetService(NS_MSGDB_SERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l15.47"></a><span id="l15.47" class="difflineplus">+      do_GetService(NS_MSGDB_SERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l15.48"></a><span id="l15.48"> </span>
<a href="#l15.49"></a><span id="l15.49">   // UnregisterPendingListener will return an error when there are no more</span>
<a href="#l15.50"></a><span id="l15.50">   // instances of this object registered as pending listeners.</span>
<a href="#l15.51"></a><span id="l15.51" class="difflineminus">-  while (NS_SUCCEEDED(rv))</span>
<a href="#l15.52"></a><span id="l15.52" class="difflineminus">-    rv = msgDBService-&gt;UnregisterPendingListener(this);</span>
<a href="#l15.53"></a><span id="l15.53" class="difflineplus">+  while (NS_SUCCEEDED(rv)) rv = msgDBService-&gt;UnregisterPendingListener(this);</span>
<a href="#l15.54"></a><span id="l15.54"> }</span>
<a href="#l15.55"></a><span id="l15.55"> </span>
<a href="#l15.56"></a><span id="l15.56"> NS_IMETHODIMP</span>
<a href="#l15.57"></a><span id="l15.57" class="difflineminus">-nsMsgXFVirtualFolderDBView::Close()</span>
<a href="#l15.58"></a><span id="l15.58" class="difflineminus">-{</span>
<a href="#l15.59"></a><span id="l15.59" class="difflineplus">+nsMsgXFVirtualFolderDBView::Close() {</span>
<a href="#l15.60"></a><span id="l15.60">   RemovePendingDBListeners();</span>
<a href="#l15.61"></a><span id="l15.61">   return nsMsgSearchDBView::Close();</span>
<a href="#l15.62"></a><span id="l15.62"> }</span>
<a href="#l15.63"></a><span id="l15.63"> </span>
<a href="#l15.64"></a><span id="l15.64"> NS_IMETHODIMP</span>
<a href="#l15.65"></a><span id="l15.65"> nsMsgXFVirtualFolderDBView::CloneDBView(nsIMessenger *aMessengerInstance,</span>
<a href="#l15.66"></a><span id="l15.66">                                         nsIMsgWindow *aMsgWindow,</span>
<a href="#l15.67"></a><span id="l15.67">                                         nsIMsgDBViewCommandUpdater *aCmdUpdater,</span>
<a href="#l15.68"></a><span id="l15.68" class="difflineminus">-                                        nsIMsgDBView **_retval)</span>
<a href="#l15.69"></a><span id="l15.69" class="difflineminus">-{</span>
<a href="#l15.70"></a><span id="l15.70" class="difflineminus">-  nsMsgXFVirtualFolderDBView* newMsgDBView = new nsMsgXFVirtualFolderDBView();</span>
<a href="#l15.71"></a><span id="l15.71" class="difflineminus">-  nsresult rv = CopyDBView(newMsgDBView, aMessengerInstance, aMsgWindow, aCmdUpdater);</span>
<a href="#l15.72"></a><span id="l15.72" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l15.73"></a><span id="l15.73" class="difflineplus">+                                        nsIMsgDBView **_retval) {</span>
<a href="#l15.74"></a><span id="l15.74" class="difflineplus">+  nsMsgXFVirtualFolderDBView *newMsgDBView = new nsMsgXFVirtualFolderDBView();</span>
<a href="#l15.75"></a><span id="l15.75" class="difflineplus">+  nsresult rv =</span>
<a href="#l15.76"></a><span id="l15.76" class="difflineplus">+      CopyDBView(newMsgDBView, aMessengerInstance, aMsgWindow, aCmdUpdater);</span>
<a href="#l15.77"></a><span id="l15.77" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.78"></a><span id="l15.78"> </span>
<a href="#l15.79"></a><span id="l15.79">   NS_IF_ADDREF(*_retval = newMsgDBView);</span>
<a href="#l15.80"></a><span id="l15.80">   return NS_OK;</span>
<a href="#l15.81"></a><span id="l15.81"> }</span>
<a href="#l15.82"></a><span id="l15.82"> </span>
<a href="#l15.83"></a><span id="l15.83"> NS_IMETHODIMP</span>
<a href="#l15.84"></a><span id="l15.84" class="difflineminus">-nsMsgXFVirtualFolderDBView::CopyDBView(nsMsgDBView *aNewMsgDBView,</span>
<a href="#l15.85"></a><span id="l15.85" class="difflineminus">-                                       nsIMessenger *aMessengerInstance,</span>
<a href="#l15.86"></a><span id="l15.86" class="difflineminus">-                                       nsIMsgWindow *aMsgWindow,</span>
<a href="#l15.87"></a><span id="l15.87" class="difflineminus">-                                       nsIMsgDBViewCommandUpdater *aCmdUpdater)</span>
<a href="#l15.88"></a><span id="l15.88" class="difflineminus">-{</span>
<a href="#l15.89"></a><span id="l15.89" class="difflineminus">-  nsMsgSearchDBView::CopyDBView(aNewMsgDBView, aMessengerInstance, aMsgWindow, aCmdUpdater);</span>
<a href="#l15.90"></a><span id="l15.90" class="difflineplus">+nsMsgXFVirtualFolderDBView::CopyDBView(</span>
<a href="#l15.91"></a><span id="l15.91" class="difflineplus">+    nsMsgDBView *aNewMsgDBView, nsIMessenger *aMessengerInstance,</span>
<a href="#l15.92"></a><span id="l15.92" class="difflineplus">+    nsIMsgWindow *aMsgWindow, nsIMsgDBViewCommandUpdater *aCmdUpdater) {</span>
<a href="#l15.93"></a><span id="l15.93" class="difflineplus">+  nsMsgSearchDBView::CopyDBView(aNewMsgDBView, aMessengerInstance, aMsgWindow,</span>
<a href="#l15.94"></a><span id="l15.94" class="difflineplus">+                                aCmdUpdater);</span>
<a href="#l15.95"></a><span id="l15.95"> </span>
<a href="#l15.96"></a><span id="l15.96" class="difflineminus">-  nsMsgXFVirtualFolderDBView* newMsgDBView = (nsMsgXFVirtualFolderDBView *) aNewMsgDBView;</span>
<a href="#l15.97"></a><span id="l15.97" class="difflineplus">+  nsMsgXFVirtualFolderDBView *newMsgDBView =</span>
<a href="#l15.98"></a><span id="l15.98" class="difflineplus">+      (nsMsgXFVirtualFolderDBView *)aNewMsgDBView;</span>
<a href="#l15.99"></a><span id="l15.99"> </span>
<a href="#l15.100"></a><span id="l15.100">   newMsgDBView-&gt;m_viewFolder = m_viewFolder;</span>
<a href="#l15.101"></a><span id="l15.101">   newMsgDBView-&gt;m_searchSession = m_searchSession;</span>
<a href="#l15.102"></a><span id="l15.102"> </span>
<a href="#l15.103"></a><span id="l15.103">   int32_t scopeCount;</span>
<a href="#l15.104"></a><span id="l15.104">   nsresult rv;</span>
<a href="#l15.105"></a><span id="l15.105" class="difflineminus">-  nsCOMPtr &lt;nsIMsgSearchSession&gt; searchSession =</span>
<a href="#l15.106"></a><span id="l15.106" class="difflineminus">-    do_QueryReferent(m_searchSession, &amp;rv);</span>
<a href="#l15.107"></a><span id="l15.107" class="difflineplus">+  nsCOMPtr&lt;nsIMsgSearchSession&gt; searchSession =</span>
<a href="#l15.108"></a><span id="l15.108" class="difflineplus">+      do_QueryReferent(m_searchSession, &amp;rv);</span>
<a href="#l15.109"></a><span id="l15.109">   // It's OK not to have a search session.</span>
<a href="#l15.110"></a><span id="l15.110">   NS_ENSURE_SUCCESS(rv, NS_OK);</span>
<a href="#l15.111"></a><span id="l15.111">   nsCOMPtr&lt;nsIMsgDBService&gt; msgDBService =</span>
<a href="#l15.112"></a><span id="l15.112" class="difflineminus">-    do_GetService(NS_MSGDB_SERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l15.113"></a><span id="l15.113" class="difflineplus">+      do_GetService(NS_MSGDB_SERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l15.114"></a><span id="l15.114">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.115"></a><span id="l15.115">   searchSession-&gt;CountSearchScopes(&amp;scopeCount);</span>
<a href="#l15.116"></a><span id="l15.116" class="difflineminus">-  for (int32_t i = 0; i &lt; scopeCount; i++)</span>
<a href="#l15.117"></a><span id="l15.117" class="difflineminus">-  {</span>
<a href="#l15.118"></a><span id="l15.118" class="difflineplus">+  for (int32_t i = 0; i &lt; scopeCount; i++) {</span>
<a href="#l15.119"></a><span id="l15.119">     nsMsgSearchScopeValue scopeId;</span>
<a href="#l15.120"></a><span id="l15.120">     nsCOMPtr&lt;nsIMsgFolder&gt; searchFolder;</span>
<a href="#l15.121"></a><span id="l15.121">     searchSession-&gt;GetNthSearchScope(i, &amp;scopeId, getter_AddRefs(searchFolder));</span>
<a href="#l15.122"></a><span id="l15.122">     if (searchFolder)</span>
<a href="#l15.123"></a><span id="l15.123">       msgDBService-&gt;RegisterPendingListener(searchFolder, newMsgDBView);</span>
<a href="#l15.124"></a><span id="l15.124">   }</span>
<a href="#l15.125"></a><span id="l15.125"> </span>
<a href="#l15.126"></a><span id="l15.126">   return NS_OK;</span>
<a href="#l15.127"></a><span id="l15.127"> }</span>
<a href="#l15.128"></a><span id="l15.128"> </span>
<a href="#l15.129"></a><span id="l15.129"> NS_IMETHODIMP</span>
<a href="#l15.130"></a><span id="l15.130" class="difflineminus">-nsMsgXFVirtualFolderDBView::GetViewType(nsMsgViewTypeValue *aViewType)</span>
<a href="#l15.131"></a><span id="l15.131" class="difflineminus">-{</span>
<a href="#l15.132"></a><span id="l15.132" class="difflineplus">+nsMsgXFVirtualFolderDBView::GetViewType(nsMsgViewTypeValue *aViewType) {</span>
<a href="#l15.133"></a><span id="l15.133">   NS_ENSURE_ARG_POINTER(aViewType);</span>
<a href="#l15.134"></a><span id="l15.134">   *aViewType = nsMsgViewType::eShowVirtualFolderResults;</span>
<a href="#l15.135"></a><span id="l15.135">   return NS_OK;</span>
<a href="#l15.136"></a><span id="l15.136"> }</span>
<a href="#l15.137"></a><span id="l15.137"> </span>
<a href="#l15.138"></a><span id="l15.138" class="difflineminus">-nsresult</span>
<a href="#l15.139"></a><span id="l15.139" class="difflineminus">-nsMsgXFVirtualFolderDBView::OnNewHeader(nsIMsgDBHdr *newHdr,</span>
<a href="#l15.140"></a><span id="l15.140" class="difflineminus">-                                        nsMsgKey aParentKey,</span>
<a href="#l15.141"></a><span id="l15.141" class="difflineminus">-                                        bool /*ensureListed*/)</span>
<a href="#l15.142"></a><span id="l15.142" class="difflineminus">-{</span>
<a href="#l15.143"></a><span id="l15.143" class="difflineminus">-  if (newHdr)</span>
<a href="#l15.144"></a><span id="l15.144" class="difflineminus">-  {</span>
<a href="#l15.145"></a><span id="l15.145" class="difflineplus">+nsresult nsMsgXFVirtualFolderDBView::OnNewHeader(nsIMsgDBHdr *newHdr,</span>
<a href="#l15.146"></a><span id="l15.146" class="difflineplus">+                                                 nsMsgKey aParentKey,</span>
<a href="#l15.147"></a><span id="l15.147" class="difflineplus">+                                                 bool /*ensureListed*/) {</span>
<a href="#l15.148"></a><span id="l15.148" class="difflineplus">+  if (newHdr) {</span>
<a href="#l15.149"></a><span id="l15.149">     bool match = false;</span>
<a href="#l15.150"></a><span id="l15.150" class="difflineminus">-    nsCOMPtr &lt;nsIMsgSearchSession&gt; searchSession =</span>
<a href="#l15.151"></a><span id="l15.151" class="difflineminus">-      do_QueryReferent(m_searchSession);</span>
<a href="#l15.152"></a><span id="l15.152" class="difflineplus">+    nsCOMPtr&lt;nsIMsgSearchSession&gt; searchSession =</span>
<a href="#l15.153"></a><span id="l15.153" class="difflineplus">+        do_QueryReferent(m_searchSession);</span>
<a href="#l15.154"></a><span id="l15.154"> </span>
<a href="#l15.155"></a><span id="l15.155" class="difflineminus">-    if (searchSession)</span>
<a href="#l15.156"></a><span id="l15.156" class="difflineminus">-      searchSession-&gt;MatchHdr(newHdr, m_db, &amp;match);</span>
<a href="#l15.157"></a><span id="l15.157" class="difflineplus">+    if (searchSession) searchSession-&gt;MatchHdr(newHdr, m_db, &amp;match);</span>
<a href="#l15.158"></a><span id="l15.158"> </span>
<a href="#l15.159"></a><span id="l15.159" class="difflineminus">-    if (!match)</span>
<a href="#l15.160"></a><span id="l15.160" class="difflineminus">-      match = WasHdrRecentlyDeleted(newHdr);</span>
<a href="#l15.161"></a><span id="l15.161" class="difflineplus">+    if (!match) match = WasHdrRecentlyDeleted(newHdr);</span>
<a href="#l15.162"></a><span id="l15.162"> </span>
<a href="#l15.163"></a><span id="l15.163" class="difflineminus">-    if (match)</span>
<a href="#l15.164"></a><span id="l15.164" class="difflineminus">-    {</span>
<a href="#l15.165"></a><span id="l15.165" class="difflineminus">-      nsCOMPtr &lt;nsIMsgFolder&gt; folder;</span>
<a href="#l15.166"></a><span id="l15.166" class="difflineplus">+    if (match) {</span>
<a href="#l15.167"></a><span id="l15.167" class="difflineplus">+      nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l15.168"></a><span id="l15.168">       newHdr-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l15.169"></a><span id="l15.169">       bool saveDoingSearch = m_doingSearch;</span>
<a href="#l15.170"></a><span id="l15.170">       m_doingSearch = false;</span>
<a href="#l15.171"></a><span id="l15.171">       OnSearchHit(newHdr, folder);</span>
<a href="#l15.172"></a><span id="l15.172">       m_doingSearch = saveDoingSearch;</span>
<a href="#l15.173"></a><span id="l15.173">     }</span>
<a href="#l15.174"></a><span id="l15.174">   }</span>
<a href="#l15.175"></a><span id="l15.175">   return NS_OK;</span>
<a href="#l15.176"></a><span id="l15.176"> }</span>
<a href="#l15.177"></a><span id="l15.177"> </span>
<a href="#l15.178"></a><span id="l15.178"> NS_IMETHODIMP</span>
<a href="#l15.179"></a><span id="l15.179" class="difflineminus">-nsMsgXFVirtualFolderDBView::OnHdrPropertyChanged(nsIMsgDBHdr *aHdrChanged,</span>
<a href="#l15.180"></a><span id="l15.180" class="difflineminus">-                                                 bool aPreChange,</span>
<a href="#l15.181"></a><span id="l15.181" class="difflineminus">-                                                 uint32_t *aStatus,</span>
<a href="#l15.182"></a><span id="l15.182" class="difflineminus">-                                                 nsIDBChangeListener *aInstigator)</span>
<a href="#l15.183"></a><span id="l15.183" class="difflineminus">-{</span>
<a href="#l15.184"></a><span id="l15.184" class="difflineplus">+nsMsgXFVirtualFolderDBView::OnHdrPropertyChanged(</span>
<a href="#l15.185"></a><span id="l15.185" class="difflineplus">+    nsIMsgDBHdr *aHdrChanged, bool aPreChange, uint32_t *aStatus,</span>
<a href="#l15.186"></a><span id="l15.186" class="difflineplus">+    nsIDBChangeListener *aInstigator) {</span>
<a href="#l15.187"></a><span id="l15.187">   // If the junk mail plugin just activated on a message, then</span>
<a href="#l15.188"></a><span id="l15.188">   // we'll allow filters to remove from view.</span>
<a href="#l15.189"></a><span id="l15.189">   // Otherwise, just update the view line.</span>
<a href="#l15.190"></a><span id="l15.190">   //</span>
<a href="#l15.191"></a><span id="l15.191">   // Note this will not add newly matched headers to the view. This is</span>
<a href="#l15.192"></a><span id="l15.192">   // probably a bug that needs fixing.</span>
<a href="#l15.193"></a><span id="l15.193"> </span>
<a href="#l15.194"></a><span id="l15.194">   NS_ENSURE_ARG_POINTER(aStatus);</span>
<a href="#l15.195"></a><span id="l15.195">   NS_ENSURE_ARG_POINTER(aHdrChanged);</span>
<a href="#l15.196"></a><span id="l15.196"> </span>
<a href="#l15.197"></a><span id="l15.197">   nsMsgViewIndex index = FindHdr(aHdrChanged);</span>
<a href="#l15.198"></a><span id="l15.198">   // Message does not appear in view.</span>
<a href="#l15.199"></a><span id="l15.199" class="difflineminus">-  if (index == nsMsgViewIndex_None)</span>
<a href="#l15.200"></a><span id="l15.200" class="difflineminus">-    return NS_OK;</span>
<a href="#l15.201"></a><span id="l15.201" class="difflineplus">+  if (index == nsMsgViewIndex_None) return NS_OK;</span>
<a href="#l15.202"></a><span id="l15.202"> </span>
<a href="#l15.203"></a><span id="l15.203">   nsCString originStr;</span>
<a href="#l15.204"></a><span id="l15.204" class="difflineminus">-  (void) aHdrChanged-&gt;GetStringProperty(&quot;junkscoreorigin&quot;, getter_Copies(originStr));</span>
<a href="#l15.205"></a><span id="l15.205" class="difflineplus">+  (void)aHdrChanged-&gt;GetStringProperty(&quot;junkscoreorigin&quot;,</span>
<a href="#l15.206"></a><span id="l15.206" class="difflineplus">+                                       getter_Copies(originStr));</span>
<a href="#l15.207"></a><span id="l15.207">   // Check for &quot;plugin&quot; with only first character for performance.</span>
<a href="#l15.208"></a><span id="l15.208">   bool plugin = (originStr.get()[0] == 'p');</span>
<a href="#l15.209"></a><span id="l15.209"> </span>
<a href="#l15.210"></a><span id="l15.210" class="difflineminus">-  if (aPreChange)</span>
<a href="#l15.211"></a><span id="l15.211" class="difflineminus">-  {</span>
<a href="#l15.212"></a><span id="l15.212" class="difflineplus">+  if (aPreChange) {</span>
<a href="#l15.213"></a><span id="l15.213">     // First call, done prior to the change.</span>
<a href="#l15.214"></a><span id="l15.214">     *aStatus = plugin;</span>
<a href="#l15.215"></a><span id="l15.215">     return NS_OK;</span>
<a href="#l15.216"></a><span id="l15.216">   }</span>
<a href="#l15.217"></a><span id="l15.217"> </span>
<a href="#l15.218"></a><span id="l15.218">   // Second call, done after the change.</span>
<a href="#l15.219"></a><span id="l15.219">   bool wasPlugin = *aStatus;</span>
<a href="#l15.220"></a><span id="l15.220"> </span>
<a href="#l15.221"></a><span id="l15.221">   bool match = true;</span>
<a href="#l15.222"></a><span id="l15.222" class="difflineminus">-  nsCOMPtr&lt;nsIMsgSearchSession&gt; searchSession(do_QueryReferent(m_searchSession));</span>
<a href="#l15.223"></a><span id="l15.223" class="difflineminus">-  if (searchSession)</span>
<a href="#l15.224"></a><span id="l15.224" class="difflineminus">-    searchSession-&gt;MatchHdr(aHdrChanged, m_db, &amp;match);</span>
<a href="#l15.225"></a><span id="l15.225" class="difflineplus">+  nsCOMPtr&lt;nsIMsgSearchSession&gt; searchSession(</span>
<a href="#l15.226"></a><span id="l15.226" class="difflineplus">+      do_QueryReferent(m_searchSession));</span>
<a href="#l15.227"></a><span id="l15.227" class="difflineplus">+  if (searchSession) searchSession-&gt;MatchHdr(aHdrChanged, m_db, &amp;match);</span>
<a href="#l15.228"></a><span id="l15.228"> </span>
<a href="#l15.229"></a><span id="l15.229">   if (!match &amp;&amp; plugin &amp;&amp; !wasPlugin)</span>
<a href="#l15.230"></a><span id="l15.230">     // Remove hdr from view.</span>
<a href="#l15.231"></a><span id="l15.231">     RemoveByIndex(index);</span>
<a href="#l15.232"></a><span id="l15.232">   else</span>
<a href="#l15.233"></a><span id="l15.233">     NoteChange(index, 1, nsMsgViewNotificationCode::changed);</span>
<a href="#l15.234"></a><span id="l15.234"> </span>
<a href="#l15.235"></a><span id="l15.235">   return NS_OK;</span>
<a href="#l15.236"></a><span id="l15.236"> }</span>
<a href="#l15.237"></a><span id="l15.237"> </span>
<a href="#l15.238"></a><span id="l15.238" class="difflineminus">-void</span>
<a href="#l15.239"></a><span id="l15.239" class="difflineminus">-nsMsgXFVirtualFolderDBView::UpdateCacheAndViewForFolder(nsIMsgFolder *folder,</span>
<a href="#l15.240"></a><span id="l15.240" class="difflineminus">-                                                        nsMsgKey *newHits,</span>
<a href="#l15.241"></a><span id="l15.241" class="difflineminus">-                                                        uint32_t numNewHits)</span>
<a href="#l15.242"></a><span id="l15.242" class="difflineminus">-{</span>
<a href="#l15.243"></a><span id="l15.243" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDatabase&gt; db;</span>
<a href="#l15.244"></a><span id="l15.244" class="difflineplus">+void nsMsgXFVirtualFolderDBView::UpdateCacheAndViewForFolder(</span>
<a href="#l15.245"></a><span id="l15.245" class="difflineplus">+    nsIMsgFolder *folder, nsMsgKey *newHits, uint32_t numNewHits) {</span>
<a href="#l15.246"></a><span id="l15.246" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l15.247"></a><span id="l15.247">   nsresult rv = folder-&gt;GetMsgDatabase(getter_AddRefs(db));</span>
<a href="#l15.248"></a><span id="l15.248" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; db)</span>
<a href="#l15.249"></a><span id="l15.249" class="difflineminus">-  {</span>
<a href="#l15.250"></a><span id="l15.250" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; db) {</span>
<a href="#l15.251"></a><span id="l15.251">     nsCString searchUri;</span>
<a href="#l15.252"></a><span id="l15.252">     m_viewFolder-&gt;GetURI(searchUri);</span>
<a href="#l15.253"></a><span id="l15.253">     uint32_t numBadHits;</span>
<a href="#l15.254"></a><span id="l15.254">     nsMsgKey *badHits;</span>
<a href="#l15.255"></a><span id="l15.255" class="difflineminus">-    rv = db-&gt;RefreshCache(searchUri.get(),</span>
<a href="#l15.256"></a><span id="l15.256" class="difflineminus">-                          numNewHits,</span>
<a href="#l15.257"></a><span id="l15.257" class="difflineminus">-                          newHits,</span>
<a href="#l15.258"></a><span id="l15.258" class="difflineminus">-                          &amp;numBadHits,</span>
<a href="#l15.259"></a><span id="l15.259" class="difflineplus">+    rv = db-&gt;RefreshCache(searchUri.get(), numNewHits, newHits, &amp;numBadHits,</span>
<a href="#l15.260"></a><span id="l15.260">                           &amp;badHits);</span>
<a href="#l15.261"></a><span id="l15.261" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l15.262"></a><span id="l15.262" class="difflineminus">-    {</span>
<a href="#l15.263"></a><span id="l15.263" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l15.264"></a><span id="l15.264">       nsCOMPtr&lt;nsIMsgDBHdr&gt; badHdr;</span>
<a href="#l15.265"></a><span id="l15.265" class="difflineminus">-      for (uint32_t badHitIndex = 0; badHitIndex &lt; numBadHits; badHitIndex++)</span>
<a href="#l15.266"></a><span id="l15.266" class="difflineminus">-      {</span>
<a href="#l15.267"></a><span id="l15.267" class="difflineplus">+      for (uint32_t badHitIndex = 0; badHitIndex &lt; numBadHits; badHitIndex++) {</span>
<a href="#l15.268"></a><span id="l15.268">         // ### of course, this isn't quite right, since we should be</span>
<a href="#l15.269"></a><span id="l15.269">         // using FindHdr, and we shouldn't be expanding the threads.</span>
<a href="#l15.270"></a><span id="l15.270">         db-&gt;GetMsgHdrForKey(badHits[badHitIndex], getter_AddRefs(badHdr));</span>
<a href="#l15.271"></a><span id="l15.271">         // Let nsMsgSearchDBView decide what to do about this header</span>
<a href="#l15.272"></a><span id="l15.272">         // getting removed.</span>
<a href="#l15.273"></a><span id="l15.273" class="difflineminus">-        if (badHdr)</span>
<a href="#l15.274"></a><span id="l15.274" class="difflineminus">-          OnHdrDeleted(badHdr, nsMsgKey_None, 0, this);</span>
<a href="#l15.275"></a><span id="l15.275" class="difflineplus">+        if (badHdr) OnHdrDeleted(badHdr, nsMsgKey_None, 0, this);</span>
<a href="#l15.276"></a><span id="l15.276">       }</span>
<a href="#l15.277"></a><span id="l15.277"> </span>
<a href="#l15.278"></a><span id="l15.278" class="difflineminus">-      delete [] badHits;</span>
<a href="#l15.279"></a><span id="l15.279" class="difflineplus">+      delete[] badHits;</span>
<a href="#l15.280"></a><span id="l15.280">     }</span>
<a href="#l15.281"></a><span id="l15.281">   }</span>
<a href="#l15.282"></a><span id="l15.282"> }</span>
<a href="#l15.283"></a><span id="l15.283"> </span>
<a href="#l15.284"></a><span id="l15.284" class="difflineminus">-void</span>
<a href="#l15.285"></a><span id="l15.285" class="difflineminus">-nsMsgXFVirtualFolderDBView::UpdateCacheAndViewForPrevSearchedFolders(nsIMsgFolder *curSearchFolder)</span>
<a href="#l15.286"></a><span id="l15.286" class="difflineminus">-{</span>
<a href="#l15.287"></a><span id="l15.287" class="difflineplus">+void nsMsgXFVirtualFolderDBView::UpdateCacheAndViewForPrevSearchedFolders(</span>
<a href="#l15.288"></a><span id="l15.288" class="difflineplus">+    nsIMsgFolder *curSearchFolder) {</span>
<a href="#l15.289"></a><span id="l15.289">   // Handle the most recent folder with hits, if any.</span>
<a href="#l15.290"></a><span id="l15.290" class="difflineminus">-  if (m_curFolderGettingHits)</span>
<a href="#l15.291"></a><span id="l15.291" class="difflineminus">-  {</span>
<a href="#l15.292"></a><span id="l15.292" class="difflineplus">+  if (m_curFolderGettingHits) {</span>
<a href="#l15.293"></a><span id="l15.293">     uint32_t count = m_hdrHits.Count();</span>
<a href="#l15.294"></a><span id="l15.294">     nsTArray&lt;nsMsgKey&gt; newHits;</span>
<a href="#l15.295"></a><span id="l15.295">     newHits.SetLength(count);</span>
<a href="#l15.296"></a><span id="l15.296">     for (uint32_t i = 0; i &lt; count; i++)</span>
<a href="#l15.297"></a><span id="l15.297">       m_hdrHits[i]-&gt;GetMessageKey(&amp;newHits[i]);</span>
<a href="#l15.298"></a><span id="l15.298"> </span>
<a href="#l15.299"></a><span id="l15.299">     newHits.Sort();</span>
<a href="#l15.300"></a><span id="l15.300" class="difflineminus">-    UpdateCacheAndViewForFolder(m_curFolderGettingHits,</span>
<a href="#l15.301"></a><span id="l15.301" class="difflineminus">-                                newHits.Elements(),</span>
<a href="#l15.302"></a><span id="l15.302" class="difflineplus">+    UpdateCacheAndViewForFolder(m_curFolderGettingHits, newHits.Elements(),</span>
<a href="#l15.303"></a><span id="l15.303">                                 newHits.Length());</span>
<a href="#l15.304"></a><span id="l15.304">     m_foldersSearchingOver.RemoveObject(m_curFolderGettingHits);</span>
<a href="#l15.305"></a><span id="l15.305">   }</span>
<a href="#l15.306"></a><span id="l15.306"> </span>
<a href="#l15.307"></a><span id="l15.307" class="difflineminus">-  while (m_foldersSearchingOver.Count() &gt; 0)</span>
<a href="#l15.308"></a><span id="l15.308" class="difflineminus">-  {</span>
<a href="#l15.309"></a><span id="l15.309" class="difflineplus">+  while (m_foldersSearchingOver.Count() &gt; 0) {</span>
<a href="#l15.310"></a><span id="l15.310">     // This new folder has cached hits.</span>
<a href="#l15.311"></a><span id="l15.311" class="difflineminus">-    if (m_foldersSearchingOver[0] == curSearchFolder)</span>
<a href="#l15.312"></a><span id="l15.312" class="difflineminus">-    {</span>
<a href="#l15.313"></a><span id="l15.313" class="difflineplus">+    if (m_foldersSearchingOver[0] == curSearchFolder) {</span>
<a href="#l15.314"></a><span id="l15.314">       m_curFolderHasCachedHits = true;</span>
<a href="#l15.315"></a><span id="l15.315">       m_foldersSearchingOver.RemoveObjectAt(0);</span>
<a href="#l15.316"></a><span id="l15.316">       break;</span>
<a href="#l15.317"></a><span id="l15.317" class="difflineminus">-    }</span>
<a href="#l15.318"></a><span id="l15.318" class="difflineminus">-    else</span>
<a href="#l15.319"></a><span id="l15.319" class="difflineminus">-    {</span>
<a href="#l15.320"></a><span id="l15.320" class="difflineplus">+    } else {</span>
<a href="#l15.321"></a><span id="l15.321">       // This must be a folder that had no hits with the current search.</span>
<a href="#l15.322"></a><span id="l15.322">       // So all cached hits, if any, need to be removed.</span>
<a href="#l15.323"></a><span id="l15.323">       UpdateCacheAndViewForFolder(m_foldersSearchingOver[0], nullptr, 0);</span>
<a href="#l15.324"></a><span id="l15.324">       m_foldersSearchingOver.RemoveObjectAt(0);</span>
<a href="#l15.325"></a><span id="l15.325">     }</span>
<a href="#l15.326"></a><span id="l15.326">   }</span>
<a href="#l15.327"></a><span id="l15.327"> }</span>
<a href="#l15.328"></a><span id="l15.328"> NS_IMETHODIMP</span>
<a href="#l15.329"></a><span id="l15.329" class="difflineminus">-nsMsgXFVirtualFolderDBView::OnSearchHit(nsIMsgDBHdr* aMsgHdr,</span>
<a href="#l15.330"></a><span id="l15.330" class="difflineminus">-                                        nsIMsgFolder *aFolder)</span>
<a href="#l15.331"></a><span id="l15.331" class="difflineminus">-{</span>
<a href="#l15.332"></a><span id="l15.332" class="difflineplus">+nsMsgXFVirtualFolderDBView::OnSearchHit(nsIMsgDBHdr *aMsgHdr,</span>
<a href="#l15.333"></a><span id="l15.333" class="difflineplus">+                                        nsIMsgFolder *aFolder) {</span>
<a href="#l15.334"></a><span id="l15.334">   NS_ENSURE_ARG(aMsgHdr);</span>
<a href="#l15.335"></a><span id="l15.335">   NS_ENSURE_ARG(aFolder);</span>
<a href="#l15.336"></a><span id="l15.336"> </span>
<a href="#l15.337"></a><span id="l15.337" class="difflineminus">-  if (m_curFolderGettingHits != aFolder &amp;&amp; m_doingSearch &amp;&amp; !m_doingQuickSearch)</span>
<a href="#l15.338"></a><span id="l15.338" class="difflineminus">-  {</span>
<a href="#l15.339"></a><span id="l15.339" class="difflineplus">+  if (m_curFolderGettingHits != aFolder &amp;&amp; m_doingSearch &amp;&amp;</span>
<a href="#l15.340"></a><span id="l15.340" class="difflineplus">+      !m_doingQuickSearch) {</span>
<a href="#l15.341"></a><span id="l15.341">     m_curFolderHasCachedHits = false;</span>
<a href="#l15.342"></a><span id="l15.342">     // Since we've gotten a hit for a new folder, the searches for</span>
<a href="#l15.343"></a><span id="l15.343">     // any previous folders are done, so deal with stale cached hits</span>
<a href="#l15.344"></a><span id="l15.344">     // for those folders now.</span>
<a href="#l15.345"></a><span id="l15.345">     UpdateCacheAndViewForPrevSearchedFolders(aFolder);</span>
<a href="#l15.346"></a><span id="l15.346">     m_curFolderGettingHits = aFolder;</span>
<a href="#l15.347"></a><span id="l15.347">     m_hdrHits.Clear();</span>
<a href="#l15.348"></a><span id="l15.348">     m_curFolderStartKeyIndex = m_keys.Length();</span>
<a href="#l15.349"></a><span id="l15.349">   }</span>
<a href="#l15.350"></a><span id="l15.350"> </span>
<a href="#l15.351"></a><span id="l15.351">   bool hdrInCache = false;</span>
<a href="#l15.352"></a><span id="l15.352" class="difflineminus">-  if (!m_doingQuickSearch)</span>
<a href="#l15.353"></a><span id="l15.353" class="difflineminus">-  {</span>
<a href="#l15.354"></a><span id="l15.354" class="difflineplus">+  if (!m_doingQuickSearch) {</span>
<a href="#l15.355"></a><span id="l15.355">     nsCOMPtr&lt;nsIMsgDatabase&gt; dbToUse;</span>
<a href="#l15.356"></a><span id="l15.356">     nsCOMPtr&lt;nsIDBFolderInfo&gt; dummyInfo;</span>
<a href="#l15.357"></a><span id="l15.357" class="difflineminus">-    nsresult rv = aFolder-&gt;GetDBFolderInfoAndDB(getter_AddRefs(dummyInfo), getter_AddRefs(dbToUse));</span>
<a href="#l15.358"></a><span id="l15.358" class="difflineplus">+    nsresult rv = aFolder-&gt;GetDBFolderInfoAndDB(getter_AddRefs(dummyInfo),</span>
<a href="#l15.359"></a><span id="l15.359" class="difflineplus">+                                                getter_AddRefs(dbToUse));</span>
<a href="#l15.360"></a><span id="l15.360">     if (NS_SUCCEEDED(rv)) {</span>
<a href="#l15.361"></a><span id="l15.361">       nsCString searchUri;</span>
<a href="#l15.362"></a><span id="l15.362">       m_viewFolder-&gt;GetURI(searchUri);</span>
<a href="#l15.363"></a><span id="l15.363">       dbToUse-&gt;HdrIsInCache(searchUri.get(), aMsgHdr, &amp;hdrInCache);</span>
<a href="#l15.364"></a><span id="l15.364">     }</span>
<a href="#l15.365"></a><span id="l15.365">   }</span>
<a href="#l15.366"></a><span id="l15.366"> </span>
<a href="#l15.367"></a><span id="l15.367" class="difflineminus">-  if (!m_doingSearch || !m_curFolderHasCachedHits || !hdrInCache)</span>
<a href="#l15.368"></a><span id="l15.368" class="difflineminus">-  {</span>
<a href="#l15.369"></a><span id="l15.369" class="difflineplus">+  if (!m_doingSearch || !m_curFolderHasCachedHits || !hdrInCache) {</span>
<a href="#l15.370"></a><span id="l15.370">     if (m_viewFlags &amp; nsMsgViewFlagsType::kGroupBySort)</span>
<a href="#l15.371"></a><span id="l15.371">       nsMsgGroupView::OnNewHeader(aMsgHdr, nsMsgKey_None, true);</span>
<a href="#l15.372"></a><span id="l15.372">     else if (m_sortValid)</span>
<a href="#l15.373"></a><span id="l15.373">       InsertHdrFromFolder(aMsgHdr, aFolder);</span>
<a href="#l15.374"></a><span id="l15.374">     else</span>
<a href="#l15.375"></a><span id="l15.375">       AddHdrFromFolder(aMsgHdr, aFolder);</span>
<a href="#l15.376"></a><span id="l15.376">   }</span>
<a href="#l15.377"></a><span id="l15.377"> </span>
<a href="#l15.378"></a><span id="l15.378">   m_hdrHits.AppendObject(aMsgHdr);</span>
<a href="#l15.379"></a><span id="l15.379">   m_totalMessagesInView++;</span>
<a href="#l15.380"></a><span id="l15.380"> </span>
<a href="#l15.381"></a><span id="l15.381">   return NS_OK;</span>
<a href="#l15.382"></a><span id="l15.382"> }</span>
<a href="#l15.383"></a><span id="l15.383"> </span>
<a href="#l15.384"></a><span id="l15.384"> NS_IMETHODIMP</span>
<a href="#l15.385"></a><span id="l15.385" class="difflineminus">-nsMsgXFVirtualFolderDBView::OnSearchDone(nsresult status)</span>
<a href="#l15.386"></a><span id="l15.386" class="difflineminus">-{</span>
<a href="#l15.387"></a><span id="l15.387" class="difflineplus">+nsMsgXFVirtualFolderDBView::OnSearchDone(nsresult status) {</span>
<a href="#l15.388"></a><span id="l15.388">   NS_ENSURE_TRUE(m_viewFolder, NS_ERROR_NOT_INITIALIZED);</span>
<a href="#l15.389"></a><span id="l15.389"> </span>
<a href="#l15.390"></a><span id="l15.390">   // Handle any non verified hits we haven't handled yet.</span>
<a href="#l15.391"></a><span id="l15.391" class="difflineminus">-  if (NS_SUCCEEDED(status) &amp;&amp; !m_doingQuickSearch &amp;&amp; status != NS_MSG_SEARCH_INTERRUPTED)</span>
<a href="#l15.392"></a><span id="l15.392" class="difflineplus">+  if (NS_SUCCEEDED(status) &amp;&amp; !m_doingQuickSearch &amp;&amp;</span>
<a href="#l15.393"></a><span id="l15.393" class="difflineplus">+      status != NS_MSG_SEARCH_INTERRUPTED)</span>
<a href="#l15.394"></a><span id="l15.394">     UpdateCacheAndViewForPrevSearchedFolders(nullptr);</span>
<a href="#l15.395"></a><span id="l15.395"> </span>
<a href="#l15.396"></a><span id="l15.396">   m_doingSearch = false;</span>
<a href="#l15.397"></a><span id="l15.397">   // We want to set imap delete model once the search is over because setting</span>
<a href="#l15.398"></a><span id="l15.398">   // next message after deletion will happen before deleting the message and</span>
<a href="#l15.399"></a><span id="l15.399">   // search scope can change with every search.</span>
<a href="#l15.400"></a><span id="l15.400"> </span>
<a href="#l15.401"></a><span id="l15.401">   // Set to default in case it is non-imap folder.</span>
<a href="#l15.402"></a><span id="l15.402">   mDeleteModel = nsMsgImapDeleteModels::MoveToTrash;</span>
<a href="#l15.403"></a><span id="l15.403">   nsIMsgFolder *curFolder = m_folders.SafeObjectAt(0);</span>
<a href="#l15.404"></a><span id="l15.404" class="difflineminus">-  if (curFolder)</span>
<a href="#l15.405"></a><span id="l15.405" class="difflineminus">-    GetImapDeleteModel(curFolder);</span>
<a href="#l15.406"></a><span id="l15.406" class="difflineplus">+  if (curFolder) GetImapDeleteModel(curFolder);</span>
<a href="#l15.407"></a><span id="l15.407"> </span>
<a href="#l15.408"></a><span id="l15.408">   nsCOMPtr&lt;nsIMsgDatabase&gt; virtDatabase;</span>
<a href="#l15.409"></a><span id="l15.409">   nsCOMPtr&lt;nsIDBFolderInfo&gt; dbFolderInfo;</span>
<a href="#l15.410"></a><span id="l15.410" class="difflineminus">-  nsresult rv = m_viewFolder-&gt;GetDBFolderInfoAndDB(getter_AddRefs(dbFolderInfo),</span>
<a href="#l15.411"></a><span id="l15.411" class="difflineminus">-                                                   getter_AddRefs(virtDatabase));</span>
<a href="#l15.412"></a><span id="l15.412" class="difflineplus">+  nsresult rv = m_viewFolder-&gt;GetDBFolderInfoAndDB(</span>
<a href="#l15.413"></a><span id="l15.413" class="difflineplus">+      getter_AddRefs(dbFolderInfo), getter_AddRefs(virtDatabase));</span>
<a href="#l15.414"></a><span id="l15.414">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.415"></a><span id="l15.415">   // Count up the number of unread and total messages from the view, and set</span>
<a href="#l15.416"></a><span id="l15.416">   // those in the folder - easier than trying to keep the count up to date in</span>
<a href="#l15.417"></a><span id="l15.417">   // the face of search hits coming in while the user is reading/deleting</span>
<a href="#l15.418"></a><span id="l15.418">   // messages.</span>
<a href="#l15.419"></a><span id="l15.419">   uint32_t numUnread = 0;</span>
<a href="#l15.420"></a><span id="l15.420" class="difflineminus">-  for (uint32_t i = 0; i &lt; m_flags.Length(); i++)</span>
<a href="#l15.421"></a><span id="l15.421" class="difflineminus">-  {</span>
<a href="#l15.422"></a><span id="l15.422" class="difflineminus">-    if (m_flags[i] &amp; nsMsgMessageFlags::Elided)</span>
<a href="#l15.423"></a><span id="l15.423" class="difflineminus">-    {</span>
<a href="#l15.424"></a><span id="l15.424" class="difflineplus">+  for (uint32_t i = 0; i &lt; m_flags.Length(); i++) {</span>
<a href="#l15.425"></a><span id="l15.425" class="difflineplus">+    if (m_flags[i] &amp; nsMsgMessageFlags::Elided) {</span>
<a href="#l15.426"></a><span id="l15.426">       nsCOMPtr&lt;nsIMsgThread&gt; thread;</span>
<a href="#l15.427"></a><span id="l15.427">       GetThreadContainingIndex(i, getter_AddRefs(thread));</span>
<a href="#l15.428"></a><span id="l15.428" class="difflineminus">-      if (thread)</span>
<a href="#l15.429"></a><span id="l15.429" class="difflineminus">-      {</span>
<a href="#l15.430"></a><span id="l15.430" class="difflineplus">+      if (thread) {</span>
<a href="#l15.431"></a><span id="l15.431">         uint32_t unreadInThread;</span>
<a href="#l15.432"></a><span id="l15.432">         thread-&gt;GetNumUnreadChildren(&amp;unreadInThread);</span>
<a href="#l15.433"></a><span id="l15.433">         numUnread += unreadInThread;</span>
<a href="#l15.434"></a><span id="l15.434">       }</span>
<a href="#l15.435"></a><span id="l15.435" class="difflineminus">-    }</span>
<a href="#l15.436"></a><span id="l15.436" class="difflineminus">-    else</span>
<a href="#l15.437"></a><span id="l15.437" class="difflineminus">-    {</span>
<a href="#l15.438"></a><span id="l15.438" class="difflineminus">-      if (!(m_flags[i] &amp; nsMsgMessageFlags::Read))</span>
<a href="#l15.439"></a><span id="l15.439" class="difflineminus">-        numUnread++;</span>
<a href="#l15.440"></a><span id="l15.440" class="difflineplus">+    } else {</span>
<a href="#l15.441"></a><span id="l15.441" class="difflineplus">+      if (!(m_flags[i] &amp; nsMsgMessageFlags::Read)) numUnread++;</span>
<a href="#l15.442"></a><span id="l15.442">     }</span>
<a href="#l15.443"></a><span id="l15.443">   }</span>
<a href="#l15.444"></a><span id="l15.444"> </span>
<a href="#l15.445"></a><span id="l15.445">   dbFolderInfo-&gt;SetNumUnreadMessages(numUnread);</span>
<a href="#l15.446"></a><span id="l15.446">   dbFolderInfo-&gt;SetNumMessages(m_totalMessagesInView);</span>
<a href="#l15.447"></a><span id="l15.447">   // Force update from db.</span>
<a href="#l15.448"></a><span id="l15.448">   m_viewFolder-&gt;UpdateSummaryTotals(true);</span>
<a href="#l15.449"></a><span id="l15.449">   virtDatabase-&gt;Commit(nsMsgDBCommitType::kLargeCommit);</span>
<a href="#l15.450"></a><span id="l15.450">   if (!m_sortValid &amp;&amp; m_sortType != nsMsgViewSortType::byThread &amp;&amp;</span>
<a href="#l15.451"></a><span id="l15.451" class="difflineminus">-      !(m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay))</span>
<a href="#l15.452"></a><span id="l15.452" class="difflineminus">-  {</span>
<a href="#l15.453"></a><span id="l15.453" class="difflineplus">+      !(m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay)) {</span>
<a href="#l15.454"></a><span id="l15.454">     // Sort the results.</span>
<a href="#l15.455"></a><span id="l15.455">     m_sortValid = false;</span>
<a href="#l15.456"></a><span id="l15.456">     Sort(m_sortType, m_sortOrder);</span>
<a href="#l15.457"></a><span id="l15.457">   }</span>
<a href="#l15.458"></a><span id="l15.458"> </span>
<a href="#l15.459"></a><span id="l15.459">   m_foldersSearchingOver.Clear();</span>
<a href="#l15.460"></a><span id="l15.460">   m_curFolderGettingHits = nullptr;</span>
<a href="#l15.461"></a><span id="l15.461">   return rv;</span>
<a href="#l15.462"></a><span id="l15.462"> }</span>
<a href="#l15.463"></a><span id="l15.463"> </span>
<a href="#l15.464"></a><span id="l15.464" class="difflineminus">-</span>
<a href="#l15.465"></a><span id="l15.465"> NS_IMETHODIMP</span>
<a href="#l15.466"></a><span id="l15.466" class="difflineminus">-nsMsgXFVirtualFolderDBView::OnNewSearch()</span>
<a href="#l15.467"></a><span id="l15.467" class="difflineminus">-{</span>
<a href="#l15.468"></a><span id="l15.468" class="difflineplus">+nsMsgXFVirtualFolderDBView::OnNewSearch() {</span>
<a href="#l15.469"></a><span id="l15.469">   int32_t oldSize = GetSize();</span>
<a href="#l15.470"></a><span id="l15.470"> </span>
<a href="#l15.471"></a><span id="l15.471">   RemovePendingDBListeners();</span>
<a href="#l15.472"></a><span id="l15.472">   m_doingSearch = true;</span>
<a href="#l15.473"></a><span id="l15.473">   m_totalMessagesInView = 0;</span>
<a href="#l15.474"></a><span id="l15.474">   m_folders.Clear();</span>
<a href="#l15.475"></a><span id="l15.475">   m_keys.Clear();</span>
<a href="#l15.476"></a><span id="l15.476">   m_levels.Clear();</span>
<a href="#l15.477"></a><span id="l15.477">   m_flags.Clear();</span>
<a href="#l15.478"></a><span id="l15.478"> </span>
<a href="#l15.479"></a><span id="l15.479">   // Needs to happen after we remove the keys, since RowCountChanged() will</span>
<a href="#l15.480"></a><span id="l15.480">   // call our GetRowCount().</span>
<a href="#l15.481"></a><span id="l15.481" class="difflineminus">-  if (mTree)</span>
<a href="#l15.482"></a><span id="l15.482" class="difflineminus">-    mTree-&gt;RowCountChanged(0, -oldSize);</span>
<a href="#l15.483"></a><span id="l15.483" class="difflineplus">+  if (mTree) mTree-&gt;RowCountChanged(0, -oldSize);</span>
<a href="#l15.484"></a><span id="l15.484"> </span>
<a href="#l15.485"></a><span id="l15.485">   // To use the search results cache, we'll need to iterate over the scopes</span>
<a href="#l15.486"></a><span id="l15.486">   // in the search session, calling getNthSearchScope</span>
<a href="#l15.487"></a><span id="l15.487">   // for i = 0; i &lt; searchSession.countSearchScopes; i++</span>
<a href="#l15.488"></a><span id="l15.488">   // and for each folder, then open the db and pull out the cached hits,</span>
<a href="#l15.489"></a><span id="l15.489">   // add them to the view. For each hit in a new folder, we'll then clean up</span>
<a href="#l15.490"></a><span id="l15.490">   // the stale hits from the previous folder(s).</span>
<a href="#l15.491"></a><span id="l15.491"> </span>
<a href="#l15.492"></a><span id="l15.492">   int32_t scopeCount;</span>
<a href="#l15.493"></a><span id="l15.493" class="difflineminus">-  nsCOMPtr&lt;nsIMsgSearchSession&gt; searchSession = do_QueryReferent(m_searchSession);</span>
<a href="#l15.494"></a><span id="l15.494" class="difflineplus">+  nsCOMPtr&lt;nsIMsgSearchSession&gt; searchSession =</span>
<a href="#l15.495"></a><span id="l15.495" class="difflineplus">+      do_QueryReferent(m_searchSession);</span>
<a href="#l15.496"></a><span id="l15.496">   // Just ignore.</span>
<a href="#l15.497"></a><span id="l15.497">   NS_ENSURE_TRUE(searchSession, NS_OK);</span>
<a href="#l15.498"></a><span id="l15.498" class="difflineminus">-  nsCOMPtr&lt;nsIMsgDBService&gt; msgDBService = do_GetService(NS_MSGDB_SERVICE_CONTRACTID);</span>
<a href="#l15.499"></a><span id="l15.499" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBService&gt; msgDBService =</span>
<a href="#l15.500"></a><span id="l15.500" class="difflineplus">+      do_GetService(NS_MSGDB_SERVICE_CONTRACTID);</span>
<a href="#l15.501"></a><span id="l15.501">   searchSession-&gt;CountSearchScopes(&amp;scopeCount);</span>
<a href="#l15.502"></a><span id="l15.502"> </span>
<a href="#l15.503"></a><span id="l15.503">   // Figure out how many search terms the virtual folder has.</span>
<a href="#l15.504"></a><span id="l15.504">   nsCOMPtr&lt;nsIMsgDatabase&gt; virtDatabase;</span>
<a href="#l15.505"></a><span id="l15.505">   nsCOMPtr&lt;nsIDBFolderInfo&gt; dbFolderInfo;</span>
<a href="#l15.506"></a><span id="l15.506" class="difflineminus">-  nsresult rv = m_viewFolder-&gt;GetDBFolderInfoAndDB(getter_AddRefs(dbFolderInfo),</span>
<a href="#l15.507"></a><span id="l15.507" class="difflineminus">-                                                   getter_AddRefs(virtDatabase));</span>
<a href="#l15.508"></a><span id="l15.508" class="difflineplus">+  nsresult rv = m_viewFolder-&gt;GetDBFolderInfoAndDB(</span>
<a href="#l15.509"></a><span id="l15.509" class="difflineplus">+      getter_AddRefs(dbFolderInfo), getter_AddRefs(virtDatabase));</span>
<a href="#l15.510"></a><span id="l15.510">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.511"></a><span id="l15.511"> </span>
<a href="#l15.512"></a><span id="l15.512">   nsCString terms;</span>
<a href="#l15.513"></a><span id="l15.513">   dbFolderInfo-&gt;GetCharProperty(&quot;searchStr&quot;, terms);</span>
<a href="#l15.514"></a><span id="l15.514">   nsCOMPtr&lt;nsIMutableArray&gt; searchTerms;</span>
<a href="#l15.515"></a><span id="l15.515">   rv = searchSession-&gt;GetSearchTerms(getter_AddRefs(searchTerms));</span>
<a href="#l15.516"></a><span id="l15.516">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.517"></a><span id="l15.517">   nsCString curSearchAsString;</span>
<a href="#l15.518"></a><span id="l15.518"> </span>
<a href="#l15.519"></a><span id="l15.519">   rv = MsgTermListToString(searchTerms, curSearchAsString);</span>
<a href="#l15.520"></a><span id="l15.520">   // Trim off the initial AND/OR, which is irrelevant and inconsistent between</span>
<a href="#l15.521"></a><span id="l15.521">   // what SearchSpec.jsm generates, and what's in virtualFolders.dat.</span>
<a href="#l15.522"></a><span id="l15.522" class="difflineminus">-  curSearchAsString.Cut(0, StringBeginsWith(curSearchAsString,</span>
<a href="#l15.523"></a><span id="l15.523" class="difflineminus">-                                            NS_LITERAL_CSTRING(&quot;AND&quot;)) ? 3 : 2);</span>
<a href="#l15.524"></a><span id="l15.524" class="difflineplus">+  curSearchAsString.Cut(</span>
<a href="#l15.525"></a><span id="l15.525" class="difflineplus">+      0,</span>
<a href="#l15.526"></a><span id="l15.526" class="difflineplus">+      StringBeginsWith(curSearchAsString, NS_LITERAL_CSTRING(&quot;AND&quot;)) ? 3 : 2);</span>
<a href="#l15.527"></a><span id="l15.527">   terms.Cut(0, StringBeginsWith(terms, NS_LITERAL_CSTRING(&quot;AND&quot;)) ? 3 : 2);</span>
<a href="#l15.528"></a><span id="l15.528"> </span>
<a href="#l15.529"></a><span id="l15.529">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.530"></a><span id="l15.530">   // If the search session search string doesn't match the vf search str,</span>
<a href="#l15.531"></a><span id="l15.531">   // then we're doing quick search, which means we don't want to invalidate</span>
<a href="#l15.532"></a><span id="l15.532">   // cached results, or used cached results.</span>
<a href="#l15.533"></a><span id="l15.533">   m_doingQuickSearch = !curSearchAsString.Equals(terms);</span>
<a href="#l15.534"></a><span id="l15.534"> </span>
<a href="#l15.535"></a><span id="l15.535" class="difflineminus">-  if (mTree &amp;&amp; !m_doingQuickSearch)</span>
<a href="#l15.536"></a><span id="l15.536" class="difflineminus">-    mTree-&gt;BeginUpdateBatch();</span>
<a href="#l15.537"></a><span id="l15.537" class="difflineplus">+  if (mTree &amp;&amp; !m_doingQuickSearch) mTree-&gt;BeginUpdateBatch();</span>
<a href="#l15.538"></a><span id="l15.538"> </span>
<a href="#l15.539"></a><span id="l15.539" class="difflineminus">-  for (int32_t i = 0; i &lt; scopeCount; i++)</span>
<a href="#l15.540"></a><span id="l15.540" class="difflineminus">-  {</span>
<a href="#l15.541"></a><span id="l15.541" class="difflineplus">+  for (int32_t i = 0; i &lt; scopeCount; i++) {</span>
<a href="#l15.542"></a><span id="l15.542">     nsMsgSearchScopeValue scopeId;</span>
<a href="#l15.543"></a><span id="l15.543">     nsCOMPtr&lt;nsIMsgFolder&gt; searchFolder;</span>
<a href="#l15.544"></a><span id="l15.544">     searchSession-&gt;GetNthSearchScope(i, &amp;scopeId, getter_AddRefs(searchFolder));</span>
<a href="#l15.545"></a><span id="l15.545" class="difflineminus">-    if (searchFolder)</span>
<a href="#l15.546"></a><span id="l15.546" class="difflineminus">-    {</span>
<a href="#l15.547"></a><span id="l15.547" class="difflineplus">+    if (searchFolder) {</span>
<a href="#l15.548"></a><span id="l15.548">       nsCOMPtr&lt;nsISimpleEnumerator&gt; cachedHits;</span>
<a href="#l15.549"></a><span id="l15.549">       nsCOMPtr&lt;nsIMsgDatabase&gt; searchDB;</span>
<a href="#l15.550"></a><span id="l15.550">       nsCString searchUri;</span>
<a href="#l15.551"></a><span id="l15.551">       m_viewFolder-&gt;GetURI(searchUri);</span>
<a href="#l15.552"></a><span id="l15.552">       nsresult rv = searchFolder-&gt;GetMsgDatabase(getter_AddRefs(searchDB));</span>
<a href="#l15.553"></a><span id="l15.553" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; searchDB)</span>
<a href="#l15.554"></a><span id="l15.554" class="difflineminus">-      {</span>
<a href="#l15.555"></a><span id="l15.555" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; searchDB) {</span>
<a href="#l15.556"></a><span id="l15.556">         if (msgDBService)</span>
<a href="#l15.557"></a><span id="l15.557">           msgDBService-&gt;RegisterPendingListener(searchFolder, this);</span>
<a href="#l15.558"></a><span id="l15.558"> </span>
<a href="#l15.559"></a><span id="l15.559">         m_foldersSearchingOver.AppendObject(searchFolder);</span>
<a href="#l15.560"></a><span id="l15.560">         // Ignore cached hits in quick search case.</span>
<a href="#l15.561"></a><span id="l15.561" class="difflineminus">-        if (m_doingQuickSearch)</span>
<a href="#l15.562"></a><span id="l15.562" class="difflineminus">-          continue;</span>
<a href="#l15.563"></a><span id="l15.563" class="difflineplus">+        if (m_doingQuickSearch) continue;</span>
<a href="#l15.564"></a><span id="l15.564"> </span>
<a href="#l15.565"></a><span id="l15.565">         searchDB-&gt;GetCachedHits(searchUri.get(), getter_AddRefs(cachedHits));</span>
<a href="#l15.566"></a><span id="l15.566">         bool hasMore;</span>
<a href="#l15.567"></a><span id="l15.567" class="difflineminus">-        if (cachedHits)</span>
<a href="#l15.568"></a><span id="l15.568" class="difflineminus">-        {</span>
<a href="#l15.569"></a><span id="l15.569" class="difflineplus">+        if (cachedHits) {</span>
<a href="#l15.570"></a><span id="l15.570">           cachedHits-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l15.571"></a><span id="l15.571" class="difflineminus">-          if (hasMore)</span>
<a href="#l15.572"></a><span id="l15.572" class="difflineminus">-          {</span>
<a href="#l15.573"></a><span id="l15.573" class="difflineplus">+          if (hasMore) {</span>
<a href="#l15.574"></a><span id="l15.574">             mozilla::DebugOnly&lt;nsMsgKey&gt; prevKey = nsMsgKey_None;</span>
<a href="#l15.575"></a><span id="l15.575" class="difflineminus">-            while (hasMore)</span>
<a href="#l15.576"></a><span id="l15.576" class="difflineminus">-            {</span>
<a href="#l15.577"></a><span id="l15.577" class="difflineminus">-              nsCOMPtr &lt;nsISupports&gt; supports;</span>
<a href="#l15.578"></a><span id="l15.578" class="difflineplus">+            while (hasMore) {</span>
<a href="#l15.579"></a><span id="l15.579" class="difflineplus">+              nsCOMPtr&lt;nsISupports&gt; supports;</span>
<a href="#l15.580"></a><span id="l15.580">               nsresult rv = cachedHits-&gt;GetNext(getter_AddRefs(supports));</span>
<a href="#l15.581"></a><span id="l15.581">               NS_ASSERTION(NS_SUCCEEDED(rv), &quot;nsMsgDBEnumerator broken&quot;);</span>
<a href="#l15.582"></a><span id="l15.582" class="difflineminus">-              nsCOMPtr &lt;nsIMsgDBHdr&gt; pHeader = do_QueryInterface(supports);</span>
<a href="#l15.583"></a><span id="l15.583" class="difflineminus">-              if (pHeader &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l15.584"></a><span id="l15.584" class="difflineminus">-              {</span>
<a href="#l15.585"></a><span id="l15.585" class="difflineplus">+              nsCOMPtr&lt;nsIMsgDBHdr&gt; pHeader = do_QueryInterface(supports);</span>
<a href="#l15.586"></a><span id="l15.586" class="difflineplus">+              if (pHeader &amp;&amp; NS_SUCCEEDED(rv)) {</span>
<a href="#l15.587"></a><span id="l15.587">                 nsMsgKey msgKey;</span>
<a href="#l15.588"></a><span id="l15.588">                 pHeader-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l15.589"></a><span id="l15.589">                 NS_ASSERTION(prevKey == nsMsgKey_None || msgKey &gt; prevKey,</span>
<a href="#l15.590"></a><span id="l15.590">                              &quot;cached Hits not sorted&quot;);</span>
<a href="#l15.591"></a><span id="l15.591"> #ifdef DEBUG</span>
<a href="#l15.592"></a><span id="l15.592">                 prevKey = msgKey;</span>
<a href="#l15.593"></a><span id="l15.593"> #endif</span>
<a href="#l15.594"></a><span id="l15.594">                 AddHdrFromFolder(pHeader, searchFolder);</span>
<a href="#l15.595"></a><span id="l15.595" class="difflineminus">-              }</span>
<a href="#l15.596"></a><span id="l15.596" class="difflineminus">-              else</span>
<a href="#l15.597"></a><span id="l15.597" class="difflineminus">-              {</span>
<a href="#l15.598"></a><span id="l15.598" class="difflineplus">+              } else {</span>
<a href="#l15.599"></a><span id="l15.599">                 break;</span>
<a href="#l15.600"></a><span id="l15.600">               }</span>
<a href="#l15.601"></a><span id="l15.601"> </span>
<a href="#l15.602"></a><span id="l15.602">               cachedHits-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l15.603"></a><span id="l15.603">             }</span>
<a href="#l15.604"></a><span id="l15.604">           }</span>
<a href="#l15.605"></a><span id="l15.605">         }</span>
<a href="#l15.606"></a><span id="l15.606">       }</span>
<a href="#l15.607"></a><span id="l15.607">     }</span>
<a href="#l15.608"></a><span id="l15.608">   }</span>
<a href="#l15.609"></a><span id="l15.609"> </span>
<a href="#l15.610"></a><span id="l15.610" class="difflineminus">-  if (mTree &amp;&amp; !m_doingQuickSearch)</span>
<a href="#l15.611"></a><span id="l15.611" class="difflineminus">-    mTree-&gt;EndUpdateBatch();</span>
<a href="#l15.612"></a><span id="l15.612" class="difflineplus">+  if (mTree &amp;&amp; !m_doingQuickSearch) mTree-&gt;EndUpdateBatch();</span>
<a href="#l15.613"></a><span id="l15.613"> </span>
<a href="#l15.614"></a><span id="l15.614">   m_curFolderStartKeyIndex = 0;</span>
<a href="#l15.615"></a><span id="l15.615">   m_curFolderGettingHits = nullptr;</span>
<a href="#l15.616"></a><span id="l15.616">   m_curFolderHasCachedHits = false;</span>
<a href="#l15.617"></a><span id="l15.617"> </span>
<a href="#l15.618"></a><span id="l15.618">   // If we have cached hits, sort them.</span>
<a href="#l15.619"></a><span id="l15.619" class="difflineminus">-  if (GetSize() &gt; 0)</span>
<a href="#l15.620"></a><span id="l15.620" class="difflineminus">-  {</span>
<a href="#l15.621"></a><span id="l15.621" class="difflineplus">+  if (GetSize() &gt; 0) {</span>
<a href="#l15.622"></a><span id="l15.622">     // Currently, we keep threaded views sorted while we build them.</span>
<a href="#l15.623"></a><span id="l15.623">     if (m_sortType != nsMsgViewSortType::byThread &amp;&amp;</span>
<a href="#l15.624"></a><span id="l15.624" class="difflineminus">-      !(m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay))</span>
<a href="#l15.625"></a><span id="l15.625" class="difflineminus">-    {</span>
<a href="#l15.626"></a><span id="l15.626" class="difflineplus">+        !(m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay)) {</span>
<a href="#l15.627"></a><span id="l15.627">       // Sort the results.</span>
<a href="#l15.628"></a><span id="l15.628">       m_sortValid = false;</span>
<a href="#l15.629"></a><span id="l15.629">       Sort(m_sortType, m_sortOrder);</span>
<a href="#l15.630"></a><span id="l15.630">     }</span>
<a href="#l15.631"></a><span id="l15.631">   }</span>
<a href="#l15.632"></a><span id="l15.632"> </span>
<a href="#l15.633"></a><span id="l15.633">   return NS_OK;</span>
<a href="#l15.634"></a><span id="l15.634"> }</span>
<a href="#l15.635"></a><span id="l15.635"> </span>
<a href="#l15.636"></a><span id="l15.636"> NS_IMETHODIMP</span>
<a href="#l15.637"></a><span id="l15.637" class="difflineminus">-nsMsgXFVirtualFolderDBView::DoCommand(nsMsgViewCommandTypeValue command)</span>
<a href="#l15.638"></a><span id="l15.638" class="difflineminus">-{</span>
<a href="#l15.639"></a><span id="l15.639" class="difflineplus">+nsMsgXFVirtualFolderDBView::DoCommand(nsMsgViewCommandTypeValue command) {</span>
<a href="#l15.640"></a><span id="l15.640">   return nsMsgSearchDBView::DoCommand(command);</span>
<a href="#l15.641"></a><span id="l15.641"> }</span>
<a href="#l15.642"></a><span id="l15.642"> </span>
<a href="#l15.643"></a><span id="l15.643"> NS_IMETHODIMP</span>
<a href="#l15.644"></a><span id="l15.644" class="difflineminus">-nsMsgXFVirtualFolderDBView::GetMsgFolder(nsIMsgFolder **aMsgFolder)</span>
<a href="#l15.645"></a><span id="l15.645" class="difflineminus">-{</span>
<a href="#l15.646"></a><span id="l15.646" class="difflineplus">+nsMsgXFVirtualFolderDBView::GetMsgFolder(nsIMsgFolder **aMsgFolder) {</span>
<a href="#l15.647"></a><span id="l15.647">   NS_ENSURE_ARG_POINTER(aMsgFolder);</span>
<a href="#l15.648"></a><span id="l15.648">   NS_IF_ADDREF(*aMsgFolder = m_viewFolder);</span>
<a href="#l15.649"></a><span id="l15.649">   return NS_OK;</span>
<a href="#l15.650"></a><span id="l15.650"> }</span>
<a href="#l15.651"></a><span id="l15.651"> </span>
<a href="#l15.652"></a><span id="l15.652"> NS_IMETHODIMP</span>
<a href="#l15.653"></a><span id="l15.653" class="difflineminus">-nsMsgXFVirtualFolderDBView::SetViewFlags(nsMsgViewFlagsTypeValue aViewFlags)</span>
<a href="#l15.654"></a><span id="l15.654" class="difflineminus">-{</span>
<a href="#l15.655"></a><span id="l15.655" class="difflineplus">+nsMsgXFVirtualFolderDBView::SetViewFlags(nsMsgViewFlagsTypeValue aViewFlags) {</span>
<a href="#l15.656"></a><span id="l15.656">   nsresult rv = NS_OK;</span>
<a href="#l15.657"></a><span id="l15.657">   // If the grouping/threading has changed, rebuild the view.</span>
<a href="#l15.658"></a><span id="l15.658">   if ((m_viewFlags &amp; (nsMsgViewFlagsType::kGroupBySort |</span>
<a href="#l15.659"></a><span id="l15.659">                       nsMsgViewFlagsType::kThreadedDisplay)) !=</span>
<a href="#l15.660"></a><span id="l15.660">       (aViewFlags &amp; (nsMsgViewFlagsType::kGroupBySort |</span>
<a href="#l15.661"></a><span id="l15.661" class="difflineminus">-                     nsMsgViewFlagsType::kThreadedDisplay)))</span>
<a href="#l15.662"></a><span id="l15.662" class="difflineminus">-  {</span>
<a href="#l15.663"></a><span id="l15.663" class="difflineplus">+                     nsMsgViewFlagsType::kThreadedDisplay))) {</span>
<a href="#l15.664"></a><span id="l15.664">     rv = RebuildView(aViewFlags);</span>
<a href="#l15.665"></a><span id="l15.665">   }</span>
<a href="#l15.666"></a><span id="l15.666"> </span>
<a href="#l15.667"></a><span id="l15.667">   nsMsgDBView::SetViewFlags(aViewFlags);</span>
<a href="#l15.668"></a><span id="l15.668">   return rv;</span>
<a href="#l15.669"></a><span id="l15.669"> }</span>
<a href="#l15.670"></a><span id="l15.670"> </span>
<a href="#l15.671"></a><span id="l15.671" class="difflineminus">-</span>
<a href="#l15.672"></a><span id="l15.672" class="difflineminus">-nsresult</span>
<a href="#l15.673"></a><span id="l15.673" class="difflineminus">-nsMsgXFVirtualFolderDBView::GetMessageEnumerator(nsISimpleEnumerator **enumerator)</span>
<a href="#l15.674"></a><span id="l15.674" class="difflineminus">-{</span>
<a href="#l15.675"></a><span id="l15.675" class="difflineplus">+nsresult nsMsgXFVirtualFolderDBView::GetMessageEnumerator(</span>
<a href="#l15.676"></a><span id="l15.676" class="difflineplus">+    nsISimpleEnumerator **enumerator) {</span>
<a href="#l15.677"></a><span id="l15.677">   return GetViewEnumerator(enumerator);</span>
<a href="#l15.678"></a><span id="l15.678"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/base/src/nsMsgXFVirtualFolderDBView.h</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgXFVirtualFolderDBView.h</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -9,53 +9,64 @@</span>
<a href="#l16.4"></a><span id="l16.4"> #include &quot;mozilla/Attributes.h&quot;</span>
<a href="#l16.5"></a><span id="l16.5"> #include &quot;nsMsgSearchDBView.h&quot;</span>
<a href="#l16.6"></a><span id="l16.6"> #include &quot;nsIMsgCopyServiceListener.h&quot;</span>
<a href="#l16.7"></a><span id="l16.7"> #include &quot;nsIMsgSearchNotify.h&quot;</span>
<a href="#l16.8"></a><span id="l16.8"> #include &quot;nsCOMArray.h&quot;</span>
<a href="#l16.9"></a><span id="l16.9"> </span>
<a href="#l16.10"></a><span id="l16.10"> class nsMsgGroupThread;</span>
<a href="#l16.11"></a><span id="l16.11"> </span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-class nsMsgXFVirtualFolderDBView : public nsMsgSearchDBView</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineminus">-{</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineminus">-public:</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineplus">+class nsMsgXFVirtualFolderDBView : public nsMsgSearchDBView {</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineplus">+ public:</span>
<a href="#l16.17"></a><span id="l16.17">   nsMsgXFVirtualFolderDBView();</span>
<a href="#l16.18"></a><span id="l16.18">   virtual ~nsMsgXFVirtualFolderDBView();</span>
<a href="#l16.19"></a><span id="l16.19"> </span>
<a href="#l16.20"></a><span id="l16.20">   // we override all the methods, currently. Might change...</span>
<a href="#l16.21"></a><span id="l16.21">   NS_DECL_NSIMSGSEARCHNOTIFY</span>
<a href="#l16.22"></a><span id="l16.22"> </span>
<a href="#l16.23"></a><span id="l16.23" class="difflineminus">-  virtual const char * GetViewName(void) override {return &quot;XFVirtualFolderView&quot;; }</span>
<a href="#l16.24"></a><span id="l16.24" class="difflineminus">-  NS_IMETHOD Open(nsIMsgFolder *folder, nsMsgViewSortTypeValue sortType, nsMsgViewSortOrderValue sortOrder,</span>
<a href="#l16.25"></a><span id="l16.25" class="difflineminus">-        nsMsgViewFlagsTypeValue viewFlags, int32_t *pCount) override;</span>
<a href="#l16.26"></a><span id="l16.26" class="difflineminus">-  NS_IMETHOD CloneDBView(nsIMessenger *aMessengerInstance, nsIMsgWindow *aMsgWindow,</span>
<a href="#l16.27"></a><span id="l16.27" class="difflineminus">-                         nsIMsgDBViewCommandUpdater *aCmdUpdater, nsIMsgDBView **_retval) override;</span>
<a href="#l16.28"></a><span id="l16.28" class="difflineminus">-  NS_IMETHOD CopyDBView(nsMsgDBView *aNewMsgDBView, nsIMessenger *aMessengerInstance,</span>
<a href="#l16.29"></a><span id="l16.29" class="difflineminus">-                        nsIMsgWindow *aMsgWindow, nsIMsgDBViewCommandUpdater *aCmdUpdater) override;</span>
<a href="#l16.30"></a><span id="l16.30" class="difflineplus">+  virtual const char *GetViewName(void) override {</span>
<a href="#l16.31"></a><span id="l16.31" class="difflineplus">+    return &quot;XFVirtualFolderView&quot;;</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineplus">+  }</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineplus">+  NS_IMETHOD Open(nsIMsgFolder *folder, nsMsgViewSortTypeValue sortType,</span>
<a href="#l16.34"></a><span id="l16.34" class="difflineplus">+                  nsMsgViewSortOrderValue sortOrder,</span>
<a href="#l16.35"></a><span id="l16.35" class="difflineplus">+                  nsMsgViewFlagsTypeValue viewFlags, int32_t *pCount) override;</span>
<a href="#l16.36"></a><span id="l16.36" class="difflineplus">+  NS_IMETHOD CloneDBView(nsIMessenger *aMessengerInstance,</span>
<a href="#l16.37"></a><span id="l16.37" class="difflineplus">+                         nsIMsgWindow *aMsgWindow,</span>
<a href="#l16.38"></a><span id="l16.38" class="difflineplus">+                         nsIMsgDBViewCommandUpdater *aCmdUpdater,</span>
<a href="#l16.39"></a><span id="l16.39" class="difflineplus">+                         nsIMsgDBView **_retval) override;</span>
<a href="#l16.40"></a><span id="l16.40" class="difflineplus">+  NS_IMETHOD CopyDBView(nsMsgDBView *aNewMsgDBView,</span>
<a href="#l16.41"></a><span id="l16.41" class="difflineplus">+                        nsIMessenger *aMessengerInstance,</span>
<a href="#l16.42"></a><span id="l16.42" class="difflineplus">+                        nsIMsgWindow *aMsgWindow,</span>
<a href="#l16.43"></a><span id="l16.43" class="difflineplus">+                        nsIMsgDBViewCommandUpdater *aCmdUpdater) override;</span>
<a href="#l16.44"></a><span id="l16.44">   NS_IMETHOD Close() override;</span>
<a href="#l16.45"></a><span id="l16.45">   NS_IMETHOD GetViewType(nsMsgViewTypeValue *aViewType) override;</span>
<a href="#l16.46"></a><span id="l16.46">   NS_IMETHOD DoCommand(nsMsgViewCommandTypeValue command) override;</span>
<a href="#l16.47"></a><span id="l16.47">   NS_IMETHOD SetViewFlags(nsMsgViewFlagsTypeValue aViewFlags) override;</span>
<a href="#l16.48"></a><span id="l16.48" class="difflineminus">-  NS_IMETHOD OnHdrPropertyChanged(nsIMsgDBHdr *aHdrToChange, bool aPreChange, uint32_t *aStatus,</span>
<a href="#l16.49"></a><span id="l16.49" class="difflineminus">-                                 nsIDBChangeListener * aInstigator) override;</span>
<a href="#l16.50"></a><span id="l16.50" class="difflineplus">+  NS_IMETHOD OnHdrPropertyChanged(nsIMsgDBHdr *aHdrToChange, bool aPreChange,</span>
<a href="#l16.51"></a><span id="l16.51" class="difflineplus">+                                  uint32_t *aStatus,</span>
<a href="#l16.52"></a><span id="l16.52" class="difflineplus">+                                  nsIDBChangeListener *aInstigator) override;</span>
<a href="#l16.53"></a><span id="l16.53">   NS_IMETHOD GetMsgFolder(nsIMsgFolder **aMsgFolder) override;</span>
<a href="#l16.54"></a><span id="l16.54"> </span>
<a href="#l16.55"></a><span id="l16.55" class="difflineminus">-  virtual nsresult OnNewHeader(nsIMsgDBHdr *newHdr, nsMsgKey parentKey, bool ensureListed) override;</span>
<a href="#l16.56"></a><span id="l16.56" class="difflineplus">+  virtual nsresult OnNewHeader(nsIMsgDBHdr *newHdr, nsMsgKey parentKey,</span>
<a href="#l16.57"></a><span id="l16.57" class="difflineplus">+                               bool ensureListed) override;</span>
<a href="#l16.58"></a><span id="l16.58">   void UpdateCacheAndViewForPrevSearchedFolders(nsIMsgFolder *curSearchFolder);</span>
<a href="#l16.59"></a><span id="l16.59" class="difflineminus">-  void UpdateCacheAndViewForFolder(nsIMsgFolder *folder, nsMsgKey *newHits, uint32_t numNewHits);</span>
<a href="#l16.60"></a><span id="l16.60" class="difflineplus">+  void UpdateCacheAndViewForFolder(nsIMsgFolder *folder, nsMsgKey *newHits,</span>
<a href="#l16.61"></a><span id="l16.61" class="difflineplus">+                                   uint32_t numNewHits);</span>
<a href="#l16.62"></a><span id="l16.62">   void RemovePendingDBListeners();</span>
<a href="#l16.63"></a><span id="l16.63"> </span>
<a href="#l16.64"></a><span id="l16.64" class="difflineminus">-protected:</span>
<a href="#l16.65"></a><span id="l16.65" class="difflineplus">+ protected:</span>
<a href="#l16.66"></a><span id="l16.66" class="difflineplus">+  virtual nsresult GetMessageEnumerator(</span>
<a href="#l16.67"></a><span id="l16.67" class="difflineplus">+      nsISimpleEnumerator **enumerator) override;</span>
<a href="#l16.68"></a><span id="l16.68"> </span>
<a href="#l16.69"></a><span id="l16.69" class="difflineminus">-  virtual nsresult GetMessageEnumerator(nsISimpleEnumerator **enumerator) override;</span>
<a href="#l16.70"></a><span id="l16.70" class="difflineminus">-</span>
<a href="#l16.71"></a><span id="l16.71" class="difflineminus">-  uint32_t m_cachedFolderArrayIndex; // array index of next folder with cached hits to deal with.</span>
<a href="#l16.72"></a><span id="l16.72" class="difflineplus">+  // array index of next folder with cached hits to deal with.</span>
<a href="#l16.73"></a><span id="l16.73" class="difflineplus">+  uint32_t m_cachedFolderArrayIndex;</span>
<a href="#l16.74"></a><span id="l16.74">   nsCOMArray&lt;nsIMsgFolder&gt; m_foldersSearchingOver;</span>
<a href="#l16.75"></a><span id="l16.75">   nsCOMArray&lt;nsIMsgDBHdr&gt; m_hdrHits;</span>
<a href="#l16.76"></a><span id="l16.76" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFolder&gt; m_curFolderGettingHits;</span>
<a href="#l16.77"></a><span id="l16.77" class="difflineminus">-  uint32_t m_curFolderStartKeyIndex; // keeps track of the index of the first hit from the cur folder</span>
<a href="#l16.78"></a><span id="l16.78" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; m_curFolderGettingHits;</span>
<a href="#l16.79"></a><span id="l16.79" class="difflineplus">+  // keeps track of the index of the first hit from the cur folder</span>
<a href="#l16.80"></a><span id="l16.80" class="difflineplus">+  uint32_t m_curFolderStartKeyIndex;</span>
<a href="#l16.81"></a><span id="l16.81">   bool m_curFolderHasCachedHits;</span>
<a href="#l16.82"></a><span id="l16.82">   bool m_doingSearch;</span>
<a href="#l16.83"></a><span id="l16.83">   // Are we doing a quick search on top of the virtual folder search?</span>
<a href="#l16.84"></a><span id="l16.84">   bool m_doingQuickSearch;</span>
<a href="#l16.85"></a><span id="l16.85"> };</span>
<a href="#l16.86"></a><span id="l16.86"> </span>
<a href="#l16.87"></a><span id="l16.87"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/base/src/nsSpamSettings.cpp</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/base/src/nsSpamSettings.cpp</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -28,216 +28,208 @@</span>
<a href="#l17.4"></a><span id="l17.4"> #include &quot;nsISimpleEnumerator.h&quot;</span>
<a href="#l17.5"></a><span id="l17.5"> #include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l17.6"></a><span id="l17.6"> #include &quot;nsIAbManager.h&quot;</span>
<a href="#l17.7"></a><span id="l17.7"> #include &quot;nsIMsgAccountManager.h&quot;</span>
<a href="#l17.8"></a><span id="l17.8"> #include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l17.9"></a><span id="l17.9"> </span>
<a href="#l17.10"></a><span id="l17.10"> using namespace mozilla::mailnews;</span>
<a href="#l17.11"></a><span id="l17.11"> </span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-nsSpamSettings::nsSpamSettings()</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineminus">-{</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineplus">+nsSpamSettings::nsSpamSettings() {</span>
<a href="#l17.15"></a><span id="l17.15">   mLevel = 0;</span>
<a href="#l17.16"></a><span id="l17.16">   mMoveOnSpam = false;</span>
<a href="#l17.17"></a><span id="l17.17">   mMoveTargetMode = nsISpamSettings::MOVE_TARGET_MODE_ACCOUNT;</span>
<a href="#l17.18"></a><span id="l17.18">   mPurge = false;</span>
<a href="#l17.19"></a><span id="l17.19" class="difflineminus">-  mPurgeInterval = 14; // 14 days</span>
<a href="#l17.20"></a><span id="l17.20" class="difflineplus">+  mPurgeInterval = 14;  // 14 days</span>
<a href="#l17.21"></a><span id="l17.21"> </span>
<a href="#l17.22"></a><span id="l17.22">   mServerFilterTrustFlags = 0;</span>
<a href="#l17.23"></a><span id="l17.23"> </span>
<a href="#l17.24"></a><span id="l17.24">   mUseWhiteList = false;</span>
<a href="#l17.25"></a><span id="l17.25">   mUseServerFilter = false;</span>
<a href="#l17.26"></a><span id="l17.26"> </span>
<a href="#l17.27"></a><span id="l17.27" class="difflineminus">-  nsresult rv = NS_GetSpecialDirectory(NS_APP_USER_PROFILE_50_DIR, getter_AddRefs(mLogFile));</span>
<a href="#l17.28"></a><span id="l17.28" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l17.29"></a><span id="l17.29" class="difflineminus">-    mLogFile-&gt;Append(NS_LITERAL_STRING(&quot;junklog.html&quot;));</span>
<a href="#l17.30"></a><span id="l17.30" class="difflineplus">+  nsresult rv = NS_GetSpecialDirectory(NS_APP_USER_PROFILE_50_DIR,</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineplus">+                                       getter_AddRefs(mLogFile));</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineplus">+  if (NS_SUCCEEDED(rv)) mLogFile-&gt;Append(NS_LITERAL_STRING(&quot;junklog.html&quot;));</span>
<a href="#l17.33"></a><span id="l17.33"> }</span>
<a href="#l17.34"></a><span id="l17.34"> </span>
<a href="#l17.35"></a><span id="l17.35" class="difflineminus">-nsSpamSettings::~nsSpamSettings()</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineminus">-{</span>
<a href="#l17.37"></a><span id="l17.37" class="difflineminus">-}</span>
<a href="#l17.38"></a><span id="l17.38" class="difflineplus">+nsSpamSettings::~nsSpamSettings() {}</span>
<a href="#l17.39"></a><span id="l17.39"> </span>
<a href="#l17.40"></a><span id="l17.40"> NS_IMPL_ISUPPORTS(nsSpamSettings, nsISpamSettings, nsIUrlListener)</span>
<a href="#l17.41"></a><span id="l17.41"> </span>
<a href="#l17.42"></a><span id="l17.42"> NS_IMETHODIMP</span>
<a href="#l17.43"></a><span id="l17.43" class="difflineminus">-nsSpamSettings::GetLevel(int32_t *aLevel)</span>
<a href="#l17.44"></a><span id="l17.44" class="difflineminus">-{</span>
<a href="#l17.45"></a><span id="l17.45" class="difflineplus">+nsSpamSettings::GetLevel(int32_t *aLevel) {</span>
<a href="#l17.46"></a><span id="l17.46">   NS_ENSURE_ARG_POINTER(aLevel);</span>
<a href="#l17.47"></a><span id="l17.47">   *aLevel = mLevel;</span>
<a href="#l17.48"></a><span id="l17.48">   return NS_OK;</span>
<a href="#l17.49"></a><span id="l17.49"> }</span>
<a href="#l17.50"></a><span id="l17.50"> </span>
<a href="#l17.51"></a><span id="l17.51" class="difflineminus">-NS_IMETHODIMP nsSpamSettings::SetLevel(int32_t aLevel)</span>
<a href="#l17.52"></a><span id="l17.52" class="difflineminus">-{</span>
<a href="#l17.53"></a><span id="l17.53" class="difflineplus">+NS_IMETHODIMP nsSpamSettings::SetLevel(int32_t aLevel) {</span>
<a href="#l17.54"></a><span id="l17.54">   NS_ASSERTION((aLevel &gt;= 0 &amp;&amp; aLevel &lt;= 100), &quot;bad level&quot;);</span>
<a href="#l17.55"></a><span id="l17.55">   mLevel = aLevel;</span>
<a href="#l17.56"></a><span id="l17.56">   return NS_OK;</span>
<a href="#l17.57"></a><span id="l17.57"> }</span>
<a href="#l17.58"></a><span id="l17.58"> </span>
<a href="#l17.59"></a><span id="l17.59"> NS_IMETHODIMP</span>
<a href="#l17.60"></a><span id="l17.60" class="difflineminus">-nsSpamSettings::GetMoveTargetMode(int32_t *aMoveTargetMode)</span>
<a href="#l17.61"></a><span id="l17.61" class="difflineminus">-{</span>
<a href="#l17.62"></a><span id="l17.62" class="difflineplus">+nsSpamSettings::GetMoveTargetMode(int32_t *aMoveTargetMode) {</span>
<a href="#l17.63"></a><span id="l17.63">   NS_ENSURE_ARG_POINTER(aMoveTargetMode);</span>
<a href="#l17.64"></a><span id="l17.64">   *aMoveTargetMode = mMoveTargetMode;</span>
<a href="#l17.65"></a><span id="l17.65">   return NS_OK;</span>
<a href="#l17.66"></a><span id="l17.66"> }</span>
<a href="#l17.67"></a><span id="l17.67"> </span>
<a href="#l17.68"></a><span id="l17.68" class="difflineminus">-NS_IMETHODIMP nsSpamSettings::SetMoveTargetMode(int32_t aMoveTargetMode)</span>
<a href="#l17.69"></a><span id="l17.69" class="difflineminus">-{</span>
<a href="#l17.70"></a><span id="l17.70" class="difflineminus">-  NS_ASSERTION((aMoveTargetMode == nsISpamSettings::MOVE_TARGET_MODE_FOLDER || aMoveTargetMode == nsISpamSettings::MOVE_TARGET_MODE_ACCOUNT), &quot;bad move target mode&quot;);</span>
<a href="#l17.71"></a><span id="l17.71" class="difflineplus">+NS_IMETHODIMP nsSpamSettings::SetMoveTargetMode(int32_t aMoveTargetMode) {</span>
<a href="#l17.72"></a><span id="l17.72" class="difflineplus">+  NS_ASSERTION((aMoveTargetMode == nsISpamSettings::MOVE_TARGET_MODE_FOLDER ||</span>
<a href="#l17.73"></a><span id="l17.73" class="difflineplus">+                aMoveTargetMode == nsISpamSettings::MOVE_TARGET_MODE_ACCOUNT),</span>
<a href="#l17.74"></a><span id="l17.74" class="difflineplus">+               &quot;bad move target mode&quot;);</span>
<a href="#l17.75"></a><span id="l17.75">   mMoveTargetMode = aMoveTargetMode;</span>
<a href="#l17.76"></a><span id="l17.76">   return NS_OK;</span>
<a href="#l17.77"></a><span id="l17.77"> }</span>
<a href="#l17.78"></a><span id="l17.78"> </span>
<a href="#l17.79"></a><span id="l17.79" class="difflineminus">-NS_IMETHODIMP nsSpamSettings::GetManualMark(bool *aManualMark)</span>
<a href="#l17.80"></a><span id="l17.80" class="difflineminus">-{</span>
<a href="#l17.81"></a><span id="l17.81" class="difflineplus">+NS_IMETHODIMP nsSpamSettings::GetManualMark(bool *aManualMark) {</span>
<a href="#l17.82"></a><span id="l17.82">   NS_ENSURE_ARG_POINTER(aManualMark);</span>
<a href="#l17.83"></a><span id="l17.83">   nsresult rv;</span>
<a href="#l17.84"></a><span id="l17.84" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l17.85"></a><span id="l17.85" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(</span>
<a href="#l17.86"></a><span id="l17.86" class="difflineplus">+      do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l17.87"></a><span id="l17.87">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.88"></a><span id="l17.88">   return prefBranch-&gt;GetBoolPref(&quot;mail.spam.manualMark&quot;, aManualMark);</span>
<a href="#l17.89"></a><span id="l17.89"> }</span>
<a href="#l17.90"></a><span id="l17.90"> </span>
<a href="#l17.91"></a><span id="l17.91" class="difflineminus">-NS_IMETHODIMP nsSpamSettings::GetManualMarkMode(int32_t *aManualMarkMode)</span>
<a href="#l17.92"></a><span id="l17.92" class="difflineminus">-{</span>
<a href="#l17.93"></a><span id="l17.93" class="difflineplus">+NS_IMETHODIMP nsSpamSettings::GetManualMarkMode(int32_t *aManualMarkMode) {</span>
<a href="#l17.94"></a><span id="l17.94">   NS_ENSURE_ARG_POINTER(aManualMarkMode);</span>
<a href="#l17.95"></a><span id="l17.95">   nsresult rv;</span>
<a href="#l17.96"></a><span id="l17.96" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l17.97"></a><span id="l17.97" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(</span>
<a href="#l17.98"></a><span id="l17.98" class="difflineplus">+      do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l17.99"></a><span id="l17.99">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.100"></a><span id="l17.100">   return prefBranch-&gt;GetIntPref(&quot;mail.spam.manualMarkMode&quot;, aManualMarkMode);</span>
<a href="#l17.101"></a><span id="l17.101"> }</span>
<a href="#l17.102"></a><span id="l17.102"> </span>
<a href="#l17.103"></a><span id="l17.103" class="difflineminus">-NS_IMETHODIMP nsSpamSettings::GetLoggingEnabled(bool *aLoggingEnabled)</span>
<a href="#l17.104"></a><span id="l17.104" class="difflineminus">-{</span>
<a href="#l17.105"></a><span id="l17.105" class="difflineplus">+NS_IMETHODIMP nsSpamSettings::GetLoggingEnabled(bool *aLoggingEnabled) {</span>
<a href="#l17.106"></a><span id="l17.106">   NS_ENSURE_ARG_POINTER(aLoggingEnabled);</span>
<a href="#l17.107"></a><span id="l17.107">   nsresult rv;</span>
<a href="#l17.108"></a><span id="l17.108" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l17.109"></a><span id="l17.109" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(</span>
<a href="#l17.110"></a><span id="l17.110" class="difflineplus">+      do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l17.111"></a><span id="l17.111">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.112"></a><span id="l17.112">   return prefBranch-&gt;GetBoolPref(&quot;mail.spam.logging.enabled&quot;, aLoggingEnabled);</span>
<a href="#l17.113"></a><span id="l17.113"> }</span>
<a href="#l17.114"></a><span id="l17.114"> </span>
<a href="#l17.115"></a><span id="l17.115" class="difflineminus">-NS_IMETHODIMP nsSpamSettings::GetMarkAsReadOnSpam(bool *aMarkAsReadOnSpam)</span>
<a href="#l17.116"></a><span id="l17.116" class="difflineminus">-{</span>
<a href="#l17.117"></a><span id="l17.117" class="difflineplus">+NS_IMETHODIMP nsSpamSettings::GetMarkAsReadOnSpam(bool *aMarkAsReadOnSpam) {</span>
<a href="#l17.118"></a><span id="l17.118">   NS_ENSURE_ARG_POINTER(aMarkAsReadOnSpam);</span>
<a href="#l17.119"></a><span id="l17.119">   nsresult rv;</span>
<a href="#l17.120"></a><span id="l17.120" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l17.121"></a><span id="l17.121" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(</span>
<a href="#l17.122"></a><span id="l17.122" class="difflineplus">+      do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l17.123"></a><span id="l17.123">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.124"></a><span id="l17.124" class="difflineminus">-  return prefBranch-&gt;GetBoolPref(&quot;mail.spam.markAsReadOnSpam&quot;, aMarkAsReadOnSpam);</span>
<a href="#l17.125"></a><span id="l17.125" class="difflineplus">+  return prefBranch-&gt;GetBoolPref(&quot;mail.spam.markAsReadOnSpam&quot;,</span>
<a href="#l17.126"></a><span id="l17.126" class="difflineplus">+                                 aMarkAsReadOnSpam);</span>
<a href="#l17.127"></a><span id="l17.127"> }</span>
<a href="#l17.128"></a><span id="l17.128"> </span>
<a href="#l17.129"></a><span id="l17.129"> NS_IMPL_GETSET(nsSpamSettings, MoveOnSpam, bool, mMoveOnSpam)</span>
<a href="#l17.130"></a><span id="l17.130"> NS_IMPL_GETSET(nsSpamSettings, Purge, bool, mPurge)</span>
<a href="#l17.131"></a><span id="l17.131"> NS_IMPL_GETSET(nsSpamSettings, UseWhiteList, bool, mUseWhiteList)</span>
<a href="#l17.132"></a><span id="l17.132"> NS_IMPL_GETSET(nsSpamSettings, UseServerFilter, bool, mUseServerFilter)</span>
<a href="#l17.133"></a><span id="l17.133"> </span>
<a href="#l17.134"></a><span id="l17.134" class="difflineminus">-NS_IMETHODIMP nsSpamSettings::GetWhiteListAbURI(char * *aWhiteListAbURI)</span>
<a href="#l17.135"></a><span id="l17.135" class="difflineminus">-{</span>
<a href="#l17.136"></a><span id="l17.136" class="difflineplus">+NS_IMETHODIMP nsSpamSettings::GetWhiteListAbURI(char **aWhiteListAbURI) {</span>
<a href="#l17.137"></a><span id="l17.137">   NS_ENSURE_ARG_POINTER(aWhiteListAbURI);</span>
<a href="#l17.138"></a><span id="l17.138">   *aWhiteListAbURI = ToNewCString(mWhiteListAbURI);</span>
<a href="#l17.139"></a><span id="l17.139">   return NS_OK;</span>
<a href="#l17.140"></a><span id="l17.140"> }</span>
<a href="#l17.141"></a><span id="l17.141" class="difflineminus">-NS_IMETHODIMP nsSpamSettings::SetWhiteListAbURI(const char * aWhiteListAbURI)</span>
<a href="#l17.142"></a><span id="l17.142" class="difflineminus">-{</span>
<a href="#l17.143"></a><span id="l17.143" class="difflineplus">+NS_IMETHODIMP nsSpamSettings::SetWhiteListAbURI(const char *aWhiteListAbURI) {</span>
<a href="#l17.144"></a><span id="l17.144">   mWhiteListAbURI = aWhiteListAbURI;</span>
<a href="#l17.145"></a><span id="l17.145">   return NS_OK;</span>
<a href="#l17.146"></a><span id="l17.146"> }</span>
<a href="#l17.147"></a><span id="l17.147"> </span>
<a href="#l17.148"></a><span id="l17.148" class="difflineminus">-NS_IMETHODIMP nsSpamSettings::GetActionTargetAccount(char * *aActionTargetAccount)</span>
<a href="#l17.149"></a><span id="l17.149" class="difflineminus">-{</span>
<a href="#l17.150"></a><span id="l17.150" class="difflineplus">+NS_IMETHODIMP nsSpamSettings::GetActionTargetAccount(</span>
<a href="#l17.151"></a><span id="l17.151" class="difflineplus">+    char **aActionTargetAccount) {</span>
<a href="#l17.152"></a><span id="l17.152">   NS_ENSURE_ARG_POINTER(aActionTargetAccount);</span>
<a href="#l17.153"></a><span id="l17.153">   *aActionTargetAccount = ToNewCString(mActionTargetAccount);</span>
<a href="#l17.154"></a><span id="l17.154">   return NS_OK;</span>
<a href="#l17.155"></a><span id="l17.155"> }</span>
<a href="#l17.156"></a><span id="l17.156"> </span>
<a href="#l17.157"></a><span id="l17.157" class="difflineminus">-NS_IMETHODIMP nsSpamSettings::SetActionTargetAccount(const char * aActionTargetAccount)</span>
<a href="#l17.158"></a><span id="l17.158" class="difflineminus">-{</span>
<a href="#l17.159"></a><span id="l17.159" class="difflineplus">+NS_IMETHODIMP nsSpamSettings::SetActionTargetAccount(</span>
<a href="#l17.160"></a><span id="l17.160" class="difflineplus">+    const char *aActionTargetAccount) {</span>
<a href="#l17.161"></a><span id="l17.161">   mActionTargetAccount = aActionTargetAccount;</span>
<a href="#l17.162"></a><span id="l17.162">   return NS_OK;</span>
<a href="#l17.163"></a><span id="l17.163"> }</span>
<a href="#l17.164"></a><span id="l17.164"> </span>
<a href="#l17.165"></a><span id="l17.165" class="difflineminus">-NS_IMETHODIMP nsSpamSettings::GetActionTargetFolder(char * *aActionTargetFolder)</span>
<a href="#l17.166"></a><span id="l17.166" class="difflineminus">-{</span>
<a href="#l17.167"></a><span id="l17.167" class="difflineplus">+NS_IMETHODIMP nsSpamSettings::GetActionTargetFolder(</span>
<a href="#l17.168"></a><span id="l17.168" class="difflineplus">+    char **aActionTargetFolder) {</span>
<a href="#l17.169"></a><span id="l17.169">   NS_ENSURE_ARG_POINTER(aActionTargetFolder);</span>
<a href="#l17.170"></a><span id="l17.170">   *aActionTargetFolder = ToNewCString(mActionTargetFolder);</span>
<a href="#l17.171"></a><span id="l17.171">   return NS_OK;</span>
<a href="#l17.172"></a><span id="l17.172"> }</span>
<a href="#l17.173"></a><span id="l17.173"> </span>
<a href="#l17.174"></a><span id="l17.174" class="difflineminus">-NS_IMETHODIMP nsSpamSettings::SetActionTargetFolder(const char * aActionTargetFolder)</span>
<a href="#l17.175"></a><span id="l17.175" class="difflineminus">-{</span>
<a href="#l17.176"></a><span id="l17.176" class="difflineplus">+NS_IMETHODIMP nsSpamSettings::SetActionTargetFolder(</span>
<a href="#l17.177"></a><span id="l17.177" class="difflineplus">+    const char *aActionTargetFolder) {</span>
<a href="#l17.178"></a><span id="l17.178">   mActionTargetFolder = aActionTargetFolder;</span>
<a href="#l17.179"></a><span id="l17.179">   return NS_OK;</span>
<a href="#l17.180"></a><span id="l17.180"> }</span>
<a href="#l17.181"></a><span id="l17.181"> </span>
<a href="#l17.182"></a><span id="l17.182" class="difflineminus">-NS_IMETHODIMP nsSpamSettings::GetPurgeInterval(int32_t *aPurgeInterval)</span>
<a href="#l17.183"></a><span id="l17.183" class="difflineminus">-{</span>
<a href="#l17.184"></a><span id="l17.184" class="difflineplus">+NS_IMETHODIMP nsSpamSettings::GetPurgeInterval(int32_t *aPurgeInterval) {</span>
<a href="#l17.185"></a><span id="l17.185">   NS_ENSURE_ARG_POINTER(aPurgeInterval);</span>
<a href="#l17.186"></a><span id="l17.186">   *aPurgeInterval = mPurgeInterval;</span>
<a href="#l17.187"></a><span id="l17.187">   return NS_OK;</span>
<a href="#l17.188"></a><span id="l17.188"> }</span>
<a href="#l17.189"></a><span id="l17.189"> </span>
<a href="#l17.190"></a><span id="l17.190" class="difflineminus">-NS_IMETHODIMP nsSpamSettings::SetPurgeInterval(int32_t aPurgeInterval)</span>
<a href="#l17.191"></a><span id="l17.191" class="difflineminus">-{</span>
<a href="#l17.192"></a><span id="l17.192" class="difflineplus">+NS_IMETHODIMP nsSpamSettings::SetPurgeInterval(int32_t aPurgeInterval) {</span>
<a href="#l17.193"></a><span id="l17.193">   NS_ASSERTION(aPurgeInterval &gt;= 0, &quot;bad purge interval&quot;);</span>
<a href="#l17.194"></a><span id="l17.194">   mPurgeInterval = aPurgeInterval;</span>
<a href="#l17.195"></a><span id="l17.195">   return NS_OK;</span>
<a href="#l17.196"></a><span id="l17.196"> }</span>
<a href="#l17.197"></a><span id="l17.197"> </span>
<a href="#l17.198"></a><span id="l17.198"> NS_IMETHODIMP</span>
<a href="#l17.199"></a><span id="l17.199" class="difflineminus">-nsSpamSettings::SetLogStream(nsIOutputStream *aLogStream)</span>
<a href="#l17.200"></a><span id="l17.200" class="difflineminus">-{</span>
<a href="#l17.201"></a><span id="l17.201" class="difflineplus">+nsSpamSettings::SetLogStream(nsIOutputStream *aLogStream) {</span>
<a href="#l17.202"></a><span id="l17.202">   // if there is a log stream already, close it</span>
<a href="#l17.203"></a><span id="l17.203">   if (mLogStream) {</span>
<a href="#l17.204"></a><span id="l17.204">     // will flush</span>
<a href="#l17.205"></a><span id="l17.205">     nsresult rv = mLogStream-&gt;Close();</span>
<a href="#l17.206"></a><span id="l17.206" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l17.207"></a><span id="l17.207" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.208"></a><span id="l17.208">   }</span>
<a href="#l17.209"></a><span id="l17.209"> </span>
<a href="#l17.210"></a><span id="l17.210">   mLogStream = aLogStream;</span>
<a href="#l17.211"></a><span id="l17.211">   return NS_OK;</span>
<a href="#l17.212"></a><span id="l17.212"> }</span>
<a href="#l17.213"></a><span id="l17.213"> </span>
<a href="#l17.214"></a><span id="l17.214" class="difflineminus">-#define LOG_HEADER &quot;&lt;!DOCTYPE html&gt;\n&lt;html&gt;\n&lt;head&gt;\n&lt;meta charset=\&quot;UTF-8\&quot;&gt;\n&lt;style type=\&quot;text/css\&quot;&gt;body{font-family:Consolas,\&quot;Lucida Console\&quot;,Monaco,\&quot;Courier New\&quot;,Courier,monospace;font-size:small}&lt;/style&gt;\n&lt;/head&gt;\n&lt;body&gt;\n&quot;</span>
<a href="#l17.215"></a><span id="l17.215" class="difflineplus">+#define LOG_HEADER                                                     \</span>
<a href="#l17.216"></a><span id="l17.216" class="difflineplus">+  &quot;&lt;!DOCTYPE html&gt;\n&lt;html&gt;\n&lt;head&gt;\n&lt;meta charset=\&quot;UTF-8\&quot;&gt;\n&lt;style &quot; \</span>
<a href="#l17.217"></a><span id="l17.217" class="difflineplus">+  &quot;type=\&quot;text/css\&quot;&gt;body{font-family:Consolas,\&quot;Lucida &quot;              \</span>
<a href="#l17.218"></a><span id="l17.218" class="difflineplus">+  &quot;Console\&quot;,Monaco,\&quot;Courier &quot;                                        \</span>
<a href="#l17.219"></a><span id="l17.219" class="difflineplus">+  &quot;New\&quot;,Courier,monospace;font-size:small}&lt;/style&gt;\n&lt;/head&gt;\n&lt;body&gt;\n&quot;</span>
<a href="#l17.220"></a><span id="l17.220"> #define LOG_HEADER_LEN (strlen(LOG_HEADER))</span>
<a href="#l17.221"></a><span id="l17.221"> </span>
<a href="#l17.222"></a><span id="l17.222"> NS_IMETHODIMP</span>
<a href="#l17.223"></a><span id="l17.223" class="difflineminus">-nsSpamSettings::GetLogStream(nsIOutputStream **aLogStream)</span>
<a href="#l17.224"></a><span id="l17.224" class="difflineminus">-{</span>
<a href="#l17.225"></a><span id="l17.225" class="difflineplus">+nsSpamSettings::GetLogStream(nsIOutputStream **aLogStream) {</span>
<a href="#l17.226"></a><span id="l17.226">   NS_ENSURE_ARG_POINTER(aLogStream);</span>
<a href="#l17.227"></a><span id="l17.227"> </span>
<a href="#l17.228"></a><span id="l17.228">   nsresult rv;</span>
<a href="#l17.229"></a><span id="l17.229"> </span>
<a href="#l17.230"></a><span id="l17.230">   if (!mLogStream) {</span>
<a href="#l17.231"></a><span id="l17.231">     // append to the end of the log file</span>
<a href="#l17.232"></a><span id="l17.232" class="difflineminus">-    rv = MsgNewBufferedFileOutputStream(getter_AddRefs(mLogStream),</span>
<a href="#l17.233"></a><span id="l17.233" class="difflineminus">-                                        mLogFile,</span>
<a href="#l17.234"></a><span id="l17.234" class="difflineplus">+    rv = MsgNewBufferedFileOutputStream(getter_AddRefs(mLogStream), mLogFile,</span>
<a href="#l17.235"></a><span id="l17.235">                                         PR_CREATE_FILE | PR_WRONLY | PR_APPEND,</span>
<a href="#l17.236"></a><span id="l17.236">                                         0600);</span>
<a href="#l17.237"></a><span id="l17.237">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.238"></a><span id="l17.238"> </span>
<a href="#l17.239"></a><span id="l17.239">     int64_t fileSize;</span>
<a href="#l17.240"></a><span id="l17.240">     rv = mLogFile-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l17.241"></a><span id="l17.241">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.242"></a><span id="l17.242"> </span>
<a href="#l17.243"></a><span id="l17.243">     // write the header at the start</span>
<a href="#l17.244"></a><span id="l17.244" class="difflineminus">-    if (fileSize == 0)</span>
<a href="#l17.245"></a><span id="l17.245" class="difflineminus">-    {</span>
<a href="#l17.246"></a><span id="l17.246" class="difflineplus">+    if (fileSize == 0) {</span>
<a href="#l17.247"></a><span id="l17.247">       uint32_t writeCount;</span>
<a href="#l17.248"></a><span id="l17.248"> </span>
<a href="#l17.249"></a><span id="l17.249">       rv = mLogStream-&gt;Write(LOG_HEADER, LOG_HEADER_LEN, &amp;writeCount);</span>
<a href="#l17.250"></a><span id="l17.250">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.251"></a><span id="l17.251" class="difflineminus">-      NS_ASSERTION(writeCount == LOG_HEADER_LEN, &quot;failed to write out log header&quot;);</span>
<a href="#l17.252"></a><span id="l17.252" class="difflineplus">+      NS_ASSERTION(writeCount == LOG_HEADER_LEN,</span>
<a href="#l17.253"></a><span id="l17.253" class="difflineplus">+                   &quot;failed to write out log header&quot;);</span>
<a href="#l17.254"></a><span id="l17.254">     }</span>
<a href="#l17.255"></a><span id="l17.255">   }</span>
<a href="#l17.256"></a><span id="l17.256"> </span>
<a href="#l17.257"></a><span id="l17.257">   NS_ADDREF(*aLogStream = mLogStream);</span>
<a href="#l17.258"></a><span id="l17.258">   return NS_OK;</span>
<a href="#l17.259"></a><span id="l17.259"> }</span>
<a href="#l17.260"></a><span id="l17.260"> </span>
<a href="#l17.261"></a><span id="l17.261" class="difflineminus">-NS_IMETHODIMP nsSpamSettings::Initialize(nsIMsgIncomingServer *aServer)</span>
<a href="#l17.262"></a><span id="l17.262" class="difflineminus">-{</span>
<a href="#l17.263"></a><span id="l17.263" class="difflineplus">+NS_IMETHODIMP nsSpamSettings::Initialize(nsIMsgIncomingServer *aServer) {</span>
<a href="#l17.264"></a><span id="l17.264">   NS_ENSURE_ARG_POINTER(aServer);</span>
<a href="#l17.265"></a><span id="l17.265">   nsresult rv;</span>
<a href="#l17.266"></a><span id="l17.266">   int32_t spamLevel;</span>
<a href="#l17.267"></a><span id="l17.267">   rv = aServer-&gt;GetIntValue(&quot;spamLevel&quot;, &amp;spamLevel);</span>
<a href="#l17.268"></a><span id="l17.268">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.269"></a><span id="l17.269">   rv = SetLevel(spamLevel);</span>
<a href="#l17.270"></a><span id="l17.270">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.271"></a><span id="l17.271"> </span>
<a href="#l17.272"></a><span id="l17.272" class="difflineat">@@ -249,17 +241,18 @@ NS_IMETHODIMP nsSpamSettings::Initialize</span>
<a href="#l17.273"></a><span id="l17.273"> </span>
<a href="#l17.274"></a><span id="l17.274">   int32_t moveTargetMode;</span>
<a href="#l17.275"></a><span id="l17.275">   rv = aServer-&gt;GetIntValue(&quot;moveTargetMode&quot;, &amp;moveTargetMode);</span>
<a href="#l17.276"></a><span id="l17.276">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.277"></a><span id="l17.277">   rv = SetMoveTargetMode(moveTargetMode);</span>
<a href="#l17.278"></a><span id="l17.278">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.279"></a><span id="l17.279"> </span>
<a href="#l17.280"></a><span id="l17.280">   nsCString spamActionTargetAccount;</span>
<a href="#l17.281"></a><span id="l17.281" class="difflineminus">-  rv = aServer-&gt;GetCharValue(&quot;spamActionTargetAccount&quot;, spamActionTargetAccount);</span>
<a href="#l17.282"></a><span id="l17.282" class="difflineplus">+  rv =</span>
<a href="#l17.283"></a><span id="l17.283" class="difflineplus">+      aServer-&gt;GetCharValue(&quot;spamActionTargetAccount&quot;, spamActionTargetAccount);</span>
<a href="#l17.284"></a><span id="l17.284">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.285"></a><span id="l17.285">   rv = SetActionTargetAccount(spamActionTargetAccount.get());</span>
<a href="#l17.286"></a><span id="l17.286">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.287"></a><span id="l17.287"> </span>
<a href="#l17.288"></a><span id="l17.288">   nsCString spamActionTargetFolder;</span>
<a href="#l17.289"></a><span id="l17.289">   rv = aServer-&gt;GetCharValue(&quot;spamActionTargetFolder&quot;, spamActionTargetFolder);</span>
<a href="#l17.290"></a><span id="l17.290">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.291"></a><span id="l17.291">   rv = SetActionTargetFolder(spamActionTargetFolder.get());</span>
<a href="#l17.292"></a><span id="l17.292" class="difflineat">@@ -292,229 +285,219 @@ NS_IMETHODIMP nsSpamSettings::Initialize</span>
<a href="#l17.293"></a><span id="l17.293">   bool useServerFilter;</span>
<a href="#l17.294"></a><span id="l17.294">   rv = aServer-&gt;GetBoolValue(&quot;useServerFilter&quot;, &amp;useServerFilter);</span>
<a href="#l17.295"></a><span id="l17.295">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.296"></a><span id="l17.296">   rv = SetUseServerFilter(useServerFilter);</span>
<a href="#l17.297"></a><span id="l17.297">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.298"></a><span id="l17.298"> </span>
<a href="#l17.299"></a><span id="l17.299">   nsCString serverFilterName;</span>
<a href="#l17.300"></a><span id="l17.300">   rv = aServer-&gt;GetCharValue(&quot;serverFilterName&quot;, serverFilterName);</span>
<a href="#l17.301"></a><span id="l17.301" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l17.302"></a><span id="l17.302" class="difflineminus">-    SetServerFilterName(serverFilterName);</span>
<a href="#l17.303"></a><span id="l17.303" class="difflineplus">+  if (NS_SUCCEEDED(rv)) SetServerFilterName(serverFilterName);</span>
<a href="#l17.304"></a><span id="l17.304">   int32_t serverFilterTrustFlags = 0;</span>
<a href="#l17.305"></a><span id="l17.305">   rv = aServer-&gt;GetIntValue(&quot;serverFilterTrustFlags&quot;, &amp;serverFilterTrustFlags);</span>
<a href="#l17.306"></a><span id="l17.306">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.307"></a><span id="l17.307">   rv = SetServerFilterTrustFlags(serverFilterTrustFlags);</span>
<a href="#l17.308"></a><span id="l17.308">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.309"></a><span id="l17.309"> </span>
<a href="#l17.310"></a><span id="l17.310" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l17.311"></a><span id="l17.311" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(</span>
<a href="#l17.312"></a><span id="l17.312" class="difflineplus">+      do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l17.313"></a><span id="l17.313">   if (prefBranch)</span>
<a href="#l17.314"></a><span id="l17.314">     prefBranch-&gt;GetCharPref(&quot;mail.trusteddomains&quot;, mTrustedMailDomains);</span>
<a href="#l17.315"></a><span id="l17.315"> </span>
<a href="#l17.316"></a><span id="l17.316">   mWhiteListDirArray.Clear();</span>
<a href="#l17.317"></a><span id="l17.317" class="difflineminus">-  if (!mWhiteListAbURI.IsEmpty())</span>
<a href="#l17.318"></a><span id="l17.318" class="difflineminus">-  {</span>
<a href="#l17.319"></a><span id="l17.319" class="difflineminus">-    nsCOMPtr&lt;nsIAbManager&gt; abManager(do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv));</span>
<a href="#l17.320"></a><span id="l17.320" class="difflineplus">+  if (!mWhiteListAbURI.IsEmpty()) {</span>
<a href="#l17.321"></a><span id="l17.321" class="difflineplus">+    nsCOMPtr&lt;nsIAbManager&gt; abManager(</span>
<a href="#l17.322"></a><span id="l17.322" class="difflineplus">+        do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv));</span>
<a href="#l17.323"></a><span id="l17.323">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.324"></a><span id="l17.324"> </span>
<a href="#l17.325"></a><span id="l17.325">     nsTArray&lt;nsCString&gt; whiteListArray;</span>
<a href="#l17.326"></a><span id="l17.326">     ParseString(mWhiteListAbURI, ' ', whiteListArray);</span>
<a href="#l17.327"></a><span id="l17.327"> </span>
<a href="#l17.328"></a><span id="l17.328" class="difflineminus">-    for (uint32_t index = 0; index &lt; whiteListArray.Length(); index++)</span>
<a href="#l17.329"></a><span id="l17.329" class="difflineminus">-    {</span>
<a href="#l17.330"></a><span id="l17.330" class="difflineplus">+    for (uint32_t index = 0; index &lt; whiteListArray.Length(); index++) {</span>
<a href="#l17.331"></a><span id="l17.331">       nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l17.332"></a><span id="l17.332">       rv = abManager-&gt;GetDirectory(whiteListArray[index],</span>
<a href="#l17.333"></a><span id="l17.333">                                    getter_AddRefs(directory));</span>
<a href="#l17.334"></a><span id="l17.334">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.335"></a><span id="l17.335"> </span>
<a href="#l17.336"></a><span id="l17.336" class="difflineminus">-      if (directory)</span>
<a href="#l17.337"></a><span id="l17.337" class="difflineminus">-        mWhiteListDirArray.AppendObject(directory);</span>
<a href="#l17.338"></a><span id="l17.338" class="difflineplus">+      if (directory) mWhiteListDirArray.AppendObject(directory);</span>
<a href="#l17.339"></a><span id="l17.339">     }</span>
<a href="#l17.340"></a><span id="l17.340">   }</span>
<a href="#l17.341"></a><span id="l17.341"> </span>
<a href="#l17.342"></a><span id="l17.342">   // the next two preferences affect whether we try to whitelist our own</span>
<a href="#l17.343"></a><span id="l17.343">   // address or domain. Spammers send emails with spoofed from address matching</span>
<a href="#l17.344"></a><span id="l17.344">   // either the email address of the recipient, or the recipient's domain,</span>
<a href="#l17.345"></a><span id="l17.345">   // hoping to get whitelisted.</span>
<a href="#l17.346"></a><span id="l17.346">   //</span>
<a href="#l17.347"></a><span id="l17.347">   // The terms to describe this get wrapped up in chains of negatives. A full</span>
<a href="#l17.348"></a><span id="l17.348" class="difflineminus">-  // definition of the boolean inhibitWhiteListingIdentityUser is &quot;Suppress address</span>
<a href="#l17.349"></a><span id="l17.349" class="difflineminus">-  // book whitelisting if the sender matches an identity's email address&quot;</span>
<a href="#l17.350"></a><span id="l17.350" class="difflineplus">+  // definition of the boolean inhibitWhiteListingIdentityUser is &quot;Suppress</span>
<a href="#l17.351"></a><span id="l17.351" class="difflineplus">+  // address book whitelisting if the sender matches an identity's email</span>
<a href="#l17.352"></a><span id="l17.352" class="difflineplus">+  // address&quot;</span>
<a href="#l17.353"></a><span id="l17.353"> </span>
<a href="#l17.354"></a><span id="l17.354">   rv = aServer-&gt;GetBoolValue(&quot;inhibitWhiteListingIdentityUser&quot;,</span>
<a href="#l17.355"></a><span id="l17.355">                              &amp;mInhibitWhiteListingIdentityUser);</span>
<a href="#l17.356"></a><span id="l17.356">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.357"></a><span id="l17.357">   rv = aServer-&gt;GetBoolValue(&quot;inhibitWhiteListingIdentityDomain&quot;,</span>
<a href="#l17.358"></a><span id="l17.358">                              &amp;mInhibitWhiteListingIdentityDomain);</span>
<a href="#l17.359"></a><span id="l17.359">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.360"></a><span id="l17.360"> </span>
<a href="#l17.361"></a><span id="l17.361">   // collect lists of identity users if needed</span>
<a href="#l17.362"></a><span id="l17.362" class="difflineminus">-  if (mInhibitWhiteListingIdentityDomain || mInhibitWhiteListingIdentityUser)</span>
<a href="#l17.363"></a><span id="l17.363" class="difflineminus">-  {</span>
<a href="#l17.364"></a><span id="l17.364" class="difflineminus">-    nsCOMPtr&lt;nsIMsgAccountManager&gt;</span>
<a href="#l17.365"></a><span id="l17.365" class="difflineminus">-      accountManager(do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv));</span>
<a href="#l17.366"></a><span id="l17.366" class="difflineplus">+  if (mInhibitWhiteListingIdentityDomain || mInhibitWhiteListingIdentityUser) {</span>
<a href="#l17.367"></a><span id="l17.367" class="difflineplus">+    nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager(</span>
<a href="#l17.368"></a><span id="l17.368" class="difflineplus">+        do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv));</span>
<a href="#l17.369"></a><span id="l17.369">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.370"></a><span id="l17.370"> </span>
<a href="#l17.371"></a><span id="l17.371">     nsCOMPtr&lt;nsIMsgAccount&gt; account;</span>
<a href="#l17.372"></a><span id="l17.372">     rv = accountManager-&gt;FindAccountForServer(aServer, getter_AddRefs(account));</span>
<a href="#l17.373"></a><span id="l17.373">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.374"></a><span id="l17.374"> </span>
<a href="#l17.375"></a><span id="l17.375">     nsAutoCString accountKey;</span>
<a href="#l17.376"></a><span id="l17.376" class="difflineminus">-    if (account)</span>
<a href="#l17.377"></a><span id="l17.377" class="difflineminus">-      account-&gt;GetKey(accountKey);</span>
<a href="#l17.378"></a><span id="l17.378" class="difflineplus">+    if (account) account-&gt;GetKey(accountKey);</span>
<a href="#l17.379"></a><span id="l17.379"> </span>
<a href="#l17.380"></a><span id="l17.380">     // Loop through all accounts, adding emails from this account, as well as</span>
<a href="#l17.381"></a><span id="l17.381">     // from any accounts that defer to this account.</span>
<a href="#l17.382"></a><span id="l17.382">     mEmails.Clear();</span>
<a href="#l17.383"></a><span id="l17.383">     nsCOMPtr&lt;nsIArray&gt; accounts;</span>
<a href="#l17.384"></a><span id="l17.384">     rv = accountManager-&gt;GetAccounts(getter_AddRefs(accounts));</span>
<a href="#l17.385"></a><span id="l17.385">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.386"></a><span id="l17.386">     uint32_t accountCount = 0;</span>
<a href="#l17.387"></a><span id="l17.387" class="difflineminus">-    if (account &amp;&amp; accounts) // no sense scanning accounts if we've nothing to match</span>
<a href="#l17.388"></a><span id="l17.388" class="difflineplus">+    // No sense scanning accounts if we've nothing to match.</span>
<a href="#l17.389"></a><span id="l17.389" class="difflineplus">+    if (account &amp;&amp; accounts)</span>
<a href="#l17.390"></a><span id="l17.390">       accounts-&gt;GetLength(&amp;accountCount);</span>
<a href="#l17.391"></a><span id="l17.391"> </span>
<a href="#l17.392"></a><span id="l17.392" class="difflineminus">-    for (uint32_t i = 0; i &lt; accountCount; i++)</span>
<a href="#l17.393"></a><span id="l17.393" class="difflineminus">-    {</span>
<a href="#l17.394"></a><span id="l17.394" class="difflineplus">+    for (uint32_t i = 0; i &lt; accountCount; i++) {</span>
<a href="#l17.395"></a><span id="l17.395">       nsCOMPtr&lt;nsIMsgAccount&gt; loopAccount(do_QueryElementAt(accounts, i));</span>
<a href="#l17.396"></a><span id="l17.396" class="difflineminus">-      if (!loopAccount)</span>
<a href="#l17.397"></a><span id="l17.397" class="difflineminus">-        continue;</span>
<a href="#l17.398"></a><span id="l17.398" class="difflineplus">+      if (!loopAccount) continue;</span>
<a href="#l17.399"></a><span id="l17.399">       nsAutoCString loopAccountKey;</span>
<a href="#l17.400"></a><span id="l17.400">       loopAccount-&gt;GetKey(loopAccountKey);</span>
<a href="#l17.401"></a><span id="l17.401">       nsCOMPtr&lt;nsIMsgIncomingServer&gt; loopServer;</span>
<a href="#l17.402"></a><span id="l17.402">       loopAccount-&gt;GetIncomingServer(getter_AddRefs(loopServer));</span>
<a href="#l17.403"></a><span id="l17.403">       nsAutoCString deferredToAccountKey;</span>
<a href="#l17.404"></a><span id="l17.404">       if (loopServer)</span>
<a href="#l17.405"></a><span id="l17.405">         loopServer-&gt;GetCharValue(&quot;deferred_to_account&quot;, deferredToAccountKey);</span>
<a href="#l17.406"></a><span id="l17.406"> </span>
<a href="#l17.407"></a><span id="l17.407">       // Add the emails for any account that defers to this one, or for the</span>
<a href="#l17.408"></a><span id="l17.408">       // account itself.</span>
<a href="#l17.409"></a><span id="l17.409" class="difflineminus">-      if (accountKey.Equals(deferredToAccountKey) || accountKey.Equals(loopAccountKey))</span>
<a href="#l17.410"></a><span id="l17.410" class="difflineminus">-      {</span>
<a href="#l17.411"></a><span id="l17.411" class="difflineplus">+      if (accountKey.Equals(deferredToAccountKey) ||</span>
<a href="#l17.412"></a><span id="l17.412" class="difflineplus">+          accountKey.Equals(loopAccountKey)) {</span>
<a href="#l17.413"></a><span id="l17.413">         nsCOMPtr&lt;nsIArray&gt; identities;</span>
<a href="#l17.414"></a><span id="l17.414">         loopAccount-&gt;GetIdentities(getter_AddRefs(identities));</span>
<a href="#l17.415"></a><span id="l17.415" class="difflineminus">-        if (!identities)</span>
<a href="#l17.416"></a><span id="l17.416" class="difflineminus">-          continue;</span>
<a href="#l17.417"></a><span id="l17.417" class="difflineplus">+        if (!identities) continue;</span>
<a href="#l17.418"></a><span id="l17.418">         uint32_t identityCount = 0;</span>
<a href="#l17.419"></a><span id="l17.419">         identities-&gt;GetLength(&amp;identityCount);</span>
<a href="#l17.420"></a><span id="l17.420" class="difflineminus">-        for (uint32_t j = 0; j &lt; identityCount; ++j)</span>
<a href="#l17.421"></a><span id="l17.421" class="difflineminus">-        {</span>
<a href="#l17.422"></a><span id="l17.422" class="difflineminus">-          nsCOMPtr&lt;nsIMsgIdentity&gt; identity(do_QueryElementAt(identities, j, &amp;rv));</span>
<a href="#l17.423"></a><span id="l17.423" class="difflineminus">-          if (NS_FAILED(rv) || !identity)</span>
<a href="#l17.424"></a><span id="l17.424" class="difflineminus">-            continue;</span>
<a href="#l17.425"></a><span id="l17.425" class="difflineplus">+        for (uint32_t j = 0; j &lt; identityCount; ++j) {</span>
<a href="#l17.426"></a><span id="l17.426" class="difflineplus">+          nsCOMPtr&lt;nsIMsgIdentity&gt; identity(</span>
<a href="#l17.427"></a><span id="l17.427" class="difflineplus">+              do_QueryElementAt(identities, j, &amp;rv));</span>
<a href="#l17.428"></a><span id="l17.428" class="difflineplus">+          if (NS_FAILED(rv) || !identity) continue;</span>
<a href="#l17.429"></a><span id="l17.429">           nsAutoCString email;</span>
<a href="#l17.430"></a><span id="l17.430">           identity-&gt;GetEmail(email);</span>
<a href="#l17.431"></a><span id="l17.431" class="difflineminus">-          if (!email.IsEmpty())</span>
<a href="#l17.432"></a><span id="l17.432" class="difflineminus">-            mEmails.AppendElement(email);</span>
<a href="#l17.433"></a><span id="l17.433" class="difflineplus">+          if (!email.IsEmpty()) mEmails.AppendElement(email);</span>
<a href="#l17.434"></a><span id="l17.434">         }</span>
<a href="#l17.435"></a><span id="l17.435">       }</span>
<a href="#l17.436"></a><span id="l17.436">     }</span>
<a href="#l17.437"></a><span id="l17.437">   }</span>
<a href="#l17.438"></a><span id="l17.438"> </span>
<a href="#l17.439"></a><span id="l17.439">   return UpdateJunkFolderState();</span>
<a href="#l17.440"></a><span id="l17.440"> }</span>
<a href="#l17.441"></a><span id="l17.441"> </span>
<a href="#l17.442"></a><span id="l17.442" class="difflineminus">-nsresult nsSpamSettings::UpdateJunkFolderState()</span>
<a href="#l17.443"></a><span id="l17.443" class="difflineminus">-{</span>
<a href="#l17.444"></a><span id="l17.444" class="difflineplus">+nsresult nsSpamSettings::UpdateJunkFolderState() {</span>
<a href="#l17.445"></a><span id="l17.445">   nsresult rv;</span>
<a href="#l17.446"></a><span id="l17.446"> </span>
<a href="#l17.447"></a><span id="l17.447">   // if the spam folder uri changed on us, we need to unset the junk flag</span>
<a href="#l17.448"></a><span id="l17.448">   // on the old spam folder</span>
<a href="#l17.449"></a><span id="l17.449">   nsCString newJunkFolderURI;</span>
<a href="#l17.450"></a><span id="l17.450">   rv = GetSpamFolderURI(getter_Copies(newJunkFolderURI));</span>
<a href="#l17.451"></a><span id="l17.451">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.452"></a><span id="l17.452"> </span>
<a href="#l17.453"></a><span id="l17.453" class="difflineminus">-  if (!mCurrentJunkFolderURI.IsEmpty() &amp;&amp; !mCurrentJunkFolderURI.Equals(newJunkFolderURI))</span>
<a href="#l17.454"></a><span id="l17.454" class="difflineminus">-  {</span>
<a href="#l17.455"></a><span id="l17.455" class="difflineplus">+  if (!mCurrentJunkFolderURI.IsEmpty() &amp;&amp;</span>
<a href="#l17.456"></a><span id="l17.456" class="difflineplus">+      !mCurrentJunkFolderURI.Equals(newJunkFolderURI)) {</span>
<a href="#l17.457"></a><span id="l17.457">     nsCOMPtr&lt;nsIMsgFolder&gt; oldJunkFolder;</span>
<a href="#l17.458"></a><span id="l17.458">     rv = FindFolder(mCurrentJunkFolderURI, getter_AddRefs(oldJunkFolder));</span>
<a href="#l17.459"></a><span id="l17.459">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.460"></a><span id="l17.460" class="difflineminus">-    if (oldJunkFolder)</span>
<a href="#l17.461"></a><span id="l17.461" class="difflineminus">-    {</span>
<a href="#l17.462"></a><span id="l17.462" class="difflineplus">+    if (oldJunkFolder) {</span>
<a href="#l17.463"></a><span id="l17.463">       // remove the nsMsgFolderFlags::Junk on the old junk folder</span>
<a href="#l17.464"></a><span id="l17.464">       // XXX TODO</span>
<a href="#l17.465"></a><span id="l17.465">       // JUNK MAIL RELATED</span>
<a href="#l17.466"></a><span id="l17.466">       // (in ClearFlag?) we need to make sure that this folder</span>
<a href="#l17.467"></a><span id="l17.467">       // is not the junk folder for another account</span>
<a href="#l17.468"></a><span id="l17.468">       // the same goes for set flag.  have fun with all that.</span>
<a href="#l17.469"></a><span id="l17.469">       oldJunkFolder-&gt;ClearFlag(nsMsgFolderFlags::Junk);</span>
<a href="#l17.470"></a><span id="l17.470">     }</span>
<a href="#l17.471"></a><span id="l17.471">   }</span>
<a href="#l17.472"></a><span id="l17.472"> </span>
<a href="#l17.473"></a><span id="l17.473">   mCurrentJunkFolderURI = newJunkFolderURI;</span>
<a href="#l17.474"></a><span id="l17.474"> </span>
<a href="#l17.475"></a><span id="l17.475">   // only try to create the junk folder if we are moving junk</span>
<a href="#l17.476"></a><span id="l17.476">   // and we have a non-empty uri</span>
<a href="#l17.477"></a><span id="l17.477">   if (mMoveOnSpam &amp;&amp; !mCurrentJunkFolderURI.IsEmpty()) {</span>
<a href="#l17.478"></a><span id="l17.478" class="difflineminus">-    // as the url listener, the spam settings will set the nsMsgFolderFlags::Junk folder flag</span>
<a href="#l17.479"></a><span id="l17.479" class="difflineminus">-    // on the junk mail folder, after it is created</span>
<a href="#l17.480"></a><span id="l17.480" class="difflineplus">+    // as the url listener, the spam settings will set the</span>
<a href="#l17.481"></a><span id="l17.481" class="difflineplus">+    // nsMsgFolderFlags::Junk folder flag on the junk mail folder, after it is</span>
<a href="#l17.482"></a><span id="l17.482" class="difflineplus">+    // created</span>
<a href="#l17.483"></a><span id="l17.483">     rv = GetOrCreateJunkFolder(mCurrentJunkFolderURI, this);</span>
<a href="#l17.484"></a><span id="l17.484">   }</span>
<a href="#l17.485"></a><span id="l17.485"> </span>
<a href="#l17.486"></a><span id="l17.486">   return rv;</span>
<a href="#l17.487"></a><span id="l17.487"> }</span>
<a href="#l17.488"></a><span id="l17.488"> </span>
<a href="#l17.489"></a><span id="l17.489" class="difflineminus">-NS_IMETHODIMP nsSpamSettings::Clone(nsISpamSettings *aSpamSettings)</span>
<a href="#l17.490"></a><span id="l17.490" class="difflineminus">-{</span>
<a href="#l17.491"></a><span id="l17.491" class="difflineplus">+NS_IMETHODIMP nsSpamSettings::Clone(nsISpamSettings *aSpamSettings) {</span>
<a href="#l17.492"></a><span id="l17.492">   NS_ENSURE_ARG_POINTER(aSpamSettings);</span>
<a href="#l17.493"></a><span id="l17.493"> </span>
<a href="#l17.494"></a><span id="l17.494">   nsresult rv = aSpamSettings-&gt;GetUseWhiteList(&amp;mUseWhiteList);</span>
<a href="#l17.495"></a><span id="l17.495" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l17.496"></a><span id="l17.496" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.497"></a><span id="l17.497"> </span>
<a href="#l17.498"></a><span id="l17.498">   (void)aSpamSettings-&gt;GetMoveOnSpam(&amp;mMoveOnSpam);</span>
<a href="#l17.499"></a><span id="l17.499">   (void)aSpamSettings-&gt;GetPurge(&amp;mPurge);</span>
<a href="#l17.500"></a><span id="l17.500">   (void)aSpamSettings-&gt;GetUseServerFilter(&amp;mUseServerFilter);</span>
<a href="#l17.501"></a><span id="l17.501"> </span>
<a href="#l17.502"></a><span id="l17.502">   rv = aSpamSettings-&gt;GetPurgeInterval(&amp;mPurgeInterval);</span>
<a href="#l17.503"></a><span id="l17.503" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l17.504"></a><span id="l17.504" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.505"></a><span id="l17.505"> </span>
<a href="#l17.506"></a><span id="l17.506">   rv = aSpamSettings-&gt;GetLevel(&amp;mLevel);</span>
<a href="#l17.507"></a><span id="l17.507" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l17.508"></a><span id="l17.508" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.509"></a><span id="l17.509"> </span>
<a href="#l17.510"></a><span id="l17.510">   rv = aSpamSettings-&gt;GetMoveTargetMode(&amp;mMoveTargetMode);</span>
<a href="#l17.511"></a><span id="l17.511" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l17.512"></a><span id="l17.512" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.513"></a><span id="l17.513"> </span>
<a href="#l17.514"></a><span id="l17.514">   nsCString actionTargetAccount;</span>
<a href="#l17.515"></a><span id="l17.515" class="difflineminus">-  rv = aSpamSettings-&gt;GetActionTargetAccount(getter_Copies(actionTargetAccount));</span>
<a href="#l17.516"></a><span id="l17.516" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l17.517"></a><span id="l17.517" class="difflineplus">+  rv =</span>
<a href="#l17.518"></a><span id="l17.518" class="difflineplus">+      aSpamSettings-&gt;GetActionTargetAccount(getter_Copies(actionTargetAccount));</span>
<a href="#l17.519"></a><span id="l17.519" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.520"></a><span id="l17.520">   mActionTargetAccount = actionTargetAccount;</span>
<a href="#l17.521"></a><span id="l17.521"> </span>
<a href="#l17.522"></a><span id="l17.522">   nsCString actionTargetFolder;</span>
<a href="#l17.523"></a><span id="l17.523">   rv = aSpamSettings-&gt;GetActionTargetFolder(getter_Copies(actionTargetFolder));</span>
<a href="#l17.524"></a><span id="l17.524" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l17.525"></a><span id="l17.525" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.526"></a><span id="l17.526">   mActionTargetFolder = actionTargetFolder;</span>
<a href="#l17.527"></a><span id="l17.527"> </span>
<a href="#l17.528"></a><span id="l17.528">   nsCString whiteListAbURI;</span>
<a href="#l17.529"></a><span id="l17.529">   rv = aSpamSettings-&gt;GetWhiteListAbURI(getter_Copies(whiteListAbURI));</span>
<a href="#l17.530"></a><span id="l17.530" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l17.531"></a><span id="l17.531" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.532"></a><span id="l17.532">   mWhiteListAbURI = whiteListAbURI;</span>
<a href="#l17.533"></a><span id="l17.533"> </span>
<a href="#l17.534"></a><span id="l17.534">   aSpamSettings-&gt;GetServerFilterName(mServerFilterName);</span>
<a href="#l17.535"></a><span id="l17.535">   aSpamSettings-&gt;GetServerFilterTrustFlags(&amp;mServerFilterTrustFlags);</span>
<a href="#l17.536"></a><span id="l17.536"> </span>
<a href="#l17.537"></a><span id="l17.537">   return rv;</span>
<a href="#l17.538"></a><span id="l17.538"> }</span>
<a href="#l17.539"></a><span id="l17.539"> </span>
<a href="#l17.540"></a><span id="l17.540" class="difflineminus">-NS_IMETHODIMP nsSpamSettings::GetSpamFolderURI(char **aSpamFolderURI)</span>
<a href="#l17.541"></a><span id="l17.541" class="difflineminus">-{</span>
<a href="#l17.542"></a><span id="l17.542" class="difflineplus">+NS_IMETHODIMP nsSpamSettings::GetSpamFolderURI(char **aSpamFolderURI) {</span>
<a href="#l17.543"></a><span id="l17.543">   NS_ENSURE_ARG_POINTER(aSpamFolderURI);</span>
<a href="#l17.544"></a><span id="l17.544"> </span>
<a href="#l17.545"></a><span id="l17.545">   if (mMoveTargetMode == nsISpamSettings::MOVE_TARGET_MODE_FOLDER)</span>
<a href="#l17.546"></a><span id="l17.546">     return GetActionTargetFolder(aSpamFolderURI);</span>
<a href="#l17.547"></a><span id="l17.547"> </span>
<a href="#l17.548"></a><span id="l17.548">   // if the mode is nsISpamSettings::MOVE_TARGET_MODE_ACCOUNT</span>
<a href="#l17.549"></a><span id="l17.549">   // the spam folder URI = account uri + &quot;/Junk&quot;</span>
<a href="#l17.550"></a><span id="l17.550">   nsCString folderURI;</span>
<a href="#l17.551"></a><span id="l17.551">   nsresult rv = GetActionTargetAccount(getter_Copies(folderURI));</span>
<a href="#l17.552"></a><span id="l17.552">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.553"></a><span id="l17.553"> </span>
<a href="#l17.554"></a><span id="l17.554">   // we might be trying to get the old spam folder uri</span>
<a href="#l17.555"></a><span id="l17.555">   // in order to clear the flag</span>
<a href="#l17.556"></a><span id="l17.556">   // if we didn't have one, bail out.</span>
<a href="#l17.557"></a><span id="l17.557" class="difflineminus">-  if (folderURI.IsEmpty())</span>
<a href="#l17.558"></a><span id="l17.558" class="difflineminus">-    return NS_OK;</span>
<a href="#l17.559"></a><span id="l17.559" class="difflineplus">+  if (folderURI.IsEmpty()) return NS_OK;</span>
<a href="#l17.560"></a><span id="l17.560"> </span>
<a href="#l17.561"></a><span id="l17.561">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l17.562"></a><span id="l17.562">   rv = GetOrCreateFolder(folderURI, getter_AddRefs(folder));</span>
<a href="#l17.563"></a><span id="l17.563">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.564"></a><span id="l17.564"> </span>
<a href="#l17.565"></a><span id="l17.565">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l17.566"></a><span id="l17.566">   rv = folder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l17.567"></a><span id="l17.567">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.568"></a><span id="l17.568" class="difflineat">@@ -534,326 +517,306 @@ NS_IMETHODIMP nsSpamSettings::GetSpamFol</span>
<a href="#l17.569"></a><span id="l17.569">   // better not to make base depend in imap</span>
<a href="#l17.570"></a><span id="l17.570">   // but doing it here, like in nsMsgCopy.cpp</span>
<a href="#l17.571"></a><span id="l17.571">   // one day, we'll fix this (and nsMsgCopy.cpp) to use GetMsgFolderFromURI()</span>
<a href="#l17.572"></a><span id="l17.572">   nsCOMPtr&lt;nsIImapIncomingServer&gt; imapServer = do_QueryInterface(server);</span>
<a href="#l17.573"></a><span id="l17.573">   if (imapServer) {</span>
<a href="#l17.574"></a><span id="l17.574">     // Make sure an specific IMAP folder has correct personal namespace</span>
<a href="#l17.575"></a><span id="l17.575">     // see bug #197043</span>
<a href="#l17.576"></a><span id="l17.576">     nsCString folderUriWithNamespace;</span>
<a href="#l17.577"></a><span id="l17.577" class="difflineminus">-    (void)imapServer-&gt;GetUriWithNamespacePrefixIfNecessary(kPersonalNamespace, folderURI,</span>
<a href="#l17.578"></a><span id="l17.578" class="difflineminus">-                                                           folderUriWithNamespace);</span>
<a href="#l17.579"></a><span id="l17.579" class="difflineminus">-    if (!folderUriWithNamespace.IsEmpty())</span>
<a href="#l17.580"></a><span id="l17.580" class="difflineminus">-      folderURI = folderUriWithNamespace;</span>
<a href="#l17.581"></a><span id="l17.581" class="difflineplus">+    (void)imapServer-&gt;GetUriWithNamespacePrefixIfNecessary(</span>
<a href="#l17.582"></a><span id="l17.582" class="difflineplus">+        kPersonalNamespace, folderURI, folderUriWithNamespace);</span>
<a href="#l17.583"></a><span id="l17.583" class="difflineplus">+    if (!folderUriWithNamespace.IsEmpty()) folderURI = folderUriWithNamespace;</span>
<a href="#l17.584"></a><span id="l17.584">   }</span>
<a href="#l17.585"></a><span id="l17.585"> </span>
<a href="#l17.586"></a><span id="l17.586">   *aSpamFolderURI = ToNewCString(folderURI);</span>
<a href="#l17.587"></a><span id="l17.587">   if (!*aSpamFolderURI)</span>
<a href="#l17.588"></a><span id="l17.588">     return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l17.589"></a><span id="l17.589">   else</span>
<a href="#l17.590"></a><span id="l17.590">     return rv;</span>
<a href="#l17.591"></a><span id="l17.591"> }</span>
<a href="#l17.592"></a><span id="l17.592"> </span>
<a href="#l17.593"></a><span id="l17.593" class="difflineminus">-NS_IMETHODIMP nsSpamSettings::GetServerFilterName(nsACString &amp;aFilterName)</span>
<a href="#l17.594"></a><span id="l17.594" class="difflineminus">-{</span>
<a href="#l17.595"></a><span id="l17.595" class="difflineplus">+NS_IMETHODIMP nsSpamSettings::GetServerFilterName(nsACString &amp;aFilterName) {</span>
<a href="#l17.596"></a><span id="l17.596">   aFilterName = mServerFilterName;</span>
<a href="#l17.597"></a><span id="l17.597">   return NS_OK;</span>
<a href="#l17.598"></a><span id="l17.598"> }</span>
<a href="#l17.599"></a><span id="l17.599"> </span>
<a href="#l17.600"></a><span id="l17.600" class="difflineminus">-NS_IMETHODIMP nsSpamSettings::SetServerFilterName(const nsACString &amp;aFilterName)</span>
<a href="#l17.601"></a><span id="l17.601" class="difflineminus">-{</span>
<a href="#l17.602"></a><span id="l17.602" class="difflineplus">+NS_IMETHODIMP nsSpamSettings::SetServerFilterName(</span>
<a href="#l17.603"></a><span id="l17.603" class="difflineplus">+    const nsACString &amp;aFilterName) {</span>
<a href="#l17.604"></a><span id="l17.604">   mServerFilterName = aFilterName;</span>
<a href="#l17.605"></a><span id="l17.605" class="difflineminus">-  mServerFilterFile = nullptr; // clear out our stored location value</span>
<a href="#l17.606"></a><span id="l17.606" class="difflineplus">+  mServerFilterFile = nullptr;  // clear out our stored location value</span>
<a href="#l17.607"></a><span id="l17.607">   return NS_OK;</span>
<a href="#l17.608"></a><span id="l17.608"> }</span>
<a href="#l17.609"></a><span id="l17.609"> </span>
<a href="#l17.610"></a><span id="l17.610" class="difflineminus">-NS_IMETHODIMP nsSpamSettings::GetServerFilterFile(nsIFile ** aFile)</span>
<a href="#l17.611"></a><span id="l17.611" class="difflineminus">-{</span>
<a href="#l17.612"></a><span id="l17.612" class="difflineplus">+NS_IMETHODIMP nsSpamSettings::GetServerFilterFile(nsIFile **aFile) {</span>
<a href="#l17.613"></a><span id="l17.613">   NS_ENSURE_ARG_POINTER(aFile);</span>
<a href="#l17.614"></a><span id="l17.614" class="difflineminus">-  if (!mServerFilterFile)</span>
<a href="#l17.615"></a><span id="l17.615" class="difflineminus">-  {</span>
<a href="#l17.616"></a><span id="l17.616" class="difflineplus">+  if (!mServerFilterFile) {</span>
<a href="#l17.617"></a><span id="l17.617">     nsresult rv;</span>
<a href="#l17.618"></a><span id="l17.618">     nsAutoCString serverFilterFileName;</span>
<a href="#l17.619"></a><span id="l17.619">     GetServerFilterName(serverFilterFileName);</span>
<a href="#l17.620"></a><span id="l17.620">     serverFilterFileName.AppendLiteral(&quot;.sfd&quot;);</span>
<a href="#l17.621"></a><span id="l17.621"> </span>
<a href="#l17.622"></a><span id="l17.622" class="difflineminus">-    nsCOMPtr&lt;nsIProperties&gt; dirSvc = do_GetService(NS_DIRECTORY_SERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l17.623"></a><span id="l17.623" class="difflineplus">+    nsCOMPtr&lt;nsIProperties&gt; dirSvc =</span>
<a href="#l17.624"></a><span id="l17.624" class="difflineplus">+        do_GetService(NS_DIRECTORY_SERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l17.625"></a><span id="l17.625">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.626"></a><span id="l17.626"> </span>
<a href="#l17.627"></a><span id="l17.627">     // Walk through the list of isp directories</span>
<a href="#l17.628"></a><span id="l17.628">     nsCOMPtr&lt;nsISimpleEnumerator&gt; ispDirectories;</span>
<a href="#l17.629"></a><span id="l17.629" class="difflineminus">-    rv = dirSvc-&gt;Get(ISP_DIRECTORY_LIST, NS_GET_IID(nsISimpleEnumerator), getter_AddRefs(ispDirectories));</span>
<a href="#l17.630"></a><span id="l17.630" class="difflineplus">+    rv = dirSvc-&gt;Get(ISP_DIRECTORY_LIST, NS_GET_IID(nsISimpleEnumerator),</span>
<a href="#l17.631"></a><span id="l17.631" class="difflineplus">+                     getter_AddRefs(ispDirectories));</span>
<a href="#l17.632"></a><span id="l17.632">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.633"></a><span id="l17.633"> </span>
<a href="#l17.634"></a><span id="l17.634">     bool hasMore;</span>
<a href="#l17.635"></a><span id="l17.635">     nsCOMPtr&lt;nsIFile&gt; file;</span>
<a href="#l17.636"></a><span id="l17.636" class="difflineminus">-    while (NS_SUCCEEDED(ispDirectories-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore)</span>
<a href="#l17.637"></a><span id="l17.637" class="difflineminus">-    {</span>
<a href="#l17.638"></a><span id="l17.638" class="difflineplus">+    while (NS_SUCCEEDED(ispDirectories-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore) {</span>
<a href="#l17.639"></a><span id="l17.639">       nsCOMPtr&lt;nsISupports&gt; elem;</span>
<a href="#l17.640"></a><span id="l17.640">       ispDirectories-&gt;GetNext(getter_AddRefs(elem));</span>
<a href="#l17.641"></a><span id="l17.641">       file = do_QueryInterface(elem);</span>
<a href="#l17.642"></a><span id="l17.642"> </span>
<a href="#l17.643"></a><span id="l17.643" class="difflineminus">-      if (file)</span>
<a href="#l17.644"></a><span id="l17.644" class="difflineminus">-      {</span>
<a href="#l17.645"></a><span id="l17.645" class="difflineminus">-        // append our desired leaf name then test to see if the file exists. If it does, we've found</span>
<a href="#l17.646"></a><span id="l17.646" class="difflineminus">-        // mServerFilterFile.</span>
<a href="#l17.647"></a><span id="l17.647" class="difflineplus">+      if (file) {</span>
<a href="#l17.648"></a><span id="l17.648" class="difflineplus">+        // append our desired leaf name then test to see if the file exists. If</span>
<a href="#l17.649"></a><span id="l17.649" class="difflineplus">+        // it does, we've found mServerFilterFile.</span>
<a href="#l17.650"></a><span id="l17.650">         file-&gt;AppendNative(serverFilterFileName);</span>
<a href="#l17.651"></a><span id="l17.651">         bool exists;</span>
<a href="#l17.652"></a><span id="l17.652" class="difflineminus">-        if (NS_SUCCEEDED(file-&gt;Exists(&amp;exists)) &amp;&amp; exists)</span>
<a href="#l17.653"></a><span id="l17.653" class="difflineminus">-        {</span>
<a href="#l17.654"></a><span id="l17.654" class="difflineplus">+        if (NS_SUCCEEDED(file-&gt;Exists(&amp;exists)) &amp;&amp; exists) {</span>
<a href="#l17.655"></a><span id="l17.655">           file.swap(mServerFilterFile);</span>
<a href="#l17.656"></a><span id="l17.656">           break;</span>
<a href="#l17.657"></a><span id="l17.657">         }</span>
<a href="#l17.658"></a><span id="l17.658" class="difflineminus">-      } // if file</span>
<a href="#l17.659"></a><span id="l17.659" class="difflineminus">-    } // until we find the location of mServerFilterName</span>
<a href="#l17.660"></a><span id="l17.660" class="difflineminus">-  } // if we haven't already stored mServerFilterFile</span>
<a href="#l17.661"></a><span id="l17.661" class="difflineplus">+      }  // if file</span>
<a href="#l17.662"></a><span id="l17.662" class="difflineplus">+    }    // until we find the location of mServerFilterName</span>
<a href="#l17.663"></a><span id="l17.663" class="difflineplus">+  }      // if we haven't already stored mServerFilterFile</span>
<a href="#l17.664"></a><span id="l17.664"> </span>
<a href="#l17.665"></a><span id="l17.665">   NS_IF_ADDREF(*aFile = mServerFilterFile);</span>
<a href="#l17.666"></a><span id="l17.666">   return NS_OK;</span>
<a href="#l17.667"></a><span id="l17.667"> }</span>
<a href="#l17.668"></a><span id="l17.668"> </span>
<a href="#l17.669"></a><span id="l17.669" class="difflineminus">-</span>
<a href="#l17.670"></a><span id="l17.670" class="difflineminus">-NS_IMPL_GETSET(nsSpamSettings, ServerFilterTrustFlags, int32_t, mServerFilterTrustFlags)</span>
<a href="#l17.671"></a><span id="l17.671" class="difflineplus">+NS_IMPL_GETSET(nsSpamSettings, ServerFilterTrustFlags, int32_t,</span>
<a href="#l17.672"></a><span id="l17.672" class="difflineplus">+               mServerFilterTrustFlags)</span>
<a href="#l17.673"></a><span id="l17.673"> </span>
<a href="#l17.674"></a><span id="l17.674"> #define LOG_ENTRY_START_TAG &quot;&lt;p&gt;\n&quot;</span>
<a href="#l17.675"></a><span id="l17.675"> #define LOG_ENTRY_START_TAG_LEN (strlen(LOG_ENTRY_START_TAG))</span>
<a href="#l17.676"></a><span id="l17.676"> #define LOG_ENTRY_END_TAG &quot;&lt;/p&gt;\n&quot;</span>
<a href="#l17.677"></a><span id="l17.677"> #define LOG_ENTRY_END_TAG_LEN (strlen(LOG_ENTRY_END_TAG))</span>
<a href="#l17.678"></a><span id="l17.678"> // Does this need to be localizable?</span>
<a href="#l17.679"></a><span id="l17.679"> #define LOG_ENTRY_TIMESTAMP &quot;[$S] &quot;</span>
<a href="#l17.680"></a><span id="l17.680"> </span>
<a href="#l17.681"></a><span id="l17.681" class="difflineminus">-NS_IMETHODIMP nsSpamSettings::LogJunkHit(nsIMsgDBHdr *aMsgHdr, bool aMoveMessage)</span>
<a href="#l17.682"></a><span id="l17.682" class="difflineminus">-{</span>
<a href="#l17.683"></a><span id="l17.683" class="difflineplus">+NS_IMETHODIMP nsSpamSettings::LogJunkHit(nsIMsgDBHdr *aMsgHdr,</span>
<a href="#l17.684"></a><span id="l17.684" class="difflineplus">+                                         bool aMoveMessage) {</span>
<a href="#l17.685"></a><span id="l17.685">   bool loggingEnabled;</span>
<a href="#l17.686"></a><span id="l17.686">   nsresult rv = GetLoggingEnabled(&amp;loggingEnabled);</span>
<a href="#l17.687"></a><span id="l17.687" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l17.688"></a><span id="l17.688" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.689"></a><span id="l17.689"> </span>
<a href="#l17.690"></a><span id="l17.690" class="difflineminus">-  if (!loggingEnabled)</span>
<a href="#l17.691"></a><span id="l17.691" class="difflineminus">-    return NS_OK;</span>
<a href="#l17.692"></a><span id="l17.692" class="difflineplus">+  if (!loggingEnabled) return NS_OK;</span>
<a href="#l17.693"></a><span id="l17.693"> </span>
<a href="#l17.694"></a><span id="l17.694">   PRTime date;</span>
<a href="#l17.695"></a><span id="l17.695"> </span>
<a href="#l17.696"></a><span id="l17.696">   nsString authorValue;</span>
<a href="#l17.697"></a><span id="l17.697">   nsString subjectValue;</span>
<a href="#l17.698"></a><span id="l17.698">   nsString dateValue;</span>
<a href="#l17.699"></a><span id="l17.699"> </span>
<a href="#l17.700"></a><span id="l17.700">   (void)aMsgHdr-&gt;GetDate(&amp;date);</span>
<a href="#l17.701"></a><span id="l17.701">   PRExplodedTime exploded;</span>
<a href="#l17.702"></a><span id="l17.702">   PR_ExplodeTime(date, PR_LocalTimeParameters, &amp;exploded);</span>
<a href="#l17.703"></a><span id="l17.703"> </span>
<a href="#l17.704"></a><span id="l17.704">   mozilla::DateTimeFormat::FormatPRExplodedTime(mozilla::kDateFormatShort,</span>
<a href="#l17.705"></a><span id="l17.705">                                                 mozilla::kTimeFormatSeconds,</span>
<a href="#l17.706"></a><span id="l17.706" class="difflineminus">-                                                &amp;exploded,</span>
<a href="#l17.707"></a><span id="l17.707" class="difflineminus">-                                                dateValue);</span>
<a href="#l17.708"></a><span id="l17.708" class="difflineplus">+                                                &amp;exploded, dateValue);</span>
<a href="#l17.709"></a><span id="l17.709"> </span>
<a href="#l17.710"></a><span id="l17.710">   (void)aMsgHdr-&gt;GetMime2DecodedAuthor(authorValue);</span>
<a href="#l17.711"></a><span id="l17.711">   (void)aMsgHdr-&gt;GetMime2DecodedSubject(subjectValue);</span>
<a href="#l17.712"></a><span id="l17.712"> </span>
<a href="#l17.713"></a><span id="l17.713">   nsCString buffer;</span>
<a href="#l17.714"></a><span id="l17.714">   // this is big enough to hold a log entry.</span>
<a href="#l17.715"></a><span id="l17.715">   // do this so we avoid growing and copying as we append to the log.</span>
<a href="#l17.716"></a><span id="l17.716">   buffer.SetCapacity(512);</span>
<a href="#l17.717"></a><span id="l17.717"> </span>
<a href="#l17.718"></a><span id="l17.718">   nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l17.719"></a><span id="l17.719" class="difflineminus">-    mozilla::services::GetStringBundleService();</span>
<a href="#l17.720"></a><span id="l17.720" class="difflineplus">+      mozilla::services::GetStringBundleService();</span>
<a href="#l17.721"></a><span id="l17.721">   NS_ENSURE_TRUE(bundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l17.722"></a><span id="l17.722"> </span>
<a href="#l17.723"></a><span id="l17.723">   nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l17.724"></a><span id="l17.724" class="difflineminus">-  rv = bundleService-&gt;CreateBundle(&quot;chrome://messenger/locale/filter.properties&quot;,</span>
<a href="#l17.725"></a><span id="l17.725" class="difflineminus">-    getter_AddRefs(bundle));</span>
<a href="#l17.726"></a><span id="l17.726" class="difflineplus">+  rv = bundleService-&gt;CreateBundle(</span>
<a href="#l17.727"></a><span id="l17.727" class="difflineplus">+      &quot;chrome://messenger/locale/filter.properties&quot;, getter_AddRefs(bundle));</span>
<a href="#l17.728"></a><span id="l17.728">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.729"></a><span id="l17.729"> </span>
<a href="#l17.730"></a><span id="l17.730" class="difflineminus">-  const char16_t *junkLogDetectFormatStrings[3] = { authorValue.get(), subjectValue.get(), dateValue.get() };</span>
<a href="#l17.731"></a><span id="l17.731" class="difflineplus">+  const char16_t *junkLogDetectFormatStrings[3] = {</span>
<a href="#l17.732"></a><span id="l17.732" class="difflineplus">+      authorValue.get(), subjectValue.get(), dateValue.get()};</span>
<a href="#l17.733"></a><span id="l17.733">   nsString junkLogDetectStr;</span>
<a href="#l17.734"></a><span id="l17.734">   rv = bundle-&gt;FormatStringFromName(</span>
<a href="#l17.735"></a><span id="l17.735" class="difflineminus">-    &quot;junkLogDetectStr&quot;,</span>
<a href="#l17.736"></a><span id="l17.736" class="difflineminus">-    junkLogDetectFormatStrings, 3,</span>
<a href="#l17.737"></a><span id="l17.737" class="difflineminus">-    junkLogDetectStr);</span>
<a href="#l17.738"></a><span id="l17.738" class="difflineplus">+      &quot;junkLogDetectStr&quot;, junkLogDetectFormatStrings, 3, junkLogDetectStr);</span>
<a href="#l17.739"></a><span id="l17.739">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.740"></a><span id="l17.740"> </span>
<a href="#l17.741"></a><span id="l17.741">   buffer += NS_ConvertUTF16toUTF8(junkLogDetectStr);</span>
<a href="#l17.742"></a><span id="l17.742" class="difflineminus">-  buffer +=  &quot;\n&quot;;</span>
<a href="#l17.743"></a><span id="l17.743" class="difflineplus">+  buffer += &quot;\n&quot;;</span>
<a href="#l17.744"></a><span id="l17.744"> </span>
<a href="#l17.745"></a><span id="l17.745">   if (aMoveMessage) {</span>
<a href="#l17.746"></a><span id="l17.746">     nsCString msgId;</span>
<a href="#l17.747"></a><span id="l17.747">     aMsgHdr-&gt;GetMessageId(getter_Copies(msgId));</span>
<a href="#l17.748"></a><span id="l17.748"> </span>
<a href="#l17.749"></a><span id="l17.749">     nsCString junkFolderURI;</span>
<a href="#l17.750"></a><span id="l17.750">     rv = GetSpamFolderURI(getter_Copies(junkFolderURI));</span>
<a href="#l17.751"></a><span id="l17.751">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.752"></a><span id="l17.752"> </span>
<a href="#l17.753"></a><span id="l17.753">     NS_ConvertASCIItoUTF16 msgIdValue(msgId);</span>
<a href="#l17.754"></a><span id="l17.754">     NS_ConvertASCIItoUTF16 junkFolderURIValue(junkFolderURI);</span>
<a href="#l17.755"></a><span id="l17.755"> </span>
<a href="#l17.756"></a><span id="l17.756" class="difflineminus">-    const char16_t *logMoveFormatStrings[2] = { msgIdValue.get(), junkFolderURIValue.get() };</span>
<a href="#l17.757"></a><span id="l17.757" class="difflineplus">+    const char16_t *logMoveFormatStrings[2] = {msgIdValue.get(),</span>
<a href="#l17.758"></a><span id="l17.758" class="difflineplus">+                                               junkFolderURIValue.get()};</span>
<a href="#l17.759"></a><span id="l17.759">     nsString logMoveStr;</span>
<a href="#l17.760"></a><span id="l17.760" class="difflineminus">-    rv = bundle-&gt;FormatStringFromName(</span>
<a href="#l17.761"></a><span id="l17.761" class="difflineminus">-      &quot;logMoveStr&quot;,</span>
<a href="#l17.762"></a><span id="l17.762" class="difflineminus">-      logMoveFormatStrings, 2,</span>
<a href="#l17.763"></a><span id="l17.763" class="difflineminus">-      logMoveStr);</span>
<a href="#l17.764"></a><span id="l17.764" class="difflineplus">+    rv = bundle-&gt;FormatStringFromName(&quot;logMoveStr&quot;, logMoveFormatStrings, 2,</span>
<a href="#l17.765"></a><span id="l17.765" class="difflineplus">+                                      logMoveStr);</span>
<a href="#l17.766"></a><span id="l17.766">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.767"></a><span id="l17.767"> </span>
<a href="#l17.768"></a><span id="l17.768">     buffer += NS_ConvertUTF16toUTF8(logMoveStr);</span>
<a href="#l17.769"></a><span id="l17.769">     buffer += &quot;\n&quot;;</span>
<a href="#l17.770"></a><span id="l17.770">   }</span>
<a href="#l17.771"></a><span id="l17.771"> </span>
<a href="#l17.772"></a><span id="l17.772">   return LogJunkString(buffer.get());</span>
<a href="#l17.773"></a><span id="l17.773"> }</span>
<a href="#l17.774"></a><span id="l17.774"> </span>
<a href="#l17.775"></a><span id="l17.775" class="difflineminus">-NS_IMETHODIMP nsSpamSettings::LogJunkString(const char *string)</span>
<a href="#l17.776"></a><span id="l17.776" class="difflineminus">-{</span>
<a href="#l17.777"></a><span id="l17.777" class="difflineplus">+NS_IMETHODIMP nsSpamSettings::LogJunkString(const char *string) {</span>
<a href="#l17.778"></a><span id="l17.778">   bool loggingEnabled;</span>
<a href="#l17.779"></a><span id="l17.779">   nsresult rv = GetLoggingEnabled(&amp;loggingEnabled);</span>
<a href="#l17.780"></a><span id="l17.780" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l17.781"></a><span id="l17.781" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.782"></a><span id="l17.782"> </span>
<a href="#l17.783"></a><span id="l17.783" class="difflineminus">-  if (!loggingEnabled)</span>
<a href="#l17.784"></a><span id="l17.784" class="difflineminus">-    return NS_OK;</span>
<a href="#l17.785"></a><span id="l17.785" class="difflineplus">+  if (!loggingEnabled) return NS_OK;</span>
<a href="#l17.786"></a><span id="l17.786"> </span>
<a href="#l17.787"></a><span id="l17.787">   nsString dateValue;</span>
<a href="#l17.788"></a><span id="l17.788">   PRExplodedTime exploded;</span>
<a href="#l17.789"></a><span id="l17.789">   PR_ExplodeTime(PR_Now(), PR_LocalTimeParameters, &amp;exploded);</span>
<a href="#l17.790"></a><span id="l17.790"> </span>
<a href="#l17.791"></a><span id="l17.791">   mozilla::DateTimeFormat::FormatPRExplodedTime(mozilla::kDateFormatShort,</span>
<a href="#l17.792"></a><span id="l17.792">                                                 mozilla::kTimeFormatSeconds,</span>
<a href="#l17.793"></a><span id="l17.793" class="difflineminus">-                                                &amp;exploded,</span>
<a href="#l17.794"></a><span id="l17.794" class="difflineminus">-                                                dateValue);</span>
<a href="#l17.795"></a><span id="l17.795" class="difflineplus">+                                                &amp;exploded, dateValue);</span>
<a href="#l17.796"></a><span id="l17.796"> </span>
<a href="#l17.797"></a><span id="l17.797">   nsCString timestampString(LOG_ENTRY_TIMESTAMP);</span>
<a href="#l17.798"></a><span id="l17.798" class="difflineminus">-  MsgReplaceSubstring(timestampString, &quot;$S&quot;, NS_ConvertUTF16toUTF8(dateValue).get());</span>
<a href="#l17.799"></a><span id="l17.799" class="difflineplus">+  MsgReplaceSubstring(timestampString, &quot;$S&quot;,</span>
<a href="#l17.800"></a><span id="l17.800" class="difflineplus">+                      NS_ConvertUTF16toUTF8(dateValue).get());</span>
<a href="#l17.801"></a><span id="l17.801"> </span>
<a href="#l17.802"></a><span id="l17.802" class="difflineminus">-  nsCOMPtr &lt;nsIOutputStream&gt; logStream;</span>
<a href="#l17.803"></a><span id="l17.803" class="difflineplus">+  nsCOMPtr&lt;nsIOutputStream&gt; logStream;</span>
<a href="#l17.804"></a><span id="l17.804">   rv = GetLogStream(getter_AddRefs(logStream));</span>
<a href="#l17.805"></a><span id="l17.805" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l17.806"></a><span id="l17.806" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.807"></a><span id="l17.807"> </span>
<a href="#l17.808"></a><span id="l17.808">   uint32_t writeCount;</span>
<a href="#l17.809"></a><span id="l17.809"> </span>
<a href="#l17.810"></a><span id="l17.810" class="difflineminus">-  rv = logStream-&gt;Write(LOG_ENTRY_START_TAG, LOG_ENTRY_START_TAG_LEN, &amp;writeCount);</span>
<a href="#l17.811"></a><span id="l17.811" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l17.812"></a><span id="l17.812" class="difflineminus">-  NS_ASSERTION(writeCount == LOG_ENTRY_START_TAG_LEN, &quot;failed to write out start log tag&quot;);</span>
<a href="#l17.813"></a><span id="l17.813" class="difflineplus">+  rv = logStream-&gt;Write(LOG_ENTRY_START_TAG, LOG_ENTRY_START_TAG_LEN,</span>
<a href="#l17.814"></a><span id="l17.814" class="difflineplus">+                        &amp;writeCount);</span>
<a href="#l17.815"></a><span id="l17.815" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.816"></a><span id="l17.816" class="difflineplus">+  NS_ASSERTION(writeCount == LOG_ENTRY_START_TAG_LEN,</span>
<a href="#l17.817"></a><span id="l17.817" class="difflineplus">+               &quot;failed to write out start log tag&quot;);</span>
<a href="#l17.818"></a><span id="l17.818"> </span>
<a href="#l17.819"></a><span id="l17.819" class="difflineminus">-  rv = logStream-&gt;Write(timestampString.get(), timestampString.Length(), &amp;writeCount);</span>
<a href="#l17.820"></a><span id="l17.820" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l17.821"></a><span id="l17.821" class="difflineminus">-  NS_ASSERTION(writeCount == timestampString.Length(), &quot;failed to write out timestamp&quot;);</span>
<a href="#l17.822"></a><span id="l17.822" class="difflineplus">+  rv = logStream-&gt;Write(timestampString.get(), timestampString.Length(),</span>
<a href="#l17.823"></a><span id="l17.823" class="difflineplus">+                        &amp;writeCount);</span>
<a href="#l17.824"></a><span id="l17.824" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.825"></a><span id="l17.825" class="difflineplus">+  NS_ASSERTION(writeCount == timestampString.Length(),</span>
<a href="#l17.826"></a><span id="l17.826" class="difflineplus">+               &quot;failed to write out timestamp&quot;);</span>
<a href="#l17.827"></a><span id="l17.827"> </span>
<a href="#l17.828"></a><span id="l17.828">   // HTML-escape the log for security reasons.</span>
<a href="#l17.829"></a><span id="l17.829">   // We don't want someone to send us a message with a subject with</span>
<a href="#l17.830"></a><span id="l17.830">   // HTML tags, especially &lt;script&gt;.</span>
<a href="#l17.831"></a><span id="l17.831">   nsCString escapedBuffer;</span>
<a href="#l17.832"></a><span id="l17.832">   nsAppendEscapedHTML(nsDependentCString(string), escapedBuffer);</span>
<a href="#l17.833"></a><span id="l17.833"> </span>
<a href="#l17.834"></a><span id="l17.834">   uint32_t escapedBufferLen = escapedBuffer.Length();</span>
<a href="#l17.835"></a><span id="l17.835">   rv = logStream-&gt;Write(escapedBuffer.get(), escapedBufferLen, &amp;writeCount);</span>
<a href="#l17.836"></a><span id="l17.836" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l17.837"></a><span id="l17.837" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.838"></a><span id="l17.838">   NS_ASSERTION(writeCount == escapedBufferLen, &quot;failed to write out log hit&quot;);</span>
<a href="#l17.839"></a><span id="l17.839"> </span>
<a href="#l17.840"></a><span id="l17.840">   rv = logStream-&gt;Write(LOG_ENTRY_END_TAG, LOG_ENTRY_END_TAG_LEN, &amp;writeCount);</span>
<a href="#l17.841"></a><span id="l17.841" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l17.842"></a><span id="l17.842" class="difflineminus">-  NS_ASSERTION(writeCount == LOG_ENTRY_END_TAG_LEN, &quot;failed to write out end log tag&quot;);</span>
<a href="#l17.843"></a><span id="l17.843" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.844"></a><span id="l17.844" class="difflineplus">+  NS_ASSERTION(writeCount == LOG_ENTRY_END_TAG_LEN,</span>
<a href="#l17.845"></a><span id="l17.845" class="difflineplus">+               &quot;failed to write out end log tag&quot;);</span>
<a href="#l17.846"></a><span id="l17.846">   return NS_OK;</span>
<a href="#l17.847"></a><span id="l17.847"> }</span>
<a href="#l17.848"></a><span id="l17.848"> </span>
<a href="#l17.849"></a><span id="l17.849" class="difflineminus">-NS_IMETHODIMP nsSpamSettings::OnStartRunningUrl(nsIURI* aURL)</span>
<a href="#l17.850"></a><span id="l17.850" class="difflineminus">-{</span>
<a href="#l17.851"></a><span id="l17.851" class="difflineplus">+NS_IMETHODIMP nsSpamSettings::OnStartRunningUrl(nsIURI *aURL) {</span>
<a href="#l17.852"></a><span id="l17.852">   // do nothing</span>
<a href="#l17.853"></a><span id="l17.853">   // all the action happens in OnStopRunningUrl()</span>
<a href="#l17.854"></a><span id="l17.854">   return NS_OK;</span>
<a href="#l17.855"></a><span id="l17.855"> }</span>
<a href="#l17.856"></a><span id="l17.856"> </span>
<a href="#l17.857"></a><span id="l17.857" class="difflineminus">-NS_IMETHODIMP nsSpamSettings::OnStopRunningUrl(nsIURI* aURL, nsresult exitCode)</span>
<a href="#l17.858"></a><span id="l17.858" class="difflineminus">-{</span>
<a href="#l17.859"></a><span id="l17.859" class="difflineplus">+NS_IMETHODIMP nsSpamSettings::OnStopRunningUrl(nsIURI *aURL,</span>
<a href="#l17.860"></a><span id="l17.860" class="difflineplus">+                                               nsresult exitCode) {</span>
<a href="#l17.861"></a><span id="l17.861">   nsCString junkFolderURI;</span>
<a href="#l17.862"></a><span id="l17.862">   nsresult rv = GetSpamFolderURI(getter_Copies(junkFolderURI));</span>
<a href="#l17.863"></a><span id="l17.863" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l17.864"></a><span id="l17.864" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.865"></a><span id="l17.865"> </span>
<a href="#l17.866"></a><span id="l17.866" class="difflineminus">-  if (junkFolderURI.IsEmpty())</span>
<a href="#l17.867"></a><span id="l17.867" class="difflineminus">-    return NS_ERROR_UNEXPECTED;</span>
<a href="#l17.868"></a><span id="l17.868" class="difflineplus">+  if (junkFolderURI.IsEmpty()) return NS_ERROR_UNEXPECTED;</span>
<a href="#l17.869"></a><span id="l17.869"> </span>
<a href="#l17.870"></a><span id="l17.870">   // when we get here, the folder should exist.</span>
<a href="#l17.871"></a><span id="l17.871" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFolder&gt; junkFolder;</span>
<a href="#l17.872"></a><span id="l17.872" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; junkFolder;</span>
<a href="#l17.873"></a><span id="l17.873">   rv = GetExistingFolder(junkFolderURI, getter_AddRefs(junkFolder));</span>
<a href="#l17.874"></a><span id="l17.874" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l17.875"></a><span id="l17.875" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.876"></a><span id="l17.876"> </span>
<a href="#l17.877"></a><span id="l17.877">   rv = junkFolder-&gt;SetFlag(nsMsgFolderFlags::Junk);</span>
<a href="#l17.878"></a><span id="l17.878" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l17.879"></a><span id="l17.879" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.880"></a><span id="l17.880">   return rv;</span>
<a href="#l17.881"></a><span id="l17.881"> }</span>
<a href="#l17.882"></a><span id="l17.882"> </span>
<a href="#l17.883"></a><span id="l17.883" class="difflineminus">-NS_IMETHODIMP nsSpamSettings::CheckWhiteList(nsIMsgDBHdr *aMsgHdr, bool *aResult)</span>
<a href="#l17.884"></a><span id="l17.884" class="difflineminus">-{</span>
<a href="#l17.885"></a><span id="l17.885" class="difflineplus">+NS_IMETHODIMP nsSpamSettings::CheckWhiteList(nsIMsgDBHdr *aMsgHdr,</span>
<a href="#l17.886"></a><span id="l17.886" class="difflineplus">+                                             bool *aResult) {</span>
<a href="#l17.887"></a><span id="l17.887">   NS_ENSURE_ARG_POINTER(aMsgHdr);</span>
<a href="#l17.888"></a><span id="l17.888">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l17.889"></a><span id="l17.889">   *aResult = false;  // default in case of error or no whitelisting</span>
<a href="#l17.890"></a><span id="l17.890"> </span>
<a href="#l17.891"></a><span id="l17.891" class="difflineminus">-  if (!mUseWhiteList || (!mWhiteListDirArray.Count() &amp;&amp;</span>
<a href="#l17.892"></a><span id="l17.892" class="difflineminus">-                          mTrustedMailDomains.IsEmpty()))</span>
<a href="#l17.893"></a><span id="l17.893" class="difflineplus">+  if (!mUseWhiteList ||</span>
<a href="#l17.894"></a><span id="l17.894" class="difflineplus">+      (!mWhiteListDirArray.Count() &amp;&amp; mTrustedMailDomains.IsEmpty()))</span>
<a href="#l17.895"></a><span id="l17.895">     return NS_OK;</span>
<a href="#l17.896"></a><span id="l17.896"> </span>
<a href="#l17.897"></a><span id="l17.897">   // do per-message processing</span>
<a href="#l17.898"></a><span id="l17.898"> </span>
<a href="#l17.899"></a><span id="l17.899">   nsCString author;</span>
<a href="#l17.900"></a><span id="l17.900">   aMsgHdr-&gt;GetAuthor(getter_Copies(author));</span>
<a href="#l17.901"></a><span id="l17.901"> </span>
<a href="#l17.902"></a><span id="l17.902">   nsAutoCString authorEmailAddress;</span>
<a href="#l17.903"></a><span id="l17.903">   ExtractEmail(EncodedHeader(author), authorEmailAddress);</span>
<a href="#l17.904"></a><span id="l17.904"> </span>
<a href="#l17.905"></a><span id="l17.905" class="difflineminus">-  if (authorEmailAddress.IsEmpty())</span>
<a href="#l17.906"></a><span id="l17.906" class="difflineminus">-    return NS_OK;</span>
<a href="#l17.907"></a><span id="l17.907" class="difflineplus">+  if (authorEmailAddress.IsEmpty()) return NS_OK;</span>
<a href="#l17.908"></a><span id="l17.908"> </span>
<a href="#l17.909"></a><span id="l17.909">   // should we skip whitelisting for the identity email?</span>
<a href="#l17.910"></a><span id="l17.910" class="difflineminus">-  if (mInhibitWhiteListingIdentityUser)</span>
<a href="#l17.911"></a><span id="l17.911" class="difflineminus">-  {</span>
<a href="#l17.912"></a><span id="l17.912" class="difflineminus">-    for (uint32_t i = 0; i &lt; mEmails.Length(); ++i)</span>
<a href="#l17.913"></a><span id="l17.913" class="difflineminus">-    {</span>
<a href="#l17.914"></a><span id="l17.914" class="difflineminus">-      if (mEmails[i].Equals(authorEmailAddress, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l17.915"></a><span id="l17.915" class="difflineplus">+  if (mInhibitWhiteListingIdentityUser) {</span>
<a href="#l17.916"></a><span id="l17.916" class="difflineplus">+    for (uint32_t i = 0; i &lt; mEmails.Length(); ++i) {</span>
<a href="#l17.917"></a><span id="l17.917" class="difflineplus">+      if (mEmails[i].Equals(authorEmailAddress,</span>
<a href="#l17.918"></a><span id="l17.918" class="difflineplus">+                            nsCaseInsensitiveCStringComparator()))</span>
<a href="#l17.919"></a><span id="l17.919">         return NS_OK;</span>
<a href="#l17.920"></a><span id="l17.920">     }</span>
<a href="#l17.921"></a><span id="l17.921">   }</span>
<a href="#l17.922"></a><span id="l17.922"> </span>
<a href="#l17.923"></a><span id="l17.923" class="difflineminus">-  if (!mTrustedMailDomains.IsEmpty() || mInhibitWhiteListingIdentityDomain)</span>
<a href="#l17.924"></a><span id="l17.924" class="difflineminus">-  {</span>
<a href="#l17.925"></a><span id="l17.925" class="difflineplus">+  if (!mTrustedMailDomains.IsEmpty() || mInhibitWhiteListingIdentityDomain) {</span>
<a href="#l17.926"></a><span id="l17.926">     nsAutoCString domain;</span>
<a href="#l17.927"></a><span id="l17.927">     int32_t atPos = authorEmailAddress.FindChar('@');</span>
<a href="#l17.928"></a><span id="l17.928" class="difflineminus">-    if (atPos &gt;= 0)</span>
<a href="#l17.929"></a><span id="l17.929" class="difflineminus">-      domain = Substring(authorEmailAddress, atPos + 1);</span>
<a href="#l17.930"></a><span id="l17.930" class="difflineminus">-    if (!domain.IsEmpty())</span>
<a href="#l17.931"></a><span id="l17.931" class="difflineminus">-    {</span>
<a href="#l17.932"></a><span id="l17.932" class="difflineplus">+    if (atPos &gt;= 0) domain = Substring(authorEmailAddress, atPos + 1);</span>
<a href="#l17.933"></a><span id="l17.933" class="difflineplus">+    if (!domain.IsEmpty()) {</span>
<a href="#l17.934"></a><span id="l17.934">       if (!mTrustedMailDomains.IsEmpty() &amp;&amp;</span>
<a href="#l17.935"></a><span id="l17.935" class="difflineminus">-          MsgHostDomainIsTrusted(domain, mTrustedMailDomains))</span>
<a href="#l17.936"></a><span id="l17.936" class="difflineminus">-      {</span>
<a href="#l17.937"></a><span id="l17.937" class="difflineplus">+          MsgHostDomainIsTrusted(domain, mTrustedMailDomains)) {</span>
<a href="#l17.938"></a><span id="l17.938">         *aResult = true;</span>
<a href="#l17.939"></a><span id="l17.939">         return NS_OK;</span>
<a href="#l17.940"></a><span id="l17.940">       }</span>
<a href="#l17.941"></a><span id="l17.941"> </span>
<a href="#l17.942"></a><span id="l17.942" class="difflineminus">-      if (mInhibitWhiteListingIdentityDomain)</span>
<a href="#l17.943"></a><span id="l17.943" class="difflineminus">-      {</span>
<a href="#l17.944"></a><span id="l17.944" class="difflineminus">-        for (uint32_t i = 0; i &lt; mEmails.Length(); ++i)</span>
<a href="#l17.945"></a><span id="l17.945" class="difflineminus">-        {</span>
<a href="#l17.946"></a><span id="l17.946" class="difflineplus">+      if (mInhibitWhiteListingIdentityDomain) {</span>
<a href="#l17.947"></a><span id="l17.947" class="difflineplus">+        for (uint32_t i = 0; i &lt; mEmails.Length(); ++i) {</span>
<a href="#l17.948"></a><span id="l17.948">           nsAutoCString identityDomain;</span>
<a href="#l17.949"></a><span id="l17.949">           int32_t atPos = mEmails[i].FindChar('@');</span>
<a href="#l17.950"></a><span id="l17.950" class="difflineminus">-          if (atPos &gt;= 0)</span>
<a href="#l17.951"></a><span id="l17.951" class="difflineminus">-          {</span>
<a href="#l17.952"></a><span id="l17.952" class="difflineplus">+          if (atPos &gt;= 0) {</span>
<a href="#l17.953"></a><span id="l17.953">             identityDomain = Substring(mEmails[i], atPos + 1);</span>
<a href="#l17.954"></a><span id="l17.954" class="difflineminus">-            if (identityDomain.Equals(domain, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l17.955"></a><span id="l17.955" class="difflineminus">-              return NS_OK; // don't whitelist</span>
<a href="#l17.956"></a><span id="l17.956" class="difflineplus">+            if (identityDomain.Equals(domain,</span>
<a href="#l17.957"></a><span id="l17.957" class="difflineplus">+                                      nsCaseInsensitiveCStringComparator()))</span>
<a href="#l17.958"></a><span id="l17.958" class="difflineplus">+              return NS_OK;  // don't whitelist</span>
<a href="#l17.959"></a><span id="l17.959">           }</span>
<a href="#l17.960"></a><span id="l17.960">         }</span>
<a href="#l17.961"></a><span id="l17.961">       }</span>
<a href="#l17.962"></a><span id="l17.962">     }</span>
<a href="#l17.963"></a><span id="l17.963">   }</span>
<a href="#l17.964"></a><span id="l17.964"> </span>
<a href="#l17.965"></a><span id="l17.965" class="difflineminus">-  if (mWhiteListDirArray.Count())</span>
<a href="#l17.966"></a><span id="l17.966" class="difflineminus">-  {</span>
<a href="#l17.967"></a><span id="l17.967" class="difflineplus">+  if (mWhiteListDirArray.Count()) {</span>
<a href="#l17.968"></a><span id="l17.968">     nsCOMPtr&lt;nsIAbCard&gt; cardForAddress;</span>
<a href="#l17.969"></a><span id="l17.969">     for (int32_t index = 0;</span>
<a href="#l17.970"></a><span id="l17.970" class="difflineminus">-         index &lt; mWhiteListDirArray.Count() &amp;&amp; !cardForAddress;</span>
<a href="#l17.971"></a><span id="l17.971" class="difflineminus">-         index++)</span>
<a href="#l17.972"></a><span id="l17.972" class="difflineminus">-    {</span>
<a href="#l17.973"></a><span id="l17.973" class="difflineminus">-      mWhiteListDirArray[index]-&gt;CardForEmailAddress(authorEmailAddress,</span>
<a href="#l17.974"></a><span id="l17.974" class="difflineminus">-                                                     getter_AddRefs(cardForAddress));</span>
<a href="#l17.975"></a><span id="l17.975" class="difflineplus">+         index &lt; mWhiteListDirArray.Count() &amp;&amp; !cardForAddress; index++) {</span>
<a href="#l17.976"></a><span id="l17.976" class="difflineplus">+      mWhiteListDirArray[index]-&gt;CardForEmailAddress(</span>
<a href="#l17.977"></a><span id="l17.977" class="difflineplus">+          authorEmailAddress, getter_AddRefs(cardForAddress));</span>
<a href="#l17.978"></a><span id="l17.978">     }</span>
<a href="#l17.979"></a><span id="l17.979" class="difflineminus">-    if (cardForAddress)</span>
<a href="#l17.980"></a><span id="l17.980" class="difflineminus">-    {</span>
<a href="#l17.981"></a><span id="l17.981" class="difflineplus">+    if (cardForAddress) {</span>
<a href="#l17.982"></a><span id="l17.982">       *aResult = true;</span>
<a href="#l17.983"></a><span id="l17.983">       return NS_OK;</span>
<a href="#l17.984"></a><span id="l17.984">     }</span>
<a href="#l17.985"></a><span id="l17.985">   }</span>
<a href="#l17.986"></a><span id="l17.986" class="difflineminus">-  return NS_OK; // default return is false</span>
<a href="#l17.987"></a><span id="l17.987" class="difflineplus">+  return NS_OK;  // default return is false</span>
<a href="#l17.988"></a><span id="l17.988"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/base/src/nsSpamSettings.h</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/base/src/nsSpamSettings.h</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -12,58 +12,58 @@</span>
<a href="#l18.4"></a><span id="l18.4"> #include &quot;nsIOutputStream.h&quot;</span>
<a href="#l18.5"></a><span id="l18.5"> #include &quot;nsIMsgIncomingServer.h&quot;</span>
<a href="#l18.6"></a><span id="l18.6"> #include &quot;nsIUrlListener.h&quot;</span>
<a href="#l18.7"></a><span id="l18.7"> #include &quot;DateTimeFormat.h&quot;</span>
<a href="#l18.8"></a><span id="l18.8"> #include &quot;nsCOMArray.h&quot;</span>
<a href="#l18.9"></a><span id="l18.9"> #include &quot;nsIAbDirectory.h&quot;</span>
<a href="#l18.10"></a><span id="l18.10"> #include &quot;nsTArray.h&quot;</span>
<a href="#l18.11"></a><span id="l18.11"> </span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-class nsSpamSettings : public nsISpamSettings, public nsIUrlListener</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineminus">-{</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineminus">-public:</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineplus">+class nsSpamSettings : public nsISpamSettings, public nsIUrlListener {</span>
<a href="#l18.16"></a><span id="l18.16" class="difflineplus">+ public:</span>
<a href="#l18.17"></a><span id="l18.17">   nsSpamSettings();</span>
<a href="#l18.18"></a><span id="l18.18"> </span>
<a href="#l18.19"></a><span id="l18.19">   NS_DECL_ISUPPORTS</span>
<a href="#l18.20"></a><span id="l18.20">   NS_DECL_NSISPAMSETTINGS</span>
<a href="#l18.21"></a><span id="l18.21">   NS_DECL_NSIURLLISTENER</span>
<a href="#l18.22"></a><span id="l18.22"> </span>
<a href="#l18.23"></a><span id="l18.23" class="difflineminus">-private:</span>
<a href="#l18.24"></a><span id="l18.24" class="difflineplus">+ private:</span>
<a href="#l18.25"></a><span id="l18.25">   virtual ~nsSpamSettings();</span>
<a href="#l18.26"></a><span id="l18.26"> </span>
<a href="#l18.27"></a><span id="l18.27" class="difflineminus">-  nsCOMPtr &lt;nsIOutputStream&gt; mLogStream;</span>
<a href="#l18.28"></a><span id="l18.28" class="difflineplus">+  nsCOMPtr&lt;nsIOutputStream&gt; mLogStream;</span>
<a href="#l18.29"></a><span id="l18.29">   nsCOMPtr&lt;nsIFile&gt; mLogFile;</span>
<a href="#l18.30"></a><span id="l18.30"> </span>
<a href="#l18.31"></a><span id="l18.31">   int32_t mLevel;</span>
<a href="#l18.32"></a><span id="l18.32">   int32_t mPurgeInterval;</span>
<a href="#l18.33"></a><span id="l18.33">   int32_t mMoveTargetMode;</span>
<a href="#l18.34"></a><span id="l18.34"> </span>
<a href="#l18.35"></a><span id="l18.35">   bool mPurge;</span>
<a href="#l18.36"></a><span id="l18.36">   bool mUseWhiteList;</span>
<a href="#l18.37"></a><span id="l18.37">   bool mMoveOnSpam;</span>
<a href="#l18.38"></a><span id="l18.38">   bool mUseServerFilter;</span>
<a href="#l18.39"></a><span id="l18.39"> </span>
<a href="#l18.40"></a><span id="l18.40">   nsCString mActionTargetAccount;</span>
<a href="#l18.41"></a><span id="l18.41">   nsCString mActionTargetFolder;</span>
<a href="#l18.42"></a><span id="l18.42">   nsCString mWhiteListAbURI;</span>
<a href="#l18.43"></a><span id="l18.43" class="difflineminus">-  nsCString mCurrentJunkFolderURI; // used to detect changes to the spam folder in ::initialize</span>
<a href="#l18.44"></a><span id="l18.44" class="difflineplus">+  // used to detect changes to the spam folder in ::initialize</span>
<a href="#l18.45"></a><span id="l18.45" class="difflineplus">+  nsCString mCurrentJunkFolderURI;</span>
<a href="#l18.46"></a><span id="l18.46"> </span>
<a href="#l18.47"></a><span id="l18.47">   nsCString mServerFilterName;</span>
<a href="#l18.48"></a><span id="l18.48">   nsCOMPtr&lt;nsIFile&gt; mServerFilterFile;</span>
<a href="#l18.49"></a><span id="l18.49" class="difflineminus">-  int32_t  mServerFilterTrustFlags;</span>
<a href="#l18.50"></a><span id="l18.50" class="difflineplus">+  int32_t mServerFilterTrustFlags;</span>
<a href="#l18.51"></a><span id="l18.51"> </span>
<a href="#l18.52"></a><span id="l18.52">   // array of address directories to use in junk whitelisting</span>
<a href="#l18.53"></a><span id="l18.53">   nsCOMArray&lt;nsIAbDirectory&gt; mWhiteListDirArray;</span>
<a href="#l18.54"></a><span id="l18.54">   // mail domains to use in junk whitelisting</span>
<a href="#l18.55"></a><span id="l18.55">   nsCString mTrustedMailDomains;</span>
<a href="#l18.56"></a><span id="l18.56">   // should we inhibit whitelisting address of identity?</span>
<a href="#l18.57"></a><span id="l18.57">   bool mInhibitWhiteListingIdentityUser;</span>
<a href="#l18.58"></a><span id="l18.58">   // should we inhibit whitelisting domain of identity?</span>
<a href="#l18.59"></a><span id="l18.59">   bool mInhibitWhiteListingIdentityDomain;</span>
<a href="#l18.60"></a><span id="l18.60">   // email addresses associated with this server</span>
<a href="#l18.61"></a><span id="l18.61">   nsTArray&lt;nsCString&gt; mEmails;</span>
<a href="#l18.62"></a><span id="l18.62"> </span>
<a href="#l18.63"></a><span id="l18.63" class="difflineminus">-  // helper routine used by Initialize which unsets the junk flag on the previous junk folder</span>
<a href="#l18.64"></a><span id="l18.64" class="difflineminus">-  // for this account, and sets it on the new junk folder.</span>
<a href="#l18.65"></a><span id="l18.65" class="difflineplus">+  // helper routine used by Initialize which unsets the junk flag on the</span>
<a href="#l18.66"></a><span id="l18.66" class="difflineplus">+  // previous junk folder for this account, and sets it on the new junk folder.</span>
<a href="#l18.67"></a><span id="l18.67">   nsresult UpdateJunkFolderState();</span>
<a href="#l18.68"></a><span id="l18.68"> };</span>
<a href="#l18.69"></a><span id="l18.69"> </span>
<a href="#l18.70"></a><span id="l18.70"> #endif /* nsSpamSettings_h__ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/base/src/nsStatusBarBiffManager.cpp</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/base/src/nsStatusBarBiffManager.cpp</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -7,234 +7,233 @@</span>
<a href="#l19.4"></a><span id="l19.4"> #include &quot;nsMsgBiffManager.h&quot;</span>
<a href="#l19.5"></a><span id="l19.5"> #include &quot;nsIMsgMailSession.h&quot;</span>
<a href="#l19.6"></a><span id="l19.6"> #include &quot;nsIMsgAccountManager.h&quot;</span>
<a href="#l19.7"></a><span id="l19.7"> #include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l19.8"></a><span id="l19.8"> #include &quot;nsIObserverService.h&quot;</span>
<a href="#l19.9"></a><span id="l19.9"> #include &quot;nsIWindowMediator.h&quot;</span>
<a href="#l19.10"></a><span id="l19.10"> #include &quot;nsIMsgMailSession.h&quot;</span>
<a href="#l19.11"></a><span id="l19.11"> #include &quot;MailNewsTypes.h&quot;</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-#include &quot;nsIMsgFolder.h&quot; // TO include biffState enum. Change to bool later...</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+#include &quot;nsIMsgFolder.h&quot;  // TO include biffState enum. Change to bool later...</span>
<a href="#l19.14"></a><span id="l19.14"> #include &quot;nsMsgDBFolder.h&quot;</span>
<a href="#l19.15"></a><span id="l19.15"> #include &quot;nsIFileChannel.h&quot;</span>
<a href="#l19.16"></a><span id="l19.16"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l19.17"></a><span id="l19.17"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l19.18"></a><span id="l19.18"> #include &quot;nsIURL.h&quot;</span>
<a href="#l19.19"></a><span id="l19.19"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l19.20"></a><span id="l19.20"> #include &quot;nsIFileURL.h&quot;</span>
<a href="#l19.21"></a><span id="l19.21"> #include &quot;nsIFile.h&quot;</span>
<a href="#l19.22"></a><span id="l19.22"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l19.23"></a><span id="l19.23"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l19.24"></a><span id="l19.24"> </span>
<a href="#l19.25"></a><span id="l19.25"> // QueryInterface, AddRef, and Release</span>
<a href="#l19.26"></a><span id="l19.26"> //</span>
<a href="#l19.27"></a><span id="l19.27" class="difflineminus">-NS_IMPL_ISUPPORTS(nsStatusBarBiffManager, nsIStatusBarBiffManager, nsIFolderListener, nsIObserver)</span>
<a href="#l19.28"></a><span id="l19.28" class="difflineplus">+NS_IMPL_ISUPPORTS(nsStatusBarBiffManager, nsIStatusBarBiffManager,</span>
<a href="#l19.29"></a><span id="l19.29" class="difflineplus">+                  nsIFolderListener, nsIObserver)</span>
<a href="#l19.30"></a><span id="l19.30"> </span>
<a href="#l19.31"></a><span id="l19.31"> nsStatusBarBiffManager::nsStatusBarBiffManager()</span>
<a href="#l19.32"></a><span id="l19.32" class="difflineminus">-: mInitialized(false), mCurrentBiffState(nsIMsgFolder::nsMsgBiffState_Unknown)</span>
<a href="#l19.33"></a><span id="l19.33" class="difflineminus">-{</span>
<a href="#l19.34"></a><span id="l19.34" class="difflineminus">-}</span>
<a href="#l19.35"></a><span id="l19.35" class="difflineplus">+    : mInitialized(false),</span>
<a href="#l19.36"></a><span id="l19.36" class="difflineplus">+      mCurrentBiffState(nsIMsgFolder::nsMsgBiffState_Unknown) {}</span>
<a href="#l19.37"></a><span id="l19.37" class="difflineplus">+</span>
<a href="#l19.38"></a><span id="l19.38" class="difflineplus">+nsStatusBarBiffManager::~nsStatusBarBiffManager() {}</span>
<a href="#l19.39"></a><span id="l19.39"> </span>
<a href="#l19.40"></a><span id="l19.40" class="difflineminus">-nsStatusBarBiffManager::~nsStatusBarBiffManager()</span>
<a href="#l19.41"></a><span id="l19.41" class="difflineminus">-{</span>
<a href="#l19.42"></a><span id="l19.42" class="difflineminus">-}</span>
<a href="#l19.43"></a><span id="l19.43" class="difflineminus">-</span>
<a href="#l19.44"></a><span id="l19.44" class="difflineminus">-#define NEW_MAIL_PREF_BRANCH             &quot;mail.biff.&quot;</span>
<a href="#l19.45"></a><span id="l19.45" class="difflineminus">-#define CHAT_PREF_BRANCH                 &quot;mail.chat.&quot;</span>
<a href="#l19.46"></a><span id="l19.46" class="difflineminus">-#define FEED_PREF_BRANCH                 &quot;mail.feed.&quot;</span>
<a href="#l19.47"></a><span id="l19.47" class="difflineminus">-#define PREF_PLAY_SOUND                  &quot;play_sound&quot;</span>
<a href="#l19.48"></a><span id="l19.48" class="difflineminus">-#define PREF_SOUND_URL                   &quot;play_sound.url&quot;</span>
<a href="#l19.49"></a><span id="l19.49" class="difflineminus">-#define PREF_SOUND_TYPE                  &quot;play_sound.type&quot;</span>
<a href="#l19.50"></a><span id="l19.50" class="difflineplus">+#define NEW_MAIL_PREF_BRANCH &quot;mail.biff.&quot;</span>
<a href="#l19.51"></a><span id="l19.51" class="difflineplus">+#define CHAT_PREF_BRANCH &quot;mail.chat.&quot;</span>
<a href="#l19.52"></a><span id="l19.52" class="difflineplus">+#define FEED_PREF_BRANCH &quot;mail.feed.&quot;</span>
<a href="#l19.53"></a><span id="l19.53" class="difflineplus">+#define PREF_PLAY_SOUND &quot;play_sound&quot;</span>
<a href="#l19.54"></a><span id="l19.54" class="difflineplus">+#define PREF_SOUND_URL &quot;play_sound.url&quot;</span>
<a href="#l19.55"></a><span id="l19.55" class="difflineplus">+#define PREF_SOUND_TYPE &quot;play_sound.type&quot;</span>
<a href="#l19.56"></a><span id="l19.56"> #define SYSTEM_SOUND_TYPE 0</span>
<a href="#l19.57"></a><span id="l19.57"> #define CUSTOM_SOUND_TYPE 1</span>
<a href="#l19.58"></a><span id="l19.58" class="difflineminus">-#define PREF_CHAT_ENABLED                &quot;mail.chat.enabled&quot;</span>
<a href="#l19.59"></a><span id="l19.59" class="difflineminus">-#define PLAY_CHAT_NOTIFICATION_SOUND     &quot;play-chat-notification-sound&quot;</span>
<a href="#l19.60"></a><span id="l19.60" class="difflineplus">+#define PREF_CHAT_ENABLED &quot;mail.chat.enabled&quot;</span>
<a href="#l19.61"></a><span id="l19.61" class="difflineplus">+#define PLAY_CHAT_NOTIFICATION_SOUND &quot;play-chat-notification-sound&quot;</span>
<a href="#l19.62"></a><span id="l19.62"> </span>
<a href="#l19.63"></a><span id="l19.63" class="difflineminus">-nsresult nsStatusBarBiffManager::Init()</span>
<a href="#l19.64"></a><span id="l19.64" class="difflineminus">-{</span>
<a href="#l19.65"></a><span id="l19.65" class="difflineminus">-  if (mInitialized)</span>
<a href="#l19.66"></a><span id="l19.66" class="difflineminus">-    return NS_ERROR_ALREADY_INITIALIZED;</span>
<a href="#l19.67"></a><span id="l19.67" class="difflineplus">+nsresult nsStatusBarBiffManager::Init() {</span>
<a href="#l19.68"></a><span id="l19.68" class="difflineplus">+  if (mInitialized) return NS_ERROR_ALREADY_INITIALIZED;</span>
<a href="#l19.69"></a><span id="l19.69"> </span>
<a href="#l19.70"></a><span id="l19.70">   nsresult rv;</span>
<a href="#l19.71"></a><span id="l19.71"> </span>
<a href="#l19.72"></a><span id="l19.72">   nsCOMPtr&lt;nsIMsgMailSession&gt; mailSession =</span>
<a href="#l19.73"></a><span id="l19.73" class="difflineminus">-    do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l19.74"></a><span id="l19.74" class="difflineminus">-  if(NS_SUCCEEDED(rv))</span>
<a href="#l19.75"></a><span id="l19.75" class="difflineplus">+      do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l19.76"></a><span id="l19.76" class="difflineplus">+  if (NS_SUCCEEDED(rv))</span>
<a href="#l19.77"></a><span id="l19.77">     mailSession-&gt;AddFolderListener(this, nsIFolderListener::intPropertyChanged);</span>
<a href="#l19.78"></a><span id="l19.78"> </span>
<a href="#l19.79"></a><span id="l19.79">   nsCOMPtr&lt;nsIPrefBranch&gt; pref(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l19.80"></a><span id="l19.80">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.81"></a><span id="l19.81"> </span>
<a href="#l19.82"></a><span id="l19.82">   bool chatEnabled = false;</span>
<a href="#l19.83"></a><span id="l19.83" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l19.84"></a><span id="l19.84" class="difflineminus">-    rv = pref-&gt;GetBoolPref(PREF_CHAT_ENABLED, &amp;chatEnabled);</span>
<a href="#l19.85"></a><span id="l19.85" class="difflineplus">+  if (NS_SUCCEEDED(rv)) rv = pref-&gt;GetBoolPref(PREF_CHAT_ENABLED, &amp;chatEnabled);</span>
<a href="#l19.86"></a><span id="l19.86">   if (NS_SUCCEEDED(rv) &amp;&amp; chatEnabled) {</span>
<a href="#l19.87"></a><span id="l19.87">     nsCOMPtr&lt;nsIObserverService&gt; observerService =</span>
<a href="#l19.88"></a><span id="l19.88" class="difflineminus">-      mozilla::services::GetObserverService();</span>
<a href="#l19.89"></a><span id="l19.89" class="difflineplus">+        mozilla::services::GetObserverService();</span>
<a href="#l19.90"></a><span id="l19.90">     if (observerService)</span>
<a href="#l19.91"></a><span id="l19.91">       observerService-&gt;AddObserver(this, PLAY_CHAT_NOTIFICATION_SOUND, false);</span>
<a href="#l19.92"></a><span id="l19.92">   }</span>
<a href="#l19.93"></a><span id="l19.93"> </span>
<a href="#l19.94"></a><span id="l19.94">   mInitialized = true;</span>
<a href="#l19.95"></a><span id="l19.95">   return NS_OK;</span>
<a href="#l19.96"></a><span id="l19.96"> }</span>
<a href="#l19.97"></a><span id="l19.97"> </span>
<a href="#l19.98"></a><span id="l19.98" class="difflineminus">-nsresult nsStatusBarBiffManager::PlayBiffSound(const char *aPrefBranch)</span>
<a href="#l19.99"></a><span id="l19.99" class="difflineminus">-{</span>
<a href="#l19.100"></a><span id="l19.100" class="difflineplus">+nsresult nsStatusBarBiffManager::PlayBiffSound(const char *aPrefBranch) {</span>
<a href="#l19.101"></a><span id="l19.101">   nsresult rv;</span>
<a href="#l19.102"></a><span id="l19.102" class="difflineminus">-  nsCOMPtr&lt;nsIPrefService&gt; prefSvc = (do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l19.103"></a><span id="l19.103" class="difflineplus">+  nsCOMPtr&lt;nsIPrefService&gt; prefSvc =</span>
<a href="#l19.104"></a><span id="l19.104" class="difflineplus">+      (do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l19.105"></a><span id="l19.105">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.106"></a><span id="l19.106">   nsCOMPtr&lt;nsIPrefBranch&gt; pref;</span>
<a href="#l19.107"></a><span id="l19.107">   rv = prefSvc-&gt;GetBranch(aPrefBranch, getter_AddRefs(pref));</span>
<a href="#l19.108"></a><span id="l19.108">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.109"></a><span id="l19.109"> </span>
<a href="#l19.110"></a><span id="l19.110">   bool playSound;</span>
<a href="#l19.111"></a><span id="l19.111">   if (mServerType.EqualsLiteral(&quot;rss&quot;)) {</span>
<a href="#l19.112"></a><span id="l19.112">     nsCOMPtr&lt;nsIPrefBranch&gt; prefFeed;</span>
<a href="#l19.113"></a><span id="l19.113">     rv = prefSvc-&gt;GetBranch(FEED_PREF_BRANCH, getter_AddRefs(prefFeed));</span>
<a href="#l19.114"></a><span id="l19.114">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.115"></a><span id="l19.115">     rv = prefFeed-&gt;GetBoolPref(PREF_PLAY_SOUND, &amp;playSound);</span>
<a href="#l19.116"></a><span id="l19.116" class="difflineminus">-  }</span>
<a href="#l19.117"></a><span id="l19.117" class="difflineminus">-  else {</span>
<a href="#l19.118"></a><span id="l19.118" class="difflineplus">+  } else {</span>
<a href="#l19.119"></a><span id="l19.119">     rv = pref-&gt;GetBoolPref(PREF_PLAY_SOUND, &amp;playSound);</span>
<a href="#l19.120"></a><span id="l19.120">   }</span>
<a href="#l19.121"></a><span id="l19.121">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.122"></a><span id="l19.122"> </span>
<a href="#l19.123"></a><span id="l19.123" class="difflineminus">-  if (!playSound)</span>
<a href="#l19.124"></a><span id="l19.124" class="difflineminus">-    return NS_OK;</span>
<a href="#l19.125"></a><span id="l19.125" class="difflineplus">+  if (!playSound) return NS_OK;</span>
<a href="#l19.126"></a><span id="l19.126"> </span>
<a href="#l19.127"></a><span id="l19.127">   // lazily create the sound instance</span>
<a href="#l19.128"></a><span id="l19.128" class="difflineminus">-  if (!mSound)</span>
<a href="#l19.129"></a><span id="l19.129" class="difflineminus">-    mSound = do_CreateInstance(&quot;@mozilla.org/sound;1&quot;);</span>
<a href="#l19.130"></a><span id="l19.130" class="difflineplus">+  if (!mSound) mSound = do_CreateInstance(&quot;@mozilla.org/sound;1&quot;);</span>
<a href="#l19.131"></a><span id="l19.131"> </span>
<a href="#l19.132"></a><span id="l19.132">   int32_t soundType = SYSTEM_SOUND_TYPE;</span>
<a href="#l19.133"></a><span id="l19.133">   rv = pref-&gt;GetIntPref(PREF_SOUND_TYPE, &amp;soundType);</span>
<a href="#l19.134"></a><span id="l19.134">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.135"></a><span id="l19.135"> </span>
<a href="#l19.136"></a><span id="l19.136">   bool customSoundPlayed = false;</span>
<a href="#l19.137"></a><span id="l19.137"> </span>
<a href="#l19.138"></a><span id="l19.138">   if (soundType == CUSTOM_SOUND_TYPE) {</span>
<a href="#l19.139"></a><span id="l19.139">     nsCString soundURLSpec;</span>
<a href="#l19.140"></a><span id="l19.140">     rv = pref-&gt;GetCharPref(PREF_SOUND_URL, soundURLSpec);</span>
<a href="#l19.141"></a><span id="l19.141"> </span>
<a href="#l19.142"></a><span id="l19.142">     if (NS_SUCCEEDED(rv) &amp;&amp; !soundURLSpec.IsEmpty()) {</span>
<a href="#l19.143"></a><span id="l19.143">       if (!strncmp(soundURLSpec.get(), &quot;file://&quot;, 7)) {</span>
<a href="#l19.144"></a><span id="l19.144">         nsCOMPtr&lt;nsIURI&gt; fileURI;</span>
<a href="#l19.145"></a><span id="l19.145">         rv = NS_NewURI(getter_AddRefs(fileURI), soundURLSpec);</span>
<a href="#l19.146"></a><span id="l19.146" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l19.147"></a><span id="l19.147" class="difflineminus">-        nsCOMPtr&lt;nsIFileURL&gt; soundURL = do_QueryInterface(fileURI,&amp;rv);</span>
<a href="#l19.148"></a><span id="l19.148" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.149"></a><span id="l19.149" class="difflineplus">+        nsCOMPtr&lt;nsIFileURL&gt; soundURL = do_QueryInterface(fileURI, &amp;rv);</span>
<a href="#l19.150"></a><span id="l19.150">         if (NS_SUCCEEDED(rv)) {</span>
<a href="#l19.151"></a><span id="l19.151">           nsCOMPtr&lt;nsIFile&gt; soundFile;</span>
<a href="#l19.152"></a><span id="l19.152">           rv = soundURL-&gt;GetFile(getter_AddRefs(soundFile));</span>
<a href="#l19.153"></a><span id="l19.153">           if (NS_SUCCEEDED(rv)) {</span>
<a href="#l19.154"></a><span id="l19.154">             bool soundFileExists = false;</span>
<a href="#l19.155"></a><span id="l19.155">             rv = soundFile-&gt;Exists(&amp;soundFileExists);</span>
<a href="#l19.156"></a><span id="l19.156">             if (NS_SUCCEEDED(rv) &amp;&amp; soundFileExists) {</span>
<a href="#l19.157"></a><span id="l19.157">               rv = mSound-&gt;Play(soundURL);</span>
<a href="#l19.158"></a><span id="l19.158" class="difflineminus">-              if (NS_SUCCEEDED(rv))</span>
<a href="#l19.159"></a><span id="l19.159" class="difflineminus">-                customSoundPlayed = true;</span>
<a href="#l19.160"></a><span id="l19.160" class="difflineplus">+              if (NS_SUCCEEDED(rv)) customSoundPlayed = true;</span>
<a href="#l19.161"></a><span id="l19.161">             }</span>
<a href="#l19.162"></a><span id="l19.162">           }</span>
<a href="#l19.163"></a><span id="l19.163">         }</span>
<a href="#l19.164"></a><span id="l19.164">       }</span>
<a href="#l19.165"></a><span id="l19.165" class="difflineminus">-      // XXX TODO: See if we can create a nsIFile using the string as a native path.</span>
<a href="#l19.166"></a><span id="l19.166" class="difflineplus">+      // XXX TODO: See if we can create a nsIFile using the string as a native</span>
<a href="#l19.167"></a><span id="l19.167" class="difflineplus">+      // path.</span>
<a href="#l19.168"></a><span id="l19.168">     }</span>
<a href="#l19.169"></a><span id="l19.169">   }</span>
<a href="#l19.170"></a><span id="l19.170"> #ifndef XP_MACOSX</span>
<a href="#l19.171"></a><span id="l19.171">   // if nothing played, play the default system sound</span>
<a href="#l19.172"></a><span id="l19.172">   if (!customSoundPlayed) {</span>
<a href="#l19.173"></a><span id="l19.173">     rv = mSound-&gt;PlayEventSound(nsISound::EVENT_NEW_MAIL_RECEIVED);</span>
<a href="#l19.174"></a><span id="l19.174">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.175"></a><span id="l19.175">   }</span>
<a href="#l19.176"></a><span id="l19.176"> #endif</span>
<a href="#l19.177"></a><span id="l19.177">   return rv;</span>
<a href="#l19.178"></a><span id="l19.178"> }</span>
<a href="#l19.179"></a><span id="l19.179"> </span>
<a href="#l19.180"></a><span id="l19.180"> // nsIFolderListener methods....</span>
<a href="#l19.181"></a><span id="l19.181"> NS_IMETHODIMP</span>
<a href="#l19.182"></a><span id="l19.182" class="difflineminus">-nsStatusBarBiffManager::OnItemAdded(nsIMsgFolder *parentItem, nsISupports *item)</span>
<a href="#l19.183"></a><span id="l19.183" class="difflineminus">-{</span>
<a href="#l19.184"></a><span id="l19.184" class="difflineplus">+nsStatusBarBiffManager::OnItemAdded(nsIMsgFolder *parentItem,</span>
<a href="#l19.185"></a><span id="l19.185" class="difflineplus">+                                    nsISupports *item) {</span>
<a href="#l19.186"></a><span id="l19.186" class="difflineplus">+  return NS_OK;</span>
<a href="#l19.187"></a><span id="l19.187" class="difflineplus">+}</span>
<a href="#l19.188"></a><span id="l19.188" class="difflineplus">+</span>
<a href="#l19.189"></a><span id="l19.189" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l19.190"></a><span id="l19.190" class="difflineplus">+nsStatusBarBiffManager::OnItemRemoved(nsIMsgFolder *parentItem,</span>
<a href="#l19.191"></a><span id="l19.191" class="difflineplus">+                                      nsISupports *item) {</span>
<a href="#l19.192"></a><span id="l19.192">   return NS_OK;</span>
<a href="#l19.193"></a><span id="l19.193"> }</span>
<a href="#l19.194"></a><span id="l19.194"> </span>
<a href="#l19.195"></a><span id="l19.195"> NS_IMETHODIMP</span>
<a href="#l19.196"></a><span id="l19.196" class="difflineminus">-nsStatusBarBiffManager::OnItemRemoved(nsIMsgFolder *parentItem, nsISupports *item)</span>
<a href="#l19.197"></a><span id="l19.197" class="difflineminus">-{</span>
<a href="#l19.198"></a><span id="l19.198" class="difflineplus">+nsStatusBarBiffManager::OnItemPropertyChanged(nsIMsgFolder *item,</span>
<a href="#l19.199"></a><span id="l19.199" class="difflineplus">+                                              const nsACString &amp;property,</span>
<a href="#l19.200"></a><span id="l19.200" class="difflineplus">+                                              const char *oldValue,</span>
<a href="#l19.201"></a><span id="l19.201" class="difflineplus">+                                              const char *newValue) {</span>
<a href="#l19.202"></a><span id="l19.202">   return NS_OK;</span>
<a href="#l19.203"></a><span id="l19.203"> }</span>
<a href="#l19.204"></a><span id="l19.204"> </span>
<a href="#l19.205"></a><span id="l19.205"> NS_IMETHODIMP</span>
<a href="#l19.206"></a><span id="l19.206" class="difflineminus">-nsStatusBarBiffManager::OnItemPropertyChanged(nsIMsgFolder *item, const nsACString &amp;property, const char *oldValue, const char *newValue)</span>
<a href="#l19.207"></a><span id="l19.207" class="difflineminus">-{</span>
<a href="#l19.208"></a><span id="l19.208" class="difflineminus">-  return NS_OK;</span>
<a href="#l19.209"></a><span id="l19.209" class="difflineminus">-}</span>
<a href="#l19.210"></a><span id="l19.210" class="difflineminus">-</span>
<a href="#l19.211"></a><span id="l19.211" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l19.212"></a><span id="l19.212" class="difflineminus">-nsStatusBarBiffManager::OnItemIntPropertyChanged(nsIMsgFolder *item, const nsACString &amp;property, int64_t oldValue, int64_t newValue)</span>
<a href="#l19.213"></a><span id="l19.213" class="difflineminus">-{</span>
<a href="#l19.214"></a><span id="l19.214" class="difflineplus">+nsStatusBarBiffManager::OnItemIntPropertyChanged(nsIMsgFolder *item,</span>
<a href="#l19.215"></a><span id="l19.215" class="difflineplus">+                                                 const nsACString &amp;property,</span>
<a href="#l19.216"></a><span id="l19.216" class="difflineplus">+                                                 int64_t oldValue,</span>
<a href="#l19.217"></a><span id="l19.217" class="difflineplus">+                                                 int64_t newValue) {</span>
<a href="#l19.218"></a><span id="l19.218">   if (property.Equals(kBiffState) &amp;&amp; mCurrentBiffState != newValue) {</span>
<a href="#l19.219"></a><span id="l19.219">     // if we got new mail, attempt to play a sound.</span>
<a href="#l19.220"></a><span id="l19.220">     // if we fail along the way, don't return.</span>
<a href="#l19.221"></a><span id="l19.221">     // we still need to update the UI.</span>
<a href="#l19.222"></a><span id="l19.222">     if (newValue == nsIMsgFolder::nsMsgBiffState_NewMail) {</span>
<a href="#l19.223"></a><span id="l19.223">       // Get the folder's server type.</span>
<a href="#l19.224"></a><span id="l19.224">       nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l19.225"></a><span id="l19.225">       nsresult rv = item-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l19.226"></a><span id="l19.226" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; server)</span>
<a href="#l19.227"></a><span id="l19.227" class="difflineminus">-        server-&gt;GetType(mServerType);</span>
<a href="#l19.228"></a><span id="l19.228" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; server) server-&gt;GetType(mServerType);</span>
<a href="#l19.229"></a><span id="l19.229"> </span>
<a href="#l19.230"></a><span id="l19.230">       // if we fail to play the biff sound, keep going.</span>
<a href="#l19.231"></a><span id="l19.231">       (void)PlayBiffSound(NEW_MAIL_PREF_BRANCH);</span>
<a href="#l19.232"></a><span id="l19.232">     }</span>
<a href="#l19.233"></a><span id="l19.233">     mCurrentBiffState = newValue;</span>
<a href="#l19.234"></a><span id="l19.234"> </span>
<a href="#l19.235"></a><span id="l19.235">     // don't care if notification fails</span>
<a href="#l19.236"></a><span id="l19.236">     nsCOMPtr&lt;nsIObserverService&gt; observerService =</span>
<a href="#l19.237"></a><span id="l19.237" class="difflineminus">-      mozilla::services::GetObserverService();</span>
<a href="#l19.238"></a><span id="l19.238" class="difflineplus">+        mozilla::services::GetObserverService();</span>
<a href="#l19.239"></a><span id="l19.239"> </span>
<a href="#l19.240"></a><span id="l19.240">     if (observerService)</span>
<a href="#l19.241"></a><span id="l19.241" class="difflineminus">-      observerService-&gt;NotifyObservers(static_cast&lt;nsIStatusBarBiffManager*&gt;(this), &quot;mail:biff-state-changed&quot;, nullptr);</span>
<a href="#l19.242"></a><span id="l19.242" class="difflineplus">+      observerService-&gt;NotifyObservers(</span>
<a href="#l19.243"></a><span id="l19.243" class="difflineplus">+          static_cast&lt;nsIStatusBarBiffManager *&gt;(this),</span>
<a href="#l19.244"></a><span id="l19.244" class="difflineplus">+          &quot;mail:biff-state-changed&quot;, nullptr);</span>
<a href="#l19.245"></a><span id="l19.245">   }</span>
<a href="#l19.246"></a><span id="l19.246">   return NS_OK;</span>
<a href="#l19.247"></a><span id="l19.247"> }</span>
<a href="#l19.248"></a><span id="l19.248"> </span>
<a href="#l19.249"></a><span id="l19.249"> NS_IMETHODIMP</span>
<a href="#l19.250"></a><span id="l19.250" class="difflineminus">-nsStatusBarBiffManager::OnItemBoolPropertyChanged(nsIMsgFolder *item, const nsACString &amp;property, bool oldValue, bool newValue)</span>
<a href="#l19.251"></a><span id="l19.251" class="difflineminus">-{</span>
<a href="#l19.252"></a><span id="l19.252" class="difflineplus">+nsStatusBarBiffManager::OnItemBoolPropertyChanged(nsIMsgFolder *item,</span>
<a href="#l19.253"></a><span id="l19.253" class="difflineplus">+                                                  const nsACString &amp;property,</span>
<a href="#l19.254"></a><span id="l19.254" class="difflineplus">+                                                  bool oldValue,</span>
<a href="#l19.255"></a><span id="l19.255" class="difflineplus">+                                                  bool newValue) {</span>
<a href="#l19.256"></a><span id="l19.256">   return NS_OK;</span>
<a href="#l19.257"></a><span id="l19.257"> }</span>
<a href="#l19.258"></a><span id="l19.258"> </span>
<a href="#l19.259"></a><span id="l19.259"> NS_IMETHODIMP</span>
<a href="#l19.260"></a><span id="l19.260" class="difflineminus">-nsStatusBarBiffManager::OnItemUnicharPropertyChanged(nsIMsgFolder *item, const nsACString &amp;property, const char16_t *oldValue, const char16_t *newValue)</span>
<a href="#l19.261"></a><span id="l19.261" class="difflineminus">-{</span>
<a href="#l19.262"></a><span id="l19.262" class="difflineplus">+nsStatusBarBiffManager::OnItemUnicharPropertyChanged(nsIMsgFolder *item,</span>
<a href="#l19.263"></a><span id="l19.263" class="difflineplus">+                                                     const nsACString &amp;property,</span>
<a href="#l19.264"></a><span id="l19.264" class="difflineplus">+                                                     const char16_t *oldValue,</span>
<a href="#l19.265"></a><span id="l19.265" class="difflineplus">+                                                     const char16_t *newValue) {</span>
<a href="#l19.266"></a><span id="l19.266">   return NS_OK;</span>
<a href="#l19.267"></a><span id="l19.267"> }</span>
<a href="#l19.268"></a><span id="l19.268"> </span>
<a href="#l19.269"></a><span id="l19.269"> NS_IMETHODIMP</span>
<a href="#l19.270"></a><span id="l19.270" class="difflineminus">-nsStatusBarBiffManager::OnItemPropertyFlagChanged(nsIMsgDBHdr *item, const nsACString &amp;property, uint32_t oldFlag, uint32_t newFlag)</span>
<a href="#l19.271"></a><span id="l19.271" class="difflineminus">-{</span>
<a href="#l19.272"></a><span id="l19.272" class="difflineplus">+nsStatusBarBiffManager::OnItemPropertyFlagChanged(nsIMsgDBHdr *item,</span>
<a href="#l19.273"></a><span id="l19.273" class="difflineplus">+                                                  const nsACString &amp;property,</span>
<a href="#l19.274"></a><span id="l19.274" class="difflineplus">+                                                  uint32_t oldFlag,</span>
<a href="#l19.275"></a><span id="l19.275" class="difflineplus">+                                                  uint32_t newFlag) {</span>
<a href="#l19.276"></a><span id="l19.276">   return NS_OK;</span>
<a href="#l19.277"></a><span id="l19.277"> }</span>
<a href="#l19.278"></a><span id="l19.278"> </span>
<a href="#l19.279"></a><span id="l19.279"> NS_IMETHODIMP</span>
<a href="#l19.280"></a><span id="l19.280" class="difflineminus">-nsStatusBarBiffManager::OnItemEvent(nsIMsgFolder *item, const nsACString &amp;event)</span>
<a href="#l19.281"></a><span id="l19.281" class="difflineminus">-{</span>
<a href="#l19.282"></a><span id="l19.282" class="difflineplus">+nsStatusBarBiffManager::OnItemEvent(nsIMsgFolder *item,</span>
<a href="#l19.283"></a><span id="l19.283" class="difflineplus">+                                    const nsACString &amp;event) {</span>
<a href="#l19.284"></a><span id="l19.284">   return NS_OK;</span>
<a href="#l19.285"></a><span id="l19.285"> }</span>
<a href="#l19.286"></a><span id="l19.286"> </span>
<a href="#l19.287"></a><span id="l19.287"> // nsIObserver implementation</span>
<a href="#l19.288"></a><span id="l19.288"> NS_IMETHODIMP</span>
<a href="#l19.289"></a><span id="l19.289" class="difflineminus">-nsStatusBarBiffManager::Observe(nsISupports *aSubject,</span>
<a href="#l19.290"></a><span id="l19.290" class="difflineminus">-                                const char *aTopic,</span>
<a href="#l19.291"></a><span id="l19.291" class="difflineminus">-                                const char16_t *aData)</span>
<a href="#l19.292"></a><span id="l19.292" class="difflineminus">-{</span>
<a href="#l19.293"></a><span id="l19.293" class="difflineplus">+nsStatusBarBiffManager::Observe(nsISupports *aSubject, const char *aTopic,</span>
<a href="#l19.294"></a><span id="l19.294" class="difflineplus">+                                const char16_t *aData) {</span>
<a href="#l19.295"></a><span id="l19.295">   return PlayBiffSound(CHAT_PREF_BRANCH);</span>
<a href="#l19.296"></a><span id="l19.296"> }</span>
<a href="#l19.297"></a><span id="l19.297"> </span>
<a href="#l19.298"></a><span id="l19.298"> // nsIStatusBarBiffManager method....</span>
<a href="#l19.299"></a><span id="l19.299"> NS_IMETHODIMP</span>
<a href="#l19.300"></a><span id="l19.300" class="difflineminus">-nsStatusBarBiffManager::GetBiffState(int32_t *aBiffState)</span>
<a href="#l19.301"></a><span id="l19.301" class="difflineminus">-{</span>
<a href="#l19.302"></a><span id="l19.302" class="difflineplus">+nsStatusBarBiffManager::GetBiffState(int32_t *aBiffState) {</span>
<a href="#l19.303"></a><span id="l19.303">   NS_ENSURE_ARG_POINTER(aBiffState);</span>
<a href="#l19.304"></a><span id="l19.304">   *aBiffState = mCurrentBiffState;</span>
<a href="#l19.305"></a><span id="l19.305">   return NS_OK;</span>
<a href="#l19.306"></a><span id="l19.306"> }</span>
<a href="#l19.307"></a><span id="l19.307" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/base/src/nsStatusBarBiffManager.h</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/base/src/nsStatusBarBiffManager.h</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -9,33 +9,29 @@</span>
<a href="#l20.4"></a><span id="l20.4"> #include &quot;nsIStatusBarBiffManager.h&quot;</span>
<a href="#l20.5"></a><span id="l20.5"> </span>
<a href="#l20.6"></a><span id="l20.6"> #include &quot;msgCore.h&quot;</span>
<a href="#l20.7"></a><span id="l20.7"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l20.8"></a><span id="l20.8"> #include &quot;nsISound.h&quot;</span>
<a href="#l20.9"></a><span id="l20.9"> #include &quot;nsIObserver.h&quot;</span>
<a href="#l20.10"></a><span id="l20.10"> </span>
<a href="#l20.11"></a><span id="l20.11"> class nsStatusBarBiffManager : public nsIStatusBarBiffManager,</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-                               public nsIObserver</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineminus">-{</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineminus">-public:</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineplus">+                               public nsIObserver {</span>
<a href="#l20.16"></a><span id="l20.16" class="difflineplus">+ public:</span>
<a href="#l20.17"></a><span id="l20.17">   NS_DECL_ISUPPORTS</span>
<a href="#l20.18"></a><span id="l20.18">   NS_DECL_NSIFOLDERLISTENER</span>
<a href="#l20.19"></a><span id="l20.19">   NS_DECL_NSISTATUSBARBIFFMANAGER</span>
<a href="#l20.20"></a><span id="l20.20">   NS_DECL_NSIOBSERVER</span>
<a href="#l20.21"></a><span id="l20.21"> </span>
<a href="#l20.22"></a><span id="l20.22">   nsStatusBarBiffManager();</span>
<a href="#l20.23"></a><span id="l20.23">   nsresult Init();</span>
<a href="#l20.24"></a><span id="l20.24"> </span>
<a href="#l20.25"></a><span id="l20.25" class="difflineminus">-private:</span>
<a href="#l20.26"></a><span id="l20.26" class="difflineplus">+ private:</span>
<a href="#l20.27"></a><span id="l20.27">   virtual ~nsStatusBarBiffManager();</span>
<a href="#l20.28"></a><span id="l20.28"> </span>
<a href="#l20.29"></a><span id="l20.29" class="difflineminus">-  bool     mInitialized;</span>
<a href="#l20.30"></a><span id="l20.30" class="difflineminus">-  int32_t  mCurrentBiffState;</span>
<a href="#l20.31"></a><span id="l20.31" class="difflineplus">+  bool mInitialized;</span>
<a href="#l20.32"></a><span id="l20.32" class="difflineplus">+  int32_t mCurrentBiffState;</span>
<a href="#l20.33"></a><span id="l20.33">   nsCString mServerType;</span>
<a href="#l20.34"></a><span id="l20.34">   nsCOMPtr&lt;nsISound&gt; mSound;</span>
<a href="#l20.35"></a><span id="l20.35">   nsresult PlayBiffSound(const char *aPrefBranch);</span>
<a href="#l20.36"></a><span id="l20.36"> };</span>
<a href="#l20.37"></a><span id="l20.37"> </span>
<a href="#l20.38"></a><span id="l20.38" class="difflineminus">-</span>
<a href="#l20.39"></a><span id="l20.39" class="difflineminus">-</span>
<a href="#l20.40"></a><span id="l20.40" class="difflineminus">-#endif // nsStatusBarBiffManager_h__</span>
<a href="#l20.41"></a><span id="l20.41" class="difflineminus">-</span>
<a href="#l20.42"></a><span id="l20.42" class="difflineplus">+#endif  // nsStatusBarBiffManager_h__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mailnews/base/src/nsSubscribableServer.cpp</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mailnews/base/src/nsSubscribableServer.cpp</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -11,797 +11,729 @@</span>
<a href="#l21.4"></a><span id="l21.4"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l21.5"></a><span id="l21.5"> #include &quot;nsCOMArray.h&quot;</span>
<a href="#l21.6"></a><span id="l21.6"> #include &quot;nsArrayEnumerator.h&quot;</span>
<a href="#l21.7"></a><span id="l21.7"> #include &quot;nsStringEnumerator.h&quot;</span>
<a href="#l21.8"></a><span id="l21.8"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l21.9"></a><span id="l21.9"> #include &quot;nsTreeColumns.h&quot;</span>
<a href="#l21.10"></a><span id="l21.10"> #include &quot;mozilla/dom/DataTransfer.h&quot;</span>
<a href="#l21.11"></a><span id="l21.11"> </span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineminus">-nsSubscribableServer::nsSubscribableServer(void)</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineminus">-{</span>
<a href="#l21.15"></a><span id="l21.15" class="difflineminus">-    mDelimiter = '.';</span>
<a href="#l21.16"></a><span id="l21.16" class="difflineminus">-    mShowFullName = true;</span>
<a href="#l21.17"></a><span id="l21.17" class="difflineminus">-    mTreeRoot = nullptr;</span>
<a href="#l21.18"></a><span id="l21.18" class="difflineminus">-    mStopped = false;</span>
<a href="#l21.19"></a><span id="l21.19" class="difflineplus">+nsSubscribableServer::nsSubscribableServer(void) {</span>
<a href="#l21.20"></a><span id="l21.20" class="difflineplus">+  mDelimiter = '.';</span>
<a href="#l21.21"></a><span id="l21.21" class="difflineplus">+  mShowFullName = true;</span>
<a href="#l21.22"></a><span id="l21.22" class="difflineplus">+  mTreeRoot = nullptr;</span>
<a href="#l21.23"></a><span id="l21.23" class="difflineplus">+  mStopped = false;</span>
<a href="#l21.24"></a><span id="l21.24"> }</span>
<a href="#l21.25"></a><span id="l21.25"> </span>
<a href="#l21.26"></a><span id="l21.26" class="difflineminus">-nsresult</span>
<a href="#l21.27"></a><span id="l21.27" class="difflineminus">-nsSubscribableServer::Init()</span>
<a href="#l21.28"></a><span id="l21.28" class="difflineminus">-{</span>
<a href="#l21.29"></a><span id="l21.29" class="difflineminus">-  return NS_OK;</span>
<a href="#l21.30"></a><span id="l21.30" class="difflineminus">-}</span>
<a href="#l21.31"></a><span id="l21.31" class="difflineplus">+nsresult nsSubscribableServer::Init() { return NS_OK; }</span>
<a href="#l21.32"></a><span id="l21.32"> </span>
<a href="#l21.33"></a><span id="l21.33" class="difflineminus">-nsSubscribableServer::~nsSubscribableServer(void)</span>
<a href="#l21.34"></a><span id="l21.34" class="difflineminus">-{</span>
<a href="#l21.35"></a><span id="l21.35" class="difflineplus">+nsSubscribableServer::~nsSubscribableServer(void) {</span>
<a href="#l21.36"></a><span id="l21.36">   mozilla::DebugOnly&lt;nsresult&gt; rv = FreeRows();</span>
<a href="#l21.37"></a><span id="l21.37">   NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed to free tree rows&quot;);</span>
<a href="#l21.38"></a><span id="l21.38">   rv = FreeSubtree(mTreeRoot);</span>
<a href="#l21.39"></a><span id="l21.39" class="difflineminus">-  NS_ASSERTION(NS_SUCCEEDED(rv),&quot;failed to free tree&quot;);</span>
<a href="#l21.40"></a><span id="l21.40" class="difflineplus">+  NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed to free tree&quot;);</span>
<a href="#l21.41"></a><span id="l21.41"> }</span>
<a href="#l21.42"></a><span id="l21.42"> </span>
<a href="#l21.43"></a><span id="l21.43"> NS_IMPL_ISUPPORTS(nsSubscribableServer, nsISubscribableServer, nsITreeView)</span>
<a href="#l21.44"></a><span id="l21.44"> </span>
<a href="#l21.45"></a><span id="l21.45"> NS_IMETHODIMP</span>
<a href="#l21.46"></a><span id="l21.46" class="difflineminus">-nsSubscribableServer::SetIncomingServer(nsIMsgIncomingServer *aServer)</span>
<a href="#l21.47"></a><span id="l21.47" class="difflineminus">-{</span>
<a href="#l21.48"></a><span id="l21.48" class="difflineplus">+nsSubscribableServer::SetIncomingServer(nsIMsgIncomingServer *aServer) {</span>
<a href="#l21.49"></a><span id="l21.49">   if (!aServer) {</span>
<a href="#l21.50"></a><span id="l21.50">     mIncomingServerUri.AssignLiteral(&quot;&quot;);</span>
<a href="#l21.51"></a><span id="l21.51">     mServerType.Truncate();</span>
<a href="#l21.52"></a><span id="l21.52">     return NS_OK;</span>
<a href="#l21.53"></a><span id="l21.53">   }</span>
<a href="#l21.54"></a><span id="l21.54">   aServer-&gt;GetType(mServerType);</span>
<a href="#l21.55"></a><span id="l21.55"> </span>
<a href="#l21.56"></a><span id="l21.56">   // We intentionally do not store a pointer to the aServer here</span>
<a href="#l21.57"></a><span id="l21.57">   // as it would create reference loops, because nsIImapIncomingServer</span>
<a href="#l21.58"></a><span id="l21.58">   // and nsINntpIncomingServer keep a reference to an internal</span>
<a href="#l21.59"></a><span id="l21.59">   // nsISubscribableServer object.</span>
<a href="#l21.60"></a><span id="l21.60">   // We only need the URI of the server anyway.</span>
<a href="#l21.61"></a><span id="l21.61">   return aServer-&gt;GetServerURI(mIncomingServerUri);</span>
<a href="#l21.62"></a><span id="l21.62"> }</span>
<a href="#l21.63"></a><span id="l21.63"> </span>
<a href="#l21.64"></a><span id="l21.64"> NS_IMETHODIMP</span>
<a href="#l21.65"></a><span id="l21.65" class="difflineminus">-nsSubscribableServer::GetDelimiter(char *aDelimiter)</span>
<a href="#l21.66"></a><span id="l21.66" class="difflineminus">-{</span>
<a href="#l21.67"></a><span id="l21.67" class="difflineplus">+nsSubscribableServer::GetDelimiter(char *aDelimiter) {</span>
<a href="#l21.68"></a><span id="l21.68">   NS_ENSURE_ARG_POINTER(aDelimiter);</span>
<a href="#l21.69"></a><span id="l21.69">   *aDelimiter = mDelimiter;</span>
<a href="#l21.70"></a><span id="l21.70">   return NS_OK;</span>
<a href="#l21.71"></a><span id="l21.71"> }</span>
<a href="#l21.72"></a><span id="l21.72"> </span>
<a href="#l21.73"></a><span id="l21.73"> NS_IMETHODIMP</span>
<a href="#l21.74"></a><span id="l21.74" class="difflineminus">-nsSubscribableServer::SetDelimiter(char aDelimiter)</span>
<a href="#l21.75"></a><span id="l21.75" class="difflineminus">-{</span>
<a href="#l21.76"></a><span id="l21.76" class="difflineplus">+nsSubscribableServer::SetDelimiter(char aDelimiter) {</span>
<a href="#l21.77"></a><span id="l21.77">   mDelimiter = aDelimiter;</span>
<a href="#l21.78"></a><span id="l21.78">   return NS_OK;</span>
<a href="#l21.79"></a><span id="l21.79"> }</span>
<a href="#l21.80"></a><span id="l21.80"> </span>
<a href="#l21.81"></a><span id="l21.81"> NS_IMETHODIMP</span>
<a href="#l21.82"></a><span id="l21.82" class="difflineminus">-nsSubscribableServer::SetAsSubscribed(const nsACString &amp;path)</span>
<a href="#l21.83"></a><span id="l21.83" class="difflineminus">-{</span>
<a href="#l21.84"></a><span id="l21.84" class="difflineminus">-    nsresult rv = NS_OK;</span>
<a href="#l21.85"></a><span id="l21.85" class="difflineplus">+nsSubscribableServer::SetAsSubscribed(const nsACString &amp;path) {</span>
<a href="#l21.86"></a><span id="l21.86" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l21.87"></a><span id="l21.87" class="difflineplus">+</span>
<a href="#l21.88"></a><span id="l21.88" class="difflineplus">+  SubscribeTreeNode *node = nullptr;</span>
<a href="#l21.89"></a><span id="l21.89" class="difflineplus">+  rv = FindAndCreateNode(path, &amp;node);</span>
<a href="#l21.90"></a><span id="l21.90" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.91"></a><span id="l21.91"> </span>
<a href="#l21.92"></a><span id="l21.92" class="difflineminus">-    SubscribeTreeNode *node = nullptr;</span>
<a href="#l21.93"></a><span id="l21.93" class="difflineminus">-    rv = FindAndCreateNode(path, &amp;node);</span>
<a href="#l21.94"></a><span id="l21.94" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l21.95"></a><span id="l21.95" class="difflineplus">+  NS_ASSERTION(node, &quot;didn't find the node&quot;);</span>
<a href="#l21.96"></a><span id="l21.96" class="difflineplus">+  if (!node) return NS_ERROR_FAILURE;</span>
<a href="#l21.97"></a><span id="l21.97" class="difflineplus">+  node-&gt;isSubscribable = true;</span>
<a href="#l21.98"></a><span id="l21.98" class="difflineplus">+  node-&gt;isSubscribed = true;</span>
<a href="#l21.99"></a><span id="l21.99"> </span>
<a href="#l21.100"></a><span id="l21.100" class="difflineminus">-    NS_ASSERTION(node,&quot;didn't find the node&quot;);</span>
<a href="#l21.101"></a><span id="l21.101" class="difflineminus">-    if (!node) return NS_ERROR_FAILURE;</span>
<a href="#l21.102"></a><span id="l21.102" class="difflineminus">-    node-&gt;isSubscribable = true;</span>
<a href="#l21.103"></a><span id="l21.103" class="difflineminus">-    node-&gt;isSubscribed = true;</span>
<a href="#l21.104"></a><span id="l21.104" class="difflineminus">-</span>
<a href="#l21.105"></a><span id="l21.105" class="difflineminus">-    return rv;</span>
<a href="#l21.106"></a><span id="l21.106" class="difflineplus">+  return rv;</span>
<a href="#l21.107"></a><span id="l21.107"> }</span>
<a href="#l21.108"></a><span id="l21.108"> </span>
<a href="#l21.109"></a><span id="l21.109"> NS_IMETHODIMP</span>
<a href="#l21.110"></a><span id="l21.110" class="difflineminus">-nsSubscribableServer::AddTo(const nsACString&amp; aName, bool aAddAsSubscribed,</span>
<a href="#l21.111"></a><span id="l21.111" class="difflineminus">-                            bool aSubscribable, bool aChangeIfExists)</span>
<a href="#l21.112"></a><span id="l21.112" class="difflineminus">-{</span>
<a href="#l21.113"></a><span id="l21.113" class="difflineminus">-    nsresult rv = NS_OK;</span>
<a href="#l21.114"></a><span id="l21.114" class="difflineplus">+nsSubscribableServer::AddTo(const nsACString &amp;aName, bool aAddAsSubscribed,</span>
<a href="#l21.115"></a><span id="l21.115" class="difflineplus">+                            bool aSubscribable, bool aChangeIfExists) {</span>
<a href="#l21.116"></a><span id="l21.116" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l21.117"></a><span id="l21.117"> </span>
<a href="#l21.118"></a><span id="l21.118" class="difflineminus">-    if (mStopped) {</span>
<a href="#l21.119"></a><span id="l21.119" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l21.120"></a><span id="l21.120" class="difflineminus">-    }</span>
<a href="#l21.121"></a><span id="l21.121" class="difflineplus">+  if (mStopped) {</span>
<a href="#l21.122"></a><span id="l21.122" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l21.123"></a><span id="l21.123" class="difflineplus">+  }</span>
<a href="#l21.124"></a><span id="l21.124"> </span>
<a href="#l21.125"></a><span id="l21.125" class="difflineminus">-    SubscribeTreeNode *node = nullptr;</span>
<a href="#l21.126"></a><span id="l21.126" class="difflineplus">+  SubscribeTreeNode *node = nullptr;</span>
<a href="#l21.127"></a><span id="l21.127"> </span>
<a href="#l21.128"></a><span id="l21.128" class="difflineminus">-    // todo, shouldn't we pass in aAddAsSubscribed, for the</span>
<a href="#l21.129"></a><span id="l21.129" class="difflineminus">-    // default value if we create it?</span>
<a href="#l21.130"></a><span id="l21.130" class="difflineminus">-    rv = FindAndCreateNode(aName, &amp;node);</span>
<a href="#l21.131"></a><span id="l21.131" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l21.132"></a><span id="l21.132" class="difflineminus">-    NS_ASSERTION(node,&quot;didn't find the node&quot;);</span>
<a href="#l21.133"></a><span id="l21.133" class="difflineminus">-    if (!node) return NS_ERROR_FAILURE;</span>
<a href="#l21.134"></a><span id="l21.134" class="difflineplus">+  // todo, shouldn't we pass in aAddAsSubscribed, for the</span>
<a href="#l21.135"></a><span id="l21.135" class="difflineplus">+  // default value if we create it?</span>
<a href="#l21.136"></a><span id="l21.136" class="difflineplus">+  rv = FindAndCreateNode(aName, &amp;node);</span>
<a href="#l21.137"></a><span id="l21.137" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.138"></a><span id="l21.138" class="difflineplus">+  NS_ASSERTION(node, &quot;didn't find the node&quot;);</span>
<a href="#l21.139"></a><span id="l21.139" class="difflineplus">+  if (!node) return NS_ERROR_FAILURE;</span>
<a href="#l21.140"></a><span id="l21.140"> </span>
<a href="#l21.141"></a><span id="l21.141" class="difflineminus">-    if (aChangeIfExists) {</span>
<a href="#l21.142"></a><span id="l21.142" class="difflineminus">-        node-&gt;isSubscribed = aAddAsSubscribed;</span>
<a href="#l21.143"></a><span id="l21.143" class="difflineminus">-    }</span>
<a href="#l21.144"></a><span id="l21.144" class="difflineplus">+  if (aChangeIfExists) {</span>
<a href="#l21.145"></a><span id="l21.145" class="difflineplus">+    node-&gt;isSubscribed = aAddAsSubscribed;</span>
<a href="#l21.146"></a><span id="l21.146" class="difflineplus">+  }</span>
<a href="#l21.147"></a><span id="l21.147"> </span>
<a href="#l21.148"></a><span id="l21.148" class="difflineminus">-    node-&gt;isSubscribable = aSubscribable;</span>
<a href="#l21.149"></a><span id="l21.149" class="difflineplus">+  node-&gt;isSubscribable = aSubscribable;</span>
<a href="#l21.150"></a><span id="l21.150"> </span>
<a href="#l21.151"></a><span id="l21.151" class="difflineminus">-    return NS_OK;</span>
<a href="#l21.152"></a><span id="l21.152" class="difflineplus">+  return NS_OK;</span>
<a href="#l21.153"></a><span id="l21.153"> }</span>
<a href="#l21.154"></a><span id="l21.154"> </span>
<a href="#l21.155"></a><span id="l21.155"> NS_IMETHODIMP</span>
<a href="#l21.156"></a><span id="l21.156"> nsSubscribableServer::SetState(const nsACString &amp;aPath, bool aState,</span>
<a href="#l21.157"></a><span id="l21.157" class="difflineminus">-                               bool *aStateChanged)</span>
<a href="#l21.158"></a><span id="l21.158" class="difflineminus">-{</span>
<a href="#l21.159"></a><span id="l21.159" class="difflineminus">-    nsresult rv = NS_OK;</span>
<a href="#l21.160"></a><span id="l21.160" class="difflineminus">-    NS_ASSERTION(!aPath.IsEmpty() &amp;&amp; aStateChanged, &quot;no path or stateChanged&quot;);</span>
<a href="#l21.161"></a><span id="l21.161" class="difflineminus">-    if (aPath.IsEmpty() || !aStateChanged) return NS_ERROR_NULL_POINTER;</span>
<a href="#l21.162"></a><span id="l21.162" class="difflineplus">+                               bool *aStateChanged) {</span>
<a href="#l21.163"></a><span id="l21.163" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l21.164"></a><span id="l21.164" class="difflineplus">+  NS_ASSERTION(!aPath.IsEmpty() &amp;&amp; aStateChanged, &quot;no path or stateChanged&quot;);</span>
<a href="#l21.165"></a><span id="l21.165" class="difflineplus">+  if (aPath.IsEmpty() || !aStateChanged) return NS_ERROR_NULL_POINTER;</span>
<a href="#l21.166"></a><span id="l21.166"> </span>
<a href="#l21.167"></a><span id="l21.167" class="difflineminus">-    NS_ASSERTION(MsgIsUTF8(aPath), &quot;aPath is not in UTF-8&quot;);</span>
<a href="#l21.168"></a><span id="l21.168" class="difflineplus">+  NS_ASSERTION(MsgIsUTF8(aPath), &quot;aPath is not in UTF-8&quot;);</span>
<a href="#l21.169"></a><span id="l21.169"> </span>
<a href="#l21.170"></a><span id="l21.170" class="difflineminus">-    *aStateChanged = false;</span>
<a href="#l21.171"></a><span id="l21.171" class="difflineplus">+  *aStateChanged = false;</span>
<a href="#l21.172"></a><span id="l21.172"> </span>
<a href="#l21.173"></a><span id="l21.173" class="difflineminus">-    SubscribeTreeNode *node = nullptr;</span>
<a href="#l21.174"></a><span id="l21.174" class="difflineminus">-    rv = FindAndCreateNode(aPath, &amp;node);</span>
<a href="#l21.175"></a><span id="l21.175" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l21.176"></a><span id="l21.176" class="difflineplus">+  SubscribeTreeNode *node = nullptr;</span>
<a href="#l21.177"></a><span id="l21.177" class="difflineplus">+  rv = FindAndCreateNode(aPath, &amp;node);</span>
<a href="#l21.178"></a><span id="l21.178" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.179"></a><span id="l21.179"> </span>
<a href="#l21.180"></a><span id="l21.180" class="difflineminus">-    NS_ASSERTION(node,&quot;didn't find the node&quot;);</span>
<a href="#l21.181"></a><span id="l21.181" class="difflineminus">-    if (!node) return NS_ERROR_FAILURE;</span>
<a href="#l21.182"></a><span id="l21.182" class="difflineplus">+  NS_ASSERTION(node, &quot;didn't find the node&quot;);</span>
<a href="#l21.183"></a><span id="l21.183" class="difflineplus">+  if (!node) return NS_ERROR_FAILURE;</span>
<a href="#l21.184"></a><span id="l21.184"> </span>
<a href="#l21.185"></a><span id="l21.185" class="difflineminus">-    NS_ASSERTION(node-&gt;isSubscribable, &quot;fix this&quot;);</span>
<a href="#l21.186"></a><span id="l21.186" class="difflineminus">-    if (!node-&gt;isSubscribable) {</span>
<a href="#l21.187"></a><span id="l21.187" class="difflineminus">-        return NS_OK;</span>
<a href="#l21.188"></a><span id="l21.188" class="difflineminus">-    }</span>
<a href="#l21.189"></a><span id="l21.189" class="difflineplus">+  NS_ASSERTION(node-&gt;isSubscribable, &quot;fix this&quot;);</span>
<a href="#l21.190"></a><span id="l21.190" class="difflineplus">+  if (!node-&gt;isSubscribable) {</span>
<a href="#l21.191"></a><span id="l21.191" class="difflineplus">+    return NS_OK;</span>
<a href="#l21.192"></a><span id="l21.192" class="difflineplus">+  }</span>
<a href="#l21.193"></a><span id="l21.193"> </span>
<a href="#l21.194"></a><span id="l21.194" class="difflineminus">-    if (node-&gt;isSubscribed == aState) {</span>
<a href="#l21.195"></a><span id="l21.195" class="difflineminus">-        return NS_OK;</span>
<a href="#l21.196"></a><span id="l21.196" class="difflineplus">+  if (node-&gt;isSubscribed == aState) {</span>
<a href="#l21.197"></a><span id="l21.197" class="difflineplus">+    return NS_OK;</span>
<a href="#l21.198"></a><span id="l21.198" class="difflineplus">+  } else {</span>
<a href="#l21.199"></a><span id="l21.199" class="difflineplus">+    node-&gt;isSubscribed = aState;</span>
<a href="#l21.200"></a><span id="l21.200" class="difflineplus">+    *aStateChanged = true;</span>
<a href="#l21.201"></a><span id="l21.201" class="difflineplus">+</span>
<a href="#l21.202"></a><span id="l21.202" class="difflineplus">+    // Repaint the tree row to show/clear the check mark.</span>
<a href="#l21.203"></a><span id="l21.203" class="difflineplus">+    if (mTree) {</span>
<a href="#l21.204"></a><span id="l21.204" class="difflineplus">+      bool dummy;</span>
<a href="#l21.205"></a><span id="l21.205" class="difflineplus">+      int32_t index = GetRow(node, &amp;dummy);</span>
<a href="#l21.206"></a><span id="l21.206" class="difflineplus">+      if (index &gt;= 0) mTree-&gt;InvalidateRow(index);</span>
<a href="#l21.207"></a><span id="l21.207">     }</span>
<a href="#l21.208"></a><span id="l21.208" class="difflineminus">-    else {</span>
<a href="#l21.209"></a><span id="l21.209" class="difflineminus">-        node-&gt;isSubscribed = aState;</span>
<a href="#l21.210"></a><span id="l21.210" class="difflineminus">-        *aStateChanged = true;</span>
<a href="#l21.211"></a><span id="l21.211" class="difflineminus">-</span>
<a href="#l21.212"></a><span id="l21.212" class="difflineminus">-        // Repaint the tree row to show/clear the check mark.</span>
<a href="#l21.213"></a><span id="l21.213" class="difflineminus">-        if (mTree) {</span>
<a href="#l21.214"></a><span id="l21.214" class="difflineminus">-          bool dummy;</span>
<a href="#l21.215"></a><span id="l21.215" class="difflineminus">-          int32_t index = GetRow(node, &amp;dummy);</span>
<a href="#l21.216"></a><span id="l21.216" class="difflineminus">-          if (index &gt;= 0)</span>
<a href="#l21.217"></a><span id="l21.217" class="difflineminus">-            mTree-&gt;InvalidateRow(index);</span>
<a href="#l21.218"></a><span id="l21.218" class="difflineminus">-        }</span>
<a href="#l21.219"></a><span id="l21.219" class="difflineminus">-    }</span>
<a href="#l21.220"></a><span id="l21.220" class="difflineminus">-    return NS_OK;</span>
<a href="#l21.221"></a><span id="l21.221" class="difflineplus">+  }</span>
<a href="#l21.222"></a><span id="l21.222" class="difflineplus">+  return NS_OK;</span>
<a href="#l21.223"></a><span id="l21.223"> }</span>
<a href="#l21.224"></a><span id="l21.224"> </span>
<a href="#l21.225"></a><span id="l21.225"> NS_IMETHODIMP</span>
<a href="#l21.226"></a><span id="l21.226" class="difflineminus">-nsSubscribableServer::SetSubscribeListener(nsISubscribeListener *aListener)</span>
<a href="#l21.227"></a><span id="l21.227" class="difflineminus">-{</span>
<a href="#l21.228"></a><span id="l21.228" class="difflineplus">+nsSubscribableServer::SetSubscribeListener(nsISubscribeListener *aListener) {</span>
<a href="#l21.229"></a><span id="l21.229">   mSubscribeListener = aListener;</span>
<a href="#l21.230"></a><span id="l21.230">   return NS_OK;</span>
<a href="#l21.231"></a><span id="l21.231"> }</span>
<a href="#l21.232"></a><span id="l21.232"> </span>
<a href="#l21.233"></a><span id="l21.233"> NS_IMETHODIMP</span>
<a href="#l21.234"></a><span id="l21.234" class="difflineminus">-nsSubscribableServer::GetSubscribeListener(nsISubscribeListener **aListener)</span>
<a href="#l21.235"></a><span id="l21.235" class="difflineminus">-{</span>
<a href="#l21.236"></a><span id="l21.236" class="difflineplus">+nsSubscribableServer::GetSubscribeListener(nsISubscribeListener **aListener) {</span>
<a href="#l21.237"></a><span id="l21.237">   NS_ENSURE_ARG_POINTER(aListener);</span>
<a href="#l21.238"></a><span id="l21.238">   NS_IF_ADDREF(*aListener = mSubscribeListener);</span>
<a href="#l21.239"></a><span id="l21.239">   return NS_OK;</span>
<a href="#l21.240"></a><span id="l21.240"> }</span>
<a href="#l21.241"></a><span id="l21.241"> </span>
<a href="#l21.242"></a><span id="l21.242"> NS_IMETHODIMP</span>
<a href="#l21.243"></a><span id="l21.243" class="difflineminus">-nsSubscribableServer::SubscribeCleanup()</span>
<a href="#l21.244"></a><span id="l21.244" class="difflineminus">-{</span>
<a href="#l21.245"></a><span id="l21.245" class="difflineminus">-  NS_ASSERTION(false,&quot;override this.&quot;);</span>
<a href="#l21.246"></a><span id="l21.246" class="difflineplus">+nsSubscribableServer::SubscribeCleanup() {</span>
<a href="#l21.247"></a><span id="l21.247" class="difflineplus">+  NS_ASSERTION(false, &quot;override this.&quot;);</span>
<a href="#l21.248"></a><span id="l21.248">   return NS_ERROR_FAILURE;</span>
<a href="#l21.249"></a><span id="l21.249"> }</span>
<a href="#l21.250"></a><span id="l21.250"> </span>
<a href="#l21.251"></a><span id="l21.251"> NS_IMETHODIMP</span>
<a href="#l21.252"></a><span id="l21.252" class="difflineminus">-nsSubscribableServer::StartPopulatingWithUri(nsIMsgWindow *aMsgWindow, bool aForceToServer, const char *uri)</span>
<a href="#l21.253"></a><span id="l21.253" class="difflineminus">-{</span>
<a href="#l21.254"></a><span id="l21.254" class="difflineminus">-    mStopped = false;</span>
<a href="#l21.255"></a><span id="l21.255" class="difflineminus">-    return NS_OK;</span>
<a href="#l21.256"></a><span id="l21.256" class="difflineplus">+nsSubscribableServer::StartPopulatingWithUri(nsIMsgWindow *aMsgWindow,</span>
<a href="#l21.257"></a><span id="l21.257" class="difflineplus">+                                             bool aForceToServer,</span>
<a href="#l21.258"></a><span id="l21.258" class="difflineplus">+                                             const char *uri) {</span>
<a href="#l21.259"></a><span id="l21.259" class="difflineplus">+  mStopped = false;</span>
<a href="#l21.260"></a><span id="l21.260" class="difflineplus">+  return NS_OK;</span>
<a href="#l21.261"></a><span id="l21.261"> }</span>
<a href="#l21.262"></a><span id="l21.262"> </span>
<a href="#l21.263"></a><span id="l21.263"> NS_IMETHODIMP</span>
<a href="#l21.264"></a><span id="l21.264" class="difflineminus">-nsSubscribableServer::StartPopulating(nsIMsgWindow *aMsgWindow, bool aForceToServer, bool aGetOnlyNew /*ignored*/)</span>
<a href="#l21.265"></a><span id="l21.265" class="difflineminus">-{</span>
<a href="#l21.266"></a><span id="l21.266" class="difflineminus">-    mStopped = false;</span>
<a href="#l21.267"></a><span id="l21.267" class="difflineplus">+nsSubscribableServer::StartPopulating(nsIMsgWindow *aMsgWindow,</span>
<a href="#l21.268"></a><span id="l21.268" class="difflineplus">+                                      bool aForceToServer,</span>
<a href="#l21.269"></a><span id="l21.269" class="difflineplus">+                                      bool aGetOnlyNew /*ignored*/) {</span>
<a href="#l21.270"></a><span id="l21.270" class="difflineplus">+  mStopped = false;</span>
<a href="#l21.271"></a><span id="l21.271"> </span>
<a href="#l21.272"></a><span id="l21.272" class="difflineminus">-    nsresult rv = FreeRows();</span>
<a href="#l21.273"></a><span id="l21.273" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.274"></a><span id="l21.274" class="difflineplus">+  nsresult rv = FreeRows();</span>
<a href="#l21.275"></a><span id="l21.275" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.276"></a><span id="l21.276"> </span>
<a href="#l21.277"></a><span id="l21.277" class="difflineminus">-    rv = FreeSubtree(mTreeRoot);</span>
<a href="#l21.278"></a><span id="l21.278" class="difflineminus">-    mTreeRoot = nullptr;</span>
<a href="#l21.279"></a><span id="l21.279" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l21.280"></a><span id="l21.280" class="difflineminus">-    return NS_OK;</span>
<a href="#l21.281"></a><span id="l21.281" class="difflineplus">+  rv = FreeSubtree(mTreeRoot);</span>
<a href="#l21.282"></a><span id="l21.282" class="difflineplus">+  mTreeRoot = nullptr;</span>
<a href="#l21.283"></a><span id="l21.283" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.284"></a><span id="l21.284" class="difflineplus">+  return NS_OK;</span>
<a href="#l21.285"></a><span id="l21.285"> }</span>
<a href="#l21.286"></a><span id="l21.286"> </span>
<a href="#l21.287"></a><span id="l21.287"> NS_IMETHODIMP</span>
<a href="#l21.288"></a><span id="l21.288" class="difflineminus">-nsSubscribableServer::StopPopulating(nsIMsgWindow *aMsgWindow)</span>
<a href="#l21.289"></a><span id="l21.289" class="difflineminus">-{</span>
<a href="#l21.290"></a><span id="l21.290" class="difflineplus">+nsSubscribableServer::StopPopulating(nsIMsgWindow *aMsgWindow) {</span>
<a href="#l21.291"></a><span id="l21.291">   mStopped = true;</span>
<a href="#l21.292"></a><span id="l21.292"> </span>
<a href="#l21.293"></a><span id="l21.293">   nsresult rv = FreeRows();</span>
<a href="#l21.294"></a><span id="l21.294">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.295"></a><span id="l21.295"> </span>
<a href="#l21.296"></a><span id="l21.296">   if (mTreeRoot) {</span>
<a href="#l21.297"></a><span id="l21.297">     SubscribeTreeNode *node = mTreeRoot-&gt;lastChild;</span>
<a href="#l21.298"></a><span id="l21.298">     // Add top level items as closed.</span>
<a href="#l21.299"></a><span id="l21.299" class="difflineminus">-    while (node)</span>
<a href="#l21.300"></a><span id="l21.300" class="difflineminus">-    {</span>
<a href="#l21.301"></a><span id="l21.301" class="difflineplus">+    while (node) {</span>
<a href="#l21.302"></a><span id="l21.302">       node-&gt;isOpen = false;</span>
<a href="#l21.303"></a><span id="l21.303">       mRowMap.AppendElement(node);</span>
<a href="#l21.304"></a><span id="l21.304">       node = node-&gt;prevSibling;</span>
<a href="#l21.305"></a><span id="l21.305">     }</span>
<a href="#l21.306"></a><span id="l21.306"> </span>
<a href="#l21.307"></a><span id="l21.307">     // Invalidate the whole thing.</span>
<a href="#l21.308"></a><span id="l21.308" class="difflineminus">-    if (mTree)</span>
<a href="#l21.309"></a><span id="l21.309" class="difflineminus">-      mTree-&gt;RowCountChanged(0, mRowMap.Length());</span>
<a href="#l21.310"></a><span id="l21.310" class="difflineplus">+    if (mTree) mTree-&gt;RowCountChanged(0, mRowMap.Length());</span>
<a href="#l21.311"></a><span id="l21.311"> </span>
<a href="#l21.312"></a><span id="l21.312">     // Open all the top level items if they are containers.</span>
<a href="#l21.313"></a><span id="l21.313">     uint32_t topRows = mRowMap.Length();</span>
<a href="#l21.314"></a><span id="l21.314">     for (int32_t i = topRows - 1; i &gt;= 0; i--) {</span>
<a href="#l21.315"></a><span id="l21.315">       bool isContainer = false;</span>
<a href="#l21.316"></a><span id="l21.316">       IsContainer(i, &amp;isContainer);</span>
<a href="#l21.317"></a><span id="l21.317" class="difflineminus">-      if (isContainer)</span>
<a href="#l21.318"></a><span id="l21.318" class="difflineminus">-        ToggleOpenState(i);</span>
<a href="#l21.319"></a><span id="l21.319" class="difflineplus">+      if (isContainer) ToggleOpenState(i);</span>
<a href="#l21.320"></a><span id="l21.320">     }</span>
<a href="#l21.321"></a><span id="l21.321">   }</span>
<a href="#l21.322"></a><span id="l21.322"> </span>
<a href="#l21.323"></a><span id="l21.323" class="difflineminus">-  if (mSubscribeListener)</span>
<a href="#l21.324"></a><span id="l21.324" class="difflineminus">-    mSubscribeListener-&gt;OnDonePopulating();</span>
<a href="#l21.325"></a><span id="l21.325" class="difflineplus">+  if (mSubscribeListener) mSubscribeListener-&gt;OnDonePopulating();</span>
<a href="#l21.326"></a><span id="l21.326"> </span>
<a href="#l21.327"></a><span id="l21.327">   return NS_OK;</span>
<a href="#l21.328"></a><span id="l21.328"> }</span>
<a href="#l21.329"></a><span id="l21.329"> </span>
<a href="#l21.330"></a><span id="l21.330" class="difflineminus">-</span>
<a href="#l21.331"></a><span id="l21.331"> NS_IMETHODIMP</span>
<a href="#l21.332"></a><span id="l21.332" class="difflineminus">-nsSubscribableServer::UpdateSubscribed()</span>
<a href="#l21.333"></a><span id="l21.333" class="difflineminus">-{</span>
<a href="#l21.334"></a><span id="l21.334" class="difflineminus">-  NS_ASSERTION(false,&quot;override this.&quot;);</span>
<a href="#l21.335"></a><span id="l21.335" class="difflineplus">+nsSubscribableServer::UpdateSubscribed() {</span>
<a href="#l21.336"></a><span id="l21.336" class="difflineplus">+  NS_ASSERTION(false, &quot;override this.&quot;);</span>
<a href="#l21.337"></a><span id="l21.337">   return NS_ERROR_FAILURE;</span>
<a href="#l21.338"></a><span id="l21.338"> }</span>
<a href="#l21.339"></a><span id="l21.339"> </span>
<a href="#l21.340"></a><span id="l21.340"> NS_IMETHODIMP</span>
<a href="#l21.341"></a><span id="l21.341" class="difflineminus">-nsSubscribableServer::Subscribe(const char16_t *aName)</span>
<a href="#l21.342"></a><span id="l21.342" class="difflineminus">-{</span>
<a href="#l21.343"></a><span id="l21.343" class="difflineminus">-  NS_ASSERTION(false,&quot;override this.&quot;);</span>
<a href="#l21.344"></a><span id="l21.344" class="difflineplus">+nsSubscribableServer::Subscribe(const char16_t *aName) {</span>
<a href="#l21.345"></a><span id="l21.345" class="difflineplus">+  NS_ASSERTION(false, &quot;override this.&quot;);</span>
<a href="#l21.346"></a><span id="l21.346">   return NS_ERROR_FAILURE;</span>
<a href="#l21.347"></a><span id="l21.347"> }</span>
<a href="#l21.348"></a><span id="l21.348"> </span>
<a href="#l21.349"></a><span id="l21.349"> NS_IMETHODIMP</span>
<a href="#l21.350"></a><span id="l21.350" class="difflineminus">-nsSubscribableServer::Unsubscribe(const char16_t *aName)</span>
<a href="#l21.351"></a><span id="l21.351" class="difflineminus">-{</span>
<a href="#l21.352"></a><span id="l21.352" class="difflineminus">-  NS_ASSERTION(false,&quot;override this.&quot;);</span>
<a href="#l21.353"></a><span id="l21.353" class="difflineplus">+nsSubscribableServer::Unsubscribe(const char16_t *aName) {</span>
<a href="#l21.354"></a><span id="l21.354" class="difflineplus">+  NS_ASSERTION(false, &quot;override this.&quot;);</span>
<a href="#l21.355"></a><span id="l21.355">   return NS_ERROR_FAILURE;</span>
<a href="#l21.356"></a><span id="l21.356"> }</span>
<a href="#l21.357"></a><span id="l21.357"> </span>
<a href="#l21.358"></a><span id="l21.358"> NS_IMETHODIMP</span>
<a href="#l21.359"></a><span id="l21.359" class="difflineminus">-nsSubscribableServer::SetShowFullName(bool showFullName)</span>
<a href="#l21.360"></a><span id="l21.360" class="difflineminus">-{</span>
<a href="#l21.361"></a><span id="l21.361" class="difflineplus">+nsSubscribableServer::SetShowFullName(bool showFullName) {</span>
<a href="#l21.362"></a><span id="l21.362">   mShowFullName = showFullName;</span>
<a href="#l21.363"></a><span id="l21.363">   return NS_OK;</span>
<a href="#l21.364"></a><span id="l21.364"> }</span>
<a href="#l21.365"></a><span id="l21.365"> </span>
<a href="#l21.366"></a><span id="l21.366" class="difflineminus">-nsresult</span>
<a href="#l21.367"></a><span id="l21.367" class="difflineminus">-nsSubscribableServer::FreeSubtree(SubscribeTreeNode *node)</span>
<a href="#l21.368"></a><span id="l21.368" class="difflineminus">-{</span>
<a href="#l21.369"></a><span id="l21.369" class="difflineminus">-    nsresult rv = NS_OK;</span>
<a href="#l21.370"></a><span id="l21.370" class="difflineplus">+nsresult nsSubscribableServer::FreeSubtree(SubscribeTreeNode *node) {</span>
<a href="#l21.371"></a><span id="l21.371" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l21.372"></a><span id="l21.372"> </span>
<a href="#l21.373"></a><span id="l21.373" class="difflineminus">-    if (node) {</span>
<a href="#l21.374"></a><span id="l21.374" class="difflineminus">-        // recursively free the children</span>
<a href="#l21.375"></a><span id="l21.375" class="difflineminus">-        if (node-&gt;firstChild) {</span>
<a href="#l21.376"></a><span id="l21.376" class="difflineminus">-            // will free node-&gt;firstChild</span>
<a href="#l21.377"></a><span id="l21.377" class="difflineminus">-            rv = FreeSubtree(node-&gt;firstChild);</span>
<a href="#l21.378"></a><span id="l21.378" class="difflineminus">-            NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l21.379"></a><span id="l21.379" class="difflineminus">-            node-&gt;firstChild = nullptr;</span>
<a href="#l21.380"></a><span id="l21.380" class="difflineminus">-        }</span>
<a href="#l21.381"></a><span id="l21.381" class="difflineplus">+  if (node) {</span>
<a href="#l21.382"></a><span id="l21.382" class="difflineplus">+    // recursively free the children</span>
<a href="#l21.383"></a><span id="l21.383" class="difflineplus">+    if (node-&gt;firstChild) {</span>
<a href="#l21.384"></a><span id="l21.384" class="difflineplus">+      // will free node-&gt;firstChild</span>
<a href="#l21.385"></a><span id="l21.385" class="difflineplus">+      rv = FreeSubtree(node-&gt;firstChild);</span>
<a href="#l21.386"></a><span id="l21.386" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.387"></a><span id="l21.387" class="difflineplus">+      node-&gt;firstChild = nullptr;</span>
<a href="#l21.388"></a><span id="l21.388" class="difflineplus">+    }</span>
<a href="#l21.389"></a><span id="l21.389"> </span>
<a href="#l21.390"></a><span id="l21.390" class="difflineminus">-        // recursively free the siblings</span>
<a href="#l21.391"></a><span id="l21.391" class="difflineminus">-        if (node-&gt;nextSibling) {</span>
<a href="#l21.392"></a><span id="l21.392" class="difflineminus">-            // will free node-&gt;nextSibling</span>
<a href="#l21.393"></a><span id="l21.393" class="difflineminus">-            rv = FreeSubtree(node-&gt;nextSibling);</span>
<a href="#l21.394"></a><span id="l21.394" class="difflineminus">-            NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l21.395"></a><span id="l21.395" class="difflineminus">-            node-&gt;nextSibling = nullptr;</span>
<a href="#l21.396"></a><span id="l21.396" class="difflineminus">-        }</span>
<a href="#l21.397"></a><span id="l21.397" class="difflineplus">+    // recursively free the siblings</span>
<a href="#l21.398"></a><span id="l21.398" class="difflineplus">+    if (node-&gt;nextSibling) {</span>
<a href="#l21.399"></a><span id="l21.399" class="difflineplus">+      // will free node-&gt;nextSibling</span>
<a href="#l21.400"></a><span id="l21.400" class="difflineplus">+      rv = FreeSubtree(node-&gt;nextSibling);</span>
<a href="#l21.401"></a><span id="l21.401" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.402"></a><span id="l21.402" class="difflineplus">+      node-&gt;nextSibling = nullptr;</span>
<a href="#l21.403"></a><span id="l21.403" class="difflineplus">+    }</span>
<a href="#l21.404"></a><span id="l21.404"> </span>
<a href="#l21.405"></a><span id="l21.405"> #ifdef HAVE_SUBSCRIBE_DESCRIPTION</span>
<a href="#l21.406"></a><span id="l21.406" class="difflineminus">-        NS_ASSERTION(node-&gt;description == nullptr, &quot;you need to free the description&quot;);</span>
<a href="#l21.407"></a><span id="l21.407" class="difflineplus">+    NS_ASSERTION(node-&gt;description == nullptr,</span>
<a href="#l21.408"></a><span id="l21.408" class="difflineplus">+                 &quot;you need to free the description&quot;);</span>
<a href="#l21.409"></a><span id="l21.409"> #endif</span>
<a href="#l21.410"></a><span id="l21.410" class="difflineminus">-        free(node-&gt;name);</span>
<a href="#l21.411"></a><span id="l21.411" class="difflineplus">+    free(node-&gt;name);</span>
<a href="#l21.412"></a><span id="l21.412"> #if 0</span>
<a href="#l21.413"></a><span id="l21.413" class="difflineminus">-        node-&gt;name = nullptr;</span>
<a href="#l21.414"></a><span id="l21.414" class="difflineminus">-        node-&gt;parent = nullptr;</span>
<a href="#l21.415"></a><span id="l21.415" class="difflineminus">-        node-&gt;lastChild = nullptr;</span>
<a href="#l21.416"></a><span id="l21.416" class="difflineminus">-        node-&gt;cachedChild = nullptr;</span>
<a href="#l21.417"></a><span id="l21.417" class="difflineplus">+    node-&gt;name = nullptr;</span>
<a href="#l21.418"></a><span id="l21.418" class="difflineplus">+    node-&gt;parent = nullptr;</span>
<a href="#l21.419"></a><span id="l21.419" class="difflineplus">+    node-&gt;lastChild = nullptr;</span>
<a href="#l21.420"></a><span id="l21.420" class="difflineplus">+    node-&gt;cachedChild = nullptr;</span>
<a href="#l21.421"></a><span id="l21.421"> #endif</span>
<a href="#l21.422"></a><span id="l21.422"> </span>
<a href="#l21.423"></a><span id="l21.423" class="difflineminus">-        delete node;</span>
<a href="#l21.424"></a><span id="l21.424" class="difflineminus">-    }</span>
<a href="#l21.425"></a><span id="l21.425" class="difflineplus">+    delete node;</span>
<a href="#l21.426"></a><span id="l21.426" class="difflineplus">+  }</span>
<a href="#l21.427"></a><span id="l21.427"> </span>
<a href="#l21.428"></a><span id="l21.428" class="difflineminus">-    return NS_OK;</span>
<a href="#l21.429"></a><span id="l21.429" class="difflineplus">+  return NS_OK;</span>
<a href="#l21.430"></a><span id="l21.430"> }</span>
<a href="#l21.431"></a><span id="l21.431"> </span>
<a href="#l21.432"></a><span id="l21.432" class="difflineminus">-nsresult</span>
<a href="#l21.433"></a><span id="l21.433" class="difflineminus">-nsSubscribableServer::FreeRows()</span>
<a href="#l21.434"></a><span id="l21.434" class="difflineminus">-{</span>
<a href="#l21.435"></a><span id="l21.435" class="difflineplus">+nsresult nsSubscribableServer::FreeRows() {</span>
<a href="#l21.436"></a><span id="l21.436">   int32_t rowCount = mRowMap.Length();</span>
<a href="#l21.437"></a><span id="l21.437">   mRowMap.Clear();</span>
<a href="#l21.438"></a><span id="l21.438" class="difflineminus">-  if (mTree)</span>
<a href="#l21.439"></a><span id="l21.439" class="difflineminus">-    mTree-&gt;RowCountChanged(0, -rowCount);</span>
<a href="#l21.440"></a><span id="l21.440" class="difflineplus">+  if (mTree) mTree-&gt;RowCountChanged(0, -rowCount);</span>
<a href="#l21.441"></a><span id="l21.441"> </span>
<a href="#l21.442"></a><span id="l21.442">   return NS_OK;</span>
<a href="#l21.443"></a><span id="l21.443"> }</span>
<a href="#l21.444"></a><span id="l21.444"> </span>
<a href="#l21.445"></a><span id="l21.445" class="difflineminus">-nsresult</span>
<a href="#l21.446"></a><span id="l21.446" class="difflineminus">-nsSubscribableServer::CreateNode(SubscribeTreeNode *parent, const char *name, const nsACString &amp;aPath, SubscribeTreeNode **result)</span>
<a href="#l21.447"></a><span id="l21.447" class="difflineminus">-{</span>
<a href="#l21.448"></a><span id="l21.448" class="difflineminus">-    NS_ASSERTION(result &amp;&amp; name, &quot;result or name is null&quot;);</span>
<a href="#l21.449"></a><span id="l21.449" class="difflineminus">-    NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l21.450"></a><span id="l21.450" class="difflineminus">-    NS_ENSURE_ARG_POINTER(name);</span>
<a href="#l21.451"></a><span id="l21.451" class="difflineplus">+nsresult nsSubscribableServer::CreateNode(SubscribeTreeNode *parent,</span>
<a href="#l21.452"></a><span id="l21.452" class="difflineplus">+                                          const char *name,</span>
<a href="#l21.453"></a><span id="l21.453" class="difflineplus">+                                          const nsACString &amp;aPath,</span>
<a href="#l21.454"></a><span id="l21.454" class="difflineplus">+                                          SubscribeTreeNode **result) {</span>
<a href="#l21.455"></a><span id="l21.455" class="difflineplus">+  NS_ASSERTION(result &amp;&amp; name, &quot;result or name is null&quot;);</span>
<a href="#l21.456"></a><span id="l21.456" class="difflineplus">+  NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l21.457"></a><span id="l21.457" class="difflineplus">+  NS_ENSURE_ARG_POINTER(name);</span>
<a href="#l21.458"></a><span id="l21.458"> </span>
<a href="#l21.459"></a><span id="l21.459" class="difflineminus">-    *result = new SubscribeTreeNode();</span>
<a href="#l21.460"></a><span id="l21.460" class="difflineminus">-    if (!*result) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l21.461"></a><span id="l21.461" class="difflineplus">+  *result = new SubscribeTreeNode();</span>
<a href="#l21.462"></a><span id="l21.462" class="difflineplus">+  if (!*result) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l21.463"></a><span id="l21.463"> </span>
<a href="#l21.464"></a><span id="l21.464" class="difflineminus">-    (*result)-&gt;name = strdup(name);</span>
<a href="#l21.465"></a><span id="l21.465" class="difflineminus">-    if (!(*result)-&gt;name) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l21.466"></a><span id="l21.466" class="difflineplus">+  (*result)-&gt;name = strdup(name);</span>
<a href="#l21.467"></a><span id="l21.467" class="difflineplus">+  if (!(*result)-&gt;name) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l21.468"></a><span id="l21.468"> </span>
<a href="#l21.469"></a><span id="l21.469" class="difflineminus">-    (*result)-&gt;path.Assign(aPath);</span>
<a href="#l21.470"></a><span id="l21.470" class="difflineplus">+  (*result)-&gt;path.Assign(aPath);</span>
<a href="#l21.471"></a><span id="l21.471"> </span>
<a href="#l21.472"></a><span id="l21.472" class="difflineminus">-    (*result)-&gt;parent = parent;</span>
<a href="#l21.473"></a><span id="l21.473" class="difflineminus">-    (*result)-&gt;prevSibling = nullptr;</span>
<a href="#l21.474"></a><span id="l21.474" class="difflineminus">-    (*result)-&gt;nextSibling = nullptr;</span>
<a href="#l21.475"></a><span id="l21.475" class="difflineminus">-    (*result)-&gt;firstChild = nullptr;</span>
<a href="#l21.476"></a><span id="l21.476" class="difflineminus">-    (*result)-&gt;lastChild = nullptr;</span>
<a href="#l21.477"></a><span id="l21.477" class="difflineminus">-    (*result)-&gt;isSubscribed = false;</span>
<a href="#l21.478"></a><span id="l21.478" class="difflineminus">-    (*result)-&gt;isSubscribable = false;</span>
<a href="#l21.479"></a><span id="l21.479" class="difflineplus">+  (*result)-&gt;parent = parent;</span>
<a href="#l21.480"></a><span id="l21.480" class="difflineplus">+  (*result)-&gt;prevSibling = nullptr;</span>
<a href="#l21.481"></a><span id="l21.481" class="difflineplus">+  (*result)-&gt;nextSibling = nullptr;</span>
<a href="#l21.482"></a><span id="l21.482" class="difflineplus">+  (*result)-&gt;firstChild = nullptr;</span>
<a href="#l21.483"></a><span id="l21.483" class="difflineplus">+  (*result)-&gt;lastChild = nullptr;</span>
<a href="#l21.484"></a><span id="l21.484" class="difflineplus">+  (*result)-&gt;isSubscribed = false;</span>
<a href="#l21.485"></a><span id="l21.485" class="difflineplus">+  (*result)-&gt;isSubscribable = false;</span>
<a href="#l21.486"></a><span id="l21.486"> #ifdef HAVE_SUBSCRIBE_DESCRIPTION</span>
<a href="#l21.487"></a><span id="l21.487" class="difflineminus">-    (*result)-&gt;description = nullptr;</span>
<a href="#l21.488"></a><span id="l21.488" class="difflineplus">+  (*result)-&gt;description = nullptr;</span>
<a href="#l21.489"></a><span id="l21.489"> #endif</span>
<a href="#l21.490"></a><span id="l21.490"> #ifdef HAVE_SUBSCRIBE_MESSAGES</span>
<a href="#l21.491"></a><span id="l21.491" class="difflineminus">-    (*result)-&gt;messages = 0;</span>
<a href="#l21.492"></a><span id="l21.492" class="difflineplus">+  (*result)-&gt;messages = 0;</span>
<a href="#l21.493"></a><span id="l21.493"> #endif</span>
<a href="#l21.494"></a><span id="l21.494" class="difflineminus">-    (*result)-&gt;cachedChild = nullptr;</span>
<a href="#l21.495"></a><span id="l21.495" class="difflineplus">+  (*result)-&gt;cachedChild = nullptr;</span>
<a href="#l21.496"></a><span id="l21.496"> </span>
<a href="#l21.497"></a><span id="l21.497" class="difflineminus">-    if (parent) {</span>
<a href="#l21.498"></a><span id="l21.498" class="difflineminus">-        parent-&gt;cachedChild = *result;</span>
<a href="#l21.499"></a><span id="l21.499" class="difflineminus">-    }</span>
<a href="#l21.500"></a><span id="l21.500" class="difflineplus">+  if (parent) {</span>
<a href="#l21.501"></a><span id="l21.501" class="difflineplus">+    parent-&gt;cachedChild = *result;</span>
<a href="#l21.502"></a><span id="l21.502" class="difflineplus">+  }</span>
<a href="#l21.503"></a><span id="l21.503"> </span>
<a href="#l21.504"></a><span id="l21.504" class="difflineminus">-    (*result)-&gt;isOpen = true;</span>
<a href="#l21.505"></a><span id="l21.505" class="difflineplus">+  (*result)-&gt;isOpen = true;</span>
<a href="#l21.506"></a><span id="l21.506"> </span>
<a href="#l21.507"></a><span id="l21.507" class="difflineminus">-    return NS_OK;</span>
<a href="#l21.508"></a><span id="l21.508" class="difflineplus">+  return NS_OK;</span>
<a href="#l21.509"></a><span id="l21.509"> }</span>
<a href="#l21.510"></a><span id="l21.510"> </span>
<a href="#l21.511"></a><span id="l21.511" class="difflineminus">-nsresult</span>
<a href="#l21.512"></a><span id="l21.512" class="difflineminus">-nsSubscribableServer::AddChildNode(SubscribeTreeNode *parent, const char *name, const nsACString &amp;aPath, SubscribeTreeNode **child)</span>
<a href="#l21.513"></a><span id="l21.513" class="difflineminus">-{</span>
<a href="#l21.514"></a><span id="l21.514" class="difflineminus">-    nsresult rv = NS_OK;</span>
<a href="#l21.515"></a><span id="l21.515" class="difflineminus">-    NS_ASSERTION(parent &amp;&amp; child &amp;&amp; name &amp;&amp; !aPath.IsEmpty(), &quot;parent, child or name is null&quot;);</span>
<a href="#l21.516"></a><span id="l21.516" class="difflineminus">-    if (!parent || !child || !name || aPath.IsEmpty()) return NS_ERROR_NULL_POINTER;</span>
<a href="#l21.517"></a><span id="l21.517" class="difflineminus">-</span>
<a href="#l21.518"></a><span id="l21.518" class="difflineminus">-    if (!parent-&gt;firstChild) {</span>
<a href="#l21.519"></a><span id="l21.519" class="difflineminus">-        // CreateNode will set the parent-&gt;cachedChild</span>
<a href="#l21.520"></a><span id="l21.520" class="difflineminus">-        rv = CreateNode(parent, name, aPath, child);</span>
<a href="#l21.521"></a><span id="l21.521" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l21.522"></a><span id="l21.522" class="difflineminus">-</span>
<a href="#l21.523"></a><span id="l21.523" class="difflineminus">-        parent-&gt;firstChild = *child;</span>
<a href="#l21.524"></a><span id="l21.524" class="difflineminus">-        parent-&gt;lastChild = *child;</span>
<a href="#l21.525"></a><span id="l21.525" class="difflineminus">-</span>
<a href="#l21.526"></a><span id="l21.526" class="difflineminus">-        return NS_OK;</span>
<a href="#l21.527"></a><span id="l21.527" class="difflineminus">-    }</span>
<a href="#l21.528"></a><span id="l21.528" class="difflineminus">-</span>
<a href="#l21.529"></a><span id="l21.529" class="difflineminus">-    if (parent-&gt;cachedChild) {</span>
<a href="#l21.530"></a><span id="l21.530" class="difflineminus">-        if (strcmp(parent-&gt;cachedChild-&gt;name,name) == 0) {</span>
<a href="#l21.531"></a><span id="l21.531" class="difflineminus">-            *child = parent-&gt;cachedChild;</span>
<a href="#l21.532"></a><span id="l21.532" class="difflineminus">-            return NS_OK;</span>
<a href="#l21.533"></a><span id="l21.533" class="difflineminus">-        }</span>
<a href="#l21.534"></a><span id="l21.534" class="difflineminus">-    }</span>
<a href="#l21.535"></a><span id="l21.535" class="difflineminus">-</span>
<a href="#l21.536"></a><span id="l21.536" class="difflineminus">-    SubscribeTreeNode *current = parent-&gt;firstChild;</span>
<a href="#l21.537"></a><span id="l21.537" class="difflineplus">+nsresult nsSubscribableServer::AddChildNode(SubscribeTreeNode *parent,</span>
<a href="#l21.538"></a><span id="l21.538" class="difflineplus">+                                            const char *name,</span>
<a href="#l21.539"></a><span id="l21.539" class="difflineplus">+                                            const nsACString &amp;aPath,</span>
<a href="#l21.540"></a><span id="l21.540" class="difflineplus">+                                            SubscribeTreeNode **child) {</span>
<a href="#l21.541"></a><span id="l21.541" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l21.542"></a><span id="l21.542" class="difflineplus">+  NS_ASSERTION(parent &amp;&amp; child &amp;&amp; name &amp;&amp; !aPath.IsEmpty(),</span>
<a href="#l21.543"></a><span id="l21.543" class="difflineplus">+               &quot;parent, child or name is null&quot;);</span>
<a href="#l21.544"></a><span id="l21.544" class="difflineplus">+  if (!parent || !child || !name || aPath.IsEmpty())</span>
<a href="#l21.545"></a><span id="l21.545" class="difflineplus">+    return NS_ERROR_NULL_POINTER;</span>
<a href="#l21.546"></a><span id="l21.546"> </span>
<a href="#l21.547"></a><span id="l21.547" class="difflineminus">-    /*</span>
<a href="#l21.548"></a><span id="l21.548" class="difflineminus">-     * insert in reverse alphabetical order</span>
<a href="#l21.549"></a><span id="l21.549" class="difflineminus">-     * this will reduce the # of strcmps</span>
<a href="#l21.550"></a><span id="l21.550" class="difflineminus">-     * since this is faster assuming:</span>
<a href="#l21.551"></a><span id="l21.551" class="difflineminus">-     *  1) the hostinfo.dat feeds us the groups in alphabetical order</span>
<a href="#l21.552"></a><span id="l21.552" class="difflineminus">-     *     since we control the hostinfo.dat file, we can guarantee this.</span>
<a href="#l21.553"></a><span id="l21.553" class="difflineminus">-     *  2) the server gives us the groups in alphabetical order</span>
<a href="#l21.554"></a><span id="l21.554" class="difflineminus">-     *     we can't guarantee this, but it seems to be a common thing</span>
<a href="#l21.555"></a><span id="l21.555" class="difflineminus">-     *</span>
<a href="#l21.556"></a><span id="l21.556" class="difflineminus">-     * because we have firstChild, lastChild, nextSibling, prevSibling</span>
<a href="#l21.557"></a><span id="l21.557" class="difflineminus">-     * we can efficiently reverse the order when dumping to hostinfo.dat</span>
<a href="#l21.558"></a><span id="l21.558" class="difflineminus">-     * or to GetTargets()</span>
<a href="#l21.559"></a><span id="l21.559" class="difflineminus">-     */</span>
<a href="#l21.560"></a><span id="l21.560" class="difflineminus">-    int32_t compare = strcmp(current-&gt;name, name);</span>
<a href="#l21.561"></a><span id="l21.561" class="difflineminus">-</span>
<a href="#l21.562"></a><span id="l21.562" class="difflineminus">-    while (current &amp;&amp; (compare != 0)) {</span>
<a href="#l21.563"></a><span id="l21.563" class="difflineminus">-        if (compare &lt; 0) {</span>
<a href="#l21.564"></a><span id="l21.564" class="difflineminus">-            // CreateNode will set the parent-&gt;cachedChild</span>
<a href="#l21.565"></a><span id="l21.565" class="difflineminus">-            rv = CreateNode(parent, name, aPath, child);</span>
<a href="#l21.566"></a><span id="l21.566" class="difflineminus">-            NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l21.567"></a><span id="l21.567" class="difflineminus">-</span>
<a href="#l21.568"></a><span id="l21.568" class="difflineminus">-            (*child)-&gt;nextSibling = current;</span>
<a href="#l21.569"></a><span id="l21.569" class="difflineminus">-            (*child)-&gt;prevSibling = current-&gt;prevSibling;</span>
<a href="#l21.570"></a><span id="l21.570" class="difflineminus">-            current-&gt;prevSibling = (*child);</span>
<a href="#l21.571"></a><span id="l21.571" class="difflineminus">-            if (!(*child)-&gt;prevSibling) {</span>
<a href="#l21.572"></a><span id="l21.572" class="difflineminus">-                parent-&gt;firstChild = (*child);</span>
<a href="#l21.573"></a><span id="l21.573" class="difflineminus">-            }</span>
<a href="#l21.574"></a><span id="l21.574" class="difflineminus">-            else {</span>
<a href="#l21.575"></a><span id="l21.575" class="difflineminus">-                (*child)-&gt;prevSibling-&gt;nextSibling = (*child);</span>
<a href="#l21.576"></a><span id="l21.576" class="difflineminus">-            }</span>
<a href="#l21.577"></a><span id="l21.577" class="difflineminus">-</span>
<a href="#l21.578"></a><span id="l21.578" class="difflineminus">-            return NS_OK;</span>
<a href="#l21.579"></a><span id="l21.579" class="difflineminus">-        }</span>
<a href="#l21.580"></a><span id="l21.580" class="difflineminus">-        current = current-&gt;nextSibling;</span>
<a href="#l21.581"></a><span id="l21.581" class="difflineminus">-        if (current) {</span>
<a href="#l21.582"></a><span id="l21.582" class="difflineminus">-            NS_ASSERTION(current-&gt;name, &quot;no name!&quot;);</span>
<a href="#l21.583"></a><span id="l21.583" class="difflineminus">-            compare = strcmp(current-&gt;name,name);</span>
<a href="#l21.584"></a><span id="l21.584" class="difflineminus">-        }</span>
<a href="#l21.585"></a><span id="l21.585" class="difflineminus">-        else {</span>
<a href="#l21.586"></a><span id="l21.586" class="difflineminus">-            compare = -1; // anything but 0, since that would be a match</span>
<a href="#l21.587"></a><span id="l21.587" class="difflineminus">-        }</span>
<a href="#l21.588"></a><span id="l21.588" class="difflineminus">-    }</span>
<a href="#l21.589"></a><span id="l21.589" class="difflineminus">-</span>
<a href="#l21.590"></a><span id="l21.590" class="difflineminus">-    if (compare == 0) {</span>
<a href="#l21.591"></a><span id="l21.591" class="difflineminus">-        // already exists;</span>
<a href="#l21.592"></a><span id="l21.592" class="difflineminus">-        *child = current;</span>
<a href="#l21.593"></a><span id="l21.593" class="difflineminus">-</span>
<a href="#l21.594"></a><span id="l21.594" class="difflineminus">-        // set the cachedChild</span>
<a href="#l21.595"></a><span id="l21.595" class="difflineminus">-        parent-&gt;cachedChild = *child;</span>
<a href="#l21.596"></a><span id="l21.596" class="difflineminus">-        return NS_OK;</span>
<a href="#l21.597"></a><span id="l21.597" class="difflineminus">-    }</span>
<a href="#l21.598"></a><span id="l21.598" class="difflineminus">-</span>
<a href="#l21.599"></a><span id="l21.599" class="difflineplus">+  if (!parent-&gt;firstChild) {</span>
<a href="#l21.600"></a><span id="l21.600">     // CreateNode will set the parent-&gt;cachedChild</span>
<a href="#l21.601"></a><span id="l21.601">     rv = CreateNode(parent, name, aPath, child);</span>
<a href="#l21.602"></a><span id="l21.602" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l21.603"></a><span id="l21.603" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.604"></a><span id="l21.604"> </span>
<a href="#l21.605"></a><span id="l21.605" class="difflineminus">-    (*child)-&gt;prevSibling = parent-&gt;lastChild;</span>
<a href="#l21.606"></a><span id="l21.606" class="difflineminus">-    (*child)-&gt;nextSibling = nullptr;</span>
<a href="#l21.607"></a><span id="l21.607" class="difflineminus">-    parent-&gt;lastChild-&gt;nextSibling = *child;</span>
<a href="#l21.608"></a><span id="l21.608" class="difflineplus">+    parent-&gt;firstChild = *child;</span>
<a href="#l21.609"></a><span id="l21.609">     parent-&gt;lastChild = *child;</span>
<a href="#l21.610"></a><span id="l21.610"> </span>
<a href="#l21.611"></a><span id="l21.611">     return NS_OK;</span>
<a href="#l21.612"></a><span id="l21.612" class="difflineplus">+  }</span>
<a href="#l21.613"></a><span id="l21.613" class="difflineplus">+</span>
<a href="#l21.614"></a><span id="l21.614" class="difflineplus">+  if (parent-&gt;cachedChild) {</span>
<a href="#l21.615"></a><span id="l21.615" class="difflineplus">+    if (strcmp(parent-&gt;cachedChild-&gt;name, name) == 0) {</span>
<a href="#l21.616"></a><span id="l21.616" class="difflineplus">+      *child = parent-&gt;cachedChild;</span>
<a href="#l21.617"></a><span id="l21.617" class="difflineplus">+      return NS_OK;</span>
<a href="#l21.618"></a><span id="l21.618" class="difflineplus">+    }</span>
<a href="#l21.619"></a><span id="l21.619" class="difflineplus">+  }</span>
<a href="#l21.620"></a><span id="l21.620" class="difflineplus">+</span>
<a href="#l21.621"></a><span id="l21.621" class="difflineplus">+  SubscribeTreeNode *current = parent-&gt;firstChild;</span>
<a href="#l21.622"></a><span id="l21.622" class="difflineplus">+</span>
<a href="#l21.623"></a><span id="l21.623" class="difflineplus">+  /*</span>
<a href="#l21.624"></a><span id="l21.624" class="difflineplus">+   * Insert in reverse alphabetical order.</span>
<a href="#l21.625"></a><span id="l21.625" class="difflineplus">+   * This will reduce the # of strcmps since this is faster assuming:</span>
<a href="#l21.626"></a><span id="l21.626" class="difflineplus">+   *  1) the hostinfo.dat feeds us the groups in alphabetical order</span>
<a href="#l21.627"></a><span id="l21.627" class="difflineplus">+   *     since we control the hostinfo.dat file, we can guarantee this.</span>
<a href="#l21.628"></a><span id="l21.628" class="difflineplus">+   *  2) the server gives us the groups in alphabetical order</span>
<a href="#l21.629"></a><span id="l21.629" class="difflineplus">+   *     we can't guarantee this, but it seems to be a common thing.</span>
<a href="#l21.630"></a><span id="l21.630" class="difflineplus">+   *</span>
<a href="#l21.631"></a><span id="l21.631" class="difflineplus">+   * Because we have firstChild, lastChild, nextSibling, prevSibling,</span>
<a href="#l21.632"></a><span id="l21.632" class="difflineplus">+   * we can efficiently reverse the order when dumping to hostinfo.dat</span>
<a href="#l21.633"></a><span id="l21.633" class="difflineplus">+   * or to GetTargets().</span>
<a href="#l21.634"></a><span id="l21.634" class="difflineplus">+   */</span>
<a href="#l21.635"></a><span id="l21.635" class="difflineplus">+  int32_t compare = strcmp(current-&gt;name, name);</span>
<a href="#l21.636"></a><span id="l21.636" class="difflineplus">+</span>
<a href="#l21.637"></a><span id="l21.637" class="difflineplus">+  while (current &amp;&amp; (compare != 0)) {</span>
<a href="#l21.638"></a><span id="l21.638" class="difflineplus">+    if (compare &lt; 0) {</span>
<a href="#l21.639"></a><span id="l21.639" class="difflineplus">+      // CreateNode will set the parent-&gt;cachedChild</span>
<a href="#l21.640"></a><span id="l21.640" class="difflineplus">+      rv = CreateNode(parent, name, aPath, child);</span>
<a href="#l21.641"></a><span id="l21.641" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.642"></a><span id="l21.642" class="difflineplus">+</span>
<a href="#l21.643"></a><span id="l21.643" class="difflineplus">+      (*child)-&gt;nextSibling = current;</span>
<a href="#l21.644"></a><span id="l21.644" class="difflineplus">+      (*child)-&gt;prevSibling = current-&gt;prevSibling;</span>
<a href="#l21.645"></a><span id="l21.645" class="difflineplus">+      current-&gt;prevSibling = (*child);</span>
<a href="#l21.646"></a><span id="l21.646" class="difflineplus">+      if (!(*child)-&gt;prevSibling) {</span>
<a href="#l21.647"></a><span id="l21.647" class="difflineplus">+        parent-&gt;firstChild = (*child);</span>
<a href="#l21.648"></a><span id="l21.648" class="difflineplus">+      } else {</span>
<a href="#l21.649"></a><span id="l21.649" class="difflineplus">+        (*child)-&gt;prevSibling-&gt;nextSibling = (*child);</span>
<a href="#l21.650"></a><span id="l21.650" class="difflineplus">+      }</span>
<a href="#l21.651"></a><span id="l21.651" class="difflineplus">+</span>
<a href="#l21.652"></a><span id="l21.652" class="difflineplus">+      return NS_OK;</span>
<a href="#l21.653"></a><span id="l21.653" class="difflineplus">+    }</span>
<a href="#l21.654"></a><span id="l21.654" class="difflineplus">+    current = current-&gt;nextSibling;</span>
<a href="#l21.655"></a><span id="l21.655" class="difflineplus">+    if (current) {</span>
<a href="#l21.656"></a><span id="l21.656" class="difflineplus">+      NS_ASSERTION(current-&gt;name, &quot;no name!&quot;);</span>
<a href="#l21.657"></a><span id="l21.657" class="difflineplus">+      compare = strcmp(current-&gt;name, name);</span>
<a href="#l21.658"></a><span id="l21.658" class="difflineplus">+    } else {</span>
<a href="#l21.659"></a><span id="l21.659" class="difflineplus">+      compare = -1;  // anything but 0, since that would be a match</span>
<a href="#l21.660"></a><span id="l21.660" class="difflineplus">+    }</span>
<a href="#l21.661"></a><span id="l21.661" class="difflineplus">+  }</span>
<a href="#l21.662"></a><span id="l21.662" class="difflineplus">+</span>
<a href="#l21.663"></a><span id="l21.663" class="difflineplus">+  if (compare == 0) {</span>
<a href="#l21.664"></a><span id="l21.664" class="difflineplus">+    // already exists;</span>
<a href="#l21.665"></a><span id="l21.665" class="difflineplus">+    *child = current;</span>
<a href="#l21.666"></a><span id="l21.666" class="difflineplus">+</span>
<a href="#l21.667"></a><span id="l21.667" class="difflineplus">+    // set the cachedChild</span>
<a href="#l21.668"></a><span id="l21.668" class="difflineplus">+    parent-&gt;cachedChild = *child;</span>
<a href="#l21.669"></a><span id="l21.669" class="difflineplus">+    return NS_OK;</span>
<a href="#l21.670"></a><span id="l21.670" class="difflineplus">+  }</span>
<a href="#l21.671"></a><span id="l21.671" class="difflineplus">+</span>
<a href="#l21.672"></a><span id="l21.672" class="difflineplus">+  // CreateNode will set the parent-&gt;cachedChild</span>
<a href="#l21.673"></a><span id="l21.673" class="difflineplus">+  rv = CreateNode(parent, name, aPath, child);</span>
<a href="#l21.674"></a><span id="l21.674" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.675"></a><span id="l21.675" class="difflineplus">+</span>
<a href="#l21.676"></a><span id="l21.676" class="difflineplus">+  (*child)-&gt;prevSibling = parent-&gt;lastChild;</span>
<a href="#l21.677"></a><span id="l21.677" class="difflineplus">+  (*child)-&gt;nextSibling = nullptr;</span>
<a href="#l21.678"></a><span id="l21.678" class="difflineplus">+  parent-&gt;lastChild-&gt;nextSibling = *child;</span>
<a href="#l21.679"></a><span id="l21.679" class="difflineplus">+  parent-&gt;lastChild = *child;</span>
<a href="#l21.680"></a><span id="l21.680" class="difflineplus">+</span>
<a href="#l21.681"></a><span id="l21.681" class="difflineplus">+  return NS_OK;</span>
<a href="#l21.682"></a><span id="l21.682"> }</span>
<a href="#l21.683"></a><span id="l21.683"> </span>
<a href="#l21.684"></a><span id="l21.684" class="difflineminus">-nsresult</span>
<a href="#l21.685"></a><span id="l21.685" class="difflineminus">-nsSubscribableServer::FindAndCreateNode(const nsACString &amp;aPath,</span>
<a href="#l21.686"></a><span id="l21.686" class="difflineminus">-                                        SubscribeTreeNode **aResult)</span>
<a href="#l21.687"></a><span id="l21.687" class="difflineminus">-{</span>
<a href="#l21.688"></a><span id="l21.688" class="difflineplus">+nsresult nsSubscribableServer::FindAndCreateNode(const nsACString &amp;aPath,</span>
<a href="#l21.689"></a><span id="l21.689" class="difflineplus">+                                                 SubscribeTreeNode **aResult) {</span>
<a href="#l21.690"></a><span id="l21.690">   nsresult rv = NS_OK;</span>
<a href="#l21.691"></a><span id="l21.691">   NS_ASSERTION(aResult, &quot;no result&quot;);</span>
<a href="#l21.692"></a><span id="l21.692">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l21.693"></a><span id="l21.693"> </span>
<a href="#l21.694"></a><span id="l21.694">   if (!mTreeRoot) {</span>
<a href="#l21.695"></a><span id="l21.695" class="difflineminus">-      // the root has no parent, and its name is server uri</span>
<a href="#l21.696"></a><span id="l21.696" class="difflineminus">-      rv = CreateNode(nullptr, mIncomingServerUri.get(), EmptyCString(), &amp;mTreeRoot);</span>
<a href="#l21.697"></a><span id="l21.697" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l21.698"></a><span id="l21.698" class="difflineplus">+    // the root has no parent, and its name is server uri</span>
<a href="#l21.699"></a><span id="l21.699" class="difflineplus">+    rv = CreateNode(nullptr, mIncomingServerUri.get(), EmptyCString(),</span>
<a href="#l21.700"></a><span id="l21.700" class="difflineplus">+                    &amp;mTreeRoot);</span>
<a href="#l21.701"></a><span id="l21.701" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.702"></a><span id="l21.702">   }</span>
<a href="#l21.703"></a><span id="l21.703"> </span>
<a href="#l21.704"></a><span id="l21.704">   if (aPath.IsEmpty()) {</span>
<a href="#l21.705"></a><span id="l21.705" class="difflineminus">-      *aResult = mTreeRoot;</span>
<a href="#l21.706"></a><span id="l21.706" class="difflineminus">-      return NS_OK;</span>
<a href="#l21.707"></a><span id="l21.707" class="difflineplus">+    *aResult = mTreeRoot;</span>
<a href="#l21.708"></a><span id="l21.708" class="difflineplus">+    return NS_OK;</span>
<a href="#l21.709"></a><span id="l21.709">   }</span>
<a href="#l21.710"></a><span id="l21.710"> </span>
<a href="#l21.711"></a><span id="l21.711">   *aResult = nullptr;</span>
<a href="#l21.712"></a><span id="l21.712"> </span>
<a href="#l21.713"></a><span id="l21.713">   SubscribeTreeNode *parent = mTreeRoot;</span>
<a href="#l21.714"></a><span id="l21.714">   SubscribeTreeNode *child = nullptr;</span>
<a href="#l21.715"></a><span id="l21.715"> </span>
<a href="#l21.716"></a><span id="l21.716">   uint32_t tokenStart = 0;</span>
<a href="#l21.717"></a><span id="l21.717">   // Special case paths that start with the hierarchy delimiter.</span>
<a href="#l21.718"></a><span id="l21.718">   // We want to include that delimiter in the first token name.</span>
<a href="#l21.719"></a><span id="l21.719">   // So start from position 1.</span>
<a href="#l21.720"></a><span id="l21.720">   int32_t tokenEnd = aPath.FindChar(mDelimiter, tokenStart + 1);</span>
<a href="#l21.721"></a><span id="l21.721">   while (true) {</span>
<a href="#l21.722"></a><span id="l21.722">     if (tokenEnd == kNotFound) {</span>
<a href="#l21.723"></a><span id="l21.723" class="difflineminus">-      if (tokenStart &gt;= aPath.Length())</span>
<a href="#l21.724"></a><span id="l21.724" class="difflineminus">-        break;</span>
<a href="#l21.725"></a><span id="l21.725" class="difflineplus">+      if (tokenStart &gt;= aPath.Length()) break;</span>
<a href="#l21.726"></a><span id="l21.726">       tokenEnd = aPath.Length();</span>
<a href="#l21.727"></a><span id="l21.727">     }</span>
<a href="#l21.728"></a><span id="l21.728">     nsCString token(Substring(aPath, tokenStart, tokenEnd - tokenStart));</span>
<a href="#l21.729"></a><span id="l21.729" class="difflineminus">-    rv = AddChildNode(parent, token.BeginReading(), Substring(aPath, 0, tokenEnd), &amp;child);</span>
<a href="#l21.730"></a><span id="l21.730" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l21.731"></a><span id="l21.731" class="difflineminus">-      return rv;</span>
<a href="#l21.732"></a><span id="l21.732" class="difflineplus">+    rv = AddChildNode(parent, token.BeginReading(),</span>
<a href="#l21.733"></a><span id="l21.733" class="difflineplus">+                      Substring(aPath, 0, tokenEnd), &amp;child);</span>
<a href="#l21.734"></a><span id="l21.734" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l21.735"></a><span id="l21.735">     tokenStart = tokenEnd + 1;</span>
<a href="#l21.736"></a><span id="l21.736">     tokenEnd = aPath.FindChar(mDelimiter, tokenStart);</span>
<a href="#l21.737"></a><span id="l21.737">     parent = child;</span>
<a href="#l21.738"></a><span id="l21.738">   }</span>
<a href="#l21.739"></a><span id="l21.739"> </span>
<a href="#l21.740"></a><span id="l21.740">   // the last child we add is the result</span>
<a href="#l21.741"></a><span id="l21.741">   *aResult = child;</span>
<a href="#l21.742"></a><span id="l21.742">   return rv;</span>
<a href="#l21.743"></a><span id="l21.743"> }</span>
<a href="#l21.744"></a><span id="l21.744"> </span>
<a href="#l21.745"></a><span id="l21.745"> NS_IMETHODIMP</span>
<a href="#l21.746"></a><span id="l21.746" class="difflineminus">-nsSubscribableServer::HasChildren(const nsACString &amp;aPath, bool *aHasChildren)</span>
<a href="#l21.747"></a><span id="l21.747" class="difflineminus">-{</span>
<a href="#l21.748"></a><span id="l21.748" class="difflineminus">-    NS_ASSERTION(aHasChildren, &quot;no hasChildren&quot;);</span>
<a href="#l21.749"></a><span id="l21.749" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aHasChildren);</span>
<a href="#l21.750"></a><span id="l21.750" class="difflineplus">+nsSubscribableServer::HasChildren(const nsACString &amp;aPath, bool *aHasChildren) {</span>
<a href="#l21.751"></a><span id="l21.751" class="difflineplus">+  NS_ASSERTION(aHasChildren, &quot;no hasChildren&quot;);</span>
<a href="#l21.752"></a><span id="l21.752" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aHasChildren);</span>
<a href="#l21.753"></a><span id="l21.753"> </span>
<a href="#l21.754"></a><span id="l21.754" class="difflineminus">-    *aHasChildren = false;</span>
<a href="#l21.755"></a><span id="l21.755" class="difflineplus">+  *aHasChildren = false;</span>
<a href="#l21.756"></a><span id="l21.756"> </span>
<a href="#l21.757"></a><span id="l21.757" class="difflineminus">-    SubscribeTreeNode *node = nullptr;</span>
<a href="#l21.758"></a><span id="l21.758" class="difflineminus">-    nsresult rv = FindAndCreateNode(aPath, &amp;node);</span>
<a href="#l21.759"></a><span id="l21.759" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l21.760"></a><span id="l21.760" class="difflineplus">+  SubscribeTreeNode *node = nullptr;</span>
<a href="#l21.761"></a><span id="l21.761" class="difflineplus">+  nsresult rv = FindAndCreateNode(aPath, &amp;node);</span>
<a href="#l21.762"></a><span id="l21.762" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.763"></a><span id="l21.763"> </span>
<a href="#l21.764"></a><span id="l21.764" class="difflineminus">-    NS_ASSERTION(node,&quot;didn't find the node&quot;);</span>
<a href="#l21.765"></a><span id="l21.765" class="difflineminus">-    if (!node) return NS_ERROR_FAILURE;</span>
<a href="#l21.766"></a><span id="l21.766" class="difflineplus">+  NS_ASSERTION(node, &quot;didn't find the node&quot;);</span>
<a href="#l21.767"></a><span id="l21.767" class="difflineplus">+  if (!node) return NS_ERROR_FAILURE;</span>
<a href="#l21.768"></a><span id="l21.768"> </span>
<a href="#l21.769"></a><span id="l21.769" class="difflineminus">-    *aHasChildren = (node-&gt;firstChild != nullptr);</span>
<a href="#l21.770"></a><span id="l21.770" class="difflineminus">-    return NS_OK;</span>
<a href="#l21.771"></a><span id="l21.771" class="difflineplus">+  *aHasChildren = (node-&gt;firstChild != nullptr);</span>
<a href="#l21.772"></a><span id="l21.772" class="difflineplus">+  return NS_OK;</span>
<a href="#l21.773"></a><span id="l21.773"> }</span>
<a href="#l21.774"></a><span id="l21.774"> </span>
<a href="#l21.775"></a><span id="l21.775" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l21.776"></a><span id="l21.776" class="difflineplus">+nsSubscribableServer::IsSubscribed(const nsACString &amp;aPath,</span>
<a href="#l21.777"></a><span id="l21.777" class="difflineplus">+                                   bool *aIsSubscribed) {</span>
<a href="#l21.778"></a><span id="l21.778" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aIsSubscribed);</span>
<a href="#l21.779"></a><span id="l21.779"> </span>
<a href="#l21.780"></a><span id="l21.780" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l21.781"></a><span id="l21.781" class="difflineminus">-nsSubscribableServer::IsSubscribed(const nsACString &amp;aPath, bool *aIsSubscribed)</span>
<a href="#l21.782"></a><span id="l21.782" class="difflineminus">-{</span>
<a href="#l21.783"></a><span id="l21.783" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aIsSubscribed);</span>
<a href="#l21.784"></a><span id="l21.784" class="difflineminus">-</span>
<a href="#l21.785"></a><span id="l21.785" class="difflineminus">-    *aIsSubscribed = false;</span>
<a href="#l21.786"></a><span id="l21.786" class="difflineplus">+  *aIsSubscribed = false;</span>
<a href="#l21.787"></a><span id="l21.787"> </span>
<a href="#l21.788"></a><span id="l21.788" class="difflineminus">-    SubscribeTreeNode *node = nullptr;</span>
<a href="#l21.789"></a><span id="l21.789" class="difflineminus">-    nsresult rv = FindAndCreateNode(aPath, &amp;node);</span>
<a href="#l21.790"></a><span id="l21.790" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l21.791"></a><span id="l21.791" class="difflineplus">+  SubscribeTreeNode *node = nullptr;</span>
<a href="#l21.792"></a><span id="l21.792" class="difflineplus">+  nsresult rv = FindAndCreateNode(aPath, &amp;node);</span>
<a href="#l21.793"></a><span id="l21.793" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.794"></a><span id="l21.794"> </span>
<a href="#l21.795"></a><span id="l21.795" class="difflineminus">-    NS_ASSERTION(node,&quot;didn't find the node&quot;);</span>
<a href="#l21.796"></a><span id="l21.796" class="difflineminus">-    if (!node) return NS_ERROR_FAILURE;</span>
<a href="#l21.797"></a><span id="l21.797" class="difflineplus">+  NS_ASSERTION(node, &quot;didn't find the node&quot;);</span>
<a href="#l21.798"></a><span id="l21.798" class="difflineplus">+  if (!node) return NS_ERROR_FAILURE;</span>
<a href="#l21.799"></a><span id="l21.799"> </span>
<a href="#l21.800"></a><span id="l21.800" class="difflineminus">-    *aIsSubscribed = node-&gt;isSubscribed;</span>
<a href="#l21.801"></a><span id="l21.801" class="difflineminus">-    return NS_OK;</span>
<a href="#l21.802"></a><span id="l21.802" class="difflineplus">+  *aIsSubscribed = node-&gt;isSubscribed;</span>
<a href="#l21.803"></a><span id="l21.803" class="difflineplus">+  return NS_OK;</span>
<a href="#l21.804"></a><span id="l21.804"> }</span>
<a href="#l21.805"></a><span id="l21.805"> </span>
<a href="#l21.806"></a><span id="l21.806"> NS_IMETHODIMP</span>
<a href="#l21.807"></a><span id="l21.807"> nsSubscribableServer::IsSubscribable(const nsACString &amp;aPath,</span>
<a href="#l21.808"></a><span id="l21.808" class="difflineminus">-                                     bool *aIsSubscribable)</span>
<a href="#l21.809"></a><span id="l21.809" class="difflineminus">-{</span>
<a href="#l21.810"></a><span id="l21.810" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aIsSubscribable);</span>
<a href="#l21.811"></a><span id="l21.811" class="difflineplus">+                                     bool *aIsSubscribable) {</span>
<a href="#l21.812"></a><span id="l21.812" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aIsSubscribable);</span>
<a href="#l21.813"></a><span id="l21.813"> </span>
<a href="#l21.814"></a><span id="l21.814" class="difflineminus">-    *aIsSubscribable = false;</span>
<a href="#l21.815"></a><span id="l21.815" class="difflineplus">+  *aIsSubscribable = false;</span>
<a href="#l21.816"></a><span id="l21.816"> </span>
<a href="#l21.817"></a><span id="l21.817" class="difflineminus">-    SubscribeTreeNode *node = nullptr;</span>
<a href="#l21.818"></a><span id="l21.818" class="difflineminus">-    nsresult rv = FindAndCreateNode(aPath, &amp;node);</span>
<a href="#l21.819"></a><span id="l21.819" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l21.820"></a><span id="l21.820" class="difflineplus">+  SubscribeTreeNode *node = nullptr;</span>
<a href="#l21.821"></a><span id="l21.821" class="difflineplus">+  nsresult rv = FindAndCreateNode(aPath, &amp;node);</span>
<a href="#l21.822"></a><span id="l21.822" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.823"></a><span id="l21.823"> </span>
<a href="#l21.824"></a><span id="l21.824" class="difflineminus">-    NS_ASSERTION(node,&quot;didn't find the node&quot;);</span>
<a href="#l21.825"></a><span id="l21.825" class="difflineminus">-    if (!node) return NS_ERROR_FAILURE;</span>
<a href="#l21.826"></a><span id="l21.826" class="difflineplus">+  NS_ASSERTION(node, &quot;didn't find the node&quot;);</span>
<a href="#l21.827"></a><span id="l21.827" class="difflineplus">+  if (!node) return NS_ERROR_FAILURE;</span>
<a href="#l21.828"></a><span id="l21.828"> </span>
<a href="#l21.829"></a><span id="l21.829" class="difflineminus">-    *aIsSubscribable = node-&gt;isSubscribable;</span>
<a href="#l21.830"></a><span id="l21.830" class="difflineminus">-    return NS_OK;</span>
<a href="#l21.831"></a><span id="l21.831" class="difflineplus">+  *aIsSubscribable = node-&gt;isSubscribable;</span>
<a href="#l21.832"></a><span id="l21.832" class="difflineplus">+  return NS_OK;</span>
<a href="#l21.833"></a><span id="l21.833"> }</span>
<a href="#l21.834"></a><span id="l21.834"> </span>
<a href="#l21.835"></a><span id="l21.835"> NS_IMETHODIMP</span>
<a href="#l21.836"></a><span id="l21.836" class="difflineminus">-nsSubscribableServer::GetLeafName(const nsACString &amp;aPath, nsAString &amp;aLeafName)</span>
<a href="#l21.837"></a><span id="l21.837" class="difflineminus">-{</span>
<a href="#l21.838"></a><span id="l21.838" class="difflineminus">-    SubscribeTreeNode *node = nullptr;</span>
<a href="#l21.839"></a><span id="l21.839" class="difflineminus">-    nsresult rv = FindAndCreateNode(aPath, &amp;node);</span>
<a href="#l21.840"></a><span id="l21.840" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l21.841"></a><span id="l21.841" class="difflineplus">+nsSubscribableServer::GetLeafName(const nsACString &amp;aPath,</span>
<a href="#l21.842"></a><span id="l21.842" class="difflineplus">+                                  nsAString &amp;aLeafName) {</span>
<a href="#l21.843"></a><span id="l21.843" class="difflineplus">+  SubscribeTreeNode *node = nullptr;</span>
<a href="#l21.844"></a><span id="l21.844" class="difflineplus">+  nsresult rv = FindAndCreateNode(aPath, &amp;node);</span>
<a href="#l21.845"></a><span id="l21.845" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.846"></a><span id="l21.846"> </span>
<a href="#l21.847"></a><span id="l21.847" class="difflineminus">-    NS_ASSERTION(node,&quot;didn't find the node&quot;);</span>
<a href="#l21.848"></a><span id="l21.848" class="difflineminus">-    if (!node) return NS_ERROR_FAILURE;</span>
<a href="#l21.849"></a><span id="l21.849" class="difflineplus">+  NS_ASSERTION(node, &quot;didn't find the node&quot;);</span>
<a href="#l21.850"></a><span id="l21.850" class="difflineplus">+  if (!node) return NS_ERROR_FAILURE;</span>
<a href="#l21.851"></a><span id="l21.851"> </span>
<a href="#l21.852"></a><span id="l21.852" class="difflineminus">-    // XXX TODO FIXME</span>
<a href="#l21.853"></a><span id="l21.853" class="difflineminus">-    // I'm assuming that mShowFullName is true for NNTP, false for IMAP.</span>
<a href="#l21.854"></a><span id="l21.854" class="difflineminus">-    // for imap, the node name is in modified UTF7</span>
<a href="#l21.855"></a><span id="l21.855" class="difflineminus">-    // for news, the path is escaped UTF8</span>
<a href="#l21.856"></a><span id="l21.856" class="difflineminus">-    //</span>
<a href="#l21.857"></a><span id="l21.857" class="difflineminus">-    // when we switch to using the tree, this hack will go away.</span>
<a href="#l21.858"></a><span id="l21.858" class="difflineminus">-    if (mShowFullName) {</span>
<a href="#l21.859"></a><span id="l21.859" class="difflineminus">-       return NS_MsgDecodeUnescapeURLPath(aPath, aLeafName);</span>
<a href="#l21.860"></a><span id="l21.860" class="difflineminus">-    }</span>
<a href="#l21.861"></a><span id="l21.861" class="difflineplus">+  // XXX TODO FIXME</span>
<a href="#l21.862"></a><span id="l21.862" class="difflineplus">+  // I'm assuming that mShowFullName is true for NNTP, false for IMAP.</span>
<a href="#l21.863"></a><span id="l21.863" class="difflineplus">+  // for imap, the node name is in modified UTF7</span>
<a href="#l21.864"></a><span id="l21.864" class="difflineplus">+  // for news, the path is escaped UTF8</span>
<a href="#l21.865"></a><span id="l21.865" class="difflineplus">+  //</span>
<a href="#l21.866"></a><span id="l21.866" class="difflineplus">+  // when we switch to using the tree, this hack will go away.</span>
<a href="#l21.867"></a><span id="l21.867" class="difflineplus">+  if (mShowFullName) {</span>
<a href="#l21.868"></a><span id="l21.868" class="difflineplus">+    return NS_MsgDecodeUnescapeURLPath(aPath, aLeafName);</span>
<a href="#l21.869"></a><span id="l21.869" class="difflineplus">+  }</span>
<a href="#l21.870"></a><span id="l21.870"> </span>
<a href="#l21.871"></a><span id="l21.871" class="difflineminus">-    return CopyMUTF7toUTF16(nsDependentCString(node-&gt;name), aLeafName);</span>
<a href="#l21.872"></a><span id="l21.872" class="difflineplus">+  return CopyMUTF7toUTF16(nsDependentCString(node-&gt;name), aLeafName);</span>
<a href="#l21.873"></a><span id="l21.873"> }</span>
<a href="#l21.874"></a><span id="l21.874"> </span>
<a href="#l21.875"></a><span id="l21.875"> NS_IMETHODIMP</span>
<a href="#l21.876"></a><span id="l21.876"> nsSubscribableServer::GetFirstChildURI(const nsACString &amp;aPath,</span>
<a href="#l21.877"></a><span id="l21.877" class="difflineminus">-                                       nsACString &amp;aResult)</span>
<a href="#l21.878"></a><span id="l21.878" class="difflineminus">-{</span>
<a href="#l21.879"></a><span id="l21.879" class="difflineminus">-    aResult.Truncate();</span>
<a href="#l21.880"></a><span id="l21.880" class="difflineplus">+                                       nsACString &amp;aResult) {</span>
<a href="#l21.881"></a><span id="l21.881" class="difflineplus">+  aResult.Truncate();</span>
<a href="#l21.882"></a><span id="l21.882"> </span>
<a href="#l21.883"></a><span id="l21.883" class="difflineminus">-    SubscribeTreeNode *node = nullptr;</span>
<a href="#l21.884"></a><span id="l21.884" class="difflineminus">-    nsresult rv = FindAndCreateNode(aPath, &amp;node);</span>
<a href="#l21.885"></a><span id="l21.885" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l21.886"></a><span id="l21.886" class="difflineplus">+  SubscribeTreeNode *node = nullptr;</span>
<a href="#l21.887"></a><span id="l21.887" class="difflineplus">+  nsresult rv = FindAndCreateNode(aPath, &amp;node);</span>
<a href="#l21.888"></a><span id="l21.888" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.889"></a><span id="l21.889"> </span>
<a href="#l21.890"></a><span id="l21.890" class="difflineminus">-    NS_ASSERTION(node,&quot;didn't find the node&quot;);</span>
<a href="#l21.891"></a><span id="l21.891" class="difflineminus">-    if (!node) return NS_ERROR_FAILURE;</span>
<a href="#l21.892"></a><span id="l21.892" class="difflineplus">+  NS_ASSERTION(node, &quot;didn't find the node&quot;);</span>
<a href="#l21.893"></a><span id="l21.893" class="difflineplus">+  if (!node) return NS_ERROR_FAILURE;</span>
<a href="#l21.894"></a><span id="l21.894"> </span>
<a href="#l21.895"></a><span id="l21.895" class="difflineminus">-    // no children</span>
<a href="#l21.896"></a><span id="l21.896" class="difflineminus">-    if (!node-&gt;firstChild) return NS_ERROR_FAILURE;</span>
<a href="#l21.897"></a><span id="l21.897" class="difflineplus">+  // no children</span>
<a href="#l21.898"></a><span id="l21.898" class="difflineplus">+  if (!node-&gt;firstChild) return NS_ERROR_FAILURE;</span>
<a href="#l21.899"></a><span id="l21.899"> </span>
<a href="#l21.900"></a><span id="l21.900" class="difflineminus">-    aResult.Assign(node-&gt;firstChild-&gt;path);</span>
<a href="#l21.901"></a><span id="l21.901" class="difflineplus">+  aResult.Assign(node-&gt;firstChild-&gt;path);</span>
<a href="#l21.902"></a><span id="l21.902"> </span>
<a href="#l21.903"></a><span id="l21.903" class="difflineminus">-    return NS_OK;</span>
<a href="#l21.904"></a><span id="l21.904" class="difflineplus">+  return NS_OK;</span>
<a href="#l21.905"></a><span id="l21.905"> }</span>
<a href="#l21.906"></a><span id="l21.906"> </span>
<a href="#l21.907"></a><span id="l21.907"> NS_IMETHODIMP</span>
<a href="#l21.908"></a><span id="l21.908"> nsSubscribableServer::GetChildURIs(const nsACString &amp;aPath,</span>
<a href="#l21.909"></a><span id="l21.909" class="difflineminus">-                                   nsIUTF8StringEnumerator **aResult)</span>
<a href="#l21.910"></a><span id="l21.910" class="difflineminus">-{</span>
<a href="#l21.911"></a><span id="l21.911" class="difflineminus">-    SubscribeTreeNode *node = nullptr;</span>
<a href="#l21.912"></a><span id="l21.912" class="difflineminus">-    nsresult rv = FindAndCreateNode(aPath, &amp;node);</span>
<a href="#l21.913"></a><span id="l21.913" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.914"></a><span id="l21.914" class="difflineplus">+                                   nsIUTF8StringEnumerator **aResult) {</span>
<a href="#l21.915"></a><span id="l21.915" class="difflineplus">+  SubscribeTreeNode *node = nullptr;</span>
<a href="#l21.916"></a><span id="l21.916" class="difflineplus">+  nsresult rv = FindAndCreateNode(aPath, &amp;node);</span>
<a href="#l21.917"></a><span id="l21.917" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.918"></a><span id="l21.918"> </span>
<a href="#l21.919"></a><span id="l21.919" class="difflineminus">-    NS_ASSERTION(node,&quot;didn't find the node&quot;);</span>
<a href="#l21.920"></a><span id="l21.920" class="difflineminus">-    if (!node)</span>
<a href="#l21.921"></a><span id="l21.921" class="difflineminus">-      return NS_ERROR_FAILURE;</span>
<a href="#l21.922"></a><span id="l21.922" class="difflineplus">+  NS_ASSERTION(node, &quot;didn't find the node&quot;);</span>
<a href="#l21.923"></a><span id="l21.923" class="difflineplus">+  if (!node) return NS_ERROR_FAILURE;</span>
<a href="#l21.924"></a><span id="l21.924"> </span>
<a href="#l21.925"></a><span id="l21.925" class="difflineminus">-    NS_ASSERTION(mTreeRoot, &quot;no tree root!&quot;);</span>
<a href="#l21.926"></a><span id="l21.926" class="difflineminus">-    if (!mTreeRoot)</span>
<a href="#l21.927"></a><span id="l21.927" class="difflineminus">-      return NS_ERROR_UNEXPECTED;</span>
<a href="#l21.928"></a><span id="l21.928" class="difflineplus">+  NS_ASSERTION(mTreeRoot, &quot;no tree root!&quot;);</span>
<a href="#l21.929"></a><span id="l21.929" class="difflineplus">+  if (!mTreeRoot) return NS_ERROR_UNEXPECTED;</span>
<a href="#l21.930"></a><span id="l21.930"> </span>
<a href="#l21.931"></a><span id="l21.931" class="difflineminus">-    // We inserted them in reverse alphabetical order.</span>
<a href="#l21.932"></a><span id="l21.932" class="difflineminus">-    // So pull them out in reverse to get the right order</span>
<a href="#l21.933"></a><span id="l21.933" class="difflineminus">-    // in the subscribe dialog.</span>
<a href="#l21.934"></a><span id="l21.934" class="difflineminus">-    SubscribeTreeNode *current = node-&gt;lastChild;</span>
<a href="#l21.935"></a><span id="l21.935" class="difflineminus">-    // return failure if there are no children.</span>
<a href="#l21.936"></a><span id="l21.936" class="difflineminus">-    if (!current)</span>
<a href="#l21.937"></a><span id="l21.937" class="difflineminus">-      return NS_ERROR_FAILURE;</span>
<a href="#l21.938"></a><span id="l21.938" class="difflineplus">+  // We inserted them in reverse alphabetical order.</span>
<a href="#l21.939"></a><span id="l21.939" class="difflineplus">+  // So pull them out in reverse to get the right order</span>
<a href="#l21.940"></a><span id="l21.940" class="difflineplus">+  // in the subscribe dialog.</span>
<a href="#l21.941"></a><span id="l21.941" class="difflineplus">+  SubscribeTreeNode *current = node-&gt;lastChild;</span>
<a href="#l21.942"></a><span id="l21.942" class="difflineplus">+  // return failure if there are no children.</span>
<a href="#l21.943"></a><span id="l21.943" class="difflineplus">+  if (!current) return NS_ERROR_FAILURE;</span>
<a href="#l21.944"></a><span id="l21.944"> </span>
<a href="#l21.945"></a><span id="l21.945" class="difflineminus">-    nsTArray&lt;nsCString&gt; *result = new nsTArray&lt;nsCString&gt;;</span>
<a href="#l21.946"></a><span id="l21.946" class="difflineplus">+  nsTArray&lt;nsCString&gt; *result = new nsTArray&lt;nsCString&gt;;</span>
<a href="#l21.947"></a><span id="l21.947"> </span>
<a href="#l21.948"></a><span id="l21.948" class="difflineminus">-    while (current) {</span>
<a href="#l21.949"></a><span id="l21.949" class="difflineminus">-        NS_ASSERTION(current-&gt;name, &quot;no name&quot;);</span>
<a href="#l21.950"></a><span id="l21.950" class="difflineminus">-        if (!current-&gt;name)</span>
<a href="#l21.951"></a><span id="l21.951" class="difflineminus">-          return NS_ERROR_FAILURE;</span>
<a href="#l21.952"></a><span id="l21.952" class="difflineplus">+  while (current) {</span>
<a href="#l21.953"></a><span id="l21.953" class="difflineplus">+    NS_ASSERTION(current-&gt;name, &quot;no name&quot;);</span>
<a href="#l21.954"></a><span id="l21.954" class="difflineplus">+    if (!current-&gt;name) return NS_ERROR_FAILURE;</span>
<a href="#l21.955"></a><span id="l21.955"> </span>
<a href="#l21.956"></a><span id="l21.956" class="difflineminus">-        result-&gt;AppendElement(current-&gt;path);</span>
<a href="#l21.957"></a><span id="l21.957" class="difflineplus">+    result-&gt;AppendElement(current-&gt;path);</span>
<a href="#l21.958"></a><span id="l21.958"> </span>
<a href="#l21.959"></a><span id="l21.959" class="difflineminus">-        current = current-&gt;prevSibling;</span>
<a href="#l21.960"></a><span id="l21.960" class="difflineminus">-    }</span>
<a href="#l21.961"></a><span id="l21.961" class="difflineplus">+    current = current-&gt;prevSibling;</span>
<a href="#l21.962"></a><span id="l21.962" class="difflineplus">+  }</span>
<a href="#l21.963"></a><span id="l21.963"> </span>
<a href="#l21.964"></a><span id="l21.964" class="difflineminus">-    rv = NS_NewAdoptingUTF8StringEnumerator(aResult, result);</span>
<a href="#l21.965"></a><span id="l21.965" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l21.966"></a><span id="l21.966" class="difflineminus">-      delete result;</span>
<a href="#l21.967"></a><span id="l21.967" class="difflineplus">+  rv = NS_NewAdoptingUTF8StringEnumerator(aResult, result);</span>
<a href="#l21.968"></a><span id="l21.968" class="difflineplus">+  if (NS_FAILED(rv)) delete result;</span>
<a href="#l21.969"></a><span id="l21.969"> </span>
<a href="#l21.970"></a><span id="l21.970" class="difflineminus">-    return rv;</span>
<a href="#l21.971"></a><span id="l21.971" class="difflineplus">+  return rv;</span>
<a href="#l21.972"></a><span id="l21.972"> }</span>
<a href="#l21.973"></a><span id="l21.973"> </span>
<a href="#l21.974"></a><span id="l21.974"> NS_IMETHODIMP</span>
<a href="#l21.975"></a><span id="l21.975" class="difflineminus">-nsSubscribableServer::CommitSubscribeChanges()</span>
<a href="#l21.976"></a><span id="l21.976" class="difflineminus">-{</span>
<a href="#l21.977"></a><span id="l21.977" class="difflineminus">-    NS_ASSERTION(false,&quot;override this.&quot;);</span>
<a href="#l21.978"></a><span id="l21.978" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l21.979"></a><span id="l21.979" class="difflineplus">+nsSubscribableServer::CommitSubscribeChanges() {</span>
<a href="#l21.980"></a><span id="l21.980" class="difflineplus">+  NS_ASSERTION(false, &quot;override this.&quot;);</span>
<a href="#l21.981"></a><span id="l21.981" class="difflineplus">+  return NS_ERROR_FAILURE;</span>
<a href="#l21.982"></a><span id="l21.982"> }</span>
<a href="#l21.983"></a><span id="l21.983"> </span>
<a href="#l21.984"></a><span id="l21.984"> NS_IMETHODIMP</span>
<a href="#l21.985"></a><span id="l21.985" class="difflineminus">-nsSubscribableServer::SetSearchValue(const nsAString &amp;aSearchValue)</span>
<a href="#l21.986"></a><span id="l21.986" class="difflineminus">-{</span>
<a href="#l21.987"></a><span id="l21.987" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l21.988"></a><span id="l21.988" class="difflineplus">+nsSubscribableServer::SetSearchValue(const nsAString &amp;aSearchValue) {</span>
<a href="#l21.989"></a><span id="l21.989" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l21.990"></a><span id="l21.990"> }</span>
<a href="#l21.991"></a><span id="l21.991"> </span>
<a href="#l21.992"></a><span id="l21.992"> NS_IMETHODIMP</span>
<a href="#l21.993"></a><span id="l21.993" class="difflineminus">-nsSubscribableServer::GetSupportsSubscribeSearch(bool *retVal)</span>
<a href="#l21.994"></a><span id="l21.994" class="difflineminus">-{</span>
<a href="#l21.995"></a><span id="l21.995" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l21.996"></a><span id="l21.996" class="difflineplus">+nsSubscribableServer::GetSupportsSubscribeSearch(bool *retVal) {</span>
<a href="#l21.997"></a><span id="l21.997" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l21.998"></a><span id="l21.998"> }</span>
<a href="#l21.999"></a><span id="l21.999"> </span>
<a href="#l21.1000"></a><span id="l21.1000"> NS_IMETHODIMP</span>
<a href="#l21.1001"></a><span id="l21.1001" class="difflineminus">-nsSubscribableServer::GetFolderView(nsITreeView **aView)</span>
<a href="#l21.1002"></a><span id="l21.1002" class="difflineminus">-{</span>
<a href="#l21.1003"></a><span id="l21.1003" class="difflineplus">+nsSubscribableServer::GetFolderView(nsITreeView **aView) {</span>
<a href="#l21.1004"></a><span id="l21.1004">   NS_ENSURE_ARG_POINTER(aView);</span>
<a href="#l21.1005"></a><span id="l21.1005" class="difflineminus">-  return this-&gt;QueryInterface(NS_GET_IID(nsITreeView), (void**)aView);</span>
<a href="#l21.1006"></a><span id="l21.1006" class="difflineplus">+  return this-&gt;QueryInterface(NS_GET_IID(nsITreeView), (void **)aView);</span>
<a href="#l21.1007"></a><span id="l21.1007"> }</span>
<a href="#l21.1008"></a><span id="l21.1008"> </span>
<a href="#l21.1009"></a><span id="l21.1009" class="difflineminus">-int32_t</span>
<a href="#l21.1010"></a><span id="l21.1010" class="difflineminus">-nsSubscribableServer::GetRow(SubscribeTreeNode *node, bool *open)</span>
<a href="#l21.1011"></a><span id="l21.1011" class="difflineminus">-{</span>
<a href="#l21.1012"></a><span id="l21.1012" class="difflineplus">+int32_t nsSubscribableServer::GetRow(SubscribeTreeNode *node, bool *open) {</span>
<a href="#l21.1013"></a><span id="l21.1013">   int32_t parentRow = -1;</span>
<a href="#l21.1014"></a><span id="l21.1014" class="difflineminus">-  if (node-&gt;parent)</span>
<a href="#l21.1015"></a><span id="l21.1015" class="difflineminus">-    parentRow = GetRow(node-&gt;parent, open);</span>
<a href="#l21.1016"></a><span id="l21.1016" class="difflineplus">+  if (node-&gt;parent) parentRow = GetRow(node-&gt;parent, open);</span>
<a href="#l21.1017"></a><span id="l21.1017"> </span>
<a href="#l21.1018"></a><span id="l21.1018">   // If the parent wasn't opened, we're not in the row map</span>
<a href="#l21.1019"></a><span id="l21.1019" class="difflineminus">-  if (open &amp;&amp; *open == false)</span>
<a href="#l21.1020"></a><span id="l21.1020" class="difflineminus">-    return -1;</span>
<a href="#l21.1021"></a><span id="l21.1021" class="difflineplus">+  if (open &amp;&amp; *open == false) return -1;</span>
<a href="#l21.1022"></a><span id="l21.1022"> </span>
<a href="#l21.1023"></a><span id="l21.1023" class="difflineminus">-  if (open)</span>
<a href="#l21.1024"></a><span id="l21.1024" class="difflineminus">-    *open = node-&gt;isOpen;</span>
<a href="#l21.1025"></a><span id="l21.1025" class="difflineplus">+  if (open) *open = node-&gt;isOpen;</span>
<a href="#l21.1026"></a><span id="l21.1026"> </span>
<a href="#l21.1027"></a><span id="l21.1027" class="difflineminus">-  for (uint32_t row = parentRow + 1; row &lt; mRowMap.Length(); row++)</span>
<a href="#l21.1028"></a><span id="l21.1028" class="difflineminus">-  {</span>
<a href="#l21.1029"></a><span id="l21.1029" class="difflineminus">-    if (mRowMap[row] == node)</span>
<a href="#l21.1030"></a><span id="l21.1030" class="difflineminus">-      return row;</span>
<a href="#l21.1031"></a><span id="l21.1031" class="difflineplus">+  for (uint32_t row = parentRow + 1; row &lt; mRowMap.Length(); row++) {</span>
<a href="#l21.1032"></a><span id="l21.1032" class="difflineplus">+    if (mRowMap[row] == node) return row;</span>
<a href="#l21.1033"></a><span id="l21.1033">   }</span>
<a href="#l21.1034"></a><span id="l21.1034"> </span>
<a href="#l21.1035"></a><span id="l21.1035">   // Apparently, we're not in the map</span>
<a href="#l21.1036"></a><span id="l21.1036">   return -1;</span>
<a href="#l21.1037"></a><span id="l21.1037"> }</span>
<a href="#l21.1038"></a><span id="l21.1038"> </span>
<a href="#l21.1039"></a><span id="l21.1039"> NS_IMETHODIMP</span>
<a href="#l21.1040"></a><span id="l21.1040" class="difflineminus">-nsSubscribableServer::GetSelection(nsITreeSelection **selection)</span>
<a href="#l21.1041"></a><span id="l21.1041" class="difflineminus">-{</span>
<a href="#l21.1042"></a><span id="l21.1042" class="difflineplus">+nsSubscribableServer::GetSelection(nsITreeSelection **selection) {</span>
<a href="#l21.1043"></a><span id="l21.1043">   NS_IF_ADDREF(*selection = mSelection);</span>
<a href="#l21.1044"></a><span id="l21.1044">   return NS_OK;</span>
<a href="#l21.1045"></a><span id="l21.1045"> }</span>
<a href="#l21.1046"></a><span id="l21.1046"> </span>
<a href="#l21.1047"></a><span id="l21.1047"> NS_IMETHODIMP</span>
<a href="#l21.1048"></a><span id="l21.1048" class="difflineminus">-nsSubscribableServer::SetSelection(nsITreeSelection *selection)</span>
<a href="#l21.1049"></a><span id="l21.1049" class="difflineminus">-{</span>
<a href="#l21.1050"></a><span id="l21.1050" class="difflineplus">+nsSubscribableServer::SetSelection(nsITreeSelection *selection) {</span>
<a href="#l21.1051"></a><span id="l21.1051">   mSelection = selection;</span>
<a href="#l21.1052"></a><span id="l21.1052">   return NS_OK;</span>
<a href="#l21.1053"></a><span id="l21.1053"> }</span>
<a href="#l21.1054"></a><span id="l21.1054"> </span>
<a href="#l21.1055"></a><span id="l21.1055"> NS_IMETHODIMP</span>
<a href="#l21.1056"></a><span id="l21.1056" class="difflineminus">-nsSubscribableServer::GetRowCount(int32_t *rowCount)</span>
<a href="#l21.1057"></a><span id="l21.1057" class="difflineminus">-{</span>
<a href="#l21.1058"></a><span id="l21.1058" class="difflineplus">+nsSubscribableServer::GetRowCount(int32_t *rowCount) {</span>
<a href="#l21.1059"></a><span id="l21.1059">   *rowCount = mRowMap.Length();</span>
<a href="#l21.1060"></a><span id="l21.1060">   return NS_OK;</span>
<a href="#l21.1061"></a><span id="l21.1061"> }</span>
<a href="#l21.1062"></a><span id="l21.1062"> </span>
<a href="#l21.1063"></a><span id="l21.1063"> NS_IMETHODIMP</span>
<a href="#l21.1064"></a><span id="l21.1064" class="difflineminus">-nsSubscribableServer::SetTree(mozilla::dom::XULTreeElement *aTree)</span>
<a href="#l21.1065"></a><span id="l21.1065" class="difflineminus">-{</span>
<a href="#l21.1066"></a><span id="l21.1066" class="difflineplus">+nsSubscribableServer::SetTree(mozilla::dom::XULTreeElement *aTree) {</span>
<a href="#l21.1067"></a><span id="l21.1067">   mTree = aTree;</span>
<a href="#l21.1068"></a><span id="l21.1068">   return NS_OK;</span>
<a href="#l21.1069"></a><span id="l21.1069"> }</span>
<a href="#l21.1070"></a><span id="l21.1070"> </span>
<a href="#l21.1071"></a><span id="l21.1071"> NS_IMETHODIMP</span>
<a href="#l21.1072"></a><span id="l21.1072" class="difflineminus">-nsSubscribableServer::IsContainer(int32_t aIndex, bool *retval)</span>
<a href="#l21.1073"></a><span id="l21.1073" class="difflineminus">-{</span>
<a href="#l21.1074"></a><span id="l21.1074" class="difflineplus">+nsSubscribableServer::IsContainer(int32_t aIndex, bool *retval) {</span>
<a href="#l21.1075"></a><span id="l21.1075">   *retval = !!mRowMap[aIndex]-&gt;firstChild;</span>
<a href="#l21.1076"></a><span id="l21.1076">   return NS_OK;</span>
<a href="#l21.1077"></a><span id="l21.1077"> }</span>
<a href="#l21.1078"></a><span id="l21.1078"> </span>
<a href="#l21.1079"></a><span id="l21.1079"> NS_IMETHODIMP</span>
<a href="#l21.1080"></a><span id="l21.1080" class="difflineminus">-nsSubscribableServer::IsContainerEmpty(int32_t aIndex, bool *retval)</span>
<a href="#l21.1081"></a><span id="l21.1081" class="difflineminus">-{</span>
<a href="#l21.1082"></a><span id="l21.1082" class="difflineplus">+nsSubscribableServer::IsContainerEmpty(int32_t aIndex, bool *retval) {</span>
<a href="#l21.1083"></a><span id="l21.1083">   *retval = false;</span>
<a href="#l21.1084"></a><span id="l21.1084">   return NS_OK;</span>
<a href="#l21.1085"></a><span id="l21.1085"> }</span>
<a href="#l21.1086"></a><span id="l21.1086"> </span>
<a href="#l21.1087"></a><span id="l21.1087"> NS_IMETHODIMP</span>
<a href="#l21.1088"></a><span id="l21.1088" class="difflineminus">-nsSubscribableServer::IsContainerOpen(int32_t aIndex, bool *retval)</span>
<a href="#l21.1089"></a><span id="l21.1089" class="difflineminus">-{</span>
<a href="#l21.1090"></a><span id="l21.1090" class="difflineplus">+nsSubscribableServer::IsContainerOpen(int32_t aIndex, bool *retval) {</span>
<a href="#l21.1091"></a><span id="l21.1091">   *retval = mRowMap[aIndex]-&gt;isOpen;</span>
<a href="#l21.1092"></a><span id="l21.1092">   return NS_OK;</span>
<a href="#l21.1093"></a><span id="l21.1093"> }</span>
<a href="#l21.1094"></a><span id="l21.1094"> </span>
<a href="#l21.1095"></a><span id="l21.1095"> NS_IMETHODIMP</span>
<a href="#l21.1096"></a><span id="l21.1096" class="difflineminus">-nsSubscribableServer::GetParentIndex(int32_t aIndex, int32_t *retval)</span>
<a href="#l21.1097"></a><span id="l21.1097" class="difflineminus">-{</span>
<a href="#l21.1098"></a><span id="l21.1098" class="difflineplus">+nsSubscribableServer::GetParentIndex(int32_t aIndex, int32_t *retval) {</span>
<a href="#l21.1099"></a><span id="l21.1099">   SubscribeTreeNode *parent = mRowMap[aIndex]-&gt;parent;</span>
<a href="#l21.1100"></a><span id="l21.1100" class="difflineminus">-  if (!parent)</span>
<a href="#l21.1101"></a><span id="l21.1101" class="difflineminus">-  {</span>
<a href="#l21.1102"></a><span id="l21.1102" class="difflineplus">+  if (!parent) {</span>
<a href="#l21.1103"></a><span id="l21.1103">     *retval = -1;</span>
<a href="#l21.1104"></a><span id="l21.1104">     return NS_OK;</span>
<a href="#l21.1105"></a><span id="l21.1105">   }</span>
<a href="#l21.1106"></a><span id="l21.1106"> </span>
<a href="#l21.1107"></a><span id="l21.1107">   int32_t index;</span>
<a href="#l21.1108"></a><span id="l21.1108" class="difflineminus">-  for (index = aIndex - 1; index &gt;= 0; index--)</span>
<a href="#l21.1109"></a><span id="l21.1109" class="difflineminus">-  {</span>
<a href="#l21.1110"></a><span id="l21.1110" class="difflineminus">-    if (mRowMap[index] == parent)</span>
<a href="#l21.1111"></a><span id="l21.1111" class="difflineminus">-    {</span>
<a href="#l21.1112"></a><span id="l21.1112" class="difflineplus">+  for (index = aIndex - 1; index &gt;= 0; index--) {</span>
<a href="#l21.1113"></a><span id="l21.1113" class="difflineplus">+    if (mRowMap[index] == parent) {</span>
<a href="#l21.1114"></a><span id="l21.1114">       *retval = index;</span>
<a href="#l21.1115"></a><span id="l21.1115">       return NS_OK;</span>
<a href="#l21.1116"></a><span id="l21.1116">     }</span>
<a href="#l21.1117"></a><span id="l21.1117">   }</span>
<a href="#l21.1118"></a><span id="l21.1118">   *retval = -1;</span>
<a href="#l21.1119"></a><span id="l21.1119">   return NS_OK;</span>
<a href="#l21.1120"></a><span id="l21.1120"> }</span>
<a href="#l21.1121"></a><span id="l21.1121"> </span>
<a href="#l21.1122"></a><span id="l21.1122"> NS_IMETHODIMP</span>
<a href="#l21.1123"></a><span id="l21.1123"> nsSubscribableServer::HasNextSibling(int32_t aRowIndex, int32_t aAfterIndex,</span>
<a href="#l21.1124"></a><span id="l21.1124" class="difflineminus">-                                     bool *retval)</span>
<a href="#l21.1125"></a><span id="l21.1125" class="difflineminus">-{</span>
<a href="#l21.1126"></a><span id="l21.1126" class="difflineplus">+                                     bool *retval) {</span>
<a href="#l21.1127"></a><span id="l21.1127">   // This looks odd, but is correct. Using -&gt;nextSibling gives a bad tree.</span>
<a href="#l21.1128"></a><span id="l21.1128">   *retval = !!mRowMap[aRowIndex]-&gt;prevSibling;</span>
<a href="#l21.1129"></a><span id="l21.1129">   return NS_OK;</span>
<a href="#l21.1130"></a><span id="l21.1130"> }</span>
<a href="#l21.1131"></a><span id="l21.1131"> </span>
<a href="#l21.1132"></a><span id="l21.1132"> NS_IMETHODIMP</span>
<a href="#l21.1133"></a><span id="l21.1133" class="difflineminus">-nsSubscribableServer::GetLevel(int32_t aIndex, int32_t *retval)</span>
<a href="#l21.1134"></a><span id="l21.1134" class="difflineminus">-{</span>
<a href="#l21.1135"></a><span id="l21.1135" class="difflineplus">+nsSubscribableServer::GetLevel(int32_t aIndex, int32_t *retval) {</span>
<a href="#l21.1136"></a><span id="l21.1136">   // When starting with -2, we increase twice and return 0 for a top level node.</span>
<a href="#l21.1137"></a><span id="l21.1137">   int32_t level = -2;</span>
<a href="#l21.1138"></a><span id="l21.1138">   SubscribeTreeNode *node = mRowMap[aIndex];</span>
<a href="#l21.1139"></a><span id="l21.1139" class="difflineminus">-  while (node)</span>
<a href="#l21.1140"></a><span id="l21.1140" class="difflineminus">-  {</span>
<a href="#l21.1141"></a><span id="l21.1141" class="difflineplus">+  while (node) {</span>
<a href="#l21.1142"></a><span id="l21.1142">     node = node-&gt;parent;</span>
<a href="#l21.1143"></a><span id="l21.1143">     level++;</span>
<a href="#l21.1144"></a><span id="l21.1144">   }</span>
<a href="#l21.1145"></a><span id="l21.1145"> </span>
<a href="#l21.1146"></a><span id="l21.1146">   *retval = level;</span>
<a href="#l21.1147"></a><span id="l21.1147">   return NS_OK;</span>
<a href="#l21.1148"></a><span id="l21.1148"> }</span>
<a href="#l21.1149"></a><span id="l21.1149"> </span>
<a href="#l21.1150"></a><span id="l21.1150"> NS_IMETHODIMP</span>
<a href="#l21.1151"></a><span id="l21.1151" class="difflineminus">-nsSubscribableServer::ToggleOpenState(int32_t aIndex)</span>
<a href="#l21.1152"></a><span id="l21.1152" class="difflineminus">-{</span>
<a href="#l21.1153"></a><span id="l21.1153" class="difflineplus">+nsSubscribableServer::ToggleOpenState(int32_t aIndex) {</span>
<a href="#l21.1154"></a><span id="l21.1154">   SubscribeTreeNode *node = mRowMap[aIndex];</span>
<a href="#l21.1155"></a><span id="l21.1155" class="difflineminus">-  if (node-&gt;isOpen)</span>
<a href="#l21.1156"></a><span id="l21.1156" class="difflineminus">-  {</span>
<a href="#l21.1157"></a><span id="l21.1157" class="difflineplus">+  if (node-&gt;isOpen) {</span>
<a href="#l21.1158"></a><span id="l21.1158">     node-&gt;isOpen = false;</span>
<a href="#l21.1159"></a><span id="l21.1159"> </span>
<a href="#l21.1160"></a><span id="l21.1160">     // Remove subtree by deleting elements from array up to next sibling.</span>
<a href="#l21.1161"></a><span id="l21.1161">     int32_t count = 0;</span>
<a href="#l21.1162"></a><span id="l21.1162">     do {</span>
<a href="#l21.1163"></a><span id="l21.1163">       // Find next sibling or the beginning of the next subtree.</span>
<a href="#l21.1164"></a><span id="l21.1164">       if (node-&gt;prevSibling) {</span>
<a href="#l21.1165"></a><span id="l21.1165">         count = mRowMap.IndexOf(node-&gt;prevSibling, aIndex) - aIndex - 1;</span>
<a href="#l21.1166"></a><span id="l21.1166" class="difflineat">@@ -809,106 +741,92 @@ nsSubscribableServer::ToggleOpenState(in</span>
<a href="#l21.1167"></a><span id="l21.1167">         node = node-&gt;parent;</span>
<a href="#l21.1168"></a><span id="l21.1168">         // When node reaches the root, delete the rest of the array.</span>
<a href="#l21.1169"></a><span id="l21.1169">         if (!node-&gt;parent) {</span>
<a href="#l21.1170"></a><span id="l21.1170">           count = mRowMap.Length() - aIndex - 1;</span>
<a href="#l21.1171"></a><span id="l21.1171">         }</span>
<a href="#l21.1172"></a><span id="l21.1172">       }</span>
<a href="#l21.1173"></a><span id="l21.1173">     } while (!count &amp;&amp; node-&gt;parent);</span>
<a href="#l21.1174"></a><span id="l21.1174">     mRowMap.RemoveElementsAt(aIndex + 1, count);</span>
<a href="#l21.1175"></a><span id="l21.1175" class="difflineminus">-    if (mTree)</span>
<a href="#l21.1176"></a><span id="l21.1176" class="difflineminus">-    {</span>
<a href="#l21.1177"></a><span id="l21.1177" class="difflineplus">+    if (mTree) {</span>
<a href="#l21.1178"></a><span id="l21.1178">       mTree-&gt;RowCountChanged(aIndex + 1, -count);</span>
<a href="#l21.1179"></a><span id="l21.1179">       mTree-&gt;InvalidateRow(aIndex);</span>
<a href="#l21.1180"></a><span id="l21.1180">     }</span>
<a href="#l21.1181"></a><span id="l21.1181" class="difflineminus">-  }</span>
<a href="#l21.1182"></a><span id="l21.1182" class="difflineminus">-  else</span>
<a href="#l21.1183"></a><span id="l21.1183" class="difflineminus">-  {</span>
<a href="#l21.1184"></a><span id="l21.1184" class="difflineplus">+  } else {</span>
<a href="#l21.1185"></a><span id="l21.1185">     // Recursively add the children nodes (i.e., remember open)</span>
<a href="#l21.1186"></a><span id="l21.1186">     node-&gt;isOpen = true;</span>
<a href="#l21.1187"></a><span id="l21.1187">     int32_t total = 0;</span>
<a href="#l21.1188"></a><span id="l21.1188">     node = node-&gt;lastChild;</span>
<a href="#l21.1189"></a><span id="l21.1189" class="difflineminus">-    while (node)</span>
<a href="#l21.1190"></a><span id="l21.1190" class="difflineminus">-    {</span>
<a href="#l21.1191"></a><span id="l21.1191" class="difflineplus">+    while (node) {</span>
<a href="#l21.1192"></a><span id="l21.1192">       total += AddSubtree(node, aIndex + 1 + total);</span>
<a href="#l21.1193"></a><span id="l21.1193">       node = node-&gt;prevSibling;</span>
<a href="#l21.1194"></a><span id="l21.1194">     }</span>
<a href="#l21.1195"></a><span id="l21.1195" class="difflineminus">-    if (mTree)</span>
<a href="#l21.1196"></a><span id="l21.1196" class="difflineminus">-    {</span>
<a href="#l21.1197"></a><span id="l21.1197" class="difflineplus">+    if (mTree) {</span>
<a href="#l21.1198"></a><span id="l21.1198">       mTree-&gt;RowCountChanged(aIndex + 1, total);</span>
<a href="#l21.1199"></a><span id="l21.1199">       mTree-&gt;InvalidateRow(aIndex);</span>
<a href="#l21.1200"></a><span id="l21.1200">     }</span>
<a href="#l21.1201"></a><span id="l21.1201">   }</span>
<a href="#l21.1202"></a><span id="l21.1202">   return NS_OK;</span>
<a href="#l21.1203"></a><span id="l21.1203"> }</span>
<a href="#l21.1204"></a><span id="l21.1204"> </span>
<a href="#l21.1205"></a><span id="l21.1205" class="difflineminus">-int32_t</span>
<a href="#l21.1206"></a><span id="l21.1206" class="difflineminus">-nsSubscribableServer::AddSubtree(SubscribeTreeNode *node, int32_t index)</span>
<a href="#l21.1207"></a><span id="l21.1207" class="difflineminus">-{</span>
<a href="#l21.1208"></a><span id="l21.1208" class="difflineplus">+int32_t nsSubscribableServer::AddSubtree(SubscribeTreeNode *node,</span>
<a href="#l21.1209"></a><span id="l21.1209" class="difflineplus">+                                         int32_t index) {</span>
<a href="#l21.1210"></a><span id="l21.1210">   mRowMap.InsertElementAt(index, node);</span>
<a href="#l21.1211"></a><span id="l21.1211">   int32_t total = 1;</span>
<a href="#l21.1212"></a><span id="l21.1212" class="difflineminus">-  if (node-&gt;isOpen)</span>
<a href="#l21.1213"></a><span id="l21.1213" class="difflineminus">-  {</span>
<a href="#l21.1214"></a><span id="l21.1214" class="difflineplus">+  if (node-&gt;isOpen) {</span>
<a href="#l21.1215"></a><span id="l21.1215">     node = node-&gt;lastChild;</span>
<a href="#l21.1216"></a><span id="l21.1216" class="difflineminus">-    while (node)</span>
<a href="#l21.1217"></a><span id="l21.1217" class="difflineminus">-    {</span>
<a href="#l21.1218"></a><span id="l21.1218" class="difflineplus">+    while (node) {</span>
<a href="#l21.1219"></a><span id="l21.1219">       total += AddSubtree(node, index + total);</span>
<a href="#l21.1220"></a><span id="l21.1220">       node = node-&gt;prevSibling;</span>
<a href="#l21.1221"></a><span id="l21.1221">     }</span>
<a href="#l21.1222"></a><span id="l21.1222">   }</span>
<a href="#l21.1223"></a><span id="l21.1223">   return total;</span>
<a href="#l21.1224"></a><span id="l21.1224"> }</span>
<a href="#l21.1225"></a><span id="l21.1225"> </span>
<a href="#l21.1226"></a><span id="l21.1226"> NS_IMETHODIMP</span>
<a href="#l21.1227"></a><span id="l21.1227"> nsSubscribableServer::GetCellText(int32_t aRow, nsTreeColumn *aCol,</span>
<a href="#l21.1228"></a><span id="l21.1228" class="difflineminus">-                                  nsAString &amp;retval)</span>
<a href="#l21.1229"></a><span id="l21.1229" class="difflineminus">-{</span>
<a href="#l21.1230"></a><span id="l21.1230" class="difflineplus">+                                  nsAString &amp;retval) {</span>
<a href="#l21.1231"></a><span id="l21.1231">   nsString colId;</span>
<a href="#l21.1232"></a><span id="l21.1232">   aCol-&gt;GetId(colId);</span>
<a href="#l21.1233"></a><span id="l21.1233">   if (colId.EqualsLiteral(&quot;nameColumn&quot;)) {</span>
<a href="#l21.1234"></a><span id="l21.1234">     nsCString path(mRowMap[aRow]-&gt;path);</span>
<a href="#l21.1235"></a><span id="l21.1235">     GetLeafName(path, retval);</span>
<a href="#l21.1236"></a><span id="l21.1236">   }</span>
<a href="#l21.1237"></a><span id="l21.1237">   return NS_OK;</span>
<a href="#l21.1238"></a><span id="l21.1238"> }</span>
<a href="#l21.1239"></a><span id="l21.1239"> </span>
<a href="#l21.1240"></a><span id="l21.1240"> NS_IMETHODIMP</span>
<a href="#l21.1241"></a><span id="l21.1241"> nsSubscribableServer::GetCellValue(int32_t aRow, nsTreeColumn *aCol,</span>
<a href="#l21.1242"></a><span id="l21.1242" class="difflineminus">-                                   nsAString &amp;retval)</span>
<a href="#l21.1243"></a><span id="l21.1243" class="difflineminus">-{</span>
<a href="#l21.1244"></a><span id="l21.1244" class="difflineplus">+                                   nsAString &amp;retval) {</span>
<a href="#l21.1245"></a><span id="l21.1245">   nsString colId;</span>
<a href="#l21.1246"></a><span id="l21.1246">   aCol-&gt;GetId(colId);</span>
<a href="#l21.1247"></a><span id="l21.1247">   if (colId.EqualsLiteral(&quot;nameColumn&quot;))</span>
<a href="#l21.1248"></a><span id="l21.1248">     retval = NS_ConvertUTF8toUTF16(mRowMap[aRow]-&gt;path);</span>
<a href="#l21.1249"></a><span id="l21.1249" class="difflineminus">-  if (colId.EqualsLiteral(&quot;subscribedColumn&quot;))</span>
<a href="#l21.1250"></a><span id="l21.1250" class="difflineminus">-  {</span>
<a href="#l21.1251"></a><span id="l21.1251" class="difflineplus">+  if (colId.EqualsLiteral(&quot;subscribedColumn&quot;)) {</span>
<a href="#l21.1252"></a><span id="l21.1252">     retval = mRowMap[aRow]-&gt;isSubscribed ? NS_LITERAL_STRING(&quot;true&quot;)</span>
<a href="#l21.1253"></a><span id="l21.1253">                                          : NS_LITERAL_STRING(&quot;false&quot;);</span>
<a href="#l21.1254"></a><span id="l21.1254">   }</span>
<a href="#l21.1255"></a><span id="l21.1255">   return NS_OK;</span>
<a href="#l21.1256"></a><span id="l21.1256"> }</span>
<a href="#l21.1257"></a><span id="l21.1257"> </span>
<a href="#l21.1258"></a><span id="l21.1258"> NS_IMETHODIMP</span>
<a href="#l21.1259"></a><span id="l21.1259"> nsSubscribableServer::SetCellText(int32_t aRow, nsTreeColumn *aCol,</span>
<a href="#l21.1260"></a><span id="l21.1260" class="difflineminus">-                                  const nsAString &amp;aText)</span>
<a href="#l21.1261"></a><span id="l21.1261" class="difflineminus">-{</span>
<a href="#l21.1262"></a><span id="l21.1262" class="difflineplus">+                                  const nsAString &amp;aText) {</span>
<a href="#l21.1263"></a><span id="l21.1263">   return NS_OK;</span>
<a href="#l21.1264"></a><span id="l21.1264"> }</span>
<a href="#l21.1265"></a><span id="l21.1265"> </span>
<a href="#l21.1266"></a><span id="l21.1266"> NS_IMETHODIMP</span>
<a href="#l21.1267"></a><span id="l21.1267"> nsSubscribableServer::SetCellValue(int32_t aRow, nsTreeColumn *aCol,</span>
<a href="#l21.1268"></a><span id="l21.1268" class="difflineminus">-                                   const nsAString &amp;aText)</span>
<a href="#l21.1269"></a><span id="l21.1269" class="difflineminus">-{</span>
<a href="#l21.1270"></a><span id="l21.1270" class="difflineplus">+                                   const nsAString &amp;aText) {</span>
<a href="#l21.1271"></a><span id="l21.1271">   return NS_OK;</span>
<a href="#l21.1272"></a><span id="l21.1272"> }</span>
<a href="#l21.1273"></a><span id="l21.1273"> </span>
<a href="#l21.1274"></a><span id="l21.1274"> NS_IMETHODIMP</span>
<a href="#l21.1275"></a><span id="l21.1275"> nsSubscribableServer::GetCellProperties(int32_t aRow, nsTreeColumn *aCol,</span>
<a href="#l21.1276"></a><span id="l21.1276" class="difflineminus">-                                        nsAString&amp; aProps)</span>
<a href="#l21.1277"></a><span id="l21.1277" class="difflineminus">-{</span>
<a href="#l21.1278"></a><span id="l21.1278" class="difflineplus">+                                        nsAString &amp;aProps) {</span>
<a href="#l21.1279"></a><span id="l21.1279">   SubscribeTreeNode *node = mRowMap[aRow];</span>
<a href="#l21.1280"></a><span id="l21.1280">   if (node-&gt;isSubscribable)</span>
<a href="#l21.1281"></a><span id="l21.1281">     aProps.AssignLiteral(&quot;subscribable-true&quot;);</span>
<a href="#l21.1282"></a><span id="l21.1282">   else</span>
<a href="#l21.1283"></a><span id="l21.1283">     aProps.AssignLiteral(&quot;subscribable-false&quot;);</span>
<a href="#l21.1284"></a><span id="l21.1284"> </span>
<a href="#l21.1285"></a><span id="l21.1285">   nsString colId;</span>
<a href="#l21.1286"></a><span id="l21.1286">   aCol-&gt;GetId(colId);</span>
<a href="#l21.1287"></a><span id="l21.1287" class="difflineat">@@ -920,100 +838,81 @@ nsSubscribableServer::GetCellProperties(</span>
<a href="#l21.1288"></a><span id="l21.1288">   } else if (colId.EqualsLiteral(&quot;nameColumn&quot;)) {</span>
<a href="#l21.1289"></a><span id="l21.1289">     aProps.AppendLiteral(&quot; serverType-&quot;);</span>
<a href="#l21.1290"></a><span id="l21.1290">     aProps.Append(NS_ConvertUTF8toUTF16(mServerType));</span>
<a href="#l21.1291"></a><span id="l21.1291">   }</span>
<a href="#l21.1292"></a><span id="l21.1292">   return NS_OK;</span>
<a href="#l21.1293"></a><span id="l21.1293"> }</span>
<a href="#l21.1294"></a><span id="l21.1294"> </span>
<a href="#l21.1295"></a><span id="l21.1295"> NS_IMETHODIMP</span>
<a href="#l21.1296"></a><span id="l21.1296" class="difflineminus">-nsSubscribableServer::GetRowProperties(int32_t aRow, nsAString&amp; aProps)</span>
<a href="#l21.1297"></a><span id="l21.1297" class="difflineminus">-{</span>
<a href="#l21.1298"></a><span id="l21.1298" class="difflineplus">+nsSubscribableServer::GetRowProperties(int32_t aRow, nsAString &amp;aProps) {</span>
<a href="#l21.1299"></a><span id="l21.1299">   return NS_OK;</span>
<a href="#l21.1300"></a><span id="l21.1300"> }</span>
<a href="#l21.1301"></a><span id="l21.1301"> </span>
<a href="#l21.1302"></a><span id="l21.1302"> NS_IMETHODIMP</span>
<a href="#l21.1303"></a><span id="l21.1303"> nsSubscribableServer::GetColumnProperties(nsTreeColumn *aCol,</span>
<a href="#l21.1304"></a><span id="l21.1304" class="difflineminus">-                                          nsAString&amp; aProps)</span>
<a href="#l21.1305"></a><span id="l21.1305" class="difflineminus">-{</span>
<a href="#l21.1306"></a><span id="l21.1306" class="difflineplus">+                                          nsAString &amp;aProps) {</span>
<a href="#l21.1307"></a><span id="l21.1307">   return NS_OK;</span>
<a href="#l21.1308"></a><span id="l21.1308"> }</span>
<a href="#l21.1309"></a><span id="l21.1309"> </span>
<a href="#l21.1310"></a><span id="l21.1310"> NS_IMETHODIMP</span>
<a href="#l21.1311"></a><span id="l21.1311"> nsSubscribableServer::IsEditable(int32_t aRow, nsTreeColumn *aCol,</span>
<a href="#l21.1312"></a><span id="l21.1312" class="difflineminus">-                                 bool *retval)</span>
<a href="#l21.1313"></a><span id="l21.1313" class="difflineminus">-{</span>
<a href="#l21.1314"></a><span id="l21.1314" class="difflineplus">+                                 bool *retval) {</span>
<a href="#l21.1315"></a><span id="l21.1315">   *retval = false;</span>
<a href="#l21.1316"></a><span id="l21.1316">   return NS_OK;</span>
<a href="#l21.1317"></a><span id="l21.1317"> }</span>
<a href="#l21.1318"></a><span id="l21.1318"> </span>
<a href="#l21.1319"></a><span id="l21.1319"> NS_IMETHODIMP</span>
<a href="#l21.1320"></a><span id="l21.1320" class="difflineminus">-nsSubscribableServer::IsSeparator(int32_t aRowIndex, bool *retval)</span>
<a href="#l21.1321"></a><span id="l21.1321" class="difflineminus">-{</span>
<a href="#l21.1322"></a><span id="l21.1322" class="difflineplus">+nsSubscribableServer::IsSeparator(int32_t aRowIndex, bool *retval) {</span>
<a href="#l21.1323"></a><span id="l21.1323">   *retval = false;</span>
<a href="#l21.1324"></a><span id="l21.1324">   return NS_OK;</span>
<a href="#l21.1325"></a><span id="l21.1325"> }</span>
<a href="#l21.1326"></a><span id="l21.1326"> </span>
<a href="#l21.1327"></a><span id="l21.1327"> NS_IMETHODIMP</span>
<a href="#l21.1328"></a><span id="l21.1328" class="difflineminus">-nsSubscribableServer::IsSorted(bool *retval)</span>
<a href="#l21.1329"></a><span id="l21.1329" class="difflineminus">-{</span>
<a href="#l21.1330"></a><span id="l21.1330" class="difflineplus">+nsSubscribableServer::IsSorted(bool *retval) {</span>
<a href="#l21.1331"></a><span id="l21.1331">   *retval = false;</span>
<a href="#l21.1332"></a><span id="l21.1332">   return NS_OK;</span>
<a href="#l21.1333"></a><span id="l21.1333"> }</span>
<a href="#l21.1334"></a><span id="l21.1334"> </span>
<a href="#l21.1335"></a><span id="l21.1335"> NS_IMETHODIMP</span>
<a href="#l21.1336"></a><span id="l21.1336"> nsSubscribableServer::CanDrop(int32_t aIndex, int32_t aOrientation,</span>
<a href="#l21.1337"></a><span id="l21.1337" class="difflineminus">-                              mozilla::dom::DataTransfer *aData, bool *retval)</span>
<a href="#l21.1338"></a><span id="l21.1338" class="difflineminus">-{</span>
<a href="#l21.1339"></a><span id="l21.1339" class="difflineplus">+                              mozilla::dom::DataTransfer *aData, bool *retval) {</span>
<a href="#l21.1340"></a><span id="l21.1340">   *retval = false;</span>
<a href="#l21.1341"></a><span id="l21.1341">   return NS_OK;</span>
<a href="#l21.1342"></a><span id="l21.1342"> }</span>
<a href="#l21.1343"></a><span id="l21.1343"> </span>
<a href="#l21.1344"></a><span id="l21.1344"> NS_IMETHODIMP</span>
<a href="#l21.1345"></a><span id="l21.1345"> nsSubscribableServer::Drop(int32_t aRow, int32_t aOrientation,</span>
<a href="#l21.1346"></a><span id="l21.1346" class="difflineminus">-                           mozilla::dom::DataTransfer *aData)</span>
<a href="#l21.1347"></a><span id="l21.1347" class="difflineminus">-{</span>
<a href="#l21.1348"></a><span id="l21.1348" class="difflineplus">+                           mozilla::dom::DataTransfer *aData) {</span>
<a href="#l21.1349"></a><span id="l21.1349">   return NS_OK;</span>
<a href="#l21.1350"></a><span id="l21.1350"> }</span>
<a href="#l21.1351"></a><span id="l21.1351"> </span>
<a href="#l21.1352"></a><span id="l21.1352"> NS_IMETHODIMP</span>
<a href="#l21.1353"></a><span id="l21.1353"> nsSubscribableServer::GetImageSrc(int32_t aRow, nsTreeColumn *aCol,</span>
<a href="#l21.1354"></a><span id="l21.1354" class="difflineminus">-                                  nsAString &amp;retval)</span>
<a href="#l21.1355"></a><span id="l21.1355" class="difflineminus">-{</span>
<a href="#l21.1356"></a><span id="l21.1356" class="difflineminus">-  return NS_OK;</span>
<a href="#l21.1357"></a><span id="l21.1357" class="difflineminus">-}</span>
<a href="#l21.1358"></a><span id="l21.1358" class="difflineminus">-</span>
<a href="#l21.1359"></a><span id="l21.1359" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l21.1360"></a><span id="l21.1360" class="difflineminus">-nsSubscribableServer::CycleHeader(nsTreeColumn *aCol)</span>
<a href="#l21.1361"></a><span id="l21.1361" class="difflineminus">-{</span>
<a href="#l21.1362"></a><span id="l21.1362" class="difflineminus">-  return NS_OK;</span>
<a href="#l21.1363"></a><span id="l21.1363" class="difflineminus">-}</span>
<a href="#l21.1364"></a><span id="l21.1364" class="difflineminus">-</span>
<a href="#l21.1365"></a><span id="l21.1365" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l21.1366"></a><span id="l21.1366" class="difflineminus">-nsSubscribableServer::SelectionChangedXPCOM()</span>
<a href="#l21.1367"></a><span id="l21.1367" class="difflineminus">-{</span>
<a href="#l21.1368"></a><span id="l21.1368" class="difflineplus">+                                  nsAString &amp;retval) {</span>
<a href="#l21.1369"></a><span id="l21.1369">   return NS_OK;</span>
<a href="#l21.1370"></a><span id="l21.1370"> }</span>
<a href="#l21.1371"></a><span id="l21.1371"> </span>
<a href="#l21.1372"></a><span id="l21.1372"> NS_IMETHODIMP</span>
<a href="#l21.1373"></a><span id="l21.1373" class="difflineminus">-nsSubscribableServer::CycleCell(int32_t aRow, nsTreeColumn *aCol)</span>
<a href="#l21.1374"></a><span id="l21.1374" class="difflineminus">-{</span>
<a href="#l21.1375"></a><span id="l21.1375" class="difflineminus">-  return NS_OK;</span>
<a href="#l21.1376"></a><span id="l21.1376" class="difflineminus">-}</span>
<a href="#l21.1377"></a><span id="l21.1377" class="difflineplus">+nsSubscribableServer::CycleHeader(nsTreeColumn *aCol) { return NS_OK; }</span>
<a href="#l21.1378"></a><span id="l21.1378"> </span>
<a href="#l21.1379"></a><span id="l21.1379"> NS_IMETHODIMP</span>
<a href="#l21.1380"></a><span id="l21.1380" class="difflineminus">-nsSubscribableServer::PerformAction(const char16_t *aAction)</span>
<a href="#l21.1381"></a><span id="l21.1381" class="difflineminus">-{</span>
<a href="#l21.1382"></a><span id="l21.1382" class="difflineplus">+nsSubscribableServer::SelectionChangedXPCOM() { return NS_OK; }</span>
<a href="#l21.1383"></a><span id="l21.1383" class="difflineplus">+</span>
<a href="#l21.1384"></a><span id="l21.1384" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l21.1385"></a><span id="l21.1385" class="difflineplus">+nsSubscribableServer::CycleCell(int32_t aRow, nsTreeColumn *aCol) {</span>
<a href="#l21.1386"></a><span id="l21.1386">   return NS_OK;</span>
<a href="#l21.1387"></a><span id="l21.1387"> }</span>
<a href="#l21.1388"></a><span id="l21.1388"> </span>
<a href="#l21.1389"></a><span id="l21.1389"> NS_IMETHODIMP</span>
<a href="#l21.1390"></a><span id="l21.1390" class="difflineminus">-nsSubscribableServer::PerformActionOnRow(const char16_t *aAction, int32_t aRow)</span>
<a href="#l21.1391"></a><span id="l21.1391" class="difflineminus">-{</span>
<a href="#l21.1392"></a><span id="l21.1392" class="difflineplus">+nsSubscribableServer::PerformAction(const char16_t *aAction) { return NS_OK; }</span>
<a href="#l21.1393"></a><span id="l21.1393" class="difflineplus">+</span>
<a href="#l21.1394"></a><span id="l21.1394" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l21.1395"></a><span id="l21.1395" class="difflineplus">+nsSubscribableServer::PerformActionOnRow(const char16_t *aAction,</span>
<a href="#l21.1396"></a><span id="l21.1396" class="difflineplus">+                                         int32_t aRow) {</span>
<a href="#l21.1397"></a><span id="l21.1397">   return NS_OK;</span>
<a href="#l21.1398"></a><span id="l21.1398"> }</span>
<a href="#l21.1399"></a><span id="l21.1399"> </span>
<a href="#l21.1400"></a><span id="l21.1400"> NS_IMETHODIMP</span>
<a href="#l21.1401"></a><span id="l21.1401" class="difflineminus">-nsSubscribableServer::PerformActionOnCell(const char16_t *aAction,</span>
<a href="#l21.1402"></a><span id="l21.1402" class="difflineminus">-                                          int32_t aRow, nsTreeColumn *aCol)</span>
<a href="#l21.1403"></a><span id="l21.1403" class="difflineminus">-{</span>
<a href="#l21.1404"></a><span id="l21.1404" class="difflineplus">+nsSubscribableServer::PerformActionOnCell(const char16_t *aAction, int32_t aRow,</span>
<a href="#l21.1405"></a><span id="l21.1405" class="difflineplus">+                                          nsTreeColumn *aCol) {</span>
<a href="#l21.1406"></a><span id="l21.1406">   return NS_OK;</span>
<a href="#l21.1407"></a><span id="l21.1407"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mailnews/base/src/nsSubscribableServer.h</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mailnews/base/src/nsSubscribableServer.h</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -35,47 +35,49 @@ typedef struct _subscribeTreeNode {</span>
<a href="#l22.4"></a><span id="l22.4"> #endif</span>
<a href="#l22.5"></a><span id="l22.5"> #ifdef HAVE_SUBSCRIBE_MESSAGES</span>
<a href="#l22.6"></a><span id="l22.6">   uint32_t messages;</span>
<a href="#l22.7"></a><span id="l22.7"> #endif</span>
<a href="#l22.8"></a><span id="l22.8">   bool isSubscribable;</span>
<a href="#l22.9"></a><span id="l22.9">   bool isOpen;</span>
<a href="#l22.10"></a><span id="l22.10"> } SubscribeTreeNode;</span>
<a href="#l22.11"></a><span id="l22.11"> </span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineminus">-class nsSubscribableServer : public nsISubscribableServer,</span>
<a href="#l22.14"></a><span id="l22.14" class="difflineminus">-                             public nsITreeView</span>
<a href="#l22.15"></a><span id="l22.15" class="difflineminus">-{</span>
<a href="#l22.16"></a><span id="l22.16" class="difflineminus">-public:</span>
<a href="#l22.17"></a><span id="l22.17" class="difflineplus">+class nsSubscribableServer : public nsISubscribableServer, public nsITreeView {</span>
<a href="#l22.18"></a><span id="l22.18" class="difflineplus">+ public:</span>
<a href="#l22.19"></a><span id="l22.19">   nsSubscribableServer();</span>
<a href="#l22.20"></a><span id="l22.20"> </span>
<a href="#l22.21"></a><span id="l22.21">   nsresult Init();</span>
<a href="#l22.22"></a><span id="l22.22"> </span>
<a href="#l22.23"></a><span id="l22.23">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l22.24"></a><span id="l22.24">   NS_DECL_NSISUBSCRIBABLESERVER</span>
<a href="#l22.25"></a><span id="l22.25">   NS_DECL_NSITREEVIEW</span>
<a href="#l22.26"></a><span id="l22.26"> </span>
<a href="#l22.27"></a><span id="l22.27" class="difflineminus">-private:</span>
<a href="#l22.28"></a><span id="l22.28" class="difflineplus">+ private:</span>
<a href="#l22.29"></a><span id="l22.29">   virtual ~nsSubscribableServer();</span>
<a href="#l22.30"></a><span id="l22.30"> </span>
<a href="#l22.31"></a><span id="l22.31">   nsresult ConvertNameToUnichar(const char *inStr, char16_t **outStr);</span>
<a href="#l22.32"></a><span id="l22.32" class="difflineminus">-  nsCOMPtr &lt;nsISubscribeListener&gt; mSubscribeListener;</span>
<a href="#l22.33"></a><span id="l22.33" class="difflineplus">+  nsCOMPtr&lt;nsISubscribeListener&gt; mSubscribeListener;</span>
<a href="#l22.34"></a><span id="l22.34">   nsCString mIncomingServerUri;</span>
<a href="#l22.35"></a><span id="l22.35">   char mDelimiter;</span>
<a href="#l22.36"></a><span id="l22.36">   bool mShowFullName;</span>
<a href="#l22.37"></a><span id="l22.37">   bool mStopped;</span>
<a href="#l22.38"></a><span id="l22.38">   nsCString mServerType;</span>
<a href="#l22.39"></a><span id="l22.39"> </span>
<a href="#l22.40"></a><span id="l22.40" class="difflineminus">-  SubscribeTreeNode *mTreeRoot;          // root of the folder tree while items are discovered on the server</span>
<a href="#l22.41"></a><span id="l22.41" class="difflineminus">-  nsTArray&lt;SubscribeTreeNode*&gt; mRowMap;  // array of nodes representing the rows for the tree element</span>
<a href="#l22.42"></a><span id="l22.42" class="difflineplus">+  // root of the folder tree while items are discovered on the server</span>
<a href="#l22.43"></a><span id="l22.43" class="difflineplus">+  SubscribeTreeNode *mTreeRoot;</span>
<a href="#l22.44"></a><span id="l22.44" class="difflineplus">+  // array of nodes representing the rows for the tree element</span>
<a href="#l22.45"></a><span id="l22.45" class="difflineplus">+  nsTArray&lt;SubscribeTreeNode *&gt; mRowMap;</span>
<a href="#l22.46"></a><span id="l22.46">   nsCOMPtr&lt;nsITreeSelection&gt; mSelection;</span>
<a href="#l22.47"></a><span id="l22.47">   RefPtr&lt;mozilla::dom::XULTreeElement&gt; mTree;</span>
<a href="#l22.48"></a><span id="l22.48">   nsresult FreeSubtree(SubscribeTreeNode *node);</span>
<a href="#l22.49"></a><span id="l22.49">   nsresult FreeRows();</span>
<a href="#l22.50"></a><span id="l22.50" class="difflineminus">-  nsresult CreateNode(SubscribeTreeNode *parent, const char *name, const nsACString &amp;aPath, SubscribeTreeNode **result);</span>
<a href="#l22.51"></a><span id="l22.51" class="difflineminus">-  nsresult AddChildNode(SubscribeTreeNode *parent, const char *name, const nsACString &amp;aPath, SubscribeTreeNode **child);</span>
<a href="#l22.52"></a><span id="l22.52" class="difflineminus">-  nsresult FindAndCreateNode(const nsACString &amp;aPath, SubscribeTreeNode **aResult);</span>
<a href="#l22.53"></a><span id="l22.53" class="difflineplus">+  nsresult CreateNode(SubscribeTreeNode *parent, const char *name,</span>
<a href="#l22.54"></a><span id="l22.54" class="difflineplus">+                      const nsACString &amp;aPath, SubscribeTreeNode **result);</span>
<a href="#l22.55"></a><span id="l22.55" class="difflineplus">+  nsresult AddChildNode(SubscribeTreeNode *parent, const char *name,</span>
<a href="#l22.56"></a><span id="l22.56" class="difflineplus">+                        const nsACString &amp;aPath, SubscribeTreeNode **child);</span>
<a href="#l22.57"></a><span id="l22.57" class="difflineplus">+  nsresult FindAndCreateNode(const nsACString &amp;aPath,</span>
<a href="#l22.58"></a><span id="l22.58" class="difflineplus">+                             SubscribeTreeNode **aResult);</span>
<a href="#l22.59"></a><span id="l22.59"> </span>
<a href="#l22.60"></a><span id="l22.60">   int32_t GetRow(SubscribeTreeNode *node, bool *open);</span>
<a href="#l22.61"></a><span id="l22.61">   int32_t AddSubtree(SubscribeTreeNode *node, int32_t index);</span>
<a href="#l22.62"></a><span id="l22.62"> };</span>
<a href="#l22.63"></a><span id="l22.63"> </span>
<a href="#l22.64"></a><span id="l22.64" class="difflineminus">-#endif // nsSubscribableServer_h__</span>
<a href="#l22.65"></a><span id="l22.65" class="difflineplus">+#endif  // nsSubscribableServer_h__</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

