<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 26649:f09d11ed16700506b7701168b63ffc1d636127f1</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ f09d11ed16700506b7701168b63ffc1d636127f1" />
<meta property="og:url" content="/comm-central/rev/f09d11ed16700506b7701168b63ffc1d636127f1" />
<meta property="og:description" content="Bug 1552634 - Change bootstrapped extensions to using manifest.json; r=Fallen" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / f09d11ed16700506b7701168b63ffc1d636127f1 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/f09d11ed16700506b7701168b63ffc1d636127f1">shortlog</a> |
<a href="/comm-central/log/f09d11ed16700506b7701168b63ffc1d636127f1">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/f09d11ed16700506b7701168b63ffc1d636127f1">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/f09d11ed16700506b7701168b63ffc1d636127f1">files</a> |
changeset |
<a href="/comm-central/raw-rev/f09d11ed16700506b7701168b63ffc1d636127f1">raw</a>  | <a href="/comm-central/archive/f09d11ed16700506b7701168b63ffc1d636127f1.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1552634">Bug 1552634</a> - Change bootstrapped extensions to using manifest.json; r=Fallen
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#71;&#101;&#111;&#102;&#102;&#32;&#76;&#97;&#110;&#107;&#111;&#119;&#32;&#60;&#103;&#101;&#111;&#102;&#102;&#64;&#100;&#97;&#114;&#107;&#116;&#114;&#111;&#106;&#97;&#110;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 20 May 2019 14:09:38 +1200</td></tr>

<tr>
 <td>changeset 26649</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/f09d11ed16700506b7701168b63ffc1d636127f1">f09d11ed16700506b7701168b63ffc1d636127f1</a></td>
</tr>



<tr>
<td>parent 26648</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/8a37a90aab4ec643fce1e1ab33984613ce0b492d">8a37a90aab4ec643fce1e1ab33984613ce0b492d</a>
</td>
</tr>

<tr>
<td>child 26650</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/13665dfc61d875ecb6846fe0bff6c987a3a31aaa">13665dfc61d875ecb6846fe0bff6c987a3a31aaa</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=f09d11ed16700506b7701168b63ffc1d636127f1">15937</a></td></tr>
<tr><td>push user</td><td>geoff@darktrojan.net</td></tr>
<tr><td>push date</td><td class="date age">Mon, 20 May 2019 02:11:37 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@64a20f2677d9 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=64a20f2677d9fbc51ad74bd0ca7ecca08cdc9ce9">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=64a20f2677d9fbc51ad74bd0ca7ecca08cdc9ce9&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=64a20f2677d9fbc51ad74bd0ca7ecca08cdc9ce9&newProject=comm-central&newRevision=f09d11ed16700506b7701168b63ffc1d636127f1&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=64a20f2677d9fbc51ad74bd0ca7ecca08cdc9ce9&newProject=comm-central&newRevision=f09d11ed16700506b7701168b63ffc1d636127f1&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=64a20f2677d9fbc51ad74bd0ca7ecca08cdc9ce9&newProject=comm-central&newRevision=f09d11ed16700506b7701168b63ffc1d636127f1&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28Fallen%29&revcount=50">Fallen</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1552634">1552634</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1552634">Bug 1552634</a> - Change bootstrapped extensions to using manifest.json; r=Fallen</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f09d11ed16700506b7701168b63ffc1d636127f1/common/src/BootstrapLoader.jsm">common/src/BootstrapLoader.jsm</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/f09d11ed16700506b7701168b63ffc1d636127f1/common/src/BootstrapLoader.jsm">diff</a> |
<a href="/comm-central/comparison/f09d11ed16700506b7701168b63ffc1d636127f1/common/src/BootstrapLoader.jsm">comparison</a> |
<a href="/comm-central/log/f09d11ed16700506b7701168b63ffc1d636127f1/common/src/BootstrapLoader.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f09d11ed16700506b7701168b63ffc1d636127f1/common/src/ExtensionSupport.jsm">common/src/ExtensionSupport.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f09d11ed16700506b7701168b63ffc1d636127f1/common/src/ExtensionSupport.jsm">file</a> |
<a href="/comm-central/annotate/f09d11ed16700506b7701168b63ffc1d636127f1/common/src/ExtensionSupport.jsm">annotate</a> |
<a href="/comm-central/diff/f09d11ed16700506b7701168b63ffc1d636127f1/common/src/ExtensionSupport.jsm">diff</a> |
<a href="/comm-central/comparison/f09d11ed16700506b7701168b63ffc1d636127f1/common/src/ExtensionSupport.jsm">comparison</a> |
<a href="/comm-central/log/f09d11ed16700506b7701168b63ffc1d636127f1/common/src/ExtensionSupport.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f09d11ed16700506b7701168b63ffc1d636127f1/common/src/RDFDataSource.jsm">common/src/RDFDataSource.jsm</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/f09d11ed16700506b7701168b63ffc1d636127f1/common/src/RDFDataSource.jsm">diff</a> |
<a href="/comm-central/comparison/f09d11ed16700506b7701168b63ffc1d636127f1/common/src/RDFDataSource.jsm">comparison</a> |
<a href="/comm-central/log/f09d11ed16700506b7701168b63ffc1d636127f1/common/src/RDFDataSource.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f09d11ed16700506b7701168b63ffc1d636127f1/common/src/RDFManifestConverter.jsm">common/src/RDFManifestConverter.jsm</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/f09d11ed16700506b7701168b63ffc1d636127f1/common/src/RDFManifestConverter.jsm">diff</a> |
<a href="/comm-central/comparison/f09d11ed16700506b7701168b63ffc1d636127f1/common/src/RDFManifestConverter.jsm">comparison</a> |
<a href="/comm-central/log/f09d11ed16700506b7701168b63ffc1d636127f1/common/src/RDFManifestConverter.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f09d11ed16700506b7701168b63ffc1d636127f1/common/src/moz.build">common/src/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f09d11ed16700506b7701168b63ffc1d636127f1/common/src/moz.build">file</a> |
<a href="/comm-central/annotate/f09d11ed16700506b7701168b63ffc1d636127f1/common/src/moz.build">annotate</a> |
<a href="/comm-central/diff/f09d11ed16700506b7701168b63ffc1d636127f1/common/src/moz.build">diff</a> |
<a href="/comm-central/comparison/f09d11ed16700506b7701168b63ffc1d636127f1/common/src/moz.build">comparison</a> |
<a href="/comm-central/log/f09d11ed16700506b7701168b63ffc1d636127f1/common/src/moz.build">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f09d11ed16700506b7701168b63ffc1d636127f1/common/test/xpcshell/head_addons.js">common/test/xpcshell/head_addons.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f09d11ed16700506b7701168b63ffc1d636127f1/common/test/xpcshell/head_addons.js">file</a> |
<a href="/comm-central/annotate/f09d11ed16700506b7701168b63ffc1d636127f1/common/test/xpcshell/head_addons.js">annotate</a> |
<a href="/comm-central/diff/f09d11ed16700506b7701168b63ffc1d636127f1/common/test/xpcshell/head_addons.js">diff</a> |
<a href="/comm-central/comparison/f09d11ed16700506b7701168b63ffc1d636127f1/common/test/xpcshell/head_addons.js">comparison</a> |
<a href="/comm-central/log/f09d11ed16700506b7701168b63ffc1d636127f1/common/test/xpcshell/head_addons.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f09d11ed16700506b7701168b63ffc1d636127f1/common/test/xpcshell/test_bootstrap.js">common/test/xpcshell/test_bootstrap.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f09d11ed16700506b7701168b63ffc1d636127f1/common/test/xpcshell/test_bootstrap.js">file</a> |
<a href="/comm-central/annotate/f09d11ed16700506b7701168b63ffc1d636127f1/common/test/xpcshell/test_bootstrap.js">annotate</a> |
<a href="/comm-central/diff/f09d11ed16700506b7701168b63ffc1d636127f1/common/test/xpcshell/test_bootstrap.js">diff</a> |
<a href="/comm-central/comparison/f09d11ed16700506b7701168b63ffc1d636127f1/common/test/xpcshell/test_bootstrap.js">comparison</a> |
<a href="/comm-central/log/f09d11ed16700506b7701168b63ffc1d636127f1/common/test/xpcshell/test_bootstrap.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f09d11ed16700506b7701168b63ffc1d636127f1/common/test/xpcshell/test_bootstrap_const.js">common/test/xpcshell/test_bootstrap_const.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f09d11ed16700506b7701168b63ffc1d636127f1/common/test/xpcshell/test_bootstrap_const.js">file</a> |
<a href="/comm-central/annotate/f09d11ed16700506b7701168b63ffc1d636127f1/common/test/xpcshell/test_bootstrap_const.js">annotate</a> |
<a href="/comm-central/diff/f09d11ed16700506b7701168b63ffc1d636127f1/common/test/xpcshell/test_bootstrap_const.js">diff</a> |
<a href="/comm-central/comparison/f09d11ed16700506b7701168b63ffc1d636127f1/common/test/xpcshell/test_bootstrap_const.js">comparison</a> |
<a href="/comm-central/log/f09d11ed16700506b7701168b63ffc1d636127f1/common/test/xpcshell/test_bootstrap_const.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f09d11ed16700506b7701168b63ffc1d636127f1/common/test/xpcshell/test_bootstrap_globals.js">common/test/xpcshell/test_bootstrap_globals.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f09d11ed16700506b7701168b63ffc1d636127f1/common/test/xpcshell/test_bootstrap_globals.js">file</a> |
<a href="/comm-central/annotate/f09d11ed16700506b7701168b63ffc1d636127f1/common/test/xpcshell/test_bootstrap_globals.js">annotate</a> |
<a href="/comm-central/diff/f09d11ed16700506b7701168b63ffc1d636127f1/common/test/xpcshell/test_bootstrap_globals.js">diff</a> |
<a href="/comm-central/comparison/f09d11ed16700506b7701168b63ffc1d636127f1/common/test/xpcshell/test_bootstrap_globals.js">comparison</a> |
<a href="/comm-central/log/f09d11ed16700506b7701168b63ffc1d636127f1/common/test/xpcshell/test_bootstrap_globals.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f09d11ed16700506b7701168b63ffc1d636127f1/common/test/xpcshell/test_bootstrapped_chrome_manifest.js">common/test/xpcshell/test_bootstrapped_chrome_manifest.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f09d11ed16700506b7701168b63ffc1d636127f1/common/test/xpcshell/test_bootstrapped_chrome_manifest.js">file</a> |
<a href="/comm-central/annotate/f09d11ed16700506b7701168b63ffc1d636127f1/common/test/xpcshell/test_bootstrapped_chrome_manifest.js">annotate</a> |
<a href="/comm-central/diff/f09d11ed16700506b7701168b63ffc1d636127f1/common/test/xpcshell/test_bootstrapped_chrome_manifest.js">diff</a> |
<a href="/comm-central/comparison/f09d11ed16700506b7701168b63ffc1d636127f1/common/test/xpcshell/test_bootstrapped_chrome_manifest.js">comparison</a> |
<a href="/comm-central/log/f09d11ed16700506b7701168b63ffc1d636127f1/common/test/xpcshell/test_bootstrapped_chrome_manifest.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f09d11ed16700506b7701168b63ffc1d636127f1/common/test/xpcshell/test_invalid_install_rdf.js">common/test/xpcshell/test_invalid_install_rdf.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/f09d11ed16700506b7701168b63ffc1d636127f1/common/test/xpcshell/test_invalid_install_rdf.js">diff</a> |
<a href="/comm-central/comparison/f09d11ed16700506b7701168b63ffc1d636127f1/common/test/xpcshell/test_invalid_install_rdf.js">comparison</a> |
<a href="/comm-central/log/f09d11ed16700506b7701168b63ffc1d636127f1/common/test/xpcshell/test_invalid_install_rdf.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f09d11ed16700506b7701168b63ffc1d636127f1/common/test/xpcshell/test_manifest.js">common/test/xpcshell/test_manifest.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/f09d11ed16700506b7701168b63ffc1d636127f1/common/test/xpcshell/test_manifest.js">diff</a> |
<a href="/comm-central/comparison/f09d11ed16700506b7701168b63ffc1d636127f1/common/test/xpcshell/test_manifest.js">comparison</a> |
<a href="/comm-central/log/f09d11ed16700506b7701168b63ffc1d636127f1/common/test/xpcshell/test_manifest.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f09d11ed16700506b7701168b63ffc1d636127f1/common/test/xpcshell/test_manifest_locales.js">common/test/xpcshell/test_manifest_locales.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/f09d11ed16700506b7701168b63ffc1d636127f1/common/test/xpcshell/test_manifest_locales.js">diff</a> |
<a href="/comm-central/comparison/f09d11ed16700506b7701168b63ffc1d636127f1/common/test/xpcshell/test_manifest_locales.js">comparison</a> |
<a href="/comm-central/log/f09d11ed16700506b7701168b63ffc1d636127f1/common/test/xpcshell/test_manifest_locales.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f09d11ed16700506b7701168b63ffc1d636127f1/common/test/xpcshell/xpcshell.ini">common/test/xpcshell/xpcshell.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f09d11ed16700506b7701168b63ffc1d636127f1/common/test/xpcshell/xpcshell.ini">file</a> |
<a href="/comm-central/annotate/f09d11ed16700506b7701168b63ffc1d636127f1/common/test/xpcshell/xpcshell.ini">annotate</a> |
<a href="/comm-central/diff/f09d11ed16700506b7701168b63ffc1d636127f1/common/test/xpcshell/xpcshell.ini">diff</a> |
<a href="/comm-central/comparison/f09d11ed16700506b7701168b63ffc1d636127f1/common/test/xpcshell/xpcshell.ini">comparison</a> |
<a href="/comm-central/log/f09d11ed16700506b7701168b63ffc1d636127f1/common/test/xpcshell/xpcshell.ini">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f09d11ed16700506b7701168b63ffc1d636127f1/mail/base/content/mailWindowOverlay.js">mail/base/content/mailWindowOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f09d11ed16700506b7701168b63ffc1d636127f1/mail/base/content/mailWindowOverlay.js">file</a> |
<a href="/comm-central/annotate/f09d11ed16700506b7701168b63ffc1d636127f1/mail/base/content/mailWindowOverlay.js">annotate</a> |
<a href="/comm-central/diff/f09d11ed16700506b7701168b63ffc1d636127f1/mail/base/content/mailWindowOverlay.js">diff</a> |
<a href="/comm-central/comparison/f09d11ed16700506b7701168b63ffc1d636127f1/mail/base/content/mailWindowOverlay.js">comparison</a> |
<a href="/comm-central/log/f09d11ed16700506b7701168b63ffc1d636127f1/mail/base/content/mailWindowOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f09d11ed16700506b7701168b63ffc1d636127f1/mail/components/extensions/ext-mail.json">mail/components/extensions/ext-mail.json</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f09d11ed16700506b7701168b63ffc1d636127f1/mail/components/extensions/ext-mail.json">file</a> |
<a href="/comm-central/annotate/f09d11ed16700506b7701168b63ffc1d636127f1/mail/components/extensions/ext-mail.json">annotate</a> |
<a href="/comm-central/diff/f09d11ed16700506b7701168b63ffc1d636127f1/mail/components/extensions/ext-mail.json">diff</a> |
<a href="/comm-central/comparison/f09d11ed16700506b7701168b63ffc1d636127f1/mail/components/extensions/ext-mail.json">comparison</a> |
<a href="/comm-central/log/f09d11ed16700506b7701168b63ffc1d636127f1/mail/components/extensions/ext-mail.json">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f09d11ed16700506b7701168b63ffc1d636127f1/mail/components/extensions/parent/ext-legacy.js">mail/components/extensions/parent/ext-legacy.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f09d11ed16700506b7701168b63ffc1d636127f1/mail/components/extensions/parent/ext-legacy.js">file</a> |
<a href="/comm-central/annotate/f09d11ed16700506b7701168b63ffc1d636127f1/mail/components/extensions/parent/ext-legacy.js">annotate</a> |
<a href="/comm-central/diff/f09d11ed16700506b7701168b63ffc1d636127f1/mail/components/extensions/parent/ext-legacy.js">diff</a> |
<a href="/comm-central/comparison/f09d11ed16700506b7701168b63ffc1d636127f1/mail/components/extensions/parent/ext-legacy.js">comparison</a> |
<a href="/comm-central/log/f09d11ed16700506b7701168b63ffc1d636127f1/mail/components/extensions/parent/ext-legacy.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f09d11ed16700506b7701168b63ffc1d636127f1/mail/components/extensions/schemas/legacy.json">mail/components/extensions/schemas/legacy.json</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f09d11ed16700506b7701168b63ffc1d636127f1/mail/components/extensions/schemas/legacy.json">file</a> |
<a href="/comm-central/annotate/f09d11ed16700506b7701168b63ffc1d636127f1/mail/components/extensions/schemas/legacy.json">annotate</a> |
<a href="/comm-central/diff/f09d11ed16700506b7701168b63ffc1d636127f1/mail/components/extensions/schemas/legacy.json">diff</a> |
<a href="/comm-central/comparison/f09d11ed16700506b7701168b63ffc1d636127f1/mail/components/extensions/schemas/legacy.json">comparison</a> |
<a href="/comm-central/log/f09d11ed16700506b7701168b63ffc1d636127f1/mail/components/extensions/schemas/legacy.json">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f09d11ed16700506b7701168b63ffc1d636127f1/mail/components/mailGlue.js">mail/components/mailGlue.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f09d11ed16700506b7701168b63ffc1d636127f1/mail/components/mailGlue.js">file</a> |
<a href="/comm-central/annotate/f09d11ed16700506b7701168b63ffc1d636127f1/mail/components/mailGlue.js">annotate</a> |
<a href="/comm-central/diff/f09d11ed16700506b7701168b63ffc1d636127f1/mail/components/mailGlue.js">diff</a> |
<a href="/comm-central/comparison/f09d11ed16700506b7701168b63ffc1d636127f1/mail/components/mailGlue.js">comparison</a> |
<a href="/comm-central/log/f09d11ed16700506b7701168b63ffc1d636127f1/mail/components/mailGlue.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f09d11ed16700506b7701168b63ffc1d636127f1/mail/test/mozmill/content-tabs/test-install-xpi.js">mail/test/mozmill/content-tabs/test-install-xpi.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f09d11ed16700506b7701168b63ffc1d636127f1/mail/test/mozmill/content-tabs/test-install-xpi.js">file</a> |
<a href="/comm-central/annotate/f09d11ed16700506b7701168b63ffc1d636127f1/mail/test/mozmill/content-tabs/test-install-xpi.js">annotate</a> |
<a href="/comm-central/diff/f09d11ed16700506b7701168b63ffc1d636127f1/mail/test/mozmill/content-tabs/test-install-xpi.js">diff</a> |
<a href="/comm-central/comparison/f09d11ed16700506b7701168b63ffc1d636127f1/mail/test/mozmill/content-tabs/test-install-xpi.js">comparison</a> |
<a href="/comm-central/log/f09d11ed16700506b7701168b63ffc1d636127f1/mail/test/mozmill/content-tabs/test-install-xpi.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f09d11ed16700506b7701168b63ffc1d636127f1/mail/test/mozmill/folder-tree-modes/test-extension/install.rdf">mail/test/mozmill/folder-tree-modes/test-extension/install.rdf</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/f09d11ed16700506b7701168b63ffc1d636127f1/mail/test/mozmill/folder-tree-modes/test-extension/install.rdf">diff</a> |
<a href="/comm-central/comparison/f09d11ed16700506b7701168b63ffc1d636127f1/mail/test/mozmill/folder-tree-modes/test-extension/install.rdf">comparison</a> |
<a href="/comm-central/log/f09d11ed16700506b7701168b63ffc1d636127f1/mail/test/mozmill/folder-tree-modes/test-extension/install.rdf">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f09d11ed16700506b7701168b63ffc1d636127f1/mail/test/mozmill/folder-tree-modes/test-extension/manifest.json">mail/test/mozmill/folder-tree-modes/test-extension/manifest.json</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f09d11ed16700506b7701168b63ffc1d636127f1/mail/test/mozmill/folder-tree-modes/test-extension/manifest.json">file</a> |
<a href="/comm-central/annotate/f09d11ed16700506b7701168b63ffc1d636127f1/mail/test/mozmill/folder-tree-modes/test-extension/manifest.json">annotate</a> |
<a href="/comm-central/diff/f09d11ed16700506b7701168b63ffc1d636127f1/mail/test/mozmill/folder-tree-modes/test-extension/manifest.json">diff</a> |
<a href="/comm-central/comparison/f09d11ed16700506b7701168b63ffc1d636127f1/mail/test/mozmill/folder-tree-modes/test-extension/manifest.json">comparison</a> |
<a href="/comm-central/log/f09d11ed16700506b7701168b63ffc1d636127f1/mail/test/mozmill/folder-tree-modes/test-extension/manifest.json">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f09d11ed16700506b7701168b63ffc1d636127f1/mail/test/resources/jsbridge/jsbridge/extension/install.rdf">mail/test/resources/jsbridge/jsbridge/extension/install.rdf</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/f09d11ed16700506b7701168b63ffc1d636127f1/mail/test/resources/jsbridge/jsbridge/extension/install.rdf">diff</a> |
<a href="/comm-central/comparison/f09d11ed16700506b7701168b63ffc1d636127f1/mail/test/resources/jsbridge/jsbridge/extension/install.rdf">comparison</a> |
<a href="/comm-central/log/f09d11ed16700506b7701168b63ffc1d636127f1/mail/test/resources/jsbridge/jsbridge/extension/install.rdf">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f09d11ed16700506b7701168b63ffc1d636127f1/mail/test/resources/jsbridge/jsbridge/extension/manifest.json">mail/test/resources/jsbridge/jsbridge/extension/manifest.json</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f09d11ed16700506b7701168b63ffc1d636127f1/mail/test/resources/jsbridge/jsbridge/extension/manifest.json">file</a> |
<a href="/comm-central/annotate/f09d11ed16700506b7701168b63ffc1d636127f1/mail/test/resources/jsbridge/jsbridge/extension/manifest.json">annotate</a> |
<a href="/comm-central/diff/f09d11ed16700506b7701168b63ffc1d636127f1/mail/test/resources/jsbridge/jsbridge/extension/manifest.json">diff</a> |
<a href="/comm-central/comparison/f09d11ed16700506b7701168b63ffc1d636127f1/mail/test/resources/jsbridge/jsbridge/extension/manifest.json">comparison</a> |
<a href="/comm-central/log/f09d11ed16700506b7701168b63ffc1d636127f1/mail/test/resources/jsbridge/jsbridge/extension/manifest.json">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f09d11ed16700506b7701168b63ffc1d636127f1/mail/test/resources/jsbridge/setup.py">mail/test/resources/jsbridge/setup.py</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f09d11ed16700506b7701168b63ffc1d636127f1/mail/test/resources/jsbridge/setup.py">file</a> |
<a href="/comm-central/annotate/f09d11ed16700506b7701168b63ffc1d636127f1/mail/test/resources/jsbridge/setup.py">annotate</a> |
<a href="/comm-central/diff/f09d11ed16700506b7701168b63ffc1d636127f1/mail/test/resources/jsbridge/setup.py">diff</a> |
<a href="/comm-central/comparison/f09d11ed16700506b7701168b63ffc1d636127f1/mail/test/resources/jsbridge/setup.py">comparison</a> |
<a href="/comm-central/log/f09d11ed16700506b7701168b63ffc1d636127f1/mail/test/resources/jsbridge/setup.py">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f09d11ed16700506b7701168b63ffc1d636127f1/mail/test/resources/mozmill/mozmill/extension/install.rdf">mail/test/resources/mozmill/mozmill/extension/install.rdf</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/f09d11ed16700506b7701168b63ffc1d636127f1/mail/test/resources/mozmill/mozmill/extension/install.rdf">diff</a> |
<a href="/comm-central/comparison/f09d11ed16700506b7701168b63ffc1d636127f1/mail/test/resources/mozmill/mozmill/extension/install.rdf">comparison</a> |
<a href="/comm-central/log/f09d11ed16700506b7701168b63ffc1d636127f1/mail/test/resources/mozmill/mozmill/extension/install.rdf">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f09d11ed16700506b7701168b63ffc1d636127f1/mail/test/resources/mozmill/mozmill/extension/manifest.json">mail/test/resources/mozmill/mozmill/extension/manifest.json</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f09d11ed16700506b7701168b63ffc1d636127f1/mail/test/resources/mozmill/mozmill/extension/manifest.json">file</a> |
<a href="/comm-central/annotate/f09d11ed16700506b7701168b63ffc1d636127f1/mail/test/resources/mozmill/mozmill/extension/manifest.json">annotate</a> |
<a href="/comm-central/diff/f09d11ed16700506b7701168b63ffc1d636127f1/mail/test/resources/mozmill/mozmill/extension/manifest.json">diff</a> |
<a href="/comm-central/comparison/f09d11ed16700506b7701168b63ffc1d636127f1/mail/test/resources/mozmill/mozmill/extension/manifest.json">comparison</a> |
<a href="/comm-central/log/f09d11ed16700506b7701168b63ffc1d636127f1/mail/test/resources/mozmill/mozmill/extension/manifest.json">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f09d11ed16700506b7701168b63ffc1d636127f1/mail/test/resources/mozmill/setup.py">mail/test/resources/mozmill/setup.py</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f09d11ed16700506b7701168b63ffc1d636127f1/mail/test/resources/mozmill/setup.py">file</a> |
<a href="/comm-central/annotate/f09d11ed16700506b7701168b63ffc1d636127f1/mail/test/resources/mozmill/setup.py">annotate</a> |
<a href="/comm-central/diff/f09d11ed16700506b7701168b63ffc1d636127f1/mail/test/resources/mozmill/setup.py">diff</a> |
<a href="/comm-central/comparison/f09d11ed16700506b7701168b63ffc1d636127f1/mail/test/resources/mozmill/setup.py">comparison</a> |
<a href="/comm-central/log/f09d11ed16700506b7701168b63ffc1d636127f1/mail/test/resources/mozmill/setup.py">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1">deleted file mode 100644</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineminus">--- a/common/src/BootstrapLoader.jsm</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineplus">+++ /dev/null</span>
<a href="#l1.4"></a><span id="l1.4" class="difflineat">@@ -1,372 +0,0 @@</span>
<a href="#l1.5"></a><span id="l1.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l1.6"></a><span id="l1.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l1.7"></a><span id="l1.7" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l1.8"></a><span id="l1.8" class="difflineminus">-</span>
<a href="#l1.9"></a><span id="l1.9" class="difflineminus">-&quot;use strict&quot;;</span>
<a href="#l1.10"></a><span id="l1.10" class="difflineminus">-</span>
<a href="#l1.11"></a><span id="l1.11" class="difflineminus">-var EXPORTED_SYMBOLS = [&quot;BootstrapLoader&quot;];</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-const {AddonManager} = ChromeUtils.import(&quot;resource://gre/modules/AddonManager.jsm&quot;);</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-const {XPCOMUtils} = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineminus">-</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineminus">-XPCOMUtils.defineLazyModuleGetters(this, {</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineminus">-  AddonInternal: &quot;resource://gre/modules/addons/XPIDatabase.jsm&quot;,</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineminus">-  Blocklist: &quot;resource://gre/modules/Blocklist.jsm&quot;,</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineminus">-  ConsoleAPI: &quot;resource://gre/modules/Console.jsm&quot;,</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineminus">-  InstallRDF: &quot;resource:///modules/RDFManifestConverter.jsm&quot;,</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineminus">-  Services: &quot;resource://gre/modules/Services.jsm&quot;,</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineminus">-});</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineminus">-</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineminus">-XPCOMUtils.defineLazyGetter(this, &quot;BOOTSTRAP_REASONS&quot;, () =&gt; {</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineminus">-  const {XPIProvider} = ChromeUtils.import(&quot;resource://gre/modules/addons/XPIProvider.jsm&quot;);</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineminus">-  return XPIProvider.BOOTSTRAP_REASONS;</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineminus">-});</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineminus">-</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineminus">-const {Log} = ChromeUtils.import(&quot;resource://gre/modules/Log.jsm&quot;);</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineminus">-var logger = Log.repository.getLogger(&quot;addons.bootstrap&quot;);</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineminus">-/**</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineminus">- * Valid IDs fit this pattern.</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineminus">- */</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineminus">-var gIDTest = /^(\{[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}\}|[a-z0-9-\._]*\@[a-z0-9-\._]+)$/i;</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineminus">-</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineminus">-// Properties that exist in the install manifest</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineminus">-const PROP_METADATA      = [&quot;id&quot;, &quot;version&quot;, &quot;type&quot;, &quot;internalName&quot;, &quot;updateURL&quot;,</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineminus">-                            &quot;optionsURL&quot;, &quot;optionsType&quot;, &quot;aboutURL&quot;, &quot;iconURL&quot;];</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineminus">-const PROP_LOCALE_SINGLE = [&quot;name&quot;, &quot;description&quot;, &quot;creator&quot;, &quot;homepageURL&quot;];</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineminus">-const PROP_LOCALE_MULTI  = [&quot;developers&quot;, &quot;translators&quot;, &quot;contributors&quot;];</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineminus">-</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineminus">-// Map new string type identifiers to old style nsIUpdateItem types.</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineminus">-// Retired values:</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineminus">-// 32 = multipackage xpi file</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineminus">-// 8 = locale</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineminus">-// 256 = apiextension</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineminus">-// 128 = experiment</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineminus">-// theme = 4</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineminus">-const TYPES = {</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineminus">-  extension: 2,</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineminus">-  dictionary: 64,</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineminus">-};</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineminus">-</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineminus">-const COMPATIBLE_BY_DEFAULT_TYPES = {</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineminus">-  extension: true,</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineminus">-  dictionary: true,</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineminus">-};</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineminus">-</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineminus">-const hasOwnProperty = Function.call.bind(Object.prototype.hasOwnProperty);</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineminus">-</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineminus">-function isXPI(filename) {</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineminus">-  let ext = filename.slice(-4).toLowerCase();</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineminus">-  return ext === &quot;.xpi&quot; || ext === &quot;.zip&quot;;</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineminus">-}</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineminus">-</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineminus">-/**</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineminus">- * Gets an nsIURI for a file within another file, either a directory or an XPI</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineminus">- * file. If aFile is a directory then this will return a file: URI, if it is an</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineminus">- * XPI file then it will return a jar: URI.</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineminus">- *</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineminus">- * @param {nsIFile} aFile</span>
<a href="#l1.73"></a><span id="l1.73" class="difflineminus">- *        The file containing the resources, must be either a directory or an</span>
<a href="#l1.74"></a><span id="l1.74" class="difflineminus">- *        XPI file</span>
<a href="#l1.75"></a><span id="l1.75" class="difflineminus">- * @param {string} aPath</span>
<a href="#l1.76"></a><span id="l1.76" class="difflineminus">- *        The path to find the resource at, &quot;/&quot; separated. If aPath is empty</span>
<a href="#l1.77"></a><span id="l1.77" class="difflineminus">- *        then the uri to the root of the contained files will be returned</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineminus">- * @returns {nsIURI}</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineminus">- *        An nsIURI pointing at the resource</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineminus">- */</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineminus">-function getURIForResourceInFile(aFile, aPath) {</span>
<a href="#l1.82"></a><span id="l1.82" class="difflineminus">-  if (!isXPI(aFile.leafName)) {</span>
<a href="#l1.83"></a><span id="l1.83" class="difflineminus">-    let resource = aFile.clone();</span>
<a href="#l1.84"></a><span id="l1.84" class="difflineminus">-    if (aPath)</span>
<a href="#l1.85"></a><span id="l1.85" class="difflineminus">-      aPath.split(&quot;/&quot;).forEach(part =&gt; resource.append(part));</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineminus">-</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineminus">-    return Services.io.newFileURI(resource);</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineminus">-  }</span>
<a href="#l1.89"></a><span id="l1.89" class="difflineminus">-</span>
<a href="#l1.90"></a><span id="l1.90" class="difflineminus">-  return buildJarURI(aFile, aPath);</span>
<a href="#l1.91"></a><span id="l1.91" class="difflineminus">-}</span>
<a href="#l1.92"></a><span id="l1.92" class="difflineminus">-</span>
<a href="#l1.93"></a><span id="l1.93" class="difflineminus">-/**</span>
<a href="#l1.94"></a><span id="l1.94" class="difflineminus">- * Creates a jar: URI for a file inside a ZIP file.</span>
<a href="#l1.95"></a><span id="l1.95" class="difflineminus">- *</span>
<a href="#l1.96"></a><span id="l1.96" class="difflineminus">- * @param {nsIFile} aJarfile</span>
<a href="#l1.97"></a><span id="l1.97" class="difflineminus">- *        The ZIP file as an nsIFile</span>
<a href="#l1.98"></a><span id="l1.98" class="difflineminus">- * @param {string} aPath</span>
<a href="#l1.99"></a><span id="l1.99" class="difflineminus">- *        The path inside the ZIP file</span>
<a href="#l1.100"></a><span id="l1.100" class="difflineminus">- * @returns {nsIURI}</span>
<a href="#l1.101"></a><span id="l1.101" class="difflineminus">- *        An nsIURI for the file</span>
<a href="#l1.102"></a><span id="l1.102" class="difflineminus">- */</span>
<a href="#l1.103"></a><span id="l1.103" class="difflineminus">-function buildJarURI(aJarfile, aPath) {</span>
<a href="#l1.104"></a><span id="l1.104" class="difflineminus">-  let uri = Services.io.newFileURI(aJarfile);</span>
<a href="#l1.105"></a><span id="l1.105" class="difflineminus">-  uri = &quot;jar:&quot; + uri.spec + &quot;!/&quot; + aPath;</span>
<a href="#l1.106"></a><span id="l1.106" class="difflineminus">-  return Services.io.newURI(uri);</span>
<a href="#l1.107"></a><span id="l1.107" class="difflineminus">-}</span>
<a href="#l1.108"></a><span id="l1.108" class="difflineminus">-</span>
<a href="#l1.109"></a><span id="l1.109" class="difflineminus">-var BootstrapLoader = {</span>
<a href="#l1.110"></a><span id="l1.110" class="difflineminus">-  name: &quot;bootstrap&quot;,</span>
<a href="#l1.111"></a><span id="l1.111" class="difflineminus">-  manifestFile: &quot;install.rdf&quot;,</span>
<a href="#l1.112"></a><span id="l1.112" class="difflineminus">-  async loadManifest(pkg) {</span>
<a href="#l1.113"></a><span id="l1.113" class="difflineminus">-    /**</span>
<a href="#l1.114"></a><span id="l1.114" class="difflineminus">-     * Reads locale properties from either the main install manifest root or</span>
<a href="#l1.115"></a><span id="l1.115" class="difflineminus">-     * an em:localized section in the install manifest.</span>
<a href="#l1.116"></a><span id="l1.116" class="difflineminus">-     *</span>
<a href="#l1.117"></a><span id="l1.117" class="difflineminus">-     * @param {Object} aSource</span>
<a href="#l1.118"></a><span id="l1.118" class="difflineminus">-     *        The resource to read the properties from.</span>
<a href="#l1.119"></a><span id="l1.119" class="difflineminus">-     * @param {boolean} isDefault</span>
<a href="#l1.120"></a><span id="l1.120" class="difflineminus">-     *        True if the locale is to be read from the main install manifest</span>
<a href="#l1.121"></a><span id="l1.121" class="difflineminus">-     *        root</span>
<a href="#l1.122"></a><span id="l1.122" class="difflineminus">-     * @param {string[]} aSeenLocales</span>
<a href="#l1.123"></a><span id="l1.123" class="difflineminus">-     *        An array of locale names already seen for this install manifest.</span>
<a href="#l1.124"></a><span id="l1.124" class="difflineminus">-     *        Any locale names seen as a part of this function will be added to</span>
<a href="#l1.125"></a><span id="l1.125" class="difflineminus">-     *        this array</span>
<a href="#l1.126"></a><span id="l1.126" class="difflineminus">-     * @returns {Object}</span>
<a href="#l1.127"></a><span id="l1.127" class="difflineminus">-     *        an object containing the locale properties</span>
<a href="#l1.128"></a><span id="l1.128" class="difflineminus">-     */</span>
<a href="#l1.129"></a><span id="l1.129" class="difflineminus">-    function readLocale(aSource, isDefault, aSeenLocales) {</span>
<a href="#l1.130"></a><span id="l1.130" class="difflineminus">-      let locale = {};</span>
<a href="#l1.131"></a><span id="l1.131" class="difflineminus">-      if (!isDefault) {</span>
<a href="#l1.132"></a><span id="l1.132" class="difflineminus">-        locale.locales = [];</span>
<a href="#l1.133"></a><span id="l1.133" class="difflineminus">-        for (let localeName of aSource.locales || []) {</span>
<a href="#l1.134"></a><span id="l1.134" class="difflineminus">-          if (!localeName) {</span>
<a href="#l1.135"></a><span id="l1.135" class="difflineminus">-            logger.warn(&quot;Ignoring empty locale in localized properties&quot;);</span>
<a href="#l1.136"></a><span id="l1.136" class="difflineminus">-            continue;</span>
<a href="#l1.137"></a><span id="l1.137" class="difflineminus">-          }</span>
<a href="#l1.138"></a><span id="l1.138" class="difflineminus">-          if (aSeenLocales.includes(localeName)) {</span>
<a href="#l1.139"></a><span id="l1.139" class="difflineminus">-            logger.warn(&quot;Ignoring duplicate locale in localized properties&quot;);</span>
<a href="#l1.140"></a><span id="l1.140" class="difflineminus">-            continue;</span>
<a href="#l1.141"></a><span id="l1.141" class="difflineminus">-          }</span>
<a href="#l1.142"></a><span id="l1.142" class="difflineminus">-          aSeenLocales.push(localeName);</span>
<a href="#l1.143"></a><span id="l1.143" class="difflineminus">-          locale.locales.push(localeName);</span>
<a href="#l1.144"></a><span id="l1.144" class="difflineminus">-        }</span>
<a href="#l1.145"></a><span id="l1.145" class="difflineminus">-</span>
<a href="#l1.146"></a><span id="l1.146" class="difflineminus">-        if (locale.locales.length == 0) {</span>
<a href="#l1.147"></a><span id="l1.147" class="difflineminus">-          logger.warn(&quot;Ignoring localized properties with no listed locales&quot;);</span>
<a href="#l1.148"></a><span id="l1.148" class="difflineminus">-          return null;</span>
<a href="#l1.149"></a><span id="l1.149" class="difflineminus">-        }</span>
<a href="#l1.150"></a><span id="l1.150" class="difflineminus">-      }</span>
<a href="#l1.151"></a><span id="l1.151" class="difflineminus">-</span>
<a href="#l1.152"></a><span id="l1.152" class="difflineminus">-      for (let prop of [...PROP_LOCALE_SINGLE, ...PROP_LOCALE_MULTI]) {</span>
<a href="#l1.153"></a><span id="l1.153" class="difflineminus">-        if (hasOwnProperty(aSource, prop)) {</span>
<a href="#l1.154"></a><span id="l1.154" class="difflineminus">-          locale[prop] = aSource[prop];</span>
<a href="#l1.155"></a><span id="l1.155" class="difflineminus">-        }</span>
<a href="#l1.156"></a><span id="l1.156" class="difflineminus">-      }</span>
<a href="#l1.157"></a><span id="l1.157" class="difflineminus">-</span>
<a href="#l1.158"></a><span id="l1.158" class="difflineminus">-      return locale;</span>
<a href="#l1.159"></a><span id="l1.159" class="difflineminus">-    }</span>
<a href="#l1.160"></a><span id="l1.160" class="difflineminus">-</span>
<a href="#l1.161"></a><span id="l1.161" class="difflineminus">-    let manifestData = await pkg.readString(&quot;install.rdf&quot;);</span>
<a href="#l1.162"></a><span id="l1.162" class="difflineminus">-    let manifest = InstallRDF.loadFromString(manifestData).decode();</span>
<a href="#l1.163"></a><span id="l1.163" class="difflineminus">-</span>
<a href="#l1.164"></a><span id="l1.164" class="difflineminus">-    let addon = new AddonInternal();</span>
<a href="#l1.165"></a><span id="l1.165" class="difflineminus">-    for (let prop of PROP_METADATA) {</span>
<a href="#l1.166"></a><span id="l1.166" class="difflineminus">-      if (hasOwnProperty(manifest, prop)) {</span>
<a href="#l1.167"></a><span id="l1.167" class="difflineminus">-        addon[prop] = manifest[prop];</span>
<a href="#l1.168"></a><span id="l1.168" class="difflineminus">-      }</span>
<a href="#l1.169"></a><span id="l1.169" class="difflineminus">-    }</span>
<a href="#l1.170"></a><span id="l1.170" class="difflineminus">-</span>
<a href="#l1.171"></a><span id="l1.171" class="difflineminus">-    if (!addon.type) {</span>
<a href="#l1.172"></a><span id="l1.172" class="difflineminus">-      addon.type = &quot;extension&quot;;</span>
<a href="#l1.173"></a><span id="l1.173" class="difflineminus">-    } else {</span>
<a href="#l1.174"></a><span id="l1.174" class="difflineminus">-      let type = addon.type;</span>
<a href="#l1.175"></a><span id="l1.175" class="difflineminus">-      addon.type = null;</span>
<a href="#l1.176"></a><span id="l1.176" class="difflineminus">-      for (let name in TYPES) {</span>
<a href="#l1.177"></a><span id="l1.177" class="difflineminus">-        if (TYPES[name] == type) {</span>
<a href="#l1.178"></a><span id="l1.178" class="difflineminus">-          addon.type = name;</span>
<a href="#l1.179"></a><span id="l1.179" class="difflineminus">-          break;</span>
<a href="#l1.180"></a><span id="l1.180" class="difflineminus">-        }</span>
<a href="#l1.181"></a><span id="l1.181" class="difflineminus">-      }</span>
<a href="#l1.182"></a><span id="l1.182" class="difflineminus">-    }</span>
<a href="#l1.183"></a><span id="l1.183" class="difflineminus">-</span>
<a href="#l1.184"></a><span id="l1.184" class="difflineminus">-    if (!(addon.type in TYPES))</span>
<a href="#l1.185"></a><span id="l1.185" class="difflineminus">-      throw new Error(&quot;Install manifest specifies unknown type: &quot; + addon.type);</span>
<a href="#l1.186"></a><span id="l1.186" class="difflineminus">-</span>
<a href="#l1.187"></a><span id="l1.187" class="difflineminus">-    if (!addon.id)</span>
<a href="#l1.188"></a><span id="l1.188" class="difflineminus">-      throw new Error(&quot;No ID in install manifest&quot;);</span>
<a href="#l1.189"></a><span id="l1.189" class="difflineminus">-    if (!gIDTest.test(addon.id))</span>
<a href="#l1.190"></a><span id="l1.190" class="difflineminus">-      throw new Error(&quot;Illegal add-on ID &quot; + addon.id);</span>
<a href="#l1.191"></a><span id="l1.191" class="difflineminus">-    if (!addon.version)</span>
<a href="#l1.192"></a><span id="l1.192" class="difflineminus">-      throw new Error(&quot;No version in install manifest&quot;);</span>
<a href="#l1.193"></a><span id="l1.193" class="difflineminus">-</span>
<a href="#l1.194"></a><span id="l1.194" class="difflineminus">-    addon.strictCompatibility = (!(addon.type in COMPATIBLE_BY_DEFAULT_TYPES) ||</span>
<a href="#l1.195"></a><span id="l1.195" class="difflineminus">-                                 manifest.strictCompatibility == &quot;true&quot;);</span>
<a href="#l1.196"></a><span id="l1.196" class="difflineminus">-</span>
<a href="#l1.197"></a><span id="l1.197" class="difflineminus">-    // Only read these properties for extensions.</span>
<a href="#l1.198"></a><span id="l1.198" class="difflineminus">-    if (addon.type == &quot;extension&quot;) {</span>
<a href="#l1.199"></a><span id="l1.199" class="difflineminus">-      if (manifest.bootstrap != &quot;true&quot;) {</span>
<a href="#l1.200"></a><span id="l1.200" class="difflineminus">-        throw new Error(&quot;Non-restartless extensions no longer supported&quot;);</span>
<a href="#l1.201"></a><span id="l1.201" class="difflineminus">-      }</span>
<a href="#l1.202"></a><span id="l1.202" class="difflineminus">-</span>
<a href="#l1.203"></a><span id="l1.203" class="difflineminus">-      if (addon.optionsType &amp;&amp;</span>
<a href="#l1.204"></a><span id="l1.204" class="difflineminus">-          addon.optionsType != AddonManager.OPTIONS_TYPE_INLINE_BROWSER &amp;&amp;</span>
<a href="#l1.205"></a><span id="l1.205" class="difflineminus">-          addon.optionsType != AddonManager.OPTIONS_TYPE_TAB) {</span>
<a href="#l1.206"></a><span id="l1.206" class="difflineminus">-            throw new Error(&quot;Install manifest specifies unknown optionsType: &quot; + addon.optionsType);</span>
<a href="#l1.207"></a><span id="l1.207" class="difflineminus">-      }</span>
<a href="#l1.208"></a><span id="l1.208" class="difflineminus">-    } else {</span>
<a href="#l1.209"></a><span id="l1.209" class="difflineminus">-      // Convert legacy dictionaries into a format the WebExtension</span>
<a href="#l1.210"></a><span id="l1.210" class="difflineminus">-      // dictionary loader can process.</span>
<a href="#l1.211"></a><span id="l1.211" class="difflineminus">-      if (addon.type === &quot;dictionary&quot;) {</span>
<a href="#l1.212"></a><span id="l1.212" class="difflineminus">-        addon.loader = null;</span>
<a href="#l1.213"></a><span id="l1.213" class="difflineminus">-        let dictionaries = {};</span>
<a href="#l1.214"></a><span id="l1.214" class="difflineminus">-        await pkg.iterFiles(({path}) =&gt; {</span>
<a href="#l1.215"></a><span id="l1.215" class="difflineminus">-          let match = /^dictionaries\/([^\/]+)\.dic$/.exec(path);</span>
<a href="#l1.216"></a><span id="l1.216" class="difflineminus">-          if (match) {</span>
<a href="#l1.217"></a><span id="l1.217" class="difflineminus">-            let lang = match[1].replace(/_/g, &quot;-&quot;);</span>
<a href="#l1.218"></a><span id="l1.218" class="difflineminus">-            dictionaries[lang] = match[0];</span>
<a href="#l1.219"></a><span id="l1.219" class="difflineminus">-          }</span>
<a href="#l1.220"></a><span id="l1.220" class="difflineminus">-        });</span>
<a href="#l1.221"></a><span id="l1.221" class="difflineminus">-        addon.startupData = {dictionaries};</span>
<a href="#l1.222"></a><span id="l1.222" class="difflineminus">-      }</span>
<a href="#l1.223"></a><span id="l1.223" class="difflineminus">-</span>
<a href="#l1.224"></a><span id="l1.224" class="difflineminus">-      // Only extensions are allowed to provide an optionsURL, optionsType,</span>
<a href="#l1.225"></a><span id="l1.225" class="difflineminus">-      // optionsBrowserStyle, or aboutURL. For all other types they are silently ignored</span>
<a href="#l1.226"></a><span id="l1.226" class="difflineminus">-      addon.aboutURL = null;</span>
<a href="#l1.227"></a><span id="l1.227" class="difflineminus">-      addon.optionsBrowserStyle = null;</span>
<a href="#l1.228"></a><span id="l1.228" class="difflineminus">-      addon.optionsType = null;</span>
<a href="#l1.229"></a><span id="l1.229" class="difflineminus">-      addon.optionsURL = null;</span>
<a href="#l1.230"></a><span id="l1.230" class="difflineminus">-    }</span>
<a href="#l1.231"></a><span id="l1.231" class="difflineminus">-</span>
<a href="#l1.232"></a><span id="l1.232" class="difflineminus">-    addon.defaultLocale = readLocale(manifest, true);</span>
<a href="#l1.233"></a><span id="l1.233" class="difflineminus">-</span>
<a href="#l1.234"></a><span id="l1.234" class="difflineminus">-    let seenLocales = [];</span>
<a href="#l1.235"></a><span id="l1.235" class="difflineminus">-    addon.locales = [];</span>
<a href="#l1.236"></a><span id="l1.236" class="difflineminus">-    for (let localeData of manifest.localized || []) {</span>
<a href="#l1.237"></a><span id="l1.237" class="difflineminus">-      let locale = readLocale(localeData, false, seenLocales);</span>
<a href="#l1.238"></a><span id="l1.238" class="difflineminus">-      if (locale)</span>
<a href="#l1.239"></a><span id="l1.239" class="difflineminus">-        addon.locales.push(locale);</span>
<a href="#l1.240"></a><span id="l1.240" class="difflineminus">-    }</span>
<a href="#l1.241"></a><span id="l1.241" class="difflineminus">-</span>
<a href="#l1.242"></a><span id="l1.242" class="difflineminus">-    let dependencies = new Set(manifest.dependencies);</span>
<a href="#l1.243"></a><span id="l1.243" class="difflineminus">-    addon.dependencies = Object.freeze(Array.from(dependencies));</span>
<a href="#l1.244"></a><span id="l1.244" class="difflineminus">-</span>
<a href="#l1.245"></a><span id="l1.245" class="difflineminus">-    let seenApplications = [];</span>
<a href="#l1.246"></a><span id="l1.246" class="difflineminus">-    addon.targetApplications = [];</span>
<a href="#l1.247"></a><span id="l1.247" class="difflineminus">-    for (let targetApp of manifest.targetApplications || []) {</span>
<a href="#l1.248"></a><span id="l1.248" class="difflineminus">-      if (!targetApp.id || !targetApp.minVersion ||</span>
<a href="#l1.249"></a><span id="l1.249" class="difflineminus">-          !targetApp.maxVersion) {</span>
<a href="#l1.250"></a><span id="l1.250" class="difflineminus">-            logger.warn(&quot;Ignoring invalid targetApplication entry in install manifest&quot;);</span>
<a href="#l1.251"></a><span id="l1.251" class="difflineminus">-            continue;</span>
<a href="#l1.252"></a><span id="l1.252" class="difflineminus">-      }</span>
<a href="#l1.253"></a><span id="l1.253" class="difflineminus">-      if (seenApplications.includes(targetApp.id)) {</span>
<a href="#l1.254"></a><span id="l1.254" class="difflineminus">-        logger.warn(&quot;Ignoring duplicate targetApplication entry for &quot; + targetApp.id +</span>
<a href="#l1.255"></a><span id="l1.255" class="difflineminus">-                    &quot; in install manifest&quot;);</span>
<a href="#l1.256"></a><span id="l1.256" class="difflineminus">-        continue;</span>
<a href="#l1.257"></a><span id="l1.257" class="difflineminus">-      }</span>
<a href="#l1.258"></a><span id="l1.258" class="difflineminus">-      seenApplications.push(targetApp.id);</span>
<a href="#l1.259"></a><span id="l1.259" class="difflineminus">-      addon.targetApplications.push(targetApp);</span>
<a href="#l1.260"></a><span id="l1.260" class="difflineminus">-    }</span>
<a href="#l1.261"></a><span id="l1.261" class="difflineminus">-</span>
<a href="#l1.262"></a><span id="l1.262" class="difflineminus">-    // Note that we don't need to check for duplicate targetPlatform entries since</span>
<a href="#l1.263"></a><span id="l1.263" class="difflineminus">-    // the RDF service coalesces them for us.</span>
<a href="#l1.264"></a><span id="l1.264" class="difflineminus">-    addon.targetPlatforms = [];</span>
<a href="#l1.265"></a><span id="l1.265" class="difflineminus">-    for (let targetPlatform of manifest.targetPlatforms || []) {</span>
<a href="#l1.266"></a><span id="l1.266" class="difflineminus">-      let platform = {</span>
<a href="#l1.267"></a><span id="l1.267" class="difflineminus">-        os: null,</span>
<a href="#l1.268"></a><span id="l1.268" class="difflineminus">-        abi: null,</span>
<a href="#l1.269"></a><span id="l1.269" class="difflineminus">-      };</span>
<a href="#l1.270"></a><span id="l1.270" class="difflineminus">-</span>
<a href="#l1.271"></a><span id="l1.271" class="difflineminus">-      let pos = targetPlatform.indexOf(&quot;_&quot;);</span>
<a href="#l1.272"></a><span id="l1.272" class="difflineminus">-      if (pos != -1) {</span>
<a href="#l1.273"></a><span id="l1.273" class="difflineminus">-        platform.os = targetPlatform.substring(0, pos);</span>
<a href="#l1.274"></a><span id="l1.274" class="difflineminus">-        platform.abi = targetPlatform.substring(pos + 1);</span>
<a href="#l1.275"></a><span id="l1.275" class="difflineminus">-      } else {</span>
<a href="#l1.276"></a><span id="l1.276" class="difflineminus">-        platform.os = targetPlatform;</span>
<a href="#l1.277"></a><span id="l1.277" class="difflineminus">-      }</span>
<a href="#l1.278"></a><span id="l1.278" class="difflineminus">-</span>
<a href="#l1.279"></a><span id="l1.279" class="difflineminus">-      addon.targetPlatforms.push(platform);</span>
<a href="#l1.280"></a><span id="l1.280" class="difflineminus">-    }</span>
<a href="#l1.281"></a><span id="l1.281" class="difflineminus">-</span>
<a href="#l1.282"></a><span id="l1.282" class="difflineminus">-    addon.userDisabled = false;</span>
<a href="#l1.283"></a><span id="l1.283" class="difflineminus">-    addon.softDisabled = addon.blocklistState == Blocklist.STATE_SOFTBLOCKED;</span>
<a href="#l1.284"></a><span id="l1.284" class="difflineminus">-    addon.applyBackgroundUpdates = AddonManager.AUTOUPDATE_DEFAULT;</span>
<a href="#l1.285"></a><span id="l1.285" class="difflineminus">-</span>
<a href="#l1.286"></a><span id="l1.286" class="difflineminus">-    addon.userPermissions = null;</span>
<a href="#l1.287"></a><span id="l1.287" class="difflineminus">-</span>
<a href="#l1.288"></a><span id="l1.288" class="difflineminus">-    addon.icons = {};</span>
<a href="#l1.289"></a><span id="l1.289" class="difflineminus">-    if (await pkg.hasResource(&quot;icon.png&quot;)) {</span>
<a href="#l1.290"></a><span id="l1.290" class="difflineminus">-      addon.icons[32] = &quot;icon.png&quot;;</span>
<a href="#l1.291"></a><span id="l1.291" class="difflineminus">-      addon.icons[48] = &quot;icon.png&quot;;</span>
<a href="#l1.292"></a><span id="l1.292" class="difflineminus">-    }</span>
<a href="#l1.293"></a><span id="l1.293" class="difflineminus">-</span>
<a href="#l1.294"></a><span id="l1.294" class="difflineminus">-    if (await pkg.hasResource(&quot;icon64.png&quot;)) {</span>
<a href="#l1.295"></a><span id="l1.295" class="difflineminus">-      addon.icons[64] = &quot;icon64.png&quot;;</span>
<a href="#l1.296"></a><span id="l1.296" class="difflineminus">-    }</span>
<a href="#l1.297"></a><span id="l1.297" class="difflineminus">-</span>
<a href="#l1.298"></a><span id="l1.298" class="difflineminus">-    return addon;</span>
<a href="#l1.299"></a><span id="l1.299" class="difflineminus">-  },</span>
<a href="#l1.300"></a><span id="l1.300" class="difflineminus">-</span>
<a href="#l1.301"></a><span id="l1.301" class="difflineminus">-  loadScope(addon) {</span>
<a href="#l1.302"></a><span id="l1.302" class="difflineminus">-    let file = addon.file || addon._sourceBundle;</span>
<a href="#l1.303"></a><span id="l1.303" class="difflineminus">-    let uri = getURIForResourceInFile(file, &quot;bootstrap.js&quot;).spec;</span>
<a href="#l1.304"></a><span id="l1.304" class="difflineminus">-    let principal = Services.scriptSecurityManager.getSystemPrincipal();</span>
<a href="#l1.305"></a><span id="l1.305" class="difflineminus">-</span>
<a href="#l1.306"></a><span id="l1.306" class="difflineminus">-    let sandbox = new Cu.Sandbox(principal, {</span>
<a href="#l1.307"></a><span id="l1.307" class="difflineminus">-      sandboxName: uri,</span>
<a href="#l1.308"></a><span id="l1.308" class="difflineminus">-      addonId: addon.id,</span>
<a href="#l1.309"></a><span id="l1.309" class="difflineminus">-      wantGlobalProperties: [&quot;ChromeUtils&quot;],</span>
<a href="#l1.310"></a><span id="l1.310" class="difflineminus">-      metadata: { addonID: addon.id, URI: uri },</span>
<a href="#l1.311"></a><span id="l1.311" class="difflineminus">-    });</span>
<a href="#l1.312"></a><span id="l1.312" class="difflineminus">-</span>
<a href="#l1.313"></a><span id="l1.313" class="difflineminus">-    try {</span>
<a href="#l1.314"></a><span id="l1.314" class="difflineminus">-      Object.assign(sandbox, BOOTSTRAP_REASONS);</span>
<a href="#l1.315"></a><span id="l1.315" class="difflineminus">-</span>
<a href="#l1.316"></a><span id="l1.316" class="difflineminus">-      XPCOMUtils.defineLazyGetter(sandbox, &quot;console&quot;, () =&gt;</span>
<a href="#l1.317"></a><span id="l1.317" class="difflineminus">-        new ConsoleAPI({ consoleID: `addon/${addon.id}` }));</span>
<a href="#l1.318"></a><span id="l1.318" class="difflineminus">-</span>
<a href="#l1.319"></a><span id="l1.319" class="difflineminus">-      Services.scriptloader.loadSubScript(uri, sandbox);</span>
<a href="#l1.320"></a><span id="l1.320" class="difflineminus">-    } catch (e) {</span>
<a href="#l1.321"></a><span id="l1.321" class="difflineminus">-      logger.warn(`Error loading bootstrap.js for ${addon.id}`, e);</span>
<a href="#l1.322"></a><span id="l1.322" class="difflineminus">-    }</span>
<a href="#l1.323"></a><span id="l1.323" class="difflineminus">-</span>
<a href="#l1.324"></a><span id="l1.324" class="difflineminus">-    function findMethod(name) {</span>
<a href="#l1.325"></a><span id="l1.325" class="difflineminus">-      if (sandbox.name) {</span>
<a href="#l1.326"></a><span id="l1.326" class="difflineminus">-        return sandbox.name;</span>
<a href="#l1.327"></a><span id="l1.327" class="difflineminus">-      }</span>
<a href="#l1.328"></a><span id="l1.328" class="difflineminus">-</span>
<a href="#l1.329"></a><span id="l1.329" class="difflineminus">-      try {</span>
<a href="#l1.330"></a><span id="l1.330" class="difflineminus">-        let method = Cu.evalInSandbox(name, sandbox);</span>
<a href="#l1.331"></a><span id="l1.331" class="difflineminus">-        return method;</span>
<a href="#l1.332"></a><span id="l1.332" class="difflineminus">-      } catch (err) { }</span>
<a href="#l1.333"></a><span id="l1.333" class="difflineminus">-</span>
<a href="#l1.334"></a><span id="l1.334" class="difflineminus">-      return () =&gt; {</span>
<a href="#l1.335"></a><span id="l1.335" class="difflineminus">-        logger.warn(`Add-on ${addon.id} is missing bootstrap method ${name}`);</span>
<a href="#l1.336"></a><span id="l1.336" class="difflineminus">-      };</span>
<a href="#l1.337"></a><span id="l1.337" class="difflineminus">-    }</span>
<a href="#l1.338"></a><span id="l1.338" class="difflineminus">-</span>
<a href="#l1.339"></a><span id="l1.339" class="difflineminus">-    let install = findMethod(&quot;install&quot;);</span>
<a href="#l1.340"></a><span id="l1.340" class="difflineminus">-    let uninstall = findMethod(&quot;uninstall&quot;);</span>
<a href="#l1.341"></a><span id="l1.341" class="difflineminus">-    let startup = findMethod(&quot;startup&quot;);</span>
<a href="#l1.342"></a><span id="l1.342" class="difflineminus">-    let shutdown = findMethod(&quot;shutdown&quot;);</span>
<a href="#l1.343"></a><span id="l1.343" class="difflineminus">-</span>
<a href="#l1.344"></a><span id="l1.344" class="difflineminus">-    return {</span>
<a href="#l1.345"></a><span id="l1.345" class="difflineminus">-      install: (...args) =&gt; install(...args),</span>
<a href="#l1.346"></a><span id="l1.346" class="difflineminus">-</span>
<a href="#l1.347"></a><span id="l1.347" class="difflineminus">-      uninstall(...args) {</span>
<a href="#l1.348"></a><span id="l1.348" class="difflineminus">-        uninstall(...args);</span>
<a href="#l1.349"></a><span id="l1.349" class="difflineminus">-        // Forget any cached files we might've had from this extension.</span>
<a href="#l1.350"></a><span id="l1.350" class="difflineminus">-        Services.obs.notifyObservers(null, &quot;startupcache-invalidate&quot;);</span>
<a href="#l1.351"></a><span id="l1.351" class="difflineminus">-      },</span>
<a href="#l1.352"></a><span id="l1.352" class="difflineminus">-</span>
<a href="#l1.353"></a><span id="l1.353" class="difflineminus">-      startup(...args) {</span>
<a href="#l1.354"></a><span id="l1.354" class="difflineminus">-        if (addon.type == &quot;extension&quot;) {</span>
<a href="#l1.355"></a><span id="l1.355" class="difflineminus">-          logger.debug(`Registering manifest for ${file.path}\n`);</span>
<a href="#l1.356"></a><span id="l1.356" class="difflineminus">-          Components.manager.addBootstrappedManifestLocation(file);</span>
<a href="#l1.357"></a><span id="l1.357" class="difflineminus">-        }</span>
<a href="#l1.358"></a><span id="l1.358" class="difflineminus">-        return startup(...args);</span>
<a href="#l1.359"></a><span id="l1.359" class="difflineminus">-      },</span>
<a href="#l1.360"></a><span id="l1.360" class="difflineminus">-</span>
<a href="#l1.361"></a><span id="l1.361" class="difflineminus">-      shutdown(data, reason) {</span>
<a href="#l1.362"></a><span id="l1.362" class="difflineminus">-        try {</span>
<a href="#l1.363"></a><span id="l1.363" class="difflineminus">-          return shutdown(data, reason);</span>
<a href="#l1.364"></a><span id="l1.364" class="difflineminus">-        } catch (err) {</span>
<a href="#l1.365"></a><span id="l1.365" class="difflineminus">-          throw err;</span>
<a href="#l1.366"></a><span id="l1.366" class="difflineminus">-        } finally {</span>
<a href="#l1.367"></a><span id="l1.367" class="difflineminus">-          if (reason != BOOTSTRAP_REASONS.APP_SHUTDOWN) {</span>
<a href="#l1.368"></a><span id="l1.368" class="difflineminus">-            logger.debug(`Removing manifest for ${file.path}\n`);</span>
<a href="#l1.369"></a><span id="l1.369" class="difflineminus">-            Components.manager.removeBootstrappedManifestLocation(file);</span>
<a href="#l1.370"></a><span id="l1.370" class="difflineminus">-          }</span>
<a href="#l1.371"></a><span id="l1.371" class="difflineminus">-        }</span>
<a href="#l1.372"></a><span id="l1.372" class="difflineminus">-      },</span>
<a href="#l1.373"></a><span id="l1.373" class="difflineminus">-    };</span>
<a href="#l1.374"></a><span id="l1.374" class="difflineminus">-  },</span>
<a href="#l1.375"></a><span id="l1.375" class="difflineminus">-};</span>
<a href="#l1.376"></a><span id="l1.376" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/common/src/ExtensionSupport.jsm</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/common/src/ExtensionSupport.jsm</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -14,16 +14,17 @@ const {Services} = ChromeUtils.import(&quot;r</span>
<a href="#l2.4"></a><span id="l2.4"> // ChromeUtils.import(&quot;resource://gre/modules/Deprecated.jsm&quot;) - needed for warning.</span>
<a href="#l2.5"></a><span id="l2.5"> const {NetUtil} = ChromeUtils.import(&quot;resource://gre/modules/NetUtil.jsm&quot;);</span>
<a href="#l2.6"></a><span id="l2.6"> </span>
<a href="#l2.7"></a><span id="l2.7"> var { fixIterator } = ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l2.8"></a><span id="l2.8"> const {IOUtils} = ChromeUtils.import(&quot;resource:///modules/IOUtils.js&quot;);</span>
<a href="#l2.9"></a><span id="l2.9"> </span>
<a href="#l2.10"></a><span id="l2.10"> var extensionHooks = new Map();</span>
<a href="#l2.11"></a><span id="l2.11"> var legacyExtensions = new Map();</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+var bootstrapExtensions = new Set();</span>
<a href="#l2.13"></a><span id="l2.13"> var openWindowList;</span>
<a href="#l2.14"></a><span id="l2.14"> </span>
<a href="#l2.15"></a><span id="l2.15"> var ExtensionSupport = {</span>
<a href="#l2.16"></a><span id="l2.16">   /**</span>
<a href="#l2.17"></a><span id="l2.17">    * A Map-like object which tracks legacy extension status. The &quot;has&quot; method</span>
<a href="#l2.18"></a><span id="l2.18">    * returns only active extensions for compatibility with existing code.</span>
<a href="#l2.19"></a><span id="l2.19">    */</span>
<a href="#l2.20"></a><span id="l2.20">   loadedLegacyExtensions: {</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineat">@@ -64,16 +65,18 @@ var ExtensionSupport = {</span>
<a href="#l2.22"></a><span id="l2.22">     onDisabled(ev) {</span>
<a href="#l2.23"></a><span id="l2.23">       this._maybeDelete(ev.id, &quot;disable&quot;);</span>
<a href="#l2.24"></a><span id="l2.24">     },</span>
<a href="#l2.25"></a><span id="l2.25">     onUninstalled(ev) {</span>
<a href="#l2.26"></a><span id="l2.26">       this._maybeDelete(ev.id, &quot;uninstall&quot;);</span>
<a href="#l2.27"></a><span id="l2.27">     },</span>
<a href="#l2.28"></a><span id="l2.28">   },</span>
<a href="#l2.29"></a><span id="l2.29"> </span>
<a href="#l2.30"></a><span id="l2.30" class="difflineplus">+  loadedBootstrapExtensions: bootstrapExtensions,</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+</span>
<a href="#l2.32"></a><span id="l2.32">   loadAddonPrefs(addonFile) {</span>
<a href="#l2.33"></a><span id="l2.33">     function setPref(preferDefault, name, value) {</span>
<a href="#l2.34"></a><span id="l2.34">       let branch = preferDefault ? Services.prefs.getDefaultBranch(&quot;&quot;) : Services.prefs.getBranch(&quot;&quot;);</span>
<a href="#l2.35"></a><span id="l2.35"> </span>
<a href="#l2.36"></a><span id="l2.36">       if (typeof value == &quot;boolean&quot;) {</span>
<a href="#l2.37"></a><span id="l2.37">         branch.setBoolPref(name, value);</span>
<a href="#l2.38"></a><span id="l2.38">       } else if (typeof value == &quot;string&quot;) {</span>
<a href="#l2.39"></a><span id="l2.39">         if (value.startsWith(&quot;chrome://&quot;) &amp;&amp; value.endsWith(&quot;.properties&quot;)) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1">deleted file mode 100644</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineminus">--- a/common/src/RDFDataSource.jsm</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineplus">+++ /dev/null</span>
<a href="#l3.4"></a><span id="l3.4" class="difflineat">@@ -1,1520 +0,0 @@</span>
<a href="#l3.5"></a><span id="l3.5" class="difflineminus">- /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l3.6"></a><span id="l3.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l3.7"></a><span id="l3.7" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l3.8"></a><span id="l3.8" class="difflineminus">-</span>
<a href="#l3.9"></a><span id="l3.9" class="difflineminus">-/**</span>
<a href="#l3.10"></a><span id="l3.10" class="difflineminus">- * This module creates a new API for accessing and modifying RDF graphs. The</span>
<a href="#l3.11"></a><span id="l3.11" class="difflineminus">- * goal is to be able to serialise the graph in a human readable form. Also</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">- * if the graph was originally loaded from an RDF/XML the serialisation should</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">- * closely match the original with any new data closely following the existing</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">- * layout. The output should always be compatible with Mozilla's RDF parser.</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">- *</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineminus">- * This is all achieved by using a DOM Document to hold the current state of the</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineminus">- * graph in XML form. This can be initially loaded and parsed from disk or</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineminus">- * a blank document used for an empty graph. As assertions are added to the</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineminus">- * graph, appropriate DOM nodes are added to the document to represent them</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineminus">- * along with any necessary whitespace to properly layout the XML.</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineminus">- *</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineminus">- * In general the order of adding assertions to the graph will impact the form</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineminus">- * the serialisation takes. If a resource is first added as the object of an</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineminus">- * assertion then it will eventually be serialised inside the assertion's</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineminus">- * property element. If a resource is first added as the subject of an assertion</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineminus">- * then it will be serialised at the top level of the XML.</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineminus">- */</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineminus">-</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineminus">-const NS_XML = &quot;http://www.w3.org/XML/1998/namespace&quot;;</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineminus">-const NS_XMLNS = &quot;http://www.w3.org/2000/xmlns/&quot;;</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-const NS_RDF = &quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#&quot;;</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineminus">-const NS_NC = &quot;http://home.netscape.com/NC-rdf#&quot;;</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineminus">-</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineminus">-/* eslint prefer-template: 1 */</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineminus">-</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineminus">-function raw(strings) {</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineminus">-  return strings.raw[0].replace(/\s+/, &quot;&quot;);</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineminus">-}</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineminus">-</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineminus">-// Copied from http://www.w3.org/TR/2000/REC-xml-20001006#CharClasses</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineminus">-const XML_LETTER = raw`</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineminus">-  \u0041-\u005A\u0061-\u007A\u00C0-\u00D6\u00D8-\u00F6</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineminus">-  \u00F8-\u00FF\u0100-\u0131\u0134-\u013E\u0141-\u0148</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineminus">-  \u014A-\u017E\u0180-\u01C3\u01CD-\u01F0\u01F4-\u01F5</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineminus">-  \u01FA-\u0217\u0250-\u02A8\u02BB-\u02C1\u0386\u0388-\u038A</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineminus">-  \u038C\u038E-\u03A1\u03A3-\u03CE\u03D0-\u03D6\u03DA\u03DC</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineminus">-  \u03DE\u03E0\u03E2-\u03F3\u0401-\u040C\u040E-\u044F</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineminus">-  \u0451-\u045C\u045E-\u0481\u0490-\u04C4\u04C7-\u04C8</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineminus">-  \u04CB-\u04CC\u04D0-\u04EB\u04EE-\u04F5\u04F8-\u04F9</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineminus">-  \u0531-\u0556\u0559\u0561-\u0586\u05D0-\u05EA\u05F0-\u05F2</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineminus">-  \u0621-\u063A\u0641-\u064A\u0671-\u06B7\u06BA-\u06BE</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineminus">-  \u06C0-\u06CE\u06D0-\u06D3\u06D5\u06E5-\u06E6\u0905-\u0939</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineminus">-  \u093D\u0958-\u0961\u0985-\u098C\u098F-\u0990\u0993-\u09A8</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineminus">-  \u09AA-\u09B0\u09B2\u09B6-\u09B9\u09DC-\u09DD\u09DF-\u09E1</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineminus">-  \u09F0-\u09F1\u0A05-\u0A0A\u0A0F-\u0A10\u0A13-\u0A28</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineminus">-  \u0A2A-\u0A30\u0A32-\u0A33\u0A35-\u0A36\u0A38-\u0A39</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineminus">-  \u0A59-\u0A5C\u0A5E\u0A72-\u0A74\u0A85-\u0A8B\u0A8D</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineminus">-  \u0A8F-\u0A91\u0A93-\u0AA8\u0AAA-\u0AB0\u0AB2-\u0AB3</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineminus">-  \u0AB5-\u0AB9\u0ABD\u0AE0\u0B05-\u0B0C\u0B0F-\u0B10</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineminus">-  \u0B13-\u0B28\u0B2A-\u0B30\u0B32-\u0B33\u0B36-\u0B39</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineminus">-  \u0B3D\u0B5C-\u0B5D\u0B5F-\u0B61\u0B85-\u0B8A\u0B8E-\u0B90</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineminus">-  \u0B92-\u0B95\u0B99-\u0B9A\u0B9C\u0B9E-\u0B9F\u0BA3-\u0BA4</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineminus">-  \u0BA8-\u0BAA\u0BAE-\u0BB5\u0BB7-\u0BB9\u0C05-\u0C0C</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineminus">-  \u0C0E-\u0C10\u0C12-\u0C28\u0C2A-\u0C33\u0C35-\u0C39</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineminus">-  \u0C60-\u0C61\u0C85-\u0C8C\u0C8E-\u0C90\u0C92-\u0CA8</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineminus">-  \u0CAA-\u0CB3\u0CB5-\u0CB9\u0CDE\u0CE0-\u0CE1\u0D05-\u0D0C</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineminus">-  \u0D0E-\u0D10\u0D12-\u0D28\u0D2A-\u0D39\u0D60-\u0D61</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineminus">-  \u0E01-\u0E2E\u0E30\u0E32-\u0E33\u0E40-\u0E45\u0E81-\u0E82</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineminus">-  \u0E84\u0E87-\u0E88\u0E8A\u0E8D\u0E94-\u0E97\u0E99-\u0E9F</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineminus">-  \u0EA1-\u0EA3\u0EA5\u0EA7\u0EAA-\u0EAB\u0EAD-\u0EAE\u0EB0</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineminus">-  \u0EB2-\u0EB3\u0EBD\u0EC0-\u0EC4\u0F40-\u0F47\u0F49-\u0F69</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineminus">-  \u10A0-\u10C5\u10D0-\u10F6\u1100\u1102-\u1103\u1105-\u1107</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineminus">-  \u1109\u110B-\u110C\u110E-\u1112\u113C\u113E\u1140\u114C</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineminus">-  \u114E\u1150\u1154-\u1155\u1159\u115F-\u1161\u1163\u1165</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineminus">-  \u1167\u1169\u116D-\u116E\u1172-\u1173\u1175\u119E\u11A8</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineminus">-  \u11AB\u11AE-\u11AF\u11B7-\u11B8\u11BA\u11BC-\u11C2\u11EB</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineminus">-  \u11F0\u11F9\u1E00-\u1E9B\u1EA0-\u1EF9\u1F00-\u1F15</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineminus">-  \u1F18-\u1F1D\u1F20-\u1F45\u1F48-\u1F4D\u1F50-\u1F57</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineminus">-  \u1F59\u1F5B\u1F5D\u1F5F-\u1F7D\u1F80-\u1FB4\u1FB6-\u1FBC</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineminus">-  \u1FBE\u1FC2-\u1FC4\u1FC6-\u1FCC\u1FD0-\u1FD3\u1FD6-\u1FDB</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineminus">-  \u1FE0-\u1FEC\u1FF2-\u1FF4\u1FF6-\u1FFC\u2126\u212A-\u212B</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineminus">-  \u212E\u2180-\u2182\u3041-\u3094\u30A1-\u30FA\u3105-\u312C</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineminus">-  \uAC00-\uD7A3\u4E00-\u9FA5\u3007\u3021-\u3029</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineminus">-`;</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineminus">-const XML_DIGIT = raw`</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineminus">-  \u0030-\u0039\u0660-\u0669\u06F0-\u06F9\u0966-\u096F</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineminus">-  \u09E6-\u09EF\u0A66-\u0A6F\u0AE6-\u0AEF\u0B66-\u0B6F</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineminus">-  \u0BE7-\u0BEF\u0C66-\u0C6F\u0CE6-\u0CEF\u0D66-\u0D6F</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineminus">-  \u0E50-\u0E59\u0ED0-\u0ED9\u0F20-\u0F29</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineminus">-`;</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineminus">-const XML_COMBINING = raw`</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineminus">-  \u0300-\u0345\u0360-\u0361\u0483-\u0486\u0591-\u05A1</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineminus">-  \u05A3-\u05B9\u05BB-\u05BD\u05BF\u05C1-\u05C2\u05C4</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineminus">-  \u064B-\u0652\u0670\u06D6-\u06DC\u06DD-\u06DF\u06E0-\u06E4</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineminus">-  \u06E7-\u06E8\u06EA-\u06ED\u0901-\u0903\u093C\u093E-\u094C</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineminus">-  \u094D\u0951-\u0954\u0962-\u0963\u0981-\u0983\u09BC\u09BE</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineminus">-  \u09BF\u09C0-\u09C4\u09C7-\u09C8\u09CB-\u09CD\u09D7</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineminus">-  \u09E2-\u09E3\u0A02\u0A3C\u0A3E\u0A3F\u0A40-\u0A42</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineminus">-  \u0A47-\u0A48\u0A4B-\u0A4D\u0A70-\u0A71\u0A81-\u0A83</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineminus">-  \u0ABC\u0ABE-\u0AC5\u0AC7-\u0AC9\u0ACB-\u0ACD\u0B01-\u0B03</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineminus">-  \u0B3C\u0B3E-\u0B43\u0B47-\u0B48\u0B4B-\u0B4D\u0B56-\u0B57</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineminus">-  \u0B82-\u0B83\u0BBE-\u0BC2\u0BC6-\u0BC8\u0BCA-\u0BCD\u0BD7</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineminus">-  \u0C01-\u0C03\u0C3E-\u0C44\u0C46-\u0C48\u0C4A-\u0C4D</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineminus">-  \u0C55-\u0C56\u0C82-\u0C83\u0CBE-\u0CC4\u0CC6-\u0CC8</span>
<a href="#l3.105"></a><span id="l3.105" class="difflineminus">-  \u0CCA-\u0CCD\u0CD5-\u0CD6\u0D02-\u0D03\u0D3E-\u0D43</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineminus">-  \u0D46-\u0D48\u0D4A-\u0D4D\u0D57\u0E31\u0E34-\u0E3A</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineminus">-  \u0E47-\u0E4E\u0EB1\u0EB4-\u0EB9\u0EBB-\u0EBC\u0EC8-\u0ECD</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineminus">-  \u0F18-\u0F19\u0F35\u0F37\u0F39\u0F3E\u0F3F\u0F71-\u0F84</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineminus">-  \u0F86-\u0F8B\u0F90-\u0F95\u0F97\u0F99-\u0FAD\u0FB1-\u0FB7</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineminus">-  \u0FB9\u20D0-\u20DC\u20E1\u302A-\u302F\u3099\u309A</span>
<a href="#l3.111"></a><span id="l3.111" class="difflineminus">-`;</span>
<a href="#l3.112"></a><span id="l3.112" class="difflineminus">-const XML_EXTENDER = raw`</span>
<a href="#l3.113"></a><span id="l3.113" class="difflineminus">-  \u00B7\u02D0\u02D1\u0387\u0640\u0E46\u0EC6\u3005</span>
<a href="#l3.114"></a><span id="l3.114" class="difflineminus">-  \u3031-\u3035\u309D-\u309E\u30FC-\u30FE</span>
<a href="#l3.115"></a><span id="l3.115" class="difflineminus">-`;</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineminus">-const XML_NCNAMECHAR = String.raw`${XML_LETTER}${XML_DIGIT}\.\-_${XML_COMBINING}${XML_EXTENDER}`;</span>
<a href="#l3.117"></a><span id="l3.117" class="difflineminus">-const XML_NCNAME = new RegExp(`^[${XML_LETTER}_][${XML_NCNAMECHAR}]*$`);</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineminus">-</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineminus">-const URI_SUFFIX = /[A-Za-z_][0-9A-Za-z\.\-_]*$/;</span>
<a href="#l3.120"></a><span id="l3.120" class="difflineminus">-const INDENT = /\n([ \t]*)$/;</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineminus">-const RDF_LISTITEM = /^http:\/\/www.w3.org\/1999\/02\/22-rdf-syntax-ns#_\d+$/;</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineminus">-</span>
<a href="#l3.123"></a><span id="l3.123" class="difflineminus">-const RDF_NODE_INVALID_TYPES =</span>
<a href="#l3.124"></a><span id="l3.124" class="difflineminus">-        [&quot;RDF&quot;, &quot;ID&quot;, &quot;about&quot;, &quot;bagID&quot;, &quot;parseType&quot;, &quot;resource&quot;, &quot;nodeID&quot;,</span>
<a href="#l3.125"></a><span id="l3.125" class="difflineminus">-         &quot;li&quot;, &quot;aboutEach&quot;, &quot;aboutEachPrefix&quot;];</span>
<a href="#l3.126"></a><span id="l3.126" class="difflineminus">-const RDF_PROPERTY_INVALID_TYPES =</span>
<a href="#l3.127"></a><span id="l3.127" class="difflineminus">-        [&quot;Description&quot;, &quot;RDF&quot;, &quot;ID&quot;, &quot;about&quot;, &quot;bagID&quot;, &quot;parseType&quot;, &quot;resource&quot;,</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineminus">-         &quot;nodeID&quot;, &quot;aboutEach&quot;, &quot;aboutEachPrefix&quot;];</span>
<a href="#l3.129"></a><span id="l3.129" class="difflineminus">-</span>
<a href="#l3.130"></a><span id="l3.130" class="difflineminus">-/**</span>
<a href="#l3.131"></a><span id="l3.131" class="difflineminus">- * Whether to use properly namespaces attributes for rdf:about etc...</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineminus">- * When on this produces poor output in the event that the rdf namespace is the</span>
<a href="#l3.133"></a><span id="l3.133" class="difflineminus">- * default namespace, and the parser recognises unnamespaced attributes and</span>
<a href="#l3.134"></a><span id="l3.134" class="difflineminus">- * most of our rdf examples are unnamespaced so leaving off for the time being.</span>
<a href="#l3.135"></a><span id="l3.135" class="difflineminus">- */</span>
<a href="#l3.136"></a><span id="l3.136" class="difflineminus">-const USE_RDFNS_ATTR = false;</span>
<a href="#l3.137"></a><span id="l3.137" class="difflineminus">-</span>
<a href="#l3.138"></a><span id="l3.138" class="difflineminus">-var EXPORTED_SYMBOLS = [&quot;RDFLiteral&quot;, &quot;RDFIntLiteral&quot;, &quot;RDFDateLiteral&quot;,</span>
<a href="#l3.139"></a><span id="l3.139" class="difflineminus">-                        &quot;RDFBlankNode&quot;, &quot;RDFResource&quot;, &quot;RDFDataSource&quot;];</span>
<a href="#l3.140"></a><span id="l3.140" class="difflineminus">-</span>
<a href="#l3.141"></a><span id="l3.141" class="difflineminus">-const {XPCOMUtils} = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l3.142"></a><span id="l3.142" class="difflineminus">-</span>
<a href="#l3.143"></a><span id="l3.143" class="difflineminus">-XPCOMUtils.defineLazyGlobalGetters(this, [&quot;DOMParser&quot;, &quot;Element&quot;, &quot;XMLSerializer&quot;, &quot;fetch&quot;]);</span>
<a href="#l3.144"></a><span id="l3.144" class="difflineminus">-</span>
<a href="#l3.145"></a><span id="l3.145" class="difflineminus">-ChromeUtils.defineModuleGetter(this, &quot;OS&quot;,</span>
<a href="#l3.146"></a><span id="l3.146" class="difflineminus">-                               &quot;resource://gre/modules/osfile.jsm&quot;);</span>
<a href="#l3.147"></a><span id="l3.147" class="difflineminus">-ChromeUtils.defineModuleGetter(this, &quot;Services&quot;,</span>
<a href="#l3.148"></a><span id="l3.148" class="difflineminus">-                               &quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l3.149"></a><span id="l3.149" class="difflineminus">-</span>
<a href="#l3.150"></a><span id="l3.150" class="difflineminus">-function isAttr(obj) {</span>
<a href="#l3.151"></a><span id="l3.151" class="difflineminus">-  return obj &amp;&amp; typeof obj == &quot;object&quot; &amp;&amp; ChromeUtils.getClassName(obj) == &quot;Attr&quot;;</span>
<a href="#l3.152"></a><span id="l3.152" class="difflineminus">-}</span>
<a href="#l3.153"></a><span id="l3.153" class="difflineminus">-function isDocument(obj) {</span>
<a href="#l3.154"></a><span id="l3.154" class="difflineminus">-  return obj &amp;&amp; typeof obj == &quot;object&quot; &amp;&amp; obj.nodeType == Element.DOCUMENT_NODE;</span>
<a href="#l3.155"></a><span id="l3.155" class="difflineminus">-}</span>
<a href="#l3.156"></a><span id="l3.156" class="difflineminus">-function isElement(obj) {</span>
<a href="#l3.157"></a><span id="l3.157" class="difflineminus">-  return Element.isInstance(obj);</span>
<a href="#l3.158"></a><span id="l3.158" class="difflineminus">-}</span>
<a href="#l3.159"></a><span id="l3.159" class="difflineminus">-function isText(obj) {</span>
<a href="#l3.160"></a><span id="l3.160" class="difflineminus">-  return obj &amp;&amp; typeof obj == &quot;object&quot; &amp;&amp; ChromeUtils.getClassName(obj) == &quot;Text&quot;;</span>
<a href="#l3.161"></a><span id="l3.161" class="difflineminus">-}</span>
<a href="#l3.162"></a><span id="l3.162" class="difflineminus">-</span>
<a href="#l3.163"></a><span id="l3.163" class="difflineminus">-/**</span>
<a href="#l3.164"></a><span id="l3.164" class="difflineminus">- * Logs an error message to the error console</span>
<a href="#l3.165"></a><span id="l3.165" class="difflineminus">- */</span>
<a href="#l3.166"></a><span id="l3.166" class="difflineminus">-function ERROR(str) {</span>
<a href="#l3.167"></a><span id="l3.167" class="difflineminus">-  Cu.reportError(str);</span>
<a href="#l3.168"></a><span id="l3.168" class="difflineminus">-}</span>
<a href="#l3.169"></a><span id="l3.169" class="difflineminus">-</span>
<a href="#l3.170"></a><span id="l3.170" class="difflineminus">-function RDF_R(name) {</span>
<a href="#l3.171"></a><span id="l3.171" class="difflineminus">-  return NS_RDF + name;</span>
<a href="#l3.172"></a><span id="l3.172" class="difflineminus">-}</span>
<a href="#l3.173"></a><span id="l3.173" class="difflineminus">-</span>
<a href="#l3.174"></a><span id="l3.174" class="difflineminus">-function renameNode(domnode, namespaceURI, qname) {</span>
<a href="#l3.175"></a><span id="l3.175" class="difflineminus">-  if (isElement(domnode)) {</span>
<a href="#l3.176"></a><span id="l3.176" class="difflineminus">-    var newdomnode = domnode.ownerDocument.createElementNS(namespaceURI, qname);</span>
<a href="#l3.177"></a><span id="l3.177" class="difflineminus">-    if (&quot;listCounter&quot; in domnode)</span>
<a href="#l3.178"></a><span id="l3.178" class="difflineminus">-      newdomnode.listCounter = domnode.listCounter;</span>
<a href="#l3.179"></a><span id="l3.179" class="difflineminus">-    domnode.replaceWith(newdomnode);</span>
<a href="#l3.180"></a><span id="l3.180" class="difflineminus">-    while (domnode.firstChild)</span>
<a href="#l3.181"></a><span id="l3.181" class="difflineminus">-      newdomnode.appendChild(domnode.firstChild);</span>
<a href="#l3.182"></a><span id="l3.182" class="difflineminus">-    for (let attr of domnode.attributes) {</span>
<a href="#l3.183"></a><span id="l3.183" class="difflineminus">-      domnode.removeAttributeNode(attr);</span>
<a href="#l3.184"></a><span id="l3.184" class="difflineminus">-      newdomnode.setAttributeNode(attr);</span>
<a href="#l3.185"></a><span id="l3.185" class="difflineminus">-    }</span>
<a href="#l3.186"></a><span id="l3.186" class="difflineminus">-    return newdomnode;</span>
<a href="#l3.187"></a><span id="l3.187" class="difflineminus">-  } else if (isAttr(domnode)) {</span>
<a href="#l3.188"></a><span id="l3.188" class="difflineminus">-    if (domnode.ownerElement.hasAttribute(namespaceURI, qname))</span>
<a href="#l3.189"></a><span id="l3.189" class="difflineminus">-      throw new Error(&quot;attribute already exists&quot;);</span>
<a href="#l3.190"></a><span id="l3.190" class="difflineminus">-    var attr = domnode.ownerDocument.createAttributeNS(namespaceURI, qname);</span>
<a href="#l3.191"></a><span id="l3.191" class="difflineminus">-    attr.value = domnode.value;</span>
<a href="#l3.192"></a><span id="l3.192" class="difflineminus">-    domnode.ownerElement.setAttributeNode(attr);</span>
<a href="#l3.193"></a><span id="l3.193" class="difflineminus">-    domnode.ownerElement.removeAttributeNode(domnode);</span>
<a href="#l3.194"></a><span id="l3.194" class="difflineminus">-    return attr;</span>
<a href="#l3.195"></a><span id="l3.195" class="difflineminus">-  }</span>
<a href="#l3.196"></a><span id="l3.196" class="difflineminus">-  throw new Error(&quot;cannot rename node of this type&quot;);</span>
<a href="#l3.197"></a><span id="l3.197" class="difflineminus">-}</span>
<a href="#l3.198"></a><span id="l3.198" class="difflineminus">-</span>
<a href="#l3.199"></a><span id="l3.199" class="difflineminus">-function predicateOrder(a, b) {</span>
<a href="#l3.200"></a><span id="l3.200" class="difflineminus">-  return a.getPredicate().localeCompare(b.getPredicate());</span>
<a href="#l3.201"></a><span id="l3.201" class="difflineminus">-}</span>
<a href="#l3.202"></a><span id="l3.202" class="difflineminus">-</span>
<a href="#l3.203"></a><span id="l3.203" class="difflineminus">-/**</span>
<a href="#l3.204"></a><span id="l3.204" class="difflineminus">- * Returns either an rdf namespaced attribute or an un-namespaced attribute</span>
<a href="#l3.205"></a><span id="l3.205" class="difflineminus">- * value. Returns null if neither exists,</span>
<a href="#l3.206"></a><span id="l3.206" class="difflineminus">- */</span>
<a href="#l3.207"></a><span id="l3.207" class="difflineminus">-function getRDFAttribute(element, name) {</span>
<a href="#l3.208"></a><span id="l3.208" class="difflineminus">-  if (element.hasAttributeNS(NS_RDF, name))</span>
<a href="#l3.209"></a><span id="l3.209" class="difflineminus">-    return element.getAttributeNS(NS_RDF, name);</span>
<a href="#l3.210"></a><span id="l3.210" class="difflineminus">-  if (element.hasAttribute(name))</span>
<a href="#l3.211"></a><span id="l3.211" class="difflineminus">-    return element.getAttribute(name);</span>
<a href="#l3.212"></a><span id="l3.212" class="difflineminus">-  return undefined;</span>
<a href="#l3.213"></a><span id="l3.213" class="difflineminus">-}</span>
<a href="#l3.214"></a><span id="l3.214" class="difflineminus">-</span>
<a href="#l3.215"></a><span id="l3.215" class="difflineminus">-/**</span>
<a href="#l3.216"></a><span id="l3.216" class="difflineminus">- * Represents an assertion in the datasource</span>
<a href="#l3.217"></a><span id="l3.217" class="difflineminus">- */</span>
<a href="#l3.218"></a><span id="l3.218" class="difflineminus">-class RDFAssertion {</span>
<a href="#l3.219"></a><span id="l3.219" class="difflineminus">-  constructor(subject, predicate, object) {</span>
<a href="#l3.220"></a><span id="l3.220" class="difflineminus">-    if (!(subject instanceof RDFSubject))</span>
<a href="#l3.221"></a><span id="l3.221" class="difflineminus">-      throw new Error(&quot;subject must be an RDFSubject&quot;);</span>
<a href="#l3.222"></a><span id="l3.222" class="difflineminus">-</span>
<a href="#l3.223"></a><span id="l3.223" class="difflineminus">-    if (typeof(predicate) != &quot;string&quot;)</span>
<a href="#l3.224"></a><span id="l3.224" class="difflineminus">-      throw new Error(&quot;predicate must be a string URI&quot;);</span>
<a href="#l3.225"></a><span id="l3.225" class="difflineminus">-</span>
<a href="#l3.226"></a><span id="l3.226" class="difflineminus">-    if (!(object instanceof RDFLiteral) &amp;&amp; !(object instanceof RDFSubject))</span>
<a href="#l3.227"></a><span id="l3.227" class="difflineminus">-      throw new Error(&quot;object must be a concrete RDFNode&quot;);</span>
<a href="#l3.228"></a><span id="l3.228" class="difflineminus">-</span>
<a href="#l3.229"></a><span id="l3.229" class="difflineminus">-    if (object instanceof RDFSubject &amp;&amp; object._ds != subject._ds)</span>
<a href="#l3.230"></a><span id="l3.230" class="difflineminus">-      throw new Error(&quot;object must be from the same datasource as subject&quot;);</span>
<a href="#l3.231"></a><span id="l3.231" class="difflineminus">-</span>
<a href="#l3.232"></a><span id="l3.232" class="difflineminus">-    // The subject on this assertion, an RDFSubject</span>
<a href="#l3.233"></a><span id="l3.233" class="difflineminus">-    this._subject = subject;</span>
<a href="#l3.234"></a><span id="l3.234" class="difflineminus">-    // The predicate, a string</span>
<a href="#l3.235"></a><span id="l3.235" class="difflineminus">-    this._predicate = predicate;</span>
<a href="#l3.236"></a><span id="l3.236" class="difflineminus">-    // The object, an RDFNode</span>
<a href="#l3.237"></a><span id="l3.237" class="difflineminus">-    this._object = object;</span>
<a href="#l3.238"></a><span id="l3.238" class="difflineminus">-    // The datasource this assertion exists in</span>
<a href="#l3.239"></a><span id="l3.239" class="difflineminus">-    this._ds = this._subject._ds;</span>
<a href="#l3.240"></a><span id="l3.240" class="difflineminus">-    // Marks that _DOMnode is the subject's element</span>
<a href="#l3.241"></a><span id="l3.241" class="difflineminus">-    this._isSubjectElement = false;</span>
<a href="#l3.242"></a><span id="l3.242" class="difflineminus">-    // The DOM node that represents this assertion. Could be a property element,</span>
<a href="#l3.243"></a><span id="l3.243" class="difflineminus">-    // a property attribute or the subject's element for rdf:type</span>
<a href="#l3.244"></a><span id="l3.244" class="difflineminus">-    this._DOMNode = null;</span>
<a href="#l3.245"></a><span id="l3.245" class="difflineminus">-  }</span>
<a href="#l3.246"></a><span id="l3.246" class="difflineminus">-</span>
<a href="#l3.247"></a><span id="l3.247" class="difflineminus">-  /**</span>
<a href="#l3.248"></a><span id="l3.248" class="difflineminus">-   * Adds content to _DOMnode to store this assertion in the DOM document.</span>
<a href="#l3.249"></a><span id="l3.249" class="difflineminus">-   */</span>
<a href="#l3.250"></a><span id="l3.250" class="difflineminus">-  _applyToDOMNode() {</span>
<a href="#l3.251"></a><span id="l3.251" class="difflineminus">-    if (this._object instanceof RDFLiteral)</span>
<a href="#l3.252"></a><span id="l3.252" class="difflineminus">-      this._object._applyToDOMNode(this._ds, this._DOMnode);</span>
<a href="#l3.253"></a><span id="l3.253" class="difflineminus">-    else</span>
<a href="#l3.254"></a><span id="l3.254" class="difflineminus">-      this._object._addReferenceToElement(this._DOMnode);</span>
<a href="#l3.255"></a><span id="l3.255" class="difflineminus">-  }</span>
<a href="#l3.256"></a><span id="l3.256" class="difflineminus">-</span>
<a href="#l3.257"></a><span id="l3.257" class="difflineminus">-  /**</span>
<a href="#l3.258"></a><span id="l3.258" class="difflineminus">-   * Returns the DOM Element linked to the subject that this assertion is</span>
<a href="#l3.259"></a><span id="l3.259" class="difflineminus">-   * attached to.</span>
<a href="#l3.260"></a><span id="l3.260" class="difflineminus">-   */</span>
<a href="#l3.261"></a><span id="l3.261" class="difflineminus">-  _getSubjectElement() {</span>
<a href="#l3.262"></a><span id="l3.262" class="difflineminus">-    if (isAttr(this._DOMnode))</span>
<a href="#l3.263"></a><span id="l3.263" class="difflineminus">-      return this._DOMnode.ownerElement;</span>
<a href="#l3.264"></a><span id="l3.264" class="difflineminus">-    if (this._isSubjectElement)</span>
<a href="#l3.265"></a><span id="l3.265" class="difflineminus">-      return this._DOMnode;</span>
<a href="#l3.266"></a><span id="l3.266" class="difflineminus">-    return this._DOMnode.parentNode;</span>
<a href="#l3.267"></a><span id="l3.267" class="difflineminus">-  }</span>
<a href="#l3.268"></a><span id="l3.268" class="difflineminus">-</span>
<a href="#l3.269"></a><span id="l3.269" class="difflineminus">-  getSubject() {</span>
<a href="#l3.270"></a><span id="l3.270" class="difflineminus">-    return this._subject;</span>
<a href="#l3.271"></a><span id="l3.271" class="difflineminus">-  }</span>
<a href="#l3.272"></a><span id="l3.272" class="difflineminus">-</span>
<a href="#l3.273"></a><span id="l3.273" class="difflineminus">-  getPredicate() {</span>
<a href="#l3.274"></a><span id="l3.274" class="difflineminus">-    return this._predicate;</span>
<a href="#l3.275"></a><span id="l3.275" class="difflineminus">-  }</span>
<a href="#l3.276"></a><span id="l3.276" class="difflineminus">-</span>
<a href="#l3.277"></a><span id="l3.277" class="difflineminus">-  getObject() {</span>
<a href="#l3.278"></a><span id="l3.278" class="difflineminus">-    return this._object;</span>
<a href="#l3.279"></a><span id="l3.279" class="difflineminus">-  }</span>
<a href="#l3.280"></a><span id="l3.280" class="difflineminus">-}</span>
<a href="#l3.281"></a><span id="l3.281" class="difflineminus">-</span>
<a href="#l3.282"></a><span id="l3.282" class="difflineminus">-class RDFNode {</span>
<a href="#l3.283"></a><span id="l3.283" class="difflineminus">-  equals(rdfnode) {</span>
<a href="#l3.284"></a><span id="l3.284" class="difflineminus">-    return (rdfnode.constructor === this.constructor &amp;&amp;</span>
<a href="#l3.285"></a><span id="l3.285" class="difflineminus">-            rdfnode._value == this._value);</span>
<a href="#l3.286"></a><span id="l3.286" class="difflineminus">-  }</span>
<a href="#l3.287"></a><span id="l3.287" class="difflineminus">-}</span>
<a href="#l3.288"></a><span id="l3.288" class="difflineminus">-</span>
<a href="#l3.289"></a><span id="l3.289" class="difflineminus">-/**</span>
<a href="#l3.290"></a><span id="l3.290" class="difflineminus">- * A simple literal value</span>
<a href="#l3.291"></a><span id="l3.291" class="difflineminus">- */</span>
<a href="#l3.292"></a><span id="l3.292" class="difflineminus">-class RDFLiteral extends RDFNode {</span>
<a href="#l3.293"></a><span id="l3.293" class="difflineminus">-  constructor(value) {</span>
<a href="#l3.294"></a><span id="l3.294" class="difflineminus">-    super();</span>
<a href="#l3.295"></a><span id="l3.295" class="difflineminus">-    this._value = value;</span>
<a href="#l3.296"></a><span id="l3.296" class="difflineminus">-  }</span>
<a href="#l3.297"></a><span id="l3.297" class="difflineminus">-</span>
<a href="#l3.298"></a><span id="l3.298" class="difflineminus">-  /**</span>
<a href="#l3.299"></a><span id="l3.299" class="difflineminus">-   * This stores the value of the literal in the given DOM node</span>
<a href="#l3.300"></a><span id="l3.300" class="difflineminus">-   */</span>
<a href="#l3.301"></a><span id="l3.301" class="difflineminus">-  _applyToDOMNode(ds, domnode) {</span>
<a href="#l3.302"></a><span id="l3.302" class="difflineminus">-    if (isElement(domnode))</span>
<a href="#l3.303"></a><span id="l3.303" class="difflineminus">-      domnode.textContent = this._value;</span>
<a href="#l3.304"></a><span id="l3.304" class="difflineminus">-    else if (isAttr(domnode))</span>
<a href="#l3.305"></a><span id="l3.305" class="difflineminus">-      domnode.value = this._value;</span>
<a href="#l3.306"></a><span id="l3.306" class="difflineminus">-    else</span>
<a href="#l3.307"></a><span id="l3.307" class="difflineminus">-      throw new Error(&quot;cannot use this node for a literal&quot;);</span>
<a href="#l3.308"></a><span id="l3.308" class="difflineminus">-  }</span>
<a href="#l3.309"></a><span id="l3.309" class="difflineminus">-</span>
<a href="#l3.310"></a><span id="l3.310" class="difflineminus">-  getValue() {</span>
<a href="#l3.311"></a><span id="l3.311" class="difflineminus">-    return this._value;</span>
<a href="#l3.312"></a><span id="l3.312" class="difflineminus">-  }</span>
<a href="#l3.313"></a><span id="l3.313" class="difflineminus">-}</span>
<a href="#l3.314"></a><span id="l3.314" class="difflineminus">-</span>
<a href="#l3.315"></a><span id="l3.315" class="difflineminus">-/**</span>
<a href="#l3.316"></a><span id="l3.316" class="difflineminus">- * A literal that is integer typed.</span>
<a href="#l3.317"></a><span id="l3.317" class="difflineminus">- */</span>
<a href="#l3.318"></a><span id="l3.318" class="difflineminus">-class RDFIntLiteral extends RDFLiteral {</span>
<a href="#l3.319"></a><span id="l3.319" class="difflineminus">-  constructor(value) {</span>
<a href="#l3.320"></a><span id="l3.320" class="difflineminus">-    super(parseInt(value));</span>
<a href="#l3.321"></a><span id="l3.321" class="difflineminus">-  }</span>
<a href="#l3.322"></a><span id="l3.322" class="difflineminus">-</span>
<a href="#l3.323"></a><span id="l3.323" class="difflineminus">-  /**</span>
<a href="#l3.324"></a><span id="l3.324" class="difflineminus">-   * This stores the value of the literal in the given DOM node</span>
<a href="#l3.325"></a><span id="l3.325" class="difflineminus">-   */</span>
<a href="#l3.326"></a><span id="l3.326" class="difflineminus">-  _applyToDOMNode(ds, domnode) {</span>
<a href="#l3.327"></a><span id="l3.327" class="difflineminus">-    if (!isElement(domnode))</span>
<a href="#l3.328"></a><span id="l3.328" class="difflineminus">-      throw new Error(&quot;cannot use this node for a literal&quot;);</span>
<a href="#l3.329"></a><span id="l3.329" class="difflineminus">-</span>
<a href="#l3.330"></a><span id="l3.330" class="difflineminus">-    RDFLiteral.prototype._applyToDOMNode.call(this, ds, domnode);</span>
<a href="#l3.331"></a><span id="l3.331" class="difflineminus">-    var prefix = ds._resolvePrefix(domnode, `${NS_NC}parseType`);</span>
<a href="#l3.332"></a><span id="l3.332" class="difflineminus">-    domnode.setAttributeNS(prefix.namespaceURI, prefix.qname, &quot;Integer&quot;);</span>
<a href="#l3.333"></a><span id="l3.333" class="difflineminus">-  }</span>
<a href="#l3.334"></a><span id="l3.334" class="difflineminus">-}</span>
<a href="#l3.335"></a><span id="l3.335" class="difflineminus">-</span>
<a href="#l3.336"></a><span id="l3.336" class="difflineminus">-/**</span>
<a href="#l3.337"></a><span id="l3.337" class="difflineminus">- * A literal that represents a date.</span>
<a href="#l3.338"></a><span id="l3.338" class="difflineminus">- */</span>
<a href="#l3.339"></a><span id="l3.339" class="difflineminus">-class RDFDateLiteral extends RDFLiteral {</span>
<a href="#l3.340"></a><span id="l3.340" class="difflineminus">-  constructor(value) {</span>
<a href="#l3.341"></a><span id="l3.341" class="difflineminus">-    if (!(value instanceof Date))</span>
<a href="#l3.342"></a><span id="l3.342" class="difflineminus">-      throw new Error(&quot;RDFDateLiteral must be constructed with a Date object&quot;);</span>
<a href="#l3.343"></a><span id="l3.343" class="difflineminus">-</span>
<a href="#l3.344"></a><span id="l3.344" class="difflineminus">-    super(value);</span>
<a href="#l3.345"></a><span id="l3.345" class="difflineminus">-  }</span>
<a href="#l3.346"></a><span id="l3.346" class="difflineminus">-</span>
<a href="#l3.347"></a><span id="l3.347" class="difflineminus">-  /**</span>
<a href="#l3.348"></a><span id="l3.348" class="difflineminus">-   * This stores the value of the literal in the given DOM node</span>
<a href="#l3.349"></a><span id="l3.349" class="difflineminus">-   */</span>
<a href="#l3.350"></a><span id="l3.350" class="difflineminus">-  _applyToDOMNode(ds, domnode) {</span>
<a href="#l3.351"></a><span id="l3.351" class="difflineminus">-    if (!isElement(domnode))</span>
<a href="#l3.352"></a><span id="l3.352" class="difflineminus">-      throw new Error(&quot;cannot use this node for a literal&quot;);</span>
<a href="#l3.353"></a><span id="l3.353" class="difflineminus">-</span>
<a href="#l3.354"></a><span id="l3.354" class="difflineminus">-    domnode.textContent = this._value.getTime();</span>
<a href="#l3.355"></a><span id="l3.355" class="difflineminus">-    var prefix = ds._resolvePrefix(domnode, `${NS_NC}parseType`);</span>
<a href="#l3.356"></a><span id="l3.356" class="difflineminus">-    domnode.setAttributeNS(prefix.namespaceURI, prefix.qname, &quot;Date&quot;);</span>
<a href="#l3.357"></a><span id="l3.357" class="difflineminus">-  }</span>
<a href="#l3.358"></a><span id="l3.358" class="difflineminus">-}</span>
<a href="#l3.359"></a><span id="l3.359" class="difflineminus">-</span>
<a href="#l3.360"></a><span id="l3.360" class="difflineminus">-/**</span>
<a href="#l3.361"></a><span id="l3.361" class="difflineminus">- * This is an RDF node that can be a subject so a resource or a blank node</span>
<a href="#l3.362"></a><span id="l3.362" class="difflineminus">- */</span>
<a href="#l3.363"></a><span id="l3.363" class="difflineminus">-class RDFSubject extends RDFNode {</span>
<a href="#l3.364"></a><span id="l3.364" class="difflineminus">-  constructor(ds) {</span>
<a href="#l3.365"></a><span id="l3.365" class="difflineminus">-    super();</span>
<a href="#l3.366"></a><span id="l3.366" class="difflineminus">-    // A lookup of the assertions with this as the subject. Keyed on predicate</span>
<a href="#l3.367"></a><span id="l3.367" class="difflineminus">-    this._assertions = {};</span>
<a href="#l3.368"></a><span id="l3.368" class="difflineminus">-    // A lookup of the assertions with this as the object. Keyed on predicate</span>
<a href="#l3.369"></a><span id="l3.369" class="difflineminus">-    this._backwards = {};</span>
<a href="#l3.370"></a><span id="l3.370" class="difflineminus">-    // The datasource this subject belongs to</span>
<a href="#l3.371"></a><span id="l3.371" class="difflineminus">-    this._ds = ds;</span>
<a href="#l3.372"></a><span id="l3.372" class="difflineminus">-    // The DOM elements in the document that represent this subject. Array of Element</span>
<a href="#l3.373"></a><span id="l3.373" class="difflineminus">-    this._elements = [];</span>
<a href="#l3.374"></a><span id="l3.374" class="difflineminus">-  }</span>
<a href="#l3.375"></a><span id="l3.375" class="difflineminus">-</span>
<a href="#l3.376"></a><span id="l3.376" class="difflineminus">-  /**</span>
<a href="#l3.377"></a><span id="l3.377" class="difflineminus">-   * Creates a new Element in the document for holding assertions about this</span>
<a href="#l3.378"></a><span id="l3.378" class="difflineminus">-   * subject. The URI controls what tagname to use.</span>
<a href="#l3.379"></a><span id="l3.379" class="difflineminus">-   */</span>
<a href="#l3.380"></a><span id="l3.380" class="difflineminus">-  _createElement(uri) {</span>
<a href="#l3.381"></a><span id="l3.381" class="difflineminus">-    // Seek an appropriate reference to this node to add this node under</span>
<a href="#l3.382"></a><span id="l3.382" class="difflineminus">-    var parent = null;</span>
<a href="#l3.383"></a><span id="l3.383" class="difflineminus">-    for (var p in this._backwards) {</span>
<a href="#l3.384"></a><span id="l3.384" class="difflineminus">-      for (let back of this._backwards[p]) {</span>
<a href="#l3.385"></a><span id="l3.385" class="difflineminus">-        // Don't add under an rdf:type</span>
<a href="#l3.386"></a><span id="l3.386" class="difflineminus">-        if (back.getPredicate() == RDF_R(&quot;type&quot;))</span>
<a href="#l3.387"></a><span id="l3.387" class="difflineminus">-          continue;</span>
<a href="#l3.388"></a><span id="l3.388" class="difflineminus">-        // The assertion already has a child node, probably one of ours</span>
<a href="#l3.389"></a><span id="l3.389" class="difflineminus">-        if (back._DOMnode.firstChild)</span>
<a href="#l3.390"></a><span id="l3.390" class="difflineminus">-          continue;</span>
<a href="#l3.391"></a><span id="l3.391" class="difflineminus">-        parent = back._DOMnode;</span>
<a href="#l3.392"></a><span id="l3.392" class="difflineminus">-        var element = this._ds._addElement(parent, uri);</span>
<a href="#l3.393"></a><span id="l3.393" class="difflineminus">-        this._removeReferenceFromElement(parent);</span>
<a href="#l3.394"></a><span id="l3.394" class="difflineminus">-        break;</span>
<a href="#l3.395"></a><span id="l3.395" class="difflineminus">-      }</span>
<a href="#l3.396"></a><span id="l3.396" class="difflineminus">-      if (parent)</span>
<a href="#l3.397"></a><span id="l3.397" class="difflineminus">-        break;</span>
<a href="#l3.398"></a><span id="l3.398" class="difflineminus">-    }</span>
<a href="#l3.399"></a><span id="l3.399" class="difflineminus">-</span>
<a href="#l3.400"></a><span id="l3.400" class="difflineminus">-    // No back assertions that are sensible to use</span>
<a href="#l3.401"></a><span id="l3.401" class="difflineminus">-    if (!parent)</span>
<a href="#l3.402"></a><span id="l3.402" class="difflineminus">-      element = this._ds._addElement(this._ds._document.documentElement, uri);</span>
<a href="#l3.403"></a><span id="l3.403" class="difflineminus">-</span>
<a href="#l3.404"></a><span id="l3.404" class="difflineminus">-    element.listCounter = 1;</span>
<a href="#l3.405"></a><span id="l3.405" class="difflineminus">-    this._applyToElement(element);</span>
<a href="#l3.406"></a><span id="l3.406" class="difflineminus">-    this._elements.push(element);</span>
<a href="#l3.407"></a><span id="l3.407" class="difflineminus">-    return element;</span>
<a href="#l3.408"></a><span id="l3.408" class="difflineminus">-  }</span>
<a href="#l3.409"></a><span id="l3.409" class="difflineminus">-</span>
<a href="#l3.410"></a><span id="l3.410" class="difflineminus">-  /**</span>
<a href="#l3.411"></a><span id="l3.411" class="difflineminus">-   * When a DOM node representing this subject is removed from the document</span>
<a href="#l3.412"></a><span id="l3.412" class="difflineminus">-   * we must remove the node and recreate any child assertions elsewhere.</span>
<a href="#l3.413"></a><span id="l3.413" class="difflineminus">-   */</span>
<a href="#l3.414"></a><span id="l3.414" class="difflineminus">-  _removeElement(element) {</span>
<a href="#l3.415"></a><span id="l3.415" class="difflineminus">-    var pos = this._elements.indexOf(element);</span>
<a href="#l3.416"></a><span id="l3.416" class="difflineminus">-    if (pos &lt; 0)</span>
<a href="#l3.417"></a><span id="l3.417" class="difflineminus">-      throw new Error(&quot;invalid element&quot;);</span>
<a href="#l3.418"></a><span id="l3.418" class="difflineminus">-    this._elements.splice(pos, 1);</span>
<a href="#l3.419"></a><span id="l3.419" class="difflineminus">-    if (element.parentNode != element.ownerDocument.documentElement)</span>
<a href="#l3.420"></a><span id="l3.420" class="difflineminus">-      this._addReferenceToElement(element.parentNode);</span>
<a href="#l3.421"></a><span id="l3.421" class="difflineminus">-    this._ds._removeElement(element);</span>
<a href="#l3.422"></a><span id="l3.422" class="difflineminus">-</span>
<a href="#l3.423"></a><span id="l3.423" class="difflineminus">-    // Find all the assertions that are represented here and create new</span>
<a href="#l3.424"></a><span id="l3.424" class="difflineminus">-    // nodes for them.</span>
<a href="#l3.425"></a><span id="l3.425" class="difflineminus">-    for (var predicate in this._assertions) {</span>
<a href="#l3.426"></a><span id="l3.426" class="difflineminus">-      for (let assertion of this._assertions[predicate]) {</span>
<a href="#l3.427"></a><span id="l3.427" class="difflineminus">-        if (assertion._getSubjectElement() == element)</span>
<a href="#l3.428"></a><span id="l3.428" class="difflineminus">-          this._createDOMNodeForAssertion(assertion);</span>
<a href="#l3.429"></a><span id="l3.429" class="difflineminus">-      }</span>
<a href="#l3.430"></a><span id="l3.430" class="difflineminus">-    }</span>
<a href="#l3.431"></a><span id="l3.431" class="difflineminus">-  }</span>
<a href="#l3.432"></a><span id="l3.432" class="difflineminus">-</span>
<a href="#l3.433"></a><span id="l3.433" class="difflineminus">-  /**</span>
<a href="#l3.434"></a><span id="l3.434" class="difflineminus">-   * Creates a DOM node to represent the assertion in the document. If the</span>
<a href="#l3.435"></a><span id="l3.435" class="difflineminus">-   * assertion has rdf:type as the predicate then an attempt will be made to</span>
<a href="#l3.436"></a><span id="l3.436" class="difflineminus">-   * create a typed subject Element, otherwise a new property Element is</span>
<a href="#l3.437"></a><span id="l3.437" class="difflineminus">-   * created. For list items an attempt is made to find an appropriate container</span>
<a href="#l3.438"></a><span id="l3.438" class="difflineminus">-   * that an rdf:li element can be added to.</span>
<a href="#l3.439"></a><span id="l3.439" class="difflineminus">-   */</span>
<a href="#l3.440"></a><span id="l3.440" class="difflineminus">-  _createDOMNodeForAssertion(assertion) {</span>
<a href="#l3.441"></a><span id="l3.441" class="difflineminus">-    let elements;</span>
<a href="#l3.442"></a><span id="l3.442" class="difflineminus">-    if (RDF_LISTITEM.test(assertion.getPredicate())) {</span>
<a href="#l3.443"></a><span id="l3.443" class="difflineminus">-      // Find all the containers</span>
<a href="#l3.444"></a><span id="l3.444" class="difflineminus">-      elements = this._elements.filter(function(element) {</span>
<a href="#l3.445"></a><span id="l3.445" class="difflineminus">-        return (element.namespaceURI == NS_RDF &amp;&amp; (element.localName == &quot;Seq&quot; ||</span>
<a href="#l3.446"></a><span id="l3.446" class="difflineminus">-                                                   element.localName == &quot;Bag&quot; ||</span>
<a href="#l3.447"></a><span id="l3.447" class="difflineminus">-                                                   element.localName == &quot;Alt&quot;));</span>
<a href="#l3.448"></a><span id="l3.448" class="difflineminus">-      });</span>
<a href="#l3.449"></a><span id="l3.449" class="difflineminus">-      if (elements.length &gt; 0) {</span>
<a href="#l3.450"></a><span id="l3.450" class="difflineminus">-        // Look for one whose listCounter matches the item we want to add</span>
<a href="#l3.451"></a><span id="l3.451" class="difflineminus">-        var item = parseInt(assertion.getPredicate().substring(NS_RDF.length + 1));</span>
<a href="#l3.452"></a><span id="l3.452" class="difflineminus">-        for (let element of elements) {</span>
<a href="#l3.453"></a><span id="l3.453" class="difflineminus">-          if (element.listCounter == item) {</span>
<a href="#l3.454"></a><span id="l3.454" class="difflineminus">-            assertion._DOMnode = this._ds._addElement(element, RDF_R(&quot;li&quot;));</span>
<a href="#l3.455"></a><span id="l3.455" class="difflineminus">-            assertion._applyToDOMNode();</span>
<a href="#l3.456"></a><span id="l3.456" class="difflineminus">-            element.listCounter++;</span>
<a href="#l3.457"></a><span id="l3.457" class="difflineminus">-            return;</span>
<a href="#l3.458"></a><span id="l3.458" class="difflineminus">-          }</span>
<a href="#l3.459"></a><span id="l3.459" class="difflineminus">-        }</span>
<a href="#l3.460"></a><span id="l3.460" class="difflineminus">-        // No good container to add to, shove in the first real container</span>
<a href="#l3.461"></a><span id="l3.461" class="difflineminus">-        assertion._DOMnode = this._ds._addElement(elements[0], assertion.getPredicate());</span>
<a href="#l3.462"></a><span id="l3.462" class="difflineminus">-        assertion._applyToDOMNode();</span>
<a href="#l3.463"></a><span id="l3.463" class="difflineminus">-        return;</span>
<a href="#l3.464"></a><span id="l3.464" class="difflineminus">-      }</span>
<a href="#l3.465"></a><span id="l3.465" class="difflineminus">-      // TODO No containers, this will end up in a non-container for now</span>
<a href="#l3.466"></a><span id="l3.466" class="difflineminus">-    } else if (assertion.getPredicate() == RDF_R(&quot;type&quot;)) {</span>
<a href="#l3.467"></a><span id="l3.467" class="difflineminus">-      // Try renaming an existing rdf:Description</span>
<a href="#l3.468"></a><span id="l3.468" class="difflineminus">-      for (let element of this.elements) {</span>
<a href="#l3.469"></a><span id="l3.469" class="difflineminus">-        if (element.namespaceURI == NS_RDF &amp;&amp;</span>
<a href="#l3.470"></a><span id="l3.470" class="difflineminus">-            element.localName == &quot;Description&quot;) {</span>
<a href="#l3.471"></a><span id="l3.471" class="difflineminus">-          try {</span>
<a href="#l3.472"></a><span id="l3.472" class="difflineminus">-            var prefix = this._ds._resolvePrefix(element.parentNode, assertion.getObject().getURI());</span>
<a href="#l3.473"></a><span id="l3.473" class="difflineminus">-            element = renameNode(element, prefix.namespaceURI, prefix.qname);</span>
<a href="#l3.474"></a><span id="l3.474" class="difflineminus">-            assertion._DOMnode = element;</span>
<a href="#l3.475"></a><span id="l3.475" class="difflineminus">-            assertion._isSubjectElement = true;</span>
<a href="#l3.476"></a><span id="l3.476" class="difflineminus">-            return;</span>
<a href="#l3.477"></a><span id="l3.477" class="difflineminus">-          } catch (e) {</span>
<a href="#l3.478"></a><span id="l3.478" class="difflineminus">-            // If the type cannot be sensibly turned into a prefix then just set</span>
<a href="#l3.479"></a><span id="l3.479" class="difflineminus">-            // as a regular property</span>
<a href="#l3.480"></a><span id="l3.480" class="difflineminus">-          }</span>
<a href="#l3.481"></a><span id="l3.481" class="difflineminus">-        }</span>
<a href="#l3.482"></a><span id="l3.482" class="difflineminus">-      }</span>
<a href="#l3.483"></a><span id="l3.483" class="difflineminus">-    }</span>
<a href="#l3.484"></a><span id="l3.484" class="difflineminus">-</span>
<a href="#l3.485"></a><span id="l3.485" class="difflineminus">-    // Filter out all the containers</span>
<a href="#l3.486"></a><span id="l3.486" class="difflineminus">-    elements = this._elements.filter(function(element) {</span>
<a href="#l3.487"></a><span id="l3.487" class="difflineminus">-      return (element.namespaceURI != NS_RDF || (element.localName != &quot;Seq&quot; &amp;&amp;</span>
<a href="#l3.488"></a><span id="l3.488" class="difflineminus">-                                                 element.localName != &quot;Bag&quot; &amp;&amp;</span>
<a href="#l3.489"></a><span id="l3.489" class="difflineminus">-                                                 element.localName != &quot;Alt&quot;));</span>
<a href="#l3.490"></a><span id="l3.490" class="difflineminus">-    });</span>
<a href="#l3.491"></a><span id="l3.491" class="difflineminus">-    if (elements.length == 0) {</span>
<a href="#l3.492"></a><span id="l3.492" class="difflineminus">-      // Create a new node of the right type</span>
<a href="#l3.493"></a><span id="l3.493" class="difflineminus">-      if (assertion.getPredicate() == RDF_R(&quot;type&quot;)) {</span>
<a href="#l3.494"></a><span id="l3.494" class="difflineminus">-        try {</span>
<a href="#l3.495"></a><span id="l3.495" class="difflineminus">-          assertion._DOMnode = this._createElement(assertion.getObject().getURI());</span>
<a href="#l3.496"></a><span id="l3.496" class="difflineminus">-          assertion._isSubjectElement = true;</span>
<a href="#l3.497"></a><span id="l3.497" class="difflineminus">-          return;</span>
<a href="#l3.498"></a><span id="l3.498" class="difflineminus">-        } catch (e) {</span>
<a href="#l3.499"></a><span id="l3.499" class="difflineminus">-          // If the type cannot be sensibly turned into a prefix then just set</span>
<a href="#l3.500"></a><span id="l3.500" class="difflineminus">-          // as a regular property</span>
<a href="#l3.501"></a><span id="l3.501" class="difflineminus">-        }</span>
<a href="#l3.502"></a><span id="l3.502" class="difflineminus">-      }</span>
<a href="#l3.503"></a><span id="l3.503" class="difflineminus">-      elements[0] = this._createElement(RDF_R(&quot;Description&quot;));</span>
<a href="#l3.504"></a><span id="l3.504" class="difflineminus">-    }</span>
<a href="#l3.505"></a><span id="l3.505" class="difflineminus">-    assertion._DOMnode = this._ds._addElement(elements[0], assertion.getPredicate());</span>
<a href="#l3.506"></a><span id="l3.506" class="difflineminus">-    assertion._applyToDOMNode();</span>
<a href="#l3.507"></a><span id="l3.507" class="difflineminus">-  }</span>
<a href="#l3.508"></a><span id="l3.508" class="difflineminus">-</span>
<a href="#l3.509"></a><span id="l3.509" class="difflineminus">-  /**</span>
<a href="#l3.510"></a><span id="l3.510" class="difflineminus">-   * Removes the DOM node representing the assertion.</span>
<a href="#l3.511"></a><span id="l3.511" class="difflineminus">-   */</span>
<a href="#l3.512"></a><span id="l3.512" class="difflineminus">-  _removeDOMNodeForAssertion(assertion) {</span>
<a href="#l3.513"></a><span id="l3.513" class="difflineminus">-    if (isAttr(assertion._DOMnode)) {</span>
<a href="#l3.514"></a><span id="l3.514" class="difflineminus">-      var parent = assertion._DOMnode.ownerElement;</span>
<a href="#l3.515"></a><span id="l3.515" class="difflineminus">-      parent.removeAttributeNode(assertion._DOMnode);</span>
<a href="#l3.516"></a><span id="l3.516" class="difflineminus">-    } else if (assertion._isSubjectElement) {</span>
<a href="#l3.517"></a><span id="l3.517" class="difflineminus">-      var domnode = renameNode(assertion._DOMnode, NS_RDF, &quot;Description&quot;);</span>
<a href="#l3.518"></a><span id="l3.518" class="difflineminus">-      if (domnode != assertion._DOMnode) {</span>
<a href="#l3.519"></a><span id="l3.519" class="difflineminus">-        var pos = this._elements.indexOf(assertion._DOMnode);</span>
<a href="#l3.520"></a><span id="l3.520" class="difflineminus">-        this._elements.splice(pos, 1, domnode);</span>
<a href="#l3.521"></a><span id="l3.521" class="difflineminus">-      }</span>
<a href="#l3.522"></a><span id="l3.522" class="difflineminus">-      parent = domnode;</span>
<a href="#l3.523"></a><span id="l3.523" class="difflineminus">-    } else {</span>
<a href="#l3.524"></a><span id="l3.524" class="difflineminus">-      var object = assertion.getObject();</span>
<a href="#l3.525"></a><span id="l3.525" class="difflineminus">-      if (object instanceof RDFSubject &amp;&amp; assertion._DOMnode.firstChild) {</span>
<a href="#l3.526"></a><span id="l3.526" class="difflineminus">-        // Object is a subject that has an Element inside this assertion's node.</span>
<a href="#l3.527"></a><span id="l3.527" class="difflineminus">-        for (let element of object._elements) {</span>
<a href="#l3.528"></a><span id="l3.528" class="difflineminus">-          if (element.parentNode == assertion._DOMnode) {</span>
<a href="#l3.529"></a><span id="l3.529" class="difflineminus">-            object._removeElement(element);</span>
<a href="#l3.530"></a><span id="l3.530" class="difflineminus">-            break;</span>
<a href="#l3.531"></a><span id="l3.531" class="difflineminus">-          }</span>
<a href="#l3.532"></a><span id="l3.532" class="difflineminus">-        }</span>
<a href="#l3.533"></a><span id="l3.533" class="difflineminus">-      }</span>
<a href="#l3.534"></a><span id="l3.534" class="difflineminus">-      parent = assertion._DOMnode.parentNode;</span>
<a href="#l3.535"></a><span id="l3.535" class="difflineminus">-      if (assertion._DOMnode.namespaceURI == NS_RDF &amp;&amp;</span>
<a href="#l3.536"></a><span id="l3.536" class="difflineminus">-          assertion._DOMnode.localName == &quot;li&quot;)</span>
<a href="#l3.537"></a><span id="l3.537" class="difflineminus">-      parent.listCounter--;</span>
<a href="#l3.538"></a><span id="l3.538" class="difflineminus">-      this._ds._removeElement(assertion._DOMnode);</span>
<a href="#l3.539"></a><span id="l3.539" class="difflineminus">-    }</span>
<a href="#l3.540"></a><span id="l3.540" class="difflineminus">-</span>
<a href="#l3.541"></a><span id="l3.541" class="difflineminus">-    // If there are no assertions left using the assertion's containing dom node</span>
<a href="#l3.542"></a><span id="l3.542" class="difflineminus">-    // then remove it from the document.</span>
<a href="#l3.543"></a><span id="l3.543" class="difflineminus">-    // TODO could do with a quick lookup list for assertions attached to a node</span>
<a href="#l3.544"></a><span id="l3.544" class="difflineminus">-    for (var p in this._assertions) {</span>
<a href="#l3.545"></a><span id="l3.545" class="difflineminus">-      for (let assertion of this._assertions[p]) {</span>
<a href="#l3.546"></a><span id="l3.546" class="difflineminus">-        if (assertion._getSubjectElement() == parent)</span>
<a href="#l3.547"></a><span id="l3.547" class="difflineminus">-          return;</span>
<a href="#l3.548"></a><span id="l3.548" class="difflineminus">-      }</span>
<a href="#l3.549"></a><span id="l3.549" class="difflineminus">-    }</span>
<a href="#l3.550"></a><span id="l3.550" class="difflineminus">-    // No assertions left in this element.</span>
<a href="#l3.551"></a><span id="l3.551" class="difflineminus">-    this._removeElement(parent);</span>
<a href="#l3.552"></a><span id="l3.552" class="difflineminus">-  }</span>
<a href="#l3.553"></a><span id="l3.553" class="difflineminus">-</span>
<a href="#l3.554"></a><span id="l3.554" class="difflineminus">-  /**</span>
<a href="#l3.555"></a><span id="l3.555" class="difflineminus">-   * Parses the given Element from the DOM document</span>
<a href="#l3.556"></a><span id="l3.556" class="difflineminus">-   */</span>
<a href="#l3.557"></a><span id="l3.557" class="difflineminus">-  /* eslint-disable complexity */</span>
<a href="#l3.558"></a><span id="l3.558" class="difflineminus">-  _parseElement(element) {</span>
<a href="#l3.559"></a><span id="l3.559" class="difflineminus">-    this._elements.push(element);</span>
<a href="#l3.560"></a><span id="l3.560" class="difflineminus">-</span>
<a href="#l3.561"></a><span id="l3.561" class="difflineminus">-    // There might be an inferred rdf:type assertion in the element name</span>
<a href="#l3.562"></a><span id="l3.562" class="difflineminus">-    if (element.namespaceURI != NS_RDF ||</span>
<a href="#l3.563"></a><span id="l3.563" class="difflineminus">-        element.localName != &quot;Description&quot;) {</span>
<a href="#l3.564"></a><span id="l3.564" class="difflineminus">-      if (element.namespaceURI == NS_RDF &amp;&amp; element.localName == &quot;li&quot;)</span>
<a href="#l3.565"></a><span id="l3.565" class="difflineminus">-        throw new Error(&quot;rdf:li is not a valid type for a subject node&quot;);</span>
<a href="#l3.566"></a><span id="l3.566" class="difflineminus">-      var assertion = new RDFAssertion(this, RDF_R(&quot;type&quot;),</span>
<a href="#l3.567"></a><span id="l3.567" class="difflineminus">-                                       this._ds.getResource(element.namespaceURI + element.localName));</span>
<a href="#l3.568"></a><span id="l3.568" class="difflineminus">-      assertion._DOMnode = element;</span>
<a href="#l3.569"></a><span id="l3.569" class="difflineminus">-      assertion._isSubjectElement = true;</span>
<a href="#l3.570"></a><span id="l3.570" class="difflineminus">-      this._addAssertion(assertion);</span>
<a href="#l3.571"></a><span id="l3.571" class="difflineminus">-    }</span>
<a href="#l3.572"></a><span id="l3.572" class="difflineminus">-</span>
<a href="#l3.573"></a><span id="l3.573" class="difflineminus">-    // Certain attributes can be literal properties</span>
<a href="#l3.574"></a><span id="l3.574" class="difflineminus">-    for (let attr of element.attributes) {</span>
<a href="#l3.575"></a><span id="l3.575" class="difflineminus">-      if (attr.namespaceURI == NS_XML || attr.namespaceURI == NS_XMLNS ||</span>
<a href="#l3.576"></a><span id="l3.576" class="difflineminus">-          attr.nodeName == &quot;xmlns&quot;)</span>
<a href="#l3.577"></a><span id="l3.577" class="difflineminus">-        continue;</span>
<a href="#l3.578"></a><span id="l3.578" class="difflineminus">-      if ((attr.namespaceURI == NS_RDF || !attr.namespaceURI) &amp;&amp;</span>
<a href="#l3.579"></a><span id="l3.579" class="difflineminus">-          ([&quot;nodeID&quot;, &quot;about&quot;, &quot;resource&quot;, &quot;ID&quot;, &quot;parseType&quot;].includes(attr.localName)))</span>
<a href="#l3.580"></a><span id="l3.580" class="difflineminus">-        continue;</span>
<a href="#l3.581"></a><span id="l3.581" class="difflineminus">-      var object = null;</span>
<a href="#l3.582"></a><span id="l3.582" class="difflineminus">-      if (attr.namespaceURI == NS_RDF) {</span>
<a href="#l3.583"></a><span id="l3.583" class="difflineminus">-        if (attr.localName == &quot;type&quot;)</span>
<a href="#l3.584"></a><span id="l3.584" class="difflineminus">-          object = this._ds.getResource(attr.nodeValue);</span>
<a href="#l3.585"></a><span id="l3.585" class="difflineminus">-        else if (attr.localName == &quot;li&quot;)</span>
<a href="#l3.586"></a><span id="l3.586" class="difflineminus">-          throw new Error(&quot;rdf:li is not allowed as a property attribute&quot;);</span>
<a href="#l3.587"></a><span id="l3.587" class="difflineminus">-        else if (attr.localName == &quot;aboutEach&quot;)</span>
<a href="#l3.588"></a><span id="l3.588" class="difflineminus">-          throw new Error(&quot;rdf:aboutEach is deprecated&quot;);</span>
<a href="#l3.589"></a><span id="l3.589" class="difflineminus">-        else if (attr.localName == &quot;aboutEachPrefix&quot;)</span>
<a href="#l3.590"></a><span id="l3.590" class="difflineminus">-          throw new Error(&quot;rdf:aboutEachPrefix is deprecated&quot;);</span>
<a href="#l3.591"></a><span id="l3.591" class="difflineminus">-        else if (attr.localName == &quot;aboutEach&quot;)</span>
<a href="#l3.592"></a><span id="l3.592" class="difflineminus">-          throw new Error(&quot;rdf:aboutEach is deprecated&quot;);</span>
<a href="#l3.593"></a><span id="l3.593" class="difflineminus">-        else if (attr.localName == &quot;bagID&quot;)</span>
<a href="#l3.594"></a><span id="l3.594" class="difflineminus">-          throw new Error(&quot;rdf:bagID is deprecated&quot;);</span>
<a href="#l3.595"></a><span id="l3.595" class="difflineminus">-      }</span>
<a href="#l3.596"></a><span id="l3.596" class="difflineminus">-      if (!object)</span>
<a href="#l3.597"></a><span id="l3.597" class="difflineminus">-        object = new RDFLiteral(attr.nodeValue);</span>
<a href="#l3.598"></a><span id="l3.598" class="difflineminus">-      assertion = new RDFAssertion(this, attr.namespaceURI + attr.localName, object);</span>
<a href="#l3.599"></a><span id="l3.599" class="difflineminus">-      assertion._DOMnode = attr;</span>
<a href="#l3.600"></a><span id="l3.600" class="difflineminus">-      this._addAssertion(assertion);</span>
<a href="#l3.601"></a><span id="l3.601" class="difflineminus">-    }</span>
<a href="#l3.602"></a><span id="l3.602" class="difflineminus">-</span>
<a href="#l3.603"></a><span id="l3.603" class="difflineminus">-    var child = element.firstChild;</span>
<a href="#l3.604"></a><span id="l3.604" class="difflineminus">-    element.listCounter = 1;</span>
<a href="#l3.605"></a><span id="l3.605" class="difflineminus">-    while (child) {</span>
<a href="#l3.606"></a><span id="l3.606" class="difflineminus">-      if (isText(child) &amp;&amp; /\S/.test(child.nodeValue)) {</span>
<a href="#l3.607"></a><span id="l3.607" class="difflineminus">-        ERROR(`Text ${child.nodeValue} is not allowed in a subject node`);</span>
<a href="#l3.608"></a><span id="l3.608" class="difflineminus">-        throw new Error(&quot;subject nodes cannot contain text content&quot;);</span>
<a href="#l3.609"></a><span id="l3.609" class="difflineminus">-      } else if (isElement(child)) {</span>
<a href="#l3.610"></a><span id="l3.610" class="difflineminus">-        object = null;</span>
<a href="#l3.611"></a><span id="l3.611" class="difflineminus">-        var predicate = child.namespaceURI + child.localName;</span>
<a href="#l3.612"></a><span id="l3.612" class="difflineminus">-        if (child.namespaceURI == NS_RDF) {</span>
<a href="#l3.613"></a><span id="l3.613" class="difflineminus">-          if (RDF_PROPERTY_INVALID_TYPES.includes(child.localName) &amp;&amp;</span>
<a href="#l3.614"></a><span id="l3.614" class="difflineminus">-              !child.localName.match(/^_\d+$/))</span>
<a href="#l3.615"></a><span id="l3.615" class="difflineminus">-            throw new Error(`${child.nodeName} is an invalid property`);</span>
<a href="#l3.616"></a><span id="l3.616" class="difflineminus">-          if (child.localName == &quot;li&quot;) {</span>
<a href="#l3.617"></a><span id="l3.617" class="difflineminus">-            predicate = RDF_R(`_${element.listCounter}`);</span>
<a href="#l3.618"></a><span id="l3.618" class="difflineminus">-            element.listCounter++;</span>
<a href="#l3.619"></a><span id="l3.619" class="difflineminus">-          }</span>
<a href="#l3.620"></a><span id="l3.620" class="difflineminus">-        }</span>
<a href="#l3.621"></a><span id="l3.621" class="difflineminus">-</span>
<a href="#l3.622"></a><span id="l3.622" class="difflineminus">-        // Check for and bail out on unknown attributes on the property element</span>
<a href="#l3.623"></a><span id="l3.623" class="difflineminus">-        for (let attr of child.attributes) {</span>
<a href="#l3.624"></a><span id="l3.624" class="difflineminus">-          // Ignore XML namespaced attributes</span>
<a href="#l3.625"></a><span id="l3.625" class="difflineminus">-          if (attr.namespaceURI == NS_XML)</span>
<a href="#l3.626"></a><span id="l3.626" class="difflineminus">-            continue;</span>
<a href="#l3.627"></a><span id="l3.627" class="difflineminus">-          // These are reserved by XML for future use</span>
<a href="#l3.628"></a><span id="l3.628" class="difflineminus">-          if (attr.localName.substring(0, 3).toLowerCase() == &quot;xml&quot;)</span>
<a href="#l3.629"></a><span id="l3.629" class="difflineminus">-            continue;</span>
<a href="#l3.630"></a><span id="l3.630" class="difflineminus">-          // We can handle these RDF attributes</span>
<a href="#l3.631"></a><span id="l3.631" class="difflineminus">-          if ((!attr.namespaceURI || attr.namespaceURI == NS_RDF) &amp;&amp;</span>
<a href="#l3.632"></a><span id="l3.632" class="difflineminus">-              [&quot;resource&quot;, &quot;nodeID&quot;].includes(attr.localName))</span>
<a href="#l3.633"></a><span id="l3.633" class="difflineminus">-            continue;</span>
<a href="#l3.634"></a><span id="l3.634" class="difflineminus">-          // This is a special attribute we handle for compatibility with Mozilla RDF</span>
<a href="#l3.635"></a><span id="l3.635" class="difflineminus">-          if (attr.namespaceURI == NS_NC &amp;&amp;</span>
<a href="#l3.636"></a><span id="l3.636" class="difflineminus">-              attr.localName == &quot;parseType&quot;)</span>
<a href="#l3.637"></a><span id="l3.637" class="difflineminus">-            continue;</span>
<a href="#l3.638"></a><span id="l3.638" class="difflineminus">-          throw new Error(`Attribute ${attr.nodeName} is not supported`);</span>
<a href="#l3.639"></a><span id="l3.639" class="difflineminus">-        }</span>
<a href="#l3.640"></a><span id="l3.640" class="difflineminus">-</span>
<a href="#l3.641"></a><span id="l3.641" class="difflineminus">-        var parseType = child.getAttributeNS(NS_NC, &quot;parseType&quot;);</span>
<a href="#l3.642"></a><span id="l3.642" class="difflineminus">-        if (parseType &amp;&amp; parseType != &quot;Date&quot; &amp;&amp; parseType != &quot;Integer&quot;) {</span>
<a href="#l3.643"></a><span id="l3.643" class="difflineminus">-          ERROR(`parseType ${parseType} is not supported`);</span>
<a href="#l3.644"></a><span id="l3.644" class="difflineminus">-          throw new Error(&quot;unsupported parseType&quot;);</span>
<a href="#l3.645"></a><span id="l3.645" class="difflineminus">-        }</span>
<a href="#l3.646"></a><span id="l3.646" class="difflineminus">-</span>
<a href="#l3.647"></a><span id="l3.647" class="difflineminus">-        var resource = getRDFAttribute(child, &quot;resource&quot;);</span>
<a href="#l3.648"></a><span id="l3.648" class="difflineminus">-        var nodeID = getRDFAttribute(child, &quot;nodeID&quot;);</span>
<a href="#l3.649"></a><span id="l3.649" class="difflineminus">-        if ((resource &amp;&amp; (nodeID || parseType)) ||</span>
<a href="#l3.650"></a><span id="l3.650" class="difflineminus">-            (nodeID &amp;&amp; (resource || parseType))) {</span>
<a href="#l3.651"></a><span id="l3.651" class="difflineminus">-          ERROR(&quot;Cannot use more than one of parseType, resource and nodeID on a single node&quot;);</span>
<a href="#l3.652"></a><span id="l3.652" class="difflineminus">-          throw new Error(&quot;Invalid rdf assertion&quot;);</span>
<a href="#l3.653"></a><span id="l3.653" class="difflineminus">-        }</span>
<a href="#l3.654"></a><span id="l3.654" class="difflineminus">-</span>
<a href="#l3.655"></a><span id="l3.655" class="difflineminus">-        if (resource !== undefined) {</span>
<a href="#l3.656"></a><span id="l3.656" class="difflineminus">-          var base = Services.io.newURI(element.baseURI);</span>
<a href="#l3.657"></a><span id="l3.657" class="difflineminus">-          object = this._ds.getResource(base.resolve(resource));</span>
<a href="#l3.658"></a><span id="l3.658" class="difflineminus">-        } else if (nodeID !== undefined) {</span>
<a href="#l3.659"></a><span id="l3.659" class="difflineminus">-          if (!nodeID.match(XML_NCNAME))</span>
<a href="#l3.660"></a><span id="l3.660" class="difflineminus">-            throw new Error(&quot;rdf:nodeID must be a valid XML name&quot;);</span>
<a href="#l3.661"></a><span id="l3.661" class="difflineminus">-          object = this._ds.getBlankNode(nodeID);</span>
<a href="#l3.662"></a><span id="l3.662" class="difflineminus">-        } else {</span>
<a href="#l3.663"></a><span id="l3.663" class="difflineminus">-          var hasText = false;</span>
<a href="#l3.664"></a><span id="l3.664" class="difflineminus">-          var childElement = null;</span>
<a href="#l3.665"></a><span id="l3.665" class="difflineminus">-          var subchild = child.firstChild;</span>
<a href="#l3.666"></a><span id="l3.666" class="difflineminus">-          while (subchild) {</span>
<a href="#l3.667"></a><span id="l3.667" class="difflineminus">-            if (isText(subchild) &amp;&amp; /\S/.test(subchild.nodeValue)) {</span>
<a href="#l3.668"></a><span id="l3.668" class="difflineminus">-              hasText = true;</span>
<a href="#l3.669"></a><span id="l3.669" class="difflineminus">-            } else if (isElement(subchild)) {</span>
<a href="#l3.670"></a><span id="l3.670" class="difflineminus">-              if (childElement) {</span>
<a href="#l3.671"></a><span id="l3.671" class="difflineminus">-                new Error(`Multiple object elements found in ${child.nodeName}`);</span>
<a href="#l3.672"></a><span id="l3.672" class="difflineminus">-              }</span>
<a href="#l3.673"></a><span id="l3.673" class="difflineminus">-              childElement = subchild;</span>
<a href="#l3.674"></a><span id="l3.674" class="difflineminus">-            }</span>
<a href="#l3.675"></a><span id="l3.675" class="difflineminus">-            subchild = subchild.nextSibling;</span>
<a href="#l3.676"></a><span id="l3.676" class="difflineminus">-          }</span>
<a href="#l3.677"></a><span id="l3.677" class="difflineminus">-</span>
<a href="#l3.678"></a><span id="l3.678" class="difflineminus">-          if ((resource || nodeID) &amp;&amp; (hasText || childElement)) {</span>
<a href="#l3.679"></a><span id="l3.679" class="difflineminus">-            ERROR(&quot;Assertion references a resource so should not contain additional contents&quot;);</span>
<a href="#l3.680"></a><span id="l3.680" class="difflineminus">-            throw new Error(&quot;assertion cannot contain multiple objects&quot;);</span>
<a href="#l3.681"></a><span id="l3.681" class="difflineminus">-          }</span>
<a href="#l3.682"></a><span id="l3.682" class="difflineminus">-</span>
<a href="#l3.683"></a><span id="l3.683" class="difflineminus">-          if (hasText &amp;&amp; childElement) {</span>
<a href="#l3.684"></a><span id="l3.684" class="difflineminus">-            ERROR(`Both literal and resource objects found in ${child.nodeName}`);</span>
<a href="#l3.685"></a><span id="l3.685" class="difflineminus">-            throw new Error(&quot;assertion cannot contain multiple objects&quot;);</span>
<a href="#l3.686"></a><span id="l3.686" class="difflineminus">-          }</span>
<a href="#l3.687"></a><span id="l3.687" class="difflineminus">-</span>
<a href="#l3.688"></a><span id="l3.688" class="difflineminus">-          if (childElement) {</span>
<a href="#l3.689"></a><span id="l3.689" class="difflineminus">-            if (parseType) {</span>
<a href="#l3.690"></a><span id="l3.690" class="difflineminus">-              ERROR(&quot;Cannot specify a parseType for an assertion with resource object&quot;);</span>
<a href="#l3.691"></a><span id="l3.691" class="difflineminus">-              throw new Error(&quot;parseType is not valid in this context&quot;);</span>
<a href="#l3.692"></a><span id="l3.692" class="difflineminus">-            }</span>
<a href="#l3.693"></a><span id="l3.693" class="difflineminus">-            object = this._ds._getSubjectForElement(childElement);</span>
<a href="#l3.694"></a><span id="l3.694" class="difflineminus">-            object._parseElement(childElement);</span>
<a href="#l3.695"></a><span id="l3.695" class="difflineminus">-          } else if (parseType == &quot;Integer&quot;) {</span>
<a href="#l3.696"></a><span id="l3.696" class="difflineminus">-            object = new RDFIntLiteral(child.textContent);</span>
<a href="#l3.697"></a><span id="l3.697" class="difflineminus">-          } else if (parseType == &quot;Date&quot;) {</span>
<a href="#l3.698"></a><span id="l3.698" class="difflineminus">-            object = new RDFDateLiteral(new Date(child.textContent));</span>
<a href="#l3.699"></a><span id="l3.699" class="difflineminus">-          } else {</span>
<a href="#l3.700"></a><span id="l3.700" class="difflineminus">-            object = new RDFLiteral(child.textContent);</span>
<a href="#l3.701"></a><span id="l3.701" class="difflineminus">-          }</span>
<a href="#l3.702"></a><span id="l3.702" class="difflineminus">-        }</span>
<a href="#l3.703"></a><span id="l3.703" class="difflineminus">-</span>
<a href="#l3.704"></a><span id="l3.704" class="difflineminus">-        assertion = new RDFAssertion(this, predicate, object);</span>
<a href="#l3.705"></a><span id="l3.705" class="difflineminus">-        this._addAssertion(assertion);</span>
<a href="#l3.706"></a><span id="l3.706" class="difflineminus">-        assertion._DOMnode = child;</span>
<a href="#l3.707"></a><span id="l3.707" class="difflineminus">-      }</span>
<a href="#l3.708"></a><span id="l3.708" class="difflineminus">-      child = child.nextSibling;</span>
<a href="#l3.709"></a><span id="l3.709" class="difflineminus">-    }</span>
<a href="#l3.710"></a><span id="l3.710" class="difflineminus">-  }</span>
<a href="#l3.711"></a><span id="l3.711" class="difflineminus">-  /* eslint-enable complexity */</span>
<a href="#l3.712"></a><span id="l3.712" class="difflineminus">-</span>
<a href="#l3.713"></a><span id="l3.713" class="difflineminus">-  /**</span>
<a href="#l3.714"></a><span id="l3.714" class="difflineminus">-   * Adds a new assertion to the internal hashes. Should be called for every</span>
<a href="#l3.715"></a><span id="l3.715" class="difflineminus">-   * new assertion parsed or created programmatically.</span>
<a href="#l3.716"></a><span id="l3.716" class="difflineminus">-   */</span>
<a href="#l3.717"></a><span id="l3.717" class="difflineminus">-  _addAssertion(assertion) {</span>
<a href="#l3.718"></a><span id="l3.718" class="difflineminus">-    var predicate = assertion.getPredicate();</span>
<a href="#l3.719"></a><span id="l3.719" class="difflineminus">-    if (predicate in this._assertions)</span>
<a href="#l3.720"></a><span id="l3.720" class="difflineminus">-      this._assertions[predicate].push(assertion);</span>
<a href="#l3.721"></a><span id="l3.721" class="difflineminus">-    else</span>
<a href="#l3.722"></a><span id="l3.722" class="difflineminus">-      this._assertions[predicate] = [ assertion ];</span>
<a href="#l3.723"></a><span id="l3.723" class="difflineminus">-</span>
<a href="#l3.724"></a><span id="l3.724" class="difflineminus">-    var object = assertion.getObject();</span>
<a href="#l3.725"></a><span id="l3.725" class="difflineminus">-    if (object instanceof RDFSubject) {</span>
<a href="#l3.726"></a><span id="l3.726" class="difflineminus">-      // Create reverse assertion</span>
<a href="#l3.727"></a><span id="l3.727" class="difflineminus">-      if (predicate in object._backwards)</span>
<a href="#l3.728"></a><span id="l3.728" class="difflineminus">-        object._backwards[predicate].push(assertion);</span>
<a href="#l3.729"></a><span id="l3.729" class="difflineminus">-      else</span>
<a href="#l3.730"></a><span id="l3.730" class="difflineminus">-        object._backwards[predicate] = [ assertion ];</span>
<a href="#l3.731"></a><span id="l3.731" class="difflineminus">-    }</span>
<a href="#l3.732"></a><span id="l3.732" class="difflineminus">-  }</span>
<a href="#l3.733"></a><span id="l3.733" class="difflineminus">-</span>
<a href="#l3.734"></a><span id="l3.734" class="difflineminus">-  /**</span>
<a href="#l3.735"></a><span id="l3.735" class="difflineminus">-   * Removes an assertion from the internal hashes. Should be called for all</span>
<a href="#l3.736"></a><span id="l3.736" class="difflineminus">-   * assertions that are programmatically deleted.</span>
<a href="#l3.737"></a><span id="l3.737" class="difflineminus">-   */</span>
<a href="#l3.738"></a><span id="l3.738" class="difflineminus">-  _removeAssertion(assertion) {</span>
<a href="#l3.739"></a><span id="l3.739" class="difflineminus">-    var predicate = assertion.getPredicate();</span>
<a href="#l3.740"></a><span id="l3.740" class="difflineminus">-    if (predicate in this._assertions) {</span>
<a href="#l3.741"></a><span id="l3.741" class="difflineminus">-      var pos = this._assertions[predicate].indexOf(assertion);</span>
<a href="#l3.742"></a><span id="l3.742" class="difflineminus">-      if (pos &gt;= 0)</span>
<a href="#l3.743"></a><span id="l3.743" class="difflineminus">-        this._assertions[predicate].splice(pos, 1);</span>
<a href="#l3.744"></a><span id="l3.744" class="difflineminus">-      if (this._assertions[predicate].length == 0)</span>
<a href="#l3.745"></a><span id="l3.745" class="difflineminus">-        delete this._assertions[predicate];</span>
<a href="#l3.746"></a><span id="l3.746" class="difflineminus">-    }</span>
<a href="#l3.747"></a><span id="l3.747" class="difflineminus">-</span>
<a href="#l3.748"></a><span id="l3.748" class="difflineminus">-    var object = assertion.getObject();</span>
<a href="#l3.749"></a><span id="l3.749" class="difflineminus">-    if (object instanceof RDFSubject) {</span>
<a href="#l3.750"></a><span id="l3.750" class="difflineminus">-      // Delete reverse assertion</span>
<a href="#l3.751"></a><span id="l3.751" class="difflineminus">-      if (predicate in object._backwards) {</span>
<a href="#l3.752"></a><span id="l3.752" class="difflineminus">-        pos = object._backwards[predicate].indexOf(assertion);</span>
<a href="#l3.753"></a><span id="l3.753" class="difflineminus">-        if (pos &gt;= 0)</span>
<a href="#l3.754"></a><span id="l3.754" class="difflineminus">-          object._backwards[predicate].splice(pos, 1);</span>
<a href="#l3.755"></a><span id="l3.755" class="difflineminus">-        if (object._backwards[predicate].length == 0)</span>
<a href="#l3.756"></a><span id="l3.756" class="difflineminus">-          delete object._backwards[predicate];</span>
<a href="#l3.757"></a><span id="l3.757" class="difflineminus">-      }</span>
<a href="#l3.758"></a><span id="l3.758" class="difflineminus">-    }</span>
<a href="#l3.759"></a><span id="l3.759" class="difflineminus">-  }</span>
<a href="#l3.760"></a><span id="l3.760" class="difflineminus">-</span>
<a href="#l3.761"></a><span id="l3.761" class="difflineminus">-  /**</span>
<a href="#l3.762"></a><span id="l3.762" class="difflineminus">-   * Returns the ordinal assertions from this subject in order.</span>
<a href="#l3.763"></a><span id="l3.763" class="difflineminus">-   */</span>
<a href="#l3.764"></a><span id="l3.764" class="difflineminus">-  _getChildAssertions() {</span>
<a href="#l3.765"></a><span id="l3.765" class="difflineminus">-    var assertions = [];</span>
<a href="#l3.766"></a><span id="l3.766" class="difflineminus">-    for (var i in this._assertions) {</span>
<a href="#l3.767"></a><span id="l3.767" class="difflineminus">-      if (RDF_LISTITEM.test(i))</span>
<a href="#l3.768"></a><span id="l3.768" class="difflineminus">-        assertions.push(...this._assertions[i]);</span>
<a href="#l3.769"></a><span id="l3.769" class="difflineminus">-    }</span>
<a href="#l3.770"></a><span id="l3.770" class="difflineminus">-    assertions.sort(predicateOrder);</span>
<a href="#l3.771"></a><span id="l3.771" class="difflineminus">-    return assertions;</span>
<a href="#l3.772"></a><span id="l3.772" class="difflineminus">-  }</span>
<a href="#l3.773"></a><span id="l3.773" class="difflineminus">-</span>
<a href="#l3.774"></a><span id="l3.774" class="difflineminus">-  /**</span>
<a href="#l3.775"></a><span id="l3.775" class="difflineminus">-   * Compares this to another rdf node</span>
<a href="#l3.776"></a><span id="l3.776" class="difflineminus">-   */</span>
<a href="#l3.777"></a><span id="l3.777" class="difflineminus">-  equals(rdfnode) {</span>
<a href="#l3.778"></a><span id="l3.778" class="difflineminus">-    // subjects are created by the datasource so no two objects ever correspond</span>
<a href="#l3.779"></a><span id="l3.779" class="difflineminus">-    // to the same one.</span>
<a href="#l3.780"></a><span id="l3.780" class="difflineminus">-    return this === rdfnode;</span>
<a href="#l3.781"></a><span id="l3.781" class="difflineminus">-  }</span>
<a href="#l3.782"></a><span id="l3.782" class="difflineminus">-</span>
<a href="#l3.783"></a><span id="l3.783" class="difflineminus">-  /**</span>
<a href="#l3.784"></a><span id="l3.784" class="difflineminus">-   * Adds a new assertion with this as the subject</span>
<a href="#l3.785"></a><span id="l3.785" class="difflineminus">-   */</span>
<a href="#l3.786"></a><span id="l3.786" class="difflineminus">-  assert(predicate, object) {</span>
<a href="#l3.787"></a><span id="l3.787" class="difflineminus">-    if (predicate == RDF_R(&quot;type&quot;) &amp;&amp; !(object instanceof RDFResource))</span>
<a href="#l3.788"></a><span id="l3.788" class="difflineminus">-      throw new Error(&quot;rdf:type must be an RDFResource&quot;);</span>
<a href="#l3.789"></a><span id="l3.789" class="difflineminus">-</span>
<a href="#l3.790"></a><span id="l3.790" class="difflineminus">-    var assertion = new RDFAssertion(this, predicate, object);</span>
<a href="#l3.791"></a><span id="l3.791" class="difflineminus">-    this._createDOMNodeForAssertion(assertion);</span>
<a href="#l3.792"></a><span id="l3.792" class="difflineminus">-    this._addAssertion(assertion);</span>
<a href="#l3.793"></a><span id="l3.793" class="difflineminus">-  }</span>
<a href="#l3.794"></a><span id="l3.794" class="difflineminus">-</span>
<a href="#l3.795"></a><span id="l3.795" class="difflineminus">-  /**</span>
<a href="#l3.796"></a><span id="l3.796" class="difflineminus">-   * Removes an assertion matching the predicate and node given, if such an</span>
<a href="#l3.797"></a><span id="l3.797" class="difflineminus">-   * assertion exists.</span>
<a href="#l3.798"></a><span id="l3.798" class="difflineminus">-   */</span>
<a href="#l3.799"></a><span id="l3.799" class="difflineminus">-  unassert(predicate, object) {</span>
<a href="#l3.800"></a><span id="l3.800" class="difflineminus">-    if (!(predicate in this._assertions))</span>
<a href="#l3.801"></a><span id="l3.801" class="difflineminus">-      return;</span>
<a href="#l3.802"></a><span id="l3.802" class="difflineminus">-</span>
<a href="#l3.803"></a><span id="l3.803" class="difflineminus">-    for (let assertion of this._assertions[predicate]) {</span>
<a href="#l3.804"></a><span id="l3.804" class="difflineminus">-      if (assertion.getObject().equals(object)) {</span>
<a href="#l3.805"></a><span id="l3.805" class="difflineminus">-        this._removeAssertion(assertion);</span>
<a href="#l3.806"></a><span id="l3.806" class="difflineminus">-        this._removeDOMNodeForAssertion(assertion);</span>
<a href="#l3.807"></a><span id="l3.807" class="difflineminus">-        return;</span>
<a href="#l3.808"></a><span id="l3.808" class="difflineminus">-      }</span>
<a href="#l3.809"></a><span id="l3.809" class="difflineminus">-    }</span>
<a href="#l3.810"></a><span id="l3.810" class="difflineminus">-  }</span>
<a href="#l3.811"></a><span id="l3.811" class="difflineminus">-</span>
<a href="#l3.812"></a><span id="l3.812" class="difflineminus">-  /**</span>
<a href="#l3.813"></a><span id="l3.813" class="difflineminus">-   * Returns an array of all the predicates that exist in assertions from this</span>
<a href="#l3.814"></a><span id="l3.814" class="difflineminus">-   * subject.</span>
<a href="#l3.815"></a><span id="l3.815" class="difflineminus">-   */</span>
<a href="#l3.816"></a><span id="l3.816" class="difflineminus">-  getPredicates() {</span>
<a href="#l3.817"></a><span id="l3.817" class="difflineminus">-    return Object.keys(this._assertions);</span>
<a href="#l3.818"></a><span id="l3.818" class="difflineminus">-  }</span>
<a href="#l3.819"></a><span id="l3.819" class="difflineminus">-</span>
<a href="#l3.820"></a><span id="l3.820" class="difflineminus">-  /**</span>
<a href="#l3.821"></a><span id="l3.821" class="difflineminus">-   * Returns all objects in assertions with this subject and the given predicate.</span>
<a href="#l3.822"></a><span id="l3.822" class="difflineminus">-   */</span>
<a href="#l3.823"></a><span id="l3.823" class="difflineminus">-  getObjects(predicate) {</span>
<a href="#l3.824"></a><span id="l3.824" class="difflineminus">-    if (predicate in this._assertions)</span>
<a href="#l3.825"></a><span id="l3.825" class="difflineminus">-      return Array.from(this._assertions[predicate],</span>
<a href="#l3.826"></a><span id="l3.826" class="difflineminus">-                        i =&gt; i.getObject());</span>
<a href="#l3.827"></a><span id="l3.827" class="difflineminus">-</span>
<a href="#l3.828"></a><span id="l3.828" class="difflineminus">-    return [];</span>
<a href="#l3.829"></a><span id="l3.829" class="difflineminus">-  }</span>
<a href="#l3.830"></a><span id="l3.830" class="difflineminus">-</span>
<a href="#l3.831"></a><span id="l3.831" class="difflineminus">-  /**</span>
<a href="#l3.832"></a><span id="l3.832" class="difflineminus">-   * Returns all of the ordinal children of this subject in order.</span>
<a href="#l3.833"></a><span id="l3.833" class="difflineminus">-   */</span>
<a href="#l3.834"></a><span id="l3.834" class="difflineminus">-  getChildren() {</span>
<a href="#l3.835"></a><span id="l3.835" class="difflineminus">-    return Array.from(this._getChildAssertions(),</span>
<a href="#l3.836"></a><span id="l3.836" class="difflineminus">-                      i =&gt; i.getObject());</span>
<a href="#l3.837"></a><span id="l3.837" class="difflineminus">-  }</span>
<a href="#l3.838"></a><span id="l3.838" class="difflineminus">-</span>
<a href="#l3.839"></a><span id="l3.839" class="difflineminus">-  /**</span>
<a href="#l3.840"></a><span id="l3.840" class="difflineminus">-   * Removes the child at the given index. This is the index based on the</span>
<a href="#l3.841"></a><span id="l3.841" class="difflineminus">-   * children returned from getChildren. Forces a reordering of the later</span>
<a href="#l3.842"></a><span id="l3.842" class="difflineminus">-   * children.</span>
<a href="#l3.843"></a><span id="l3.843" class="difflineminus">-   */</span>
<a href="#l3.844"></a><span id="l3.844" class="difflineminus">-  removeChildAt(pos) {</span>
<a href="#l3.845"></a><span id="l3.845" class="difflineminus">-    if (pos &lt; 0)</span>
<a href="#l3.846"></a><span id="l3.846" class="difflineminus">-      throw new Error(&quot;no such child&quot;);</span>
<a href="#l3.847"></a><span id="l3.847" class="difflineminus">-    var assertions = this._getChildAssertions();</span>
<a href="#l3.848"></a><span id="l3.848" class="difflineminus">-    if (pos &gt;= assertions.length)</span>
<a href="#l3.849"></a><span id="l3.849" class="difflineminus">-      throw new Error(&quot;no such child&quot;);</span>
<a href="#l3.850"></a><span id="l3.850" class="difflineminus">-    for (var i = pos; i &lt; assertions.length; i++) {</span>
<a href="#l3.851"></a><span id="l3.851" class="difflineminus">-      this._removeAssertion(assertions[i]);</span>
<a href="#l3.852"></a><span id="l3.852" class="difflineminus">-      this._removeDOMNodeForAssertion(assertions[i]);</span>
<a href="#l3.853"></a><span id="l3.853" class="difflineminus">-    }</span>
<a href="#l3.854"></a><span id="l3.854" class="difflineminus">-    var index = 1;</span>
<a href="#l3.855"></a><span id="l3.855" class="difflineminus">-    if (pos &gt; 0)</span>
<a href="#l3.856"></a><span id="l3.856" class="difflineminus">-      index = parseInt(assertions[pos - 1].getPredicate().substring(NS_RDF.length + 1)) + 1;</span>
<a href="#l3.857"></a><span id="l3.857" class="difflineminus">-    for (let i = pos + 1; i &lt; assertions.length; i++) {</span>
<a href="#l3.858"></a><span id="l3.858" class="difflineminus">-      assertions[i]._predicate = RDF_R(`_${index}`);</span>
<a href="#l3.859"></a><span id="l3.859" class="difflineminus">-      this._addAssertion(assertions[i]);</span>
<a href="#l3.860"></a><span id="l3.860" class="difflineminus">-      this._createDOMNodeForAssertion(assertions[i]);</span>
<a href="#l3.861"></a><span id="l3.861" class="difflineminus">-      index++;</span>
<a href="#l3.862"></a><span id="l3.862" class="difflineminus">-    }</span>
<a href="#l3.863"></a><span id="l3.863" class="difflineminus">-  }</span>
<a href="#l3.864"></a><span id="l3.864" class="difflineminus">-</span>
<a href="#l3.865"></a><span id="l3.865" class="difflineminus">-  /**</span>
<a href="#l3.866"></a><span id="l3.866" class="difflineminus">-   * Removes the child with the given object. It is unspecified which child is</span>
<a href="#l3.867"></a><span id="l3.867" class="difflineminus">-   * removed if the object features more than once.</span>
<a href="#l3.868"></a><span id="l3.868" class="difflineminus">-   */</span>
<a href="#l3.869"></a><span id="l3.869" class="difflineminus">-  removeChild(object) {</span>
<a href="#l3.870"></a><span id="l3.870" class="difflineminus">-    var assertions = this._getChildAssertions();</span>
<a href="#l3.871"></a><span id="l3.871" class="difflineminus">-    for (var pos = 0; pos &lt; assertions.length; pos++) {</span>
<a href="#l3.872"></a><span id="l3.872" class="difflineminus">-      if (assertions[pos].getObject().equals(object)) {</span>
<a href="#l3.873"></a><span id="l3.873" class="difflineminus">-        for (var i = pos; i &lt; assertions.length; i++) {</span>
<a href="#l3.874"></a><span id="l3.874" class="difflineminus">-          this._removeAssertion(assertions[i]);</span>
<a href="#l3.875"></a><span id="l3.875" class="difflineminus">-          this._removeDOMNodeForAssertion(assertions[i]);</span>
<a href="#l3.876"></a><span id="l3.876" class="difflineminus">-        }</span>
<a href="#l3.877"></a><span id="l3.877" class="difflineminus">-        var index = 1;</span>
<a href="#l3.878"></a><span id="l3.878" class="difflineminus">-        if (pos &gt; 0)</span>
<a href="#l3.879"></a><span id="l3.879" class="difflineminus">-          index = parseInt(assertions[pos - 1].getPredicate().substring(NS_RDF.length + 1)) + 1;</span>
<a href="#l3.880"></a><span id="l3.880" class="difflineminus">-        for (let i = pos + 1; i &lt; assertions.length; i++) {</span>
<a href="#l3.881"></a><span id="l3.881" class="difflineminus">-          assertions[i]._predicate = RDF_R(`_${index}`);</span>
<a href="#l3.882"></a><span id="l3.882" class="difflineminus">-          this._addAssertion(assertions[i]);</span>
<a href="#l3.883"></a><span id="l3.883" class="difflineminus">-          this._createDOMNodeForAssertion(assertions[i]);</span>
<a href="#l3.884"></a><span id="l3.884" class="difflineminus">-          index++;</span>
<a href="#l3.885"></a><span id="l3.885" class="difflineminus">-        }</span>
<a href="#l3.886"></a><span id="l3.886" class="difflineminus">-        return;</span>
<a href="#l3.887"></a><span id="l3.887" class="difflineminus">-      }</span>
<a href="#l3.888"></a><span id="l3.888" class="difflineminus">-    }</span>
<a href="#l3.889"></a><span id="l3.889" class="difflineminus">-    throw new Error(&quot;no such child&quot;);</span>
<a href="#l3.890"></a><span id="l3.890" class="difflineminus">-  }</span>
<a href="#l3.891"></a><span id="l3.891" class="difflineminus">-</span>
<a href="#l3.892"></a><span id="l3.892" class="difflineminus">-  /**</span>
<a href="#l3.893"></a><span id="l3.893" class="difflineminus">-   * Adds a new ordinal child to this subject.</span>
<a href="#l3.894"></a><span id="l3.894" class="difflineminus">-   */</span>
<a href="#l3.895"></a><span id="l3.895" class="difflineminus">-  addChild(object) {</span>
<a href="#l3.896"></a><span id="l3.896" class="difflineminus">-    var max = 0;</span>
<a href="#l3.897"></a><span id="l3.897" class="difflineminus">-    for (var i in this._assertions) {</span>
<a href="#l3.898"></a><span id="l3.898" class="difflineminus">-      if (RDF_LISTITEM.test(i))</span>
<a href="#l3.899"></a><span id="l3.899" class="difflineminus">-        max = Math.max(max, parseInt(i.substring(NS_RDF.length + 1)));</span>
<a href="#l3.900"></a><span id="l3.900" class="difflineminus">-    }</span>
<a href="#l3.901"></a><span id="l3.901" class="difflineminus">-    max++;</span>
<a href="#l3.902"></a><span id="l3.902" class="difflineminus">-    this.assert(RDF_R(`_${max}`), object);</span>
<a href="#l3.903"></a><span id="l3.903" class="difflineminus">-  }</span>
<a href="#l3.904"></a><span id="l3.904" class="difflineminus">-</span>
<a href="#l3.905"></a><span id="l3.905" class="difflineminus">-  /**</span>
<a href="#l3.906"></a><span id="l3.906" class="difflineminus">-   * This reorders the child assertions to remove duplicates and gaps in the</span>
<a href="#l3.907"></a><span id="l3.907" class="difflineminus">-   * sequence. Generally this will move all children to be under the same</span>
<a href="#l3.908"></a><span id="l3.908" class="difflineminus">-   * container element and all represented as an rdf:li</span>
<a href="#l3.909"></a><span id="l3.909" class="difflineminus">-   */</span>
<a href="#l3.910"></a><span id="l3.910" class="difflineminus">-  reorderChildren() {</span>
<a href="#l3.911"></a><span id="l3.911" class="difflineminus">-    var assertions = this._getChildAssertions();</span>
<a href="#l3.912"></a><span id="l3.912" class="difflineminus">-    for (let assertion of assertions) {</span>
<a href="#l3.913"></a><span id="l3.913" class="difflineminus">-      this._removeAssertion(assertion);</span>
<a href="#l3.914"></a><span id="l3.914" class="difflineminus">-      this._removeDOMNodeForAssertion(assertion);</span>
<a href="#l3.915"></a><span id="l3.915" class="difflineminus">-    }</span>
<a href="#l3.916"></a><span id="l3.916" class="difflineminus">-    var index = 1;</span>
<a href="#l3.917"></a><span id="l3.917" class="difflineminus">-    for (let assertion of assertions) {</span>
<a href="#l3.918"></a><span id="l3.918" class="difflineminus">-      assertion._predicate = RDF_R(`_${index}`);</span>
<a href="#l3.919"></a><span id="l3.919" class="difflineminus">-      this._addAssertion(assertion);</span>
<a href="#l3.920"></a><span id="l3.920" class="difflineminus">-      this._createDOMNodeForAssertion(assertion);</span>
<a href="#l3.921"></a><span id="l3.921" class="difflineminus">-      index++;</span>
<a href="#l3.922"></a><span id="l3.922" class="difflineminus">-    }</span>
<a href="#l3.923"></a><span id="l3.923" class="difflineminus">-  }</span>
<a href="#l3.924"></a><span id="l3.924" class="difflineminus">-</span>
<a href="#l3.925"></a><span id="l3.925" class="difflineminus">-  /**</span>
<a href="#l3.926"></a><span id="l3.926" class="difflineminus">-   * Returns the type of this subject or null if there is no specified type.</span>
<a href="#l3.927"></a><span id="l3.927" class="difflineminus">-   */</span>
<a href="#l3.928"></a><span id="l3.928" class="difflineminus">-  getType() {</span>
<a href="#l3.929"></a><span id="l3.929" class="difflineminus">-    var type = this.getProperty(RDF_R(&quot;type&quot;));</span>
<a href="#l3.930"></a><span id="l3.930" class="difflineminus">-    if (type &amp;&amp; type instanceof RDFResource)</span>
<a href="#l3.931"></a><span id="l3.931" class="difflineminus">-      return type.getURI();</span>
<a href="#l3.932"></a><span id="l3.932" class="difflineminus">-    return null;</span>
<a href="#l3.933"></a><span id="l3.933" class="difflineminus">-  }</span>
<a href="#l3.934"></a><span id="l3.934" class="difflineminus">-</span>
<a href="#l3.935"></a><span id="l3.935" class="difflineminus">-  /**</span>
<a href="#l3.936"></a><span id="l3.936" class="difflineminus">-   * Tests if a property exists for the given predicate.</span>
<a href="#l3.937"></a><span id="l3.937" class="difflineminus">-   */</span>
<a href="#l3.938"></a><span id="l3.938" class="difflineminus">-  hasProperty(predicate) {</span>
<a href="#l3.939"></a><span id="l3.939" class="difflineminus">-    return (predicate in this._assertions);</span>
<a href="#l3.940"></a><span id="l3.940" class="difflineminus">-  }</span>
<a href="#l3.941"></a><span id="l3.941" class="difflineminus">-</span>
<a href="#l3.942"></a><span id="l3.942" class="difflineminus">-  /**</span>
<a href="#l3.943"></a><span id="l3.943" class="difflineminus">-   * Retrieves the first property value for the given predicate.</span>
<a href="#l3.944"></a><span id="l3.944" class="difflineminus">-   */</span>
<a href="#l3.945"></a><span id="l3.945" class="difflineminus">-  getProperty(predicate) {</span>
<a href="#l3.946"></a><span id="l3.946" class="difflineminus">-    if (predicate in this._assertions)</span>
<a href="#l3.947"></a><span id="l3.947" class="difflineminus">-      return this._assertions[predicate][0].getObject();</span>
<a href="#l3.948"></a><span id="l3.948" class="difflineminus">-    return null;</span>
<a href="#l3.949"></a><span id="l3.949" class="difflineminus">-  }</span>
<a href="#l3.950"></a><span id="l3.950" class="difflineminus">-</span>
<a href="#l3.951"></a><span id="l3.951" class="difflineminus">-  /**</span>
<a href="#l3.952"></a><span id="l3.952" class="difflineminus">-   * Sets the property value for the given predicate, clearing any existing</span>
<a href="#l3.953"></a><span id="l3.953" class="difflineminus">-   * values.</span>
<a href="#l3.954"></a><span id="l3.954" class="difflineminus">-   */</span>
<a href="#l3.955"></a><span id="l3.955" class="difflineminus">-  setProperty(predicate, object) {</span>
<a href="#l3.956"></a><span id="l3.956" class="difflineminus">-    // TODO optimise by replacing the first assertion and clearing the rest</span>
<a href="#l3.957"></a><span id="l3.957" class="difflineminus">-    this.clearProperty(predicate);</span>
<a href="#l3.958"></a><span id="l3.958" class="difflineminus">-    this.assert(predicate, object);</span>
<a href="#l3.959"></a><span id="l3.959" class="difflineminus">-  }</span>
<a href="#l3.960"></a><span id="l3.960" class="difflineminus">-</span>
<a href="#l3.961"></a><span id="l3.961" class="difflineminus">-  /**</span>
<a href="#l3.962"></a><span id="l3.962" class="difflineminus">-   * Clears any existing properties for the given predicate.</span>
<a href="#l3.963"></a><span id="l3.963" class="difflineminus">-   */</span>
<a href="#l3.964"></a><span id="l3.964" class="difflineminus">-  clearProperty(predicate) {</span>
<a href="#l3.965"></a><span id="l3.965" class="difflineminus">-    if (!(predicate in this._assertions))</span>
<a href="#l3.966"></a><span id="l3.966" class="difflineminus">-      return;</span>
<a href="#l3.967"></a><span id="l3.967" class="difflineminus">-</span>
<a href="#l3.968"></a><span id="l3.968" class="difflineminus">-    var assertions = this._assertions[predicate];</span>
<a href="#l3.969"></a><span id="l3.969" class="difflineminus">-    while (assertions.length &gt; 0) {</span>
<a href="#l3.970"></a><span id="l3.970" class="difflineminus">-      var assertion = assertions[0];</span>
<a href="#l3.971"></a><span id="l3.971" class="difflineminus">-      this._removeAssertion(assertion);</span>
<a href="#l3.972"></a><span id="l3.972" class="difflineminus">-      this._removeDOMNodeForAssertion(assertion);</span>
<a href="#l3.973"></a><span id="l3.973" class="difflineminus">-    }</span>
<a href="#l3.974"></a><span id="l3.974" class="difflineminus">-  }</span>
<a href="#l3.975"></a><span id="l3.975" class="difflineminus">-}</span>
<a href="#l3.976"></a><span id="l3.976" class="difflineminus">-</span>
<a href="#l3.977"></a><span id="l3.977" class="difflineminus">-/**</span>
<a href="#l3.978"></a><span id="l3.978" class="difflineminus">- * Creates a new RDFResource for the datasource. Private.</span>
<a href="#l3.979"></a><span id="l3.979" class="difflineminus">- */</span>
<a href="#l3.980"></a><span id="l3.980" class="difflineminus">-class RDFResource extends RDFSubject {</span>
<a href="#l3.981"></a><span id="l3.981" class="difflineminus">-  constructor(ds, uri) {</span>
<a href="#l3.982"></a><span id="l3.982" class="difflineminus">-    if (!(ds instanceof RDFDataSource))</span>
<a href="#l3.983"></a><span id="l3.983" class="difflineminus">-      throw new Error(&quot;datasource must be an RDFDataSource&quot;);</span>
<a href="#l3.984"></a><span id="l3.984" class="difflineminus">-</span>
<a href="#l3.985"></a><span id="l3.985" class="difflineminus">-    if (!uri)</span>
<a href="#l3.986"></a><span id="l3.986" class="difflineminus">-      throw new Error(&quot;An RDFResource requires a non-null uri&quot;);</span>
<a href="#l3.987"></a><span id="l3.987" class="difflineminus">-</span>
<a href="#l3.988"></a><span id="l3.988" class="difflineminus">-    super(ds);</span>
<a href="#l3.989"></a><span id="l3.989" class="difflineminus">-    // This is the uri that the resource represents.</span>
<a href="#l3.990"></a><span id="l3.990" class="difflineminus">-    this._uri = uri;</span>
<a href="#l3.991"></a><span id="l3.991" class="difflineminus">-  }</span>
<a href="#l3.992"></a><span id="l3.992" class="difflineminus">-</span>
<a href="#l3.993"></a><span id="l3.993" class="difflineminus">-  /**</span>
<a href="#l3.994"></a><span id="l3.994" class="difflineminus">-   * Sets attributes on the DOM element to mark it as representing this resource</span>
<a href="#l3.995"></a><span id="l3.995" class="difflineminus">-   */</span>
<a href="#l3.996"></a><span id="l3.996" class="difflineminus">-  _applyToElement(element) {</span>
<a href="#l3.997"></a><span id="l3.997" class="difflineminus">-    if (USE_RDFNS_ATTR) {</span>
<a href="#l3.998"></a><span id="l3.998" class="difflineminus">-      var prefix = this._ds._resolvePrefix(element, RDF_R(&quot;about&quot;));</span>
<a href="#l3.999"></a><span id="l3.999" class="difflineminus">-      element.setAttributeNS(prefix.namespaceURI, prefix.qname, this._uri);</span>
<a href="#l3.1000"></a><span id="l3.1000" class="difflineminus">-    } else {</span>
<a href="#l3.1001"></a><span id="l3.1001" class="difflineminus">-      element.setAttribute(&quot;about&quot;, this._uri);</span>
<a href="#l3.1002"></a><span id="l3.1002" class="difflineminus">-    }</span>
<a href="#l3.1003"></a><span id="l3.1003" class="difflineminus">-  }</span>
<a href="#l3.1004"></a><span id="l3.1004" class="difflineminus">-</span>
<a href="#l3.1005"></a><span id="l3.1005" class="difflineminus">-  /**</span>
<a href="#l3.1006"></a><span id="l3.1006" class="difflineminus">-   * Adds a reference to this resource to the given property Element.</span>
<a href="#l3.1007"></a><span id="l3.1007" class="difflineminus">-   */</span>
<a href="#l3.1008"></a><span id="l3.1008" class="difflineminus">-  _addReferenceToElement(element) {</span>
<a href="#l3.1009"></a><span id="l3.1009" class="difflineminus">-    if (USE_RDFNS_ATTR) {</span>
<a href="#l3.1010"></a><span id="l3.1010" class="difflineminus">-      var prefix = this._ds._resolvePrefix(element, RDF_R(&quot;resource&quot;));</span>
<a href="#l3.1011"></a><span id="l3.1011" class="difflineminus">-      element.setAttributeNS(prefix.namespaceURI, prefix.qname, this._uri);</span>
<a href="#l3.1012"></a><span id="l3.1012" class="difflineminus">-    } else {</span>
<a href="#l3.1013"></a><span id="l3.1013" class="difflineminus">-      element.setAttribute(&quot;resource&quot;, this._uri);</span>
<a href="#l3.1014"></a><span id="l3.1014" class="difflineminus">-    }</span>
<a href="#l3.1015"></a><span id="l3.1015" class="difflineminus">-  }</span>
<a href="#l3.1016"></a><span id="l3.1016" class="difflineminus">-</span>
<a href="#l3.1017"></a><span id="l3.1017" class="difflineminus">-    /**</span>
<a href="#l3.1018"></a><span id="l3.1018" class="difflineminus">-     * Removes any reference to this resource from the given property Element.</span>
<a href="#l3.1019"></a><span id="l3.1019" class="difflineminus">-     */</span>
<a href="#l3.1020"></a><span id="l3.1020" class="difflineminus">-    _removeReferenceFromElement(element) {</span>
<a href="#l3.1021"></a><span id="l3.1021" class="difflineminus">-      if (element.hasAttributeNS(NS_RDF, &quot;resource&quot;))</span>
<a href="#l3.1022"></a><span id="l3.1022" class="difflineminus">-        element.removeAttributeNS(NS_RDF, &quot;resource&quot;);</span>
<a href="#l3.1023"></a><span id="l3.1023" class="difflineminus">-      if (element.hasAttribute(&quot;resource&quot;))</span>
<a href="#l3.1024"></a><span id="l3.1024" class="difflineminus">-        element.removeAttribute(&quot;resource&quot;);</span>
<a href="#l3.1025"></a><span id="l3.1025" class="difflineminus">-    }</span>
<a href="#l3.1026"></a><span id="l3.1026" class="difflineminus">-</span>
<a href="#l3.1027"></a><span id="l3.1027" class="difflineminus">-  getURI() {</span>
<a href="#l3.1028"></a><span id="l3.1028" class="difflineminus">-    return this._uri;</span>
<a href="#l3.1029"></a><span id="l3.1029" class="difflineminus">-  }</span>
<a href="#l3.1030"></a><span id="l3.1030" class="difflineminus">-}</span>
<a href="#l3.1031"></a><span id="l3.1031" class="difflineminus">-</span>
<a href="#l3.1032"></a><span id="l3.1032" class="difflineminus">-/**</span>
<a href="#l3.1033"></a><span id="l3.1033" class="difflineminus">- * Creates a new blank node. Private.</span>
<a href="#l3.1034"></a><span id="l3.1034" class="difflineminus">- */</span>
<a href="#l3.1035"></a><span id="l3.1035" class="difflineminus">-class RDFBlankNode extends RDFSubject {</span>
<a href="#l3.1036"></a><span id="l3.1036" class="difflineminus">-  constructor(ds, nodeID) {</span>
<a href="#l3.1037"></a><span id="l3.1037" class="difflineminus">-    if (!(ds instanceof RDFDataSource))</span>
<a href="#l3.1038"></a><span id="l3.1038" class="difflineminus">-      throw new Error(&quot;datasource must be an RDFDataSource&quot;);</span>
<a href="#l3.1039"></a><span id="l3.1039" class="difflineminus">-</span>
<a href="#l3.1040"></a><span id="l3.1040" class="difflineminus">-    super(ds);</span>
<a href="#l3.1041"></a><span id="l3.1041" class="difflineminus">-    // The nodeID of this node. May be null if there is no ID.</span>
<a href="#l3.1042"></a><span id="l3.1042" class="difflineminus">-    this._nodeID = nodeID;</span>
<a href="#l3.1043"></a><span id="l3.1043" class="difflineminus">-  }</span>
<a href="#l3.1044"></a><span id="l3.1044" class="difflineminus">-</span>
<a href="#l3.1045"></a><span id="l3.1045" class="difflineminus">-  /**</span>
<a href="#l3.1046"></a><span id="l3.1046" class="difflineminus">-   * Sets attributes on the DOM element to mark it as representing this node</span>
<a href="#l3.1047"></a><span id="l3.1047" class="difflineminus">-   */</span>
<a href="#l3.1048"></a><span id="l3.1048" class="difflineminus">-  _applyToElement(element) {</span>
<a href="#l3.1049"></a><span id="l3.1049" class="difflineminus">-    if (!this._nodeID)</span>
<a href="#l3.1050"></a><span id="l3.1050" class="difflineminus">-      return;</span>
<a href="#l3.1051"></a><span id="l3.1051" class="difflineminus">-    if (USE_RDFNS_ATTR) {</span>
<a href="#l3.1052"></a><span id="l3.1052" class="difflineminus">-      var prefix = this._ds._resolvePrefix(element, RDF_R(&quot;nodeID&quot;));</span>
<a href="#l3.1053"></a><span id="l3.1053" class="difflineminus">-      element.setAttributeNS(prefix.namespaceURI, prefix.qname, this._nodeID);</span>
<a href="#l3.1054"></a><span id="l3.1054" class="difflineminus">-    } else {</span>
<a href="#l3.1055"></a><span id="l3.1055" class="difflineminus">-      element.setAttribute(&quot;nodeID&quot;, this._nodeID);</span>
<a href="#l3.1056"></a><span id="l3.1056" class="difflineminus">-    }</span>
<a href="#l3.1057"></a><span id="l3.1057" class="difflineminus">-  }</span>
<a href="#l3.1058"></a><span id="l3.1058" class="difflineminus">-</span>
<a href="#l3.1059"></a><span id="l3.1059" class="difflineminus">-  /**</span>
<a href="#l3.1060"></a><span id="l3.1060" class="difflineminus">-   * Creates a new Element in the document for holding assertions about this</span>
<a href="#l3.1061"></a><span id="l3.1061" class="difflineminus">-   * subject. The URI controls what tagname to use.</span>
<a href="#l3.1062"></a><span id="l3.1062" class="difflineminus">-   */</span>
<a href="#l3.1063"></a><span id="l3.1063" class="difflineminus">-  _createNewElement(uri) {</span>
<a href="#l3.1064"></a><span id="l3.1064" class="difflineminus">-    // If there are already nodes representing this in the document then we need</span>
<a href="#l3.1065"></a><span id="l3.1065" class="difflineminus">-    // a nodeID to match them</span>
<a href="#l3.1066"></a><span id="l3.1066" class="difflineminus">-    if (!this._nodeID &amp;&amp; this._elements.length &gt; 0) {</span>
<a href="#l3.1067"></a><span id="l3.1067" class="difflineminus">-      this._ds._createNodeID(this);</span>
<a href="#l3.1068"></a><span id="l3.1068" class="difflineminus">-      for (let element of this._elements)</span>
<a href="#l3.1069"></a><span id="l3.1069" class="difflineminus">-        this._applyToElement(element);</span>
<a href="#l3.1070"></a><span id="l3.1070" class="difflineminus">-    }</span>
<a href="#l3.1071"></a><span id="l3.1071" class="difflineminus">-</span>
<a href="#l3.1072"></a><span id="l3.1072" class="difflineminus">-    return super._createNewElement.call(uri);</span>
<a href="#l3.1073"></a><span id="l3.1073" class="difflineminus">-  }</span>
<a href="#l3.1074"></a><span id="l3.1074" class="difflineminus">-</span>
<a href="#l3.1075"></a><span id="l3.1075" class="difflineminus">-  /**</span>
<a href="#l3.1076"></a><span id="l3.1076" class="difflineminus">-   * Adds a reference to this node to the given property Element.</span>
<a href="#l3.1077"></a><span id="l3.1077" class="difflineminus">-   */</span>
<a href="#l3.1078"></a><span id="l3.1078" class="difflineminus">-  _addReferenceToElement(element) {</span>
<a href="#l3.1079"></a><span id="l3.1079" class="difflineminus">-    if (this._elements.length &gt; 0 &amp;&amp; !this._nodeID) {</span>
<a href="#l3.1080"></a><span id="l3.1080" class="difflineminus">-      // In document elsewhere already</span>
<a href="#l3.1081"></a><span id="l3.1081" class="difflineminus">-      // Create a node ID and update the other nodes referencing</span>
<a href="#l3.1082"></a><span id="l3.1082" class="difflineminus">-      this._ds._createNodeID(this);</span>
<a href="#l3.1083"></a><span id="l3.1083" class="difflineminus">-      for (let element of this._elements)</span>
<a href="#l3.1084"></a><span id="l3.1084" class="difflineminus">-        this._applyToElement(element);</span>
<a href="#l3.1085"></a><span id="l3.1085" class="difflineminus">-    }</span>
<a href="#l3.1086"></a><span id="l3.1086" class="difflineminus">-</span>
<a href="#l3.1087"></a><span id="l3.1087" class="difflineminus">-    if (this._nodeID) {</span>
<a href="#l3.1088"></a><span id="l3.1088" class="difflineminus">-      if (USE_RDFNS_ATTR) {</span>
<a href="#l3.1089"></a><span id="l3.1089" class="difflineminus">-        let prefix = this._ds._resolvePrefix(element, RDF_R(&quot;nodeID&quot;));</span>
<a href="#l3.1090"></a><span id="l3.1090" class="difflineminus">-        element.setAttributeNS(prefix.namespaceURI, prefix.qname, this._nodeID);</span>
<a href="#l3.1091"></a><span id="l3.1091" class="difflineminus">-      } else {</span>
<a href="#l3.1092"></a><span id="l3.1092" class="difflineminus">-        element.setAttribute(&quot;nodeID&quot;, this._nodeID);</span>
<a href="#l3.1093"></a><span id="l3.1093" class="difflineminus">-      }</span>
<a href="#l3.1094"></a><span id="l3.1094" class="difflineminus">-    } else {</span>
<a href="#l3.1095"></a><span id="l3.1095" class="difflineminus">-      // Add the empty blank node, this is generally right since further</span>
<a href="#l3.1096"></a><span id="l3.1096" class="difflineminus">-      // assertions will be added to fill this out</span>
<a href="#l3.1097"></a><span id="l3.1097" class="difflineminus">-      var newelement = this._ds._addElement(element, RDF_R(&quot;Description&quot;));</span>
<a href="#l3.1098"></a><span id="l3.1098" class="difflineminus">-      newelement.listCounter = 1;</span>
<a href="#l3.1099"></a><span id="l3.1099" class="difflineminus">-      this._elements.push(newelement);</span>
<a href="#l3.1100"></a><span id="l3.1100" class="difflineminus">-    }</span>
<a href="#l3.1101"></a><span id="l3.1101" class="difflineminus">-  }</span>
<a href="#l3.1102"></a><span id="l3.1102" class="difflineminus">-</span>
<a href="#l3.1103"></a><span id="l3.1103" class="difflineminus">-    /**</span>
<a href="#l3.1104"></a><span id="l3.1104" class="difflineminus">-     * Removes any reference to this node from the given property Element.</span>
<a href="#l3.1105"></a><span id="l3.1105" class="difflineminus">-     */</span>
<a href="#l3.1106"></a><span id="l3.1106" class="difflineminus">-    _removeReferenceFromElement(element) {</span>
<a href="#l3.1107"></a><span id="l3.1107" class="difflineminus">-      if (element.hasAttributeNS(NS_RDF, &quot;nodeID&quot;))</span>
<a href="#l3.1108"></a><span id="l3.1108" class="difflineminus">-        element.removeAttributeNS(NS_RDF, &quot;nodeID&quot;);</span>
<a href="#l3.1109"></a><span id="l3.1109" class="difflineminus">-      if (element.hasAttribute(&quot;nodeID&quot;))</span>
<a href="#l3.1110"></a><span id="l3.1110" class="difflineminus">-        element.removeAttribute(&quot;nodeID&quot;);</span>
<a href="#l3.1111"></a><span id="l3.1111" class="difflineminus">-    }</span>
<a href="#l3.1112"></a><span id="l3.1112" class="difflineminus">-</span>
<a href="#l3.1113"></a><span id="l3.1113" class="difflineminus">-  getNodeID() {</span>
<a href="#l3.1114"></a><span id="l3.1114" class="difflineminus">-    return this._nodeID;</span>
<a href="#l3.1115"></a><span id="l3.1115" class="difflineminus">-  }</span>
<a href="#l3.1116"></a><span id="l3.1116" class="difflineminus">-}</span>
<a href="#l3.1117"></a><span id="l3.1117" class="difflineminus">-</span>
<a href="#l3.1118"></a><span id="l3.1118" class="difflineminus">-/**</span>
<a href="#l3.1119"></a><span id="l3.1119" class="difflineminus">- * Creates a new RDFDataSource from the given document. The document will be</span>
<a href="#l3.1120"></a><span id="l3.1120" class="difflineminus">- * changed as assertions are added and removed to the RDF. Pass a null document</span>
<a href="#l3.1121"></a><span id="l3.1121" class="difflineminus">- * to start with an empty graph.</span>
<a href="#l3.1122"></a><span id="l3.1122" class="difflineminus">- */</span>
<a href="#l3.1123"></a><span id="l3.1123" class="difflineminus">-class RDFDataSource {</span>
<a href="#l3.1124"></a><span id="l3.1124" class="difflineminus">-  constructor(document) {</span>
<a href="#l3.1125"></a><span id="l3.1125" class="difflineminus">-    // All known resources, indexed on URI</span>
<a href="#l3.1126"></a><span id="l3.1126" class="difflineminus">-    this._resources = {};</span>
<a href="#l3.1127"></a><span id="l3.1127" class="difflineminus">-    // All blank nodes</span>
<a href="#l3.1128"></a><span id="l3.1128" class="difflineminus">-    this._allBlankNodes = [];</span>
<a href="#l3.1129"></a><span id="l3.1129" class="difflineminus">-    // All blank nodes with IDs, indexed on ID</span>
<a href="#l3.1130"></a><span id="l3.1130" class="difflineminus">-    this._blankNodes = {};</span>
<a href="#l3.1131"></a><span id="l3.1131" class="difflineminus">-    // Suggested prefixes to use for namespaces, index is prefix, value is namespaceURI.</span>
<a href="#l3.1132"></a><span id="l3.1132" class="difflineminus">-    this._prefixes = {</span>
<a href="#l3.1133"></a><span id="l3.1133" class="difflineminus">-      rdf: NS_RDF,</span>
<a href="#l3.1134"></a><span id="l3.1134" class="difflineminus">-      NC: NS_NC,</span>
<a href="#l3.1135"></a><span id="l3.1135" class="difflineminus">-    };</span>
<a href="#l3.1136"></a><span id="l3.1136" class="difflineminus">-</span>
<a href="#l3.1137"></a><span id="l3.1137" class="difflineminus">-    if (!document) {</span>
<a href="#l3.1138"></a><span id="l3.1138" class="difflineminus">-      // Creating a document through xpcom leaves out the xml prolog so just parse</span>
<a href="#l3.1139"></a><span id="l3.1139" class="difflineminus">-      // something small</span>
<a href="#l3.1140"></a><span id="l3.1140" class="difflineminus">-      var parser = Cc[&quot;@mozilla.org/xmlextras/domparser;1&quot;].</span>
<a href="#l3.1141"></a><span id="l3.1141" class="difflineminus">-                   createInstance(Ci.nsIDOMParser);</span>
<a href="#l3.1142"></a><span id="l3.1142" class="difflineminus">-      var doctext = `&lt;?xml version=&quot;1.0&quot;?&gt;\n&lt;rdf:RDF xmlns:rdf=&quot;${NS_RDF}&quot;/&gt;\n`;</span>
<a href="#l3.1143"></a><span id="l3.1143" class="difflineminus">-      document = parser.parseFromString(doctext, &quot;text/xml&quot;);</span>
<a href="#l3.1144"></a><span id="l3.1144" class="difflineminus">-    }</span>
<a href="#l3.1145"></a><span id="l3.1145" class="difflineminus">-    // The underlying DOM document for this datasource</span>
<a href="#l3.1146"></a><span id="l3.1146" class="difflineminus">-    this._document = document;</span>
<a href="#l3.1147"></a><span id="l3.1147" class="difflineminus">-    this._parseDocument();</span>
<a href="#l3.1148"></a><span id="l3.1148" class="difflineminus">-  }</span>
<a href="#l3.1149"></a><span id="l3.1149" class="difflineminus">-</span>
<a href="#l3.1150"></a><span id="l3.1150" class="difflineminus">-  static loadFromString(text) {</span>
<a href="#l3.1151"></a><span id="l3.1151" class="difflineminus">-    let parser = new DOMParser();</span>
<a href="#l3.1152"></a><span id="l3.1152" class="difflineminus">-    let document = parser.parseFromString(text, &quot;application/xml&quot;);</span>
<a href="#l3.1153"></a><span id="l3.1153" class="difflineminus">-</span>
<a href="#l3.1154"></a><span id="l3.1154" class="difflineminus">-    return new this(document);</span>
<a href="#l3.1155"></a><span id="l3.1155" class="difflineminus">-  }</span>
<a href="#l3.1156"></a><span id="l3.1156" class="difflineminus">-</span>
<a href="#l3.1157"></a><span id="l3.1157" class="difflineminus">-  static loadFromBuffer(buffer) {</span>
<a href="#l3.1158"></a><span id="l3.1158" class="difflineminus">-    let parser = new DOMParser();</span>
<a href="#l3.1159"></a><span id="l3.1159" class="difflineminus">-    let document = parser.parseFromBuffer(new Uint8Array(buffer), &quot;application/xml&quot;);</span>
<a href="#l3.1160"></a><span id="l3.1160" class="difflineminus">-</span>
<a href="#l3.1161"></a><span id="l3.1161" class="difflineminus">-    return new this(document);</span>
<a href="#l3.1162"></a><span id="l3.1162" class="difflineminus">-  }</span>
<a href="#l3.1163"></a><span id="l3.1163" class="difflineminus">-</span>
<a href="#l3.1164"></a><span id="l3.1164" class="difflineminus">-  static async loadFromFile(uri) {</span>
<a href="#l3.1165"></a><span id="l3.1165" class="difflineminus">-    if (uri instanceof Ci.nsIFile)</span>
<a href="#l3.1166"></a><span id="l3.1166" class="difflineminus">-      uri = Services.io.newFileURI(uri);</span>
<a href="#l3.1167"></a><span id="l3.1167" class="difflineminus">-    else if (typeof(uri) == &quot;string&quot;)</span>
<a href="#l3.1168"></a><span id="l3.1168" class="difflineminus">-      uri = Services.io.newURI(uri);</span>
<a href="#l3.1169"></a><span id="l3.1169" class="difflineminus">-</span>
<a href="#l3.1170"></a><span id="l3.1170" class="difflineminus">-    let resp = await fetch(uri.spec);</span>
<a href="#l3.1171"></a><span id="l3.1171" class="difflineminus">-    return this.loadFromBuffer(await resp.arrayBuffer());</span>
<a href="#l3.1172"></a><span id="l3.1172" class="difflineminus">-  }</span>
<a href="#l3.1173"></a><span id="l3.1173" class="difflineminus">-</span>
<a href="#l3.1174"></a><span id="l3.1174" class="difflineminus">-  get uri() {</span>
<a href="#l3.1175"></a><span id="l3.1175" class="difflineminus">-    return this._document.documentURI;</span>
<a href="#l3.1176"></a><span id="l3.1176" class="difflineminus">-  }</span>
<a href="#l3.1177"></a><span id="l3.1177" class="difflineminus">-</span>
<a href="#l3.1178"></a><span id="l3.1178" class="difflineminus">-  /**</span>
<a href="#l3.1179"></a><span id="l3.1179" class="difflineminus">-   * Creates a new nodeID for an unnamed blank node. Just node&lt;number&gt;.</span>
<a href="#l3.1180"></a><span id="l3.1180" class="difflineminus">-   */</span>
<a href="#l3.1181"></a><span id="l3.1181" class="difflineminus">-  _createNodeID(blanknode) {</span>
<a href="#l3.1182"></a><span id="l3.1182" class="difflineminus">-    var i = 1;</span>
<a href="#l3.1183"></a><span id="l3.1183" class="difflineminus">-    while (`node${i}` in this._blankNodes)</span>
<a href="#l3.1184"></a><span id="l3.1184" class="difflineminus">-      i++;</span>
<a href="#l3.1185"></a><span id="l3.1185" class="difflineminus">-    blanknode._nodeID = `node${i}`;</span>
<a href="#l3.1186"></a><span id="l3.1186" class="difflineminus">-    this._blankNodes[blanknode._nodeID] = blanknode;</span>
<a href="#l3.1187"></a><span id="l3.1187" class="difflineminus">-  }</span>
<a href="#l3.1188"></a><span id="l3.1188" class="difflineminus">-</span>
<a href="#l3.1189"></a><span id="l3.1189" class="difflineminus">-  /**</span>
<a href="#l3.1190"></a><span id="l3.1190" class="difflineminus">-   * Returns an rdf subject for the given DOM Element. If the subject has not</span>
<a href="#l3.1191"></a><span id="l3.1191" class="difflineminus">-   * been seen before a new one is created.</span>
<a href="#l3.1192"></a><span id="l3.1192" class="difflineminus">-   */</span>
<a href="#l3.1193"></a><span id="l3.1193" class="difflineminus">-  _getSubjectForElement(element) {</span>
<a href="#l3.1194"></a><span id="l3.1194" class="difflineminus">-    if (element.namespaceURI == NS_RDF &amp;&amp;</span>
<a href="#l3.1195"></a><span id="l3.1195" class="difflineminus">-        RDF_NODE_INVALID_TYPES.includes(element.localName))</span>
<a href="#l3.1196"></a><span id="l3.1196" class="difflineminus">-      throw new Error(`${element.nodeName} is not a valid class for a subject node`);</span>
<a href="#l3.1197"></a><span id="l3.1197" class="difflineminus">-</span>
<a href="#l3.1198"></a><span id="l3.1198" class="difflineminus">-    var about = getRDFAttribute(element, &quot;about&quot;);</span>
<a href="#l3.1199"></a><span id="l3.1199" class="difflineminus">-    var id = getRDFAttribute(element, &quot;ID&quot;);</span>
<a href="#l3.1200"></a><span id="l3.1200" class="difflineminus">-    var nodeID = getRDFAttribute(element, &quot;nodeID&quot;);</span>
<a href="#l3.1201"></a><span id="l3.1201" class="difflineminus">-</span>
<a href="#l3.1202"></a><span id="l3.1202" class="difflineminus">-    if ((about &amp;&amp; (id || nodeID)) ||</span>
<a href="#l3.1203"></a><span id="l3.1203" class="difflineminus">-        (nodeID &amp;&amp; (id || about))) {</span>
<a href="#l3.1204"></a><span id="l3.1204" class="difflineminus">-      ERROR(&quot;More than one of about, ID and nodeID present on the same subject&quot;);</span>
<a href="#l3.1205"></a><span id="l3.1205" class="difflineminus">-      throw new Error(&quot;invalid subject in rdf&quot;);</span>
<a href="#l3.1206"></a><span id="l3.1206" class="difflineminus">-    }</span>
<a href="#l3.1207"></a><span id="l3.1207" class="difflineminus">-</span>
<a href="#l3.1208"></a><span id="l3.1208" class="difflineminus">-    if (about !== undefined) {</span>
<a href="#l3.1209"></a><span id="l3.1209" class="difflineminus">-      let base = Services.io.newURI(element.baseURI);</span>
<a href="#l3.1210"></a><span id="l3.1210" class="difflineminus">-      return this.getResource(base.resolve(about));</span>
<a href="#l3.1211"></a><span id="l3.1211" class="difflineminus">-    }</span>
<a href="#l3.1212"></a><span id="l3.1212" class="difflineminus">-    if (id !== undefined) {</span>
<a href="#l3.1213"></a><span id="l3.1213" class="difflineminus">-      if (!id.match(XML_NCNAME))</span>
<a href="#l3.1214"></a><span id="l3.1214" class="difflineminus">-        throw new Error(&quot;rdf:ID must be a valid XML name&quot;);</span>
<a href="#l3.1215"></a><span id="l3.1215" class="difflineminus">-      let base = Services.io.newURI(element.baseURI);</span>
<a href="#l3.1216"></a><span id="l3.1216" class="difflineminus">-      return this.getResource(base.resolve(`#${id}`));</span>
<a href="#l3.1217"></a><span id="l3.1217" class="difflineminus">-    }</span>
<a href="#l3.1218"></a><span id="l3.1218" class="difflineminus">-    if (nodeID !== undefined)</span>
<a href="#l3.1219"></a><span id="l3.1219" class="difflineminus">-      return this.getBlankNode(nodeID);</span>
<a href="#l3.1220"></a><span id="l3.1220" class="difflineminus">-    return this.getBlankNode(null);</span>
<a href="#l3.1221"></a><span id="l3.1221" class="difflineminus">-  }</span>
<a href="#l3.1222"></a><span id="l3.1222" class="difflineminus">-</span>
<a href="#l3.1223"></a><span id="l3.1223" class="difflineminus">-  /**</span>
<a href="#l3.1224"></a><span id="l3.1224" class="difflineminus">-   * Parses the document for subjects at the top level.</span>
<a href="#l3.1225"></a><span id="l3.1225" class="difflineminus">-   */</span>
<a href="#l3.1226"></a><span id="l3.1226" class="difflineminus">-  _parseDocument() {</span>
<a href="#l3.1227"></a><span id="l3.1227" class="difflineminus">-    if (!this._document.documentElement) {</span>
<a href="#l3.1228"></a><span id="l3.1228" class="difflineminus">-      ERROR(&quot;No document element in document&quot;);</span>
<a href="#l3.1229"></a><span id="l3.1229" class="difflineminus">-      throw new Error(&quot;document contains no root element&quot;);</span>
<a href="#l3.1230"></a><span id="l3.1230" class="difflineminus">-    }</span>
<a href="#l3.1231"></a><span id="l3.1231" class="difflineminus">-</span>
<a href="#l3.1232"></a><span id="l3.1232" class="difflineminus">-    if (this._document.documentElement.namespaceURI != NS_RDF ||</span>
<a href="#l3.1233"></a><span id="l3.1233" class="difflineminus">-        this._document.documentElement.localName != &quot;RDF&quot;) {</span>
<a href="#l3.1234"></a><span id="l3.1234" class="difflineminus">-      ERROR(`${this._document.documentElement.nodeName} is not rdf:RDF`);</span>
<a href="#l3.1235"></a><span id="l3.1235" class="difflineminus">-      throw new Error(&quot;document does not appear to be RDF&quot;);</span>
<a href="#l3.1236"></a><span id="l3.1236" class="difflineminus">-    }</span>
<a href="#l3.1237"></a><span id="l3.1237" class="difflineminus">-</span>
<a href="#l3.1238"></a><span id="l3.1238" class="difflineminus">-    var domnode = this._document.documentElement.firstChild;</span>
<a href="#l3.1239"></a><span id="l3.1239" class="difflineminus">-    while (domnode) {</span>
<a href="#l3.1240"></a><span id="l3.1240" class="difflineminus">-      if (isText(domnode) &amp;&amp; /\S/.test(domnode.nodeValue)) {</span>
<a href="#l3.1241"></a><span id="l3.1241" class="difflineminus">-        ERROR(&quot;RDF does not allow for text in the root of the document&quot;);</span>
<a href="#l3.1242"></a><span id="l3.1242" class="difflineminus">-        throw new Error(&quot;invalid markup in document&quot;);</span>
<a href="#l3.1243"></a><span id="l3.1243" class="difflineminus">-      } else if (isElement(domnode)) {</span>
<a href="#l3.1244"></a><span id="l3.1244" class="difflineminus">-        var subject = this._getSubjectForElement(domnode);</span>
<a href="#l3.1245"></a><span id="l3.1245" class="difflineminus">-        subject._parseElement(domnode);</span>
<a href="#l3.1246"></a><span id="l3.1246" class="difflineminus">-      }</span>
<a href="#l3.1247"></a><span id="l3.1247" class="difflineminus">-      domnode = domnode.nextSibling;</span>
<a href="#l3.1248"></a><span id="l3.1248" class="difflineminus">-    }</span>
<a href="#l3.1249"></a><span id="l3.1249" class="difflineminus">-  }</span>
<a href="#l3.1250"></a><span id="l3.1250" class="difflineminus">-</span>
<a href="#l3.1251"></a><span id="l3.1251" class="difflineminus">-  /**</span>
<a href="#l3.1252"></a><span id="l3.1252" class="difflineminus">-   * Works out a sensible namespace prefix to use for the given uri. node should</span>
<a href="#l3.1253"></a><span id="l3.1253" class="difflineminus">-   * be the parent of where the element is to be inserted, or the node that an</span>
<a href="#l3.1254"></a><span id="l3.1254" class="difflineminus">-   * attribute is to be added to. This will recursively walk to the top of the</span>
<a href="#l3.1255"></a><span id="l3.1255" class="difflineminus">-   * document finding an already registered prefix that matches for the uri.</span>
<a href="#l3.1256"></a><span id="l3.1256" class="difflineminus">-   * If none is found a new prefix is registered.</span>
<a href="#l3.1257"></a><span id="l3.1257" class="difflineminus">-   * This returns an object with keys namespaceURI, prefix, localName and qname.</span>
<a href="#l3.1258"></a><span id="l3.1258" class="difflineminus">-   * Pass null or undefined for badPrefixes for the first call.</span>
<a href="#l3.1259"></a><span id="l3.1259" class="difflineminus">-   */</span>
<a href="#l3.1260"></a><span id="l3.1260" class="difflineminus">-  _resolvePrefix(domnode, uri, badPrefixes) {</span>
<a href="#l3.1261"></a><span id="l3.1261" class="difflineminus">-    if (!badPrefixes)</span>
<a href="#l3.1262"></a><span id="l3.1262" class="difflineminus">-      badPrefixes = [];</span>
<a href="#l3.1263"></a><span id="l3.1263" class="difflineminus">-</span>
<a href="#l3.1264"></a><span id="l3.1264" class="difflineminus">-    // No known prefix, try to create one from the lookup list</span>
<a href="#l3.1265"></a><span id="l3.1265" class="difflineminus">-    if (!domnode || isDocument(domnode)) {</span>
<a href="#l3.1266"></a><span id="l3.1266" class="difflineminus">-      for (let i in this._prefixes) {</span>
<a href="#l3.1267"></a><span id="l3.1267" class="difflineminus">-        if (badPrefixes.includes(i))</span>
<a href="#l3.1268"></a><span id="l3.1268" class="difflineminus">-          continue;</span>
<a href="#l3.1269"></a><span id="l3.1269" class="difflineminus">-        if (this._prefixes[i] == uri.substring(0, this._prefixes[i].length)) {</span>
<a href="#l3.1270"></a><span id="l3.1270" class="difflineminus">-          var local = uri.substring(this._prefixes[i].length);</span>
<a href="#l3.1271"></a><span id="l3.1271" class="difflineminus">-          var test = URI_SUFFIX.exec(local);</span>
<a href="#l3.1272"></a><span id="l3.1272" class="difflineminus">-          // Remaining part of uri is a good XML Name</span>
<a href="#l3.1273"></a><span id="l3.1273" class="difflineminus">-          if (test &amp;&amp; test[0] == local) {</span>
<a href="#l3.1274"></a><span id="l3.1274" class="difflineminus">-            this._document.documentElement.setAttributeNS(NS_XMLNS, `xmlns:${i}`, this._prefixes[i]);</span>
<a href="#l3.1275"></a><span id="l3.1275" class="difflineminus">-            return {</span>
<a href="#l3.1276"></a><span id="l3.1276" class="difflineminus">-              namespaceURI: this._prefixes[i],</span>
<a href="#l3.1277"></a><span id="l3.1277" class="difflineminus">-              prefix: i,</span>
<a href="#l3.1278"></a><span id="l3.1278" class="difflineminus">-              localName: local,</span>
<a href="#l3.1279"></a><span id="l3.1279" class="difflineminus">-              qname: i ? `${i}:${local}` : local,</span>
<a href="#l3.1280"></a><span id="l3.1280" class="difflineminus">-            };</span>
<a href="#l3.1281"></a><span id="l3.1281" class="difflineminus">-          }</span>
<a href="#l3.1282"></a><span id="l3.1282" class="difflineminus">-        }</span>
<a href="#l3.1283"></a><span id="l3.1283" class="difflineminus">-      }</span>
<a href="#l3.1284"></a><span id="l3.1284" class="difflineminus">-</span>
<a href="#l3.1285"></a><span id="l3.1285" class="difflineminus">-      // No match, make something up</span>
<a href="#l3.1286"></a><span id="l3.1286" class="difflineminus">-      test = URI_SUFFIX.exec(uri);</span>
<a href="#l3.1287"></a><span id="l3.1287" class="difflineminus">-      if (test) {</span>
<a href="#l3.1288"></a><span id="l3.1288" class="difflineminus">-        var namespaceURI = uri.substring(0, uri.length - test[0].length);</span>
<a href="#l3.1289"></a><span id="l3.1289" class="difflineminus">-        local = test[0];</span>
<a href="#l3.1290"></a><span id="l3.1290" class="difflineminus">-        let i = 1;</span>
<a href="#l3.1291"></a><span id="l3.1291" class="difflineminus">-        while (badPrefixes.includes(`NS${i}`))</span>
<a href="#l3.1292"></a><span id="l3.1292" class="difflineminus">-          i++;</span>
<a href="#l3.1293"></a><span id="l3.1293" class="difflineminus">-        this._document.documentElement.setAttributeNS(NS_XMLNS, `xmlns:NS${i}`, namespaceURI);</span>
<a href="#l3.1294"></a><span id="l3.1294" class="difflineminus">-        return {</span>
<a href="#l3.1295"></a><span id="l3.1295" class="difflineminus">-          namespaceURI,</span>
<a href="#l3.1296"></a><span id="l3.1296" class="difflineminus">-          prefix: `NS${i}`,</span>
<a href="#l3.1297"></a><span id="l3.1297" class="difflineminus">-          localName: local,</span>
<a href="#l3.1298"></a><span id="l3.1298" class="difflineminus">-          qname: `NS${i}:${local}`,</span>
<a href="#l3.1299"></a><span id="l3.1299" class="difflineminus">-        };</span>
<a href="#l3.1300"></a><span id="l3.1300" class="difflineminus">-      }</span>
<a href="#l3.1301"></a><span id="l3.1301" class="difflineminus">-      // There is no end part of this URI that is an XML Name</span>
<a href="#l3.1302"></a><span id="l3.1302" class="difflineminus">-      throw new Error(`invalid node name: ${uri}`);</span>
<a href="#l3.1303"></a><span id="l3.1303" class="difflineminus">-    }</span>
<a href="#l3.1304"></a><span id="l3.1304" class="difflineminus">-</span>
<a href="#l3.1305"></a><span id="l3.1305" class="difflineminus">-    for (let attr of domnode.attributes) {</span>
<a href="#l3.1306"></a><span id="l3.1306" class="difflineminus">-      // Not a namespace declaration, ignore this attribute</span>
<a href="#l3.1307"></a><span id="l3.1307" class="difflineminus">-      if (attr.namespaceURI != NS_XMLNS &amp;&amp; attr.nodeName != &quot;xmlns&quot;)</span>
<a href="#l3.1308"></a><span id="l3.1308" class="difflineminus">-        continue;</span>
<a href="#l3.1309"></a><span id="l3.1309" class="difflineminus">-</span>
<a href="#l3.1310"></a><span id="l3.1310" class="difflineminus">-      var prefix = attr.prefix ? attr.localName : &quot;&quot;;</span>
<a href="#l3.1311"></a><span id="l3.1311" class="difflineminus">-      // Seen this prefix before, cannot use it</span>
<a href="#l3.1312"></a><span id="l3.1312" class="difflineminus">-      if (badPrefixes.includes(prefix))</span>
<a href="#l3.1313"></a><span id="l3.1313" class="difflineminus">-        continue;</span>
<a href="#l3.1314"></a><span id="l3.1314" class="difflineminus">-</span>
<a href="#l3.1315"></a><span id="l3.1315" class="difflineminus">-      // Namespace matches the start of the uri</span>
<a href="#l3.1316"></a><span id="l3.1316" class="difflineminus">-      if (attr.value == uri.substring(0, attr.value.length)) {</span>
<a href="#l3.1317"></a><span id="l3.1317" class="difflineminus">-        local = uri.substring(attr.value.length);</span>
<a href="#l3.1318"></a><span id="l3.1318" class="difflineminus">-        test = URI_SUFFIX.exec(local);</span>
<a href="#l3.1319"></a><span id="l3.1319" class="difflineminus">-        // Remaining part of uri is a good XML Name</span>
<a href="#l3.1320"></a><span id="l3.1320" class="difflineminus">-        if (test &amp;&amp; test[0] == local) {</span>
<a href="#l3.1321"></a><span id="l3.1321" class="difflineminus">-          return {</span>
<a href="#l3.1322"></a><span id="l3.1322" class="difflineminus">-            namespaceURI: attr.value,</span>
<a href="#l3.1323"></a><span id="l3.1323" class="difflineminus">-            prefix,</span>
<a href="#l3.1324"></a><span id="l3.1324" class="difflineminus">-            localName: local,</span>
<a href="#l3.1325"></a><span id="l3.1325" class="difflineminus">-            qname: prefix ? `${prefix}:${local}` : local,</span>
<a href="#l3.1326"></a><span id="l3.1326" class="difflineminus">-          };</span>
<a href="#l3.1327"></a><span id="l3.1327" class="difflineminus">-        }</span>
<a href="#l3.1328"></a><span id="l3.1328" class="difflineminus">-      }</span>
<a href="#l3.1329"></a><span id="l3.1329" class="difflineminus">-</span>
<a href="#l3.1330"></a><span id="l3.1330" class="difflineminus">-      badPrefixes.push(prefix);</span>
<a href="#l3.1331"></a><span id="l3.1331" class="difflineminus">-    }</span>
<a href="#l3.1332"></a><span id="l3.1332" class="difflineminus">-</span>
<a href="#l3.1333"></a><span id="l3.1333" class="difflineminus">-    // No prefix found here, move up the document</span>
<a href="#l3.1334"></a><span id="l3.1334" class="difflineminus">-    return this._resolvePrefix(domnode.parentNode, uri, badPrefixes);</span>
<a href="#l3.1335"></a><span id="l3.1335" class="difflineminus">-  }</span>
<a href="#l3.1336"></a><span id="l3.1336" class="difflineminus">-</span>
<a href="#l3.1337"></a><span id="l3.1337" class="difflineminus">-  /**</span>
<a href="#l3.1338"></a><span id="l3.1338" class="difflineminus">-   * Guess the indent level within the given Element. The method looks for</span>
<a href="#l3.1339"></a><span id="l3.1339" class="difflineminus">-   * elements that are preceded by whitespace including a newline. The</span>
<a href="#l3.1340"></a><span id="l3.1340" class="difflineminus">-   * whitespace following the newline is presumed to be the indentation for the</span>
<a href="#l3.1341"></a><span id="l3.1341" class="difflineminus">-   * element.</span>
<a href="#l3.1342"></a><span id="l3.1342" class="difflineminus">-   * If the indentation cannot be guessed then it recurses up the document</span>
<a href="#l3.1343"></a><span id="l3.1343" class="difflineminus">-   * hierarchy until it can guess the indent or until the Document is reached.</span>
<a href="#l3.1344"></a><span id="l3.1344" class="difflineminus">-   */</span>
<a href="#l3.1345"></a><span id="l3.1345" class="difflineminus">-  _guessIndent(element) {</span>
<a href="#l3.1346"></a><span id="l3.1346" class="difflineminus">-    // The indent at document level is 0</span>
<a href="#l3.1347"></a><span id="l3.1347" class="difflineminus">-    if (!element || isDocument(element))</span>
<a href="#l3.1348"></a><span id="l3.1348" class="difflineminus">-      return &quot;&quot;;</span>
<a href="#l3.1349"></a><span id="l3.1349" class="difflineminus">-</span>
<a href="#l3.1350"></a><span id="l3.1350" class="difflineminus">-    // Check the text immediately preceding each child node. One could be</span>
<a href="#l3.1351"></a><span id="l3.1351" class="difflineminus">-    // a valid indent</span>
<a href="#l3.1352"></a><span id="l3.1352" class="difflineminus">-    var pretext = &quot;&quot;;</span>
<a href="#l3.1353"></a><span id="l3.1353" class="difflineminus">-    var child = element.firstChild;</span>
<a href="#l3.1354"></a><span id="l3.1354" class="difflineminus">-    while (child) {</span>
<a href="#l3.1355"></a><span id="l3.1355" class="difflineminus">-      if (isText(child)) {</span>
<a href="#l3.1356"></a><span id="l3.1356" class="difflineminus">-        pretext += child.nodeValue;</span>
<a href="#l3.1357"></a><span id="l3.1357" class="difflineminus">-      } else if (isElement(child)) {</span>
<a href="#l3.1358"></a><span id="l3.1358" class="difflineminus">-        var result = INDENT.exec(pretext);</span>
<a href="#l3.1359"></a><span id="l3.1359" class="difflineminus">-        if (result)</span>
<a href="#l3.1360"></a><span id="l3.1360" class="difflineminus">-          return result[1];</span>
<a href="#l3.1361"></a><span id="l3.1361" class="difflineminus">-        pretext = &quot;&quot;;</span>
<a href="#l3.1362"></a><span id="l3.1362" class="difflineminus">-      }</span>
<a href="#l3.1363"></a><span id="l3.1363" class="difflineminus">-      child = child.nextSibling;</span>
<a href="#l3.1364"></a><span id="l3.1364" class="difflineminus">-    }</span>
<a href="#l3.1365"></a><span id="l3.1365" class="difflineminus">-</span>
<a href="#l3.1366"></a><span id="l3.1366" class="difflineminus">-    // pretext now contains any trailing text in the element. This can be</span>
<a href="#l3.1367"></a><span id="l3.1367" class="difflineminus">-    // the indent of the end tag. If so add a little to it.</span>
<a href="#l3.1368"></a><span id="l3.1368" class="difflineminus">-    result = INDENT.exec(pretext);</span>
<a href="#l3.1369"></a><span id="l3.1369" class="difflineminus">-    if (result)</span>
<a href="#l3.1370"></a><span id="l3.1370" class="difflineminus">-      return `${result[1]}  `;</span>
<a href="#l3.1371"></a><span id="l3.1371" class="difflineminus">-</span>
<a href="#l3.1372"></a><span id="l3.1372" class="difflineminus">-    // Check the text immediately before this node</span>
<a href="#l3.1373"></a><span id="l3.1373" class="difflineminus">-    pretext = &quot;&quot;;</span>
<a href="#l3.1374"></a><span id="l3.1374" class="difflineminus">-    var sibling = element.previousSibling;</span>
<a href="#l3.1375"></a><span id="l3.1375" class="difflineminus">-    while (sibling &amp;&amp; isText(sibling)) {</span>
<a href="#l3.1376"></a><span id="l3.1376" class="difflineminus">-      pretext += sibling.nodeValue;</span>
<a href="#l3.1377"></a><span id="l3.1377" class="difflineminus">-      sibling = sibling.previousSibling;</span>
<a href="#l3.1378"></a><span id="l3.1378" class="difflineminus">-    }</span>
<a href="#l3.1379"></a><span id="l3.1379" class="difflineminus">-</span>
<a href="#l3.1380"></a><span id="l3.1380" class="difflineminus">-    // If there is a sensible indent then just add to it.</span>
<a href="#l3.1381"></a><span id="l3.1381" class="difflineminus">-    result = INDENT.exec(pretext);</span>
<a href="#l3.1382"></a><span id="l3.1382" class="difflineminus">-    if (result)</span>
<a href="#l3.1383"></a><span id="l3.1383" class="difflineminus">-      return `${result[1]}  `;</span>
<a href="#l3.1384"></a><span id="l3.1384" class="difflineminus">-</span>
<a href="#l3.1385"></a><span id="l3.1385" class="difflineminus">-    // Last chance, get the indent level for the tag above and add to it</span>
<a href="#l3.1386"></a><span id="l3.1386" class="difflineminus">-    return `${this._guessIndent(element.parentNode)}  `;</span>
<a href="#l3.1387"></a><span id="l3.1387" class="difflineminus">-  }</span>
<a href="#l3.1388"></a><span id="l3.1388" class="difflineminus">-</span>
<a href="#l3.1389"></a><span id="l3.1389" class="difflineminus">-  _addElement(parent, uri) {</span>
<a href="#l3.1390"></a><span id="l3.1390" class="difflineminus">-    var prefix = this._resolvePrefix(parent, uri);</span>
<a href="#l3.1391"></a><span id="l3.1391" class="difflineminus">-    var element = this._document.createElementNS(prefix.namespaceURI, prefix.qname);</span>
<a href="#l3.1392"></a><span id="l3.1392" class="difflineminus">-</span>
<a href="#l3.1393"></a><span id="l3.1393" class="difflineminus">-    if (parent.lastChild) {</span>
<a href="#l3.1394"></a><span id="l3.1394" class="difflineminus">-      // We want to insert immediately after the last child element</span>
<a href="#l3.1395"></a><span id="l3.1395" class="difflineminus">-      var last = parent.lastChild;</span>
<a href="#l3.1396"></a><span id="l3.1396" class="difflineminus">-      while (last &amp;&amp; isText(last))</span>
<a href="#l3.1397"></a><span id="l3.1397" class="difflineminus">-        last = last.previousSibling;</span>
<a href="#l3.1398"></a><span id="l3.1398" class="difflineminus">-      // No child elements so insert at the start</span>
<a href="#l3.1399"></a><span id="l3.1399" class="difflineminus">-      if (!last)</span>
<a href="#l3.1400"></a><span id="l3.1400" class="difflineminus">-        last = parent.firstChild;</span>
<a href="#l3.1401"></a><span id="l3.1401" class="difflineminus">-      else</span>
<a href="#l3.1402"></a><span id="l3.1402" class="difflineminus">-        last = last.nextSibling;</span>
<a href="#l3.1403"></a><span id="l3.1403" class="difflineminus">-</span>
<a href="#l3.1404"></a><span id="l3.1404" class="difflineminus">-      let indent = this._guessIndent(parent);</span>
<a href="#l3.1405"></a><span id="l3.1405" class="difflineminus">-      parent.insertBefore(this._document.createTextNode(`\n${indent}`), last);</span>
<a href="#l3.1406"></a><span id="l3.1406" class="difflineminus">-      parent.insertBefore(element, last);</span>
<a href="#l3.1407"></a><span id="l3.1407" class="difflineminus">-    } else {</span>
<a href="#l3.1408"></a><span id="l3.1408" class="difflineminus">-      // No children, must indent our element and the end tag</span>
<a href="#l3.1409"></a><span id="l3.1409" class="difflineminus">-      let indent = this._guessIndent(parent.parentNode);</span>
<a href="#l3.1410"></a><span id="l3.1410" class="difflineminus">-      parent.append(`\n${indent}  `, element, `\n${indent}`);</span>
<a href="#l3.1411"></a><span id="l3.1411" class="difflineminus">-    }</span>
<a href="#l3.1412"></a><span id="l3.1412" class="difflineminus">-    return element;</span>
<a href="#l3.1413"></a><span id="l3.1413" class="difflineminus">-  }</span>
<a href="#l3.1414"></a><span id="l3.1414" class="difflineminus">-</span>
<a href="#l3.1415"></a><span id="l3.1415" class="difflineminus">-  /**</span>
<a href="#l3.1416"></a><span id="l3.1416" class="difflineminus">-   * Removes the element from its parent. Should also remove surrounding</span>
<a href="#l3.1417"></a><span id="l3.1417" class="difflineminus">-   * white space as appropriate.</span>
<a href="#l3.1418"></a><span id="l3.1418" class="difflineminus">-   */</span>
<a href="#l3.1419"></a><span id="l3.1419" class="difflineminus">-  _removeElement(element) {</span>
<a href="#l3.1420"></a><span id="l3.1420" class="difflineminus">-    var parent = element.parentNode;</span>
<a href="#l3.1421"></a><span id="l3.1421" class="difflineminus">-    var sibling = element.previousSibling;</span>
<a href="#l3.1422"></a><span id="l3.1422" class="difflineminus">-    // Drop any text nodes immediately preceding the element</span>
<a href="#l3.1423"></a><span id="l3.1423" class="difflineminus">-    while (sibling &amp;&amp; isText(sibling)) {</span>
<a href="#l3.1424"></a><span id="l3.1424" class="difflineminus">-      var temp = sibling;</span>
<a href="#l3.1425"></a><span id="l3.1425" class="difflineminus">-      sibling = sibling.previousSibling;</span>
<a href="#l3.1426"></a><span id="l3.1426" class="difflineminus">-      parent.removeChild(temp);</span>
<a href="#l3.1427"></a><span id="l3.1427" class="difflineminus">-    }</span>
<a href="#l3.1428"></a><span id="l3.1428" class="difflineminus">-</span>
<a href="#l3.1429"></a><span id="l3.1429" class="difflineminus">-    sibling = element.nextSibling;</span>
<a href="#l3.1430"></a><span id="l3.1430" class="difflineminus">-    // Drop the element</span>
<a href="#l3.1431"></a><span id="l3.1431" class="difflineminus">-    parent.removeChild(element);</span>
<a href="#l3.1432"></a><span id="l3.1432" class="difflineminus">-</span>
<a href="#l3.1433"></a><span id="l3.1433" class="difflineminus">-    // If the next node after element is now the first child then element was</span>
<a href="#l3.1434"></a><span id="l3.1434" class="difflineminus">-    // the first child. If there are no other child elements then remove the</span>
<a href="#l3.1435"></a><span id="l3.1435" class="difflineminus">-    // remaining child nodes.</span>
<a href="#l3.1436"></a><span id="l3.1436" class="difflineminus">-    if (parent.firstChild == sibling) {</span>
<a href="#l3.1437"></a><span id="l3.1437" class="difflineminus">-      while (sibling &amp;&amp; isText(sibling))</span>
<a href="#l3.1438"></a><span id="l3.1438" class="difflineminus">-        sibling = sibling.nextSibling;</span>
<a href="#l3.1439"></a><span id="l3.1439" class="difflineminus">-      if (!sibling) {</span>
<a href="#l3.1440"></a><span id="l3.1440" class="difflineminus">-        // No other child elements</span>
<a href="#l3.1441"></a><span id="l3.1441" class="difflineminus">-        while (parent.lastChild)</span>
<a href="#l3.1442"></a><span id="l3.1442" class="difflineminus">-          parent.removeChild(parent.lastChild);</span>
<a href="#l3.1443"></a><span id="l3.1443" class="difflineminus">-      }</span>
<a href="#l3.1444"></a><span id="l3.1444" class="difflineminus">-    }</span>
<a href="#l3.1445"></a><span id="l3.1445" class="difflineminus">-  }</span>
<a href="#l3.1446"></a><span id="l3.1446" class="difflineminus">-</span>
<a href="#l3.1447"></a><span id="l3.1447" class="difflineminus">-  /**</span>
<a href="#l3.1448"></a><span id="l3.1448" class="difflineminus">-   * Requests that a given prefix be used for the namespace where possible.</span>
<a href="#l3.1449"></a><span id="l3.1449" class="difflineminus">-   * This must be called before any assertions are made using the namespace</span>
<a href="#l3.1450"></a><span id="l3.1450" class="difflineminus">-   * and the registration will not override any existing prefix used in the</span>
<a href="#l3.1451"></a><span id="l3.1451" class="difflineminus">-   * document.</span>
<a href="#l3.1452"></a><span id="l3.1452" class="difflineminus">-   */</span>
<a href="#l3.1453"></a><span id="l3.1453" class="difflineminus">-  registerPrefix(prefix, namespaceURI) {</span>
<a href="#l3.1454"></a><span id="l3.1454" class="difflineminus">-    this._prefixes[prefix] = namespaceURI;</span>
<a href="#l3.1455"></a><span id="l3.1455" class="difflineminus">-  }</span>
<a href="#l3.1456"></a><span id="l3.1456" class="difflineminus">-</span>
<a href="#l3.1457"></a><span id="l3.1457" class="difflineminus">-  /**</span>
<a href="#l3.1458"></a><span id="l3.1458" class="difflineminus">-   * Gets a blank node. nodeID may be null and if so a new blank node is created.</span>
<a href="#l3.1459"></a><span id="l3.1459" class="difflineminus">-   * If a nodeID is given then the blank node with that ID is returned or created.</span>
<a href="#l3.1460"></a><span id="l3.1460" class="difflineminus">-   */</span>
<a href="#l3.1461"></a><span id="l3.1461" class="difflineminus">-  getBlankNode(nodeID) {</span>
<a href="#l3.1462"></a><span id="l3.1462" class="difflineminus">-    if (nodeID &amp;&amp; nodeID in this._blankNodes)</span>
<a href="#l3.1463"></a><span id="l3.1463" class="difflineminus">-      return this._blankNodes[nodeID];</span>
<a href="#l3.1464"></a><span id="l3.1464" class="difflineminus">-</span>
<a href="#l3.1465"></a><span id="l3.1465" class="difflineminus">-    if (nodeID &amp;&amp; !nodeID.match(XML_NCNAME))</span>
<a href="#l3.1466"></a><span id="l3.1466" class="difflineminus">-      throw new Error(&quot;rdf:nodeID must be a valid XML name&quot;);</span>
<a href="#l3.1467"></a><span id="l3.1467" class="difflineminus">-</span>
<a href="#l3.1468"></a><span id="l3.1468" class="difflineminus">-    var rdfnode = new RDFBlankNode(this, nodeID);</span>
<a href="#l3.1469"></a><span id="l3.1469" class="difflineminus">-    this._allBlankNodes.push(rdfnode);</span>
<a href="#l3.1470"></a><span id="l3.1470" class="difflineminus">-    if (nodeID)</span>
<a href="#l3.1471"></a><span id="l3.1471" class="difflineminus">-      this._blankNodes[nodeID] = rdfnode;</span>
<a href="#l3.1472"></a><span id="l3.1472" class="difflineminus">-    return rdfnode;</span>
<a href="#l3.1473"></a><span id="l3.1473" class="difflineminus">-  }</span>
<a href="#l3.1474"></a><span id="l3.1474" class="difflineminus">-</span>
<a href="#l3.1475"></a><span id="l3.1475" class="difflineminus">-  /**</span>
<a href="#l3.1476"></a><span id="l3.1476" class="difflineminus">-   * Gets all blank nodes</span>
<a href="#l3.1477"></a><span id="l3.1477" class="difflineminus">-   */</span>
<a href="#l3.1478"></a><span id="l3.1478" class="difflineminus">-  getAllBlankNodes() {</span>
<a href="#l3.1479"></a><span id="l3.1479" class="difflineminus">-    return this._allBlankNodes.slice();</span>
<a href="#l3.1480"></a><span id="l3.1480" class="difflineminus">-  }</span>
<a href="#l3.1481"></a><span id="l3.1481" class="difflineminus">-</span>
<a href="#l3.1482"></a><span id="l3.1482" class="difflineminus">-  /**</span>
<a href="#l3.1483"></a><span id="l3.1483" class="difflineminus">-   * Gets the resource for the URI. The resource is created if it has not been</span>
<a href="#l3.1484"></a><span id="l3.1484" class="difflineminus">-   * used already.</span>
<a href="#l3.1485"></a><span id="l3.1485" class="difflineminus">-   */</span>
<a href="#l3.1486"></a><span id="l3.1486" class="difflineminus">-  getResource(uri) {</span>
<a href="#l3.1487"></a><span id="l3.1487" class="difflineminus">-    if (uri in this._resources)</span>
<a href="#l3.1488"></a><span id="l3.1488" class="difflineminus">-      return this._resources[uri];</span>
<a href="#l3.1489"></a><span id="l3.1489" class="difflineminus">-</span>
<a href="#l3.1490"></a><span id="l3.1490" class="difflineminus">-    var resource = new RDFResource(this, uri);</span>
<a href="#l3.1491"></a><span id="l3.1491" class="difflineminus">-    this._resources[uri] = resource;</span>
<a href="#l3.1492"></a><span id="l3.1492" class="difflineminus">-    return resource;</span>
<a href="#l3.1493"></a><span id="l3.1493" class="difflineminus">-  }</span>
<a href="#l3.1494"></a><span id="l3.1494" class="difflineminus">-</span>
<a href="#l3.1495"></a><span id="l3.1495" class="difflineminus">-  /**</span>
<a href="#l3.1496"></a><span id="l3.1496" class="difflineminus">-   * Gets all resources that have been used.</span>
<a href="#l3.1497"></a><span id="l3.1497" class="difflineminus">-   */</span>
<a href="#l3.1498"></a><span id="l3.1498" class="difflineminus">-  getAllResources() {</span>
<a href="#l3.1499"></a><span id="l3.1499" class="difflineminus">-    return Object.values(this._resources);</span>
<a href="#l3.1500"></a><span id="l3.1500" class="difflineminus">-  }</span>
<a href="#l3.1501"></a><span id="l3.1501" class="difflineminus">-</span>
<a href="#l3.1502"></a><span id="l3.1502" class="difflineminus">-  /**</span>
<a href="#l3.1503"></a><span id="l3.1503" class="difflineminus">-   * Returns all blank nodes and resources</span>
<a href="#l3.1504"></a><span id="l3.1504" class="difflineminus">-   */</span>
<a href="#l3.1505"></a><span id="l3.1505" class="difflineminus">-  getAllSubjects() {</span>
<a href="#l3.1506"></a><span id="l3.1506" class="difflineminus">-    return [...Object.values(this._resources),</span>
<a href="#l3.1507"></a><span id="l3.1507" class="difflineminus">-            ...this._allBlankNodes];</span>
<a href="#l3.1508"></a><span id="l3.1508" class="difflineminus">-  }</span>
<a href="#l3.1509"></a><span id="l3.1509" class="difflineminus">-</span>
<a href="#l3.1510"></a><span id="l3.1510" class="difflineminus">-  /**</span>
<a href="#l3.1511"></a><span id="l3.1511" class="difflineminus">-   * Saves the RDF/XML to a string.</span>
<a href="#l3.1512"></a><span id="l3.1512" class="difflineminus">-   */</span>
<a href="#l3.1513"></a><span id="l3.1513" class="difflineminus">-  serializeToString() {</span>
<a href="#l3.1514"></a><span id="l3.1514" class="difflineminus">-    var serializer = new XMLSerializer();</span>
<a href="#l3.1515"></a><span id="l3.1515" class="difflineminus">-    return serializer.serializeToString(this._document);</span>
<a href="#l3.1516"></a><span id="l3.1516" class="difflineminus">-  }</span>
<a href="#l3.1517"></a><span id="l3.1517" class="difflineminus">-</span>
<a href="#l3.1518"></a><span id="l3.1518" class="difflineminus">-  /**</span>
<a href="#l3.1519"></a><span id="l3.1519" class="difflineminus">-   * Saves the RDF/XML to a file.</span>
<a href="#l3.1520"></a><span id="l3.1520" class="difflineminus">-   */</span>
<a href="#l3.1521"></a><span id="l3.1521" class="difflineminus">-  async saveToFile(file) {</span>
<a href="#l3.1522"></a><span id="l3.1522" class="difflineminus">-    return OS.File.writeAtomic(file, new TextEncoder().encode(this.serializeToString()));</span>
<a href="#l3.1523"></a><span id="l3.1523" class="difflineminus">-  }</span>
<a href="#l3.1524"></a><span id="l3.1524" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1">deleted file mode 100644</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineminus">--- a/common/src/RDFManifestConverter.jsm</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineplus">+++ /dev/null</span>
<a href="#l4.4"></a><span id="l4.4" class="difflineat">@@ -1,110 +0,0 @@</span>
<a href="#l4.5"></a><span id="l4.5" class="difflineminus">- /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l4.6"></a><span id="l4.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l4.7"></a><span id="l4.7" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l4.8"></a><span id="l4.8" class="difflineminus">-&quot;use strict&quot;;</span>
<a href="#l4.9"></a><span id="l4.9" class="difflineminus">-</span>
<a href="#l4.10"></a><span id="l4.10" class="difflineminus">-var EXPORTED_SYMBOLS = [&quot;InstallRDF&quot;];</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineminus">-</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-ChromeUtils.defineModuleGetter(this, &quot;RDFDataSource&quot;,</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-                               &quot;resource:///modules/RDFDataSource.jsm&quot;);</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineminus">-const RDFURI_INSTALL_MANIFEST_ROOT = &quot;urn:mozilla:install-manifest&quot;;</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineminus">-</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineminus">-function EM_R(aProperty) {</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineminus">-  return `http://www.mozilla.org/2004/em-rdf#${aProperty}`;</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineminus">-}</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineminus">-</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineminus">-function getValue(literal) {</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineminus">-  return literal &amp;&amp; literal.getValue();</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineminus">-}</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineminus">-</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineminus">-function getProperty(resource, property) {</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineminus">-  return getValue(resource.getProperty(EM_R(property)));</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineminus">-}</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineminus">-</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineminus">-class Manifest {</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineminus">-  constructor(ds) {</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">-    this.ds = ds;</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineminus">-  }</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineminus">-</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineminus">-  static loadFromString(text) {</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineminus">-    return new this(RDFDataSource.loadFromString(text));</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineminus">-  }</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineminus">-</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineminus">-  static loadFromBuffer(buffer) {</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineminus">-    return new this(RDFDataSource.loadFromBuffer(buffer));</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineminus">-  }</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineminus">-</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineminus">-  static async loadFromFile(uri) {</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineminus">-    return new this(await RDFDataSource.loadFromFile(uri));</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineminus">-  }</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineminus">-}</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineminus">-</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineminus">-class InstallRDF extends Manifest {</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineminus">-  _readProps(source, obj, props) {</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineminus">-    for (let prop of props) {</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineminus">-      let val = getProperty(source, prop);</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineminus">-      if (val != null) {</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineminus">-        obj[prop] = val;</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineminus">-      }</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineminus">-    }</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineminus">-  }</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineminus">-</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineminus">-  _readArrayProp(source, obj, prop, target, decode = getValue) {</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineminus">-    let result = Array.from(source.getObjects(EM_R(prop)),</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineminus">-                            target =&gt; decode(target));</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineminus">-    if (result.length) {</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineminus">-      obj[target] = result;</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineminus">-    }</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineminus">-  }</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineminus">-</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineminus">-  _readArrayProps(source, obj, props, decode = getValue) {</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineminus">-    for (let [prop, target] of Object.entries(props)) {</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineminus">-      this._readArrayProp(source, obj, prop, target, decode);</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineminus">-    }</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineminus">-  }</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineminus">-</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineminus">-  _readLocaleStrings(source, obj) {</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineminus">-    this._readProps(source, obj, [&quot;name&quot;, &quot;description&quot;, &quot;creator&quot;, &quot;homepageURL&quot;]);</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineminus">-    this._readArrayProps(source, obj, {</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineminus">-      locale: &quot;locales&quot;,</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineminus">-      developer: &quot;developers&quot;,</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineminus">-      translator: &quot;translators&quot;,</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineminus">-      contributor: &quot;contributors&quot;,</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineminus">-    });</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineminus">-  }</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineminus">-</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineminus">-  decode() {</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineminus">-    let root = this.ds.getResource(RDFURI_INSTALL_MANIFEST_ROOT);</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineminus">-    let result = {};</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineminus">-</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineminus">-    let props = [&quot;id&quot;, &quot;version&quot;, &quot;type&quot;, &quot;updateURL&quot;, &quot;optionsURL&quot;,</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineminus">-                 &quot;optionsType&quot;, &quot;aboutURL&quot;, &quot;iconURL&quot;,</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineminus">-                 &quot;bootstrap&quot;, &quot;unpack&quot;, &quot;strictCompatibility&quot;];</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineminus">-    this._readProps(root, result, props);</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineminus">-</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineminus">-    let decodeTargetApplication = source =&gt; {</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineminus">-      let app = {};</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineminus">-      this._readProps(source, app, [&quot;id&quot;, &quot;minVersion&quot;, &quot;maxVersion&quot;]);</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineminus">-      return app;</span>
<a href="#l4.94"></a><span id="l4.94" class="difflineminus">-    };</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineminus">-</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineminus">-    let decodeLocale = source =&gt; {</span>
<a href="#l4.97"></a><span id="l4.97" class="difflineminus">-      let localized = {};</span>
<a href="#l4.98"></a><span id="l4.98" class="difflineminus">-      this._readLocaleStrings(source, localized);</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineminus">-      return localized;</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineminus">-    };</span>
<a href="#l4.101"></a><span id="l4.101" class="difflineminus">-</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineminus">-    this._readLocaleStrings(root, result);</span>
<a href="#l4.103"></a><span id="l4.103" class="difflineminus">-</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineminus">-    this._readArrayProps(root, result, {&quot;targetPlatform&quot;: &quot;targetPlatforms&quot;});</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineminus">-    this._readArrayProps(root, result, {&quot;targetApplication&quot;: &quot;targetApplications&quot;},</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineminus">-                         decodeTargetApplication);</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineminus">-    this._readArrayProps(root, result, {&quot;localized&quot;: &quot;localized&quot;},</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineminus">-                         decodeLocale);</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineminus">-    this._readArrayProps(root, result, {&quot;dependency&quot;: &quot;dependencies&quot;},</span>
<a href="#l4.110"></a><span id="l4.110" class="difflineminus">-                         source =&gt; getProperty(source, &quot;id&quot;));</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineminus">-</span>
<a href="#l4.112"></a><span id="l4.112" class="difflineminus">-    return result;</span>
<a href="#l4.113"></a><span id="l4.113" class="difflineminus">-  }</span>
<a href="#l4.114"></a><span id="l4.114" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/common/src/moz.build</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/common/src/moz.build</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -1,20 +1,17 @@</span>
<a href="#l5.4"></a><span id="l5.4"> # vim: set filetype=python:</span>
<a href="#l5.5"></a><span id="l5.5"> # This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l5.6"></a><span id="l5.6"> # License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l5.7"></a><span id="l5.7"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l5.8"></a><span id="l5.8"> </span>
<a href="#l5.9"></a><span id="l5.9"> EXTRA_JS_MODULES += [</span>
<a href="#l5.10"></a><span id="l5.10" class="difflineminus">-    'BootstrapLoader.jsm',</span>
<a href="#l5.11"></a><span id="l5.11">     'ChromeManifest.jsm',</span>
<a href="#l5.12"></a><span id="l5.12">     'ExtensionSupport.jsm',</span>
<a href="#l5.13"></a><span id="l5.13">     'Overlays.jsm',</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineminus">-    'RDFDataSource.jsm',</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineminus">-    'RDFManifestConverter.jsm',</span>
<a href="#l5.16"></a><span id="l5.16"> ]</span>
<a href="#l5.17"></a><span id="l5.17"> </span>
<a href="#l5.18"></a><span id="l5.18"> SOURCES += [</span>
<a href="#l5.19"></a><span id="l5.19">     'nsCommonModule.cpp',</span>
<a href="#l5.20"></a><span id="l5.20">     'nsComponentManagerExtra.cpp',</span>
<a href="#l5.21"></a><span id="l5.21"> ]</span>
<a href="#l5.22"></a><span id="l5.22"> </span>
<a href="#l5.23"></a><span id="l5.23"> LOCAL_INCLUDES += [</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/common/test/xpcshell/head_addons.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/common/test/xpcshell/head_addons.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -63,29 +63,31 @@ const {</span>
<a href="#l6.4"></a><span id="l6.4">   overrideBuiltIns,</span>
<a href="#l6.5"></a><span id="l6.5">   promiseAddonEvent,</span>
<a href="#l6.6"></a><span id="l6.6">   promiseCompleteAllInstalls,</span>
<a href="#l6.7"></a><span id="l6.7">   promiseCompleteInstall,</span>
<a href="#l6.8"></a><span id="l6.8">   promiseConsoleOutput,</span>
<a href="#l6.9"></a><span id="l6.9">   promiseFindAddonUpdates,</span>
<a href="#l6.10"></a><span id="l6.10">   promiseInstallAllFiles,</span>
<a href="#l6.11"></a><span id="l6.11">   promiseInstallFile,</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+  promiseRestartManager,</span>
<a href="#l6.13"></a><span id="l6.13">   promiseSetExtensionModifiedTime,</span>
<a href="#l6.14"></a><span id="l6.14">   promiseShutdownManager,</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+  promiseStartupManager,</span>
<a href="#l6.16"></a><span id="l6.16">   promiseWebExtensionStartup,</span>
<a href="#l6.17"></a><span id="l6.17">   promiseWriteProxyFileToDir,</span>
<a href="#l6.18"></a><span id="l6.18">   registerDirectory,</span>
<a href="#l6.19"></a><span id="l6.19">   setExtensionModifiedTime,</span>
<a href="#l6.20"></a><span id="l6.20">   writeFilesToZip,</span>
<a href="#l6.21"></a><span id="l6.21"> } = AddonTestUtils;</span>
<a href="#l6.22"></a><span id="l6.22"> </span>
<a href="#l6.23"></a><span id="l6.23"> // WebExtension wrapper for ease of testing</span>
<a href="#l6.24"></a><span id="l6.24"> ExtensionTestUtils.init(this);</span>
<a href="#l6.25"></a><span id="l6.25"> </span>
<a href="#l6.26"></a><span id="l6.26" class="difflineminus">-AddonTestUtils.init(this);</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineplus">+AddonTestUtils.init(this, false);</span>
<a href="#l6.28"></a><span id="l6.28"> AddonTestUtils.overrideCertDB();</span>
<a href="#l6.29"></a><span id="l6.29"> </span>
<a href="#l6.30"></a><span id="l6.30"> XPCOMUtils.defineLazyGetter(this, &quot;BOOTSTRAP_REASONS&quot;,</span>
<a href="#l6.31"></a><span id="l6.31">                             () =&gt; AddonManagerPrivate.BOOTSTRAP_REASONS);</span>
<a href="#l6.32"></a><span id="l6.32"> </span>
<a href="#l6.33"></a><span id="l6.33"> function getReasonName(reason) {</span>
<a href="#l6.34"></a><span id="l6.34">   for (let key of Object.keys(BOOTSTRAP_REASONS)) {</span>
<a href="#l6.35"></a><span id="l6.35">     if (BOOTSTRAP_REASONS[key] == reason) {</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineat">@@ -143,28 +145,16 @@ Object.defineProperty(this, &quot;TEST_UNPACK</span>
<a href="#l6.37"></a><span id="l6.37">    return AddonTestUtils.testUnpacked = val;</span>
<a href="#l6.38"></a><span id="l6.38">   },</span>
<a href="#l6.39"></a><span id="l6.39"> });</span>
<a href="#l6.40"></a><span id="l6.40"> </span>
<a href="#l6.41"></a><span id="l6.41"> // We need some internal bits of AddonManager</span>
<a href="#l6.42"></a><span id="l6.42"> var AMscope = ChromeUtils.import(&quot;resource://gre/modules/AddonManager.jsm&quot;, null);</span>
<a href="#l6.43"></a><span id="l6.43"> var { AddonManager, AddonManagerInternal, AddonManagerPrivate } = AMscope;</span>
<a href="#l6.44"></a><span id="l6.44"> </span>
<a href="#l6.45"></a><span id="l6.45" class="difflineminus">-// Wrap the startup functions to ensure the bootstrap loader is added.</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineminus">-function promiseStartupManager(newVersion) {</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineminus">-  const {BootstrapLoader} = ChromeUtils.import(&quot;resource:///modules/BootstrapLoader.jsm&quot;);</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineminus">-  AddonManager.addExternalExtensionLoader(BootstrapLoader);</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineminus">-  return AddonTestUtils.promiseStartupManager(newVersion);</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineminus">-}</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineminus">-</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineminus">-async function promiseRestartManager(newVersion) {</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineminus">-  await promiseShutdownManager(false);</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineminus">-  await promiseStartupManager(newVersion);</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineminus">-}</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineminus">-</span>
<a href="#l6.57"></a><span id="l6.57"> const promiseAddonByID = AddonManager.getAddonByID;</span>
<a href="#l6.58"></a><span id="l6.58"> const promiseAddonsByIDs = AddonManager.getAddonsByIDs;</span>
<a href="#l6.59"></a><span id="l6.59"> </span>
<a href="#l6.60"></a><span id="l6.60"> var gPort = null;</span>
<a href="#l6.61"></a><span id="l6.61"> var gUrlToFileMap = {};</span>
<a href="#l6.62"></a><span id="l6.62"> </span>
<a href="#l6.63"></a><span id="l6.63"> // Map resource://xpcshell-data/ to the data directory</span>
<a href="#l6.64"></a><span id="l6.64"> var resHandler = Services.io.getProtocolHandler(&quot;resource&quot;)</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineat">@@ -802,111 +792,16 @@ function isThemeInAddonsList(aDir, aId) </span>
<a href="#l6.66"></a><span id="l6.66">   return AddonTestUtils.addonsList.hasTheme(aDir, aId);</span>
<a href="#l6.67"></a><span id="l6.67"> }</span>
<a href="#l6.68"></a><span id="l6.68"> </span>
<a href="#l6.69"></a><span id="l6.69"> function isExtensionInBootstrappedList(aDir, aId) {</span>
<a href="#l6.70"></a><span id="l6.70">   return AddonTestUtils.addonsList.hasExtension(aDir, aId);</span>
<a href="#l6.71"></a><span id="l6.71"> }</span>
<a href="#l6.72"></a><span id="l6.72"> </span>
<a href="#l6.73"></a><span id="l6.73"> /**</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineminus">- * Writes an install.rdf manifest into a directory using the properties passed</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineminus">- * in a JS object. The objects should contain a property for each property to</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineminus">- * appear in the RDF. The object may contain an array of objects with id,</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineminus">- * minVersion and maxVersion in the targetApplications property to give target</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineminus">- * application compatibility.</span>
<a href="#l6.79"></a><span id="l6.79" class="difflineminus">- *</span>
<a href="#l6.80"></a><span id="l6.80" class="difflineminus">- * @param   aData</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineminus">- *          The object holding data about the add-on</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineminus">- * @param   aDir</span>
<a href="#l6.83"></a><span id="l6.83" class="difflineminus">- *          The directory to add the install.rdf to</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineminus">- * @param   aId</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineminus">- *          An optional string to override the default installation aId</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineminus">- * @param   aExtraFile</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineminus">- *          An optional dummy file to create in the directory</span>
<a href="#l6.88"></a><span id="l6.88" class="difflineminus">- * @return  An nsIFile for the directory in which the add-on is installed.</span>
<a href="#l6.89"></a><span id="l6.89" class="difflineminus">- */</span>
<a href="#l6.90"></a><span id="l6.90" class="difflineminus">-async function promiseWriteInstallRDFToDir(aData, aDir, aId = aData.id, aExtraFile = null) {</span>
<a href="#l6.91"></a><span id="l6.91" class="difflineminus">-  let files = {</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineminus">-    &quot;install.rdf&quot;: createInstallRDF(aData),</span>
<a href="#l6.93"></a><span id="l6.93" class="difflineminus">-  };</span>
<a href="#l6.94"></a><span id="l6.94" class="difflineminus">-  if (typeof aExtraFile === &quot;object&quot;)</span>
<a href="#l6.95"></a><span id="l6.95" class="difflineminus">-    Object.assign(files, aExtraFile);</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineminus">-  else</span>
<a href="#l6.97"></a><span id="l6.97" class="difflineminus">-    files[aExtraFile] = &quot;&quot;;</span>
<a href="#l6.98"></a><span id="l6.98" class="difflineminus">-</span>
<a href="#l6.99"></a><span id="l6.99" class="difflineminus">-  let dir = aDir.clone();</span>
<a href="#l6.100"></a><span id="l6.100" class="difflineminus">-  dir.append(aId);</span>
<a href="#l6.101"></a><span id="l6.101" class="difflineminus">-</span>
<a href="#l6.102"></a><span id="l6.102" class="difflineminus">-  await AddonTestUtils.promiseWriteFilesToDir(dir.path, files);</span>
<a href="#l6.103"></a><span id="l6.103" class="difflineminus">-  return dir;</span>
<a href="#l6.104"></a><span id="l6.104" class="difflineminus">-}</span>
<a href="#l6.105"></a><span id="l6.105" class="difflineminus">-</span>
<a href="#l6.106"></a><span id="l6.106" class="difflineminus">-/**</span>
<a href="#l6.107"></a><span id="l6.107" class="difflineminus">- * Writes an install.rdf manifest into a packed extension using the properties passed</span>
<a href="#l6.108"></a><span id="l6.108" class="difflineminus">- * in a JS object. The objects should contain a property for each property to</span>
<a href="#l6.109"></a><span id="l6.109" class="difflineminus">- * appear in the RDF. The object may contain an array of objects with id,</span>
<a href="#l6.110"></a><span id="l6.110" class="difflineminus">- * minVersion and maxVersion in the targetApplications property to give target</span>
<a href="#l6.111"></a><span id="l6.111" class="difflineminus">- * application compatibility.</span>
<a href="#l6.112"></a><span id="l6.112" class="difflineminus">- *</span>
<a href="#l6.113"></a><span id="l6.113" class="difflineminus">- * @param   aData</span>
<a href="#l6.114"></a><span id="l6.114" class="difflineminus">- *          The object holding data about the add-on</span>
<a href="#l6.115"></a><span id="l6.115" class="difflineminus">- * @param   aDir</span>
<a href="#l6.116"></a><span id="l6.116" class="difflineminus">- *          The install directory to add the extension to</span>
<a href="#l6.117"></a><span id="l6.117" class="difflineminus">- * @param   aId</span>
<a href="#l6.118"></a><span id="l6.118" class="difflineminus">- *          An optional string to override the default installation aId</span>
<a href="#l6.119"></a><span id="l6.119" class="difflineminus">- * @param   aExtraFile</span>
<a href="#l6.120"></a><span id="l6.120" class="difflineminus">- *          An optional dummy file to create in the extension</span>
<a href="#l6.121"></a><span id="l6.121" class="difflineminus">- * @return  A file pointing to where the extension was installed</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineminus">- */</span>
<a href="#l6.123"></a><span id="l6.123" class="difflineminus">-async function promiseWriteInstallRDFToXPI(aData, aDir, aId = aData.id, aExtraFile = null) {</span>
<a href="#l6.124"></a><span id="l6.124" class="difflineminus">-  let files = {</span>
<a href="#l6.125"></a><span id="l6.125" class="difflineminus">-    &quot;install.rdf&quot;: createInstallRDF(aData),</span>
<a href="#l6.126"></a><span id="l6.126" class="difflineminus">-  };</span>
<a href="#l6.127"></a><span id="l6.127" class="difflineminus">-  if (typeof aExtraFile === &quot;object&quot;)</span>
<a href="#l6.128"></a><span id="l6.128" class="difflineminus">-    Object.assign(files, aExtraFile);</span>
<a href="#l6.129"></a><span id="l6.129" class="difflineminus">-  else</span>
<a href="#l6.130"></a><span id="l6.130" class="difflineminus">-  if (aExtraFile)</span>
<a href="#l6.131"></a><span id="l6.131" class="difflineminus">-    files[aExtraFile] = &quot;&quot;;</span>
<a href="#l6.132"></a><span id="l6.132" class="difflineminus">-</span>
<a href="#l6.133"></a><span id="l6.133" class="difflineminus">-  if (!aDir.exists())</span>
<a href="#l6.134"></a><span id="l6.134" class="difflineminus">-    aDir.create(Ci.nsIFile.DIRECTORY_TYPE, FileUtils.PERMS_DIRECTORY);</span>
<a href="#l6.135"></a><span id="l6.135" class="difflineminus">-</span>
<a href="#l6.136"></a><span id="l6.136" class="difflineminus">-  var file = aDir.clone();</span>
<a href="#l6.137"></a><span id="l6.137" class="difflineminus">-  file.append(`${aId}.xpi`);</span>
<a href="#l6.138"></a><span id="l6.138" class="difflineminus">-</span>
<a href="#l6.139"></a><span id="l6.139" class="difflineminus">-  AddonTestUtils.writeFilesToZip(file.path, files);</span>
<a href="#l6.140"></a><span id="l6.140" class="difflineminus">-</span>
<a href="#l6.141"></a><span id="l6.141" class="difflineminus">-  return file;</span>
<a href="#l6.142"></a><span id="l6.142" class="difflineminus">-}</span>
<a href="#l6.143"></a><span id="l6.143" class="difflineminus">-</span>
<a href="#l6.144"></a><span id="l6.144" class="difflineminus">-/**</span>
<a href="#l6.145"></a><span id="l6.145" class="difflineminus">- * Writes an install.rdf manifest into an extension using the properties passed</span>
<a href="#l6.146"></a><span id="l6.146" class="difflineminus">- * in a JS object. The objects should contain a property for each property to</span>
<a href="#l6.147"></a><span id="l6.147" class="difflineminus">- * appear in the RDF. The object may contain an array of objects with id,</span>
<a href="#l6.148"></a><span id="l6.148" class="difflineminus">- * minVersion and maxVersion in the targetApplications property to give target</span>
<a href="#l6.149"></a><span id="l6.149" class="difflineminus">- * application compatibility.</span>
<a href="#l6.150"></a><span id="l6.150" class="difflineminus">- *</span>
<a href="#l6.151"></a><span id="l6.151" class="difflineminus">- * @param   aData</span>
<a href="#l6.152"></a><span id="l6.152" class="difflineminus">- *          The object holding data about the add-on</span>
<a href="#l6.153"></a><span id="l6.153" class="difflineminus">- * @param   aDir</span>
<a href="#l6.154"></a><span id="l6.154" class="difflineminus">- *          The install directory to add the extension to</span>
<a href="#l6.155"></a><span id="l6.155" class="difflineminus">- * @param   aId</span>
<a href="#l6.156"></a><span id="l6.156" class="difflineminus">- *          An optional string to override the default installation aId</span>
<a href="#l6.157"></a><span id="l6.157" class="difflineminus">- * @param   aExtraFile</span>
<a href="#l6.158"></a><span id="l6.158" class="difflineminus">- *          An optional dummy file to create in the extension</span>
<a href="#l6.159"></a><span id="l6.159" class="difflineminus">- * @return  A file pointing to where the extension was installed</span>
<a href="#l6.160"></a><span id="l6.160" class="difflineminus">- */</span>
<a href="#l6.161"></a><span id="l6.161" class="difflineminus">-function promiseWriteInstallRDFForExtension(aData, aDir, aId, aExtraFile) {</span>
<a href="#l6.162"></a><span id="l6.162" class="difflineminus">-  if (TEST_UNPACKED) {</span>
<a href="#l6.163"></a><span id="l6.163" class="difflineminus">-    return promiseWriteInstallRDFToDir(aData, aDir, aId, aExtraFile);</span>
<a href="#l6.164"></a><span id="l6.164" class="difflineminus">-  }</span>
<a href="#l6.165"></a><span id="l6.165" class="difflineminus">-  return promiseWriteInstallRDFToXPI(aData, aDir, aId, aExtraFile);</span>
<a href="#l6.166"></a><span id="l6.166" class="difflineminus">-}</span>
<a href="#l6.167"></a><span id="l6.167" class="difflineminus">-</span>
<a href="#l6.168"></a><span id="l6.168" class="difflineminus">-/**</span>
<a href="#l6.169"></a><span id="l6.169">  * Writes a manifest.json manifest into an extension using the properties passed</span>
<a href="#l6.170"></a><span id="l6.170">  * in a JS object.</span>
<a href="#l6.171"></a><span id="l6.171">  *</span>
<a href="#l6.172"></a><span id="l6.172">  * @param   aManifest</span>
<a href="#l6.173"></a><span id="l6.173">  *          The data to write</span>
<a href="#l6.174"></a><span id="l6.174">  * @param   aDir</span>
<a href="#l6.175"></a><span id="l6.175">  *          The install directory to add the extension to</span>
<a href="#l6.176"></a><span id="l6.176">  * @param   aId</span>
<a href="#l6.177"></a><span id="l6.177" class="difflineat">@@ -935,20 +830,16 @@ function createTempXPIFile(aData, aExtra</span>
<a href="#l6.178"></a><span id="l6.178">   if (typeof aExtraFile == &quot;object&quot;)</span>
<a href="#l6.179"></a><span id="l6.179">     Object.assign(files, aExtraFile);</span>
<a href="#l6.180"></a><span id="l6.180">   else if (aExtraFile)</span>
<a href="#l6.181"></a><span id="l6.181">     files[aExtraFile] = &quot;&quot;;</span>
<a href="#l6.182"></a><span id="l6.182"> </span>
<a href="#l6.183"></a><span id="l6.183">   return AddonTestUtils.createTempXPIFile(files);</span>
<a href="#l6.184"></a><span id="l6.184"> }</span>
<a href="#l6.185"></a><span id="l6.185"> </span>
<a href="#l6.186"></a><span id="l6.186" class="difflineminus">-function promiseInstallXPI(installRDF) {</span>
<a href="#l6.187"></a><span id="l6.187" class="difflineminus">-  return AddonTestUtils.promiseInstallXPI({&quot;install.rdf&quot;: installRDF});</span>
<a href="#l6.188"></a><span id="l6.188" class="difflineminus">-}</span>
<a href="#l6.189"></a><span id="l6.189" class="difflineminus">-</span>
<a href="#l6.190"></a><span id="l6.190"> var gExpectedEvents = {};</span>
<a href="#l6.191"></a><span id="l6.191"> var gExpectedInstalls = [];</span>
<a href="#l6.192"></a><span id="l6.192"> var gNext = null;</span>
<a href="#l6.193"></a><span id="l6.193"> </span>
<a href="#l6.194"></a><span id="l6.194"> function getExpectedEvent(aId) {</span>
<a href="#l6.195"></a><span id="l6.195">   if (!(aId in gExpectedEvents))</span>
<a href="#l6.196"></a><span id="l6.196">     do_throw(&quot;Wasn't expecting events for &quot; + aId);</span>
<a href="#l6.197"></a><span id="l6.197">   if (gExpectedEvents[aId].length == 0)</span>
<a href="#l6.198"></a><span id="l6.198" class="difflineat">@@ -1438,60 +1329,8 @@ function _writeArrayProps(obj, props, in</span>
<a href="#l6.199"></a><span id="l6.199"> function _writeLocaleStrings(data) {</span>
<a href="#l6.200"></a><span id="l6.200">   let items = [];</span>
<a href="#l6.201"></a><span id="l6.201"> </span>
<a href="#l6.202"></a><span id="l6.202">   items.push(this._writeProps(data, [&quot;name&quot;, &quot;description&quot;, &quot;creator&quot;, &quot;homepageURL&quot;]));</span>
<a href="#l6.203"></a><span id="l6.203">   items.push(this._writeArrayProps(data, [&quot;developer&quot;, &quot;translator&quot;, &quot;contributor&quot;]));</span>
<a href="#l6.204"></a><span id="l6.204"> </span>
<a href="#l6.205"></a><span id="l6.205">   return items.join(&quot;&quot;);</span>
<a href="#l6.206"></a><span id="l6.206"> }</span>
<a href="#l6.207"></a><span id="l6.207" class="difflineminus">-</span>
<a href="#l6.208"></a><span id="l6.208" class="difflineminus">-function createInstallRDF(data) {</span>
<a href="#l6.209"></a><span id="l6.209" class="difflineminus">-  let defaults = {</span>
<a href="#l6.210"></a><span id="l6.210" class="difflineminus">-    bootstrap: true,</span>
<a href="#l6.211"></a><span id="l6.211" class="difflineminus">-    version: &quot;1.0&quot;,</span>
<a href="#l6.212"></a><span id="l6.212" class="difflineminus">-    name: `Test Extension ${data.id}`,</span>
<a href="#l6.213"></a><span id="l6.213" class="difflineminus">-    targetApplications: [</span>
<a href="#l6.214"></a><span id="l6.214" class="difflineminus">-      {</span>
<a href="#l6.215"></a><span id="l6.215" class="difflineminus">-        &quot;id&quot;: &quot;xpcshell@tests.mozilla.org&quot;,</span>
<a href="#l6.216"></a><span id="l6.216" class="difflineminus">-        &quot;minVersion&quot;: &quot;1&quot;,</span>
<a href="#l6.217"></a><span id="l6.217" class="difflineminus">-        &quot;maxVersion&quot;: &quot;64.*&quot;,</span>
<a href="#l6.218"></a><span id="l6.218" class="difflineminus">-      },</span>
<a href="#l6.219"></a><span id="l6.219" class="difflineminus">-    ],</span>
<a href="#l6.220"></a><span id="l6.220" class="difflineminus">-  };</span>
<a href="#l6.221"></a><span id="l6.221" class="difflineminus">-</span>
<a href="#l6.222"></a><span id="l6.222" class="difflineminus">-  var rdf = '&lt;?xml version=&quot;1.0&quot;?&gt;\n';</span>
<a href="#l6.223"></a><span id="l6.223" class="difflineminus">-  rdf += '&lt;RDF xmlns=&quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#&quot;\n' +</span>
<a href="#l6.224"></a><span id="l6.224" class="difflineminus">-         '     xmlns:em=&quot;http://www.mozilla.org/2004/em-rdf#&quot;&gt;\n';</span>
<a href="#l6.225"></a><span id="l6.225" class="difflineminus">-</span>
<a href="#l6.226"></a><span id="l6.226" class="difflineminus">-  rdf += '&lt;Description about=&quot;urn:mozilla:install-manifest&quot;&gt;\n';</span>
<a href="#l6.227"></a><span id="l6.227" class="difflineminus">-</span>
<a href="#l6.228"></a><span id="l6.228" class="difflineminus">-  data = Object.assign({}, defaults, data);</span>
<a href="#l6.229"></a><span id="l6.229" class="difflineminus">-</span>
<a href="#l6.230"></a><span id="l6.230" class="difflineminus">-  let props = [&quot;id&quot;, &quot;version&quot;, &quot;type&quot;, &quot;internalName&quot;, &quot;updateURL&quot;,</span>
<a href="#l6.231"></a><span id="l6.231" class="difflineminus">-               &quot;optionsURL&quot;, &quot;optionsType&quot;, &quot;aboutURL&quot;, &quot;iconURL&quot;,</span>
<a href="#l6.232"></a><span id="l6.232" class="difflineminus">-               &quot;skinnable&quot;, &quot;bootstrap&quot;, &quot;strictCompatibility&quot;];</span>
<a href="#l6.233"></a><span id="l6.233" class="difflineminus">-  rdf += _writeProps(data, props);</span>
<a href="#l6.234"></a><span id="l6.234" class="difflineminus">-</span>
<a href="#l6.235"></a><span id="l6.235" class="difflineminus">-  rdf += _writeLocaleStrings(data);</span>
<a href="#l6.236"></a><span id="l6.236" class="difflineminus">-</span>
<a href="#l6.237"></a><span id="l6.237" class="difflineminus">-  for (let platform of data.targetPlatforms || [])</span>
<a href="#l6.238"></a><span id="l6.238" class="difflineminus">-    rdf += escaped`&lt;em:targetPlatform&gt;${platform}&lt;/em:targetPlatform&gt;\n`;</span>
<a href="#l6.239"></a><span id="l6.239" class="difflineminus">-</span>
<a href="#l6.240"></a><span id="l6.240" class="difflineminus">-  for (let app of data.targetApplications || []) {</span>
<a href="#l6.241"></a><span id="l6.241" class="difflineminus">-    rdf += &quot;&lt;em:targetApplication&gt;&lt;Description&gt;\n&quot;;</span>
<a href="#l6.242"></a><span id="l6.242" class="difflineminus">-    rdf += _writeProps(app, [&quot;id&quot;, &quot;minVersion&quot;, &quot;maxVersion&quot;]);</span>
<a href="#l6.243"></a><span id="l6.243" class="difflineminus">-    rdf += &quot;&lt;/Description&gt;&lt;/em:targetApplication&gt;\n&quot;;</span>
<a href="#l6.244"></a><span id="l6.244" class="difflineminus">-  }</span>
<a href="#l6.245"></a><span id="l6.245" class="difflineminus">-</span>
<a href="#l6.246"></a><span id="l6.246" class="difflineminus">-  for (let localized of data.localized || []) {</span>
<a href="#l6.247"></a><span id="l6.247" class="difflineminus">-    rdf += &quot;&lt;em:localized&gt;&lt;Description&gt;\n&quot;;</span>
<a href="#l6.248"></a><span id="l6.248" class="difflineminus">-    rdf += _writeArrayProps(localized, [&quot;locale&quot;]);</span>
<a href="#l6.249"></a><span id="l6.249" class="difflineminus">-    rdf += _writeLocaleStrings(localized);</span>
<a href="#l6.250"></a><span id="l6.250" class="difflineminus">-    rdf += &quot;&lt;/Description&gt;&lt;/em:localized&gt;\n&quot;;</span>
<a href="#l6.251"></a><span id="l6.251" class="difflineminus">-  }</span>
<a href="#l6.252"></a><span id="l6.252" class="difflineminus">-</span>
<a href="#l6.253"></a><span id="l6.253" class="difflineminus">-  for (let dep of data.dependencies || [])</span>
<a href="#l6.254"></a><span id="l6.254" class="difflineminus">-    rdf += escaped`&lt;em:dependency&gt;&lt;Description em:id=&quot;${dep}&quot;/&gt;&lt;/em:dependency&gt;\n`;</span>
<a href="#l6.255"></a><span id="l6.255" class="difflineminus">-</span>
<a href="#l6.256"></a><span id="l6.256" class="difflineminus">-  rdf += &quot;&lt;/Description&gt;\n&lt;/RDF&gt;\n&quot;;</span>
<a href="#l6.257"></a><span id="l6.257" class="difflineminus">-  return rdf;</span>
<a href="#l6.258"></a><span id="l6.258" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/common/test/xpcshell/test_bootstrap.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/common/test/xpcshell/test_bootstrap.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -29,53 +29,90 @@ const profileDir = gProfD.clone();</span>
<a href="#l7.4"></a><span id="l7.4"> profileDir.append(&quot;extensions&quot;);</span>
<a href="#l7.5"></a><span id="l7.5"> const userExtDir = gProfD.clone();</span>
<a href="#l7.6"></a><span id="l7.6"> userExtDir.append(&quot;extensions2&quot;);</span>
<a href="#l7.7"></a><span id="l7.7"> userExtDir.append(gAppInfo.ID);</span>
<a href="#l7.8"></a><span id="l7.8"> registerDirectory(&quot;XREUSysExt&quot;, userExtDir.parent);</span>
<a href="#l7.9"></a><span id="l7.9"> </span>
<a href="#l7.10"></a><span id="l7.10"> const ADDONS = {</span>
<a href="#l7.11"></a><span id="l7.11">   test_bootstrap1_1: {</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-    &quot;install.rdf&quot;: createInstallRDF({</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-      id: &quot;bootstrap1@tests.mozilla.org&quot;,</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+    &quot;manifest.json&quot;: JSON.stringify({</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+      applications: {</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+        gecko: {</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+          id: &quot;bootstrap1@tests.mozilla.org&quot;,</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+        },</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+      },</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+      legacy: {</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+        type: &quot;bootstrap&quot;,</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineplus">+      },</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineplus">+      manifest_version: 2,</span>
<a href="#l7.24"></a><span id="l7.24"> </span>
<a href="#l7.25"></a><span id="l7.25">       name: &quot;Test Bootstrap 1&quot;,</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineminus">-</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineminus">-      iconURL: &quot;chrome://foo/skin/icon.png&quot;,</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineminus">-      aboutURL: &quot;chrome://foo/content/about.xul&quot;,</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineminus">-      optionsURL: &quot;chrome://foo/content/options.xul&quot;,</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineplus">+      version: &quot;1.0&quot;,</span>
<a href="#l7.31"></a><span id="l7.31">     }),</span>
<a href="#l7.32"></a><span id="l7.32">     &quot;bootstrap.js&quot;: BOOTSTRAP_MONITOR_BOOTSTRAP_JS,</span>
<a href="#l7.33"></a><span id="l7.33">   },</span>
<a href="#l7.34"></a><span id="l7.34">   test_bootstrap1_2: {</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineminus">-    &quot;install.rdf&quot;: createInstallRDF({</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineminus">-      id: &quot;bootstrap1@tests.mozilla.org&quot;,</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+    &quot;manifest.json&quot;: JSON.stringify({</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineplus">+      applications: {</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineplus">+        gecko: {</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+          id: &quot;bootstrap1@tests.mozilla.org&quot;,</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineplus">+        },</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineplus">+      },</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineplus">+      legacy: {</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+        type: &quot;bootstrap&quot;,</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineplus">+      },</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineplus">+      manifest_version: 2,</span>
<a href="#l7.47"></a><span id="l7.47">       version: &quot;2.0&quot;,</span>
<a href="#l7.48"></a><span id="l7.48"> </span>
<a href="#l7.49"></a><span id="l7.49">       name: &quot;Test Bootstrap 1&quot;,</span>
<a href="#l7.50"></a><span id="l7.50">     }),</span>
<a href="#l7.51"></a><span id="l7.51">     &quot;bootstrap.js&quot;: BOOTSTRAP_MONITOR_BOOTSTRAP_JS,</span>
<a href="#l7.52"></a><span id="l7.52">   },</span>
<a href="#l7.53"></a><span id="l7.53">   test_bootstrap1_3: {</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineminus">-    &quot;install.rdf&quot;: createInstallRDF({</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineminus">-      id: &quot;bootstrap1@tests.mozilla.org&quot;,</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineplus">+    &quot;manifest.json&quot;: JSON.stringify({</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineplus">+      applications: {</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineplus">+        gecko: {</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineplus">+          id: &quot;bootstrap1@tests.mozilla.org&quot;,</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineplus">+        },</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineplus">+      },</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineplus">+      legacy: {</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineplus">+        type: &quot;bootstrap&quot;,</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineplus">+      },</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineplus">+      manifest_version: 2,</span>
<a href="#l7.66"></a><span id="l7.66">       version: &quot;3.0&quot;,</span>
<a href="#l7.67"></a><span id="l7.67"> </span>
<a href="#l7.68"></a><span id="l7.68">       name: &quot;Test Bootstrap 1&quot;,</span>
<a href="#l7.69"></a><span id="l7.69"> </span>
<a href="#l7.70"></a><span id="l7.70">       targetApplications: [{</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineminus">-        id: &quot;undefined&quot;,</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineplus">+        applications: {</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineplus">+          gecko: {</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineplus">+            id: &quot;undefined&quot;,</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineplus">+          },</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineplus">+        },</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineplus">+        legacy: {</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineplus">+          type: &quot;bootstrap&quot;,</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineplus">+        },</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineplus">+        manifest_version: 2,</span>
<a href="#l7.81"></a><span id="l7.81">         minVersion: &quot;1&quot;,</span>
<a href="#l7.82"></a><span id="l7.82">         maxVersion: &quot;1&quot;}],</span>
<a href="#l7.83"></a><span id="l7.83">     }),</span>
<a href="#l7.84"></a><span id="l7.84">     &quot;bootstrap.js&quot;: BOOTSTRAP_MONITOR_BOOTSTRAP_JS,</span>
<a href="#l7.85"></a><span id="l7.85">   },</span>
<a href="#l7.86"></a><span id="l7.86">   test_bootstrap2_1: {</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineminus">-    &quot;install.rdf&quot;: createInstallRDF({</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineminus">-      id: &quot;bootstrap2@tests.mozilla.org&quot;,</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineplus">+    &quot;manifest.json&quot;: JSON.stringify({</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineplus">+      applications: {</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineplus">+        gecko: {</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineplus">+          id: &quot;bootstrap2@tests.mozilla.org&quot;,</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineplus">+        },</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineplus">+      },</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineplus">+      legacy: {</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineplus">+        type: &quot;bootstrap&quot;,</span>
<a href="#l7.97"></a><span id="l7.97" class="difflineplus">+      },</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineplus">+      manifest_version: 2,</span>
<a href="#l7.99"></a><span id="l7.99">     }),</span>
<a href="#l7.100"></a><span id="l7.100">     &quot;bootstrap.js&quot;: BOOTSTRAP_MONITOR_BOOTSTRAP_JS,</span>
<a href="#l7.101"></a><span id="l7.101">   },</span>
<a href="#l7.102"></a><span id="l7.102"> };</span>
<a href="#l7.103"></a><span id="l7.103"> </span>
<a href="#l7.104"></a><span id="l7.104"> var testserver = AddonTestUtils.createHttpServer({hosts: [&quot;example.com&quot;]});</span>
<a href="#l7.105"></a><span id="l7.105"> </span>
<a href="#l7.106"></a><span id="l7.106"> const XPIS = {};</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineat">@@ -433,17 +470,17 @@ add_task(async function test_7() {</span>
<a href="#l7.108"></a><span id="l7.108">         AddonManager.OP_NEEDS_RESTART_UNINSTALL, 0);</span>
<a href="#l7.109"></a><span id="l7.109">   await b1.uninstall();</span>
<a href="#l7.110"></a><span id="l7.110"> </span>
<a href="#l7.111"></a><span id="l7.111">   await checkBootstrappedPref();</span>
<a href="#l7.112"></a><span id="l7.112"> </span>
<a href="#l7.113"></a><span id="l7.113">   ensure_test_completed();</span>
<a href="#l7.114"></a><span id="l7.114">   BootstrapMonitor.checkAddonNotInstalled(ID1);</span>
<a href="#l7.115"></a><span id="l7.115">   BootstrapMonitor.checkAddonNotStarted(ID1);</span>
<a href="#l7.116"></a><span id="l7.116" class="difflineminus">-  equal(getShutdownReason(), ADDON_UNINSTALL);</span>
<a href="#l7.117"></a><span id="l7.117" class="difflineplus">+  equal(getShutdownReason(), ADDON_DISABLE);</span>
<a href="#l7.118"></a><span id="l7.118">   equal(getShutdownNewVersion(), undefined);</span>
<a href="#l7.119"></a><span id="l7.119">   do_check_not_in_crash_annotation(ID1, &quot;2.0&quot;);</span>
<a href="#l7.120"></a><span id="l7.120"> </span>
<a href="#l7.121"></a><span id="l7.121">   b1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l7.122"></a><span id="l7.122">   equal(b1, null);</span>
<a href="#l7.123"></a><span id="l7.123"> </span>
<a href="#l7.124"></a><span id="l7.124">   await promiseRestartManager();</span>
<a href="#l7.125"></a><span id="l7.125"> </span>
<a href="#l7.126"></a><span id="l7.126" class="difflineat">@@ -644,221 +681,16 @@ add_task(async function test_12() {</span>
<a href="#l7.127"></a><span id="l7.127">   do_check_in_crash_annotation(ID1, &quot;1.0&quot;);</span>
<a href="#l7.128"></a><span id="l7.128"> </span>
<a href="#l7.129"></a><span id="l7.129">   await b1.uninstall();</span>
<a href="#l7.130"></a><span id="l7.130"> </span>
<a href="#l7.131"></a><span id="l7.131">   await promiseRestartManager();</span>
<a href="#l7.132"></a><span id="l7.132">   await checkBootstrappedPref();</span>
<a href="#l7.133"></a><span id="l7.133"> });</span>
<a href="#l7.134"></a><span id="l7.134"> </span>
<a href="#l7.135"></a><span id="l7.135" class="difflineminus">-</span>
<a href="#l7.136"></a><span id="l7.136" class="difflineminus">-// Tests that installing a bootstrapped extension with an invalid application</span>
<a href="#l7.137"></a><span id="l7.137" class="difflineminus">-// entry doesn't call it's startup method</span>
<a href="#l7.138"></a><span id="l7.138" class="difflineminus">-add_task(async function test_13() {</span>
<a href="#l7.139"></a><span id="l7.139" class="difflineminus">-  prepare_test({}, [</span>
<a href="#l7.140"></a><span id="l7.140" class="difflineminus">-    &quot;onNewInstall&quot;,</span>
<a href="#l7.141"></a><span id="l7.141" class="difflineminus">-  ]);</span>
<a href="#l7.142"></a><span id="l7.142" class="difflineminus">-</span>
<a href="#l7.143"></a><span id="l7.143" class="difflineminus">-  let install = await AddonManager.getInstallForFile(XPIS.test_bootstrap1_3);</span>
<a href="#l7.144"></a><span id="l7.144" class="difflineminus">-  ensure_test_completed();</span>
<a href="#l7.145"></a><span id="l7.145" class="difflineminus">-</span>
<a href="#l7.146"></a><span id="l7.146" class="difflineminus">-  notEqual(install, null);</span>
<a href="#l7.147"></a><span id="l7.147" class="difflineminus">-  equal(install.type, &quot;extension&quot;);</span>
<a href="#l7.148"></a><span id="l7.148" class="difflineminus">-  equal(install.version, &quot;3.0&quot;);</span>
<a href="#l7.149"></a><span id="l7.149" class="difflineminus">-  equal(install.name, &quot;Test Bootstrap 1&quot;);</span>
<a href="#l7.150"></a><span id="l7.150" class="difflineminus">-  equal(install.state, AddonManager.STATE_DOWNLOADED);</span>
<a href="#l7.151"></a><span id="l7.151" class="difflineminus">-  do_check_not_in_crash_annotation(ID1, &quot;3.0&quot;);</span>
<a href="#l7.152"></a><span id="l7.152" class="difflineminus">-</span>
<a href="#l7.153"></a><span id="l7.153" class="difflineminus">-  await new Promise(resolve =&gt; {</span>
<a href="#l7.154"></a><span id="l7.154" class="difflineminus">-    prepare_test({</span>
<a href="#l7.155"></a><span id="l7.155" class="difflineminus">-      [ID1]: [</span>
<a href="#l7.156"></a><span id="l7.156" class="difflineminus">-        [&quot;onInstalling&quot;, false],</span>
<a href="#l7.157"></a><span id="l7.157" class="difflineminus">-        &quot;onInstalled&quot;,</span>
<a href="#l7.158"></a><span id="l7.158" class="difflineminus">-      ],</span>
<a href="#l7.159"></a><span id="l7.159" class="difflineminus">-    }, [</span>
<a href="#l7.160"></a><span id="l7.160" class="difflineminus">-      &quot;onInstallStarted&quot;,</span>
<a href="#l7.161"></a><span id="l7.161" class="difflineminus">-      &quot;onInstallEnded&quot;,</span>
<a href="#l7.162"></a><span id="l7.162" class="difflineminus">-    ], resolve);</span>
<a href="#l7.163"></a><span id="l7.163" class="difflineminus">-    install.install();</span>
<a href="#l7.164"></a><span id="l7.164" class="difflineminus">-  });</span>
<a href="#l7.165"></a><span id="l7.165" class="difflineminus">-</span>
<a href="#l7.166"></a><span id="l7.166" class="difflineminus">-  let installs = await AddonManager.getAllInstalls();</span>
<a href="#l7.167"></a><span id="l7.167" class="difflineminus">-</span>
<a href="#l7.168"></a><span id="l7.168" class="difflineminus">-  // There should be no active installs now since the install completed and</span>
<a href="#l7.169"></a><span id="l7.169" class="difflineminus">-  // doesn't require a restart.</span>
<a href="#l7.170"></a><span id="l7.170" class="difflineminus">-  equal(installs.length, 0);</span>
<a href="#l7.171"></a><span id="l7.171" class="difflineminus">-</span>
<a href="#l7.172"></a><span id="l7.172" class="difflineminus">-  let b1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l7.173"></a><span id="l7.173" class="difflineminus">-  notEqual(b1, null);</span>
<a href="#l7.174"></a><span id="l7.174" class="difflineminus">-  equal(b1.version, &quot;3.0&quot;);</span>
<a href="#l7.175"></a><span id="l7.175" class="difflineminus">-  ok(b1.appDisabled);</span>
<a href="#l7.176"></a><span id="l7.176" class="difflineminus">-  ok(!b1.userDisabled);</span>
<a href="#l7.177"></a><span id="l7.177" class="difflineminus">-  ok(!b1.isActive);</span>
<a href="#l7.178"></a><span id="l7.178" class="difflineminus">-  BootstrapMonitor.checkAddonInstalled(ID1, &quot;3.0&quot;); // We call install even for disabled add-ons</span>
<a href="#l7.179"></a><span id="l7.179" class="difflineminus">-  BootstrapMonitor.checkAddonNotStarted(ID1); // Should not have called startup though</span>
<a href="#l7.180"></a><span id="l7.180" class="difflineminus">-  do_check_not_in_crash_annotation(ID1, &quot;3.0&quot;);</span>
<a href="#l7.181"></a><span id="l7.181" class="difflineminus">-</span>
<a href="#l7.182"></a><span id="l7.182" class="difflineminus">-  await promiseRestartManager();</span>
<a href="#l7.183"></a><span id="l7.183" class="difflineminus">-</span>
<a href="#l7.184"></a><span id="l7.184" class="difflineminus">-  b1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l7.185"></a><span id="l7.185" class="difflineminus">-  notEqual(b1, null);</span>
<a href="#l7.186"></a><span id="l7.186" class="difflineminus">-  equal(b1.version, &quot;3.0&quot;);</span>
<a href="#l7.187"></a><span id="l7.187" class="difflineminus">-  ok(b1.appDisabled);</span>
<a href="#l7.188"></a><span id="l7.188" class="difflineminus">-  ok(!b1.userDisabled);</span>
<a href="#l7.189"></a><span id="l7.189" class="difflineminus">-  ok(!b1.isActive);</span>
<a href="#l7.190"></a><span id="l7.190" class="difflineminus">-  BootstrapMonitor.checkAddonInstalled(ID1, &quot;3.0&quot;); // We call install even for disabled add-ons</span>
<a href="#l7.191"></a><span id="l7.191" class="difflineminus">-  BootstrapMonitor.checkAddonNotStarted(ID1); // Should not have called startup though</span>
<a href="#l7.192"></a><span id="l7.192" class="difflineminus">-  do_check_not_in_crash_annotation(ID1, &quot;3.0&quot;);</span>
<a href="#l7.193"></a><span id="l7.193" class="difflineminus">-</span>
<a href="#l7.194"></a><span id="l7.194" class="difflineminus">-  await checkBootstrappedPref();</span>
<a href="#l7.195"></a><span id="l7.195" class="difflineminus">-  await b1.uninstall();</span>
<a href="#l7.196"></a><span id="l7.196" class="difflineminus">-});</span>
<a href="#l7.197"></a><span id="l7.197" class="difflineminus">-</span>
<a href="#l7.198"></a><span id="l7.198" class="difflineminus">-// Tests that a bootstrapped extension with an invalid target application entry</span>
<a href="#l7.199"></a><span id="l7.199" class="difflineminus">-// does not get loaded when detected during startup</span>
<a href="#l7.200"></a><span id="l7.200" class="difflineminus">-add_task(async function test_14() {</span>
<a href="#l7.201"></a><span id="l7.201" class="difflineminus">-  await promiseRestartManager();</span>
<a href="#l7.202"></a><span id="l7.202" class="difflineminus">-</span>
<a href="#l7.203"></a><span id="l7.203" class="difflineminus">-  await promiseShutdownManager();</span>
<a href="#l7.204"></a><span id="l7.204" class="difflineminus">-</span>
<a href="#l7.205"></a><span id="l7.205" class="difflineminus">-  await manuallyInstall(XPIS.test_bootstrap1_3, profileDir, ID1);</span>
<a href="#l7.206"></a><span id="l7.206" class="difflineminus">-</span>
<a href="#l7.207"></a><span id="l7.207" class="difflineminus">-  await promiseStartupManager();</span>
<a href="#l7.208"></a><span id="l7.208" class="difflineminus">-</span>
<a href="#l7.209"></a><span id="l7.209" class="difflineminus">-  let b1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l7.210"></a><span id="l7.210" class="difflineminus">-  notEqual(b1, null);</span>
<a href="#l7.211"></a><span id="l7.211" class="difflineminus">-  equal(b1.version, &quot;3.0&quot;);</span>
<a href="#l7.212"></a><span id="l7.212" class="difflineminus">-  ok(b1.appDisabled);</span>
<a href="#l7.213"></a><span id="l7.213" class="difflineminus">-  ok(!b1.userDisabled);</span>
<a href="#l7.214"></a><span id="l7.214" class="difflineminus">-  ok(!b1.isActive);</span>
<a href="#l7.215"></a><span id="l7.215" class="difflineminus">-  BootstrapMonitor.checkAddonInstalled(ID1, &quot;3.0&quot;); // We call install even for disabled add-ons</span>
<a href="#l7.216"></a><span id="l7.216" class="difflineminus">-  BootstrapMonitor.checkAddonNotStarted(ID1); // Should not have called startup though</span>
<a href="#l7.217"></a><span id="l7.217" class="difflineminus">-  do_check_not_in_crash_annotation(ID1, &quot;3.0&quot;);</span>
<a href="#l7.218"></a><span id="l7.218" class="difflineminus">-</span>
<a href="#l7.219"></a><span id="l7.219" class="difflineminus">-  await checkBootstrappedPref();</span>
<a href="#l7.220"></a><span id="l7.220" class="difflineminus">-  await b1.uninstall();</span>
<a href="#l7.221"></a><span id="l7.221" class="difflineminus">-});</span>
<a href="#l7.222"></a><span id="l7.222" class="difflineminus">-</span>
<a href="#l7.223"></a><span id="l7.223" class="difflineminus">-// Tests that upgrading a disabled bootstrapped extension still calls uninstall</span>
<a href="#l7.224"></a><span id="l7.224" class="difflineminus">-// and install but doesn't startup the new version</span>
<a href="#l7.225"></a><span id="l7.225" class="difflineminus">-add_task(async function test_15() {</span>
<a href="#l7.226"></a><span id="l7.226" class="difflineminus">-  await Promise.all([</span>
<a href="#l7.227"></a><span id="l7.227" class="difflineminus">-    BootstrapMonitor.promiseAddonStartup(ID1),</span>
<a href="#l7.228"></a><span id="l7.228" class="difflineminus">-    promiseInstallFile(XPIS.test_bootstrap1_1),</span>
<a href="#l7.229"></a><span id="l7.229" class="difflineminus">-  ]);</span>
<a href="#l7.230"></a><span id="l7.230" class="difflineminus">-</span>
<a href="#l7.231"></a><span id="l7.231" class="difflineminus">-  let b1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l7.232"></a><span id="l7.232" class="difflineminus">-  notEqual(b1, null);</span>
<a href="#l7.233"></a><span id="l7.233" class="difflineminus">-  equal(b1.version, &quot;1.0&quot;);</span>
<a href="#l7.234"></a><span id="l7.234" class="difflineminus">-  ok(!b1.appDisabled);</span>
<a href="#l7.235"></a><span id="l7.235" class="difflineminus">-  ok(!b1.userDisabled);</span>
<a href="#l7.236"></a><span id="l7.236" class="difflineminus">-  ok(b1.isActive);</span>
<a href="#l7.237"></a><span id="l7.237" class="difflineminus">-  ok(!b1.isSystem);</span>
<a href="#l7.238"></a><span id="l7.238" class="difflineminus">-  BootstrapMonitor.checkAddonInstalled(ID1, &quot;1.0&quot;);</span>
<a href="#l7.239"></a><span id="l7.239" class="difflineminus">-  BootstrapMonitor.checkAddonStarted(ID1, &quot;1.0&quot;);</span>
<a href="#l7.240"></a><span id="l7.240" class="difflineminus">-</span>
<a href="#l7.241"></a><span id="l7.241" class="difflineminus">-  await b1.disable();</span>
<a href="#l7.242"></a><span id="l7.242" class="difflineminus">-  ok(!b1.isActive);</span>
<a href="#l7.243"></a><span id="l7.243" class="difflineminus">-  BootstrapMonitor.checkAddonInstalled(ID1, &quot;1.0&quot;);</span>
<a href="#l7.244"></a><span id="l7.244" class="difflineminus">-  BootstrapMonitor.checkAddonNotStarted(ID1);</span>
<a href="#l7.245"></a><span id="l7.245" class="difflineminus">-</span>
<a href="#l7.246"></a><span id="l7.246" class="difflineminus">-  prepare_test({}, [</span>
<a href="#l7.247"></a><span id="l7.247" class="difflineminus">-    &quot;onNewInstall&quot;,</span>
<a href="#l7.248"></a><span id="l7.248" class="difflineminus">-  ]);</span>
<a href="#l7.249"></a><span id="l7.249" class="difflineminus">-</span>
<a href="#l7.250"></a><span id="l7.250" class="difflineminus">-  let install = await AddonManager.getInstallForFile(XPIS.test_bootstrap1_2);</span>
<a href="#l7.251"></a><span id="l7.251" class="difflineminus">-  ensure_test_completed();</span>
<a href="#l7.252"></a><span id="l7.252" class="difflineminus">-</span>
<a href="#l7.253"></a><span id="l7.253" class="difflineminus">-  notEqual(install, null);</span>
<a href="#l7.254"></a><span id="l7.254" class="difflineminus">-  ok(install.addon.userDisabled);</span>
<a href="#l7.255"></a><span id="l7.255" class="difflineminus">-</span>
<a href="#l7.256"></a><span id="l7.256" class="difflineminus">-  await new Promise(resolve =&gt; {</span>
<a href="#l7.257"></a><span id="l7.257" class="difflineminus">-    prepare_test({</span>
<a href="#l7.258"></a><span id="l7.258" class="difflineminus">-      [ID1]: [</span>
<a href="#l7.259"></a><span id="l7.259" class="difflineminus">-        [&quot;onInstalling&quot;, false],</span>
<a href="#l7.260"></a><span id="l7.260" class="difflineminus">-        &quot;onInstalled&quot;,</span>
<a href="#l7.261"></a><span id="l7.261" class="difflineminus">-      ],</span>
<a href="#l7.262"></a><span id="l7.262" class="difflineminus">-    }, [</span>
<a href="#l7.263"></a><span id="l7.263" class="difflineminus">-      &quot;onInstallStarted&quot;,</span>
<a href="#l7.264"></a><span id="l7.264" class="difflineminus">-      &quot;onInstallEnded&quot;,</span>
<a href="#l7.265"></a><span id="l7.265" class="difflineminus">-    ], resolve);</span>
<a href="#l7.266"></a><span id="l7.266" class="difflineminus">-    install.install();</span>
<a href="#l7.267"></a><span id="l7.267" class="difflineminus">-  });</span>
<a href="#l7.268"></a><span id="l7.268" class="difflineminus">-</span>
<a href="#l7.269"></a><span id="l7.269" class="difflineminus">-  b1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l7.270"></a><span id="l7.270" class="difflineminus">-  notEqual(b1, null);</span>
<a href="#l7.271"></a><span id="l7.271" class="difflineminus">-  equal(b1.version, &quot;2.0&quot;);</span>
<a href="#l7.272"></a><span id="l7.272" class="difflineminus">-  ok(!b1.appDisabled);</span>
<a href="#l7.273"></a><span id="l7.273" class="difflineminus">-  ok(b1.userDisabled);</span>
<a href="#l7.274"></a><span id="l7.274" class="difflineminus">-  ok(!b1.isActive);</span>
<a href="#l7.275"></a><span id="l7.275" class="difflineminus">-  BootstrapMonitor.checkAddonInstalled(ID1, &quot;2.0&quot;);</span>
<a href="#l7.276"></a><span id="l7.276" class="difflineminus">-  BootstrapMonitor.checkAddonNotStarted(ID1);</span>
<a href="#l7.277"></a><span id="l7.277" class="difflineminus">-</span>
<a href="#l7.278"></a><span id="l7.278" class="difflineminus">-  await checkBootstrappedPref();</span>
<a href="#l7.279"></a><span id="l7.279" class="difflineminus">-  await promiseRestartManager();</span>
<a href="#l7.280"></a><span id="l7.280" class="difflineminus">-</span>
<a href="#l7.281"></a><span id="l7.281" class="difflineminus">-  let b1_2 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l7.282"></a><span id="l7.282" class="difflineminus">-  notEqual(b1_2, null);</span>
<a href="#l7.283"></a><span id="l7.283" class="difflineminus">-  equal(b1_2.version, &quot;2.0&quot;);</span>
<a href="#l7.284"></a><span id="l7.284" class="difflineminus">-  ok(!b1_2.appDisabled);</span>
<a href="#l7.285"></a><span id="l7.285" class="difflineminus">-  ok(b1_2.userDisabled);</span>
<a href="#l7.286"></a><span id="l7.286" class="difflineminus">-  ok(!b1_2.isActive);</span>
<a href="#l7.287"></a><span id="l7.287" class="difflineminus">-  BootstrapMonitor.checkAddonInstalled(ID1, &quot;2.0&quot;);</span>
<a href="#l7.288"></a><span id="l7.288" class="difflineminus">-  BootstrapMonitor.checkAddonNotStarted(ID1);</span>
<a href="#l7.289"></a><span id="l7.289" class="difflineminus">-</span>
<a href="#l7.290"></a><span id="l7.290" class="difflineminus">-  await b1_2.uninstall();</span>
<a href="#l7.291"></a><span id="l7.291" class="difflineminus">-});</span>
<a href="#l7.292"></a><span id="l7.292" class="difflineminus">-</span>
<a href="#l7.293"></a><span id="l7.293" class="difflineminus">-// Tests that bootstrapped extensions don't get loaded when in safe mode</span>
<a href="#l7.294"></a><span id="l7.294" class="difflineminus">-add_task(async function test_16() {</span>
<a href="#l7.295"></a><span id="l7.295" class="difflineminus">-  await Promise.all([</span>
<a href="#l7.296"></a><span id="l7.296" class="difflineminus">-    BootstrapMonitor.promiseAddonStartup(ID1),</span>
<a href="#l7.297"></a><span id="l7.297" class="difflineminus">-    promiseInstallFile(XPIS.test_bootstrap1_1),</span>
<a href="#l7.298"></a><span id="l7.298" class="difflineminus">-  ]);</span>
<a href="#l7.299"></a><span id="l7.299" class="difflineminus">-</span>
<a href="#l7.300"></a><span id="l7.300" class="difflineminus">-  let b1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l7.301"></a><span id="l7.301" class="difflineminus">-  // Should have installed and started</span>
<a href="#l7.302"></a><span id="l7.302" class="difflineminus">-  BootstrapMonitor.checkAddonInstalled(ID1, &quot;1.0&quot;);</span>
<a href="#l7.303"></a><span id="l7.303" class="difflineminus">-  BootstrapMonitor.checkAddonStarted(ID1, &quot;1.0&quot;);</span>
<a href="#l7.304"></a><span id="l7.304" class="difflineminus">-  ok(b1.isActive);</span>
<a href="#l7.305"></a><span id="l7.305" class="difflineminus">-  ok(!b1.isSystem);</span>
<a href="#l7.306"></a><span id="l7.306" class="difflineminus">-  equal(b1.iconURL, &quot;chrome://foo/skin/icon.png&quot;);</span>
<a href="#l7.307"></a><span id="l7.307" class="difflineminus">-  equal(b1.aboutURL, &quot;chrome://foo/content/about.xul&quot;);</span>
<a href="#l7.308"></a><span id="l7.308" class="difflineminus">-  equal(b1.optionsURL, &quot;chrome://foo/content/options.xul&quot;);</span>
<a href="#l7.309"></a><span id="l7.309" class="difflineminus">-</span>
<a href="#l7.310"></a><span id="l7.310" class="difflineminus">-  await promiseShutdownManager();</span>
<a href="#l7.311"></a><span id="l7.311" class="difflineminus">-</span>
<a href="#l7.312"></a><span id="l7.312" class="difflineminus">-  // Should have stopped</span>
<a href="#l7.313"></a><span id="l7.313" class="difflineminus">-  BootstrapMonitor.checkAddonInstalled(ID1, &quot;1.0&quot;);</span>
<a href="#l7.314"></a><span id="l7.314" class="difflineminus">-  BootstrapMonitor.checkAddonNotStarted(ID1);</span>
<a href="#l7.315"></a><span id="l7.315" class="difflineminus">-</span>
<a href="#l7.316"></a><span id="l7.316" class="difflineminus">-  gAppInfo.inSafeMode = true;</span>
<a href="#l7.317"></a><span id="l7.317" class="difflineminus">-  await promiseStartupManager();</span>
<a href="#l7.318"></a><span id="l7.318" class="difflineminus">-</span>
<a href="#l7.319"></a><span id="l7.319" class="difflineminus">-  let b1_2 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l7.320"></a><span id="l7.320" class="difflineminus">-  // Should still be stopped</span>
<a href="#l7.321"></a><span id="l7.321" class="difflineminus">-  BootstrapMonitor.checkAddonInstalled(ID1, &quot;1.0&quot;);</span>
<a href="#l7.322"></a><span id="l7.322" class="difflineminus">-  BootstrapMonitor.checkAddonNotStarted(ID1);</span>
<a href="#l7.323"></a><span id="l7.323" class="difflineminus">-  ok(!b1_2.isActive);</span>
<a href="#l7.324"></a><span id="l7.324" class="difflineminus">-  equal(b1_2.iconURL, null);</span>
<a href="#l7.325"></a><span id="l7.325" class="difflineminus">-  equal(b1_2.aboutURL, null);</span>
<a href="#l7.326"></a><span id="l7.326" class="difflineminus">-  equal(b1_2.optionsURL, null);</span>
<a href="#l7.327"></a><span id="l7.327" class="difflineminus">-</span>
<a href="#l7.328"></a><span id="l7.328" class="difflineminus">-  await promiseShutdownManager();</span>
<a href="#l7.329"></a><span id="l7.329" class="difflineminus">-  gAppInfo.inSafeMode = false;</span>
<a href="#l7.330"></a><span id="l7.330" class="difflineminus">-  await promiseStartupManager();</span>
<a href="#l7.331"></a><span id="l7.331" class="difflineminus">-</span>
<a href="#l7.332"></a><span id="l7.332" class="difflineminus">-  // Should have started</span>
<a href="#l7.333"></a><span id="l7.333" class="difflineminus">-  BootstrapMonitor.checkAddonInstalled(ID1, &quot;1.0&quot;);</span>
<a href="#l7.334"></a><span id="l7.334" class="difflineminus">-  BootstrapMonitor.checkAddonStarted(ID1, &quot;1.0&quot;);</span>
<a href="#l7.335"></a><span id="l7.335" class="difflineminus">-</span>
<a href="#l7.336"></a><span id="l7.336" class="difflineminus">-  let b1_3 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l7.337"></a><span id="l7.337" class="difflineminus">-  await b1_3.uninstall();</span>
<a href="#l7.338"></a><span id="l7.338" class="difflineminus">-});</span>
<a href="#l7.339"></a><span id="l7.339" class="difflineminus">-</span>
<a href="#l7.340"></a><span id="l7.340"> // Check that a bootstrapped extension in a non-profile location is loaded</span>
<a href="#l7.341"></a><span id="l7.341"> add_task(async function test_17() {</span>
<a href="#l7.342"></a><span id="l7.342">   await promiseShutdownManager();</span>
<a href="#l7.343"></a><span id="l7.343"> </span>
<a href="#l7.344"></a><span id="l7.344">   await manuallyInstall(XPIS.test_bootstrap1_1, userExtDir, ID1);</span>
<a href="#l7.345"></a><span id="l7.345"> </span>
<a href="#l7.346"></a><span id="l7.346">   await promiseStartupManager();</span>
<a href="#l7.347"></a><span id="l7.347"> </span>
<a href="#l7.348"></a><span id="l7.348" class="difflineat">@@ -937,250 +769,8 @@ add_task(async function test_19() {</span>
<a href="#l7.349"></a><span id="l7.349"> </span>
<a href="#l7.350"></a><span id="l7.350">   equal(getShutdownNewVersion(), &quot;1.0&quot;);</span>
<a href="#l7.351"></a><span id="l7.351">   equal(getUninstallNewVersion(), &quot;1.0&quot;);</span>
<a href="#l7.352"></a><span id="l7.352">   equal(getInstallOldVersion(), &quot;2.0&quot;);</span>
<a href="#l7.353"></a><span id="l7.353">   equal(getStartupOldVersion(), &quot;2.0&quot;);</span>
<a href="#l7.354"></a><span id="l7.354"> </span>
<a href="#l7.355"></a><span id="l7.355">   await checkBootstrappedPref();</span>
<a href="#l7.356"></a><span id="l7.356"> });</span>
<a href="#l7.357"></a><span id="l7.357" class="difflineminus">-</span>
<a href="#l7.358"></a><span id="l7.358" class="difflineminus">-// Check that a new profile extension detected at startup replaces the non-profile</span>
<a href="#l7.359"></a><span id="l7.359" class="difflineminus">-// one</span>
<a href="#l7.360"></a><span id="l7.360" class="difflineminus">-add_task(async function test_20() {</span>
<a href="#l7.361"></a><span id="l7.361" class="difflineminus">-  await promiseShutdownManager();</span>
<a href="#l7.362"></a><span id="l7.362" class="difflineminus">-</span>
<a href="#l7.363"></a><span id="l7.363" class="difflineminus">-  await manuallyInstall(XPIS.test_bootstrap1_2, profileDir, ID1);</span>
<a href="#l7.364"></a><span id="l7.364" class="difflineminus">-</span>
<a href="#l7.365"></a><span id="l7.365" class="difflineminus">-  await promiseStartupManager();</span>
<a href="#l7.366"></a><span id="l7.366" class="difflineminus">-</span>
<a href="#l7.367"></a><span id="l7.367" class="difflineminus">-  let b1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l7.368"></a><span id="l7.368" class="difflineminus">-  // Should have installed and started</span>
<a href="#l7.369"></a><span id="l7.369" class="difflineminus">-  BootstrapMonitor.checkAddonInstalled(ID1, &quot;2.0&quot;);</span>
<a href="#l7.370"></a><span id="l7.370" class="difflineminus">-  BootstrapMonitor.checkAddonStarted(ID1, &quot;2.0&quot;);</span>
<a href="#l7.371"></a><span id="l7.371" class="difflineminus">-  notEqual(b1, null);</span>
<a href="#l7.372"></a><span id="l7.372" class="difflineminus">-  equal(b1.version, &quot;2.0&quot;);</span>
<a href="#l7.373"></a><span id="l7.373" class="difflineminus">-  ok(b1.isActive);</span>
<a href="#l7.374"></a><span id="l7.374" class="difflineminus">-  ok(!b1.isSystem);</span>
<a href="#l7.375"></a><span id="l7.375" class="difflineminus">-</span>
<a href="#l7.376"></a><span id="l7.376" class="difflineminus">-  equal(getShutdownReason(), APP_SHUTDOWN);</span>
<a href="#l7.377"></a><span id="l7.377" class="difflineminus">-  equal(getUninstallReason(), ADDON_UPGRADE);</span>
<a href="#l7.378"></a><span id="l7.378" class="difflineminus">-  equal(getInstallReason(), ADDON_UPGRADE);</span>
<a href="#l7.379"></a><span id="l7.379" class="difflineminus">-  equal(getStartupReason(), APP_STARTUP);</span>
<a href="#l7.380"></a><span id="l7.380" class="difflineminus">-</span>
<a href="#l7.381"></a><span id="l7.381" class="difflineminus">-  equal(getShutdownNewVersion(), undefined);</span>
<a href="#l7.382"></a><span id="l7.382" class="difflineminus">-  equal(getUninstallNewVersion(), 2);</span>
<a href="#l7.383"></a><span id="l7.383" class="difflineminus">-  equal(getInstallOldVersion(), 1);</span>
<a href="#l7.384"></a><span id="l7.384" class="difflineminus">-  equal(getStartupOldVersion(), undefined);</span>
<a href="#l7.385"></a><span id="l7.385" class="difflineminus">-});</span>
<a href="#l7.386"></a><span id="l7.386" class="difflineminus">-</span>
<a href="#l7.387"></a><span id="l7.387" class="difflineminus">-// Check that a detected removal reveals the non-profile one</span>
<a href="#l7.388"></a><span id="l7.388" class="difflineminus">-add_task(async function test_21() {</span>
<a href="#l7.389"></a><span id="l7.389" class="difflineminus">-  await promiseShutdownManager();</span>
<a href="#l7.390"></a><span id="l7.390" class="difflineminus">-</span>
<a href="#l7.391"></a><span id="l7.391" class="difflineminus">-  equal(getShutdownReason(), APP_SHUTDOWN);</span>
<a href="#l7.392"></a><span id="l7.392" class="difflineminus">-  equal(getShutdownNewVersion(), undefined);</span>
<a href="#l7.393"></a><span id="l7.393" class="difflineminus">-</span>
<a href="#l7.394"></a><span id="l7.394" class="difflineminus">-  manuallyUninstall(profileDir, ID1);</span>
<a href="#l7.395"></a><span id="l7.395" class="difflineminus">-  BootstrapMonitor.clear(ID1);</span>
<a href="#l7.396"></a><span id="l7.396" class="difflineminus">-</span>
<a href="#l7.397"></a><span id="l7.397" class="difflineminus">-  await promiseStartupManager();</span>
<a href="#l7.398"></a><span id="l7.398" class="difflineminus">-</span>
<a href="#l7.399"></a><span id="l7.399" class="difflineminus">-  let b1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l7.400"></a><span id="l7.400" class="difflineminus">-  // Should have installed and started</span>
<a href="#l7.401"></a><span id="l7.401" class="difflineminus">-  BootstrapMonitor.checkAddonInstalled(ID1, &quot;1.0&quot;);</span>
<a href="#l7.402"></a><span id="l7.402" class="difflineminus">-  BootstrapMonitor.checkAddonStarted(ID1, &quot;1.0&quot;);</span>
<a href="#l7.403"></a><span id="l7.403" class="difflineminus">-  notEqual(b1, null);</span>
<a href="#l7.404"></a><span id="l7.404" class="difflineminus">-  equal(b1.version, &quot;1.0&quot;);</span>
<a href="#l7.405"></a><span id="l7.405" class="difflineminus">-  ok(b1.isActive);</span>
<a href="#l7.406"></a><span id="l7.406" class="difflineminus">-  ok(!b1.isSystem);</span>
<a href="#l7.407"></a><span id="l7.407" class="difflineminus">-</span>
<a href="#l7.408"></a><span id="l7.408" class="difflineminus">-  // This won't be set as the bootstrap script was gone so we couldn't</span>
<a href="#l7.409"></a><span id="l7.409" class="difflineminus">-  // uninstall it properly</span>
<a href="#l7.410"></a><span id="l7.410" class="difflineminus">-  equal(getUninstallReason(), undefined);</span>
<a href="#l7.411"></a><span id="l7.411" class="difflineminus">-  equal(getUninstallNewVersion(), undefined);</span>
<a href="#l7.412"></a><span id="l7.412" class="difflineminus">-</span>
<a href="#l7.413"></a><span id="l7.413" class="difflineminus">-  equal(getInstallReason(), ADDON_DOWNGRADE);</span>
<a href="#l7.414"></a><span id="l7.414" class="difflineminus">-  equal(getInstallOldVersion(), 2);</span>
<a href="#l7.415"></a><span id="l7.415" class="difflineminus">-</span>
<a href="#l7.416"></a><span id="l7.416" class="difflineminus">-  equal(getStartupReason(), APP_STARTUP);</span>
<a href="#l7.417"></a><span id="l7.417" class="difflineminus">-  equal(getStartupOldVersion(), undefined);</span>
<a href="#l7.418"></a><span id="l7.418" class="difflineminus">-</span>
<a href="#l7.419"></a><span id="l7.419" class="difflineminus">-  await checkBootstrappedPref();</span>
<a href="#l7.420"></a><span id="l7.420" class="difflineminus">-  await promiseShutdownManager();</span>
<a href="#l7.421"></a><span id="l7.421" class="difflineminus">-</span>
<a href="#l7.422"></a><span id="l7.422" class="difflineminus">-  manuallyUninstall(userExtDir, ID1);</span>
<a href="#l7.423"></a><span id="l7.423" class="difflineminus">-  BootstrapMonitor.clear(ID1);</span>
<a href="#l7.424"></a><span id="l7.424" class="difflineminus">-</span>
<a href="#l7.425"></a><span id="l7.425" class="difflineminus">-  await promiseStartupManager();</span>
<a href="#l7.426"></a><span id="l7.426" class="difflineminus">-});</span>
<a href="#l7.427"></a><span id="l7.427" class="difflineminus">-</span>
<a href="#l7.428"></a><span id="l7.428" class="difflineminus">-// Check that an upgrade from the filesystem is detected and applied correctly</span>
<a href="#l7.429"></a><span id="l7.429" class="difflineminus">-add_task(async function test_22() {</span>
<a href="#l7.430"></a><span id="l7.430" class="difflineminus">-  await promiseShutdownManager();</span>
<a href="#l7.431"></a><span id="l7.431" class="difflineminus">-</span>
<a href="#l7.432"></a><span id="l7.432" class="difflineminus">-  let file = await manuallyInstall(XPIS.test_bootstrap1_1, profileDir, ID1);</span>
<a href="#l7.433"></a><span id="l7.433" class="difflineminus">-  if (file.isDirectory())</span>
<a href="#l7.434"></a><span id="l7.434" class="difflineminus">-    file.append(&quot;install.rdf&quot;);</span>
<a href="#l7.435"></a><span id="l7.435" class="difflineminus">-</span>
<a href="#l7.436"></a><span id="l7.436" class="difflineminus">-  // Make it look old so changes are detected</span>
<a href="#l7.437"></a><span id="l7.437" class="difflineminus">-  setExtensionModifiedTime(file, file.lastModifiedTime - 5000);</span>
<a href="#l7.438"></a><span id="l7.438" class="difflineminus">-</span>
<a href="#l7.439"></a><span id="l7.439" class="difflineminus">-  await promiseStartupManager();</span>
<a href="#l7.440"></a><span id="l7.440" class="difflineminus">-</span>
<a href="#l7.441"></a><span id="l7.441" class="difflineminus">-  let b1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l7.442"></a><span id="l7.442" class="difflineminus">-  // Should have installed and started</span>
<a href="#l7.443"></a><span id="l7.443" class="difflineminus">-  BootstrapMonitor.checkAddonInstalled(ID1, &quot;1.0&quot;);</span>
<a href="#l7.444"></a><span id="l7.444" class="difflineminus">-  BootstrapMonitor.checkAddonStarted(ID1, &quot;1.0&quot;);</span>
<a href="#l7.445"></a><span id="l7.445" class="difflineminus">-  notEqual(b1, null);</span>
<a href="#l7.446"></a><span id="l7.446" class="difflineminus">-  equal(b1.version, &quot;1.0&quot;);</span>
<a href="#l7.447"></a><span id="l7.447" class="difflineminus">-  ok(b1.isActive);</span>
<a href="#l7.448"></a><span id="l7.448" class="difflineminus">-  ok(!b1.isSystem);</span>
<a href="#l7.449"></a><span id="l7.449" class="difflineminus">-</span>
<a href="#l7.450"></a><span id="l7.450" class="difflineminus">-  await promiseShutdownManager();</span>
<a href="#l7.451"></a><span id="l7.451" class="difflineminus">-</span>
<a href="#l7.452"></a><span id="l7.452" class="difflineminus">-  equal(getShutdownReason(), APP_SHUTDOWN);</span>
<a href="#l7.453"></a><span id="l7.453" class="difflineminus">-  equal(getShutdownNewVersion(), undefined);</span>
<a href="#l7.454"></a><span id="l7.454" class="difflineminus">-</span>
<a href="#l7.455"></a><span id="l7.455" class="difflineminus">-  manuallyUninstall(profileDir, ID1);</span>
<a href="#l7.456"></a><span id="l7.456" class="difflineminus">-  BootstrapMonitor.clear(ID1);</span>
<a href="#l7.457"></a><span id="l7.457" class="difflineminus">-  await manuallyInstall(XPIS.test_bootstrap1_2, profileDir, ID1);</span>
<a href="#l7.458"></a><span id="l7.458" class="difflineminus">-</span>
<a href="#l7.459"></a><span id="l7.459" class="difflineminus">-  await promiseStartupManager();</span>
<a href="#l7.460"></a><span id="l7.460" class="difflineminus">-</span>
<a href="#l7.461"></a><span id="l7.461" class="difflineminus">-  let b1_2 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l7.462"></a><span id="l7.462" class="difflineminus">-  // Should have installed and started</span>
<a href="#l7.463"></a><span id="l7.463" class="difflineminus">-  BootstrapMonitor.checkAddonInstalled(ID1, &quot;2.0&quot;);</span>
<a href="#l7.464"></a><span id="l7.464" class="difflineminus">-  BootstrapMonitor.checkAddonStarted(ID1, &quot;2.0&quot;);</span>
<a href="#l7.465"></a><span id="l7.465" class="difflineminus">-  notEqual(b1_2, null);</span>
<a href="#l7.466"></a><span id="l7.466" class="difflineminus">-  equal(b1_2.version, &quot;2.0&quot;);</span>
<a href="#l7.467"></a><span id="l7.467" class="difflineminus">-  ok(b1_2.isActive);</span>
<a href="#l7.468"></a><span id="l7.468" class="difflineminus">-  ok(!b1_2.isSystem);</span>
<a href="#l7.469"></a><span id="l7.469" class="difflineminus">-</span>
<a href="#l7.470"></a><span id="l7.470" class="difflineminus">-  // This won't be set as the bootstrap script was gone so we couldn't</span>
<a href="#l7.471"></a><span id="l7.471" class="difflineminus">-  // uninstall it properly</span>
<a href="#l7.472"></a><span id="l7.472" class="difflineminus">-  equal(getUninstallReason(), undefined);</span>
<a href="#l7.473"></a><span id="l7.473" class="difflineminus">-  equal(getUninstallNewVersion(), undefined);</span>
<a href="#l7.474"></a><span id="l7.474" class="difflineminus">-</span>
<a href="#l7.475"></a><span id="l7.475" class="difflineminus">-  equal(getInstallReason(), ADDON_UPGRADE);</span>
<a href="#l7.476"></a><span id="l7.476" class="difflineminus">-  equal(getInstallOldVersion(), 1);</span>
<a href="#l7.477"></a><span id="l7.477" class="difflineminus">-  equal(getStartupReason(), APP_STARTUP);</span>
<a href="#l7.478"></a><span id="l7.478" class="difflineminus">-  equal(getStartupOldVersion(), undefined);</span>
<a href="#l7.479"></a><span id="l7.479" class="difflineminus">-</span>
<a href="#l7.480"></a><span id="l7.480" class="difflineminus">-  await checkBootstrappedPref();</span>
<a href="#l7.481"></a><span id="l7.481" class="difflineminus">-  await b1_2.uninstall();</span>
<a href="#l7.482"></a><span id="l7.482" class="difflineminus">-});</span>
<a href="#l7.483"></a><span id="l7.483" class="difflineminus">-</span>
<a href="#l7.484"></a><span id="l7.484" class="difflineminus">-</span>
<a href="#l7.485"></a><span id="l7.485" class="difflineminus">-// Tests that installing from a URL doesn't require a restart</span>
<a href="#l7.486"></a><span id="l7.486" class="difflineminus">-add_task(async function test_23() {</span>
<a href="#l7.487"></a><span id="l7.487" class="difflineminus">-  prepare_test({}, [</span>
<a href="#l7.488"></a><span id="l7.488" class="difflineminus">-    &quot;onNewInstall&quot;,</span>
<a href="#l7.489"></a><span id="l7.489" class="difflineminus">-  ]);</span>
<a href="#l7.490"></a><span id="l7.490" class="difflineminus">-</span>
<a href="#l7.491"></a><span id="l7.491" class="difflineminus">-  let url = &quot;http://example.com/addons/test_bootstrap1_1.xpi&quot;;</span>
<a href="#l7.492"></a><span id="l7.492" class="difflineminus">-  let install = await AddonManager.getInstallForURL(url, {});</span>
<a href="#l7.493"></a><span id="l7.493" class="difflineminus">-</span>
<a href="#l7.494"></a><span id="l7.494" class="difflineminus">-  ensure_test_completed();</span>
<a href="#l7.495"></a><span id="l7.495" class="difflineminus">-</span>
<a href="#l7.496"></a><span id="l7.496" class="difflineminus">-  notEqual(install, null);</span>
<a href="#l7.497"></a><span id="l7.497" class="difflineminus">-</span>
<a href="#l7.498"></a><span id="l7.498" class="difflineminus">-  await new Promise(resolve =&gt; {</span>
<a href="#l7.499"></a><span id="l7.499" class="difflineminus">-    prepare_test({}, [</span>
<a href="#l7.500"></a><span id="l7.500" class="difflineminus">-      &quot;onDownloadStarted&quot;,</span>
<a href="#l7.501"></a><span id="l7.501" class="difflineminus">-      &quot;onDownloadEnded&quot;,</span>
<a href="#l7.502"></a><span id="l7.502" class="difflineminus">-    ], function() {</span>
<a href="#l7.503"></a><span id="l7.503" class="difflineminus">-      equal(install.type, &quot;extension&quot;);</span>
<a href="#l7.504"></a><span id="l7.504" class="difflineminus">-      equal(install.version, &quot;1.0&quot;);</span>
<a href="#l7.505"></a><span id="l7.505" class="difflineminus">-      equal(install.name, &quot;Test Bootstrap 1&quot;);</span>
<a href="#l7.506"></a><span id="l7.506" class="difflineminus">-      equal(install.state, AddonManager.STATE_DOWNLOADED);</span>
<a href="#l7.507"></a><span id="l7.507" class="difflineminus">-      equal(install.addon.operationsRequiringRestart &amp;</span>
<a href="#l7.508"></a><span id="l7.508" class="difflineminus">-                   AddonManager.OP_NEEDS_RESTART_INSTALL, 0);</span>
<a href="#l7.509"></a><span id="l7.509" class="difflineminus">-      do_check_not_in_crash_annotation(ID1, &quot;1.0&quot;);</span>
<a href="#l7.510"></a><span id="l7.510" class="difflineminus">-</span>
<a href="#l7.511"></a><span id="l7.511" class="difflineminus">-      prepare_test({</span>
<a href="#l7.512"></a><span id="l7.512" class="difflineminus">-        [ID1]: [</span>
<a href="#l7.513"></a><span id="l7.513" class="difflineminus">-          [&quot;onInstalling&quot;, false],</span>
<a href="#l7.514"></a><span id="l7.514" class="difflineminus">-          &quot;onInstalled&quot;,</span>
<a href="#l7.515"></a><span id="l7.515" class="difflineminus">-        ],</span>
<a href="#l7.516"></a><span id="l7.516" class="difflineminus">-      }, [</span>
<a href="#l7.517"></a><span id="l7.517" class="difflineminus">-        &quot;onInstallStarted&quot;,</span>
<a href="#l7.518"></a><span id="l7.518" class="difflineminus">-        &quot;onInstallEnded&quot;,</span>
<a href="#l7.519"></a><span id="l7.519" class="difflineminus">-      ], resolve);</span>
<a href="#l7.520"></a><span id="l7.520" class="difflineminus">-    });</span>
<a href="#l7.521"></a><span id="l7.521" class="difflineminus">-    install.install();</span>
<a href="#l7.522"></a><span id="l7.522" class="difflineminus">-  });</span>
<a href="#l7.523"></a><span id="l7.523" class="difflineminus">-</span>
<a href="#l7.524"></a><span id="l7.524" class="difflineminus">-  await checkBootstrappedPref();</span>
<a href="#l7.525"></a><span id="l7.525" class="difflineminus">-</span>
<a href="#l7.526"></a><span id="l7.526" class="difflineminus">-  let installs = await AddonManager.getAllInstalls();</span>
<a href="#l7.527"></a><span id="l7.527" class="difflineminus">-</span>
<a href="#l7.528"></a><span id="l7.528" class="difflineminus">-  // There should be no active installs now since the install completed and</span>
<a href="#l7.529"></a><span id="l7.529" class="difflineminus">-  // doesn't require a restart.</span>
<a href="#l7.530"></a><span id="l7.530" class="difflineminus">-  equal(installs.length, 0);</span>
<a href="#l7.531"></a><span id="l7.531" class="difflineminus">-</span>
<a href="#l7.532"></a><span id="l7.532" class="difflineminus">-  let b1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l7.533"></a><span id="l7.533" class="difflineminus">-</span>
<a href="#l7.534"></a><span id="l7.534" class="difflineminus">-  notEqual(b1, null);</span>
<a href="#l7.535"></a><span id="l7.535" class="difflineminus">-  equal(b1.version, &quot;1.0&quot;);</span>
<a href="#l7.536"></a><span id="l7.536" class="difflineminus">-  ok(!b1.appDisabled);</span>
<a href="#l7.537"></a><span id="l7.537" class="difflineminus">-  ok(!b1.userDisabled);</span>
<a href="#l7.538"></a><span id="l7.538" class="difflineminus">-  ok(b1.isActive);</span>
<a href="#l7.539"></a><span id="l7.539" class="difflineminus">-  ok(!b1.isSystem);</span>
<a href="#l7.540"></a><span id="l7.540" class="difflineminus">-  BootstrapMonitor.checkAddonInstalled(ID1, &quot;1.0&quot;);</span>
<a href="#l7.541"></a><span id="l7.541" class="difflineminus">-  BootstrapMonitor.checkAddonStarted(ID1, &quot;1.0&quot;);</span>
<a href="#l7.542"></a><span id="l7.542" class="difflineminus">-  equal(getStartupReason(), ADDON_INSTALL);</span>
<a href="#l7.543"></a><span id="l7.543" class="difflineminus">-  equal(getStartupOldVersion(), undefined);</span>
<a href="#l7.544"></a><span id="l7.544" class="difflineminus">-  do_check_in_crash_annotation(ID1, &quot;1.0&quot;);</span>
<a href="#l7.545"></a><span id="l7.545" class="difflineminus">-</span>
<a href="#l7.546"></a><span id="l7.546" class="difflineminus">-  let dir = do_get_addon_root_uri(profileDir, ID1);</span>
<a href="#l7.547"></a><span id="l7.547" class="difflineminus">-  equal(b1.getResourceURI(&quot;bootstrap.js&quot;).spec, dir + &quot;bootstrap.js&quot;);</span>
<a href="#l7.548"></a><span id="l7.548" class="difflineminus">-</span>
<a href="#l7.549"></a><span id="l7.549" class="difflineminus">-  await promiseRestartManager();</span>
<a href="#l7.550"></a><span id="l7.550" class="difflineminus">-</span>
<a href="#l7.551"></a><span id="l7.551" class="difflineminus">-  let b1_2 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l7.552"></a><span id="l7.552" class="difflineminus">-  await b1_2.uninstall();</span>
<a href="#l7.553"></a><span id="l7.553" class="difflineminus">-});</span>
<a href="#l7.554"></a><span id="l7.554" class="difflineminus">-</span>
<a href="#l7.555"></a><span id="l7.555" class="difflineminus">-// Tests that we recover from a broken preference</span>
<a href="#l7.556"></a><span id="l7.556" class="difflineminus">-add_task(async function test_24() {</span>
<a href="#l7.557"></a><span id="l7.557" class="difflineminus">-  info(&quot;starting 24&quot;);</span>
<a href="#l7.558"></a><span id="l7.558" class="difflineminus">-</span>
<a href="#l7.559"></a><span id="l7.559" class="difflineminus">-  await Promise.all([</span>
<a href="#l7.560"></a><span id="l7.560" class="difflineminus">-    BootstrapMonitor.promiseAddonStartup(ID2),</span>
<a href="#l7.561"></a><span id="l7.561" class="difflineminus">-    promiseInstallAllFiles([XPIS.test_bootstrap1_1, XPIS.test_bootstrap2_1]),</span>
<a href="#l7.562"></a><span id="l7.562" class="difflineminus">-  ]);</span>
<a href="#l7.563"></a><span id="l7.563" class="difflineminus">-</span>
<a href="#l7.564"></a><span id="l7.564" class="difflineminus">-  info(&quot;test 24 got prefs&quot;);</span>
<a href="#l7.565"></a><span id="l7.565" class="difflineminus">-  BootstrapMonitor.checkAddonInstalled(ID1, &quot;1.0&quot;);</span>
<a href="#l7.566"></a><span id="l7.566" class="difflineminus">-  BootstrapMonitor.checkAddonStarted(ID1, &quot;1.0&quot;);</span>
<a href="#l7.567"></a><span id="l7.567" class="difflineminus">-  BootstrapMonitor.checkAddonInstalled(ID2, &quot;1.0&quot;);</span>
<a href="#l7.568"></a><span id="l7.568" class="difflineminus">-  BootstrapMonitor.checkAddonStarted(ID2, &quot;1.0&quot;);</span>
<a href="#l7.569"></a><span id="l7.569" class="difflineminus">-</span>
<a href="#l7.570"></a><span id="l7.570" class="difflineminus">-  await promiseRestartManager();</span>
<a href="#l7.571"></a><span id="l7.571" class="difflineminus">-</span>
<a href="#l7.572"></a><span id="l7.572" class="difflineminus">-  BootstrapMonitor.checkAddonInstalled(ID1, &quot;1.0&quot;);</span>
<a href="#l7.573"></a><span id="l7.573" class="difflineminus">-  BootstrapMonitor.checkAddonStarted(ID1, &quot;1.0&quot;);</span>
<a href="#l7.574"></a><span id="l7.574" class="difflineminus">-  BootstrapMonitor.checkAddonInstalled(ID2, &quot;1.0&quot;);</span>
<a href="#l7.575"></a><span id="l7.575" class="difflineminus">-  BootstrapMonitor.checkAddonStarted(ID2, &quot;1.0&quot;);</span>
<a href="#l7.576"></a><span id="l7.576" class="difflineminus">-</span>
<a href="#l7.577"></a><span id="l7.577" class="difflineminus">-  await promiseShutdownManager();</span>
<a href="#l7.578"></a><span id="l7.578" class="difflineminus">-</span>
<a href="#l7.579"></a><span id="l7.579" class="difflineminus">-  BootstrapMonitor.checkAddonInstalled(ID1, &quot;1.0&quot;);</span>
<a href="#l7.580"></a><span id="l7.580" class="difflineminus">-  BootstrapMonitor.checkAddonNotStarted(ID1);</span>
<a href="#l7.581"></a><span id="l7.581" class="difflineminus">-  BootstrapMonitor.checkAddonInstalled(ID2, &quot;1.0&quot;);</span>
<a href="#l7.582"></a><span id="l7.582" class="difflineminus">-  BootstrapMonitor.checkAddonNotStarted(ID2);</span>
<a href="#l7.583"></a><span id="l7.583" class="difflineminus">-</span>
<a href="#l7.584"></a><span id="l7.584" class="difflineminus">-  // Break the JSON.</span>
<a href="#l7.585"></a><span id="l7.585" class="difflineminus">-  let data = aomStartup.readStartupData();</span>
<a href="#l7.586"></a><span id="l7.586" class="difflineminus">-  data[&quot;app-profile&quot;].addons[ID1].path += &quot;foo&quot;;</span>
<a href="#l7.587"></a><span id="l7.587" class="difflineminus">-</span>
<a href="#l7.588"></a><span id="l7.588" class="difflineminus">-  await OS.File.writeAtomic(gAddonStartup.path,</span>
<a href="#l7.589"></a><span id="l7.589" class="difflineminus">-                            new TextEncoder().encode(JSON.stringify(data)),</span>
<a href="#l7.590"></a><span id="l7.590" class="difflineminus">-                            {compression: &quot;lz4&quot;});</span>
<a href="#l7.591"></a><span id="l7.591" class="difflineminus">-</span>
<a href="#l7.592"></a><span id="l7.592" class="difflineminus">-  await promiseStartupManager();</span>
<a href="#l7.593"></a><span id="l7.593" class="difflineminus">-</span>
<a href="#l7.594"></a><span id="l7.594" class="difflineminus">-  BootstrapMonitor.checkAddonInstalled(ID1, &quot;1.0&quot;);</span>
<a href="#l7.595"></a><span id="l7.595" class="difflineminus">-  BootstrapMonitor.checkAddonStarted(ID1, &quot;1.0&quot;);</span>
<a href="#l7.596"></a><span id="l7.596" class="difflineminus">-  BootstrapMonitor.checkAddonInstalled(ID2, &quot;1.0&quot;);</span>
<a href="#l7.597"></a><span id="l7.597" class="difflineminus">-  BootstrapMonitor.checkAddonStarted(ID2, &quot;1.0&quot;);</span>
<a href="#l7.598"></a><span id="l7.598" class="difflineminus">-});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/common/test/xpcshell/test_bootstrap_const.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/common/test/xpcshell/test_bootstrap_const.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -1,18 +1,28 @@</span>
<a href="#l8.4"></a><span id="l8.4"> /* Any copyright is dedicated to the Public Domain.</span>
<a href="#l8.5"></a><span id="l8.5">  * http://creativecommons.org/publicdomain/zero/1.0/</span>
<a href="#l8.6"></a><span id="l8.6">  */</span>
<a href="#l8.7"></a><span id="l8.7"> </span>
<a href="#l8.8"></a><span id="l8.8"> createAppInfo(&quot;xpcshell@tests.mozilla.org&quot;, &quot;XPCShell&quot;, &quot;1&quot;, &quot;1&quot;);</span>
<a href="#l8.9"></a><span id="l8.9"> </span>
<a href="#l8.10"></a><span id="l8.10"> const ADDONS = {</span>
<a href="#l8.11"></a><span id="l8.11">   test_bootstrap_const: {</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-    &quot;install.rdf&quot;: createInstallRDF({</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-      &quot;id&quot;: &quot;bootstrap@tests.mozilla.org&quot;,</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+    &quot;manifest.json&quot;: JSON.stringify({</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+      applications: {</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+        gecko: {</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+          id: &quot;bootstrap@tests.mozilla.org&quot;,</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+        },</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+      },</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineplus">+      legacy: {</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineplus">+        type: &quot;bootstrap&quot;,</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineplus">+      },</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineplus">+      manifest_version: 2,</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+      name: &quot;Test Bootstrap 1&quot;,</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineplus">+      version: &quot;1.0&quot;,</span>
<a href="#l8.26"></a><span id="l8.26">     }),</span>
<a href="#l8.27"></a><span id="l8.27">     &quot;bootstrap.js&quot;: &quot;var {Services} = ChromeUtils.import(\&quot;resource://gre/modules/Services.jsm\&quot;);\n\nconst install = function() {\n  Services.obs.notifyObservers(null, \&quot;addon-install\&quot;);\n};\n&quot;,</span>
<a href="#l8.28"></a><span id="l8.28">   },</span>
<a href="#l8.29"></a><span id="l8.29"> };</span>
<a href="#l8.30"></a><span id="l8.30"> </span>
<a href="#l8.31"></a><span id="l8.31"> add_task(async function() {</span>
<a href="#l8.32"></a><span id="l8.32">   await promiseStartupManager();</span>
<a href="#l8.33"></a><span id="l8.33"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/common/test/xpcshell/test_bootstrap_globals.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/common/test/xpcshell/test_bootstrap_globals.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -4,18 +4,28 @@</span>
<a href="#l9.4"></a><span id="l9.4"> </span>
<a href="#l9.5"></a><span id="l9.5"> // This verifies that bootstrap.js has the expected globals defined</span>
<a href="#l9.6"></a><span id="l9.6"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l9.7"></a><span id="l9.7"> </span>
<a href="#l9.8"></a><span id="l9.8"> createAppInfo(&quot;xpcshell@tests.mozilla.org&quot;, &quot;XPCShell&quot;, &quot;1&quot;, &quot;1&quot;);</span>
<a href="#l9.9"></a><span id="l9.9"> </span>
<a href="#l9.10"></a><span id="l9.10"> const ADDONS = {</span>
<a href="#l9.11"></a><span id="l9.11">   bootstrap_globals: {</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-    &quot;install.rdf&quot;: createInstallRDF({</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-      &quot;id&quot;: &quot;bootstrap_globals@tests.mozilla.org&quot;,</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+    &quot;manifest.json&quot;: JSON.stringify({</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+      applications: {</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+        gecko: {</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+          id: &quot;bootstrap_globals@tests.mozilla.org&quot;,</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+        },</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineplus">+      },</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineplus">+      legacy: {</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineplus">+        type: &quot;bootstrap&quot;,</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineplus">+      },</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineplus">+      manifest_version: 2,</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineplus">+      name: &quot;Test Bootstrap 1&quot;,</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineplus">+      version: &quot;1.0&quot;,</span>
<a href="#l9.26"></a><span id="l9.26">     }),</span>
<a href="#l9.27"></a><span id="l9.27">     &quot;bootstrap.js&quot;: String.raw`var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l9.28"></a><span id="l9.28"> </span>
<a href="#l9.29"></a><span id="l9.29"> var seenGlobals = new Set();</span>
<a href="#l9.30"></a><span id="l9.30"> var scope = this;</span>
<a href="#l9.31"></a><span id="l9.31"> function checkGlobal(name, type) {</span>
<a href="#l9.32"></a><span id="l9.32">   if (scope[name] &amp;&amp; typeof(scope[name]) == type)</span>
<a href="#l9.33"></a><span id="l9.33">     seenGlobals.add(name);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/common/test/xpcshell/test_bootstrapped_chrome_manifest.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/common/test/xpcshell/test_bootstrapped_chrome_manifest.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -1,15 +1,25 @@</span>
<a href="#l10.4"></a><span id="l10.4"> /* Any copyright is dedicated to the Public Domain.</span>
<a href="#l10.5"></a><span id="l10.5">  * http://creativecommons.org/publicdomain/zero/1.0/</span>
<a href="#l10.6"></a><span id="l10.6">  */</span>
<a href="#l10.7"></a><span id="l10.7"> </span>
<a href="#l10.8"></a><span id="l10.8"> const ADDON = {</span>
<a href="#l10.9"></a><span id="l10.9" class="difflineminus">-  &quot;install.rdf&quot;: createInstallRDF({</span>
<a href="#l10.10"></a><span id="l10.10" class="difflineminus">-    &quot;id&quot;: &quot;bug675371@tests.mozilla.org&quot;,</span>
<a href="#l10.11"></a><span id="l10.11" class="difflineplus">+  &quot;manifest.json&quot;: JSON.stringify({</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+    applications: {</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+      gecko: {</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+        id: &quot;bug675371@tests.mozilla.org&quot;,</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+      },</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+    },</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+    legacy: {</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineplus">+      type: &quot;bootstrap&quot;,</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineplus">+    },</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineplus">+    manifest_version: 2,</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineplus">+    name: &quot;Test Bootstrap 1&quot;,</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineplus">+    version: &quot;1.0&quot;,</span>
<a href="#l10.23"></a><span id="l10.23">   }),</span>
<a href="#l10.24"></a><span id="l10.24">   &quot;chrome.manifest&quot;: `content bug675371 .`,</span>
<a href="#l10.25"></a><span id="l10.25">   &quot;test.js&quot;: `var active = true;`,</span>
<a href="#l10.26"></a><span id="l10.26"> };</span>
<a href="#l10.27"></a><span id="l10.27"> </span>
<a href="#l10.28"></a><span id="l10.28"> add_task(async function run_test() {</span>
<a href="#l10.29"></a><span id="l10.29">   createAppInfo(&quot;xpcshell@tests.mozilla.org&quot;, &quot;XPCShell&quot;, &quot;1&quot;, &quot;1.9.2&quot;);</span>
<a href="#l10.30"></a><span id="l10.30">   await promiseStartupManager();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1">deleted file mode 100644</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineminus">--- a/common/test/xpcshell/test_invalid_install_rdf.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineplus">+++ /dev/null</span>
<a href="#l11.4"></a><span id="l11.4" class="difflineat">@@ -1,113 +0,0 @@</span>
<a href="#l11.5"></a><span id="l11.5" class="difflineminus">-/* Any copyright is dedicated to the Public Domain.</span>
<a href="#l11.6"></a><span id="l11.6" class="difflineminus">- * http://creativecommons.org/publicdomain/zero/1.0/</span>
<a href="#l11.7"></a><span id="l11.7" class="difflineminus">- */</span>
<a href="#l11.8"></a><span id="l11.8" class="difflineminus">-</span>
<a href="#l11.9"></a><span id="l11.9" class="difflineminus">-// Test that side-loaded extensions with invalid install.rdf files are</span>
<a href="#l11.10"></a><span id="l11.10" class="difflineminus">-// not initialized at startup.</span>
<a href="#l11.11"></a><span id="l11.11" class="difflineminus">-</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-const APP_ID = &quot;xpcshell@tests.mozilla.org&quot;;</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineminus">-Services.prefs.setIntPref(&quot;extensions.enabledScopes&quot;, AddonManager.SCOPE_USER);</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineminus">-</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineminus">-createAppInfo(APP_ID, &quot;XPCShell&quot;, &quot;1&quot;, &quot;1.9.2&quot;);</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineminus">-</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineminus">-const userAppDir = AddonTestUtils.profileDir.clone();</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineminus">-userAppDir.append(&quot;app-extensions&quot;);</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineminus">-userAppDir.create(Ci.nsIFile.DIRECTORY_TYPE, FileUtils.PERMS_DIRECTORY);</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineminus">-AddonTestUtils.registerDirectory(&quot;XREUSysExt&quot;, userAppDir);</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineminus">-</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineminus">-const userExtensions = userAppDir.clone();</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineminus">-userExtensions.append(APP_ID);</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineminus">-userExtensions.create(Ci.nsIFile.DIRECTORY_TYPE, FileUtils.PERMS_DIRECTORY);</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineminus">-</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineminus">-XPCOMUtils.defineLazyServiceGetters(this, {</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineminus">-  ChromeRegistry: [&quot;@mozilla.org/chrome/chrome-registry;1&quot;, &quot;nsIChromeRegistry&quot;],</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineminus">-});</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineminus">-</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineminus">-function hasChromeEntry(package) {</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineminus">-  try {</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineminus">-    void ChromeRegistry.convertChromeURL(Services.io.newURI(`chrome://${package}/content/`));</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineminus">-    return true;</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineminus">-  } catch (e) {</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineminus">-    return false;</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineminus">-  }</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineminus">-}</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineminus">-</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineminus">-add_task(async function() {</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineminus">-  await promiseWriteInstallRDFToXPI({</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineminus">-    id: &quot;langpack-foo@addons.mozilla.org&quot;,</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineminus">-    version: &quot;1.0&quot;,</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineminus">-    type: 8,</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineminus">-    targetApplications: [{</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineminus">-      id: &quot;xpcshell@tests.mozilla.org&quot;,</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineminus">-      minVersion: &quot;1&quot;,</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineminus">-      maxVersion: &quot;1&quot;,</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineminus">-    }],</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineminus">-    name: &quot;Invalid install.rdf extension&quot;,</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineminus">-  }, userExtensions, undefined, {</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineminus">-    &quot;chrome.manifest&quot;: `</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineminus">-      content foo-langpack ./</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineminus">-    `,</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineminus">-  });</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineminus">-</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineminus">-  await promiseWriteInstallRDFToXPI({</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineminus">-    id: &quot;foo@addons.mozilla.org&quot;,</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineminus">-    version: &quot;1.0&quot;,</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineminus">-    bootstrap: true,</span>
<a href="#l11.61"></a><span id="l11.61" class="difflineminus">-    targetApplications: [{</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineminus">-      id: &quot;xpcshell@tests.mozilla.org&quot;,</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineminus">-      minVersion: &quot;1&quot;,</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineminus">-      maxVersion: &quot;1&quot;,</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineminus">-    }],</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineminus">-    name: &quot;Invalid install.rdf extension&quot;,</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineminus">-  }, userExtensions, undefined, {</span>
<a href="#l11.68"></a><span id="l11.68" class="difflineminus">-    &quot;chrome.manifest&quot;: `</span>
<a href="#l11.69"></a><span id="l11.69" class="difflineminus">-      content foo ./</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineminus">-    `,</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineminus">-  });</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineminus">-</span>
<a href="#l11.73"></a><span id="l11.73" class="difflineminus">-  await promiseWriteInstallRDFToXPI({</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineminus">-    id: &quot;foo-legacy-legacy@addons.mozilla.org&quot;,</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineminus">-    version: &quot;1.0&quot;,</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineminus">-    bootstrap: false,</span>
<a href="#l11.77"></a><span id="l11.77" class="difflineminus">-    targetApplications: [{</span>
<a href="#l11.78"></a><span id="l11.78" class="difflineminus">-      id: &quot;xpcshell@tests.mozilla.org&quot;,</span>
<a href="#l11.79"></a><span id="l11.79" class="difflineminus">-      minVersion: &quot;1&quot;,</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineminus">-      maxVersion: &quot;1&quot;,</span>
<a href="#l11.81"></a><span id="l11.81" class="difflineminus">-    }],</span>
<a href="#l11.82"></a><span id="l11.82" class="difflineminus">-    name: &quot;Invalid install.rdf extension&quot;,</span>
<a href="#l11.83"></a><span id="l11.83" class="difflineminus">-  }, userExtensions, undefined, {</span>
<a href="#l11.84"></a><span id="l11.84" class="difflineminus">-    &quot;chrome.manifest&quot;: `</span>
<a href="#l11.85"></a><span id="l11.85" class="difflineminus">-      content foo-legacy-legacy ./</span>
<a href="#l11.86"></a><span id="l11.86" class="difflineminus">-    `,</span>
<a href="#l11.87"></a><span id="l11.87" class="difflineminus">-  });</span>
<a href="#l11.88"></a><span id="l11.88" class="difflineminus">-</span>
<a href="#l11.89"></a><span id="l11.89" class="difflineminus">-  equal(hasChromeEntry(&quot;foo-langpack&quot;), false,</span>
<a href="#l11.90"></a><span id="l11.90" class="difflineminus">-        &quot;Should not have registered foo-langpack resource before AOM startup&quot;);</span>
<a href="#l11.91"></a><span id="l11.91" class="difflineminus">-  equal(hasChromeEntry(&quot;foo-legacy-legacy&quot;), false,</span>
<a href="#l11.92"></a><span id="l11.92" class="difflineminus">-        &quot;Should not have registered foo-legacy-legacy resource before AOM startup&quot;);</span>
<a href="#l11.93"></a><span id="l11.93" class="difflineminus">-  equal(hasChromeEntry(&quot;foo&quot;), false,</span>
<a href="#l11.94"></a><span id="l11.94" class="difflineminus">-        &quot;Should not have registered foo resource before AOM startup&quot;);</span>
<a href="#l11.95"></a><span id="l11.95" class="difflineminus">-</span>
<a href="#l11.96"></a><span id="l11.96" class="difflineminus">-  await promiseStartupManager();</span>
<a href="#l11.97"></a><span id="l11.97" class="difflineminus">-</span>
<a href="#l11.98"></a><span id="l11.98" class="difflineminus">-  equal(hasChromeEntry(&quot;foo-langpack&quot;), false,</span>
<a href="#l11.99"></a><span id="l11.99" class="difflineminus">-        &quot;Should not have registered chrome manifest for invalid extension&quot;);</span>
<a href="#l11.100"></a><span id="l11.100" class="difflineminus">-  equal(hasChromeEntry(&quot;foo-legacy-legacy&quot;), false,</span>
<a href="#l11.101"></a><span id="l11.101" class="difflineminus">-        &quot;Should not have registered chrome manifest for non-restartless extension&quot;);</span>
<a href="#l11.102"></a><span id="l11.102" class="difflineminus">-  equal(hasChromeEntry(&quot;foo&quot;), true,</span>
<a href="#l11.103"></a><span id="l11.103" class="difflineminus">-        &quot;Should have registered chrome manifest for valid extension&quot;);</span>
<a href="#l11.104"></a><span id="l11.104" class="difflineminus">-</span>
<a href="#l11.105"></a><span id="l11.105" class="difflineminus">-  await promiseRestartManager();</span>
<a href="#l11.106"></a><span id="l11.106" class="difflineminus">-</span>
<a href="#l11.107"></a><span id="l11.107" class="difflineminus">-  equal(hasChromeEntry(&quot;foo-langpack&quot;), false,</span>
<a href="#l11.108"></a><span id="l11.108" class="difflineminus">-        &quot;Should still not have registered chrome manifest for invalid extension after restart&quot;);</span>
<a href="#l11.109"></a><span id="l11.109" class="difflineminus">-  equal(hasChromeEntry(&quot;foo-legacy-legacy&quot;), false,</span>
<a href="#l11.110"></a><span id="l11.110" class="difflineminus">-        &quot;Should still not have registered chrome manifest for non-restartless extension&quot;);</span>
<a href="#l11.111"></a><span id="l11.111" class="difflineminus">-  equal(hasChromeEntry(&quot;foo&quot;), true,</span>
<a href="#l11.112"></a><span id="l11.112" class="difflineminus">-        &quot;Should still have registered chrome manifest for valid extension after restart&quot;);</span>
<a href="#l11.113"></a><span id="l11.113" class="difflineminus">-</span>
<a href="#l11.114"></a><span id="l11.114" class="difflineminus">-  await promiseShutdownManager();</span>
<a href="#l11.115"></a><span id="l11.115" class="difflineminus">-</span>
<a href="#l11.116"></a><span id="l11.116" class="difflineminus">-  userAppDir.remove(true);</span>
<a href="#l11.117"></a><span id="l11.117" class="difflineminus">-});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1">deleted file mode 100644</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineminus">--- a/common/test/xpcshell/test_manifest.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineplus">+++ /dev/null</span>
<a href="#l12.4"></a><span id="l12.4" class="difflineat">@@ -1,752 +0,0 @@</span>
<a href="#l12.5"></a><span id="l12.5" class="difflineminus">-/* Any copyright is dedicated to the Public Domain.</span>
<a href="#l12.6"></a><span id="l12.6" class="difflineminus">- * http://creativecommons.org/publicdomain/zero/1.0/</span>
<a href="#l12.7"></a><span id="l12.7" class="difflineminus">- */</span>
<a href="#l12.8"></a><span id="l12.8" class="difflineminus">-</span>
<a href="#l12.9"></a><span id="l12.9" class="difflineminus">-// This tests that all properties are read from the install manifests and that</span>
<a href="#l12.10"></a><span id="l12.10" class="difflineminus">-// items are correctly enabled/disabled based on them (blocklist tests are</span>
<a href="#l12.11"></a><span id="l12.11" class="difflineminus">-// elsewhere)</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">-const ADDONS = [</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineminus">-  {</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineminus">-    &quot;install.rdf&quot;: {</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineminus">-      id: &quot;addon1@tests.mozilla.org&quot;,</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineminus">-      version: &quot;1.0&quot;,</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineminus">-      bootstrap: true,</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineminus">-      aboutURL: &quot;chrome://test/content/about.xul&quot;,</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineminus">-      iconURL: &quot;chrome://test/skin/icon.png&quot;,</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineminus">-      targetApplications: [{</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineminus">-        id: &quot;xpcshell@tests.mozilla.org&quot;,</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineminus">-        minVersion: &quot;1&quot;,</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineminus">-        maxVersion: &quot;1&quot;,</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineminus">-      }],</span>
<a href="#l12.26"></a><span id="l12.26" class="difflineminus">-      name: &quot;Test Addon 1&quot;,</span>
<a href="#l12.27"></a><span id="l12.27" class="difflineminus">-      description: &quot;Test Description&quot;,</span>
<a href="#l12.28"></a><span id="l12.28" class="difflineminus">-      creator: &quot;Test Creator&quot;,</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineminus">-      homepageURL: &quot;http://www.example.com&quot;,</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineminus">-      developer: [</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineminus">-        &quot;Test Developer 1&quot;,</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineminus">-        &quot;Test Developer 2&quot;,</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineminus">-      ],</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineminus">-      translator: [</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineminus">-        &quot;Test Translator 1&quot;,</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineminus">-        &quot;Test Translator 2&quot;,</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineminus">-      ],</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineminus">-      contributor: [</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineminus">-        &quot;Test Contributor 1&quot;,</span>
<a href="#l12.40"></a><span id="l12.40" class="difflineminus">-        &quot;Test Contributor 2&quot;,</span>
<a href="#l12.41"></a><span id="l12.41" class="difflineminus">-      ],</span>
<a href="#l12.42"></a><span id="l12.42" class="difflineminus">-    },</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineminus">-</span>
<a href="#l12.44"></a><span id="l12.44" class="difflineminus">-    expected: {</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineminus">-      id: &quot;addon1@tests.mozilla.org&quot;,</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineminus">-      type: &quot;extension&quot;,</span>
<a href="#l12.47"></a><span id="l12.47" class="difflineminus">-      version: &quot;1.0&quot;,</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineminus">-      optionsType: null,</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineminus">-      aboutURL: &quot;chrome://test/content/about.xul&quot;,</span>
<a href="#l12.50"></a><span id="l12.50" class="difflineminus">-      iconURL: &quot;chrome://test/skin/icon.png&quot;,</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineminus">-      icons: {32: &quot;chrome://test/skin/icon.png&quot;, 48: &quot;chrome://test/skin/icon.png&quot;},</span>
<a href="#l12.52"></a><span id="l12.52" class="difflineminus">-      name: &quot;Test Addon 1&quot;,</span>
<a href="#l12.53"></a><span id="l12.53" class="difflineminus">-      description: &quot;Test Description&quot;,</span>
<a href="#l12.54"></a><span id="l12.54" class="difflineminus">-      creator: &quot;Test Creator&quot;,</span>
<a href="#l12.55"></a><span id="l12.55" class="difflineminus">-      homepageURL: &quot;http://www.example.com&quot;,</span>
<a href="#l12.56"></a><span id="l12.56" class="difflineminus">-      developers: [&quot;Test Developer 1&quot;, &quot;Test Developer 2&quot;],</span>
<a href="#l12.57"></a><span id="l12.57" class="difflineminus">-      translators: [&quot;Test Translator 1&quot;, &quot;Test Translator 2&quot;],</span>
<a href="#l12.58"></a><span id="l12.58" class="difflineminus">-      contributors: [&quot;Test Contributor 1&quot;, &quot;Test Contributor 2&quot;],</span>
<a href="#l12.59"></a><span id="l12.59" class="difflineminus">-      isActive: true,</span>
<a href="#l12.60"></a><span id="l12.60" class="difflineminus">-      userDisabled: false,</span>
<a href="#l12.61"></a><span id="l12.61" class="difflineminus">-      appDisabled: false,</span>
<a href="#l12.62"></a><span id="l12.62" class="difflineminus">-      isCompatible: true,</span>
<a href="#l12.63"></a><span id="l12.63" class="difflineminus">-      providesUpdatesSecurely: true,</span>
<a href="#l12.64"></a><span id="l12.64" class="difflineminus">-      blocklistState: Ci.nsIBlocklistService.STATE_NOT_BLOCKED,</span>
<a href="#l12.65"></a><span id="l12.65" class="difflineminus">-    },</span>
<a href="#l12.66"></a><span id="l12.66" class="difflineminus">-  },</span>
<a href="#l12.67"></a><span id="l12.67" class="difflineminus">-</span>
<a href="#l12.68"></a><span id="l12.68" class="difflineminus">-  {</span>
<a href="#l12.69"></a><span id="l12.69" class="difflineminus">-    &quot;install.rdf&quot;: {</span>
<a href="#l12.70"></a><span id="l12.70" class="difflineminus">-      id: &quot;addon2@tests.mozilla.org&quot;,</span>
<a href="#l12.71"></a><span id="l12.71" class="difflineminus">-      version: &quot;1.0&quot;,</span>
<a href="#l12.72"></a><span id="l12.72" class="difflineminus">-      bootstrap: true,</span>
<a href="#l12.73"></a><span id="l12.73" class="difflineminus">-      updateURL: &quot;https://www.foo.com&quot;,</span>
<a href="#l12.74"></a><span id="l12.74" class="difflineminus">-      targetApplications: [{</span>
<a href="#l12.75"></a><span id="l12.75" class="difflineminus">-        id: &quot;xpcshell@tests.mozilla.org&quot;,</span>
<a href="#l12.76"></a><span id="l12.76" class="difflineminus">-        minVersion: &quot;1&quot;,</span>
<a href="#l12.77"></a><span id="l12.77" class="difflineminus">-        maxVersion: &quot;1&quot;,</span>
<a href="#l12.78"></a><span id="l12.78" class="difflineminus">-      }],</span>
<a href="#l12.79"></a><span id="l12.79" class="difflineminus">-      name: &quot;Test Addon 2&quot;,</span>
<a href="#l12.80"></a><span id="l12.80" class="difflineminus">-    },</span>
<a href="#l12.81"></a><span id="l12.81" class="difflineminus">-</span>
<a href="#l12.82"></a><span id="l12.82" class="difflineminus">-    expected: {</span>
<a href="#l12.83"></a><span id="l12.83" class="difflineminus">-      id: &quot;addon2@tests.mozilla.org&quot;,</span>
<a href="#l12.84"></a><span id="l12.84" class="difflineminus">-      isActive: true,</span>
<a href="#l12.85"></a><span id="l12.85" class="difflineminus">-      userDisabled: false,</span>
<a href="#l12.86"></a><span id="l12.86" class="difflineminus">-      appDisabled: false,</span>
<a href="#l12.87"></a><span id="l12.87" class="difflineminus">-      providesUpdatesSecurely: true,</span>
<a href="#l12.88"></a><span id="l12.88" class="difflineminus">-    },</span>
<a href="#l12.89"></a><span id="l12.89" class="difflineminus">-  },</span>
<a href="#l12.90"></a><span id="l12.90" class="difflineminus">-</span>
<a href="#l12.91"></a><span id="l12.91" class="difflineminus">-  {</span>
<a href="#l12.92"></a><span id="l12.92" class="difflineminus">-    &quot;install.rdf&quot;: {</span>
<a href="#l12.93"></a><span id="l12.93" class="difflineminus">-      id: &quot;addon3@tests.mozilla.org&quot;,</span>
<a href="#l12.94"></a><span id="l12.94" class="difflineminus">-      version: &quot;1.0&quot;,</span>
<a href="#l12.95"></a><span id="l12.95" class="difflineminus">-      bootstrap: true,</span>
<a href="#l12.96"></a><span id="l12.96" class="difflineminus">-      updateURL: &quot;http://www.foo.com&quot;,</span>
<a href="#l12.97"></a><span id="l12.97" class="difflineminus">-      targetApplications: [{</span>
<a href="#l12.98"></a><span id="l12.98" class="difflineminus">-        id: &quot;xpcshell@tests.mozilla.org&quot;,</span>
<a href="#l12.99"></a><span id="l12.99" class="difflineminus">-        minVersion: &quot;1&quot;,</span>
<a href="#l12.100"></a><span id="l12.100" class="difflineminus">-        maxVersion: &quot;1&quot;,</span>
<a href="#l12.101"></a><span id="l12.101" class="difflineminus">-      }],</span>
<a href="#l12.102"></a><span id="l12.102" class="difflineminus">-      name: &quot;Test Addon 3&quot;,</span>
<a href="#l12.103"></a><span id="l12.103" class="difflineminus">-    },</span>
<a href="#l12.104"></a><span id="l12.104" class="difflineminus">-</span>
<a href="#l12.105"></a><span id="l12.105" class="difflineminus">-    expected: {</span>
<a href="#l12.106"></a><span id="l12.106" class="difflineminus">-      id: &quot;addon3@tests.mozilla.org&quot;,</span>
<a href="#l12.107"></a><span id="l12.107" class="difflineminus">-      isActive: false,</span>
<a href="#l12.108"></a><span id="l12.108" class="difflineminus">-      userDisabled: false,</span>
<a href="#l12.109"></a><span id="l12.109" class="difflineminus">-      appDisabled: true,</span>
<a href="#l12.110"></a><span id="l12.110" class="difflineminus">-      providesUpdatesSecurely: false,</span>
<a href="#l12.111"></a><span id="l12.111" class="difflineminus">-    },</span>
<a href="#l12.112"></a><span id="l12.112" class="difflineminus">-  },</span>
<a href="#l12.113"></a><span id="l12.113" class="difflineminus">-</span>
<a href="#l12.114"></a><span id="l12.114" class="difflineminus">-  {</span>
<a href="#l12.115"></a><span id="l12.115" class="difflineminus">-    &quot;install.rdf&quot;: {</span>
<a href="#l12.116"></a><span id="l12.116" class="difflineminus">-      id: &quot;addon4@tests.mozilla.org&quot;,</span>
<a href="#l12.117"></a><span id="l12.117" class="difflineminus">-      version: &quot;1.0&quot;,</span>
<a href="#l12.118"></a><span id="l12.118" class="difflineminus">-      bootstrap: true,</span>
<a href="#l12.119"></a><span id="l12.119" class="difflineminus">-      updateURL: &quot;http://www.foo.com&quot;,</span>
<a href="#l12.120"></a><span id="l12.120" class="difflineminus">-      updateKey: &quot;foo&quot;,</span>
<a href="#l12.121"></a><span id="l12.121" class="difflineminus">-      targetApplications: [{</span>
<a href="#l12.122"></a><span id="l12.122" class="difflineminus">-        id: &quot;xpcshell@tests.mozilla.org&quot;,</span>
<a href="#l12.123"></a><span id="l12.123" class="difflineminus">-        minVersion: &quot;1&quot;,</span>
<a href="#l12.124"></a><span id="l12.124" class="difflineminus">-        maxVersion: &quot;1&quot;,</span>
<a href="#l12.125"></a><span id="l12.125" class="difflineminus">-      }],</span>
<a href="#l12.126"></a><span id="l12.126" class="difflineminus">-      name: &quot;Test Addon 4&quot;,</span>
<a href="#l12.127"></a><span id="l12.127" class="difflineminus">-    },</span>
<a href="#l12.128"></a><span id="l12.128" class="difflineminus">-</span>
<a href="#l12.129"></a><span id="l12.129" class="difflineminus">-    expected: {</span>
<a href="#l12.130"></a><span id="l12.130" class="difflineminus">-      id: &quot;addon4@tests.mozilla.org&quot;,</span>
<a href="#l12.131"></a><span id="l12.131" class="difflineminus">-      isActive: false,</span>
<a href="#l12.132"></a><span id="l12.132" class="difflineminus">-      userDisabled: false,</span>
<a href="#l12.133"></a><span id="l12.133" class="difflineminus">-      appDisabled: true,</span>
<a href="#l12.134"></a><span id="l12.134" class="difflineminus">-      providesUpdatesSecurely: false,</span>
<a href="#l12.135"></a><span id="l12.135" class="difflineminus">-    },</span>
<a href="#l12.136"></a><span id="l12.136" class="difflineminus">-  },</span>
<a href="#l12.137"></a><span id="l12.137" class="difflineminus">-</span>
<a href="#l12.138"></a><span id="l12.138" class="difflineminus">-  {</span>
<a href="#l12.139"></a><span id="l12.139" class="difflineminus">-    &quot;install.rdf&quot;: {</span>
<a href="#l12.140"></a><span id="l12.140" class="difflineminus">-      id: &quot;addon5@tests.mozilla.org&quot;,</span>
<a href="#l12.141"></a><span id="l12.141" class="difflineminus">-      version: &quot;1.0&quot;,</span>
<a href="#l12.142"></a><span id="l12.142" class="difflineminus">-      bootstrap: true,</span>
<a href="#l12.143"></a><span id="l12.143" class="difflineminus">-      targetApplications: [{</span>
<a href="#l12.144"></a><span id="l12.144" class="difflineminus">-        id: &quot;xpcshell@tests.mozilla.org&quot;,</span>
<a href="#l12.145"></a><span id="l12.145" class="difflineminus">-        minVersion: &quot;1&quot;,</span>
<a href="#l12.146"></a><span id="l12.146" class="difflineminus">-        maxVersion: &quot;*&quot;,</span>
<a href="#l12.147"></a><span id="l12.147" class="difflineminus">-      }],</span>
<a href="#l12.148"></a><span id="l12.148" class="difflineminus">-      name: &quot;Test Addon 5&quot;,</span>
<a href="#l12.149"></a><span id="l12.149" class="difflineminus">-    },</span>
<a href="#l12.150"></a><span id="l12.150" class="difflineminus">-</span>
<a href="#l12.151"></a><span id="l12.151" class="difflineminus">-    expected: {</span>
<a href="#l12.152"></a><span id="l12.152" class="difflineminus">-      isActive: true,</span>
<a href="#l12.153"></a><span id="l12.153" class="difflineminus">-      userDisabled: false,</span>
<a href="#l12.154"></a><span id="l12.154" class="difflineminus">-      appDisabled: false,</span>
<a href="#l12.155"></a><span id="l12.155" class="difflineminus">-      isCompatible: true,</span>
<a href="#l12.156"></a><span id="l12.156" class="difflineminus">-    },</span>
<a href="#l12.157"></a><span id="l12.157" class="difflineminus">-  },</span>
<a href="#l12.158"></a><span id="l12.158" class="difflineminus">-</span>
<a href="#l12.159"></a><span id="l12.159" class="difflineminus">-  {</span>
<a href="#l12.160"></a><span id="l12.160" class="difflineminus">-    &quot;install.rdf&quot;: {</span>
<a href="#l12.161"></a><span id="l12.161" class="difflineminus">-      id: &quot;addon6@tests.mozilla.org&quot;,</span>
<a href="#l12.162"></a><span id="l12.162" class="difflineminus">-      version: &quot;1.0&quot;,</span>
<a href="#l12.163"></a><span id="l12.163" class="difflineminus">-      bootstrap: true,</span>
<a href="#l12.164"></a><span id="l12.164" class="difflineminus">-      targetApplications: [{</span>
<a href="#l12.165"></a><span id="l12.165" class="difflineminus">-        id: &quot;xpcshell@tests.mozilla.org&quot;,</span>
<a href="#l12.166"></a><span id="l12.166" class="difflineminus">-        minVersion: &quot;0&quot;,</span>
<a href="#l12.167"></a><span id="l12.167" class="difflineminus">-        maxVersion: &quot;1&quot;,</span>
<a href="#l12.168"></a><span id="l12.168" class="difflineminus">-      }],</span>
<a href="#l12.169"></a><span id="l12.169" class="difflineminus">-      name: &quot;Test Addon 6&quot;,</span>
<a href="#l12.170"></a><span id="l12.170" class="difflineminus">-    },</span>
<a href="#l12.171"></a><span id="l12.171" class="difflineminus">-</span>
<a href="#l12.172"></a><span id="l12.172" class="difflineminus">-    expected: {</span>
<a href="#l12.173"></a><span id="l12.173" class="difflineminus">-      isActive: true,</span>
<a href="#l12.174"></a><span id="l12.174" class="difflineminus">-      userDisabled: false,</span>
<a href="#l12.175"></a><span id="l12.175" class="difflineminus">-      appDisabled: false,</span>
<a href="#l12.176"></a><span id="l12.176" class="difflineminus">-      isCompatible: true,</span>
<a href="#l12.177"></a><span id="l12.177" class="difflineminus">-    },</span>
<a href="#l12.178"></a><span id="l12.178" class="difflineminus">-  },</span>
<a href="#l12.179"></a><span id="l12.179" class="difflineminus">-</span>
<a href="#l12.180"></a><span id="l12.180" class="difflineminus">-  {</span>
<a href="#l12.181"></a><span id="l12.181" class="difflineminus">-    &quot;install.rdf&quot;: {</span>
<a href="#l12.182"></a><span id="l12.182" class="difflineminus">-      id: &quot;addon7@tests.mozilla.org&quot;,</span>
<a href="#l12.183"></a><span id="l12.183" class="difflineminus">-      version: &quot;1.0&quot;,</span>
<a href="#l12.184"></a><span id="l12.184" class="difflineminus">-      bootstrap: true,</span>
<a href="#l12.185"></a><span id="l12.185" class="difflineminus">-      targetApplications: [{</span>
<a href="#l12.186"></a><span id="l12.186" class="difflineminus">-        id: &quot;xpcshell@tests.mozilla.org&quot;,</span>
<a href="#l12.187"></a><span id="l12.187" class="difflineminus">-        minVersion: &quot;0&quot;,</span>
<a href="#l12.188"></a><span id="l12.188" class="difflineminus">-        maxVersion: &quot;0&quot;,</span>
<a href="#l12.189"></a><span id="l12.189" class="difflineminus">-      }],</span>
<a href="#l12.190"></a><span id="l12.190" class="difflineminus">-      name: &quot;Test Addon 7&quot;,</span>
<a href="#l12.191"></a><span id="l12.191" class="difflineminus">-    },</span>
<a href="#l12.192"></a><span id="l12.192" class="difflineminus">-</span>
<a href="#l12.193"></a><span id="l12.193" class="difflineminus">-    expected: {</span>
<a href="#l12.194"></a><span id="l12.194" class="difflineminus">-      isActive: false,</span>
<a href="#l12.195"></a><span id="l12.195" class="difflineminus">-      userDisabled: false,</span>
<a href="#l12.196"></a><span id="l12.196" class="difflineminus">-      appDisabled: true,</span>
<a href="#l12.197"></a><span id="l12.197" class="difflineminus">-      isCompatible: false,</span>
<a href="#l12.198"></a><span id="l12.198" class="difflineminus">-    },</span>
<a href="#l12.199"></a><span id="l12.199" class="difflineminus">-  },</span>
<a href="#l12.200"></a><span id="l12.200" class="difflineminus">-</span>
<a href="#l12.201"></a><span id="l12.201" class="difflineminus">-  {</span>
<a href="#l12.202"></a><span id="l12.202" class="difflineminus">-    &quot;install.rdf&quot;: {</span>
<a href="#l12.203"></a><span id="l12.203" class="difflineminus">-      id: &quot;addon8@tests.mozilla.org&quot;,</span>
<a href="#l12.204"></a><span id="l12.204" class="difflineminus">-      version: &quot;1.0&quot;,</span>
<a href="#l12.205"></a><span id="l12.205" class="difflineminus">-      bootstrap: true,</span>
<a href="#l12.206"></a><span id="l12.206" class="difflineminus">-      targetApplications: [{</span>
<a href="#l12.207"></a><span id="l12.207" class="difflineminus">-        id: &quot;xpcshell@tests.mozilla.org&quot;,</span>
<a href="#l12.208"></a><span id="l12.208" class="difflineminus">-        minVersion: &quot;1.1&quot;,</span>
<a href="#l12.209"></a><span id="l12.209" class="difflineminus">-        maxVersion: &quot;*&quot;,</span>
<a href="#l12.210"></a><span id="l12.210" class="difflineminus">-      }],</span>
<a href="#l12.211"></a><span id="l12.211" class="difflineminus">-      name: &quot;Test Addon 8&quot;,</span>
<a href="#l12.212"></a><span id="l12.212" class="difflineminus">-    },</span>
<a href="#l12.213"></a><span id="l12.213" class="difflineminus">-</span>
<a href="#l12.214"></a><span id="l12.214" class="difflineminus">-    expected: {</span>
<a href="#l12.215"></a><span id="l12.215" class="difflineminus">-      isActive: false,</span>
<a href="#l12.216"></a><span id="l12.216" class="difflineminus">-      userDisabled: false,</span>
<a href="#l12.217"></a><span id="l12.217" class="difflineminus">-      appDisabled: true,</span>
<a href="#l12.218"></a><span id="l12.218" class="difflineminus">-      isCompatible: false,</span>
<a href="#l12.219"></a><span id="l12.219" class="difflineminus">-    },</span>
<a href="#l12.220"></a><span id="l12.220" class="difflineminus">-  },</span>
<a href="#l12.221"></a><span id="l12.221" class="difflineminus">-</span>
<a href="#l12.222"></a><span id="l12.222" class="difflineminus">-  {</span>
<a href="#l12.223"></a><span id="l12.223" class="difflineminus">-    &quot;install.rdf&quot;: {</span>
<a href="#l12.224"></a><span id="l12.224" class="difflineminus">-      id: &quot;addon9@tests.mozilla.org&quot;,</span>
<a href="#l12.225"></a><span id="l12.225" class="difflineminus">-      version: &quot;1.0&quot;,</span>
<a href="#l12.226"></a><span id="l12.226" class="difflineminus">-      bootstrap: true,</span>
<a href="#l12.227"></a><span id="l12.227" class="difflineminus">-      targetApplications: [{</span>
<a href="#l12.228"></a><span id="l12.228" class="difflineminus">-        id: &quot;toolkit@mozilla.org&quot;,</span>
<a href="#l12.229"></a><span id="l12.229" class="difflineminus">-        minVersion: &quot;1.9.2&quot;,</span>
<a href="#l12.230"></a><span id="l12.230" class="difflineminus">-        maxVersion: &quot;1.9.*&quot;,</span>
<a href="#l12.231"></a><span id="l12.231" class="difflineminus">-      }],</span>
<a href="#l12.232"></a><span id="l12.232" class="difflineminus">-      name: &quot;Test Addon 9&quot;,</span>
<a href="#l12.233"></a><span id="l12.233" class="difflineminus">-    },</span>
<a href="#l12.234"></a><span id="l12.234" class="difflineminus">-</span>
<a href="#l12.235"></a><span id="l12.235" class="difflineminus">-    expected: {</span>
<a href="#l12.236"></a><span id="l12.236" class="difflineminus">-      isActive: true,</span>
<a href="#l12.237"></a><span id="l12.237" class="difflineminus">-      userDisabled: false,</span>
<a href="#l12.238"></a><span id="l12.238" class="difflineminus">-      appDisabled: false,</span>
<a href="#l12.239"></a><span id="l12.239" class="difflineminus">-      isCompatible: true,</span>
<a href="#l12.240"></a><span id="l12.240" class="difflineminus">-    },</span>
<a href="#l12.241"></a><span id="l12.241" class="difflineminus">-  },</span>
<a href="#l12.242"></a><span id="l12.242" class="difflineminus">-</span>
<a href="#l12.243"></a><span id="l12.243" class="difflineminus">-  {</span>
<a href="#l12.244"></a><span id="l12.244" class="difflineminus">-    &quot;install.rdf&quot;: {</span>
<a href="#l12.245"></a><span id="l12.245" class="difflineminus">-      id: &quot;addon10@tests.mozilla.org&quot;,</span>
<a href="#l12.246"></a><span id="l12.246" class="difflineminus">-      version: &quot;1.0&quot;,</span>
<a href="#l12.247"></a><span id="l12.247" class="difflineminus">-      bootstrap: true,</span>
<a href="#l12.248"></a><span id="l12.248" class="difflineminus">-      targetApplications: [{</span>
<a href="#l12.249"></a><span id="l12.249" class="difflineminus">-        id: &quot;toolkit@mozilla.org&quot;,</span>
<a href="#l12.250"></a><span id="l12.250" class="difflineminus">-        minVersion: &quot;1.9.2.1&quot;,</span>
<a href="#l12.251"></a><span id="l12.251" class="difflineminus">-        maxVersion: &quot;1.9.*&quot;,</span>
<a href="#l12.252"></a><span id="l12.252" class="difflineminus">-      }],</span>
<a href="#l12.253"></a><span id="l12.253" class="difflineminus">-      name: &quot;Test Addon 10&quot;,</span>
<a href="#l12.254"></a><span id="l12.254" class="difflineminus">-    },</span>
<a href="#l12.255"></a><span id="l12.255" class="difflineminus">-</span>
<a href="#l12.256"></a><span id="l12.256" class="difflineminus">-    expected: {</span>
<a href="#l12.257"></a><span id="l12.257" class="difflineminus">-      isActive: false,</span>
<a href="#l12.258"></a><span id="l12.258" class="difflineminus">-      userDisabled: false,</span>
<a href="#l12.259"></a><span id="l12.259" class="difflineminus">-      appDisabled: true,</span>
<a href="#l12.260"></a><span id="l12.260" class="difflineminus">-      isCompatible: false,</span>
<a href="#l12.261"></a><span id="l12.261" class="difflineminus">-    },</span>
<a href="#l12.262"></a><span id="l12.262" class="difflineminus">-  },</span>
<a href="#l12.263"></a><span id="l12.263" class="difflineminus">-</span>
<a href="#l12.264"></a><span id="l12.264" class="difflineminus">-  {</span>
<a href="#l12.265"></a><span id="l12.265" class="difflineminus">-    &quot;install.rdf&quot;: {</span>
<a href="#l12.266"></a><span id="l12.266" class="difflineminus">-      id: &quot;addon11@tests.mozilla.org&quot;,</span>
<a href="#l12.267"></a><span id="l12.267" class="difflineminus">-      version: &quot;1.0&quot;,</span>
<a href="#l12.268"></a><span id="l12.268" class="difflineminus">-      bootstrap: true,</span>
<a href="#l12.269"></a><span id="l12.269" class="difflineminus">-      targetApplications: [{</span>
<a href="#l12.270"></a><span id="l12.270" class="difflineminus">-        id: &quot;toolkit@mozilla.org&quot;,</span>
<a href="#l12.271"></a><span id="l12.271" class="difflineminus">-        minVersion: &quot;1.9&quot;,</span>
<a href="#l12.272"></a><span id="l12.272" class="difflineminus">-        maxVersion: &quot;1.9.2&quot;,</span>
<a href="#l12.273"></a><span id="l12.273" class="difflineminus">-      }],</span>
<a href="#l12.274"></a><span id="l12.274" class="difflineminus">-      name: &quot;Test Addon 11&quot;,</span>
<a href="#l12.275"></a><span id="l12.275" class="difflineminus">-    },</span>
<a href="#l12.276"></a><span id="l12.276" class="difflineminus">-</span>
<a href="#l12.277"></a><span id="l12.277" class="difflineminus">-    expected: {</span>
<a href="#l12.278"></a><span id="l12.278" class="difflineminus">-      isActive: true,</span>
<a href="#l12.279"></a><span id="l12.279" class="difflineminus">-      userDisabled: false,</span>
<a href="#l12.280"></a><span id="l12.280" class="difflineminus">-      appDisabled: false,</span>
<a href="#l12.281"></a><span id="l12.281" class="difflineminus">-      isCompatible: true,</span>
<a href="#l12.282"></a><span id="l12.282" class="difflineminus">-    },</span>
<a href="#l12.283"></a><span id="l12.283" class="difflineminus">-  },</span>
<a href="#l12.284"></a><span id="l12.284" class="difflineminus">-</span>
<a href="#l12.285"></a><span id="l12.285" class="difflineminus">-  {</span>
<a href="#l12.286"></a><span id="l12.286" class="difflineminus">-    &quot;install.rdf&quot;: {</span>
<a href="#l12.287"></a><span id="l12.287" class="difflineminus">-      id: &quot;addon12@tests.mozilla.org&quot;,</span>
<a href="#l12.288"></a><span id="l12.288" class="difflineminus">-      version: &quot;1.0&quot;,</span>
<a href="#l12.289"></a><span id="l12.289" class="difflineminus">-      bootstrap: true,</span>
<a href="#l12.290"></a><span id="l12.290" class="difflineminus">-      targetApplications: [{</span>
<a href="#l12.291"></a><span id="l12.291" class="difflineminus">-        id: &quot;toolkit@mozilla.org&quot;,</span>
<a href="#l12.292"></a><span id="l12.292" class="difflineminus">-        minVersion: &quot;1.9&quot;,</span>
<a href="#l12.293"></a><span id="l12.293" class="difflineminus">-        maxVersion: &quot;1.9.1.*&quot;,</span>
<a href="#l12.294"></a><span id="l12.294" class="difflineminus">-      }],</span>
<a href="#l12.295"></a><span id="l12.295" class="difflineminus">-      name: &quot;Test Addon 12&quot;,</span>
<a href="#l12.296"></a><span id="l12.296" class="difflineminus">-    },</span>
<a href="#l12.297"></a><span id="l12.297" class="difflineminus">-</span>
<a href="#l12.298"></a><span id="l12.298" class="difflineminus">-    expected: {</span>
<a href="#l12.299"></a><span id="l12.299" class="difflineminus">-      isActive: false,</span>
<a href="#l12.300"></a><span id="l12.300" class="difflineminus">-      userDisabled: false,</span>
<a href="#l12.301"></a><span id="l12.301" class="difflineminus">-      appDisabled: true,</span>
<a href="#l12.302"></a><span id="l12.302" class="difflineminus">-      isCompatible: false,</span>
<a href="#l12.303"></a><span id="l12.303" class="difflineminus">-    },</span>
<a href="#l12.304"></a><span id="l12.304" class="difflineminus">-  },</span>
<a href="#l12.305"></a><span id="l12.305" class="difflineminus">-</span>
<a href="#l12.306"></a><span id="l12.306" class="difflineminus">-  {</span>
<a href="#l12.307"></a><span id="l12.307" class="difflineminus">-    &quot;install.rdf&quot;: {</span>
<a href="#l12.308"></a><span id="l12.308" class="difflineminus">-      id: &quot;addon13@tests.mozilla.org&quot;,</span>
<a href="#l12.309"></a><span id="l12.309" class="difflineminus">-      version: &quot;1.0&quot;,</span>
<a href="#l12.310"></a><span id="l12.310" class="difflineminus">-      bootstrap: true,</span>
<a href="#l12.311"></a><span id="l12.311" class="difflineminus">-      targetApplications: [{</span>
<a href="#l12.312"></a><span id="l12.312" class="difflineminus">-        id: &quot;toolkit@mozilla.org&quot;,</span>
<a href="#l12.313"></a><span id="l12.313" class="difflineminus">-        minVersion: &quot;1.9&quot;,</span>
<a href="#l12.314"></a><span id="l12.314" class="difflineminus">-        maxVersion: &quot;1.9.*&quot;,</span>
<a href="#l12.315"></a><span id="l12.315" class="difflineminus">-      }, {</span>
<a href="#l12.316"></a><span id="l12.316" class="difflineminus">-        id: &quot;xpcshell@tests.mozilla.org&quot;,</span>
<a href="#l12.317"></a><span id="l12.317" class="difflineminus">-        minVersion: &quot;0&quot;,</span>
<a href="#l12.318"></a><span id="l12.318" class="difflineminus">-        maxVersion: &quot;0.5&quot;,</span>
<a href="#l12.319"></a><span id="l12.319" class="difflineminus">-      }],</span>
<a href="#l12.320"></a><span id="l12.320" class="difflineminus">-      name: &quot;Test Addon 13&quot;,</span>
<a href="#l12.321"></a><span id="l12.321" class="difflineminus">-    },</span>
<a href="#l12.322"></a><span id="l12.322" class="difflineminus">-</span>
<a href="#l12.323"></a><span id="l12.323" class="difflineminus">-    expected: {</span>
<a href="#l12.324"></a><span id="l12.324" class="difflineminus">-      isActive: false,</span>
<a href="#l12.325"></a><span id="l12.325" class="difflineminus">-      userDisabled: false,</span>
<a href="#l12.326"></a><span id="l12.326" class="difflineminus">-      appDisabled: true,</span>
<a href="#l12.327"></a><span id="l12.327" class="difflineminus">-      isCompatible: false,</span>
<a href="#l12.328"></a><span id="l12.328" class="difflineminus">-    },</span>
<a href="#l12.329"></a><span id="l12.329" class="difflineminus">-  },</span>
<a href="#l12.330"></a><span id="l12.330" class="difflineminus">-</span>
<a href="#l12.331"></a><span id="l12.331" class="difflineminus">-  {</span>
<a href="#l12.332"></a><span id="l12.332" class="difflineminus">-    &quot;install.rdf&quot;: {</span>
<a href="#l12.333"></a><span id="l12.333" class="difflineminus">-      id: &quot;addon14@tests.mozilla.org&quot;,</span>
<a href="#l12.334"></a><span id="l12.334" class="difflineminus">-      version: &quot;1.0&quot;,</span>
<a href="#l12.335"></a><span id="l12.335" class="difflineminus">-      bootstrap: true,</span>
<a href="#l12.336"></a><span id="l12.336" class="difflineminus">-      targetApplications: [{</span>
<a href="#l12.337"></a><span id="l12.337" class="difflineminus">-        id: &quot;toolkit@mozilla.org&quot;,</span>
<a href="#l12.338"></a><span id="l12.338" class="difflineminus">-        minVersion: &quot;1.9&quot;,</span>
<a href="#l12.339"></a><span id="l12.339" class="difflineminus">-        maxVersion: &quot;1.9.1&quot;,</span>
<a href="#l12.340"></a><span id="l12.340" class="difflineminus">-      }, {</span>
<a href="#l12.341"></a><span id="l12.341" class="difflineminus">-        id: &quot;xpcshell@tests.mozilla.org&quot;,</span>
<a href="#l12.342"></a><span id="l12.342" class="difflineminus">-        minVersion: &quot;1&quot;,</span>
<a href="#l12.343"></a><span id="l12.343" class="difflineminus">-        maxVersion: &quot;1&quot;,</span>
<a href="#l12.344"></a><span id="l12.344" class="difflineminus">-      }],</span>
<a href="#l12.345"></a><span id="l12.345" class="difflineminus">-      name: &quot;Test Addon 14&quot;,</span>
<a href="#l12.346"></a><span id="l12.346" class="difflineminus">-    },</span>
<a href="#l12.347"></a><span id="l12.347" class="difflineminus">-</span>
<a href="#l12.348"></a><span id="l12.348" class="difflineminus">-    expected: {</span>
<a href="#l12.349"></a><span id="l12.349" class="difflineminus">-      isActive: true,</span>
<a href="#l12.350"></a><span id="l12.350" class="difflineminus">-      userDisabled: false,</span>
<a href="#l12.351"></a><span id="l12.351" class="difflineminus">-      appDisabled: false,</span>
<a href="#l12.352"></a><span id="l12.352" class="difflineminus">-      isCompatible: true,</span>
<a href="#l12.353"></a><span id="l12.353" class="difflineminus">-    },</span>
<a href="#l12.354"></a><span id="l12.354" class="difflineminus">-  },</span>
<a href="#l12.355"></a><span id="l12.355" class="difflineminus">-</span>
<a href="#l12.356"></a><span id="l12.356" class="difflineminus">-  {</span>
<a href="#l12.357"></a><span id="l12.357" class="difflineminus">-    &quot;install.rdf&quot;: {</span>
<a href="#l12.358"></a><span id="l12.358" class="difflineminus">-      id: &quot;addon15@tests.mozilla.org&quot;,</span>
<a href="#l12.359"></a><span id="l12.359" class="difflineminus">-      version: &quot;1.0&quot;,</span>
<a href="#l12.360"></a><span id="l12.360" class="difflineminus">-      bootstrap: true,</span>
<a href="#l12.361"></a><span id="l12.361" class="difflineminus">-      updateKey: &quot;foo&quot;,</span>
<a href="#l12.362"></a><span id="l12.362" class="difflineminus">-      targetApplications: [{</span>
<a href="#l12.363"></a><span id="l12.363" class="difflineminus">-        id: &quot;xpcshell@tests.mozilla.org&quot;,</span>
<a href="#l12.364"></a><span id="l12.364" class="difflineminus">-        minVersion: &quot;1&quot;,</span>
<a href="#l12.365"></a><span id="l12.365" class="difflineminus">-        maxVersion: &quot;1&quot;,</span>
<a href="#l12.366"></a><span id="l12.366" class="difflineminus">-      }],</span>
<a href="#l12.367"></a><span id="l12.367" class="difflineminus">-      name: &quot;Test Addon 15&quot;,</span>
<a href="#l12.368"></a><span id="l12.368" class="difflineminus">-    },</span>
<a href="#l12.369"></a><span id="l12.369" class="difflineminus">-</span>
<a href="#l12.370"></a><span id="l12.370" class="difflineminus">-    expected: {</span>
<a href="#l12.371"></a><span id="l12.371" class="difflineminus">-      isActive: true,</span>
<a href="#l12.372"></a><span id="l12.372" class="difflineminus">-      userDisabled: false,</span>
<a href="#l12.373"></a><span id="l12.373" class="difflineminus">-      appDisabled: false,</span>
<a href="#l12.374"></a><span id="l12.374" class="difflineminus">-      isCompatible: true,</span>
<a href="#l12.375"></a><span id="l12.375" class="difflineminus">-      providesUpdatesSecurely: true,</span>
<a href="#l12.376"></a><span id="l12.376" class="difflineminus">-    },</span>
<a href="#l12.377"></a><span id="l12.377" class="difflineminus">-  },</span>
<a href="#l12.378"></a><span id="l12.378" class="difflineminus">-</span>
<a href="#l12.379"></a><span id="l12.379" class="difflineminus">-  {</span>
<a href="#l12.380"></a><span id="l12.380" class="difflineminus">-    &quot;install.rdf&quot;: {</span>
<a href="#l12.381"></a><span id="l12.381" class="difflineminus">-      id: &quot;addon16@tests.mozilla.org&quot;,</span>
<a href="#l12.382"></a><span id="l12.382" class="difflineminus">-      version: &quot;1.0&quot;,</span>
<a href="#l12.383"></a><span id="l12.383" class="difflineminus">-      bootstrap: true,</span>
<a href="#l12.384"></a><span id="l12.384" class="difflineminus">-      updateKey: &quot;foo&quot;,</span>
<a href="#l12.385"></a><span id="l12.385" class="difflineminus">-      updateURL: &quot;https://www.foo.com&quot;,</span>
<a href="#l12.386"></a><span id="l12.386" class="difflineminus">-      targetApplications: [{</span>
<a href="#l12.387"></a><span id="l12.387" class="difflineminus">-        id: &quot;xpcshell@tests.mozilla.org&quot;,</span>
<a href="#l12.388"></a><span id="l12.388" class="difflineminus">-        minVersion: &quot;1&quot;,</span>
<a href="#l12.389"></a><span id="l12.389" class="difflineminus">-        maxVersion: &quot;1&quot;,</span>
<a href="#l12.390"></a><span id="l12.390" class="difflineminus">-      }],</span>
<a href="#l12.391"></a><span id="l12.391" class="difflineminus">-      name: &quot;Test Addon 16&quot;,</span>
<a href="#l12.392"></a><span id="l12.392" class="difflineminus">-    },</span>
<a href="#l12.393"></a><span id="l12.393" class="difflineminus">-</span>
<a href="#l12.394"></a><span id="l12.394" class="difflineminus">-    expected: {</span>
<a href="#l12.395"></a><span id="l12.395" class="difflineminus">-      isActive: true,</span>
<a href="#l12.396"></a><span id="l12.396" class="difflineminus">-      userDisabled: false,</span>
<a href="#l12.397"></a><span id="l12.397" class="difflineminus">-      appDisabled: false,</span>
<a href="#l12.398"></a><span id="l12.398" class="difflineminus">-      isCompatible: true,</span>
<a href="#l12.399"></a><span id="l12.399" class="difflineminus">-      providesUpdatesSecurely: true,</span>
<a href="#l12.400"></a><span id="l12.400" class="difflineminus">-    },</span>
<a href="#l12.401"></a><span id="l12.401" class="difflineminus">-  },</span>
<a href="#l12.402"></a><span id="l12.402" class="difflineminus">-</span>
<a href="#l12.403"></a><span id="l12.403" class="difflineminus">-  {</span>
<a href="#l12.404"></a><span id="l12.404" class="difflineminus">-    &quot;install.rdf&quot;: {</span>
<a href="#l12.405"></a><span id="l12.405" class="difflineminus">-      id: &quot;addon17@tests.mozilla.org&quot;,</span>
<a href="#l12.406"></a><span id="l12.406" class="difflineminus">-      version: &quot;1.0&quot;,</span>
<a href="#l12.407"></a><span id="l12.407" class="difflineminus">-      bootstrap: true,</span>
<a href="#l12.408"></a><span id="l12.408" class="difflineminus">-      optionsURL: &quot;chrome://test/content/options.xul&quot;,</span>
<a href="#l12.409"></a><span id="l12.409" class="difflineminus">-      optionsType: &quot;2&quot;,</span>
<a href="#l12.410"></a><span id="l12.410" class="difflineminus">-      targetApplications: [{</span>
<a href="#l12.411"></a><span id="l12.411" class="difflineminus">-        id: &quot;xpcshell@tests.mozilla.org&quot;,</span>
<a href="#l12.412"></a><span id="l12.412" class="difflineminus">-        minVersion: &quot;1&quot;,</span>
<a href="#l12.413"></a><span id="l12.413" class="difflineminus">-        maxVersion: &quot;1&quot;,</span>
<a href="#l12.414"></a><span id="l12.414" class="difflineminus">-      }],</span>
<a href="#l12.415"></a><span id="l12.415" class="difflineminus">-      name: &quot;Test Addon 17&quot;,</span>
<a href="#l12.416"></a><span id="l12.416" class="difflineminus">-    },</span>
<a href="#l12.417"></a><span id="l12.417" class="difflineminus">-</span>
<a href="#l12.418"></a><span id="l12.418" class="difflineminus">-    // An obsolete optionsType means the add-on isn't registered.</span>
<a href="#l12.419"></a><span id="l12.419" class="difflineminus">-    expected: null,</span>
<a href="#l12.420"></a><span id="l12.420" class="difflineminus">-  },</span>
<a href="#l12.421"></a><span id="l12.421" class="difflineminus">-</span>
<a href="#l12.422"></a><span id="l12.422" class="difflineminus">-  {</span>
<a href="#l12.423"></a><span id="l12.423" class="difflineminus">-    &quot;install.rdf&quot;: {</span>
<a href="#l12.424"></a><span id="l12.424" class="difflineminus">-      id: &quot;addon18@tests.mozilla.org&quot;,</span>
<a href="#l12.425"></a><span id="l12.425" class="difflineminus">-      version: &quot;1.0&quot;,</span>
<a href="#l12.426"></a><span id="l12.426" class="difflineminus">-      bootstrap: true,</span>
<a href="#l12.427"></a><span id="l12.427" class="difflineminus">-      targetApplications: [{</span>
<a href="#l12.428"></a><span id="l12.428" class="difflineminus">-        id: &quot;xpcshell@tests.mozilla.org&quot;,</span>
<a href="#l12.429"></a><span id="l12.429" class="difflineminus">-        minVersion: &quot;1&quot;,</span>
<a href="#l12.430"></a><span id="l12.430" class="difflineminus">-        maxVersion: &quot;1&quot;,</span>
<a href="#l12.431"></a><span id="l12.431" class="difflineminus">-      }],</span>
<a href="#l12.432"></a><span id="l12.432" class="difflineminus">-      name: &quot;Test Addon 18&quot;,</span>
<a href="#l12.433"></a><span id="l12.433" class="difflineminus">-    },</span>
<a href="#l12.434"></a><span id="l12.434" class="difflineminus">-    extraFiles: {&quot;options.xul&quot;: &quot;&quot;},</span>
<a href="#l12.435"></a><span id="l12.435" class="difflineminus">-</span>
<a href="#l12.436"></a><span id="l12.436" class="difflineminus">-    expected: {</span>
<a href="#l12.437"></a><span id="l12.437" class="difflineminus">-      isActive: true,</span>
<a href="#l12.438"></a><span id="l12.438" class="difflineminus">-      userDisabled: false,</span>
<a href="#l12.439"></a><span id="l12.439" class="difflineminus">-      appDisabled: false,</span>
<a href="#l12.440"></a><span id="l12.440" class="difflineminus">-      isCompatible: true,</span>
<a href="#l12.441"></a><span id="l12.441" class="difflineminus">-      optionsURL: null,</span>
<a href="#l12.442"></a><span id="l12.442" class="difflineminus">-      optionsType: null,</span>
<a href="#l12.443"></a><span id="l12.443" class="difflineminus">-    },</span>
<a href="#l12.444"></a><span id="l12.444" class="difflineminus">-  },</span>
<a href="#l12.445"></a><span id="l12.445" class="difflineminus">-</span>
<a href="#l12.446"></a><span id="l12.446" class="difflineminus">-  {</span>
<a href="#l12.447"></a><span id="l12.447" class="difflineminus">-    &quot;install.rdf&quot;: {</span>
<a href="#l12.448"></a><span id="l12.448" class="difflineminus">-      id: &quot;addon19@tests.mozilla.org&quot;,</span>
<a href="#l12.449"></a><span id="l12.449" class="difflineminus">-      version: &quot;1.0&quot;,</span>
<a href="#l12.450"></a><span id="l12.450" class="difflineminus">-      bootstrap: true,</span>
<a href="#l12.451"></a><span id="l12.451" class="difflineminus">-      optionsType: &quot;99&quot;,</span>
<a href="#l12.452"></a><span id="l12.452" class="difflineminus">-      targetApplications: [{</span>
<a href="#l12.453"></a><span id="l12.453" class="difflineminus">-        id: &quot;xpcshell@tests.mozilla.org&quot;,</span>
<a href="#l12.454"></a><span id="l12.454" class="difflineminus">-        minVersion: &quot;1&quot;,</span>
<a href="#l12.455"></a><span id="l12.455" class="difflineminus">-        maxVersion: &quot;1&quot;,</span>
<a href="#l12.456"></a><span id="l12.456" class="difflineminus">-      }],</span>
<a href="#l12.457"></a><span id="l12.457" class="difflineminus">-      name: &quot;Test Addon 19&quot;,</span>
<a href="#l12.458"></a><span id="l12.458" class="difflineminus">-    },</span>
<a href="#l12.459"></a><span id="l12.459" class="difflineminus">-</span>
<a href="#l12.460"></a><span id="l12.460" class="difflineminus">-    expected: null,</span>
<a href="#l12.461"></a><span id="l12.461" class="difflineminus">-  },</span>
<a href="#l12.462"></a><span id="l12.462" class="difflineminus">-</span>
<a href="#l12.463"></a><span id="l12.463" class="difflineminus">-  {</span>
<a href="#l12.464"></a><span id="l12.464" class="difflineminus">-    &quot;install.rdf&quot;: {</span>
<a href="#l12.465"></a><span id="l12.465" class="difflineminus">-      id: &quot;addon20@tests.mozilla.org&quot;,</span>
<a href="#l12.466"></a><span id="l12.466" class="difflineminus">-      version: &quot;1.0&quot;,</span>
<a href="#l12.467"></a><span id="l12.467" class="difflineminus">-      bootstrap: true,</span>
<a href="#l12.468"></a><span id="l12.468" class="difflineminus">-      optionsURL: &quot;chrome://test/content/options.xul&quot;,</span>
<a href="#l12.469"></a><span id="l12.469" class="difflineminus">-      targetApplications: [{</span>
<a href="#l12.470"></a><span id="l12.470" class="difflineminus">-        id: &quot;xpcshell@tests.mozilla.org&quot;,</span>
<a href="#l12.471"></a><span id="l12.471" class="difflineminus">-        minVersion: &quot;1&quot;,</span>
<a href="#l12.472"></a><span id="l12.472" class="difflineminus">-        maxVersion: &quot;1&quot;,</span>
<a href="#l12.473"></a><span id="l12.473" class="difflineminus">-      }],</span>
<a href="#l12.474"></a><span id="l12.474" class="difflineminus">-      name: &quot;Test Addon 20&quot;,</span>
<a href="#l12.475"></a><span id="l12.475" class="difflineminus">-    },</span>
<a href="#l12.476"></a><span id="l12.476" class="difflineminus">-</span>
<a href="#l12.477"></a><span id="l12.477" class="difflineminus">-    // Even with a defined optionsURL optionsType is null by default.</span>
<a href="#l12.478"></a><span id="l12.478" class="difflineminus">-    expected: {</span>
<a href="#l12.479"></a><span id="l12.479" class="difflineminus">-      isActive: true,</span>
<a href="#l12.480"></a><span id="l12.480" class="difflineminus">-      userDisabled: false,</span>
<a href="#l12.481"></a><span id="l12.481" class="difflineminus">-      appDisabled: false,</span>
<a href="#l12.482"></a><span id="l12.482" class="difflineminus">-      isCompatible: true,</span>
<a href="#l12.483"></a><span id="l12.483" class="difflineminus">-      optionsURL: &quot;chrome://test/content/options.xul&quot;,</span>
<a href="#l12.484"></a><span id="l12.484" class="difflineminus">-      optionsType: null,</span>
<a href="#l12.485"></a><span id="l12.485" class="difflineminus">-    },</span>
<a href="#l12.486"></a><span id="l12.486" class="difflineminus">-  },</span>
<a href="#l12.487"></a><span id="l12.487" class="difflineminus">-</span>
<a href="#l12.488"></a><span id="l12.488" class="difflineminus">-  {</span>
<a href="#l12.489"></a><span id="l12.489" class="difflineminus">-    &quot;install.rdf&quot;: {</span>
<a href="#l12.490"></a><span id="l12.490" class="difflineminus">-      id: &quot;addon21@tests.mozilla.org&quot;,</span>
<a href="#l12.491"></a><span id="l12.491" class="difflineminus">-      version: &quot;1.0&quot;,</span>
<a href="#l12.492"></a><span id="l12.492" class="difflineminus">-      bootstrap: true,</span>
<a href="#l12.493"></a><span id="l12.493" class="difflineminus">-      optionsType: &quot;3&quot;,</span>
<a href="#l12.494"></a><span id="l12.494" class="difflineminus">-      optionsURL: &quot;chrome://test/content/options.xul&quot;,</span>
<a href="#l12.495"></a><span id="l12.495" class="difflineminus">-      targetApplications: [{</span>
<a href="#l12.496"></a><span id="l12.496" class="difflineminus">-        id: &quot;xpcshell@tests.mozilla.org&quot;,</span>
<a href="#l12.497"></a><span id="l12.497" class="difflineminus">-        minVersion: &quot;1&quot;,</span>
<a href="#l12.498"></a><span id="l12.498" class="difflineminus">-        maxVersion: &quot;1&quot;,</span>
<a href="#l12.499"></a><span id="l12.499" class="difflineminus">-      }],</span>
<a href="#l12.500"></a><span id="l12.500" class="difflineminus">-      name: &quot;Test Addon 21&quot;,</span>
<a href="#l12.501"></a><span id="l12.501" class="difflineminus">-    },</span>
<a href="#l12.502"></a><span id="l12.502" class="difflineminus">-</span>
<a href="#l12.503"></a><span id="l12.503" class="difflineminus">-    expected: {</span>
<a href="#l12.504"></a><span id="l12.504" class="difflineminus">-      isActive: true,</span>
<a href="#l12.505"></a><span id="l12.505" class="difflineminus">-      userDisabled: false,</span>
<a href="#l12.506"></a><span id="l12.506" class="difflineminus">-      appDisabled: false,</span>
<a href="#l12.507"></a><span id="l12.507" class="difflineminus">-      isCompatible: true,</span>
<a href="#l12.508"></a><span id="l12.508" class="difflineminus">-      optionsURL: &quot;chrome://test/content/options.xul&quot;,</span>
<a href="#l12.509"></a><span id="l12.509" class="difflineminus">-      optionsType: AddonManager.OPTIONS_TYPE_TAB,</span>
<a href="#l12.510"></a><span id="l12.510" class="difflineminus">-    },</span>
<a href="#l12.511"></a><span id="l12.511" class="difflineminus">-  },</span>
<a href="#l12.512"></a><span id="l12.512" class="difflineminus">-</span>
<a href="#l12.513"></a><span id="l12.513" class="difflineminus">-  {</span>
<a href="#l12.514"></a><span id="l12.514" class="difflineminus">-    &quot;install.rdf&quot;: {</span>
<a href="#l12.515"></a><span id="l12.515" class="difflineminus">-      id: &quot;addon22@tests.mozilla.org&quot;,</span>
<a href="#l12.516"></a><span id="l12.516" class="difflineminus">-      version: &quot;1.0&quot;,</span>
<a href="#l12.517"></a><span id="l12.517" class="difflineminus">-      bootstrap: true,</span>
<a href="#l12.518"></a><span id="l12.518" class="difflineminus">-      optionsType: &quot;2&quot;,</span>
<a href="#l12.519"></a><span id="l12.519" class="difflineminus">-      targetApplications: [{</span>
<a href="#l12.520"></a><span id="l12.520" class="difflineminus">-        id: &quot;xpcshell@tests.mozilla.org&quot;,</span>
<a href="#l12.521"></a><span id="l12.521" class="difflineminus">-        minVersion: &quot;1&quot;,</span>
<a href="#l12.522"></a><span id="l12.522" class="difflineminus">-        maxVersion: &quot;1&quot;,</span>
<a href="#l12.523"></a><span id="l12.523" class="difflineminus">-      }],</span>
<a href="#l12.524"></a><span id="l12.524" class="difflineminus">-      name: &quot;Test Addon 22&quot;,</span>
<a href="#l12.525"></a><span id="l12.525" class="difflineminus">-    },</span>
<a href="#l12.526"></a><span id="l12.526" class="difflineminus">-</span>
<a href="#l12.527"></a><span id="l12.527" class="difflineminus">-    // An obsolete optionsType means the add-on isn't registered.</span>
<a href="#l12.528"></a><span id="l12.528" class="difflineminus">-    expected: null,</span>
<a href="#l12.529"></a><span id="l12.529" class="difflineminus">-  },</span>
<a href="#l12.530"></a><span id="l12.530" class="difflineminus">-</span>
<a href="#l12.531"></a><span id="l12.531" class="difflineminus">-  {</span>
<a href="#l12.532"></a><span id="l12.532" class="difflineminus">-    &quot;install.rdf&quot;: {</span>
<a href="#l12.533"></a><span id="l12.533" class="difflineminus">-      id: &quot;addon23@tests.mozilla.org&quot;,</span>
<a href="#l12.534"></a><span id="l12.534" class="difflineminus">-      version: &quot;1.0&quot;,</span>
<a href="#l12.535"></a><span id="l12.535" class="difflineminus">-      bootstrap: true,</span>
<a href="#l12.536"></a><span id="l12.536" class="difflineminus">-      optionsType: &quot;2&quot;,</span>
<a href="#l12.537"></a><span id="l12.537" class="difflineminus">-      targetApplications: [{</span>
<a href="#l12.538"></a><span id="l12.538" class="difflineminus">-        id: &quot;xpcshell@tests.mozilla.org&quot;,</span>
<a href="#l12.539"></a><span id="l12.539" class="difflineminus">-        minVersion: &quot;1&quot;,</span>
<a href="#l12.540"></a><span id="l12.540" class="difflineminus">-        maxVersion: &quot;1&quot;,</span>
<a href="#l12.541"></a><span id="l12.541" class="difflineminus">-      }],</span>
<a href="#l12.542"></a><span id="l12.542" class="difflineminus">-      name: &quot;Test Addon 23&quot;,</span>
<a href="#l12.543"></a><span id="l12.543" class="difflineminus">-    },</span>
<a href="#l12.544"></a><span id="l12.544" class="difflineminus">-    extraFiles: {&quot;options.xul&quot;: &quot;&quot;},</span>
<a href="#l12.545"></a><span id="l12.545" class="difflineminus">-</span>
<a href="#l12.546"></a><span id="l12.546" class="difflineminus">-    // An obsolete optionsType means the add-on isn't registered.</span>
<a href="#l12.547"></a><span id="l12.547" class="difflineminus">-    expected: null,</span>
<a href="#l12.548"></a><span id="l12.548" class="difflineminus">-  },</span>
<a href="#l12.549"></a><span id="l12.549" class="difflineminus">-</span>
<a href="#l12.550"></a><span id="l12.550" class="difflineminus">-  {</span>
<a href="#l12.551"></a><span id="l12.551" class="difflineminus">-    &quot;install.rdf&quot;: {</span>
<a href="#l12.552"></a><span id="l12.552" class="difflineminus">-      id: &quot;addon24@tests.mozilla.org&quot;,</span>
<a href="#l12.553"></a><span id="l12.553" class="difflineminus">-      version: &quot;1.0&quot;,</span>
<a href="#l12.554"></a><span id="l12.554" class="difflineminus">-      bootstrap: true,</span>
<a href="#l12.555"></a><span id="l12.555" class="difflineminus">-      targetApplications: [{</span>
<a href="#l12.556"></a><span id="l12.556" class="difflineminus">-        id: &quot;xpcshell@tests.mozilla.org&quot;,</span>
<a href="#l12.557"></a><span id="l12.557" class="difflineminus">-        minVersion: &quot;1&quot;,</span>
<a href="#l12.558"></a><span id="l12.558" class="difflineminus">-        maxVersion: &quot;1&quot;,</span>
<a href="#l12.559"></a><span id="l12.559" class="difflineminus">-      }],</span>
<a href="#l12.560"></a><span id="l12.560" class="difflineminus">-      name: &quot;Test Addon 24&quot;,</span>
<a href="#l12.561"></a><span id="l12.561" class="difflineminus">-    },</span>
<a href="#l12.562"></a><span id="l12.562" class="difflineminus">-    extraFiles: {&quot;options.xul&quot;: &quot;&quot;},</span>
<a href="#l12.563"></a><span id="l12.563" class="difflineminus">-</span>
<a href="#l12.564"></a><span id="l12.564" class="difflineminus">-    expected: {</span>
<a href="#l12.565"></a><span id="l12.565" class="difflineminus">-      optionsType: null,</span>
<a href="#l12.566"></a><span id="l12.566" class="difflineminus">-      optionsURL: null,</span>
<a href="#l12.567"></a><span id="l12.567" class="difflineminus">-    },</span>
<a href="#l12.568"></a><span id="l12.568" class="difflineminus">-  },</span>
<a href="#l12.569"></a><span id="l12.569" class="difflineminus">-</span>
<a href="#l12.570"></a><span id="l12.570" class="difflineminus">-  {</span>
<a href="#l12.571"></a><span id="l12.571" class="difflineminus">-    &quot;install.rdf&quot;: {</span>
<a href="#l12.572"></a><span id="l12.572" class="difflineminus">-      id: &quot;addon25@tests.mozilla.org&quot;,</span>
<a href="#l12.573"></a><span id="l12.573" class="difflineminus">-      version: &quot;1.0&quot;,</span>
<a href="#l12.574"></a><span id="l12.574" class="difflineminus">-      bootstrap: true,</span>
<a href="#l12.575"></a><span id="l12.575" class="difflineminus">-      optionsType: &quot;3&quot;,</span>
<a href="#l12.576"></a><span id="l12.576" class="difflineminus">-      targetApplications: [{</span>
<a href="#l12.577"></a><span id="l12.577" class="difflineminus">-        id: &quot;xpcshell@tests.mozilla.org&quot;,</span>
<a href="#l12.578"></a><span id="l12.578" class="difflineminus">-        minVersion: &quot;1&quot;,</span>
<a href="#l12.579"></a><span id="l12.579" class="difflineminus">-        maxVersion: &quot;1&quot;,</span>
<a href="#l12.580"></a><span id="l12.580" class="difflineminus">-      }],</span>
<a href="#l12.581"></a><span id="l12.581" class="difflineminus">-      name: &quot;Test Addon 25&quot;,</span>
<a href="#l12.582"></a><span id="l12.582" class="difflineminus">-    },</span>
<a href="#l12.583"></a><span id="l12.583" class="difflineminus">-</span>
<a href="#l12.584"></a><span id="l12.584" class="difflineminus">-    expected: {</span>
<a href="#l12.585"></a><span id="l12.585" class="difflineminus">-      optionsType: null,</span>
<a href="#l12.586"></a><span id="l12.586" class="difflineminus">-      optionsURL: null,</span>
<a href="#l12.587"></a><span id="l12.587" class="difflineminus">-    },</span>
<a href="#l12.588"></a><span id="l12.588" class="difflineminus">-  },</span>
<a href="#l12.589"></a><span id="l12.589" class="difflineminus">-</span>
<a href="#l12.590"></a><span id="l12.590" class="difflineminus">-  {</span>
<a href="#l12.591"></a><span id="l12.591" class="difflineminus">-    &quot;install.rdf&quot;: {</span>
<a href="#l12.592"></a><span id="l12.592" class="difflineminus">-      id: &quot;addon26@tests.mozilla.org&quot;,</span>
<a href="#l12.593"></a><span id="l12.593" class="difflineminus">-      version: &quot;1.0&quot;,</span>
<a href="#l12.594"></a><span id="l12.594" class="difflineminus">-      bootstrap: true,</span>
<a href="#l12.595"></a><span id="l12.595" class="difflineminus">-      optionsType: &quot;4&quot;,</span>
<a href="#l12.596"></a><span id="l12.596" class="difflineminus">-      targetApplications: [{</span>
<a href="#l12.597"></a><span id="l12.597" class="difflineminus">-        id: &quot;xpcshell@tests.mozilla.org&quot;,</span>
<a href="#l12.598"></a><span id="l12.598" class="difflineminus">-        minVersion: &quot;1&quot;,</span>
<a href="#l12.599"></a><span id="l12.599" class="difflineminus">-        maxVersion: &quot;1&quot;,</span>
<a href="#l12.600"></a><span id="l12.600" class="difflineminus">-      }],</span>
<a href="#l12.601"></a><span id="l12.601" class="difflineminus">-      name: &quot;Test Addon 26&quot;,</span>
<a href="#l12.602"></a><span id="l12.602" class="difflineminus">-    },</span>
<a href="#l12.603"></a><span id="l12.603" class="difflineminus">-    extraFiles: {&quot;options.xul&quot;: &quot;&quot;},</span>
<a href="#l12.604"></a><span id="l12.604" class="difflineminus">-    expected: null,</span>
<a href="#l12.605"></a><span id="l12.605" class="difflineminus">-  },</span>
<a href="#l12.606"></a><span id="l12.606" class="difflineminus">-</span>
<a href="#l12.607"></a><span id="l12.607" class="difflineminus">-  // Tests compatibility based on target platforms.</span>
<a href="#l12.608"></a><span id="l12.608" class="difflineminus">-</span>
<a href="#l12.609"></a><span id="l12.609" class="difflineminus">-  // No targetPlatforms so should be compatible</span>
<a href="#l12.610"></a><span id="l12.610" class="difflineminus">-  {</span>
<a href="#l12.611"></a><span id="l12.611" class="difflineminus">-    &quot;install.rdf&quot;: {</span>
<a href="#l12.612"></a><span id="l12.612" class="difflineminus">-      id: &quot;tp-addon1@tests.mozilla.org&quot;,</span>
<a href="#l12.613"></a><span id="l12.613" class="difflineminus">-      version: &quot;1.0&quot;,</span>
<a href="#l12.614"></a><span id="l12.614" class="difflineminus">-      bootstrap: true,</span>
<a href="#l12.615"></a><span id="l12.615" class="difflineminus">-      name: &quot;Test 1&quot;,</span>
<a href="#l12.616"></a><span id="l12.616" class="difflineminus">-      targetApplications: [{</span>
<a href="#l12.617"></a><span id="l12.617" class="difflineminus">-        id: &quot;xpcshell@tests.mozilla.org&quot;,</span>
<a href="#l12.618"></a><span id="l12.618" class="difflineminus">-        minVersion: &quot;1&quot;,</span>
<a href="#l12.619"></a><span id="l12.619" class="difflineminus">-        maxVersion: &quot;1&quot;,</span>
<a href="#l12.620"></a><span id="l12.620" class="difflineminus">-      }],</span>
<a href="#l12.621"></a><span id="l12.621" class="difflineminus">-    },</span>
<a href="#l12.622"></a><span id="l12.622" class="difflineminus">-</span>
<a href="#l12.623"></a><span id="l12.623" class="difflineminus">-    expected: {</span>
<a href="#l12.624"></a><span id="l12.624" class="difflineminus">-      appDisabled: false,</span>
<a href="#l12.625"></a><span id="l12.625" class="difflineminus">-      isPlatformCompatible: true,</span>
<a href="#l12.626"></a><span id="l12.626" class="difflineminus">-      isActive: true,</span>
<a href="#l12.627"></a><span id="l12.627" class="difflineminus">-    },</span>
<a href="#l12.628"></a><span id="l12.628" class="difflineminus">-  },</span>
<a href="#l12.629"></a><span id="l12.629" class="difflineminus">-</span>
<a href="#l12.630"></a><span id="l12.630" class="difflineminus">-  // Matches the OS</span>
<a href="#l12.631"></a><span id="l12.631" class="difflineminus">-  {</span>
<a href="#l12.632"></a><span id="l12.632" class="difflineminus">-    &quot;install.rdf&quot;: {</span>
<a href="#l12.633"></a><span id="l12.633" class="difflineminus">-      id: &quot;tp-addon2@tests.mozilla.org&quot;,</span>
<a href="#l12.634"></a><span id="l12.634" class="difflineminus">-      version: &quot;1.0&quot;,</span>
<a href="#l12.635"></a><span id="l12.635" class="difflineminus">-      bootstrap: true,</span>
<a href="#l12.636"></a><span id="l12.636" class="difflineminus">-      name: &quot;Test 2&quot;,</span>
<a href="#l12.637"></a><span id="l12.637" class="difflineminus">-      targetPlatforms: [</span>
<a href="#l12.638"></a><span id="l12.638" class="difflineminus">-        &quot;XPCShell&quot;,</span>
<a href="#l12.639"></a><span id="l12.639" class="difflineminus">-        &quot;WINNT_x86&quot;,</span>
<a href="#l12.640"></a><span id="l12.640" class="difflineminus">-        &quot;XPCShell&quot;,</span>
<a href="#l12.641"></a><span id="l12.641" class="difflineminus">-      ],</span>
<a href="#l12.642"></a><span id="l12.642" class="difflineminus">-      targetApplications: [{</span>
<a href="#l12.643"></a><span id="l12.643" class="difflineminus">-        id: &quot;xpcshell@tests.mozilla.org&quot;,</span>
<a href="#l12.644"></a><span id="l12.644" class="difflineminus">-        minVersion: &quot;1&quot;,</span>
<a href="#l12.645"></a><span id="l12.645" class="difflineminus">-        maxVersion: &quot;1&quot;,</span>
<a href="#l12.646"></a><span id="l12.646" class="difflineminus">-      }],</span>
<a href="#l12.647"></a><span id="l12.647" class="difflineminus">-    },</span>
<a href="#l12.648"></a><span id="l12.648" class="difflineminus">-</span>
<a href="#l12.649"></a><span id="l12.649" class="difflineminus">-    expected: {</span>
<a href="#l12.650"></a><span id="l12.650" class="difflineminus">-      appDisabled: false,</span>
<a href="#l12.651"></a><span id="l12.651" class="difflineminus">-      isPlatformCompatible: true,</span>
<a href="#l12.652"></a><span id="l12.652" class="difflineminus">-      isActive: true,</span>
<a href="#l12.653"></a><span id="l12.653" class="difflineminus">-    },</span>
<a href="#l12.654"></a><span id="l12.654" class="difflineminus">-  },</span>
<a href="#l12.655"></a><span id="l12.655" class="difflineminus">-</span>
<a href="#l12.656"></a><span id="l12.656" class="difflineminus">-  // Matches the OS and ABI</span>
<a href="#l12.657"></a><span id="l12.657" class="difflineminus">-  {</span>
<a href="#l12.658"></a><span id="l12.658" class="difflineminus">-    &quot;install.rdf&quot;: {</span>
<a href="#l12.659"></a><span id="l12.659" class="difflineminus">-      id: &quot;tp-addon3@tests.mozilla.org&quot;,</span>
<a href="#l12.660"></a><span id="l12.660" class="difflineminus">-      version: &quot;1.0&quot;,</span>
<a href="#l12.661"></a><span id="l12.661" class="difflineminus">-      bootstrap: true,</span>
<a href="#l12.662"></a><span id="l12.662" class="difflineminus">-      name: &quot;Test 3&quot;,</span>
<a href="#l12.663"></a><span id="l12.663" class="difflineminus">-      targetPlatforms: [</span>
<a href="#l12.664"></a><span id="l12.664" class="difflineminus">-        &quot;WINNT&quot;,</span>
<a href="#l12.665"></a><span id="l12.665" class="difflineminus">-        &quot;XPCShell_noarch-spidermonkey&quot;,</span>
<a href="#l12.666"></a><span id="l12.666" class="difflineminus">-      ],</span>
<a href="#l12.667"></a><span id="l12.667" class="difflineminus">-      targetApplications: [{</span>
<a href="#l12.668"></a><span id="l12.668" class="difflineminus">-        id: &quot;xpcshell@tests.mozilla.org&quot;,</span>
<a href="#l12.669"></a><span id="l12.669" class="difflineminus">-        minVersion: &quot;1&quot;,</span>
<a href="#l12.670"></a><span id="l12.670" class="difflineminus">-        maxVersion: &quot;1&quot;,</span>
<a href="#l12.671"></a><span id="l12.671" class="difflineminus">-      }],</span>
<a href="#l12.672"></a><span id="l12.672" class="difflineminus">-    },</span>
<a href="#l12.673"></a><span id="l12.673" class="difflineminus">-</span>
<a href="#l12.674"></a><span id="l12.674" class="difflineminus">-    expected: {</span>
<a href="#l12.675"></a><span id="l12.675" class="difflineminus">-      appDisabled: false,</span>
<a href="#l12.676"></a><span id="l12.676" class="difflineminus">-      isPlatformCompatible: true,</span>
<a href="#l12.677"></a><span id="l12.677" class="difflineminus">-      isActive: true,</span>
<a href="#l12.678"></a><span id="l12.678" class="difflineminus">-    },</span>
<a href="#l12.679"></a><span id="l12.679" class="difflineminus">-  },</span>
<a href="#l12.680"></a><span id="l12.680" class="difflineminus">-</span>
<a href="#l12.681"></a><span id="l12.681" class="difflineminus">-  // Doesn't match</span>
<a href="#l12.682"></a><span id="l12.682" class="difflineminus">-  {</span>
<a href="#l12.683"></a><span id="l12.683" class="difflineminus">-    &quot;install.rdf&quot;: {</span>
<a href="#l12.684"></a><span id="l12.684" class="difflineminus">-      id: &quot;tp-addon4@tests.mozilla.org&quot;,</span>
<a href="#l12.685"></a><span id="l12.685" class="difflineminus">-      version: &quot;1.0&quot;,</span>
<a href="#l12.686"></a><span id="l12.686" class="difflineminus">-      bootstrap: true,</span>
<a href="#l12.687"></a><span id="l12.687" class="difflineminus">-      name: &quot;Test 4&quot;,</span>
<a href="#l12.688"></a><span id="l12.688" class="difflineminus">-      targetPlatforms: [</span>
<a href="#l12.689"></a><span id="l12.689" class="difflineminus">-        &quot;WINNT_noarch-spidermonkey&quot;,</span>
<a href="#l12.690"></a><span id="l12.690" class="difflineminus">-        &quot;Darwin&quot;,</span>
<a href="#l12.691"></a><span id="l12.691" class="difflineminus">-        &quot;WINNT_noarch-spidermonkey&quot;,</span>
<a href="#l12.692"></a><span id="l12.692" class="difflineminus">-      ],</span>
<a href="#l12.693"></a><span id="l12.693" class="difflineminus">-      targetApplications: [{</span>
<a href="#l12.694"></a><span id="l12.694" class="difflineminus">-        id: &quot;xpcshell@tests.mozilla.org&quot;,</span>
<a href="#l12.695"></a><span id="l12.695" class="difflineminus">-        minVersion: &quot;1&quot;,</span>
<a href="#l12.696"></a><span id="l12.696" class="difflineminus">-        maxVersion: &quot;1&quot;,</span>
<a href="#l12.697"></a><span id="l12.697" class="difflineminus">-      }],</span>
<a href="#l12.698"></a><span id="l12.698" class="difflineminus">-    },</span>
<a href="#l12.699"></a><span id="l12.699" class="difflineminus">-</span>
<a href="#l12.700"></a><span id="l12.700" class="difflineminus">-    expected: {</span>
<a href="#l12.701"></a><span id="l12.701" class="difflineminus">-      appDisabled: true,</span>
<a href="#l12.702"></a><span id="l12.702" class="difflineminus">-      isPlatformCompatible: false,</span>
<a href="#l12.703"></a><span id="l12.703" class="difflineminus">-      isActive: false,</span>
<a href="#l12.704"></a><span id="l12.704" class="difflineminus">-    },</span>
<a href="#l12.705"></a><span id="l12.705" class="difflineminus">-  },</span>
<a href="#l12.706"></a><span id="l12.706" class="difflineminus">-</span>
<a href="#l12.707"></a><span id="l12.707" class="difflineminus">-  // Matches the OS but since a different entry specifies ABI this doesn't match.</span>
<a href="#l12.708"></a><span id="l12.708" class="difflineminus">-  {</span>
<a href="#l12.709"></a><span id="l12.709" class="difflineminus">-    &quot;install.rdf&quot;: {</span>
<a href="#l12.710"></a><span id="l12.710" class="difflineminus">-      id: &quot;tp-addon5@tests.mozilla.org&quot;,</span>
<a href="#l12.711"></a><span id="l12.711" class="difflineminus">-      version: &quot;1.0&quot;,</span>
<a href="#l12.712"></a><span id="l12.712" class="difflineminus">-      bootstrap: true,</span>
<a href="#l12.713"></a><span id="l12.713" class="difflineminus">-      name: &quot;Test 5&quot;,</span>
<a href="#l12.714"></a><span id="l12.714" class="difflineminus">-      targetPlatforms: [</span>
<a href="#l12.715"></a><span id="l12.715" class="difflineminus">-        &quot;XPCShell&quot;,</span>
<a href="#l12.716"></a><span id="l12.716" class="difflineminus">-        &quot;XPCShell_foo&quot;,</span>
<a href="#l12.717"></a><span id="l12.717" class="difflineminus">-      ],</span>
<a href="#l12.718"></a><span id="l12.718" class="difflineminus">-      targetApplications: [{</span>
<a href="#l12.719"></a><span id="l12.719" class="difflineminus">-        id: &quot;xpcshell@tests.mozilla.org&quot;,</span>
<a href="#l12.720"></a><span id="l12.720" class="difflineminus">-        minVersion: &quot;1&quot;,</span>
<a href="#l12.721"></a><span id="l12.721" class="difflineminus">-        maxVersion: &quot;1&quot;,</span>
<a href="#l12.722"></a><span id="l12.722" class="difflineminus">-      }],</span>
<a href="#l12.723"></a><span id="l12.723" class="difflineminus">-    },</span>
<a href="#l12.724"></a><span id="l12.724" class="difflineminus">-</span>
<a href="#l12.725"></a><span id="l12.725" class="difflineminus">-    expected: {</span>
<a href="#l12.726"></a><span id="l12.726" class="difflineminus">-      appDisabled: true,</span>
<a href="#l12.727"></a><span id="l12.727" class="difflineminus">-      isPlatformCompatible: false,</span>
<a href="#l12.728"></a><span id="l12.728" class="difflineminus">-      isActive: false,</span>
<a href="#l12.729"></a><span id="l12.729" class="difflineminus">-    },</span>
<a href="#l12.730"></a><span id="l12.730" class="difflineminus">-  },</span>
<a href="#l12.731"></a><span id="l12.731" class="difflineminus">-];</span>
<a href="#l12.732"></a><span id="l12.732" class="difflineminus">-</span>
<a href="#l12.733"></a><span id="l12.733" class="difflineminus">-const IDS = ADDONS.map(a =&gt; a[&quot;install.rdf&quot;].id);</span>
<a href="#l12.734"></a><span id="l12.734" class="difflineminus">-</span>
<a href="#l12.735"></a><span id="l12.735" class="difflineminus">-add_task(async function setup() {</span>
<a href="#l12.736"></a><span id="l12.736" class="difflineminus">-  createAppInfo(&quot;xpcshell@tests.mozilla.org&quot;, &quot;XPCShell&quot;, &quot;1&quot;, &quot;1.9.2&quot;);</span>
<a href="#l12.737"></a><span id="l12.737" class="difflineminus">-  const profileDir = gProfD.clone();</span>
<a href="#l12.738"></a><span id="l12.738" class="difflineminus">-  profileDir.append(&quot;extensions&quot;);</span>
<a href="#l12.739"></a><span id="l12.739" class="difflineminus">-</span>
<a href="#l12.740"></a><span id="l12.740" class="difflineminus">-  for (let addon of ADDONS) {</span>
<a href="#l12.741"></a><span id="l12.741" class="difflineminus">-    await promiseWriteInstallRDFForExtension(addon[&quot;install.rdf&quot;], profileDir, undefined, addon.extraFiles);</span>
<a href="#l12.742"></a><span id="l12.742" class="difflineminus">-  }</span>
<a href="#l12.743"></a><span id="l12.743" class="difflineminus">-});</span>
<a href="#l12.744"></a><span id="l12.744" class="difflineminus">-</span>
<a href="#l12.745"></a><span id="l12.745" class="difflineminus">-add_task(async function test_values() {</span>
<a href="#l12.746"></a><span id="l12.746" class="difflineminus">-  await promiseStartupManager();</span>
<a href="#l12.747"></a><span id="l12.747" class="difflineminus">-</span>
<a href="#l12.748"></a><span id="l12.748" class="difflineminus">-  let addons = await getAddons(IDS);</span>
<a href="#l12.749"></a><span id="l12.749" class="difflineminus">-</span>
<a href="#l12.750"></a><span id="l12.750" class="difflineminus">-  for (let addon of ADDONS) {</span>
<a href="#l12.751"></a><span id="l12.751" class="difflineminus">-    let {id} = addon[&quot;install.rdf&quot;];</span>
<a href="#l12.752"></a><span id="l12.752" class="difflineminus">-    checkAddon(id, addons.get(id), addon.expected);</span>
<a href="#l12.753"></a><span id="l12.753" class="difflineminus">-  }</span>
<a href="#l12.754"></a><span id="l12.754" class="difflineminus">-</span>
<a href="#l12.755"></a><span id="l12.755" class="difflineminus">-  await promiseShutdownManager();</span>
<a href="#l12.756"></a><span id="l12.756" class="difflineminus">-});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1">deleted file mode 100644</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineminus">--- a/common/test/xpcshell/test_manifest_locales.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineplus">+++ /dev/null</span>
<a href="#l13.4"></a><span id="l13.4" class="difflineat">@@ -1,134 +0,0 @@</span>
<a href="#l13.5"></a><span id="l13.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l13.6"></a><span id="l13.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l13.7"></a><span id="l13.7" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l13.8"></a><span id="l13.8" class="difflineminus">- */</span>
<a href="#l13.9"></a><span id="l13.9" class="difflineminus">-</span>
<a href="#l13.10"></a><span id="l13.10" class="difflineminus">-const ID = &quot;bug397778@tests.mozilla.org&quot;;</span>
<a href="#l13.11"></a><span id="l13.11" class="difflineminus">-</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-const ADDON = createInstallRDF({</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-  id: &quot;bug397778@tests.mozilla.org&quot;,</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineminus">-  version: &quot;1.0&quot;,</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineminus">-  name: &quot;Fallback Name&quot;,</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineminus">-  description: &quot;Fallback Description&quot;,</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineminus">-  bootstrap: true,</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineminus">-</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineminus">-  targetApplications: [{</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineminus">-    id: &quot;xpcshell@tests.mozilla.org&quot;,</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineminus">-    minVersion: &quot;1&quot;,</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineminus">-    maxVersion: &quot;1&quot;}],</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineminus">-</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineminus">-  localized: [</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineminus">-    {</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineminus">-      locale: [&quot;fr&quot;],</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineminus">-      name: &quot;fr Name&quot;,</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineminus">-      description: &quot;fr Description&quot;,</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineminus">-    },</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineminus">-    {</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineminus">-      locale: [&quot;de-DE&quot;],</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineminus">-      name: &quot;Deutsches W\u00f6rterbuch&quot;,</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineminus">-    },</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineminus">-    {</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineminus">-      locale: [&quot;es-ES&quot;],</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineminus">-      name: &quot;es-ES Name&quot;,</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineminus">-      description: &quot;es-ES Description&quot;,</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineminus">-    },</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineminus">-    {</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineminus">-      locale: [&quot;zh-TW&quot;],</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineminus">-      name: &quot;zh-TW Name&quot;,</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineminus">-      description: &quot;zh-TW Description&quot;,</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineminus">-    },</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineminus">-    {</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineminus">-      locale: [&quot;zh-CN&quot;],</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineminus">-      name: &quot;zh-CN Name&quot;,</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineminus">-      description: &quot;zh-CN Description&quot;,</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineminus">-    },</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineminus">-    {</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineminus">-      locale: [&quot;en-GB&quot;],</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineminus">-      name: &quot;en-GB Name&quot;,</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineminus">-      description: &quot;en-GB Description&quot;,</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineminus">-    },</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineminus">-    {</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineminus">-      locale: [&quot;en&quot;],</span>
<a href="#l13.56"></a><span id="l13.56" class="difflineminus">-      name: &quot;en Name&quot;,</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineminus">-      description: &quot;en Description&quot;,</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineminus">-    },</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineminus">-    {</span>
<a href="#l13.60"></a><span id="l13.60" class="difflineminus">-      locale: [&quot;en-CA&quot;],</span>
<a href="#l13.61"></a><span id="l13.61" class="difflineminus">-      name: &quot;en-CA Name&quot;,</span>
<a href="#l13.62"></a><span id="l13.62" class="difflineminus">-      description: &quot;en-CA Description&quot;,</span>
<a href="#l13.63"></a><span id="l13.63" class="difflineminus">-    },</span>
<a href="#l13.64"></a><span id="l13.64" class="difflineminus">-  ],</span>
<a href="#l13.65"></a><span id="l13.65" class="difflineminus">-});</span>
<a href="#l13.66"></a><span id="l13.66" class="difflineminus">-</span>
<a href="#l13.67"></a><span id="l13.67" class="difflineminus">-add_task(async function setup() {</span>
<a href="#l13.68"></a><span id="l13.68" class="difflineminus">-  createAppInfo(&quot;xpcshell@tests.mozilla.org&quot;, &quot;XPCShell&quot;, &quot;1&quot;);</span>
<a href="#l13.69"></a><span id="l13.69" class="difflineminus">-  Services.locale.requestedLocales = [&quot;fr-FR&quot;];</span>
<a href="#l13.70"></a><span id="l13.70" class="difflineminus">-</span>
<a href="#l13.71"></a><span id="l13.71" class="difflineminus">-  await promiseStartupManager();</span>
<a href="#l13.72"></a><span id="l13.72" class="difflineminus">-  await promiseInstallXPI(ADDON);</span>
<a href="#l13.73"></a><span id="l13.73" class="difflineminus">-});</span>
<a href="#l13.74"></a><span id="l13.74" class="difflineminus">-</span>
<a href="#l13.75"></a><span id="l13.75" class="difflineminus">-add_task(async function test_1() {</span>
<a href="#l13.76"></a><span id="l13.76" class="difflineminus">-  let addon = await AddonManager.getAddonByID(ID);</span>
<a href="#l13.77"></a><span id="l13.77" class="difflineminus">-  Assert.notEqual(addon, null);</span>
<a href="#l13.78"></a><span id="l13.78" class="difflineminus">-  Assert.equal(addon.name, &quot;fr Name&quot;);</span>
<a href="#l13.79"></a><span id="l13.79" class="difflineminus">-  Assert.equal(addon.description, &quot;fr Description&quot;);</span>
<a href="#l13.80"></a><span id="l13.80" class="difflineminus">-</span>
<a href="#l13.81"></a><span id="l13.81" class="difflineminus">-  await addon.disable();</span>
<a href="#l13.82"></a><span id="l13.82" class="difflineminus">-  await promiseRestartManager();</span>
<a href="#l13.83"></a><span id="l13.83" class="difflineminus">-</span>
<a href="#l13.84"></a><span id="l13.84" class="difflineminus">-  let newAddon = await AddonManager.getAddonByID(ID);</span>
<a href="#l13.85"></a><span id="l13.85" class="difflineminus">-  Assert.notEqual(newAddon, null);</span>
<a href="#l13.86"></a><span id="l13.86" class="difflineminus">-  Assert.equal(newAddon.name, &quot;fr Name&quot;);</span>
<a href="#l13.87"></a><span id="l13.87" class="difflineminus">-});</span>
<a href="#l13.88"></a><span id="l13.88" class="difflineminus">-</span>
<a href="#l13.89"></a><span id="l13.89" class="difflineminus">-add_task(async function test_2() {</span>
<a href="#l13.90"></a><span id="l13.90" class="difflineminus">-  // Change locale. The more specific de-DE is the best match</span>
<a href="#l13.91"></a><span id="l13.91" class="difflineminus">-  await restartWithLocales([&quot;de&quot;]);</span>
<a href="#l13.92"></a><span id="l13.92" class="difflineminus">-</span>
<a href="#l13.93"></a><span id="l13.93" class="difflineminus">-  let addon = await AddonManager.getAddonByID(ID);</span>
<a href="#l13.94"></a><span id="l13.94" class="difflineminus">-  Assert.notEqual(addon, null);</span>
<a href="#l13.95"></a><span id="l13.95" class="difflineminus">-  Assert.equal(addon.name, &quot;Deutsches W\u00f6rterbuch&quot;);</span>
<a href="#l13.96"></a><span id="l13.96" class="difflineminus">-  Assert.equal(addon.description, null);</span>
<a href="#l13.97"></a><span id="l13.97" class="difflineminus">-});</span>
<a href="#l13.98"></a><span id="l13.98" class="difflineminus">-</span>
<a href="#l13.99"></a><span id="l13.99" class="difflineminus">-add_task(async function test_3() {</span>
<a href="#l13.100"></a><span id="l13.100" class="difflineminus">-  // Change locale. Locale case should have no effect</span>
<a href="#l13.101"></a><span id="l13.101" class="difflineminus">-  await restartWithLocales([&quot;DE-de&quot;]);</span>
<a href="#l13.102"></a><span id="l13.102" class="difflineminus">-</span>
<a href="#l13.103"></a><span id="l13.103" class="difflineminus">-  let addon = await AddonManager.getAddonByID(ID);</span>
<a href="#l13.104"></a><span id="l13.104" class="difflineminus">-  Assert.notEqual(addon, null);</span>
<a href="#l13.105"></a><span id="l13.105" class="difflineminus">-  Assert.equal(addon.name, &quot;Deutsches W\u00f6rterbuch&quot;);</span>
<a href="#l13.106"></a><span id="l13.106" class="difflineminus">-  Assert.equal(addon.description, null);</span>
<a href="#l13.107"></a><span id="l13.107" class="difflineminus">-});</span>
<a href="#l13.108"></a><span id="l13.108" class="difflineminus">-</span>
<a href="#l13.109"></a><span id="l13.109" class="difflineminus">-add_task(async function test_4() {</span>
<a href="#l13.110"></a><span id="l13.110" class="difflineminus">-  // Change locale. es-ES should closely match</span>
<a href="#l13.111"></a><span id="l13.111" class="difflineminus">-  await restartWithLocales([&quot;es-AR&quot;]);</span>
<a href="#l13.112"></a><span id="l13.112" class="difflineminus">-</span>
<a href="#l13.113"></a><span id="l13.113" class="difflineminus">-  let addon = await AddonManager.getAddonByID(ID);</span>
<a href="#l13.114"></a><span id="l13.114" class="difflineminus">-  Assert.notEqual(addon, null);</span>
<a href="#l13.115"></a><span id="l13.115" class="difflineminus">-  Assert.equal(addon.name, &quot;es-ES Name&quot;);</span>
<a href="#l13.116"></a><span id="l13.116" class="difflineminus">-  Assert.equal(addon.description, &quot;es-ES Description&quot;);</span>
<a href="#l13.117"></a><span id="l13.117" class="difflineminus">-});</span>
<a href="#l13.118"></a><span id="l13.118" class="difflineminus">-</span>
<a href="#l13.119"></a><span id="l13.119" class="difflineminus">-add_task(async function test_5() {</span>
<a href="#l13.120"></a><span id="l13.120" class="difflineminus">-  // Change locale. Either zh-CN or zh-TW could match</span>
<a href="#l13.121"></a><span id="l13.121" class="difflineminus">-  await restartWithLocales([&quot;zh&quot;]);</span>
<a href="#l13.122"></a><span id="l13.122" class="difflineminus">-</span>
<a href="#l13.123"></a><span id="l13.123" class="difflineminus">-  let addon = await AddonManager.getAddonByID(ID);</span>
<a href="#l13.124"></a><span id="l13.124" class="difflineminus">-  Assert.notEqual(addon, null);</span>
<a href="#l13.125"></a><span id="l13.125" class="difflineminus">-  ok(addon.name == &quot;zh-TW Name&quot; || addon.name == &quot;zh-CN Name&quot;,</span>
<a href="#l13.126"></a><span id="l13.126" class="difflineminus">-     `Add-on name mismatch: ${addon.name}`);</span>
<a href="#l13.127"></a><span id="l13.127" class="difflineminus">-});</span>
<a href="#l13.128"></a><span id="l13.128" class="difflineminus">-</span>
<a href="#l13.129"></a><span id="l13.129" class="difflineminus">-add_task(async function test_6() {</span>
<a href="#l13.130"></a><span id="l13.130" class="difflineminus">-  // Unknown locale should try to match against en-US as well. Of en,en-GB</span>
<a href="#l13.131"></a><span id="l13.131" class="difflineminus">-  // en should match as being less specific</span>
<a href="#l13.132"></a><span id="l13.132" class="difflineminus">-  await restartWithLocales([&quot;nl-NL&quot;]);</span>
<a href="#l13.133"></a><span id="l13.133" class="difflineminus">-</span>
<a href="#l13.134"></a><span id="l13.134" class="difflineminus">-  let addon = await AddonManager.getAddonByID(ID);</span>
<a href="#l13.135"></a><span id="l13.135" class="difflineminus">-  Assert.notEqual(addon, null);</span>
<a href="#l13.136"></a><span id="l13.136" class="difflineminus">-  Assert.equal(addon.name, &quot;en Name&quot;);</span>
<a href="#l13.137"></a><span id="l13.137" class="difflineminus">-  Assert.equal(addon.description, &quot;en Description&quot;);</span>
<a href="#l13.138"></a><span id="l13.138" class="difflineminus">-});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/common/test/xpcshell/xpcshell.ini</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/common/test/xpcshell/xpcshell.ini</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -3,11 +3,8 @@ tags = addons</span>
<a href="#l14.4"></a><span id="l14.4"> head = head_addons.js</span>
<a href="#l14.5"></a><span id="l14.5"> support-files =</span>
<a href="#l14.6"></a><span id="l14.6">   data/**</span>
<a href="#l14.7"></a><span id="l14.7"> </span>
<a href="#l14.8"></a><span id="l14.8"> [test_bootstrap.js]</span>
<a href="#l14.9"></a><span id="l14.9"> [test_bootstrap_const.js]</span>
<a href="#l14.10"></a><span id="l14.10"> [test_bootstrap_globals.js]</span>
<a href="#l14.11"></a><span id="l14.11"> [test_bootstrapped_chrome_manifest.js]</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-[test_invalid_install_rdf.js]</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineminus">-[test_manifest.js]</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineminus">-[test_manifest_locales.js]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mail/base/content/mailWindowOverlay.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mail/base/content/mailWindowOverlay.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -3234,17 +3234,18 @@ async function initAddonPrefsMenu(aMenup</span>
<a href="#l15.4"></a><span id="l15.4">     }</span>
<a href="#l15.5"></a><span id="l15.5">     if (addon.optionsURL &amp;&amp; (addon.optionsType === null || addon.optionsType == 3)) {</span>
<a href="#l15.6"></a><span id="l15.6">       addonsFound.push({</span>
<a href="#l15.7"></a><span id="l15.7">         addon,</span>
<a href="#l15.8"></a><span id="l15.8">         optionsURL: addon.optionsURL,</span>
<a href="#l15.9"></a><span id="l15.9">         optionsOpenInTab: addon.optionsType == 3,</span>
<a href="#l15.10"></a><span id="l15.10">       });</span>
<a href="#l15.11"></a><span id="l15.11">     }</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-    if (ExtensionSupport.loadedLegacyExtensions.has(addon.id)) {</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+    if (ExtensionSupport.loadedLegacyExtensions.has(addon.id) ||</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineplus">+        ExtensionSupport.loadedBootstrapExtensions.has(addon.id)) {</span>
<a href="#l15.15"></a><span id="l15.15">       let webextension = ExtensionParent.GlobalManager.getExtension(addon.id);</span>
<a href="#l15.16"></a><span id="l15.16">       let legacy = webextension.manifest.legacy;</span>
<a href="#l15.17"></a><span id="l15.17">       if (typeof legacy == &quot;boolean&quot; || !legacy.options || !legacy.options.page) {</span>
<a href="#l15.18"></a><span id="l15.18">         continue;</span>
<a href="#l15.19"></a><span id="l15.19">       }</span>
<a href="#l15.20"></a><span id="l15.20">       addonsFound.push({</span>
<a href="#l15.21"></a><span id="l15.21">         addon,</span>
<a href="#l15.22"></a><span id="l15.22">         optionsURL: legacy.options.page,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mail/components/extensions/ext-mail.json</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mail/components/extensions/ext-mail.json</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -82,16 +82,17 @@</span>
<a href="#l16.4"></a><span id="l16.4">     &quot;paths&quot;: [</span>
<a href="#l16.5"></a><span id="l16.5">       [&quot;geckoProfiler&quot;]</span>
<a href="#l16.6"></a><span id="l16.6">     ]</span>
<a href="#l16.7"></a><span id="l16.7">   },</span>
<a href="#l16.8"></a><span id="l16.8">   &quot;legacy&quot;: {</span>
<a href="#l16.9"></a><span id="l16.9">     &quot;url&quot;: &quot;chrome://messenger/content/parent/ext-legacy.js&quot;,</span>
<a href="#l16.10"></a><span id="l16.10">     &quot;schema&quot;: &quot;chrome://messenger/content/schemas/legacy.json&quot;,</span>
<a href="#l16.11"></a><span id="l16.11">     &quot;scopes&quot;: [&quot;addon_parent&quot;],</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineplus">+    &quot;events&quot;: [&quot;disable&quot;, &quot;uninstall&quot;, &quot;update&quot;],</span>
<a href="#l16.13"></a><span id="l16.13">     &quot;manifest&quot;: [&quot;legacy&quot;]</span>
<a href="#l16.14"></a><span id="l16.14">   },</span>
<a href="#l16.15"></a><span id="l16.15">   &quot;mailTabs&quot;: {</span>
<a href="#l16.16"></a><span id="l16.16">     &quot;url&quot;: &quot;chrome://messenger/content/parent/ext-mailTabs.js&quot;,</span>
<a href="#l16.17"></a><span id="l16.17">     &quot;schema&quot;: &quot;chrome://messenger/content/schemas/mailTabs.json&quot;,</span>
<a href="#l16.18"></a><span id="l16.18">     &quot;scopes&quot;: [&quot;addon_parent&quot;],</span>
<a href="#l16.19"></a><span id="l16.19">     &quot;manifest&quot;: [&quot;mailTabs&quot;],</span>
<a href="#l16.20"></a><span id="l16.20">     &quot;paths&quot;: [</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mail/components/extensions/parent/ext-legacy.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mail/components/extensions/parent/ext-legacy.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -4,26 +4,54 @@</span>
<a href="#l17.4"></a><span id="l17.4"> </span>
<a href="#l17.5"></a><span id="l17.5"> ChromeUtils.defineModuleGetter(this, &quot;ChromeManifest&quot;, &quot;resource:///modules/ChromeManifest.jsm&quot;);</span>
<a href="#l17.6"></a><span id="l17.6"> ChromeUtils.defineModuleGetter(this, &quot;ExtensionSupport&quot;, &quot;resource:///modules/ExtensionSupport.jsm&quot;);</span>
<a href="#l17.7"></a><span id="l17.7"> ChromeUtils.defineModuleGetter(this, &quot;Overlays&quot;, &quot;resource:///modules/Overlays.jsm&quot;);</span>
<a href="#l17.8"></a><span id="l17.8"> ChromeUtils.defineModuleGetter(this, &quot;XPIInternal&quot;, &quot;resource://gre/modules/addons/XPIProvider.jsm&quot;);</span>
<a href="#l17.9"></a><span id="l17.9"> </span>
<a href="#l17.10"></a><span id="l17.10"> Cu.importGlobalProperties([&quot;fetch&quot;]);</span>
<a href="#l17.11"></a><span id="l17.11"> </span>
<a href="#l17.12"></a><span id="l17.12" class="difflineplus">+var {XPCOMUtils} = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+var {ConsoleAPI} = ChromeUtils.import(&quot;resource://gre/modules/Console.jsm&quot;);</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineplus">+</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;BOOTSTRAP_REASONS&quot;, () =&gt; {</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineplus">+  const {XPIProvider} = ChromeUtils.import(&quot;resource://gre/modules/addons/XPIProvider.jsm&quot;);</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineplus">+  return XPIProvider.BOOTSTRAP_REASONS;</span>
<a href="#l17.18"></a><span id="l17.18" class="difflineplus">+});</span>
<a href="#l17.19"></a><span id="l17.19" class="difflineplus">+</span>
<a href="#l17.20"></a><span id="l17.20" class="difflineplus">+const {Log} = ChromeUtils.import(&quot;resource://gre/modules/Log.jsm&quot;);</span>
<a href="#l17.21"></a><span id="l17.21" class="difflineplus">+var logger = Log.repository.getLogger(&quot;addons.bootstrap&quot;);</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineplus">+</span>
<a href="#l17.23"></a><span id="l17.23" class="difflineplus">+let bootstrapScopes = new Map();</span>
<a href="#l17.24"></a><span id="l17.24" class="difflineplus">+let cachedParams = new Map();</span>
<a href="#l17.25"></a><span id="l17.25" class="difflineplus">+</span>
<a href="#l17.26"></a><span id="l17.26" class="difflineplus">+Services.obs.addObserver(() =&gt; {</span>
<a href="#l17.27"></a><span id="l17.27" class="difflineplus">+  for (let [id, scope] of bootstrapScopes.entries()) {</span>
<a href="#l17.28"></a><span id="l17.28" class="difflineplus">+    if (ExtensionSupport.loadedBootstrapExtensions.has(id)) {</span>
<a href="#l17.29"></a><span id="l17.29" class="difflineplus">+      scope.shutdown({...cachedParams.get(id)}, BOOTSTRAP_REASONS.APP_SHUTDOWN);</span>
<a href="#l17.30"></a><span id="l17.30" class="difflineplus">+    }</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineplus">+  }</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineplus">+}, &quot;quit-application-granted&quot;);</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineplus">+</span>
<a href="#l17.34"></a><span id="l17.34"> var { ExtensionError } = ExtensionUtils;</span>
<a href="#l17.35"></a><span id="l17.35"> </span>
<a href="#l17.36"></a><span id="l17.36"> this.legacy = class extends ExtensionAPI {</span>
<a href="#l17.37"></a><span id="l17.37">   async onManifestEntry(entryName) {</span>
<a href="#l17.38"></a><span id="l17.38">     if (this.extension.manifest.legacy) {</span>
<a href="#l17.39"></a><span id="l17.39" class="difflineminus">-      await this.register();</span>
<a href="#l17.40"></a><span id="l17.40" class="difflineplus">+      if (this.extension.manifest.legacy.type == &quot;bootstrap&quot;) {</span>
<a href="#l17.41"></a><span id="l17.41" class="difflineplus">+        await this.registerBootstrapped();</span>
<a href="#l17.42"></a><span id="l17.42" class="difflineplus">+      } else {</span>
<a href="#l17.43"></a><span id="l17.43" class="difflineplus">+        await this.registerNonBootstrapped();</span>
<a href="#l17.44"></a><span id="l17.44" class="difflineplus">+      }</span>
<a href="#l17.45"></a><span id="l17.45">     }</span>
<a href="#l17.46"></a><span id="l17.46">   }</span>
<a href="#l17.47"></a><span id="l17.47"> </span>
<a href="#l17.48"></a><span id="l17.48" class="difflineminus">-  async register() {</span>
<a href="#l17.49"></a><span id="l17.49" class="difflineplus">+  // This function is for non-bootstrapped add-ons.</span>
<a href="#l17.50"></a><span id="l17.50" class="difflineplus">+</span>
<a href="#l17.51"></a><span id="l17.51" class="difflineplus">+  async registerNonBootstrapped() {</span>
<a href="#l17.52"></a><span id="l17.52">     this.extension.legacyLoaded = true;</span>
<a href="#l17.53"></a><span id="l17.53"> </span>
<a href="#l17.54"></a><span id="l17.54">     let state = {</span>
<a href="#l17.55"></a><span id="l17.55">       id: this.extension.id,</span>
<a href="#l17.56"></a><span id="l17.56">       pendingOperation: null,</span>
<a href="#l17.57"></a><span id="l17.57">       version: this.extension.version,</span>
<a href="#l17.58"></a><span id="l17.58">     };</span>
<a href="#l17.59"></a><span id="l17.59">     if (ExtensionSupport.loadedLegacyExtensions.has(this.extension.id)) {</span>
<a href="#l17.60"></a><span id="l17.60" class="difflineat">@@ -142,16 +170,157 @@ this.legacy = class extends ExtensionAPI</span>
<a href="#l17.61"></a><span id="l17.61">     Services.obs.addObserver(documentObserver, &quot;chrome-document-interactive&quot;);</span>
<a href="#l17.62"></a><span id="l17.62"> </span>
<a href="#l17.63"></a><span id="l17.63">     this.extension.callOnClose({</span>
<a href="#l17.64"></a><span id="l17.64">       close: () =&gt; {</span>
<a href="#l17.65"></a><span id="l17.65">         Services.obs.removeObserver(documentObserver, &quot;chrome-document-interactive&quot;);</span>
<a href="#l17.66"></a><span id="l17.66">       },</span>
<a href="#l17.67"></a><span id="l17.67">     });</span>
<a href="#l17.68"></a><span id="l17.68">   }</span>
<a href="#l17.69"></a><span id="l17.69" class="difflineplus">+</span>
<a href="#l17.70"></a><span id="l17.70" class="difflineplus">+  // The following functions are for bootstrapped add-ons.</span>
<a href="#l17.71"></a><span id="l17.71" class="difflineplus">+</span>
<a href="#l17.72"></a><span id="l17.72" class="difflineplus">+  async registerBootstrapped() {</span>
<a href="#l17.73"></a><span id="l17.73" class="difflineplus">+    let oldParams = cachedParams.get(this.extension.id);</span>
<a href="#l17.74"></a><span id="l17.74" class="difflineplus">+    let params = {</span>
<a href="#l17.75"></a><span id="l17.75" class="difflineplus">+      id: this.extension.id,</span>
<a href="#l17.76"></a><span id="l17.76" class="difflineplus">+      version: this.extension.version,</span>
<a href="#l17.77"></a><span id="l17.77" class="difflineplus">+      resourceURI: Services.io.newURI(this.extension.resourceURL),</span>
<a href="#l17.78"></a><span id="l17.78" class="difflineplus">+      installPath: this.extensionFile.path,</span>
<a href="#l17.79"></a><span id="l17.79" class="difflineplus">+    };</span>
<a href="#l17.80"></a><span id="l17.80" class="difflineplus">+    cachedParams.set(this.extension.id, {...params});</span>
<a href="#l17.81"></a><span id="l17.81" class="difflineplus">+</span>
<a href="#l17.82"></a><span id="l17.82" class="difflineplus">+    if ([&quot;ADDON_UPGRADE&quot;, &quot;ADDON_DOWNGRADE&quot;].includes(this.extension.startupReason)) {</span>
<a href="#l17.83"></a><span id="l17.83" class="difflineplus">+      params.oldVersion = oldParams.version;</span>
<a href="#l17.84"></a><span id="l17.84" class="difflineplus">+    }</span>
<a href="#l17.85"></a><span id="l17.85" class="difflineplus">+</span>
<a href="#l17.86"></a><span id="l17.86" class="difflineplus">+    let scope = await this.loadScope();</span>
<a href="#l17.87"></a><span id="l17.87" class="difflineplus">+    bootstrapScopes.set(this.extension.id, scope);</span>
<a href="#l17.88"></a><span id="l17.88" class="difflineplus">+</span>
<a href="#l17.89"></a><span id="l17.89" class="difflineplus">+    if ([&quot;ADDON_INSTALL&quot;, &quot;ADDON_UPGRADE&quot;, &quot;ADDON_DOWNGRADE&quot;].includes(this.extension.startupReason)) {</span>
<a href="#l17.90"></a><span id="l17.90" class="difflineplus">+      scope.install(params, BOOTSTRAP_REASONS[this.extension.startupReason]);</span>
<a href="#l17.91"></a><span id="l17.91" class="difflineplus">+    }</span>
<a href="#l17.92"></a><span id="l17.92" class="difflineplus">+    scope.startup(params, BOOTSTRAP_REASONS[this.extension.startupReason]);</span>
<a href="#l17.93"></a><span id="l17.93" class="difflineplus">+    ExtensionSupport.loadedBootstrapExtensions.add(this.extension.id);</span>
<a href="#l17.94"></a><span id="l17.94" class="difflineplus">+  }</span>
<a href="#l17.95"></a><span id="l17.95" class="difflineplus">+</span>
<a href="#l17.96"></a><span id="l17.96" class="difflineplus">+  static onDisable(id) {</span>
<a href="#l17.97"></a><span id="l17.97" class="difflineplus">+    if (bootstrapScopes.has(id)) {</span>
<a href="#l17.98"></a><span id="l17.98" class="difflineplus">+      bootstrapScopes.get(id).shutdown({...cachedParams.get(id)}, BOOTSTRAP_REASONS.ADDON_DISABLE);</span>
<a href="#l17.99"></a><span id="l17.99" class="difflineplus">+      ExtensionSupport.loadedBootstrapExtensions.delete(id);</span>
<a href="#l17.100"></a><span id="l17.100" class="difflineplus">+    }</span>
<a href="#l17.101"></a><span id="l17.101" class="difflineplus">+  }</span>
<a href="#l17.102"></a><span id="l17.102" class="difflineplus">+</span>
<a href="#l17.103"></a><span id="l17.103" class="difflineplus">+  static onUpdate(id, manifest) {</span>
<a href="#l17.104"></a><span id="l17.104" class="difflineplus">+    if (bootstrapScopes.has(id)) {</span>
<a href="#l17.105"></a><span id="l17.105" class="difflineplus">+      let params = {</span>
<a href="#l17.106"></a><span id="l17.106" class="difflineplus">+        ...cachedParams.get(id),</span>
<a href="#l17.107"></a><span id="l17.107" class="difflineplus">+        newVersion: manifest.version,</span>
<a href="#l17.108"></a><span id="l17.108" class="difflineplus">+      };</span>
<a href="#l17.109"></a><span id="l17.109" class="difflineplus">+      let reason = BOOTSTRAP_REASONS.ADDON_UPGRADE;</span>
<a href="#l17.110"></a><span id="l17.110" class="difflineplus">+      if (Services.vc.compare(params.newVersion, params.version) &lt; 0) {</span>
<a href="#l17.111"></a><span id="l17.111" class="difflineplus">+        reason = BOOTSTRAP_REASONS.ADDON_DOWNGRADE;</span>
<a href="#l17.112"></a><span id="l17.112" class="difflineplus">+      }</span>
<a href="#l17.113"></a><span id="l17.113" class="difflineplus">+</span>
<a href="#l17.114"></a><span id="l17.114" class="difflineplus">+      let scope = bootstrapScopes.get(id);</span>
<a href="#l17.115"></a><span id="l17.115" class="difflineplus">+      scope.shutdown(params, reason);</span>
<a href="#l17.116"></a><span id="l17.116" class="difflineplus">+      scope.uninstall(params, reason);</span>
<a href="#l17.117"></a><span id="l17.117" class="difflineplus">+      ExtensionSupport.loadedBootstrapExtensions.delete(id);</span>
<a href="#l17.118"></a><span id="l17.118" class="difflineplus">+      bootstrapScopes.delete(id);</span>
<a href="#l17.119"></a><span id="l17.119" class="difflineplus">+    }</span>
<a href="#l17.120"></a><span id="l17.120" class="difflineplus">+  }</span>
<a href="#l17.121"></a><span id="l17.121" class="difflineplus">+</span>
<a href="#l17.122"></a><span id="l17.122" class="difflineplus">+  static onUninstall(id) {</span>
<a href="#l17.123"></a><span id="l17.123" class="difflineplus">+    if (bootstrapScopes.has(id)) {</span>
<a href="#l17.124"></a><span id="l17.124" class="difflineplus">+      bootstrapScopes.get(id).uninstall({...cachedParams.get(id)}, BOOTSTRAP_REASONS.ADDON_UNINSTALL);</span>
<a href="#l17.125"></a><span id="l17.125" class="difflineplus">+      bootstrapScopes.delete(id);</span>
<a href="#l17.126"></a><span id="l17.126" class="difflineplus">+    }</span>
<a href="#l17.127"></a><span id="l17.127" class="difflineplus">+  }</span>
<a href="#l17.128"></a><span id="l17.128" class="difflineplus">+</span>
<a href="#l17.129"></a><span id="l17.129" class="difflineplus">+  get extensionFile() {</span>
<a href="#l17.130"></a><span id="l17.130" class="difflineplus">+    let uri = Services.io.newURI(this.extension.resourceURL);</span>
<a href="#l17.131"></a><span id="l17.131" class="difflineplus">+    if (uri instanceof Ci.nsIJARURI) {</span>
<a href="#l17.132"></a><span id="l17.132" class="difflineplus">+      uri = uri.QueryInterface(Ci.nsIJARURI).JARFile;</span>
<a href="#l17.133"></a><span id="l17.133" class="difflineplus">+    }</span>
<a href="#l17.134"></a><span id="l17.134" class="difflineplus">+    return uri.QueryInterface(Ci.nsIFileURL).file;</span>
<a href="#l17.135"></a><span id="l17.135" class="difflineplus">+  }</span>
<a href="#l17.136"></a><span id="l17.136" class="difflineplus">+</span>
<a href="#l17.137"></a><span id="l17.137" class="difflineplus">+  loadScope() {</span>
<a href="#l17.138"></a><span id="l17.138" class="difflineplus">+    let {extension} = this;</span>
<a href="#l17.139"></a><span id="l17.139" class="difflineplus">+    let file = this.extensionFile;</span>
<a href="#l17.140"></a><span id="l17.140" class="difflineplus">+    let uri = this.extension.getURL(&quot;bootstrap.js&quot;);</span>
<a href="#l17.141"></a><span id="l17.141" class="difflineplus">+    let principal = Services.scriptSecurityManager.getSystemPrincipal();</span>
<a href="#l17.142"></a><span id="l17.142" class="difflineplus">+</span>
<a href="#l17.143"></a><span id="l17.143" class="difflineplus">+    let sandbox = new Cu.Sandbox(principal, {</span>
<a href="#l17.144"></a><span id="l17.144" class="difflineplus">+      sandboxName: uri,</span>
<a href="#l17.145"></a><span id="l17.145" class="difflineplus">+      addonId: this.extension.id,</span>
<a href="#l17.146"></a><span id="l17.146" class="difflineplus">+      wantGlobalProperties: [&quot;ChromeUtils&quot;],</span>
<a href="#l17.147"></a><span id="l17.147" class="difflineplus">+      metadata: { addonID: this.extension.id, URI: uri },</span>
<a href="#l17.148"></a><span id="l17.148" class="difflineplus">+    });</span>
<a href="#l17.149"></a><span id="l17.149" class="difflineplus">+</span>
<a href="#l17.150"></a><span id="l17.150" class="difflineplus">+    try {</span>
<a href="#l17.151"></a><span id="l17.151" class="difflineplus">+      Object.assign(sandbox, BOOTSTRAP_REASONS);</span>
<a href="#l17.152"></a><span id="l17.152" class="difflineplus">+</span>
<a href="#l17.153"></a><span id="l17.153" class="difflineplus">+      XPCOMUtils.defineLazyGetter(sandbox, &quot;console&quot;, () =&gt;</span>
<a href="#l17.154"></a><span id="l17.154" class="difflineplus">+        new ConsoleAPI({ consoleID: `addon/${this.extension.id}` }));</span>
<a href="#l17.155"></a><span id="l17.155" class="difflineplus">+</span>
<a href="#l17.156"></a><span id="l17.156" class="difflineplus">+      Services.scriptloader.loadSubScript(uri, sandbox);</span>
<a href="#l17.157"></a><span id="l17.157" class="difflineplus">+    } catch (e) {</span>
<a href="#l17.158"></a><span id="l17.158" class="difflineplus">+      logger.warn(`Error loading bootstrap.js for ${this.extension.id}`, e);</span>
<a href="#l17.159"></a><span id="l17.159" class="difflineplus">+    }</span>
<a href="#l17.160"></a><span id="l17.160" class="difflineplus">+</span>
<a href="#l17.161"></a><span id="l17.161" class="difflineplus">+    function findMethod(name) {</span>
<a href="#l17.162"></a><span id="l17.162" class="difflineplus">+      if (sandbox.name) {</span>
<a href="#l17.163"></a><span id="l17.163" class="difflineplus">+        return sandbox.name;</span>
<a href="#l17.164"></a><span id="l17.164" class="difflineplus">+      }</span>
<a href="#l17.165"></a><span id="l17.165" class="difflineplus">+</span>
<a href="#l17.166"></a><span id="l17.166" class="difflineplus">+      try {</span>
<a href="#l17.167"></a><span id="l17.167" class="difflineplus">+        let method = Cu.evalInSandbox(name, sandbox);</span>
<a href="#l17.168"></a><span id="l17.168" class="difflineplus">+        return method;</span>
<a href="#l17.169"></a><span id="l17.169" class="difflineplus">+      } catch (err) { }</span>
<a href="#l17.170"></a><span id="l17.170" class="difflineplus">+</span>
<a href="#l17.171"></a><span id="l17.171" class="difflineplus">+      return () =&gt; {</span>
<a href="#l17.172"></a><span id="l17.172" class="difflineplus">+        logger.warn(`Add-on ${extension.id} is missing bootstrap method ${name}`);</span>
<a href="#l17.173"></a><span id="l17.173" class="difflineplus">+      };</span>
<a href="#l17.174"></a><span id="l17.174" class="difflineplus">+    }</span>
<a href="#l17.175"></a><span id="l17.175" class="difflineplus">+</span>
<a href="#l17.176"></a><span id="l17.176" class="difflineplus">+    let install = findMethod(&quot;install&quot;);</span>
<a href="#l17.177"></a><span id="l17.177" class="difflineplus">+    let uninstall = findMethod(&quot;uninstall&quot;);</span>
<a href="#l17.178"></a><span id="l17.178" class="difflineplus">+    let startup = findMethod(&quot;startup&quot;);</span>
<a href="#l17.179"></a><span id="l17.179" class="difflineplus">+    let shutdown = findMethod(&quot;shutdown&quot;);</span>
<a href="#l17.180"></a><span id="l17.180" class="difflineplus">+</span>
<a href="#l17.181"></a><span id="l17.181" class="difflineplus">+    return {</span>
<a href="#l17.182"></a><span id="l17.182" class="difflineplus">+      install: (...args) =&gt; install(...args),</span>
<a href="#l17.183"></a><span id="l17.183" class="difflineplus">+</span>
<a href="#l17.184"></a><span id="l17.184" class="difflineplus">+      uninstall(...args) {</span>
<a href="#l17.185"></a><span id="l17.185" class="difflineplus">+        uninstall(...args);</span>
<a href="#l17.186"></a><span id="l17.186" class="difflineplus">+        // Forget any cached files we might've had from this extension.</span>
<a href="#l17.187"></a><span id="l17.187" class="difflineplus">+        Services.obs.notifyObservers(null, &quot;startupcache-invalidate&quot;);</span>
<a href="#l17.188"></a><span id="l17.188" class="difflineplus">+      },</span>
<a href="#l17.189"></a><span id="l17.189" class="difflineplus">+</span>
<a href="#l17.190"></a><span id="l17.190" class="difflineplus">+      startup(...args) {</span>
<a href="#l17.191"></a><span id="l17.191" class="difflineplus">+        logger.debug(`Registering manifest for ${file.path}\n`);</span>
<a href="#l17.192"></a><span id="l17.192" class="difflineplus">+        Components.manager.addBootstrappedManifestLocation(file);</span>
<a href="#l17.193"></a><span id="l17.193" class="difflineplus">+        return startup(...args);</span>
<a href="#l17.194"></a><span id="l17.194" class="difflineplus">+      },</span>
<a href="#l17.195"></a><span id="l17.195" class="difflineplus">+</span>
<a href="#l17.196"></a><span id="l17.196" class="difflineplus">+      shutdown(data, reason) {</span>
<a href="#l17.197"></a><span id="l17.197" class="difflineplus">+        try {</span>
<a href="#l17.198"></a><span id="l17.198" class="difflineplus">+          return shutdown(data, reason);</span>
<a href="#l17.199"></a><span id="l17.199" class="difflineplus">+        } catch (err) {</span>
<a href="#l17.200"></a><span id="l17.200" class="difflineplus">+          throw err;</span>
<a href="#l17.201"></a><span id="l17.201" class="difflineplus">+        } finally {</span>
<a href="#l17.202"></a><span id="l17.202" class="difflineplus">+          if (reason != BOOTSTRAP_REASONS.APP_SHUTDOWN) {</span>
<a href="#l17.203"></a><span id="l17.203" class="difflineplus">+            logger.debug(`Removing manifest for ${file.path}\n`);</span>
<a href="#l17.204"></a><span id="l17.204" class="difflineplus">+            Components.manager.removeBootstrappedManifestLocation(file);</span>
<a href="#l17.205"></a><span id="l17.205" class="difflineplus">+          }</span>
<a href="#l17.206"></a><span id="l17.206" class="difflineplus">+        }</span>
<a href="#l17.207"></a><span id="l17.207" class="difflineplus">+      },</span>
<a href="#l17.208"></a><span id="l17.208" class="difflineplus">+    };</span>
<a href="#l17.209"></a><span id="l17.209" class="difflineplus">+  }</span>
<a href="#l17.210"></a><span id="l17.210"> };</span>
<a href="#l17.211"></a><span id="l17.211"> </span>
<a href="#l17.212"></a><span id="l17.212"> function getAllWindows() {</span>
<a href="#l17.213"></a><span id="l17.213">   function getChildDocShells(parentDocShell) {</span>
<a href="#l17.214"></a><span id="l17.214">     let docShellEnum = parentDocShell.getDocShellEnumerator(</span>
<a href="#l17.215"></a><span id="l17.215">       Ci.nsIDocShellTreeItem.typeAll,</span>
<a href="#l17.216"></a><span id="l17.216">       Ci.nsIDocShell.ENUMERATE_FORWARDS</span>
<a href="#l17.217"></a><span id="l17.217">     );</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mail/components/extensions/schemas/legacy.json</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mail/components/extensions/schemas/legacy.json</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -9,27 +9,33 @@</span>
<a href="#l18.4"></a><span id="l18.4">             &quot;optional&quot;: true,</span>
<a href="#l18.5"></a><span id="l18.5">             &quot;choices&quot;: [</span>
<a href="#l18.6"></a><span id="l18.6">               {</span>
<a href="#l18.7"></a><span id="l18.7">                 &quot;type&quot;: &quot;boolean&quot;</span>
<a href="#l18.8"></a><span id="l18.8">               },</span>
<a href="#l18.9"></a><span id="l18.9">               {</span>
<a href="#l18.10"></a><span id="l18.10">                 &quot;type&quot;: &quot;object&quot;,</span>
<a href="#l18.11"></a><span id="l18.11">                 &quot;properties&quot;: {</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineplus">+                  &quot;type&quot;: {</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+                    &quot;type&quot;: &quot;string&quot;,</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineplus">+                    &quot;enum&quot;: [&quot;xul&quot;, &quot;bootstrap&quot;],</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineplus">+                    &quot;optional&quot;: true</span>
<a href="#l18.16"></a><span id="l18.16" class="difflineplus">+                  },</span>
<a href="#l18.17"></a><span id="l18.17">                   &quot;options&quot;: {</span>
<a href="#l18.18"></a><span id="l18.18">                     &quot;type&quot;: &quot;object&quot;,</span>
<a href="#l18.19"></a><span id="l18.19">                     &quot;properties&quot;: {</span>
<a href="#l18.20"></a><span id="l18.20">                       &quot;page&quot;: {</span>
<a href="#l18.21"></a><span id="l18.21">                         &quot;type&quot;: &quot;string&quot;</span>
<a href="#l18.22"></a><span id="l18.22">                       },</span>
<a href="#l18.23"></a><span id="l18.23">                       &quot;open_in_tab&quot;: {</span>
<a href="#l18.24"></a><span id="l18.24">                         &quot;type&quot;: &quot;boolean&quot;,</span>
<a href="#l18.25"></a><span id="l18.25">                         &quot;optional&quot;: true</span>
<a href="#l18.26"></a><span id="l18.26">                       }</span>
<a href="#l18.27"></a><span id="l18.27" class="difflineminus">-                    }</span>
<a href="#l18.28"></a><span id="l18.28" class="difflineplus">+                    },</span>
<a href="#l18.29"></a><span id="l18.29" class="difflineplus">+                    &quot;optional&quot;: true</span>
<a href="#l18.30"></a><span id="l18.30">                   }</span>
<a href="#l18.31"></a><span id="l18.31">                 }</span>
<a href="#l18.32"></a><span id="l18.32">               }</span>
<a href="#l18.33"></a><span id="l18.33">             ]</span>
<a href="#l18.34"></a><span id="l18.34">           }</span>
<a href="#l18.35"></a><span id="l18.35">         }</span>
<a href="#l18.36"></a><span id="l18.36">       }</span>
<a href="#l18.37"></a><span id="l18.37">     ]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mail/components/mailGlue.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mail/components/mailGlue.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -96,20 +96,16 @@ MailGlue.prototype = {</span>
<a href="#l19.4"></a><span id="l19.4"> </span>
<a href="#l19.5"></a><span id="l19.5">     ExtensionSupport.unregisterWindowListener(&quot;Thunderbird-internal-Toolbox&quot;);</span>
<a href="#l19.6"></a><span id="l19.6">     ExtensionSupport.unregisterWindowListener(&quot;Thunderbird-internal-BrowserConsole&quot;);</span>
<a href="#l19.7"></a><span id="l19.7">   },</span>
<a href="#l19.8"></a><span id="l19.8"> </span>
<a href="#l19.9"></a><span id="l19.9">   // nsIObserver implementation</span>
<a href="#l19.10"></a><span id="l19.10">   observe(aSubject, aTopic, aData) {</span>
<a href="#l19.11"></a><span id="l19.11">     switch (aTopic) {</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-    case &quot;app-startup&quot;:</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineminus">-      const {BootstrapLoader} = ChromeUtils.import(&quot;resource:///modules/BootstrapLoader.jsm&quot;);</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineminus">-      AddonManager.addExternalExtensionLoader(BootstrapLoader);</span>
<a href="#l19.15"></a><span id="l19.15" class="difflineminus">-      break;</span>
<a href="#l19.16"></a><span id="l19.16">     case &quot;xpcom-shutdown&quot;:</span>
<a href="#l19.17"></a><span id="l19.17">       this._dispose();</span>
<a href="#l19.18"></a><span id="l19.18">       break;</span>
<a href="#l19.19"></a><span id="l19.19">     case &quot;final-ui-startup&quot;:</span>
<a href="#l19.20"></a><span id="l19.20">       this._onProfileStartup();</span>
<a href="#l19.21"></a><span id="l19.21">       break;</span>
<a href="#l19.22"></a><span id="l19.22">     case &quot;mail-startup-done&quot;:</span>
<a href="#l19.23"></a><span id="l19.23">       this._onMailStartupDone();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mail/test/mozmill/content-tabs/test-install-xpi.js</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mail/test/mozmill/content-tabs/test-install-xpi.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -61,34 +61,33 @@ function test_install_corrupt_xpi() {</span>
<a href="#l20.4"></a><span id="l20.4">   mc.click(content_tab_eid(gNewTab, &quot;corruptlink&quot;));</span>
<a href="#l20.5"></a><span id="l20.5">   waitForNotification(&quot;addon-install-blocked&quot;, &quot;.popup-notification-primary-button&quot;);</span>
<a href="#l20.6"></a><span id="l20.6">   waitForNotification(&quot;addon-install-failed&quot;, &quot;.popup-notification-primary-button&quot;);</span>
<a href="#l20.7"></a><span id="l20.7"> }</span>
<a href="#l20.8"></a><span id="l20.8"> </span>
<a href="#l20.9"></a><span id="l20.9"> function test_install_xpi_offer() {</span>
<a href="#l20.10"></a><span id="l20.10">   mc.click(content_tab_eid(gNewTab, &quot;installlink&quot;));</span>
<a href="#l20.11"></a><span id="l20.11">   waitForNotification(&quot;addon-install-blocked&quot;, &quot;.popup-notification-primary-button&quot;);</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-  waitForNotification(&quot;addon-install-confirmation&quot;, &quot;.popup-notification-secondary-button&quot;);</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+  waitForNotification(&quot;addon-install-failed&quot;, &quot;.popup-notification-primary-button&quot;);</span>
<a href="#l20.14"></a><span id="l20.14"> }</span>
<a href="#l20.15"></a><span id="l20.15"> </span>
<a href="#l20.16"></a><span id="l20.16"> function test_xpinstall_disabled() {</span>
<a href="#l20.17"></a><span id="l20.17">   Services.prefs.setBoolPref(&quot;xpinstall.enabled&quot;, false);</span>
<a href="#l20.18"></a><span id="l20.18"> </span>
<a href="#l20.19"></a><span id="l20.19">   // Try installation again - this time we'll get an install has been disabled message.</span>
<a href="#l20.20"></a><span id="l20.20">   mc.click(content_tab_eid(gNewTab, &quot;installlink&quot;));</span>
<a href="#l20.21"></a><span id="l20.21">   waitForNotification(&quot;xpinstall-disabled&quot;, &quot;.popup-notification-secondary-button&quot;);</span>
<a href="#l20.22"></a><span id="l20.22"> </span>
<a href="#l20.23"></a><span id="l20.23">   Services.prefs.clearUserPref(&quot;xpinstall.enabled&quot;);</span>
<a href="#l20.24"></a><span id="l20.24"> }</span>
<a href="#l20.25"></a><span id="l20.25"> </span>
<a href="#l20.26"></a><span id="l20.26"> function test_xpinstall_actually_install() {</span>
<a href="#l20.27"></a><span id="l20.27">   mc.click(content_tab_eid(gNewTab, &quot;installlink&quot;));</span>
<a href="#l20.28"></a><span id="l20.28">   waitForNotification(&quot;addon-install-blocked&quot;, &quot;.popup-notification-primary-button&quot;);</span>
<a href="#l20.29"></a><span id="l20.29" class="difflineminus">-  waitForNotification(&quot;addon-install-confirmation&quot;, &quot;.popup-notification-primary-button&quot;);</span>
<a href="#l20.30"></a><span id="l20.30" class="difflineminus">-  waitForNotification(&quot;addon-installed&quot;, &quot;.popup-notification-primary-button&quot;);</span>
<a href="#l20.31"></a><span id="l20.31" class="difflineplus">+  waitForNotification(&quot;addon-install-failed&quot;, &quot;.popup-notification-primary-button&quot;);</span>
<a href="#l20.32"></a><span id="l20.32"> }</span>
<a href="#l20.33"></a><span id="l20.33"> </span>
<a href="#l20.34"></a><span id="l20.34"> function test_xpinstall_webext_actually_install() {</span>
<a href="#l20.35"></a><span id="l20.35">   mc.click(content_tab_eid(gNewTab, &quot;installwebextlink&quot;));</span>
<a href="#l20.36"></a><span id="l20.36">   waitForNotification(&quot;addon-install-blocked&quot;, &quot;.popup-notification-primary-button&quot;);</span>
<a href="#l20.37"></a><span id="l20.37">   waitForNotification(&quot;addon-webext-permissions&quot;, &quot;.popup-notification-primary-button&quot;, () =&gt; {</span>
<a href="#l20.38"></a><span id="l20.38">     let intro = new elib.ID(gDocument, &quot;addon-webext-perm-intro&quot;);</span>
<a href="#l20.39"></a><span id="l20.39">     mc.assertNotDOMProperty(intro, &quot;hidden&quot;, &quot;true&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1">rename from mail/test/mozmill/folder-tree-modes/test-extension/install.rdf</span>
<a href="#l21.2"></a><span id="l21.2">rename to mail/test/mozmill/folder-tree-modes/test-extension/manifest.json</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineminus">--- a/mail/test/mozmill/folder-tree-modes/test-extension/install.rdf</span>
<a href="#l21.4"></a><span id="l21.4" class="difflineplus">+++ b/mail/test/mozmill/folder-tree-modes/test-extension/manifest.json</span>
<a href="#l21.5"></a><span id="l21.5" class="difflineat">@@ -1,19 +1,14 @@</span>
<a href="#l21.6"></a><span id="l21.6" class="difflineminus">-&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<a href="#l21.7"></a><span id="l21.7" class="difflineminus">-&lt;RDF xmlns=&quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#&quot; xmlns:em=&quot;http://www.mozilla.org/2004/em-rdf#&quot;&gt;</span>
<a href="#l21.8"></a><span id="l21.8" class="difflineminus">-  &lt;Description about=&quot;urn:mozilla:install-manifest&quot;&gt;</span>
<a href="#l21.9"></a><span id="l21.9" class="difflineminus">-    &lt;em:id&gt;testfoldertreemode@mozilla.org&lt;/em:id&gt;</span>
<a href="#l21.10"></a><span id="l21.10" class="difflineminus">-    &lt;em:type&gt;2&lt;/em:type&gt;</span>
<a href="#l21.11"></a><span id="l21.11" class="difflineminus">-    &lt;em:name&gt;Test Folder Modes&lt;/em:name&gt;</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-    &lt;em:version&gt;1.0&lt;/em:version&gt;</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineminus">-    &lt;em:creator&gt;Mozilla Foundation&lt;/em:creator&gt;</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineminus">-    &lt;em:description&gt;Provides a custom folder tree mode to be used by tests&lt;/em:description&gt;</span>
<a href="#l21.15"></a><span id="l21.15" class="difflineminus">-    &lt;em:bootstrap&gt;true&lt;/em:bootstrap&gt;</span>
<a href="#l21.16"></a><span id="l21.16" class="difflineminus">-    &lt;em:targetApplication&gt;</span>
<a href="#l21.17"></a><span id="l21.17" class="difflineminus">-      &lt;Description&gt;</span>
<a href="#l21.18"></a><span id="l21.18" class="difflineminus">-        &lt;em:id&gt;{3550f703-e582-4d05-9a08-453d09bdfdc6}&lt;/em:id&gt; &lt;!-- Thunderbird --&gt;</span>
<a href="#l21.19"></a><span id="l21.19" class="difflineminus">-        &lt;em:minVersion&gt;3.1a1pre&lt;/em:minVersion&gt;</span>
<a href="#l21.20"></a><span id="l21.20" class="difflineminus">-        &lt;em:maxVersion&gt;*&lt;/em:maxVersion&gt;</span>
<a href="#l21.21"></a><span id="l21.21" class="difflineminus">-      &lt;/Description&gt;</span>
<a href="#l21.22"></a><span id="l21.22" class="difflineminus">-    &lt;/em:targetApplication&gt;</span>
<a href="#l21.23"></a><span id="l21.23" class="difflineminus">-  &lt;/Description&gt;</span>
<a href="#l21.24"></a><span id="l21.24" class="difflineminus">-&lt;/RDF&gt;</span>
<a href="#l21.25"></a><span id="l21.25" class="difflineplus">+{</span>
<a href="#l21.26"></a><span id="l21.26" class="difflineplus">+  &quot;manifest_version&quot;: 2,</span>
<a href="#l21.27"></a><span id="l21.27" class="difflineplus">+  &quot;applications&quot;: {</span>
<a href="#l21.28"></a><span id="l21.28" class="difflineplus">+    &quot;gecko&quot;: {</span>
<a href="#l21.29"></a><span id="l21.29" class="difflineplus">+      &quot;id&quot;: &quot;testfoldertreemode@mozilla.org&quot;</span>
<a href="#l21.30"></a><span id="l21.30" class="difflineplus">+    }</span>
<a href="#l21.31"></a><span id="l21.31" class="difflineplus">+  },</span>
<a href="#l21.32"></a><span id="l21.32" class="difflineplus">+  &quot;name&quot;: &quot;Test Folder Modes&quot;,</span>
<a href="#l21.33"></a><span id="l21.33" class="difflineplus">+  &quot;version&quot;: &quot;1.0&quot;,</span>
<a href="#l21.34"></a><span id="l21.34" class="difflineplus">+  &quot;description&quot;: &quot;Provides a custom folder tree mode to be used by tests&quot;,</span>
<a href="#l21.35"></a><span id="l21.35" class="difflineplus">+  &quot;legacy&quot;: {</span>
<a href="#l21.36"></a><span id="l21.36" class="difflineplus">+    &quot;type&quot;: &quot;bootstrap&quot;</span>
<a href="#l21.37"></a><span id="l21.37" class="difflineplus">+  }</span>
<a href="#l21.38"></a><span id="l21.38" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1">deleted file mode 100644</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineminus">--- a/mail/test/resources/jsbridge/jsbridge/extension/install.rdf</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineplus">+++ /dev/null</span>
<a href="#l22.4"></a><span id="l22.4" class="difflineat">@@ -1,51 +0,0 @@</span>
<a href="#l22.5"></a><span id="l22.5" class="difflineminus">-&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<a href="#l22.6"></a><span id="l22.6" class="difflineminus">-&lt;RDF xmlns=&quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#&quot;</span>
<a href="#l22.7"></a><span id="l22.7" class="difflineminus">-     xmlns:em=&quot;http://www.mozilla.org/2004/em-rdf#&quot;&gt;</span>
<a href="#l22.8"></a><span id="l22.8" class="difflineminus">-   &lt;Description about=&quot;urn:mozilla:install-manifest&quot;&gt;</span>
<a href="#l22.9"></a><span id="l22.9" class="difflineminus">-     &lt;em:id&gt;jsbridge@mozilla.com&lt;/em:id&gt;</span>
<a href="#l22.10"></a><span id="l22.10" class="difflineminus">-     &lt;em:name&gt;jsbridge&lt;/em:name&gt;</span>
<a href="#l22.11"></a><span id="l22.11" class="difflineminus">-     &lt;em:version&gt;2.4.14&lt;/em:version&gt;</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-     &lt;em:bootstrap&gt;true&lt;/em:bootstrap&gt;</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineminus">-     &lt;em:creator&gt;Mikeal Rogers&lt;/em:creator&gt;</span>
<a href="#l22.14"></a><span id="l22.14" class="difflineminus">-     &lt;em:description&gt;Python to JavaScript bridge&lt;/em:description&gt;</span>
<a href="#l22.15"></a><span id="l22.15" class="difflineminus">-     &lt;em:targetApplication&gt;</span>
<a href="#l22.16"></a><span id="l22.16" class="difflineminus">-       &lt;!-- Firefox --&gt;</span>
<a href="#l22.17"></a><span id="l22.17" class="difflineminus">-       &lt;Description&gt;</span>
<a href="#l22.18"></a><span id="l22.18" class="difflineminus">-         &lt;em:id&gt;{ec8030f7-c20a-464f-9b0e-13a3a9e97384}&lt;/em:id&gt;</span>
<a href="#l22.19"></a><span id="l22.19" class="difflineminus">-         &lt;em:minVersion&gt;4.0&lt;/em:minVersion&gt;</span>
<a href="#l22.20"></a><span id="l22.20" class="difflineminus">-         &lt;em:maxVersion&gt;20.*&lt;/em:maxVersion&gt;</span>
<a href="#l22.21"></a><span id="l22.21" class="difflineminus">-       &lt;/Description&gt;</span>
<a href="#l22.22"></a><span id="l22.22" class="difflineminus">-     &lt;/em:targetApplication&gt;</span>
<a href="#l22.23"></a><span id="l22.23" class="difflineminus">-     &lt;em:targetApplication&gt;</span>
<a href="#l22.24"></a><span id="l22.24" class="difflineminus">-       &lt;!-- Thunderbird --&gt;</span>
<a href="#l22.25"></a><span id="l22.25" class="difflineminus">-       &lt;Description&gt;</span>
<a href="#l22.26"></a><span id="l22.26" class="difflineminus">-         &lt;em:id&gt;{3550f703-e582-4d05-9a08-453d09bdfdc6}&lt;/em:id&gt;</span>
<a href="#l22.27"></a><span id="l22.27" class="difflineminus">-         &lt;em:minVersion&gt;5.0&lt;/em:minVersion&gt;</span>
<a href="#l22.28"></a><span id="l22.28" class="difflineminus">-         &lt;em:maxVersion&gt;*&lt;/em:maxVersion&gt;</span>
<a href="#l22.29"></a><span id="l22.29" class="difflineminus">-       &lt;/Description&gt;</span>
<a href="#l22.30"></a><span id="l22.30" class="difflineminus">-     &lt;/em:targetApplication&gt;</span>
<a href="#l22.31"></a><span id="l22.31" class="difflineminus">-     &lt;em:targetApplication&gt;</span>
<a href="#l22.32"></a><span id="l22.32" class="difflineminus">-       &lt;!-- Sunbird --&gt;</span>
<a href="#l22.33"></a><span id="l22.33" class="difflineminus">-       &lt;Description&gt;</span>
<a href="#l22.34"></a><span id="l22.34" class="difflineminus">-         &lt;em:id&gt;{718e30fb-e89b-41dd-9da7-e25a45638b28}&lt;/em:id&gt;</span>
<a href="#l22.35"></a><span id="l22.35" class="difflineminus">-         &lt;em:minVersion&gt;1.0b5&lt;/em:minVersion&gt;</span>
<a href="#l22.36"></a><span id="l22.36" class="difflineminus">-         &lt;em:maxVersion&gt;1.6b1&lt;/em:maxVersion&gt;</span>
<a href="#l22.37"></a><span id="l22.37" class="difflineminus">-       &lt;/Description&gt;</span>
<a href="#l22.38"></a><span id="l22.38" class="difflineminus">-     &lt;/em:targetApplication&gt;</span>
<a href="#l22.39"></a><span id="l22.39" class="difflineminus">-     &lt;em:targetApplication&gt;</span>
<a href="#l22.40"></a><span id="l22.40" class="difflineminus">-       &lt;!-- SeaMonkey --&gt;</span>
<a href="#l22.41"></a><span id="l22.41" class="difflineminus">-       &lt;Description&gt;</span>
<a href="#l22.42"></a><span id="l22.42" class="difflineminus">-         &lt;em:id&gt;{92650c4d-4b8e-4d2a-b7eb-24ecf4f6b63a}&lt;/em:id&gt;</span>
<a href="#l22.43"></a><span id="l22.43" class="difflineminus">-         &lt;em:minVersion&gt;2.1&lt;/em:minVersion&gt;</span>
<a href="#l22.44"></a><span id="l22.44" class="difflineminus">-         &lt;em:maxVersion&gt;2.16&lt;/em:maxVersion&gt;</span>
<a href="#l22.45"></a><span id="l22.45" class="difflineminus">-       &lt;/Description&gt;</span>
<a href="#l22.46"></a><span id="l22.46" class="difflineminus">-     &lt;/em:targetApplication&gt;</span>
<a href="#l22.47"></a><span id="l22.47" class="difflineminus">-     &lt;em:targetApplication&gt;</span>
<a href="#l22.48"></a><span id="l22.48" class="difflineminus">-         &lt;Description&gt;</span>
<a href="#l22.49"></a><span id="l22.49" class="difflineminus">-          &lt;em:id&gt;toolkit@mozilla.org&lt;/em:id&gt;</span>
<a href="#l22.50"></a><span id="l22.50" class="difflineminus">-          &lt;em:minVersion&gt;2.0&lt;/em:minVersion&gt;</span>
<a href="#l22.51"></a><span id="l22.51" class="difflineminus">-          &lt;em:maxVersion&gt;20.*&lt;/em:maxVersion&gt;</span>
<a href="#l22.52"></a><span id="l22.52" class="difflineminus">-         &lt;/Description&gt;</span>
<a href="#l22.53"></a><span id="l22.53" class="difflineminus">-     &lt;/em:targetApplication&gt;</span>
<a href="#l22.54"></a><span id="l22.54" class="difflineminus">-   &lt;/Description&gt;</span>
<a href="#l22.55"></a><span id="l22.55" class="difflineminus">-&lt;/RDF&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1">new file mode 100644</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineminus">--- /dev/null</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineplus">+++ b/mail/test/resources/jsbridge/jsbridge/extension/manifest.json</span>
<a href="#l23.4"></a><span id="l23.4" class="difflineat">@@ -0,0 +1,13 @@</span>
<a href="#l23.5"></a><span id="l23.5" class="difflineplus">+{</span>
<a href="#l23.6"></a><span id="l23.6" class="difflineplus">+  &quot;manifest_version&quot;: 2,</span>
<a href="#l23.7"></a><span id="l23.7" class="difflineplus">+  &quot;name&quot;: &quot;jsbridge&quot;,</span>
<a href="#l23.8"></a><span id="l23.8" class="difflineplus">+  &quot;version&quot;: &quot;2.5.2&quot;,</span>
<a href="#l23.9"></a><span id="l23.9" class="difflineplus">+  &quot;applications&quot;: {</span>
<a href="#l23.10"></a><span id="l23.10" class="difflineplus">+    &quot;gecko&quot;: {</span>
<a href="#l23.11"></a><span id="l23.11" class="difflineplus">+      &quot;id&quot;: &quot;jsbridge@mozilla.com&quot;</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineplus">+    }</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineplus">+  },</span>
<a href="#l23.14"></a><span id="l23.14" class="difflineplus">+  &quot;legacy&quot;: {</span>
<a href="#l23.15"></a><span id="l23.15" class="difflineplus">+    &quot;type&quot;: &quot;bootstrap&quot;</span>
<a href="#l23.16"></a><span id="l23.16" class="difflineplus">+  }</span>
<a href="#l23.17"></a><span id="l23.17" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mail/test/resources/jsbridge/setup.py</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mail/test/resources/jsbridge/setup.py</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -37,17 +37,17 @@</span>
<a href="#l24.4"></a><span id="l24.4"> </span>
<a href="#l24.5"></a><span id="l24.5"> from setuptools import setup, find_packages</span>
<a href="#l24.6"></a><span id="l24.6"> </span>
<a href="#l24.7"></a><span id="l24.7"> desc = &quot;&quot;&quot;Python to JavaScript bridge interface.&quot;&quot;&quot;</span>
<a href="#l24.8"></a><span id="l24.8"> summ = &quot;&quot;&quot;A powerful and extensible Python to JavaScript bridge interface.&quot;&quot;&quot;</span>
<a href="#l24.9"></a><span id="l24.9"> </span>
<a href="#l24.10"></a><span id="l24.10"> PACKAGE_NAME = &quot;jsbridge_thunderbird&quot;</span>
<a href="#l24.11"></a><span id="l24.11"> # You must update the required version in mozmill's setup.py to match this.</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-PACKAGE_VERSION = &quot;2.5.1&quot;</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineplus">+PACKAGE_VERSION = &quot;2.5.2&quot;</span>
<a href="#l24.14"></a><span id="l24.14"> </span>
<a href="#l24.15"></a><span id="l24.15"> requires = ['mozrunner &gt;= 6.0']</span>
<a href="#l24.16"></a><span id="l24.16"> </span>
<a href="#l24.17"></a><span id="l24.17"> setup(name=PACKAGE_NAME,</span>
<a href="#l24.18"></a><span id="l24.18">       version=PACKAGE_VERSION,</span>
<a href="#l24.19"></a><span id="l24.19">       description=desc,</span>
<a href="#l24.20"></a><span id="l24.20">       long_description=summ,</span>
<a href="#l24.21"></a><span id="l24.21">       author='Mikeal Rogers, Mozilla',</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1">deleted file mode 100755</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineminus">--- a/mail/test/resources/mozmill/mozmill/extension/install.rdf</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineplus">+++ /dev/null</span>
<a href="#l25.4"></a><span id="l25.4" class="difflineat">@@ -1,52 +0,0 @@</span>
<a href="#l25.5"></a><span id="l25.5" class="difflineminus">-&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<a href="#l25.6"></a><span id="l25.6" class="difflineminus">-&lt;RDF xmlns=&quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#&quot;</span>
<a href="#l25.7"></a><span id="l25.7" class="difflineminus">-     xmlns:em=&quot;http://www.mozilla.org/2004/em-rdf#&quot;&gt;</span>
<a href="#l25.8"></a><span id="l25.8" class="difflineminus">-   &lt;Description about=&quot;urn:mozilla:install-manifest&quot;&gt;</span>
<a href="#l25.9"></a><span id="l25.9" class="difflineminus">-     &lt;em:id&gt;mozmill@mozilla.com&lt;/em:id&gt;</span>
<a href="#l25.10"></a><span id="l25.10" class="difflineminus">-     &lt;em:name&gt;MozMill&lt;/em:name&gt;</span>
<a href="#l25.11"></a><span id="l25.11" class="difflineminus">-     &lt;em:version&gt;1.5.16&lt;/em:version&gt;</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-     &lt;em:creator&gt;Adam Christian&lt;/em:creator&gt;</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineminus">-     &lt;em:description&gt;A testing extension based on the Windmill Testing Framework client source&lt;/em:description&gt;</span>
<a href="#l25.14"></a><span id="l25.14" class="difflineminus">-     &lt;em:bootstrap&gt;true&lt;/em:bootstrap&gt;</span>
<a href="#l25.15"></a><span id="l25.15" class="difflineminus">-     &lt;em:optionsURL&gt;chrome://mozmill/content/prefs.xul&lt;/em:optionsURL&gt;</span>
<a href="#l25.16"></a><span id="l25.16" class="difflineminus">-     &lt;em:targetApplication&gt;</span>
<a href="#l25.17"></a><span id="l25.17" class="difflineminus">-       &lt;!-- Firefox --&gt;</span>
<a href="#l25.18"></a><span id="l25.18" class="difflineminus">-       &lt;Description&gt;</span>
<a href="#l25.19"></a><span id="l25.19" class="difflineminus">-         &lt;em:id&gt;{ec8030f7-c20a-464f-9b0e-13a3a9e97384}&lt;/em:id&gt;</span>
<a href="#l25.20"></a><span id="l25.20" class="difflineminus">-         &lt;em:minVersion&gt;4.0&lt;/em:minVersion&gt;</span>
<a href="#l25.21"></a><span id="l25.21" class="difflineminus">-         &lt;em:maxVersion&gt;20.*&lt;/em:maxVersion&gt;</span>
<a href="#l25.22"></a><span id="l25.22" class="difflineminus">-       &lt;/Description&gt;</span>
<a href="#l25.23"></a><span id="l25.23" class="difflineminus">-     &lt;/em:targetApplication&gt;</span>
<a href="#l25.24"></a><span id="l25.24" class="difflineminus">-     &lt;em:targetApplication&gt;</span>
<a href="#l25.25"></a><span id="l25.25" class="difflineminus">-       &lt;!-- Thunderbird --&gt;</span>
<a href="#l25.26"></a><span id="l25.26" class="difflineminus">-       &lt;Description&gt;</span>
<a href="#l25.27"></a><span id="l25.27" class="difflineminus">-         &lt;em:id&gt;{3550f703-e582-4d05-9a08-453d09bdfdc6}&lt;/em:id&gt;</span>
<a href="#l25.28"></a><span id="l25.28" class="difflineminus">-         &lt;em:minVersion&gt;5.0&lt;/em:minVersion&gt;</span>
<a href="#l25.29"></a><span id="l25.29" class="difflineminus">-         &lt;em:maxVersion&gt;*&lt;/em:maxVersion&gt;</span>
<a href="#l25.30"></a><span id="l25.30" class="difflineminus">-       &lt;/Description&gt;</span>
<a href="#l25.31"></a><span id="l25.31" class="difflineminus">-     &lt;/em:targetApplication&gt;</span>
<a href="#l25.32"></a><span id="l25.32" class="difflineminus">-     &lt;em:targetApplication&gt;</span>
<a href="#l25.33"></a><span id="l25.33" class="difflineminus">-       &lt;!-- Sunbird --&gt;</span>
<a href="#l25.34"></a><span id="l25.34" class="difflineminus">-       &lt;Description&gt;</span>
<a href="#l25.35"></a><span id="l25.35" class="difflineminus">-         &lt;em:id&gt;{718e30fb-e89b-41dd-9da7-e25a45638b28}&lt;/em:id&gt;</span>
<a href="#l25.36"></a><span id="l25.36" class="difflineminus">-         &lt;em:minVersion&gt;1.0b5&lt;/em:minVersion&gt;</span>
<a href="#l25.37"></a><span id="l25.37" class="difflineminus">-         &lt;em:maxVersion&gt;1.6b1&lt;/em:maxVersion&gt;</span>
<a href="#l25.38"></a><span id="l25.38" class="difflineminus">-       &lt;/Description&gt;</span>
<a href="#l25.39"></a><span id="l25.39" class="difflineminus">-     &lt;/em:targetApplication&gt;</span>
<a href="#l25.40"></a><span id="l25.40" class="difflineminus">-     &lt;em:targetApplication&gt;</span>
<a href="#l25.41"></a><span id="l25.41" class="difflineminus">-       &lt;!-- SeaMonkey --&gt;</span>
<a href="#l25.42"></a><span id="l25.42" class="difflineminus">-       &lt;Description&gt;</span>
<a href="#l25.43"></a><span id="l25.43" class="difflineminus">-         &lt;em:id&gt;{92650c4d-4b8e-4d2a-b7eb-24ecf4f6b63a}&lt;/em:id&gt;</span>
<a href="#l25.44"></a><span id="l25.44" class="difflineminus">-         &lt;em:minVersion&gt;2.1&lt;/em:minVersion&gt;</span>
<a href="#l25.45"></a><span id="l25.45" class="difflineminus">-         &lt;em:maxVersion&gt;2.16&lt;/em:maxVersion&gt;</span>
<a href="#l25.46"></a><span id="l25.46" class="difflineminus">-       &lt;/Description&gt;</span>
<a href="#l25.47"></a><span id="l25.47" class="difflineminus">-     &lt;/em:targetApplication&gt;</span>
<a href="#l25.48"></a><span id="l25.48" class="difflineminus">-     &lt;em:targetApplication&gt;</span>
<a href="#l25.49"></a><span id="l25.49" class="difflineminus">-         &lt;Description&gt;</span>
<a href="#l25.50"></a><span id="l25.50" class="difflineminus">-          &lt;em:id&gt;toolkit@mozilla.org&lt;/em:id&gt;</span>
<a href="#l25.51"></a><span id="l25.51" class="difflineminus">-          &lt;em:minVersion&gt;2.0&lt;/em:minVersion&gt;</span>
<a href="#l25.52"></a><span id="l25.52" class="difflineminus">-          &lt;em:maxVersion&gt;20.*&lt;/em:maxVersion&gt;</span>
<a href="#l25.53"></a><span id="l25.53" class="difflineminus">-         &lt;/Description&gt;</span>
<a href="#l25.54"></a><span id="l25.54" class="difflineminus">-     &lt;/em:targetApplication&gt;</span>
<a href="#l25.55"></a><span id="l25.55" class="difflineminus">-   &lt;/Description&gt;</span>
<a href="#l25.56"></a><span id="l25.56" class="difflineminus">-&lt;/RDF&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1">new file mode 100644</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineminus">--- /dev/null</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineplus">+++ b/mail/test/resources/mozmill/mozmill/extension/manifest.json</span>
<a href="#l26.4"></a><span id="l26.4" class="difflineat">@@ -0,0 +1,16 @@</span>
<a href="#l26.5"></a><span id="l26.5" class="difflineplus">+{</span>
<a href="#l26.6"></a><span id="l26.6" class="difflineplus">+  &quot;manifest_version&quot;: 2,</span>
<a href="#l26.7"></a><span id="l26.7" class="difflineplus">+  &quot;name&quot;: &quot;MozMill&quot;,</span>
<a href="#l26.8"></a><span id="l26.8" class="difflineplus">+  &quot;version&quot;: &quot;1.6.2&quot;,</span>
<a href="#l26.9"></a><span id="l26.9" class="difflineplus">+  &quot;applications&quot;: {</span>
<a href="#l26.10"></a><span id="l26.10" class="difflineplus">+    &quot;gecko&quot;: {</span>
<a href="#l26.11"></a><span id="l26.11" class="difflineplus">+      &quot;id&quot;: &quot;mozmill@mozilla.com&quot;</span>
<a href="#l26.12"></a><span id="l26.12" class="difflineplus">+    }</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineplus">+  },</span>
<a href="#l26.14"></a><span id="l26.14" class="difflineplus">+  &quot;legacy&quot;: {</span>
<a href="#l26.15"></a><span id="l26.15" class="difflineplus">+    &quot;type&quot;: &quot;bootstrap&quot;,</span>
<a href="#l26.16"></a><span id="l26.16" class="difflineplus">+    &quot;options&quot;: {</span>
<a href="#l26.17"></a><span id="l26.17" class="difflineplus">+      &quot;page&quot;: &quot;chrome://mozmill/content/prefs.xul&quot;</span>
<a href="#l26.18"></a><span id="l26.18" class="difflineplus">+    }</span>
<a href="#l26.19"></a><span id="l26.19" class="difflineplus">+  }</span>
<a href="#l26.20"></a><span id="l26.20" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/mail/test/resources/mozmill/setup.py</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/mail/test/resources/mozmill/setup.py</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -36,17 +36,17 @@</span>
<a href="#l27.4"></a><span id="l27.4"> # ***** END LICENSE BLOCK *****</span>
<a href="#l27.5"></a><span id="l27.5"> </span>
<a href="#l27.6"></a><span id="l27.6"> from setuptools import setup, find_packages</span>
<a href="#l27.7"></a><span id="l27.7"> </span>
<a href="#l27.8"></a><span id="l27.8"> desc = &quot;&quot;&quot;UI Automation tool for Mozilla applications.&quot;&quot;&quot;</span>
<a href="#l27.9"></a><span id="l27.9"> summ = &quot;&quot;&quot;A tool for full UI automation of Mozilla applications.&quot;&quot;&quot;</span>
<a href="#l27.10"></a><span id="l27.10"> </span>
<a href="#l27.11"></a><span id="l27.11"> PACKAGE_NAME = &quot;mozmill_thunderbird&quot;</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-PACKAGE_VERSION = &quot;1.6.1&quot;</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineplus">+PACKAGE_VERSION = &quot;1.6.2&quot;</span>
<a href="#l27.14"></a><span id="l27.14"> </span>
<a href="#l27.15"></a><span id="l27.15"> setup(name=PACKAGE_NAME,</span>
<a href="#l27.16"></a><span id="l27.16">       version=PACKAGE_VERSION,</span>
<a href="#l27.17"></a><span id="l27.17">       description=desc,</span>
<a href="#l27.18"></a><span id="l27.18">       long_description=summ,</span>
<a href="#l27.19"></a><span id="l27.19">       author='Mozilla, Mikeal Rogers',</span>
<a href="#l27.20"></a><span id="l27.20">       author_email='mikeal.rogers@gmail.com',</span>
<a href="#l27.21"></a><span id="l27.21">       url='http://github.com/mozautomation/mozmill',</span>
<a href="#l27.22"></a><span id="l27.22" class="difflineat">@@ -60,17 +60,17 @@ setup(name=PACKAGE_NAME,</span>
<a href="#l27.23"></a><span id="l27.23">       entry_points=&quot;&quot;&quot;</span>
<a href="#l27.24"></a><span id="l27.24">           [console_scripts]</span>
<a href="#l27.25"></a><span id="l27.25">           mozmill = mozmill:cli</span>
<a href="#l27.26"></a><span id="l27.26">           mozmill-thunderbird = mozmill:tbird_cli</span>
<a href="#l27.27"></a><span id="l27.27">           mozmill-restart = mozmill:restart_cli</span>
<a href="#l27.28"></a><span id="l27.28">         &quot;&quot;&quot;,</span>
<a href="#l27.29"></a><span id="l27.29">       platforms=['Any'],</span>
<a href="#l27.30"></a><span id="l27.30">       install_requires=[</span>
<a href="#l27.31"></a><span id="l27.31" class="difflineminus">-          'jsbridge_thunderbird == 2.5.1',</span>
<a href="#l27.32"></a><span id="l27.32" class="difflineplus">+          'jsbridge_thunderbird == 2.5.2',</span>
<a href="#l27.33"></a><span id="l27.33">           'mozrunner &gt;= 6.0',</span>
<a href="#l27.34"></a><span id="l27.34">           'manifestparser &gt;= 0.9'</span>
<a href="#l27.35"></a><span id="l27.35">       ],</span>
<a href="#l27.36"></a><span id="l27.36">       classifiers=[</span>
<a href="#l27.37"></a><span id="l27.37">           'Development Status :: 4 - Beta',</span>
<a href="#l27.38"></a><span id="l27.38">           'Environment :: Console',</span>
<a href="#l27.39"></a><span id="l27.39">           'Intended Audience :: Developers',</span>
<a href="#l27.40"></a><span id="l27.40">           'License :: OSI Approved :: Apache Software License',</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:31Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

