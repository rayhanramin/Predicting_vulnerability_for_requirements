<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 6101:b7d14a8dd2d0b25bf30b7bbf09319d796376f147</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ b7d14a8dd2d0b25bf30b7bbf09319d796376f147" />
<meta property="og:url" content="/comm-central/rev/b7d14a8dd2d0b25bf30b7bbf09319d796376f147" />
<meta property="og:description" content="bug 580663 - Remove old bookmarks system code, r=IanN" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / b7d14a8dd2d0b25bf30b7bbf09319d796376f147 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/b7d14a8dd2d0b25bf30b7bbf09319d796376f147">shortlog</a> |
<a href="/comm-central/log/b7d14a8dd2d0b25bf30b7bbf09319d796376f147">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/b7d14a8dd2d0b25bf30b7bbf09319d796376f147">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/b7d14a8dd2d0b25bf30b7bbf09319d796376f147">files</a> |
changeset |
<a href="/comm-central/raw-rev/b7d14a8dd2d0b25bf30b7bbf09319d796376f147">raw</a>  | <a href="/comm-central/archive/b7d14a8dd2d0b25bf30b7bbf09319d796376f147.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=580663">bug 580663</a> - Remove old bookmarks system code, r=IanN
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#82;&#111;&#98;&#101;&#114;&#116;&#32;&#75;&#97;&#105;&#115;&#101;&#114;&#32;&#60;&#107;&#97;&#105;&#114;&#111;&#64;&#107;&#97;&#105;&#114;&#111;&#46;&#97;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Sun, 08 Aug 2010 22:06:47 +0200</td></tr>

<tr>
 <td>changeset 6101</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/b7d14a8dd2d0b25bf30b7bbf09319d796376f147">b7d14a8dd2d0b25bf30b7bbf09319d796376f147</a></td>
</tr>



<tr>
<td>parent 6100</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/b7f04f55aa20f29039d50312ee05657b89d39ebb">b7f04f55aa20f29039d50312ee05657b89d39ebb</a>
</td>
</tr>

<tr>
<td>child 6102</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/b9e980d6f85d8be090681db70a0be5a06d5b216d">b9e980d6f85d8be090681db70a0be5a06d5b216d</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=b7d14a8dd2d0b25bf30b7bbf09319d796376f147">4716</a></td></tr>
<tr><td>push user</td><td>kairo@kairo.at</td></tr>
<tr><td>push date</td><td class="date age">Sun, 08 Aug 2010 20:07:31 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@b9e980d6f85d [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=b9e980d6f85d8be090681db70a0be5a06d5b216d">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=b9e980d6f85d8be090681db70a0be5a06d5b216d&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b9e980d6f85d8be090681db70a0be5a06d5b216d&newProject=comm-central&newRevision=6e9656086f3397ba950d84983e1878cb757598d0&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b9e980d6f85d8be090681db70a0be5a06d5b216d&newProject=comm-central&newRevision=6e9656086f3397ba950d84983e1878cb757598d0&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b9e980d6f85d8be090681db70a0be5a06d5b216d&newProject=comm-central&newRevision=6e9656086f3397ba950d84983e1878cb757598d0&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28IanN%29&revcount=50">IanN</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=580663">580663</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=580663">bug 580663</a> - Remove old bookmarks system code, r=IanN</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/browser/public/nsIBookmarksService.idl">suite/browser/public/nsIBookmarksService.idl</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/browser/public/nsIBookmarksService.idl">diff</a> |
<a href="/comm-central/comparison/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/browser/public/nsIBookmarksService.idl">comparison</a> |
<a href="/comm-central/log/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/browser/public/nsIBookmarksService.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/browser/src/nsBookmarksService.cpp">suite/browser/src/nsBookmarksService.cpp</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/browser/src/nsBookmarksService.cpp">diff</a> |
<a href="/comm-central/comparison/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/browser/src/nsBookmarksService.cpp">comparison</a> |
<a href="/comm-central/log/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/browser/src/nsBookmarksService.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/browser/src/nsBookmarksService.h">suite/browser/src/nsBookmarksService.h</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/browser/src/nsBookmarksService.h">diff</a> |
<a href="/comm-central/comparison/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/browser/src/nsBookmarksService.h">comparison</a> |
<a href="/comm-central/log/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/browser/src/nsBookmarksService.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/browser/src/nsInternetSearchService.cpp">suite/browser/src/nsInternetSearchService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/browser/src/nsInternetSearchService.cpp">file</a> |
<a href="/comm-central/annotate/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/browser/src/nsInternetSearchService.cpp">annotate</a> |
<a href="/comm-central/diff/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/browser/src/nsInternetSearchService.cpp">diff</a> |
<a href="/comm-central/comparison/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/browser/src/nsInternetSearchService.cpp">comparison</a> |
<a href="/comm-central/log/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/browser/src/nsInternetSearchService.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/common/bookmarks/addBookmark.js">suite/common/bookmarks/addBookmark.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/common/bookmarks/addBookmark.js">diff</a> |
<a href="/comm-central/comparison/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/common/bookmarks/addBookmark.js">comparison</a> |
<a href="/comm-central/log/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/common/bookmarks/addBookmark.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/common/bookmarks/addBookmark.xul">suite/common/bookmarks/addBookmark.xul</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/common/bookmarks/addBookmark.xul">diff</a> |
<a href="/comm-central/comparison/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/common/bookmarks/addBookmark.xul">comparison</a> |
<a href="/comm-central/log/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/common/bookmarks/addBookmark.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/common/bookmarks/bookmarks.css">suite/common/bookmarks/bookmarks.css</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/common/bookmarks/bookmarks.css">diff</a> |
<a href="/comm-central/comparison/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/common/bookmarks/bookmarks.css">comparison</a> |
<a href="/comm-central/log/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/common/bookmarks/bookmarks.css">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/common/bookmarks/bookmarks.js">suite/common/bookmarks/bookmarks.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/common/bookmarks/bookmarks.js">diff</a> |
<a href="/comm-central/comparison/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/common/bookmarks/bookmarks.js">comparison</a> |
<a href="/comm-central/log/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/common/bookmarks/bookmarks.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/common/bookmarks/bookmarksMenu.js">suite/common/bookmarks/bookmarksMenu.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/common/bookmarks/bookmarksMenu.js">diff</a> |
<a href="/comm-central/comparison/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/common/bookmarks/bookmarksMenu.js">comparison</a> |
<a href="/comm-central/log/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/common/bookmarks/bookmarksMenu.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/common/bookmarks/bookmarksOverlay.xul">suite/common/bookmarks/bookmarksOverlay.xul</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/common/bookmarks/bookmarksOverlay.xul">diff</a> |
<a href="/comm-central/comparison/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/common/bookmarks/bookmarksOverlay.xul">comparison</a> |
<a href="/comm-central/log/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/common/bookmarks/bookmarksOverlay.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/common/bookmarks/bookmarksTree.xml">suite/common/bookmarks/bookmarksTree.xml</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/common/bookmarks/bookmarksTree.xml">diff</a> |
<a href="/comm-central/comparison/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/common/bookmarks/bookmarksTree.xml">comparison</a> |
<a href="/comm-central/log/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/common/bookmarks/bookmarksTree.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/common/bookmarks/findBookmark.js">suite/common/bookmarks/findBookmark.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/common/bookmarks/findBookmark.js">diff</a> |
<a href="/comm-central/comparison/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/common/bookmarks/findBookmark.js">comparison</a> |
<a href="/comm-central/log/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/common/bookmarks/findBookmark.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/common/bookmarks/findBookmark.xul">suite/common/bookmarks/findBookmark.xul</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/common/bookmarks/findBookmark.xul">diff</a> |
<a href="/comm-central/comparison/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/common/bookmarks/findBookmark.xul">comparison</a> |
<a href="/comm-central/log/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/common/bookmarks/findBookmark.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/common/bookmarks/sortFolder.js">suite/common/bookmarks/sortFolder.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/common/bookmarks/sortFolder.js">diff</a> |
<a href="/comm-central/comparison/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/common/bookmarks/sortFolder.js">comparison</a> |
<a href="/comm-central/log/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/common/bookmarks/sortFolder.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/common/bookmarks/sortFolder.xul">suite/common/bookmarks/sortFolder.xul</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/common/bookmarks/sortFolder.xul">diff</a> |
<a href="/comm-central/comparison/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/common/bookmarks/sortFolder.xul">comparison</a> |
<a href="/comm-central/log/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/common/bookmarks/sortFolder.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/locales/en-US/chrome/common/bookmarks/addBookmark.dtd">suite/locales/en-US/chrome/common/bookmarks/addBookmark.dtd</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/locales/en-US/chrome/common/bookmarks/addBookmark.dtd">diff</a> |
<a href="/comm-central/comparison/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/locales/en-US/chrome/common/bookmarks/addBookmark.dtd">comparison</a> |
<a href="/comm-central/log/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/locales/en-US/chrome/common/bookmarks/addBookmark.dtd">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/locales/en-US/chrome/common/bookmarks/bm-props.dtd">suite/locales/en-US/chrome/common/bookmarks/bm-props.dtd</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/locales/en-US/chrome/common/bookmarks/bm-props.dtd">diff</a> |
<a href="/comm-central/comparison/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/locales/en-US/chrome/common/bookmarks/bm-props.dtd">comparison</a> |
<a href="/comm-central/log/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/locales/en-US/chrome/common/bookmarks/bm-props.dtd">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/locales/en-US/chrome/common/bookmarks/bookmarks.dtd">suite/locales/en-US/chrome/common/bookmarks/bookmarks.dtd</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/locales/en-US/chrome/common/bookmarks/bookmarks.dtd">diff</a> |
<a href="/comm-central/comparison/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/locales/en-US/chrome/common/bookmarks/bookmarks.dtd">comparison</a> |
<a href="/comm-central/log/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/locales/en-US/chrome/common/bookmarks/bookmarks.dtd">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/locales/en-US/chrome/common/bookmarks/bookmarks.properties">suite/locales/en-US/chrome/common/bookmarks/bookmarks.properties</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/locales/en-US/chrome/common/bookmarks/bookmarks.properties">diff</a> |
<a href="/comm-central/comparison/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/locales/en-US/chrome/common/bookmarks/bookmarks.properties">comparison</a> |
<a href="/comm-central/log/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/locales/en-US/chrome/common/bookmarks/bookmarks.properties">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/locales/en-US/chrome/common/bookmarks/findBookmark.dtd">suite/locales/en-US/chrome/common/bookmarks/findBookmark.dtd</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/locales/en-US/chrome/common/bookmarks/findBookmark.dtd">diff</a> |
<a href="/comm-central/comparison/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/locales/en-US/chrome/common/bookmarks/findBookmark.dtd">comparison</a> |
<a href="/comm-central/log/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/locales/en-US/chrome/common/bookmarks/findBookmark.dtd">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/locales/en-US/chrome/common/bookmarks/sortFolder.dtd">suite/locales/en-US/chrome/common/bookmarks/sortFolder.dtd</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/locales/en-US/chrome/common/bookmarks/sortFolder.dtd">diff</a> |
<a href="/comm-central/comparison/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/locales/en-US/chrome/common/bookmarks/sortFolder.dtd">comparison</a> |
<a href="/comm-central/log/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/locales/en-US/chrome/common/bookmarks/sortFolder.dtd">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/profile/migration/src/nsSuiteProfileMigratorUtils.cpp">suite/profile/migration/src/nsSuiteProfileMigratorUtils.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/profile/migration/src/nsSuiteProfileMigratorUtils.cpp">file</a> |
<a href="/comm-central/annotate/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/profile/migration/src/nsSuiteProfileMigratorUtils.cpp">annotate</a> |
<a href="/comm-central/diff/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/profile/migration/src/nsSuiteProfileMigratorUtils.cpp">diff</a> |
<a href="/comm-central/comparison/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/profile/migration/src/nsSuiteProfileMigratorUtils.cpp">comparison</a> |
<a href="/comm-central/log/b7d14a8dd2d0b25bf30b7bbf09319d796376f147/suite/profile/migration/src/nsSuiteProfileMigratorUtils.cpp">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1">deleted file mode 100644</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineminus">--- a/suite/browser/public/nsIBookmarksService.idl</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineplus">+++ /dev/null</span>
<a href="#l1.4"></a><span id="l1.4" class="difflineat">@@ -1,129 +0,0 @@</span>
<a href="#l1.5"></a><span id="l1.5" class="difflineminus">-/* -*- Mode: IDL; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l1.6"></a><span id="l1.6" class="difflineminus">-/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l1.7"></a><span id="l1.7" class="difflineminus">- * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l1.8"></a><span id="l1.8" class="difflineminus">- *</span>
<a href="#l1.9"></a><span id="l1.9" class="difflineminus">- * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l1.10"></a><span id="l1.10" class="difflineminus">- * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l1.11"></a><span id="l1.11" class="difflineminus">- * the License. You may obtain a copy of the License at</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">- * http://www.mozilla.org/MPL/</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">- *</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">- * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineminus">- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineminus">- * for the specific language governing rights and limitations under the</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineminus">- * License.</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineminus">- *</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineminus">- * The Original Code is mozilla.org code.</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineminus">- *</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineminus">- * The Initial Developer of the Original Code is</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineminus">- * Netscape Communications Corporation.</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineminus">- * Portions created by the Initial Developer are Copyright (C) 1998</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineminus">- * the Initial Developer. All Rights Reserved.</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineminus">- *</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineminus">- * Contributor(s):</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineminus">- *   Ben Goodger              &lt;ben@netscape.com&gt;</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineminus">- *   Jan Varga                &lt;varga@ku.sk&gt;</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineminus">- *</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineminus">- * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">- * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineminus">- * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineminus">- * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineminus">- * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineminus">- * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineminus">- * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineminus">- * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineminus">- * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineminus">- * the provisions above, a recipient may use your version of this file under</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineminus">- * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineminus">- *</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineminus">- * ***** END LICENSE BLOCK ***** */</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineminus">-</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineminus">-/**</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineminus">- * The Browser Bookmarks service</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineminus">- */</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineminus">-</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineminus">-#include &quot;nsISupports.idl&quot;</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineminus">-</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineminus">-interface nsIRDFNode;</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineminus">-interface nsIRDFResource;</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineminus">-interface nsITransaction;</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineminus">-interface nsITransactionManager;</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineminus">-</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineminus">-[scriptable, uuid(b3b8d09d-71b1-4654-b807-9288c2f16300)]</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineminus">-interface nsIBookmarksService : nsISupports</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineminus">-{</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineminus">-    const unsigned long BOOKMARK_DEFAULT_TYPE   = 0;</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineminus">-    const unsigned long BOOKMARK_SEARCH_TYPE    = 1;</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineminus">-    const unsigned long BOOKMARK_FIND_TYPE      = 2;</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineminus">-</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineminus">-    const long SORT_DESCENDING = -1;</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineminus">-    const long SORT_ASCENDING = 1;</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineminus">-</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineminus">-    boolean readBookmarks();</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineminus">-    boolean isBookmarked(in string aURL);</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineminus">-    boolean isBookmarkedResource(in nsIRDFResource aSource);</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineminus">-</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineminus">-    void addBookmarkImmediately(in wstring aURI, in wstring aTitle, in long bmType, in wstring docCharset);</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineminus">-        </span>
<a href="#l1.71"></a><span id="l1.71" class="difflineminus">-    nsIRDFResource createFolder(in wstring aName);</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineminus">-    nsIRDFResource createFolderInContainer(in wstring aName, in nsIRDFResource aParentFolder, </span>
<a href="#l1.73"></a><span id="l1.73" class="difflineminus">-                                           in long aIndex);</span>
<a href="#l1.74"></a><span id="l1.74" class="difflineminus">-</span>
<a href="#l1.75"></a><span id="l1.75" class="difflineminus">-    nsIRDFResource createGroup(in wstring aName);</span>
<a href="#l1.76"></a><span id="l1.76" class="difflineminus">-    nsIRDFResource createGroupInContainer(in wstring aName, in nsIRDFResource aParentFolder, </span>
<a href="#l1.77"></a><span id="l1.77" class="difflineminus">-                                          in long aIndex);</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineminus">-</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineminus">-    void sortFolder(in nsIRDFResource aFolder,</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineminus">-                    in nsIRDFResource aProperty,</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineminus">-                    in long aDirection,</span>
<a href="#l1.82"></a><span id="l1.82" class="difflineminus">-                    in boolean aFoldersFirst,</span>
<a href="#l1.83"></a><span id="l1.83" class="difflineminus">-                    in boolean aRecurse);</span>
<a href="#l1.84"></a><span id="l1.84" class="difflineminus">-</span>
<a href="#l1.85"></a><span id="l1.85" class="difflineminus">-    nsIRDFResource createBookmark(in wstring aName,</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineminus">-                                  in wstring aURL,</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineminus">-                                  in wstring aShortcutURL,</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineminus">-                                  in wstring aDescription,</span>
<a href="#l1.89"></a><span id="l1.89" class="difflineminus">-                                  in wstring aDocCharSet);</span>
<a href="#l1.90"></a><span id="l1.90" class="difflineminus">-    nsIRDFResource createBookmarkInContainer(in wstring aName,</span>
<a href="#l1.91"></a><span id="l1.91" class="difflineminus">-                                             in wstring aURL,</span>
<a href="#l1.92"></a><span id="l1.92" class="difflineminus">-                                             in wstring aShortcutURL,</span>
<a href="#l1.93"></a><span id="l1.93" class="difflineminus">-                                             in wstring aDescription,</span>
<a href="#l1.94"></a><span id="l1.94" class="difflineminus">-                                             in wstring aDocCharSet, </span>
<a href="#l1.95"></a><span id="l1.95" class="difflineminus">-                                             in nsIRDFResource aFolder,</span>
<a href="#l1.96"></a><span id="l1.96" class="difflineminus">-                                             in long aIndex);</span>
<a href="#l1.97"></a><span id="l1.97" class="difflineminus">-</span>
<a href="#l1.98"></a><span id="l1.98" class="difflineminus">-    nsIRDFResource createSeparator();</span>
<a href="#l1.99"></a><span id="l1.99" class="difflineminus">-</span>
<a href="#l1.100"></a><span id="l1.100" class="difflineminus">-    nsIRDFResource cloneResource(in nsIRDFResource aSource);</span>
<a href="#l1.101"></a><span id="l1.101" class="difflineminus">-</span>
<a href="#l1.102"></a><span id="l1.102" class="difflineminus">-    void updateBookmarkIcon(in string aURL, in wstring aIconURL);</span>
<a href="#l1.103"></a><span id="l1.103" class="difflineminus">-    void removeBookmarkIcon(in string aURL, in wstring aIconURL);</span>
<a href="#l1.104"></a><span id="l1.104" class="difflineminus">-</span>
<a href="#l1.105"></a><span id="l1.105" class="difflineminus">-    void updateLastVisitedDate(in string aURL, in wstring docCharset);</span>
<a href="#l1.106"></a><span id="l1.106" class="difflineminus">-    </span>
<a href="#l1.107"></a><span id="l1.107" class="difflineminus">-    AString getLastCharset(in AUTF8String aURL); </span>
<a href="#l1.108"></a><span id="l1.108" class="difflineminus">-</span>
<a href="#l1.109"></a><span id="l1.109" class="difflineminus">-    string resolveKeyword(in wstring aName);</span>
<a href="#l1.110"></a><span id="l1.110" class="difflineminus">-    </span>
<a href="#l1.111"></a><span id="l1.111" class="difflineminus">-    void importSystemBookmarks(in nsIRDFResource aParentFolder);</span>
<a href="#l1.112"></a><span id="l1.112" class="difflineminus">-</span>
<a href="#l1.113"></a><span id="l1.113" class="difflineminus">-    readonly attribute nsITransactionManager transactionManager;</span>
<a href="#l1.114"></a><span id="l1.114" class="difflineminus">-</span>
<a href="#l1.115"></a><span id="l1.115" class="difflineminus">-    nsITransaction createTransaction(in nsIRDFResource parent,</span>
<a href="#l1.116"></a><span id="l1.116" class="difflineminus">-                                     in nsIRDFNode item,</span>
<a href="#l1.117"></a><span id="l1.117" class="difflineminus">-                                     in unsigned long index,</span>
<a href="#l1.118"></a><span id="l1.118" class="difflineminus">-                                     in boolean remove);</span>
<a href="#l1.119"></a><span id="l1.119" class="difflineminus">-};</span>
<a href="#l1.120"></a><span id="l1.120" class="difflineminus">-</span>
<a href="#l1.121"></a><span id="l1.121" class="difflineminus">-%{C++</span>
<a href="#l1.122"></a><span id="l1.122" class="difflineminus">-</span>
<a href="#l1.123"></a><span id="l1.123" class="difflineminus">-// {E638D760-8687-11d2-B530-000000000000}</span>
<a href="#l1.124"></a><span id="l1.124" class="difflineminus">-#define NS_BOOKMARKS_SERVICE_CID \</span>
<a href="#l1.125"></a><span id="l1.125" class="difflineminus">-{ 0xe638d760, 0x8687, 0x11d2, { 0xb5, 0x30, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0 } }</span>
<a href="#l1.126"></a><span id="l1.126" class="difflineminus">-</span>
<a href="#l1.127"></a><span id="l1.127" class="difflineminus">-#define NS_BOOKMARKS_SERVICE_CONTRACTID \</span>
<a href="#l1.128"></a><span id="l1.128" class="difflineminus">-    &quot;@mozilla.org/browser/bookmarks-service;1&quot;</span>
<a href="#l1.129"></a><span id="l1.129" class="difflineminus">-</span>
<a href="#l1.130"></a><span id="l1.130" class="difflineminus">-#define NS_BOOKMARKS_DATASOURCE_CONTRACTID \</span>
<a href="#l1.131"></a><span id="l1.131" class="difflineminus">-    &quot;@mozilla.org/rdf/datasource;1?name=bookmarks&quot;</span>
<a href="#l1.132"></a><span id="l1.132" class="difflineminus">-</span>
<a href="#l1.133"></a><span id="l1.133" class="difflineminus">-%}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1">deleted file mode 100644</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineminus">--- a/suite/browser/src/nsBookmarksService.cpp</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineplus">+++ /dev/null</span>
<a href="#l2.4"></a><span id="l2.4" class="difflineat">@@ -1,6071 +0,0 @@</span>
<a href="#l2.5"></a><span id="l2.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l2.6"></a><span id="l2.6" class="difflineminus">-/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l2.7"></a><span id="l2.7" class="difflineminus">- * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l2.8"></a><span id="l2.8" class="difflineminus">- *</span>
<a href="#l2.9"></a><span id="l2.9" class="difflineminus">- * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l2.10"></a><span id="l2.10" class="difflineminus">- * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l2.11"></a><span id="l2.11" class="difflineminus">- * the License. You may obtain a copy of the License at</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">- * http://www.mozilla.org/MPL/</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">- *</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">- * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineminus">- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineminus">- * for the specific language governing rights and limitations under the</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineminus">- * License.</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineminus">- *</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineminus">- * The Original Code is mozilla.org code.</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineminus">- *</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineminus">- * The Initial Developer of the Original Code is</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineminus">- * Netscape Communications Corporation.</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineminus">- * Portions created by the Initial Developer are Copyright (C) 1998</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineminus">- * the Initial Developer. All Rights Reserved.</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineminus">- *</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineminus">- * Contributor(s):</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineminus">- *   Robert John Churchill    &lt;rjc@netscape.com&gt;</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineminus">- *   Chris Waterson           &lt;waterson@netscape.com&gt;</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineminus">- *   David Hyatt              &lt;hyatt@netscape.com&gt;</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineminus">- *   Ben Goodger              &lt;ben@netscape.com&gt;</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">- *   Andreas Otte             &lt;andreas.otte@debitel.net&gt;</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">- *   Jan Varga                &lt;varga@ku.sk&gt;</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineminus">- *   Benjamin Smedberg        &lt;bsmedberg@covad.net&gt;</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineminus">- *</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineminus">- * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineminus">- * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineminus">- * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineminus">- * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineminus">- * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineminus">- * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineminus">- * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineminus">- * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineminus">- * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineminus">- * the provisions above, a recipient may use your version of this file under</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineminus">- * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineminus">- *</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineminus">- * ***** END LICENSE BLOCK ***** */</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineminus">-</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineminus">-/*</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineminus">-  The global bookmarks service.</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineminus">- */</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineminus">-</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineminus">-#include &quot;nsBookmarksService.h&quot;</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineminus">-#include &quot;nsIDOMWindow.h&quot;</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineminus">-#include &quot;nsIObserverService.h&quot;</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineminus">-#include &quot;nsIProfile.h&quot;</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineminus">-#include &quot;nsIRDFContainer.h&quot;</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineminus">-#include &quot;nsIRDFContainerUtils.h&quot;</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineminus">-#include &quot;nsIRDFService.h&quot;</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineminus">-#include &quot;nsIRDFXMLSerializer.h&quot;</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineminus">-#include &quot;nsIRDFXMLSource.h&quot;</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineminus">-#include &quot;nsRDFCID.h&quot;</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineminus">-#include &quot;nsISupportsPrimitives.h&quot;</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineminus">-#include &quot;rdf.h&quot;</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineminus">-#include &quot;nsCRTGlue.h&quot;</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineminus">-#include &quot;nsEnumeratorUtils.h&quot;</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineminus">-#include &quot;nsAppDirectoryServiceDefs.h&quot;</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineminus">-#include &quot;nsDirectoryServiceDefs.h&quot;</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineminus">-#include &quot;nsDirectoryServiceUtils.h&quot;</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineminus">-#include &quot;nsUnicharUtils.h&quot;</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineminus">-</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineminus">-#include &quot;nsISound.h&quot;</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineminus">-#include &quot;nsIPrompt.h&quot;</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineminus">-#include &quot;nsIWindowWatcher.h&quot;</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineminus">-#include &quot;nsWidgetsCID.h&quot;</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineminus">-</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineminus">-#include &quot;nsIURL.h&quot;</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineminus">-#include &quot;nsIFileURL.h&quot;</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineminus">-#include &quot;nsIFile.h&quot;</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineminus">-#include &quot;nsIInputStream.h&quot;</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineminus">-#include &quot;nsILineInputStream.h&quot;</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineminus">-#include &quot;nsIOutputStream.h&quot;</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineminus">-#include &quot;nsNetUtil.h&quot;</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineminus">-#include &quot;nsICacheEntryDescriptor.h&quot;</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineminus">-</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineminus">-#include &quot;nsICharsetConverterManager.h&quot;</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineminus">-#include &quot;nsICharsetAlias.h&quot;</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineminus">-#include &quot;nsIPlatformCharset.h&quot;</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineminus">-#include &quot;nsIPrefService.h&quot;</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineminus">-#include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineminus">-#include &quot;nsIPrefBranch2.h&quot;</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineminus">-</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineminus">-#include &quot;nsIWebNavigation.h&quot;</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineminus">-</span>
<a href="#l2.95"></a><span id="l2.95" class="difflineminus">-// for sorting</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineminus">-#include &quot;nsCollationCID.h&quot;</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineminus">-#include &quot;nsILocaleService.h&quot;</span>
<a href="#l2.98"></a><span id="l2.98" class="difflineminus">-#include &quot;nsICollation.h&quot;</span>
<a href="#l2.99"></a><span id="l2.99" class="difflineminus">-#include &quot;nsVoidArray.h&quot;</span>
<a href="#l2.100"></a><span id="l2.100" class="difflineminus">-#include &quot;nsUnicharUtils.h&quot;</span>
<a href="#l2.101"></a><span id="l2.101" class="difflineminus">-#include &quot;nsTArray.h&quot;</span>
<a href="#l2.102"></a><span id="l2.102" class="difflineminus">-#include &quot;nsINetUtil.h&quot;</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineminus">-</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineminus">-#if defined(XP_WIN) || defined(XP_OS2)</span>
<a href="#l2.105"></a><span id="l2.105" class="difflineminus">-#define NS_LINEBREAK &quot;\015\012&quot;</span>
<a href="#l2.106"></a><span id="l2.106" class="difflineminus">-#else</span>
<a href="#l2.107"></a><span id="l2.107" class="difflineminus">-#define NS_LINEBREAK &quot;\012&quot;</span>
<a href="#l2.108"></a><span id="l2.108" class="difflineminus">-#endif</span>
<a href="#l2.109"></a><span id="l2.109" class="difflineminus">-</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineminus">-#ifdef XP_WIN</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineminus">-#include &lt;shlobj.h&gt;</span>
<a href="#l2.112"></a><span id="l2.112" class="difflineminus">-#include &lt;intshcut.h&gt;</span>
<a href="#l2.113"></a><span id="l2.113" class="difflineminus">-#ifdef CompareString</span>
<a href="#l2.114"></a><span id="l2.114" class="difflineminus">-#undef CompareString</span>
<a href="#l2.115"></a><span id="l2.115" class="difflineminus">-#endif</span>
<a href="#l2.116"></a><span id="l2.116" class="difflineminus">-#endif</span>
<a href="#l2.117"></a><span id="l2.117" class="difflineminus">-</span>
<a href="#l2.118"></a><span id="l2.118" class="difflineminus">-nsIRDFResource      *kNC_IEFavoritesRoot;</span>
<a href="#l2.119"></a><span id="l2.119" class="difflineminus">-nsIRDFResource      *kNC_SystemBookmarksStaticRoot;</span>
<a href="#l2.120"></a><span id="l2.120" class="difflineminus">-nsIRDFResource      *kNC_Bookmark;</span>
<a href="#l2.121"></a><span id="l2.121" class="difflineminus">-nsIRDFResource      *kNC_BookmarkSeparator;</span>
<a href="#l2.122"></a><span id="l2.122" class="difflineminus">-nsIRDFResource      *kNC_BookmarkAddDate;</span>
<a href="#l2.123"></a><span id="l2.123" class="difflineminus">-nsIRDFResource      *kNC_BookmarksTopRoot;</span>
<a href="#l2.124"></a><span id="l2.124" class="difflineminus">-nsIRDFResource      *kNC_BookmarksRoot;</span>
<a href="#l2.125"></a><span id="l2.125" class="difflineminus">-nsIRDFResource      *kNC_Description;</span>
<a href="#l2.126"></a><span id="l2.126" class="difflineminus">-nsIRDFResource      *kNC_Folder;</span>
<a href="#l2.127"></a><span id="l2.127" class="difflineminus">-nsIRDFResource      *kNC_FolderType;</span>
<a href="#l2.128"></a><span id="l2.128" class="difflineminus">-nsIRDFResource      *kNC_FolderGroup;</span>
<a href="#l2.129"></a><span id="l2.129" class="difflineminus">-nsIRDFResource      *kNC_IEFavorite;</span>
<a href="#l2.130"></a><span id="l2.130" class="difflineminus">-nsIRDFResource      *kNC_IEFavoriteFolder;</span>
<a href="#l2.131"></a><span id="l2.131" class="difflineminus">-nsIRDFResource      *kNC_Name;</span>
<a href="#l2.132"></a><span id="l2.132" class="difflineminus">-nsIRDFResource      *kNC_Icon;</span>
<a href="#l2.133"></a><span id="l2.133" class="difflineminus">-nsIRDFResource      *kNC_NewBookmarkFolder;</span>
<a href="#l2.134"></a><span id="l2.134" class="difflineminus">-nsIRDFResource      *kNC_NewSearchFolder;</span>
<a href="#l2.135"></a><span id="l2.135" class="difflineminus">-nsIRDFResource      *kNC_PersonalToolbarFolder;</span>
<a href="#l2.136"></a><span id="l2.136" class="difflineminus">-nsIRDFResource      *kNC_ShortcutURL;</span>
<a href="#l2.137"></a><span id="l2.137" class="difflineminus">-nsIRDFResource      *kNC_URL;</span>
<a href="#l2.138"></a><span id="l2.138" class="difflineminus">-nsIRDFResource      *kRDF_type;</span>
<a href="#l2.139"></a><span id="l2.139" class="difflineminus">-nsIRDFResource      *kRDF_nextVal;</span>
<a href="#l2.140"></a><span id="l2.140" class="difflineminus">-nsIRDFResource      *kWEB_LastModifiedDate;</span>
<a href="#l2.141"></a><span id="l2.141" class="difflineminus">-nsIRDFResource      *kWEB_LastVisitDate;</span>
<a href="#l2.142"></a><span id="l2.142" class="difflineminus">-nsIRDFResource      *kWEB_Schedule;</span>
<a href="#l2.143"></a><span id="l2.143" class="difflineminus">-nsIRDFResource      *kWEB_ScheduleActive;</span>
<a href="#l2.144"></a><span id="l2.144" class="difflineminus">-nsIRDFResource      *kWEB_Status;</span>
<a href="#l2.145"></a><span id="l2.145" class="difflineminus">-nsIRDFResource      *kWEB_LastPingDate;</span>
<a href="#l2.146"></a><span id="l2.146" class="difflineminus">-nsIRDFResource      *kWEB_LastPingETag;</span>
<a href="#l2.147"></a><span id="l2.147" class="difflineminus">-nsIRDFResource      *kWEB_LastPingModDate;</span>
<a href="#l2.148"></a><span id="l2.148" class="difflineminus">-nsIRDFResource      *kWEB_LastCharset;</span>
<a href="#l2.149"></a><span id="l2.149" class="difflineminus">-nsIRDFResource      *kWEB_LastPingContentLen;</span>
<a href="#l2.150"></a><span id="l2.150" class="difflineminus">-nsIRDFLiteral       *kTrueLiteral;</span>
<a href="#l2.151"></a><span id="l2.151" class="difflineminus">-nsIRDFLiteral       *kEmptyLiteral;</span>
<a href="#l2.152"></a><span id="l2.152" class="difflineminus">-nsIRDFDate          *kEmptyDate;</span>
<a href="#l2.153"></a><span id="l2.153" class="difflineminus">-nsIRDFResource      *kNC_Parent;</span>
<a href="#l2.154"></a><span id="l2.154" class="difflineminus">-nsIRDFResource      *kNC_BookmarkCommand_NewBookmark;</span>
<a href="#l2.155"></a><span id="l2.155" class="difflineminus">-nsIRDFResource      *kNC_BookmarkCommand_NewFolder;</span>
<a href="#l2.156"></a><span id="l2.156" class="difflineminus">-nsIRDFResource      *kNC_BookmarkCommand_NewSeparator;</span>
<a href="#l2.157"></a><span id="l2.157" class="difflineminus">-nsIRDFResource      *kNC_BookmarkCommand_DeleteBookmark;</span>
<a href="#l2.158"></a><span id="l2.158" class="difflineminus">-nsIRDFResource      *kNC_BookmarkCommand_DeleteBookmarkFolder;</span>
<a href="#l2.159"></a><span id="l2.159" class="difflineminus">-nsIRDFResource      *kNC_BookmarkCommand_DeleteBookmarkSeparator;</span>
<a href="#l2.160"></a><span id="l2.160" class="difflineminus">-nsIRDFResource      *kNC_BookmarkCommand_SetNewBookmarkFolder = nsnull;</span>
<a href="#l2.161"></a><span id="l2.161" class="difflineminus">-nsIRDFResource      *kNC_BookmarkCommand_SetPersonalToolbarFolder;</span>
<a href="#l2.162"></a><span id="l2.162" class="difflineminus">-nsIRDFResource      *kNC_BookmarkCommand_SetNewSearchFolder;</span>
<a href="#l2.163"></a><span id="l2.163" class="difflineminus">-nsIRDFResource      *kNC_BookmarkCommand_Import;</span>
<a href="#l2.164"></a><span id="l2.164" class="difflineminus">-nsIRDFResource      *kNC_BookmarkCommand_Export;</span>
<a href="#l2.165"></a><span id="l2.165" class="difflineminus">-</span>
<a href="#l2.166"></a><span id="l2.166" class="difflineminus">-#define BOOKMARK_TIMEOUT        15000       // fire every 15 seconds</span>
<a href="#l2.167"></a><span id="l2.167" class="difflineminus">-// #define  DEBUG_BOOKMARK_PING_OUTPUT  1</span>
<a href="#l2.168"></a><span id="l2.168" class="difflineminus">-</span>
<a href="#l2.169"></a><span id="l2.169" class="difflineminus">-////////////////////////////////////////////////////////////////////////</span>
<a href="#l2.170"></a><span id="l2.170" class="difflineminus">-</span>
<a href="#l2.171"></a><span id="l2.171" class="difflineminus">-static NS_DEFINE_CID(kRDFInMemoryDataSourceCID,   NS_RDFINMEMORYDATASOURCE_CID);</span>
<a href="#l2.172"></a><span id="l2.172" class="difflineminus">-static NS_DEFINE_CID(kRDFServiceCID,              NS_RDFSERVICE_CID);</span>
<a href="#l2.173"></a><span id="l2.173" class="difflineminus">-static NS_DEFINE_CID(kRDFContainerCID,            NS_RDFCONTAINER_CID);</span>
<a href="#l2.174"></a><span id="l2.174" class="difflineminus">-static NS_DEFINE_CID(kRDFContainerUtilsCID,       NS_RDFCONTAINERUTILS_CID);</span>
<a href="#l2.175"></a><span id="l2.175" class="difflineminus">-</span>
<a href="#l2.176"></a><span id="l2.176" class="difflineminus">-#define URINC_BOOKMARKS_TOPROOT_STRING            &quot;NC:BookmarksTopRoot&quot;</span>
<a href="#l2.177"></a><span id="l2.177" class="difflineminus">-#define URINC_BOOKMARKS_ROOT_STRING               &quot;NC:BookmarksRoot&quot;</span>
<a href="#l2.178"></a><span id="l2.178" class="difflineminus">-</span>
<a href="#l2.179"></a><span id="l2.179" class="difflineminus">-static const char kURINC_BookmarksTopRoot[]           = URINC_BOOKMARKS_TOPROOT_STRING; </span>
<a href="#l2.180"></a><span id="l2.180" class="difflineminus">-static const char kURINC_BookmarksRoot[]              = URINC_BOOKMARKS_ROOT_STRING; </span>
<a href="#l2.181"></a><span id="l2.181" class="difflineminus">-static const char kURINC_IEFavoritesRoot[]            = &quot;NC:IEFavoritesRoot&quot;; </span>
<a href="#l2.182"></a><span id="l2.182" class="difflineminus">-static const char kURINC_SystemBookmarksStaticRoot[]  = &quot;NC:SystemBookmarksStaticRoot&quot;; </span>
<a href="#l2.183"></a><span id="l2.183" class="difflineminus">-static const char kURINC_NewBookmarkFolder[]          = &quot;NC:NewBookmarkFolder&quot;; </span>
<a href="#l2.184"></a><span id="l2.184" class="difflineminus">-static const char kURINC_PersonalToolbarFolder[]      = &quot;NC:PersonalToolbarFolder&quot;; </span>
<a href="#l2.185"></a><span id="l2.185" class="difflineminus">-static const char kURINC_NewSearchFolder[]            = &quot;NC:NewSearchFolder&quot;; </span>
<a href="#l2.186"></a><span id="l2.186" class="difflineminus">-static const char kBookmarkCommand[]                  = &quot;http://home.netscape.com/NC-rdf#command?&quot;;</span>
<a href="#l2.187"></a><span id="l2.187" class="difflineminus">-</span>
<a href="#l2.188"></a><span id="l2.188" class="difflineminus">-#define bookmark_properties NS_LITERAL_CSTRING(&quot;chrome://communicator/locale/bookmarks/bookmarks.properties&quot;)</span>
<a href="#l2.189"></a><span id="l2.189" class="difflineminus">-</span>
<a href="#l2.190"></a><span id="l2.190" class="difflineminus">-////////////////////////////////////////////////////////////////////////</span>
<a href="#l2.191"></a><span id="l2.191" class="difflineminus">-</span>
<a href="#l2.192"></a><span id="l2.192" class="difflineminus">-PRInt32               gRefCnt=0;</span>
<a href="#l2.193"></a><span id="l2.193" class="difflineminus">-nsIRDFService        *gRDF;</span>
<a href="#l2.194"></a><span id="l2.194" class="difflineminus">-nsIRDFContainerUtils *gRDFC;</span>
<a href="#l2.195"></a><span id="l2.195" class="difflineminus">-nsICharsetAlias      *gCharsetAlias;</span>
<a href="#l2.196"></a><span id="l2.196" class="difflineminus">-nsICollation         *gCollation;</span>
<a href="#l2.197"></a><span id="l2.197" class="difflineminus">-PRBool                gImportedSystemBookmarks = PR_FALSE;</span>
<a href="#l2.198"></a><span id="l2.198" class="difflineminus">-</span>
<a href="#l2.199"></a><span id="l2.199" class="difflineminus">-static nsresult</span>
<a href="#l2.200"></a><span id="l2.200" class="difflineminus">-bm_AddRefGlobals()</span>
<a href="#l2.201"></a><span id="l2.201" class="difflineminus">-{</span>
<a href="#l2.202"></a><span id="l2.202" class="difflineminus">-    if (gRefCnt++ == 0)</span>
<a href="#l2.203"></a><span id="l2.203" class="difflineminus">-    {</span>
<a href="#l2.204"></a><span id="l2.204" class="difflineminus">-        nsresult rv;</span>
<a href="#l2.205"></a><span id="l2.205" class="difflineminus">-        rv = CallGetService(kRDFServiceCID, &amp;gRDF);</span>
<a href="#l2.206"></a><span id="l2.206" class="difflineminus">-        if (NS_FAILED(rv)) {</span>
<a href="#l2.207"></a><span id="l2.207" class="difflineminus">-            NS_ERROR(&quot;unable to get RDF service&quot;);</span>
<a href="#l2.208"></a><span id="l2.208" class="difflineminus">-            return rv;</span>
<a href="#l2.209"></a><span id="l2.209" class="difflineminus">-        }</span>
<a href="#l2.210"></a><span id="l2.210" class="difflineminus">-</span>
<a href="#l2.211"></a><span id="l2.211" class="difflineminus">-        rv = CallGetService(kRDFContainerUtilsCID, &amp;gRDFC);</span>
<a href="#l2.212"></a><span id="l2.212" class="difflineminus">-        if (NS_FAILED(rv)) {</span>
<a href="#l2.213"></a><span id="l2.213" class="difflineminus">-            NS_ERROR(&quot;unable to get RDF container utils&quot;);</span>
<a href="#l2.214"></a><span id="l2.214" class="difflineminus">-            return rv;</span>
<a href="#l2.215"></a><span id="l2.215" class="difflineminus">-        }</span>
<a href="#l2.216"></a><span id="l2.216" class="difflineminus">-</span>
<a href="#l2.217"></a><span id="l2.217" class="difflineminus">-        rv = CallGetService(NS_CHARSETALIAS_CONTRACTID, &amp;gCharsetAlias);</span>
<a href="#l2.218"></a><span id="l2.218" class="difflineminus">-        if (NS_FAILED(rv)) {</span>
<a href="#l2.219"></a><span id="l2.219" class="difflineminus">-            NS_ERROR(&quot;unable to get charset alias service&quot;);</span>
<a href="#l2.220"></a><span id="l2.220" class="difflineminus">-            return rv;</span>
<a href="#l2.221"></a><span id="l2.221" class="difflineminus">-        }</span>
<a href="#l2.222"></a><span id="l2.222" class="difflineminus">-</span>
<a href="#l2.223"></a><span id="l2.223" class="difflineminus">-        nsCOMPtr&lt;nsILocaleService&gt; ls = do_GetService(NS_LOCALESERVICE_CONTRACTID);</span>
<a href="#l2.224"></a><span id="l2.224" class="difflineminus">-        if (ls) {</span>
<a href="#l2.225"></a><span id="l2.225" class="difflineminus">-            nsCOMPtr&lt;nsILocale&gt; locale;</span>
<a href="#l2.226"></a><span id="l2.226" class="difflineminus">-            ls-&gt;GetApplicationLocale(getter_AddRefs(locale));</span>
<a href="#l2.227"></a><span id="l2.227" class="difflineminus">-            if (locale) {</span>
<a href="#l2.228"></a><span id="l2.228" class="difflineminus">-                nsCOMPtr&lt;nsICollationFactory&gt; factory = do_CreateInstance(NS_COLLATIONFACTORY_CONTRACTID);</span>
<a href="#l2.229"></a><span id="l2.229" class="difflineminus">-                if (factory) {</span>
<a href="#l2.230"></a><span id="l2.230" class="difflineminus">-                    factory-&gt;CreateCollation(locale, &amp;gCollation);</span>
<a href="#l2.231"></a><span id="l2.231" class="difflineminus">-                }</span>
<a href="#l2.232"></a><span id="l2.232" class="difflineminus">-            }</span>
<a href="#l2.233"></a><span id="l2.233" class="difflineminus">-        }</span>
<a href="#l2.234"></a><span id="l2.234" class="difflineminus">-</span>
<a href="#l2.235"></a><span id="l2.235" class="difflineminus">-        gRDF-&gt;GetResource(NS_LITERAL_CSTRING(kURINC_BookmarksTopRoot),</span>
<a href="#l2.236"></a><span id="l2.236" class="difflineminus">-                          &amp;kNC_BookmarksTopRoot);</span>
<a href="#l2.237"></a><span id="l2.237" class="difflineminus">-        gRDF-&gt;GetResource(NS_LITERAL_CSTRING(kURINC_BookmarksRoot),</span>
<a href="#l2.238"></a><span id="l2.238" class="difflineminus">-                          &amp;kNC_BookmarksRoot);</span>
<a href="#l2.239"></a><span id="l2.239" class="difflineminus">-        gRDF-&gt;GetResource(NS_LITERAL_CSTRING(kURINC_IEFavoritesRoot),</span>
<a href="#l2.240"></a><span id="l2.240" class="difflineminus">-                          &amp;kNC_IEFavoritesRoot);</span>
<a href="#l2.241"></a><span id="l2.241" class="difflineminus">-        gRDF-&gt;GetResource(NS_LITERAL_CSTRING(kURINC_SystemBookmarksStaticRoot),</span>
<a href="#l2.242"></a><span id="l2.242" class="difflineminus">-                          &amp;kNC_SystemBookmarksStaticRoot);</span>
<a href="#l2.243"></a><span id="l2.243" class="difflineminus">-        gRDF-&gt;GetResource(NS_LITERAL_CSTRING(kURINC_NewBookmarkFolder),</span>
<a href="#l2.244"></a><span id="l2.244" class="difflineminus">-                          &amp;kNC_NewBookmarkFolder);</span>
<a href="#l2.245"></a><span id="l2.245" class="difflineminus">-        gRDF-&gt;GetResource(NS_LITERAL_CSTRING(kURINC_PersonalToolbarFolder),</span>
<a href="#l2.246"></a><span id="l2.246" class="difflineminus">-                          &amp;kNC_PersonalToolbarFolder);</span>
<a href="#l2.247"></a><span id="l2.247" class="difflineminus">-        gRDF-&gt;GetResource(NS_LITERAL_CSTRING(kURINC_NewSearchFolder),</span>
<a href="#l2.248"></a><span id="l2.248" class="difflineminus">-                          &amp;kNC_NewSearchFolder);</span>
<a href="#l2.249"></a><span id="l2.249" class="difflineminus">-</span>
<a href="#l2.250"></a><span id="l2.250" class="difflineminus">-        gRDF-&gt;GetResource(NS_LITERAL_CSTRING(NC_NAMESPACE_URI &quot;Bookmark&quot;),</span>
<a href="#l2.251"></a><span id="l2.251" class="difflineminus">-                          &amp;kNC_Bookmark);</span>
<a href="#l2.252"></a><span id="l2.252" class="difflineminus">-        gRDF-&gt;GetResource(NS_LITERAL_CSTRING(NC_NAMESPACE_URI &quot;BookmarkSeparator&quot;),</span>
<a href="#l2.253"></a><span id="l2.253" class="difflineminus">-                          &amp;kNC_BookmarkSeparator);</span>
<a href="#l2.254"></a><span id="l2.254" class="difflineminus">-        gRDF-&gt;GetResource(NS_LITERAL_CSTRING(NC_NAMESPACE_URI &quot;BookmarkAddDate&quot;),</span>
<a href="#l2.255"></a><span id="l2.255" class="difflineminus">-                          &amp;kNC_BookmarkAddDate);</span>
<a href="#l2.256"></a><span id="l2.256" class="difflineminus">-        gRDF-&gt;GetResource(NS_LITERAL_CSTRING(NC_NAMESPACE_URI &quot;Description&quot;),</span>
<a href="#l2.257"></a><span id="l2.257" class="difflineminus">-                          &amp;kNC_Description);</span>
<a href="#l2.258"></a><span id="l2.258" class="difflineminus">-        gRDF-&gt;GetResource(NS_LITERAL_CSTRING(NC_NAMESPACE_URI &quot;Folder&quot;),</span>
<a href="#l2.259"></a><span id="l2.259" class="difflineminus">-                          &amp;kNC_Folder);</span>
<a href="#l2.260"></a><span id="l2.260" class="difflineminus">-        gRDF-&gt;GetResource(NS_LITERAL_CSTRING(NC_NAMESPACE_URI &quot;FolderType&quot;),</span>
<a href="#l2.261"></a><span id="l2.261" class="difflineminus">-                          &amp;kNC_FolderType);</span>
<a href="#l2.262"></a><span id="l2.262" class="difflineminus">-        gRDF-&gt;GetResource(NS_LITERAL_CSTRING(NC_NAMESPACE_URI &quot;FolderGroup&quot;),</span>
<a href="#l2.263"></a><span id="l2.263" class="difflineminus">-                          &amp;kNC_FolderGroup);</span>
<a href="#l2.264"></a><span id="l2.264" class="difflineminus">-        gRDF-&gt;GetResource(NS_LITERAL_CSTRING(NC_NAMESPACE_URI &quot;IEFavorite&quot;),</span>
<a href="#l2.265"></a><span id="l2.265" class="difflineminus">-                          &amp;kNC_IEFavorite);</span>
<a href="#l2.266"></a><span id="l2.266" class="difflineminus">-        gRDF-&gt;GetResource(NS_LITERAL_CSTRING(NC_NAMESPACE_URI &quot;IEFavoriteFolder&quot;),</span>
<a href="#l2.267"></a><span id="l2.267" class="difflineminus">-                          &amp;kNC_IEFavoriteFolder);</span>
<a href="#l2.268"></a><span id="l2.268" class="difflineminus">-        gRDF-&gt;GetResource(NS_LITERAL_CSTRING(NC_NAMESPACE_URI &quot;Name&quot;),</span>
<a href="#l2.269"></a><span id="l2.269" class="difflineminus">-                          &amp;kNC_Name);</span>
<a href="#l2.270"></a><span id="l2.270" class="difflineminus">-        gRDF-&gt;GetResource(NS_LITERAL_CSTRING(NC_NAMESPACE_URI &quot;Icon&quot;),</span>
<a href="#l2.271"></a><span id="l2.271" class="difflineminus">-                          &amp;kNC_Icon);</span>
<a href="#l2.272"></a><span id="l2.272" class="difflineminus">-        gRDF-&gt;GetResource(NS_LITERAL_CSTRING(NC_NAMESPACE_URI &quot;ShortcutURL&quot;),</span>
<a href="#l2.273"></a><span id="l2.273" class="difflineminus">-                          &amp;kNC_ShortcutURL);</span>
<a href="#l2.274"></a><span id="l2.274" class="difflineminus">-        gRDF-&gt;GetResource(NS_LITERAL_CSTRING(NC_NAMESPACE_URI &quot;URL&quot;),</span>
<a href="#l2.275"></a><span id="l2.275" class="difflineminus">-                          &amp;kNC_URL);</span>
<a href="#l2.276"></a><span id="l2.276" class="difflineminus">-        gRDF-&gt;GetResource(NS_LITERAL_CSTRING(RDF_NAMESPACE_URI &quot;type&quot;),</span>
<a href="#l2.277"></a><span id="l2.277" class="difflineminus">-                          &amp;kRDF_type);</span>
<a href="#l2.278"></a><span id="l2.278" class="difflineminus">-        gRDF-&gt;GetResource(NS_LITERAL_CSTRING(RDF_NAMESPACE_URI &quot;nextVal&quot;),</span>
<a href="#l2.279"></a><span id="l2.279" class="difflineminus">-                          &amp;kRDF_nextVal);</span>
<a href="#l2.280"></a><span id="l2.280" class="difflineminus">-</span>
<a href="#l2.281"></a><span id="l2.281" class="difflineminus">-        gRDF-&gt;GetResource(NS_LITERAL_CSTRING(WEB_NAMESPACE_URI &quot;LastModifiedDate&quot;),</span>
<a href="#l2.282"></a><span id="l2.282" class="difflineminus">-                          &amp;kWEB_LastModifiedDate);</span>
<a href="#l2.283"></a><span id="l2.283" class="difflineminus">-        gRDF-&gt;GetResource(NS_LITERAL_CSTRING(WEB_NAMESPACE_URI &quot;LastVisitDate&quot;),</span>
<a href="#l2.284"></a><span id="l2.284" class="difflineminus">-                          &amp;kWEB_LastVisitDate);</span>
<a href="#l2.285"></a><span id="l2.285" class="difflineminus">-        gRDF-&gt;GetResource(NS_LITERAL_CSTRING(WEB_NAMESPACE_URI &quot;LastCharset&quot;),</span>
<a href="#l2.286"></a><span id="l2.286" class="difflineminus">-                          &amp;kWEB_LastCharset);</span>
<a href="#l2.287"></a><span id="l2.287" class="difflineminus">-</span>
<a href="#l2.288"></a><span id="l2.288" class="difflineminus">-        gRDF-&gt;GetResource(NS_LITERAL_CSTRING(WEB_NAMESPACE_URI &quot;Schedule&quot;),</span>
<a href="#l2.289"></a><span id="l2.289" class="difflineminus">-                          &amp;kWEB_Schedule);</span>
<a href="#l2.290"></a><span id="l2.290" class="difflineminus">-        gRDF-&gt;GetResource(NS_LITERAL_CSTRING(WEB_NAMESPACE_URI &quot;ScheduleFlag&quot;),</span>
<a href="#l2.291"></a><span id="l2.291" class="difflineminus">-                          &amp;kWEB_ScheduleActive);</span>
<a href="#l2.292"></a><span id="l2.292" class="difflineminus">-        gRDF-&gt;GetResource(NS_LITERAL_CSTRING(WEB_NAMESPACE_URI &quot;status&quot;),</span>
<a href="#l2.293"></a><span id="l2.293" class="difflineminus">-                          &amp;kWEB_Status);</span>
<a href="#l2.294"></a><span id="l2.294" class="difflineminus">-        gRDF-&gt;GetResource(NS_LITERAL_CSTRING(WEB_NAMESPACE_URI &quot;LastPingDate&quot;),</span>
<a href="#l2.295"></a><span id="l2.295" class="difflineminus">-                          &amp;kWEB_LastPingDate);</span>
<a href="#l2.296"></a><span id="l2.296" class="difflineminus">-        gRDF-&gt;GetResource(NS_LITERAL_CSTRING(WEB_NAMESPACE_URI &quot;LastPingETag&quot;),</span>
<a href="#l2.297"></a><span id="l2.297" class="difflineminus">-                          &amp;kWEB_LastPingETag);</span>
<a href="#l2.298"></a><span id="l2.298" class="difflineminus">-        gRDF-&gt;GetResource(NS_LITERAL_CSTRING(WEB_NAMESPACE_URI &quot;LastPingModDate&quot;),</span>
<a href="#l2.299"></a><span id="l2.299" class="difflineminus">-                          &amp;kWEB_LastPingModDate);</span>
<a href="#l2.300"></a><span id="l2.300" class="difflineminus">-        gRDF-&gt;GetResource(NS_LITERAL_CSTRING(WEB_NAMESPACE_URI &quot;LastPingContentLen&quot;),</span>
<a href="#l2.301"></a><span id="l2.301" class="difflineminus">-                          &amp;kWEB_LastPingContentLen);</span>
<a href="#l2.302"></a><span id="l2.302" class="difflineminus">-</span>
<a href="#l2.303"></a><span id="l2.303" class="difflineminus">-        gRDF-&gt;GetResource(NS_LITERAL_CSTRING(NC_NAMESPACE_URI &quot;parent&quot;), &amp;kNC_Parent);</span>
<a href="#l2.304"></a><span id="l2.304" class="difflineminus">-</span>
<a href="#l2.305"></a><span id="l2.305" class="difflineminus">-        gRDF-&gt;GetLiteral(NS_LITERAL_STRING(&quot;true&quot;).get(), &amp;kTrueLiteral);</span>
<a href="#l2.306"></a><span id="l2.306" class="difflineminus">-</span>
<a href="#l2.307"></a><span id="l2.307" class="difflineminus">-        gRDF-&gt;GetLiteral(EmptyString().get(), &amp;kEmptyLiteral);</span>
<a href="#l2.308"></a><span id="l2.308" class="difflineminus">-</span>
<a href="#l2.309"></a><span id="l2.309" class="difflineminus">-        gRDF-&gt;GetDateLiteral(0, &amp;kEmptyDate);</span>
<a href="#l2.310"></a><span id="l2.310" class="difflineminus">-</span>
<a href="#l2.311"></a><span id="l2.311" class="difflineminus">-        gRDF-&gt;GetResource(NS_LITERAL_CSTRING(NC_NAMESPACE_URI &quot;command?cmd=newbookmark&quot;),</span>
<a href="#l2.312"></a><span id="l2.312" class="difflineminus">-                          &amp;kNC_BookmarkCommand_NewBookmark);</span>
<a href="#l2.313"></a><span id="l2.313" class="difflineminus">-        gRDF-&gt;GetResource(NS_LITERAL_CSTRING(NC_NAMESPACE_URI &quot;command?cmd=newfolder&quot;),</span>
<a href="#l2.314"></a><span id="l2.314" class="difflineminus">-                          &amp;kNC_BookmarkCommand_NewFolder);</span>
<a href="#l2.315"></a><span id="l2.315" class="difflineminus">-        gRDF-&gt;GetResource(NS_LITERAL_CSTRING(NC_NAMESPACE_URI &quot;command?cmd=newseparator&quot;),</span>
<a href="#l2.316"></a><span id="l2.316" class="difflineminus">-                          &amp;kNC_BookmarkCommand_NewSeparator);</span>
<a href="#l2.317"></a><span id="l2.317" class="difflineminus">-        gRDF-&gt;GetResource(NS_LITERAL_CSTRING(NC_NAMESPACE_URI &quot;command?cmd=deletebookmark&quot;),</span>
<a href="#l2.318"></a><span id="l2.318" class="difflineminus">-                          &amp;kNC_BookmarkCommand_DeleteBookmark);</span>
<a href="#l2.319"></a><span id="l2.319" class="difflineminus">-        gRDF-&gt;GetResource(NS_LITERAL_CSTRING(NC_NAMESPACE_URI &quot;command?cmd=deletebookmarkfolder&quot;),</span>
<a href="#l2.320"></a><span id="l2.320" class="difflineminus">-                          &amp;kNC_BookmarkCommand_DeleteBookmarkFolder);</span>
<a href="#l2.321"></a><span id="l2.321" class="difflineminus">-        gRDF-&gt;GetResource(NS_LITERAL_CSTRING(NC_NAMESPACE_URI &quot;command?cmd=deletebookmarkseparator&quot;),</span>
<a href="#l2.322"></a><span id="l2.322" class="difflineminus">-                          &amp;kNC_BookmarkCommand_DeleteBookmarkSeparator);</span>
<a href="#l2.323"></a><span id="l2.323" class="difflineminus">-        gRDF-&gt;GetResource(NS_LITERAL_CSTRING(NC_NAMESPACE_URI &quot;command?cmd=setnewbookmarkfolder&quot;),</span>
<a href="#l2.324"></a><span id="l2.324" class="difflineminus">-                          &amp;kNC_BookmarkCommand_SetNewBookmarkFolder);</span>
<a href="#l2.325"></a><span id="l2.325" class="difflineminus">-        gRDF-&gt;GetResource(NS_LITERAL_CSTRING(NC_NAMESPACE_URI &quot;command?cmd=setpersonaltoolbarfolder&quot;),</span>
<a href="#l2.326"></a><span id="l2.326" class="difflineminus">-                          &amp;kNC_BookmarkCommand_SetPersonalToolbarFolder);</span>
<a href="#l2.327"></a><span id="l2.327" class="difflineminus">-        gRDF-&gt;GetResource(NS_LITERAL_CSTRING(NC_NAMESPACE_URI &quot;command?cmd=setnewsearchfolder&quot;),</span>
<a href="#l2.328"></a><span id="l2.328" class="difflineminus">-                          &amp;kNC_BookmarkCommand_SetNewSearchFolder);</span>
<a href="#l2.329"></a><span id="l2.329" class="difflineminus">-        gRDF-&gt;GetResource(NS_LITERAL_CSTRING(NC_NAMESPACE_URI &quot;command?cmd=import&quot;),</span>
<a href="#l2.330"></a><span id="l2.330" class="difflineminus">-                          &amp;kNC_BookmarkCommand_Import);</span>
<a href="#l2.331"></a><span id="l2.331" class="difflineminus">-        gRDF-&gt;GetResource(NS_LITERAL_CSTRING(NC_NAMESPACE_URI &quot;command?cmd=export&quot;),</span>
<a href="#l2.332"></a><span id="l2.332" class="difflineminus">-                          &amp;kNC_BookmarkCommand_Export);</span>
<a href="#l2.333"></a><span id="l2.333" class="difflineminus">-    }</span>
<a href="#l2.334"></a><span id="l2.334" class="difflineminus">-    return NS_OK;</span>
<a href="#l2.335"></a><span id="l2.335" class="difflineminus">-}</span>
<a href="#l2.336"></a><span id="l2.336" class="difflineminus">-</span>
<a href="#l2.337"></a><span id="l2.337" class="difflineminus">-</span>
<a href="#l2.338"></a><span id="l2.338" class="difflineminus">-</span>
<a href="#l2.339"></a><span id="l2.339" class="difflineminus">-static void</span>
<a href="#l2.340"></a><span id="l2.340" class="difflineminus">-bm_ReleaseGlobals()</span>
<a href="#l2.341"></a><span id="l2.341" class="difflineminus">-{</span>
<a href="#l2.342"></a><span id="l2.342" class="difflineminus">-    if (--gRefCnt == 0)</span>
<a href="#l2.343"></a><span id="l2.343" class="difflineminus">-    {</span>
<a href="#l2.344"></a><span id="l2.344" class="difflineminus">-        NS_IF_RELEASE(gRDF);</span>
<a href="#l2.345"></a><span id="l2.345" class="difflineminus">-        NS_IF_RELEASE(gRDFC);</span>
<a href="#l2.346"></a><span id="l2.346" class="difflineminus">-        NS_IF_RELEASE(gCharsetAlias);</span>
<a href="#l2.347"></a><span id="l2.347" class="difflineminus">-</span>
<a href="#l2.348"></a><span id="l2.348" class="difflineminus">-        NS_IF_RELEASE(gCollation);</span>
<a href="#l2.349"></a><span id="l2.349" class="difflineminus">-</span>
<a href="#l2.350"></a><span id="l2.350" class="difflineminus">-        NS_IF_RELEASE(kNC_Bookmark);</span>
<a href="#l2.351"></a><span id="l2.351" class="difflineminus">-        NS_IF_RELEASE(kNC_BookmarkSeparator);</span>
<a href="#l2.352"></a><span id="l2.352" class="difflineminus">-        NS_IF_RELEASE(kNC_BookmarkAddDate);</span>
<a href="#l2.353"></a><span id="l2.353" class="difflineminus">-        NS_IF_RELEASE(kNC_BookmarksTopRoot);</span>
<a href="#l2.354"></a><span id="l2.354" class="difflineminus">-        NS_IF_RELEASE(kNC_BookmarksRoot);</span>
<a href="#l2.355"></a><span id="l2.355" class="difflineminus">-        NS_IF_RELEASE(kNC_Description);</span>
<a href="#l2.356"></a><span id="l2.356" class="difflineminus">-        NS_IF_RELEASE(kNC_Folder);</span>
<a href="#l2.357"></a><span id="l2.357" class="difflineminus">-        NS_IF_RELEASE(kNC_FolderType);</span>
<a href="#l2.358"></a><span id="l2.358" class="difflineminus">-        NS_IF_RELEASE(kNC_FolderGroup);</span>
<a href="#l2.359"></a><span id="l2.359" class="difflineminus">-        NS_IF_RELEASE(kNC_IEFavorite);</span>
<a href="#l2.360"></a><span id="l2.360" class="difflineminus">-        NS_IF_RELEASE(kNC_IEFavoriteFolder);</span>
<a href="#l2.361"></a><span id="l2.361" class="difflineminus">-        NS_IF_RELEASE(kNC_IEFavoritesRoot);</span>
<a href="#l2.362"></a><span id="l2.362" class="difflineminus">-        NS_IF_RELEASE(kNC_SystemBookmarksStaticRoot);</span>
<a href="#l2.363"></a><span id="l2.363" class="difflineminus">-        NS_IF_RELEASE(kNC_Name);</span>
<a href="#l2.364"></a><span id="l2.364" class="difflineminus">-        NS_IF_RELEASE(kNC_Icon);</span>
<a href="#l2.365"></a><span id="l2.365" class="difflineminus">-        NS_IF_RELEASE(kNC_NewBookmarkFolder);</span>
<a href="#l2.366"></a><span id="l2.366" class="difflineminus">-        NS_IF_RELEASE(kNC_NewSearchFolder);</span>
<a href="#l2.367"></a><span id="l2.367" class="difflineminus">-        NS_IF_RELEASE(kNC_PersonalToolbarFolder);</span>
<a href="#l2.368"></a><span id="l2.368" class="difflineminus">-        NS_IF_RELEASE(kNC_ShortcutURL);</span>
<a href="#l2.369"></a><span id="l2.369" class="difflineminus">-        NS_IF_RELEASE(kNC_URL);</span>
<a href="#l2.370"></a><span id="l2.370" class="difflineminus">-        NS_IF_RELEASE(kRDF_type);</span>
<a href="#l2.371"></a><span id="l2.371" class="difflineminus">-        NS_IF_RELEASE(kRDF_nextVal);</span>
<a href="#l2.372"></a><span id="l2.372" class="difflineminus">-        NS_IF_RELEASE(kWEB_LastModifiedDate);</span>
<a href="#l2.373"></a><span id="l2.373" class="difflineminus">-        NS_IF_RELEASE(kWEB_LastVisitDate);</span>
<a href="#l2.374"></a><span id="l2.374" class="difflineminus">-        NS_IF_RELEASE(kNC_Parent);</span>
<a href="#l2.375"></a><span id="l2.375" class="difflineminus">-        NS_IF_RELEASE(kTrueLiteral);</span>
<a href="#l2.376"></a><span id="l2.376" class="difflineminus">-        NS_IF_RELEASE(kEmptyLiteral);</span>
<a href="#l2.377"></a><span id="l2.377" class="difflineminus">-        NS_IF_RELEASE(kEmptyDate);</span>
<a href="#l2.378"></a><span id="l2.378" class="difflineminus">-        NS_IF_RELEASE(kWEB_Schedule);</span>
<a href="#l2.379"></a><span id="l2.379" class="difflineminus">-        NS_IF_RELEASE(kWEB_ScheduleActive);</span>
<a href="#l2.380"></a><span id="l2.380" class="difflineminus">-        NS_IF_RELEASE(kWEB_Status);</span>
<a href="#l2.381"></a><span id="l2.381" class="difflineminus">-        NS_IF_RELEASE(kWEB_LastPingDate);</span>
<a href="#l2.382"></a><span id="l2.382" class="difflineminus">-        NS_IF_RELEASE(kWEB_LastPingETag);</span>
<a href="#l2.383"></a><span id="l2.383" class="difflineminus">-        NS_IF_RELEASE(kWEB_LastPingModDate);</span>
<a href="#l2.384"></a><span id="l2.384" class="difflineminus">-        NS_IF_RELEASE(kWEB_LastPingContentLen);</span>
<a href="#l2.385"></a><span id="l2.385" class="difflineminus">-        NS_IF_RELEASE(kWEB_LastCharset);</span>
<a href="#l2.386"></a><span id="l2.386" class="difflineminus">-        NS_IF_RELEASE(kNC_BookmarkCommand_NewBookmark);</span>
<a href="#l2.387"></a><span id="l2.387" class="difflineminus">-        NS_IF_RELEASE(kNC_BookmarkCommand_NewFolder);</span>
<a href="#l2.388"></a><span id="l2.388" class="difflineminus">-        NS_IF_RELEASE(kNC_BookmarkCommand_NewSeparator);</span>
<a href="#l2.389"></a><span id="l2.389" class="difflineminus">-        NS_IF_RELEASE(kNC_BookmarkCommand_DeleteBookmark);</span>
<a href="#l2.390"></a><span id="l2.390" class="difflineminus">-        NS_IF_RELEASE(kNC_BookmarkCommand_DeleteBookmarkFolder);</span>
<a href="#l2.391"></a><span id="l2.391" class="difflineminus">-        NS_IF_RELEASE(kNC_BookmarkCommand_DeleteBookmarkSeparator);</span>
<a href="#l2.392"></a><span id="l2.392" class="difflineminus">-        NS_IF_RELEASE(kNC_BookmarkCommand_SetNewBookmarkFolder);</span>
<a href="#l2.393"></a><span id="l2.393" class="difflineminus">-        NS_IF_RELEASE(kNC_BookmarkCommand_SetPersonalToolbarFolder);</span>
<a href="#l2.394"></a><span id="l2.394" class="difflineminus">-        NS_IF_RELEASE(kNC_BookmarkCommand_SetNewSearchFolder);</span>
<a href="#l2.395"></a><span id="l2.395" class="difflineminus">-        NS_IF_RELEASE(kNC_BookmarkCommand_Import);</span>
<a href="#l2.396"></a><span id="l2.396" class="difflineminus">-        NS_IF_RELEASE(kNC_BookmarkCommand_Export);</span>
<a href="#l2.397"></a><span id="l2.397" class="difflineminus">-    }</span>
<a href="#l2.398"></a><span id="l2.398" class="difflineminus">-}</span>
<a href="#l2.399"></a><span id="l2.399" class="difflineminus">-</span>
<a href="#l2.400"></a><span id="l2.400" class="difflineminus">-/**</span>
<a href="#l2.401"></a><span id="l2.401" class="difflineminus">- * Escape HTML-special characters in a string.</span>
<a href="#l2.402"></a><span id="l2.402" class="difflineminus">- */</span>
<a href="#l2.403"></a><span id="l2.403" class="difflineminus">-static void</span>
<a href="#l2.404"></a><span id="l2.404" class="difflineminus">-EscapeHTML(nsCString &amp;data)</span>
<a href="#l2.405"></a><span id="l2.405" class="difflineminus">-{</span>
<a href="#l2.406"></a><span id="l2.406" class="difflineminus">-    const char *begin = data.get();</span>
<a href="#l2.407"></a><span id="l2.407" class="difflineminus">-</span>
<a href="#l2.408"></a><span id="l2.408" class="difflineminus">-    for (PRInt32 pos = data.Length() - 1; pos &gt;= 0; --pos) {</span>
<a href="#l2.409"></a><span id="l2.409" class="difflineminus">-        switch (begin[pos]) {</span>
<a href="#l2.410"></a><span id="l2.410" class="difflineminus">-        case '&lt;':</span>
<a href="#l2.411"></a><span id="l2.411" class="difflineminus">-            data.Replace(pos, 1, &quot;&amp;lt;&quot;);</span>
<a href="#l2.412"></a><span id="l2.412" class="difflineminus">-            break;</span>
<a href="#l2.413"></a><span id="l2.413" class="difflineminus">-</span>
<a href="#l2.414"></a><span id="l2.414" class="difflineminus">-        case '&gt;':</span>
<a href="#l2.415"></a><span id="l2.415" class="difflineminus">-            data.Replace(pos, 1, &quot;&amp;gt;&quot;);</span>
<a href="#l2.416"></a><span id="l2.416" class="difflineminus">-            break;</span>
<a href="#l2.417"></a><span id="l2.417" class="difflineminus">-</span>
<a href="#l2.418"></a><span id="l2.418" class="difflineminus">-        case '&amp;':</span>
<a href="#l2.419"></a><span id="l2.419" class="difflineminus">-            data.Replace(pos, 1, &quot;&amp;amp;&quot;);</span>
<a href="#l2.420"></a><span id="l2.420" class="difflineminus">-            break;</span>
<a href="#l2.421"></a><span id="l2.421" class="difflineminus">-</span>
<a href="#l2.422"></a><span id="l2.422" class="difflineminus">-        case '&quot;':</span>
<a href="#l2.423"></a><span id="l2.423" class="difflineminus">-            data.Replace(pos, 1, &quot;&amp;quot;&quot;);</span>
<a href="#l2.424"></a><span id="l2.424" class="difflineminus">-            break;</span>
<a href="#l2.425"></a><span id="l2.425" class="difflineminus">-</span>
<a href="#l2.426"></a><span id="l2.426" class="difflineminus">-        case '\'':</span>
<a href="#l2.427"></a><span id="l2.427" class="difflineminus">-            data.Replace(pos, 1, &quot;&amp;#39;&quot;);</span>
<a href="#l2.428"></a><span id="l2.428" class="difflineminus">-            break;</span>
<a href="#l2.429"></a><span id="l2.429" class="difflineminus">-</span>
<a href="#l2.430"></a><span id="l2.430" class="difflineminus">-        default:</span>
<a href="#l2.431"></a><span id="l2.431" class="difflineminus">-            continue;</span>
<a href="#l2.432"></a><span id="l2.432" class="difflineminus">-        }</span>
<a href="#l2.433"></a><span id="l2.433" class="difflineminus">-        begin = data.get();</span>
<a href="#l2.434"></a><span id="l2.434" class="difflineminus">-    }</span>
<a href="#l2.435"></a><span id="l2.435" class="difflineminus">-}</span>
<a href="#l2.436"></a><span id="l2.436" class="difflineminus">-</span>
<a href="#l2.437"></a><span id="l2.437" class="difflineminus">-////////////////////////////////////////////////////////////////////////</span>
<a href="#l2.438"></a><span id="l2.438" class="difflineminus">-</span>
<a href="#l2.439"></a><span id="l2.439" class="difflineminus">-/**</span>
<a href="#l2.440"></a><span id="l2.440" class="difflineminus">- * The bookmark parser knows how to read &lt;tt&gt;bookmarks.html&lt;/tt&gt; and convert it</span>
<a href="#l2.441"></a><span id="l2.441" class="difflineminus">- * into an RDF graph.</span>
<a href="#l2.442"></a><span id="l2.442" class="difflineminus">- */</span>
<a href="#l2.443"></a><span id="l2.443" class="difflineminus">-class BookmarkParser {</span>
<a href="#l2.444"></a><span id="l2.444" class="difflineminus">-private:</span>
<a href="#l2.445"></a><span id="l2.445" class="difflineminus">-    nsCOMPtr&lt;nsIUnicodeDecoder&gt; mUnicodeDecoder;</span>
<a href="#l2.446"></a><span id="l2.446" class="difflineminus">-    nsIRDFDataSource*           mDataSource;</span>
<a href="#l2.447"></a><span id="l2.447" class="difflineminus">-    nsCString                   mIEFavoritesRoot;</span>
<a href="#l2.448"></a><span id="l2.448" class="difflineminus">-    PRBool                      mFoundIEFavoritesRoot;</span>
<a href="#l2.449"></a><span id="l2.449" class="difflineminus">-    PRBool                      mFoundPersonalToolbarFolder;</span>
<a href="#l2.450"></a><span id="l2.450" class="difflineminus">-    PRBool                      mIsImportOperation;</span>
<a href="#l2.451"></a><span id="l2.451" class="difflineminus">-    char*                       mContents;</span>
<a href="#l2.452"></a><span id="l2.452" class="difflineminus">-    PRUint32                    mContentsLen;</span>
<a href="#l2.453"></a><span id="l2.453" class="difflineminus">-    PRInt32                     mStartOffset;</span>
<a href="#l2.454"></a><span id="l2.454" class="difflineminus">-    nsCOMPtr&lt;nsIInputStream&gt;    mInputStream;</span>
<a href="#l2.455"></a><span id="l2.455" class="difflineminus">-</span>
<a href="#l2.456"></a><span id="l2.456" class="difflineminus">-    friend  class nsBookmarksService;</span>
<a href="#l2.457"></a><span id="l2.457" class="difflineminus">-</span>
<a href="#l2.458"></a><span id="l2.458" class="difflineminus">-protected:</span>
<a href="#l2.459"></a><span id="l2.459" class="difflineminus">-    struct BookmarkField</span>
<a href="#l2.460"></a><span id="l2.460" class="difflineminus">-    {</span>
<a href="#l2.461"></a><span id="l2.461" class="difflineminus">-        const char      *mName;</span>
<a href="#l2.462"></a><span id="l2.462" class="difflineminus">-        const char      *mPropertyName;</span>
<a href="#l2.463"></a><span id="l2.463" class="difflineminus">-        nsIRDFResource  *mProperty;</span>
<a href="#l2.464"></a><span id="l2.464" class="difflineminus">-        nsresult        (*mParse)(nsIRDFResource *arc, nsString&amp; aValue, nsIRDFNode** aResult);</span>
<a href="#l2.465"></a><span id="l2.465" class="difflineminus">-        nsIRDFNode      *mValue;</span>
<a href="#l2.466"></a><span id="l2.466" class="difflineminus">-    };</span>
<a href="#l2.467"></a><span id="l2.467" class="difflineminus">-</span>
<a href="#l2.468"></a><span id="l2.468" class="difflineminus">-    static BookmarkField gBookmarkFieldTable[];</span>
<a href="#l2.469"></a><span id="l2.469" class="difflineminus">-    static BookmarkField gBookmarkHeaderFieldTable[];</span>
<a href="#l2.470"></a><span id="l2.470" class="difflineminus">-</span>
<a href="#l2.471"></a><span id="l2.471" class="difflineminus">-    nsresult AssertTime(nsIRDFResource* aSource,</span>
<a href="#l2.472"></a><span id="l2.472" class="difflineminus">-                        nsIRDFResource* aLabel,</span>
<a href="#l2.473"></a><span id="l2.473" class="difflineminus">-                        PRInt32 aTime);</span>
<a href="#l2.474"></a><span id="l2.474" class="difflineminus">-</span>
<a href="#l2.475"></a><span id="l2.475" class="difflineminus">-    nsresult setFolderHint(nsIRDFResource *newSource, nsIRDFResource *objType);</span>
<a href="#l2.476"></a><span id="l2.476" class="difflineminus">-</span>
<a href="#l2.477"></a><span id="l2.477" class="difflineminus">-    static nsresult Unescape(nsString &amp;text);</span>
<a href="#l2.478"></a><span id="l2.478" class="difflineminus">-</span>
<a href="#l2.479"></a><span id="l2.479" class="difflineminus">-    nsresult ParseMetaTag(const nsString &amp;aLine, nsIUnicodeDecoder **decoder);</span>
<a href="#l2.480"></a><span id="l2.480" class="difflineminus">-</span>
<a href="#l2.481"></a><span id="l2.481" class="difflineminus">-    nsresult ParseBookmarkInfo(BookmarkField *fields, PRBool isBookmarkFlag, const nsString &amp;aLine,</span>
<a href="#l2.482"></a><span id="l2.482" class="difflineminus">-                               const nsCOMPtr&lt;nsIRDFContainer&gt; &amp;aContainer,</span>
<a href="#l2.483"></a><span id="l2.483" class="difflineminus">-                               nsIRDFResource *nodeType, nsCOMPtr&lt;nsIRDFResource&gt; &amp;bookmarkNode);</span>
<a href="#l2.484"></a><span id="l2.484" class="difflineminus">-</span>
<a href="#l2.485"></a><span id="l2.485" class="difflineminus">-    nsresult ParseBookmarkSeparator(const nsString &amp;aLine,</span>
<a href="#l2.486"></a><span id="l2.486" class="difflineminus">-                                    const nsCOMPtr&lt;nsIRDFContainer&gt; &amp;aContainer);</span>
<a href="#l2.487"></a><span id="l2.487" class="difflineminus">-</span>
<a href="#l2.488"></a><span id="l2.488" class="difflineminus">-    nsresult ParseHeaderBegin(const nsString &amp;aLine,</span>
<a href="#l2.489"></a><span id="l2.489" class="difflineminus">-                              const nsCOMPtr&lt;nsIRDFContainer&gt; &amp;aContainer);</span>
<a href="#l2.490"></a><span id="l2.490" class="difflineminus">-</span>
<a href="#l2.491"></a><span id="l2.491" class="difflineminus">-    nsresult ParseHeaderEnd(const nsString &amp;aLine);</span>
<a href="#l2.492"></a><span id="l2.492" class="difflineminus">-</span>
<a href="#l2.493"></a><span id="l2.493" class="difflineminus">-    PRInt32 getEOL(const char *whole, PRInt32 startOffset, PRInt32 totalLength);</span>
<a href="#l2.494"></a><span id="l2.494" class="difflineminus">-</span>
<a href="#l2.495"></a><span id="l2.495" class="difflineminus">-    nsresult updateAtom(nsIRDFDataSource *db, nsIRDFResource *src,</span>
<a href="#l2.496"></a><span id="l2.496" class="difflineminus">-                        nsIRDFResource *prop, nsIRDFNode *newValue, PRBool *dirtyFlag);</span>
<a href="#l2.497"></a><span id="l2.497" class="difflineminus">-</span>
<a href="#l2.498"></a><span id="l2.498" class="difflineminus">-    static    nsresult ParseResource(nsIRDFResource *arc, nsString&amp; aValue, nsIRDFNode** aResult);</span>
<a href="#l2.499"></a><span id="l2.499" class="difflineminus">-    static    nsresult ParseLiteral(nsIRDFResource *arc, nsString&amp; aValue, nsIRDFNode** aResult);</span>
<a href="#l2.500"></a><span id="l2.500" class="difflineminus">-    static    nsresult ParseDate(nsIRDFResource *arc, nsString&amp; aValue, nsIRDFNode** aResult);</span>
<a href="#l2.501"></a><span id="l2.501" class="difflineminus">-</span>
<a href="#l2.502"></a><span id="l2.502" class="difflineminus">-public:</span>
<a href="#l2.503"></a><span id="l2.503" class="difflineminus">-    BookmarkParser();</span>
<a href="#l2.504"></a><span id="l2.504" class="difflineminus">-    ~BookmarkParser();</span>
<a href="#l2.505"></a><span id="l2.505" class="difflineminus">-</span>
<a href="#l2.506"></a><span id="l2.506" class="difflineminus">-    nsresult Init(nsIFile *aFile, nsIRDFDataSource *aDataSource, </span>
<a href="#l2.507"></a><span id="l2.507" class="difflineminus">-                  PRBool aIsImportOperation = PR_FALSE);</span>
<a href="#l2.508"></a><span id="l2.508" class="difflineminus">-    nsresult DecodeBuffer(nsString &amp;line, char *buf, PRUint32 aLength);</span>
<a href="#l2.509"></a><span id="l2.509" class="difflineminus">-    nsresult ProcessLine(nsIRDFContainer *aContainer, nsIRDFResource *nodeType,</span>
<a href="#l2.510"></a><span id="l2.510" class="difflineminus">-                         nsCOMPtr&lt;nsIRDFResource&gt; &amp;bookmarkNode, const nsString &amp;line,</span>
<a href="#l2.511"></a><span id="l2.511" class="difflineminus">-                         nsString &amp;description, PRBool &amp;inDescription, PRBool &amp;isActiveFlag);</span>
<a href="#l2.512"></a><span id="l2.512" class="difflineminus">-    nsresult Parse(nsIRDFResource* aContainer, nsIRDFResource *nodeType);</span>
<a href="#l2.513"></a><span id="l2.513" class="difflineminus">-</span>
<a href="#l2.514"></a><span id="l2.514" class="difflineminus">-    nsresult SetIEFavoritesRoot(const nsCString&amp; IEFavoritesRootURL)</span>
<a href="#l2.515"></a><span id="l2.515" class="difflineminus">-    {</span>
<a href="#l2.516"></a><span id="l2.516" class="difflineminus">-        mIEFavoritesRoot = IEFavoritesRootURL;</span>
<a href="#l2.517"></a><span id="l2.517" class="difflineminus">-        return NS_OK;</span>
<a href="#l2.518"></a><span id="l2.518" class="difflineminus">-    }</span>
<a href="#l2.519"></a><span id="l2.519" class="difflineminus">-    nsresult ParserFoundIEFavoritesRoot(PRBool *foundIEFavoritesRoot)</span>
<a href="#l2.520"></a><span id="l2.520" class="difflineminus">-    {</span>
<a href="#l2.521"></a><span id="l2.521" class="difflineminus">-        *foundIEFavoritesRoot = mFoundIEFavoritesRoot;</span>
<a href="#l2.522"></a><span id="l2.522" class="difflineminus">-        return NS_OK;</span>
<a href="#l2.523"></a><span id="l2.523" class="difflineminus">-    }</span>
<a href="#l2.524"></a><span id="l2.524" class="difflineminus">-    nsresult ParserFoundPersonalToolbarFolder(PRBool *foundPersonalToolbarFolder)</span>
<a href="#l2.525"></a><span id="l2.525" class="difflineminus">-    {</span>
<a href="#l2.526"></a><span id="l2.526" class="difflineminus">-        *foundPersonalToolbarFolder = mFoundPersonalToolbarFolder;</span>
<a href="#l2.527"></a><span id="l2.527" class="difflineminus">-        return NS_OK;</span>
<a href="#l2.528"></a><span id="l2.528" class="difflineminus">-    }</span>
<a href="#l2.529"></a><span id="l2.529" class="difflineminus">-};</span>
<a href="#l2.530"></a><span id="l2.530" class="difflineminus">-</span>
<a href="#l2.531"></a><span id="l2.531" class="difflineminus">-BookmarkParser::BookmarkParser() :</span>
<a href="#l2.532"></a><span id="l2.532" class="difflineminus">-    mContents(nsnull),</span>
<a href="#l2.533"></a><span id="l2.533" class="difflineminus">-    mContentsLen(0L),</span>
<a href="#l2.534"></a><span id="l2.534" class="difflineminus">-    mStartOffset(0L)</span>
<a href="#l2.535"></a><span id="l2.535" class="difflineminus">-{</span>
<a href="#l2.536"></a><span id="l2.536" class="difflineminus">-    bm_AddRefGlobals();</span>
<a href="#l2.537"></a><span id="l2.537" class="difflineminus">-}</span>
<a href="#l2.538"></a><span id="l2.538" class="difflineminus">-</span>
<a href="#l2.539"></a><span id="l2.539" class="difflineminus">-static const char kOpenAnchor[]    = &quot;&lt;A &quot;;</span>
<a href="#l2.540"></a><span id="l2.540" class="difflineminus">-static const char kCloseAnchor[]   = &quot;&lt;/A&gt;&quot;;</span>
<a href="#l2.541"></a><span id="l2.541" class="difflineminus">-</span>
<a href="#l2.542"></a><span id="l2.542" class="difflineminus">-static const char kOpenHeading[]   = &quot;&lt;H&quot;;</span>
<a href="#l2.543"></a><span id="l2.543" class="difflineminus">-static const char kCloseHeading[]  = &quot;&lt;/H&quot;;</span>
<a href="#l2.544"></a><span id="l2.544" class="difflineminus">-</span>
<a href="#l2.545"></a><span id="l2.545" class="difflineminus">-static const char kSeparator[]     = &quot;&lt;HR&quot;;</span>
<a href="#l2.546"></a><span id="l2.546" class="difflineminus">-</span>
<a href="#l2.547"></a><span id="l2.547" class="difflineminus">-static const char kOpenUL[]        = &quot;&lt;UL&gt;&quot;;</span>
<a href="#l2.548"></a><span id="l2.548" class="difflineminus">-static const char kCloseUL[]       = &quot;&lt;/UL&gt;&quot;;</span>
<a href="#l2.549"></a><span id="l2.549" class="difflineminus">-</span>
<a href="#l2.550"></a><span id="l2.550" class="difflineminus">-static const char kOpenMenu[]      = &quot;&lt;MENU&gt;&quot;;</span>
<a href="#l2.551"></a><span id="l2.551" class="difflineminus">-static const char kCloseMenu[]     = &quot;&lt;/MENU&gt;&quot;;</span>
<a href="#l2.552"></a><span id="l2.552" class="difflineminus">-</span>
<a href="#l2.553"></a><span id="l2.553" class="difflineminus">-static const char kOpenDL[]        = &quot;&lt;DL&gt;&quot;;</span>
<a href="#l2.554"></a><span id="l2.554" class="difflineminus">-static const char kCloseDL[]       = &quot;&lt;/DL&gt;&quot;;</span>
<a href="#l2.555"></a><span id="l2.555" class="difflineminus">-</span>
<a href="#l2.556"></a><span id="l2.556" class="difflineminus">-static const char kOpenDD[]        = &quot;&lt;DD&gt;&quot;;</span>
<a href="#l2.557"></a><span id="l2.557" class="difflineminus">-</span>
<a href="#l2.558"></a><span id="l2.558" class="difflineminus">-static const char kOpenMeta[]      = &quot;&lt;META &quot;;</span>
<a href="#l2.559"></a><span id="l2.559" class="difflineminus">-</span>
<a href="#l2.560"></a><span id="l2.560" class="difflineminus">-static const char kNewBookmarkFolderEquals[]      = &quot;NEW_BOOKMARK_FOLDER=\&quot;&quot;;</span>
<a href="#l2.561"></a><span id="l2.561" class="difflineminus">-static const char kNewSearchFolderEquals[]        = &quot;NEW_SEARCH_FOLDER=\&quot;&quot;;</span>
<a href="#l2.562"></a><span id="l2.562" class="difflineminus">-static const char kPersonalToolbarFolderEquals[]  = &quot;PERSONAL_TOOLBAR_FOLDER=\&quot;&quot;;</span>
<a href="#l2.563"></a><span id="l2.563" class="difflineminus">-</span>
<a href="#l2.564"></a><span id="l2.564" class="difflineminus">-static const char kNameEquals[]            = &quot;NAME=\&quot;&quot;;</span>
<a href="#l2.565"></a><span id="l2.565" class="difflineminus">-static const char kNameEqualsLC[]          = &quot;name=\&quot;&quot;;</span>
<a href="#l2.566"></a><span id="l2.566" class="difflineminus">-static const char kHREFEquals[]            = &quot;HREF=\&quot;&quot;;</span>
<a href="#l2.567"></a><span id="l2.567" class="difflineminus">-static const char kTargetEquals[]          = &quot;TARGET=\&quot;&quot;;</span>
<a href="#l2.568"></a><span id="l2.568" class="difflineminus">-static const char kAddDateEquals[]         = &quot;ADD_DATE=\&quot;&quot;;</span>
<a href="#l2.569"></a><span id="l2.569" class="difflineminus">-static const char kFolderGroupEquals[]     = &quot;FOLDER_GROUP=\&quot;&quot;;</span>
<a href="#l2.570"></a><span id="l2.570" class="difflineminus">-static const char kLastVisitEquals[]       = &quot;LAST_VISIT=\&quot;&quot;;</span>
<a href="#l2.571"></a><span id="l2.571" class="difflineminus">-static const char kLastModifiedEquals[]    = &quot;LAST_MODIFIED=\&quot;&quot;;</span>
<a href="#l2.572"></a><span id="l2.572" class="difflineminus">-static const char kLastCharsetEquals[]     = &quot;LAST_CHARSET=\&quot;&quot;;</span>
<a href="#l2.573"></a><span id="l2.573" class="difflineminus">-static const char kShortcutURLEquals[]     = &quot;SHORTCUTURL=\&quot;&quot;;</span>
<a href="#l2.574"></a><span id="l2.574" class="difflineminus">-static const char kIconEquals[]            = &quot;ICON=\&quot;&quot;;</span>
<a href="#l2.575"></a><span id="l2.575" class="difflineminus">-static const char kScheduleEquals[]        = &quot;SCHEDULE=\&quot;&quot;;</span>
<a href="#l2.576"></a><span id="l2.576" class="difflineminus">-static const char kLastPingEquals[]        = &quot;LAST_PING=\&quot;&quot;;</span>
<a href="#l2.577"></a><span id="l2.577" class="difflineminus">-static const char kPingETagEquals[]        = &quot;PING_ETAG=\&quot;&quot;;</span>
<a href="#l2.578"></a><span id="l2.578" class="difflineminus">-static const char kPingLastModEquals[]     = &quot;PING_LAST_MODIFIED=\&quot;&quot;;</span>
<a href="#l2.579"></a><span id="l2.579" class="difflineminus">-static const char kPingContentLenEquals[]  = &quot;PING_CONTENT_LEN=\&quot;&quot;;</span>
<a href="#l2.580"></a><span id="l2.580" class="difflineminus">-static const char kPingStatusEquals[]      = &quot;PING_STATUS=\&quot;&quot;;</span>
<a href="#l2.581"></a><span id="l2.581" class="difflineminus">-static const char kIDEquals[]              = &quot;ID=\&quot;&quot;;</span>
<a href="#l2.582"></a><span id="l2.582" class="difflineminus">-static const char kContentEquals[]         = &quot;CONTENT=\&quot;&quot;;</span>
<a href="#l2.583"></a><span id="l2.583" class="difflineminus">-static const char kHTTPEquivEquals[]       = &quot;HTTP-EQUIV=\&quot;&quot;;</span>
<a href="#l2.584"></a><span id="l2.584" class="difflineminus">-static const char kCharsetEquals[]         = &quot;charset=&quot;;        // note: no quote</span>
<a href="#l2.585"></a><span id="l2.585" class="difflineminus">-</span>
<a href="#l2.586"></a><span id="l2.586" class="difflineminus">-nsresult</span>
<a href="#l2.587"></a><span id="l2.587" class="difflineminus">-BookmarkParser::Init(nsIFile *aFile, nsIRDFDataSource *aDataSource, </span>
<a href="#l2.588"></a><span id="l2.588" class="difflineminus">-                     PRBool aIsImportOperation)</span>
<a href="#l2.589"></a><span id="l2.589" class="difflineminus">-{</span>
<a href="#l2.590"></a><span id="l2.590" class="difflineminus">-    mDataSource = aDataSource;</span>
<a href="#l2.591"></a><span id="l2.591" class="difflineminus">-    mFoundIEFavoritesRoot = PR_FALSE;</span>
<a href="#l2.592"></a><span id="l2.592" class="difflineminus">-    mFoundPersonalToolbarFolder = PR_FALSE;</span>
<a href="#l2.593"></a><span id="l2.593" class="difflineminus">-    mIsImportOperation = aIsImportOperation;</span>
<a href="#l2.594"></a><span id="l2.594" class="difflineminus">-</span>
<a href="#l2.595"></a><span id="l2.595" class="difflineminus">-    nsresult rv;</span>
<a href="#l2.596"></a><span id="l2.596" class="difflineminus">-</span>
<a href="#l2.597"></a><span id="l2.597" class="difflineminus">-    // determine default platform charset...</span>
<a href="#l2.598"></a><span id="l2.598" class="difflineminus">-    nsCOMPtr&lt;nsIPlatformCharset&gt; platformCharset = </span>
<a href="#l2.599"></a><span id="l2.599" class="difflineminus">-        do_GetService(NS_PLATFORMCHARSET_CONTRACTID, &amp;rv);</span>
<a href="#l2.600"></a><span id="l2.600" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; (platformCharset))</span>
<a href="#l2.601"></a><span id="l2.601" class="difflineminus">-    {</span>
<a href="#l2.602"></a><span id="l2.602" class="difflineminus">-        nsCAutoString    defaultCharset;</span>
<a href="#l2.603"></a><span id="l2.603" class="difflineminus">-        if (NS_SUCCEEDED(rv = platformCharset-&gt;GetCharset(kPlatformCharsetSel_4xBookmarkFile, defaultCharset)))</span>
<a href="#l2.604"></a><span id="l2.604" class="difflineminus">-        {</span>
<a href="#l2.605"></a><span id="l2.605" class="difflineminus">-            // found the default platform charset, now try and get a decoder from it to Unicode</span>
<a href="#l2.606"></a><span id="l2.606" class="difflineminus">-            nsCOMPtr&lt;nsICharsetConverterManager&gt; charsetConv = </span>
<a href="#l2.607"></a><span id="l2.607" class="difflineminus">-                do_GetService(NS_CHARSETCONVERTERMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l2.608"></a><span id="l2.608" class="difflineminus">-            if (NS_SUCCEEDED(rv) &amp;&amp; (charsetConv))</span>
<a href="#l2.609"></a><span id="l2.609" class="difflineminus">-            {</span>
<a href="#l2.610"></a><span id="l2.610" class="difflineminus">-                rv = charsetConv-&gt;GetUnicodeDecoderRaw(defaultCharset.get(),</span>
<a href="#l2.611"></a><span id="l2.611" class="difflineminus">-                                                       getter_AddRefs(mUnicodeDecoder));</span>
<a href="#l2.612"></a><span id="l2.612" class="difflineminus">-            }</span>
<a href="#l2.613"></a><span id="l2.613" class="difflineminus">-        }</span>
<a href="#l2.614"></a><span id="l2.614" class="difflineminus">-    }</span>
<a href="#l2.615"></a><span id="l2.615" class="difflineminus">-</span>
<a href="#l2.616"></a><span id="l2.616" class="difflineminus">-    nsCAutoString   str;</span>
<a href="#l2.617"></a><span id="l2.617" class="difflineminus">-    BookmarkField   *field;</span>
<a href="#l2.618"></a><span id="l2.618" class="difflineminus">-    for (field = gBookmarkFieldTable; field-&gt;mName; ++field)</span>
<a href="#l2.619"></a><span id="l2.619" class="difflineminus">-    {</span>
<a href="#l2.620"></a><span id="l2.620" class="difflineminus">-        str = field-&gt;mPropertyName;</span>
<a href="#l2.621"></a><span id="l2.621" class="difflineminus">-        rv = gRDF-&gt;GetResource(str, &amp;field-&gt;mProperty);</span>
<a href="#l2.622"></a><span id="l2.622" class="difflineminus">-        if (NS_FAILED(rv))  return rv;</span>
<a href="#l2.623"></a><span id="l2.623" class="difflineminus">-    }</span>
<a href="#l2.624"></a><span id="l2.624" class="difflineminus">-    for (field = gBookmarkHeaderFieldTable; field-&gt;mName; ++field)</span>
<a href="#l2.625"></a><span id="l2.625" class="difflineminus">-    {</span>
<a href="#l2.626"></a><span id="l2.626" class="difflineminus">-        str = field-&gt;mPropertyName;</span>
<a href="#l2.627"></a><span id="l2.627" class="difflineminus">-        rv = gRDF-&gt;GetResource(str, &amp;field-&gt;mProperty);</span>
<a href="#l2.628"></a><span id="l2.628" class="difflineminus">-        if (NS_FAILED(rv))  return rv;</span>
<a href="#l2.629"></a><span id="l2.629" class="difflineminus">-    }</span>
<a href="#l2.630"></a><span id="l2.630" class="difflineminus">-</span>
<a href="#l2.631"></a><span id="l2.631" class="difflineminus">-    if (aFile)</span>
<a href="#l2.632"></a><span id="l2.632" class="difflineminus">-    {</span>
<a href="#l2.633"></a><span id="l2.633" class="difflineminus">-        PRInt64 contentsLen;</span>
<a href="#l2.634"></a><span id="l2.634" class="difflineminus">-        rv = aFile-&gt;GetFileSize(&amp;contentsLen);</span>
<a href="#l2.635"></a><span id="l2.635" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.636"></a><span id="l2.636" class="difflineminus">-</span>
<a href="#l2.637"></a><span id="l2.637" class="difflineminus">-        if(LL_CMP(contentsLen, &gt;, LL_INIT(0,0xFFFFFFFE)))</span>
<a href="#l2.638"></a><span id="l2.638" class="difflineminus">-            return NS_ERROR_FILE_TOO_BIG;</span>
<a href="#l2.639"></a><span id="l2.639" class="difflineminus">-</span>
<a href="#l2.640"></a><span id="l2.640" class="difflineminus">-        LL_L2UI(mContentsLen, contentsLen);</span>
<a href="#l2.641"></a><span id="l2.641" class="difflineminus">-</span>
<a href="#l2.642"></a><span id="l2.642" class="difflineminus">-        if (mContentsLen &gt; 0)</span>
<a href="#l2.643"></a><span id="l2.643" class="difflineminus">-        {</span>
<a href="#l2.644"></a><span id="l2.644" class="difflineminus">-            mContents = new char [mContentsLen + 1];</span>
<a href="#l2.645"></a><span id="l2.645" class="difflineminus">-            if (mContents)</span>
<a href="#l2.646"></a><span id="l2.646" class="difflineminus">-            {</span>
<a href="#l2.647"></a><span id="l2.647" class="difflineminus">-                nsCOMPtr&lt;nsIInputStream&gt; inputStream;</span>
<a href="#l2.648"></a><span id="l2.648" class="difflineminus">-                rv = NS_NewLocalFileInputStream(getter_AddRefs(inputStream),</span>
<a href="#l2.649"></a><span id="l2.649" class="difflineminus">-                                                aFile,</span>
<a href="#l2.650"></a><span id="l2.650" class="difflineminus">-                                                PR_RDONLY,</span>
<a href="#l2.651"></a><span id="l2.651" class="difflineminus">-                                                -1, 0);</span>
<a href="#l2.652"></a><span id="l2.652" class="difflineminus">-</span>
<a href="#l2.653"></a><span id="l2.653" class="difflineminus">-                if (NS_FAILED(rv))</span>
<a href="#l2.654"></a><span id="l2.654" class="difflineminus">-                {</span>
<a href="#l2.655"></a><span id="l2.655" class="difflineminus">-                    delete [] mContents;</span>
<a href="#l2.656"></a><span id="l2.656" class="difflineminus">-                    mContents = nsnull;</span>
<a href="#l2.657"></a><span id="l2.657" class="difflineminus">-                }</span>
<a href="#l2.658"></a><span id="l2.658" class="difflineminus">-                else</span>
<a href="#l2.659"></a><span id="l2.659" class="difflineminus">-                {</span>
<a href="#l2.660"></a><span id="l2.660" class="difflineminus">-                    PRUint32 howMany;</span>
<a href="#l2.661"></a><span id="l2.661" class="difflineminus">-                    rv = inputStream-&gt;Read(mContents, mContentsLen, &amp;howMany);</span>
<a href="#l2.662"></a><span id="l2.662" class="difflineminus">-                    if (NS_FAILED(rv))</span>
<a href="#l2.663"></a><span id="l2.663" class="difflineminus">-                    {</span>
<a href="#l2.664"></a><span id="l2.664" class="difflineminus">-                        delete [] mContents;</span>
<a href="#l2.665"></a><span id="l2.665" class="difflineminus">-                        mContents = nsnull;</span>
<a href="#l2.666"></a><span id="l2.666" class="difflineminus">-                        return NS_OK;</span>
<a href="#l2.667"></a><span id="l2.667" class="difflineminus">-                    }</span>
<a href="#l2.668"></a><span id="l2.668" class="difflineminus">-</span>
<a href="#l2.669"></a><span id="l2.669" class="difflineminus">-                    if (howMany == mContentsLen)</span>
<a href="#l2.670"></a><span id="l2.670" class="difflineminus">-                    {</span>
<a href="#l2.671"></a><span id="l2.671" class="difflineminus">-                        mContents[mContentsLen] = '\0';</span>
<a href="#l2.672"></a><span id="l2.672" class="difflineminus">-                    }</span>
<a href="#l2.673"></a><span id="l2.673" class="difflineminus">-                    else</span>
<a href="#l2.674"></a><span id="l2.674" class="difflineminus">-                    {</span>
<a href="#l2.675"></a><span id="l2.675" class="difflineminus">-                        delete [] mContents;</span>
<a href="#l2.676"></a><span id="l2.676" class="difflineminus">-                        mContents = nsnull;</span>
<a href="#l2.677"></a><span id="l2.677" class="difflineminus">-                    }</span>
<a href="#l2.678"></a><span id="l2.678" class="difflineminus">-                }                    </span>
<a href="#l2.679"></a><span id="l2.679" class="difflineminus">-            }</span>
<a href="#l2.680"></a><span id="l2.680" class="difflineminus">-        }</span>
<a href="#l2.681"></a><span id="l2.681" class="difflineminus">-</span>
<a href="#l2.682"></a><span id="l2.682" class="difflineminus">-        if (!mContents)</span>
<a href="#l2.683"></a><span id="l2.683" class="difflineminus">-        {</span>
<a href="#l2.684"></a><span id="l2.684" class="difflineminus">-            // we were unable to read in the entire bookmark file at once,</span>
<a href="#l2.685"></a><span id="l2.685" class="difflineminus">-            // so let's try reading it in a bit at a time instead</span>
<a href="#l2.686"></a><span id="l2.686" class="difflineminus">-</span>
<a href="#l2.687"></a><span id="l2.687" class="difflineminus">-            rv = NS_NewLocalFileInputStream(getter_AddRefs(mInputStream),</span>
<a href="#l2.688"></a><span id="l2.688" class="difflineminus">-                                            aFile, PR_RDONLY, -1, 0);</span>
<a href="#l2.689"></a><span id="l2.689" class="difflineminus">-            NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.690"></a><span id="l2.690" class="difflineminus">-        }</span>
<a href="#l2.691"></a><span id="l2.691" class="difflineminus">-    }</span>
<a href="#l2.692"></a><span id="l2.692" class="difflineminus">-</span>
<a href="#l2.693"></a><span id="l2.693" class="difflineminus">-    return NS_OK;</span>
<a href="#l2.694"></a><span id="l2.694" class="difflineminus">-}</span>
<a href="#l2.695"></a><span id="l2.695" class="difflineminus">-</span>
<a href="#l2.696"></a><span id="l2.696" class="difflineminus">-BookmarkParser::~BookmarkParser()</span>
<a href="#l2.697"></a><span id="l2.697" class="difflineminus">-{</span>
<a href="#l2.698"></a><span id="l2.698" class="difflineminus">-    if (mContents)</span>
<a href="#l2.699"></a><span id="l2.699" class="difflineminus">-    {</span>
<a href="#l2.700"></a><span id="l2.700" class="difflineminus">-        delete [] mContents;</span>
<a href="#l2.701"></a><span id="l2.701" class="difflineminus">-        mContents = nsnull;</span>
<a href="#l2.702"></a><span id="l2.702" class="difflineminus">-    }</span>
<a href="#l2.703"></a><span id="l2.703" class="difflineminus">-    if (mInputStream)</span>
<a href="#l2.704"></a><span id="l2.704" class="difflineminus">-    {</span>
<a href="#l2.705"></a><span id="l2.705" class="difflineminus">-        mInputStream-&gt;Close();</span>
<a href="#l2.706"></a><span id="l2.706" class="difflineminus">-    }</span>
<a href="#l2.707"></a><span id="l2.707" class="difflineminus">-    BookmarkField   *field;</span>
<a href="#l2.708"></a><span id="l2.708" class="difflineminus">-    for (field = gBookmarkFieldTable; field-&gt;mName; ++field)</span>
<a href="#l2.709"></a><span id="l2.709" class="difflineminus">-    {</span>
<a href="#l2.710"></a><span id="l2.710" class="difflineminus">-        NS_IF_RELEASE(field-&gt;mProperty);</span>
<a href="#l2.711"></a><span id="l2.711" class="difflineminus">-    }</span>
<a href="#l2.712"></a><span id="l2.712" class="difflineminus">-    for (field = gBookmarkHeaderFieldTable; field-&gt;mName; ++field)</span>
<a href="#l2.713"></a><span id="l2.713" class="difflineminus">-    {</span>
<a href="#l2.714"></a><span id="l2.714" class="difflineminus">-        NS_IF_RELEASE(field-&gt;mProperty);</span>
<a href="#l2.715"></a><span id="l2.715" class="difflineminus">-    }</span>
<a href="#l2.716"></a><span id="l2.716" class="difflineminus">-    bm_ReleaseGlobals();</span>
<a href="#l2.717"></a><span id="l2.717" class="difflineminus">-}</span>
<a href="#l2.718"></a><span id="l2.718" class="difflineminus">-</span>
<a href="#l2.719"></a><span id="l2.719" class="difflineminus">-PRInt32</span>
<a href="#l2.720"></a><span id="l2.720" class="difflineminus">-BookmarkParser::getEOL(const char *whole, PRInt32 startOffset, PRInt32 totalLength)</span>
<a href="#l2.721"></a><span id="l2.721" class="difflineminus">-{</span>
<a href="#l2.722"></a><span id="l2.722" class="difflineminus">-    PRInt32 eolOffset = -1;</span>
<a href="#l2.723"></a><span id="l2.723" class="difflineminus">-</span>
<a href="#l2.724"></a><span id="l2.724" class="difflineminus">-    while (startOffset &lt; totalLength)</span>
<a href="#l2.725"></a><span id="l2.725" class="difflineminus">-    {</span>
<a href="#l2.726"></a><span id="l2.726" class="difflineminus">-        char    c;</span>
<a href="#l2.727"></a><span id="l2.727" class="difflineminus">-        c = whole[startOffset];</span>
<a href="#l2.728"></a><span id="l2.728" class="difflineminus">-        if ((c == '\n') || (c == '\r') || (c == '\0'))</span>
<a href="#l2.729"></a><span id="l2.729" class="difflineminus">-        {</span>
<a href="#l2.730"></a><span id="l2.730" class="difflineminus">-            eolOffset = startOffset;</span>
<a href="#l2.731"></a><span id="l2.731" class="difflineminus">-            break;</span>
<a href="#l2.732"></a><span id="l2.732" class="difflineminus">-        }</span>
<a href="#l2.733"></a><span id="l2.733" class="difflineminus">-        ++startOffset;</span>
<a href="#l2.734"></a><span id="l2.734" class="difflineminus">-    }</span>
<a href="#l2.735"></a><span id="l2.735" class="difflineminus">-    return eolOffset;</span>
<a href="#l2.736"></a><span id="l2.736" class="difflineminus">-}</span>
<a href="#l2.737"></a><span id="l2.737" class="difflineminus">-</span>
<a href="#l2.738"></a><span id="l2.738" class="difflineminus">-nsresult</span>
<a href="#l2.739"></a><span id="l2.739" class="difflineminus">-BookmarkParser::DecodeBuffer(nsString &amp;line, char *buf, PRUint32 aLength)</span>
<a href="#l2.740"></a><span id="l2.740" class="difflineminus">-{</span>
<a href="#l2.741"></a><span id="l2.741" class="difflineminus">-    if (mUnicodeDecoder)</span>
<a href="#l2.742"></a><span id="l2.742" class="difflineminus">-    {</span>
<a href="#l2.743"></a><span id="l2.743" class="difflineminus">-        nsresult    rv;</span>
<a href="#l2.744"></a><span id="l2.744" class="difflineminus">-        char        *aBuffer = buf;</span>
<a href="#l2.745"></a><span id="l2.745" class="difflineminus">-        PRInt32     unicharBufLen = 0;</span>
<a href="#l2.746"></a><span id="l2.746" class="difflineminus">-        mUnicodeDecoder-&gt;GetMaxLength(aBuffer, aLength, &amp;unicharBufLen);</span>
<a href="#l2.747"></a><span id="l2.747" class="difflineminus">-        </span>
<a href="#l2.748"></a><span id="l2.748" class="difflineminus">-        nsAutoTArray&lt;PRUnichar, 256&gt; stackBuffer;</span>
<a href="#l2.749"></a><span id="l2.749" class="difflineminus">-        if (!stackBuffer.SetLength(unicharBufLen + 1))</span>
<a href="#l2.750"></a><span id="l2.750" class="difflineminus">-          return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l2.751"></a><span id="l2.751" class="difflineminus">-        </span>
<a href="#l2.752"></a><span id="l2.752" class="difflineminus">-        do</span>
<a href="#l2.753"></a><span id="l2.753" class="difflineminus">-        {</span>
<a href="#l2.754"></a><span id="l2.754" class="difflineminus">-            PRInt32     srcLength = aLength;</span>
<a href="#l2.755"></a><span id="l2.755" class="difflineminus">-            PRInt32     unicharLength = unicharBufLen;</span>
<a href="#l2.756"></a><span id="l2.756" class="difflineminus">-            PRUnichar *unichars = stackBuffer.Elements();</span>
<a href="#l2.757"></a><span id="l2.757" class="difflineminus">-            </span>
<a href="#l2.758"></a><span id="l2.758" class="difflineminus">-            rv = mUnicodeDecoder-&gt;Convert(aBuffer, &amp;srcLength, stackBuffer.Elements(), &amp;unicharLength);</span>
<a href="#l2.759"></a><span id="l2.759" class="difflineminus">-            unichars[unicharLength]=0;  //add this since the unicode converters can't be trusted to do so.</span>
<a href="#l2.760"></a><span id="l2.760" class="difflineminus">-</span>
<a href="#l2.761"></a><span id="l2.761" class="difflineminus">-            // Move the nsParser.cpp 00 -&gt; space hack to here so it won't break UCS2 file</span>
<a href="#l2.762"></a><span id="l2.762" class="difflineminus">-</span>
<a href="#l2.763"></a><span id="l2.763" class="difflineminus">-            // Hack Start</span>
<a href="#l2.764"></a><span id="l2.764" class="difflineminus">-            for(PRInt32 i=0;i&lt;unicharLength-1; i++)</span>
<a href="#l2.765"></a><span id="l2.765" class="difflineminus">-                if(0x0000 == unichars[i])   unichars[i] = 0x0020;</span>
<a href="#l2.766"></a><span id="l2.766" class="difflineminus">-            // Hack End</span>
<a href="#l2.767"></a><span id="l2.767" class="difflineminus">-</span>
<a href="#l2.768"></a><span id="l2.768" class="difflineminus">-            line.Append(unichars, unicharLength);</span>
<a href="#l2.769"></a><span id="l2.769" class="difflineminus">-            // if we failed, we consume one byte by replace it with U+FFFD</span>
<a href="#l2.770"></a><span id="l2.770" class="difflineminus">-            // and try conversion again.</span>
<a href="#l2.771"></a><span id="l2.771" class="difflineminus">-            if(NS_FAILED(rv))</span>
<a href="#l2.772"></a><span id="l2.772" class="difflineminus">-            {</span>
<a href="#l2.773"></a><span id="l2.773" class="difflineminus">-                mUnicodeDecoder-&gt;Reset();</span>
<a href="#l2.774"></a><span id="l2.774" class="difflineminus">-                line.Append( (PRUnichar)0xFFFD);</span>
<a href="#l2.775"></a><span id="l2.775" class="difflineminus">-                if(((PRUint32) (srcLength + 1)) &gt; (PRUint32)aLength)</span>
<a href="#l2.776"></a><span id="l2.776" class="difflineminus">-                    srcLength = aLength;</span>
<a href="#l2.777"></a><span id="l2.777" class="difflineminus">-                else </span>
<a href="#l2.778"></a><span id="l2.778" class="difflineminus">-                    srcLength++;</span>
<a href="#l2.779"></a><span id="l2.779" class="difflineminus">-                aBuffer += srcLength;</span>
<a href="#l2.780"></a><span id="l2.780" class="difflineminus">-                aLength -= srcLength;</span>
<a href="#l2.781"></a><span id="l2.781" class="difflineminus">-            }</span>
<a href="#l2.782"></a><span id="l2.782" class="difflineminus">-        } while (NS_FAILED(rv) &amp;&amp; (aLength &gt; 0));</span>
<a href="#l2.783"></a><span id="l2.783" class="difflineminus">-</span>
<a href="#l2.784"></a><span id="l2.784" class="difflineminus">-    }</span>
<a href="#l2.785"></a><span id="l2.785" class="difflineminus">-    else</span>
<a href="#l2.786"></a><span id="l2.786" class="difflineminus">-    {</span>
<a href="#l2.787"></a><span id="l2.787" class="difflineminus">-        CopyASCIItoUTF16(nsDependentCString(buf), line);</span>
<a href="#l2.788"></a><span id="l2.788" class="difflineminus">-    }</span>
<a href="#l2.789"></a><span id="l2.789" class="difflineminus">-    return NS_OK;</span>
<a href="#l2.790"></a><span id="l2.790" class="difflineminus">-}</span>
<a href="#l2.791"></a><span id="l2.791" class="difflineminus">-</span>
<a href="#l2.792"></a><span id="l2.792" class="difflineminus">-</span>
<a href="#l2.793"></a><span id="l2.793" class="difflineminus">-</span>
<a href="#l2.794"></a><span id="l2.794" class="difflineminus">-nsresult</span>
<a href="#l2.795"></a><span id="l2.795" class="difflineminus">-BookmarkParser::ProcessLine(nsIRDFContainer *container, nsIRDFResource *nodeType,</span>
<a href="#l2.796"></a><span id="l2.796" class="difflineminus">-            nsCOMPtr&lt;nsIRDFResource&gt; &amp;bookmarkNode, const nsString &amp;line,</span>
<a href="#l2.797"></a><span id="l2.797" class="difflineminus">-            nsString &amp;description, PRBool &amp;inDescription, PRBool &amp;isActiveFlag)</span>
<a href="#l2.798"></a><span id="l2.798" class="difflineminus">-{</span>
<a href="#l2.799"></a><span id="l2.799" class="difflineminus">-    nsresult    rv = NS_OK;</span>
<a href="#l2.800"></a><span id="l2.800" class="difflineminus">-    PRInt32     offset;</span>
<a href="#l2.801"></a><span id="l2.801" class="difflineminus">-</span>
<a href="#l2.802"></a><span id="l2.802" class="difflineminus">-    if (inDescription == PR_TRUE)</span>
<a href="#l2.803"></a><span id="l2.803" class="difflineminus">-    {</span>
<a href="#l2.804"></a><span id="l2.804" class="difflineminus">-        offset = line.FindChar('&lt;');</span>
<a href="#l2.805"></a><span id="l2.805" class="difflineminus">-        if (offset &lt; 0)</span>
<a href="#l2.806"></a><span id="l2.806" class="difflineminus">-        {</span>
<a href="#l2.807"></a><span id="l2.807" class="difflineminus">-            if (!description.IsEmpty())</span>
<a href="#l2.808"></a><span id="l2.808" class="difflineminus">-            {</span>
<a href="#l2.809"></a><span id="l2.809" class="difflineminus">-                description.Append(PRUnichar('\n'));</span>
<a href="#l2.810"></a><span id="l2.810" class="difflineminus">-            }</span>
<a href="#l2.811"></a><span id="l2.811" class="difflineminus">-            description += line;</span>
<a href="#l2.812"></a><span id="l2.812" class="difflineminus">-            return NS_OK;</span>
<a href="#l2.813"></a><span id="l2.813" class="difflineminus">-        }</span>
<a href="#l2.814"></a><span id="l2.814" class="difflineminus">-</span>
<a href="#l2.815"></a><span id="l2.815" class="difflineminus">-        Unescape(description);</span>
<a href="#l2.816"></a><span id="l2.816" class="difflineminus">-</span>
<a href="#l2.817"></a><span id="l2.817" class="difflineminus">-        if (bookmarkNode)</span>
<a href="#l2.818"></a><span id="l2.818" class="difflineminus">-        {</span>
<a href="#l2.819"></a><span id="l2.819" class="difflineminus">-            nsCOMPtr&lt;nsIRDFLiteral&gt; descLiteral;</span>
<a href="#l2.820"></a><span id="l2.820" class="difflineminus">-            if (NS_SUCCEEDED(rv = gRDF-&gt;GetLiteral(description.get(), getter_AddRefs(descLiteral))))</span>
<a href="#l2.821"></a><span id="l2.821" class="difflineminus">-            {</span>
<a href="#l2.822"></a><span id="l2.822" class="difflineminus">-                rv = mDataSource-&gt;Assert(bookmarkNode, kNC_Description, descLiteral, PR_TRUE);</span>
<a href="#l2.823"></a><span id="l2.823" class="difflineminus">-            }</span>
<a href="#l2.824"></a><span id="l2.824" class="difflineminus">-        }</span>
<a href="#l2.825"></a><span id="l2.825" class="difflineminus">-</span>
<a href="#l2.826"></a><span id="l2.826" class="difflineminus">-        inDescription = PR_FALSE;</span>
<a href="#l2.827"></a><span id="l2.827" class="difflineminus">-        description.Truncate();</span>
<a href="#l2.828"></a><span id="l2.828" class="difflineminus">-    }</span>
<a href="#l2.829"></a><span id="l2.829" class="difflineminus">-</span>
<a href="#l2.830"></a><span id="l2.830" class="difflineminus">-    if ((offset = line.Find(kHREFEquals, PR_TRUE)) &gt;= 0)</span>
<a href="#l2.831"></a><span id="l2.831" class="difflineminus">-    {</span>
<a href="#l2.832"></a><span id="l2.832" class="difflineminus">-        rv = ParseBookmarkInfo(gBookmarkFieldTable, PR_TRUE, line, container, nodeType, bookmarkNode);</span>
<a href="#l2.833"></a><span id="l2.833" class="difflineminus">-    }</span>
<a href="#l2.834"></a><span id="l2.834" class="difflineminus">-    else if ((offset = line.Find(kOpenMeta, PR_TRUE)) &gt;= 0)</span>
<a href="#l2.835"></a><span id="l2.835" class="difflineminus">-    {</span>
<a href="#l2.836"></a><span id="l2.836" class="difflineminus">-        rv = ParseMetaTag(line, getter_AddRefs(mUnicodeDecoder));</span>
<a href="#l2.837"></a><span id="l2.837" class="difflineminus">-    }</span>
<a href="#l2.838"></a><span id="l2.838" class="difflineminus">-    else if ((offset = line.Find(kOpenHeading, PR_TRUE)) &gt;= 0 &amp;&amp;</span>
<a href="#l2.839"></a><span id="l2.839" class="difflineminus">-         NS_IsAsciiDigit(line.CharAt(offset + 2)))</span>
<a href="#l2.840"></a><span id="l2.840" class="difflineminus">-    {</span>
<a href="#l2.841"></a><span id="l2.841" class="difflineminus">-        // XXX Ignore &lt;H1&gt; so that bookmarks root _is_ &lt;H1&gt;</span>
<a href="#l2.842"></a><span id="l2.842" class="difflineminus">-        if (line.CharAt(offset + 2) != PRUnichar('1'))</span>
<a href="#l2.843"></a><span id="l2.843" class="difflineminus">-        {</span>
<a href="#l2.844"></a><span id="l2.844" class="difflineminus">-            nsCOMPtr&lt;nsIRDFResource&gt;    dummy;</span>
<a href="#l2.845"></a><span id="l2.845" class="difflineminus">-            rv = ParseBookmarkInfo(gBookmarkHeaderFieldTable, PR_FALSE, line, container, nodeType, dummy);</span>
<a href="#l2.846"></a><span id="l2.846" class="difflineminus">-        }</span>
<a href="#l2.847"></a><span id="l2.847" class="difflineminus">-    }</span>
<a href="#l2.848"></a><span id="l2.848" class="difflineminus">-    else if ((offset = line.Find(kSeparator, PR_TRUE)) &gt;= 0)</span>
<a href="#l2.849"></a><span id="l2.849" class="difflineminus">-    {</span>
<a href="#l2.850"></a><span id="l2.850" class="difflineminus">-        rv = ParseBookmarkSeparator(line, container);</span>
<a href="#l2.851"></a><span id="l2.851" class="difflineminus">-    }</span>
<a href="#l2.852"></a><span id="l2.852" class="difflineminus">-    else if ((offset = line.Find(kCloseUL, PR_TRUE)) &gt;= 0 ||</span>
<a href="#l2.853"></a><span id="l2.853" class="difflineminus">-         (offset = line.Find(kCloseMenu, PR_TRUE)) &gt;= 0 ||</span>
<a href="#l2.854"></a><span id="l2.854" class="difflineminus">-         (offset = line.Find(kCloseDL, PR_TRUE)) &gt;= 0)</span>
<a href="#l2.855"></a><span id="l2.855" class="difflineminus">-    {</span>
<a href="#l2.856"></a><span id="l2.856" class="difflineminus">-        isActiveFlag = PR_FALSE;</span>
<a href="#l2.857"></a><span id="l2.857" class="difflineminus">-        return ParseHeaderEnd(line);</span>
<a href="#l2.858"></a><span id="l2.858" class="difflineminus">-    }</span>
<a href="#l2.859"></a><span id="l2.859" class="difflineminus">-    else if ((offset = line.Find(kOpenUL, PR_TRUE)) &gt;= 0 ||</span>
<a href="#l2.860"></a><span id="l2.860" class="difflineminus">-         (offset = line.Find(kOpenMenu, PR_TRUE)) &gt;= 0 ||</span>
<a href="#l2.861"></a><span id="l2.861" class="difflineminus">-         (offset = line.Find(kOpenDL, PR_TRUE)) &gt;= 0)</span>
<a href="#l2.862"></a><span id="l2.862" class="difflineminus">-    {</span>
<a href="#l2.863"></a><span id="l2.863" class="difflineminus">-        rv = ParseHeaderBegin(line, container);</span>
<a href="#l2.864"></a><span id="l2.864" class="difflineminus">-    }</span>
<a href="#l2.865"></a><span id="l2.865" class="difflineminus">-    else if ((offset = line.Find(kOpenDD, PR_TRUE)) &gt;= 0)</span>
<a href="#l2.866"></a><span id="l2.866" class="difflineminus">-    {</span>
<a href="#l2.867"></a><span id="l2.867" class="difflineminus">-        inDescription = PR_TRUE;</span>
<a href="#l2.868"></a><span id="l2.868" class="difflineminus">-        description = line;</span>
<a href="#l2.869"></a><span id="l2.869" class="difflineminus">-        description.Cut(0, offset+sizeof(kOpenDD)-1);</span>
<a href="#l2.870"></a><span id="l2.870" class="difflineminus">-    }</span>
<a href="#l2.871"></a><span id="l2.871" class="difflineminus">-    else</span>
<a href="#l2.872"></a><span id="l2.872" class="difflineminus">-    {</span>
<a href="#l2.873"></a><span id="l2.873" class="difflineminus">-        // XXX Discard the line?</span>
<a href="#l2.874"></a><span id="l2.874" class="difflineminus">-    }</span>
<a href="#l2.875"></a><span id="l2.875" class="difflineminus">-    return rv;</span>
<a href="#l2.876"></a><span id="l2.876" class="difflineminus">-}</span>
<a href="#l2.877"></a><span id="l2.877" class="difflineminus">-</span>
<a href="#l2.878"></a><span id="l2.878" class="difflineminus">-</span>
<a href="#l2.879"></a><span id="l2.879" class="difflineminus">-</span>
<a href="#l2.880"></a><span id="l2.880" class="difflineminus">-nsresult</span>
<a href="#l2.881"></a><span id="l2.881" class="difflineminus">-BookmarkParser::Parse(nsIRDFResource *aContainer, nsIRDFResource *nodeType)</span>
<a href="#l2.882"></a><span id="l2.882" class="difflineminus">-{</span>
<a href="#l2.883"></a><span id="l2.883" class="difflineminus">-    // tokenize the input stream.</span>
<a href="#l2.884"></a><span id="l2.884" class="difflineminus">-    // XXX this needs to handle quotes, etc. it'd be nice to use the real parser for this...</span>
<a href="#l2.885"></a><span id="l2.885" class="difflineminus">-</span>
<a href="#l2.886"></a><span id="l2.886" class="difflineminus">-    nsresult rv;</span>
<a href="#l2.887"></a><span id="l2.887" class="difflineminus">-    nsCOMPtr&lt;nsIRDFContainer&gt; container =</span>
<a href="#l2.888"></a><span id="l2.888" class="difflineminus">-            do_CreateInstance(kRDFContainerCID, &amp;rv);</span>
<a href="#l2.889"></a><span id="l2.889" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l2.890"></a><span id="l2.890" class="difflineminus">-</span>
<a href="#l2.891"></a><span id="l2.891" class="difflineminus">-    rv = container-&gt;Init(mDataSource, aContainer);</span>
<a href="#l2.892"></a><span id="l2.892" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l2.893"></a><span id="l2.893" class="difflineminus">-</span>
<a href="#l2.894"></a><span id="l2.894" class="difflineminus">-    nsCOMPtr&lt;nsIRDFResource&gt;    bookmarkNode = aContainer;</span>
<a href="#l2.895"></a><span id="l2.895" class="difflineminus">-    nsAutoString            description, line;</span>
<a href="#l2.896"></a><span id="l2.896" class="difflineminus">-    PRBool              isActiveFlag = PR_TRUE, inDescriptionFlag = PR_FALSE;</span>
<a href="#l2.897"></a><span id="l2.897" class="difflineminus">-</span>
<a href="#l2.898"></a><span id="l2.898" class="difflineminus">-    if ((mContents) &amp;&amp; (mContentsLen &gt; 0))</span>
<a href="#l2.899"></a><span id="l2.899" class="difflineminus">-    {</span>
<a href="#l2.900"></a><span id="l2.900" class="difflineminus">-        // we were able to read the entire bookmark file into memory, so process it</span>
<a href="#l2.901"></a><span id="l2.901" class="difflineminus">-        char                *linePtr;</span>
<a href="#l2.902"></a><span id="l2.902" class="difflineminus">-        PRInt32             eol;</span>
<a href="#l2.903"></a><span id="l2.903" class="difflineminus">-</span>
<a href="#l2.904"></a><span id="l2.904" class="difflineminus">-        while ((isActiveFlag == PR_TRUE) &amp;&amp; (mStartOffset &lt; (signed)mContentsLen))</span>
<a href="#l2.905"></a><span id="l2.905" class="difflineminus">-        {</span>
<a href="#l2.906"></a><span id="l2.906" class="difflineminus">-            linePtr = &amp;mContents[mStartOffset];</span>
<a href="#l2.907"></a><span id="l2.907" class="difflineminus">-            eol = getEOL(mContents, mStartOffset, mContentsLen);</span>
<a href="#l2.908"></a><span id="l2.908" class="difflineminus">-</span>
<a href="#l2.909"></a><span id="l2.909" class="difflineminus">-            PRInt32 aLength;</span>
<a href="#l2.910"></a><span id="l2.910" class="difflineminus">-</span>
<a href="#l2.911"></a><span id="l2.911" class="difflineminus">-            if ((eol &gt;= mStartOffset) &amp;&amp; (eol &lt; (signed)mContentsLen))</span>
<a href="#l2.912"></a><span id="l2.912" class="difflineminus">-            {</span>
<a href="#l2.913"></a><span id="l2.913" class="difflineminus">-                // mContents[eol] = '\0';</span>
<a href="#l2.914"></a><span id="l2.914" class="difflineminus">-                aLength = eol - mStartOffset;</span>
<a href="#l2.915"></a><span id="l2.915" class="difflineminus">-                mStartOffset = eol + 1;</span>
<a href="#l2.916"></a><span id="l2.916" class="difflineminus">-            }</span>
<a href="#l2.917"></a><span id="l2.917" class="difflineminus">-            else</span>
<a href="#l2.918"></a><span id="l2.918" class="difflineminus">-            {</span>
<a href="#l2.919"></a><span id="l2.919" class="difflineminus">-                aLength = mContentsLen - mStartOffset;</span>
<a href="#l2.920"></a><span id="l2.920" class="difflineminus">-                mStartOffset = mContentsLen + 1;</span>
<a href="#l2.921"></a><span id="l2.921" class="difflineminus">-                isActiveFlag = PR_FALSE;</span>
<a href="#l2.922"></a><span id="l2.922" class="difflineminus">-            }</span>
<a href="#l2.923"></a><span id="l2.923" class="difflineminus">-            if (aLength &lt; 1)    continue;</span>
<a href="#l2.924"></a><span id="l2.924" class="difflineminus">-</span>
<a href="#l2.925"></a><span id="l2.925" class="difflineminus">-            line.Truncate();</span>
<a href="#l2.926"></a><span id="l2.926" class="difflineminus">-            DecodeBuffer(line, linePtr, aLength);</span>
<a href="#l2.927"></a><span id="l2.927" class="difflineminus">-</span>
<a href="#l2.928"></a><span id="l2.928" class="difflineminus">-            rv = ProcessLine(container, nodeType, bookmarkNode,</span>
<a href="#l2.929"></a><span id="l2.929" class="difflineminus">-                line, description, inDescriptionFlag, isActiveFlag);</span>
<a href="#l2.930"></a><span id="l2.930" class="difflineminus">-            if (NS_FAILED(rv))  break;</span>
<a href="#l2.931"></a><span id="l2.931" class="difflineminus">-        }</span>
<a href="#l2.932"></a><span id="l2.932" class="difflineminus">-    }</span>
<a href="#l2.933"></a><span id="l2.933" class="difflineminus">-    else</span>
<a href="#l2.934"></a><span id="l2.934" class="difflineminus">-    {</span>
<a href="#l2.935"></a><span id="l2.935" class="difflineminus">-        NS_ENSURE_TRUE(mInputStream, NS_ERROR_NULL_POINTER);</span>
<a href="#l2.936"></a><span id="l2.936" class="difflineminus">-</span>
<a href="#l2.937"></a><span id="l2.937" class="difflineminus">-        // we were unable to read in the entire bookmark file at once,</span>
<a href="#l2.938"></a><span id="l2.938" class="difflineminus">-        // so let's try reading it in a bit at a time instead, and process it</span>
<a href="#l2.939"></a><span id="l2.939" class="difflineminus">-        nsCOMPtr&lt;nsILineInputStream&gt; lineInputStream =</span>
<a href="#l2.940"></a><span id="l2.940" class="difflineminus">-            do_QueryInterface(mInputStream);</span>
<a href="#l2.941"></a><span id="l2.941" class="difflineminus">-        NS_ENSURE_TRUE(lineInputStream, NS_NOINTERFACE);</span>
<a href="#l2.942"></a><span id="l2.942" class="difflineminus">-</span>
<a href="#l2.943"></a><span id="l2.943" class="difflineminus">-        PRBool moreData = PR_TRUE;</span>
<a href="#l2.944"></a><span id="l2.944" class="difflineminus">-</span>
<a href="#l2.945"></a><span id="l2.945" class="difflineminus">-        while(NS_SUCCEEDED(rv) &amp;&amp; isActiveFlag &amp;&amp; moreData)</span>
<a href="#l2.946"></a><span id="l2.946" class="difflineminus">-        {</span>
<a href="#l2.947"></a><span id="l2.947" class="difflineminus">-            nsCAutoString cLine;</span>
<a href="#l2.948"></a><span id="l2.948" class="difflineminus">-            rv = lineInputStream-&gt;ReadLine(cLine, &amp;moreData);</span>
<a href="#l2.949"></a><span id="l2.949" class="difflineminus">-</span>
<a href="#l2.950"></a><span id="l2.950" class="difflineminus">-            if (NS_SUCCEEDED(rv))</span>
<a href="#l2.951"></a><span id="l2.951" class="difflineminus">-            {</span>
<a href="#l2.952"></a><span id="l2.952" class="difflineminus">-                CopyASCIItoUTF16(cLine, line);</span>
<a href="#l2.953"></a><span id="l2.953" class="difflineminus">-                rv = ProcessLine(container, nodeType, bookmarkNode,</span>
<a href="#l2.954"></a><span id="l2.954" class="difflineminus">-                    line, description, inDescriptionFlag, isActiveFlag);</span>
<a href="#l2.955"></a><span id="l2.955" class="difflineminus">-            }</span>
<a href="#l2.956"></a><span id="l2.956" class="difflineminus">-        }</span>
<a href="#l2.957"></a><span id="l2.957" class="difflineminus">-    }</span>
<a href="#l2.958"></a><span id="l2.958" class="difflineminus">-    return rv;</span>
<a href="#l2.959"></a><span id="l2.959" class="difflineminus">-}</span>
<a href="#l2.960"></a><span id="l2.960" class="difflineminus">-</span>
<a href="#l2.961"></a><span id="l2.961" class="difflineminus">-nsresult</span>
<a href="#l2.962"></a><span id="l2.962" class="difflineminus">-BookmarkParser::Unescape(nsString &amp;text)</span>
<a href="#l2.963"></a><span id="l2.963" class="difflineminus">-{</span>
<a href="#l2.964"></a><span id="l2.964" class="difflineminus">-    // convert some HTML-escaped (such as &quot;&amp;lt;&quot;) values back</span>
<a href="#l2.965"></a><span id="l2.965" class="difflineminus">-</span>
<a href="#l2.966"></a><span id="l2.966" class="difflineminus">-    PRInt32     offset=0;</span>
<a href="#l2.967"></a><span id="l2.967" class="difflineminus">-</span>
<a href="#l2.968"></a><span id="l2.968" class="difflineminus">-    while((offset = text.FindChar((PRUnichar('&amp;')), offset)) &gt;= 0)</span>
<a href="#l2.969"></a><span id="l2.969" class="difflineminus">-    {</span>
<a href="#l2.970"></a><span id="l2.970" class="difflineminus">-        if (Substring(text, offset, 4).LowerCaseEqualsLiteral(&quot;&amp;lt;&quot;))</span>
<a href="#l2.971"></a><span id="l2.971" class="difflineminus">-        {</span>
<a href="#l2.972"></a><span id="l2.972" class="difflineminus">-            text.Cut(offset, 4);</span>
<a href="#l2.973"></a><span id="l2.973" class="difflineminus">-            text.Insert(PRUnichar('&lt;'), offset);</span>
<a href="#l2.974"></a><span id="l2.974" class="difflineminus">-        }</span>
<a href="#l2.975"></a><span id="l2.975" class="difflineminus">-        else if (Substring(text, offset, 4).LowerCaseEqualsLiteral(&quot;&amp;gt;&quot;))</span>
<a href="#l2.976"></a><span id="l2.976" class="difflineminus">-        {</span>
<a href="#l2.977"></a><span id="l2.977" class="difflineminus">-            text.Cut(offset, 4);</span>
<a href="#l2.978"></a><span id="l2.978" class="difflineminus">-            text.Insert(PRUnichar('&gt;'), offset);</span>
<a href="#l2.979"></a><span id="l2.979" class="difflineminus">-        }</span>
<a href="#l2.980"></a><span id="l2.980" class="difflineminus">-        else if (Substring(text, offset, 5).LowerCaseEqualsLiteral(&quot;&amp;amp;&quot;))</span>
<a href="#l2.981"></a><span id="l2.981" class="difflineminus">-        {</span>
<a href="#l2.982"></a><span id="l2.982" class="difflineminus">-            text.Cut(offset, 5);</span>
<a href="#l2.983"></a><span id="l2.983" class="difflineminus">-            text.Insert(PRUnichar('&amp;'), offset);</span>
<a href="#l2.984"></a><span id="l2.984" class="difflineminus">-        }</span>
<a href="#l2.985"></a><span id="l2.985" class="difflineminus">-        else if (Substring(text, offset, 6).LowerCaseEqualsLiteral(&quot;&amp;quot;&quot;))</span>
<a href="#l2.986"></a><span id="l2.986" class="difflineminus">-        {</span>
<a href="#l2.987"></a><span id="l2.987" class="difflineminus">-            text.Cut(offset, 6);</span>
<a href="#l2.988"></a><span id="l2.988" class="difflineminus">-            text.Insert(PRUnichar('\&quot;'), offset);</span>
<a href="#l2.989"></a><span id="l2.989" class="difflineminus">-        }</span>
<a href="#l2.990"></a><span id="l2.990" class="difflineminus">-        else if (Substring(text, offset, 5).Equals(NS_LITERAL_STRING(&quot;&amp;#39;&quot;)))</span>
<a href="#l2.991"></a><span id="l2.991" class="difflineminus">-        {</span>
<a href="#l2.992"></a><span id="l2.992" class="difflineminus">-            text.Cut(offset, 5);</span>
<a href="#l2.993"></a><span id="l2.993" class="difflineminus">-            text.Insert(PRUnichar('\''), offset);</span>
<a href="#l2.994"></a><span id="l2.994" class="difflineminus">-        }</span>
<a href="#l2.995"></a><span id="l2.995" class="difflineminus">-</span>
<a href="#l2.996"></a><span id="l2.996" class="difflineminus">-        ++offset;</span>
<a href="#l2.997"></a><span id="l2.997" class="difflineminus">-    }</span>
<a href="#l2.998"></a><span id="l2.998" class="difflineminus">-    return NS_OK;</span>
<a href="#l2.999"></a><span id="l2.999" class="difflineminus">-}</span>
<a href="#l2.1000"></a><span id="l2.1000" class="difflineminus">-</span>
<a href="#l2.1001"></a><span id="l2.1001" class="difflineminus">-nsresult</span>
<a href="#l2.1002"></a><span id="l2.1002" class="difflineminus">-BookmarkParser::ParseMetaTag(const nsString &amp;aLine, nsIUnicodeDecoder **decoder)</span>
<a href="#l2.1003"></a><span id="l2.1003" class="difflineminus">-{</span>
<a href="#l2.1004"></a><span id="l2.1004" class="difflineminus">-    nsresult    rv = NS_OK;</span>
<a href="#l2.1005"></a><span id="l2.1005" class="difflineminus">-</span>
<a href="#l2.1006"></a><span id="l2.1006" class="difflineminus">-    *decoder = nsnull;</span>
<a href="#l2.1007"></a><span id="l2.1007" class="difflineminus">-</span>
<a href="#l2.1008"></a><span id="l2.1008" class="difflineminus">-    // get the HTTP-EQUIV attribute</span>
<a href="#l2.1009"></a><span id="l2.1009" class="difflineminus">-    PRInt32 start = aLine.Find(kHTTPEquivEquals, PR_TRUE);</span>
<a href="#l2.1010"></a><span id="l2.1010" class="difflineminus">-    NS_ASSERTION(start &gt;= 0, &quot;no 'HTTP-EQUIV=\&quot;' string: how'd we get here?&quot;);</span>
<a href="#l2.1011"></a><span id="l2.1011" class="difflineminus">-    if (start &lt; 0)  return NS_ERROR_UNEXPECTED;</span>
<a href="#l2.1012"></a><span id="l2.1012" class="difflineminus">-    // Skip past the first double-quote</span>
<a href="#l2.1013"></a><span id="l2.1013" class="difflineminus">-    start += (sizeof(kHTTPEquivEquals) - 1);</span>
<a href="#l2.1014"></a><span id="l2.1014" class="difflineminus">-    // ...and find the next so we can chop the HTTP-EQUIV attribute</span>
<a href="#l2.1015"></a><span id="l2.1015" class="difflineminus">-    PRInt32 end = aLine.FindChar(PRUnichar('&quot;'), start);</span>
<a href="#l2.1016"></a><span id="l2.1016" class="difflineminus">-    nsAutoString httpEquiv(Substring(aLine, start, end - start));</span>
<a href="#l2.1017"></a><span id="l2.1017" class="difflineminus">-</span>
<a href="#l2.1018"></a><span id="l2.1018" class="difflineminus">-    // if HTTP-EQUIV isn't &quot;Content-Type&quot;, just ignore the META tag</span>
<a href="#l2.1019"></a><span id="l2.1019" class="difflineminus">-    if (!httpEquiv.LowerCaseEqualsLiteral(&quot;content-type&quot;))</span>
<a href="#l2.1020"></a><span id="l2.1020" class="difflineminus">-        return NS_OK;</span>
<a href="#l2.1021"></a><span id="l2.1021" class="difflineminus">-</span>
<a href="#l2.1022"></a><span id="l2.1022" class="difflineminus">-    // get the CONTENT attribute</span>
<a href="#l2.1023"></a><span id="l2.1023" class="difflineminus">-    start = aLine.Find(kContentEquals, PR_TRUE);</span>
<a href="#l2.1024"></a><span id="l2.1024" class="difflineminus">-    NS_ASSERTION(start &gt;= 0, &quot;no 'CONTENT=\&quot;' string: how'd we get here?&quot;);</span>
<a href="#l2.1025"></a><span id="l2.1025" class="difflineminus">-    if (start &lt; 0)  return NS_ERROR_UNEXPECTED;</span>
<a href="#l2.1026"></a><span id="l2.1026" class="difflineminus">-    // Skip past the first double-quote</span>
<a href="#l2.1027"></a><span id="l2.1027" class="difflineminus">-    start += (sizeof(kContentEquals) - 1);</span>
<a href="#l2.1028"></a><span id="l2.1028" class="difflineminus">-    // ...and find the next so we can chop the CONTENT attribute</span>
<a href="#l2.1029"></a><span id="l2.1029" class="difflineminus">-    end = aLine.FindChar(PRUnichar('&quot;'), start);</span>
<a href="#l2.1030"></a><span id="l2.1030" class="difflineminus">-    nsAutoString content(Substring(aLine, start, end - start));</span>
<a href="#l2.1031"></a><span id="l2.1031" class="difflineminus">-</span>
<a href="#l2.1032"></a><span id="l2.1032" class="difflineminus">-    // look for the charset value</span>
<a href="#l2.1033"></a><span id="l2.1033" class="difflineminus">-    start = content.Find(kCharsetEquals, PR_TRUE);</span>
<a href="#l2.1034"></a><span id="l2.1034" class="difflineminus">-    NS_ASSERTION(start &gt;= 0, &quot;no 'charset=' string: how'd we get here?&quot;);</span>
<a href="#l2.1035"></a><span id="l2.1035" class="difflineminus">-    if (start &lt; 0)  return NS_ERROR_UNEXPECTED;</span>
<a href="#l2.1036"></a><span id="l2.1036" class="difflineminus">-    start += (sizeof(kCharsetEquals)-1);</span>
<a href="#l2.1037"></a><span id="l2.1037" class="difflineminus">-</span>
<a href="#l2.1038"></a><span id="l2.1038" class="difflineminus">-    NS_LossyConvertUTF16toASCII charset(Substring(content, start,</span>
<a href="#l2.1039"></a><span id="l2.1039" class="difflineminus">-                                                  content.Length() - start));</span>
<a href="#l2.1040"></a><span id="l2.1040" class="difflineminus">-    if (charset.Length() &lt; 1)   return NS_ERROR_UNEXPECTED;</span>
<a href="#l2.1041"></a><span id="l2.1041" class="difflineminus">-</span>
<a href="#l2.1042"></a><span id="l2.1042" class="difflineminus">-    // found a charset, now try and get a decoder from it to Unicode</span>
<a href="#l2.1043"></a><span id="l2.1043" class="difflineminus">-    nsICharsetConverterManager *charsetConv;</span>
<a href="#l2.1044"></a><span id="l2.1044" class="difflineminus">-    rv = CallGetService(NS_CHARSETCONVERTERMANAGER_CONTRACTID, &amp;charsetConv);</span>
<a href="#l2.1045"></a><span id="l2.1045" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l2.1046"></a><span id="l2.1046" class="difflineminus">-    {</span>
<a href="#l2.1047"></a><span id="l2.1047" class="difflineminus">-        rv = charsetConv-&gt;GetUnicodeDecoderRaw(charset.get(), decoder);</span>
<a href="#l2.1048"></a><span id="l2.1048" class="difflineminus">-        NS_RELEASE(charsetConv);</span>
<a href="#l2.1049"></a><span id="l2.1049" class="difflineminus">-    }</span>
<a href="#l2.1050"></a><span id="l2.1050" class="difflineminus">-    return rv;</span>
<a href="#l2.1051"></a><span id="l2.1051" class="difflineminus">-}</span>
<a href="#l2.1052"></a><span id="l2.1052" class="difflineminus">-</span>
<a href="#l2.1053"></a><span id="l2.1053" class="difflineminus">-BookmarkParser::BookmarkField</span>
<a href="#l2.1054"></a><span id="l2.1054" class="difflineminus">-BookmarkParser::gBookmarkFieldTable[] =</span>
<a href="#l2.1055"></a><span id="l2.1055" class="difflineminus">-{</span>
<a href="#l2.1056"></a><span id="l2.1056" class="difflineminus">-  // Note: the first entry MUST be the ID/resource of the bookmark</span>
<a href="#l2.1057"></a><span id="l2.1057" class="difflineminus">-  { kIDEquals,              NC_NAMESPACE_URI  &quot;ID&quot;,                nsnull,  BookmarkParser::ParseResource,  nsnull },</span>
<a href="#l2.1058"></a><span id="l2.1058" class="difflineminus">-  { kHREFEquals,            NC_NAMESPACE_URI  &quot;URL&quot;,               nsnull,  BookmarkParser::ParseLiteral,   nsnull },</span>
<a href="#l2.1059"></a><span id="l2.1059" class="difflineminus">-  { kAddDateEquals,         NC_NAMESPACE_URI  &quot;BookmarkAddDate&quot;,   nsnull,  BookmarkParser::ParseDate,      nsnull },</span>
<a href="#l2.1060"></a><span id="l2.1060" class="difflineminus">-  { kLastVisitEquals,       WEB_NAMESPACE_URI &quot;LastVisitDate&quot;,     nsnull,  BookmarkParser::ParseDate,      nsnull },</span>
<a href="#l2.1061"></a><span id="l2.1061" class="difflineminus">-  { kLastModifiedEquals,    WEB_NAMESPACE_URI &quot;LastModifiedDate&quot;,  nsnull,  BookmarkParser::ParseDate,      nsnull },</span>
<a href="#l2.1062"></a><span id="l2.1062" class="difflineminus">-  { kShortcutURLEquals,     NC_NAMESPACE_URI  &quot;ShortcutURL&quot;,       nsnull,  BookmarkParser::ParseLiteral,   nsnull },</span>
<a href="#l2.1063"></a><span id="l2.1063" class="difflineminus">-  { kIconEquals,            NC_NAMESPACE_URI  &quot;Icon&quot;,              nsnull,  BookmarkParser::ParseLiteral,   nsnull },</span>
<a href="#l2.1064"></a><span id="l2.1064" class="difflineminus">-  { kLastCharsetEquals,     WEB_NAMESPACE_URI &quot;LastCharset&quot;,       nsnull,  BookmarkParser::ParseLiteral,   nsnull },</span>
<a href="#l2.1065"></a><span id="l2.1065" class="difflineminus">-  { kScheduleEquals,        WEB_NAMESPACE_URI &quot;Schedule&quot;,          nsnull,  BookmarkParser::ParseLiteral,   nsnull },</span>
<a href="#l2.1066"></a><span id="l2.1066" class="difflineminus">-  { kLastPingEquals,        WEB_NAMESPACE_URI &quot;LastPingDate&quot;,      nsnull,  BookmarkParser::ParseDate,      nsnull },</span>
<a href="#l2.1067"></a><span id="l2.1067" class="difflineminus">-  { kPingETagEquals,        WEB_NAMESPACE_URI &quot;LastPingETag&quot;,      nsnull,  BookmarkParser::ParseLiteral,   nsnull },</span>
<a href="#l2.1068"></a><span id="l2.1068" class="difflineminus">-  { kPingLastModEquals,     WEB_NAMESPACE_URI &quot;LastPingModDate&quot;,   nsnull,  BookmarkParser::ParseLiteral,   nsnull },</span>
<a href="#l2.1069"></a><span id="l2.1069" class="difflineminus">-  { kPingContentLenEquals,  WEB_NAMESPACE_URI &quot;LastPingContentLen&quot;,nsnull,  BookmarkParser::ParseLiteral,   nsnull },</span>
<a href="#l2.1070"></a><span id="l2.1070" class="difflineminus">-  { kPingStatusEquals,      WEB_NAMESPACE_URI &quot;status&quot;,            nsnull,  BookmarkParser::ParseLiteral,   nsnull },</span>
<a href="#l2.1071"></a><span id="l2.1071" class="difflineminus">-  // Note: end of table</span>
<a href="#l2.1072"></a><span id="l2.1072" class="difflineminus">-  { nsnull,                 nsnull,                                nsnull,  nsnull,                         nsnull },</span>
<a href="#l2.1073"></a><span id="l2.1073" class="difflineminus">-};</span>
<a href="#l2.1074"></a><span id="l2.1074" class="difflineminus">-</span>
<a href="#l2.1075"></a><span id="l2.1075" class="difflineminus">-BookmarkParser::BookmarkField</span>
<a href="#l2.1076"></a><span id="l2.1076" class="difflineminus">-BookmarkParser::gBookmarkHeaderFieldTable[] =</span>
<a href="#l2.1077"></a><span id="l2.1077" class="difflineminus">-{</span>
<a href="#l2.1078"></a><span id="l2.1078" class="difflineminus">-  // Note: the first entry MUST be the ID/resource of the bookmark</span>
<a href="#l2.1079"></a><span id="l2.1079" class="difflineminus">-  { kIDEquals,                    NC_NAMESPACE_URI  &quot;ID&quot;,                nsnull,  BookmarkParser::ParseResource,  nsnull },</span>
<a href="#l2.1080"></a><span id="l2.1080" class="difflineminus">-  { kAddDateEquals,               NC_NAMESPACE_URI  &quot;BookmarkAddDate&quot;,   nsnull,  BookmarkParser::ParseDate,      nsnull },</span>
<a href="#l2.1081"></a><span id="l2.1081" class="difflineminus">-  { kLastModifiedEquals,          WEB_NAMESPACE_URI &quot;LastModifiedDate&quot;,  nsnull,  BookmarkParser::ParseDate,      nsnull },</span>
<a href="#l2.1082"></a><span id="l2.1082" class="difflineminus">-  { kFolderGroupEquals,           NC_NAMESPACE_URI  &quot;FolderGroup&quot;,       nsnull,  BookmarkParser::ParseLiteral,   nsnull },</span>
<a href="#l2.1083"></a><span id="l2.1083" class="difflineminus">-  // Note: these last three are specially handled</span>
<a href="#l2.1084"></a><span id="l2.1084" class="difflineminus">-  { kNewBookmarkFolderEquals,     kURINC_NewBookmarkFolder,              nsnull,  BookmarkParser::ParseLiteral,   nsnull },</span>
<a href="#l2.1085"></a><span id="l2.1085" class="difflineminus">-  { kNewSearchFolderEquals,       kURINC_NewSearchFolder,                nsnull,  BookmarkParser::ParseLiteral,   nsnull },</span>
<a href="#l2.1086"></a><span id="l2.1086" class="difflineminus">-  { kPersonalToolbarFolderEquals, kURINC_PersonalToolbarFolder,          nsnull,  BookmarkParser::ParseLiteral,   nsnull },</span>
<a href="#l2.1087"></a><span id="l2.1087" class="difflineminus">-  // Note: end of table</span>
<a href="#l2.1088"></a><span id="l2.1088" class="difflineminus">-  { nsnull,                       nsnull,                                nsnull,  nsnull,                         nsnull },</span>
<a href="#l2.1089"></a><span id="l2.1089" class="difflineminus">-};</span>
<a href="#l2.1090"></a><span id="l2.1090" class="difflineminus">-</span>
<a href="#l2.1091"></a><span id="l2.1091" class="difflineminus">-nsresult</span>
<a href="#l2.1092"></a><span id="l2.1092" class="difflineminus">-BookmarkParser::ParseBookmarkInfo(BookmarkField *fields, PRBool isBookmarkFlag,</span>
<a href="#l2.1093"></a><span id="l2.1093" class="difflineminus">-                const nsString &amp;aLine, const nsCOMPtr&lt;nsIRDFContainer&gt; &amp;aContainer,</span>
<a href="#l2.1094"></a><span id="l2.1094" class="difflineminus">-                nsIRDFResource *nodeType, nsCOMPtr&lt;nsIRDFResource&gt; &amp;bookmarkNode)</span>
<a href="#l2.1095"></a><span id="l2.1095" class="difflineminus">-{</span>
<a href="#l2.1096"></a><span id="l2.1096" class="difflineminus">-    NS_PRECONDITION(aContainer != nsnull, &quot;null ptr&quot;);</span>
<a href="#l2.1097"></a><span id="l2.1097" class="difflineminus">-    if (! aContainer)</span>
<a href="#l2.1098"></a><span id="l2.1098" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l2.1099"></a><span id="l2.1099" class="difflineminus">-</span>
<a href="#l2.1100"></a><span id="l2.1100" class="difflineminus">-    bookmarkNode = nsnull;</span>
<a href="#l2.1101"></a><span id="l2.1101" class="difflineminus">-</span>
<a href="#l2.1102"></a><span id="l2.1102" class="difflineminus">-    PRInt32     lineLen = aLine.Length();</span>
<a href="#l2.1103"></a><span id="l2.1103" class="difflineminus">-</span>
<a href="#l2.1104"></a><span id="l2.1104" class="difflineminus">-    PRInt32     attrStart=0;</span>
<a href="#l2.1105"></a><span id="l2.1105" class="difflineminus">-    if (isBookmarkFlag == PR_TRUE)</span>
<a href="#l2.1106"></a><span id="l2.1106" class="difflineminus">-    {</span>
<a href="#l2.1107"></a><span id="l2.1107" class="difflineminus">-        attrStart = aLine.Find(kOpenAnchor, PR_TRUE, attrStart);</span>
<a href="#l2.1108"></a><span id="l2.1108" class="difflineminus">-        if (attrStart &lt; 0)  return NS_ERROR_UNEXPECTED;</span>
<a href="#l2.1109"></a><span id="l2.1109" class="difflineminus">-        attrStart += sizeof(kOpenAnchor)-1;</span>
<a href="#l2.1110"></a><span id="l2.1110" class="difflineminus">-    }</span>
<a href="#l2.1111"></a><span id="l2.1111" class="difflineminus">-    else</span>
<a href="#l2.1112"></a><span id="l2.1112" class="difflineminus">-    {</span>
<a href="#l2.1113"></a><span id="l2.1113" class="difflineminus">-        attrStart = aLine.Find(kOpenHeading, PR_TRUE, attrStart);</span>
<a href="#l2.1114"></a><span id="l2.1114" class="difflineminus">-        if (attrStart &lt; 0)  return NS_ERROR_UNEXPECTED;</span>
<a href="#l2.1115"></a><span id="l2.1115" class="difflineminus">-        attrStart += sizeof(kOpenHeading)-1;</span>
<a href="#l2.1116"></a><span id="l2.1116" class="difflineminus">-    }</span>
<a href="#l2.1117"></a><span id="l2.1117" class="difflineminus">-</span>
<a href="#l2.1118"></a><span id="l2.1118" class="difflineminus">-    // free up any allocated data in field table BEFORE processing</span>
<a href="#l2.1119"></a><span id="l2.1119" class="difflineminus">-    for (BookmarkField *preField = fields; preField-&gt;mName; ++preField)</span>
<a href="#l2.1120"></a><span id="l2.1120" class="difflineminus">-    {</span>
<a href="#l2.1121"></a><span id="l2.1121" class="difflineminus">-        NS_IF_RELEASE(preField-&gt;mValue);</span>
<a href="#l2.1122"></a><span id="l2.1122" class="difflineminus">-    }</span>
<a href="#l2.1123"></a><span id="l2.1123" class="difflineminus">-</span>
<a href="#l2.1124"></a><span id="l2.1124" class="difflineminus">-    // loop over attributes</span>
<a href="#l2.1125"></a><span id="l2.1125" class="difflineminus">-    while((attrStart &lt; lineLen) &amp;&amp; (aLine[attrStart] != '&gt;'))</span>
<a href="#l2.1126"></a><span id="l2.1126" class="difflineminus">-    {</span>
<a href="#l2.1127"></a><span id="l2.1127" class="difflineminus">-        while(NS_IsAsciiWhitespace(aLine[attrStart]))   ++attrStart;</span>
<a href="#l2.1128"></a><span id="l2.1128" class="difflineminus">-</span>
<a href="#l2.1129"></a><span id="l2.1129" class="difflineminus">-        PRBool  fieldFound = PR_FALSE;</span>
<a href="#l2.1130"></a><span id="l2.1130" class="difflineminus">-</span>
<a href="#l2.1131"></a><span id="l2.1131" class="difflineminus">-        NS_ConvertASCIItoUTF16 id(kIDEquals);</span>
<a href="#l2.1132"></a><span id="l2.1132" class="difflineminus">-        for (BookmarkField *field = fields; field-&gt;mName; ++field)</span>
<a href="#l2.1133"></a><span id="l2.1133" class="difflineminus">-        {</span>
<a href="#l2.1134"></a><span id="l2.1134" class="difflineminus">-            NS_ConvertASCIItoUTF16 name(field-&gt;mName);</span>
<a href="#l2.1135"></a><span id="l2.1135" class="difflineminus">-            if (mIsImportOperation &amp;&amp; name.Equals(id)) </span>
<a href="#l2.1136"></a><span id="l2.1136" class="difflineminus">-                // For import operations, we don't want to save the unique identifier for folders,</span>
<a href="#l2.1137"></a><span id="l2.1137" class="difflineminus">-                // because this can cause bugs like 74969 (importing duplicate bookmark folder </span>
<a href="#l2.1138"></a><span id="l2.1138" class="difflineminus">-                // hierachy causes bookmarks file to grow infinitely).</span>
<a href="#l2.1139"></a><span id="l2.1139" class="difflineminus">-                continue;</span>
<a href="#l2.1140"></a><span id="l2.1140" class="difflineminus">-  </span>
<a href="#l2.1141"></a><span id="l2.1141" class="difflineminus">-            if (Substring(aLine, attrStart,</span>
<a href="#l2.1142"></a><span id="l2.1142" class="difflineminus">-                          name.Length()).Equals(name, CaseInsensitiveCompare))</span>
<a href="#l2.1143"></a><span id="l2.1143" class="difflineminus">-            {</span>
<a href="#l2.1144"></a><span id="l2.1144" class="difflineminus">-                attrStart += strlen(field-&gt;mName);</span>
<a href="#l2.1145"></a><span id="l2.1145" class="difflineminus">-</span>
<a href="#l2.1146"></a><span id="l2.1146" class="difflineminus">-                // skip to terminating quote of string</span>
<a href="#l2.1147"></a><span id="l2.1147" class="difflineminus">-                PRInt32 termQuote = aLine.FindChar(PRUnichar('\&quot;'), attrStart);</span>
<a href="#l2.1148"></a><span id="l2.1148" class="difflineminus">-                if (termQuote &gt; attrStart)</span>
<a href="#l2.1149"></a><span id="l2.1149" class="difflineminus">-                {</span>
<a href="#l2.1150"></a><span id="l2.1150" class="difflineminus">-                    // process data</span>
<a href="#l2.1151"></a><span id="l2.1151" class="difflineminus">-                    nsAutoString data(Substring(aLine, attrStart,</span>
<a href="#l2.1152"></a><span id="l2.1152" class="difflineminus">-                                                termQuote - attrStart));</span>
<a href="#l2.1153"></a><span id="l2.1153" class="difflineminus">-</span>
<a href="#l2.1154"></a><span id="l2.1154" class="difflineminus">-                    attrStart = termQuote + 1;</span>
<a href="#l2.1155"></a><span id="l2.1155" class="difflineminus">-                    fieldFound = PR_TRUE;</span>
<a href="#l2.1156"></a><span id="l2.1156" class="difflineminus">-</span>
<a href="#l2.1157"></a><span id="l2.1157" class="difflineminus">-                    if (!data.IsEmpty())</span>
<a href="#l2.1158"></a><span id="l2.1158" class="difflineminus">-                    {</span>
<a href="#l2.1159"></a><span id="l2.1159" class="difflineminus">-                        // XXX Bug 58421 We should not ever hit this assertion</span>
<a href="#l2.1160"></a><span id="l2.1160" class="difflineminus">-                        NS_ASSERTION(!field-&gt;mValue, &quot;Field already has a value&quot;);</span>
<a href="#l2.1161"></a><span id="l2.1161" class="difflineminus">-                        // but prevent a leak if we do hit it</span>
<a href="#l2.1162"></a><span id="l2.1162" class="difflineminus">-                        NS_IF_RELEASE(field-&gt;mValue);</span>
<a href="#l2.1163"></a><span id="l2.1163" class="difflineminus">-</span>
<a href="#l2.1164"></a><span id="l2.1164" class="difflineminus">-                        nsresult rv = (*field-&gt;mParse)(field-&gt;mProperty, data, &amp;field-&gt;mValue);</span>
<a href="#l2.1165"></a><span id="l2.1165" class="difflineminus">-                        if (NS_FAILED(rv)) break;</span>
<a href="#l2.1166"></a><span id="l2.1166" class="difflineminus">-                    }</span>
<a href="#l2.1167"></a><span id="l2.1167" class="difflineminus">-                }</span>
<a href="#l2.1168"></a><span id="l2.1168" class="difflineminus">-                break;</span>
<a href="#l2.1169"></a><span id="l2.1169" class="difflineminus">-            }</span>
<a href="#l2.1170"></a><span id="l2.1170" class="difflineminus">-        }</span>
<a href="#l2.1171"></a><span id="l2.1171" class="difflineminus">-</span>
<a href="#l2.1172"></a><span id="l2.1172" class="difflineminus">-        if (fieldFound == PR_FALSE)</span>
<a href="#l2.1173"></a><span id="l2.1173" class="difflineminus">-        {</span>
<a href="#l2.1174"></a><span id="l2.1174" class="difflineminus">-            // skip to next attribute</span>
<a href="#l2.1175"></a><span id="l2.1175" class="difflineminus">-            while((attrStart &lt; lineLen) &amp;&amp; (aLine[attrStart] != '&gt;') &amp;&amp;</span>
<a href="#l2.1176"></a><span id="l2.1176" class="difflineminus">-                (!NS_IsAsciiWhitespace(aLine[attrStart])))</span>
<a href="#l2.1177"></a><span id="l2.1177" class="difflineminus">-            {</span>
<a href="#l2.1178"></a><span id="l2.1178" class="difflineminus">-                ++attrStart;</span>
<a href="#l2.1179"></a><span id="l2.1179" class="difflineminus">-            }</span>
<a href="#l2.1180"></a><span id="l2.1180" class="difflineminus">-        }</span>
<a href="#l2.1181"></a><span id="l2.1181" class="difflineminus">-    }</span>
<a href="#l2.1182"></a><span id="l2.1182" class="difflineminus">-</span>
<a href="#l2.1183"></a><span id="l2.1183" class="difflineminus">-    nsresult    rv;</span>
<a href="#l2.1184"></a><span id="l2.1184" class="difflineminus">-</span>
<a href="#l2.1185"></a><span id="l2.1185" class="difflineminus">-    // Note: the first entry MUST be the ID/resource of the bookmark</span>
<a href="#l2.1186"></a><span id="l2.1186" class="difflineminus">-    nsCOMPtr&lt;nsIRDFResource&gt; bookmark = do_QueryInterface(fields[0].mValue);</span>
<a href="#l2.1187"></a><span id="l2.1187" class="difflineminus">-    if (!bookmark)</span>
<a href="#l2.1188"></a><span id="l2.1188" class="difflineminus">-    {</span>
<a href="#l2.1189"></a><span id="l2.1189" class="difflineminus">-        // We've never seen this bookmark/folder before. Assign it an anonymous ID</span>
<a href="#l2.1190"></a><span id="l2.1190" class="difflineminus">-        rv = gRDF-&gt;GetAnonymousResource(getter_AddRefs(bookmark));</span>
<a href="#l2.1191"></a><span id="l2.1191" class="difflineminus">-        NS_ASSERTION(NS_SUCCEEDED(rv), &quot;unable to create anonymous resource for folder&quot;);</span>
<a href="#l2.1192"></a><span id="l2.1192" class="difflineminus">-    }</span>
<a href="#l2.1193"></a><span id="l2.1193" class="difflineminus">-    else if (bookmark.get() == kNC_PersonalToolbarFolder)</span>
<a href="#l2.1194"></a><span id="l2.1194" class="difflineminus">-    {</span>
<a href="#l2.1195"></a><span id="l2.1195" class="difflineminus">-        mFoundPersonalToolbarFolder = PR_TRUE;</span>
<a href="#l2.1196"></a><span id="l2.1196" class="difflineminus">-    }</span>
<a href="#l2.1197"></a><span id="l2.1197" class="difflineminus">-</span>
<a href="#l2.1198"></a><span id="l2.1198" class="difflineminus">-    if (bookmark)</span>
<a href="#l2.1199"></a><span id="l2.1199" class="difflineminus">-    {</span>
<a href="#l2.1200"></a><span id="l2.1200" class="difflineminus">-        const char* bookmarkURI;</span>
<a href="#l2.1201"></a><span id="l2.1201" class="difflineminus">-        bookmark-&gt;GetValueConst(&amp;bookmarkURI);</span>
<a href="#l2.1202"></a><span id="l2.1202" class="difflineminus">-</span>
<a href="#l2.1203"></a><span id="l2.1203" class="difflineminus">-        bookmarkNode = bookmark;</span>
<a href="#l2.1204"></a><span id="l2.1204" class="difflineminus">-</span>
<a href="#l2.1205"></a><span id="l2.1205" class="difflineminus">-        // assert appropriate node type</span>
<a href="#l2.1206"></a><span id="l2.1206" class="difflineminus">-        PRBool isIEFavoriteRoot = PR_FALSE;</span>
<a href="#l2.1207"></a><span id="l2.1207" class="difflineminus">-        if (!mIEFavoritesRoot.IsEmpty())</span>
<a href="#l2.1208"></a><span id="l2.1208" class="difflineminus">-        {</span>
<a href="#l2.1209"></a><span id="l2.1209" class="difflineminus">-            if (!strcmp(mIEFavoritesRoot.get(), bookmarkURI))</span>
<a href="#l2.1210"></a><span id="l2.1210" class="difflineminus">-            {</span>
<a href="#l2.1211"></a><span id="l2.1211" class="difflineminus">-                mFoundIEFavoritesRoot = PR_TRUE;</span>
<a href="#l2.1212"></a><span id="l2.1212" class="difflineminus">-                isIEFavoriteRoot = PR_TRUE;</span>
<a href="#l2.1213"></a><span id="l2.1213" class="difflineminus">-            }</span>
<a href="#l2.1214"></a><span id="l2.1214" class="difflineminus">-        }</span>
<a href="#l2.1215"></a><span id="l2.1215" class="difflineminus">-        if ((isIEFavoriteRoot == PR_TRUE) || ((nodeType == kNC_IEFavorite) &amp;&amp; (isBookmarkFlag == PR_FALSE)))</span>
<a href="#l2.1216"></a><span id="l2.1216" class="difflineminus">-        {</span>
<a href="#l2.1217"></a><span id="l2.1217" class="difflineminus">-            rv = mDataSource-&gt;Assert(bookmark, kRDF_type, kNC_IEFavoriteFolder, PR_TRUE);</span>
<a href="#l2.1218"></a><span id="l2.1218" class="difflineminus">-        }</span>
<a href="#l2.1219"></a><span id="l2.1219" class="difflineminus">-        else if (nodeType == kNC_IEFavorite ||</span>
<a href="#l2.1220"></a><span id="l2.1220" class="difflineminus">-                 nodeType == kNC_IEFavoriteFolder ||</span>
<a href="#l2.1221"></a><span id="l2.1221" class="difflineminus">-                 nodeType == kNC_BookmarkSeparator)</span>
<a href="#l2.1222"></a><span id="l2.1222" class="difflineminus">-        {</span>
<a href="#l2.1223"></a><span id="l2.1223" class="difflineminus">-            rv = mDataSource-&gt;Assert(bookmark, kRDF_type, nodeType, PR_TRUE);</span>
<a href="#l2.1224"></a><span id="l2.1224" class="difflineminus">-        }</span>
<a href="#l2.1225"></a><span id="l2.1225" class="difflineminus">-</span>
<a href="#l2.1226"></a><span id="l2.1226" class="difflineminus">-        // process data</span>
<a href="#l2.1227"></a><span id="l2.1227" class="difflineminus">-        for (BookmarkField *field = fields; field-&gt;mName; ++field)</span>
<a href="#l2.1228"></a><span id="l2.1228" class="difflineminus">-        {</span>
<a href="#l2.1229"></a><span id="l2.1229" class="difflineminus">-            if (field-&gt;mValue)</span>
<a href="#l2.1230"></a><span id="l2.1230" class="difflineminus">-            {</span>
<a href="#l2.1231"></a><span id="l2.1231" class="difflineminus">-                // check for and set various folder hints</span>
<a href="#l2.1232"></a><span id="l2.1232" class="difflineminus">-                if (field-&gt;mProperty == kNC_NewBookmarkFolder)</span>
<a href="#l2.1233"></a><span id="l2.1233" class="difflineminus">-                {</span>
<a href="#l2.1234"></a><span id="l2.1234" class="difflineminus">-                      rv = setFolderHint(bookmark, kNC_NewBookmarkFolder);</span>
<a href="#l2.1235"></a><span id="l2.1235" class="difflineminus">-                }</span>
<a href="#l2.1236"></a><span id="l2.1236" class="difflineminus">-                else if (field-&gt;mProperty == kNC_NewSearchFolder)</span>
<a href="#l2.1237"></a><span id="l2.1237" class="difflineminus">-                {</span>
<a href="#l2.1238"></a><span id="l2.1238" class="difflineminus">-                      rv = setFolderHint(bookmark, kNC_NewSearchFolder);</span>
<a href="#l2.1239"></a><span id="l2.1239" class="difflineminus">-                }</span>
<a href="#l2.1240"></a><span id="l2.1240" class="difflineminus">-                else if (field-&gt;mProperty == kNC_PersonalToolbarFolder)</span>
<a href="#l2.1241"></a><span id="l2.1241" class="difflineminus">-                {</span>
<a href="#l2.1242"></a><span id="l2.1242" class="difflineminus">-                      rv = setFolderHint(bookmark, kNC_PersonalToolbarFolder);</span>
<a href="#l2.1243"></a><span id="l2.1243" class="difflineminus">-                      mFoundPersonalToolbarFolder = PR_TRUE;</span>
<a href="#l2.1244"></a><span id="l2.1244" class="difflineminus">-                }</span>
<a href="#l2.1245"></a><span id="l2.1245" class="difflineminus">-                else if (field-&gt;mProperty)</span>
<a href="#l2.1246"></a><span id="l2.1246" class="difflineminus">-                {</span>
<a href="#l2.1247"></a><span id="l2.1247" class="difflineminus">-                    updateAtom(mDataSource, bookmark, field-&gt;mProperty,</span>
<a href="#l2.1248"></a><span id="l2.1248" class="difflineminus">-                               field-&gt;mValue, nsnull);</span>
<a href="#l2.1249"></a><span id="l2.1249" class="difflineminus">-                }</span>
<a href="#l2.1250"></a><span id="l2.1250" class="difflineminus">-            }</span>
<a href="#l2.1251"></a><span id="l2.1251" class="difflineminus">-        }</span>
<a href="#l2.1252"></a><span id="l2.1252" class="difflineminus">-</span>
<a href="#l2.1253"></a><span id="l2.1253" class="difflineminus">-        // look for bookmark name (and unescape)</span>
<a href="#l2.1254"></a><span id="l2.1254" class="difflineminus">-        if (aLine[attrStart] == '&gt;')</span>
<a href="#l2.1255"></a><span id="l2.1255" class="difflineminus">-        {</span>
<a href="#l2.1256"></a><span id="l2.1256" class="difflineminus">-            PRInt32 nameEnd;</span>
<a href="#l2.1257"></a><span id="l2.1257" class="difflineminus">-            if (isBookmarkFlag == PR_TRUE)</span>
<a href="#l2.1258"></a><span id="l2.1258" class="difflineminus">-                nameEnd = aLine.Find(kCloseAnchor, PR_TRUE, ++attrStart);</span>
<a href="#l2.1259"></a><span id="l2.1259" class="difflineminus">-            else</span>
<a href="#l2.1260"></a><span id="l2.1260" class="difflineminus">-                nameEnd = aLine.Find(kCloseHeading, PR_TRUE, ++attrStart);</span>
<a href="#l2.1261"></a><span id="l2.1261" class="difflineminus">-</span>
<a href="#l2.1262"></a><span id="l2.1262" class="difflineminus">-            if (nameEnd &gt; attrStart)</span>
<a href="#l2.1263"></a><span id="l2.1263" class="difflineminus">-            {</span>
<a href="#l2.1264"></a><span id="l2.1264" class="difflineminus">-                nsAutoString name(Substring(aLine, attrStart,</span>
<a href="#l2.1265"></a><span id="l2.1265" class="difflineminus">-                                            nameEnd - attrStart));</span>
<a href="#l2.1266"></a><span id="l2.1266" class="difflineminus">-                if (!name.IsEmpty())</span>
<a href="#l2.1267"></a><span id="l2.1267" class="difflineminus">-                {</span>
<a href="#l2.1268"></a><span id="l2.1268" class="difflineminus">-                    Unescape(name);</span>
<a href="#l2.1269"></a><span id="l2.1269" class="difflineminus">-</span>
<a href="#l2.1270"></a><span id="l2.1270" class="difflineminus">-                    nsCOMPtr&lt;nsIRDFNode&gt;    nameNode;</span>
<a href="#l2.1271"></a><span id="l2.1271" class="difflineminus">-                    rv = ParseLiteral(kNC_Name, name, getter_AddRefs(nameNode));</span>
<a href="#l2.1272"></a><span id="l2.1272" class="difflineminus">-                    if (NS_SUCCEEDED(rv) &amp;&amp; nameNode)</span>
<a href="#l2.1273"></a><span id="l2.1273" class="difflineminus">-                        updateAtom(mDataSource, bookmark, kNC_Name, nameNode, nsnull);</span>
<a href="#l2.1274"></a><span id="l2.1274" class="difflineminus">-                }</span>
<a href="#l2.1275"></a><span id="l2.1275" class="difflineminus">-            }</span>
<a href="#l2.1276"></a><span id="l2.1276" class="difflineminus">-        }</span>
<a href="#l2.1277"></a><span id="l2.1277" class="difflineminus">-</span>
<a href="#l2.1278"></a><span id="l2.1278" class="difflineminus">-        if (isBookmarkFlag == PR_FALSE)</span>
<a href="#l2.1279"></a><span id="l2.1279" class="difflineminus">-        {</span>
<a href="#l2.1280"></a><span id="l2.1280" class="difflineminus">-            rv = gRDFC-&gt;MakeSeq(mDataSource, bookmark, nsnull);</span>
<a href="#l2.1281"></a><span id="l2.1281" class="difflineminus">-            NS_ASSERTION(NS_SUCCEEDED(rv), &quot;unable to make new folder as sequence&quot;);</span>
<a href="#l2.1282"></a><span id="l2.1282" class="difflineminus">-            if (NS_SUCCEEDED(rv))</span>
<a href="#l2.1283"></a><span id="l2.1283" class="difflineminus">-            {</span>
<a href="#l2.1284"></a><span id="l2.1284" class="difflineminus">-                // And now recursively parse the rest of the file...</span>
<a href="#l2.1285"></a><span id="l2.1285" class="difflineminus">-                rv = Parse(bookmark, nodeType);</span>
<a href="#l2.1286"></a><span id="l2.1286" class="difflineminus">-                NS_ASSERTION(NS_SUCCEEDED(rv), &quot;unable to parse bookmarks&quot;);</span>
<a href="#l2.1287"></a><span id="l2.1287" class="difflineminus">-            }</span>
<a href="#l2.1288"></a><span id="l2.1288" class="difflineminus">-        }</span>
<a href="#l2.1289"></a><span id="l2.1289" class="difflineminus">-</span>
<a href="#l2.1290"></a><span id="l2.1290" class="difflineminus">-        // prevent duplicates                                                       </span>
<a href="#l2.1291"></a><span id="l2.1291" class="difflineminus">-        PRInt32 aIndex;                                                             </span>
<a href="#l2.1292"></a><span id="l2.1292" class="difflineminus">-        nsCOMPtr&lt;nsIRDFResource&gt; containerRes;</span>
<a href="#l2.1293"></a><span id="l2.1293" class="difflineminus">-        aContainer-&gt;GetResource(getter_AddRefs(containerRes));</span>
<a href="#l2.1294"></a><span id="l2.1294" class="difflineminus">-        if (containerRes &amp;&amp; NS_SUCCEEDED(gRDFC-&gt;IndexOf(mDataSource, containerRes, bookmark, &amp;aIndex)) &amp;&amp;                 </span>
<a href="#l2.1295"></a><span id="l2.1295" class="difflineminus">-            (aIndex &lt; 0))                                                           </span>
<a href="#l2.1296"></a><span id="l2.1296" class="difflineminus">-        {                                                                           </span>
<a href="#l2.1297"></a><span id="l2.1297" class="difflineminus">-          // The last thing we do is add the bookmark to the container.           </span>
<a href="#l2.1298"></a><span id="l2.1298" class="difflineminus">-          // This ensures the minimal amount of reflow.                           </span>
<a href="#l2.1299"></a><span id="l2.1299" class="difflineminus">-          rv = aContainer-&gt;AppendElement(bookmark);                               </span>
<a href="#l2.1300"></a><span id="l2.1300" class="difflineminus">-          NS_ASSERTION(NS_SUCCEEDED(rv), &quot;unable to add bookmark to container&quot;);  </span>
<a href="#l2.1301"></a><span id="l2.1301" class="difflineminus">-        }      </span>
<a href="#l2.1302"></a><span id="l2.1302" class="difflineminus">-    }</span>
<a href="#l2.1303"></a><span id="l2.1303" class="difflineminus">-</span>
<a href="#l2.1304"></a><span id="l2.1304" class="difflineminus">-    // free up any allocated data in field table AFTER processing</span>
<a href="#l2.1305"></a><span id="l2.1305" class="difflineminus">-    for (BookmarkField *postField = fields; postField-&gt;mName; ++postField)</span>
<a href="#l2.1306"></a><span id="l2.1306" class="difflineminus">-    {</span>
<a href="#l2.1307"></a><span id="l2.1307" class="difflineminus">-        NS_IF_RELEASE(postField-&gt;mValue);</span>
<a href="#l2.1308"></a><span id="l2.1308" class="difflineminus">-    }</span>
<a href="#l2.1309"></a><span id="l2.1309" class="difflineminus">-</span>
<a href="#l2.1310"></a><span id="l2.1310" class="difflineminus">-    return NS_OK;</span>
<a href="#l2.1311"></a><span id="l2.1311" class="difflineminus">-}</span>
<a href="#l2.1312"></a><span id="l2.1312" class="difflineminus">-</span>
<a href="#l2.1313"></a><span id="l2.1313" class="difflineminus">-nsresult</span>
<a href="#l2.1314"></a><span id="l2.1314" class="difflineminus">-BookmarkParser::ParseResource(nsIRDFResource *arc, nsString&amp; url, nsIRDFNode** aResult)</span>
<a href="#l2.1315"></a><span id="l2.1315" class="difflineminus">-{</span>
<a href="#l2.1316"></a><span id="l2.1316" class="difflineminus">-    *aResult = nsnull;</span>
<a href="#l2.1317"></a><span id="l2.1317" class="difflineminus">-</span>
<a href="#l2.1318"></a><span id="l2.1318" class="difflineminus">-    if (arc == kNC_URL)</span>
<a href="#l2.1319"></a><span id="l2.1319" class="difflineminus">-    {</span>
<a href="#l2.1320"></a><span id="l2.1320" class="difflineminus">-        // Now do properly replace %22's; this is particularly important for javascript: URLs</span>
<a href="#l2.1321"></a><span id="l2.1321" class="difflineminus">-        static const char kEscape22[] = &quot;%22&quot;;</span>
<a href="#l2.1322"></a><span id="l2.1322" class="difflineminus">-        PRInt32 offset;</span>
<a href="#l2.1323"></a><span id="l2.1323" class="difflineminus">-        while ((offset = url.Find(kEscape22)) &gt;= 0)</span>
<a href="#l2.1324"></a><span id="l2.1324" class="difflineminus">-            url.Replace(offset, sizeof(kEscape22) - 1, '\&quot;');</span>
<a href="#l2.1325"></a><span id="l2.1325" class="difflineminus">-</span>
<a href="#l2.1326"></a><span id="l2.1326" class="difflineminus">-        // XXX At this point, the URL may be relative. 4.5 called into</span>
<a href="#l2.1327"></a><span id="l2.1327" class="difflineminus">-        // netlib to make an absolute URL, and there was some magic</span>
<a href="#l2.1328"></a><span id="l2.1328" class="difflineminus">-        // &quot;relative_URL&quot; parameter that got sent down as well. We punt on</span>
<a href="#l2.1329"></a><span id="l2.1329" class="difflineminus">-        // that stuff.</span>
<a href="#l2.1330"></a><span id="l2.1330" class="difflineminus">-</span>
<a href="#l2.1331"></a><span id="l2.1331" class="difflineminus">-        // hack fix for bug # 21175:</span>
<a href="#l2.1332"></a><span id="l2.1332" class="difflineminus">-        // if we don't have a protocol scheme, add &quot;http://&quot; as a default scheme</span>
<a href="#l2.1333"></a><span id="l2.1333" class="difflineminus">-        if (url.FindChar(PRUnichar(':')) &lt; 0)</span>
<a href="#l2.1334"></a><span id="l2.1334" class="difflineminus">-            url.Insert(NS_LITERAL_STRING(&quot;http://&quot;), 0);</span>
<a href="#l2.1335"></a><span id="l2.1335" class="difflineminus">-    }</span>
<a href="#l2.1336"></a><span id="l2.1336" class="difflineminus">-</span>
<a href="#l2.1337"></a><span id="l2.1337" class="difflineminus">-    nsresult                    rv;</span>
<a href="#l2.1338"></a><span id="l2.1338" class="difflineminus">-    nsCOMPtr&lt;nsIRDFResource&gt;    result;</span>
<a href="#l2.1339"></a><span id="l2.1339" class="difflineminus">-    rv = gRDF-&gt;GetUnicodeResource(url, getter_AddRefs(result));</span>
<a href="#l2.1340"></a><span id="l2.1340" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l2.1341"></a><span id="l2.1341" class="difflineminus">-    return result-&gt;QueryInterface(NS_GET_IID(nsIRDFNode), (void**) aResult);</span>
<a href="#l2.1342"></a><span id="l2.1342" class="difflineminus">-}</span>
<a href="#l2.1343"></a><span id="l2.1343" class="difflineminus">-</span>
<a href="#l2.1344"></a><span id="l2.1344" class="difflineminus">-nsresult</span>
<a href="#l2.1345"></a><span id="l2.1345" class="difflineminus">-BookmarkParser::ParseLiteral(nsIRDFResource *arc, nsString&amp; aValue, nsIRDFNode** aResult)</span>
<a href="#l2.1346"></a><span id="l2.1346" class="difflineminus">-{</span>
<a href="#l2.1347"></a><span id="l2.1347" class="difflineminus">-    *aResult = nsnull;</span>
<a href="#l2.1348"></a><span id="l2.1348" class="difflineminus">-</span>
<a href="#l2.1349"></a><span id="l2.1349" class="difflineminus">-    if (arc == kNC_ShortcutURL)</span>
<a href="#l2.1350"></a><span id="l2.1350" class="difflineminus">-    {</span>
<a href="#l2.1351"></a><span id="l2.1351" class="difflineminus">-        Unescape(aValue);</span>
<a href="#l2.1352"></a><span id="l2.1352" class="difflineminus">-        // lowercase the shortcut URL before storing internally</span>
<a href="#l2.1353"></a><span id="l2.1353" class="difflineminus">-        ToLowerCase(aValue);</span>
<a href="#l2.1354"></a><span id="l2.1354" class="difflineminus">-    }</span>
<a href="#l2.1355"></a><span id="l2.1355" class="difflineminus">-    else if (arc == kWEB_LastCharset)</span>
<a href="#l2.1356"></a><span id="l2.1356" class="difflineminus">-    {</span>
<a href="#l2.1357"></a><span id="l2.1357" class="difflineminus">-        if (gCharsetAlias)</span>
<a href="#l2.1358"></a><span id="l2.1358" class="difflineminus">-        {</span>
<a href="#l2.1359"></a><span id="l2.1359" class="difflineminus">-            NS_LossyConvertUTF16toASCII charset(aValue);</span>
<a href="#l2.1360"></a><span id="l2.1360" class="difflineminus">-            gCharsetAlias-&gt;GetPreferred(charset, charset);</span>
<a href="#l2.1361"></a><span id="l2.1361" class="difflineminus">-            CopyASCIItoUTF16(charset, aValue);</span>
<a href="#l2.1362"></a><span id="l2.1362" class="difflineminus">-        }</span>
<a href="#l2.1363"></a><span id="l2.1363" class="difflineminus">-    }</span>
<a href="#l2.1364"></a><span id="l2.1364" class="difflineminus">-    else if (arc == kWEB_LastPingETag)</span>
<a href="#l2.1365"></a><span id="l2.1365" class="difflineminus">-    {</span>
<a href="#l2.1366"></a><span id="l2.1366" class="difflineminus">-        // don't allow quotes in etag</span>
<a href="#l2.1367"></a><span id="l2.1367" class="difflineminus">-        PRInt32 offset;</span>
<a href="#l2.1368"></a><span id="l2.1368" class="difflineminus">-        while ((offset = aValue.FindChar('\&quot;')) &gt;= 0)</span>
<a href="#l2.1369"></a><span id="l2.1369" class="difflineminus">-        {</span>
<a href="#l2.1370"></a><span id="l2.1370" class="difflineminus">-            aValue.Cut(offset, 1);</span>
<a href="#l2.1371"></a><span id="l2.1371" class="difflineminus">-        }</span>
<a href="#l2.1372"></a><span id="l2.1372" class="difflineminus">-    }</span>
<a href="#l2.1373"></a><span id="l2.1373" class="difflineminus">-</span>
<a href="#l2.1374"></a><span id="l2.1374" class="difflineminus">-    nsresult                rv;</span>
<a href="#l2.1375"></a><span id="l2.1375" class="difflineminus">-    nsCOMPtr&lt;nsIRDFLiteral&gt; result;</span>
<a href="#l2.1376"></a><span id="l2.1376" class="difflineminus">-    rv = gRDF-&gt;GetLiteral(aValue.get(), getter_AddRefs(result));</span>
<a href="#l2.1377"></a><span id="l2.1377" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l2.1378"></a><span id="l2.1378" class="difflineminus">-    return result-&gt;QueryInterface(NS_GET_IID(nsIRDFNode), (void**) aResult);</span>
<a href="#l2.1379"></a><span id="l2.1379" class="difflineminus">-}</span>
<a href="#l2.1380"></a><span id="l2.1380" class="difflineminus">-</span>
<a href="#l2.1381"></a><span id="l2.1381" class="difflineminus">-nsresult</span>
<a href="#l2.1382"></a><span id="l2.1382" class="difflineminus">-BookmarkParser::ParseDate(nsIRDFResource *arc, nsString&amp; aValue, nsIRDFNode** aResult)</span>
<a href="#l2.1383"></a><span id="l2.1383" class="difflineminus">-{</span>
<a href="#l2.1384"></a><span id="l2.1384" class="difflineminus">-    *aResult = nsnull;</span>
<a href="#l2.1385"></a><span id="l2.1385" class="difflineminus">-</span>
<a href="#l2.1386"></a><span id="l2.1386" class="difflineminus">-    PRInt32 theDate = 0;</span>
<a href="#l2.1387"></a><span id="l2.1387" class="difflineminus">-    if (!aValue.IsEmpty())</span>
<a href="#l2.1388"></a><span id="l2.1388" class="difflineminus">-    {</span>
<a href="#l2.1389"></a><span id="l2.1389" class="difflineminus">-        nsresult err;</span>
<a href="#l2.1390"></a><span id="l2.1390" class="difflineminus">-        theDate = aValue.ToInteger(&amp;err); // ignored.</span>
<a href="#l2.1391"></a><span id="l2.1391" class="difflineminus">-    }</span>
<a href="#l2.1392"></a><span id="l2.1392" class="difflineminus">-    if (theDate == 0)</span>
<a href="#l2.1393"></a><span id="l2.1393" class="difflineminus">-      return NS_RDF_NO_VALUE;</span>
<a href="#l2.1394"></a><span id="l2.1394" class="difflineminus">-</span>
<a href="#l2.1395"></a><span id="l2.1395" class="difflineminus">-    nsresult rv;</span>
<a href="#l2.1396"></a><span id="l2.1396" class="difflineminus">-    // convert from seconds to microseconds (PRTime)</span>
<a href="#l2.1397"></a><span id="l2.1397" class="difflineminus">-    PRInt64     dateVal, temp, million;</span>
<a href="#l2.1398"></a><span id="l2.1398" class="difflineminus">-    LL_I2L(temp, theDate);</span>
<a href="#l2.1399"></a><span id="l2.1399" class="difflineminus">-    LL_I2L(million, PR_USEC_PER_SEC);</span>
<a href="#l2.1400"></a><span id="l2.1400" class="difflineminus">-    LL_MUL(dateVal, temp, million);</span>
<a href="#l2.1401"></a><span id="l2.1401" class="difflineminus">-</span>
<a href="#l2.1402"></a><span id="l2.1402" class="difflineminus">-    nsCOMPtr&lt;nsIRDFDate&gt;    result;</span>
<a href="#l2.1403"></a><span id="l2.1403" class="difflineminus">-    if (NS_FAILED(rv = gRDF-&gt;GetDateLiteral(dateVal, getter_AddRefs(result))))</span>
<a href="#l2.1404"></a><span id="l2.1404" class="difflineminus">-    {</span>
<a href="#l2.1405"></a><span id="l2.1405" class="difflineminus">-        NS_ERROR(&quot;unable to get date literal for time&quot;);</span>
<a href="#l2.1406"></a><span id="l2.1406" class="difflineminus">-        return rv;</span>
<a href="#l2.1407"></a><span id="l2.1407" class="difflineminus">-    }</span>
<a href="#l2.1408"></a><span id="l2.1408" class="difflineminus">-    return result-&gt;QueryInterface(NS_GET_IID(nsIRDFNode), (void**) aResult);</span>
<a href="#l2.1409"></a><span id="l2.1409" class="difflineminus">-}</span>
<a href="#l2.1410"></a><span id="l2.1410" class="difflineminus">-</span>
<a href="#l2.1411"></a><span id="l2.1411" class="difflineminus">-nsresult</span>
<a href="#l2.1412"></a><span id="l2.1412" class="difflineminus">-BookmarkParser::updateAtom(nsIRDFDataSource *db, nsIRDFResource *src,</span>
<a href="#l2.1413"></a><span id="l2.1413" class="difflineminus">-            nsIRDFResource *prop, nsIRDFNode *newValue, PRBool *dirtyFlag)</span>
<a href="#l2.1414"></a><span id="l2.1414" class="difflineminus">-{</span>
<a href="#l2.1415"></a><span id="l2.1415" class="difflineminus">-    nsresult        rv;</span>
<a href="#l2.1416"></a><span id="l2.1416" class="difflineminus">-    nsCOMPtr&lt;nsIRDFNode&gt;    oldValue;</span>
<a href="#l2.1417"></a><span id="l2.1417" class="difflineminus">-</span>
<a href="#l2.1418"></a><span id="l2.1418" class="difflineminus">-    if (dirtyFlag != nsnull)</span>
<a href="#l2.1419"></a><span id="l2.1419" class="difflineminus">-    {</span>
<a href="#l2.1420"></a><span id="l2.1420" class="difflineminus">-        *dirtyFlag = PR_FALSE;</span>
<a href="#l2.1421"></a><span id="l2.1421" class="difflineminus">-    }</span>
<a href="#l2.1422"></a><span id="l2.1422" class="difflineminus">-</span>
<a href="#l2.1423"></a><span id="l2.1423" class="difflineminus">-    if (NS_SUCCEEDED(rv = db-&gt;GetTarget(src, prop, PR_TRUE, getter_AddRefs(oldValue))) &amp;&amp;</span>
<a href="#l2.1424"></a><span id="l2.1424" class="difflineminus">-        (rv != NS_RDF_NO_VALUE))</span>
<a href="#l2.1425"></a><span id="l2.1425" class="difflineminus">-    {</span>
<a href="#l2.1426"></a><span id="l2.1426" class="difflineminus">-        rv = db-&gt;Change(src, prop, oldValue, newValue);</span>
<a href="#l2.1427"></a><span id="l2.1427" class="difflineminus">-</span>
<a href="#l2.1428"></a><span id="l2.1428" class="difflineminus">-        if ((oldValue.get() != newValue) &amp;&amp; (dirtyFlag != nsnull))</span>
<a href="#l2.1429"></a><span id="l2.1429" class="difflineminus">-        {</span>
<a href="#l2.1430"></a><span id="l2.1430" class="difflineminus">-            *dirtyFlag = PR_TRUE;</span>
<a href="#l2.1431"></a><span id="l2.1431" class="difflineminus">-        }</span>
<a href="#l2.1432"></a><span id="l2.1432" class="difflineminus">-    }</span>
<a href="#l2.1433"></a><span id="l2.1433" class="difflineminus">-    else</span>
<a href="#l2.1434"></a><span id="l2.1434" class="difflineminus">-    {</span>
<a href="#l2.1435"></a><span id="l2.1435" class="difflineminus">-        rv = db-&gt;Assert(src, prop, newValue, PR_TRUE);</span>
<a href="#l2.1436"></a><span id="l2.1436" class="difflineminus">-</span>
<a href="#l2.1437"></a><span id="l2.1437" class="difflineminus">-        if (prop == kWEB_Schedule)</span>
<a href="#l2.1438"></a><span id="l2.1438" class="difflineminus">-        {</span>
<a href="#l2.1439"></a><span id="l2.1439" class="difflineminus">-          // internally mark nodes with schedules so that we can find them quickly</span>
<a href="#l2.1440"></a><span id="l2.1440" class="difflineminus">-          updateAtom(db, src, kWEB_ScheduleActive, kTrueLiteral, dirtyFlag);</span>
<a href="#l2.1441"></a><span id="l2.1441" class="difflineminus">-        }</span>
<a href="#l2.1442"></a><span id="l2.1442" class="difflineminus">-    }</span>
<a href="#l2.1443"></a><span id="l2.1443" class="difflineminus">-    return rv;</span>
<a href="#l2.1444"></a><span id="l2.1444" class="difflineminus">-}</span>
<a href="#l2.1445"></a><span id="l2.1445" class="difflineminus">-</span>
<a href="#l2.1446"></a><span id="l2.1446" class="difflineminus">-nsresult</span>
<a href="#l2.1447"></a><span id="l2.1447" class="difflineminus">-BookmarkParser::ParseBookmarkSeparator(const nsString &amp;aLine, const nsCOMPtr&lt;nsIRDFContainer&gt; &amp;aContainer)</span>
<a href="#l2.1448"></a><span id="l2.1448" class="difflineminus">-{</span>
<a href="#l2.1449"></a><span id="l2.1449" class="difflineminus">-    nsCOMPtr&lt;nsIRDFResource&gt;  separator;</span>
<a href="#l2.1450"></a><span id="l2.1450" class="difflineminus">-    nsresult rv = gRDF-&gt;GetAnonymousResource(getter_AddRefs(separator));</span>
<a href="#l2.1451"></a><span id="l2.1451" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l2.1452"></a><span id="l2.1452" class="difflineminus">-        return rv;</span>
<a href="#l2.1453"></a><span id="l2.1453" class="difflineminus">-</span>
<a href="#l2.1454"></a><span id="l2.1454" class="difflineminus">-    PRInt32 lineLen = aLine.Length();</span>
<a href="#l2.1455"></a><span id="l2.1455" class="difflineminus">-</span>
<a href="#l2.1456"></a><span id="l2.1456" class="difflineminus">-    PRInt32 attrStart = 0;</span>
<a href="#l2.1457"></a><span id="l2.1457" class="difflineminus">-    attrStart = aLine.Find(kSeparator, PR_TRUE, attrStart);</span>
<a href="#l2.1458"></a><span id="l2.1458" class="difflineminus">-    if (attrStart &lt; 0)</span>
<a href="#l2.1459"></a><span id="l2.1459" class="difflineminus">-        return NS_ERROR_UNEXPECTED;</span>
<a href="#l2.1460"></a><span id="l2.1460" class="difflineminus">-    attrStart += sizeof(kSeparator)-1;</span>
<a href="#l2.1461"></a><span id="l2.1461" class="difflineminus">-</span>
<a href="#l2.1462"></a><span id="l2.1462" class="difflineminus">-    while((attrStart &lt; lineLen) &amp;&amp; (aLine[attrStart] != '&gt;')) {</span>
<a href="#l2.1463"></a><span id="l2.1463" class="difflineminus">-        while(NS_IsAsciiWhitespace(aLine[attrStart]))</span>
<a href="#l2.1464"></a><span id="l2.1464" class="difflineminus">-            ++attrStart;</span>
<a href="#l2.1465"></a><span id="l2.1465" class="difflineminus">-</span>
<a href="#l2.1466"></a><span id="l2.1466" class="difflineminus">-        if (Substring(aLine, attrStart, sizeof(kNameEqualsLC) - 1)</span>
<a href="#l2.1467"></a><span id="l2.1467" class="difflineminus">-              .LowerCaseEqualsLiteral(kNameEqualsLC)) {</span>
<a href="#l2.1468"></a><span id="l2.1468" class="difflineminus">-            attrStart += sizeof(kNameEqualsLC) - 1;</span>
<a href="#l2.1469"></a><span id="l2.1469" class="difflineminus">-</span>
<a href="#l2.1470"></a><span id="l2.1470" class="difflineminus">-            // skip to terminating quote of string</span>
<a href="#l2.1471"></a><span id="l2.1471" class="difflineminus">-            PRInt32 termQuote = aLine.FindChar(PRUnichar('\&quot;'), attrStart);</span>
<a href="#l2.1472"></a><span id="l2.1472" class="difflineminus">-            if (termQuote &gt; attrStart) {</span>
<a href="#l2.1473"></a><span id="l2.1473" class="difflineminus">-                nsAutoString name(Substring(aLine, attrStart,</span>
<a href="#l2.1474"></a><span id="l2.1474" class="difflineminus">-                                            termQuote - attrStart));</span>
<a href="#l2.1475"></a><span id="l2.1475" class="difflineminus">-                attrStart = termQuote + 1;</span>
<a href="#l2.1476"></a><span id="l2.1476" class="difflineminus">-                if (!name.IsEmpty()) {</span>
<a href="#l2.1477"></a><span id="l2.1477" class="difflineminus">-                    Unescape(name);</span>
<a href="#l2.1478"></a><span id="l2.1478" class="difflineminus">-</span>
<a href="#l2.1479"></a><span id="l2.1479" class="difflineminus">-                    nsCOMPtr&lt;nsIRDFLiteral&gt; nameLiteral;</span>
<a href="#l2.1480"></a><span id="l2.1480" class="difflineminus">-                    rv = gRDF-&gt;GetLiteral(name.get(), getter_AddRefs(nameLiteral));</span>
<a href="#l2.1481"></a><span id="l2.1481" class="difflineminus">-                    if (NS_FAILED(rv))</span>
<a href="#l2.1482"></a><span id="l2.1482" class="difflineminus">-                        return rv;</span>
<a href="#l2.1483"></a><span id="l2.1483" class="difflineminus">-                    rv = mDataSource-&gt;Assert(separator, kNC_Name, nameLiteral, PR_TRUE);</span>
<a href="#l2.1484"></a><span id="l2.1484" class="difflineminus">-                    if (NS_FAILED(rv))</span>
<a href="#l2.1485"></a><span id="l2.1485" class="difflineminus">-                        return rv;</span>
<a href="#l2.1486"></a><span id="l2.1486" class="difflineminus">-                }</span>
<a href="#l2.1487"></a><span id="l2.1487" class="difflineminus">-            }</span>
<a href="#l2.1488"></a><span id="l2.1488" class="difflineminus">-        }</span>
<a href="#l2.1489"></a><span id="l2.1489" class="difflineminus">-    }</span>
<a href="#l2.1490"></a><span id="l2.1490" class="difflineminus">-</span>
<a href="#l2.1491"></a><span id="l2.1491" class="difflineminus">-    rv = mDataSource-&gt;Assert(separator, kRDF_type, kNC_BookmarkSeparator, PR_TRUE);</span>
<a href="#l2.1492"></a><span id="l2.1492" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l2.1493"></a><span id="l2.1493" class="difflineminus">-        return rv;</span>
<a href="#l2.1494"></a><span id="l2.1494" class="difflineminus">-</span>
<a href="#l2.1495"></a><span id="l2.1495" class="difflineminus">-    rv = aContainer-&gt;AppendElement(separator);</span>
<a href="#l2.1496"></a><span id="l2.1496" class="difflineminus">-</span>
<a href="#l2.1497"></a><span id="l2.1497" class="difflineminus">-    return rv;</span>
<a href="#l2.1498"></a><span id="l2.1498" class="difflineminus">-}</span>
<a href="#l2.1499"></a><span id="l2.1499" class="difflineminus">-</span>
<a href="#l2.1500"></a><span id="l2.1500" class="difflineminus">-nsresult</span>
<a href="#l2.1501"></a><span id="l2.1501" class="difflineminus">-BookmarkParser::ParseHeaderBegin(const nsString &amp;aLine, const nsCOMPtr&lt;nsIRDFContainer&gt; &amp;aContainer)</span>
<a href="#l2.1502"></a><span id="l2.1502" class="difflineminus">-{</span>
<a href="#l2.1503"></a><span id="l2.1503" class="difflineminus">-    return NS_OK;</span>
<a href="#l2.1504"></a><span id="l2.1504" class="difflineminus">-}</span>
<a href="#l2.1505"></a><span id="l2.1505" class="difflineminus">-</span>
<a href="#l2.1506"></a><span id="l2.1506" class="difflineminus">-nsresult</span>
<a href="#l2.1507"></a><span id="l2.1507" class="difflineminus">-BookmarkParser::ParseHeaderEnd(const nsString &amp;aLine)</span>
<a href="#l2.1508"></a><span id="l2.1508" class="difflineminus">-{</span>
<a href="#l2.1509"></a><span id="l2.1509" class="difflineminus">-    return NS_OK;</span>
<a href="#l2.1510"></a><span id="l2.1510" class="difflineminus">-}</span>
<a href="#l2.1511"></a><span id="l2.1511" class="difflineminus">-</span>
<a href="#l2.1512"></a><span id="l2.1512" class="difflineminus">-nsresult</span>
<a href="#l2.1513"></a><span id="l2.1513" class="difflineminus">-BookmarkParser::AssertTime(nsIRDFResource* aSource,</span>
<a href="#l2.1514"></a><span id="l2.1514" class="difflineminus">-                           nsIRDFResource* aLabel,</span>
<a href="#l2.1515"></a><span id="l2.1515" class="difflineminus">-                           PRInt32 aTime)</span>
<a href="#l2.1516"></a><span id="l2.1516" class="difflineminus">-{</span>
<a href="#l2.1517"></a><span id="l2.1517" class="difflineminus">-    nsresult    rv = NS_OK;</span>
<a href="#l2.1518"></a><span id="l2.1518" class="difflineminus">-</span>
<a href="#l2.1519"></a><span id="l2.1519" class="difflineminus">-    if (aTime != 0)</span>
<a href="#l2.1520"></a><span id="l2.1520" class="difflineminus">-    {</span>
<a href="#l2.1521"></a><span id="l2.1521" class="difflineminus">-        // Convert to a date literal</span>
<a href="#l2.1522"></a><span id="l2.1522" class="difflineminus">-        PRInt64     dateVal, temp, million;</span>
<a href="#l2.1523"></a><span id="l2.1523" class="difflineminus">-</span>
<a href="#l2.1524"></a><span id="l2.1524" class="difflineminus">-        LL_I2L(temp, aTime);</span>
<a href="#l2.1525"></a><span id="l2.1525" class="difflineminus">-        LL_I2L(million, PR_USEC_PER_SEC);</span>
<a href="#l2.1526"></a><span id="l2.1526" class="difflineminus">-        LL_MUL(dateVal, temp, million);     // convert from seconds to microseconds (PRTime)</span>
<a href="#l2.1527"></a><span id="l2.1527" class="difflineminus">-</span>
<a href="#l2.1528"></a><span id="l2.1528" class="difflineminus">-        nsCOMPtr&lt;nsIRDFDate&gt;    dateLiteral;</span>
<a href="#l2.1529"></a><span id="l2.1529" class="difflineminus">-        if (NS_FAILED(rv = gRDF-&gt;GetDateLiteral(dateVal, getter_AddRefs(dateLiteral))))</span>
<a href="#l2.1530"></a><span id="l2.1530" class="difflineminus">-        {</span>
<a href="#l2.1531"></a><span id="l2.1531" class="difflineminus">-            NS_ERROR(&quot;unable to get date literal for time&quot;);</span>
<a href="#l2.1532"></a><span id="l2.1532" class="difflineminus">-            return rv;</span>
<a href="#l2.1533"></a><span id="l2.1533" class="difflineminus">-        }</span>
<a href="#l2.1534"></a><span id="l2.1534" class="difflineminus">-        updateAtom(mDataSource, aSource, aLabel, dateLiteral, nsnull);</span>
<a href="#l2.1535"></a><span id="l2.1535" class="difflineminus">-    }</span>
<a href="#l2.1536"></a><span id="l2.1536" class="difflineminus">-    return rv;</span>
<a href="#l2.1537"></a><span id="l2.1537" class="difflineminus">-}</span>
<a href="#l2.1538"></a><span id="l2.1538" class="difflineminus">-</span>
<a href="#l2.1539"></a><span id="l2.1539" class="difflineminus">-nsresult</span>
<a href="#l2.1540"></a><span id="l2.1540" class="difflineminus">-BookmarkParser::setFolderHint(nsIRDFResource *newSource, nsIRDFResource *objType)</span>
<a href="#l2.1541"></a><span id="l2.1541" class="difflineminus">-{</span>
<a href="#l2.1542"></a><span id="l2.1542" class="difflineminus">-    nsresult            rv;</span>
<a href="#l2.1543"></a><span id="l2.1543" class="difflineminus">-    nsCOMPtr&lt;nsISimpleEnumerator&gt;   srcList;</span>
<a href="#l2.1544"></a><span id="l2.1544" class="difflineminus">-    if (NS_FAILED(rv = mDataSource-&gt;GetSources(kNC_FolderType, objType, PR_TRUE, getter_AddRefs(srcList))))</span>
<a href="#l2.1545"></a><span id="l2.1545" class="difflineminus">-        return rv;</span>
<a href="#l2.1546"></a><span id="l2.1546" class="difflineminus">-</span>
<a href="#l2.1547"></a><span id="l2.1547" class="difflineminus">-    PRBool  hasMoreSrcs = PR_TRUE;</span>
<a href="#l2.1548"></a><span id="l2.1548" class="difflineminus">-    while(NS_SUCCEEDED(rv = srcList-&gt;HasMoreElements(&amp;hasMoreSrcs))</span>
<a href="#l2.1549"></a><span id="l2.1549" class="difflineminus">-        &amp;&amp; (hasMoreSrcs == PR_TRUE))</span>
<a href="#l2.1550"></a><span id="l2.1550" class="difflineminus">-    {</span>
<a href="#l2.1551"></a><span id="l2.1551" class="difflineminus">-        nsCOMPtr&lt;nsISupports&gt;   aSrc;</span>
<a href="#l2.1552"></a><span id="l2.1552" class="difflineminus">-        if (NS_FAILED(rv = srcList-&gt;GetNext(getter_AddRefs(aSrc))))</span>
<a href="#l2.1553"></a><span id="l2.1553" class="difflineminus">-            break;</span>
<a href="#l2.1554"></a><span id="l2.1554" class="difflineminus">-        nsCOMPtr&lt;nsIRDFResource&gt;    aSource = do_QueryInterface(aSrc);</span>
<a href="#l2.1555"></a><span id="l2.1555" class="difflineminus">-        if (!aSource)   continue;</span>
<a href="#l2.1556"></a><span id="l2.1556" class="difflineminus">-</span>
<a href="#l2.1557"></a><span id="l2.1557" class="difflineminus">-        if (NS_FAILED(rv = mDataSource-&gt;Unassert(aSource, kNC_FolderType, objType)))</span>
<a href="#l2.1558"></a><span id="l2.1558" class="difflineminus">-            continue;</span>
<a href="#l2.1559"></a><span id="l2.1559" class="difflineminus">-    }</span>
<a href="#l2.1560"></a><span id="l2.1560" class="difflineminus">-</span>
<a href="#l2.1561"></a><span id="l2.1561" class="difflineminus">-    rv = mDataSource-&gt;Assert(newSource, kNC_FolderType, objType, PR_TRUE);</span>
<a href="#l2.1562"></a><span id="l2.1562" class="difflineminus">-</span>
<a href="#l2.1563"></a><span id="l2.1563" class="difflineminus">-    return rv;</span>
<a href="#l2.1564"></a><span id="l2.1564" class="difflineminus">-}</span>
<a href="#l2.1565"></a><span id="l2.1565" class="difflineminus">-</span>
<a href="#l2.1566"></a><span id="l2.1566" class="difflineminus">-</span>
<a href="#l2.1567"></a><span id="l2.1567" class="difflineminus">-class SortInfo {</span>
<a href="#l2.1568"></a><span id="l2.1568" class="difflineminus">-public:</span>
<a href="#l2.1569"></a><span id="l2.1569" class="difflineminus">-    SortInfo(PRInt32 aDirection, PRBool aFoldersFirst)</span>
<a href="#l2.1570"></a><span id="l2.1570" class="difflineminus">-        : mDirection(aDirection),</span>
<a href="#l2.1571"></a><span id="l2.1571" class="difflineminus">-          mFoldersFirst(aFoldersFirst) {</span>
<a href="#l2.1572"></a><span id="l2.1572" class="difflineminus">-    }</span>
<a href="#l2.1573"></a><span id="l2.1573" class="difflineminus">-</span>
<a href="#l2.1574"></a><span id="l2.1574" class="difflineminus">-protected:</span>
<a href="#l2.1575"></a><span id="l2.1575" class="difflineminus">-    PRInt32     mDirection;</span>
<a href="#l2.1576"></a><span id="l2.1576" class="difflineminus">-    PRBool      mFoldersFirst;</span>
<a href="#l2.1577"></a><span id="l2.1577" class="difflineminus">-</span>
<a href="#l2.1578"></a><span id="l2.1578" class="difflineminus">-    friend class nsBookmarksService;</span>
<a href="#l2.1579"></a><span id="l2.1579" class="difflineminus">-};</span>
<a href="#l2.1580"></a><span id="l2.1580" class="difflineminus">-</span>
<a href="#l2.1581"></a><span id="l2.1581" class="difflineminus">-class ElementInfo {</span>
<a href="#l2.1582"></a><span id="l2.1582" class="difflineminus">-public:</span>
<a href="#l2.1583"></a><span id="l2.1583" class="difflineminus">-    ElementInfo(nsIRDFResource* aElement, nsIRDFNode* aNode, PRBool aIsFolder)</span>
<a href="#l2.1584"></a><span id="l2.1584" class="difflineminus">-      : mElement(aElement), mNode(aNode), mIsFolder(aIsFolder) {</span>
<a href="#l2.1585"></a><span id="l2.1585" class="difflineminus">-    }</span>
<a href="#l2.1586"></a><span id="l2.1586" class="difflineminus">-</span>
<a href="#l2.1587"></a><span id="l2.1587" class="difflineminus">-protected:</span>
<a href="#l2.1588"></a><span id="l2.1588" class="difflineminus">-    nsCOMPtr&lt;nsIRDFResource&gt;    mElement;</span>
<a href="#l2.1589"></a><span id="l2.1589" class="difflineminus">-    nsCOMPtr&lt;nsIRDFNode&gt;        mNode;</span>
<a href="#l2.1590"></a><span id="l2.1590" class="difflineminus">-    PRBool                      mIsFolder;</span>
<a href="#l2.1591"></a><span id="l2.1591" class="difflineminus">-</span>
<a href="#l2.1592"></a><span id="l2.1592" class="difflineminus">-    friend class nsBookmarksService;</span>
<a href="#l2.1593"></a><span id="l2.1593" class="difflineminus">-};</span>
<a href="#l2.1594"></a><span id="l2.1594" class="difflineminus">-</span>
<a href="#l2.1595"></a><span id="l2.1595" class="difflineminus">-// Note, that elements are deleted only when the array goes away.</span>
<a href="#l2.1596"></a><span id="l2.1596" class="difflineminus">-// Any call on this array that would result in an element being removed or</span>
<a href="#l2.1597"></a><span id="l2.1597" class="difflineminus">-// replaced should make sure that the element gets deleted.</span>
<a href="#l2.1598"></a><span id="l2.1598" class="difflineminus">-class ElementArray : public nsAutoVoidArray</span>
<a href="#l2.1599"></a><span id="l2.1599" class="difflineminus">-{</span>
<a href="#l2.1600"></a><span id="l2.1600" class="difflineminus">-public:</span>
<a href="#l2.1601"></a><span id="l2.1601" class="difflineminus">-  virtual ~ElementArray();</span>
<a href="#l2.1602"></a><span id="l2.1602" class="difflineminus">-</span>
<a href="#l2.1603"></a><span id="l2.1603" class="difflineminus">-  ElementInfo* ElementAt(PRInt32 aIndex) const {</span>
<a href="#l2.1604"></a><span id="l2.1604" class="difflineminus">-    return static_cast&lt;ElementInfo*&gt;(nsAutoVoidArray::ElementAt(aIndex));</span>
<a href="#l2.1605"></a><span id="l2.1605" class="difflineminus">-  }</span>
<a href="#l2.1606"></a><span id="l2.1606" class="difflineminus">-</span>
<a href="#l2.1607"></a><span id="l2.1607" class="difflineminus">-  ElementInfo* operator[](PRInt32 aIndex) const {</span>
<a href="#l2.1608"></a><span id="l2.1608" class="difflineminus">-    return ElementAt(aIndex);</span>
<a href="#l2.1609"></a><span id="l2.1609" class="difflineminus">-  }</span>
<a href="#l2.1610"></a><span id="l2.1610" class="difflineminus">-</span>
<a href="#l2.1611"></a><span id="l2.1611" class="difflineminus">-  void   Clear();</span>
<a href="#l2.1612"></a><span id="l2.1612" class="difflineminus">-};</span>
<a href="#l2.1613"></a><span id="l2.1613" class="difflineminus">-</span>
<a href="#l2.1614"></a><span id="l2.1614" class="difflineminus">-ElementArray::~ElementArray()</span>
<a href="#l2.1615"></a><span id="l2.1615" class="difflineminus">-{</span>
<a href="#l2.1616"></a><span id="l2.1616" class="difflineminus">-    Clear();</span>
<a href="#l2.1617"></a><span id="l2.1617" class="difflineminus">-}</span>
<a href="#l2.1618"></a><span id="l2.1618" class="difflineminus">-</span>
<a href="#l2.1619"></a><span id="l2.1619" class="difflineminus">-void</span>
<a href="#l2.1620"></a><span id="l2.1620" class="difflineminus">-ElementArray::Clear()</span>
<a href="#l2.1621"></a><span id="l2.1621" class="difflineminus">-{</span>
<a href="#l2.1622"></a><span id="l2.1622" class="difflineminus">-    PRInt32 index = Count();</span>
<a href="#l2.1623"></a><span id="l2.1623" class="difflineminus">-    while (--index &gt;= 0)</span>
<a href="#l2.1624"></a><span id="l2.1624" class="difflineminus">-    {</span>
<a href="#l2.1625"></a><span id="l2.1625" class="difflineminus">-        ElementInfo* elementInfo = ElementAt(index);</span>
<a href="#l2.1626"></a><span id="l2.1626" class="difflineminus">-        delete elementInfo;</span>
<a href="#l2.1627"></a><span id="l2.1627" class="difflineminus">-    }</span>
<a href="#l2.1628"></a><span id="l2.1628" class="difflineminus">-    nsAutoVoidArray::Clear();</span>
<a href="#l2.1629"></a><span id="l2.1629" class="difflineminus">-}</span>
<a href="#l2.1630"></a><span id="l2.1630" class="difflineminus">-</span>
<a href="#l2.1631"></a><span id="l2.1631" class="difflineminus">-/**</span>
<a href="#l2.1632"></a><span id="l2.1632" class="difflineminus">- * The bookmark transaction knows how to assert and unassert arcs</span>
<a href="#l2.1633"></a><span id="l2.1633" class="difflineminus">- */</span>
<a href="#l2.1634"></a><span id="l2.1634" class="difflineminus">-class BookmarkTransaction: public nsITransaction,</span>
<a href="#l2.1635"></a><span id="l2.1635" class="difflineminus">-                           public nsIInterfaceRequestor</span>
<a href="#l2.1636"></a><span id="l2.1636" class="difflineminus">-{</span>
<a href="#l2.1637"></a><span id="l2.1637" class="difflineminus">-  NS_DECL_ISUPPORTS</span>
<a href="#l2.1638"></a><span id="l2.1638" class="difflineminus">-  NS_DECL_NSITRANSACTION</span>
<a href="#l2.1639"></a><span id="l2.1639" class="difflineminus">-  NS_DECL_NSIINTERFACEREQUESTOR</span>
<a href="#l2.1640"></a><span id="l2.1640" class="difflineminus">-</span>
<a href="#l2.1641"></a><span id="l2.1641" class="difflineminus">-private:</span>
<a href="#l2.1642"></a><span id="l2.1642" class="difflineminus">-  nsBookmarksService* mBookmarksService;</span>
<a href="#l2.1643"></a><span id="l2.1643" class="difflineminus">-  nsCOMPtr&lt;nsIRDFResource&gt; mParent;</span>
<a href="#l2.1644"></a><span id="l2.1644" class="difflineminus">-  nsCOMPtr&lt;nsIRDFNode&gt; mItem;</span>
<a href="#l2.1645"></a><span id="l2.1645" class="difflineminus">-  PRUint32 mIndex;</span>
<a href="#l2.1646"></a><span id="l2.1646" class="difflineminus">-  PRBool mRemove;</span>
<a href="#l2.1647"></a><span id="l2.1647" class="difflineminus">-  nsresult performTransaction(PRBool aRemove, PRBool aRenumber);</span>
<a href="#l2.1648"></a><span id="l2.1648" class="difflineminus">-</span>
<a href="#l2.1649"></a><span id="l2.1649" class="difflineminus">-public:</span>
<a href="#l2.1650"></a><span id="l2.1650" class="difflineminus">-  BookmarkTransaction(nsBookmarksService* aBookmarksService,</span>
<a href="#l2.1651"></a><span id="l2.1651" class="difflineminus">-                      nsIRDFResource* aParent, nsIRDFNode* aItem,</span>
<a href="#l2.1652"></a><span id="l2.1652" class="difflineminus">-                      PRUint32 aIndex, PRBool aRemove)</span>
<a href="#l2.1653"></a><span id="l2.1653" class="difflineminus">-    : mBookmarksService(aBookmarksService),</span>
<a href="#l2.1654"></a><span id="l2.1654" class="difflineminus">-      mParent(aParent),</span>
<a href="#l2.1655"></a><span id="l2.1655" class="difflineminus">-      mItem(aItem),</span>
<a href="#l2.1656"></a><span id="l2.1656" class="difflineminus">-      mIndex(aIndex),</span>
<a href="#l2.1657"></a><span id="l2.1657" class="difflineminus">-      mRemove(aRemove) {}</span>
<a href="#l2.1658"></a><span id="l2.1658" class="difflineminus">-};</span>
<a href="#l2.1659"></a><span id="l2.1659" class="difflineminus">-</span>
<a href="#l2.1660"></a><span id="l2.1660" class="difflineminus">-NS_IMPL_ISUPPORTS2(BookmarkTransaction, nsITransaction, nsIInterfaceRequestor)</span>
<a href="#l2.1661"></a><span id="l2.1661" class="difflineminus">-</span>
<a href="#l2.1662"></a><span id="l2.1662" class="difflineminus">-nsresult</span>
<a href="#l2.1663"></a><span id="l2.1663" class="difflineminus">-BookmarkTransaction::performTransaction(PRBool aRemove, PRBool aRenumber)</span>
<a href="#l2.1664"></a><span id="l2.1664" class="difflineminus">-{</span>
<a href="#l2.1665"></a><span id="l2.1665" class="difflineminus">-  nsresult rv;</span>
<a href="#l2.1666"></a><span id="l2.1666" class="difflineminus">-  nsCOMPtr&lt;nsIRDFContainer&gt; container(do_CreateInstance(&quot;@mozilla.org/rdf/container;1&quot;, &amp;rv));</span>
<a href="#l2.1667"></a><span id="l2.1667" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l2.1668"></a><span id="l2.1668" class="difflineminus">-    return rv;</span>
<a href="#l2.1669"></a><span id="l2.1669" class="difflineminus">-</span>
<a href="#l2.1670"></a><span id="l2.1670" class="difflineminus">-  rv = container-&gt;Init(mBookmarksService, mParent);</span>
<a href="#l2.1671"></a><span id="l2.1671" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l2.1672"></a><span id="l2.1672" class="difflineminus">-    return rv;</span>
<a href="#l2.1673"></a><span id="l2.1673" class="difflineminus">-</span>
<a href="#l2.1674"></a><span id="l2.1674" class="difflineminus">-  if (!aRemove)</span>
<a href="#l2.1675"></a><span id="l2.1675" class="difflineminus">-    return container-&gt;InsertElementAt(mItem, mIndex, aRenumber);</span>
<a href="#l2.1676"></a><span id="l2.1676" class="difflineminus">-</span>
<a href="#l2.1677"></a><span id="l2.1677" class="difflineminus">-  // We don't renumber the container when deleting bookmarks.</span>
<a href="#l2.1678"></a><span id="l2.1678" class="difflineminus">-  // This makes it easy to undo the transaction by restoring the same index.</span>
<a href="#l2.1679"></a><span id="l2.1679" class="difflineminus">-  return container-&gt;RemoveElement(mItem, PR_FALSE);</span>
<a href="#l2.1680"></a><span id="l2.1680" class="difflineminus">-}</span>
<a href="#l2.1681"></a><span id="l2.1681" class="difflineminus">-</span>
<a href="#l2.1682"></a><span id="l2.1682" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l2.1683"></a><span id="l2.1683" class="difflineminus">-BookmarkTransaction::DoTransaction()</span>
<a href="#l2.1684"></a><span id="l2.1684" class="difflineminus">-{</span>
<a href="#l2.1685"></a><span id="l2.1685" class="difflineminus">-  return performTransaction(mRemove, PR_TRUE);</span>
<a href="#l2.1686"></a><span id="l2.1686" class="difflineminus">-}</span>
<a href="#l2.1687"></a><span id="l2.1687" class="difflineminus">-</span>
<a href="#l2.1688"></a><span id="l2.1688" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l2.1689"></a><span id="l2.1689" class="difflineminus">-BookmarkTransaction::UndoTransaction()</span>
<a href="#l2.1690"></a><span id="l2.1690" class="difflineminus">-{</span>
<a href="#l2.1691"></a><span id="l2.1691" class="difflineminus">-  // We don't renumber the container when undoing transactions.</span>
<a href="#l2.1692"></a><span id="l2.1692" class="difflineminus">-  // This makes it easy to redo the transaction by restoring the same index.</span>
<a href="#l2.1693"></a><span id="l2.1693" class="difflineminus">-  return performTransaction(!mRemove, PR_FALSE);</span>
<a href="#l2.1694"></a><span id="l2.1694" class="difflineminus">-}</span>
<a href="#l2.1695"></a><span id="l2.1695" class="difflineminus">-</span>
<a href="#l2.1696"></a><span id="l2.1696" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l2.1697"></a><span id="l2.1697" class="difflineminus">-BookmarkTransaction::RedoTransaction()</span>
<a href="#l2.1698"></a><span id="l2.1698" class="difflineminus">-{</span>
<a href="#l2.1699"></a><span id="l2.1699" class="difflineminus">-  // We don't renumber the container when redoing transactions.</span>
<a href="#l2.1700"></a><span id="l2.1700" class="difflineminus">-  // This makes it easy to undo the transaction by restoring the same index.</span>
<a href="#l2.1701"></a><span id="l2.1701" class="difflineminus">-  return performTransaction(mRemove, PR_FALSE);</span>
<a href="#l2.1702"></a><span id="l2.1702" class="difflineminus">-}</span>
<a href="#l2.1703"></a><span id="l2.1703" class="difflineminus">-</span>
<a href="#l2.1704"></a><span id="l2.1704" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l2.1705"></a><span id="l2.1705" class="difflineminus">-BookmarkTransaction::GetIsTransient(PRBool *aIsTransient)</span>
<a href="#l2.1706"></a><span id="l2.1706" class="difflineminus">-{</span>
<a href="#l2.1707"></a><span id="l2.1707" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aIsTransient);</span>
<a href="#l2.1708"></a><span id="l2.1708" class="difflineminus">-  *aIsTransient = PR_FALSE;</span>
<a href="#l2.1709"></a><span id="l2.1709" class="difflineminus">-  return NS_OK;</span>
<a href="#l2.1710"></a><span id="l2.1710" class="difflineminus">-}</span>
<a href="#l2.1711"></a><span id="l2.1711" class="difflineminus">-</span>
<a href="#l2.1712"></a><span id="l2.1712" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l2.1713"></a><span id="l2.1713" class="difflineminus">-BookmarkTransaction::Merge(nsITransaction* aTransaction, PRBool* aResult)</span>
<a href="#l2.1714"></a><span id="l2.1714" class="difflineminus">-{</span>
<a href="#l2.1715"></a><span id="l2.1715" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l2.1716"></a><span id="l2.1716" class="difflineminus">-  *aResult = PR_FALSE;</span>
<a href="#l2.1717"></a><span id="l2.1717" class="difflineminus">-  return NS_OK;</span>
<a href="#l2.1718"></a><span id="l2.1718" class="difflineminus">-}</span>
<a href="#l2.1719"></a><span id="l2.1719" class="difflineminus">-</span>
<a href="#l2.1720"></a><span id="l2.1720" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l2.1721"></a><span id="l2.1721" class="difflineminus">-BookmarkTransaction::GetInterface(REFNSIID aIID, void** aResult)</span>
<a href="#l2.1722"></a><span id="l2.1722" class="difflineminus">-{</span>
<a href="#l2.1723"></a><span id="l2.1723" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l2.1724"></a><span id="l2.1724" class="difflineminus">-  nsISupports *result = nsnull;</span>
<a href="#l2.1725"></a><span id="l2.1725" class="difflineminus">-  if (aIID.Equals(NS_GET_IID(nsIRDFNode))) {</span>
<a href="#l2.1726"></a><span id="l2.1726" class="difflineminus">-    NS_ADDREF(result = mItem);</span>
<a href="#l2.1727"></a><span id="l2.1727" class="difflineminus">-    *aResult = result;</span>
<a href="#l2.1728"></a><span id="l2.1728" class="difflineminus">-    return NS_OK;</span>
<a href="#l2.1729"></a><span id="l2.1729" class="difflineminus">-  }</span>
<a href="#l2.1730"></a><span id="l2.1730" class="difflineminus">-  return NS_NOINTERFACE;</span>
<a href="#l2.1731"></a><span id="l2.1731" class="difflineminus">-}</span>
<a href="#l2.1732"></a><span id="l2.1732" class="difflineminus">-</span>
<a href="#l2.1733"></a><span id="l2.1733" class="difflineminus">-////////////////////////////////////////////////////////////////////////</span>
<a href="#l2.1734"></a><span id="l2.1734" class="difflineminus">-// nsBookmarksService implementation</span>
<a href="#l2.1735"></a><span id="l2.1735" class="difflineminus">-</span>
<a href="#l2.1736"></a><span id="l2.1736" class="difflineminus">-nsBookmarksService::nsBookmarksService() :</span>
<a href="#l2.1737"></a><span id="l2.1737" class="difflineminus">-    mUpdateBatchNest(0),</span>
<a href="#l2.1738"></a><span id="l2.1738" class="difflineminus">-    mDirty(PR_FALSE)</span>
<a href="#l2.1739"></a><span id="l2.1739" class="difflineminus">-</span>
<a href="#l2.1740"></a><span id="l2.1740" class="difflineminus">-{ }</span>
<a href="#l2.1741"></a><span id="l2.1741" class="difflineminus">-</span>
<a href="#l2.1742"></a><span id="l2.1742" class="difflineminus">-nsBookmarksService::~nsBookmarksService()</span>
<a href="#l2.1743"></a><span id="l2.1743" class="difflineminus">-{</span>
<a href="#l2.1744"></a><span id="l2.1744" class="difflineminus">-    if (mTimer)</span>
<a href="#l2.1745"></a><span id="l2.1745" class="difflineminus">-    {</span>
<a href="#l2.1746"></a><span id="l2.1746" class="difflineminus">-        // be sure to cancel the timer, as it holds a</span>
<a href="#l2.1747"></a><span id="l2.1747" class="difflineminus">-        // weak reference back to nsBookmarksService</span>
<a href="#l2.1748"></a><span id="l2.1748" class="difflineminus">-        mTimer-&gt;Cancel();</span>
<a href="#l2.1749"></a><span id="l2.1749" class="difflineminus">-        mTimer = nsnull;</span>
<a href="#l2.1750"></a><span id="l2.1750" class="difflineminus">-    }</span>
<a href="#l2.1751"></a><span id="l2.1751" class="difflineminus">-</span>
<a href="#l2.1752"></a><span id="l2.1752" class="difflineminus">-    // Unregister ourselves from the RDF service</span>
<a href="#l2.1753"></a><span id="l2.1753" class="difflineminus">-    if (gRDF)</span>
<a href="#l2.1754"></a><span id="l2.1754" class="difflineminus">-        gRDF-&gt;UnregisterDataSource(this);</span>
<a href="#l2.1755"></a><span id="l2.1755" class="difflineminus">-</span>
<a href="#l2.1756"></a><span id="l2.1756" class="difflineminus">-    // Note: can't flush in the DTOR, as the RDF service</span>
<a href="#l2.1757"></a><span id="l2.1757" class="difflineminus">-    // has probably already been destroyed</span>
<a href="#l2.1758"></a><span id="l2.1758" class="difflineminus">-    // Flush();</span>
<a href="#l2.1759"></a><span id="l2.1759" class="difflineminus">-    bm_ReleaseGlobals();</span>
<a href="#l2.1760"></a><span id="l2.1760" class="difflineminus">-}</span>
<a href="#l2.1761"></a><span id="l2.1761" class="difflineminus">-</span>
<a href="#l2.1762"></a><span id="l2.1762" class="difflineminus">-nsresult</span>
<a href="#l2.1763"></a><span id="l2.1763" class="difflineminus">-nsBookmarksService::Init()</span>
<a href="#l2.1764"></a><span id="l2.1764" class="difflineminus">-{</span>
<a href="#l2.1765"></a><span id="l2.1765" class="difflineminus">-    nsresult rv;</span>
<a href="#l2.1766"></a><span id="l2.1766" class="difflineminus">-    rv = bm_AddRefGlobals();</span>
<a href="#l2.1767"></a><span id="l2.1767" class="difflineminus">-    if (NS_FAILED(rv))  return rv;</span>
<a href="#l2.1768"></a><span id="l2.1768" class="difflineminus">-</span>
<a href="#l2.1769"></a><span id="l2.1769" class="difflineminus">-    mNetService = do_GetService(NS_IOSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l2.1770"></a><span id="l2.1770" class="difflineminus">-    if (NS_FAILED(rv))  return rv;</span>
<a href="#l2.1771"></a><span id="l2.1771" class="difflineminus">-</span>
<a href="#l2.1772"></a><span id="l2.1772" class="difflineminus">-    // create cache service/session, ignoring errors</span>
<a href="#l2.1773"></a><span id="l2.1773" class="difflineminus">-    mCacheService = do_GetService(NS_CACHESERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l2.1774"></a><span id="l2.1774" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l2.1775"></a><span id="l2.1775" class="difflineminus">-    {</span>
<a href="#l2.1776"></a><span id="l2.1776" class="difflineminus">-        rv = mCacheService-&gt;CreateSession(&quot;HTTP&quot;, nsICache::STORE_ANYWHERE,</span>
<a href="#l2.1777"></a><span id="l2.1777" class="difflineminus">-            nsICache::STREAM_BASED, getter_AddRefs(mCacheSession));</span>
<a href="#l2.1778"></a><span id="l2.1778" class="difflineminus">-    }</span>
<a href="#l2.1779"></a><span id="l2.1779" class="difflineminus">-</span>
<a href="#l2.1780"></a><span id="l2.1780" class="difflineminus">-    mTransactionManager = do_CreateInstance(NS_TRANSACTIONMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l2.1781"></a><span id="l2.1781" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l2.1782"></a><span id="l2.1782" class="difflineminus">-</span>
<a href="#l2.1783"></a><span id="l2.1783" class="difflineminus">-    /* create a URL for the string resource file */</span>
<a href="#l2.1784"></a><span id="l2.1784" class="difflineminus">-    nsCOMPtr&lt;nsIURI&gt; uri;</span>
<a href="#l2.1785"></a><span id="l2.1785" class="difflineminus">-    mNetService-&gt;NewURI(bookmark_properties, nsnull, nsnull,</span>
<a href="#l2.1786"></a><span id="l2.1786" class="difflineminus">-                        getter_AddRefs(uri));</span>
<a href="#l2.1787"></a><span id="l2.1787" class="difflineminus">-    if (uri)</span>
<a href="#l2.1788"></a><span id="l2.1788" class="difflineminus">-    {</span>
<a href="#l2.1789"></a><span id="l2.1789" class="difflineminus">-        /* create a bundle for the localization */</span>
<a href="#l2.1790"></a><span id="l2.1790" class="difflineminus">-        nsCOMPtr&lt;nsIStringBundleService&gt; stringService =</span>
<a href="#l2.1791"></a><span id="l2.1791" class="difflineminus">-                do_GetService(NS_STRINGBUNDLE_CONTRACTID);</span>
<a href="#l2.1792"></a><span id="l2.1792" class="difflineminus">-        if (stringService)</span>
<a href="#l2.1793"></a><span id="l2.1793" class="difflineminus">-        {</span>
<a href="#l2.1794"></a><span id="l2.1794" class="difflineminus">-            nsCAutoString spec;</span>
<a href="#l2.1795"></a><span id="l2.1795" class="difflineminus">-            uri-&gt;GetSpec(spec);</span>
<a href="#l2.1796"></a><span id="l2.1796" class="difflineminus">-            if (!spec.IsEmpty())</span>
<a href="#l2.1797"></a><span id="l2.1797" class="difflineminus">-            {</span>
<a href="#l2.1798"></a><span id="l2.1798" class="difflineminus">-                stringService-&gt;CreateBundle(spec.get(), getter_AddRefs(mBundle));</span>
<a href="#l2.1799"></a><span id="l2.1799" class="difflineminus">-            }</span>
<a href="#l2.1800"></a><span id="l2.1800" class="difflineminus">-        }</span>
<a href="#l2.1801"></a><span id="l2.1801" class="difflineminus">-    }</span>
<a href="#l2.1802"></a><span id="l2.1802" class="difflineminus">-</span>
<a href="#l2.1803"></a><span id="l2.1803" class="difflineminus">-    nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l2.1804"></a><span id="l2.1804" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l2.1805"></a><span id="l2.1805" class="difflineminus">-    {</span>
<a href="#l2.1806"></a><span id="l2.1806" class="difflineminus">-        // get browser icon prefs</span>
<a href="#l2.1807"></a><span id="l2.1807" class="difflineminus">-        PRInt32 toolbarIcons = 0;</span>
<a href="#l2.1808"></a><span id="l2.1808" class="difflineminus">-        prefBranch-&gt;GetIntPref(&quot;browser.chrome.load_toolbar_icons&quot;, &amp;toolbarIcons);</span>
<a href="#l2.1809"></a><span id="l2.1809" class="difflineminus">-        if (toolbarIcons &gt; 0) {</span>
<a href="#l2.1810"></a><span id="l2.1810" class="difflineminus">-              prefBranch-&gt;GetBoolPref(&quot;browser.chrome.site_icons&quot;, &amp;mBrowserIcons);</span>
<a href="#l2.1811"></a><span id="l2.1811" class="difflineminus">-              mAlwaysLoadIcons = (toolbarIcons &gt; 1);</span>
<a href="#l2.1812"></a><span id="l2.1812" class="difflineminus">-        } else</span>
<a href="#l2.1813"></a><span id="l2.1813" class="difflineminus">-              mAlwaysLoadIcons = mBrowserIcons = PR_FALSE;</span>
<a href="#l2.1814"></a><span id="l2.1814" class="difflineminus">-        </span>
<a href="#l2.1815"></a><span id="l2.1815" class="difflineminus">-        // determine what the name of the Personal Toolbar Folder is...</span>
<a href="#l2.1816"></a><span id="l2.1816" class="difflineminus">-        // first from user preference, then string bundle, then hard-coded default</span>
<a href="#l2.1817"></a><span id="l2.1817" class="difflineminus">-        nsCString prefValue;</span>
<a href="#l2.1818"></a><span id="l2.1818" class="difflineminus">-        rv = prefBranch-&gt;GetCharPref(&quot;custtoolbar.personal_toolbar_folder&quot;, getter_Copies(prefValue));</span>
<a href="#l2.1819"></a><span id="l2.1819" class="difflineminus">-        if (NS_SUCCEEDED(rv) &amp;&amp; !prefValue.IsEmpty())</span>
<a href="#l2.1820"></a><span id="l2.1820" class="difflineminus">-        {</span>
<a href="#l2.1821"></a><span id="l2.1821" class="difflineminus">-            CopyUTF8toUTF16(prefValue, mPersonalToolbarName);</span>
<a href="#l2.1822"></a><span id="l2.1822" class="difflineminus">-        }</span>
<a href="#l2.1823"></a><span id="l2.1823" class="difflineminus">-</span>
<a href="#l2.1824"></a><span id="l2.1824" class="difflineminus">-        if (mPersonalToolbarName.IsEmpty())</span>
<a href="#l2.1825"></a><span id="l2.1825" class="difflineminus">-        {</span>
<a href="#l2.1826"></a><span id="l2.1826" class="difflineminus">-            // rjc note: always try to get the string bundle (see above) before trying this</span>
<a href="#l2.1827"></a><span id="l2.1827" class="difflineminus">-            rv = mBundle-&gt;GetStringFromName(NS_LITERAL_STRING(&quot;DefaultPersonalToolbarFolder&quot;).get(), </span>
<a href="#l2.1828"></a><span id="l2.1828" class="difflineminus">-                                            getter_Copies(mPersonalToolbarName));</span>
<a href="#l2.1829"></a><span id="l2.1829" class="difflineminus">-            if (NS_FAILED(rv) || mPersonalToolbarName.IsEmpty()) {</span>
<a href="#l2.1830"></a><span id="l2.1830" class="difflineminus">-              // no preference, so fallback to a well-known name</span>
<a href="#l2.1831"></a><span id="l2.1831" class="difflineminus">-              mPersonalToolbarName.AssignLiteral(&quot;Personal Toolbar Folder&quot;);</span>
<a href="#l2.1832"></a><span id="l2.1832" class="difflineminus">-            }</span>
<a href="#l2.1833"></a><span id="l2.1833" class="difflineminus">-        }</span>
<a href="#l2.1834"></a><span id="l2.1834" class="difflineminus">-    }</span>
<a href="#l2.1835"></a><span id="l2.1835" class="difflineminus">-</span>
<a href="#l2.1836"></a><span id="l2.1836" class="difflineminus">-    // Gets the default name for NC:BookmarksRoot</span>
<a href="#l2.1837"></a><span id="l2.1837" class="difflineminus">-    // if the user has more than one profile: always include the profile name</span>
<a href="#l2.1838"></a><span id="l2.1838" class="difflineminus">-    // otherwise, include the profile name only if it is not named 'default'</span>
<a href="#l2.1839"></a><span id="l2.1839" class="difflineminus">-    // the profile &quot;default&quot; is not localizable and arises when there is no ns4.x install</span>
<a href="#l2.1840"></a><span id="l2.1840" class="difflineminus">-    nsresult             useProfile;</span>
<a href="#l2.1841"></a><span id="l2.1841" class="difflineminus">-    nsCOMPtr&lt;nsIProfile&gt; profileService(do_GetService(NS_PROFILE_CONTRACTID,&amp;useProfile));</span>
<a href="#l2.1842"></a><span id="l2.1842" class="difflineminus">-    if (NS_SUCCEEDED(useProfile))</span>
<a href="#l2.1843"></a><span id="l2.1843" class="difflineminus">-    {</span>
<a href="#l2.1844"></a><span id="l2.1844" class="difflineminus">-        nsString currentProfileName;</span>
<a href="#l2.1845"></a><span id="l2.1845" class="difflineminus">-    </span>
<a href="#l2.1846"></a><span id="l2.1846" class="difflineminus">-        useProfile = profileService-&gt;GetCurrentProfile(getter_Copies(currentProfileName));</span>
<a href="#l2.1847"></a><span id="l2.1847" class="difflineminus">-        if (NS_SUCCEEDED(useProfile))</span>
<a href="#l2.1848"></a><span id="l2.1848" class="difflineminus">-        {</span>
<a href="#l2.1849"></a><span id="l2.1849" class="difflineminus">-            const PRUnichar *param[1] = {currentProfileName.get()};</span>
<a href="#l2.1850"></a><span id="l2.1850" class="difflineminus">-            useProfile = mBundle-&gt;FormatStringFromName(NS_LITERAL_STRING(&quot;bookmarks_root&quot;).get(),</span>
<a href="#l2.1851"></a><span id="l2.1851" class="difflineminus">-                                                    param, 1, getter_Copies(mBookmarksRootName));</span>
<a href="#l2.1852"></a><span id="l2.1852" class="difflineminus">-            if (NS_SUCCEEDED(useProfile))</span>
<a href="#l2.1853"></a><span id="l2.1853" class="difflineminus">-            {</span>
<a href="#l2.1854"></a><span id="l2.1854" class="difflineminus">-                PRInt32 profileCount;</span>
<a href="#l2.1855"></a><span id="l2.1855" class="difflineminus">-                useProfile = profileService-&gt;GetProfileCount(&amp;profileCount);</span>
<a href="#l2.1856"></a><span id="l2.1856" class="difflineminus">-                if (NS_SUCCEEDED(useProfile) &amp;&amp; profileCount == 1)</span>
<a href="#l2.1857"></a><span id="l2.1857" class="difflineminus">-                {</span>
<a href="#l2.1858"></a><span id="l2.1858" class="difflineminus">-                    ToLowerCase(currentProfileName);</span>
<a href="#l2.1859"></a><span id="l2.1859" class="difflineminus">-                    if (currentProfileName.EqualsLiteral(&quot;default&quot;))</span>
<a href="#l2.1860"></a><span id="l2.1860" class="difflineminus">-                        useProfile = NS_ERROR_FAILURE;</span>
<a href="#l2.1861"></a><span id="l2.1861" class="difflineminus">-                }</span>
<a href="#l2.1862"></a><span id="l2.1862" class="difflineminus">-            }</span>
<a href="#l2.1863"></a><span id="l2.1863" class="difflineminus">-        }</span>
<a href="#l2.1864"></a><span id="l2.1864" class="difflineminus">-    }</span>
<a href="#l2.1865"></a><span id="l2.1865" class="difflineminus">-</span>
<a href="#l2.1866"></a><span id="l2.1866" class="difflineminus">-    if (NS_FAILED(useProfile))</span>
<a href="#l2.1867"></a><span id="l2.1867" class="difflineminus">-    {</span>
<a href="#l2.1868"></a><span id="l2.1868" class="difflineminus">-        rv = mBundle-&gt;GetStringFromName(NS_LITERAL_STRING(&quot;bookmarks_default_root&quot;).get(),</span>
<a href="#l2.1869"></a><span id="l2.1869" class="difflineminus">-                                        getter_Copies(mBookmarksRootName));</span>
<a href="#l2.1870"></a><span id="l2.1870" class="difflineminus">-        if (NS_FAILED(rv) || mBookmarksRootName.IsEmpty()) {</span>
<a href="#l2.1871"></a><span id="l2.1871" class="difflineminus">-            mBookmarksRootName.AssignLiteral(&quot;Bookmarks&quot;);</span>
<a href="#l2.1872"></a><span id="l2.1872" class="difflineminus">-        }</span>
<a href="#l2.1873"></a><span id="l2.1873" class="difflineminus">-    }</span>
<a href="#l2.1874"></a><span id="l2.1874" class="difflineminus">-</span>
<a href="#l2.1875"></a><span id="l2.1875" class="difflineminus">-    // Register as an observer of profile changes</span>
<a href="#l2.1876"></a><span id="l2.1876" class="difflineminus">-    nsCOMPtr&lt;nsIObserverService&gt; observerService = </span>
<a href="#l2.1877"></a><span id="l2.1877" class="difflineminus">-             do_GetService(&quot;@mozilla.org/observer-service;1&quot;, &amp;rv);</span>
<a href="#l2.1878"></a><span id="l2.1878" class="difflineminus">-    NS_ASSERTION(observerService, &quot;Could not get observer service.&quot;);</span>
<a href="#l2.1879"></a><span id="l2.1879" class="difflineminus">-    if (observerService) {</span>
<a href="#l2.1880"></a><span id="l2.1880" class="difflineminus">-        observerService-&gt;AddObserver(this, &quot;profile-before-change&quot;, PR_TRUE);</span>
<a href="#l2.1881"></a><span id="l2.1881" class="difflineminus">-        observerService-&gt;AddObserver(this, &quot;profile-after-change&quot;, PR_TRUE);</span>
<a href="#l2.1882"></a><span id="l2.1882" class="difflineminus">-    }</span>
<a href="#l2.1883"></a><span id="l2.1883" class="difflineminus">-</span>
<a href="#l2.1884"></a><span id="l2.1884" class="difflineminus">-    rv = initDatasource();</span>
<a href="#l2.1885"></a><span id="l2.1885" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l2.1886"></a><span id="l2.1886" class="difflineminus">-        return rv;</span>
<a href="#l2.1887"></a><span id="l2.1887" class="difflineminus">-</span>
<a href="#l2.1888"></a><span id="l2.1888" class="difflineminus">-    /* timer initialization */</span>
<a href="#l2.1889"></a><span id="l2.1889" class="difflineminus">-    busyResource = nsnull;</span>
<a href="#l2.1890"></a><span id="l2.1890" class="difflineminus">-</span>
<a href="#l2.1891"></a><span id="l2.1891" class="difflineminus">-    if (!mTimer)</span>
<a href="#l2.1892"></a><span id="l2.1892" class="difflineminus">-    {</span>
<a href="#l2.1893"></a><span id="l2.1893" class="difflineminus">-        busySchedule = PR_FALSE;</span>
<a href="#l2.1894"></a><span id="l2.1894" class="difflineminus">-        mTimer = do_CreateInstance(&quot;@mozilla.org/timer;1&quot;, &amp;rv);</span>
<a href="#l2.1895"></a><span id="l2.1895" class="difflineminus">-        NS_ASSERTION(NS_SUCCEEDED(rv), &quot;unable to create a timer&quot;);</span>
<a href="#l2.1896"></a><span id="l2.1896" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l2.1897"></a><span id="l2.1897" class="difflineminus">-        mTimer-&gt;InitWithFuncCallback(nsBookmarksService::FireTimer, this, BOOKMARK_TIMEOUT, </span>
<a href="#l2.1898"></a><span id="l2.1898" class="difflineminus">-                                     nsITimer::TYPE_REPEATING_SLACK);</span>
<a href="#l2.1899"></a><span id="l2.1899" class="difflineminus">-        // Note: don't addref &quot;this&quot; as we'll cancel the timer in the nsBookmarkService destructor</span>
<a href="#l2.1900"></a><span id="l2.1900" class="difflineminus">-    }</span>
<a href="#l2.1901"></a><span id="l2.1901" class="difflineminus">-</span>
<a href="#l2.1902"></a><span id="l2.1902" class="difflineminus">-    // register this as a named data source with the RDF</span>
<a href="#l2.1903"></a><span id="l2.1903" class="difflineminus">-    // service. Do this *last*, because if Init() fails, then the</span>
<a href="#l2.1904"></a><span id="l2.1904" class="difflineminus">-    // object will be destroyed (leaving the RDF service with a</span>
<a href="#l2.1905"></a><span id="l2.1905" class="difflineminus">-    // dangling pointer).</span>
<a href="#l2.1906"></a><span id="l2.1906" class="difflineminus">-    rv = gRDF-&gt;RegisterDataSource(this, PR_FALSE);</span>
<a href="#l2.1907"></a><span id="l2.1907" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l2.1908"></a><span id="l2.1908" class="difflineminus">-</span>
<a href="#l2.1909"></a><span id="l2.1909" class="difflineminus">-    return NS_OK;</span>
<a href="#l2.1910"></a><span id="l2.1910" class="difflineminus">-}</span>
<a href="#l2.1911"></a><span id="l2.1911" class="difflineminus">-</span>
<a href="#l2.1912"></a><span id="l2.1912" class="difflineminus">-nsresult</span>
<a href="#l2.1913"></a><span id="l2.1913" class="difflineminus">-nsBookmarksService::getLocaleString(const char *key, nsString &amp;str)</span>
<a href="#l2.1914"></a><span id="l2.1914" class="difflineminus">-{</span>
<a href="#l2.1915"></a><span id="l2.1915" class="difflineminus">-    PRUnichar   *keyUni = nsnull;</span>
<a href="#l2.1916"></a><span id="l2.1916" class="difflineminus">-    NS_ConvertASCIItoUTF16 keyStr(key);</span>
<a href="#l2.1917"></a><span id="l2.1917" class="difflineminus">-</span>
<a href="#l2.1918"></a><span id="l2.1918" class="difflineminus">-    nsresult    rv = NS_RDF_NO_VALUE;</span>
<a href="#l2.1919"></a><span id="l2.1919" class="difflineminus">-    if (mBundle &amp;&amp; (NS_SUCCEEDED(rv = mBundle-&gt;GetStringFromName(keyStr.get(), &amp;keyUni)))</span>
<a href="#l2.1920"></a><span id="l2.1920" class="difflineminus">-        &amp;&amp; (keyUni))</span>
<a href="#l2.1921"></a><span id="l2.1921" class="difflineminus">-    {</span>
<a href="#l2.1922"></a><span id="l2.1922" class="difflineminus">-        str = keyUni;</span>
<a href="#l2.1923"></a><span id="l2.1923" class="difflineminus">-        NS_Free(keyUni);</span>
<a href="#l2.1924"></a><span id="l2.1924" class="difflineminus">-    }</span>
<a href="#l2.1925"></a><span id="l2.1925" class="difflineminus">-    else</span>
<a href="#l2.1926"></a><span id="l2.1926" class="difflineminus">-    {</span>
<a href="#l2.1927"></a><span id="l2.1927" class="difflineminus">-        str.Truncate();</span>
<a href="#l2.1928"></a><span id="l2.1928" class="difflineminus">-    }</span>
<a href="#l2.1929"></a><span id="l2.1929" class="difflineminus">-    return rv;</span>
<a href="#l2.1930"></a><span id="l2.1930" class="difflineminus">-}</span>
<a href="#l2.1931"></a><span id="l2.1931" class="difflineminus">-</span>
<a href="#l2.1932"></a><span id="l2.1932" class="difflineminus">-nsresult</span>
<a href="#l2.1933"></a><span id="l2.1933" class="difflineminus">-nsBookmarksService::ExamineBookmarkSchedule(nsIRDFResource *theBookmark, PRBool &amp; examineFlag)</span>
<a href="#l2.1934"></a><span id="l2.1934" class="difflineminus">-{</span>
<a href="#l2.1935"></a><span id="l2.1935" class="difflineminus">-    examineFlag = PR_FALSE;</span>
<a href="#l2.1936"></a><span id="l2.1936" class="difflineminus">-    </span>
<a href="#l2.1937"></a><span id="l2.1937" class="difflineminus">-    nsresult    rv = NS_OK;</span>
<a href="#l2.1938"></a><span id="l2.1938" class="difflineminus">-</span>
<a href="#l2.1939"></a><span id="l2.1939" class="difflineminus">-    nsCOMPtr&lt;nsIRDFNode&gt;    scheduleNode;</span>
<a href="#l2.1940"></a><span id="l2.1940" class="difflineminus">-    if (NS_FAILED(rv = mInner-&gt;GetTarget(theBookmark, kWEB_Schedule, PR_TRUE,</span>
<a href="#l2.1941"></a><span id="l2.1941" class="difflineminus">-        getter_AddRefs(scheduleNode))) || (rv == NS_RDF_NO_VALUE))</span>
<a href="#l2.1942"></a><span id="l2.1942" class="difflineminus">-        return rv;</span>
<a href="#l2.1943"></a><span id="l2.1943" class="difflineminus">-    </span>
<a href="#l2.1944"></a><span id="l2.1944" class="difflineminus">-    nsCOMPtr&lt;nsIRDFLiteral&gt; scheduleLiteral = do_QueryInterface(scheduleNode);</span>
<a href="#l2.1945"></a><span id="l2.1945" class="difflineminus">-    if (!scheduleLiteral)   return NS_ERROR_NO_INTERFACE;</span>
<a href="#l2.1946"></a><span id="l2.1946" class="difflineminus">-    </span>
<a href="#l2.1947"></a><span id="l2.1947" class="difflineminus">-    const PRUnichar     *scheduleUni = nsnull;</span>
<a href="#l2.1948"></a><span id="l2.1948" class="difflineminus">-    if (NS_FAILED(rv = scheduleLiteral-&gt;GetValueConst(&amp;scheduleUni)))</span>
<a href="#l2.1949"></a><span id="l2.1949" class="difflineminus">-        return rv;</span>
<a href="#l2.1950"></a><span id="l2.1950" class="difflineminus">-    if (!scheduleUni)   return NS_ERROR_NULL_POINTER;</span>
<a href="#l2.1951"></a><span id="l2.1951" class="difflineminus">-</span>
<a href="#l2.1952"></a><span id="l2.1952" class="difflineminus">-    nsAutoString        schedule(scheduleUni);</span>
<a href="#l2.1953"></a><span id="l2.1953" class="difflineminus">-    if (schedule.Length() &lt; 1)  return NS_ERROR_UNEXPECTED;</span>
<a href="#l2.1954"></a><span id="l2.1954" class="difflineminus">-</span>
<a href="#l2.1955"></a><span id="l2.1955" class="difflineminus">-    // convert the current date/time from microseconds (PRTime) to seconds</span>
<a href="#l2.1956"></a><span id="l2.1956" class="difflineminus">-    // Note: don't change now64, as its used later in the function</span>
<a href="#l2.1957"></a><span id="l2.1957" class="difflineminus">-    PRTime      now64 = PR_Now(), temp64, million;</span>
<a href="#l2.1958"></a><span id="l2.1958" class="difflineminus">-    LL_I2L(million, PR_USEC_PER_SEC);</span>
<a href="#l2.1959"></a><span id="l2.1959" class="difflineminus">-    LL_DIV(temp64, now64, million);</span>
<a href="#l2.1960"></a><span id="l2.1960" class="difflineminus">-    PRInt32     now32;</span>
<a href="#l2.1961"></a><span id="l2.1961" class="difflineminus">-    LL_L2I(now32, temp64);</span>
<a href="#l2.1962"></a><span id="l2.1962" class="difflineminus">-</span>
<a href="#l2.1963"></a><span id="l2.1963" class="difflineminus">-    PRExplodedTime  nowInfo;</span>
<a href="#l2.1964"></a><span id="l2.1964" class="difflineminus">-    PR_ExplodeTime(now64, PR_LocalTimeParameters, &amp;nowInfo);</span>
<a href="#l2.1965"></a><span id="l2.1965" class="difflineminus">-    </span>
<a href="#l2.1966"></a><span id="l2.1966" class="difflineminus">-    // XXX Do we need to do this?</span>
<a href="#l2.1967"></a><span id="l2.1967" class="difflineminus">-    PR_NormalizeTime(&amp;nowInfo, PR_LocalTimeParameters);</span>
<a href="#l2.1968"></a><span id="l2.1968" class="difflineminus">-</span>
<a href="#l2.1969"></a><span id="l2.1969" class="difflineminus">-    nsAutoString    dayNum;</span>
<a href="#l2.1970"></a><span id="l2.1970" class="difflineminus">-    dayNum.AppendInt(nowInfo.tm_wday, 10);</span>
<a href="#l2.1971"></a><span id="l2.1971" class="difflineminus">-</span>
<a href="#l2.1972"></a><span id="l2.1972" class="difflineminus">-    // a schedule string has the following format:</span>
<a href="#l2.1973"></a><span id="l2.1973" class="difflineminus">-    // Check Monday, Tuesday, and Friday | 9 AM thru 5 PM | every five minutes | change bookmark icon</span>
<a href="#l2.1974"></a><span id="l2.1974" class="difflineminus">-    // 125|9-17|5|icon</span>
<a href="#l2.1975"></a><span id="l2.1975" class="difflineminus">-</span>
<a href="#l2.1976"></a><span id="l2.1976" class="difflineminus">-    nsAutoString    notificationMethod;</span>
<a href="#l2.1977"></a><span id="l2.1977" class="difflineminus">-    PRInt32     startHour = -1, endHour = -1, duration = -1;</span>
<a href="#l2.1978"></a><span id="l2.1978" class="difflineminus">-</span>
<a href="#l2.1979"></a><span id="l2.1979" class="difflineminus">-    // should we be checking today?</span>
<a href="#l2.1980"></a><span id="l2.1980" class="difflineminus">-    PRInt32     slashOffset;</span>
<a href="#l2.1981"></a><span id="l2.1981" class="difflineminus">-    if ((slashOffset = schedule.FindChar(PRUnichar('|'))) &gt;= 0)</span>
<a href="#l2.1982"></a><span id="l2.1982" class="difflineminus">-    {</span>
<a href="#l2.1983"></a><span id="l2.1983" class="difflineminus">-        nsAutoString daySection(StringHead(schedule, slashOffset));</span>
<a href="#l2.1984"></a><span id="l2.1984" class="difflineminus">-        schedule.Cut(0, slashOffset+1);</span>
<a href="#l2.1985"></a><span id="l2.1985" class="difflineminus">-        if (daySection.Find(dayNum) &gt;= 0)</span>
<a href="#l2.1986"></a><span id="l2.1986" class="difflineminus">-        {</span>
<a href="#l2.1987"></a><span id="l2.1987" class="difflineminus">-            // ok, we should be checking today.  Within hour range?</span>
<a href="#l2.1988"></a><span id="l2.1988" class="difflineminus">-            if ((slashOffset = schedule.FindChar(PRUnichar('|'))) &gt;= 0)</span>
<a href="#l2.1989"></a><span id="l2.1989" class="difflineminus">-            {</span>
<a href="#l2.1990"></a><span id="l2.1990" class="difflineminus">-                nsAutoString hourRange(StringHead(schedule, slashOffset));</span>
<a href="#l2.1991"></a><span id="l2.1991" class="difflineminus">-                schedule.Cut(0, slashOffset+1);</span>
<a href="#l2.1992"></a><span id="l2.1992" class="difflineminus">-</span>
<a href="#l2.1993"></a><span id="l2.1993" class="difflineminus">-                // now have the &quot;hour-range&quot; segment of the string</span>
<a href="#l2.1994"></a><span id="l2.1994" class="difflineminus">-                // such as &quot;9-17&quot; or &quot;9-12&quot; from the examples above</span>
<a href="#l2.1995"></a><span id="l2.1995" class="difflineminus">-                PRInt32     dashOffset;</span>
<a href="#l2.1996"></a><span id="l2.1996" class="difflineminus">-                if ((dashOffset = hourRange.FindChar(PRUnichar('-'))) &gt;= 1)</span>
<a href="#l2.1997"></a><span id="l2.1997" class="difflineminus">-                {</span>
<a href="#l2.1998"></a><span id="l2.1998" class="difflineminus">-                    nsAutoString startStr(StringHead(hourRange, dashOffset));</span>
<a href="#l2.1999"></a><span id="l2.1999" class="difflineminus">-                    nsAutoString endStr(Substring(hourRange, dashOffset + 1));</span>
<a href="#l2.2000"></a><span id="l2.2000" class="difflineminus">-</span>
<a href="#l2.2001"></a><span id="l2.2001" class="difflineminus">-                    nsresult rv2;</span>
<a href="#l2.2002"></a><span id="l2.2002" class="difflineminus">-                    startHour = startStr.ToInteger(&amp;rv2);</span>
<a href="#l2.2003"></a><span id="l2.2003" class="difflineminus">-                    if (NS_FAILED(rv2)) startHour = -1;</span>
<a href="#l2.2004"></a><span id="l2.2004" class="difflineminus">-                    endHour = endStr.ToInteger(&amp;rv2);</span>
<a href="#l2.2005"></a><span id="l2.2005" class="difflineminus">-                    if (NS_FAILED(rv2)) endHour = -1;</span>
<a href="#l2.2006"></a><span id="l2.2006" class="difflineminus">-                    </span>
<a href="#l2.2007"></a><span id="l2.2007" class="difflineminus">-                    if ((startHour &gt;=0) &amp;&amp; (endHour &gt;=0))</span>
<a href="#l2.2008"></a><span id="l2.2008" class="difflineminus">-                    {</span>
<a href="#l2.2009"></a><span id="l2.2009" class="difflineminus">-                        if ((slashOffset = schedule.FindChar(PRUnichar('|'))) &gt;= 0)</span>
<a href="#l2.2010"></a><span id="l2.2010" class="difflineminus">-                        {</span>
<a href="#l2.2011"></a><span id="l2.2011" class="difflineminus">-                            nsAutoString durationStr(StringHead(schedule,</span>
<a href="#l2.2012"></a><span id="l2.2012" class="difflineminus">-                                                                slashOffset));</span>
<a href="#l2.2013"></a><span id="l2.2013" class="difflineminus">-                            schedule.Cut(0, slashOffset+1);</span>
<a href="#l2.2014"></a><span id="l2.2014" class="difflineminus">-</span>
<a href="#l2.2015"></a><span id="l2.2015" class="difflineminus">-                            // get duration</span>
<a href="#l2.2016"></a><span id="l2.2016" class="difflineminus">-                            duration = durationStr.ToInteger(&amp;rv2);</span>
<a href="#l2.2017"></a><span id="l2.2017" class="difflineminus">-                            if (NS_FAILED(rv2)) duration = -1;</span>
<a href="#l2.2018"></a><span id="l2.2018" class="difflineminus">-</span>
<a href="#l2.2019"></a><span id="l2.2019" class="difflineminus">-                            // what's left is the notification options</span>
<a href="#l2.2020"></a><span id="l2.2020" class="difflineminus">-                            notificationMethod = schedule;</span>
<a href="#l2.2021"></a><span id="l2.2021" class="difflineminus">-                        }</span>
<a href="#l2.2022"></a><span id="l2.2022" class="difflineminus">-                    }</span>
<a href="#l2.2023"></a><span id="l2.2023" class="difflineminus">-                }</span>
<a href="#l2.2024"></a><span id="l2.2024" class="difflineminus">-            }</span>
<a href="#l2.2025"></a><span id="l2.2025" class="difflineminus">-        }</span>
<a href="#l2.2026"></a><span id="l2.2026" class="difflineminus">-    }</span>
<a href="#l2.2027"></a><span id="l2.2027" class="difflineminus">-        </span>
<a href="#l2.2028"></a><span id="l2.2028" class="difflineminus">-</span>
<a href="#l2.2029"></a><span id="l2.2029" class="difflineminus">-#ifdef  DEBUG_BOOKMARK_PING_OUTPUT</span>
<a href="#l2.2030"></a><span id="l2.2030" class="difflineminus">-    char *methodStr = ToNewCString(notificationMethod);</span>
<a href="#l2.2031"></a><span id="l2.2031" class="difflineminus">-    if (methodStr)</span>
<a href="#l2.2032"></a><span id="l2.2032" class="difflineminus">-    {</span>
<a href="#l2.2033"></a><span id="l2.2033" class="difflineminus">-        printf(&quot;Start Hour: %d    End Hour: %d    Duration: %d mins    Method: '%s'\n&quot;,</span>
<a href="#l2.2034"></a><span id="l2.2034" class="difflineminus">-            startHour, endHour, duration, methodStr);</span>
<a href="#l2.2035"></a><span id="l2.2035" class="difflineminus">-        delete [] methodStr;</span>
<a href="#l2.2036"></a><span id="l2.2036" class="difflineminus">-        methodStr = nsnull;</span>
<a href="#l2.2037"></a><span id="l2.2037" class="difflineminus">-    }</span>
<a href="#l2.2038"></a><span id="l2.2038" class="difflineminus">-#endif</span>
<a href="#l2.2039"></a><span id="l2.2039" class="difflineminus">-</span>
<a href="#l2.2040"></a><span id="l2.2040" class="difflineminus">-    if ((startHour &lt;= nowInfo.tm_hour) &amp;&amp; (endHour &gt;= nowInfo.tm_hour) &amp;&amp;</span>
<a href="#l2.2041"></a><span id="l2.2041" class="difflineminus">-        (duration &gt;= 1) &amp;&amp; (!notificationMethod.IsEmpty()))</span>
<a href="#l2.2042"></a><span id="l2.2042" class="difflineminus">-    {</span>
<a href="#l2.2043"></a><span id="l2.2043" class="difflineminus">-        // OK, we're with the start/end time range, check the duration</span>
<a href="#l2.2044"></a><span id="l2.2044" class="difflineminus">-        // against the last time we've &quot;pinged&quot; the server (if ever)</span>
<a href="#l2.2045"></a><span id="l2.2045" class="difflineminus">-</span>
<a href="#l2.2046"></a><span id="l2.2046" class="difflineminus">-        examineFlag = PR_TRUE;</span>
<a href="#l2.2047"></a><span id="l2.2047" class="difflineminus">-</span>
<a href="#l2.2048"></a><span id="l2.2048" class="difflineminus">-        nsCOMPtr&lt;nsIRDFNode&gt;    pingNode;</span>
<a href="#l2.2049"></a><span id="l2.2049" class="difflineminus">-        if (NS_SUCCEEDED(rv = mInner-&gt;GetTarget(theBookmark, kWEB_LastPingDate,</span>
<a href="#l2.2050"></a><span id="l2.2050" class="difflineminus">-            PR_TRUE, getter_AddRefs(pingNode))) &amp;&amp; (rv != NS_RDF_NO_VALUE))</span>
<a href="#l2.2051"></a><span id="l2.2051" class="difflineminus">-        {</span>
<a href="#l2.2052"></a><span id="l2.2052" class="difflineminus">-            nsCOMPtr&lt;nsIRDFDate&gt;    pingLiteral = do_QueryInterface(pingNode);</span>
<a href="#l2.2053"></a><span id="l2.2053" class="difflineminus">-            if (pingLiteral)</span>
<a href="#l2.2054"></a><span id="l2.2054" class="difflineminus">-            {</span>
<a href="#l2.2055"></a><span id="l2.2055" class="difflineminus">-                PRInt64     lastPing;</span>
<a href="#l2.2056"></a><span id="l2.2056" class="difflineminus">-                if (NS_SUCCEEDED(rv = pingLiteral-&gt;GetValue(&amp;lastPing)))</span>
<a href="#l2.2057"></a><span id="l2.2057" class="difflineminus">-                {</span>
<a href="#l2.2058"></a><span id="l2.2058" class="difflineminus">-                    PRInt64     diff64, sixty;</span>
<a href="#l2.2059"></a><span id="l2.2059" class="difflineminus">-                    LL_SUB(diff64, now64, lastPing);</span>
<a href="#l2.2060"></a><span id="l2.2060" class="difflineminus">-                    </span>
<a href="#l2.2061"></a><span id="l2.2061" class="difflineminus">-                    // convert from milliseconds to seconds</span>
<a href="#l2.2062"></a><span id="l2.2062" class="difflineminus">-                    LL_DIV(diff64, diff64, million);</span>
<a href="#l2.2063"></a><span id="l2.2063" class="difflineminus">-                    // convert from seconds to minutes</span>
<a href="#l2.2064"></a><span id="l2.2064" class="difflineminus">-                    LL_I2L(sixty, 60L);</span>
<a href="#l2.2065"></a><span id="l2.2065" class="difflineminus">-                    LL_DIV(diff64, diff64, sixty);</span>
<a href="#l2.2066"></a><span id="l2.2066" class="difflineminus">-</span>
<a href="#l2.2067"></a><span id="l2.2067" class="difflineminus">-                    PRInt32     diff32;</span>
<a href="#l2.2068"></a><span id="l2.2068" class="difflineminus">-                    LL_L2I(diff32, diff64);</span>
<a href="#l2.2069"></a><span id="l2.2069" class="difflineminus">-                    if (diff32 &lt; duration)</span>
<a href="#l2.2070"></a><span id="l2.2070" class="difflineminus">-                    {</span>
<a href="#l2.2071"></a><span id="l2.2071" class="difflineminus">-                        examineFlag = PR_FALSE;</span>
<a href="#l2.2072"></a><span id="l2.2072" class="difflineminus">-</span>
<a href="#l2.2073"></a><span id="l2.2073" class="difflineminus">-#ifdef  DEBUG_BOOKMARK_PING_OUTPUT</span>
<a href="#l2.2074"></a><span id="l2.2074" class="difflineminus">-                        printf(&quot;Skipping URL, its too soon.\n&quot;);</span>
<a href="#l2.2075"></a><span id="l2.2075" class="difflineminus">-#endif</span>
<a href="#l2.2076"></a><span id="l2.2076" class="difflineminus">-                    }</span>
<a href="#l2.2077"></a><span id="l2.2077" class="difflineminus">-                }</span>
<a href="#l2.2078"></a><span id="l2.2078" class="difflineminus">-            }</span>
<a href="#l2.2079"></a><span id="l2.2079" class="difflineminus">-        }</span>
<a href="#l2.2080"></a><span id="l2.2080" class="difflineminus">-    }</span>
<a href="#l2.2081"></a><span id="l2.2081" class="difflineminus">-    return rv;</span>
<a href="#l2.2082"></a><span id="l2.2082" class="difflineminus">-}</span>
<a href="#l2.2083"></a><span id="l2.2083" class="difflineminus">-</span>
<a href="#l2.2084"></a><span id="l2.2084" class="difflineminus">-nsresult</span>
<a href="#l2.2085"></a><span id="l2.2085" class="difflineminus">-nsBookmarksService::GetBookmarkToPing(nsIRDFResource **theBookmark)</span>
<a href="#l2.2086"></a><span id="l2.2086" class="difflineminus">-{</span>
<a href="#l2.2087"></a><span id="l2.2087" class="difflineminus">-    nsresult    rv = NS_OK;</span>
<a href="#l2.2088"></a><span id="l2.2088" class="difflineminus">-</span>
<a href="#l2.2089"></a><span id="l2.2089" class="difflineminus">-    *theBookmark = nsnull;</span>
<a href="#l2.2090"></a><span id="l2.2090" class="difflineminus">-</span>
<a href="#l2.2091"></a><span id="l2.2091" class="difflineminus">-    nsCOMPtr&lt;nsISimpleEnumerator&gt;   srcList;</span>
<a href="#l2.2092"></a><span id="l2.2092" class="difflineminus">-    if (NS_FAILED(rv = GetSources(kWEB_ScheduleActive, kTrueLiteral, PR_TRUE, getter_AddRefs(srcList))))</span>
<a href="#l2.2093"></a><span id="l2.2093" class="difflineminus">-        return rv;</span>
<a href="#l2.2094"></a><span id="l2.2094" class="difflineminus">-</span>
<a href="#l2.2095"></a><span id="l2.2095" class="difflineminus">-    nsCOMPtr&lt;nsISupportsArray&gt; bookmarkList(do_CreateInstance(NS_SUPPORTSARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l2.2096"></a><span id="l2.2096" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l2.2097"></a><span id="l2.2097" class="difflineminus">-        return rv;</span>
<a href="#l2.2098"></a><span id="l2.2098" class="difflineminus">-</span>
<a href="#l2.2099"></a><span id="l2.2099" class="difflineminus">-    // build up a list of potential bookmarks to check</span>
<a href="#l2.2100"></a><span id="l2.2100" class="difflineminus">-    PRBool  hasMoreSrcs = PR_TRUE;</span>
<a href="#l2.2101"></a><span id="l2.2101" class="difflineminus">-    while(NS_SUCCEEDED(rv = srcList-&gt;HasMoreElements(&amp;hasMoreSrcs))</span>
<a href="#l2.2102"></a><span id="l2.2102" class="difflineminus">-        &amp;&amp; (hasMoreSrcs == PR_TRUE))</span>
<a href="#l2.2103"></a><span id="l2.2103" class="difflineminus">-    {</span>
<a href="#l2.2104"></a><span id="l2.2104" class="difflineminus">-        nsCOMPtr&lt;nsISupports&gt;   aSrc;</span>
<a href="#l2.2105"></a><span id="l2.2105" class="difflineminus">-        if (NS_FAILED(rv = srcList-&gt;GetNext(getter_AddRefs(aSrc))))</span>
<a href="#l2.2106"></a><span id="l2.2106" class="difflineminus">-            break;</span>
<a href="#l2.2107"></a><span id="l2.2107" class="difflineminus">-        nsCOMPtr&lt;nsIRDFResource&gt;    aSource = do_QueryInterface(aSrc);</span>
<a href="#l2.2108"></a><span id="l2.2108" class="difflineminus">-        if (!aSource)   continue;</span>
<a href="#l2.2109"></a><span id="l2.2109" class="difflineminus">-</span>
<a href="#l2.2110"></a><span id="l2.2110" class="difflineminus">-        // does the bookmark have a schedule, and if so,</span>
<a href="#l2.2111"></a><span id="l2.2111" class="difflineminus">-        // are we within its bounds for checking the URL?</span>
<a href="#l2.2112"></a><span id="l2.2112" class="difflineminus">-</span>
<a href="#l2.2113"></a><span id="l2.2113" class="difflineminus">-        PRBool  examineFlag = PR_FALSE;</span>
<a href="#l2.2114"></a><span id="l2.2114" class="difflineminus">-        if (NS_FAILED(rv = ExamineBookmarkSchedule(aSource, examineFlag))</span>
<a href="#l2.2115"></a><span id="l2.2115" class="difflineminus">-            || (examineFlag == PR_FALSE))   continue;</span>
<a href="#l2.2116"></a><span id="l2.2116" class="difflineminus">-</span>
<a href="#l2.2117"></a><span id="l2.2117" class="difflineminus">-        bookmarkList-&gt;AppendElement(aSource);</span>
<a href="#l2.2118"></a><span id="l2.2118" class="difflineminus">-    }</span>
<a href="#l2.2119"></a><span id="l2.2119" class="difflineminus">-</span>
<a href="#l2.2120"></a><span id="l2.2120" class="difflineminus">-    // pick a random entry from the list of bookmarks to check</span>
<a href="#l2.2121"></a><span id="l2.2121" class="difflineminus">-    PRUint32    numBookmarks;</span>
<a href="#l2.2122"></a><span id="l2.2122" class="difflineminus">-    if (NS_SUCCEEDED(rv = bookmarkList-&gt;Count(&amp;numBookmarks)) &amp;&amp; (numBookmarks &gt; 0))</span>
<a href="#l2.2123"></a><span id="l2.2123" class="difflineminus">-    {</span>
<a href="#l2.2124"></a><span id="l2.2124" class="difflineminus">-        PRInt32     randomNum;</span>
<a href="#l2.2125"></a><span id="l2.2125" class="difflineminus">-        LL_L2I(randomNum, PR_Now());</span>
<a href="#l2.2126"></a><span id="l2.2126" class="difflineminus">-        PRUint32    randomBookmark = (numBookmarks-1) % randomNum;</span>
<a href="#l2.2127"></a><span id="l2.2127" class="difflineminus">-</span>
<a href="#l2.2128"></a><span id="l2.2128" class="difflineminus">-        nsCOMPtr&lt;nsISupports&gt;   iSupports;</span>
<a href="#l2.2129"></a><span id="l2.2129" class="difflineminus">-        if (NS_SUCCEEDED(rv = bookmarkList-&gt;GetElementAt(randomBookmark,</span>
<a href="#l2.2130"></a><span id="l2.2130" class="difflineminus">-            getter_AddRefs(iSupports))))</span>
<a href="#l2.2131"></a><span id="l2.2131" class="difflineminus">-        {</span>
<a href="#l2.2132"></a><span id="l2.2132" class="difflineminus">-            nsCOMPtr&lt;nsIRDFResource&gt;    aBookmark = do_QueryInterface(iSupports);</span>
<a href="#l2.2133"></a><span id="l2.2133" class="difflineminus">-            if (aBookmark)</span>
<a href="#l2.2134"></a><span id="l2.2134" class="difflineminus">-            {</span>
<a href="#l2.2135"></a><span id="l2.2135" class="difflineminus">-                *theBookmark = aBookmark;</span>
<a href="#l2.2136"></a><span id="l2.2136" class="difflineminus">-                NS_ADDREF(*theBookmark);</span>
<a href="#l2.2137"></a><span id="l2.2137" class="difflineminus">-            }</span>
<a href="#l2.2138"></a><span id="l2.2138" class="difflineminus">-        }</span>
<a href="#l2.2139"></a><span id="l2.2139" class="difflineminus">-    }</span>
<a href="#l2.2140"></a><span id="l2.2140" class="difflineminus">-    return rv;</span>
<a href="#l2.2141"></a><span id="l2.2141" class="difflineminus">-}</span>
<a href="#l2.2142"></a><span id="l2.2142" class="difflineminus">-</span>
<a href="#l2.2143"></a><span id="l2.2143" class="difflineminus">-void</span>
<a href="#l2.2144"></a><span id="l2.2144" class="difflineminus">-nsBookmarksService::FireTimer(nsITimer* aTimer, void* aClosure)</span>
<a href="#l2.2145"></a><span id="l2.2145" class="difflineminus">-{</span>
<a href="#l2.2146"></a><span id="l2.2146" class="difflineminus">-    nsBookmarksService *bmks = static_cast&lt;nsBookmarksService *&gt;(aClosure);</span>
<a href="#l2.2147"></a><span id="l2.2147" class="difflineminus">-    if (!bmks)  return;</span>
<a href="#l2.2148"></a><span id="l2.2148" class="difflineminus">-    nsresult            rv;</span>
<a href="#l2.2149"></a><span id="l2.2149" class="difflineminus">-</span>
<a href="#l2.2150"></a><span id="l2.2150" class="difflineminus">-    if (bmks-&gt;mDirty)</span>
<a href="#l2.2151"></a><span id="l2.2151" class="difflineminus">-    {</span>
<a href="#l2.2152"></a><span id="l2.2152" class="difflineminus">-        bmks-&gt;Flush();</span>
<a href="#l2.2153"></a><span id="l2.2153" class="difflineminus">-    }</span>
<a href="#l2.2154"></a><span id="l2.2154" class="difflineminus">-</span>
<a href="#l2.2155"></a><span id="l2.2155" class="difflineminus">-    if (bmks-&gt;busySchedule == PR_FALSE)</span>
<a href="#l2.2156"></a><span id="l2.2156" class="difflineminus">-    {</span>
<a href="#l2.2157"></a><span id="l2.2157" class="difflineminus">-        nsCOMPtr&lt;nsIRDFResource&gt;    bookmark;</span>
<a href="#l2.2158"></a><span id="l2.2158" class="difflineminus">-        if (NS_SUCCEEDED(rv = bmks-&gt;GetBookmarkToPing(getter_AddRefs(bookmark))) &amp;&amp; (bookmark))</span>
<a href="#l2.2159"></a><span id="l2.2159" class="difflineminus">-        {</span>
<a href="#l2.2160"></a><span id="l2.2160" class="difflineminus">-            bmks-&gt;busyResource = bookmark;</span>
<a href="#l2.2161"></a><span id="l2.2161" class="difflineminus">-</span>
<a href="#l2.2162"></a><span id="l2.2162" class="difflineminus">-            nsAutoString url;</span>
<a href="#l2.2163"></a><span id="l2.2163" class="difflineminus">-            rv = bmks-&gt;GetURLFromResource(bookmark, url);</span>
<a href="#l2.2164"></a><span id="l2.2164" class="difflineminus">-            if (NS_FAILED(rv))</span>
<a href="#l2.2165"></a><span id="l2.2165" class="difflineminus">-                return;</span>
<a href="#l2.2166"></a><span id="l2.2166" class="difflineminus">-</span>
<a href="#l2.2167"></a><span id="l2.2167" class="difflineminus">-#ifdef  DEBUG_BOOKMARK_PING_OUTPUT</span>
<a href="#l2.2168"></a><span id="l2.2168" class="difflineminus">-            printf(&quot;nsBookmarksService::FireTimer - Pinging '%s'\n&quot;,</span>
<a href="#l2.2169"></a><span id="l2.2169" class="difflineminus">-                   NS_ConvertUTF16toUTF8(url).get());</span>
<a href="#l2.2170"></a><span id="l2.2170" class="difflineminus">-#endif</span>
<a href="#l2.2171"></a><span id="l2.2171" class="difflineminus">-</span>
<a href="#l2.2172"></a><span id="l2.2172" class="difflineminus">-            nsCOMPtr&lt;nsIURI&gt;    uri;</span>
<a href="#l2.2173"></a><span id="l2.2173" class="difflineminus">-            if (NS_SUCCEEDED(rv = NS_NewURI(getter_AddRefs(uri), url)))</span>
<a href="#l2.2174"></a><span id="l2.2174" class="difflineminus">-            {</span>
<a href="#l2.2175"></a><span id="l2.2175" class="difflineminus">-                nsCOMPtr&lt;nsIChannel&gt;    channel;</span>
<a href="#l2.2176"></a><span id="l2.2176" class="difflineminus">-                if (NS_SUCCEEDED(rv = NS_NewChannel(getter_AddRefs(channel), uri, nsnull)))</span>
<a href="#l2.2177"></a><span id="l2.2177" class="difflineminus">-                {</span>
<a href="#l2.2178"></a><span id="l2.2178" class="difflineminus">-                    channel-&gt;SetLoadFlags(nsIRequest::VALIDATE_ALWAYS);</span>
<a href="#l2.2179"></a><span id="l2.2179" class="difflineminus">-                    nsCOMPtr&lt;nsIHttpChannel&gt;    httpChannel = do_QueryInterface(channel);</span>
<a href="#l2.2180"></a><span id="l2.2180" class="difflineminus">-                    if (httpChannel)</span>
<a href="#l2.2181"></a><span id="l2.2181" class="difflineminus">-                    {</span>
<a href="#l2.2182"></a><span id="l2.2182" class="difflineminus">-                        bmks-&gt;htmlSize = 0;</span>
<a href="#l2.2183"></a><span id="l2.2183" class="difflineminus">-                        httpChannel-&gt;SetRequestMethod(NS_LITERAL_CSTRING(&quot;HEAD&quot;));</span>
<a href="#l2.2184"></a><span id="l2.2184" class="difflineminus">-                        if (NS_SUCCEEDED(rv = channel-&gt;AsyncOpen(bmks, nsnull)))</span>
<a href="#l2.2185"></a><span id="l2.2185" class="difflineminus">-                        {</span>
<a href="#l2.2186"></a><span id="l2.2186" class="difflineminus">-                            bmks-&gt;busySchedule = PR_TRUE;</span>
<a href="#l2.2187"></a><span id="l2.2187" class="difflineminus">-                        }</span>
<a href="#l2.2188"></a><span id="l2.2188" class="difflineminus">-                    }</span>
<a href="#l2.2189"></a><span id="l2.2189" class="difflineminus">-                }</span>
<a href="#l2.2190"></a><span id="l2.2190" class="difflineminus">-            }</span>
<a href="#l2.2191"></a><span id="l2.2191" class="difflineminus">-        }</span>
<a href="#l2.2192"></a><span id="l2.2192" class="difflineminus">-    }</span>
<a href="#l2.2193"></a><span id="l2.2193" class="difflineminus">-#ifdef  DEBUG_BOOKMARK_PING_OUTPUT</span>
<a href="#l2.2194"></a><span id="l2.2194" class="difflineminus">-    else</span>
<a href="#l2.2195"></a><span id="l2.2195" class="difflineminus">-    {</span>
<a href="#l2.2196"></a><span id="l2.2196" class="difflineminus">-        printf(&quot;nsBookmarksService::FireTimer - busy pinging.\n&quot;);</span>
<a href="#l2.2197"></a><span id="l2.2197" class="difflineminus">-    }</span>
<a href="#l2.2198"></a><span id="l2.2198" class="difflineminus">-#endif</span>
<a href="#l2.2199"></a><span id="l2.2199" class="difflineminus">-}</span>
<a href="#l2.2200"></a><span id="l2.2200" class="difflineminus">-</span>
<a href="#l2.2201"></a><span id="l2.2201" class="difflineminus">-</span>
<a href="#l2.2202"></a><span id="l2.2202" class="difflineminus">-// stream observer methods</span>
<a href="#l2.2203"></a><span id="l2.2203" class="difflineminus">-</span>
<a href="#l2.2204"></a><span id="l2.2204" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l2.2205"></a><span id="l2.2205" class="difflineminus">-nsBookmarksService::OnStartRequest(nsIRequest* request, nsISupports *ctxt)</span>
<a href="#l2.2206"></a><span id="l2.2206" class="difflineminus">-{</span>
<a href="#l2.2207"></a><span id="l2.2207" class="difflineminus">-    return NS_OK;</span>
<a href="#l2.2208"></a><span id="l2.2208" class="difflineminus">-}</span>
<a href="#l2.2209"></a><span id="l2.2209" class="difflineminus">-</span>
<a href="#l2.2210"></a><span id="l2.2210" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l2.2211"></a><span id="l2.2211" class="difflineminus">-nsBookmarksService::OnDataAvailable(nsIRequest* request, nsISupports *ctxt, nsIInputStream *aIStream,</span>
<a href="#l2.2212"></a><span id="l2.2212" class="difflineminus">-                      PRUint32 sourceOffset, PRUint32 aLength)</span>
<a href="#l2.2213"></a><span id="l2.2213" class="difflineminus">-{</span>
<a href="#l2.2214"></a><span id="l2.2214" class="difflineminus">-    // calculate html page size if server doesn't tell us in headers</span>
<a href="#l2.2215"></a><span id="l2.2215" class="difflineminus">-    htmlSize += aLength;</span>
<a href="#l2.2216"></a><span id="l2.2216" class="difflineminus">-</span>
<a href="#l2.2217"></a><span id="l2.2217" class="difflineminus">-    return NS_OK;</span>
<a href="#l2.2218"></a><span id="l2.2218" class="difflineminus">-}</span>
<a href="#l2.2219"></a><span id="l2.2219" class="difflineminus">-</span>
<a href="#l2.2220"></a><span id="l2.2220" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l2.2221"></a><span id="l2.2221" class="difflineminus">-nsBookmarksService::OnStopRequest(nsIRequest* request, nsISupports *ctxt,</span>
<a href="#l2.2222"></a><span id="l2.2222" class="difflineminus">-                    nsresult status)</span>
<a href="#l2.2223"></a><span id="l2.2223" class="difflineminus">-{</span>
<a href="#l2.2224"></a><span id="l2.2224" class="difflineminus">-    nsresult rv;</span>
<a href="#l2.2225"></a><span id="l2.2225" class="difflineminus">-</span>
<a href="#l2.2226"></a><span id="l2.2226" class="difflineminus">-    nsAutoString url;</span>
<a href="#l2.2227"></a><span id="l2.2227" class="difflineminus">-    if (NS_SUCCEEDED(rv = GetURLFromResource(busyResource, url)))</span>
<a href="#l2.2228"></a><span id="l2.2228" class="difflineminus">-    {</span>
<a href="#l2.2229"></a><span id="l2.2229" class="difflineminus">-#ifdef  DEBUG_BOOKMARK_PING_OUTPUT</span>
<a href="#l2.2230"></a><span id="l2.2230" class="difflineminus">-        printf(&quot;Finished polling '%s'\n&quot;, NS_ConvertUTF16toUTF8(url).get());</span>
<a href="#l2.2231"></a><span id="l2.2231" class="difflineminus">-#endif</span>
<a href="#l2.2232"></a><span id="l2.2232" class="difflineminus">-    }</span>
<a href="#l2.2233"></a><span id="l2.2233" class="difflineminus">-    nsCOMPtr&lt;nsIChannel&gt; channel = do_QueryInterface(request);</span>
<a href="#l2.2234"></a><span id="l2.2234" class="difflineminus">-    nsCOMPtr&lt;nsIHttpChannel&gt;    httpChannel = do_QueryInterface(channel);</span>
<a href="#l2.2235"></a><span id="l2.2235" class="difflineminus">-    if (httpChannel)</span>
<a href="#l2.2236"></a><span id="l2.2236" class="difflineminus">-    {</span>
<a href="#l2.2237"></a><span id="l2.2237" class="difflineminus">-        nsAutoString            eTagValue, lastModValue, contentLengthValue;</span>
<a href="#l2.2238"></a><span id="l2.2238" class="difflineminus">-</span>
<a href="#l2.2239"></a><span id="l2.2239" class="difflineminus">-        nsCAutoString val;</span>
<a href="#l2.2240"></a><span id="l2.2240" class="difflineminus">-        if (NS_SUCCEEDED(httpChannel-&gt;GetResponseHeader(NS_LITERAL_CSTRING(&quot;ETag&quot;), val)))</span>
<a href="#l2.2241"></a><span id="l2.2241" class="difflineminus">-            CopyASCIItoUTF16(val, eTagValue);</span>
<a href="#l2.2242"></a><span id="l2.2242" class="difflineminus">-        if (NS_SUCCEEDED(httpChannel-&gt;GetResponseHeader(NS_LITERAL_CSTRING(&quot;Last-Modified&quot;), val)))</span>
<a href="#l2.2243"></a><span id="l2.2243" class="difflineminus">-            CopyASCIItoUTF16(val, lastModValue);</span>
<a href="#l2.2244"></a><span id="l2.2244" class="difflineminus">-        if (NS_SUCCEEDED(httpChannel-&gt;GetResponseHeader(NS_LITERAL_CSTRING(&quot;Content-Length&quot;), val)))</span>
<a href="#l2.2245"></a><span id="l2.2245" class="difflineminus">-            CopyASCIItoUTF16(val, contentLengthValue);</span>
<a href="#l2.2246"></a><span id="l2.2246" class="difflineminus">-        val.Truncate();</span>
<a href="#l2.2247"></a><span id="l2.2247" class="difflineminus">-</span>
<a href="#l2.2248"></a><span id="l2.2248" class="difflineminus">-        PRBool      changedFlag = PR_FALSE;</span>
<a href="#l2.2249"></a><span id="l2.2249" class="difflineminus">-</span>
<a href="#l2.2250"></a><span id="l2.2250" class="difflineminus">-        PRUint32    respStatus;</span>
<a href="#l2.2251"></a><span id="l2.2251" class="difflineminus">-        if (NS_SUCCEEDED(rv = httpChannel-&gt;GetResponseStatus(&amp;respStatus)))</span>
<a href="#l2.2252"></a><span id="l2.2252" class="difflineminus">-        {</span>
<a href="#l2.2253"></a><span id="l2.2253" class="difflineminus">-            if ((respStatus &gt;= 200) &amp;&amp; (respStatus &lt;= 299))</span>
<a href="#l2.2254"></a><span id="l2.2254" class="difflineminus">-            {</span>
<a href="#l2.2255"></a><span id="l2.2255" class="difflineminus">-                if (!eTagValue.IsEmpty())</span>
<a href="#l2.2256"></a><span id="l2.2256" class="difflineminus">-                {</span>
<a href="#l2.2257"></a><span id="l2.2257" class="difflineminus">-#ifdef  DEBUG_BOOKMARK_PING_OUTPUT</span>
<a href="#l2.2258"></a><span id="l2.2258" class="difflineminus">-                    printf(&quot;eTag: '%s'\n&quot;, NS_ConvertUTF16toUTF8(eTagValue).get());</span>
<a href="#l2.2259"></a><span id="l2.2259" class="difflineminus">-#endif</span>
<a href="#l2.2260"></a><span id="l2.2260" class="difflineminus">-                    nsAutoString        eTagStr;</span>
<a href="#l2.2261"></a><span id="l2.2261" class="difflineminus">-                    nsCOMPtr&lt;nsIRDFNode&gt;    currentETagNode;</span>
<a href="#l2.2262"></a><span id="l2.2262" class="difflineminus">-                    if (NS_SUCCEEDED(rv = mInner-&gt;GetTarget(busyResource, kWEB_LastPingETag,</span>
<a href="#l2.2263"></a><span id="l2.2263" class="difflineminus">-                        PR_TRUE, getter_AddRefs(currentETagNode))) &amp;&amp; (rv != NS_RDF_NO_VALUE))</span>
<a href="#l2.2264"></a><span id="l2.2264" class="difflineminus">-                    {</span>
<a href="#l2.2265"></a><span id="l2.2265" class="difflineminus">-                        nsCOMPtr&lt;nsIRDFLiteral&gt; currentETagLit = do_QueryInterface(currentETagNode);</span>
<a href="#l2.2266"></a><span id="l2.2266" class="difflineminus">-                        if (currentETagLit)</span>
<a href="#l2.2267"></a><span id="l2.2267" class="difflineminus">-                        {</span>
<a href="#l2.2268"></a><span id="l2.2268" class="difflineminus">-                            const PRUnichar* currentETagStr = nsnull;</span>
<a href="#l2.2269"></a><span id="l2.2269" class="difflineminus">-                            currentETagLit-&gt;GetValueConst(&amp;currentETagStr);</span>
<a href="#l2.2270"></a><span id="l2.2270" class="difflineminus">-                            if ((currentETagStr) &amp;&amp;</span>
<a href="#l2.2271"></a><span id="l2.2271" class="difflineminus">-                                !eTagValue.Equals(nsDependentString(currentETagStr),</span>
<a href="#l2.2272"></a><span id="l2.2272" class="difflineminus">-                                                  CaseInsensitiveCompare))</span>
<a href="#l2.2273"></a><span id="l2.2273" class="difflineminus">-                            {</span>
<a href="#l2.2274"></a><span id="l2.2274" class="difflineminus">-                                changedFlag = PR_TRUE;</span>
<a href="#l2.2275"></a><span id="l2.2275" class="difflineminus">-                            }</span>
<a href="#l2.2276"></a><span id="l2.2276" class="difflineminus">-                            eTagStr.Assign(eTagValue);</span>
<a href="#l2.2277"></a><span id="l2.2277" class="difflineminus">-                            nsCOMPtr&lt;nsIRDFLiteral&gt; newETagLiteral;</span>
<a href="#l2.2278"></a><span id="l2.2278" class="difflineminus">-                            if (NS_SUCCEEDED(rv = gRDF-&gt;GetLiteral(eTagStr.get(),</span>
<a href="#l2.2279"></a><span id="l2.2279" class="difflineminus">-                                getter_AddRefs(newETagLiteral))))</span>
<a href="#l2.2280"></a><span id="l2.2280" class="difflineminus">-                            {</span>
<a href="#l2.2281"></a><span id="l2.2281" class="difflineminus">-                                rv = mInner-&gt;Change(busyResource, kWEB_LastPingETag,</span>
<a href="#l2.2282"></a><span id="l2.2282" class="difflineminus">-                                    currentETagNode, newETagLiteral);</span>
<a href="#l2.2283"></a><span id="l2.2283" class="difflineminus">-                            }</span>
<a href="#l2.2284"></a><span id="l2.2284" class="difflineminus">-                        }</span>
<a href="#l2.2285"></a><span id="l2.2285" class="difflineminus">-                    }</span>
<a href="#l2.2286"></a><span id="l2.2286" class="difflineminus">-                    else</span>
<a href="#l2.2287"></a><span id="l2.2287" class="difflineminus">-                    {</span>
<a href="#l2.2288"></a><span id="l2.2288" class="difflineminus">-                        eTagStr.Assign(eTagValue);</span>
<a href="#l2.2289"></a><span id="l2.2289" class="difflineminus">-                        nsCOMPtr&lt;nsIRDFLiteral&gt; newETagLiteral;</span>
<a href="#l2.2290"></a><span id="l2.2290" class="difflineminus">-                        if (NS_SUCCEEDED(rv = gRDF-&gt;GetLiteral(eTagStr.get(),</span>
<a href="#l2.2291"></a><span id="l2.2291" class="difflineminus">-                            getter_AddRefs(newETagLiteral))))</span>
<a href="#l2.2292"></a><span id="l2.2292" class="difflineminus">-                        {</span>
<a href="#l2.2293"></a><span id="l2.2293" class="difflineminus">-                            rv = mInner-&gt;Assert(busyResource, kWEB_LastPingETag,</span>
<a href="#l2.2294"></a><span id="l2.2294" class="difflineminus">-                                newETagLiteral, PR_TRUE);</span>
<a href="#l2.2295"></a><span id="l2.2295" class="difflineminus">-                        }</span>
<a href="#l2.2296"></a><span id="l2.2296" class="difflineminus">-                    }</span>
<a href="#l2.2297"></a><span id="l2.2297" class="difflineminus">-                }</span>
<a href="#l2.2298"></a><span id="l2.2298" class="difflineminus">-            }</span>
<a href="#l2.2299"></a><span id="l2.2299" class="difflineminus">-        }</span>
<a href="#l2.2300"></a><span id="l2.2300" class="difflineminus">-</span>
<a href="#l2.2301"></a><span id="l2.2301" class="difflineminus">-        if ((changedFlag == PR_FALSE) &amp;&amp; (!lastModValue.IsEmpty()))</span>
<a href="#l2.2302"></a><span id="l2.2302" class="difflineminus">-        {</span>
<a href="#l2.2303"></a><span id="l2.2303" class="difflineminus">-#ifdef  DEBUG_BOOKMARK_PING_OUTPUT</span>
<a href="#l2.2304"></a><span id="l2.2304" class="difflineminus">-            printf(&quot;Last-Modified: '%s'\n&quot;, lastModValue.get());</span>
<a href="#l2.2305"></a><span id="l2.2305" class="difflineminus">-#endif</span>
<a href="#l2.2306"></a><span id="l2.2306" class="difflineminus">-            nsAutoString        lastModStr;</span>
<a href="#l2.2307"></a><span id="l2.2307" class="difflineminus">-            nsCOMPtr&lt;nsIRDFNode&gt;    currentLastModNode;</span>
<a href="#l2.2308"></a><span id="l2.2308" class="difflineminus">-            if (NS_SUCCEEDED(rv = mInner-&gt;GetTarget(busyResource, kWEB_LastPingModDate,</span>
<a href="#l2.2309"></a><span id="l2.2309" class="difflineminus">-                PR_TRUE, getter_AddRefs(currentLastModNode))) &amp;&amp; (rv != NS_RDF_NO_VALUE))</span>
<a href="#l2.2310"></a><span id="l2.2310" class="difflineminus">-            {</span>
<a href="#l2.2311"></a><span id="l2.2311" class="difflineminus">-                nsCOMPtr&lt;nsIRDFLiteral&gt; currentLastModLit = do_QueryInterface(currentLastModNode);</span>
<a href="#l2.2312"></a><span id="l2.2312" class="difflineminus">-                if (currentLastModLit)</span>
<a href="#l2.2313"></a><span id="l2.2313" class="difflineminus">-                {</span>
<a href="#l2.2314"></a><span id="l2.2314" class="difflineminus">-                    const PRUnichar* currentLastModStr = nsnull;</span>
<a href="#l2.2315"></a><span id="l2.2315" class="difflineminus">-                    currentLastModLit-&gt;GetValueConst(&amp;currentLastModStr);</span>
<a href="#l2.2316"></a><span id="l2.2316" class="difflineminus">-                    if ((currentLastModStr) &amp;&amp;</span>
<a href="#l2.2317"></a><span id="l2.2317" class="difflineminus">-                        !lastModValue.Equals(nsDependentString(currentLastModStr),</span>
<a href="#l2.2318"></a><span id="l2.2318" class="difflineminus">-                                             CaseInsensitiveCompare))</span>
<a href="#l2.2319"></a><span id="l2.2319" class="difflineminus">-                    {</span>
<a href="#l2.2320"></a><span id="l2.2320" class="difflineminus">-                        changedFlag = PR_TRUE;</span>
<a href="#l2.2321"></a><span id="l2.2321" class="difflineminus">-                    }</span>
<a href="#l2.2322"></a><span id="l2.2322" class="difflineminus">-                    lastModStr.Assign(lastModValue);</span>
<a href="#l2.2323"></a><span id="l2.2323" class="difflineminus">-                    nsCOMPtr&lt;nsIRDFLiteral&gt; newLastModLiteral;</span>
<a href="#l2.2324"></a><span id="l2.2324" class="difflineminus">-                    if (NS_SUCCEEDED(rv = gRDF-&gt;GetLiteral(lastModStr.get(),</span>
<a href="#l2.2325"></a><span id="l2.2325" class="difflineminus">-                        getter_AddRefs(newLastModLiteral))))</span>
<a href="#l2.2326"></a><span id="l2.2326" class="difflineminus">-                    {</span>
<a href="#l2.2327"></a><span id="l2.2327" class="difflineminus">-                        rv = mInner-&gt;Change(busyResource, kWEB_LastPingModDate,</span>
<a href="#l2.2328"></a><span id="l2.2328" class="difflineminus">-                            currentLastModNode, newLastModLiteral);</span>
<a href="#l2.2329"></a><span id="l2.2329" class="difflineminus">-                    }</span>
<a href="#l2.2330"></a><span id="l2.2330" class="difflineminus">-                }</span>
<a href="#l2.2331"></a><span id="l2.2331" class="difflineminus">-            }</span>
<a href="#l2.2332"></a><span id="l2.2332" class="difflineminus">-            else</span>
<a href="#l2.2333"></a><span id="l2.2333" class="difflineminus">-            {</span>
<a href="#l2.2334"></a><span id="l2.2334" class="difflineminus">-                lastModStr.Assign(lastModValue);</span>
<a href="#l2.2335"></a><span id="l2.2335" class="difflineminus">-                nsCOMPtr&lt;nsIRDFLiteral&gt; newLastModLiteral;</span>
<a href="#l2.2336"></a><span id="l2.2336" class="difflineminus">-                if (NS_SUCCEEDED(rv = gRDF-&gt;GetLiteral(lastModStr.get(),</span>
<a href="#l2.2337"></a><span id="l2.2337" class="difflineminus">-                    getter_AddRefs(newLastModLiteral))))</span>
<a href="#l2.2338"></a><span id="l2.2338" class="difflineminus">-                {</span>
<a href="#l2.2339"></a><span id="l2.2339" class="difflineminus">-                    rv = mInner-&gt;Assert(busyResource, kWEB_LastPingModDate,</span>
<a href="#l2.2340"></a><span id="l2.2340" class="difflineminus">-                        newLastModLiteral, PR_TRUE);</span>
<a href="#l2.2341"></a><span id="l2.2341" class="difflineminus">-                }</span>
<a href="#l2.2342"></a><span id="l2.2342" class="difflineminus">-            }</span>
<a href="#l2.2343"></a><span id="l2.2343" class="difflineminus">-        }</span>
<a href="#l2.2344"></a><span id="l2.2344" class="difflineminus">-</span>
<a href="#l2.2345"></a><span id="l2.2345" class="difflineminus">-        if ((changedFlag == PR_FALSE) &amp;&amp; (!contentLengthValue.IsEmpty()))</span>
<a href="#l2.2346"></a><span id="l2.2346" class="difflineminus">-        {</span>
<a href="#l2.2347"></a><span id="l2.2347" class="difflineminus">-#ifdef  DEBUG_BOOKMARK_PING_OUTPUT</span>
<a href="#l2.2348"></a><span id="l2.2348" class="difflineminus">-            printf(&quot;Content-Length: '%s'\n&quot;, contentLengthValue.get());</span>
<a href="#l2.2349"></a><span id="l2.2349" class="difflineminus">-#endif</span>
<a href="#l2.2350"></a><span id="l2.2350" class="difflineminus">-            nsAutoString        contentLenStr;</span>
<a href="#l2.2351"></a><span id="l2.2351" class="difflineminus">-            nsCOMPtr&lt;nsIRDFNode&gt;    currentContentLengthNode;</span>
<a href="#l2.2352"></a><span id="l2.2352" class="difflineminus">-            if (NS_SUCCEEDED(rv = mInner-&gt;GetTarget(busyResource, kWEB_LastPingContentLen,</span>
<a href="#l2.2353"></a><span id="l2.2353" class="difflineminus">-                PR_TRUE, getter_AddRefs(currentContentLengthNode))) &amp;&amp; (rv != NS_RDF_NO_VALUE))</span>
<a href="#l2.2354"></a><span id="l2.2354" class="difflineminus">-            {</span>
<a href="#l2.2355"></a><span id="l2.2355" class="difflineminus">-                nsCOMPtr&lt;nsIRDFLiteral&gt; currentContentLengthLit = do_QueryInterface(currentContentLengthNode);</span>
<a href="#l2.2356"></a><span id="l2.2356" class="difflineminus">-                if (currentContentLengthLit)</span>
<a href="#l2.2357"></a><span id="l2.2357" class="difflineminus">-                {</span>
<a href="#l2.2358"></a><span id="l2.2358" class="difflineminus">-                    const PRUnichar *currentContentLengthStr = nsnull;</span>
<a href="#l2.2359"></a><span id="l2.2359" class="difflineminus">-                    currentContentLengthLit-&gt;GetValueConst(&amp;currentContentLengthStr);</span>
<a href="#l2.2360"></a><span id="l2.2360" class="difflineminus">-                    if ((currentContentLengthStr) &amp;&amp;</span>
<a href="#l2.2361"></a><span id="l2.2361" class="difflineminus">-                        !contentLengthValue.Equals(nsDependentString(currentContentLengthStr),</span>
<a href="#l2.2362"></a><span id="l2.2362" class="difflineminus">-                                                   CaseInsensitiveCompare))</span>
<a href="#l2.2363"></a><span id="l2.2363" class="difflineminus">-                    {</span>
<a href="#l2.2364"></a><span id="l2.2364" class="difflineminus">-                        changedFlag = PR_TRUE;</span>
<a href="#l2.2365"></a><span id="l2.2365" class="difflineminus">-                    }</span>
<a href="#l2.2366"></a><span id="l2.2366" class="difflineminus">-                    contentLenStr.Assign(contentLengthValue);</span>
<a href="#l2.2367"></a><span id="l2.2367" class="difflineminus">-                    nsCOMPtr&lt;nsIRDFLiteral&gt; newContentLengthLiteral;</span>
<a href="#l2.2368"></a><span id="l2.2368" class="difflineminus">-                    if (NS_SUCCEEDED(rv = gRDF-&gt;GetLiteral(contentLenStr.get(),</span>
<a href="#l2.2369"></a><span id="l2.2369" class="difflineminus">-                        getter_AddRefs(newContentLengthLiteral))))</span>
<a href="#l2.2370"></a><span id="l2.2370" class="difflineminus">-                    {</span>
<a href="#l2.2371"></a><span id="l2.2371" class="difflineminus">-                        rv = mInner-&gt;Change(busyResource, kWEB_LastPingContentLen,</span>
<a href="#l2.2372"></a><span id="l2.2372" class="difflineminus">-                            currentContentLengthNode, newContentLengthLiteral);</span>
<a href="#l2.2373"></a><span id="l2.2373" class="difflineminus">-                    }</span>
<a href="#l2.2374"></a><span id="l2.2374" class="difflineminus">-                }</span>
<a href="#l2.2375"></a><span id="l2.2375" class="difflineminus">-            }</span>
<a href="#l2.2376"></a><span id="l2.2376" class="difflineminus">-            else</span>
<a href="#l2.2377"></a><span id="l2.2377" class="difflineminus">-            {</span>
<a href="#l2.2378"></a><span id="l2.2378" class="difflineminus">-                contentLenStr.Assign(contentLengthValue);</span>
<a href="#l2.2379"></a><span id="l2.2379" class="difflineminus">-                nsCOMPtr&lt;nsIRDFLiteral&gt; newContentLengthLiteral;</span>
<a href="#l2.2380"></a><span id="l2.2380" class="difflineminus">-                if (NS_SUCCEEDED(rv = gRDF-&gt;GetLiteral(contentLenStr.get(),</span>
<a href="#l2.2381"></a><span id="l2.2381" class="difflineminus">-                    getter_AddRefs(newContentLengthLiteral))))</span>
<a href="#l2.2382"></a><span id="l2.2382" class="difflineminus">-                {</span>
<a href="#l2.2383"></a><span id="l2.2383" class="difflineminus">-                    rv = mInner-&gt;Assert(busyResource, kWEB_LastPingContentLen,</span>
<a href="#l2.2384"></a><span id="l2.2384" class="difflineminus">-                        newContentLengthLiteral, PR_TRUE);</span>
<a href="#l2.2385"></a><span id="l2.2385" class="difflineminus">-                }</span>
<a href="#l2.2386"></a><span id="l2.2386" class="difflineminus">-            }</span>
<a href="#l2.2387"></a><span id="l2.2387" class="difflineminus">-        }</span>
<a href="#l2.2388"></a><span id="l2.2388" class="difflineminus">-</span>
<a href="#l2.2389"></a><span id="l2.2389" class="difflineminus">-        // update last poll date</span>
<a href="#l2.2390"></a><span id="l2.2390" class="difflineminus">-        nsCOMPtr&lt;nsIRDFDate&gt;    dateLiteral;</span>
<a href="#l2.2391"></a><span id="l2.2391" class="difflineminus">-        if (NS_SUCCEEDED(rv = gRDF-&gt;GetDateLiteral(PR_Now(), getter_AddRefs(dateLiteral))))</span>
<a href="#l2.2392"></a><span id="l2.2392" class="difflineminus">-        {</span>
<a href="#l2.2393"></a><span id="l2.2393" class="difflineminus">-            nsCOMPtr&lt;nsIRDFNode&gt;    lastPingNode;</span>
<a href="#l2.2394"></a><span id="l2.2394" class="difflineminus">-            if (NS_SUCCEEDED(rv = mInner-&gt;GetTarget(busyResource, kWEB_LastPingDate, PR_TRUE,</span>
<a href="#l2.2395"></a><span id="l2.2395" class="difflineminus">-                getter_AddRefs(lastPingNode))) &amp;&amp; (rv != NS_RDF_NO_VALUE))</span>
<a href="#l2.2396"></a><span id="l2.2396" class="difflineminus">-            {</span>
<a href="#l2.2397"></a><span id="l2.2397" class="difflineminus">-                rv = mInner-&gt;Change(busyResource, kWEB_LastPingDate, lastPingNode, dateLiteral);</span>
<a href="#l2.2398"></a><span id="l2.2398" class="difflineminus">-            }</span>
<a href="#l2.2399"></a><span id="l2.2399" class="difflineminus">-            else</span>
<a href="#l2.2400"></a><span id="l2.2400" class="difflineminus">-            {</span>
<a href="#l2.2401"></a><span id="l2.2401" class="difflineminus">-                rv = mInner-&gt;Assert(busyResource, kWEB_LastPingDate, dateLiteral, PR_TRUE);</span>
<a href="#l2.2402"></a><span id="l2.2402" class="difflineminus">-            }</span>
<a href="#l2.2403"></a><span id="l2.2403" class="difflineminus">-            NS_ASSERTION(rv == NS_RDF_ASSERTION_ACCEPTED, &quot;unable to assert new time&quot;);</span>
<a href="#l2.2404"></a><span id="l2.2404" class="difflineminus">-</span>
<a href="#l2.2405"></a><span id="l2.2405" class="difflineminus">-//          mDirty = PR_TRUE;</span>
<a href="#l2.2406"></a><span id="l2.2406" class="difflineminus">-        }</span>
<a href="#l2.2407"></a><span id="l2.2407" class="difflineminus">-        else</span>
<a href="#l2.2408"></a><span id="l2.2408" class="difflineminus">-        {</span>
<a href="#l2.2409"></a><span id="l2.2409" class="difflineminus">-            NS_ERROR(&quot;unable to get date literal for now&quot;);</span>
<a href="#l2.2410"></a><span id="l2.2410" class="difflineminus">-        }</span>
<a href="#l2.2411"></a><span id="l2.2411" class="difflineminus">-</span>
<a href="#l2.2412"></a><span id="l2.2412" class="difflineminus">-        // If its changed, set the appropriate info</span>
<a href="#l2.2413"></a><span id="l2.2413" class="difflineminus">-        if (changedFlag == PR_TRUE)</span>
<a href="#l2.2414"></a><span id="l2.2414" class="difflineminus">-        {</span>
<a href="#l2.2415"></a><span id="l2.2415" class="difflineminus">-#ifdef  DEBUG_BOOKMARK_PING_OUTPUT</span>
<a href="#l2.2416"></a><span id="l2.2416" class="difflineminus">-            printf(&quot;URL has changed!\n\n&quot;);</span>
<a href="#l2.2417"></a><span id="l2.2417" class="difflineminus">-#endif</span>
<a href="#l2.2418"></a><span id="l2.2418" class="difflineminus">-</span>
<a href="#l2.2419"></a><span id="l2.2419" class="difflineminus">-            nsAutoString        schedule;</span>
<a href="#l2.2420"></a><span id="l2.2420" class="difflineminus">-</span>
<a href="#l2.2421"></a><span id="l2.2421" class="difflineminus">-            nsCOMPtr&lt;nsIRDFNode&gt;    scheduleNode;</span>
<a href="#l2.2422"></a><span id="l2.2422" class="difflineminus">-            if (NS_SUCCEEDED(rv = mInner-&gt;GetTarget(busyResource, kWEB_Schedule, PR_TRUE,</span>
<a href="#l2.2423"></a><span id="l2.2423" class="difflineminus">-                getter_AddRefs(scheduleNode))) &amp;&amp; (rv != NS_RDF_NO_VALUE))</span>
<a href="#l2.2424"></a><span id="l2.2424" class="difflineminus">-            {</span>
<a href="#l2.2425"></a><span id="l2.2425" class="difflineminus">-                nsCOMPtr&lt;nsIRDFLiteral&gt; scheduleLiteral = do_QueryInterface(scheduleNode);</span>
<a href="#l2.2426"></a><span id="l2.2426" class="difflineminus">-                if (scheduleLiteral)</span>
<a href="#l2.2427"></a><span id="l2.2427" class="difflineminus">-                {</span>
<a href="#l2.2428"></a><span id="l2.2428" class="difflineminus">-                    const PRUnichar     *scheduleUni = nsnull;</span>
<a href="#l2.2429"></a><span id="l2.2429" class="difflineminus">-                    if (NS_SUCCEEDED(rv = scheduleLiteral-&gt;GetValueConst(&amp;scheduleUni))</span>
<a href="#l2.2430"></a><span id="l2.2430" class="difflineminus">-                        &amp;&amp; (scheduleUni))</span>
<a href="#l2.2431"></a><span id="l2.2431" class="difflineminus">-                    {</span>
<a href="#l2.2432"></a><span id="l2.2432" class="difflineminus">-                        schedule = scheduleUni;</span>
<a href="#l2.2433"></a><span id="l2.2433" class="difflineminus">-                    }</span>
<a href="#l2.2434"></a><span id="l2.2434" class="difflineminus">-                }</span>
<a href="#l2.2435"></a><span id="l2.2435" class="difflineminus">-            }</span>
<a href="#l2.2436"></a><span id="l2.2436" class="difflineminus">-</span>
<a href="#l2.2437"></a><span id="l2.2437" class="difflineminus">-            // update icon?</span>
<a href="#l2.2438"></a><span id="l2.2438" class="difflineminus">-            if (schedule.Find(NS_LITERAL_STRING(&quot;icon&quot;), PR_TRUE) != -1)</span>
<a href="#l2.2439"></a><span id="l2.2439" class="difflineminus">-            {</span>
<a href="#l2.2440"></a><span id="l2.2440" class="difflineminus">-                nsCOMPtr&lt;nsIRDFLiteral&gt; statusLiteral;</span>
<a href="#l2.2441"></a><span id="l2.2441" class="difflineminus">-                if (NS_SUCCEEDED(rv = gRDF-&gt;GetLiteral(NS_LITERAL_STRING(&quot;new&quot;).get(), getter_AddRefs(statusLiteral))))</span>
<a href="#l2.2442"></a><span id="l2.2442" class="difflineminus">-                {</span>
<a href="#l2.2443"></a><span id="l2.2443" class="difflineminus">-                    nsCOMPtr&lt;nsIRDFNode&gt;    currentStatusNode;</span>
<a href="#l2.2444"></a><span id="l2.2444" class="difflineminus">-                    if (NS_SUCCEEDED(rv = mInner-&gt;GetTarget(busyResource, kWEB_Status, PR_TRUE,</span>
<a href="#l2.2445"></a><span id="l2.2445" class="difflineminus">-                        getter_AddRefs(currentStatusNode))) &amp;&amp; (rv != NS_RDF_NO_VALUE))</span>
<a href="#l2.2446"></a><span id="l2.2446" class="difflineminus">-                    {</span>
<a href="#l2.2447"></a><span id="l2.2447" class="difflineminus">-                        rv = mInner-&gt;Change(busyResource, kWEB_Status, currentStatusNode, statusLiteral);</span>
<a href="#l2.2448"></a><span id="l2.2448" class="difflineminus">-                    }</span>
<a href="#l2.2449"></a><span id="l2.2449" class="difflineminus">-                    else</span>
<a href="#l2.2450"></a><span id="l2.2450" class="difflineminus">-                    {</span>
<a href="#l2.2451"></a><span id="l2.2451" class="difflineminus">-                        rv = mInner-&gt;Assert(busyResource, kWEB_Status, statusLiteral, PR_TRUE);</span>
<a href="#l2.2452"></a><span id="l2.2452" class="difflineminus">-                    }</span>
<a href="#l2.2453"></a><span id="l2.2453" class="difflineminus">-                    NS_ASSERTION(rv == NS_RDF_ASSERTION_ACCEPTED, &quot;unable to assert changed status&quot;);</span>
<a href="#l2.2454"></a><span id="l2.2454" class="difflineminus">-                }</span>
<a href="#l2.2455"></a><span id="l2.2455" class="difflineminus">-            }</span>
<a href="#l2.2456"></a><span id="l2.2456" class="difflineminus">-            </span>
<a href="#l2.2457"></a><span id="l2.2457" class="difflineminus">-            // play a sound?</span>
<a href="#l2.2458"></a><span id="l2.2458" class="difflineminus">-            if (schedule.Find(NS_LITERAL_STRING(&quot;sound&quot;), PR_TRUE) != -1)</span>
<a href="#l2.2459"></a><span id="l2.2459" class="difflineminus">-            {</span>
<a href="#l2.2460"></a><span id="l2.2460" class="difflineminus">-                nsCOMPtr&lt;nsISound&gt; soundInterface =</span>
<a href="#l2.2461"></a><span id="l2.2461" class="difflineminus">-                        do_CreateInstance(&quot;@mozilla.org/sound;1&quot;, &amp;rv);</span>
<a href="#l2.2462"></a><span id="l2.2462" class="difflineminus">-                if (NS_SUCCEEDED(rv))</span>
<a href="#l2.2463"></a><span id="l2.2463" class="difflineminus">-                {</span>
<a href="#l2.2464"></a><span id="l2.2464" class="difflineminus">-                    // for the moment, just beep</span>
<a href="#l2.2465"></a><span id="l2.2465" class="difflineminus">-                    soundInterface-&gt;Beep();</span>
<a href="#l2.2466"></a><span id="l2.2466" class="difflineminus">-                }</span>
<a href="#l2.2467"></a><span id="l2.2467" class="difflineminus">-            }</span>
<a href="#l2.2468"></a><span id="l2.2468" class="difflineminus">-            </span>
<a href="#l2.2469"></a><span id="l2.2469" class="difflineminus">-            PRBool      openURLFlag = PR_FALSE;</span>
<a href="#l2.2470"></a><span id="l2.2470" class="difflineminus">-</span>
<a href="#l2.2471"></a><span id="l2.2471" class="difflineminus">-            // show an alert?</span>
<a href="#l2.2472"></a><span id="l2.2472" class="difflineminus">-            if (schedule.Find(NS_LITERAL_STRING(&quot;alert&quot;), PR_TRUE) != -1)</span>
<a href="#l2.2473"></a><span id="l2.2473" class="difflineminus">-            {</span>
<a href="#l2.2474"></a><span id="l2.2474" class="difflineminus">-                nsCOMPtr&lt;nsIPrompt&gt; prompter;</span>
<a href="#l2.2475"></a><span id="l2.2475" class="difflineminus">-                NS_QueryNotificationCallbacks(channel, prompter);</span>
<a href="#l2.2476"></a><span id="l2.2476" class="difflineminus">-                if (!prompter)</span>
<a href="#l2.2477"></a><span id="l2.2477" class="difflineminus">-                {</span>
<a href="#l2.2478"></a><span id="l2.2478" class="difflineminus">-                    nsCOMPtr&lt;nsIWindowWatcher&gt; wwatch(do_GetService(NS_WINDOWWATCHER_CONTRACTID));</span>
<a href="#l2.2479"></a><span id="l2.2479" class="difflineminus">-                    if (wwatch)</span>
<a href="#l2.2480"></a><span id="l2.2480" class="difflineminus">-                        wwatch-&gt;GetNewPrompter(0, getter_AddRefs(prompter));</span>
<a href="#l2.2481"></a><span id="l2.2481" class="difflineminus">-                }</span>
<a href="#l2.2482"></a><span id="l2.2482" class="difflineminus">-</span>
<a href="#l2.2483"></a><span id="l2.2483" class="difflineminus">-                if (prompter)</span>
<a href="#l2.2484"></a><span id="l2.2484" class="difflineminus">-                {</span>
<a href="#l2.2485"></a><span id="l2.2485" class="difflineminus">-                    nsAutoString    promptStr;</span>
<a href="#l2.2486"></a><span id="l2.2486" class="difflineminus">-                    getLocaleString(&quot;WebPageUpdated&quot;, promptStr);</span>
<a href="#l2.2487"></a><span id="l2.2487" class="difflineminus">-                    if (!promptStr.IsEmpty())   promptStr.AppendLiteral(&quot;\n\n&quot;);</span>
<a href="#l2.2488"></a><span id="l2.2488" class="difflineminus">-</span>
<a href="#l2.2489"></a><span id="l2.2489" class="difflineminus">-                    nsCOMPtr&lt;nsIRDFNode&gt;    nameNode;</span>
<a href="#l2.2490"></a><span id="l2.2490" class="difflineminus">-                    if (NS_SUCCEEDED(mInner-&gt;GetTarget(busyResource, kNC_Name,</span>
<a href="#l2.2491"></a><span id="l2.2491" class="difflineminus">-                        PR_TRUE, getter_AddRefs(nameNode))))</span>
<a href="#l2.2492"></a><span id="l2.2492" class="difflineminus">-                    {</span>
<a href="#l2.2493"></a><span id="l2.2493" class="difflineminus">-                        nsCOMPtr&lt;nsIRDFLiteral&gt; nameLiteral = do_QueryInterface(nameNode);</span>
<a href="#l2.2494"></a><span id="l2.2494" class="difflineminus">-                        if (nameLiteral)</span>
<a href="#l2.2495"></a><span id="l2.2495" class="difflineminus">-                        {</span>
<a href="#l2.2496"></a><span id="l2.2496" class="difflineminus">-                            const PRUnichar *nameUni = nsnull;</span>
<a href="#l2.2497"></a><span id="l2.2497" class="difflineminus">-                            if (NS_SUCCEEDED(rv = nameLiteral-&gt;GetValueConst(&amp;nameUni))</span>
<a href="#l2.2498"></a><span id="l2.2498" class="difflineminus">-                                &amp;&amp; (nameUni))</span>
<a href="#l2.2499"></a><span id="l2.2499" class="difflineminus">-                            {</span>
<a href="#l2.2500"></a><span id="l2.2500" class="difflineminus">-                                nsAutoString    info;</span>
<a href="#l2.2501"></a><span id="l2.2501" class="difflineminus">-                                getLocaleString(&quot;WebPageTitle&quot;, info);</span>
<a href="#l2.2502"></a><span id="l2.2502" class="difflineminus">-                                promptStr += info;</span>
<a href="#l2.2503"></a><span id="l2.2503" class="difflineminus">-                                promptStr.AppendLiteral(&quot; &quot;);</span>
<a href="#l2.2504"></a><span id="l2.2504" class="difflineminus">-                                promptStr += nameUni;</span>
<a href="#l2.2505"></a><span id="l2.2505" class="difflineminus">-                                promptStr.AppendLiteral(&quot;\n&quot;);</span>
<a href="#l2.2506"></a><span id="l2.2506" class="difflineminus">-                                getLocaleString(&quot;WebPageURL&quot;, info);</span>
<a href="#l2.2507"></a><span id="l2.2507" class="difflineminus">-                                promptStr += info;</span>
<a href="#l2.2508"></a><span id="l2.2508" class="difflineminus">-                                promptStr.AppendLiteral(&quot; &quot;);</span>
<a href="#l2.2509"></a><span id="l2.2509" class="difflineminus">-                            }</span>
<a href="#l2.2510"></a><span id="l2.2510" class="difflineminus">-                        }</span>
<a href="#l2.2511"></a><span id="l2.2511" class="difflineminus">-                    }</span>
<a href="#l2.2512"></a><span id="l2.2512" class="difflineminus">-                    promptStr.Append(url);</span>
<a href="#l2.2513"></a><span id="l2.2513" class="difflineminus">-                    </span>
<a href="#l2.2514"></a><span id="l2.2514" class="difflineminus">-                    nsAutoString    temp;</span>
<a href="#l2.2515"></a><span id="l2.2515" class="difflineminus">-                    getLocaleString(&quot;WebPageAskDisplay&quot;, temp);</span>
<a href="#l2.2516"></a><span id="l2.2516" class="difflineminus">-                    if (!temp.IsEmpty())</span>
<a href="#l2.2517"></a><span id="l2.2517" class="difflineminus">-                    {</span>
<a href="#l2.2518"></a><span id="l2.2518" class="difflineminus">-                        promptStr.AppendLiteral(&quot;\n\n&quot;);</span>
<a href="#l2.2519"></a><span id="l2.2519" class="difflineminus">-                        promptStr += temp;</span>
<a href="#l2.2520"></a><span id="l2.2520" class="difflineminus">-                    }</span>
<a href="#l2.2521"></a><span id="l2.2521" class="difflineminus">-</span>
<a href="#l2.2522"></a><span id="l2.2522" class="difflineminus">-                    nsAutoString    stopOption;</span>
<a href="#l2.2523"></a><span id="l2.2523" class="difflineminus">-                    getLocaleString(&quot;WebPageAskStopOption&quot;, stopOption);</span>
<a href="#l2.2524"></a><span id="l2.2524" class="difflineminus">-                    PRBool      stopCheckingFlag = PR_FALSE;</span>
<a href="#l2.2525"></a><span id="l2.2525" class="difflineminus">-                    rv = prompter-&gt;ConfirmCheck(nsnull, promptStr.get(), stopOption.get(),</span>
<a href="#l2.2526"></a><span id="l2.2526" class="difflineminus">-                                  &amp;stopCheckingFlag, &amp;openURLFlag);</span>
<a href="#l2.2527"></a><span id="l2.2527" class="difflineminus">-                    if (NS_FAILED(rv))</span>
<a href="#l2.2528"></a><span id="l2.2528" class="difflineminus">-                    {</span>
<a href="#l2.2529"></a><span id="l2.2529" class="difflineminus">-                        openURLFlag = PR_FALSE;</span>
<a href="#l2.2530"></a><span id="l2.2530" class="difflineminus">-                        stopCheckingFlag = PR_FALSE;</span>
<a href="#l2.2531"></a><span id="l2.2531" class="difflineminus">-                    }</span>
<a href="#l2.2532"></a><span id="l2.2532" class="difflineminus">-                    if (stopCheckingFlag == PR_TRUE)</span>
<a href="#l2.2533"></a><span id="l2.2533" class="difflineminus">-                    {</span>
<a href="#l2.2534"></a><span id="l2.2534" class="difflineminus">-#ifdef  DEBUG_BOOKMARK_PING_OUTPUT</span>
<a href="#l2.2535"></a><span id="l2.2535" class="difflineminus">-                        printf(&quot;\nStop checking this URL.\n&quot;);</span>
<a href="#l2.2536"></a><span id="l2.2536" class="difflineminus">-#endif</span>
<a href="#l2.2537"></a><span id="l2.2537" class="difflineminus">-                        rv = mInner-&gt;Unassert(busyResource, kWEB_Schedule, scheduleNode);</span>
<a href="#l2.2538"></a><span id="l2.2538" class="difflineminus">-                        NS_ASSERTION(NS_SUCCEEDED(rv), &quot;unable to unassert kWEB_Schedule&quot;);</span>
<a href="#l2.2539"></a><span id="l2.2539" class="difflineminus">-                    }</span>
<a href="#l2.2540"></a><span id="l2.2540" class="difflineminus">-                }</span>
<a href="#l2.2541"></a><span id="l2.2541" class="difflineminus">-            }</span>
<a href="#l2.2542"></a><span id="l2.2542" class="difflineminus">-</span>
<a href="#l2.2543"></a><span id="l2.2543" class="difflineminus">-            // open the URL in a new window?</span>
<a href="#l2.2544"></a><span id="l2.2544" class="difflineminus">-            if ((openURLFlag == PR_TRUE) ||</span>
<a href="#l2.2545"></a><span id="l2.2545" class="difflineminus">-                schedule.Find(NS_LITERAL_STRING(&quot;open&quot;), PR_TRUE) != -1)</span>
<a href="#l2.2546"></a><span id="l2.2546" class="difflineminus">-            {</span>
<a href="#l2.2547"></a><span id="l2.2547" class="difflineminus">-                if (NS_SUCCEEDED(rv))</span>
<a href="#l2.2548"></a><span id="l2.2548" class="difflineminus">-                {</span>
<a href="#l2.2549"></a><span id="l2.2549" class="difflineminus">-                    nsCOMPtr&lt;nsIWindowWatcher&gt; wwatch(do_GetService(NS_WINDOWWATCHER_CONTRACTID));</span>
<a href="#l2.2550"></a><span id="l2.2550" class="difflineminus">-                    if (wwatch)</span>
<a href="#l2.2551"></a><span id="l2.2551" class="difflineminus">-                    {</span>
<a href="#l2.2552"></a><span id="l2.2552" class="difflineminus">-                        nsCOMPtr&lt;nsIDOMWindow&gt; newWindow;</span>
<a href="#l2.2553"></a><span id="l2.2553" class="difflineminus">-                        nsCOMPtr&lt;nsISupportsArray&gt; suppArray(do_CreateInstance(NS_SUPPORTSARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l2.2554"></a><span id="l2.2554" class="difflineminus">-                        if (NS_FAILED(rv)) return rv;</span>
<a href="#l2.2555"></a><span id="l2.2555" class="difflineminus">-</span>
<a href="#l2.2556"></a><span id="l2.2556" class="difflineminus">-                        nsCOMPtr&lt;nsISupportsString&gt; suppString(do_CreateInstance(&quot;@mozilla.org/supports-string;1&quot;, &amp;rv));</span>
<a href="#l2.2557"></a><span id="l2.2557" class="difflineminus">-                        if (!suppString) return rv;</span>
<a href="#l2.2558"></a><span id="l2.2558" class="difflineminus">-</span>
<a href="#l2.2559"></a><span id="l2.2559" class="difflineminus">-                        rv = suppString-&gt;SetData(url);</span>
<a href="#l2.2560"></a><span id="l2.2560" class="difflineminus">-                        if (NS_FAILED(rv)) return rv;</span>
<a href="#l2.2561"></a><span id="l2.2561" class="difflineminus">-</span>
<a href="#l2.2562"></a><span id="l2.2562" class="difflineminus">-                        suppArray-&gt;AppendElement(suppString);</span>
<a href="#l2.2563"></a><span id="l2.2563" class="difflineminus">-</span>
<a href="#l2.2564"></a><span id="l2.2564" class="difflineminus">-                        nsCString chromeUrl;</span>
<a href="#l2.2565"></a><span id="l2.2565" class="difflineminus">-                        nsCOMPtr&lt;nsIPrefBranch&gt; prefs(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l2.2566"></a><span id="l2.2566" class="difflineminus">-                        if (NS_SUCCEEDED(rv))</span>
<a href="#l2.2567"></a><span id="l2.2567" class="difflineminus">-                        {</span>
<a href="#l2.2568"></a><span id="l2.2568" class="difflineminus">-                            prefs-&gt;GetCharPref(&quot;browser.chromeURL&quot;, getter_Copies(chromeUrl));</span>
<a href="#l2.2569"></a><span id="l2.2569" class="difflineminus">-                        }</span>
<a href="#l2.2570"></a><span id="l2.2570" class="difflineminus">-                        if (chromeUrl.IsEmpty())</span>
<a href="#l2.2571"></a><span id="l2.2571" class="difflineminus">-                        {</span>
<a href="#l2.2572"></a><span id="l2.2572" class="difflineminus">-                            chromeUrl.AssignLiteral(&quot;chrome://navigator/content/navigator.xul&quot;);</span>
<a href="#l2.2573"></a><span id="l2.2573" class="difflineminus">-                        }</span>
<a href="#l2.2574"></a><span id="l2.2574" class="difflineminus">-                        wwatch-&gt;OpenWindow(0, chromeUrl.get(), &quot;_blank&quot;,</span>
<a href="#l2.2575"></a><span id="l2.2575" class="difflineminus">-                                           &quot;chrome,dialog=no,all&quot;, suppArray,</span>
<a href="#l2.2576"></a><span id="l2.2576" class="difflineminus">-                                           getter_AddRefs(newWindow));</span>
<a href="#l2.2577"></a><span id="l2.2577" class="difflineminus">-                    }</span>
<a href="#l2.2578"></a><span id="l2.2578" class="difflineminus">-                }</span>
<a href="#l2.2579"></a><span id="l2.2579" class="difflineminus">-            }</span>
<a href="#l2.2580"></a><span id="l2.2580" class="difflineminus">-        }</span>
<a href="#l2.2581"></a><span id="l2.2581" class="difflineminus">-#ifdef  DEBUG_BOOKMARK_PING_OUTPUT</span>
<a href="#l2.2582"></a><span id="l2.2582" class="difflineminus">-        else</span>
<a href="#l2.2583"></a><span id="l2.2583" class="difflineminus">-        {</span>
<a href="#l2.2584"></a><span id="l2.2584" class="difflineminus">-            printf(&quot;URL has not changed status.\n\n&quot;);</span>
<a href="#l2.2585"></a><span id="l2.2585" class="difflineminus">-        }</span>
<a href="#l2.2586"></a><span id="l2.2586" class="difflineminus">-#endif</span>
<a href="#l2.2587"></a><span id="l2.2587" class="difflineminus">-    }</span>
<a href="#l2.2588"></a><span id="l2.2588" class="difflineminus">-</span>
<a href="#l2.2589"></a><span id="l2.2589" class="difflineminus">-    busyResource = nsnull;</span>
<a href="#l2.2590"></a><span id="l2.2590" class="difflineminus">-    busySchedule = PR_FALSE;</span>
<a href="#l2.2591"></a><span id="l2.2591" class="difflineminus">-</span>
<a href="#l2.2592"></a><span id="l2.2592" class="difflineminus">-    return NS_OK;</span>
<a href="#l2.2593"></a><span id="l2.2593" class="difflineminus">-}</span>
<a href="#l2.2594"></a><span id="l2.2594" class="difflineminus">-</span>
<a href="#l2.2595"></a><span id="l2.2595" class="difflineminus">-</span>
<a href="#l2.2596"></a><span id="l2.2596" class="difflineminus">-// nsIObserver methods</span>
<a href="#l2.2597"></a><span id="l2.2597" class="difflineminus">-</span>
<a href="#l2.2598"></a><span id="l2.2598" class="difflineminus">-NS_IMETHODIMP nsBookmarksService::Observe(nsISupports *aSubject, const char *aTopic, const PRUnichar *someData)</span>
<a href="#l2.2599"></a><span id="l2.2599" class="difflineminus">-{</span>
<a href="#l2.2600"></a><span id="l2.2600" class="difflineminus">-    nsresult rv = NS_OK;</span>
<a href="#l2.2601"></a><span id="l2.2601" class="difflineminus">-</span>
<a href="#l2.2602"></a><span id="l2.2602" class="difflineminus">-    if (!strcmp(aTopic, &quot;profile-before-change&quot;))</span>
<a href="#l2.2603"></a><span id="l2.2603" class="difflineminus">-    {</span>
<a href="#l2.2604"></a><span id="l2.2604" class="difflineminus">-        // The profile has not changed yet.</span>
<a href="#l2.2605"></a><span id="l2.2605" class="difflineminus">-        rv = Flush();</span>
<a href="#l2.2606"></a><span id="l2.2606" class="difflineminus">-    </span>
<a href="#l2.2607"></a><span id="l2.2607" class="difflineminus">-        if (someData &amp;&amp; NS_LITERAL_STRING(&quot;shutdown-cleanse&quot;).Equals(someData))</span>
<a href="#l2.2608"></a><span id="l2.2608" class="difflineminus">-        {</span>
<a href="#l2.2609"></a><span id="l2.2609" class="difflineminus">-            if (mBookmarksFile)</span>
<a href="#l2.2610"></a><span id="l2.2610" class="difflineminus">-            {</span>
<a href="#l2.2611"></a><span id="l2.2611" class="difflineminus">-                mBookmarksFile-&gt;Remove(PR_FALSE);</span>
<a href="#l2.2612"></a><span id="l2.2612" class="difflineminus">-            }</span>
<a href="#l2.2613"></a><span id="l2.2613" class="difflineminus">-        }</span>
<a href="#l2.2614"></a><span id="l2.2614" class="difflineminus">-    }    </span>
<a href="#l2.2615"></a><span id="l2.2615" class="difflineminus">-    else if (mBookmarksFile &amp;&amp; !strcmp(aTopic, &quot;profile-after-change&quot;))</span>
<a href="#l2.2616"></a><span id="l2.2616" class="difflineminus">-    {</span>
<a href="#l2.2617"></a><span id="l2.2617" class="difflineminus">-        // The profile has already changed.</span>
<a href="#l2.2618"></a><span id="l2.2618" class="difflineminus">-        rv = LoadBookmarks();</span>
<a href="#l2.2619"></a><span id="l2.2619" class="difflineminus">-    }</span>
<a href="#l2.2620"></a><span id="l2.2620" class="difflineminus">-    else if (!strcmp(aTopic, NS_PREFBRANCH_PREFCHANGE_TOPIC_ID))</span>
<a href="#l2.2621"></a><span id="l2.2621" class="difflineminus">-    {</span>
<a href="#l2.2622"></a><span id="l2.2622" class="difflineminus">-        rv = Flush();</span>
<a href="#l2.2623"></a><span id="l2.2623" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l2.2624"></a><span id="l2.2624" class="difflineminus">-            rv = LoadBookmarks();</span>
<a href="#l2.2625"></a><span id="l2.2625" class="difflineminus">-    }</span>
<a href="#l2.2626"></a><span id="l2.2626" class="difflineminus">-</span>
<a href="#l2.2627"></a><span id="l2.2627" class="difflineminus">-    return rv;</span>
<a href="#l2.2628"></a><span id="l2.2628" class="difflineminus">-}</span>
<a href="#l2.2629"></a><span id="l2.2629" class="difflineminus">-</span>
<a href="#l2.2630"></a><span id="l2.2630" class="difflineminus">-</span>
<a href="#l2.2631"></a><span id="l2.2631" class="difflineminus">-////////////////////////////////////////////////////////////////////////</span>
<a href="#l2.2632"></a><span id="l2.2632" class="difflineminus">-// nsISupports methods</span>
<a href="#l2.2633"></a><span id="l2.2633" class="difflineminus">-</span>
<a href="#l2.2634"></a><span id="l2.2634" class="difflineminus">-NS_IMPL_CYCLE_COLLECTION_CLASS(nsBookmarksService)</span>
<a href="#l2.2635"></a><span id="l2.2635" class="difflineminus">-</span>
<a href="#l2.2636"></a><span id="l2.2636" class="difflineminus">-NS_IMPL_CYCLE_COLLECTION_UNLINK_BEGIN(nsBookmarksService)</span>
<a href="#l2.2637"></a><span id="l2.2637" class="difflineminus">-    NS_IMPL_CYCLE_COLLECTION_UNLINK_NSCOMPTR(mInner)</span>
<a href="#l2.2638"></a><span id="l2.2638" class="difflineminus">-    // Skip busyResource?</span>
<a href="#l2.2639"></a><span id="l2.2639" class="difflineminus">-    NS_IMPL_CYCLE_COLLECTION_UNLINK_NSCOMARRAY(mObservers)</span>
<a href="#l2.2640"></a><span id="l2.2640" class="difflineminus">-    // Skip mBundle?</span>
<a href="#l2.2641"></a><span id="l2.2641" class="difflineminus">-    NS_IMPL_CYCLE_COLLECTION_UNLINK_NSCOMPTR(mTimer)</span>
<a href="#l2.2642"></a><span id="l2.2642" class="difflineminus">-    NS_IMPL_CYCLE_COLLECTION_UNLINK_NSCOMPTR(mNetService)</span>
<a href="#l2.2643"></a><span id="l2.2643" class="difflineminus">-    NS_IMPL_CYCLE_COLLECTION_UNLINK_NSCOMPTR(mCacheService)</span>
<a href="#l2.2644"></a><span id="l2.2644" class="difflineminus">-    NS_IMPL_CYCLE_COLLECTION_UNLINK_NSCOMPTR(mCacheSession)</span>
<a href="#l2.2645"></a><span id="l2.2645" class="difflineminus">-    NS_IMPL_CYCLE_COLLECTION_UNLINK_NSCOMPTR(mTransactionManager)</span>
<a href="#l2.2646"></a><span id="l2.2646" class="difflineminus">-    NS_IMPL_CYCLE_COLLECTION_UNLINK_NSCOMPTR(mBookmarksFile)</span>
<a href="#l2.2647"></a><span id="l2.2647" class="difflineminus">-NS_IMPL_CYCLE_COLLECTION_UNLINK_END</span>
<a href="#l2.2648"></a><span id="l2.2648" class="difflineminus">-</span>
<a href="#l2.2649"></a><span id="l2.2649" class="difflineminus">-NS_IMPL_CYCLE_COLLECTION_TRAVERSE_BEGIN(nsBookmarksService)</span>
<a href="#l2.2650"></a><span id="l2.2650" class="difflineminus">-    NS_IMPL_CYCLE_COLLECTION_TRAVERSE_NSCOMPTR(mInner)</span>
<a href="#l2.2651"></a><span id="l2.2651" class="difflineminus">-    // Skip busyResource?</span>
<a href="#l2.2652"></a><span id="l2.2652" class="difflineminus">-    NS_IMPL_CYCLE_COLLECTION_TRAVERSE_NSCOMARRAY(mObservers)</span>
<a href="#l2.2653"></a><span id="l2.2653" class="difflineminus">-    // Skip mBundle?</span>
<a href="#l2.2654"></a><span id="l2.2654" class="difflineminus">-    NS_IMPL_CYCLE_COLLECTION_TRAVERSE_NSCOMPTR(mTimer)</span>
<a href="#l2.2655"></a><span id="l2.2655" class="difflineminus">-    NS_IMPL_CYCLE_COLLECTION_TRAVERSE_NSCOMPTR(mNetService)</span>
<a href="#l2.2656"></a><span id="l2.2656" class="difflineminus">-    NS_IMPL_CYCLE_COLLECTION_TRAVERSE_NSCOMPTR(mCacheService)</span>
<a href="#l2.2657"></a><span id="l2.2657" class="difflineminus">-    NS_IMPL_CYCLE_COLLECTION_TRAVERSE_NSCOMPTR(mCacheSession)</span>
<a href="#l2.2658"></a><span id="l2.2658" class="difflineminus">-    NS_IMPL_CYCLE_COLLECTION_TRAVERSE_NSCOMPTR(mTransactionManager)</span>
<a href="#l2.2659"></a><span id="l2.2659" class="difflineminus">-    NS_IMPL_CYCLE_COLLECTION_TRAVERSE_NSCOMPTR(mBookmarksFile)</span>
<a href="#l2.2660"></a><span id="l2.2660" class="difflineminus">-NS_IMPL_CYCLE_COLLECTION_TRAVERSE_END</span>
<a href="#l2.2661"></a><span id="l2.2661" class="difflineminus">-</span>
<a href="#l2.2662"></a><span id="l2.2662" class="difflineminus">-NS_IMPL_CYCLE_COLLECTING_ADDREF_AMBIGUOUS(nsBookmarksService,</span>
<a href="#l2.2663"></a><span id="l2.2663" class="difflineminus">-                                          nsIBookmarksService)</span>
<a href="#l2.2664"></a><span id="l2.2664" class="difflineminus">-NS_IMPL_CYCLE_COLLECTING_RELEASE_AMBIGUOUS(nsBookmarksService,</span>
<a href="#l2.2665"></a><span id="l2.2665" class="difflineminus">-                                           nsIBookmarksService)</span>
<a href="#l2.2666"></a><span id="l2.2666" class="difflineminus">-NS_INTERFACE_MAP_BEGIN(nsBookmarksService)</span>
<a href="#l2.2667"></a><span id="l2.2667" class="difflineminus">-    NS_INTERFACE_MAP_ENTRY_AMBIGUOUS(nsISupports, nsIBookmarksService)</span>
<a href="#l2.2668"></a><span id="l2.2668" class="difflineminus">-    NS_INTERFACE_MAP_ENTRY(nsIBookmarksService)</span>
<a href="#l2.2669"></a><span id="l2.2669" class="difflineminus">-    NS_INTERFACE_MAP_ENTRY(nsIRDFDataSource)</span>
<a href="#l2.2670"></a><span id="l2.2670" class="difflineminus">-    NS_INTERFACE_MAP_ENTRY(nsIRDFRemoteDataSource)</span>
<a href="#l2.2671"></a><span id="l2.2671" class="difflineminus">-    NS_INTERFACE_MAP_ENTRY(nsIRDFPropagatableDataSource)</span>
<a href="#l2.2672"></a><span id="l2.2672" class="difflineminus">-    NS_INTERFACE_MAP_ENTRY(nsIRDFObserver)</span>
<a href="#l2.2673"></a><span id="l2.2673" class="difflineminus">-    NS_INTERFACE_MAP_ENTRY(nsIStreamListener)</span>
<a href="#l2.2674"></a><span id="l2.2674" class="difflineminus">-    NS_INTERFACE_MAP_ENTRY(nsIRequestObserver)</span>
<a href="#l2.2675"></a><span id="l2.2675" class="difflineminus">-    NS_INTERFACE_MAP_ENTRY(nsICharsetResolver)</span>
<a href="#l2.2676"></a><span id="l2.2676" class="difflineminus">-    NS_INTERFACE_MAP_ENTRY(nsIObserver)</span>
<a href="#l2.2677"></a><span id="l2.2677" class="difflineminus">-    NS_INTERFACE_MAP_ENTRY(nsISupportsWeakReference)</span>
<a href="#l2.2678"></a><span id="l2.2678" class="difflineminus">-    NS_INTERFACE_MAP_ENTRIES_CYCLE_COLLECTION(nsBookmarksService)</span>
<a href="#l2.2679"></a><span id="l2.2679" class="difflineminus">-NS_INTERFACE_MAP_END</span>
<a href="#l2.2680"></a><span id="l2.2680" class="difflineminus">-</span>
<a href="#l2.2681"></a><span id="l2.2681" class="difflineminus">-////////////////////////////////////////////////////////////////////////</span>
<a href="#l2.2682"></a><span id="l2.2682" class="difflineminus">-// nsIBookmarksService</span>
<a href="#l2.2683"></a><span id="l2.2683" class="difflineminus">-</span>
<a href="#l2.2684"></a><span id="l2.2684" class="difflineminus">-nsresult</span>
<a href="#l2.2685"></a><span id="l2.2685" class="difflineminus">-nsBookmarksService::InsertResource(nsIRDFResource* aResource,</span>
<a href="#l2.2686"></a><span id="l2.2686" class="difflineminus">-                                   nsIRDFResource* aParentFolder, PRInt32 aIndex)</span>
<a href="#l2.2687"></a><span id="l2.2687" class="difflineminus">-{</span>
<a href="#l2.2688"></a><span id="l2.2688" class="difflineminus">-    nsresult rv = NS_OK;</span>
<a href="#l2.2689"></a><span id="l2.2689" class="difflineminus">-    // Add to container if the parent folder is non null </span>
<a href="#l2.2690"></a><span id="l2.2690" class="difflineminus">-    if (aParentFolder)</span>
<a href="#l2.2691"></a><span id="l2.2691" class="difflineminus">-    {</span>
<a href="#l2.2692"></a><span id="l2.2692" class="difflineminus">-        nsCOMPtr&lt;nsIRDFContainer&gt; container(do_CreateInstance(&quot;@mozilla.org/rdf/container;1&quot;, &amp;rv));</span>
<a href="#l2.2693"></a><span id="l2.2693" class="difflineminus">-        if (NS_FAILED(rv)) </span>
<a href="#l2.2694"></a><span id="l2.2694" class="difflineminus">-            return rv;</span>
<a href="#l2.2695"></a><span id="l2.2695" class="difflineminus">-        rv = container-&gt;Init(mInner, aParentFolder);</span>
<a href="#l2.2696"></a><span id="l2.2696" class="difflineminus">-        if (NS_FAILED(rv)) </span>
<a href="#l2.2697"></a><span id="l2.2697" class="difflineminus">-            return rv;</span>
<a href="#l2.2698"></a><span id="l2.2698" class="difflineminus">-        // if the index in the js call is null or undefined, aIndex will be equal to 0</span>
<a href="#l2.2699"></a><span id="l2.2699" class="difflineminus">-        if (aIndex &gt; 0) </span>
<a href="#l2.2700"></a><span id="l2.2700" class="difflineminus">-            rv = container-&gt;InsertElementAt(aResource, aIndex, PR_TRUE);</span>
<a href="#l2.2701"></a><span id="l2.2701" class="difflineminus">-        else</span>
<a href="#l2.2702"></a><span id="l2.2702" class="difflineminus">-            rv = container-&gt;AppendElement(aResource);</span>
<a href="#l2.2703"></a><span id="l2.2703" class="difflineminus">-</span>
<a href="#l2.2704"></a><span id="l2.2704" class="difflineminus">-        mDirty = PR_TRUE;</span>
<a href="#l2.2705"></a><span id="l2.2705" class="difflineminus">-    }</span>
<a href="#l2.2706"></a><span id="l2.2706" class="difflineminus">-    return rv;</span>
<a href="#l2.2707"></a><span id="l2.2707" class="difflineminus">-}</span>
<a href="#l2.2708"></a><span id="l2.2708" class="difflineminus">-</span>
<a href="#l2.2709"></a><span id="l2.2709" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l2.2710"></a><span id="l2.2710" class="difflineminus">-nsBookmarksService::CreateFolder(const PRUnichar* aName, </span>
<a href="#l2.2711"></a><span id="l2.2711" class="difflineminus">-                                 nsIRDFResource** aResult)</span>
<a href="#l2.2712"></a><span id="l2.2712" class="difflineminus">-{</span>
<a href="#l2.2713"></a><span id="l2.2713" class="difflineminus">-    nsresult rv;</span>
<a href="#l2.2714"></a><span id="l2.2714" class="difflineminus">-</span>
<a href="#l2.2715"></a><span id="l2.2715" class="difflineminus">-    // Resource: Folder ID</span>
<a href="#l2.2716"></a><span id="l2.2716" class="difflineminus">-    nsCOMPtr&lt;nsIRDFResource&gt; folderResource;</span>
<a href="#l2.2717"></a><span id="l2.2717" class="difflineminus">-    rv = gRDF-&gt;GetAnonymousResource(getter_AddRefs(folderResource));</span>
<a href="#l2.2718"></a><span id="l2.2718" class="difflineminus">-    if (NS_FAILED(rv)) </span>
<a href="#l2.2719"></a><span id="l2.2719" class="difflineminus">-        return rv;</span>
<a href="#l2.2720"></a><span id="l2.2720" class="difflineminus">-</span>
<a href="#l2.2721"></a><span id="l2.2721" class="difflineminus">-    rv = gRDFC-&gt;MakeSeq(mInner, folderResource, nsnull);</span>
<a href="#l2.2722"></a><span id="l2.2722" class="difflineminus">-    if (NS_FAILED(rv)) </span>
<a href="#l2.2723"></a><span id="l2.2723" class="difflineminus">-        return rv;</span>
<a href="#l2.2724"></a><span id="l2.2724" class="difflineminus">-</span>
<a href="#l2.2725"></a><span id="l2.2725" class="difflineminus">-    // Literal: Folder Name</span>
<a href="#l2.2726"></a><span id="l2.2726" class="difflineminus">-    nsCOMPtr&lt;nsIRDFLiteral&gt; nameLiteral;</span>
<a href="#l2.2727"></a><span id="l2.2727" class="difflineminus">-    nsAutoString folderName; </span>
<a href="#l2.2728"></a><span id="l2.2728" class="difflineminus">-    folderName.Assign(aName);</span>
<a href="#l2.2729"></a><span id="l2.2729" class="difflineminus">-    if (folderName.IsEmpty()) {</span>
<a href="#l2.2730"></a><span id="l2.2730" class="difflineminus">-        getLocaleString(&quot;NewFolder&quot;, folderName);</span>
<a href="#l2.2731"></a><span id="l2.2731" class="difflineminus">-</span>
<a href="#l2.2732"></a><span id="l2.2732" class="difflineminus">-        rv = gRDF-&gt;GetLiteral(folderName.get(), getter_AddRefs(nameLiteral));</span>
<a href="#l2.2733"></a><span id="l2.2733" class="difflineminus">-        if (NS_FAILED(rv)) </span>
<a href="#l2.2734"></a><span id="l2.2734" class="difflineminus">-            return rv;</span>
<a href="#l2.2735"></a><span id="l2.2735" class="difflineminus">-    }</span>
<a href="#l2.2736"></a><span id="l2.2736" class="difflineminus">-    else</span>
<a href="#l2.2737"></a><span id="l2.2737" class="difflineminus">-    {</span>
<a href="#l2.2738"></a><span id="l2.2738" class="difflineminus">-        rv = gRDF-&gt;GetLiteral(aName, getter_AddRefs(nameLiteral));</span>
<a href="#l2.2739"></a><span id="l2.2739" class="difflineminus">-        if (NS_FAILED(rv)) </span>
<a href="#l2.2740"></a><span id="l2.2740" class="difflineminus">-            return rv;</span>
<a href="#l2.2741"></a><span id="l2.2741" class="difflineminus">-    }</span>
<a href="#l2.2742"></a><span id="l2.2742" class="difflineminus">-</span>
<a href="#l2.2743"></a><span id="l2.2743" class="difflineminus">-    rv = mInner-&gt;Assert(folderResource, kNC_Name, nameLiteral, PR_TRUE);</span>
<a href="#l2.2744"></a><span id="l2.2744" class="difflineminus">-    if (NS_FAILED(rv)) </span>
<a href="#l2.2745"></a><span id="l2.2745" class="difflineminus">-        return rv;</span>
<a href="#l2.2746"></a><span id="l2.2746" class="difflineminus">-</span>
<a href="#l2.2747"></a><span id="l2.2747" class="difflineminus">-    // Date: Date of Creation</span>
<a href="#l2.2748"></a><span id="l2.2748" class="difflineminus">-    // Convert the current date/time from microseconds (PRTime) to seconds.</span>
<a href="#l2.2749"></a><span id="l2.2749" class="difflineminus">-    nsCOMPtr&lt;nsIRDFDate&gt; dateLiteral;</span>
<a href="#l2.2750"></a><span id="l2.2750" class="difflineminus">-    rv = gRDF-&gt;GetDateLiteral(PR_Now(), getter_AddRefs(dateLiteral));</span>
<a href="#l2.2751"></a><span id="l2.2751" class="difflineminus">-    if (NS_FAILED(rv)) </span>
<a href="#l2.2752"></a><span id="l2.2752" class="difflineminus">-        return rv;</span>
<a href="#l2.2753"></a><span id="l2.2753" class="difflineminus">-    rv = mInner-&gt;Assert(folderResource, kNC_BookmarkAddDate, dateLiteral, PR_TRUE);</span>
<a href="#l2.2754"></a><span id="l2.2754" class="difflineminus">-    if (NS_FAILED(rv)) </span>
<a href="#l2.2755"></a><span id="l2.2755" class="difflineminus">-        return rv;</span>
<a href="#l2.2756"></a><span id="l2.2756" class="difflineminus">-</span>
<a href="#l2.2757"></a><span id="l2.2757" class="difflineminus">-    *aResult = folderResource;</span>
<a href="#l2.2758"></a><span id="l2.2758" class="difflineminus">-    NS_ADDREF(*aResult);</span>
<a href="#l2.2759"></a><span id="l2.2759" class="difflineminus">-</span>
<a href="#l2.2760"></a><span id="l2.2760" class="difflineminus">-    return rv;</span>
<a href="#l2.2761"></a><span id="l2.2761" class="difflineminus">-}</span>
<a href="#l2.2762"></a><span id="l2.2762" class="difflineminus">-</span>
<a href="#l2.2763"></a><span id="l2.2763" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l2.2764"></a><span id="l2.2764" class="difflineminus">-nsBookmarksService::CreateFolderInContainer(const PRUnichar* aName, </span>
<a href="#l2.2765"></a><span id="l2.2765" class="difflineminus">-                                            nsIRDFResource* aParentFolder, PRInt32 aIndex,</span>
<a href="#l2.2766"></a><span id="l2.2766" class="difflineminus">-                                            nsIRDFResource** aResult)</span>
<a href="#l2.2767"></a><span id="l2.2767" class="difflineminus">-{</span>
<a href="#l2.2768"></a><span id="l2.2768" class="difflineminus">-    nsresult rv = CreateFolder(aName, aResult);</span>
<a href="#l2.2769"></a><span id="l2.2769" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l2.2770"></a><span id="l2.2770" class="difflineminus">-        rv = InsertResource(*aResult, aParentFolder, aIndex);</span>
<a href="#l2.2771"></a><span id="l2.2771" class="difflineminus">-    return rv;</span>
<a href="#l2.2772"></a><span id="l2.2772" class="difflineminus">-}</span>
<a href="#l2.2773"></a><span id="l2.2773" class="difflineminus">-</span>
<a href="#l2.2774"></a><span id="l2.2774" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l2.2775"></a><span id="l2.2775" class="difflineminus">-nsBookmarksService::CreateGroup(const PRUnichar* aName, </span>
<a href="#l2.2776"></a><span id="l2.2776" class="difflineminus">-                                nsIRDFResource** aResult)</span>
<a href="#l2.2777"></a><span id="l2.2777" class="difflineminus">-{</span>
<a href="#l2.2778"></a><span id="l2.2778" class="difflineminus">-    nsresult rv;</span>
<a href="#l2.2779"></a><span id="l2.2779" class="difflineminus">-    rv = CreateFolderInContainer(aName, nsnull, nsnull, aResult);</span>
<a href="#l2.2780"></a><span id="l2.2780" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l2.2781"></a><span id="l2.2781" class="difflineminus">-        rv = mInner-&gt;Assert(*aResult, kNC_FolderGroup, kTrueLiteral, PR_TRUE);</span>
<a href="#l2.2782"></a><span id="l2.2782" class="difflineminus">-    return rv;</span>
<a href="#l2.2783"></a><span id="l2.2783" class="difflineminus">-}</span>
<a href="#l2.2784"></a><span id="l2.2784" class="difflineminus">-</span>
<a href="#l2.2785"></a><span id="l2.2785" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l2.2786"></a><span id="l2.2786" class="difflineminus">-nsBookmarksService::CreateGroupInContainer(const PRUnichar* aName, </span>
<a href="#l2.2787"></a><span id="l2.2787" class="difflineminus">-                                           nsIRDFResource* aParentFolder, PRInt32 aIndex,</span>
<a href="#l2.2788"></a><span id="l2.2788" class="difflineminus">-                                           nsIRDFResource** aResult)</span>
<a href="#l2.2789"></a><span id="l2.2789" class="difflineminus">-{</span>
<a href="#l2.2790"></a><span id="l2.2790" class="difflineminus">-    nsresult rv = CreateGroup(aName, aResult);</span>
<a href="#l2.2791"></a><span id="l2.2791" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l2.2792"></a><span id="l2.2792" class="difflineminus">-        rv = InsertResource(*aResult, aParentFolder, aIndex);</span>
<a href="#l2.2793"></a><span id="l2.2793" class="difflineminus">-    return rv;</span>
<a href="#l2.2794"></a><span id="l2.2794" class="difflineminus">-}</span>
<a href="#l2.2795"></a><span id="l2.2795" class="difflineminus">-</span>
<a href="#l2.2796"></a><span id="l2.2796" class="difflineminus">-int</span>
<a href="#l2.2797"></a><span id="l2.2797" class="difflineminus">-nsBookmarksService::Compare(const void* aElement1, const void* aElement2, void* aData)</span>
<a href="#l2.2798"></a><span id="l2.2798" class="difflineminus">-{</span>
<a href="#l2.2799"></a><span id="l2.2799" class="difflineminus">-    const ElementInfo* elementInfo1 =</span>
<a href="#l2.2800"></a><span id="l2.2800" class="difflineminus">-      static_cast&lt;ElementInfo*&gt;(const_cast&lt;void*&gt;(aElement1));</span>
<a href="#l2.2801"></a><span id="l2.2801" class="difflineminus">-    const ElementInfo* elementInfo2 =</span>
<a href="#l2.2802"></a><span id="l2.2802" class="difflineminus">-      static_cast&lt;ElementInfo*&gt;(const_cast&lt;void*&gt;(aElement2));</span>
<a href="#l2.2803"></a><span id="l2.2803" class="difflineminus">-    SortInfo* sortInfo = (SortInfo*)aData;</span>
<a href="#l2.2804"></a><span id="l2.2804" class="difflineminus">-</span>
<a href="#l2.2805"></a><span id="l2.2805" class="difflineminus">-    if (sortInfo-&gt;mFoldersFirst) {</span>
<a href="#l2.2806"></a><span id="l2.2806" class="difflineminus">-        if (elementInfo1-&gt;mIsFolder) {</span>
<a href="#l2.2807"></a><span id="l2.2807" class="difflineminus">-            if (!elementInfo2-&gt;mIsFolder) {</span>
<a href="#l2.2808"></a><span id="l2.2808" class="difflineminus">-                return -1;</span>
<a href="#l2.2809"></a><span id="l2.2809" class="difflineminus">-            }</span>
<a href="#l2.2810"></a><span id="l2.2810" class="difflineminus">-        }</span>
<a href="#l2.2811"></a><span id="l2.2811" class="difflineminus">-        else {</span>
<a href="#l2.2812"></a><span id="l2.2812" class="difflineminus">-            if (elementInfo2-&gt;mIsFolder) {</span>
<a href="#l2.2813"></a><span id="l2.2813" class="difflineminus">-                return 1;</span>
<a href="#l2.2814"></a><span id="l2.2814" class="difflineminus">-            }</span>
<a href="#l2.2815"></a><span id="l2.2815" class="difflineminus">-        }</span>
<a href="#l2.2816"></a><span id="l2.2816" class="difflineminus">-    }</span>
<a href="#l2.2817"></a><span id="l2.2817" class="difflineminus">- </span>
<a href="#l2.2818"></a><span id="l2.2818" class="difflineminus">-    PRInt32 result = 0;</span>
<a href="#l2.2819"></a><span id="l2.2819" class="difflineminus">- </span>
<a href="#l2.2820"></a><span id="l2.2820" class="difflineminus">-    nsIRDFNode* node1 = elementInfo1-&gt;mNode;</span>
<a href="#l2.2821"></a><span id="l2.2821" class="difflineminus">-    nsIRDFNode* node2 = elementInfo2-&gt;mNode;</span>
<a href="#l2.2822"></a><span id="l2.2822" class="difflineminus">- </span>
<a href="#l2.2823"></a><span id="l2.2823" class="difflineminus">-    // Literals?</span>
<a href="#l2.2824"></a><span id="l2.2824" class="difflineminus">-    nsCOMPtr&lt;nsIRDFLiteral&gt; literal1 = do_QueryInterface(node1);</span>
<a href="#l2.2825"></a><span id="l2.2825" class="difflineminus">-    if (literal1) {</span>
<a href="#l2.2826"></a><span id="l2.2826" class="difflineminus">-        nsCOMPtr&lt;nsIRDFLiteral&gt; literal2 = do_QueryInterface(node2);</span>
<a href="#l2.2827"></a><span id="l2.2827" class="difflineminus">-        if (literal2) {</span>
<a href="#l2.2828"></a><span id="l2.2828" class="difflineminus">-            const PRUnichar* value1;</span>
<a href="#l2.2829"></a><span id="l2.2829" class="difflineminus">-            literal1-&gt;GetValueConst(&amp;value1);</span>
<a href="#l2.2830"></a><span id="l2.2830" class="difflineminus">-            const PRUnichar* value2;</span>
<a href="#l2.2831"></a><span id="l2.2831" class="difflineminus">-            literal2-&gt;GetValueConst(&amp;value2);</span>
<a href="#l2.2832"></a><span id="l2.2832" class="difflineminus">-</span>
<a href="#l2.2833"></a><span id="l2.2833" class="difflineminus">-            if (gCollation) {</span>
<a href="#l2.2834"></a><span id="l2.2834" class="difflineminus">-                gCollation-&gt;CompareString(nsICollation::kCollationCaseInSensitive,</span>
<a href="#l2.2835"></a><span id="l2.2835" class="difflineminus">-                                          nsDependentString(value1),</span>
<a href="#l2.2836"></a><span id="l2.2836" class="difflineminus">-                                          nsDependentString(value2),</span>
<a href="#l2.2837"></a><span id="l2.2837" class="difflineminus">-                                          &amp;result);</span>
<a href="#l2.2838"></a><span id="l2.2838" class="difflineminus">-            }</span>
<a href="#l2.2839"></a><span id="l2.2839" class="difflineminus">-            else {</span>
<a href="#l2.2840"></a><span id="l2.2840" class="difflineminus">-                result = nsDependentString(value1).Compare(nsDependentString(value2),</span>
<a href="#l2.2841"></a><span id="l2.2841" class="difflineminus">-                                                           CaseInsensitiveCompare);</span>
<a href="#l2.2842"></a><span id="l2.2842" class="difflineminus">-            }</span>
<a href="#l2.2843"></a><span id="l2.2843" class="difflineminus">-</span>
<a href="#l2.2844"></a><span id="l2.2844" class="difflineminus">-            return result * sortInfo-&gt;mDirection;</span>
<a href="#l2.2845"></a><span id="l2.2845" class="difflineminus">-        }</span>
<a href="#l2.2846"></a><span id="l2.2846" class="difflineminus">-    }</span>
<a href="#l2.2847"></a><span id="l2.2847" class="difflineminus">- </span>
<a href="#l2.2848"></a><span id="l2.2848" class="difflineminus">-    // Dates?</span>
<a href="#l2.2849"></a><span id="l2.2849" class="difflineminus">-    nsCOMPtr&lt;nsIRDFDate&gt; date1 = do_QueryInterface(node1);</span>
<a href="#l2.2850"></a><span id="l2.2850" class="difflineminus">-    if (date1) {</span>
<a href="#l2.2851"></a><span id="l2.2851" class="difflineminus">-        nsCOMPtr&lt;nsIRDFDate&gt; date2 = do_QueryInterface(node2);</span>
<a href="#l2.2852"></a><span id="l2.2852" class="difflineminus">-        if (date2) {</span>
<a href="#l2.2853"></a><span id="l2.2853" class="difflineminus">-            PRTime value1;</span>
<a href="#l2.2854"></a><span id="l2.2854" class="difflineminus">-            date1-&gt;GetValue(&amp;value1);</span>
<a href="#l2.2855"></a><span id="l2.2855" class="difflineminus">-            PRTime value2;</span>
<a href="#l2.2856"></a><span id="l2.2856" class="difflineminus">-            date2-&gt;GetValue(&amp;value2);</span>
<a href="#l2.2857"></a><span id="l2.2857" class="difflineminus">-</span>
<a href="#l2.2858"></a><span id="l2.2858" class="difflineminus">-            PRInt64 delta;</span>
<a href="#l2.2859"></a><span id="l2.2859" class="difflineminus">-            LL_SUB(delta, value1, value2);</span>
<a href="#l2.2860"></a><span id="l2.2860" class="difflineminus">-</span>
<a href="#l2.2861"></a><span id="l2.2861" class="difflineminus">-            if (LL_IS_ZERO(delta))</span>
<a href="#l2.2862"></a><span id="l2.2862" class="difflineminus">-                result = 0;</span>
<a href="#l2.2863"></a><span id="l2.2863" class="difflineminus">-            else if (LL_GE_ZERO(delta))</span>
<a href="#l2.2864"></a><span id="l2.2864" class="difflineminus">-                result = 1;</span>
<a href="#l2.2865"></a><span id="l2.2865" class="difflineminus">-            else</span>
<a href="#l2.2866"></a><span id="l2.2866" class="difflineminus">-                result = -1;</span>
<a href="#l2.2867"></a><span id="l2.2867" class="difflineminus">-</span>
<a href="#l2.2868"></a><span id="l2.2868" class="difflineminus">-            return result * sortInfo-&gt;mDirection;</span>
<a href="#l2.2869"></a><span id="l2.2869" class="difflineminus">-        }</span>
<a href="#l2.2870"></a><span id="l2.2870" class="difflineminus">-    }</span>
<a href="#l2.2871"></a><span id="l2.2871" class="difflineminus">-</span>
<a href="#l2.2872"></a><span id="l2.2872" class="difflineminus">-    // Ack! Apples &amp; oranges.</span>
<a href="#l2.2873"></a><span id="l2.2873" class="difflineminus">-    return 0;</span>
<a href="#l2.2874"></a><span id="l2.2874" class="difflineminus">-}</span>
<a href="#l2.2875"></a><span id="l2.2875" class="difflineminus">- </span>
<a href="#l2.2876"></a><span id="l2.2876" class="difflineminus">-nsresult</span>
<a href="#l2.2877"></a><span id="l2.2877" class="difflineminus">-nsBookmarksService::Sort(nsIRDFResource* aFolder, nsIRDFResource* aProperty,</span>
<a href="#l2.2878"></a><span id="l2.2878" class="difflineminus">-                         PRInt32 aDirection, PRBool aFoldersFirst,</span>
<a href="#l2.2879"></a><span id="l2.2879" class="difflineminus">-                         PRBool aRecurse)</span>
<a href="#l2.2880"></a><span id="l2.2880" class="difflineminus">-{</span>
<a href="#l2.2881"></a><span id="l2.2881" class="difflineminus">-    nsresult rv;</span>
<a href="#l2.2882"></a><span id="l2.2882" class="difflineminus">-    nsCOMPtr&lt;nsIRDFContainer&gt; container =</span>
<a href="#l2.2883"></a><span id="l2.2883" class="difflineminus">-        do_CreateInstance(&quot;@mozilla.org/rdf/container;1&quot;, &amp;rv);</span>
<a href="#l2.2884"></a><span id="l2.2884" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l2.2885"></a><span id="l2.2885" class="difflineminus">-        return rv;</span>
<a href="#l2.2886"></a><span id="l2.2886" class="difflineminus">-</span>
<a href="#l2.2887"></a><span id="l2.2887" class="difflineminus">-    rv = container-&gt;Init(mInner, aFolder);</span>
<a href="#l2.2888"></a><span id="l2.2888" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l2.2889"></a><span id="l2.2889" class="difflineminus">-        return rv;</span>
<a href="#l2.2890"></a><span id="l2.2890" class="difflineminus">-</span>
<a href="#l2.2891"></a><span id="l2.2891" class="difflineminus">-    nsCOMPtr&lt;nsISimpleEnumerator&gt; elements;</span>
<a href="#l2.2892"></a><span id="l2.2892" class="difflineminus">-    rv = container-&gt;GetElements(getter_AddRefs(elements));</span>
<a href="#l2.2893"></a><span id="l2.2893" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l2.2894"></a><span id="l2.2894" class="difflineminus">-        return rv;</span>
<a href="#l2.2895"></a><span id="l2.2895" class="difflineminus">-</span>
<a href="#l2.2896"></a><span id="l2.2896" class="difflineminus">-    ElementArray elementArray;</span>
<a href="#l2.2897"></a><span id="l2.2897" class="difflineminus">-</span>
<a href="#l2.2898"></a><span id="l2.2898" class="difflineminus">-    PRBool hasMore = PR_FALSE;</span>
<a href="#l2.2899"></a><span id="l2.2899" class="difflineminus">-    while (NS_SUCCEEDED(rv = elements-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp;</span>
<a href="#l2.2900"></a><span id="l2.2900" class="difflineminus">-           hasMore) {</span>
<a href="#l2.2901"></a><span id="l2.2901" class="difflineminus">-        nsCOMPtr&lt;nsISupports&gt; supports;</span>
<a href="#l2.2902"></a><span id="l2.2902" class="difflineminus">-        rv = elements-&gt;GetNext(getter_AddRefs(supports));</span>
<a href="#l2.2903"></a><span id="l2.2903" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l2.2904"></a><span id="l2.2904" class="difflineminus">-            return rv;</span>
<a href="#l2.2905"></a><span id="l2.2905" class="difflineminus">-</span>
<a href="#l2.2906"></a><span id="l2.2906" class="difflineminus">-        nsCOMPtr&lt;nsIRDFResource&gt; element = do_QueryInterface(supports, &amp;rv);</span>
<a href="#l2.2907"></a><span id="l2.2907" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l2.2908"></a><span id="l2.2908" class="difflineminus">-            return rv;</span>
<a href="#l2.2909"></a><span id="l2.2909" class="difflineminus">-</span>
<a href="#l2.2910"></a><span id="l2.2910" class="difflineminus">-        nsCOMPtr&lt;nsIRDFNode&gt; node;</span>
<a href="#l2.2911"></a><span id="l2.2911" class="difflineminus">-        rv = mInner-&gt;GetTarget(element, aProperty, PR_TRUE, getter_AddRefs(node));</span>
<a href="#l2.2912"></a><span id="l2.2912" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l2.2913"></a><span id="l2.2913" class="difflineminus">-            return rv;</span>
<a href="#l2.2914"></a><span id="l2.2914" class="difflineminus">-</span>
<a href="#l2.2915"></a><span id="l2.2915" class="difflineminus">-        if (!node) {</span>
<a href="#l2.2916"></a><span id="l2.2916" class="difflineminus">-            if (aProperty == kNC_BookmarkAddDate ||</span>
<a href="#l2.2917"></a><span id="l2.2917" class="difflineminus">-                aProperty == kWEB_LastModifiedDate ||</span>
<a href="#l2.2918"></a><span id="l2.2918" class="difflineminus">-                aProperty == kWEB_LastVisitDate) {</span>
<a href="#l2.2919"></a><span id="l2.2919" class="difflineminus">-                node = do_QueryInterface(kEmptyDate);</span>
<a href="#l2.2920"></a><span id="l2.2920" class="difflineminus">-            }</span>
<a href="#l2.2921"></a><span id="l2.2921" class="difflineminus">-            else {</span>
<a href="#l2.2922"></a><span id="l2.2922" class="difflineminus">-                node = do_QueryInterface(kEmptyLiteral);</span>
<a href="#l2.2923"></a><span id="l2.2923" class="difflineminus">-            }</span>
<a href="#l2.2924"></a><span id="l2.2924" class="difflineminus">-        }</span>
<a href="#l2.2925"></a><span id="l2.2925" class="difflineminus">-</span>
<a href="#l2.2926"></a><span id="l2.2926" class="difflineminus">-        PRBool isContainer;</span>
<a href="#l2.2927"></a><span id="l2.2927" class="difflineminus">-        rv = gRDFC-&gt;IsContainer(mInner, element, &amp;isContainer);</span>
<a href="#l2.2928"></a><span id="l2.2928" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l2.2929"></a><span id="l2.2929" class="difflineminus">-            return rv;</span>
<a href="#l2.2930"></a><span id="l2.2930" class="difflineminus">-</span>
<a href="#l2.2931"></a><span id="l2.2931" class="difflineminus">-        PRBool isGroup;</span>
<a href="#l2.2932"></a><span id="l2.2932" class="difflineminus">-        rv = mInner-&gt;HasAssertion(element, kNC_FolderGroup, kTrueLiteral,</span>
<a href="#l2.2933"></a><span id="l2.2933" class="difflineminus">-                                  PR_TRUE, &amp;isGroup);</span>
<a href="#l2.2934"></a><span id="l2.2934" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l2.2935"></a><span id="l2.2935" class="difflineminus">-            return rv;</span>
<a href="#l2.2936"></a><span id="l2.2936" class="difflineminus">-</span>
<a href="#l2.2937"></a><span id="l2.2937" class="difflineminus">-        ElementInfo* elementInfo = new ElementInfo(element, node,</span>
<a href="#l2.2938"></a><span id="l2.2938" class="difflineminus">-                                                   isContainer &amp;&amp; !isGroup);</span>
<a href="#l2.2939"></a><span id="l2.2939" class="difflineminus">-        if (!elementInfo)</span>
<a href="#l2.2940"></a><span id="l2.2940" class="difflineminus">-            return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l2.2941"></a><span id="l2.2941" class="difflineminus">-</span>
<a href="#l2.2942"></a><span id="l2.2942" class="difflineminus">-        elementArray.AppendElement(elementInfo);</span>
<a href="#l2.2943"></a><span id="l2.2943" class="difflineminus">-</span>
<a href="#l2.2944"></a><span id="l2.2944" class="difflineminus">-        if (isContainer &amp;&amp; aRecurse) {</span>
<a href="#l2.2945"></a><span id="l2.2945" class="difflineminus">-            rv = Sort(element, aProperty, aDirection, aFoldersFirst, aRecurse);</span>
<a href="#l2.2946"></a><span id="l2.2946" class="difflineminus">-            if (NS_FAILED(rv))</span>
<a href="#l2.2947"></a><span id="l2.2947" class="difflineminus">-                return rv;</span>
<a href="#l2.2948"></a><span id="l2.2948" class="difflineminus">-        }</span>
<a href="#l2.2949"></a><span id="l2.2949" class="difflineminus">-    }</span>
<a href="#l2.2950"></a><span id="l2.2950" class="difflineminus">-</span>
<a href="#l2.2951"></a><span id="l2.2951" class="difflineminus">-    SortInfo sortInfo(aDirection, aFoldersFirst);</span>
<a href="#l2.2952"></a><span id="l2.2952" class="difflineminus">-    elementArray.Sort(Compare, &amp;sortInfo);</span>
<a href="#l2.2953"></a><span id="l2.2953" class="difflineminus">-</span>
<a href="#l2.2954"></a><span id="l2.2954" class="difflineminus">-    // XXXvarga If we ever make it so that ordinals are guaranteed to be unique,</span>
<a href="#l2.2955"></a><span id="l2.2955" class="difflineminus">-    // the code below can be significantly simplified.</span>
<a href="#l2.2956"></a><span id="l2.2956" class="difflineminus">-    for (PRInt32 j = elementArray.Count() - 1; j &gt;= 0; --j) {</span>
<a href="#l2.2957"></a><span id="l2.2957" class="difflineminus">-        ElementInfo* elementInfo = elementArray[j];</span>
<a href="#l2.2958"></a><span id="l2.2958" class="difflineminus">-</span>
<a href="#l2.2959"></a><span id="l2.2959" class="difflineminus">-        PRInt32 oldIndex;</span>
<a href="#l2.2960"></a><span id="l2.2960" class="difflineminus">-        rv = gRDFC-&gt;IndexOf(mInner, aFolder, elementInfo-&gt;mElement, &amp;oldIndex);</span>
<a href="#l2.2961"></a><span id="l2.2961" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l2.2962"></a><span id="l2.2962" class="difflineminus">-            return rv;</span>
<a href="#l2.2963"></a><span id="l2.2963" class="difflineminus">-</span>
<a href="#l2.2964"></a><span id="l2.2964" class="difflineminus">-        // The old index is 1 based.</span>
<a href="#l2.2965"></a><span id="l2.2965" class="difflineminus">-        if (oldIndex != j + 1) {</span>
<a href="#l2.2966"></a><span id="l2.2966" class="difflineminus">-            nsCOMPtr&lt;nsIRDFResource&gt; oldOrdinal;</span>
<a href="#l2.2967"></a><span id="l2.2967" class="difflineminus">-            rv = gRDFC-&gt;IndexToOrdinalResource(oldIndex, getter_AddRefs(oldOrdinal));</span>
<a href="#l2.2968"></a><span id="l2.2968" class="difflineminus">-            if (NS_FAILED(rv))</span>
<a href="#l2.2969"></a><span id="l2.2969" class="difflineminus">-                return rv;</span>
<a href="#l2.2970"></a><span id="l2.2970" class="difflineminus">-</span>
<a href="#l2.2971"></a><span id="l2.2971" class="difflineminus">-            nsCOMPtr&lt;nsIRDFResource&gt; newOrdinal;</span>
<a href="#l2.2972"></a><span id="l2.2972" class="difflineminus">-            rv = gRDFC-&gt;IndexToOrdinalResource(j + 1, getter_AddRefs(newOrdinal));</span>
<a href="#l2.2973"></a><span id="l2.2973" class="difflineminus">-            if (NS_FAILED(rv))</span>
<a href="#l2.2974"></a><span id="l2.2974" class="difflineminus">-                return rv;</span>
<a href="#l2.2975"></a><span id="l2.2975" class="difflineminus">-</span>
<a href="#l2.2976"></a><span id="l2.2976" class="difflineminus">-            // We need to find the correct element for the old ordinal,</span>
<a href="#l2.2977"></a><span id="l2.2977" class="difflineminus">-            // it happens that there are two elements with the same ordinal.</span>
<a href="#l2.2978"></a><span id="l2.2978" class="difflineminus">-            nsCOMPtr&lt;nsISimpleEnumerator&gt; elements;</span>
<a href="#l2.2979"></a><span id="l2.2979" class="difflineminus">-            rv = mInner-&gt;GetTargets(aFolder, oldOrdinal, PR_TRUE,</span>
<a href="#l2.2980"></a><span id="l2.2980" class="difflineminus">-                                    getter_AddRefs(elements));</span>
<a href="#l2.2981"></a><span id="l2.2981" class="difflineminus">-</span>
<a href="#l2.2982"></a><span id="l2.2982" class="difflineminus">-            PRBool hasMore = PR_FALSE;</span>
<a href="#l2.2983"></a><span id="l2.2983" class="difflineminus">-            while (NS_SUCCEEDED(rv = elements-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp;</span>
<a href="#l2.2984"></a><span id="l2.2984" class="difflineminus">-                   hasMore) {</span>
<a href="#l2.2985"></a><span id="l2.2985" class="difflineminus">-                nsCOMPtr&lt;nsISupports&gt; supports;</span>
<a href="#l2.2986"></a><span id="l2.2986" class="difflineminus">-                rv = elements-&gt;GetNext(getter_AddRefs(supports));</span>
<a href="#l2.2987"></a><span id="l2.2987" class="difflineminus">-                if (NS_FAILED(rv))</span>
<a href="#l2.2988"></a><span id="l2.2988" class="difflineminus">-                    return rv;</span>
<a href="#l2.2989"></a><span id="l2.2989" class="difflineminus">-</span>
<a href="#l2.2990"></a><span id="l2.2990" class="difflineminus">-                nsCOMPtr&lt;nsIRDFNode&gt; element = do_QueryInterface(supports);</span>
<a href="#l2.2991"></a><span id="l2.2991" class="difflineminus">-                if (element == elementInfo-&gt;mElement) {</span>
<a href="#l2.2992"></a><span id="l2.2992" class="difflineminus">-                    rv = mInner-&gt;Unassert(aFolder, oldOrdinal, element);</span>
<a href="#l2.2993"></a><span id="l2.2993" class="difflineminus">-                    if (NS_FAILED(rv))</span>
<a href="#l2.2994"></a><span id="l2.2994" class="difflineminus">-                        return rv;</span>
<a href="#l2.2995"></a><span id="l2.2995" class="difflineminus">-</span>
<a href="#l2.2996"></a><span id="l2.2996" class="difflineminus">-                    rv = mInner-&gt;Assert(aFolder, newOrdinal, element, PR_TRUE);</span>
<a href="#l2.2997"></a><span id="l2.2997" class="difflineminus">-                    if (NS_FAILED(rv))</span>
<a href="#l2.2998"></a><span id="l2.2998" class="difflineminus">-                        return rv;</span>
<a href="#l2.2999"></a><span id="l2.2999" class="difflineminus">-                    break;</span>
<a href="#l2.3000"></a><span id="l2.3000" class="difflineminus">-                }</span>
<a href="#l2.3001"></a><span id="l2.3001" class="difflineminus">-            }</span>
<a href="#l2.3002"></a><span id="l2.3002" class="difflineminus">-        }</span>
<a href="#l2.3003"></a><span id="l2.3003" class="difflineminus">-    }</span>
<a href="#l2.3004"></a><span id="l2.3004" class="difflineminus">-</span>
<a href="#l2.3005"></a><span id="l2.3005" class="difflineminus">-    return NS_OK;</span>
<a href="#l2.3006"></a><span id="l2.3006" class="difflineminus">-}</span>
<a href="#l2.3007"></a><span id="l2.3007" class="difflineminus">-</span>
<a href="#l2.3008"></a><span id="l2.3008" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l2.3009"></a><span id="l2.3009" class="difflineminus">-nsBookmarksService::SortFolder(nsIRDFResource* aFolder,</span>
<a href="#l2.3010"></a><span id="l2.3010" class="difflineminus">-                               nsIRDFResource* aProperty,</span>
<a href="#l2.3011"></a><span id="l2.3011" class="difflineminus">-                               PRInt32 aDirection,</span>
<a href="#l2.3012"></a><span id="l2.3012" class="difflineminus">-                               PRBool aFoldersFirst,</span>
<a href="#l2.3013"></a><span id="l2.3013" class="difflineminus">-                               PRBool aRecurse)</span>
<a href="#l2.3014"></a><span id="l2.3014" class="difflineminus">-{</span>
<a href="#l2.3015"></a><span id="l2.3015" class="difflineminus">-#ifdef DEBUG_varga</span>
<a href="#l2.3016"></a><span id="l2.3016" class="difflineminus">-    PRIntervalTime startTime =  PR_IntervalNow();</span>
<a href="#l2.3017"></a><span id="l2.3017" class="difflineminus">-#endif</span>
<a href="#l2.3018"></a><span id="l2.3018" class="difflineminus">-</span>
<a href="#l2.3019"></a><span id="l2.3019" class="difflineminus">-    BeginUpdateBatch();</span>
<a href="#l2.3020"></a><span id="l2.3020" class="difflineminus">-    SetPropagateChanges(PR_FALSE);</span>
<a href="#l2.3021"></a><span id="l2.3021" class="difflineminus">-    nsresult rv = Sort(aFolder, aProperty, aDirection, aFoldersFirst,</span>
<a href="#l2.3022"></a><span id="l2.3022" class="difflineminus">-                       aRecurse);</span>
<a href="#l2.3023"></a><span id="l2.3023" class="difflineminus">-    SetPropagateChanges(PR_TRUE);</span>
<a href="#l2.3024"></a><span id="l2.3024" class="difflineminus">-    EndUpdateBatch();</span>
<a href="#l2.3025"></a><span id="l2.3025" class="difflineminus">-</span>
<a href="#l2.3026"></a><span id="l2.3026" class="difflineminus">-#ifdef DEBUG_varga</span>
<a href="#l2.3027"></a><span id="l2.3027" class="difflineminus">-    PRIntervalTime endTime =  PR_IntervalNow();</span>
<a href="#l2.3028"></a><span id="l2.3028" class="difflineminus">-    printf(&quot;Time spent in SortFolder(): %d msec\n&quot;, PR_IntervalToMilliseconds(endTime - startTime));</span>
<a href="#l2.3029"></a><span id="l2.3029" class="difflineminus">-#endif</span>
<a href="#l2.3030"></a><span id="l2.3030" class="difflineminus">-</span>
<a href="#l2.3031"></a><span id="l2.3031" class="difflineminus">-    return rv;</span>
<a href="#l2.3032"></a><span id="l2.3032" class="difflineminus">-}</span>
<a href="#l2.3033"></a><span id="l2.3033" class="difflineminus">-</span>
<a href="#l2.3034"></a><span id="l2.3034" class="difflineminus">-nsresult</span>
<a href="#l2.3035"></a><span id="l2.3035" class="difflineminus">-nsBookmarksService::GetURLFromResource(nsIRDFResource* aResource,</span>
<a href="#l2.3036"></a><span id="l2.3036" class="difflineminus">-                                       nsAString&amp; aURL)</span>
<a href="#l2.3037"></a><span id="l2.3037" class="difflineminus">-{</span>
<a href="#l2.3038"></a><span id="l2.3038" class="difflineminus">-    NS_ENSURE_ARG(aResource);</span>
<a href="#l2.3039"></a><span id="l2.3039" class="difflineminus">-</span>
<a href="#l2.3040"></a><span id="l2.3040" class="difflineminus">-    nsCOMPtr&lt;nsIRDFNode&gt; urlNode;</span>
<a href="#l2.3041"></a><span id="l2.3041" class="difflineminus">-    nsresult rv = mInner-&gt;GetTarget(aResource, kNC_URL, PR_TRUE, getter_AddRefs(urlNode));</span>
<a href="#l2.3042"></a><span id="l2.3042" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l2.3043"></a><span id="l2.3043" class="difflineminus">-        return rv;</span>
<a href="#l2.3044"></a><span id="l2.3044" class="difflineminus">-</span>
<a href="#l2.3045"></a><span id="l2.3045" class="difflineminus">-    if (urlNode) {</span>
<a href="#l2.3046"></a><span id="l2.3046" class="difflineminus">-        nsCOMPtr&lt;nsIRDFLiteral&gt; urlLiteral = do_QueryInterface(urlNode, &amp;rv);</span>
<a href="#l2.3047"></a><span id="l2.3047" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l2.3048"></a><span id="l2.3048" class="difflineminus">-            return rv;</span>
<a href="#l2.3049"></a><span id="l2.3049" class="difflineminus">-</span>
<a href="#l2.3050"></a><span id="l2.3050" class="difflineminus">-        const PRUnichar* url = nsnull;</span>
<a href="#l2.3051"></a><span id="l2.3051" class="difflineminus">-        rv = urlLiteral-&gt;GetValueConst(&amp;url);</span>
<a href="#l2.3052"></a><span id="l2.3052" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l2.3053"></a><span id="l2.3053" class="difflineminus">-            return rv;</span>
<a href="#l2.3054"></a><span id="l2.3054" class="difflineminus">-</span>
<a href="#l2.3055"></a><span id="l2.3055" class="difflineminus">-        aURL.Assign(url);</span>
<a href="#l2.3056"></a><span id="l2.3056" class="difflineminus">-    }</span>
<a href="#l2.3057"></a><span id="l2.3057" class="difflineminus">-</span>
<a href="#l2.3058"></a><span id="l2.3058" class="difflineminus">-    return NS_OK;</span>
<a href="#l2.3059"></a><span id="l2.3059" class="difflineminus">-}</span>
<a href="#l2.3060"></a><span id="l2.3060" class="difflineminus">-</span>
<a href="#l2.3061"></a><span id="l2.3061" class="difflineminus">-nsresult</span>
<a href="#l2.3062"></a><span id="l2.3062" class="difflineminus">-nsBookmarksService::CopyResource(nsIRDFResource* aOldResource,</span>
<a href="#l2.3063"></a><span id="l2.3063" class="difflineminus">-                                 nsIRDFResource* aNewResource)</span>
<a href="#l2.3064"></a><span id="l2.3064" class="difflineminus">-{</span>
<a href="#l2.3065"></a><span id="l2.3065" class="difflineminus">-    // Make all arcs coming out of aOldResource also come out of</span>
<a href="#l2.3066"></a><span id="l2.3066" class="difflineminus">-    // aNewResource. Wallop any previous values.</span>
<a href="#l2.3067"></a><span id="l2.3067" class="difflineminus">-    nsCOMPtr&lt;nsISimpleEnumerator&gt; arcsOut;</span>
<a href="#l2.3068"></a><span id="l2.3068" class="difflineminus">-    nsresult rv = mInner-&gt;ArcLabelsOut(aOldResource, getter_AddRefs(arcsOut));</span>
<a href="#l2.3069"></a><span id="l2.3069" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l2.3070"></a><span id="l2.3070" class="difflineminus">-        return rv;</span>
<a href="#l2.3071"></a><span id="l2.3071" class="difflineminus">-</span>
<a href="#l2.3072"></a><span id="l2.3072" class="difflineminus">-    while (1) {</span>
<a href="#l2.3073"></a><span id="l2.3073" class="difflineminus">-        PRBool hasMoreArcsOut;</span>
<a href="#l2.3074"></a><span id="l2.3074" class="difflineminus">-        rv = arcsOut-&gt;HasMoreElements(&amp;hasMoreArcsOut);</span>
<a href="#l2.3075"></a><span id="l2.3075" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l2.3076"></a><span id="l2.3076" class="difflineminus">-            return rv;</span>
<a href="#l2.3077"></a><span id="l2.3077" class="difflineminus">-</span>
<a href="#l2.3078"></a><span id="l2.3078" class="difflineminus">-        if (!hasMoreArcsOut)</span>
<a href="#l2.3079"></a><span id="l2.3079" class="difflineminus">-            break;</span>
<a href="#l2.3080"></a><span id="l2.3080" class="difflineminus">-</span>
<a href="#l2.3081"></a><span id="l2.3081" class="difflineminus">-        nsCOMPtr&lt;nsISupports&gt; supports;</span>
<a href="#l2.3082"></a><span id="l2.3082" class="difflineminus">-        rv = arcsOut-&gt;GetNext(getter_AddRefs(supports));</span>
<a href="#l2.3083"></a><span id="l2.3083" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l2.3084"></a><span id="l2.3084" class="difflineminus">-            return rv;</span>
<a href="#l2.3085"></a><span id="l2.3085" class="difflineminus">-</span>
<a href="#l2.3086"></a><span id="l2.3086" class="difflineminus">-        nsCOMPtr&lt;nsIRDFResource&gt; property = do_QueryInterface(supports);</span>
<a href="#l2.3087"></a><span id="l2.3087" class="difflineminus">-        if (!property)</span>
<a href="#l2.3088"></a><span id="l2.3088" class="difflineminus">-            return NS_ERROR_UNEXPECTED;</span>
<a href="#l2.3089"></a><span id="l2.3089" class="difflineminus">-</span>
<a href="#l2.3090"></a><span id="l2.3090" class="difflineminus">-        nsCOMPtr&lt;nsIRDFNode&gt; oldvalue;</span>
<a href="#l2.3091"></a><span id="l2.3091" class="difflineminus">-        rv = mInner-&gt;GetTarget(aNewResource, property, PR_TRUE,</span>
<a href="#l2.3092"></a><span id="l2.3092" class="difflineminus">-                               getter_AddRefs(oldvalue));</span>
<a href="#l2.3093"></a><span id="l2.3093" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l2.3094"></a><span id="l2.3094" class="difflineminus">-            return rv;</span>
<a href="#l2.3095"></a><span id="l2.3095" class="difflineminus">-</span>
<a href="#l2.3096"></a><span id="l2.3096" class="difflineminus">-        nsCOMPtr&lt;nsIRDFNode&gt; newvalue;</span>
<a href="#l2.3097"></a><span id="l2.3097" class="difflineminus">-        rv = mInner-&gt;GetTarget(aOldResource, property, PR_TRUE,</span>
<a href="#l2.3098"></a><span id="l2.3098" class="difflineminus">-                               getter_AddRefs(newvalue));</span>
<a href="#l2.3099"></a><span id="l2.3099" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l2.3100"></a><span id="l2.3100" class="difflineminus">-            return rv;</span>
<a href="#l2.3101"></a><span id="l2.3101" class="difflineminus">-</span>
<a href="#l2.3102"></a><span id="l2.3102" class="difflineminus">-        if (oldvalue) {</span>
<a href="#l2.3103"></a><span id="l2.3103" class="difflineminus">-            if (newvalue) {</span>
<a href="#l2.3104"></a><span id="l2.3104" class="difflineminus">-                 rv = mInner-&gt;Change(aNewResource, property, oldvalue, newvalue);</span>
<a href="#l2.3105"></a><span id="l2.3105" class="difflineminus">-            }</span>
<a href="#l2.3106"></a><span id="l2.3106" class="difflineminus">-            else {</span>
<a href="#l2.3107"></a><span id="l2.3107" class="difflineminus">-                 rv = mInner-&gt;Unassert(aNewResource, property, oldvalue);</span>
<a href="#l2.3108"></a><span id="l2.3108" class="difflineminus">-            }</span>
<a href="#l2.3109"></a><span id="l2.3109" class="difflineminus">-        }</span>
<a href="#l2.3110"></a><span id="l2.3110" class="difflineminus">-        else if (newvalue) {</span>
<a href="#l2.3111"></a><span id="l2.3111" class="difflineminus">-            rv = mInner-&gt;Assert(aNewResource, property, newvalue, PR_TRUE);</span>
<a href="#l2.3112"></a><span id="l2.3112" class="difflineminus">-        }</span>
<a href="#l2.3113"></a><span id="l2.3113" class="difflineminus">-</span>
<a href="#l2.3114"></a><span id="l2.3114" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l2.3115"></a><span id="l2.3115" class="difflineminus">-            return rv;</span>
<a href="#l2.3116"></a><span id="l2.3116" class="difflineminus">-    }</span>
<a href="#l2.3117"></a><span id="l2.3117" class="difflineminus">-</span>
<a href="#l2.3118"></a><span id="l2.3118" class="difflineminus">-    // Make all arcs pointing to aOldResource now point to aNewResource.</span>
<a href="#l2.3119"></a><span id="l2.3119" class="difflineminus">-    nsCOMPtr&lt;nsISimpleEnumerator&gt; arcsIn;</span>
<a href="#l2.3120"></a><span id="l2.3120" class="difflineminus">-    rv = mInner-&gt;ArcLabelsIn(aOldResource, getter_AddRefs(arcsIn));</span>
<a href="#l2.3121"></a><span id="l2.3121" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l2.3122"></a><span id="l2.3122" class="difflineminus">-        return rv;</span>
<a href="#l2.3123"></a><span id="l2.3123" class="difflineminus">-                                                                                </span>
<a href="#l2.3124"></a><span id="l2.3124" class="difflineminus">-    while (1) {</span>
<a href="#l2.3125"></a><span id="l2.3125" class="difflineminus">-        PRBool hasMoreArcsIn;</span>
<a href="#l2.3126"></a><span id="l2.3126" class="difflineminus">-        rv = arcsIn-&gt;HasMoreElements(&amp;hasMoreArcsIn);</span>
<a href="#l2.3127"></a><span id="l2.3127" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l2.3128"></a><span id="l2.3128" class="difflineminus">-            return rv;</span>
<a href="#l2.3129"></a><span id="l2.3129" class="difflineminus">-</span>
<a href="#l2.3130"></a><span id="l2.3130" class="difflineminus">-        if (!hasMoreArcsIn)</span>
<a href="#l2.3131"></a><span id="l2.3131" class="difflineminus">-            break;</span>
<a href="#l2.3132"></a><span id="l2.3132" class="difflineminus">-</span>
<a href="#l2.3133"></a><span id="l2.3133" class="difflineminus">-        nsCOMPtr&lt;nsISupports&gt; supports;</span>
<a href="#l2.3134"></a><span id="l2.3134" class="difflineminus">-        rv = arcsIn-&gt;GetNext(getter_AddRefs(supports));</span>
<a href="#l2.3135"></a><span id="l2.3135" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l2.3136"></a><span id="l2.3136" class="difflineminus">-            return rv;</span>
<a href="#l2.3137"></a><span id="l2.3137" class="difflineminus">-                                                                                </span>
<a href="#l2.3138"></a><span id="l2.3138" class="difflineminus">-        nsCOMPtr&lt;nsIRDFResource&gt; property = do_QueryInterface(supports);</span>
<a href="#l2.3139"></a><span id="l2.3139" class="difflineminus">-        if (!property)</span>
<a href="#l2.3140"></a><span id="l2.3140" class="difflineminus">-            return NS_ERROR_UNEXPECTED;</span>
<a href="#l2.3141"></a><span id="l2.3141" class="difflineminus">-</span>
<a href="#l2.3142"></a><span id="l2.3142" class="difflineminus">-        nsCOMPtr&lt;nsISimpleEnumerator&gt; sources;</span>
<a href="#l2.3143"></a><span id="l2.3143" class="difflineminus">-        rv = GetSources(property, aOldResource, PR_TRUE,</span>
<a href="#l2.3144"></a><span id="l2.3144" class="difflineminus">-                        getter_AddRefs(sources));</span>
<a href="#l2.3145"></a><span id="l2.3145" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l2.3146"></a><span id="l2.3146" class="difflineminus">-            return rv;</span>
<a href="#l2.3147"></a><span id="l2.3147" class="difflineminus">-</span>
<a href="#l2.3148"></a><span id="l2.3148" class="difflineminus">-        while (1) {</span>
<a href="#l2.3149"></a><span id="l2.3149" class="difflineminus">-            PRBool hasMoreSrcs;</span>
<a href="#l2.3150"></a><span id="l2.3150" class="difflineminus">-            rv = sources-&gt;HasMoreElements(&amp;hasMoreSrcs);</span>
<a href="#l2.3151"></a><span id="l2.3151" class="difflineminus">-            if (NS_FAILED(rv))</span>
<a href="#l2.3152"></a><span id="l2.3152" class="difflineminus">-                return rv;</span>
<a href="#l2.3153"></a><span id="l2.3153" class="difflineminus">-</span>
<a href="#l2.3154"></a><span id="l2.3154" class="difflineminus">-            if (!hasMoreSrcs)</span>
<a href="#l2.3155"></a><span id="l2.3155" class="difflineminus">-                break;</span>
<a href="#l2.3156"></a><span id="l2.3156" class="difflineminus">-</span>
<a href="#l2.3157"></a><span id="l2.3157" class="difflineminus">-            nsCOMPtr&lt;nsISupports&gt; supports;</span>
<a href="#l2.3158"></a><span id="l2.3158" class="difflineminus">-            rv = sources-&gt;GetNext(getter_AddRefs(supports));</span>
<a href="#l2.3159"></a><span id="l2.3159" class="difflineminus">-            if (NS_FAILED(rv))</span>
<a href="#l2.3160"></a><span id="l2.3160" class="difflineminus">-                return rv;</span>
<a href="#l2.3161"></a><span id="l2.3161" class="difflineminus">-</span>
<a href="#l2.3162"></a><span id="l2.3162" class="difflineminus">-            nsCOMPtr&lt;nsIRDFResource&gt; source = do_QueryInterface(supports);</span>
<a href="#l2.3163"></a><span id="l2.3163" class="difflineminus">-            if (!source)</span>
<a href="#l2.3164"></a><span id="l2.3164" class="difflineminus">-                return NS_ERROR_UNEXPECTED;</span>
<a href="#l2.3165"></a><span id="l2.3165" class="difflineminus">-</span>
<a href="#l2.3166"></a><span id="l2.3166" class="difflineminus">-            rv = mInner-&gt;Change(source, property, aOldResource, aNewResource);</span>
<a href="#l2.3167"></a><span id="l2.3167" class="difflineminus">-            if (NS_FAILED(rv))</span>
<a href="#l2.3168"></a><span id="l2.3168" class="difflineminus">-                return rv;</span>
<a href="#l2.3169"></a><span id="l2.3169" class="difflineminus">-        }</span>
<a href="#l2.3170"></a><span id="l2.3170" class="difflineminus">-    }</span>
<a href="#l2.3171"></a><span id="l2.3171" class="difflineminus">-</span>
<a href="#l2.3172"></a><span id="l2.3172" class="difflineminus">-    return NS_OK;</span>
<a href="#l2.3173"></a><span id="l2.3173" class="difflineminus">-}</span>
<a href="#l2.3174"></a><span id="l2.3174" class="difflineminus">-</span>
<a href="#l2.3175"></a><span id="l2.3175" class="difflineminus">-nsresult</span>
<a href="#l2.3176"></a><span id="l2.3176" class="difflineminus">-nsBookmarksService::SetNewPersonalToolbarFolder(nsIRDFResource* aFolder)</span>
<a href="#l2.3177"></a><span id="l2.3177" class="difflineminus">-{</span>
<a href="#l2.3178"></a><span id="l2.3178" class="difflineminus">-    nsCOMPtr&lt;nsIRDFResource&gt; tempResource;</span>
<a href="#l2.3179"></a><span id="l2.3179" class="difflineminus">-    nsresult rv = gRDF-&gt;GetAnonymousResource(getter_AddRefs(tempResource));</span>
<a href="#l2.3180"></a><span id="l2.3180" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l2.3181"></a><span id="l2.3181" class="difflineminus">-        return rv;</span>
<a href="#l2.3182"></a><span id="l2.3182" class="difflineminus">-</span>
<a href="#l2.3183"></a><span id="l2.3183" class="difflineminus">-    rv = CopyResource(kNC_PersonalToolbarFolder, tempResource);</span>
<a href="#l2.3184"></a><span id="l2.3184" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l2.3185"></a><span id="l2.3185" class="difflineminus">-        return rv;</span>
<a href="#l2.3186"></a><span id="l2.3186" class="difflineminus">-</span>
<a href="#l2.3187"></a><span id="l2.3187" class="difflineminus">-    rv = CopyResource(aFolder, kNC_PersonalToolbarFolder);</span>
<a href="#l2.3188"></a><span id="l2.3188" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l2.3189"></a><span id="l2.3189" class="difflineminus">-        return rv;</span>
<a href="#l2.3190"></a><span id="l2.3190" class="difflineminus">-</span>
<a href="#l2.3191"></a><span id="l2.3191" class="difflineminus">-    return CopyResource(tempResource, aFolder);</span>
<a href="#l2.3192"></a><span id="l2.3192" class="difflineminus">-}</span>
<a href="#l2.3193"></a><span id="l2.3193" class="difflineminus">-</span>
<a href="#l2.3194"></a><span id="l2.3194" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l2.3195"></a><span id="l2.3195" class="difflineminus">-nsBookmarksService::CreateBookmark(const PRUnichar* aName,</span>
<a href="#l2.3196"></a><span id="l2.3196" class="difflineminus">-                                   const PRUnichar* aURL, </span>
<a href="#l2.3197"></a><span id="l2.3197" class="difflineminus">-                                   const PRUnichar* aShortcutURL,</span>
<a href="#l2.3198"></a><span id="l2.3198" class="difflineminus">-                                   const PRUnichar* aDescription,</span>
<a href="#l2.3199"></a><span id="l2.3199" class="difflineminus">-                                   const PRUnichar* aDocCharSet, </span>
<a href="#l2.3200"></a><span id="l2.3200" class="difflineminus">-                                   nsIRDFResource** aResult)</span>
<a href="#l2.3201"></a><span id="l2.3201" class="difflineminus">-{</span>
<a href="#l2.3202"></a><span id="l2.3202" class="difflineminus">-    // Resource: Bookmark ID</span>
<a href="#l2.3203"></a><span id="l2.3203" class="difflineminus">-    nsCOMPtr&lt;nsIRDFResource&gt; bookmarkResource;</span>
<a href="#l2.3204"></a><span id="l2.3204" class="difflineminus">-    nsresult rv = gRDF-&gt;GetAnonymousResource(getter_AddRefs(bookmarkResource));</span>
<a href="#l2.3205"></a><span id="l2.3205" class="difflineminus">-</span>
<a href="#l2.3206"></a><span id="l2.3206" class="difflineminus">-    if (NS_FAILED(rv)) </span>
<a href="#l2.3207"></a><span id="l2.3207" class="difflineminus">-        return rv;</span>
<a href="#l2.3208"></a><span id="l2.3208" class="difflineminus">-</span>
<a href="#l2.3209"></a><span id="l2.3209" class="difflineminus">-    // Literal: Folder Name</span>
<a href="#l2.3210"></a><span id="l2.3210" class="difflineminus">-    nsCOMPtr&lt;nsIRDFLiteral&gt; nameLiteral;</span>
<a href="#l2.3211"></a><span id="l2.3211" class="difflineminus">-    nsAutoString bookmarkName; </span>
<a href="#l2.3212"></a><span id="l2.3212" class="difflineminus">-    bookmarkName.Assign(aName);</span>
<a href="#l2.3213"></a><span id="l2.3213" class="difflineminus">-    if (bookmarkName.IsEmpty()) {</span>
<a href="#l2.3214"></a><span id="l2.3214" class="difflineminus">-        getLocaleString(&quot;NewBookmark&quot;, bookmarkName);</span>
<a href="#l2.3215"></a><span id="l2.3215" class="difflineminus">-</span>
<a href="#l2.3216"></a><span id="l2.3216" class="difflineminus">-        rv = gRDF-&gt;GetLiteral(bookmarkName.get(), getter_AddRefs(nameLiteral));</span>
<a href="#l2.3217"></a><span id="l2.3217" class="difflineminus">-        if (NS_FAILED(rv)) </span>
<a href="#l2.3218"></a><span id="l2.3218" class="difflineminus">-            return rv;</span>
<a href="#l2.3219"></a><span id="l2.3219" class="difflineminus">-    }</span>
<a href="#l2.3220"></a><span id="l2.3220" class="difflineminus">-    else</span>
<a href="#l2.3221"></a><span id="l2.3221" class="difflineminus">-    {</span>
<a href="#l2.3222"></a><span id="l2.3222" class="difflineminus">-        rv = gRDF-&gt;GetLiteral(aName, getter_AddRefs(nameLiteral));</span>
<a href="#l2.3223"></a><span id="l2.3223" class="difflineminus">-        if (NS_FAILED(rv)) </span>
<a href="#l2.3224"></a><span id="l2.3224" class="difflineminus">-            return rv;</span>
<a href="#l2.3225"></a><span id="l2.3225" class="difflineminus">-    }</span>
<a href="#l2.3226"></a><span id="l2.3226" class="difflineminus">-</span>
<a href="#l2.3227"></a><span id="l2.3227" class="difflineminus">-    rv = mInner-&gt;Assert(bookmarkResource, kNC_Name, nameLiteral, PR_TRUE);</span>
<a href="#l2.3228"></a><span id="l2.3228" class="difflineminus">-    if (NS_FAILED(rv)) </span>
<a href="#l2.3229"></a><span id="l2.3229" class="difflineminus">-        return rv;</span>
<a href="#l2.3230"></a><span id="l2.3230" class="difflineminus">-</span>
<a href="#l2.3231"></a><span id="l2.3231" class="difflineminus">-    // Resource: URL</span>
<a href="#l2.3232"></a><span id="l2.3232" class="difflineminus">-    nsAutoString url;</span>
<a href="#l2.3233"></a><span id="l2.3233" class="difflineminus">-    url.Assign(aURL);</span>
<a href="#l2.3234"></a><span id="l2.3234" class="difflineminus">-    nsCOMPtr&lt;nsIRDFLiteral&gt; urlLiteral;</span>
<a href="#l2.3235"></a><span id="l2.3235" class="difflineminus">-    rv = gRDF-&gt;GetLiteral(url.get(), getter_AddRefs(urlLiteral));</span>
<a href="#l2.3236"></a><span id="l2.3236" class="difflineminus">-    if (NS_FAILED(rv)) </span>
<a href="#l2.3237"></a><span id="l2.3237" class="difflineminus">-        return rv;</span>
<a href="#l2.3238"></a><span id="l2.3238" class="difflineminus">-    rv = mInner-&gt;Assert(bookmarkResource, kNC_URL, urlLiteral, PR_TRUE);</span>
<a href="#l2.3239"></a><span id="l2.3239" class="difflineminus">-    if (NS_FAILED(rv)) </span>
<a href="#l2.3240"></a><span id="l2.3240" class="difflineminus">-        return rv;</span>
<a href="#l2.3241"></a><span id="l2.3241" class="difflineminus">-</span>
<a href="#l2.3242"></a><span id="l2.3242" class="difflineminus">-    // Literal: Shortcut URL</span>
<a href="#l2.3243"></a><span id="l2.3243" class="difflineminus">-    if (aShortcutURL &amp;&amp; *aShortcutURL) {</span>
<a href="#l2.3244"></a><span id="l2.3244" class="difflineminus">-        nsCOMPtr&lt;nsIRDFLiteral&gt; shortcutLiteral;</span>
<a href="#l2.3245"></a><span id="l2.3245" class="difflineminus">-        rv = gRDF-&gt;GetLiteral(aShortcutURL, getter_AddRefs(shortcutLiteral));</span>
<a href="#l2.3246"></a><span id="l2.3246" class="difflineminus">-        if (NS_FAILED(rv)) </span>
<a href="#l2.3247"></a><span id="l2.3247" class="difflineminus">-            return rv;</span>
<a href="#l2.3248"></a><span id="l2.3248" class="difflineminus">-        rv = mInner-&gt;Assert(bookmarkResource, kNC_ShortcutURL, shortcutLiteral, PR_TRUE);</span>
<a href="#l2.3249"></a><span id="l2.3249" class="difflineminus">-        if (NS_FAILED(rv)) </span>
<a href="#l2.3250"></a><span id="l2.3250" class="difflineminus">-            return rv;</span>
<a href="#l2.3251"></a><span id="l2.3251" class="difflineminus">-    }</span>
<a href="#l2.3252"></a><span id="l2.3252" class="difflineminus">-</span>
<a href="#l2.3253"></a><span id="l2.3253" class="difflineminus">-    // Literal: Description</span>
<a href="#l2.3254"></a><span id="l2.3254" class="difflineminus">-    if (aDescription &amp;&amp; *aDescription) {</span>
<a href="#l2.3255"></a><span id="l2.3255" class="difflineminus">-        nsCOMPtr&lt;nsIRDFLiteral&gt; descriptionLiteral;</span>
<a href="#l2.3256"></a><span id="l2.3256" class="difflineminus">-        rv = gRDF-&gt;GetLiteral(aDescription, getter_AddRefs(descriptionLiteral));</span>
<a href="#l2.3257"></a><span id="l2.3257" class="difflineminus">-        if (NS_FAILED(rv)) </span>
<a href="#l2.3258"></a><span id="l2.3258" class="difflineminus">-            return rv;</span>
<a href="#l2.3259"></a><span id="l2.3259" class="difflineminus">-        rv = mInner-&gt;Assert(bookmarkResource, kNC_Description, descriptionLiteral, PR_TRUE);</span>
<a href="#l2.3260"></a><span id="l2.3260" class="difflineminus">-        if (NS_FAILED(rv)) </span>
<a href="#l2.3261"></a><span id="l2.3261" class="difflineminus">-            return rv;</span>
<a href="#l2.3262"></a><span id="l2.3262" class="difflineminus">-    }</span>
<a href="#l2.3263"></a><span id="l2.3263" class="difflineminus">-</span>
<a href="#l2.3264"></a><span id="l2.3264" class="difflineminus">-    // Date: Date of Creation</span>
<a href="#l2.3265"></a><span id="l2.3265" class="difflineminus">-    // Convert the current date/time from microseconds (PRTime) to seconds.</span>
<a href="#l2.3266"></a><span id="l2.3266" class="difflineminus">-    nsCOMPtr&lt;nsIRDFDate&gt; dateLiteral;</span>
<a href="#l2.3267"></a><span id="l2.3267" class="difflineminus">-    rv = gRDF-&gt;GetDateLiteral(PR_Now(), getter_AddRefs(dateLiteral));</span>
<a href="#l2.3268"></a><span id="l2.3268" class="difflineminus">-    if (NS_FAILED(rv)) </span>
<a href="#l2.3269"></a><span id="l2.3269" class="difflineminus">-        return rv;</span>
<a href="#l2.3270"></a><span id="l2.3270" class="difflineminus">-    rv = mInner-&gt;Assert(bookmarkResource, kNC_BookmarkAddDate, dateLiteral, PR_TRUE);</span>
<a href="#l2.3271"></a><span id="l2.3271" class="difflineminus">-    if (NS_FAILED(rv)) </span>
<a href="#l2.3272"></a><span id="l2.3272" class="difflineminus">-        return rv;</span>
<a href="#l2.3273"></a><span id="l2.3273" class="difflineminus">-</span>
<a href="#l2.3274"></a><span id="l2.3274" class="difflineminus">-    // Literal: Charset used when last visited</span>
<a href="#l2.3275"></a><span id="l2.3275" class="difflineminus">-    nsAutoString charset; </span>
<a href="#l2.3276"></a><span id="l2.3276" class="difflineminus">-    charset.Assign(aDocCharSet);</span>
<a href="#l2.3277"></a><span id="l2.3277" class="difflineminus">-    if (!charset.IsEmpty()) {</span>
<a href="#l2.3278"></a><span id="l2.3278" class="difflineminus">-        nsCOMPtr&lt;nsIRDFLiteral&gt; charsetLiteral;</span>
<a href="#l2.3279"></a><span id="l2.3279" class="difflineminus">-        rv = gRDF-&gt;GetLiteral(aDocCharSet, getter_AddRefs(charsetLiteral));</span>
<a href="#l2.3280"></a><span id="l2.3280" class="difflineminus">-        if (NS_FAILED(rv)) </span>
<a href="#l2.3281"></a><span id="l2.3281" class="difflineminus">-            return rv;</span>
<a href="#l2.3282"></a><span id="l2.3282" class="difflineminus">-        rv = mInner-&gt;Assert(bookmarkResource, kWEB_LastCharset, charsetLiteral, PR_TRUE);</span>
<a href="#l2.3283"></a><span id="l2.3283" class="difflineminus">-        if (NS_FAILED(rv)) </span>
<a href="#l2.3284"></a><span id="l2.3284" class="difflineminus">-            return rv;</span>
<a href="#l2.3285"></a><span id="l2.3285" class="difflineminus">-    }</span>
<a href="#l2.3286"></a><span id="l2.3286" class="difflineminus">-</span>
<a href="#l2.3287"></a><span id="l2.3287" class="difflineminus">-    *aResult = bookmarkResource;</span>
<a href="#l2.3288"></a><span id="l2.3288" class="difflineminus">-    NS_ADDREF(*aResult);</span>
<a href="#l2.3289"></a><span id="l2.3289" class="difflineminus">-</span>
<a href="#l2.3290"></a><span id="l2.3290" class="difflineminus">-    return rv;</span>
<a href="#l2.3291"></a><span id="l2.3291" class="difflineminus">-}</span>
<a href="#l2.3292"></a><span id="l2.3292" class="difflineminus">-</span>
<a href="#l2.3293"></a><span id="l2.3293" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l2.3294"></a><span id="l2.3294" class="difflineminus">-nsBookmarksService::CreateBookmarkInContainer(const PRUnichar* aName,</span>
<a href="#l2.3295"></a><span id="l2.3295" class="difflineminus">-                                              const PRUnichar* aURL, </span>
<a href="#l2.3296"></a><span id="l2.3296" class="difflineminus">-                                              const PRUnichar* aShortcutURL, </span>
<a href="#l2.3297"></a><span id="l2.3297" class="difflineminus">-                                              const PRUnichar* aDescription, </span>
<a href="#l2.3298"></a><span id="l2.3298" class="difflineminus">-                                              const PRUnichar* aDocCharSet, </span>
<a href="#l2.3299"></a><span id="l2.3299" class="difflineminus">-                                              nsIRDFResource* aParentFolder,</span>
<a href="#l2.3300"></a><span id="l2.3300" class="difflineminus">-                                              PRInt32 aIndex,</span>
<a href="#l2.3301"></a><span id="l2.3301" class="difflineminus">-                                              nsIRDFResource** aResult)</span>
<a href="#l2.3302"></a><span id="l2.3302" class="difflineminus">-{</span>
<a href="#l2.3303"></a><span id="l2.3303" class="difflineminus">-    nsresult rv = CreateBookmark(aName, aURL, aShortcutURL, aDescription, aDocCharSet, aResult);</span>
<a href="#l2.3304"></a><span id="l2.3304" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l2.3305"></a><span id="l2.3305" class="difflineminus">-        rv = InsertResource(*aResult, aParentFolder, aIndex);</span>
<a href="#l2.3306"></a><span id="l2.3306" class="difflineminus">-    return rv;</span>
<a href="#l2.3307"></a><span id="l2.3307" class="difflineminus">-}</span>
<a href="#l2.3308"></a><span id="l2.3308" class="difflineminus">-</span>
<a href="#l2.3309"></a><span id="l2.3309" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l2.3310"></a><span id="l2.3310" class="difflineminus">-nsBookmarksService::CreateSeparator(nsIRDFResource** aResult)</span>
<a href="#l2.3311"></a><span id="l2.3311" class="difflineminus">-{</span>
<a href="#l2.3312"></a><span id="l2.3312" class="difflineminus">-    nsresult rv;</span>
<a href="#l2.3313"></a><span id="l2.3313" class="difflineminus">-</span>
<a href="#l2.3314"></a><span id="l2.3314" class="difflineminus">-    // create the anonymous resource for the separator</span>
<a href="#l2.3315"></a><span id="l2.3315" class="difflineminus">-    nsCOMPtr&lt;nsIRDFResource&gt; separatorResource;</span>
<a href="#l2.3316"></a><span id="l2.3316" class="difflineminus">-    rv = gRDF-&gt;GetAnonymousResource(getter_AddRefs(separatorResource));</span>
<a href="#l2.3317"></a><span id="l2.3317" class="difflineminus">-    if (NS_FAILED(rv)) </span>
<a href="#l2.3318"></a><span id="l2.3318" class="difflineminus">-        return rv;</span>
<a href="#l2.3319"></a><span id="l2.3319" class="difflineminus">-</span>
<a href="#l2.3320"></a><span id="l2.3320" class="difflineminus">-    // Assert the separator type arc</span>
<a href="#l2.3321"></a><span id="l2.3321" class="difflineminus">-    rv = mInner-&gt;Assert(separatorResource, kRDF_type, kNC_BookmarkSeparator, PR_TRUE);</span>
<a href="#l2.3322"></a><span id="l2.3322" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l2.3323"></a><span id="l2.3323" class="difflineminus">-        return rv;</span>
<a href="#l2.3324"></a><span id="l2.3324" class="difflineminus">-</span>
<a href="#l2.3325"></a><span id="l2.3325" class="difflineminus">-    *aResult = separatorResource;</span>
<a href="#l2.3326"></a><span id="l2.3326" class="difflineminus">-    NS_ADDREF(*aResult);</span>
<a href="#l2.3327"></a><span id="l2.3327" class="difflineminus">-</span>
<a href="#l2.3328"></a><span id="l2.3328" class="difflineminus">-    return rv;</span>
<a href="#l2.3329"></a><span id="l2.3329" class="difflineminus">-}</span>
<a href="#l2.3330"></a><span id="l2.3330" class="difflineminus">-</span>
<a href="#l2.3331"></a><span id="l2.3331" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l2.3332"></a><span id="l2.3332" class="difflineminus">-nsBookmarksService::CloneResource(nsIRDFResource* aSource,</span>
<a href="#l2.3333"></a><span id="l2.3333" class="difflineminus">-                                  nsIRDFResource** aResult)</span>
<a href="#l2.3334"></a><span id="l2.3334" class="difflineminus">-{</span>
<a href="#l2.3335"></a><span id="l2.3335" class="difflineminus">-    nsCOMPtr&lt;nsIRDFResource&gt; newResource;</span>
<a href="#l2.3336"></a><span id="l2.3336" class="difflineminus">-    nsresult rv = gRDF-&gt;GetAnonymousResource(getter_AddRefs(newResource));</span>
<a href="#l2.3337"></a><span id="l2.3337" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.3338"></a><span id="l2.3338" class="difflineminus">-</span>
<a href="#l2.3339"></a><span id="l2.3339" class="difflineminus">-    nsCOMPtr&lt;nsISimpleEnumerator&gt; arcs;</span>
<a href="#l2.3340"></a><span id="l2.3340" class="difflineminus">-    rv = mInner-&gt;ArcLabelsOut(aSource, getter_AddRefs(arcs));</span>
<a href="#l2.3341"></a><span id="l2.3341" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.3342"></a><span id="l2.3342" class="difflineminus">-</span>
<a href="#l2.3343"></a><span id="l2.3343" class="difflineminus">-    PRBool hasMore = PR_FALSE;</span>
<a href="#l2.3344"></a><span id="l2.3344" class="difflineminus">-    while (NS_SUCCEEDED(arcs-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore) {</span>
<a href="#l2.3345"></a><span id="l2.3345" class="difflineminus">-        nsCOMPtr&lt;nsISupports&gt; supports;</span>
<a href="#l2.3346"></a><span id="l2.3346" class="difflineminus">-        rv = arcs-&gt;GetNext(getter_AddRefs(supports));</span>
<a href="#l2.3347"></a><span id="l2.3347" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.3348"></a><span id="l2.3348" class="difflineminus">-</span>
<a href="#l2.3349"></a><span id="l2.3349" class="difflineminus">-        nsCOMPtr&lt;nsIRDFResource&gt; property = do_QueryInterface(supports, &amp;rv);</span>
<a href="#l2.3350"></a><span id="l2.3350" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.3351"></a><span id="l2.3351" class="difflineminus">-      </span>
<a href="#l2.3352"></a><span id="l2.3352" class="difflineminus">-        // Don't duplicate the folder type.</span>
<a href="#l2.3353"></a><span id="l2.3353" class="difflineminus">-        // (NC:PersonalToolbarFolder, NC:NewBookmarkFolder, etc...)</span>
<a href="#l2.3354"></a><span id="l2.3354" class="difflineminus">-        PRBool isFolderType;</span>
<a href="#l2.3355"></a><span id="l2.3355" class="difflineminus">-        rv = property-&gt;EqualsNode(kNC_FolderType, &amp;isFolderType);</span>
<a href="#l2.3356"></a><span id="l2.3356" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.3357"></a><span id="l2.3357" class="difflineminus">-        if (isFolderType)</span>
<a href="#l2.3358"></a><span id="l2.3358" class="difflineminus">-            continue;</span>
<a href="#l2.3359"></a><span id="l2.3359" class="difflineminus">-</span>
<a href="#l2.3360"></a><span id="l2.3360" class="difflineminus">-        nsCOMPtr&lt;nsIRDFNode&gt; target;</span>
<a href="#l2.3361"></a><span id="l2.3361" class="difflineminus">-        rv = mInner-&gt;GetTarget(aSource, property, PR_TRUE, getter_AddRefs(target));</span>
<a href="#l2.3362"></a><span id="l2.3362" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.3363"></a><span id="l2.3363" class="difflineminus">- </span>
<a href="#l2.3364"></a><span id="l2.3364" class="difflineminus">-        // Test if the arc points to a child.</span>
<a href="#l2.3365"></a><span id="l2.3365" class="difflineminus">-        PRBool isOrdinal;</span>
<a href="#l2.3366"></a><span id="l2.3366" class="difflineminus">-        rv = gRDFC-&gt;IsOrdinalProperty(property, &amp;isOrdinal);</span>
<a href="#l2.3367"></a><span id="l2.3367" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.3368"></a><span id="l2.3368" class="difflineminus">-</span>
<a href="#l2.3369"></a><span id="l2.3369" class="difflineminus">-        if (isOrdinal) {</span>
<a href="#l2.3370"></a><span id="l2.3370" class="difflineminus">-            nsCOMPtr&lt;nsIRDFResource&gt; oldChild = do_QueryInterface(target);</span>
<a href="#l2.3371"></a><span id="l2.3371" class="difflineminus">-            nsCOMPtr&lt;nsIRDFResource&gt; newChild;</span>
<a href="#l2.3372"></a><span id="l2.3372" class="difflineminus">-            rv = CloneResource(oldChild, getter_AddRefs(newChild));</span>
<a href="#l2.3373"></a><span id="l2.3373" class="difflineminus">-            NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.3374"></a><span id="l2.3374" class="difflineminus">-</span>
<a href="#l2.3375"></a><span id="l2.3375" class="difflineminus">-            rv = mInner-&gt;Assert(newResource, property, newChild, PR_TRUE);</span>
<a href="#l2.3376"></a><span id="l2.3376" class="difflineminus">-        }</span>
<a href="#l2.3377"></a><span id="l2.3377" class="difflineminus">-        else {</span>
<a href="#l2.3378"></a><span id="l2.3378" class="difflineminus">-            rv = mInner-&gt;Assert(newResource, property, target, PR_TRUE);</span>
<a href="#l2.3379"></a><span id="l2.3379" class="difflineminus">-        }</span>
<a href="#l2.3380"></a><span id="l2.3380" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.3381"></a><span id="l2.3381" class="difflineminus">-    }</span>
<a href="#l2.3382"></a><span id="l2.3382" class="difflineminus">-</span>
<a href="#l2.3383"></a><span id="l2.3383" class="difflineminus">-    NS_ADDREF(*aResult = newResource);</span>
<a href="#l2.3384"></a><span id="l2.3384" class="difflineminus">-</span>
<a href="#l2.3385"></a><span id="l2.3385" class="difflineminus">-    return NS_OK;</span>
<a href="#l2.3386"></a><span id="l2.3386" class="difflineminus">-}</span>
<a href="#l2.3387"></a><span id="l2.3387" class="difflineminus">-</span>
<a href="#l2.3388"></a><span id="l2.3388" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l2.3389"></a><span id="l2.3389" class="difflineminus">-nsBookmarksService::AddBookmarkImmediately(const PRUnichar *aURI,</span>
<a href="#l2.3390"></a><span id="l2.3390" class="difflineminus">-                                           const PRUnichar *aTitle, </span>
<a href="#l2.3391"></a><span id="l2.3391" class="difflineminus">-                                           PRInt32 aBookmarkType, </span>
<a href="#l2.3392"></a><span id="l2.3392" class="difflineminus">-                                           const PRUnichar *aCharset)</span>
<a href="#l2.3393"></a><span id="l2.3393" class="difflineminus">-{</span>
<a href="#l2.3394"></a><span id="l2.3394" class="difflineminus">-    nsresult rv;</span>
<a href="#l2.3395"></a><span id="l2.3395" class="difflineminus">-</span>
<a href="#l2.3396"></a><span id="l2.3396" class="difflineminus">-    // Figure out where to add the new bookmark</span>
<a href="#l2.3397"></a><span id="l2.3397" class="difflineminus">-    nsCOMPtr&lt;nsIRDFResource&gt; bookmarkFolder = kNC_NewBookmarkFolder;</span>
<a href="#l2.3398"></a><span id="l2.3398" class="difflineminus">-</span>
<a href="#l2.3399"></a><span id="l2.3399" class="difflineminus">-    switch(aBookmarkType)</span>
<a href="#l2.3400"></a><span id="l2.3400" class="difflineminus">-    {</span>
<a href="#l2.3401"></a><span id="l2.3401" class="difflineminus">-    case BOOKMARK_SEARCH_TYPE:</span>
<a href="#l2.3402"></a><span id="l2.3402" class="difflineminus">-    case BOOKMARK_FIND_TYPE:</span>
<a href="#l2.3403"></a><span id="l2.3403" class="difflineminus">-        bookmarkFolder = kNC_NewSearchFolder;</span>
<a href="#l2.3404"></a><span id="l2.3404" class="difflineminus">-        break;</span>
<a href="#l2.3405"></a><span id="l2.3405" class="difflineminus">-    }</span>
<a href="#l2.3406"></a><span id="l2.3406" class="difflineminus">-</span>
<a href="#l2.3407"></a><span id="l2.3407" class="difflineminus">-    nsCOMPtr&lt;nsIRDFResource&gt; destinationFolder;</span>
<a href="#l2.3408"></a><span id="l2.3408" class="difflineminus">-    rv = getFolderViaHint(bookmarkFolder, PR_TRUE, getter_AddRefs(destinationFolder));</span>
<a href="#l2.3409"></a><span id="l2.3409" class="difflineminus">-    if (NS_FAILED(rv)) </span>
<a href="#l2.3410"></a><span id="l2.3410" class="difflineminus">-        return rv;</span>
<a href="#l2.3411"></a><span id="l2.3411" class="difflineminus">-</span>
<a href="#l2.3412"></a><span id="l2.3412" class="difflineminus">-    nsCOMPtr&lt;nsIRDFResource&gt; bookmark;</span>
<a href="#l2.3413"></a><span id="l2.3413" class="difflineminus">-    return CreateBookmarkInContainer(aTitle, aURI, nsnull, nsnull, aCharset, destinationFolder, -1, </span>
<a href="#l2.3414"></a><span id="l2.3414" class="difflineminus">-                                     getter_AddRefs(bookmark));</span>
<a href="#l2.3415"></a><span id="l2.3415" class="difflineminus">-}</span>
<a href="#l2.3416"></a><span id="l2.3416" class="difflineminus">-</span>
<a href="#l2.3417"></a><span id="l2.3417" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l2.3418"></a><span id="l2.3418" class="difflineminus">-nsBookmarksService::IsBookmarkedResource(nsIRDFResource *bookmark, PRBool *isBookmarkedFlag)</span>
<a href="#l2.3419"></a><span id="l2.3419" class="difflineminus">-{</span>
<a href="#l2.3420"></a><span id="l2.3420" class="difflineminus">-    if (!bookmark)      return NS_ERROR_UNEXPECTED;</span>
<a href="#l2.3421"></a><span id="l2.3421" class="difflineminus">-    if (!isBookmarkedFlag)  return NS_ERROR_UNEXPECTED;</span>
<a href="#l2.3422"></a><span id="l2.3422" class="difflineminus">-    if (!mInner)        return NS_ERROR_UNEXPECTED;</span>
<a href="#l2.3423"></a><span id="l2.3423" class="difflineminus">-</span>
<a href="#l2.3424"></a><span id="l2.3424" class="difflineminus">-    // bookmark root is special (it isn't contained in a rdf seq)</span>
<a href="#l2.3425"></a><span id="l2.3425" class="difflineminus">-    if (bookmark == kNC_BookmarksRoot)</span>
<a href="#l2.3426"></a><span id="l2.3426" class="difflineminus">-    {</span>
<a href="#l2.3427"></a><span id="l2.3427" class="difflineminus">-        *isBookmarkedFlag = PR_TRUE;</span>
<a href="#l2.3428"></a><span id="l2.3428" class="difflineminus">-        return NS_OK;</span>
<a href="#l2.3429"></a><span id="l2.3429" class="difflineminus">-    }</span>
<a href="#l2.3430"></a><span id="l2.3430" class="difflineminus">-</span>
<a href="#l2.3431"></a><span id="l2.3431" class="difflineminus">-    *isBookmarkedFlag = PR_FALSE;</span>
<a href="#l2.3432"></a><span id="l2.3432" class="difflineminus">-</span>
<a href="#l2.3433"></a><span id="l2.3433" class="difflineminus">-    // make sure it is referred to by an ordinal (i.e. is contained in a rdf seq)</span>
<a href="#l2.3434"></a><span id="l2.3434" class="difflineminus">-    nsresult rv;</span>
<a href="#l2.3435"></a><span id="l2.3435" class="difflineminus">-    nsCOMPtr&lt;nsISimpleEnumerator&gt;   enumerator;</span>
<a href="#l2.3436"></a><span id="l2.3436" class="difflineminus">-    if (NS_FAILED(rv = mInner-&gt;ArcLabelsIn(bookmark, getter_AddRefs(enumerator))))</span>
<a href="#l2.3437"></a><span id="l2.3437" class="difflineminus">-        return rv;</span>
<a href="#l2.3438"></a><span id="l2.3438" class="difflineminus">-        </span>
<a href="#l2.3439"></a><span id="l2.3439" class="difflineminus">-    PRBool  more = PR_TRUE;</span>
<a href="#l2.3440"></a><span id="l2.3440" class="difflineminus">-    while(NS_SUCCEEDED(rv = enumerator-&gt;HasMoreElements(&amp;more))</span>
<a href="#l2.3441"></a><span id="l2.3441" class="difflineminus">-        &amp;&amp; (more == PR_TRUE))</span>
<a href="#l2.3442"></a><span id="l2.3442" class="difflineminus">-    {</span>
<a href="#l2.3443"></a><span id="l2.3443" class="difflineminus">-        nsCOMPtr&lt;nsISupports&gt;       isupports;</span>
<a href="#l2.3444"></a><span id="l2.3444" class="difflineminus">-        if (NS_FAILED(rv = enumerator-&gt;GetNext(getter_AddRefs(isupports))))</span>
<a href="#l2.3445"></a><span id="l2.3445" class="difflineminus">-            break;</span>
<a href="#l2.3446"></a><span id="l2.3446" class="difflineminus">-        nsCOMPtr&lt;nsIRDFResource&gt;    property = do_QueryInterface(isupports);</span>
<a href="#l2.3447"></a><span id="l2.3447" class="difflineminus">-        if (!property)  continue;</span>
<a href="#l2.3448"></a><span id="l2.3448" class="difflineminus">-</span>
<a href="#l2.3449"></a><span id="l2.3449" class="difflineminus">-        PRBool  flag = PR_FALSE;</span>
<a href="#l2.3450"></a><span id="l2.3450" class="difflineminus">-        if (NS_FAILED(rv = gRDFC-&gt;IsOrdinalProperty(property, &amp;flag)))  continue;</span>
<a href="#l2.3451"></a><span id="l2.3451" class="difflineminus">-        if (flag == PR_TRUE)</span>
<a href="#l2.3452"></a><span id="l2.3452" class="difflineminus">-        {</span>
<a href="#l2.3453"></a><span id="l2.3453" class="difflineminus">-            *isBookmarkedFlag = PR_TRUE;</span>
<a href="#l2.3454"></a><span id="l2.3454" class="difflineminus">-            break;</span>
<a href="#l2.3455"></a><span id="l2.3455" class="difflineminus">-        }</span>
<a href="#l2.3456"></a><span id="l2.3456" class="difflineminus">-    }</span>
<a href="#l2.3457"></a><span id="l2.3457" class="difflineminus">-    return rv;</span>
<a href="#l2.3458"></a><span id="l2.3458" class="difflineminus">-}</span>
<a href="#l2.3459"></a><span id="l2.3459" class="difflineminus">-</span>
<a href="#l2.3460"></a><span id="l2.3460" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l2.3461"></a><span id="l2.3461" class="difflineminus">-nsBookmarksService::IsBookmarked(const char* aURL, PRBool* aIsBookmarked)</span>
<a href="#l2.3462"></a><span id="l2.3462" class="difflineminus">-{</span>
<a href="#l2.3463"></a><span id="l2.3463" class="difflineminus">-    NS_ENSURE_ARG(aURL);</span>
<a href="#l2.3464"></a><span id="l2.3464" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aIsBookmarked);</span>
<a href="#l2.3465"></a><span id="l2.3465" class="difflineminus">-</span>
<a href="#l2.3466"></a><span id="l2.3466" class="difflineminus">-    if (!mInner)</span>
<a href="#l2.3467"></a><span id="l2.3467" class="difflineminus">-        return NS_ERROR_UNEXPECTED;</span>
<a href="#l2.3468"></a><span id="l2.3468" class="difflineminus">-</span>
<a href="#l2.3469"></a><span id="l2.3469" class="difflineminus">-    *aIsBookmarked = PR_FALSE;</span>
<a href="#l2.3470"></a><span id="l2.3470" class="difflineminus">-</span>
<a href="#l2.3471"></a><span id="l2.3471" class="difflineminus">-    nsCOMPtr&lt;nsIRDFLiteral&gt; urlLiteral;</span>
<a href="#l2.3472"></a><span id="l2.3472" class="difflineminus">-    nsresult rv = gRDF-&gt;GetLiteral(NS_ConvertUTF8toUTF16(aURL).get(),</span>
<a href="#l2.3473"></a><span id="l2.3473" class="difflineminus">-                                   getter_AddRefs(urlLiteral));</span>
<a href="#l2.3474"></a><span id="l2.3474" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l2.3475"></a><span id="l2.3475" class="difflineminus">-        return rv;</span>
<a href="#l2.3476"></a><span id="l2.3476" class="difflineminus">-</span>
<a href="#l2.3477"></a><span id="l2.3477" class="difflineminus">-    nsCOMPtr&lt;nsIRDFResource&gt; bookmark;</span>
<a href="#l2.3478"></a><span id="l2.3478" class="difflineminus">-    rv = GetSource(kNC_URL, urlLiteral, PR_TRUE, getter_AddRefs(bookmark));</span>
<a href="#l2.3479"></a><span id="l2.3479" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l2.3480"></a><span id="l2.3480" class="difflineminus">-        return rv;</span>
<a href="#l2.3481"></a><span id="l2.3481" class="difflineminus">-</span>
<a href="#l2.3482"></a><span id="l2.3482" class="difflineminus">-    return IsBookmarkedResource(bookmark, aIsBookmarked);</span>
<a href="#l2.3483"></a><span id="l2.3483" class="difflineminus">-}</span>
<a href="#l2.3484"></a><span id="l2.3484" class="difflineminus">-</span>
<a href="#l2.3485"></a><span id="l2.3485" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l2.3486"></a><span id="l2.3486" class="difflineminus">-nsBookmarksService::RequestCharset(nsIWebNavigation* aWebNavigation,</span>
<a href="#l2.3487"></a><span id="l2.3487" class="difflineminus">-                                   nsIChannel* aChannel,</span>
<a href="#l2.3488"></a><span id="l2.3488" class="difflineminus">-                                   PRBool* aWantCharset,</span>
<a href="#l2.3489"></a><span id="l2.3489" class="difflineminus">-                                   nsISupports** aClosure,</span>
<a href="#l2.3490"></a><span id="l2.3490" class="difflineminus">-                                   nsACString&amp; aResult)</span>
<a href="#l2.3491"></a><span id="l2.3491" class="difflineminus">-{</span>
<a href="#l2.3492"></a><span id="l2.3492" class="difflineminus">-    if (!mInner)</span>
<a href="#l2.3493"></a><span id="l2.3493" class="difflineminus">-        return NS_ERROR_UNEXPECTED;</span>
<a href="#l2.3494"></a><span id="l2.3494" class="difflineminus">-    *aWantCharset = PR_FALSE;</span>
<a href="#l2.3495"></a><span id="l2.3495" class="difflineminus">-    *aClosure = nsnull;</span>
<a href="#l2.3496"></a><span id="l2.3496" class="difflineminus">-</span>
<a href="#l2.3497"></a><span id="l2.3497" class="difflineminus">-    nsresult rv;</span>
<a href="#l2.3498"></a><span id="l2.3498" class="difflineminus">-    </span>
<a href="#l2.3499"></a><span id="l2.3499" class="difflineminus">-    nsCOMPtr&lt;nsIURI&gt; uri;</span>
<a href="#l2.3500"></a><span id="l2.3500" class="difflineminus">-    rv = aChannel-&gt;GetURI(getter_AddRefs(uri));</span>
<a href="#l2.3501"></a><span id="l2.3501" class="difflineminus">-</span>
<a href="#l2.3502"></a><span id="l2.3502" class="difflineminus">-    nsCAutoString urlSpec;</span>
<a href="#l2.3503"></a><span id="l2.3503" class="difflineminus">-    uri-&gt;GetSpec(urlSpec);</span>
<a href="#l2.3504"></a><span id="l2.3504" class="difflineminus">-   </span>
<a href="#l2.3505"></a><span id="l2.3505" class="difflineminus">-    nsCOMPtr&lt;nsIRDFLiteral&gt; urlLiteral;</span>
<a href="#l2.3506"></a><span id="l2.3506" class="difflineminus">-    rv = gRDF-&gt;GetLiteral(NS_ConvertUTF8toUTF16(urlSpec).get(),</span>
<a href="#l2.3507"></a><span id="l2.3507" class="difflineminus">-                                   getter_AddRefs(urlLiteral));</span>
<a href="#l2.3508"></a><span id="l2.3508" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l2.3509"></a><span id="l2.3509" class="difflineminus">-        return rv;</span>
<a href="#l2.3510"></a><span id="l2.3510" class="difflineminus">-</span>
<a href="#l2.3511"></a><span id="l2.3511" class="difflineminus">-    nsCOMPtr&lt;nsIRDFResource&gt; bookmark;</span>
<a href="#l2.3512"></a><span id="l2.3512" class="difflineminus">-    rv = GetSource(kNC_URL, urlLiteral, PR_TRUE, getter_AddRefs(bookmark));</span>
<a href="#l2.3513"></a><span id="l2.3513" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l2.3514"></a><span id="l2.3514" class="difflineminus">-        return rv;</span>
<a href="#l2.3515"></a><span id="l2.3515" class="difflineminus">-</span>
<a href="#l2.3516"></a><span id="l2.3516" class="difflineminus">-    if (bookmark) {</span>
<a href="#l2.3517"></a><span id="l2.3517" class="difflineminus">-        // Always use mInner! Otherwise, could get into an infinite loop</span>
<a href="#l2.3518"></a><span id="l2.3518" class="difflineminus">-        // due to Assert/Change calling UpdateBookmarkLastModifiedDate().</span>
<a href="#l2.3519"></a><span id="l2.3519" class="difflineminus">-</span>
<a href="#l2.3520"></a><span id="l2.3520" class="difflineminus">-        nsCOMPtr&lt;nsIRDFNode&gt; nodeType;</span>
<a href="#l2.3521"></a><span id="l2.3521" class="difflineminus">-        GetSynthesizedType(bookmark, getter_AddRefs(nodeType));</span>
<a href="#l2.3522"></a><span id="l2.3522" class="difflineminus">-        if (nodeType == kNC_Bookmark) {</span>
<a href="#l2.3523"></a><span id="l2.3523" class="difflineminus">-            nsCOMPtr&lt;nsIRDFNode&gt;  charsetNode;</span>
<a href="#l2.3524"></a><span id="l2.3524" class="difflineminus">-            rv = mInner-&gt;GetTarget(bookmark, kWEB_LastCharset, PR_TRUE,</span>
<a href="#l2.3525"></a><span id="l2.3525" class="difflineminus">-                                   getter_AddRefs(charsetNode));</span>
<a href="#l2.3526"></a><span id="l2.3526" class="difflineminus">-            if (NS_FAILED(rv))</span>
<a href="#l2.3527"></a><span id="l2.3527" class="difflineminus">-                return rv;</span>
<a href="#l2.3528"></a><span id="l2.3528" class="difflineminus">-</span>
<a href="#l2.3529"></a><span id="l2.3529" class="difflineminus">-            if (charsetNode) {</span>
<a href="#l2.3530"></a><span id="l2.3530" class="difflineminus">-                nsCOMPtr&lt;nsIRDFLiteral&gt; charsetLiteral = do_QueryInterface(charsetNode);</span>
<a href="#l2.3531"></a><span id="l2.3531" class="difflineminus">-                if (charsetLiteral) {</span>
<a href="#l2.3532"></a><span id="l2.3532" class="difflineminus">-                    const PRUnichar* charset;</span>
<a href="#l2.3533"></a><span id="l2.3533" class="difflineminus">-                    charsetLiteral-&gt;GetValueConst(&amp;charset);</span>
<a href="#l2.3534"></a><span id="l2.3534" class="difflineminus">-                    LossyCopyUTF16toASCII(nsDependentString(charset), aResult);</span>
<a href="#l2.3535"></a><span id="l2.3535" class="difflineminus">-                    </span>
<a href="#l2.3536"></a><span id="l2.3536" class="difflineminus">-                    return NS_OK;</span>
<a href="#l2.3537"></a><span id="l2.3537" class="difflineminus">-                }</span>
<a href="#l2.3538"></a><span id="l2.3538" class="difflineminus">-            }</span>
<a href="#l2.3539"></a><span id="l2.3539" class="difflineminus">-        }</span>
<a href="#l2.3540"></a><span id="l2.3540" class="difflineminus">-    }</span>
<a href="#l2.3541"></a><span id="l2.3541" class="difflineminus">-</span>
<a href="#l2.3542"></a><span id="l2.3542" class="difflineminus">-    aResult.Truncate();</span>
<a href="#l2.3543"></a><span id="l2.3543" class="difflineminus">-    return NS_OK;</span>
<a href="#l2.3544"></a><span id="l2.3544" class="difflineminus">-}</span>
<a href="#l2.3545"></a><span id="l2.3545" class="difflineminus">-</span>
<a href="#l2.3546"></a><span id="l2.3546" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l2.3547"></a><span id="l2.3547" class="difflineminus">-nsBookmarksService::NotifyResolvedCharset(const nsACString&amp; aCharset,</span>
<a href="#l2.3548"></a><span id="l2.3548" class="difflineminus">-                                          nsISupports* aClosure)</span>
<a href="#l2.3549"></a><span id="l2.3549" class="difflineminus">-{</span>
<a href="#l2.3550"></a><span id="l2.3550" class="difflineminus">-    NS_ERROR(&quot;Unexpected call to NotifyResolvedCharset -- we never set aWantCharset to true!&quot;);</span>
<a href="#l2.3551"></a><span id="l2.3551" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l2.3552"></a><span id="l2.3552" class="difflineminus">-}</span>
<a href="#l2.3553"></a><span id="l2.3553" class="difflineminus">-</span>
<a href="#l2.3554"></a><span id="l2.3554" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l2.3555"></a><span id="l2.3555" class="difflineminus">-nsBookmarksService::UpdateBookmarkIcon(const char *aURL, const PRUnichar *aIconURL)</span>
<a href="#l2.3556"></a><span id="l2.3556" class="difflineminus">-{</span>
<a href="#l2.3557"></a><span id="l2.3557" class="difflineminus">-    nsCOMPtr&lt;nsIRDFLiteral&gt; urlLiteral;</span>
<a href="#l2.3558"></a><span id="l2.3558" class="difflineminus">-    nsresult rv = gRDF-&gt;GetLiteral(NS_ConvertUTF8toUTF16(aURL).get(),</span>
<a href="#l2.3559"></a><span id="l2.3559" class="difflineminus">-                                   getter_AddRefs(urlLiteral));</span>
<a href="#l2.3560"></a><span id="l2.3560" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l2.3561"></a><span id="l2.3561" class="difflineminus">-        return rv;</span>
<a href="#l2.3562"></a><span id="l2.3562" class="difflineminus">-</span>
<a href="#l2.3563"></a><span id="l2.3563" class="difflineminus">-    nsCOMPtr&lt;nsISimpleEnumerator&gt; bookmarks;</span>
<a href="#l2.3564"></a><span id="l2.3564" class="difflineminus">-    rv = GetSources(kNC_URL, urlLiteral, PR_TRUE, getter_AddRefs(bookmarks));</span>
<a href="#l2.3565"></a><span id="l2.3565" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l2.3566"></a><span id="l2.3566" class="difflineminus">-        return rv;</span>
<a href="#l2.3567"></a><span id="l2.3567" class="difflineminus">-</span>
<a href="#l2.3568"></a><span id="l2.3568" class="difflineminus">-    PRBool hasMoreBookmarks = PR_FALSE;</span>
<a href="#l2.3569"></a><span id="l2.3569" class="difflineminus">-    while (NS_SUCCEEDED(rv = bookmarks-&gt;HasMoreElements(&amp;hasMoreBookmarks)) &amp;&amp;</span>
<a href="#l2.3570"></a><span id="l2.3570" class="difflineminus">-           hasMoreBookmarks) {</span>
<a href="#l2.3571"></a><span id="l2.3571" class="difflineminus">-        nsCOMPtr&lt;nsISupports&gt; supports;</span>
<a href="#l2.3572"></a><span id="l2.3572" class="difflineminus">-        rv = bookmarks-&gt;GetNext(getter_AddRefs(supports));</span>
<a href="#l2.3573"></a><span id="l2.3573" class="difflineminus">-        if (NS_FAILED(rv)) </span>
<a href="#l2.3574"></a><span id="l2.3574" class="difflineminus">-            return rv;</span>
<a href="#l2.3575"></a><span id="l2.3575" class="difflineminus">-</span>
<a href="#l2.3576"></a><span id="l2.3576" class="difflineminus">-        nsCOMPtr&lt;nsIRDFResource&gt; bookmark = do_QueryInterface(supports);</span>
<a href="#l2.3577"></a><span id="l2.3577" class="difflineminus">-        if (bookmark) {</span>
<a href="#l2.3578"></a><span id="l2.3578" class="difflineminus">-            nsCOMPtr&lt;nsIRDFNode&gt; iconNode;</span>
<a href="#l2.3579"></a><span id="l2.3579" class="difflineminus">-            rv = ProcessCachedBookmarkIcon(bookmark, aIconURL,</span>
<a href="#l2.3580"></a><span id="l2.3580" class="difflineminus">-                                           getter_AddRefs(iconNode));</span>
<a href="#l2.3581"></a><span id="l2.3581" class="difflineminus">-            if (NS_FAILED(rv))</span>
<a href="#l2.3582"></a><span id="l2.3582" class="difflineminus">-                return rv;</span>
<a href="#l2.3583"></a><span id="l2.3583" class="difflineminus">-</span>
<a href="#l2.3584"></a><span id="l2.3584" class="difflineminus">-            if (iconNode) {</span>
<a href="#l2.3585"></a><span id="l2.3585" class="difflineminus">-                // Yes, that's right. Fake out RDF observers.</span>
<a href="#l2.3586"></a><span id="l2.3586" class="difflineminus">-                (void)OnAssert(this, bookmark, kNC_Icon, iconNode);</span>
<a href="#l2.3587"></a><span id="l2.3587" class="difflineminus">-            }</span>
<a href="#l2.3588"></a><span id="l2.3588" class="difflineminus">-        }</span>
<a href="#l2.3589"></a><span id="l2.3589" class="difflineminus">-    }</span>
<a href="#l2.3590"></a><span id="l2.3590" class="difflineminus">-</span>
<a href="#l2.3591"></a><span id="l2.3591" class="difflineminus">-    return NS_OK;</span>
<a href="#l2.3592"></a><span id="l2.3592" class="difflineminus">-}</span>
<a href="#l2.3593"></a><span id="l2.3593" class="difflineminus">-</span>
<a href="#l2.3594"></a><span id="l2.3594" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l2.3595"></a><span id="l2.3595" class="difflineminus">-nsBookmarksService::RemoveBookmarkIcon(const char *aURL, const PRUnichar *aIconURL)</span>
<a href="#l2.3596"></a><span id="l2.3596" class="difflineminus">-{</span>
<a href="#l2.3597"></a><span id="l2.3597" class="difflineminus">-    nsCOMPtr&lt;nsIRDFLiteral&gt; urlLiteral;</span>
<a href="#l2.3598"></a><span id="l2.3598" class="difflineminus">-    nsresult rv = gRDF-&gt;GetLiteral(NS_ConvertUTF8toUTF16(aURL).get(),</span>
<a href="#l2.3599"></a><span id="l2.3599" class="difflineminus">-                                   getter_AddRefs(urlLiteral));</span>
<a href="#l2.3600"></a><span id="l2.3600" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l2.3601"></a><span id="l2.3601" class="difflineminus">-        return rv;</span>
<a href="#l2.3602"></a><span id="l2.3602" class="difflineminus">-</span>
<a href="#l2.3603"></a><span id="l2.3603" class="difflineminus">-    nsCOMPtr&lt;nsISimpleEnumerator&gt; bookmarks;</span>
<a href="#l2.3604"></a><span id="l2.3604" class="difflineminus">-    rv = GetSources(kNC_URL, urlLiteral, PR_TRUE, getter_AddRefs(bookmarks));</span>
<a href="#l2.3605"></a><span id="l2.3605" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l2.3606"></a><span id="l2.3606" class="difflineminus">-        return rv;</span>
<a href="#l2.3607"></a><span id="l2.3607" class="difflineminus">-</span>
<a href="#l2.3608"></a><span id="l2.3608" class="difflineminus">-    PRBool hasMoreBookmarks = PR_FALSE;</span>
<a href="#l2.3609"></a><span id="l2.3609" class="difflineminus">-    while (NS_SUCCEEDED(rv = bookmarks-&gt;HasMoreElements(&amp;hasMoreBookmarks)) &amp;&amp;</span>
<a href="#l2.3610"></a><span id="l2.3610" class="difflineminus">-           hasMoreBookmarks) {</span>
<a href="#l2.3611"></a><span id="l2.3611" class="difflineminus">-        nsCOMPtr&lt;nsISupports&gt; supports;</span>
<a href="#l2.3612"></a><span id="l2.3612" class="difflineminus">-        rv = bookmarks-&gt;GetNext(getter_AddRefs(supports));</span>
<a href="#l2.3613"></a><span id="l2.3613" class="difflineminus">-        if (NS_FAILED(rv)) </span>
<a href="#l2.3614"></a><span id="l2.3614" class="difflineminus">-            return rv;</span>
<a href="#l2.3615"></a><span id="l2.3615" class="difflineminus">-</span>
<a href="#l2.3616"></a><span id="l2.3616" class="difflineminus">-        nsCOMPtr&lt;nsIRDFResource&gt; bookmark = do_QueryInterface(supports);</span>
<a href="#l2.3617"></a><span id="l2.3617" class="difflineminus">-        if (bookmark) {</span>
<a href="#l2.3618"></a><span id="l2.3618" class="difflineminus">-            nsCOMPtr&lt;nsIRDFLiteral&gt; iconLiteral;</span>
<a href="#l2.3619"></a><span id="l2.3619" class="difflineminus">-            rv = gRDF-&gt;GetLiteral(aIconURL, getter_AddRefs(iconLiteral));</span>
<a href="#l2.3620"></a><span id="l2.3620" class="difflineminus">-            if (NS_FAILED(rv)) </span>
<a href="#l2.3621"></a><span id="l2.3621" class="difflineminus">-                return rv;</span>
<a href="#l2.3622"></a><span id="l2.3622" class="difflineminus">-</span>
<a href="#l2.3623"></a><span id="l2.3623" class="difflineminus">-            PRBool hasThisIconURL = PR_FALSE;</span>
<a href="#l2.3624"></a><span id="l2.3624" class="difflineminus">-            rv = mInner-&gt;HasAssertion(bookmark, kNC_Icon, iconLiteral, PR_TRUE,</span>
<a href="#l2.3625"></a><span id="l2.3625" class="difflineminus">-                                      &amp;hasThisIconURL);</span>
<a href="#l2.3626"></a><span id="l2.3626" class="difflineminus">-            if (NS_FAILED(rv)) </span>
<a href="#l2.3627"></a><span id="l2.3627" class="difflineminus">-                return rv;</span>
<a href="#l2.3628"></a><span id="l2.3628" class="difflineminus">-</span>
<a href="#l2.3629"></a><span id="l2.3629" class="difflineminus">-            if (hasThisIconURL) {</span>
<a href="#l2.3630"></a><span id="l2.3630" class="difflineminus">-                (void)mInner-&gt;Unassert(bookmark, kNC_Icon, iconLiteral);</span>
<a href="#l2.3631"></a><span id="l2.3631" class="difflineminus">-</span>
<a href="#l2.3632"></a><span id="l2.3632" class="difflineminus">-                mDirty = PR_TRUE;</span>
<a href="#l2.3633"></a><span id="l2.3633" class="difflineminus">-            }</span>
<a href="#l2.3634"></a><span id="l2.3634" class="difflineminus">-        }</span>
<a href="#l2.3635"></a><span id="l2.3635" class="difflineminus">-    }</span>
<a href="#l2.3636"></a><span id="l2.3636" class="difflineminus">-</span>
<a href="#l2.3637"></a><span id="l2.3637" class="difflineminus">-    return NS_OK;</span>
<a href="#l2.3638"></a><span id="l2.3638" class="difflineminus">-}</span>
<a href="#l2.3639"></a><span id="l2.3639" class="difflineminus">-</span>
<a href="#l2.3640"></a><span id="l2.3640" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l2.3641"></a><span id="l2.3641" class="difflineminus">-nsBookmarksService::UpdateLastVisitedDate(const char *aURL,</span>
<a href="#l2.3642"></a><span id="l2.3642" class="difflineminus">-                                          const PRUnichar *aCharset)</span>
<a href="#l2.3643"></a><span id="l2.3643" class="difflineminus">-{</span>
<a href="#l2.3644"></a><span id="l2.3644" class="difflineminus">-    NS_PRECONDITION(aURL != nsnull, &quot;null ptr&quot;);</span>
<a href="#l2.3645"></a><span id="l2.3645" class="difflineminus">-    if (! aURL)</span>
<a href="#l2.3646"></a><span id="l2.3646" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l2.3647"></a><span id="l2.3647" class="difflineminus">-</span>
<a href="#l2.3648"></a><span id="l2.3648" class="difflineminus">-    NS_PRECONDITION(aCharset != nsnull, &quot;null ptr&quot;);</span>
<a href="#l2.3649"></a><span id="l2.3649" class="difflineminus">-    if (! aCharset)</span>
<a href="#l2.3650"></a><span id="l2.3650" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l2.3651"></a><span id="l2.3651" class="difflineminus">-</span>
<a href="#l2.3652"></a><span id="l2.3652" class="difflineminus">-    nsCOMPtr&lt;nsIRDFLiteral&gt; urlLiteral;</span>
<a href="#l2.3653"></a><span id="l2.3653" class="difflineminus">-    nsresult rv = gRDF-&gt;GetLiteral(NS_ConvertUTF8toUTF16(aURL).get(),</span>
<a href="#l2.3654"></a><span id="l2.3654" class="difflineminus">-                                   getter_AddRefs(urlLiteral));</span>
<a href="#l2.3655"></a><span id="l2.3655" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l2.3656"></a><span id="l2.3656" class="difflineminus">-        return rv;</span>
<a href="#l2.3657"></a><span id="l2.3657" class="difflineminus">-</span>
<a href="#l2.3658"></a><span id="l2.3658" class="difflineminus">-    nsCOMPtr&lt;nsISimpleEnumerator&gt; bookmarks;</span>
<a href="#l2.3659"></a><span id="l2.3659" class="difflineminus">-    rv = GetSources(kNC_URL, urlLiteral, PR_TRUE, getter_AddRefs(bookmarks));</span>
<a href="#l2.3660"></a><span id="l2.3660" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l2.3661"></a><span id="l2.3661" class="difflineminus">-        return rv;</span>
<a href="#l2.3662"></a><span id="l2.3662" class="difflineminus">-</span>
<a href="#l2.3663"></a><span id="l2.3663" class="difflineminus">-    PRBool hasMoreBookmarks = PR_FALSE;</span>
<a href="#l2.3664"></a><span id="l2.3664" class="difflineminus">-    while (NS_SUCCEEDED(rv = bookmarks-&gt;HasMoreElements(&amp;hasMoreBookmarks)) &amp;&amp;</span>
<a href="#l2.3665"></a><span id="l2.3665" class="difflineminus">-           hasMoreBookmarks) {</span>
<a href="#l2.3666"></a><span id="l2.3666" class="difflineminus">-        nsCOMPtr&lt;nsISupports&gt; supports;</span>
<a href="#l2.3667"></a><span id="l2.3667" class="difflineminus">-        rv = bookmarks-&gt;GetNext(getter_AddRefs(supports));</span>
<a href="#l2.3668"></a><span id="l2.3668" class="difflineminus">-        if (NS_FAILED(rv)) </span>
<a href="#l2.3669"></a><span id="l2.3669" class="difflineminus">-            return rv;</span>
<a href="#l2.3670"></a><span id="l2.3670" class="difflineminus">-</span>
<a href="#l2.3671"></a><span id="l2.3671" class="difflineminus">-        nsCOMPtr&lt;nsIRDFResource&gt; bookmark = do_QueryInterface(supports);</span>
<a href="#l2.3672"></a><span id="l2.3672" class="difflineminus">-        if (bookmark) {</span>
<a href="#l2.3673"></a><span id="l2.3673" class="difflineminus">-            // Always use mInner! Otherwise, we could get into an infinite loop</span>
<a href="#l2.3674"></a><span id="l2.3674" class="difflineminus">-            // due to Assert/Change calling UpdateBookmarkLastModifiedDate().</span>
<a href="#l2.3675"></a><span id="l2.3675" class="difflineminus">-</span>
<a href="#l2.3676"></a><span id="l2.3676" class="difflineminus">-            nsCOMPtr&lt;nsIRDFNode&gt; nodeType;</span>
<a href="#l2.3677"></a><span id="l2.3677" class="difflineminus">-            GetSynthesizedType(bookmark, getter_AddRefs(nodeType));</span>
<a href="#l2.3678"></a><span id="l2.3678" class="difflineminus">-            if (nodeType == kNC_Bookmark) {</span>
<a href="#l2.3679"></a><span id="l2.3679" class="difflineminus">-                nsCOMPtr&lt;nsIRDFDate&gt; now;</span>
<a href="#l2.3680"></a><span id="l2.3680" class="difflineminus">-                rv = gRDF-&gt;GetDateLiteral(PR_Now(), getter_AddRefs(now));</span>
<a href="#l2.3681"></a><span id="l2.3681" class="difflineminus">-                if (NS_FAILED(rv))</span>
<a href="#l2.3682"></a><span id="l2.3682" class="difflineminus">-                    return rv;</span>
<a href="#l2.3683"></a><span id="l2.3683" class="difflineminus">-</span>
<a href="#l2.3684"></a><span id="l2.3684" class="difflineminus">-                nsCOMPtr&lt;nsIRDFNode&gt; lastMod;</span>
<a href="#l2.3685"></a><span id="l2.3685" class="difflineminus">-                rv = mInner-&gt;GetTarget(bookmark, kWEB_LastVisitDate, PR_TRUE,</span>
<a href="#l2.3686"></a><span id="l2.3686" class="difflineminus">-                                       getter_AddRefs(lastMod));</span>
<a href="#l2.3687"></a><span id="l2.3687" class="difflineminus">-                if (NS_FAILED(rv))</span>
<a href="#l2.3688"></a><span id="l2.3688" class="difflineminus">-                    return rv;</span>
<a href="#l2.3689"></a><span id="l2.3689" class="difflineminus">-</span>
<a href="#l2.3690"></a><span id="l2.3690" class="difflineminus">-                if (lastMod) {</span>
<a href="#l2.3691"></a><span id="l2.3691" class="difflineminus">-                    rv = mInner-&gt;Change(bookmark, kWEB_LastVisitDate, lastMod, now);</span>
<a href="#l2.3692"></a><span id="l2.3692" class="difflineminus">-                }</span>
<a href="#l2.3693"></a><span id="l2.3693" class="difflineminus">-                else {</span>
<a href="#l2.3694"></a><span id="l2.3694" class="difflineminus">-                    rv = mInner-&gt;Assert(bookmark, kWEB_LastVisitDate, now, PR_TRUE);</span>
<a href="#l2.3695"></a><span id="l2.3695" class="difflineminus">-                }</span>
<a href="#l2.3696"></a><span id="l2.3696" class="difflineminus">-                if (NS_FAILED(rv))</span>
<a href="#l2.3697"></a><span id="l2.3697" class="difflineminus">-                    return rv;</span>
<a href="#l2.3698"></a><span id="l2.3698" class="difflineminus">-</span>
<a href="#l2.3699"></a><span id="l2.3699" class="difflineminus">-                // Piggy-backing last charset.</span>
<a href="#l2.3700"></a><span id="l2.3700" class="difflineminus">-                if (aCharset &amp;&amp; *aCharset) {</span>
<a href="#l2.3701"></a><span id="l2.3701" class="difflineminus">-                    nsCOMPtr&lt;nsIRDFLiteral&gt; charsetliteral;</span>
<a href="#l2.3702"></a><span id="l2.3702" class="difflineminus">-                    rv = gRDF-&gt;GetLiteral(aCharset,</span>
<a href="#l2.3703"></a><span id="l2.3703" class="difflineminus">-                                          getter_AddRefs(charsetliteral));</span>
<a href="#l2.3704"></a><span id="l2.3704" class="difflineminus">-                    if (NS_FAILED(rv))</span>
<a href="#l2.3705"></a><span id="l2.3705" class="difflineminus">-                        return rv;</span>
<a href="#l2.3706"></a><span id="l2.3706" class="difflineminus">-</span>
<a href="#l2.3707"></a><span id="l2.3707" class="difflineminus">-                    nsCOMPtr&lt;nsIRDFNode&gt; charsetNode;</span>
<a href="#l2.3708"></a><span id="l2.3708" class="difflineminus">-                    rv = mInner-&gt;GetTarget(bookmark, kWEB_LastCharset, PR_TRUE,</span>
<a href="#l2.3709"></a><span id="l2.3709" class="difflineminus">-                                           getter_AddRefs(charsetNode));</span>
<a href="#l2.3710"></a><span id="l2.3710" class="difflineminus">-                    if (NS_FAILED(rv))</span>
<a href="#l2.3711"></a><span id="l2.3711" class="difflineminus">-                        return rv;</span>
<a href="#l2.3712"></a><span id="l2.3712" class="difflineminus">-</span>
<a href="#l2.3713"></a><span id="l2.3713" class="difflineminus">-                    if (charsetNode) {</span>
<a href="#l2.3714"></a><span id="l2.3714" class="difflineminus">-                        rv = mInner-&gt;Change(bookmark, kWEB_LastCharset,</span>
<a href="#l2.3715"></a><span id="l2.3715" class="difflineminus">-                                            charsetNode, charsetliteral);</span>
<a href="#l2.3716"></a><span id="l2.3716" class="difflineminus">-                    }</span>
<a href="#l2.3717"></a><span id="l2.3717" class="difflineminus">-                    else {</span>
<a href="#l2.3718"></a><span id="l2.3718" class="difflineminus">-                        rv = mInner-&gt;Assert(bookmark, kWEB_LastCharset,</span>
<a href="#l2.3719"></a><span id="l2.3719" class="difflineminus">-                                            charsetliteral, PR_TRUE);</span>
<a href="#l2.3720"></a><span id="l2.3720" class="difflineminus">-                    }</span>
<a href="#l2.3721"></a><span id="l2.3721" class="difflineminus">-                    if (NS_FAILED(rv))</span>
<a href="#l2.3722"></a><span id="l2.3722" class="difflineminus">-                        return rv;</span>
<a href="#l2.3723"></a><span id="l2.3723" class="difflineminus">-                } </span>
<a href="#l2.3724"></a><span id="l2.3724" class="difflineminus">-</span>
<a href="#l2.3725"></a><span id="l2.3725" class="difflineminus">-                // Also update bookmark's &quot;status&quot;!</span>
<a href="#l2.3726"></a><span id="l2.3726" class="difflineminus">-                nsCOMPtr&lt;nsIRDFNode&gt; statusNode;</span>
<a href="#l2.3727"></a><span id="l2.3727" class="difflineminus">-                rv = mInner-&gt;GetTarget(bookmark, kWEB_Status, PR_TRUE,</span>
<a href="#l2.3728"></a><span id="l2.3728" class="difflineminus">-                                       getter_AddRefs(statusNode));</span>
<a href="#l2.3729"></a><span id="l2.3729" class="difflineminus">-                if (NS_SUCCEEDED(rv) &amp;&amp; statusNode) {</span>
<a href="#l2.3730"></a><span id="l2.3730" class="difflineminus">-                    rv = mInner-&gt;Unassert(bookmark, kWEB_Status, statusNode);</span>
<a href="#l2.3731"></a><span id="l2.3731" class="difflineminus">-                    NS_ASSERTION(rv == NS_RDF_ASSERTION_ACCEPTED, &quot;unable to Unassert changed status&quot;);</span>
<a href="#l2.3732"></a><span id="l2.3732" class="difflineminus">-                }</span>
<a href="#l2.3733"></a><span id="l2.3733" class="difflineminus">-</span>
<a href="#l2.3734"></a><span id="l2.3734" class="difflineminus">-                mDirty = PR_TRUE;</span>
<a href="#l2.3735"></a><span id="l2.3735" class="difflineminus">-            }</span>
<a href="#l2.3736"></a><span id="l2.3736" class="difflineminus">-        }</span>
<a href="#l2.3737"></a><span id="l2.3737" class="difflineminus">-    }</span>
<a href="#l2.3738"></a><span id="l2.3738" class="difflineminus">-</span>
<a href="#l2.3739"></a><span id="l2.3739" class="difflineminus">-    return rv;</span>
<a href="#l2.3740"></a><span id="l2.3740" class="difflineminus">-}</span>
<a href="#l2.3741"></a><span id="l2.3741" class="difflineminus">-</span>
<a href="#l2.3742"></a><span id="l2.3742" class="difflineminus">-nsresult</span>
<a href="#l2.3743"></a><span id="l2.3743" class="difflineminus">-nsBookmarksService::GetSynthesizedType(nsIRDFResource *aNode, nsIRDFNode **aType)</span>
<a href="#l2.3744"></a><span id="l2.3744" class="difflineminus">-{</span>
<a href="#l2.3745"></a><span id="l2.3745" class="difflineminus">-    *aType = nsnull;</span>
<a href="#l2.3746"></a><span id="l2.3746" class="difflineminus">-    nsresult rv = mInner-&gt;GetTarget(aNode, kRDF_type, PR_TRUE, aType);</span>
<a href="#l2.3747"></a><span id="l2.3747" class="difflineminus">-    if (NS_FAILED(rv) || (rv == NS_RDF_NO_VALUE))</span>
<a href="#l2.3748"></a><span id="l2.3748" class="difflineminus">-    {</span>
<a href="#l2.3749"></a><span id="l2.3749" class="difflineminus">-        // if we didn't match anything in the graph, synthesize its type</span>
<a href="#l2.3750"></a><span id="l2.3750" class="difflineminus">-        // (which is either a bookmark or a bookmark folder, since everything</span>
<a href="#l2.3751"></a><span id="l2.3751" class="difflineminus">-        // else is annotated)</span>
<a href="#l2.3752"></a><span id="l2.3752" class="difflineminus">-        PRBool isContainer = PR_FALSE;</span>
<a href="#l2.3753"></a><span id="l2.3753" class="difflineminus">-        PRBool isBookmarkedFlag = PR_FALSE;</span>
<a href="#l2.3754"></a><span id="l2.3754" class="difflineminus">-        (void)gRDFC-&gt;IsSeq(mInner, aNode, &amp;isContainer);</span>
<a href="#l2.3755"></a><span id="l2.3755" class="difflineminus">-</span>
<a href="#l2.3756"></a><span id="l2.3756" class="difflineminus">-        if (isContainer)</span>
<a href="#l2.3757"></a><span id="l2.3757" class="difflineminus">-        {</span>
<a href="#l2.3758"></a><span id="l2.3758" class="difflineminus">-            *aType =  kNC_Folder;</span>
<a href="#l2.3759"></a><span id="l2.3759" class="difflineminus">-        }</span>
<a href="#l2.3760"></a><span id="l2.3760" class="difflineminus">-        else if (NS_SUCCEEDED(rv = IsBookmarkedResource(aNode,</span>
<a href="#l2.3761"></a><span id="l2.3761" class="difflineminus">-                                                        &amp;isBookmarkedFlag)) &amp;&amp; (isBookmarkedFlag == PR_TRUE))</span>
<a href="#l2.3762"></a><span id="l2.3762" class="difflineminus">-        {</span>
<a href="#l2.3763"></a><span id="l2.3763" class="difflineminus">-            *aType = kNC_Bookmark;</span>
<a href="#l2.3764"></a><span id="l2.3764" class="difflineminus">-        }</span>
<a href="#l2.3765"></a><span id="l2.3765" class="difflineminus">-#ifdef XP_BEOS</span>
<a href="#l2.3766"></a><span id="l2.3766" class="difflineminus">-        else</span>
<a href="#l2.3767"></a><span id="l2.3767" class="difflineminus">-        {</span>
<a href="#l2.3768"></a><span id="l2.3768" class="difflineminus">-            //solution for BeOS - bookmarks are stored as file attributes. </span>
<a href="#l2.3769"></a><span id="l2.3769" class="difflineminus">-            *aType = kNC_URL;</span>
<a href="#l2.3770"></a><span id="l2.3770" class="difflineminus">-        }</span>
<a href="#l2.3771"></a><span id="l2.3771" class="difflineminus">-#endif</span>
<a href="#l2.3772"></a><span id="l2.3772" class="difflineminus">-        NS_IF_ADDREF(*aType);</span>
<a href="#l2.3773"></a><span id="l2.3773" class="difflineminus">-    }</span>
<a href="#l2.3774"></a><span id="l2.3774" class="difflineminus">-    return NS_OK;</span>
<a href="#l2.3775"></a><span id="l2.3775" class="difflineminus">-}</span>
<a href="#l2.3776"></a><span id="l2.3776" class="difflineminus">-</span>
<a href="#l2.3777"></a><span id="l2.3777" class="difflineminus">-nsresult</span>
<a href="#l2.3778"></a><span id="l2.3778" class="difflineminus">-nsBookmarksService::UpdateBookmarkLastModifiedDate(nsIRDFResource *aSource)</span>
<a href="#l2.3779"></a><span id="l2.3779" class="difflineminus">-{</span>
<a href="#l2.3780"></a><span id="l2.3780" class="difflineminus">-    nsCOMPtr&lt;nsIRDFDate&gt;    now;</span>
<a href="#l2.3781"></a><span id="l2.3781" class="difflineminus">-    nsresult        rv;</span>
<a href="#l2.3782"></a><span id="l2.3782" class="difflineminus">-</span>
<a href="#l2.3783"></a><span id="l2.3783" class="difflineminus">-    if (NS_SUCCEEDED(rv = gRDF-&gt;GetDateLiteral(PR_Now(), getter_AddRefs(now))))</span>
<a href="#l2.3784"></a><span id="l2.3784" class="difflineminus">-    {</span>
<a href="#l2.3785"></a><span id="l2.3785" class="difflineminus">-        nsCOMPtr&lt;nsIRDFNode&gt;    lastMod;</span>
<a href="#l2.3786"></a><span id="l2.3786" class="difflineminus">-</span>
<a href="#l2.3787"></a><span id="l2.3787" class="difflineminus">-        // Note: always use mInner!! Otherwise, could get into an infinite loop</span>
<a href="#l2.3788"></a><span id="l2.3788" class="difflineminus">-        // due to Assert/Change calling UpdateBookmarkLastModifiedDate()</span>
<a href="#l2.3789"></a><span id="l2.3789" class="difflineminus">-</span>
<a href="#l2.3790"></a><span id="l2.3790" class="difflineminus">-        if (NS_SUCCEEDED(rv = mInner-&gt;GetTarget(aSource, kWEB_LastModifiedDate, PR_TRUE,</span>
<a href="#l2.3791"></a><span id="l2.3791" class="difflineminus">-            getter_AddRefs(lastMod))) &amp;&amp; (rv != NS_RDF_NO_VALUE))</span>
<a href="#l2.3792"></a><span id="l2.3792" class="difflineminus">-        {</span>
<a href="#l2.3793"></a><span id="l2.3793" class="difflineminus">-            rv = mInner-&gt;Change(aSource, kWEB_LastModifiedDate, lastMod, now);</span>
<a href="#l2.3794"></a><span id="l2.3794" class="difflineminus">-        }</span>
<a href="#l2.3795"></a><span id="l2.3795" class="difflineminus">-        else</span>
<a href="#l2.3796"></a><span id="l2.3796" class="difflineminus">-        {</span>
<a href="#l2.3797"></a><span id="l2.3797" class="difflineminus">-            rv = mInner-&gt;Assert(aSource, kWEB_LastModifiedDate, now, PR_TRUE);</span>
<a href="#l2.3798"></a><span id="l2.3798" class="difflineminus">-        }</span>
<a href="#l2.3799"></a><span id="l2.3799" class="difflineminus">-    }</span>
<a href="#l2.3800"></a><span id="l2.3800" class="difflineminus">-    return rv;</span>
<a href="#l2.3801"></a><span id="l2.3801" class="difflineminus">-}</span>
<a href="#l2.3802"></a><span id="l2.3802" class="difflineminus">-</span>
<a href="#l2.3803"></a><span id="l2.3803" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l2.3804"></a><span id="l2.3804" class="difflineminus">-nsBookmarksService::GetLastCharset(const nsACString &amp;aURL, nsAString &amp;aCharset)</span>
<a href="#l2.3805"></a><span id="l2.3805" class="difflineminus">-{</span>
<a href="#l2.3806"></a><span id="l2.3806" class="difflineminus">-    aCharset.Truncate(); </span>
<a href="#l2.3807"></a><span id="l2.3807" class="difflineminus">-</span>
<a href="#l2.3808"></a><span id="l2.3808" class="difflineminus">-    nsCOMPtr&lt;nsIRDFLiteral&gt; urlLiteral;</span>
<a href="#l2.3809"></a><span id="l2.3809" class="difflineminus">-    nsresult rv = gRDF-&gt;GetLiteral(NS_ConvertUTF8toUTF16(aURL).get(),</span>
<a href="#l2.3810"></a><span id="l2.3810" class="difflineminus">-                                   getter_AddRefs(urlLiteral));</span>
<a href="#l2.3811"></a><span id="l2.3811" class="difflineminus">-</span>
<a href="#l2.3812"></a><span id="l2.3812" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l2.3813"></a><span id="l2.3813" class="difflineminus">-        return rv;</span>
<a href="#l2.3814"></a><span id="l2.3814" class="difflineminus">-</span>
<a href="#l2.3815"></a><span id="l2.3815" class="difflineminus">-    nsCOMPtr&lt;nsIRDFResource&gt; bookmark;</span>
<a href="#l2.3816"></a><span id="l2.3816" class="difflineminus">-    rv = GetSource(kNC_URL, urlLiteral, PR_TRUE, getter_AddRefs(bookmark));</span>
<a href="#l2.3817"></a><span id="l2.3817" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l2.3818"></a><span id="l2.3818" class="difflineminus">-        return rv;</span>
<a href="#l2.3819"></a><span id="l2.3819" class="difflineminus">-</span>
<a href="#l2.3820"></a><span id="l2.3820" class="difflineminus">-    nsCOMPtr&lt;nsIRDFNode&gt; nodeType;</span>
<a href="#l2.3821"></a><span id="l2.3821" class="difflineminus">-    GetSynthesizedType(bookmark, getter_AddRefs(nodeType));</span>
<a href="#l2.3822"></a><span id="l2.3822" class="difflineminus">-    if (nodeType == kNC_Bookmark) {</span>
<a href="#l2.3823"></a><span id="l2.3823" class="difflineminus">-        nsCOMPtr&lt;nsIRDFNode&gt; charsetNode;</span>
<a href="#l2.3824"></a><span id="l2.3824" class="difflineminus">-        rv = GetTarget(bookmark, kWEB_LastCharset, PR_TRUE,</span>
<a href="#l2.3825"></a><span id="l2.3825" class="difflineminus">-                       getter_AddRefs(charsetNode));</span>
<a href="#l2.3826"></a><span id="l2.3826" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l2.3827"></a><span id="l2.3827" class="difflineminus">-            return rv;</span>
<a href="#l2.3828"></a><span id="l2.3828" class="difflineminus">-</span>
<a href="#l2.3829"></a><span id="l2.3829" class="difflineminus">-        if (charsetNode) {</span>
<a href="#l2.3830"></a><span id="l2.3830" class="difflineminus">-            nsCOMPtr&lt;nsIRDFLiteral&gt; charsetData(do_QueryInterface(charsetNode));</span>
<a href="#l2.3831"></a><span id="l2.3831" class="difflineminus">-            if (charsetData) {</span>
<a href="#l2.3832"></a><span id="l2.3832" class="difflineminus">-                const PRUnichar *charset;</span>
<a href="#l2.3833"></a><span id="l2.3833" class="difflineminus">-                charsetData-&gt;GetValueConst(&amp;charset);</span>
<a href="#l2.3834"></a><span id="l2.3834" class="difflineminus">-                aCharset.Assign(charset);</span>
<a href="#l2.3835"></a><span id="l2.3835" class="difflineminus">-            }</span>
<a href="#l2.3836"></a><span id="l2.3836" class="difflineminus">-        }</span>
<a href="#l2.3837"></a><span id="l2.3837" class="difflineminus">-    }</span>
<a href="#l2.3838"></a><span id="l2.3838" class="difflineminus">-</span>
<a href="#l2.3839"></a><span id="l2.3839" class="difflineminus">-    return NS_OK;</span>
<a href="#l2.3840"></a><span id="l2.3840" class="difflineminus">-}</span>
<a href="#l2.3841"></a><span id="l2.3841" class="difflineminus">-</span>
<a href="#l2.3842"></a><span id="l2.3842" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l2.3843"></a><span id="l2.3843" class="difflineminus">-nsBookmarksService::ResolveKeyword(const PRUnichar *aUserInput, char **aShortcutURL)</span>
<a href="#l2.3844"></a><span id="l2.3844" class="difflineminus">-{</span>
<a href="#l2.3845"></a><span id="l2.3845" class="difflineminus">-    NS_PRECONDITION(aUserInput != nsnull, &quot;null ptr&quot;);</span>
<a href="#l2.3846"></a><span id="l2.3846" class="difflineminus">-    if (! aUserInput)</span>
<a href="#l2.3847"></a><span id="l2.3847" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l2.3848"></a><span id="l2.3848" class="difflineminus">-</span>
<a href="#l2.3849"></a><span id="l2.3849" class="difflineminus">-    NS_PRECONDITION(aShortcutURL != nsnull, &quot;null ptr&quot;);</span>
<a href="#l2.3850"></a><span id="l2.3850" class="difflineminus">-    if (! aShortcutURL)</span>
<a href="#l2.3851"></a><span id="l2.3851" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l2.3852"></a><span id="l2.3852" class="difflineminus">-</span>
<a href="#l2.3853"></a><span id="l2.3853" class="difflineminus">-    // Shortcuts are always lowercased internally.</span>
<a href="#l2.3854"></a><span id="l2.3854" class="difflineminus">-    nsAutoString shortcut(aUserInput);</span>
<a href="#l2.3855"></a><span id="l2.3855" class="difflineminus">-    ToLowerCase(shortcut);</span>
<a href="#l2.3856"></a><span id="l2.3856" class="difflineminus">-</span>
<a href="#l2.3857"></a><span id="l2.3857" class="difflineminus">-    nsCOMPtr&lt;nsIRDFLiteral&gt; shortcutLiteral;</span>
<a href="#l2.3858"></a><span id="l2.3858" class="difflineminus">-    nsresult rv = gRDF-&gt;GetLiteral(shortcut.get(),</span>
<a href="#l2.3859"></a><span id="l2.3859" class="difflineminus">-                                   getter_AddRefs(shortcutLiteral));</span>
<a href="#l2.3860"></a><span id="l2.3860" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l2.3861"></a><span id="l2.3861" class="difflineminus">-        return rv;</span>
<a href="#l2.3862"></a><span id="l2.3862" class="difflineminus">-</span>
<a href="#l2.3863"></a><span id="l2.3863" class="difflineminus">-    nsCOMPtr&lt;nsIRDFResource&gt; source;</span>
<a href="#l2.3864"></a><span id="l2.3864" class="difflineminus">-    rv = GetSource(kNC_ShortcutURL, shortcutLiteral, PR_TRUE,</span>
<a href="#l2.3865"></a><span id="l2.3865" class="difflineminus">-                   getter_AddRefs(source));</span>
<a href="#l2.3866"></a><span id="l2.3866" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l2.3867"></a><span id="l2.3867" class="difflineminus">-        return rv;</span>
<a href="#l2.3868"></a><span id="l2.3868" class="difflineminus">-</span>
<a href="#l2.3869"></a><span id="l2.3869" class="difflineminus">-    if (source) {</span>
<a href="#l2.3870"></a><span id="l2.3870" class="difflineminus">-        nsAutoString url;</span>
<a href="#l2.3871"></a><span id="l2.3871" class="difflineminus">-        rv = GetURLFromResource(source, url);</span>
<a href="#l2.3872"></a><span id="l2.3872" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l2.3873"></a><span id="l2.3873" class="difflineminus">-           return rv;</span>
<a href="#l2.3874"></a><span id="l2.3874" class="difflineminus">-</span>
<a href="#l2.3875"></a><span id="l2.3875" class="difflineminus">-        if (!url.IsEmpty()) {</span>
<a href="#l2.3876"></a><span id="l2.3876" class="difflineminus">-            *aShortcutURL = ToNewUTF8String(url);</span>
<a href="#l2.3877"></a><span id="l2.3877" class="difflineminus">-            return NS_OK;</span>
<a href="#l2.3878"></a><span id="l2.3878" class="difflineminus">-        }</span>
<a href="#l2.3879"></a><span id="l2.3879" class="difflineminus">-    }</span>
<a href="#l2.3880"></a><span id="l2.3880" class="difflineminus">-</span>
<a href="#l2.3881"></a><span id="l2.3881" class="difflineminus">-    *aShortcutURL = nsnull;</span>
<a href="#l2.3882"></a><span id="l2.3882" class="difflineminus">-    return NS_RDF_NO_VALUE;</span>
<a href="#l2.3883"></a><span id="l2.3883" class="difflineminus">-}</span>
<a href="#l2.3884"></a><span id="l2.3884" class="difflineminus">-</span>
<a href="#l2.3885"></a><span id="l2.3885" class="difflineminus">-#ifdef XP_WIN</span>
<a href="#l2.3886"></a><span id="l2.3886" class="difflineminus">-// Determines the URL for a shortcut file </span>
<a href="#l2.3887"></a><span id="l2.3887" class="difflineminus">-static void ResolveShortcut(nsIFile* aFile, nsACString&amp; aURI)</span>
<a href="#l2.3888"></a><span id="l2.3888" class="difflineminus">-{</span>
<a href="#l2.3889"></a><span id="l2.3889" class="difflineminus">-    nsCOMPtr&lt;nsIFileProtocolHandler&gt; fph;</span>
<a href="#l2.3890"></a><span id="l2.3890" class="difflineminus">-    nsresult rv = NS_GetFileProtocolHandler(getter_AddRefs(fph));</span>
<a href="#l2.3891"></a><span id="l2.3891" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l2.3892"></a><span id="l2.3892" class="difflineminus">-        return;</span>
<a href="#l2.3893"></a><span id="l2.3893" class="difflineminus">-</span>
<a href="#l2.3894"></a><span id="l2.3894" class="difflineminus">-    nsCOMPtr&lt;nsIURI&gt; uri;</span>
<a href="#l2.3895"></a><span id="l2.3895" class="difflineminus">-    rv = fph-&gt;ReadURLFile(aFile, getter_AddRefs(uri));</span>
<a href="#l2.3896"></a><span id="l2.3896" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l2.3897"></a><span id="l2.3897" class="difflineminus">-        return;</span>
<a href="#l2.3898"></a><span id="l2.3898" class="difflineminus">-</span>
<a href="#l2.3899"></a><span id="l2.3899" class="difflineminus">-    uri-&gt;GetSpec(aURI);</span>
<a href="#l2.3900"></a><span id="l2.3900" class="difflineminus">-} </span>
<a href="#l2.3901"></a><span id="l2.3901" class="difflineminus">-</span>
<a href="#l2.3902"></a><span id="l2.3902" class="difflineminus">-nsresult</span>
<a href="#l2.3903"></a><span id="l2.3903" class="difflineminus">-nsBookmarksService::ParseFavoritesFolder(nsIFile* aDirectory, nsIRDFResource* aParentResource)</span>
<a href="#l2.3904"></a><span id="l2.3904" class="difflineminus">-{</span>
<a href="#l2.3905"></a><span id="l2.3905" class="difflineminus">-    nsresult rv;</span>
<a href="#l2.3906"></a><span id="l2.3906" class="difflineminus">-</span>
<a href="#l2.3907"></a><span id="l2.3907" class="difflineminus">-    nsCOMPtr&lt;nsISimpleEnumerator&gt; entries;</span>
<a href="#l2.3908"></a><span id="l2.3908" class="difflineminus">-    rv = aDirectory-&gt;GetDirectoryEntries(getter_AddRefs(entries));</span>
<a href="#l2.3909"></a><span id="l2.3909" class="difflineminus">-    if (NS_FAILED(rv)) </span>
<a href="#l2.3910"></a><span id="l2.3910" class="difflineminus">-        return rv;</span>
<a href="#l2.3911"></a><span id="l2.3911" class="difflineminus">-</span>
<a href="#l2.3912"></a><span id="l2.3912" class="difflineminus">-    do</span>
<a href="#l2.3913"></a><span id="l2.3913" class="difflineminus">-    {</span>
<a href="#l2.3914"></a><span id="l2.3914" class="difflineminus">-        PRBool hasMore = PR_FALSE;</span>
<a href="#l2.3915"></a><span id="l2.3915" class="difflineminus">-        rv = entries-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l2.3916"></a><span id="l2.3916" class="difflineminus">-        if (NS_FAILED(rv) || !hasMore) </span>
<a href="#l2.3917"></a><span id="l2.3917" class="difflineminus">-            break;</span>
<a href="#l2.3918"></a><span id="l2.3918" class="difflineminus">-</span>
<a href="#l2.3919"></a><span id="l2.3919" class="difflineminus">-        nsCOMPtr&lt;nsISupports&gt; supp;</span>
<a href="#l2.3920"></a><span id="l2.3920" class="difflineminus">-        rv = entries-&gt;GetNext(getter_AddRefs(supp));</span>
<a href="#l2.3921"></a><span id="l2.3921" class="difflineminus">-        if (NS_FAILED(rv)) </span>
<a href="#l2.3922"></a><span id="l2.3922" class="difflineminus">-            break;</span>
<a href="#l2.3923"></a><span id="l2.3923" class="difflineminus">-</span>
<a href="#l2.3924"></a><span id="l2.3924" class="difflineminus">-        nsCOMPtr&lt;nsIFile&gt; currFile(do_QueryInterface(supp));</span>
<a href="#l2.3925"></a><span id="l2.3925" class="difflineminus">-    </span>
<a href="#l2.3926"></a><span id="l2.3926" class="difflineminus">-        nsCOMPtr&lt;nsIURI&gt; uri;</span>
<a href="#l2.3927"></a><span id="l2.3927" class="difflineminus">-        rv = NS_NewFileURI(getter_AddRefs(uri), currFile);</span>
<a href="#l2.3928"></a><span id="l2.3928" class="difflineminus">-        if (NS_FAILED(rv)) </span>
<a href="#l2.3929"></a><span id="l2.3929" class="difflineminus">-            break;</span>
<a href="#l2.3930"></a><span id="l2.3930" class="difflineminus">-</span>
<a href="#l2.3931"></a><span id="l2.3931" class="difflineminus">-        nsAutoString bookmarkName;</span>
<a href="#l2.3932"></a><span id="l2.3932" class="difflineminus">-        currFile-&gt;GetLeafName(bookmarkName);</span>
<a href="#l2.3933"></a><span id="l2.3933" class="difflineminus">-</span>
<a href="#l2.3934"></a><span id="l2.3934" class="difflineminus">-        PRBool isSymlink = PR_FALSE;</span>
<a href="#l2.3935"></a><span id="l2.3935" class="difflineminus">-        PRBool isDir = PR_FALSE;</span>
<a href="#l2.3936"></a><span id="l2.3936" class="difflineminus">-</span>
<a href="#l2.3937"></a><span id="l2.3937" class="difflineminus">-        currFile-&gt;IsSymlink(&amp;isSymlink);</span>
<a href="#l2.3938"></a><span id="l2.3938" class="difflineminus">-        currFile-&gt;IsDirectory(&amp;isDir);</span>
<a href="#l2.3939"></a><span id="l2.3939" class="difflineminus">-</span>
<a href="#l2.3940"></a><span id="l2.3940" class="difflineminus">-        if (isSymlink)</span>
<a href="#l2.3941"></a><span id="l2.3941" class="difflineminus">-        {</span>
<a href="#l2.3942"></a><span id="l2.3942" class="difflineminus">-            // It's a .lnk file.  Get the native path and check to see if it's</span>
<a href="#l2.3943"></a><span id="l2.3943" class="difflineminus">-            // a dir.  If so, create a bookmark for the dir.  If not, then</span>
<a href="#l2.3944"></a><span id="l2.3944" class="difflineminus">-            // simply do nothing and continue.</span>
<a href="#l2.3945"></a><span id="l2.3945" class="difflineminus">-</span>
<a href="#l2.3946"></a><span id="l2.3946" class="difflineminus">-            // Get the native path that the .lnk file is pointing to.</span>
<a href="#l2.3947"></a><span id="l2.3947" class="difflineminus">-            nsCAutoString path;</span>
<a href="#l2.3948"></a><span id="l2.3948" class="difflineminus">-            rv = currFile-&gt;GetNativeTarget(path);</span>
<a href="#l2.3949"></a><span id="l2.3949" class="difflineminus">-            if (NS_FAILED(rv)) </span>
<a href="#l2.3950"></a><span id="l2.3950" class="difflineminus">-                continue;</span>
<a href="#l2.3951"></a><span id="l2.3951" class="difflineminus">-</span>
<a href="#l2.3952"></a><span id="l2.3952" class="difflineminus">-            nsCOMPtr&lt;nsILocalFile&gt; localFile;</span>
<a href="#l2.3953"></a><span id="l2.3953" class="difflineminus">-            rv = NS_NewNativeLocalFile(path, PR_TRUE, getter_AddRefs(localFile));</span>
<a href="#l2.3954"></a><span id="l2.3954" class="difflineminus">-            if (NS_FAILED(rv)) </span>
<a href="#l2.3955"></a><span id="l2.3955" class="difflineminus">-                continue;</span>
<a href="#l2.3956"></a><span id="l2.3956" class="difflineminus">-</span>
<a href="#l2.3957"></a><span id="l2.3957" class="difflineminus">-            // Check for dir here.  If path is not a dir, just continue with</span>
<a href="#l2.3958"></a><span id="l2.3958" class="difflineminus">-            // next import.</span>
<a href="#l2.3959"></a><span id="l2.3959" class="difflineminus">-            rv = localFile-&gt;IsDirectory(&amp;isDir);</span>
<a href="#l2.3960"></a><span id="l2.3960" class="difflineminus">-            NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.3961"></a><span id="l2.3961" class="difflineminus">-            if (!isDir)</span>
<a href="#l2.3962"></a><span id="l2.3962" class="difflineminus">-                continue;</span>
<a href="#l2.3963"></a><span id="l2.3963" class="difflineminus">-</span>
<a href="#l2.3964"></a><span id="l2.3964" class="difflineminus">-            nsCAutoString spec;</span>
<a href="#l2.3965"></a><span id="l2.3965" class="difflineminus">-            nsCOMPtr&lt;nsIFile&gt; filePath(localFile);</span>
<a href="#l2.3966"></a><span id="l2.3966" class="difflineminus">-            // Get the file url format (file:///...) of the native file path.</span>
<a href="#l2.3967"></a><span id="l2.3967" class="difflineminus">-            rv = NS_GetURLSpecFromFile(filePath, spec);</span>
<a href="#l2.3968"></a><span id="l2.3968" class="difflineminus">-            if (NS_FAILED(rv)) </span>
<a href="#l2.3969"></a><span id="l2.3969" class="difflineminus">-                continue;</span>
<a href="#l2.3970"></a><span id="l2.3970" class="difflineminus">-</span>
<a href="#l2.3971"></a><span id="l2.3971" class="difflineminus">-            // Look for and strip out the .lnk extension.</span>
<a href="#l2.3972"></a><span id="l2.3972" class="difflineminus">-            NS_NAMED_LITERAL_STRING(lnkExt, &quot;.lnk&quot;);</span>
<a href="#l2.3973"></a><span id="l2.3973" class="difflineminus">-            PRInt32 lnkExtStart = bookmarkName.Length() - lnkExt.Length();</span>
<a href="#l2.3974"></a><span id="l2.3974" class="difflineminus">-            if (StringEndsWith(bookmarkName, lnkExt,</span>
<a href="#l2.3975"></a><span id="l2.3975" class="difflineminus">-                  CaseInsensitiveCompare))</span>
<a href="#l2.3976"></a><span id="l2.3976" class="difflineminus">-                bookmarkName.SetLength(lnkExtStart);</span>
<a href="#l2.3977"></a><span id="l2.3977" class="difflineminus">-</span>
<a href="#l2.3978"></a><span id="l2.3978" class="difflineminus">-            nsCOMPtr&lt;nsIRDFResource&gt; bookmark;</span>
<a href="#l2.3979"></a><span id="l2.3979" class="difflineminus">-            // NS_GetURLSpecFromFile on Windows returns url-escaped URL in </span>
<a href="#l2.3980"></a><span id="l2.3980" class="difflineminus">-            // pure ASCII. However, in the future, we may return 'hostpart'</span>
<a href="#l2.3981"></a><span id="l2.3981" class="difflineminus">-            // of a remote file in UTF-8. Therefore, using UTF-8 in place of</span>
<a href="#l2.3982"></a><span id="l2.3982" class="difflineminus">-            // ASCII is not a bad idea.</span>
<a href="#l2.3983"></a><span id="l2.3983" class="difflineminus">-            CreateBookmarkInContainer(bookmarkName.get(),</span>
<a href="#l2.3984"></a><span id="l2.3984" class="difflineminus">-                                      NS_ConvertUTF8toUTF16(spec).get(),</span>
<a href="#l2.3985"></a><span id="l2.3985" class="difflineminus">-                                      nsnull, nsnull, nsnull, aParentResource,</span>
<a href="#l2.3986"></a><span id="l2.3986" class="difflineminus">-                                      -1, getter_AddRefs(bookmark));</span>
<a href="#l2.3987"></a><span id="l2.3987" class="difflineminus">-            if (NS_FAILED(rv)) </span>
<a href="#l2.3988"></a><span id="l2.3988" class="difflineminus">-                continue;</span>
<a href="#l2.3989"></a><span id="l2.3989" class="difflineminus">-        }</span>
<a href="#l2.3990"></a><span id="l2.3990" class="difflineminus">-        else if (isDir)</span>
<a href="#l2.3991"></a><span id="l2.3991" class="difflineminus">-        {</span>
<a href="#l2.3992"></a><span id="l2.3992" class="difflineminus">-            nsCOMPtr&lt;nsIRDFResource&gt; folder;</span>
<a href="#l2.3993"></a><span id="l2.3993" class="difflineminus">-            rv = CreateFolderInContainer(bookmarkName.get(), aParentResource, -1, getter_AddRefs(folder));</span>
<a href="#l2.3994"></a><span id="l2.3994" class="difflineminus">-            if (NS_FAILED(rv)) </span>
<a href="#l2.3995"></a><span id="l2.3995" class="difflineminus">-                continue;</span>
<a href="#l2.3996"></a><span id="l2.3996" class="difflineminus">-</span>
<a href="#l2.3997"></a><span id="l2.3997" class="difflineminus">-            rv = ParseFavoritesFolder(currFile, folder);</span>
<a href="#l2.3998"></a><span id="l2.3998" class="difflineminus">-            if (NS_FAILED(rv)) </span>
<a href="#l2.3999"></a><span id="l2.3999" class="difflineminus">-                continue;</span>
<a href="#l2.4000"></a><span id="l2.4000" class="difflineminus">-        }</span>
<a href="#l2.4001"></a><span id="l2.4001" class="difflineminus">-        else</span>
<a href="#l2.4002"></a><span id="l2.4002" class="difflineminus">-        {</span>
<a href="#l2.4003"></a><span id="l2.4003" class="difflineminus">-            nsCOMPtr&lt;nsIURL&gt; url(do_QueryInterface(uri));</span>
<a href="#l2.4004"></a><span id="l2.4004" class="difflineminus">-            nsCAutoString extension;</span>
<a href="#l2.4005"></a><span id="l2.4005" class="difflineminus">-</span>
<a href="#l2.4006"></a><span id="l2.4006" class="difflineminus">-            url-&gt;GetFileExtension(extension);</span>
<a href="#l2.4007"></a><span id="l2.4007" class="difflineminus">-            if (!extension.Equals(NS_LITERAL_CSTRING(&quot;url&quot;), CaseInsensitiveCompare))</span>
<a href="#l2.4008"></a><span id="l2.4008" class="difflineminus">-                continue;</span>
<a href="#l2.4009"></a><span id="l2.4009" class="difflineminus">-</span>
<a href="#l2.4010"></a><span id="l2.4010" class="difflineminus">-            nsAutoString name(Substring(bookmarkName, 0, </span>
<a href="#l2.4011"></a><span id="l2.4011" class="difflineminus">-                                        bookmarkName.Length() - extension.Length() - 1));</span>
<a href="#l2.4012"></a><span id="l2.4012" class="difflineminus">-     </span>
<a href="#l2.4013"></a><span id="l2.4013" class="difflineminus">-</span>
<a href="#l2.4014"></a><span id="l2.4014" class="difflineminus">-            nsCAutoString resolvedURL;</span>
<a href="#l2.4015"></a><span id="l2.4015" class="difflineminus">-            ResolveShortcut(currFile, resolvedURL);</span>
<a href="#l2.4016"></a><span id="l2.4016" class="difflineminus">-</span>
<a href="#l2.4017"></a><span id="l2.4017" class="difflineminus">-            nsCOMPtr&lt;nsIRDFResource&gt; bookmark;</span>
<a href="#l2.4018"></a><span id="l2.4018" class="difflineminus">-            // ResolveShortcut gives us a UTF8 string (uri-&gt;GetSpec)</span>
<a href="#l2.4019"></a><span id="l2.4019" class="difflineminus">-            rv = CreateBookmarkInContainer(name.get(),</span>
<a href="#l2.4020"></a><span id="l2.4020" class="difflineminus">-                 NS_ConvertUTF8toUTF16(resolvedURL).get(),</span>
<a href="#l2.4021"></a><span id="l2.4021" class="difflineminus">-                 nsnull, nsnull, nsnull, aParentResource, -1,</span>
<a href="#l2.4022"></a><span id="l2.4022" class="difflineminus">-                 getter_AddRefs(bookmark));</span>
<a href="#l2.4023"></a><span id="l2.4023" class="difflineminus">-            if (NS_FAILED(rv)) </span>
<a href="#l2.4024"></a><span id="l2.4024" class="difflineminus">-                continue;</span>
<a href="#l2.4025"></a><span id="l2.4025" class="difflineminus">-        }</span>
<a href="#l2.4026"></a><span id="l2.4026" class="difflineminus">-    }</span>
<a href="#l2.4027"></a><span id="l2.4027" class="difflineminus">-    while (1);</span>
<a href="#l2.4028"></a><span id="l2.4028" class="difflineminus">-</span>
<a href="#l2.4029"></a><span id="l2.4029" class="difflineminus">-    return rv;</span>
<a href="#l2.4030"></a><span id="l2.4030" class="difflineminus">-}</span>
<a href="#l2.4031"></a><span id="l2.4031" class="difflineminus">-#endif</span>
<a href="#l2.4032"></a><span id="l2.4032" class="difflineminus">-</span>
<a href="#l2.4033"></a><span id="l2.4033" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l2.4034"></a><span id="l2.4034" class="difflineminus">-nsBookmarksService::ImportSystemBookmarks(nsIRDFResource* aParentFolder)</span>
<a href="#l2.4035"></a><span id="l2.4035" class="difflineminus">-{</span>
<a href="#l2.4036"></a><span id="l2.4036" class="difflineminus">-    gImportedSystemBookmarks = PR_TRUE;</span>
<a href="#l2.4037"></a><span id="l2.4037" class="difflineminus">-</span>
<a href="#l2.4038"></a><span id="l2.4038" class="difflineminus">-#ifdef XP_WIN</span>
<a href="#l2.4039"></a><span id="l2.4039" class="difflineminus">-    nsresult rv;</span>
<a href="#l2.4040"></a><span id="l2.4040" class="difflineminus">-</span>
<a href="#l2.4041"></a><span id="l2.4041" class="difflineminus">-    nsCOMPtr&lt;nsIProperties&gt; fileLocator(do_GetService(&quot;@mozilla.org/file/directory_service;1&quot;, &amp;rv));</span>
<a href="#l2.4042"></a><span id="l2.4042" class="difflineminus">-    if (NS_FAILED(rv)) </span>
<a href="#l2.4043"></a><span id="l2.4043" class="difflineminus">-        return rv;</span>
<a href="#l2.4044"></a><span id="l2.4044" class="difflineminus">-</span>
<a href="#l2.4045"></a><span id="l2.4045" class="difflineminus">-    nsCOMPtr&lt;nsIFile&gt; favoritesDirectory;</span>
<a href="#l2.4046"></a><span id="l2.4046" class="difflineminus">-    fileLocator-&gt;Get(NS_WIN_FAVORITES_DIR, NS_GET_IID(nsIFile),</span>
<a href="#l2.4047"></a><span id="l2.4047" class="difflineminus">-                     getter_AddRefs(favoritesDirectory));</span>
<a href="#l2.4048"></a><span id="l2.4048" class="difflineminus">-</span>
<a href="#l2.4049"></a><span id="l2.4049" class="difflineminus">-    // If |favoritesDirectory| is null, it means that we're on a Windows </span>
<a href="#l2.4050"></a><span id="l2.4050" class="difflineminus">-    // platform that does not have a Favorites folder, e.g. Windows 95 </span>
<a href="#l2.4051"></a><span id="l2.4051" class="difflineminus">-    // (early SRs, before IE integrated with the shell). Only try to </span>
<a href="#l2.4052"></a><span id="l2.4052" class="difflineminus">-    // read Favorites folder if it exists on the machine. </span>
<a href="#l2.4053"></a><span id="l2.4053" class="difflineminus">-    if (favoritesDirectory) </span>
<a href="#l2.4054"></a><span id="l2.4054" class="difflineminus">-        return ParseFavoritesFolder(favoritesDirectory, aParentFolder);</span>
<a href="#l2.4055"></a><span id="l2.4055" class="difflineminus">-#endif</span>
<a href="#l2.4056"></a><span id="l2.4056" class="difflineminus">-</span>
<a href="#l2.4057"></a><span id="l2.4057" class="difflineminus">-    return NS_OK;</span>
<a href="#l2.4058"></a><span id="l2.4058" class="difflineminus">-}</span>
<a href="#l2.4059"></a><span id="l2.4059" class="difflineminus">-</span>
<a href="#l2.4060"></a><span id="l2.4060" class="difflineminus">-#ifdef XP_WIN</span>
<a href="#l2.4061"></a><span id="l2.4061" class="difflineminus">-void</span>
<a href="#l2.4062"></a><span id="l2.4062" class="difflineminus">-nsBookmarksService::HandleSystemBookmarks(nsIRDFNode* aNode) </span>
<a href="#l2.4063"></a><span id="l2.4063" class="difflineminus">-{</span>
<a href="#l2.4064"></a><span id="l2.4064" class="difflineminus">-    if (!gImportedSystemBookmarks &amp;&amp; aNode == kNC_SystemBookmarksStaticRoot)</span>
<a href="#l2.4065"></a><span id="l2.4065" class="difflineminus">-    {</span>
<a href="#l2.4066"></a><span id="l2.4066" class="difflineminus">-        PRBool isSeq = PR_TRUE;</span>
<a href="#l2.4067"></a><span id="l2.4067" class="difflineminus">-        gRDFC-&gt;IsSeq(mInner, kNC_SystemBookmarksStaticRoot, &amp;isSeq);</span>
<a href="#l2.4068"></a><span id="l2.4068" class="difflineminus">-    </span>
<a href="#l2.4069"></a><span id="l2.4069" class="difflineminus">-        if (!isSeq)</span>
<a href="#l2.4070"></a><span id="l2.4070" class="difflineminus">-        {</span>
<a href="#l2.4071"></a><span id="l2.4071" class="difflineminus">-            nsCOMPtr&lt;nsIRDFContainer&gt; ctr;</span>
<a href="#l2.4072"></a><span id="l2.4072" class="difflineminus">-            gRDFC-&gt;MakeSeq(mInner, kNC_SystemBookmarksStaticRoot, getter_AddRefs(ctr));</span>
<a href="#l2.4073"></a><span id="l2.4073" class="difflineminus">-      </span>
<a href="#l2.4074"></a><span id="l2.4074" class="difflineminus">-            ImportSystemBookmarks(kNC_SystemBookmarksStaticRoot);</span>
<a href="#l2.4075"></a><span id="l2.4075" class="difflineminus">-        }</span>
<a href="#l2.4076"></a><span id="l2.4076" class="difflineminus">-    }</span>
<a href="#l2.4077"></a><span id="l2.4077" class="difflineminus">-}</span>
<a href="#l2.4078"></a><span id="l2.4078" class="difflineminus">-#endif</span>
<a href="#l2.4079"></a><span id="l2.4079" class="difflineminus">-</span>
<a href="#l2.4080"></a><span id="l2.4080" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l2.4081"></a><span id="l2.4081" class="difflineminus">-nsBookmarksService::GetTransactionManager(nsITransactionManager** aTransactionManager)</span>
<a href="#l2.4082"></a><span id="l2.4082" class="difflineminus">-{</span>
<a href="#l2.4083"></a><span id="l2.4083" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aTransactionManager);</span>
<a href="#l2.4084"></a><span id="l2.4084" class="difflineminus">-</span>
<a href="#l2.4085"></a><span id="l2.4085" class="difflineminus">-    NS_ADDREF(*aTransactionManager = mTransactionManager);</span>
<a href="#l2.4086"></a><span id="l2.4086" class="difflineminus">-</span>
<a href="#l2.4087"></a><span id="l2.4087" class="difflineminus">-    return NS_OK;</span>
<a href="#l2.4088"></a><span id="l2.4088" class="difflineminus">-}</span>
<a href="#l2.4089"></a><span id="l2.4089" class="difflineminus">-</span>
<a href="#l2.4090"></a><span id="l2.4090" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l2.4091"></a><span id="l2.4091" class="difflineminus">-nsBookmarksService::CreateTransaction(nsIRDFResource* aParent,</span>
<a href="#l2.4092"></a><span id="l2.4092" class="difflineminus">-                                      nsIRDFNode* aItem,</span>
<a href="#l2.4093"></a><span id="l2.4093" class="difflineminus">-                                      PRUint32 aIndex,</span>
<a href="#l2.4094"></a><span id="l2.4094" class="difflineminus">-                                      PRBool aRemove,</span>
<a href="#l2.4095"></a><span id="l2.4095" class="difflineminus">-                                      nsITransaction** aTransaction)</span>
<a href="#l2.4096"></a><span id="l2.4096" class="difflineminus">-{</span>
<a href="#l2.4097"></a><span id="l2.4097" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aTransaction);</span>
<a href="#l2.4098"></a><span id="l2.4098" class="difflineminus">-  NS_ENSURE_ARG(aItem);</span>
<a href="#l2.4099"></a><span id="l2.4099" class="difflineminus">-  *aTransaction = new BookmarkTransaction(this, aParent, aItem, aIndex, aRemove);</span>
<a href="#l2.4100"></a><span id="l2.4100" class="difflineminus">-  if (!*aTransaction)</span>
<a href="#l2.4101"></a><span id="l2.4101" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l2.4102"></a><span id="l2.4102" class="difflineminus">-</span>
<a href="#l2.4103"></a><span id="l2.4103" class="difflineminus">-  NS_ADDREF(*aTransaction);</span>
<a href="#l2.4104"></a><span id="l2.4104" class="difflineminus">-  return NS_OK;</span>
<a href="#l2.4105"></a><span id="l2.4105" class="difflineminus">-}</span>
<a href="#l2.4106"></a><span id="l2.4106" class="difflineminus">-</span>
<a href="#l2.4107"></a><span id="l2.4107" class="difflineminus">-////////////////////////////////////////////////////////////////////////</span>
<a href="#l2.4108"></a><span id="l2.4108" class="difflineminus">-// nsIRDFDataSource</span>
<a href="#l2.4109"></a><span id="l2.4109" class="difflineminus">-</span>
<a href="#l2.4110"></a><span id="l2.4110" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l2.4111"></a><span id="l2.4111" class="difflineminus">-nsBookmarksService::GetURI(char* *aURI)</span>
<a href="#l2.4112"></a><span id="l2.4112" class="difflineminus">-{</span>
<a href="#l2.4113"></a><span id="l2.4113" class="difflineminus">-    *aURI = NS_strdup(&quot;rdf:bookmarks&quot;);</span>
<a href="#l2.4114"></a><span id="l2.4114" class="difflineminus">-    if (! *aURI)</span>
<a href="#l2.4115"></a><span id="l2.4115" class="difflineminus">-        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l2.4116"></a><span id="l2.4116" class="difflineminus">-</span>
<a href="#l2.4117"></a><span id="l2.4117" class="difflineminus">-    return NS_OK;</span>
<a href="#l2.4118"></a><span id="l2.4118" class="difflineminus">-}</span>
<a href="#l2.4119"></a><span id="l2.4119" class="difflineminus">-</span>
<a href="#l2.4120"></a><span id="l2.4120" class="difflineminus">-static PRBool</span>
<a href="#l2.4121"></a><span id="l2.4121" class="difflineminus">-isBookmarkCommand(nsIRDFResource *r)</span>
<a href="#l2.4122"></a><span id="l2.4122" class="difflineminus">-{</span>
<a href="#l2.4123"></a><span id="l2.4123" class="difflineminus">-    PRBool      isBookmarkCommandFlag = PR_FALSE;</span>
<a href="#l2.4124"></a><span id="l2.4124" class="difflineminus">-    const char  *uri = nsnull;</span>
<a href="#l2.4125"></a><span id="l2.4125" class="difflineminus">-    </span>
<a href="#l2.4126"></a><span id="l2.4126" class="difflineminus">-    if (NS_SUCCEEDED(r-&gt;GetValueConst( &amp;uri )) &amp;&amp; (uri))</span>
<a href="#l2.4127"></a><span id="l2.4127" class="difflineminus">-    {</span>
<a href="#l2.4128"></a><span id="l2.4128" class="difflineminus">-        if (!strncmp(uri, kBookmarkCommand, sizeof(kBookmarkCommand) - 1))</span>
<a href="#l2.4129"></a><span id="l2.4129" class="difflineminus">-        {</span>
<a href="#l2.4130"></a><span id="l2.4130" class="difflineminus">-            isBookmarkCommandFlag = PR_TRUE;</span>
<a href="#l2.4131"></a><span id="l2.4131" class="difflineminus">-        }</span>
<a href="#l2.4132"></a><span id="l2.4132" class="difflineminus">-    }</span>
<a href="#l2.4133"></a><span id="l2.4133" class="difflineminus">-    return isBookmarkCommandFlag;</span>
<a href="#l2.4134"></a><span id="l2.4134" class="difflineminus">-}</span>
<a href="#l2.4135"></a><span id="l2.4135" class="difflineminus">-</span>
<a href="#l2.4136"></a><span id="l2.4136" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l2.4137"></a><span id="l2.4137" class="difflineminus">-nsBookmarksService::GetTarget(nsIRDFResource* aSource,</span>
<a href="#l2.4138"></a><span id="l2.4138" class="difflineminus">-                              nsIRDFResource* aProperty,</span>
<a href="#l2.4139"></a><span id="l2.4139" class="difflineminus">-                              PRBool aTruthValue,</span>
<a href="#l2.4140"></a><span id="l2.4140" class="difflineminus">-                              nsIRDFNode** aTarget)</span>
<a href="#l2.4141"></a><span id="l2.4141" class="difflineminus">-{</span>
<a href="#l2.4142"></a><span id="l2.4142" class="difflineminus">-    *aTarget = nsnull;</span>
<a href="#l2.4143"></a><span id="l2.4143" class="difflineminus">-</span>
<a href="#l2.4144"></a><span id="l2.4144" class="difflineminus">-    nsresult    rv;</span>
<a href="#l2.4145"></a><span id="l2.4145" class="difflineminus">-</span>
<a href="#l2.4146"></a><span id="l2.4146" class="difflineminus">-    if (aTruthValue &amp;&amp; (aProperty == kRDF_type))</span>
<a href="#l2.4147"></a><span id="l2.4147" class="difflineminus">-    {</span>
<a href="#l2.4148"></a><span id="l2.4148" class="difflineminus">-        rv = GetSynthesizedType(aSource, aTarget);</span>
<a href="#l2.4149"></a><span id="l2.4149" class="difflineminus">-        return rv;</span>
<a href="#l2.4150"></a><span id="l2.4150" class="difflineminus">-    }</span>
<a href="#l2.4151"></a><span id="l2.4151" class="difflineminus">-    else if (aTruthValue &amp;&amp; isBookmarkCommand(aSource) &amp;&amp; (aProperty == kNC_Name))</span>
<a href="#l2.4152"></a><span id="l2.4152" class="difflineminus">-    {</span>
<a href="#l2.4153"></a><span id="l2.4153" class="difflineminus">-        nsAutoString    name;</span>
<a href="#l2.4154"></a><span id="l2.4154" class="difflineminus">-        if (aSource == kNC_BookmarkCommand_NewBookmark)</span>
<a href="#l2.4155"></a><span id="l2.4155" class="difflineminus">-            getLocaleString(&quot;NewBookmark&quot;, name);</span>
<a href="#l2.4156"></a><span id="l2.4156" class="difflineminus">-        else if (aSource == kNC_BookmarkCommand_NewFolder)</span>
<a href="#l2.4157"></a><span id="l2.4157" class="difflineminus">-            getLocaleString(&quot;NewFolder&quot;, name);</span>
<a href="#l2.4158"></a><span id="l2.4158" class="difflineminus">-        else if (aSource == kNC_BookmarkCommand_NewSeparator)</span>
<a href="#l2.4159"></a><span id="l2.4159" class="difflineminus">-            getLocaleString(&quot;NewSeparator&quot;, name);</span>
<a href="#l2.4160"></a><span id="l2.4160" class="difflineminus">-        else if (aSource == kNC_BookmarkCommand_DeleteBookmark)</span>
<a href="#l2.4161"></a><span id="l2.4161" class="difflineminus">-            getLocaleString(&quot;DeleteBookmark&quot;, name);</span>
<a href="#l2.4162"></a><span id="l2.4162" class="difflineminus">-        else if (aSource == kNC_BookmarkCommand_DeleteBookmarkFolder)</span>
<a href="#l2.4163"></a><span id="l2.4163" class="difflineminus">-            getLocaleString(&quot;DeleteFolder&quot;, name);</span>
<a href="#l2.4164"></a><span id="l2.4164" class="difflineminus">-        else if (aSource == kNC_BookmarkCommand_DeleteBookmarkSeparator)</span>
<a href="#l2.4165"></a><span id="l2.4165" class="difflineminus">-            getLocaleString(&quot;DeleteSeparator&quot;, name);</span>
<a href="#l2.4166"></a><span id="l2.4166" class="difflineminus">-        else if (aSource == kNC_BookmarkCommand_SetNewBookmarkFolder)</span>
<a href="#l2.4167"></a><span id="l2.4167" class="difflineminus">-            getLocaleString(&quot;SetNewBookmarkFolder&quot;, name);</span>
<a href="#l2.4168"></a><span id="l2.4168" class="difflineminus">-        else if (aSource == kNC_BookmarkCommand_SetPersonalToolbarFolder)</span>
<a href="#l2.4169"></a><span id="l2.4169" class="difflineminus">-            getLocaleString(&quot;SetPersonalToolbarFolder&quot;, name);</span>
<a href="#l2.4170"></a><span id="l2.4170" class="difflineminus">-        else if (aSource == kNC_BookmarkCommand_SetNewSearchFolder)</span>
<a href="#l2.4171"></a><span id="l2.4171" class="difflineminus">-            getLocaleString(&quot;SetNewSearchFolder&quot;, name);</span>
<a href="#l2.4172"></a><span id="l2.4172" class="difflineminus">-        else if (aSource == kNC_BookmarkCommand_Import)</span>
<a href="#l2.4173"></a><span id="l2.4173" class="difflineminus">-            getLocaleString(&quot;Import&quot;, name);</span>
<a href="#l2.4174"></a><span id="l2.4174" class="difflineminus">-        else if (aSource == kNC_BookmarkCommand_Export)</span>
<a href="#l2.4175"></a><span id="l2.4175" class="difflineminus">-            getLocaleString(&quot;Export&quot;, name);</span>
<a href="#l2.4176"></a><span id="l2.4176" class="difflineminus">-</span>
<a href="#l2.4177"></a><span id="l2.4177" class="difflineminus">-        if (!name.IsEmpty())</span>
<a href="#l2.4178"></a><span id="l2.4178" class="difflineminus">-        {</span>
<a href="#l2.4179"></a><span id="l2.4179" class="difflineminus">-            *aTarget = nsnull;</span>
<a href="#l2.4180"></a><span id="l2.4180" class="difflineminus">-            nsCOMPtr&lt;nsIRDFLiteral&gt; literal;</span>
<a href="#l2.4181"></a><span id="l2.4181" class="difflineminus">-            if (NS_FAILED(rv = gRDF-&gt;GetLiteral(name.get(), getter_AddRefs(literal))))</span>
<a href="#l2.4182"></a><span id="l2.4182" class="difflineminus">-                return rv;</span>
<a href="#l2.4183"></a><span id="l2.4183" class="difflineminus">-            *aTarget = literal;</span>
<a href="#l2.4184"></a><span id="l2.4184" class="difflineminus">-            NS_IF_ADDREF(*aTarget);</span>
<a href="#l2.4185"></a><span id="l2.4185" class="difflineminus">-            return rv;</span>
<a href="#l2.4186"></a><span id="l2.4186" class="difflineminus">-        }</span>
<a href="#l2.4187"></a><span id="l2.4187" class="difflineminus">-    }</span>
<a href="#l2.4188"></a><span id="l2.4188" class="difflineminus">-    else if (aProperty == kNC_Icon)</span>
<a href="#l2.4189"></a><span id="l2.4189" class="difflineminus">-    {</span>
<a href="#l2.4190"></a><span id="l2.4190" class="difflineminus">-        rv = ProcessCachedBookmarkIcon(aSource, nsnull, aTarget);</span>
<a href="#l2.4191"></a><span id="l2.4191" class="difflineminus">-        return rv;</span>
<a href="#l2.4192"></a><span id="l2.4192" class="difflineminus">-    }</span>
<a href="#l2.4193"></a><span id="l2.4193" class="difflineminus">-</span>
<a href="#l2.4194"></a><span id="l2.4194" class="difflineminus">-    rv = mInner-&gt;GetTarget(aSource, aProperty, aTruthValue, aTarget);</span>
<a href="#l2.4195"></a><span id="l2.4195" class="difflineminus">-    return rv;</span>
<a href="#l2.4196"></a><span id="l2.4196" class="difflineminus">-}</span>
<a href="#l2.4197"></a><span id="l2.4197" class="difflineminus">-</span>
<a href="#l2.4198"></a><span id="l2.4198" class="difflineminus">-nsresult</span>
<a href="#l2.4199"></a><span id="l2.4199" class="difflineminus">-nsBookmarksService::ProcessCachedBookmarkIcon(nsIRDFResource* aSource,</span>
<a href="#l2.4200"></a><span id="l2.4200" class="difflineminus">-                                              const PRUnichar *iconURL, nsIRDFNode** aTarget)</span>
<a href="#l2.4201"></a><span id="l2.4201" class="difflineminus">-{</span>
<a href="#l2.4202"></a><span id="l2.4202" class="difflineminus">-    *aTarget = nsnull;</span>
<a href="#l2.4203"></a><span id="l2.4203" class="difflineminus">-</span>
<a href="#l2.4204"></a><span id="l2.4204" class="difflineminus">-    if (!mBrowserIcons)</span>
<a href="#l2.4205"></a><span id="l2.4205" class="difflineminus">-    {</span>
<a href="#l2.4206"></a><span id="l2.4206" class="difflineminus">-        return NS_RDF_NO_VALUE;</span>
<a href="#l2.4207"></a><span id="l2.4207" class="difflineminus">-    }</span>
<a href="#l2.4208"></a><span id="l2.4208" class="difflineminus">-</span>
<a href="#l2.4209"></a><span id="l2.4209" class="difflineminus">-    // if it is in fact a bookmark or favorite (but NOT a folder, or a separator, etc)...</span>
<a href="#l2.4210"></a><span id="l2.4210" class="difflineminus">-</span>
<a href="#l2.4211"></a><span id="l2.4211" class="difflineminus">-    nsCOMPtr&lt;nsIRDFNode&gt; nodeType;</span>
<a href="#l2.4212"></a><span id="l2.4212" class="difflineminus">-    GetSynthesizedType(aSource, getter_AddRefs(nodeType));</span>
<a href="#l2.4213"></a><span id="l2.4213" class="difflineminus">-    if ((nodeType != kNC_Bookmark) &amp;&amp; (nodeType != kNC_IEFavorite))</span>
<a href="#l2.4214"></a><span id="l2.4214" class="difflineminus">-    {</span>
<a href="#l2.4215"></a><span id="l2.4215" class="difflineminus">-        return NS_RDF_NO_VALUE;</span>
<a href="#l2.4216"></a><span id="l2.4216" class="difflineminus">-    }</span>
<a href="#l2.4217"></a><span id="l2.4217" class="difflineminus">-</span>
<a href="#l2.4218"></a><span id="l2.4218" class="difflineminus">-    nsresult rv;</span>
<a href="#l2.4219"></a><span id="l2.4219" class="difflineminus">-    nsCAutoString path;</span>
<a href="#l2.4220"></a><span id="l2.4220" class="difflineminus">-    nsCOMPtr&lt;nsIRDFNode&gt;    oldIconNode;</span>
<a href="#l2.4221"></a><span id="l2.4221" class="difflineminus">-</span>
<a href="#l2.4222"></a><span id="l2.4222" class="difflineminus">-    // if we have a new icon URL, save it away into our internal graph</span>
<a href="#l2.4223"></a><span id="l2.4223" class="difflineminus">-    if (iconURL)</span>
<a href="#l2.4224"></a><span id="l2.4224" class="difflineminus">-    {</span>
<a href="#l2.4225"></a><span id="l2.4225" class="difflineminus">-        LossyCopyUTF16toASCII(nsDependentString(iconURL), path);</span>
<a href="#l2.4226"></a><span id="l2.4226" class="difflineminus">-</span>
<a href="#l2.4227"></a><span id="l2.4227" class="difflineminus">-        nsCOMPtr&lt;nsIRDFLiteral&gt; iconLiteral;</span>
<a href="#l2.4228"></a><span id="l2.4228" class="difflineminus">-        if (NS_FAILED(rv = gRDF-&gt;GetLiteral(iconURL, getter_AddRefs(iconLiteral))))</span>
<a href="#l2.4229"></a><span id="l2.4229" class="difflineminus">-        {</span>
<a href="#l2.4230"></a><span id="l2.4230" class="difflineminus">-            return rv;</span>
<a href="#l2.4231"></a><span id="l2.4231" class="difflineminus">-        }</span>
<a href="#l2.4232"></a><span id="l2.4232" class="difflineminus">-</span>
<a href="#l2.4233"></a><span id="l2.4233" class="difflineminus">-        rv = mInner-&gt;GetTarget(aSource, kNC_Icon, PR_TRUE, getter_AddRefs(oldIconNode));</span>
<a href="#l2.4234"></a><span id="l2.4234" class="difflineminus">-        if (NS_SUCCEEDED(rv) &amp;&amp; (rv != NS_RDF_NO_VALUE) &amp;&amp; (oldIconNode))</span>
<a href="#l2.4235"></a><span id="l2.4235" class="difflineminus">-        {</span>
<a href="#l2.4236"></a><span id="l2.4236" class="difflineminus">-            (void)mInner-&gt;Unassert(aSource, kNC_Icon, oldIconNode);</span>
<a href="#l2.4237"></a><span id="l2.4237" class="difflineminus">-        }</span>
<a href="#l2.4238"></a><span id="l2.4238" class="difflineminus">-        (void)mInner-&gt;Assert(aSource, kNC_Icon, iconLiteral, PR_TRUE);</span>
<a href="#l2.4239"></a><span id="l2.4239" class="difflineminus">-</span>
<a href="#l2.4240"></a><span id="l2.4240" class="difflineminus">-        mDirty = PR_TRUE;</span>
<a href="#l2.4241"></a><span id="l2.4241" class="difflineminus">-    }</span>
<a href="#l2.4242"></a><span id="l2.4242" class="difflineminus">-    else</span>
<a href="#l2.4243"></a><span id="l2.4243" class="difflineminus">-    {</span>
<a href="#l2.4244"></a><span id="l2.4244" class="difflineminus">-        // otherwise, just check and see if we have an internal icon reference</span>
<a href="#l2.4245"></a><span id="l2.4245" class="difflineminus">-        rv = mInner-&gt;GetTarget(aSource, kNC_Icon, PR_TRUE, getter_AddRefs(oldIconNode));</span>
<a href="#l2.4246"></a><span id="l2.4246" class="difflineminus">-    }</span>
<a href="#l2.4247"></a><span id="l2.4247" class="difflineminus">-    </span>
<a href="#l2.4248"></a><span id="l2.4248" class="difflineminus">-    if (oldIconNode)</span>
<a href="#l2.4249"></a><span id="l2.4249" class="difflineminus">-    {</span>
<a href="#l2.4250"></a><span id="l2.4250" class="difflineminus">-        nsCOMPtr&lt;nsIRDFLiteral&gt; tempLiteral = do_QueryInterface(oldIconNode);</span>
<a href="#l2.4251"></a><span id="l2.4251" class="difflineminus">-        if (tempLiteral)</span>
<a href="#l2.4252"></a><span id="l2.4252" class="difflineminus">-        {</span>
<a href="#l2.4253"></a><span id="l2.4253" class="difflineminus">-            const PRUnichar *uni = nsnull;</span>
<a href="#l2.4254"></a><span id="l2.4254" class="difflineminus">-            tempLiteral-&gt;GetValueConst(&amp;uni);</span>
<a href="#l2.4255"></a><span id="l2.4255" class="difflineminus">-            if (uni)</span>
<a href="#l2.4256"></a><span id="l2.4256" class="difflineminus">-                LossyCopyUTF16toASCII(nsDependentString(uni), path);</span>
<a href="#l2.4257"></a><span id="l2.4257" class="difflineminus">-        }</span>
<a href="#l2.4258"></a><span id="l2.4258" class="difflineminus">-    }</span>
<a href="#l2.4259"></a><span id="l2.4259" class="difflineminus">-</span>
<a href="#l2.4260"></a><span id="l2.4260" class="difflineminus">-    PRBool forceLoad = mAlwaysLoadIcons;</span>
<a href="#l2.4261"></a><span id="l2.4261" class="difflineminus">-</span>
<a href="#l2.4262"></a><span id="l2.4262" class="difflineminus">-    // if no internal icon reference, try and synthesize a URL</span>
<a href="#l2.4263"></a><span id="l2.4263" class="difflineminus">-    if (path.IsEmpty())</span>
<a href="#l2.4264"></a><span id="l2.4264" class="difflineminus">-    {</span>
<a href="#l2.4265"></a><span id="l2.4265" class="difflineminus">-        const char  *uri;</span>
<a href="#l2.4266"></a><span id="l2.4266" class="difflineminus">-        forceLoad = PR_FALSE;</span>
<a href="#l2.4267"></a><span id="l2.4267" class="difflineminus">-        if (NS_FAILED(rv = aSource-&gt;GetValueConst( &amp;uri )))</span>
<a href="#l2.4268"></a><span id="l2.4268" class="difflineminus">-        {</span>
<a href="#l2.4269"></a><span id="l2.4269" class="difflineminus">-            return rv;</span>
<a href="#l2.4270"></a><span id="l2.4270" class="difflineminus">-        }</span>
<a href="#l2.4271"></a><span id="l2.4271" class="difflineminus">-</span>
<a href="#l2.4272"></a><span id="l2.4272" class="difflineminus">-        nsCOMPtr&lt;nsIURI&gt;    nsURI;</span>
<a href="#l2.4273"></a><span id="l2.4273" class="difflineminus">-        if (NS_FAILED(rv = mNetService-&gt;NewURI(nsDependentCString(uri), nsnull, nsnull, getter_AddRefs(nsURI))))</span>
<a href="#l2.4274"></a><span id="l2.4274" class="difflineminus">-        {</span>
<a href="#l2.4275"></a><span id="l2.4275" class="difflineminus">-            return rv;</span>
<a href="#l2.4276"></a><span id="l2.4276" class="difflineminus">-        }</span>
<a href="#l2.4277"></a><span id="l2.4277" class="difflineminus">-        </span>
<a href="#l2.4278"></a><span id="l2.4278" class="difflineminus">-        // only allow http/https URLs for favicon</span>
<a href="#l2.4279"></a><span id="l2.4279" class="difflineminus">-        PRBool  isHTTP = PR_FALSE;</span>
<a href="#l2.4280"></a><span id="l2.4280" class="difflineminus">-        nsURI-&gt;SchemeIs(&quot;http&quot;, &amp;isHTTP);</span>
<a href="#l2.4281"></a><span id="l2.4281" class="difflineminus">-        if (!isHTTP)</span>
<a href="#l2.4282"></a><span id="l2.4282" class="difflineminus">-        {</span>
<a href="#l2.4283"></a><span id="l2.4283" class="difflineminus">-            nsURI-&gt;SchemeIs(&quot;https&quot;, &amp;isHTTP);</span>
<a href="#l2.4284"></a><span id="l2.4284" class="difflineminus">-        }</span>
<a href="#l2.4285"></a><span id="l2.4285" class="difflineminus">-        if (!isHTTP)</span>
<a href="#l2.4286"></a><span id="l2.4286" class="difflineminus">-        {</span>
<a href="#l2.4287"></a><span id="l2.4287" class="difflineminus">-            return NS_RDF_NO_VALUE;</span>
<a href="#l2.4288"></a><span id="l2.4288" class="difflineminus">-        }</span>
<a href="#l2.4289"></a><span id="l2.4289" class="difflineminus">-</span>
<a href="#l2.4290"></a><span id="l2.4290" class="difflineminus">-        nsCAutoString prePath;</span>
<a href="#l2.4291"></a><span id="l2.4291" class="difflineminus">-        if (NS_FAILED(rv = nsURI-&gt;GetPrePath(prePath)))</span>
<a href="#l2.4292"></a><span id="l2.4292" class="difflineminus">-        {</span>
<a href="#l2.4293"></a><span id="l2.4293" class="difflineminus">-            return rv;</span>
<a href="#l2.4294"></a><span id="l2.4294" class="difflineminus">-        }</span>
<a href="#l2.4295"></a><span id="l2.4295" class="difflineminus">-        path.Assign(prePath);</span>
<a href="#l2.4296"></a><span id="l2.4296" class="difflineminus">-        path.Append(&quot;/favicon.ico&quot;);</span>
<a href="#l2.4297"></a><span id="l2.4297" class="difflineminus">-    }</span>
<a href="#l2.4298"></a><span id="l2.4298" class="difflineminus">-</span>
<a href="#l2.4299"></a><span id="l2.4299" class="difflineminus">-    if (!forceLoad) {</span>
<a href="#l2.4300"></a><span id="l2.4300" class="difflineminus">-        // only return favicon reference if its in the cache</span>
<a href="#l2.4301"></a><span id="l2.4301" class="difflineminus">-        // (that is, never go out onto the net)</span>
<a href="#l2.4302"></a><span id="l2.4302" class="difflineminus">-        if (!mCacheSession)</span>
<a href="#l2.4303"></a><span id="l2.4303" class="difflineminus">-        {</span>
<a href="#l2.4304"></a><span id="l2.4304" class="difflineminus">-            return NS_RDF_NO_VALUE;</span>
<a href="#l2.4305"></a><span id="l2.4305" class="difflineminus">-        }</span>
<a href="#l2.4306"></a><span id="l2.4306" class="difflineminus">-        nsCOMPtr&lt;nsICacheEntryDescriptor&gt; entry;</span>
<a href="#l2.4307"></a><span id="l2.4307" class="difflineminus">-        rv = mCacheSession-&gt;OpenCacheEntry(path, nsICache::ACCESS_READ,</span>
<a href="#l2.4308"></a><span id="l2.4308" class="difflineminus">-                                           nsICache::NON_BLOCKING, getter_AddRefs(entry));</span>
<a href="#l2.4309"></a><span id="l2.4309" class="difflineminus">-        if (NS_FAILED(rv) || (!entry))</span>
<a href="#l2.4310"></a><span id="l2.4310" class="difflineminus">-        {</span>
<a href="#l2.4311"></a><span id="l2.4311" class="difflineminus">-            return NS_RDF_NO_VALUE;</span>
<a href="#l2.4312"></a><span id="l2.4312" class="difflineminus">-        }</span>
<a href="#l2.4313"></a><span id="l2.4313" class="difflineminus">-        if (entry) </span>
<a href="#l2.4314"></a><span id="l2.4314" class="difflineminus">-        {</span>
<a href="#l2.4315"></a><span id="l2.4315" class="difflineminus">-            PRUint32 expTime;</span>
<a href="#l2.4316"></a><span id="l2.4316" class="difflineminus">-            entry-&gt;GetExpirationTime(&amp;expTime);</span>
<a href="#l2.4317"></a><span id="l2.4317" class="difflineminus">-            if (expTime != PR_UINT32_MAX)</span>
<a href="#l2.4318"></a><span id="l2.4318" class="difflineminus">-                entry-&gt;SetExpirationTime(PR_UINT32_MAX);</span>
<a href="#l2.4319"></a><span id="l2.4319" class="difflineminus">-        }</span>
<a href="#l2.4320"></a><span id="l2.4320" class="difflineminus">-        entry-&gt;Close();</span>
<a href="#l2.4321"></a><span id="l2.4321" class="difflineminus">-    }</span>
<a href="#l2.4322"></a><span id="l2.4322" class="difflineminus">-</span>
<a href="#l2.4323"></a><span id="l2.4323" class="difflineminus">-    // ok, have a cached icon entry, so return the URL's associated favicon</span>
<a href="#l2.4324"></a><span id="l2.4324" class="difflineminus">-    NS_ConvertASCIItoUTF16 litStr(path);</span>
<a href="#l2.4325"></a><span id="l2.4325" class="difflineminus">-    nsCOMPtr&lt;nsIRDFLiteral&gt; literal;</span>
<a href="#l2.4326"></a><span id="l2.4326" class="difflineminus">-    if (NS_FAILED(rv = gRDF-&gt;GetLiteral(litStr.get(), getter_AddRefs(literal))))</span>
<a href="#l2.4327"></a><span id="l2.4327" class="difflineminus">-    {</span>
<a href="#l2.4328"></a><span id="l2.4328" class="difflineminus">-        return rv;</span>
<a href="#l2.4329"></a><span id="l2.4329" class="difflineminus">-    }</span>
<a href="#l2.4330"></a><span id="l2.4330" class="difflineminus">-    *aTarget = literal;</span>
<a href="#l2.4331"></a><span id="l2.4331" class="difflineminus">-    NS_IF_ADDREF(*aTarget);</span>
<a href="#l2.4332"></a><span id="l2.4332" class="difflineminus">-    return NS_OK;</span>
<a href="#l2.4333"></a><span id="l2.4333" class="difflineminus">-}</span>
<a href="#l2.4334"></a><span id="l2.4334" class="difflineminus">-</span>
<a href="#l2.4335"></a><span id="l2.4335" class="difflineminus">-void</span>
<a href="#l2.4336"></a><span id="l2.4336" class="difflineminus">-nsBookmarksService::AnnotateBookmarkSchedule(nsIRDFResource* aSource, PRBool scheduleFlag)</span>
<a href="#l2.4337"></a><span id="l2.4337" class="difflineminus">-{</span>
<a href="#l2.4338"></a><span id="l2.4338" class="difflineminus">-    if (scheduleFlag)</span>
<a href="#l2.4339"></a><span id="l2.4339" class="difflineminus">-    {</span>
<a href="#l2.4340"></a><span id="l2.4340" class="difflineminus">-        PRBool exists = PR_FALSE;</span>
<a href="#l2.4341"></a><span id="l2.4341" class="difflineminus">-        if (NS_SUCCEEDED(mInner-&gt;HasAssertion(aSource, kWEB_ScheduleActive,</span>
<a href="#l2.4342"></a><span id="l2.4342" class="difflineminus">-                                              kTrueLiteral, PR_TRUE, &amp;exists)) &amp;&amp; (!exists))</span>
<a href="#l2.4343"></a><span id="l2.4343" class="difflineminus">-        {</span>
<a href="#l2.4344"></a><span id="l2.4344" class="difflineminus">-            (void)mInner-&gt;Assert(aSource, kWEB_ScheduleActive, kTrueLiteral, PR_TRUE);</span>
<a href="#l2.4345"></a><span id="l2.4345" class="difflineminus">-        }</span>
<a href="#l2.4346"></a><span id="l2.4346" class="difflineminus">-    }</span>
<a href="#l2.4347"></a><span id="l2.4347" class="difflineminus">-    else</span>
<a href="#l2.4348"></a><span id="l2.4348" class="difflineminus">-    {</span>
<a href="#l2.4349"></a><span id="l2.4349" class="difflineminus">-        (void)mInner-&gt;Unassert(aSource, kWEB_ScheduleActive, kTrueLiteral);</span>
<a href="#l2.4350"></a><span id="l2.4350" class="difflineminus">-    }</span>
<a href="#l2.4351"></a><span id="l2.4351" class="difflineminus">-}</span>
<a href="#l2.4352"></a><span id="l2.4352" class="difflineminus">-</span>
<a href="#l2.4353"></a><span id="l2.4353" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l2.4354"></a><span id="l2.4354" class="difflineminus">-nsBookmarksService::Assert(nsIRDFResource* aSource,</span>
<a href="#l2.4355"></a><span id="l2.4355" class="difflineminus">-                           nsIRDFResource* aProperty,</span>
<a href="#l2.4356"></a><span id="l2.4356" class="difflineminus">-                           nsIRDFNode* aTarget,</span>
<a href="#l2.4357"></a><span id="l2.4357" class="difflineminus">-                           PRBool aTruthValue)</span>
<a href="#l2.4358"></a><span id="l2.4358" class="difflineminus">-{</span>
<a href="#l2.4359"></a><span id="l2.4359" class="difflineminus">-    nsresult rv = NS_RDF_ASSERTION_REJECTED;</span>
<a href="#l2.4360"></a><span id="l2.4360" class="difflineminus">-</span>
<a href="#l2.4361"></a><span id="l2.4361" class="difflineminus">-    if (CanAccept(aSource, aProperty, aTarget))</span>
<a href="#l2.4362"></a><span id="l2.4362" class="difflineminus">-    {</span>
<a href="#l2.4363"></a><span id="l2.4363" class="difflineminus">-        rv = mInner-&gt;Assert(aSource, aProperty, aTarget, aTruthValue);</span>
<a href="#l2.4364"></a><span id="l2.4364" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l2.4365"></a><span id="l2.4365" class="difflineminus">-            return rv;</span>
<a href="#l2.4366"></a><span id="l2.4366" class="difflineminus">-</span>
<a href="#l2.4367"></a><span id="l2.4367" class="difflineminus">-        UpdateBookmarkLastModifiedDate(aSource);</span>
<a href="#l2.4368"></a><span id="l2.4368" class="difflineminus">-            </span>
<a href="#l2.4369"></a><span id="l2.4369" class="difflineminus">-        if (aProperty == kWEB_Schedule) {</span>
<a href="#l2.4370"></a><span id="l2.4370" class="difflineminus">-              AnnotateBookmarkSchedule(aSource, PR_TRUE);</span>
<a href="#l2.4371"></a><span id="l2.4371" class="difflineminus">-        }</span>
<a href="#l2.4372"></a><span id="l2.4372" class="difflineminus">-    }</span>
<a href="#l2.4373"></a><span id="l2.4373" class="difflineminus">-</span>
<a href="#l2.4374"></a><span id="l2.4374" class="difflineminus">-    return rv;</span>
<a href="#l2.4375"></a><span id="l2.4375" class="difflineminus">-}</span>
<a href="#l2.4376"></a><span id="l2.4376" class="difflineminus">-</span>
<a href="#l2.4377"></a><span id="l2.4377" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l2.4378"></a><span id="l2.4378" class="difflineminus">-nsBookmarksService::Unassert(nsIRDFResource* aSource,</span>
<a href="#l2.4379"></a><span id="l2.4379" class="difflineminus">-                             nsIRDFResource* aProperty,</span>
<a href="#l2.4380"></a><span id="l2.4380" class="difflineminus">-                             nsIRDFNode* aTarget)</span>
<a href="#l2.4381"></a><span id="l2.4381" class="difflineminus">-{</span>
<a href="#l2.4382"></a><span id="l2.4382" class="difflineminus">-    nsresult rv = NS_RDF_ASSERTION_REJECTED;</span>
<a href="#l2.4383"></a><span id="l2.4383" class="difflineminus">-</span>
<a href="#l2.4384"></a><span id="l2.4384" class="difflineminus">-    if (CanAccept(aSource, aProperty, aTarget)) {</span>
<a href="#l2.4385"></a><span id="l2.4385" class="difflineminus">-        rv = mInner-&gt;Unassert(aSource, aProperty, aTarget);</span>
<a href="#l2.4386"></a><span id="l2.4386" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l2.4387"></a><span id="l2.4387" class="difflineminus">-            return rv;</span>
<a href="#l2.4388"></a><span id="l2.4388" class="difflineminus">-</span>
<a href="#l2.4389"></a><span id="l2.4389" class="difflineminus">-        UpdateBookmarkLastModifiedDate(aSource);</span>
<a href="#l2.4390"></a><span id="l2.4390" class="difflineminus">-</span>
<a href="#l2.4391"></a><span id="l2.4391" class="difflineminus">-        if (aProperty == kWEB_Schedule) {</span>
<a href="#l2.4392"></a><span id="l2.4392" class="difflineminus">-            AnnotateBookmarkSchedule(aSource, PR_FALSE);</span>
<a href="#l2.4393"></a><span id="l2.4393" class="difflineminus">-        }</span>
<a href="#l2.4394"></a><span id="l2.4394" class="difflineminus">-    }</span>
<a href="#l2.4395"></a><span id="l2.4395" class="difflineminus">-</span>
<a href="#l2.4396"></a><span id="l2.4396" class="difflineminus">-    return rv;</span>
<a href="#l2.4397"></a><span id="l2.4397" class="difflineminus">-}</span>
<a href="#l2.4398"></a><span id="l2.4398" class="difflineminus">-</span>
<a href="#l2.4399"></a><span id="l2.4399" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l2.4400"></a><span id="l2.4400" class="difflineminus">-nsBookmarksService::Change(nsIRDFResource* aSource,</span>
<a href="#l2.4401"></a><span id="l2.4401" class="difflineminus">-                           nsIRDFResource* aProperty,</span>
<a href="#l2.4402"></a><span id="l2.4402" class="difflineminus">-                           nsIRDFNode* aOldTarget,</span>
<a href="#l2.4403"></a><span id="l2.4403" class="difflineminus">-                           nsIRDFNode* aNewTarget)</span>
<a href="#l2.4404"></a><span id="l2.4404" class="difflineminus">-{</span>
<a href="#l2.4405"></a><span id="l2.4405" class="difflineminus">-    nsresult rv = NS_RDF_ASSERTION_REJECTED;</span>
<a href="#l2.4406"></a><span id="l2.4406" class="difflineminus">-</span>
<a href="#l2.4407"></a><span id="l2.4407" class="difflineminus">-    if (CanAccept(aSource, aProperty, aNewTarget)) {</span>
<a href="#l2.4408"></a><span id="l2.4408" class="difflineminus">-        rv = mInner-&gt;Change(aSource, aProperty, aOldTarget, aNewTarget);</span>
<a href="#l2.4409"></a><span id="l2.4409" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l2.4410"></a><span id="l2.4410" class="difflineminus">-            return rv;</span>
<a href="#l2.4411"></a><span id="l2.4411" class="difflineminus">-</span>
<a href="#l2.4412"></a><span id="l2.4412" class="difflineminus">-        UpdateBookmarkLastModifiedDate(aSource);</span>
<a href="#l2.4413"></a><span id="l2.4413" class="difflineminus">-</span>
<a href="#l2.4414"></a><span id="l2.4414" class="difflineminus">-        if (aProperty == kWEB_Schedule) {</span>
<a href="#l2.4415"></a><span id="l2.4415" class="difflineminus">-            AnnotateBookmarkSchedule(aSource, PR_TRUE);</span>
<a href="#l2.4416"></a><span id="l2.4416" class="difflineminus">-        }</span>
<a href="#l2.4417"></a><span id="l2.4417" class="difflineminus">-    }</span>
<a href="#l2.4418"></a><span id="l2.4418" class="difflineminus">-</span>
<a href="#l2.4419"></a><span id="l2.4419" class="difflineminus">-    return rv;</span>
<a href="#l2.4420"></a><span id="l2.4420" class="difflineminus">-}</span>
<a href="#l2.4421"></a><span id="l2.4421" class="difflineminus">-</span>
<a href="#l2.4422"></a><span id="l2.4422" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l2.4423"></a><span id="l2.4423" class="difflineminus">-nsBookmarksService::Move(nsIRDFResource* aOldSource,</span>
<a href="#l2.4424"></a><span id="l2.4424" class="difflineminus">-                         nsIRDFResource* aNewSource,</span>
<a href="#l2.4425"></a><span id="l2.4425" class="difflineminus">-                         nsIRDFResource* aProperty,</span>
<a href="#l2.4426"></a><span id="l2.4426" class="difflineminus">-                         nsIRDFNode* aTarget)</span>
<a href="#l2.4427"></a><span id="l2.4427" class="difflineminus">-{</span>
<a href="#l2.4428"></a><span id="l2.4428" class="difflineminus">-    nsresult    rv = NS_RDF_ASSERTION_REJECTED;</span>
<a href="#l2.4429"></a><span id="l2.4429" class="difflineminus">-</span>
<a href="#l2.4430"></a><span id="l2.4430" class="difflineminus">-    if (CanAccept(aNewSource, aProperty, aTarget))</span>
<a href="#l2.4431"></a><span id="l2.4431" class="difflineminus">-    {</span>
<a href="#l2.4432"></a><span id="l2.4432" class="difflineminus">-        rv = mInner-&gt;Move(aOldSource, aNewSource, aProperty, aTarget);</span>
<a href="#l2.4433"></a><span id="l2.4433" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l2.4434"></a><span id="l2.4434" class="difflineminus">-            return rv;</span>
<a href="#l2.4435"></a><span id="l2.4435" class="difflineminus">-</span>
<a href="#l2.4436"></a><span id="l2.4436" class="difflineminus">-        UpdateBookmarkLastModifiedDate(aOldSource);</span>
<a href="#l2.4437"></a><span id="l2.4437" class="difflineminus">-        UpdateBookmarkLastModifiedDate(aNewSource);</span>
<a href="#l2.4438"></a><span id="l2.4438" class="difflineminus">-    }</span>
<a href="#l2.4439"></a><span id="l2.4439" class="difflineminus">-    return rv;</span>
<a href="#l2.4440"></a><span id="l2.4440" class="difflineminus">-}</span>
<a href="#l2.4441"></a><span id="l2.4441" class="difflineminus">-</span>
<a href="#l2.4442"></a><span id="l2.4442" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l2.4443"></a><span id="l2.4443" class="difflineminus">-nsBookmarksService::HasAssertion(nsIRDFResource* source,</span>
<a href="#l2.4444"></a><span id="l2.4444" class="difflineminus">-                nsIRDFResource* property,</span>
<a href="#l2.4445"></a><span id="l2.4445" class="difflineminus">-                nsIRDFNode* target,</span>
<a href="#l2.4446"></a><span id="l2.4446" class="difflineminus">-                PRBool tv,</span>
<a href="#l2.4447"></a><span id="l2.4447" class="difflineminus">-                PRBool* hasAssertion)</span>
<a href="#l2.4448"></a><span id="l2.4448" class="difflineminus">-{</span>
<a href="#l2.4449"></a><span id="l2.4449" class="difflineminus">-#ifdef XP_WIN</span>
<a href="#l2.4450"></a><span id="l2.4450" class="difflineminus">-    HandleSystemBookmarks(source);</span>
<a href="#l2.4451"></a><span id="l2.4451" class="difflineminus">-#endif</span>
<a href="#l2.4452"></a><span id="l2.4452" class="difflineminus">-</span>
<a href="#l2.4453"></a><span id="l2.4453" class="difflineminus">-    return mInner-&gt;HasAssertion(source, property, target, tv, hasAssertion);</span>
<a href="#l2.4454"></a><span id="l2.4454" class="difflineminus">-}</span>
<a href="#l2.4455"></a><span id="l2.4455" class="difflineminus">-</span>
<a href="#l2.4456"></a><span id="l2.4456" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l2.4457"></a><span id="l2.4457" class="difflineminus">-nsBookmarksService::AddObserver(nsIRDFObserver* aObserver)</span>
<a href="#l2.4458"></a><span id="l2.4458" class="difflineminus">-{</span>
<a href="#l2.4459"></a><span id="l2.4459" class="difflineminus">-    if (! aObserver)</span>
<a href="#l2.4460"></a><span id="l2.4460" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l2.4461"></a><span id="l2.4461" class="difflineminus">-</span>
<a href="#l2.4462"></a><span id="l2.4462" class="difflineminus">-    if (! mObservers.AppendObject(aObserver)) {</span>
<a href="#l2.4463"></a><span id="l2.4463" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l2.4464"></a><span id="l2.4464" class="difflineminus">-    }</span>
<a href="#l2.4465"></a><span id="l2.4465" class="difflineminus">-    </span>
<a href="#l2.4466"></a><span id="l2.4466" class="difflineminus">-    return NS_OK;</span>
<a href="#l2.4467"></a><span id="l2.4467" class="difflineminus">-}</span>
<a href="#l2.4468"></a><span id="l2.4468" class="difflineminus">-</span>
<a href="#l2.4469"></a><span id="l2.4469" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l2.4470"></a><span id="l2.4470" class="difflineminus">-nsBookmarksService::RemoveObserver(nsIRDFObserver* aObserver)</span>
<a href="#l2.4471"></a><span id="l2.4471" class="difflineminus">-{</span>
<a href="#l2.4472"></a><span id="l2.4472" class="difflineminus">-    if (! aObserver)</span>
<a href="#l2.4473"></a><span id="l2.4473" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l2.4474"></a><span id="l2.4474" class="difflineminus">-</span>
<a href="#l2.4475"></a><span id="l2.4475" class="difflineminus">-    mObservers.RemoveObject(aObserver);</span>
<a href="#l2.4476"></a><span id="l2.4476" class="difflineminus">-</span>
<a href="#l2.4477"></a><span id="l2.4477" class="difflineminus">-    return NS_OK;</span>
<a href="#l2.4478"></a><span id="l2.4478" class="difflineminus">-}</span>
<a href="#l2.4479"></a><span id="l2.4479" class="difflineminus">-</span>
<a href="#l2.4480"></a><span id="l2.4480" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l2.4481"></a><span id="l2.4481" class="difflineminus">-nsBookmarksService::HasArcIn(nsIRDFNode *aNode, nsIRDFResource *aArc, PRBool *_retval)</span>
<a href="#l2.4482"></a><span id="l2.4482" class="difflineminus">-{</span>
<a href="#l2.4483"></a><span id="l2.4483" class="difflineminus">-#ifdef XP_WIN</span>
<a href="#l2.4484"></a><span id="l2.4484" class="difflineminus">-    HandleSystemBookmarks(aNode);</span>
<a href="#l2.4485"></a><span id="l2.4485" class="difflineminus">-#endif</span>
<a href="#l2.4486"></a><span id="l2.4486" class="difflineminus">-</span>
<a href="#l2.4487"></a><span id="l2.4487" class="difflineminus">-    return mInner-&gt;HasArcIn(aNode, aArc, _retval);</span>
<a href="#l2.4488"></a><span id="l2.4488" class="difflineminus">-}</span>
<a href="#l2.4489"></a><span id="l2.4489" class="difflineminus">-</span>
<a href="#l2.4490"></a><span id="l2.4490" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l2.4491"></a><span id="l2.4491" class="difflineminus">-nsBookmarksService::HasArcOut(nsIRDFResource *aSource, nsIRDFResource *aArc, PRBool *_retval)</span>
<a href="#l2.4492"></a><span id="l2.4492" class="difflineminus">-{</span>
<a href="#l2.4493"></a><span id="l2.4493" class="difflineminus">-#ifdef XP_WIN</span>
<a href="#l2.4494"></a><span id="l2.4494" class="difflineminus">-    HandleSystemBookmarks(aSource);</span>
<a href="#l2.4495"></a><span id="l2.4495" class="difflineminus">-#endif</span>
<a href="#l2.4496"></a><span id="l2.4496" class="difflineminus">-  </span>
<a href="#l2.4497"></a><span id="l2.4497" class="difflineminus">-    return mInner-&gt;HasArcOut(aSource, aArc, _retval);</span>
<a href="#l2.4498"></a><span id="l2.4498" class="difflineminus">-}</span>
<a href="#l2.4499"></a><span id="l2.4499" class="difflineminus">-</span>
<a href="#l2.4500"></a><span id="l2.4500" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l2.4501"></a><span id="l2.4501" class="difflineminus">-nsBookmarksService::ArcLabelsOut(nsIRDFResource* source,</span>
<a href="#l2.4502"></a><span id="l2.4502" class="difflineminus">-                nsISimpleEnumerator** labels)</span>
<a href="#l2.4503"></a><span id="l2.4503" class="difflineminus">-{</span>
<a href="#l2.4504"></a><span id="l2.4504" class="difflineminus">-#ifdef XP_WIN</span>
<a href="#l2.4505"></a><span id="l2.4505" class="difflineminus">-    HandleSystemBookmarks(source);</span>
<a href="#l2.4506"></a><span id="l2.4506" class="difflineminus">-#endif</span>
<a href="#l2.4507"></a><span id="l2.4507" class="difflineminus">-</span>
<a href="#l2.4508"></a><span id="l2.4508" class="difflineminus">-    return mInner-&gt;ArcLabelsOut(source, labels);</span>
<a href="#l2.4509"></a><span id="l2.4509" class="difflineminus">-}</span>
<a href="#l2.4510"></a><span id="l2.4510" class="difflineminus">-</span>
<a href="#l2.4511"></a><span id="l2.4511" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l2.4512"></a><span id="l2.4512" class="difflineminus">-nsBookmarksService::GetAllResources(nsISimpleEnumerator** aResult)</span>
<a href="#l2.4513"></a><span id="l2.4513" class="difflineminus">-{</span>
<a href="#l2.4514"></a><span id="l2.4514" class="difflineminus">-#ifdef XP_WIN</span>
<a href="#l2.4515"></a><span id="l2.4515" class="difflineminus">-    HandleSystemBookmarks(kNC_SystemBookmarksStaticRoot);</span>
<a href="#l2.4516"></a><span id="l2.4516" class="difflineminus">-#endif</span>
<a href="#l2.4517"></a><span id="l2.4517" class="difflineminus">-  </span>
<a href="#l2.4518"></a><span id="l2.4518" class="difflineminus">-    return mInner-&gt;GetAllResources(aResult);</span>
<a href="#l2.4519"></a><span id="l2.4519" class="difflineminus">-}</span>
<a href="#l2.4520"></a><span id="l2.4520" class="difflineminus">-</span>
<a href="#l2.4521"></a><span id="l2.4521" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l2.4522"></a><span id="l2.4522" class="difflineminus">-nsBookmarksService::GetAllCmds(nsIRDFResource* source,</span>
<a href="#l2.4523"></a><span id="l2.4523" class="difflineminus">-                   nsISimpleEnumerator/*&lt;nsIRDFResource&gt;*/** commands)</span>
<a href="#l2.4524"></a><span id="l2.4524" class="difflineminus">-{</span>
<a href="#l2.4525"></a><span id="l2.4525" class="difflineminus">-    nsresult            rv;</span>
<a href="#l2.4526"></a><span id="l2.4526" class="difflineminus">-    nsCOMPtr&lt;nsISupportsArray&gt; cmdArray(do_CreateInstance(NS_SUPPORTSARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l2.4527"></a><span id="l2.4527" class="difflineminus">-    if (NS_FAILED(rv))  return rv;</span>
<a href="#l2.4528"></a><span id="l2.4528" class="difflineminus">-</span>
<a href="#l2.4529"></a><span id="l2.4529" class="difflineminus">-    // determine type</span>
<a href="#l2.4530"></a><span id="l2.4530" class="difflineminus">-    nsCOMPtr&lt;nsIRDFNode&gt; nodeType;</span>
<a href="#l2.4531"></a><span id="l2.4531" class="difflineminus">-    GetSynthesizedType(source, getter_AddRefs(nodeType));</span>
<a href="#l2.4532"></a><span id="l2.4532" class="difflineminus">-</span>
<a href="#l2.4533"></a><span id="l2.4533" class="difflineminus">-    PRBool  isBookmark, isBookmarkFolder, isBookmarkSeparator;</span>
<a href="#l2.4534"></a><span id="l2.4534" class="difflineminus">-    isBookmark = (nodeType == kNC_Bookmark) ? PR_TRUE : PR_FALSE;</span>
<a href="#l2.4535"></a><span id="l2.4535" class="difflineminus">-    isBookmarkFolder = (nodeType == kNC_Folder) ? PR_TRUE : PR_FALSE;</span>
<a href="#l2.4536"></a><span id="l2.4536" class="difflineminus">-    isBookmarkSeparator = (nodeType == kNC_BookmarkSeparator) ? PR_TRUE : PR_FALSE;</span>
<a href="#l2.4537"></a><span id="l2.4537" class="difflineminus">-</span>
<a href="#l2.4538"></a><span id="l2.4538" class="difflineminus">-    if (isBookmark || isBookmarkFolder || isBookmarkSeparator)</span>
<a href="#l2.4539"></a><span id="l2.4539" class="difflineminus">-    {</span>
<a href="#l2.4540"></a><span id="l2.4540" class="difflineminus">-        cmdArray-&gt;AppendElement(kNC_BookmarkCommand_NewBookmark);</span>
<a href="#l2.4541"></a><span id="l2.4541" class="difflineminus">-        cmdArray-&gt;AppendElement(kNC_BookmarkCommand_NewFolder);</span>
<a href="#l2.4542"></a><span id="l2.4542" class="difflineminus">-        cmdArray-&gt;AppendElement(kNC_BookmarkCommand_NewSeparator);</span>
<a href="#l2.4543"></a><span id="l2.4543" class="difflineminus">-        cmdArray-&gt;AppendElement(kNC_BookmarkSeparator);</span>
<a href="#l2.4544"></a><span id="l2.4544" class="difflineminus">-    }</span>
<a href="#l2.4545"></a><span id="l2.4545" class="difflineminus">-    if (isBookmark)</span>
<a href="#l2.4546"></a><span id="l2.4546" class="difflineminus">-    {</span>
<a href="#l2.4547"></a><span id="l2.4547" class="difflineminus">-        cmdArray-&gt;AppendElement(kNC_BookmarkCommand_DeleteBookmark);</span>
<a href="#l2.4548"></a><span id="l2.4548" class="difflineminus">-    }</span>
<a href="#l2.4549"></a><span id="l2.4549" class="difflineminus">-    if (isBookmarkFolder &amp;&amp; (source != kNC_BookmarksRoot) &amp;&amp; (source != kNC_IEFavoritesRoot))</span>
<a href="#l2.4550"></a><span id="l2.4550" class="difflineminus">-    {</span>
<a href="#l2.4551"></a><span id="l2.4551" class="difflineminus">-        cmdArray-&gt;AppendElement(kNC_BookmarkCommand_DeleteBookmarkFolder);</span>
<a href="#l2.4552"></a><span id="l2.4552" class="difflineminus">-    }</span>
<a href="#l2.4553"></a><span id="l2.4553" class="difflineminus">-    if (isBookmarkSeparator)</span>
<a href="#l2.4554"></a><span id="l2.4554" class="difflineminus">-    {</span>
<a href="#l2.4555"></a><span id="l2.4555" class="difflineminus">-        cmdArray-&gt;AppendElement(kNC_BookmarkCommand_DeleteBookmarkSeparator);</span>
<a href="#l2.4556"></a><span id="l2.4556" class="difflineminus">-    }</span>
<a href="#l2.4557"></a><span id="l2.4557" class="difflineminus">-    if (isBookmarkFolder)</span>
<a href="#l2.4558"></a><span id="l2.4558" class="difflineminus">-    {</span>
<a href="#l2.4559"></a><span id="l2.4559" class="difflineminus">-        nsCOMPtr&lt;nsIRDFResource&gt;    newBookmarkFolder, personalToolbarFolder, newSearchFolder;</span>
<a href="#l2.4560"></a><span id="l2.4560" class="difflineminus">-        getFolderViaHint(kNC_NewBookmarkFolder, PR_FALSE, getter_AddRefs(newBookmarkFolder));</span>
<a href="#l2.4561"></a><span id="l2.4561" class="difflineminus">-        getFolderViaHint(kNC_PersonalToolbarFolder, PR_FALSE, getter_AddRefs(personalToolbarFolder));</span>
<a href="#l2.4562"></a><span id="l2.4562" class="difflineminus">-        getFolderViaHint(kNC_NewSearchFolder, PR_FALSE, getter_AddRefs(newSearchFolder));</span>
<a href="#l2.4563"></a><span id="l2.4563" class="difflineminus">-</span>
<a href="#l2.4564"></a><span id="l2.4564" class="difflineminus">-        cmdArray-&gt;AppendElement(kNC_BookmarkSeparator);</span>
<a href="#l2.4565"></a><span id="l2.4565" class="difflineminus">-        if (source != newBookmarkFolder.get())      cmdArray-&gt;AppendElement(kNC_BookmarkCommand_SetNewBookmarkFolder);</span>
<a href="#l2.4566"></a><span id="l2.4566" class="difflineminus">-        if (source != newSearchFolder.get())        cmdArray-&gt;AppendElement(kNC_BookmarkCommand_SetNewSearchFolder);</span>
<a href="#l2.4567"></a><span id="l2.4567" class="difflineminus">-        if (source != personalToolbarFolder.get())  cmdArray-&gt;AppendElement(kNC_BookmarkCommand_SetPersonalToolbarFolder);</span>
<a href="#l2.4568"></a><span id="l2.4568" class="difflineminus">-    }</span>
<a href="#l2.4569"></a><span id="l2.4569" class="difflineminus">-</span>
<a href="#l2.4570"></a><span id="l2.4570" class="difflineminus">-    // always append a separator last (due to aggregation of commands from multiple datasources)</span>
<a href="#l2.4571"></a><span id="l2.4571" class="difflineminus">-    cmdArray-&gt;AppendElement(kNC_BookmarkSeparator);</span>
<a href="#l2.4572"></a><span id="l2.4572" class="difflineminus">-</span>
<a href="#l2.4573"></a><span id="l2.4573" class="difflineminus">-    return NS_NewArrayEnumerator(commands, cmdArray);</span>
<a href="#l2.4574"></a><span id="l2.4574" class="difflineminus">-}</span>
<a href="#l2.4575"></a><span id="l2.4575" class="difflineminus">-</span>
<a href="#l2.4576"></a><span id="l2.4576" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l2.4577"></a><span id="l2.4577" class="difflineminus">-nsBookmarksService::IsCommandEnabled(nsISupportsArray/*&lt;nsIRDFResource&gt;*/* aSources,</span>
<a href="#l2.4578"></a><span id="l2.4578" class="difflineminus">-                                         nsIRDFResource*   aCommand,</span>
<a href="#l2.4579"></a><span id="l2.4579" class="difflineminus">-                                         nsISupportsArray/*&lt;nsIRDFResource&gt;*/* aArguments,</span>
<a href="#l2.4580"></a><span id="l2.4580" class="difflineminus">-                                         PRBool* aResult)</span>
<a href="#l2.4581"></a><span id="l2.4581" class="difflineminus">-{</span>
<a href="#l2.4582"></a><span id="l2.4582" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l2.4583"></a><span id="l2.4583" class="difflineminus">-}</span>
<a href="#l2.4584"></a><span id="l2.4584" class="difflineminus">-</span>
<a href="#l2.4585"></a><span id="l2.4585" class="difflineminus">-nsresult</span>
<a href="#l2.4586"></a><span id="l2.4586" class="difflineminus">-nsBookmarksService::getArgumentN(nsISupportsArray *arguments, nsIRDFResource *res,</span>
<a href="#l2.4587"></a><span id="l2.4587" class="difflineminus">-                PRInt32 offset, nsIRDFNode **argValue)</span>
<a href="#l2.4588"></a><span id="l2.4588" class="difflineminus">-{</span>
<a href="#l2.4589"></a><span id="l2.4589" class="difflineminus">-    nsresult        rv;</span>
<a href="#l2.4590"></a><span id="l2.4590" class="difflineminus">-    PRUint32        loop, numArguments;</span>
<a href="#l2.4591"></a><span id="l2.4591" class="difflineminus">-</span>
<a href="#l2.4592"></a><span id="l2.4592" class="difflineminus">-    *argValue = nsnull;</span>
<a href="#l2.4593"></a><span id="l2.4593" class="difflineminus">-</span>
<a href="#l2.4594"></a><span id="l2.4594" class="difflineminus">-    if (NS_FAILED(rv = arguments-&gt;Count(&amp;numArguments)))    return rv;</span>
<a href="#l2.4595"></a><span id="l2.4595" class="difflineminus">-</span>
<a href="#l2.4596"></a><span id="l2.4596" class="difflineminus">-    // format is argument, value, argument, value, ... [you get the idea]</span>
<a href="#l2.4597"></a><span id="l2.4597" class="difflineminus">-    // multiple arguments can be the same, by the way, thus the &quot;offset&quot;</span>
<a href="#l2.4598"></a><span id="l2.4598" class="difflineminus">-    for (loop = 0; loop &lt; numArguments; loop += 2)</span>
<a href="#l2.4599"></a><span id="l2.4599" class="difflineminus">-    {</span>
<a href="#l2.4600"></a><span id="l2.4600" class="difflineminus">-        nsCOMPtr&lt;nsIRDFResource&gt; src = do_QueryElementAt(arguments, loop, &amp;rv);</span>
<a href="#l2.4601"></a><span id="l2.4601" class="difflineminus">-        if (!src) return rv;</span>
<a href="#l2.4602"></a><span id="l2.4602" class="difflineminus">-        </span>
<a href="#l2.4603"></a><span id="l2.4603" class="difflineminus">-        if (src == res)</span>
<a href="#l2.4604"></a><span id="l2.4604" class="difflineminus">-        {</span>
<a href="#l2.4605"></a><span id="l2.4605" class="difflineminus">-            if (offset &gt; 0)</span>
<a href="#l2.4606"></a><span id="l2.4606" class="difflineminus">-            {</span>
<a href="#l2.4607"></a><span id="l2.4607" class="difflineminus">-                --offset;</span>
<a href="#l2.4608"></a><span id="l2.4608" class="difflineminus">-                continue;</span>
<a href="#l2.4609"></a><span id="l2.4609" class="difflineminus">-            }</span>
<a href="#l2.4610"></a><span id="l2.4610" class="difflineminus">-</span>
<a href="#l2.4611"></a><span id="l2.4611" class="difflineminus">-            nsCOMPtr&lt;nsIRDFNode&gt; val = do_QueryElementAt(arguments, loop + 1,</span>
<a href="#l2.4612"></a><span id="l2.4612" class="difflineminus">-                                                         &amp;rv);</span>
<a href="#l2.4613"></a><span id="l2.4613" class="difflineminus">-            if (!val) return rv;</span>
<a href="#l2.4614"></a><span id="l2.4614" class="difflineminus">-</span>
<a href="#l2.4615"></a><span id="l2.4615" class="difflineminus">-            *argValue = val;</span>
<a href="#l2.4616"></a><span id="l2.4616" class="difflineminus">-            NS_ADDREF(*argValue);</span>
<a href="#l2.4617"></a><span id="l2.4617" class="difflineminus">-            return NS_OK;</span>
<a href="#l2.4618"></a><span id="l2.4618" class="difflineminus">-        }</span>
<a href="#l2.4619"></a><span id="l2.4619" class="difflineminus">-    }</span>
<a href="#l2.4620"></a><span id="l2.4620" class="difflineminus">-    return NS_ERROR_INVALID_ARG;</span>
<a href="#l2.4621"></a><span id="l2.4621" class="difflineminus">-}</span>
<a href="#l2.4622"></a><span id="l2.4622" class="difflineminus">-</span>
<a href="#l2.4623"></a><span id="l2.4623" class="difflineminus">-/** </span>
<a href="#l2.4624"></a><span id="l2.4624" class="difflineminus">- * Inserts a bookmark item of the given type adjacent to the node specified </span>
<a href="#l2.4625"></a><span id="l2.4625" class="difflineminus">- * with aRelativeNode. Creation parameters are given in aArguments. </span>
<a href="#l2.4626"></a><span id="l2.4626" class="difflineminus">- */</span>
<a href="#l2.4627"></a><span id="l2.4627" class="difflineminus">-nsresult</span>
<a href="#l2.4628"></a><span id="l2.4628" class="difflineminus">-nsBookmarksService::insertBookmarkItem(nsIRDFResource *aRelativeNode, </span>
<a href="#l2.4629"></a><span id="l2.4629" class="difflineminus">-                                       nsISupportsArray *aArguments, </span>
<a href="#l2.4630"></a><span id="l2.4630" class="difflineminus">-                                       nsIRDFResource *aItemType)</span>
<a href="#l2.4631"></a><span id="l2.4631" class="difflineminus">-{</span>
<a href="#l2.4632"></a><span id="l2.4632" class="difflineminus">-    nsresult rv;</span>
<a href="#l2.4633"></a><span id="l2.4633" class="difflineminus">-    const PRInt32 kParentArgumentIndex = 0;</span>
<a href="#l2.4634"></a><span id="l2.4634" class="difflineminus">-  </span>
<a href="#l2.4635"></a><span id="l2.4635" class="difflineminus">-    nsCOMPtr&lt;nsIRDFResource&gt; rParent;</span>
<a href="#l2.4636"></a><span id="l2.4636" class="difflineminus">-</span>
<a href="#l2.4637"></a><span id="l2.4637" class="difflineminus">-    if (aRelativeNode == kNC_BookmarksRoot)</span>
<a href="#l2.4638"></a><span id="l2.4638" class="difflineminus">-        rParent = aRelativeNode;</span>
<a href="#l2.4639"></a><span id="l2.4639" class="difflineminus">-    else</span>
<a href="#l2.4640"></a><span id="l2.4640" class="difflineminus">-    {</span>
<a href="#l2.4641"></a><span id="l2.4641" class="difflineminus">-        nsCOMPtr&lt;nsIRDFNode&gt; parentNode;</span>
<a href="#l2.4642"></a><span id="l2.4642" class="difflineminus">-        rv = getArgumentN(aArguments, kNC_Parent, kParentArgumentIndex, getter_AddRefs(parentNode));</span>
<a href="#l2.4643"></a><span id="l2.4643" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l2.4644"></a><span id="l2.4644" class="difflineminus">-        rParent = do_QueryInterface(parentNode, &amp;rv);</span>
<a href="#l2.4645"></a><span id="l2.4645" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l2.4646"></a><span id="l2.4646" class="difflineminus">-    }</span>
<a href="#l2.4647"></a><span id="l2.4647" class="difflineminus">-</span>
<a href="#l2.4648"></a><span id="l2.4648" class="difflineminus">-    nsCOMPtr&lt;nsIRDFContainer&gt; container(do_CreateInstance(&quot;@mozilla.org/rdf/container;1&quot;, &amp;rv));</span>
<a href="#l2.4649"></a><span id="l2.4649" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l2.4650"></a><span id="l2.4650" class="difflineminus">-</span>
<a href="#l2.4651"></a><span id="l2.4651" class="difflineminus">-    rv = container-&gt;Init(this, rParent);</span>
<a href="#l2.4652"></a><span id="l2.4652" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l2.4653"></a><span id="l2.4653" class="difflineminus">-</span>
<a href="#l2.4654"></a><span id="l2.4654" class="difflineminus">-    PRInt32 relNodeIdx = 0;</span>
<a href="#l2.4655"></a><span id="l2.4655" class="difflineminus">-    if (aRelativeNode != kNC_BookmarksRoot) {</span>
<a href="#l2.4656"></a><span id="l2.4656" class="difflineminus">-        // Find the position of the relative node, so we can create this item </span>
<a href="#l2.4657"></a><span id="l2.4657" class="difflineminus">-        // adjacent to it.</span>
<a href="#l2.4658"></a><span id="l2.4658" class="difflineminus">-        rv = container-&gt;IndexOf(aRelativeNode, &amp;relNodeIdx);</span>
<a href="#l2.4659"></a><span id="l2.4659" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l2.4660"></a><span id="l2.4660" class="difflineminus">-</span>
<a href="#l2.4661"></a><span id="l2.4661" class="difflineminus">-        // If the item isn't in the container, just append to the container.</span>
<a href="#l2.4662"></a><span id="l2.4662" class="difflineminus">-        if (relNodeIdx == -1) {</span>
<a href="#l2.4663"></a><span id="l2.4663" class="difflineminus">-            rv = container-&gt;GetCount(&amp;relNodeIdx);</span>
<a href="#l2.4664"></a><span id="l2.4664" class="difflineminus">-            if (NS_FAILED(rv)) return rv;</span>
<a href="#l2.4665"></a><span id="l2.4665" class="difflineminus">-        }</span>
<a href="#l2.4666"></a><span id="l2.4666" class="difflineminus">-    }</span>
<a href="#l2.4667"></a><span id="l2.4667" class="difflineminus">-</span>
<a href="#l2.4668"></a><span id="l2.4668" class="difflineminus">-    nsAutoString itemName;</span>
<a href="#l2.4669"></a><span id="l2.4669" class="difflineminus">-  </span>
<a href="#l2.4670"></a><span id="l2.4670" class="difflineminus">-    // If a creation name was supplied, use it. </span>
<a href="#l2.4671"></a><span id="l2.4671" class="difflineminus">-    if (aItemType == kNC_Bookmark || aItemType == kNC_Folder) {</span>
<a href="#l2.4672"></a><span id="l2.4672" class="difflineminus">-        nsCOMPtr&lt;nsIRDFNode&gt; nameNode;</span>
<a href="#l2.4673"></a><span id="l2.4673" class="difflineminus">-        getArgumentN(aArguments, kNC_Name, kParentArgumentIndex, getter_AddRefs(nameNode));</span>
<a href="#l2.4674"></a><span id="l2.4674" class="difflineminus">-        nsCOMPtr&lt;nsIRDFLiteral&gt; nameLiteral;</span>
<a href="#l2.4675"></a><span id="l2.4675" class="difflineminus">-        nameLiteral = do_QueryInterface(nameNode);</span>
<a href="#l2.4676"></a><span id="l2.4676" class="difflineminus">-        if (nameLiteral) {</span>
<a href="#l2.4677"></a><span id="l2.4677" class="difflineminus">-            const PRUnichar* uName = nsnull;</span>
<a href="#l2.4678"></a><span id="l2.4678" class="difflineminus">-            nameLiteral-&gt;GetValueConst(&amp;uName);</span>
<a href="#l2.4679"></a><span id="l2.4679" class="difflineminus">-            if (uName) </span>
<a href="#l2.4680"></a><span id="l2.4680" class="difflineminus">-                itemName = uName;</span>
<a href="#l2.4681"></a><span id="l2.4681" class="difflineminus">-        }</span>
<a href="#l2.4682"></a><span id="l2.4682" class="difflineminus">-    }</span>
<a href="#l2.4683"></a><span id="l2.4683" class="difflineminus">-</span>
<a href="#l2.4684"></a><span id="l2.4684" class="difflineminus">-    if (itemName.IsEmpty())</span>
<a href="#l2.4685"></a><span id="l2.4685" class="difflineminus">-    {</span>
<a href="#l2.4686"></a><span id="l2.4686" class="difflineminus">-        // Retrieve a default name from the bookmark properties file.</span>
<a href="#l2.4687"></a><span id="l2.4687" class="difflineminus">-        if (aItemType == kNC_Bookmark) </span>
<a href="#l2.4688"></a><span id="l2.4688" class="difflineminus">-            getLocaleString(&quot;NewBookmark&quot;, itemName);</span>
<a href="#l2.4689"></a><span id="l2.4689" class="difflineminus">-        else if (aItemType == kNC_Folder) </span>
<a href="#l2.4690"></a><span id="l2.4690" class="difflineminus">-            getLocaleString(&quot;NewFolder&quot;, itemName);</span>
<a href="#l2.4691"></a><span id="l2.4691" class="difflineminus">-    }</span>
<a href="#l2.4692"></a><span id="l2.4692" class="difflineminus">-</span>
<a href="#l2.4693"></a><span id="l2.4693" class="difflineminus">-    nsCOMPtr&lt;nsIRDFResource&gt; newResource;</span>
<a href="#l2.4694"></a><span id="l2.4694" class="difflineminus">-  </span>
<a href="#l2.4695"></a><span id="l2.4695" class="difflineminus">-    // Retrieve the URL from the arguments list. </span>
<a href="#l2.4696"></a><span id="l2.4696" class="difflineminus">-    if (aItemType == kNC_Bookmark || aItemType == kNC_Folder)</span>
<a href="#l2.4697"></a><span id="l2.4697" class="difflineminus">-    {</span>
<a href="#l2.4698"></a><span id="l2.4698" class="difflineminus">-        nsCOMPtr&lt;nsIRDFNode&gt; urlNode;</span>
<a href="#l2.4699"></a><span id="l2.4699" class="difflineminus">-        getArgumentN(aArguments, kNC_URL, kParentArgumentIndex, getter_AddRefs(urlNode));</span>
<a href="#l2.4700"></a><span id="l2.4700" class="difflineminus">-        nsCOMPtr&lt;nsIRDFLiteral&gt; bookmarkURILiteral(do_QueryInterface(urlNode));</span>
<a href="#l2.4701"></a><span id="l2.4701" class="difflineminus">-        if (bookmarkURILiteral)</span>
<a href="#l2.4702"></a><span id="l2.4702" class="difflineminus">-        {</span>
<a href="#l2.4703"></a><span id="l2.4703" class="difflineminus">-            const PRUnichar* uURL = nsnull;</span>
<a href="#l2.4704"></a><span id="l2.4704" class="difflineminus">-            bookmarkURILiteral-&gt;GetValueConst(&amp;uURL);</span>
<a href="#l2.4705"></a><span id="l2.4705" class="difflineminus">-            if (uURL)</span>
<a href="#l2.4706"></a><span id="l2.4706" class="difflineminus">-            {</span>
<a href="#l2.4707"></a><span id="l2.4707" class="difflineminus">-                rv = gRDF-&gt;GetUnicodeResource(nsDependentString(uURL), getter_AddRefs(newResource));</span>
<a href="#l2.4708"></a><span id="l2.4708" class="difflineminus">-                if (NS_FAILED(rv)) return rv;</span>
<a href="#l2.4709"></a><span id="l2.4709" class="difflineminus">-            }</span>
<a href="#l2.4710"></a><span id="l2.4710" class="difflineminus">-        }</span>
<a href="#l2.4711"></a><span id="l2.4711" class="difflineminus">-    }</span>
<a href="#l2.4712"></a><span id="l2.4712" class="difflineminus">-</span>
<a href="#l2.4713"></a><span id="l2.4713" class="difflineminus">-    if (!newResource)</span>
<a href="#l2.4714"></a><span id="l2.4714" class="difflineminus">-    {</span>
<a href="#l2.4715"></a><span id="l2.4715" class="difflineminus">-        // We're a folder, or some other type of anonymous resource.</span>
<a href="#l2.4716"></a><span id="l2.4716" class="difflineminus">-        rv = gRDF-&gt;GetAnonymousResource(getter_AddRefs(newResource));</span>
<a href="#l2.4717"></a><span id="l2.4717" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l2.4718"></a><span id="l2.4718" class="difflineminus">-    }</span>
<a href="#l2.4719"></a><span id="l2.4719" class="difflineminus">-</span>
<a href="#l2.4720"></a><span id="l2.4720" class="difflineminus">-    if (aItemType == kNC_Folder)</span>
<a href="#l2.4721"></a><span id="l2.4721" class="difflineminus">-    {</span>
<a href="#l2.4722"></a><span id="l2.4722" class="difflineminus">-        // Make Sequences for Folders.</span>
<a href="#l2.4723"></a><span id="l2.4723" class="difflineminus">-        rv = gRDFC-&gt;MakeSeq(mInner, newResource, nsnull);</span>
<a href="#l2.4724"></a><span id="l2.4724" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l2.4725"></a><span id="l2.4725" class="difflineminus">-    }</span>
<a href="#l2.4726"></a><span id="l2.4726" class="difflineminus">-</span>
<a href="#l2.4727"></a><span id="l2.4727" class="difflineminus">-    // Assert Name arc</span>
<a href="#l2.4728"></a><span id="l2.4728" class="difflineminus">-    if (!itemName.IsEmpty())</span>
<a href="#l2.4729"></a><span id="l2.4729" class="difflineminus">-    {</span>
<a href="#l2.4730"></a><span id="l2.4730" class="difflineminus">-        nsCOMPtr&lt;nsIRDFLiteral&gt; nameLiteral;</span>
<a href="#l2.4731"></a><span id="l2.4731" class="difflineminus">-        rv = gRDF-&gt;GetLiteral(itemName.get(), getter_AddRefs(nameLiteral));</span>
<a href="#l2.4732"></a><span id="l2.4732" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l2.4733"></a><span id="l2.4733" class="difflineminus">-        rv = mInner-&gt;Assert(newResource, kNC_Name, nameLiteral, PR_TRUE);</span>
<a href="#l2.4734"></a><span id="l2.4734" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l2.4735"></a><span id="l2.4735" class="difflineminus">-    }</span>
<a href="#l2.4736"></a><span id="l2.4736" class="difflineminus">-</span>
<a href="#l2.4737"></a><span id="l2.4737" class="difflineminus">-    // Assert type arc</span>
<a href="#l2.4738"></a><span id="l2.4738" class="difflineminus">-    rv = mInner-&gt;Assert(newResource, kRDF_type, aItemType, PR_TRUE);</span>
<a href="#l2.4739"></a><span id="l2.4739" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l2.4740"></a><span id="l2.4740" class="difflineminus">-</span>
<a href="#l2.4741"></a><span id="l2.4741" class="difflineminus">-    // XXX - investigate asserting date as a resource with a raw date value for</span>
<a href="#l2.4742"></a><span id="l2.4742" class="difflineminus">-    //       lookup, and a Name arc with a pretty display name, e.g. &quot;Saturday&quot;</span>
<a href="#l2.4743"></a><span id="l2.4743" class="difflineminus">-  </span>
<a href="#l2.4744"></a><span id="l2.4744" class="difflineminus">-    // Convert the current date/time from microseconds (PRTime) to seconds.</span>
<a href="#l2.4745"></a><span id="l2.4745" class="difflineminus">-    nsCOMPtr&lt;nsIRDFDate&gt; dateLiteral;</span>
<a href="#l2.4746"></a><span id="l2.4746" class="difflineminus">-    rv = gRDF-&gt;GetDateLiteral(PR_Now(), getter_AddRefs(dateLiteral));</span>
<a href="#l2.4747"></a><span id="l2.4747" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l2.4748"></a><span id="l2.4748" class="difflineminus">-    rv = mInner-&gt;Assert(newResource, kNC_BookmarkAddDate, dateLiteral, PR_TRUE);</span>
<a href="#l2.4749"></a><span id="l2.4749" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l2.4750"></a><span id="l2.4750" class="difflineminus">-</span>
<a href="#l2.4751"></a><span id="l2.4751" class="difflineminus">-    // Add to container. </span>
<a href="#l2.4752"></a><span id="l2.4752" class="difflineminus">-    rv = container-&gt;InsertElementAt(newResource, !relNodeIdx ? 1 : relNodeIdx, PR_TRUE);</span>
<a href="#l2.4753"></a><span id="l2.4753" class="difflineminus">-  </span>
<a href="#l2.4754"></a><span id="l2.4754" class="difflineminus">-    return rv;</span>
<a href="#l2.4755"></a><span id="l2.4755" class="difflineminus">-}</span>
<a href="#l2.4756"></a><span id="l2.4756" class="difflineminus">-</span>
<a href="#l2.4757"></a><span id="l2.4757" class="difflineminus">-nsresult</span>
<a href="#l2.4758"></a><span id="l2.4758" class="difflineminus">-nsBookmarksService::deleteBookmarkItem(nsIRDFResource *src,</span>
<a href="#l2.4759"></a><span id="l2.4759" class="difflineminus">-                                       nsISupportsArray *aArguments,</span>
<a href="#l2.4760"></a><span id="l2.4760" class="difflineminus">-                                       PRInt32 parentArgIndex)</span>
<a href="#l2.4761"></a><span id="l2.4761" class="difflineminus">-{</span>
<a href="#l2.4762"></a><span id="l2.4762" class="difflineminus">-    nsresult            rv;</span>
<a href="#l2.4763"></a><span id="l2.4763" class="difflineminus">-</span>
<a href="#l2.4764"></a><span id="l2.4764" class="difflineminus">-    nsCOMPtr&lt;nsIRDFNode&gt;        aNode;</span>
<a href="#l2.4765"></a><span id="l2.4765" class="difflineminus">-    if (NS_FAILED(rv = getArgumentN(aArguments, kNC_Parent,</span>
<a href="#l2.4766"></a><span id="l2.4766" class="difflineminus">-            parentArgIndex, getter_AddRefs(aNode))))</span>
<a href="#l2.4767"></a><span id="l2.4767" class="difflineminus">-        return rv;</span>
<a href="#l2.4768"></a><span id="l2.4768" class="difflineminus">-    nsCOMPtr&lt;nsIRDFResource&gt;    argParent = do_QueryInterface(aNode);</span>
<a href="#l2.4769"></a><span id="l2.4769" class="difflineminus">-    if (!argParent) return NS_ERROR_NO_INTERFACE;</span>
<a href="#l2.4770"></a><span id="l2.4770" class="difflineminus">-</span>
<a href="#l2.4771"></a><span id="l2.4771" class="difflineminus">-    nsCOMPtr&lt;nsIRDFContainer&gt; container =</span>
<a href="#l2.4772"></a><span id="l2.4772" class="difflineminus">-            do_CreateInstance(kRDFContainerCID, &amp;rv);</span>
<a href="#l2.4773"></a><span id="l2.4773" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l2.4774"></a><span id="l2.4774" class="difflineminus">-        return rv;</span>
<a href="#l2.4775"></a><span id="l2.4775" class="difflineminus">-    if (NS_FAILED(rv = container-&gt;Init(this, argParent)))</span>
<a href="#l2.4776"></a><span id="l2.4776" class="difflineminus">-        return rv;</span>
<a href="#l2.4777"></a><span id="l2.4777" class="difflineminus">-</span>
<a href="#l2.4778"></a><span id="l2.4778" class="difflineminus">-    if (NS_FAILED(rv = container-&gt;RemoveElement(src, PR_TRUE)))</span>
<a href="#l2.4779"></a><span id="l2.4779" class="difflineminus">-        return rv;</span>
<a href="#l2.4780"></a><span id="l2.4780" class="difflineminus">-</span>
<a href="#l2.4781"></a><span id="l2.4781" class="difflineminus">-    return rv;</span>
<a href="#l2.4782"></a><span id="l2.4782" class="difflineminus">-}</span>
<a href="#l2.4783"></a><span id="l2.4783" class="difflineminus">-</span>
<a href="#l2.4784"></a><span id="l2.4784" class="difflineminus">-nsresult</span>
<a href="#l2.4785"></a><span id="l2.4785" class="difflineminus">-nsBookmarksService::setFolderHint(nsIRDFResource *newSource, nsIRDFResource *objType)</span>
<a href="#l2.4786"></a><span id="l2.4786" class="difflineminus">-{</span>
<a href="#l2.4787"></a><span id="l2.4787" class="difflineminus">-    nsresult            rv;</span>
<a href="#l2.4788"></a><span id="l2.4788" class="difflineminus">-    nsCOMPtr&lt;nsISimpleEnumerator&gt;   srcList;</span>
<a href="#l2.4789"></a><span id="l2.4789" class="difflineminus">-    if (NS_FAILED(rv = GetSources(kNC_FolderType, objType, PR_TRUE, getter_AddRefs(srcList))))</span>
<a href="#l2.4790"></a><span id="l2.4790" class="difflineminus">-        return rv;</span>
<a href="#l2.4791"></a><span id="l2.4791" class="difflineminus">-</span>
<a href="#l2.4792"></a><span id="l2.4792" class="difflineminus">-    PRBool  hasMoreSrcs = PR_TRUE;</span>
<a href="#l2.4793"></a><span id="l2.4793" class="difflineminus">-    while(NS_SUCCEEDED(rv = srcList-&gt;HasMoreElements(&amp;hasMoreSrcs))</span>
<a href="#l2.4794"></a><span id="l2.4794" class="difflineminus">-        &amp;&amp; (hasMoreSrcs == PR_TRUE))</span>
<a href="#l2.4795"></a><span id="l2.4795" class="difflineminus">-    {</span>
<a href="#l2.4796"></a><span id="l2.4796" class="difflineminus">-        nsCOMPtr&lt;nsISupports&gt;   aSrc;</span>
<a href="#l2.4797"></a><span id="l2.4797" class="difflineminus">-        if (NS_FAILED(rv = srcList-&gt;GetNext(getter_AddRefs(aSrc))))</span>
<a href="#l2.4798"></a><span id="l2.4798" class="difflineminus">-            break;</span>
<a href="#l2.4799"></a><span id="l2.4799" class="difflineminus">-        nsCOMPtr&lt;nsIRDFResource&gt;    aSource = do_QueryInterface(aSrc);</span>
<a href="#l2.4800"></a><span id="l2.4800" class="difflineminus">-        if (!aSource)   continue;</span>
<a href="#l2.4801"></a><span id="l2.4801" class="difflineminus">-</span>
<a href="#l2.4802"></a><span id="l2.4802" class="difflineminus">-        // if folder is already marked, nothing left to do</span>
<a href="#l2.4803"></a><span id="l2.4803" class="difflineminus">-        if (aSource.get() == newSource)   return NS_OK;</span>
<a href="#l2.4804"></a><span id="l2.4804" class="difflineminus">-</span>
<a href="#l2.4805"></a><span id="l2.4805" class="difflineminus">-        if (NS_FAILED(rv = mInner-&gt;Unassert(aSource, kNC_FolderType, objType)))</span>
<a href="#l2.4806"></a><span id="l2.4806" class="difflineminus">-            continue;</span>
<a href="#l2.4807"></a><span id="l2.4807" class="difflineminus">-    }</span>
<a href="#l2.4808"></a><span id="l2.4808" class="difflineminus">-</span>
<a href="#l2.4809"></a><span id="l2.4809" class="difflineminus">-    // If not setting a new Personal Toolbar Folder, just assert new type, and</span>
<a href="#l2.4810"></a><span id="l2.4810" class="difflineminus">-    // then done.</span>
<a href="#l2.4811"></a><span id="l2.4811" class="difflineminus">-    if (objType != kNC_PersonalToolbarFolder) {</span>
<a href="#l2.4812"></a><span id="l2.4812" class="difflineminus">-        rv = mInner-&gt;Assert(newSource, kNC_FolderType, objType, PR_TRUE);</span>
<a href="#l2.4813"></a><span id="l2.4813" class="difflineminus">-</span>
<a href="#l2.4814"></a><span id="l2.4814" class="difflineminus">-        mDirty = PR_TRUE;</span>
<a href="#l2.4815"></a><span id="l2.4815" class="difflineminus">-        return rv;</span>
<a href="#l2.4816"></a><span id="l2.4816" class="difflineminus">-    }</span>
<a href="#l2.4817"></a><span id="l2.4817" class="difflineminus">-</span>
<a href="#l2.4818"></a><span id="l2.4818" class="difflineminus">-    // If setting a new Personal Toolbar Folder, we need to work some magic!</span>
<a href="#l2.4819"></a><span id="l2.4819" class="difflineminus">-    BeginUpdateBatch();</span>
<a href="#l2.4820"></a><span id="l2.4820" class="difflineminus">-    rv = SetNewPersonalToolbarFolder(newSource);</span>
<a href="#l2.4821"></a><span id="l2.4821" class="difflineminus">-    EndUpdateBatch();</span>
<a href="#l2.4822"></a><span id="l2.4822" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l2.4823"></a><span id="l2.4823" class="difflineminus">-        return rv;</span>
<a href="#l2.4824"></a><span id="l2.4824" class="difflineminus">-</span>
<a href="#l2.4825"></a><span id="l2.4825" class="difflineminus">-    rv = mInner-&gt;Assert(kNC_PersonalToolbarFolder, kNC_FolderType, objType, PR_TRUE);</span>
<a href="#l2.4826"></a><span id="l2.4826" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l2.4827"></a><span id="l2.4827" class="difflineminus">-        return rv;</span>
<a href="#l2.4828"></a><span id="l2.4828" class="difflineminus">-</span>
<a href="#l2.4829"></a><span id="l2.4829" class="difflineminus">-    mDirty = PR_TRUE;</span>
<a href="#l2.4830"></a><span id="l2.4830" class="difflineminus">-</span>
<a href="#l2.4831"></a><span id="l2.4831" class="difflineminus">-    return NS_OK;</span>
<a href="#l2.4832"></a><span id="l2.4832" class="difflineminus">-}</span>
<a href="#l2.4833"></a><span id="l2.4833" class="difflineminus">-</span>
<a href="#l2.4834"></a><span id="l2.4834" class="difflineminus">-nsresult</span>
<a href="#l2.4835"></a><span id="l2.4835" class="difflineminus">-nsBookmarksService::getFolderViaHint(nsIRDFResource *objType, PRBool fallbackFlag, nsIRDFResource **folder)</span>
<a href="#l2.4836"></a><span id="l2.4836" class="difflineminus">-{</span>
<a href="#l2.4837"></a><span id="l2.4837" class="difflineminus">-    if (!folder)    return NS_ERROR_UNEXPECTED;</span>
<a href="#l2.4838"></a><span id="l2.4838" class="difflineminus">-    *folder = nsnull;</span>
<a href="#l2.4839"></a><span id="l2.4839" class="difflineminus">-    if (!objType)   return NS_ERROR_UNEXPECTED;</span>
<a href="#l2.4840"></a><span id="l2.4840" class="difflineminus">-</span>
<a href="#l2.4841"></a><span id="l2.4841" class="difflineminus">-    nsresult            rv;</span>
<a href="#l2.4842"></a><span id="l2.4842" class="difflineminus">-    nsCOMPtr&lt;nsIRDFResource&gt;    oldSource;</span>
<a href="#l2.4843"></a><span id="l2.4843" class="difflineminus">-    if (NS_FAILED(rv = mInner-&gt;GetSource(kNC_FolderType, objType, PR_TRUE, getter_AddRefs(oldSource))))</span>
<a href="#l2.4844"></a><span id="l2.4844" class="difflineminus">-        return rv;</span>
<a href="#l2.4845"></a><span id="l2.4845" class="difflineminus">-</span>
<a href="#l2.4846"></a><span id="l2.4846" class="difflineminus">-    if ((rv != NS_RDF_NO_VALUE) &amp;&amp; (oldSource))</span>
<a href="#l2.4847"></a><span id="l2.4847" class="difflineminus">-    {</span>
<a href="#l2.4848"></a><span id="l2.4848" class="difflineminus">-        PRBool isBookmarkedFlag = PR_FALSE;</span>
<a href="#l2.4849"></a><span id="l2.4849" class="difflineminus">-        if (NS_SUCCEEDED(rv = IsBookmarkedResource(oldSource, &amp;isBookmarkedFlag)) &amp;&amp;</span>
<a href="#l2.4850"></a><span id="l2.4850" class="difflineminus">-            isBookmarkedFlag) {</span>
<a href="#l2.4851"></a><span id="l2.4851" class="difflineminus">-            *folder = oldSource;</span>
<a href="#l2.4852"></a><span id="l2.4852" class="difflineminus">-        }</span>
<a href="#l2.4853"></a><span id="l2.4853" class="difflineminus">-    }</span>
<a href="#l2.4854"></a><span id="l2.4854" class="difflineminus">-</span>
<a href="#l2.4855"></a><span id="l2.4855" class="difflineminus">-    // if we couldn't find a real &quot;New Internet Search Folder&quot;, fallback to looking for</span>
<a href="#l2.4856"></a><span id="l2.4856" class="difflineminus">-    // a &quot;New Bookmark Folder&quot;, and if can't find that, then default to the bookmarks root</span>
<a href="#l2.4857"></a><span id="l2.4857" class="difflineminus">-    if ((!(*folder)) &amp;&amp; (fallbackFlag == PR_TRUE) &amp;&amp; (objType == kNC_NewSearchFolder))</span>
<a href="#l2.4858"></a><span id="l2.4858" class="difflineminus">-    {</span>
<a href="#l2.4859"></a><span id="l2.4859" class="difflineminus">-        rv = getFolderViaHint(kNC_NewBookmarkFolder, fallbackFlag, folder);</span>
<a href="#l2.4860"></a><span id="l2.4860" class="difflineminus">-    }</span>
<a href="#l2.4861"></a><span id="l2.4861" class="difflineminus">-</span>
<a href="#l2.4862"></a><span id="l2.4862" class="difflineminus">-    if (!(*folder))</span>
<a href="#l2.4863"></a><span id="l2.4863" class="difflineminus">-    {</span>
<a href="#l2.4864"></a><span id="l2.4864" class="difflineminus">-        // fallback to some well-known defaults</span>
<a href="#l2.4865"></a><span id="l2.4865" class="difflineminus">-        if (objType == kNC_NewBookmarkFolder || objType == kNC_NewSearchFolder)</span>
<a href="#l2.4866"></a><span id="l2.4866" class="difflineminus">-        {</span>
<a href="#l2.4867"></a><span id="l2.4867" class="difflineminus">-            *folder = kNC_BookmarksRoot;</span>
<a href="#l2.4868"></a><span id="l2.4868" class="difflineminus">-        }</span>
<a href="#l2.4869"></a><span id="l2.4869" class="difflineminus">-        else if (objType == kNC_PersonalToolbarFolder)</span>
<a href="#l2.4870"></a><span id="l2.4870" class="difflineminus">-        {</span>
<a href="#l2.4871"></a><span id="l2.4871" class="difflineminus">-            *folder = kNC_PersonalToolbarFolder;</span>
<a href="#l2.4872"></a><span id="l2.4872" class="difflineminus">-        }</span>
<a href="#l2.4873"></a><span id="l2.4873" class="difflineminus">-    }</span>
<a href="#l2.4874"></a><span id="l2.4874" class="difflineminus">-</span>
<a href="#l2.4875"></a><span id="l2.4875" class="difflineminus">-    NS_IF_ADDREF(*folder);</span>
<a href="#l2.4876"></a><span id="l2.4876" class="difflineminus">-</span>
<a href="#l2.4877"></a><span id="l2.4877" class="difflineminus">-    return NS_OK;</span>
<a href="#l2.4878"></a><span id="l2.4878" class="difflineminus">-}</span>
<a href="#l2.4879"></a><span id="l2.4879" class="difflineminus">-</span>
<a href="#l2.4880"></a><span id="l2.4880" class="difflineminus">-nsresult</span>
<a href="#l2.4881"></a><span id="l2.4881" class="difflineminus">-nsBookmarksService::importBookmarks(nsISupportsArray *aArguments)</span>
<a href="#l2.4882"></a><span id="l2.4882" class="difflineminus">-{</span>
<a href="#l2.4883"></a><span id="l2.4883" class="difflineminus">-    // look for #URL which is the file path to import</span>
<a href="#l2.4884"></a><span id="l2.4884" class="difflineminus">-    nsresult rv;</span>
<a href="#l2.4885"></a><span id="l2.4885" class="difflineminus">-    nsCOMPtr&lt;nsIRDFNode&gt; aNode;</span>
<a href="#l2.4886"></a><span id="l2.4886" class="difflineminus">-    rv = getArgumentN(aArguments, kNC_URL, 0, getter_AddRefs(aNode));</span>
<a href="#l2.4887"></a><span id="l2.4887" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.4888"></a><span id="l2.4888" class="difflineminus">-    nsCOMPtr&lt;nsIRDFLiteral&gt; pathLiteral = do_QueryInterface(aNode, &amp;rv);</span>
<a href="#l2.4889"></a><span id="l2.4889" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, NS_ERROR_NO_INTERFACE);</span>
<a href="#l2.4890"></a><span id="l2.4890" class="difflineminus">-    const PRUnichar *pathUni = nsnull;</span>
<a href="#l2.4891"></a><span id="l2.4891" class="difflineminus">-    pathLiteral-&gt;GetValueConst(&amp;pathUni);</span>
<a href="#l2.4892"></a><span id="l2.4892" class="difflineminus">-    NS_ENSURE_TRUE(pathUni, NS_ERROR_NULL_POINTER);</span>
<a href="#l2.4893"></a><span id="l2.4893" class="difflineminus">-</span>
<a href="#l2.4894"></a><span id="l2.4894" class="difflineminus">-    nsCOMPtr&lt;nsILocalFile&gt; file;</span>
<a href="#l2.4895"></a><span id="l2.4895" class="difflineminus">-    rv = NS_NewLocalFile(nsDependentString(pathUni), PR_TRUE, getter_AddRefs(file));</span>
<a href="#l2.4896"></a><span id="l2.4896" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.4897"></a><span id="l2.4897" class="difflineminus">-    PRBool isFile;</span>
<a href="#l2.4898"></a><span id="l2.4898" class="difflineminus">-    rv = file-&gt;IsFile(&amp;isFile);</span>
<a href="#l2.4899"></a><span id="l2.4899" class="difflineminus">-    NS_ENSURE_TRUE(NS_SUCCEEDED(rv) &amp;&amp; isFile, NS_ERROR_UNEXPECTED);</span>
<a href="#l2.4900"></a><span id="l2.4900" class="difflineminus">-</span>
<a href="#l2.4901"></a><span id="l2.4901" class="difflineminus">-    // figure out where to add the imported bookmarks</span>
<a href="#l2.4902"></a><span id="l2.4902" class="difflineminus">-    nsCOMPtr&lt;nsIRDFResource&gt; newBookmarkFolder;</span>
<a href="#l2.4903"></a><span id="l2.4903" class="difflineminus">-    rv = getFolderViaHint(kNC_NewBookmarkFolder, PR_TRUE, </span>
<a href="#l2.4904"></a><span id="l2.4904" class="difflineminus">-                          getter_AddRefs(newBookmarkFolder));</span>
<a href="#l2.4905"></a><span id="l2.4905" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.4906"></a><span id="l2.4906" class="difflineminus">-</span>
<a href="#l2.4907"></a><span id="l2.4907" class="difflineminus">-    // read 'em in</span>
<a href="#l2.4908"></a><span id="l2.4908" class="difflineminus">-    BookmarkParser parser;</span>
<a href="#l2.4909"></a><span id="l2.4909" class="difflineminus">-    parser.Init(file, mInner, PR_TRUE);</span>
<a href="#l2.4910"></a><span id="l2.4910" class="difflineminus">-</span>
<a href="#l2.4911"></a><span id="l2.4911" class="difflineminus">-    // Note: can't Begin|EndUpdateBatch() this as notifications are required</span>
<a href="#l2.4912"></a><span id="l2.4912" class="difflineminus">-    parser.Parse(newBookmarkFolder, kNC_Bookmark);</span>
<a href="#l2.4913"></a><span id="l2.4913" class="difflineminus">-</span>
<a href="#l2.4914"></a><span id="l2.4914" class="difflineminus">-    return NS_OK;</span>
<a href="#l2.4915"></a><span id="l2.4915" class="difflineminus">-}</span>
<a href="#l2.4916"></a><span id="l2.4916" class="difflineminus">-</span>
<a href="#l2.4917"></a><span id="l2.4917" class="difflineminus">-nsresult</span>
<a href="#l2.4918"></a><span id="l2.4918" class="difflineminus">-nsBookmarksService::exportBookmarks(nsISupportsArray *aArguments)</span>
<a href="#l2.4919"></a><span id="l2.4919" class="difflineminus">-{</span>
<a href="#l2.4920"></a><span id="l2.4920" class="difflineminus">-    // look for #URL which is the file path to export</span>
<a href="#l2.4921"></a><span id="l2.4921" class="difflineminus">-    nsCOMPtr&lt;nsIRDFNode&gt; node;</span>
<a href="#l2.4922"></a><span id="l2.4922" class="difflineminus">-    nsresult rv = getArgumentN(aArguments, kNC_URL, 0, getter_AddRefs(node));</span>
<a href="#l2.4923"></a><span id="l2.4923" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.4924"></a><span id="l2.4924" class="difflineminus">-    nsCOMPtr&lt;nsIRDFLiteral&gt; literal = do_QueryInterface(node, &amp;rv);</span>
<a href="#l2.4925"></a><span id="l2.4925" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, NS_ERROR_NO_INTERFACE);</span>
<a href="#l2.4926"></a><span id="l2.4926" class="difflineminus">-    const PRUnichar* pathUni = nsnull;</span>
<a href="#l2.4927"></a><span id="l2.4927" class="difflineminus">-    literal-&gt;GetValueConst(&amp;pathUni);</span>
<a href="#l2.4928"></a><span id="l2.4928" class="difflineminus">-    NS_ENSURE_TRUE(pathUni, NS_ERROR_NULL_POINTER);</span>
<a href="#l2.4929"></a><span id="l2.4929" class="difflineminus">-</span>
<a href="#l2.4930"></a><span id="l2.4930" class="difflineminus">-    // determine file type to export; default to HTML unless told otherwise</span>
<a href="#l2.4931"></a><span id="l2.4931" class="difflineminus">-    const PRUnichar* format = EmptyString().get();</span>
<a href="#l2.4932"></a><span id="l2.4932" class="difflineminus">-    rv = getArgumentN(aArguments, kRDF_type, 0, getter_AddRefs(node));</span>
<a href="#l2.4933"></a><span id="l2.4933" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l2.4934"></a><span id="l2.4934" class="difflineminus">-    {</span>
<a href="#l2.4935"></a><span id="l2.4935" class="difflineminus">-        literal = do_QueryInterface(node, &amp;rv);</span>
<a href="#l2.4936"></a><span id="l2.4936" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, NS_ERROR_NO_INTERFACE);</span>
<a href="#l2.4937"></a><span id="l2.4937" class="difflineminus">-        literal-&gt;GetValueConst(&amp;format);</span>
<a href="#l2.4938"></a><span id="l2.4938" class="difflineminus">-        NS_ENSURE_TRUE(format, NS_ERROR_NULL_POINTER);</span>
<a href="#l2.4939"></a><span id="l2.4939" class="difflineminus">-    }</span>
<a href="#l2.4940"></a><span id="l2.4940" class="difflineminus">-</span>
<a href="#l2.4941"></a><span id="l2.4941" class="difflineminus">-    nsCOMPtr&lt;nsILocalFile&gt; file;</span>
<a href="#l2.4942"></a><span id="l2.4942" class="difflineminus">-    rv = NS_NewLocalFile(nsDependentString(pathUni), PR_TRUE, getter_AddRefs(file));</span>
<a href="#l2.4943"></a><span id="l2.4943" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.4944"></a><span id="l2.4944" class="difflineminus">-</span>
<a href="#l2.4945"></a><span id="l2.4945" class="difflineminus">-    if (NS_LITERAL_STRING(&quot;RDF&quot;).Equals(format, CaseInsensitiveCompare))</span>
<a href="#l2.4946"></a><span id="l2.4946" class="difflineminus">-    {</span>
<a href="#l2.4947"></a><span id="l2.4947" class="difflineminus">-        nsCOMPtr&lt;nsIURI&gt; uri;</span>
<a href="#l2.4948"></a><span id="l2.4948" class="difflineminus">-        nsresult rv = NS_NewFileURI(getter_AddRefs(uri), file);</span>
<a href="#l2.4949"></a><span id="l2.4949" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.4950"></a><span id="l2.4950" class="difflineminus">-</span>
<a href="#l2.4951"></a><span id="l2.4951" class="difflineminus">-        rv = SerializeBookmarks(uri);</span>
<a href="#l2.4952"></a><span id="l2.4952" class="difflineminus">-    }</span>
<a href="#l2.4953"></a><span id="l2.4953" class="difflineminus">-    else</span>
<a href="#l2.4954"></a><span id="l2.4954" class="difflineminus">-    {</span>
<a href="#l2.4955"></a><span id="l2.4955" class="difflineminus">-        // write 'em out</span>
<a href="#l2.4956"></a><span id="l2.4956" class="difflineminus">-        rv = WriteBookmarks(file, mInner, kNC_BookmarksRoot);</span>
<a href="#l2.4957"></a><span id="l2.4957" class="difflineminus">-    }</span>
<a href="#l2.4958"></a><span id="l2.4958" class="difflineminus">-</span>
<a href="#l2.4959"></a><span id="l2.4959" class="difflineminus">-    return rv;</span>
<a href="#l2.4960"></a><span id="l2.4960" class="difflineminus">-}</span>
<a href="#l2.4961"></a><span id="l2.4961" class="difflineminus">-</span>
<a href="#l2.4962"></a><span id="l2.4962" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l2.4963"></a><span id="l2.4963" class="difflineminus">-nsBookmarksService::DoCommand(nsISupportsArray *aSources, nsIRDFResource *aCommand,</span>
<a href="#l2.4964"></a><span id="l2.4964" class="difflineminus">-                nsISupportsArray *aArguments)</span>
<a href="#l2.4965"></a><span id="l2.4965" class="difflineminus">-{</span>
<a href="#l2.4966"></a><span id="l2.4966" class="difflineminus">-    nsresult        rv = NS_OK;</span>
<a href="#l2.4967"></a><span id="l2.4967" class="difflineminus">-    PRInt32         loop;</span>
<a href="#l2.4968"></a><span id="l2.4968" class="difflineminus">-    PRUint32        numSources;</span>
<a href="#l2.4969"></a><span id="l2.4969" class="difflineminus">-    if (NS_FAILED(rv = aSources-&gt;Count(&amp;numSources)))   return rv;</span>
<a href="#l2.4970"></a><span id="l2.4970" class="difflineminus">-    if (numSources &lt; 1)</span>
<a href="#l2.4971"></a><span id="l2.4971" class="difflineminus">-    {</span>
<a href="#l2.4972"></a><span id="l2.4972" class="difflineminus">-        return NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l2.4973"></a><span id="l2.4973" class="difflineminus">-    }</span>
<a href="#l2.4974"></a><span id="l2.4974" class="difflineminus">-</span>
<a href="#l2.4975"></a><span id="l2.4975" class="difflineminus">-    // Note: some commands only run once (instead of looping over selection);</span>
<a href="#l2.4976"></a><span id="l2.4976" class="difflineminus">-    //       if that's the case, be sure to &quot;break&quot; (if success) so that &quot;mDirty&quot;</span>
<a href="#l2.4977"></a><span id="l2.4977" class="difflineminus">-    //       is set (and &quot;bookmarks.html&quot; will be flushed out shortly afterwards)</span>
<a href="#l2.4978"></a><span id="l2.4978" class="difflineminus">-</span>
<a href="#l2.4979"></a><span id="l2.4979" class="difflineminus">-    for (loop=((PRInt32)numSources)-1; loop&gt;=0; loop--)</span>
<a href="#l2.4980"></a><span id="l2.4980" class="difflineminus">-    {</span>
<a href="#l2.4981"></a><span id="l2.4981" class="difflineminus">-        nsCOMPtr&lt;nsIRDFResource&gt; src = do_QueryElementAt(aSources, loop, &amp;rv);</span>
<a href="#l2.4982"></a><span id="l2.4982" class="difflineminus">-        if (!src) return rv;</span>
<a href="#l2.4983"></a><span id="l2.4983" class="difflineminus">-</span>
<a href="#l2.4984"></a><span id="l2.4984" class="difflineminus">-        if (aCommand == kNC_BookmarkCommand_NewBookmark)</span>
<a href="#l2.4985"></a><span id="l2.4985" class="difflineminus">-        {</span>
<a href="#l2.4986"></a><span id="l2.4986" class="difflineminus">-            rv = insertBookmarkItem(src, aArguments, kNC_Bookmark);</span>
<a href="#l2.4987"></a><span id="l2.4987" class="difflineminus">-            if (NS_FAILED(rv))  return rv;</span>
<a href="#l2.4988"></a><span id="l2.4988" class="difflineminus">-            break;</span>
<a href="#l2.4989"></a><span id="l2.4989" class="difflineminus">-        }</span>
<a href="#l2.4990"></a><span id="l2.4990" class="difflineminus">-        else if (aCommand == kNC_BookmarkCommand_NewFolder)</span>
<a href="#l2.4991"></a><span id="l2.4991" class="difflineminus">-        {</span>
<a href="#l2.4992"></a><span id="l2.4992" class="difflineminus">-            rv = insertBookmarkItem(src, aArguments, kNC_Folder);</span>
<a href="#l2.4993"></a><span id="l2.4993" class="difflineminus">-            if (NS_FAILED(rv))  return rv;</span>
<a href="#l2.4994"></a><span id="l2.4994" class="difflineminus">-            break;</span>
<a href="#l2.4995"></a><span id="l2.4995" class="difflineminus">-        }</span>
<a href="#l2.4996"></a><span id="l2.4996" class="difflineminus">-        else if (aCommand == kNC_BookmarkCommand_NewSeparator)</span>
<a href="#l2.4997"></a><span id="l2.4997" class="difflineminus">-        {</span>
<a href="#l2.4998"></a><span id="l2.4998" class="difflineminus">-            rv = insertBookmarkItem(src, aArguments, kNC_BookmarkSeparator);</span>
<a href="#l2.4999"></a><span id="l2.4999" class="difflineminus">-            if (NS_FAILED(rv))  return rv;</span>
<a href="#l2.5000"></a><span id="l2.5000" class="difflineminus">-            break;</span>
<a href="#l2.5001"></a><span id="l2.5001" class="difflineminus">-        }</span>
<a href="#l2.5002"></a><span id="l2.5002" class="difflineminus">-        else if (aCommand == kNC_BookmarkCommand_DeleteBookmark ||</span>
<a href="#l2.5003"></a><span id="l2.5003" class="difflineminus">-            aCommand == kNC_BookmarkCommand_DeleteBookmarkFolder ||</span>
<a href="#l2.5004"></a><span id="l2.5004" class="difflineminus">-            aCommand == kNC_BookmarkCommand_DeleteBookmarkSeparator)</span>
<a href="#l2.5005"></a><span id="l2.5005" class="difflineminus">-        {</span>
<a href="#l2.5006"></a><span id="l2.5006" class="difflineminus">-            if (NS_FAILED(rv = deleteBookmarkItem(src, aArguments, loop)))</span>
<a href="#l2.5007"></a><span id="l2.5007" class="difflineminus">-                return rv;</span>
<a href="#l2.5008"></a><span id="l2.5008" class="difflineminus">-        }</span>
<a href="#l2.5009"></a><span id="l2.5009" class="difflineminus">-        else if (aCommand == kNC_BookmarkCommand_SetNewBookmarkFolder)</span>
<a href="#l2.5010"></a><span id="l2.5010" class="difflineminus">-        {</span>
<a href="#l2.5011"></a><span id="l2.5011" class="difflineminus">-            rv = setFolderHint(src, kNC_NewBookmarkFolder);</span>
<a href="#l2.5012"></a><span id="l2.5012" class="difflineminus">-            if (NS_FAILED(rv))  return rv;</span>
<a href="#l2.5013"></a><span id="l2.5013" class="difflineminus">-            break;</span>
<a href="#l2.5014"></a><span id="l2.5014" class="difflineminus">-        }</span>
<a href="#l2.5015"></a><span id="l2.5015" class="difflineminus">-        else if (aCommand == kNC_BookmarkCommand_SetPersonalToolbarFolder)</span>
<a href="#l2.5016"></a><span id="l2.5016" class="difflineminus">-        {</span>
<a href="#l2.5017"></a><span id="l2.5017" class="difflineminus">-            rv = setFolderHint(src, kNC_PersonalToolbarFolder);</span>
<a href="#l2.5018"></a><span id="l2.5018" class="difflineminus">-            if (NS_FAILED(rv))  return rv;</span>
<a href="#l2.5019"></a><span id="l2.5019" class="difflineminus">-            break;</span>
<a href="#l2.5020"></a><span id="l2.5020" class="difflineminus">-        }</span>
<a href="#l2.5021"></a><span id="l2.5021" class="difflineminus">-        else if (aCommand == kNC_BookmarkCommand_SetNewSearchFolder)</span>
<a href="#l2.5022"></a><span id="l2.5022" class="difflineminus">-        {</span>
<a href="#l2.5023"></a><span id="l2.5023" class="difflineminus">-            rv = setFolderHint(src, kNC_NewSearchFolder);</span>
<a href="#l2.5024"></a><span id="l2.5024" class="difflineminus">-            if (NS_FAILED(rv))  return rv;</span>
<a href="#l2.5025"></a><span id="l2.5025" class="difflineminus">-            break;</span>
<a href="#l2.5026"></a><span id="l2.5026" class="difflineminus">-        }</span>
<a href="#l2.5027"></a><span id="l2.5027" class="difflineminus">-        else if (aCommand == kNC_BookmarkCommand_Import)</span>
<a href="#l2.5028"></a><span id="l2.5028" class="difflineminus">-        {</span>
<a href="#l2.5029"></a><span id="l2.5029" class="difflineminus">-            rv = importBookmarks(aArguments);</span>
<a href="#l2.5030"></a><span id="l2.5030" class="difflineminus">-            if (NS_FAILED(rv))  return rv;</span>
<a href="#l2.5031"></a><span id="l2.5031" class="difflineminus">-            break;</span>
<a href="#l2.5032"></a><span id="l2.5032" class="difflineminus">-        }</span>
<a href="#l2.5033"></a><span id="l2.5033" class="difflineminus">-        else if (aCommand == kNC_BookmarkCommand_Export)</span>
<a href="#l2.5034"></a><span id="l2.5034" class="difflineminus">-        {</span>
<a href="#l2.5035"></a><span id="l2.5035" class="difflineminus">-            rv = exportBookmarks(aArguments);</span>
<a href="#l2.5036"></a><span id="l2.5036" class="difflineminus">-            if (NS_FAILED(rv))  return rv;</span>
<a href="#l2.5037"></a><span id="l2.5037" class="difflineminus">-            break;</span>
<a href="#l2.5038"></a><span id="l2.5038" class="difflineminus">-        }</span>
<a href="#l2.5039"></a><span id="l2.5039" class="difflineminus">-    }</span>
<a href="#l2.5040"></a><span id="l2.5040" class="difflineminus">-</span>
<a href="#l2.5041"></a><span id="l2.5041" class="difflineminus">-    mDirty = PR_TRUE;</span>
<a href="#l2.5042"></a><span id="l2.5042" class="difflineminus">-</span>
<a href="#l2.5043"></a><span id="l2.5043" class="difflineminus">-    return NS_OK;</span>
<a href="#l2.5044"></a><span id="l2.5044" class="difflineminus">-}</span>
<a href="#l2.5045"></a><span id="l2.5045" class="difflineminus">-</span>
<a href="#l2.5046"></a><span id="l2.5046" class="difflineminus">-</span>
<a href="#l2.5047"></a><span id="l2.5047" class="difflineminus">-////////////////////////////////////////////////////////////////////////</span>
<a href="#l2.5048"></a><span id="l2.5048" class="difflineminus">-// nsIRDFRemoteDataSource</span>
<a href="#l2.5049"></a><span id="l2.5049" class="difflineminus">-</span>
<a href="#l2.5050"></a><span id="l2.5050" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l2.5051"></a><span id="l2.5051" class="difflineminus">-nsBookmarksService::GetLoaded(PRBool* _result)</span>
<a href="#l2.5052"></a><span id="l2.5052" class="difflineminus">-{</span>
<a href="#l2.5053"></a><span id="l2.5053" class="difflineminus">-    *_result = PR_TRUE;</span>
<a href="#l2.5054"></a><span id="l2.5054" class="difflineminus">-    return NS_OK;</span>
<a href="#l2.5055"></a><span id="l2.5055" class="difflineminus">-}</span>
<a href="#l2.5056"></a><span id="l2.5056" class="difflineminus">-</span>
<a href="#l2.5057"></a><span id="l2.5057" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l2.5058"></a><span id="l2.5058" class="difflineminus">-nsBookmarksService::Init(const char* aURI)</span>
<a href="#l2.5059"></a><span id="l2.5059" class="difflineminus">-{</span>
<a href="#l2.5060"></a><span id="l2.5060" class="difflineminus">-    return NS_OK;</span>
<a href="#l2.5061"></a><span id="l2.5061" class="difflineminus">-}</span>
<a href="#l2.5062"></a><span id="l2.5062" class="difflineminus">-</span>
<a href="#l2.5063"></a><span id="l2.5063" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l2.5064"></a><span id="l2.5064" class="difflineminus">-nsBookmarksService::Refresh(PRBool aBlocking)</span>
<a href="#l2.5065"></a><span id="l2.5065" class="difflineminus">-{</span>
<a href="#l2.5066"></a><span id="l2.5066" class="difflineminus">-    // XXX re-sync with the bookmarks file, if necessary.</span>
<a href="#l2.5067"></a><span id="l2.5067" class="difflineminus">-    return NS_OK;</span>
<a href="#l2.5068"></a><span id="l2.5068" class="difflineminus">-}</span>
<a href="#l2.5069"></a><span id="l2.5069" class="difflineminus">-</span>
<a href="#l2.5070"></a><span id="l2.5070" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l2.5071"></a><span id="l2.5071" class="difflineminus">-nsBookmarksService::Flush()</span>
<a href="#l2.5072"></a><span id="l2.5072" class="difflineminus">-{</span>
<a href="#l2.5073"></a><span id="l2.5073" class="difflineminus">-    nsresult    rv = NS_OK;</span>
<a href="#l2.5074"></a><span id="l2.5074" class="difflineminus">-</span>
<a href="#l2.5075"></a><span id="l2.5075" class="difflineminus">-    // Note: we cannot check mDirty here because consumers from script</span>
<a href="#l2.5076"></a><span id="l2.5076" class="difflineminus">-    // (e.g. the BookmarksTransaction code in bookmarks.js) rely on</span>
<a href="#l2.5077"></a><span id="l2.5077" class="difflineminus">-    // flushing us directly, as it has no way to set our mDirty flag.</span>
<a href="#l2.5078"></a><span id="l2.5078" class="difflineminus">-    if (mBookmarksFile)</span>
<a href="#l2.5079"></a><span id="l2.5079" class="difflineminus">-    {</span>
<a href="#l2.5080"></a><span id="l2.5080" class="difflineminus">-        rv = WriteBookmarks(mBookmarksFile, mInner, kNC_BookmarksRoot);</span>
<a href="#l2.5081"></a><span id="l2.5081" class="difflineminus">-    }</span>
<a href="#l2.5082"></a><span id="l2.5082" class="difflineminus">-</span>
<a href="#l2.5083"></a><span id="l2.5083" class="difflineminus">-    return rv;</span>
<a href="#l2.5084"></a><span id="l2.5084" class="difflineminus">-}</span>
<a href="#l2.5085"></a><span id="l2.5085" class="difflineminus">-</span>
<a href="#l2.5086"></a><span id="l2.5086" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l2.5087"></a><span id="l2.5087" class="difflineminus">-nsBookmarksService::FlushTo(const char *aURI)</span>
<a href="#l2.5088"></a><span id="l2.5088" class="difflineminus">-{</span>
<a href="#l2.5089"></a><span id="l2.5089" class="difflineminus">-  // Do not ever implement this (security)</span>
<a href="#l2.5090"></a><span id="l2.5090" class="difflineminus">-  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l2.5091"></a><span id="l2.5091" class="difflineminus">-}</span>
<a href="#l2.5092"></a><span id="l2.5092" class="difflineminus">-</span>
<a href="#l2.5093"></a><span id="l2.5093" class="difflineminus">-</span>
<a href="#l2.5094"></a><span id="l2.5094" class="difflineminus">-////////////////////////////////////////////////////////////////////////</span>
<a href="#l2.5095"></a><span id="l2.5095" class="difflineminus">-// nsIRDFPropagatableDataSource</span>
<a href="#l2.5096"></a><span id="l2.5096" class="difflineminus">-</span>
<a href="#l2.5097"></a><span id="l2.5097" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l2.5098"></a><span id="l2.5098" class="difflineminus">-nsBookmarksService::GetPropagateChanges(PRBool* aPropagateChanges)</span>
<a href="#l2.5099"></a><span id="l2.5099" class="difflineminus">-{</span>
<a href="#l2.5100"></a><span id="l2.5100" class="difflineminus">-    nsCOMPtr&lt;nsIRDFPropagatableDataSource&gt; propagatable = do_QueryInterface(mInner);</span>
<a href="#l2.5101"></a><span id="l2.5101" class="difflineminus">-    return propagatable-&gt;GetPropagateChanges(aPropagateChanges);</span>
<a href="#l2.5102"></a><span id="l2.5102" class="difflineminus">-}</span>
<a href="#l2.5103"></a><span id="l2.5103" class="difflineminus">-</span>
<a href="#l2.5104"></a><span id="l2.5104" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l2.5105"></a><span id="l2.5105" class="difflineminus">-nsBookmarksService::SetPropagateChanges(PRBool aPropagateChanges)</span>
<a href="#l2.5106"></a><span id="l2.5106" class="difflineminus">-{</span>
<a href="#l2.5107"></a><span id="l2.5107" class="difflineminus">-    nsCOMPtr&lt;nsIRDFPropagatableDataSource&gt; propagatable = do_QueryInterface(mInner);</span>
<a href="#l2.5108"></a><span id="l2.5108" class="difflineminus">-    return propagatable-&gt;SetPropagateChanges(aPropagateChanges);</span>
<a href="#l2.5109"></a><span id="l2.5109" class="difflineminus">-}</span>
<a href="#l2.5110"></a><span id="l2.5110" class="difflineminus">-</span>
<a href="#l2.5111"></a><span id="l2.5111" class="difflineminus">-</span>
<a href="#l2.5112"></a><span id="l2.5112" class="difflineminus">-////////////////////////////////////////////////////////////////////////</span>
<a href="#l2.5113"></a><span id="l2.5113" class="difflineminus">-// Implementation methods</span>
<a href="#l2.5114"></a><span id="l2.5114" class="difflineminus">-</span>
<a href="#l2.5115"></a><span id="l2.5115" class="difflineminus">-nsresult</span>
<a href="#l2.5116"></a><span id="l2.5116" class="difflineminus">-nsBookmarksService::EnsureBookmarksFile()</span>
<a href="#l2.5117"></a><span id="l2.5117" class="difflineminus">-{</span>
<a href="#l2.5118"></a><span id="l2.5118" class="difflineminus">-    nsresult rv;</span>
<a href="#l2.5119"></a><span id="l2.5119" class="difflineminus">-</span>
<a href="#l2.5120"></a><span id="l2.5120" class="difflineminus">-    // First we see if the user has set a pref for the location of the </span>
<a href="#l2.5121"></a><span id="l2.5121" class="difflineminus">-    // bookmarks file.</span>
<a href="#l2.5122"></a><span id="l2.5122" class="difflineminus">-    nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l2.5123"></a><span id="l2.5123" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l2.5124"></a><span id="l2.5124" class="difflineminus">-    {</span>
<a href="#l2.5125"></a><span id="l2.5125" class="difflineminus">-        nsCOMPtr&lt;nsISupportsString&gt; prefVal;</span>
<a href="#l2.5126"></a><span id="l2.5126" class="difflineminus">-        rv = prefBranch-&gt;GetComplexValue(&quot;browser.bookmarks.file&quot;,</span>
<a href="#l2.5127"></a><span id="l2.5127" class="difflineminus">-                                         NS_GET_IID(nsISupportsString),</span>
<a href="#l2.5128"></a><span id="l2.5128" class="difflineminus">-                                         getter_AddRefs(prefVal));      </span>
<a href="#l2.5129"></a><span id="l2.5129" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l2.5130"></a><span id="l2.5130" class="difflineminus">-        {</span>
<a href="#l2.5131"></a><span id="l2.5131" class="difflineminus">-            nsAutoString bookmarksFile;</span>
<a href="#l2.5132"></a><span id="l2.5132" class="difflineminus">-            prefVal-&gt;GetData(bookmarksFile); // more efficient than ToString</span>
<a href="#l2.5133"></a><span id="l2.5133" class="difflineminus">-            rv = NS_NewLocalFile(bookmarksFile, PR_TRUE,</span>
<a href="#l2.5134"></a><span id="l2.5134" class="difflineminus">-                                 getter_AddRefs(mBookmarksFile));</span>
<a href="#l2.5135"></a><span id="l2.5135" class="difflineminus">-</span>
<a href="#l2.5136"></a><span id="l2.5136" class="difflineminus">-            if (NS_SUCCEEDED(rv))</span>
<a href="#l2.5137"></a><span id="l2.5137" class="difflineminus">-            {</span>
<a href="#l2.5138"></a><span id="l2.5138" class="difflineminus">-                return NS_OK;</span>
<a href="#l2.5139"></a><span id="l2.5139" class="difflineminus">-            }</span>
<a href="#l2.5140"></a><span id="l2.5140" class="difflineminus">-        }</span>
<a href="#l2.5141"></a><span id="l2.5141" class="difflineminus">-    }</span>
<a href="#l2.5142"></a><span id="l2.5142" class="difflineminus">-</span>
<a href="#l2.5143"></a><span id="l2.5143" class="difflineminus">-</span>
<a href="#l2.5144"></a><span id="l2.5144" class="difflineminus">-    // Otherwise, we look for bookmarks.html in the current profile</span>
<a href="#l2.5145"></a><span id="l2.5145" class="difflineminus">-    // directory using the magic directory service.</span>
<a href="#l2.5146"></a><span id="l2.5146" class="difflineminus">-    rv = NS_GetSpecialDirectory(NS_APP_BOOKMARKS_50_FILE, (nsIFile **)(nsILocalFile **)getter_AddRefs(mBookmarksFile));</span>
<a href="#l2.5147"></a><span id="l2.5147" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.5148"></a><span id="l2.5148" class="difflineminus">-</span>
<a href="#l2.5149"></a><span id="l2.5149" class="difflineminus">-    return NS_OK;</span>
<a href="#l2.5150"></a><span id="l2.5150" class="difflineminus">-}</span>
<a href="#l2.5151"></a><span id="l2.5151" class="difflineminus">-</span>
<a href="#l2.5152"></a><span id="l2.5152" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l2.5153"></a><span id="l2.5153" class="difflineminus">-nsBookmarksService::ReadBookmarks(PRBool *didLoadBookmarks)</span>
<a href="#l2.5154"></a><span id="l2.5154" class="difflineminus">-{</span>
<a href="#l2.5155"></a><span id="l2.5155" class="difflineminus">-    *didLoadBookmarks = PR_FALSE;</span>
<a href="#l2.5156"></a><span id="l2.5156" class="difflineminus">-    if (!mBookmarksFile)</span>
<a href="#l2.5157"></a><span id="l2.5157" class="difflineminus">-    {</span>
<a href="#l2.5158"></a><span id="l2.5158" class="difflineminus">-        LoadBookmarks();</span>
<a href="#l2.5159"></a><span id="l2.5159" class="difflineminus">-        if (mBookmarksFile) {</span>
<a href="#l2.5160"></a><span id="l2.5160" class="difflineminus">-            *didLoadBookmarks = PR_TRUE;</span>
<a href="#l2.5161"></a><span id="l2.5161" class="difflineminus">-            nsCOMPtr&lt;nsIPrefBranch2&gt; prefBranchInt(do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l2.5162"></a><span id="l2.5162" class="difflineminus">-            if (prefBranchInt)</span>
<a href="#l2.5163"></a><span id="l2.5163" class="difflineminus">-                prefBranchInt-&gt;AddObserver(&quot;browser.bookmarks.file&quot;, this, true);</span>
<a href="#l2.5164"></a><span id="l2.5164" class="difflineminus">-        }</span>
<a href="#l2.5165"></a><span id="l2.5165" class="difflineminus">-    }</span>
<a href="#l2.5166"></a><span id="l2.5166" class="difflineminus">-    return NS_OK;</span>
<a href="#l2.5167"></a><span id="l2.5167" class="difflineminus">-}</span>
<a href="#l2.5168"></a><span id="l2.5168" class="difflineminus">-</span>
<a href="#l2.5169"></a><span id="l2.5169" class="difflineminus">-nsresult</span>
<a href="#l2.5170"></a><span id="l2.5170" class="difflineminus">-nsBookmarksService::initDatasource()</span>
<a href="#l2.5171"></a><span id="l2.5171" class="difflineminus">-{</span>
<a href="#l2.5172"></a><span id="l2.5172" class="difflineminus">-    // the profile manager might call Readbookmarks() in certain circumstances</span>
<a href="#l2.5173"></a><span id="l2.5173" class="difflineminus">-    // so we need to forget about any previous bookmarks</span>
<a href="#l2.5174"></a><span id="l2.5174" class="difflineminus">-    // don't change this to an xml-ds, it will cause serious perf problems</span>
<a href="#l2.5175"></a><span id="l2.5175" class="difflineminus">-    nsresult rv;</span>
<a href="#l2.5176"></a><span id="l2.5176" class="difflineminus">-    mInner = do_CreateInstance(kRDFInMemoryDataSourceCID, &amp;rv);</span>
<a href="#l2.5177"></a><span id="l2.5177" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l2.5178"></a><span id="l2.5178" class="difflineminus">-</span>
<a href="#l2.5179"></a><span id="l2.5179" class="difflineminus">-    rv = mInner-&gt;AddObserver(this);</span>
<a href="#l2.5180"></a><span id="l2.5180" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l2.5181"></a><span id="l2.5181" class="difflineminus">-</span>
<a href="#l2.5182"></a><span id="l2.5182" class="difflineminus">-    rv = gRDFC-&gt;MakeSeq(mInner, kNC_BookmarksTopRoot, nsnull);</span>
<a href="#l2.5183"></a><span id="l2.5183" class="difflineminus">-    NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Unable to make NC:BookmarksTopRoot a sequence&quot;);</span>
<a href="#l2.5184"></a><span id="l2.5184" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l2.5185"></a><span id="l2.5185" class="difflineminus">-</span>
<a href="#l2.5186"></a><span id="l2.5186" class="difflineminus">-    rv = gRDFC-&gt;MakeSeq(mInner, kNC_BookmarksRoot, nsnull);</span>
<a href="#l2.5187"></a><span id="l2.5187" class="difflineminus">-    NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Unable to make NC:BookmarksRoot a sequence&quot;);</span>
<a href="#l2.5188"></a><span id="l2.5188" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l2.5189"></a><span id="l2.5189" class="difflineminus">-</span>
<a href="#l2.5190"></a><span id="l2.5190" class="difflineminus">-    // Make sure bookmark's root has the correct type</span>
<a href="#l2.5191"></a><span id="l2.5191" class="difflineminus">-    rv = mInner-&gt;Assert(kNC_BookmarksTopRoot, kRDF_type, kNC_Folder, PR_TRUE);</span>
<a href="#l2.5192"></a><span id="l2.5192" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l2.5193"></a><span id="l2.5193" class="difflineminus">-</span>
<a href="#l2.5194"></a><span id="l2.5194" class="difflineminus">-    rv = mInner-&gt;Assert(kNC_BookmarksRoot, kRDF_type, kNC_Folder, PR_TRUE);</span>
<a href="#l2.5195"></a><span id="l2.5195" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l2.5196"></a><span id="l2.5196" class="difflineminus">-</span>
<a href="#l2.5197"></a><span id="l2.5197" class="difflineminus">-    // Insert NC:BookmarksRoot in NC:BookmarksTopRoot</span>
<a href="#l2.5198"></a><span id="l2.5198" class="difflineminus">-    nsCOMPtr&lt;nsIRDFContainer&gt; container(do_CreateInstance(kRDFContainerCID, &amp;rv));</span>
<a href="#l2.5199"></a><span id="l2.5199" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l2.5200"></a><span id="l2.5200" class="difflineminus">-    rv = container-&gt;Init(mInner, kNC_BookmarksTopRoot);</span>
<a href="#l2.5201"></a><span id="l2.5201" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l2.5202"></a><span id="l2.5202" class="difflineminus">-    rv = container-&gt;AppendElement(kNC_BookmarksRoot);</span>
<a href="#l2.5203"></a><span id="l2.5203" class="difflineminus">-</span>
<a href="#l2.5204"></a><span id="l2.5204" class="difflineminus">-    return rv;</span>
<a href="#l2.5205"></a><span id="l2.5205" class="difflineminus">-}</span>
<a href="#l2.5206"></a><span id="l2.5206" class="difflineminus">-</span>
<a href="#l2.5207"></a><span id="l2.5207" class="difflineminus">-nsresult</span>
<a href="#l2.5208"></a><span id="l2.5208" class="difflineminus">-nsBookmarksService::LoadBookmarks()</span>
<a href="#l2.5209"></a><span id="l2.5209" class="difflineminus">-{</span>
<a href="#l2.5210"></a><span id="l2.5210" class="difflineminus">-    nsresult    rv;</span>
<a href="#l2.5211"></a><span id="l2.5211" class="difflineminus">-</span>
<a href="#l2.5212"></a><span id="l2.5212" class="difflineminus">-    rv = initDatasource();</span>
<a href="#l2.5213"></a><span id="l2.5213" class="difflineminus">-    if (NS_FAILED(rv)) return NS_OK;</span>
<a href="#l2.5214"></a><span id="l2.5214" class="difflineminus">-</span>
<a href="#l2.5215"></a><span id="l2.5215" class="difflineminus">-    rv = EnsureBookmarksFile();</span>
<a href="#l2.5216"></a><span id="l2.5216" class="difflineminus">-</span>
<a href="#l2.5217"></a><span id="l2.5217" class="difflineminus">-    // Lack of Bookmarks file is non-fatal</span>
<a href="#l2.5218"></a><span id="l2.5218" class="difflineminus">-    if (NS_FAILED(rv)) return NS_OK;</span>
<a href="#l2.5219"></a><span id="l2.5219" class="difflineminus">-</span>
<a href="#l2.5220"></a><span id="l2.5220" class="difflineminus">-    PRBool foundIERoot = PR_FALSE;</span>
<a href="#l2.5221"></a><span id="l2.5221" class="difflineminus">-</span>
<a href="#l2.5222"></a><span id="l2.5222" class="difflineminus">-    nsCOMPtr&lt;nsIPrefService&gt; prefSvc(do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l2.5223"></a><span id="l2.5223" class="difflineminus">-    nsCOMPtr&lt;nsIPrefBranch&gt; bookmarksPrefs;</span>
<a href="#l2.5224"></a><span id="l2.5224" class="difflineminus">-    if (prefSvc)</span>
<a href="#l2.5225"></a><span id="l2.5225" class="difflineminus">-        prefSvc-&gt;GetBranch(&quot;browser.bookmarks.&quot;, getter_AddRefs(bookmarksPrefs));</span>
<a href="#l2.5226"></a><span id="l2.5226" class="difflineminus">-</span>
<a href="#l2.5227"></a><span id="l2.5227" class="difflineminus">-#ifdef DEBUG_varga</span>
<a href="#l2.5228"></a><span id="l2.5228" class="difflineminus">-    PRTime now = PR_Now();</span>
<a href="#l2.5229"></a><span id="l2.5229" class="difflineminus">-    printf(&quot;Start reading in bookmarks.html\n&quot;);</span>
<a href="#l2.5230"></a><span id="l2.5230" class="difflineminus">-#endif</span>
<a href="#l2.5231"></a><span id="l2.5231" class="difflineminus">-  </span>
<a href="#l2.5232"></a><span id="l2.5232" class="difflineminus">-    // System Bookmarks Strategy</span>
<a href="#l2.5233"></a><span id="l2.5233" class="difflineminus">-    //</span>
<a href="#l2.5234"></a><span id="l2.5234" class="difflineminus">-    // * By default, we do a one-off import of system bookmarks when the browser </span>
<a href="#l2.5235"></a><span id="l2.5235" class="difflineminus">-    //   is run for the first time. This creates a hierarchy of bona-fide Mozilla</span>
<a href="#l2.5236"></a><span id="l2.5236" class="difflineminus">-    //   bookmarks that is fully manipulable by the user but is not a live view.</span>
<a href="#l2.5237"></a><span id="l2.5237" class="difflineminus">-    //</span>
<a href="#l2.5238"></a><span id="l2.5238" class="difflineminus">-    // * As an option, the user can enable a &quot;live view&quot; of his or her system</span>
<a href="#l2.5239"></a><span id="l2.5239" class="difflineminus">-    //   bookmarks which are not user manipulable but does update automatically.</span>
<a href="#l2.5240"></a><span id="l2.5240" class="difflineminus">-</span>
<a href="#l2.5241"></a><span id="l2.5241" class="difflineminus">-    // Determine whether or not the user wishes to see the live view of system</span>
<a href="#l2.5242"></a><span id="l2.5242" class="difflineminus">-    // bookmarks. This is controlled by the </span>
<a href="#l2.5243"></a><span id="l2.5243" class="difflineminus">-    //</span>
<a href="#l2.5244"></a><span id="l2.5244" class="difflineminus">-    //   browser.bookmarks.import_system_favorites</span>
<a href="#l2.5245"></a><span id="l2.5245" class="difflineminus">-    //</span>
<a href="#l2.5246"></a><span id="l2.5246" class="difflineminus">-    // pref. See bug 22642 for details. </span>
<a href="#l2.5247"></a><span id="l2.5247" class="difflineminus">-    //</span>
<a href="#l2.5248"></a><span id="l2.5248" class="difflineminus">-    PRBool useDynamicSystemBookmarks;</span>
<a href="#l2.5249"></a><span id="l2.5249" class="difflineminus">-#ifdef XP_BEOS</span>
<a href="#l2.5250"></a><span id="l2.5250" class="difflineminus">-    // always dynamic in BeOS</span>
<a href="#l2.5251"></a><span id="l2.5251" class="difflineminus">-    useDynamicSystemBookmarks = PR_TRUE;</span>
<a href="#l2.5252"></a><span id="l2.5252" class="difflineminus">-#else</span>
<a href="#l2.5253"></a><span id="l2.5253" class="difflineminus">-    useDynamicSystemBookmarks = PR_FALSE;</span>
<a href="#l2.5254"></a><span id="l2.5254" class="difflineminus">-    if (bookmarksPrefs)</span>
<a href="#l2.5255"></a><span id="l2.5255" class="difflineminus">-        bookmarksPrefs-&gt;GetBoolPref(&quot;import_system_favorites&quot;, &amp;useDynamicSystemBookmarks);</span>
<a href="#l2.5256"></a><span id="l2.5256" class="difflineminus">-#endif</span>
<a href="#l2.5257"></a><span id="l2.5257" class="difflineminus">-</span>
<a href="#l2.5258"></a><span id="l2.5258" class="difflineminus">-    nsCAutoString bookmarksURICString;</span>
<a href="#l2.5259"></a><span id="l2.5259" class="difflineminus">-</span>
<a href="#l2.5260"></a><span id="l2.5260" class="difflineminus">-#if defined(XP_WIN) || defined(XP_BEOS)</span>
<a href="#l2.5261"></a><span id="l2.5261" class="difflineminus">-    nsCOMPtr&lt;nsIFile&gt; systemBookmarksFolder;</span>
<a href="#l2.5262"></a><span id="l2.5262" class="difflineminus">-</span>
<a href="#l2.5263"></a><span id="l2.5263" class="difflineminus">-#ifdef XP_WIN</span>
<a href="#l2.5264"></a><span id="l2.5264" class="difflineminus">-    rv = NS_GetSpecialDirectory(NS_WIN_FAVORITES_DIR, getter_AddRefs(systemBookmarksFolder));</span>
<a href="#l2.5265"></a><span id="l2.5265" class="difflineminus">-#else</span>
<a href="#l2.5266"></a><span id="l2.5266" class="difflineminus">-    rv = NS_GetSpecialDirectory(NS_BEOS_SETTINGS_DIR, getter_AddRefs(systemBookmarksFolder));</span>
<a href="#l2.5267"></a><span id="l2.5267" class="difflineminus">-</span>
<a href="#l2.5268"></a><span id="l2.5268" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l2.5269"></a><span id="l2.5269" class="difflineminus">-        rv = systemBookmarksFolder-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;NetPositive&quot;));</span>
<a href="#l2.5270"></a><span id="l2.5270" class="difflineminus">-   </span>
<a href="#l2.5271"></a><span id="l2.5271" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l2.5272"></a><span id="l2.5272" class="difflineminus">-        rv = systemBookmarksFolder-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;Bookmarks&quot;));</span>
<a href="#l2.5273"></a><span id="l2.5273" class="difflineminus">-#endif</span>
<a href="#l2.5274"></a><span id="l2.5274" class="difflineminus">-</span>
<a href="#l2.5275"></a><span id="l2.5275" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l2.5276"></a><span id="l2.5276" class="difflineminus">-    {</span>
<a href="#l2.5277"></a><span id="l2.5277" class="difflineminus">-        nsCOMPtr&lt;nsIURI&gt; bookmarksURI;</span>
<a href="#l2.5278"></a><span id="l2.5278" class="difflineminus">-        rv = NS_NewFileURI(getter_AddRefs(bookmarksURI), systemBookmarksFolder);</span>
<a href="#l2.5279"></a><span id="l2.5279" class="difflineminus">-</span>
<a href="#l2.5280"></a><span id="l2.5280" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l2.5281"></a><span id="l2.5281" class="difflineminus">-            rv = bookmarksURI-&gt;GetSpec(bookmarksURICString);</span>
<a href="#l2.5282"></a><span id="l2.5282" class="difflineminus">-    }</span>
<a href="#l2.5283"></a><span id="l2.5283" class="difflineminus">-</span>
<a href="#l2.5284"></a><span id="l2.5284" class="difflineminus">-#endif</span>
<a href="#l2.5285"></a><span id="l2.5285" class="difflineminus">-</span>
<a href="#l2.5286"></a><span id="l2.5286" class="difflineminus">-    nsCOMPtr&lt;nsIRDFResource&gt; systemFolderResource;</span>
<a href="#l2.5287"></a><span id="l2.5287" class="difflineminus">-    if (!bookmarksURICString.IsEmpty())</span>
<a href="#l2.5288"></a><span id="l2.5288" class="difflineminus">-        gRDF-&gt;GetResource(bookmarksURICString,</span>
<a href="#l2.5289"></a><span id="l2.5289" class="difflineminus">-                          getter_AddRefs(systemFolderResource));</span>
<a href="#l2.5290"></a><span id="l2.5290" class="difflineminus">-</span>
<a href="#l2.5291"></a><span id="l2.5291" class="difflineminus">-    // scope the stream to get the open/close automatically.</span>
<a href="#l2.5292"></a><span id="l2.5292" class="difflineminus">-    {</span>
<a href="#l2.5293"></a><span id="l2.5293" class="difflineminus">-        BookmarkParser parser;</span>
<a href="#l2.5294"></a><span id="l2.5294" class="difflineminus">-        parser.Init(mBookmarksFile, mInner);</span>
<a href="#l2.5295"></a><span id="l2.5295" class="difflineminus">-        if (useDynamicSystemBookmarks &amp;&amp; !bookmarksURICString.IsEmpty())</span>
<a href="#l2.5296"></a><span id="l2.5296" class="difflineminus">-        {</span>
<a href="#l2.5297"></a><span id="l2.5297" class="difflineminus">-            parser.SetIEFavoritesRoot(bookmarksURICString);</span>
<a href="#l2.5298"></a><span id="l2.5298" class="difflineminus">-            parser.ParserFoundIEFavoritesRoot(&amp;foundIERoot);</span>
<a href="#l2.5299"></a><span id="l2.5299" class="difflineminus">-        }</span>
<a href="#l2.5300"></a><span id="l2.5300" class="difflineminus">-</span>
<a href="#l2.5301"></a><span id="l2.5301" class="difflineminus">-        BeginUpdateBatch();</span>
<a href="#l2.5302"></a><span id="l2.5302" class="difflineminus">-        parser.Parse(kNC_BookmarksRoot, kNC_Bookmark);</span>
<a href="#l2.5303"></a><span id="l2.5303" class="difflineminus">-        EndUpdateBatch();</span>
<a href="#l2.5304"></a><span id="l2.5304" class="difflineminus">-        </span>
<a href="#l2.5305"></a><span id="l2.5305" class="difflineminus">-        PRBool foundPTFolder = PR_FALSE;</span>
<a href="#l2.5306"></a><span id="l2.5306" class="difflineminus">-        parser.ParserFoundPersonalToolbarFolder(&amp;foundPTFolder);</span>
<a href="#l2.5307"></a><span id="l2.5307" class="difflineminus">-        // try to ensure that we end up with a personal toolbar folder</span>
<a href="#l2.5308"></a><span id="l2.5308" class="difflineminus">-        if ((foundPTFolder == PR_FALSE) &amp;&amp; (!mPersonalToolbarName.IsEmpty()))</span>
<a href="#l2.5309"></a><span id="l2.5309" class="difflineminus">-        {</span>
<a href="#l2.5310"></a><span id="l2.5310" class="difflineminus">-            nsCOMPtr&lt;nsIRDFLiteral&gt;   ptNameLiteral;</span>
<a href="#l2.5311"></a><span id="l2.5311" class="difflineminus">-            rv = gRDF-&gt;GetLiteral(mPersonalToolbarName.get(), getter_AddRefs(ptNameLiteral));</span>
<a href="#l2.5312"></a><span id="l2.5312" class="difflineminus">-            if (NS_SUCCEEDED(rv))</span>
<a href="#l2.5313"></a><span id="l2.5313" class="difflineminus">-            {</span>
<a href="#l2.5314"></a><span id="l2.5314" class="difflineminus">-                nsCOMPtr&lt;nsIRDFResource&gt;    ptSource;</span>
<a href="#l2.5315"></a><span id="l2.5315" class="difflineminus">-                rv = mInner-&gt;GetSource(kNC_Name, ptNameLiteral, PR_TRUE, getter_AddRefs(ptSource));</span>
<a href="#l2.5316"></a><span id="l2.5316" class="difflineminus">-                if (NS_FAILED(rv)) return rv;</span>
<a href="#l2.5317"></a><span id="l2.5317" class="difflineminus">-        </span>
<a href="#l2.5318"></a><span id="l2.5318" class="difflineminus">-                if ((rv != NS_RDF_NO_VALUE) &amp;&amp; (ptSource))</span>
<a href="#l2.5319"></a><span id="l2.5319" class="difflineminus">-                    setFolderHint(ptSource, kNC_PersonalToolbarFolder);</span>
<a href="#l2.5320"></a><span id="l2.5320" class="difflineminus">-            }</span>
<a href="#l2.5321"></a><span id="l2.5321" class="difflineminus">-        }</span>
<a href="#l2.5322"></a><span id="l2.5322" class="difflineminus">-</span>
<a href="#l2.5323"></a><span id="l2.5323" class="difflineminus">-      // Sets the default bookmarks root name.</span>
<a href="#l2.5324"></a><span id="l2.5324" class="difflineminus">-      nsCOMPtr&lt;nsIRDFLiteral&gt; brNameLiteral;</span>
<a href="#l2.5325"></a><span id="l2.5325" class="difflineminus">-      rv = gRDF-&gt;GetLiteral(mBookmarksRootName.get(), getter_AddRefs(brNameLiteral));</span>
<a href="#l2.5326"></a><span id="l2.5326" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l2.5327"></a><span id="l2.5327" class="difflineminus">-          mInner-&gt;Assert(kNC_BookmarksRoot, kNC_Name, brNameLiteral, PR_TRUE);</span>
<a href="#l2.5328"></a><span id="l2.5328" class="difflineminus">-</span>
<a href="#l2.5329"></a><span id="l2.5329" class="difflineminus">-    } // &lt;-- scope the stream to get the open/close automatically.</span>
<a href="#l2.5330"></a><span id="l2.5330" class="difflineminus">-</span>
<a href="#l2.5331"></a><span id="l2.5331" class="difflineminus">-    // Now append the one-time-per-profile empty &quot;Full&quot; System Bookmarks Root. </span>
<a href="#l2.5332"></a><span id="l2.5332" class="difflineminus">-    // When the user opens this folder for the first time, system bookmarks are </span>
<a href="#l2.5333"></a><span id="l2.5333" class="difflineminus">-    // imported into this folder. A pref is used to keep track of whether or </span>
<a href="#l2.5334"></a><span id="l2.5334" class="difflineminus">-    // not to perform this operation. </span>
<a href="#l2.5335"></a><span id="l2.5335" class="difflineminus">-#ifdef XP_WIN</span>
<a href="#l2.5336"></a><span id="l2.5336" class="difflineminus">-    PRBool addedStaticRoot = PR_FALSE;</span>
<a href="#l2.5337"></a><span id="l2.5337" class="difflineminus">-    if (bookmarksPrefs)</span>
<a href="#l2.5338"></a><span id="l2.5338" class="difflineminus">-        bookmarksPrefs-&gt;GetBoolPref(&quot;added_static_root&quot;, </span>
<a href="#l2.5339"></a><span id="l2.5339" class="difflineminus">-                                    &amp;addedStaticRoot);</span>
<a href="#l2.5340"></a><span id="l2.5340" class="difflineminus">-</span>
<a href="#l2.5341"></a><span id="l2.5341" class="difflineminus">-    // Add the root that System bookmarks are imported into as real bookmarks. This is </span>
<a href="#l2.5342"></a><span id="l2.5342" class="difflineminus">-    // only done once. </span>
<a href="#l2.5343"></a><span id="l2.5343" class="difflineminus">-    if (!addedStaticRoot &amp;&amp; systemFolderResource)</span>
<a href="#l2.5344"></a><span id="l2.5344" class="difflineminus">-    {</span>
<a href="#l2.5345"></a><span id="l2.5345" class="difflineminus">-        nsCOMPtr&lt;nsIRDFContainer&gt; rootContainer(do_CreateInstance(kRDFContainerCID, &amp;rv));</span>
<a href="#l2.5346"></a><span id="l2.5346" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l2.5347"></a><span id="l2.5347" class="difflineminus">-</span>
<a href="#l2.5348"></a><span id="l2.5348" class="difflineminus">-        rv = rootContainer-&gt;Init(this, kNC_BookmarksRoot);</span>
<a href="#l2.5349"></a><span id="l2.5349" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l2.5350"></a><span id="l2.5350" class="difflineminus">-</span>
<a href="#l2.5351"></a><span id="l2.5351" class="difflineminus">-        rv = mInner-&gt;Assert(kNC_SystemBookmarksStaticRoot, kRDF_type, kNC_Folder, PR_TRUE);</span>
<a href="#l2.5352"></a><span id="l2.5352" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l2.5353"></a><span id="l2.5353" class="difflineminus">-</span>
<a href="#l2.5354"></a><span id="l2.5354" class="difflineminus">-        nsAutoString importedStaticTitle;</span>
<a href="#l2.5355"></a><span id="l2.5355" class="difflineminus">-        getLocaleString(&quot;ImportedIEStaticFavorites&quot;, importedStaticTitle);</span>
<a href="#l2.5356"></a><span id="l2.5356" class="difflineminus">-</span>
<a href="#l2.5357"></a><span id="l2.5357" class="difflineminus">-        nsCOMPtr&lt;nsIRDFLiteral&gt; staticTitleLiteral;</span>
<a href="#l2.5358"></a><span id="l2.5358" class="difflineminus">-        rv = gRDF-&gt;GetLiteral(importedStaticTitle.get(), getter_AddRefs(staticTitleLiteral));</span>
<a href="#l2.5359"></a><span id="l2.5359" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l2.5360"></a><span id="l2.5360" class="difflineminus">-</span>
<a href="#l2.5361"></a><span id="l2.5361" class="difflineminus">-        rv = mInner-&gt;Assert(kNC_SystemBookmarksStaticRoot, kNC_Name, staticTitleLiteral, PR_TRUE);</span>
<a href="#l2.5362"></a><span id="l2.5362" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l2.5363"></a><span id="l2.5363" class="difflineminus">-</span>
<a href="#l2.5364"></a><span id="l2.5364" class="difflineminus">-        rv = rootContainer-&gt;AppendElement(kNC_SystemBookmarksStaticRoot);</span>
<a href="#l2.5365"></a><span id="l2.5365" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l2.5366"></a><span id="l2.5366" class="difflineminus">-</span>
<a href="#l2.5367"></a><span id="l2.5367" class="difflineminus">-        // If the user has not specifically asked for the Dynamic bookmarks root </span>
<a href="#l2.5368"></a><span id="l2.5368" class="difflineminus">-        // via the pref, remove it from an existing bookmarks file as it serves</span>
<a href="#l2.5369"></a><span id="l2.5369" class="difflineminus">-        // only to add confusion. </span>
<a href="#l2.5370"></a><span id="l2.5370" class="difflineminus">-        if (!useDynamicSystemBookmarks)</span>
<a href="#l2.5371"></a><span id="l2.5371" class="difflineminus">-        {</span>
<a href="#l2.5372"></a><span id="l2.5372" class="difflineminus">-            nsCOMPtr&lt;nsIRDFContainer&gt; container(do_CreateInstance(kRDFContainerCID, &amp;rv));</span>
<a href="#l2.5373"></a><span id="l2.5373" class="difflineminus">-            if (NS_FAILED(rv)) return rv;</span>
<a href="#l2.5374"></a><span id="l2.5374" class="difflineminus">-</span>
<a href="#l2.5375"></a><span id="l2.5375" class="difflineminus">-            rv = container-&gt;Init(this, kNC_BookmarksRoot);</span>
<a href="#l2.5376"></a><span id="l2.5376" class="difflineminus">-            if (NS_FAILED(rv)) return rv;</span>
<a href="#l2.5377"></a><span id="l2.5377" class="difflineminus">-      </span>
<a href="#l2.5378"></a><span id="l2.5378" class="difflineminus">-            rv = container-&gt;RemoveElement(systemFolderResource, PR_TRUE);</span>
<a href="#l2.5379"></a><span id="l2.5379" class="difflineminus">-            if (NS_FAILED(rv)) return rv;</span>
<a href="#l2.5380"></a><span id="l2.5380" class="difflineminus">-        }</span>
<a href="#l2.5381"></a><span id="l2.5381" class="difflineminus">-</span>
<a href="#l2.5382"></a><span id="l2.5382" class="difflineminus">-        bookmarksPrefs-&gt;SetBoolPref(&quot;added_static_root&quot;, PR_TRUE);</span>
<a href="#l2.5383"></a><span id="l2.5383" class="difflineminus">-    }</span>
<a href="#l2.5384"></a><span id="l2.5384" class="difflineminus">-#endif</span>
<a href="#l2.5385"></a><span id="l2.5385" class="difflineminus">-</span>
<a href="#l2.5386"></a><span id="l2.5386" class="difflineminus">-    // Add the dynamic system bookmarks root if the user has asked for it</span>
<a href="#l2.5387"></a><span id="l2.5387" class="difflineminus">-    // by setting the pref. </span>
<a href="#l2.5388"></a><span id="l2.5388" class="difflineminus">-    if (useDynamicSystemBookmarks)</span>
<a href="#l2.5389"></a><span id="l2.5389" class="difflineminus">-    {</span>
<a href="#l2.5390"></a><span id="l2.5390" class="difflineminus">-#if defined(XP_WIN) || defined(XP_BEOS)</span>
<a href="#l2.5391"></a><span id="l2.5391" class="difflineminus">-        if (systemFolderResource)</span>
<a href="#l2.5392"></a><span id="l2.5392" class="difflineminus">-        {</span>
<a href="#l2.5393"></a><span id="l2.5393" class="difflineminus">-            nsAutoString systemBookmarksFolderTitle;</span>
<a href="#l2.5394"></a><span id="l2.5394" class="difflineminus">-#ifdef XP_BEOS</span>
<a href="#l2.5395"></a><span id="l2.5395" class="difflineminus">-            getLocaleString(&quot;ImportedNetPositiveBookmarks&quot;, systemBookmarksFolderTitle);</span>
<a href="#l2.5396"></a><span id="l2.5396" class="difflineminus">-#else</span>
<a href="#l2.5397"></a><span id="l2.5397" class="difflineminus">-            getLocaleString(&quot;ImportedIEFavorites&quot;, systemBookmarksFolderTitle);</span>
<a href="#l2.5398"></a><span id="l2.5398" class="difflineminus">-#endif</span>
<a href="#l2.5399"></a><span id="l2.5399" class="difflineminus">-</span>
<a href="#l2.5400"></a><span id="l2.5400" class="difflineminus">-            nsCOMPtr&lt;nsIRDFLiteral&gt;   systemFolderTitleLiteral;</span>
<a href="#l2.5401"></a><span id="l2.5401" class="difflineminus">-            rv = gRDF-&gt;GetLiteral(systemBookmarksFolderTitle.get(), </span>
<a href="#l2.5402"></a><span id="l2.5402" class="difflineminus">-                                  getter_AddRefs(systemFolderTitleLiteral));</span>
<a href="#l2.5403"></a><span id="l2.5403" class="difflineminus">-            if (NS_SUCCEEDED(rv) &amp;&amp; systemFolderTitleLiteral)</span>
<a href="#l2.5404"></a><span id="l2.5404" class="difflineminus">-                rv = mInner-&gt;Assert(systemFolderResource, kNC_Name, </span>
<a href="#l2.5405"></a><span id="l2.5405" class="difflineminus">-                                    systemFolderTitleLiteral, PR_TRUE);</span>
<a href="#l2.5406"></a><span id="l2.5406" class="difflineminus">-    </span>
<a href="#l2.5407"></a><span id="l2.5407" class="difflineminus">-            // if the IE Favorites root isn't somewhere in bookmarks.html, add it</span>
<a href="#l2.5408"></a><span id="l2.5408" class="difflineminus">-            if (!foundIERoot)</span>
<a href="#l2.5409"></a><span id="l2.5409" class="difflineminus">-            {</span>
<a href="#l2.5410"></a><span id="l2.5410" class="difflineminus">-                nsCOMPtr&lt;nsIRDFContainer&gt; container(do_CreateInstance(kRDFContainerCID, &amp;rv));</span>
<a href="#l2.5411"></a><span id="l2.5411" class="difflineminus">-                if (NS_FAILED(rv)) return rv;</span>
<a href="#l2.5412"></a><span id="l2.5412" class="difflineminus">-</span>
<a href="#l2.5413"></a><span id="l2.5413" class="difflineminus">-                rv = container-&gt;Init(this, kNC_BookmarksRoot);</span>
<a href="#l2.5414"></a><span id="l2.5414" class="difflineminus">-                if (NS_FAILED(rv)) return rv;</span>
<a href="#l2.5415"></a><span id="l2.5415" class="difflineminus">-</span>
<a href="#l2.5416"></a><span id="l2.5416" class="difflineminus">-                rv = container-&gt;AppendElement(systemFolderResource);</span>
<a href="#l2.5417"></a><span id="l2.5417" class="difflineminus">-                if (NS_FAILED(rv)) return rv;</span>
<a href="#l2.5418"></a><span id="l2.5418" class="difflineminus">-            }</span>
<a href="#l2.5419"></a><span id="l2.5419" class="difflineminus">-        }</span>
<a href="#l2.5420"></a><span id="l2.5420" class="difflineminus">-#endif</span>
<a href="#l2.5421"></a><span id="l2.5421" class="difflineminus">-    }</span>
<a href="#l2.5422"></a><span id="l2.5422" class="difflineminus">-</span>
<a href="#l2.5423"></a><span id="l2.5423" class="difflineminus">-#ifdef DEBUG_varga</span>
<a href="#l2.5424"></a><span id="l2.5424" class="difflineminus">-    PRTime now2 = PR_Now();</span>
<a href="#l2.5425"></a><span id="l2.5425" class="difflineminus">-    PRUint64    loadTime64;</span>
<a href="#l2.5426"></a><span id="l2.5426" class="difflineminus">-    LL_SUB(loadTime64, now2, now);</span>
<a href="#l2.5427"></a><span id="l2.5427" class="difflineminus">-    PRUint32    loadTime32;</span>
<a href="#l2.5428"></a><span id="l2.5428" class="difflineminus">-    LL_L2UI(loadTime32, loadTime64);</span>
<a href="#l2.5429"></a><span id="l2.5429" class="difflineminus">-    printf(&quot;Finished reading in bookmarks.html  (%u microseconds)\n&quot;, loadTime32);</span>
<a href="#l2.5430"></a><span id="l2.5430" class="difflineminus">-#endif</span>
<a href="#l2.5431"></a><span id="l2.5431" class="difflineminus">-</span>
<a href="#l2.5432"></a><span id="l2.5432" class="difflineminus">-    return NS_OK;</span>
<a href="#l2.5433"></a><span id="l2.5433" class="difflineminus">-}</span>
<a href="#l2.5434"></a><span id="l2.5434" class="difflineminus">-</span>
<a href="#l2.5435"></a><span id="l2.5435" class="difflineminus">-static char kFileIntro[] = </span>
<a href="#l2.5436"></a><span id="l2.5436" class="difflineminus">-    &quot;&lt;!DOCTYPE NETSCAPE-Bookmark-file-1&gt;&quot; NS_LINEBREAK</span>
<a href="#l2.5437"></a><span id="l2.5437" class="difflineminus">-    &quot;&lt;!-- This is an automatically generated file.&quot; NS_LINEBREAK</span>
<a href="#l2.5438"></a><span id="l2.5438" class="difflineminus">-    &quot;     It will be read and overwritten.&quot; NS_LINEBREAK</span>
<a href="#l2.5439"></a><span id="l2.5439" class="difflineminus">-    &quot;     DO NOT EDIT! --&gt;&quot; NS_LINEBREAK</span>
<a href="#l2.5440"></a><span id="l2.5440" class="difflineminus">-    // Note: we write bookmarks in UTF-8</span>
<a href="#l2.5441"></a><span id="l2.5441" class="difflineminus">-    &quot;&lt;META HTTP-EQUIV=\&quot;Content-Type\&quot; CONTENT=\&quot;text/html; charset=UTF-8\&quot;&gt;&quot; NS_LINEBREAK</span>
<a href="#l2.5442"></a><span id="l2.5442" class="difflineminus">-    &quot;&lt;TITLE&gt;Bookmarks&lt;/TITLE&gt;&quot; NS_LINEBREAK</span>
<a href="#l2.5443"></a><span id="l2.5443" class="difflineminus">-    &quot;&lt;H1&gt;Bookmarks&lt;/H1&gt;&quot; NS_LINEBREAK NS_LINEBREAK;</span>
<a href="#l2.5444"></a><span id="l2.5444" class="difflineminus">-</span>
<a href="#l2.5445"></a><span id="l2.5445" class="difflineminus">-nsresult</span>
<a href="#l2.5446"></a><span id="l2.5446" class="difflineminus">-nsBookmarksService::WriteBookmarks(nsIFile* aBookmarksFile,</span>
<a href="#l2.5447"></a><span id="l2.5447" class="difflineminus">-                                   nsIRDFDataSource* aDataSource,</span>
<a href="#l2.5448"></a><span id="l2.5448" class="difflineminus">-                                   nsIRDFResource *aRoot)</span>
<a href="#l2.5449"></a><span id="l2.5449" class="difflineminus">-{</span>
<a href="#l2.5450"></a><span id="l2.5450" class="difflineminus">-    if (!aBookmarksFile || !aDataSource || !aRoot)</span>
<a href="#l2.5451"></a><span id="l2.5451" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l2.5452"></a><span id="l2.5452" class="difflineminus">-</span>
<a href="#l2.5453"></a><span id="l2.5453" class="difflineminus">-    // get a safe output stream, so we don't clobber the bookmarks file unless</span>
<a href="#l2.5454"></a><span id="l2.5454" class="difflineminus">-    // all the writes succeeded.</span>
<a href="#l2.5455"></a><span id="l2.5455" class="difflineminus">-    nsCOMPtr&lt;nsIOutputStream&gt; out;</span>
<a href="#l2.5456"></a><span id="l2.5456" class="difflineminus">-    nsresult rv = NS_NewSafeLocalFileOutputStream(getter_AddRefs(out),</span>
<a href="#l2.5457"></a><span id="l2.5457" class="difflineminus">-                                                  aBookmarksFile,</span>
<a href="#l2.5458"></a><span id="l2.5458" class="difflineminus">-                                                  -1,</span>
<a href="#l2.5459"></a><span id="l2.5459" class="difflineminus">-                                                  /*octal*/ 0600);</span>
<a href="#l2.5460"></a><span id="l2.5460" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l2.5461"></a><span id="l2.5461" class="difflineminus">-</span>
<a href="#l2.5462"></a><span id="l2.5462" class="difflineminus">-    // We need a buffered output stream for performance.</span>
<a href="#l2.5463"></a><span id="l2.5463" class="difflineminus">-    // See bug 202477.</span>
<a href="#l2.5464"></a><span id="l2.5464" class="difflineminus">-    nsCOMPtr&lt;nsIOutputStream&gt; strm;</span>
<a href="#l2.5465"></a><span id="l2.5465" class="difflineminus">-    rv = NS_NewBufferedOutputStream(getter_AddRefs(strm), out, 4096);</span>
<a href="#l2.5466"></a><span id="l2.5466" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l2.5467"></a><span id="l2.5467" class="difflineminus">-</span>
<a href="#l2.5468"></a><span id="l2.5468" class="difflineminus">-    PRUint32 dummy;</span>
<a href="#l2.5469"></a><span id="l2.5469" class="difflineminus">-    strm-&gt;Write(kFileIntro, sizeof(kFileIntro)-1, &amp;dummy);</span>
<a href="#l2.5470"></a><span id="l2.5470" class="difflineminus">-</span>
<a href="#l2.5471"></a><span id="l2.5471" class="difflineminus">-    nsCOMArray&lt;nsIRDFResource&gt; parentArray;</span>
<a href="#l2.5472"></a><span id="l2.5472" class="difflineminus">-    rv = WriteBookmarksContainer(aDataSource, strm, aRoot, 0, parentArray);</span>
<a href="#l2.5473"></a><span id="l2.5473" class="difflineminus">-</span>
<a href="#l2.5474"></a><span id="l2.5474" class="difflineminus">-    // All went ok. Maybe except for problems in Write(), but the stream detects</span>
<a href="#l2.5475"></a><span id="l2.5475" class="difflineminus">-    // that for us</span>
<a href="#l2.5476"></a><span id="l2.5476" class="difflineminus">-    nsCOMPtr&lt;nsISafeOutputStream&gt; safeStream = do_QueryInterface(strm);</span>
<a href="#l2.5477"></a><span id="l2.5477" class="difflineminus">-    NS_ASSERTION(safeStream, &quot;expected a safe output stream!&quot;);</span>
<a href="#l2.5478"></a><span id="l2.5478" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; safeStream)</span>
<a href="#l2.5479"></a><span id="l2.5479" class="difflineminus">-        rv = safeStream-&gt;Finish();</span>
<a href="#l2.5480"></a><span id="l2.5480" class="difflineminus">-</span>
<a href="#l2.5481"></a><span id="l2.5481" class="difflineminus">-    if (NS_FAILED(rv)) {</span>
<a href="#l2.5482"></a><span id="l2.5482" class="difflineminus">-        NS_WARNING(&quot;failed to save bookmarks file! possible dataloss&quot;);</span>
<a href="#l2.5483"></a><span id="l2.5483" class="difflineminus">-        return rv;</span>
<a href="#l2.5484"></a><span id="l2.5484" class="difflineminus">-    }</span>
<a href="#l2.5485"></a><span id="l2.5485" class="difflineminus">-</span>
<a href="#l2.5486"></a><span id="l2.5486" class="difflineminus">-    mDirty = PR_FALSE;</span>
<a href="#l2.5487"></a><span id="l2.5487" class="difflineminus">-    return NS_OK;</span>
<a href="#l2.5488"></a><span id="l2.5488" class="difflineminus">-}</span>
<a href="#l2.5489"></a><span id="l2.5489" class="difflineminus">-</span>
<a href="#l2.5490"></a><span id="l2.5490" class="difflineminus">-static const char kBookmarkIntro[] = &quot;&lt;DL&gt;&lt;p&gt;&quot; NS_LINEBREAK;</span>
<a href="#l2.5491"></a><span id="l2.5491" class="difflineminus">-static const char kIndent[] = &quot;    &quot;;</span>
<a href="#l2.5492"></a><span id="l2.5492" class="difflineminus">-static const char kContainerIntro[] = &quot;&lt;DT&gt;&lt;H3&quot;;</span>
<a href="#l2.5493"></a><span id="l2.5493" class="difflineminus">-static const char kSpaceStr[] = &quot; &quot;;</span>
<a href="#l2.5494"></a><span id="l2.5494" class="difflineminus">-static const char kTrueEnd[] = &quot;true\&quot;&quot;;</span>
<a href="#l2.5495"></a><span id="l2.5495" class="difflineminus">-static const char kQuoteStr[] = &quot;\&quot;&quot;;</span>
<a href="#l2.5496"></a><span id="l2.5496" class="difflineminus">-static const char kCloseAngle[] = &quot;&gt;&quot;;</span>
<a href="#l2.5497"></a><span id="l2.5497" class="difflineminus">-static const char kCloseH3[] = &quot;&lt;/H3&gt;&quot; NS_LINEBREAK;</span>
<a href="#l2.5498"></a><span id="l2.5498" class="difflineminus">-static const char kHROpen[] = &quot;&lt;HR&quot;;</span>
<a href="#l2.5499"></a><span id="l2.5499" class="difflineminus">-static const char kAngleNL[] = &quot;&gt;&quot; NS_LINEBREAK;</span>
<a href="#l2.5500"></a><span id="l2.5500" class="difflineminus">-static const char kDTOpen[] = &quot;&lt;DT&gt;&lt;A&quot;;</span>
<a href="#l2.5501"></a><span id="l2.5501" class="difflineminus">-static const char kAClose[] = &quot;&lt;/A&gt;&quot; NS_LINEBREAK;</span>
<a href="#l2.5502"></a><span id="l2.5502" class="difflineminus">-static const char kBookmarkClose[] = &quot;&lt;/DL&gt;&lt;p&gt;&quot; NS_LINEBREAK;</span>
<a href="#l2.5503"></a><span id="l2.5503" class="difflineminus">-static const char kNL[] = NS_LINEBREAK;</span>
<a href="#l2.5504"></a><span id="l2.5504" class="difflineminus">-</span>
<a href="#l2.5505"></a><span id="l2.5505" class="difflineminus">-nsresult</span>
<a href="#l2.5506"></a><span id="l2.5506" class="difflineminus">-nsBookmarksService::WriteBookmarksContainer(nsIRDFDataSource *ds,</span>
<a href="#l2.5507"></a><span id="l2.5507" class="difflineminus">-                                            nsIOutputStream* strm,</span>
<a href="#l2.5508"></a><span id="l2.5508" class="difflineminus">-                                            nsIRDFResource *parent, PRInt32 level,</span>
<a href="#l2.5509"></a><span id="l2.5509" class="difflineminus">-                                            nsCOMArray&lt;nsIRDFResource&gt;&amp; parentArray)</span>
<a href="#l2.5510"></a><span id="l2.5510" class="difflineminus">-{</span>
<a href="#l2.5511"></a><span id="l2.5511" class="difflineminus">-    // rv is used for various functions</span>
<a href="#l2.5512"></a><span id="l2.5512" class="difflineminus">-    nsresult rv;</span>
<a href="#l2.5513"></a><span id="l2.5513" class="difflineminus">-</span>
<a href="#l2.5514"></a><span id="l2.5514" class="difflineminus">-    nsCOMPtr&lt;nsIRDFContainer&gt; container =</span>
<a href="#l2.5515"></a><span id="l2.5515" class="difflineminus">-            do_CreateInstance(kRDFContainerCID, &amp;rv);</span>
<a href="#l2.5516"></a><span id="l2.5516" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.5517"></a><span id="l2.5517" class="difflineminus">-</span>
<a href="#l2.5518"></a><span id="l2.5518" class="difflineminus">-    nsCAutoString   indentation;</span>
<a href="#l2.5519"></a><span id="l2.5519" class="difflineminus">-</span>
<a href="#l2.5520"></a><span id="l2.5520" class="difflineminus">-    for (PRInt32 loop=0; loop&lt;level; loop++)</span>
<a href="#l2.5521"></a><span id="l2.5521" class="difflineminus">-        indentation.Append(kIndent, sizeof(kIndent)-1);</span>
<a href="#l2.5522"></a><span id="l2.5522" class="difflineminus">-</span>
<a href="#l2.5523"></a><span id="l2.5523" class="difflineminus">-    PRUint32 dummy;</span>
<a href="#l2.5524"></a><span id="l2.5524" class="difflineminus">-    rv = strm-&gt;Write(indentation.get(), indentation.Length(), &amp;dummy);</span>
<a href="#l2.5525"></a><span id="l2.5525" class="difflineminus">-    rv |= strm-&gt;Write(kBookmarkIntro, sizeof(kBookmarkIntro)-1, &amp;dummy);</span>
<a href="#l2.5526"></a><span id="l2.5526" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, NS_ERROR_UNEXPECTED);</span>
<a href="#l2.5527"></a><span id="l2.5527" class="difflineminus">-</span>
<a href="#l2.5528"></a><span id="l2.5528" class="difflineminus">-    rv = container-&gt;Init(ds, parent);</span>
<a href="#l2.5529"></a><span id="l2.5529" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; (parentArray.IndexOfObject(parent) &lt; 0))</span>
<a href="#l2.5530"></a><span id="l2.5530" class="difflineminus">-    {</span>
<a href="#l2.5531"></a><span id="l2.5531" class="difflineminus">-        // Note: once we've added something into the parentArray, don't &quot;return&quot; out</span>
<a href="#l2.5532"></a><span id="l2.5532" class="difflineminus">-        //       of this function without removing it from the parentArray!</span>
<a href="#l2.5533"></a><span id="l2.5533" class="difflineminus">-        parentArray.InsertObjectAt(parent, 0);</span>
<a href="#l2.5534"></a><span id="l2.5534" class="difflineminus">-</span>
<a href="#l2.5535"></a><span id="l2.5535" class="difflineminus">-        nsCOMPtr&lt;nsISimpleEnumerator&gt;   children;</span>
<a href="#l2.5536"></a><span id="l2.5536" class="difflineminus">-        if (NS_SUCCEEDED(rv = container-&gt;GetElements(getter_AddRefs(children))))</span>
<a href="#l2.5537"></a><span id="l2.5537" class="difflineminus">-        {</span>
<a href="#l2.5538"></a><span id="l2.5538" class="difflineminus">-            PRBool  more = PR_TRUE;</span>
<a href="#l2.5539"></a><span id="l2.5539" class="difflineminus">-            while (more == PR_TRUE)</span>
<a href="#l2.5540"></a><span id="l2.5540" class="difflineminus">-            {</span>
<a href="#l2.5541"></a><span id="l2.5541" class="difflineminus">-                if (NS_FAILED(rv = children-&gt;HasMoreElements(&amp;more)))   break;</span>
<a href="#l2.5542"></a><span id="l2.5542" class="difflineminus">-                if (more != PR_TRUE)    break;</span>
<a href="#l2.5543"></a><span id="l2.5543" class="difflineminus">-</span>
<a href="#l2.5544"></a><span id="l2.5544" class="difflineminus">-                nsCOMPtr&lt;nsISupports&gt;   iSupports;                  </span>
<a href="#l2.5545"></a><span id="l2.5545" class="difflineminus">-                if (NS_FAILED(rv = children-&gt;GetNext(getter_AddRefs(iSupports))))   break;</span>
<a href="#l2.5546"></a><span id="l2.5546" class="difflineminus">-</span>
<a href="#l2.5547"></a><span id="l2.5547" class="difflineminus">-                nsCOMPtr&lt;nsIRDFResource&gt;    child = do_QueryInterface(iSupports);</span>
<a href="#l2.5548"></a><span id="l2.5548" class="difflineminus">-                if (!child) break;</span>
<a href="#l2.5549"></a><span id="l2.5549" class="difflineminus">-</span>
<a href="#l2.5550"></a><span id="l2.5550" class="difflineminus">-                PRBool  isContainer = PR_FALSE;</span>
<a href="#l2.5551"></a><span id="l2.5551" class="difflineminus">-                if (child.get() != kNC_IEFavoritesRoot)</span>
<a href="#l2.5552"></a><span id="l2.5552" class="difflineminus">-                {</span>
<a href="#l2.5553"></a><span id="l2.5553" class="difflineminus">-                    rv = gRDFC-&gt;IsContainer(ds, child, &amp;isContainer);</span>
<a href="#l2.5554"></a><span id="l2.5554" class="difflineminus">-                    if (NS_FAILED(rv)) break;</span>
<a href="#l2.5555"></a><span id="l2.5555" class="difflineminus">-                }</span>
<a href="#l2.5556"></a><span id="l2.5556" class="difflineminus">-</span>
<a href="#l2.5557"></a><span id="l2.5557" class="difflineminus">-                nsCOMPtr&lt;nsIRDFNode&gt;    nameNode;</span>
<a href="#l2.5558"></a><span id="l2.5558" class="difflineminus">-                nsCAutoString       name;</span>
<a href="#l2.5559"></a><span id="l2.5559" class="difflineminus">-                rv = ds-&gt;GetTarget(child, kNC_Name, PR_TRUE, getter_AddRefs(nameNode));</span>
<a href="#l2.5560"></a><span id="l2.5560" class="difflineminus">-                if (NS_SUCCEEDED(rv) &amp;&amp; nameNode)</span>
<a href="#l2.5561"></a><span id="l2.5561" class="difflineminus">-                {</span>
<a href="#l2.5562"></a><span id="l2.5562" class="difflineminus">-                    nsCOMPtr&lt;nsIRDFLiteral&gt; nameLiteral = do_QueryInterface(nameNode);</span>
<a href="#l2.5563"></a><span id="l2.5563" class="difflineminus">-                    if (nameLiteral)</span>
<a href="#l2.5564"></a><span id="l2.5564" class="difflineminus">-                    {</span>
<a href="#l2.5565"></a><span id="l2.5565" class="difflineminus">-                        const PRUnichar *title = nsnull;</span>
<a href="#l2.5566"></a><span id="l2.5566" class="difflineminus">-                        if (NS_SUCCEEDED(rv = nameLiteral-&gt;GetValueConst(&amp;title)))</span>
<a href="#l2.5567"></a><span id="l2.5567" class="difflineminus">-                        {</span>
<a href="#l2.5568"></a><span id="l2.5568" class="difflineminus">-                            CopyUTF16toUTF8(nsDependentString(title), name);</span>
<a href="#l2.5569"></a><span id="l2.5569" class="difflineminus">-                        }</span>
<a href="#l2.5570"></a><span id="l2.5570" class="difflineminus">-                    }</span>
<a href="#l2.5571"></a><span id="l2.5571" class="difflineminus">-                }</span>
<a href="#l2.5572"></a><span id="l2.5572" class="difflineminus">-</span>
<a href="#l2.5573"></a><span id="l2.5573" class="difflineminus">-                rv = strm-&gt;Write(indentation.get(), indentation.Length(), &amp;dummy);</span>
<a href="#l2.5574"></a><span id="l2.5574" class="difflineminus">-                rv |= strm-&gt;Write(kIndent, sizeof(kIndent)-1, &amp;dummy);</span>
<a href="#l2.5575"></a><span id="l2.5575" class="difflineminus">-                if (NS_FAILED(rv)) break;</span>
<a href="#l2.5576"></a><span id="l2.5576" class="difflineminus">-</span>
<a href="#l2.5577"></a><span id="l2.5577" class="difflineminus">-                if (isContainer == PR_TRUE)</span>
<a href="#l2.5578"></a><span id="l2.5578" class="difflineminus">-                {</span>
<a href="#l2.5579"></a><span id="l2.5579" class="difflineminus">-                    rv = strm-&gt;Write(kContainerIntro, sizeof(kContainerIntro)-1, &amp;dummy);</span>
<a href="#l2.5580"></a><span id="l2.5580" class="difflineminus">-                    // output ADD_DATE</span>
<a href="#l2.5581"></a><span id="l2.5581" class="difflineminus">-                    rv |= WriteBookmarkProperties(ds, strm, child, kNC_BookmarkAddDate, kAddDateEquals, PR_FALSE);</span>
<a href="#l2.5582"></a><span id="l2.5582" class="difflineminus">-</span>
<a href="#l2.5583"></a><span id="l2.5583" class="difflineminus">-                    // output LAST_MODIFIED</span>
<a href="#l2.5584"></a><span id="l2.5584" class="difflineminus">-                    rv |= WriteBookmarkProperties(ds, strm, child, kWEB_LastModifiedDate, kLastModifiedEquals, PR_FALSE);</span>
<a href="#l2.5585"></a><span id="l2.5585" class="difflineminus">-                    if (NS_FAILED(rv)) break;</span>
<a href="#l2.5586"></a><span id="l2.5586" class="difflineminus">-</span>
<a href="#l2.5587"></a><span id="l2.5587" class="difflineminus">-                    // output various special folder hints</span>
<a href="#l2.5588"></a><span id="l2.5588" class="difflineminus">-                    PRBool  hasType = PR_FALSE;</span>
<a href="#l2.5589"></a><span id="l2.5589" class="difflineminus">-                    if (NS_SUCCEEDED(rv = mInner-&gt;HasAssertion(child, kNC_FolderType, kNC_NewBookmarkFolder,</span>
<a href="#l2.5590"></a><span id="l2.5590" class="difflineminus">-                                                               PR_TRUE, &amp;hasType)) &amp;&amp; (hasType == PR_TRUE))</span>
<a href="#l2.5591"></a><span id="l2.5591" class="difflineminus">-                    {</span>
<a href="#l2.5592"></a><span id="l2.5592" class="difflineminus">-                        rv = strm-&gt;Write(kSpaceStr, sizeof(kSpaceStr)-1, &amp;dummy);</span>
<a href="#l2.5593"></a><span id="l2.5593" class="difflineminus">-                        rv |= strm-&gt;Write(kNewBookmarkFolderEquals, sizeof(kNewBookmarkFolderEquals)-1, &amp;dummy);</span>
<a href="#l2.5594"></a><span id="l2.5594" class="difflineminus">-                        rv |= strm-&gt;Write(kTrueEnd, sizeof(kTrueEnd)-1, &amp;dummy);</span>
<a href="#l2.5595"></a><span id="l2.5595" class="difflineminus">-                        if (NS_FAILED(rv)) break;</span>
<a href="#l2.5596"></a><span id="l2.5596" class="difflineminus">-                    }</span>
<a href="#l2.5597"></a><span id="l2.5597" class="difflineminus">-                    if (NS_SUCCEEDED(rv = mInner-&gt;HasAssertion(child, kNC_FolderType, kNC_NewSearchFolder,</span>
<a href="#l2.5598"></a><span id="l2.5598" class="difflineminus">-                                                               PR_TRUE, &amp;hasType)) &amp;&amp; (hasType == PR_TRUE))</span>
<a href="#l2.5599"></a><span id="l2.5599" class="difflineminus">-                    {</span>
<a href="#l2.5600"></a><span id="l2.5600" class="difflineminus">-                        rv = strm-&gt;Write(kSpaceStr, sizeof(kSpaceStr)-1, &amp;dummy);</span>
<a href="#l2.5601"></a><span id="l2.5601" class="difflineminus">-                        rv |= strm-&gt;Write(kNewSearchFolderEquals, sizeof(kNewSearchFolderEquals)-1, &amp;dummy);</span>
<a href="#l2.5602"></a><span id="l2.5602" class="difflineminus">-                        rv |= strm-&gt;Write(kTrueEnd, sizeof(kTrueEnd)-1, &amp;dummy);</span>
<a href="#l2.5603"></a><span id="l2.5603" class="difflineminus">-                        if (NS_FAILED(rv)) break;</span>
<a href="#l2.5604"></a><span id="l2.5604" class="difflineminus">-                    }</span>
<a href="#l2.5605"></a><span id="l2.5605" class="difflineminus">-                    if (NS_SUCCEEDED(rv = mInner-&gt;HasAssertion(child, kNC_FolderType, kNC_PersonalToolbarFolder,</span>
<a href="#l2.5606"></a><span id="l2.5606" class="difflineminus">-                                                               PR_TRUE, &amp;hasType)) &amp;&amp; (hasType == PR_TRUE))</span>
<a href="#l2.5607"></a><span id="l2.5607" class="difflineminus">-                    {</span>
<a href="#l2.5608"></a><span id="l2.5608" class="difflineminus">-                        rv = strm-&gt;Write(kSpaceStr, sizeof(kSpaceStr)-1, &amp;dummy);</span>
<a href="#l2.5609"></a><span id="l2.5609" class="difflineminus">-                        rv |= strm-&gt;Write(kPersonalToolbarFolderEquals, sizeof(kPersonalToolbarFolderEquals)-1, &amp;dummy);</span>
<a href="#l2.5610"></a><span id="l2.5610" class="difflineminus">-                        rv |= strm-&gt;Write(kTrueEnd, sizeof(kTrueEnd)-1, &amp;dummy);</span>
<a href="#l2.5611"></a><span id="l2.5611" class="difflineminus">-                        if (NS_FAILED(rv)) break;</span>
<a href="#l2.5612"></a><span id="l2.5612" class="difflineminus">-                    }</span>
<a href="#l2.5613"></a><span id="l2.5613" class="difflineminus">-</span>
<a href="#l2.5614"></a><span id="l2.5614" class="difflineminus">-                    if (NS_SUCCEEDED(rv = mInner-&gt;HasArcOut(child, kNC_FolderGroup, &amp;hasType)) &amp;&amp; </span>
<a href="#l2.5615"></a><span id="l2.5615" class="difflineminus">-                        (hasType == PR_TRUE))</span>
<a href="#l2.5616"></a><span id="l2.5616" class="difflineminus">-                    {</span>
<a href="#l2.5617"></a><span id="l2.5617" class="difflineminus">-                        rv = strm-&gt;Write(kSpaceStr, sizeof(kSpaceStr)-1, &amp;dummy);</span>
<a href="#l2.5618"></a><span id="l2.5618" class="difflineminus">-                        rv |= strm-&gt;Write(kFolderGroupEquals, sizeof(kFolderGroupEquals)-1, &amp;dummy);</span>
<a href="#l2.5619"></a><span id="l2.5619" class="difflineminus">-                        rv |= strm-&gt;Write(kTrueEnd, sizeof(kTrueEnd)-1, &amp;dummy);</span>
<a href="#l2.5620"></a><span id="l2.5620" class="difflineminus">-                        if (NS_FAILED(rv)) break;</span>
<a href="#l2.5621"></a><span id="l2.5621" class="difflineminus">-                    }</span>
<a href="#l2.5622"></a><span id="l2.5622" class="difflineminus">-</span>
<a href="#l2.5623"></a><span id="l2.5623" class="difflineminus">-                    // output ID</span>
<a href="#l2.5624"></a><span id="l2.5624" class="difflineminus">-                    const char  *id = nsnull;</span>
<a href="#l2.5625"></a><span id="l2.5625" class="difflineminus">-                    rv = child-&gt;GetValueConst(&amp;id);</span>
<a href="#l2.5626"></a><span id="l2.5626" class="difflineminus">-                    if (NS_SUCCEEDED(rv) &amp;&amp; (id))</span>
<a href="#l2.5627"></a><span id="l2.5627" class="difflineminus">-                    {</span>
<a href="#l2.5628"></a><span id="l2.5628" class="difflineminus">-                        rv = strm-&gt;Write(kSpaceStr, sizeof(kSpaceStr)-1, &amp;dummy);</span>
<a href="#l2.5629"></a><span id="l2.5629" class="difflineminus">-                        rv |= strm-&gt;Write(kIDEquals, sizeof(kIDEquals)-1, &amp;dummy);</span>
<a href="#l2.5630"></a><span id="l2.5630" class="difflineminus">-                        rv |= strm-&gt;Write(id, strlen(id), &amp;dummy);</span>
<a href="#l2.5631"></a><span id="l2.5631" class="difflineminus">-                        rv |= strm-&gt;Write(kQuoteStr, sizeof(kQuoteStr)-1, &amp;dummy);</span>
<a href="#l2.5632"></a><span id="l2.5632" class="difflineminus">-                        if (NS_FAILED(rv)) break;</span>
<a href="#l2.5633"></a><span id="l2.5633" class="difflineminus">-                    }</span>
<a href="#l2.5634"></a><span id="l2.5634" class="difflineminus">-          </span>
<a href="#l2.5635"></a><span id="l2.5635" class="difflineminus">-                    rv = strm-&gt;Write(kCloseAngle, sizeof(kCloseAngle)-1, &amp;dummy);</span>
<a href="#l2.5636"></a><span id="l2.5636" class="difflineminus">-          </span>
<a href="#l2.5637"></a><span id="l2.5637" class="difflineminus">-                    // output title</span>
<a href="#l2.5638"></a><span id="l2.5638" class="difflineminus">-                    if (!name.IsEmpty())</span>
<a href="#l2.5639"></a><span id="l2.5639" class="difflineminus">-                    {</span>
<a href="#l2.5640"></a><span id="l2.5640" class="difflineminus">-                        // see bug #65098</span>
<a href="#l2.5641"></a><span id="l2.5641" class="difflineminus">-                        EscapeHTML(name);</span>
<a href="#l2.5642"></a><span id="l2.5642" class="difflineminus">-</span>
<a href="#l2.5643"></a><span id="l2.5643" class="difflineminus">-                        rv |= strm-&gt;Write(name.get(), name.Length(), &amp;dummy);</span>
<a href="#l2.5644"></a><span id="l2.5644" class="difflineminus">-                    }</span>
<a href="#l2.5645"></a><span id="l2.5645" class="difflineminus">-                    rv |= strm-&gt;Write(kCloseH3, sizeof(kCloseH3)-1, &amp;dummy);</span>
<a href="#l2.5646"></a><span id="l2.5646" class="difflineminus">-</span>
<a href="#l2.5647"></a><span id="l2.5647" class="difflineminus">-                    // output description (if one exists)</span>
<a href="#l2.5648"></a><span id="l2.5648" class="difflineminus">-                    rv |= WriteBookmarkProperties(ds, strm, child, kNC_Description, kOpenDD, PR_TRUE);</span>
<a href="#l2.5649"></a><span id="l2.5649" class="difflineminus">-</span>
<a href="#l2.5650"></a><span id="l2.5650" class="difflineminus">-                    rv |= WriteBookmarksContainer(ds, strm, child, level+1, parentArray);</span>
<a href="#l2.5651"></a><span id="l2.5651" class="difflineminus">-                }</span>
<a href="#l2.5652"></a><span id="l2.5652" class="difflineminus">-                else</span>
<a href="#l2.5653"></a><span id="l2.5653" class="difflineminus">-                {</span>
<a href="#l2.5654"></a><span id="l2.5654" class="difflineminus">-                    const char  *url = nsnull;</span>
<a href="#l2.5655"></a><span id="l2.5655" class="difflineminus">-                    if (NS_SUCCEEDED(rv = child-&gt;GetValueConst(&amp;url)) &amp;&amp; (url))</span>
<a href="#l2.5656"></a><span id="l2.5656" class="difflineminus">-                    {</span>
<a href="#l2.5657"></a><span id="l2.5657" class="difflineminus">-                        nsCAutoString   uri(url);</span>
<a href="#l2.5658"></a><span id="l2.5658" class="difflineminus">-</span>
<a href="#l2.5659"></a><span id="l2.5659" class="difflineminus">-                        PRBool      isBookmarkSeparator = PR_FALSE;</span>
<a href="#l2.5660"></a><span id="l2.5660" class="difflineminus">-                        if (NS_SUCCEEDED(mInner-&gt;HasAssertion(child, kRDF_type,</span>
<a href="#l2.5661"></a><span id="l2.5661" class="difflineminus">-                                                              kNC_BookmarkSeparator, PR_TRUE, &amp;isBookmarkSeparator)) &amp;&amp;</span>
<a href="#l2.5662"></a><span id="l2.5662" class="difflineminus">-                            (isBookmarkSeparator == PR_TRUE) )</span>
<a href="#l2.5663"></a><span id="l2.5663" class="difflineminus">-                        {</span>
<a href="#l2.5664"></a><span id="l2.5664" class="difflineminus">-                            // its a separator</span>
<a href="#l2.5665"></a><span id="l2.5665" class="difflineminus">-                            rv = strm-&gt;Write(kHROpen, sizeof(kHROpen)-1, &amp;dummy);</span>
<a href="#l2.5666"></a><span id="l2.5666" class="difflineminus">-</span>
<a href="#l2.5667"></a><span id="l2.5667" class="difflineminus">-                            // output NAME</span>
<a href="#l2.5668"></a><span id="l2.5668" class="difflineminus">-                            rv |= WriteBookmarkProperties(ds, strm, child, kNC_Name, kNameEquals, PR_FALSE);</span>
<a href="#l2.5669"></a><span id="l2.5669" class="difflineminus">-</span>
<a href="#l2.5670"></a><span id="l2.5670" class="difflineminus">-                            rv |= strm-&gt;Write(kAngleNL, sizeof(kAngleNL)-1, &amp;dummy);</span>
<a href="#l2.5671"></a><span id="l2.5671" class="difflineminus">-                            if (NS_FAILED(rv)) break;</span>
<a href="#l2.5672"></a><span id="l2.5672" class="difflineminus">-                        }</span>
<a href="#l2.5673"></a><span id="l2.5673" class="difflineminus">-                        else</span>
<a href="#l2.5674"></a><span id="l2.5674" class="difflineminus">-                        {</span>
<a href="#l2.5675"></a><span id="l2.5675" class="difflineminus">-                            rv = strm-&gt;Write(kDTOpen, sizeof(kDTOpen)-1, &amp;dummy);</span>
<a href="#l2.5676"></a><span id="l2.5676" class="difflineminus">-</span>
<a href="#l2.5677"></a><span id="l2.5677" class="difflineminus">-                            // output URL</span>
<a href="#l2.5678"></a><span id="l2.5678" class="difflineminus">-                            rv |= WriteBookmarkProperties(ds, strm, child, kNC_URL, kHREFEquals, PR_FALSE);</span>
<a href="#l2.5679"></a><span id="l2.5679" class="difflineminus">-</span>
<a href="#l2.5680"></a><span id="l2.5680" class="difflineminus">-                            // output ADD_DATE</span>
<a href="#l2.5681"></a><span id="l2.5681" class="difflineminus">-                            rv |= WriteBookmarkProperties(ds, strm, child, kNC_BookmarkAddDate, kAddDateEquals, PR_FALSE);</span>
<a href="#l2.5682"></a><span id="l2.5682" class="difflineminus">-</span>
<a href="#l2.5683"></a><span id="l2.5683" class="difflineminus">-                            // output LAST_VISIT</span>
<a href="#l2.5684"></a><span id="l2.5684" class="difflineminus">-                            rv |= WriteBookmarkProperties(ds, strm, child, kWEB_LastVisitDate, kLastVisitEquals, PR_FALSE);</span>
<a href="#l2.5685"></a><span id="l2.5685" class="difflineminus">-</span>
<a href="#l2.5686"></a><span id="l2.5686" class="difflineminus">-                            // output LAST_MODIFIED</span>
<a href="#l2.5687"></a><span id="l2.5687" class="difflineminus">-                            rv |= WriteBookmarkProperties(ds, strm, child, kWEB_LastModifiedDate, kLastModifiedEquals, PR_FALSE);</span>
<a href="#l2.5688"></a><span id="l2.5688" class="difflineminus">-</span>
<a href="#l2.5689"></a><span id="l2.5689" class="difflineminus">-                            // output SHORTCUTURL</span>
<a href="#l2.5690"></a><span id="l2.5690" class="difflineminus">-                            rv |= WriteBookmarkProperties(ds, strm, child, kNC_ShortcutURL, kShortcutURLEquals, PR_FALSE);</span>
<a href="#l2.5691"></a><span id="l2.5691" class="difflineminus">-</span>
<a href="#l2.5692"></a><span id="l2.5692" class="difflineminus">-                            // output kNC_Icon</span>
<a href="#l2.5693"></a><span id="l2.5693" class="difflineminus">-                            rv |= WriteBookmarkProperties(ds, strm, child, kNC_Icon, kIconEquals, PR_FALSE);</span>
<a href="#l2.5694"></a><span id="l2.5694" class="difflineminus">-</span>
<a href="#l2.5695"></a><span id="l2.5695" class="difflineminus">-                            // output SCHEDULE</span>
<a href="#l2.5696"></a><span id="l2.5696" class="difflineminus">-                            rv |= WriteBookmarkProperties(ds, strm, child, kWEB_Schedule, kScheduleEquals, PR_FALSE);</span>
<a href="#l2.5697"></a><span id="l2.5697" class="difflineminus">-</span>
<a href="#l2.5698"></a><span id="l2.5698" class="difflineminus">-                            // output LAST_PING</span>
<a href="#l2.5699"></a><span id="l2.5699" class="difflineminus">-                            rv |= WriteBookmarkProperties(ds, strm, child, kWEB_LastPingDate, kLastPingEquals, PR_FALSE);</span>
<a href="#l2.5700"></a><span id="l2.5700" class="difflineminus">-</span>
<a href="#l2.5701"></a><span id="l2.5701" class="difflineminus">-                            // output PING_ETAG</span>
<a href="#l2.5702"></a><span id="l2.5702" class="difflineminus">-                            rv |= WriteBookmarkProperties(ds, strm, child, kWEB_LastPingETag, kPingETagEquals, PR_FALSE);</span>
<a href="#l2.5703"></a><span id="l2.5703" class="difflineminus">-</span>
<a href="#l2.5704"></a><span id="l2.5704" class="difflineminus">-                            // output PING_LAST_MODIFIED</span>
<a href="#l2.5705"></a><span id="l2.5705" class="difflineminus">-                            rv |= WriteBookmarkProperties(ds, strm, child, kWEB_LastPingModDate, kPingLastModEquals, PR_FALSE);</span>
<a href="#l2.5706"></a><span id="l2.5706" class="difflineminus">-</span>
<a href="#l2.5707"></a><span id="l2.5707" class="difflineminus">-                            // output LAST_CHARSET</span>
<a href="#l2.5708"></a><span id="l2.5708" class="difflineminus">-                            rv |= WriteBookmarkProperties(ds, strm, child, kWEB_LastCharset, kLastCharsetEquals, PR_FALSE);</span>
<a href="#l2.5709"></a><span id="l2.5709" class="difflineminus">-</span>
<a href="#l2.5710"></a><span id="l2.5710" class="difflineminus">-                            // output PING_CONTENT_LEN</span>
<a href="#l2.5711"></a><span id="l2.5711" class="difflineminus">-                            rv |= WriteBookmarkProperties(ds, strm, child, kWEB_LastPingContentLen, kPingContentLenEquals, PR_FALSE);</span>
<a href="#l2.5712"></a><span id="l2.5712" class="difflineminus">-</span>
<a href="#l2.5713"></a><span id="l2.5713" class="difflineminus">-                            // output PING_STATUS</span>
<a href="#l2.5714"></a><span id="l2.5714" class="difflineminus">-                            rv |= WriteBookmarkProperties(ds, strm, child, kWEB_Status, kPingStatusEquals, PR_FALSE);</span>
<a href="#l2.5715"></a><span id="l2.5715" class="difflineminus">-                            if (NS_FAILED(rv)) break;</span>
<a href="#l2.5716"></a><span id="l2.5716" class="difflineminus">-                            </span>
<a href="#l2.5717"></a><span id="l2.5717" class="difflineminus">-                            // output ID</span>
<a href="#l2.5718"></a><span id="l2.5718" class="difflineminus">-                            const char  *id = nsnull;</span>
<a href="#l2.5719"></a><span id="l2.5719" class="difflineminus">-                            rv = child-&gt;GetValueConst(&amp;id);</span>
<a href="#l2.5720"></a><span id="l2.5720" class="difflineminus">-                            if (NS_SUCCEEDED(rv) &amp;&amp; (id))</span>
<a href="#l2.5721"></a><span id="l2.5721" class="difflineminus">-                            {</span>
<a href="#l2.5722"></a><span id="l2.5722" class="difflineminus">-                                rv = strm-&gt;Write(kSpaceStr, sizeof(kSpaceStr)-1, &amp;dummy);</span>
<a href="#l2.5723"></a><span id="l2.5723" class="difflineminus">-                                rv |= strm-&gt;Write(kIDEquals, sizeof(kIDEquals)-1, &amp;dummy);</span>
<a href="#l2.5724"></a><span id="l2.5724" class="difflineminus">-                                rv |= strm-&gt;Write(id, strlen(id), &amp;dummy);</span>
<a href="#l2.5725"></a><span id="l2.5725" class="difflineminus">-                                rv |= strm-&gt;Write(kQuoteStr, sizeof(kQuoteStr)-1, &amp;dummy);</span>
<a href="#l2.5726"></a><span id="l2.5726" class="difflineminus">-                                if (NS_FAILED(rv)) break;</span>
<a href="#l2.5727"></a><span id="l2.5727" class="difflineminus">-                            }</span>
<a href="#l2.5728"></a><span id="l2.5728" class="difflineminus">-</span>
<a href="#l2.5729"></a><span id="l2.5729" class="difflineminus">-                            rv = strm-&gt;Write(kCloseAngle, sizeof(kCloseAngle)-1, &amp;dummy);</span>
<a href="#l2.5730"></a><span id="l2.5730" class="difflineminus">-</span>
<a href="#l2.5731"></a><span id="l2.5731" class="difflineminus">-                            // output title</span>
<a href="#l2.5732"></a><span id="l2.5732" class="difflineminus">-                            if (!name.IsEmpty())</span>
<a href="#l2.5733"></a><span id="l2.5733" class="difflineminus">-                            {</span>
<a href="#l2.5734"></a><span id="l2.5734" class="difflineminus">-                                // Note: we escape the title due to security issues;</span>
<a href="#l2.5735"></a><span id="l2.5735" class="difflineminus">-                                //       see bug # 13197 for details</span>
<a href="#l2.5736"></a><span id="l2.5736" class="difflineminus">-                                EscapeHTML(name);</span>
<a href="#l2.5737"></a><span id="l2.5737" class="difflineminus">-</span>
<a href="#l2.5738"></a><span id="l2.5738" class="difflineminus">-                                rv |= strm-&gt;Write(name.get(), name.Length(),</span>
<a href="#l2.5739"></a><span id="l2.5739" class="difflineminus">-                                                  &amp;dummy);</span>
<a href="#l2.5740"></a><span id="l2.5740" class="difflineminus">-                            }</span>
<a href="#l2.5741"></a><span id="l2.5741" class="difflineminus">-</span>
<a href="#l2.5742"></a><span id="l2.5742" class="difflineminus">-                            rv |= strm-&gt;Write(kAClose, sizeof(kAClose)-1, &amp;dummy);</span>
<a href="#l2.5743"></a><span id="l2.5743" class="difflineminus">-                            </span>
<a href="#l2.5744"></a><span id="l2.5744" class="difflineminus">-                            // output description (if one exists)</span>
<a href="#l2.5745"></a><span id="l2.5745" class="difflineminus">-                            rv |= WriteBookmarkProperties(ds, strm, child, kNC_Description, kOpenDD, PR_TRUE);</span>
<a href="#l2.5746"></a><span id="l2.5746" class="difflineminus">-                        }</span>
<a href="#l2.5747"></a><span id="l2.5747" class="difflineminus">-                    }</span>
<a href="#l2.5748"></a><span id="l2.5748" class="difflineminus">-                }</span>
<a href="#l2.5749"></a><span id="l2.5749" class="difflineminus">-</span>
<a href="#l2.5750"></a><span id="l2.5750" class="difflineminus">-                if (NS_FAILED(rv))  break;</span>
<a href="#l2.5751"></a><span id="l2.5751" class="difflineminus">-            }</span>
<a href="#l2.5752"></a><span id="l2.5752" class="difflineminus">-        }</span>
<a href="#l2.5753"></a><span id="l2.5753" class="difflineminus">-</span>
<a href="#l2.5754"></a><span id="l2.5754" class="difflineminus">-        // cleanup: remove current parent element from parentArray</span>
<a href="#l2.5755"></a><span id="l2.5755" class="difflineminus">-        parentArray.RemoveObjectAt(0);</span>
<a href="#l2.5756"></a><span id="l2.5756" class="difflineminus">-    }</span>
<a href="#l2.5757"></a><span id="l2.5757" class="difflineminus">-</span>
<a href="#l2.5758"></a><span id="l2.5758" class="difflineminus">-    rv |= strm-&gt;Write(indentation.get(), indentation.Length(), &amp;dummy);</span>
<a href="#l2.5759"></a><span id="l2.5759" class="difflineminus">-    rv |= strm-&gt;Write(kBookmarkClose, sizeof(kBookmarkClose)-1, &amp;dummy);</span>
<a href="#l2.5760"></a><span id="l2.5760" class="difflineminus">-</span>
<a href="#l2.5761"></a><span id="l2.5761" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, NS_ERROR_UNEXPECTED);</span>
<a href="#l2.5762"></a><span id="l2.5762" class="difflineminus">-</span>
<a href="#l2.5763"></a><span id="l2.5763" class="difflineminus">-    return NS_OK;</span>
<a href="#l2.5764"></a><span id="l2.5764" class="difflineminus">-}</span>
<a href="#l2.5765"></a><span id="l2.5765" class="difflineminus">-</span>
<a href="#l2.5766"></a><span id="l2.5766" class="difflineminus">-nsresult</span>
<a href="#l2.5767"></a><span id="l2.5767" class="difflineminus">-nsBookmarksService::SerializeBookmarks(nsIURI* aURI)</span>
<a href="#l2.5768"></a><span id="l2.5768" class="difflineminus">-{</span>
<a href="#l2.5769"></a><span id="l2.5769" class="difflineminus">-    NS_ASSERTION(aURI, &quot;null ptr&quot;);</span>
<a href="#l2.5770"></a><span id="l2.5770" class="difflineminus">-</span>
<a href="#l2.5771"></a><span id="l2.5771" class="difflineminus">-    nsresult rv;</span>
<a href="#l2.5772"></a><span id="l2.5772" class="difflineminus">-    nsCOMPtr&lt;nsIFileURL&gt; fileURL = do_QueryInterface(aURI, &amp;rv);</span>
<a href="#l2.5773"></a><span id="l2.5773" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l2.5774"></a><span id="l2.5774" class="difflineminus">-</span>
<a href="#l2.5775"></a><span id="l2.5775" class="difflineminus">-    nsCOMPtr&lt;nsIFile&gt; file;</span>
<a href="#l2.5776"></a><span id="l2.5776" class="difflineminus">-    rv = fileURL-&gt;GetFile(getter_AddRefs(file));</span>
<a href="#l2.5777"></a><span id="l2.5777" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l2.5778"></a><span id="l2.5778" class="difflineminus">-</span>
<a href="#l2.5779"></a><span id="l2.5779" class="difflineminus">-    // if file doesn't exist, create it</span>
<a href="#l2.5780"></a><span id="l2.5780" class="difflineminus">-    (void)file-&gt;Create(nsIFile::NORMAL_FILE_TYPE, 0666);</span>
<a href="#l2.5781"></a><span id="l2.5781" class="difflineminus">-</span>
<a href="#l2.5782"></a><span id="l2.5782" class="difflineminus">-    nsCOMPtr&lt;nsIOutputStream&gt; out;</span>
<a href="#l2.5783"></a><span id="l2.5783" class="difflineminus">-    rv = NS_NewLocalFileOutputStream(getter_AddRefs(out), file);</span>
<a href="#l2.5784"></a><span id="l2.5784" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l2.5785"></a><span id="l2.5785" class="difflineminus">-</span>
<a href="#l2.5786"></a><span id="l2.5786" class="difflineminus">-    nsCOMPtr&lt;nsIOutputStream&gt; bufferedOut;</span>
<a href="#l2.5787"></a><span id="l2.5787" class="difflineminus">-    rv = NS_NewBufferedOutputStream(getter_AddRefs(bufferedOut), out, 4096);</span>
<a href="#l2.5788"></a><span id="l2.5788" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l2.5789"></a><span id="l2.5789" class="difflineminus">-</span>
<a href="#l2.5790"></a><span id="l2.5790" class="difflineminus">-    nsCOMPtr&lt;nsIRDFXMLSerializer&gt; serializer =</span>
<a href="#l2.5791"></a><span id="l2.5791" class="difflineminus">-        do_CreateInstance(&quot;@mozilla.org/rdf/xml-serializer;1&quot;, &amp;rv);</span>
<a href="#l2.5792"></a><span id="l2.5792" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l2.5793"></a><span id="l2.5793" class="difflineminus">-</span>
<a href="#l2.5794"></a><span id="l2.5794" class="difflineminus">-    rv = serializer-&gt;Init(this);</span>
<a href="#l2.5795"></a><span id="l2.5795" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l2.5796"></a><span id="l2.5796" class="difflineminus">-</span>
<a href="#l2.5797"></a><span id="l2.5797" class="difflineminus">-    nsCOMPtr&lt;nsIRDFXMLSource&gt; source = do_QueryInterface(serializer);</span>
<a href="#l2.5798"></a><span id="l2.5798" class="difflineminus">-    if (! source)</span>
<a href="#l2.5799"></a><span id="l2.5799" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l2.5800"></a><span id="l2.5800" class="difflineminus">-</span>
<a href="#l2.5801"></a><span id="l2.5801" class="difflineminus">-    return source-&gt;Serialize(bufferedOut);</span>
<a href="#l2.5802"></a><span id="l2.5802" class="difflineminus">-}</span>
<a href="#l2.5803"></a><span id="l2.5803" class="difflineminus">-</span>
<a href="#l2.5804"></a><span id="l2.5804" class="difflineminus">-/*</span>
<a href="#l2.5805"></a><span id="l2.5805" class="difflineminus">-    Note: this routine is similar, yet distinctly different from, nsRDFContentUtils::GetTextForNode</span>
<a href="#l2.5806"></a><span id="l2.5806" class="difflineminus">-*/</span>
<a href="#l2.5807"></a><span id="l2.5807" class="difflineminus">-</span>
<a href="#l2.5808"></a><span id="l2.5808" class="difflineminus">-nsresult</span>
<a href="#l2.5809"></a><span id="l2.5809" class="difflineminus">-nsBookmarksService::GetTextForNode(nsIRDFNode* aNode, nsString&amp; aResult)</span>
<a href="#l2.5810"></a><span id="l2.5810" class="difflineminus">-{</span>
<a href="#l2.5811"></a><span id="l2.5811" class="difflineminus">-    nsresult        rv;</span>
<a href="#l2.5812"></a><span id="l2.5812" class="difflineminus">-    nsIRDFResource  *resource;</span>
<a href="#l2.5813"></a><span id="l2.5813" class="difflineminus">-    nsIRDFLiteral   *literal;</span>
<a href="#l2.5814"></a><span id="l2.5814" class="difflineminus">-    nsIRDFDate      *dateLiteral;</span>
<a href="#l2.5815"></a><span id="l2.5815" class="difflineminus">-    nsIRDFInt       *intLiteral;</span>
<a href="#l2.5816"></a><span id="l2.5816" class="difflineminus">-</span>
<a href="#l2.5817"></a><span id="l2.5817" class="difflineminus">-    if (! aNode)</span>
<a href="#l2.5818"></a><span id="l2.5818" class="difflineminus">-    {</span>
<a href="#l2.5819"></a><span id="l2.5819" class="difflineminus">-        aResult.Truncate();</span>
<a href="#l2.5820"></a><span id="l2.5820" class="difflineminus">-        rv = NS_OK;</span>
<a href="#l2.5821"></a><span id="l2.5821" class="difflineminus">-    }</span>
<a href="#l2.5822"></a><span id="l2.5822" class="difflineminus">-    else if (NS_SUCCEEDED(rv = aNode-&gt;QueryInterface(NS_GET_IID(nsIRDFResource), (void**) &amp;resource)))</span>
<a href="#l2.5823"></a><span id="l2.5823" class="difflineminus">-    {</span>
<a href="#l2.5824"></a><span id="l2.5824" class="difflineminus">-        const char  *p = nsnull;</span>
<a href="#l2.5825"></a><span id="l2.5825" class="difflineminus">-        if (NS_SUCCEEDED(rv = resource-&gt;GetValueConst( &amp;p )) &amp;&amp; (p))</span>
<a href="#l2.5826"></a><span id="l2.5826" class="difflineminus">-            CopyASCIItoUTF16(nsDependentCString(p), aResult);</span>
<a href="#l2.5827"></a><span id="l2.5827" class="difflineminus">-</span>
<a href="#l2.5828"></a><span id="l2.5828" class="difflineminus">-        NS_RELEASE(resource);</span>
<a href="#l2.5829"></a><span id="l2.5829" class="difflineminus">-    }</span>
<a href="#l2.5830"></a><span id="l2.5830" class="difflineminus">-    else if (NS_SUCCEEDED(rv = aNode-&gt;QueryInterface(NS_GET_IID(nsIRDFDate), (void**) &amp;dateLiteral)))</span>
<a href="#l2.5831"></a><span id="l2.5831" class="difflineminus">-    {</span>
<a href="#l2.5832"></a><span id="l2.5832" class="difflineminus">-    PRInt64     theDate, million;</span>
<a href="#l2.5833"></a><span id="l2.5833" class="difflineminus">-        if (NS_SUCCEEDED(rv = dateLiteral-&gt;GetValue( &amp;theDate )))</span>
<a href="#l2.5834"></a><span id="l2.5834" class="difflineminus">-        {</span>
<a href="#l2.5835"></a><span id="l2.5835" class="difflineminus">-            LL_I2L(million, PR_USEC_PER_SEC);</span>
<a href="#l2.5836"></a><span id="l2.5836" class="difflineminus">-            LL_DIV(theDate, theDate, million);          // convert from microseconds (PRTime) to seconds</span>
<a href="#l2.5837"></a><span id="l2.5837" class="difflineminus">-            PRInt32     now32;</span>
<a href="#l2.5838"></a><span id="l2.5838" class="difflineminus">-            LL_L2I(now32, theDate);</span>
<a href="#l2.5839"></a><span id="l2.5839" class="difflineminus">-            aResult.Truncate();</span>
<a href="#l2.5840"></a><span id="l2.5840" class="difflineminus">-            aResult.AppendInt(now32, 10);</span>
<a href="#l2.5841"></a><span id="l2.5841" class="difflineminus">-        }</span>
<a href="#l2.5842"></a><span id="l2.5842" class="difflineminus">-        NS_RELEASE(dateLiteral);</span>
<a href="#l2.5843"></a><span id="l2.5843" class="difflineminus">-    }</span>
<a href="#l2.5844"></a><span id="l2.5844" class="difflineminus">-    else if (NS_SUCCEEDED(rv = aNode-&gt;QueryInterface(NS_GET_IID(nsIRDFInt), (void**) &amp;intLiteral)))</span>
<a href="#l2.5845"></a><span id="l2.5845" class="difflineminus">-    {</span>
<a href="#l2.5846"></a><span id="l2.5846" class="difflineminus">-        PRInt32     theInt;</span>
<a href="#l2.5847"></a><span id="l2.5847" class="difflineminus">-        aResult.Truncate();</span>
<a href="#l2.5848"></a><span id="l2.5848" class="difflineminus">-        if (NS_SUCCEEDED(rv = intLiteral-&gt;GetValue( &amp;theInt )))</span>
<a href="#l2.5849"></a><span id="l2.5849" class="difflineminus">-        {</span>
<a href="#l2.5850"></a><span id="l2.5850" class="difflineminus">-            aResult.AppendInt(theInt, 10);</span>
<a href="#l2.5851"></a><span id="l2.5851" class="difflineminus">-        }</span>
<a href="#l2.5852"></a><span id="l2.5852" class="difflineminus">-        NS_RELEASE(intLiteral);</span>
<a href="#l2.5853"></a><span id="l2.5853" class="difflineminus">-    }</span>
<a href="#l2.5854"></a><span id="l2.5854" class="difflineminus">-    else if (NS_SUCCEEDED(rv = aNode-&gt;QueryInterface(NS_GET_IID(nsIRDFLiteral), (void**) &amp;literal)))</span>
<a href="#l2.5855"></a><span id="l2.5855" class="difflineminus">-    {</span>
<a href="#l2.5856"></a><span id="l2.5856" class="difflineminus">-        const PRUnichar     *p = nsnull;</span>
<a href="#l2.5857"></a><span id="l2.5857" class="difflineminus">-        if (NS_SUCCEEDED(rv = literal-&gt;GetValueConst( &amp;p )) &amp;&amp; (p))</span>
<a href="#l2.5858"></a><span id="l2.5858" class="difflineminus">-        {</span>
<a href="#l2.5859"></a><span id="l2.5859" class="difflineminus">-            aResult = p;</span>
<a href="#l2.5860"></a><span id="l2.5860" class="difflineminus">-        }</span>
<a href="#l2.5861"></a><span id="l2.5861" class="difflineminus">-        NS_RELEASE(literal);</span>
<a href="#l2.5862"></a><span id="l2.5862" class="difflineminus">-    }</span>
<a href="#l2.5863"></a><span id="l2.5863" class="difflineminus">-    else</span>
<a href="#l2.5864"></a><span id="l2.5864" class="difflineminus">-    {</span>
<a href="#l2.5865"></a><span id="l2.5865" class="difflineminus">-        NS_ERROR(&quot;not a resource or a literal&quot;);</span>
<a href="#l2.5866"></a><span id="l2.5866" class="difflineminus">-        rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l2.5867"></a><span id="l2.5867" class="difflineminus">-    }</span>
<a href="#l2.5868"></a><span id="l2.5868" class="difflineminus">-</span>
<a href="#l2.5869"></a><span id="l2.5869" class="difflineminus">-    return rv;</span>
<a href="#l2.5870"></a><span id="l2.5870" class="difflineminus">-}</span>
<a href="#l2.5871"></a><span id="l2.5871" class="difflineminus">-</span>
<a href="#l2.5872"></a><span id="l2.5872" class="difflineminus">-nsresult</span>
<a href="#l2.5873"></a><span id="l2.5873" class="difflineminus">-nsBookmarksService::WriteBookmarkProperties(nsIRDFDataSource *ds,</span>
<a href="#l2.5874"></a><span id="l2.5874" class="difflineminus">-    nsIOutputStream* strm, nsIRDFResource *child, nsIRDFResource *property,</span>
<a href="#l2.5875"></a><span id="l2.5875" class="difflineminus">-    const char *htmlAttrib, PRBool isFirst)</span>
<a href="#l2.5876"></a><span id="l2.5876" class="difflineminus">-{</span>
<a href="#l2.5877"></a><span id="l2.5877" class="difflineminus">-    nsresult  rv;</span>
<a href="#l2.5878"></a><span id="l2.5878" class="difflineminus">-    PRUint32  dummy;</span>
<a href="#l2.5879"></a><span id="l2.5879" class="difflineminus">-</span>
<a href="#l2.5880"></a><span id="l2.5880" class="difflineminus">-    nsCOMPtr&lt;nsIRDFNode&gt;    node;</span>
<a href="#l2.5881"></a><span id="l2.5881" class="difflineminus">-    if (NS_SUCCEEDED(rv = ds-&gt;GetTarget(child, property, PR_TRUE, getter_AddRefs(node)))</span>
<a href="#l2.5882"></a><span id="l2.5882" class="difflineminus">-        &amp;&amp; (rv != NS_RDF_NO_VALUE))</span>
<a href="#l2.5883"></a><span id="l2.5883" class="difflineminus">-    {</span>
<a href="#l2.5884"></a><span id="l2.5884" class="difflineminus">-        nsAutoString    literalString;</span>
<a href="#l2.5885"></a><span id="l2.5885" class="difflineminus">-        if (NS_SUCCEEDED(rv = GetTextForNode(node, literalString)))</span>
<a href="#l2.5886"></a><span id="l2.5886" class="difflineminus">-        {</span>
<a href="#l2.5887"></a><span id="l2.5887" class="difflineminus">-            if (property == kNC_URL) {</span>
<a href="#l2.5888"></a><span id="l2.5888" class="difflineminus">-                // Now do properly replace %22's; this is particularly important for javascript: URLs</span>
<a href="#l2.5889"></a><span id="l2.5889" class="difflineminus">-                PRInt32 offset;</span>
<a href="#l2.5890"></a><span id="l2.5890" class="difflineminus">-                while ((offset = literalString.FindChar('\&quot;')) &gt;= 0) {</span>
<a href="#l2.5891"></a><span id="l2.5891" class="difflineminus">-                    literalString.Cut(offset, 1);</span>
<a href="#l2.5892"></a><span id="l2.5892" class="difflineminus">-                    literalString.Insert(NS_LITERAL_STRING(&quot;%22&quot;), offset);</span>
<a href="#l2.5893"></a><span id="l2.5893" class="difflineminus">-                }</span>
<a href="#l2.5894"></a><span id="l2.5894" class="difflineminus">-            }</span>
<a href="#l2.5895"></a><span id="l2.5895" class="difflineminus">-</span>
<a href="#l2.5896"></a><span id="l2.5896" class="difflineminus">-            nsCAutoString attribute;</span>
<a href="#l2.5897"></a><span id="l2.5897" class="difflineminus">-            CopyUTF16toUTF8(literalString, attribute);</span>
<a href="#l2.5898"></a><span id="l2.5898" class="difflineminus">-</span>
<a href="#l2.5899"></a><span id="l2.5899" class="difflineminus">-            if (isFirst == PR_FALSE)</span>
<a href="#l2.5900"></a><span id="l2.5900" class="difflineminus">-            {</span>
<a href="#l2.5901"></a><span id="l2.5901" class="difflineminus">-                rv |= strm-&gt;Write(kSpaceStr, sizeof(kSpaceStr)-1, &amp;dummy);</span>
<a href="#l2.5902"></a><span id="l2.5902" class="difflineminus">-            }</span>
<a href="#l2.5903"></a><span id="l2.5903" class="difflineminus">-</span>
<a href="#l2.5904"></a><span id="l2.5904" class="difflineminus">-            if (property == kNC_Description)</span>
<a href="#l2.5905"></a><span id="l2.5905" class="difflineminus">-            {</span>
<a href="#l2.5906"></a><span id="l2.5906" class="difflineminus">-                if (!literalString.IsEmpty())</span>
<a href="#l2.5907"></a><span id="l2.5907" class="difflineminus">-                {</span>
<a href="#l2.5908"></a><span id="l2.5908" class="difflineminus">-                    EscapeHTML(attribute);</span>
<a href="#l2.5909"></a><span id="l2.5909" class="difflineminus">-</span>
<a href="#l2.5910"></a><span id="l2.5910" class="difflineminus">-                    if (NS_SUCCEEDED(rv))</span>
<a href="#l2.5911"></a><span id="l2.5911" class="difflineminus">-                    {</span>
<a href="#l2.5912"></a><span id="l2.5912" class="difflineminus">-                        rv |= strm-&gt;Write(htmlAttrib, strlen(htmlAttrib), &amp;dummy);</span>
<a href="#l2.5913"></a><span id="l2.5913" class="difflineminus">-                        rv |= strm-&gt;Write(attribute.get(),</span>
<a href="#l2.5914"></a><span id="l2.5914" class="difflineminus">-                                          attribute.Length(), &amp;dummy);</span>
<a href="#l2.5915"></a><span id="l2.5915" class="difflineminus">-                        rv |= strm-&gt;Write(kNL, sizeof(kNL)-1, &amp;dummy);</span>
<a href="#l2.5916"></a><span id="l2.5916" class="difflineminus">-                    }</span>
<a href="#l2.5917"></a><span id="l2.5917" class="difflineminus">-                }</span>
<a href="#l2.5918"></a><span id="l2.5918" class="difflineminus">-            }</span>
<a href="#l2.5919"></a><span id="l2.5919" class="difflineminus">-            else</span>
<a href="#l2.5920"></a><span id="l2.5920" class="difflineminus">-            {</span>
<a href="#l2.5921"></a><span id="l2.5921" class="difflineminus">-                if (property == kNC_Name || property == kNC_ShortcutURL)</span>
<a href="#l2.5922"></a><span id="l2.5922" class="difflineminus">-                {</span>
<a href="#l2.5923"></a><span id="l2.5923" class="difflineminus">-                    EscapeHTML(attribute);</span>
<a href="#l2.5924"></a><span id="l2.5924" class="difflineminus">-                }</span>
<a href="#l2.5925"></a><span id="l2.5925" class="difflineminus">-</span>
<a href="#l2.5926"></a><span id="l2.5926" class="difflineminus">-                rv |= strm-&gt;Write(htmlAttrib, strlen(htmlAttrib), &amp;dummy);</span>
<a href="#l2.5927"></a><span id="l2.5927" class="difflineminus">-                rv |= strm-&gt;Write(attribute.get(), attribute.Length(), &amp;dummy);</span>
<a href="#l2.5928"></a><span id="l2.5928" class="difflineminus">-                rv |= strm-&gt;Write(kQuoteStr, sizeof(kQuoteStr)-1, &amp;dummy);</span>
<a href="#l2.5929"></a><span id="l2.5929" class="difflineminus">-            }</span>
<a href="#l2.5930"></a><span id="l2.5930" class="difflineminus">-        }</span>
<a href="#l2.5931"></a><span id="l2.5931" class="difflineminus">-    }</span>
<a href="#l2.5932"></a><span id="l2.5932" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l2.5933"></a><span id="l2.5933" class="difflineminus">-        return NS_ERROR_UNEXPECTED;</span>
<a href="#l2.5934"></a><span id="l2.5934" class="difflineminus">-    </span>
<a href="#l2.5935"></a><span id="l2.5935" class="difflineminus">-    return NS_OK;</span>
<a href="#l2.5936"></a><span id="l2.5936" class="difflineminus">-}</span>
<a href="#l2.5937"></a><span id="l2.5937" class="difflineminus">-</span>
<a href="#l2.5938"></a><span id="l2.5938" class="difflineminus">-PRBool</span>
<a href="#l2.5939"></a><span id="l2.5939" class="difflineminus">-nsBookmarksService::CanAccept(nsIRDFResource* aSource,</span>
<a href="#l2.5940"></a><span id="l2.5940" class="difflineminus">-                  nsIRDFResource* aProperty,</span>
<a href="#l2.5941"></a><span id="l2.5941" class="difflineminus">-                  nsIRDFNode* aTarget)</span>
<a href="#l2.5942"></a><span id="l2.5942" class="difflineminus">-{</span>
<a href="#l2.5943"></a><span id="l2.5943" class="difflineminus">-    nsresult    rv;</span>
<a href="#l2.5944"></a><span id="l2.5944" class="difflineminus">-    PRBool      isBookmarkedFlag = PR_FALSE, canAcceptFlag = PR_FALSE, isOrdinal;</span>
<a href="#l2.5945"></a><span id="l2.5945" class="difflineminus">-</span>
<a href="#l2.5946"></a><span id="l2.5946" class="difflineminus">-    if (NS_SUCCEEDED(rv = IsBookmarkedResource(aSource, &amp;isBookmarkedFlag)) &amp;&amp;</span>
<a href="#l2.5947"></a><span id="l2.5947" class="difflineminus">-        (isBookmarkedFlag == PR_TRUE) &amp;&amp;</span>
<a href="#l2.5948"></a><span id="l2.5948" class="difflineminus">-        (NS_SUCCEEDED(rv = gRDFC-&gt;IsOrdinalProperty(aProperty, &amp;isOrdinal))))</span>
<a href="#l2.5949"></a><span id="l2.5949" class="difflineminus">-    {</span>
<a href="#l2.5950"></a><span id="l2.5950" class="difflineminus">-        if (isOrdinal == PR_TRUE)</span>
<a href="#l2.5951"></a><span id="l2.5951" class="difflineminus">-        {</span>
<a href="#l2.5952"></a><span id="l2.5952" class="difflineminus">-            canAcceptFlag = PR_TRUE;</span>
<a href="#l2.5953"></a><span id="l2.5953" class="difflineminus">-        }</span>
<a href="#l2.5954"></a><span id="l2.5954" class="difflineminus">-        else if ((aProperty == kNC_Description) ||</span>
<a href="#l2.5955"></a><span id="l2.5955" class="difflineminus">-             (aProperty == kNC_Name) ||</span>
<a href="#l2.5956"></a><span id="l2.5956" class="difflineminus">-             (aProperty == kNC_ShortcutURL) ||</span>
<a href="#l2.5957"></a><span id="l2.5957" class="difflineminus">-             (aProperty == kNC_URL) ||</span>
<a href="#l2.5958"></a><span id="l2.5958" class="difflineminus">-             (aProperty == kWEB_LastModifiedDate) ||</span>
<a href="#l2.5959"></a><span id="l2.5959" class="difflineminus">-             (aProperty == kWEB_LastVisitDate) ||</span>
<a href="#l2.5960"></a><span id="l2.5960" class="difflineminus">-             (aProperty == kNC_BookmarkAddDate) ||</span>
<a href="#l2.5961"></a><span id="l2.5961" class="difflineminus">-             (aProperty == kRDF_nextVal) ||</span>
<a href="#l2.5962"></a><span id="l2.5962" class="difflineminus">-             (aProperty == kRDF_type) ||</span>
<a href="#l2.5963"></a><span id="l2.5963" class="difflineminus">-             (aProperty == kWEB_Schedule))</span>
<a href="#l2.5964"></a><span id="l2.5964" class="difflineminus">-        {</span>
<a href="#l2.5965"></a><span id="l2.5965" class="difflineminus">-            canAcceptFlag = PR_TRUE;</span>
<a href="#l2.5966"></a><span id="l2.5966" class="difflineminus">-        }</span>
<a href="#l2.5967"></a><span id="l2.5967" class="difflineminus">-    }</span>
<a href="#l2.5968"></a><span id="l2.5968" class="difflineminus">-    return canAcceptFlag;</span>
<a href="#l2.5969"></a><span id="l2.5969" class="difflineminus">-}</span>
<a href="#l2.5970"></a><span id="l2.5970" class="difflineminus">-</span>
<a href="#l2.5971"></a><span id="l2.5971" class="difflineminus">-</span>
<a href="#l2.5972"></a><span id="l2.5972" class="difflineminus">-//----------------------------------------------------------------------</span>
<a href="#l2.5973"></a><span id="l2.5973" class="difflineminus">-//</span>
<a href="#l2.5974"></a><span id="l2.5974" class="difflineminus">-// nsIRDFObserver interface</span>
<a href="#l2.5975"></a><span id="l2.5975" class="difflineminus">-//</span>
<a href="#l2.5976"></a><span id="l2.5976" class="difflineminus">-</span>
<a href="#l2.5977"></a><span id="l2.5977" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l2.5978"></a><span id="l2.5978" class="difflineminus">-nsBookmarksService::OnAssert(nsIRDFDataSource* aDataSource,</span>
<a href="#l2.5979"></a><span id="l2.5979" class="difflineminus">-                 nsIRDFResource* aSource,</span>
<a href="#l2.5980"></a><span id="l2.5980" class="difflineminus">-                 nsIRDFResource* aProperty,</span>
<a href="#l2.5981"></a><span id="l2.5981" class="difflineminus">-                 nsIRDFNode* aTarget)</span>
<a href="#l2.5982"></a><span id="l2.5982" class="difflineminus">-{</span>
<a href="#l2.5983"></a><span id="l2.5983" class="difflineminus">-    if (mUpdateBatchNest != 0)  return NS_OK;</span>
<a href="#l2.5984"></a><span id="l2.5984" class="difflineminus">-</span>
<a href="#l2.5985"></a><span id="l2.5985" class="difflineminus">-    PRInt32 count = mObservers.Count();</span>
<a href="#l2.5986"></a><span id="l2.5986" class="difflineminus">-    for (PRInt32 i = 0; i &lt; count; ++i)</span>
<a href="#l2.5987"></a><span id="l2.5987" class="difflineminus">-    {</span>
<a href="#l2.5988"></a><span id="l2.5988" class="difflineminus">-        (void) mObservers[i]-&gt;OnAssert(this, aSource, aProperty, aTarget);</span>
<a href="#l2.5989"></a><span id="l2.5989" class="difflineminus">-    }</span>
<a href="#l2.5990"></a><span id="l2.5990" class="difflineminus">-</span>
<a href="#l2.5991"></a><span id="l2.5991" class="difflineminus">-    return NS_OK;</span>
<a href="#l2.5992"></a><span id="l2.5992" class="difflineminus">-}</span>
<a href="#l2.5993"></a><span id="l2.5993" class="difflineminus">-</span>
<a href="#l2.5994"></a><span id="l2.5994" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l2.5995"></a><span id="l2.5995" class="difflineminus">-nsBookmarksService::OnUnassert(nsIRDFDataSource* aDataSource,</span>
<a href="#l2.5996"></a><span id="l2.5996" class="difflineminus">-                   nsIRDFResource* aSource,</span>
<a href="#l2.5997"></a><span id="l2.5997" class="difflineminus">-                   nsIRDFResource* aProperty,</span>
<a href="#l2.5998"></a><span id="l2.5998" class="difflineminus">-                   nsIRDFNode* aTarget)</span>
<a href="#l2.5999"></a><span id="l2.5999" class="difflineminus">-{</span>
<a href="#l2.6000"></a><span id="l2.6000" class="difflineminus">-    if (mUpdateBatchNest != 0)  return NS_OK;</span>
<a href="#l2.6001"></a><span id="l2.6001" class="difflineminus">-</span>
<a href="#l2.6002"></a><span id="l2.6002" class="difflineminus">-    PRInt32 count = mObservers.Count();</span>
<a href="#l2.6003"></a><span id="l2.6003" class="difflineminus">-    for (PRInt32 i = 0; i &lt; count; ++i)</span>
<a href="#l2.6004"></a><span id="l2.6004" class="difflineminus">-    {</span>
<a href="#l2.6005"></a><span id="l2.6005" class="difflineminus">-        (void) mObservers[i]-&gt;OnUnassert(this, aSource, aProperty, aTarget);</span>
<a href="#l2.6006"></a><span id="l2.6006" class="difflineminus">-    }</span>
<a href="#l2.6007"></a><span id="l2.6007" class="difflineminus">-</span>
<a href="#l2.6008"></a><span id="l2.6008" class="difflineminus">-    return NS_OK;</span>
<a href="#l2.6009"></a><span id="l2.6009" class="difflineminus">-}</span>
<a href="#l2.6010"></a><span id="l2.6010" class="difflineminus">-</span>
<a href="#l2.6011"></a><span id="l2.6011" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l2.6012"></a><span id="l2.6012" class="difflineminus">-nsBookmarksService::OnChange(nsIRDFDataSource* aDataSource,</span>
<a href="#l2.6013"></a><span id="l2.6013" class="difflineminus">-                 nsIRDFResource* aSource,</span>
<a href="#l2.6014"></a><span id="l2.6014" class="difflineminus">-                 nsIRDFResource* aProperty,</span>
<a href="#l2.6015"></a><span id="l2.6015" class="difflineminus">-                 nsIRDFNode* aOldTarget,</span>
<a href="#l2.6016"></a><span id="l2.6016" class="difflineminus">-                 nsIRDFNode* aNewTarget)</span>
<a href="#l2.6017"></a><span id="l2.6017" class="difflineminus">-{</span>
<a href="#l2.6018"></a><span id="l2.6018" class="difflineminus">-    if (mUpdateBatchNest != 0)  return NS_OK;</span>
<a href="#l2.6019"></a><span id="l2.6019" class="difflineminus">-</span>
<a href="#l2.6020"></a><span id="l2.6020" class="difflineminus">-    PRInt32 count = mObservers.Count();</span>
<a href="#l2.6021"></a><span id="l2.6021" class="difflineminus">-    for (PRInt32 i = 0; i &lt; count; ++i)</span>
<a href="#l2.6022"></a><span id="l2.6022" class="difflineminus">-    {</span>
<a href="#l2.6023"></a><span id="l2.6023" class="difflineminus">-        (void) mObservers[i]-&gt;OnChange(this, aSource, aProperty, aOldTarget, aNewTarget);</span>
<a href="#l2.6024"></a><span id="l2.6024" class="difflineminus">-    }</span>
<a href="#l2.6025"></a><span id="l2.6025" class="difflineminus">-</span>
<a href="#l2.6026"></a><span id="l2.6026" class="difflineminus">-    return NS_OK;</span>
<a href="#l2.6027"></a><span id="l2.6027" class="difflineminus">-}</span>
<a href="#l2.6028"></a><span id="l2.6028" class="difflineminus">-</span>
<a href="#l2.6029"></a><span id="l2.6029" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l2.6030"></a><span id="l2.6030" class="difflineminus">-nsBookmarksService::OnMove(nsIRDFDataSource* aDataSource,</span>
<a href="#l2.6031"></a><span id="l2.6031" class="difflineminus">-               nsIRDFResource* aOldSource,</span>
<a href="#l2.6032"></a><span id="l2.6032" class="difflineminus">-               nsIRDFResource* aNewSource,</span>
<a href="#l2.6033"></a><span id="l2.6033" class="difflineminus">-               nsIRDFResource* aProperty,</span>
<a href="#l2.6034"></a><span id="l2.6034" class="difflineminus">-               nsIRDFNode* aTarget)</span>
<a href="#l2.6035"></a><span id="l2.6035" class="difflineminus">-{</span>
<a href="#l2.6036"></a><span id="l2.6036" class="difflineminus">-    if (mUpdateBatchNest != 0)  return NS_OK;</span>
<a href="#l2.6037"></a><span id="l2.6037" class="difflineminus">-</span>
<a href="#l2.6038"></a><span id="l2.6038" class="difflineminus">-    PRInt32 count = mObservers.Count();</span>
<a href="#l2.6039"></a><span id="l2.6039" class="difflineminus">-    for (PRInt32 i = 0; i &lt; count; ++i)</span>
<a href="#l2.6040"></a><span id="l2.6040" class="difflineminus">-    {</span>
<a href="#l2.6041"></a><span id="l2.6041" class="difflineminus">-        (void) mObservers[i]-&gt;OnMove(this, aOldSource, aNewSource, aProperty, aTarget);</span>
<a href="#l2.6042"></a><span id="l2.6042" class="difflineminus">-    }</span>
<a href="#l2.6043"></a><span id="l2.6043" class="difflineminus">-</span>
<a href="#l2.6044"></a><span id="l2.6044" class="difflineminus">-    return NS_OK;</span>
<a href="#l2.6045"></a><span id="l2.6045" class="difflineminus">-}</span>
<a href="#l2.6046"></a><span id="l2.6046" class="difflineminus">-</span>
<a href="#l2.6047"></a><span id="l2.6047" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l2.6048"></a><span id="l2.6048" class="difflineminus">-nsBookmarksService::OnBeginUpdateBatch(nsIRDFDataSource* aDataSource)</span>
<a href="#l2.6049"></a><span id="l2.6049" class="difflineminus">-{</span>
<a href="#l2.6050"></a><span id="l2.6050" class="difflineminus">-    if (mUpdateBatchNest++ == 0)</span>
<a href="#l2.6051"></a><span id="l2.6051" class="difflineminus">-    {</span>
<a href="#l2.6052"></a><span id="l2.6052" class="difflineminus">-        PRInt32 count = mObservers.Count();</span>
<a href="#l2.6053"></a><span id="l2.6053" class="difflineminus">-        for (PRInt32 i = 0; i &lt; count; ++i) {</span>
<a href="#l2.6054"></a><span id="l2.6054" class="difflineminus">-            (void) mObservers[i]-&gt;OnBeginUpdateBatch(this);</span>
<a href="#l2.6055"></a><span id="l2.6055" class="difflineminus">-        }</span>
<a href="#l2.6056"></a><span id="l2.6056" class="difflineminus">-    }</span>
<a href="#l2.6057"></a><span id="l2.6057" class="difflineminus">-</span>
<a href="#l2.6058"></a><span id="l2.6058" class="difflineminus">-    return NS_OK;</span>
<a href="#l2.6059"></a><span id="l2.6059" class="difflineminus">-}</span>
<a href="#l2.6060"></a><span id="l2.6060" class="difflineminus">-</span>
<a href="#l2.6061"></a><span id="l2.6061" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l2.6062"></a><span id="l2.6062" class="difflineminus">-nsBookmarksService::OnEndUpdateBatch(nsIRDFDataSource* aDataSource)</span>
<a href="#l2.6063"></a><span id="l2.6063" class="difflineminus">-{</span>
<a href="#l2.6064"></a><span id="l2.6064" class="difflineminus">-    NS_ASSERTION(mUpdateBatchNest &gt; 0, &quot;badly nested update batch&quot;);</span>
<a href="#l2.6065"></a><span id="l2.6065" class="difflineminus">-</span>
<a href="#l2.6066"></a><span id="l2.6066" class="difflineminus">-    if (--mUpdateBatchNest == 0)</span>
<a href="#l2.6067"></a><span id="l2.6067" class="difflineminus">-    {</span>
<a href="#l2.6068"></a><span id="l2.6068" class="difflineminus">-        PRInt32 count = mObservers.Count();</span>
<a href="#l2.6069"></a><span id="l2.6069" class="difflineminus">-        for (PRInt32 i = 0; i &lt; count; ++i) {</span>
<a href="#l2.6070"></a><span id="l2.6070" class="difflineminus">-            (void) mObservers[i]-&gt;OnEndUpdateBatch(this);</span>
<a href="#l2.6071"></a><span id="l2.6071" class="difflineminus">-        }</span>
<a href="#l2.6072"></a><span id="l2.6072" class="difflineminus">-    }</span>
<a href="#l2.6073"></a><span id="l2.6073" class="difflineminus">-</span>
<a href="#l2.6074"></a><span id="l2.6074" class="difflineminus">-    return NS_OK;</span>
<a href="#l2.6075"></a><span id="l2.6075" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1">deleted file mode 100644</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineminus">--- a/suite/browser/src/nsBookmarksService.h</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineplus">+++ /dev/null</span>
<a href="#l3.4"></a><span id="l3.4" class="difflineat">@@ -1,321 +0,0 @@</span>
<a href="#l3.5"></a><span id="l3.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l3.6"></a><span id="l3.6" class="difflineminus">-/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l3.7"></a><span id="l3.7" class="difflineminus">- * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l3.8"></a><span id="l3.8" class="difflineminus">- *</span>
<a href="#l3.9"></a><span id="l3.9" class="difflineminus">- * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l3.10"></a><span id="l3.10" class="difflineminus">- * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l3.11"></a><span id="l3.11" class="difflineminus">- * the License. You may obtain a copy of the License at</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">- * http://www.mozilla.org/MPL/</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">- *</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">- * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineminus">- * for the specific language governing rights and limitations under the</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineminus">- * License.</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineminus">- *</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineminus">- * The Original Code is mozilla.org code.</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineminus">- *</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineminus">- * The Initial Developer of the Original Code is</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineminus">- * Netscape Communications Corporation.</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineminus">- * Portions created by the Initial Developer are Copyright (C) 1998</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineminus">- * the Initial Developer. All Rights Reserved.</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineminus">- *</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineminus">- * Contributor(s):</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineminus">- *</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineminus">- * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineminus">- * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineminus">- * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">- * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineminus">- * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineminus">- * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineminus">- * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineminus">- * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineminus">- * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineminus">- * the provisions above, a recipient may use your version of this file under</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineminus">- * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineminus">- *</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineminus">- * ***** END LICENSE BLOCK ***** */</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineminus">-</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineminus">-#ifndef bookmarksservice___h___</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineminus">-#define bookmarksservice___h___</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineminus">-</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineminus">-#include &quot;nsIRDFDataSource.h&quot;</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineminus">-#include &quot;nsIRDFRemoteDataSource.h&quot;</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineminus">-#include &quot;nsIRDFPropagatableDataSource.h&quot;</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineminus">-#include &quot;nsIStreamListener.h&quot;</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineminus">-#include &quot;nsIRDFObserver.h&quot;</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineminus">-#include &quot;nsISupportsArray.h&quot;</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineminus">-#include &quot;nsCOMArray.h&quot;</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineminus">-#include &quot;nsIStringBundle.h&quot;</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineminus">-#include &quot;nsITimer.h&quot;</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineminus">-#include &quot;nsIRDFNode.h&quot;</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineminus">-#include &quot;nsIBookmarksService.h&quot;</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineminus">-#include &quot;nsStringAPI.h&quot;</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineminus">-#include &quot;nsIFile.h&quot;</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineminus">-#include &quot;nsIObserver.h&quot;</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineminus">-#include &quot;nsWeakReference.h&quot;</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineminus">-#include &quot;nsCOMArray.h&quot;</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineminus">-#include &quot;nsIIOService.h&quot;</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineminus">-#include &quot;nsICacheService.h&quot;</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineminus">-#include &quot;nsICacheSession.h&quot;</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineminus">-#include &quot;nsITransactionManager.h&quot;</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineminus">-#include &quot;nsICharsetResolver.h&quot;</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineminus">-#include &quot;nsCycleCollectionParticipant.h&quot;</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineminus">-</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineminus">-class nsIOutputStream;</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineminus">-</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineminus">-class nsBookmarksService : public nsIBookmarksService,</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineminus">-                           public nsIRDFDataSource,</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineminus">-                           public nsIRDFRemoteDataSource,</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineminus">-                           public nsIRDFPropagatableDataSource,</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineminus">-                           public nsIStreamListener,</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineminus">-                           public nsICharsetResolver,</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineminus">-                           public nsIRDFObserver,</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineminus">-                           public nsIObserver,</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineminus">-                           public nsSupportsWeakReference</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineminus">-{</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineminus">-protected:</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineminus">-    nsCOMPtr&lt;nsIRDFDataSource&gt;      mInner;</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineminus">-    nsCOMPtr&lt;nsIRDFResource&gt;        busyResource;</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineminus">-    nsCOMArray&lt;nsIRDFObserver&gt;      mObservers;</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineminus">-    nsCOMPtr&lt;nsIStringBundle&gt;       mBundle;</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineminus">-    nsCOMPtr&lt;nsITimer&gt;              mTimer;</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineminus">-    nsCOMPtr&lt;nsIIOService&gt;          mNetService;</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineminus">-    nsCOMPtr&lt;nsICacheService&gt;       mCacheService;</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineminus">-    nsCOMPtr&lt;nsICacheSession&gt;       mCacheSession;</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineminus">-    nsCOMPtr&lt;nsITransactionManager&gt; mTransactionManager;</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineminus">-    nsCOMPtr&lt;nsILocalFile&gt;          mBookmarksFile;</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineminus">-</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineminus">-    PRUint32      htmlSize;</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineminus">-    PRInt32       mUpdateBatchNest;</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineminus">-    nsString      mPersonalToolbarName;</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineminus">-    nsString      mBookmarksRootName;</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineminus">-    PRBool        mDirty;</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineminus">-    PRBool        mBrowserIcons;</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineminus">-    PRBool        mAlwaysLoadIcons;</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineminus">-    PRBool        busySchedule;</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineminus">-</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineminus">-    // System Bookmark parsing</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineminus">-#ifdef XP_WIN</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineminus">-    // @param aDirectory      - Favorites Folder to import from.</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineminus">-    // @param aParentResource - Folder into which to place imported</span>
<a href="#l3.105"></a><span id="l3.105" class="difflineminus">-    //                          Favorites.</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineminus">-    nsresult      ParseFavoritesFolder(nsIFile* aDirectory, </span>
<a href="#l3.107"></a><span id="l3.107" class="difflineminus">-                                       nsIRDFResource* aParentResource);</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineminus">-</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineminus">-    void          HandleSystemBookmarks(nsIRDFNode* aNode);</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineminus">-#endif</span>
<a href="#l3.111"></a><span id="l3.111" class="difflineminus">-</span>
<a href="#l3.112"></a><span id="l3.112" class="difflineminus">-    static void FireTimer(nsITimer* aTimer, void* aClosure);</span>
<a href="#l3.113"></a><span id="l3.113" class="difflineminus">-</span>
<a href="#l3.114"></a><span id="l3.114" class="difflineminus">-    nsresult ExamineBookmarkSchedule(nsIRDFResource *theBookmark, PRBool &amp; examineFlag);</span>
<a href="#l3.115"></a><span id="l3.115" class="difflineminus">-</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineminus">-    nsresult GetBookmarkToPing(nsIRDFResource **theBookmark);</span>
<a href="#l3.117"></a><span id="l3.117" class="difflineminus">-</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineminus">-    nsresult EnsureBookmarksFile();</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineminus">-</span>
<a href="#l3.120"></a><span id="l3.120" class="difflineminus">-    nsresult WriteBookmarks(nsIFile* bookmarksFile, nsIRDFDataSource *ds,</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineminus">-                            nsIRDFResource *root);</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineminus">-</span>
<a href="#l3.123"></a><span id="l3.123" class="difflineminus">-    nsresult WriteBookmarksContainer(nsIRDFDataSource *ds,</span>
<a href="#l3.124"></a><span id="l3.124" class="difflineminus">-                                     nsIOutputStream* strm,</span>
<a href="#l3.125"></a><span id="l3.125" class="difflineminus">-                                     nsIRDFResource *container,</span>
<a href="#l3.126"></a><span id="l3.126" class="difflineminus">-                                     PRInt32 level,</span>
<a href="#l3.127"></a><span id="l3.127" class="difflineminus">-                                     nsCOMArray&lt;nsIRDFResource&gt;&amp; parentArray);</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineminus">-</span>
<a href="#l3.129"></a><span id="l3.129" class="difflineminus">-    nsresult SerializeBookmarks(nsIURI* aURI);</span>
<a href="#l3.130"></a><span id="l3.130" class="difflineminus">-</span>
<a href="#l3.131"></a><span id="l3.131" class="difflineminus">-    nsresult GetTextForNode(nsIRDFNode* aNode, nsString&amp; aResult);</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineminus">-</span>
<a href="#l3.133"></a><span id="l3.133" class="difflineminus">-    nsresult GetSynthesizedType(nsIRDFResource *aNode, nsIRDFNode **aType);</span>
<a href="#l3.134"></a><span id="l3.134" class="difflineminus">-</span>
<a href="#l3.135"></a><span id="l3.135" class="difflineminus">-    nsresult UpdateBookmarkLastModifiedDate(nsIRDFResource *aSource);</span>
<a href="#l3.136"></a><span id="l3.136" class="difflineminus">-</span>
<a href="#l3.137"></a><span id="l3.137" class="difflineminus">-    nsresult WriteBookmarkProperties(nsIRDFDataSource *ds,</span>
<a href="#l3.138"></a><span id="l3.138" class="difflineminus">-                                     nsIOutputStream* strm,</span>
<a href="#l3.139"></a><span id="l3.139" class="difflineminus">-                                     nsIRDFResource *node,</span>
<a href="#l3.140"></a><span id="l3.140" class="difflineminus">-                                     nsIRDFResource *property,</span>
<a href="#l3.141"></a><span id="l3.141" class="difflineminus">-                                     const char *htmlAttrib,</span>
<a href="#l3.142"></a><span id="l3.142" class="difflineminus">-                                     PRBool isFirst);</span>
<a href="#l3.143"></a><span id="l3.143" class="difflineminus">-</span>
<a href="#l3.144"></a><span id="l3.144" class="difflineminus">-    PRBool   CanAccept(nsIRDFResource* aSource, nsIRDFResource* aProperty, nsIRDFNode* aTarget);</span>
<a href="#l3.145"></a><span id="l3.145" class="difflineminus">-</span>
<a href="#l3.146"></a><span id="l3.146" class="difflineminus">-    nsresult getArgumentN(nsISupportsArray *arguments, nsIRDFResource *res,</span>
<a href="#l3.147"></a><span id="l3.147" class="difflineminus">-                          PRInt32 offset, nsIRDFNode **argValue);</span>
<a href="#l3.148"></a><span id="l3.148" class="difflineminus">-</span>
<a href="#l3.149"></a><span id="l3.149" class="difflineminus">-    nsresult insertBookmarkItem(nsIRDFResource *src,</span>
<a href="#l3.150"></a><span id="l3.150" class="difflineminus">-                                nsISupportsArray *aArguments,</span>
<a href="#l3.151"></a><span id="l3.151" class="difflineminus">-                                nsIRDFResource *objType);</span>
<a href="#l3.152"></a><span id="l3.152" class="difflineminus">-</span>
<a href="#l3.153"></a><span id="l3.153" class="difflineminus">-    nsresult deleteBookmarkItem(nsIRDFResource *src,</span>
<a href="#l3.154"></a><span id="l3.154" class="difflineminus">-                                nsISupportsArray *aArguments,</span>
<a href="#l3.155"></a><span id="l3.155" class="difflineminus">-                                PRInt32 parentArgIndex);</span>
<a href="#l3.156"></a><span id="l3.156" class="difflineminus">-</span>
<a href="#l3.157"></a><span id="l3.157" class="difflineminus">-    nsresult setFolderHint(nsIRDFResource *src, nsIRDFResource *objType);</span>
<a href="#l3.158"></a><span id="l3.158" class="difflineminus">-</span>
<a href="#l3.159"></a><span id="l3.159" class="difflineminus">-    nsresult getFolderViaHint(nsIRDFResource *src, PRBool fallbackFlag,</span>
<a href="#l3.160"></a><span id="l3.160" class="difflineminus">-                              nsIRDFResource **folder);</span>
<a href="#l3.161"></a><span id="l3.161" class="difflineminus">-</span>
<a href="#l3.162"></a><span id="l3.162" class="difflineminus">-    nsresult importBookmarks(nsISupportsArray *aArguments);</span>
<a href="#l3.163"></a><span id="l3.163" class="difflineminus">-</span>
<a href="#l3.164"></a><span id="l3.164" class="difflineminus">-    nsresult exportBookmarks(nsISupportsArray *aArguments);</span>
<a href="#l3.165"></a><span id="l3.165" class="difflineminus">-</span>
<a href="#l3.166"></a><span id="l3.166" class="difflineminus">-    nsresult ProcessCachedBookmarkIcon(nsIRDFResource* aSource,</span>
<a href="#l3.167"></a><span id="l3.167" class="difflineminus">-                                       const PRUnichar *iconURL,</span>
<a href="#l3.168"></a><span id="l3.168" class="difflineminus">-                                       nsIRDFNode** aTarget);</span>
<a href="#l3.169"></a><span id="l3.169" class="difflineminus">-</span>
<a href="#l3.170"></a><span id="l3.170" class="difflineminus">-    void AnnotateBookmarkSchedule(nsIRDFResource* aSource,</span>
<a href="#l3.171"></a><span id="l3.171" class="difflineminus">-                                  PRBool scheduleFlag);</span>
<a href="#l3.172"></a><span id="l3.172" class="difflineminus">-</span>
<a href="#l3.173"></a><span id="l3.173" class="difflineminus">-    nsresult InsertResource(nsIRDFResource* aResource,</span>
<a href="#l3.174"></a><span id="l3.174" class="difflineminus">-                            nsIRDFResource* aParentFolder, PRInt32 aIndex);</span>
<a href="#l3.175"></a><span id="l3.175" class="difflineminus">-</span>
<a href="#l3.176"></a><span id="l3.176" class="difflineminus">-    nsresult getLocaleString(const char *key, nsString &amp;str);</span>
<a href="#l3.177"></a><span id="l3.177" class="difflineminus">-</span>
<a href="#l3.178"></a><span id="l3.178" class="difflineminus">-    static int</span>
<a href="#l3.179"></a><span id="l3.179" class="difflineminus">-    Compare(const void* aElement1, const void* aElement2, void* aData);</span>
<a href="#l3.180"></a><span id="l3.180" class="difflineminus">-</span>
<a href="#l3.181"></a><span id="l3.181" class="difflineminus">-    nsresult</span>
<a href="#l3.182"></a><span id="l3.182" class="difflineminus">-    Sort(nsIRDFResource* aFolder, nsIRDFResource* aProperty,</span>
<a href="#l3.183"></a><span id="l3.183" class="difflineminus">-         PRInt32 aDirection, PRBool aFoldersFirst, PRBool aRecurse);</span>
<a href="#l3.184"></a><span id="l3.184" class="difflineminus">-</span>
<a href="#l3.185"></a><span id="l3.185" class="difflineminus">-    nsresult</span>
<a href="#l3.186"></a><span id="l3.186" class="difflineminus">-    GetURLFromResource(nsIRDFResource* aResource, nsAString&amp; aURL);</span>
<a href="#l3.187"></a><span id="l3.187" class="difflineminus">-</span>
<a href="#l3.188"></a><span id="l3.188" class="difflineminus">-    nsresult</span>
<a href="#l3.189"></a><span id="l3.189" class="difflineminus">-    CopyResource(nsIRDFResource* aOldResource, nsIRDFResource* aNewResource);</span>
<a href="#l3.190"></a><span id="l3.190" class="difflineminus">-</span>
<a href="#l3.191"></a><span id="l3.191" class="difflineminus">-    nsresult</span>
<a href="#l3.192"></a><span id="l3.192" class="difflineminus">-    SetNewPersonalToolbarFolder(nsIRDFResource* aFolder);</span>
<a href="#l3.193"></a><span id="l3.193" class="difflineminus">-</span>
<a href="#l3.194"></a><span id="l3.194" class="difflineminus">-    nsresult LoadBookmarks();</span>
<a href="#l3.195"></a><span id="l3.195" class="difflineminus">-    nsresult initDatasource();</span>
<a href="#l3.196"></a><span id="l3.196" class="difflineminus">-</span>
<a href="#l3.197"></a><span id="l3.197" class="difflineminus">-    // nsIStreamObserver methods:</span>
<a href="#l3.198"></a><span id="l3.198" class="difflineminus">-    NS_DECL_NSIREQUESTOBSERVER</span>
<a href="#l3.199"></a><span id="l3.199" class="difflineminus">-</span>
<a href="#l3.200"></a><span id="l3.200" class="difflineminus">-    // nsIStreamListener methods:</span>
<a href="#l3.201"></a><span id="l3.201" class="difflineminus">-    NS_DECL_NSISTREAMLISTENER</span>
<a href="#l3.202"></a><span id="l3.202" class="difflineminus">-</span>
<a href="#l3.203"></a><span id="l3.203" class="difflineminus">-    NS_DECL_NSICHARSETRESOLVER</span>
<a href="#l3.204"></a><span id="l3.204" class="difflineminus">-</span>
<a href="#l3.205"></a><span id="l3.205" class="difflineminus">-    // nsIObserver methods:</span>
<a href="#l3.206"></a><span id="l3.206" class="difflineminus">-    NS_DECL_NSIOBSERVER</span>
<a href="#l3.207"></a><span id="l3.207" class="difflineminus">-</span>
<a href="#l3.208"></a><span id="l3.208" class="difflineminus">-public:</span>
<a href="#l3.209"></a><span id="l3.209" class="difflineminus">-    nsBookmarksService();</span>
<a href="#l3.210"></a><span id="l3.210" class="difflineminus">-    virtual ~nsBookmarksService();</span>
<a href="#l3.211"></a><span id="l3.211" class="difflineminus">-    nsresult Init();</span>
<a href="#l3.212"></a><span id="l3.212" class="difflineminus">-</span>
<a href="#l3.213"></a><span id="l3.213" class="difflineminus">-    // nsISupports</span>
<a href="#l3.214"></a><span id="l3.214" class="difflineminus">-    NS_DECL_CYCLE_COLLECTING_ISUPPORTS</span>
<a href="#l3.215"></a><span id="l3.215" class="difflineminus">-    NS_DECL_CYCLE_COLLECTION_CLASS_AMBIGUOUS(nsBookmarksService,</span>
<a href="#l3.216"></a><span id="l3.216" class="difflineminus">-                                             nsIBookmarksService)</span>
<a href="#l3.217"></a><span id="l3.217" class="difflineminus">-</span>
<a href="#l3.218"></a><span id="l3.218" class="difflineminus">-    // nsIBookmarksService</span>
<a href="#l3.219"></a><span id="l3.219" class="difflineminus">-    NS_DECL_NSIBOOKMARKSSERVICE</span>
<a href="#l3.220"></a><span id="l3.220" class="difflineminus">-</span>
<a href="#l3.221"></a><span id="l3.221" class="difflineminus">-    // nsIRDFDataSource</span>
<a href="#l3.222"></a><span id="l3.222" class="difflineminus">-    NS_IMETHOD GetURI(char* *uri);</span>
<a href="#l3.223"></a><span id="l3.223" class="difflineminus">-</span>
<a href="#l3.224"></a><span id="l3.224" class="difflineminus">-    NS_IMETHOD GetSource(nsIRDFResource* property,</span>
<a href="#l3.225"></a><span id="l3.225" class="difflineminus">-                         nsIRDFNode* target,</span>
<a href="#l3.226"></a><span id="l3.226" class="difflineminus">-                         PRBool tv,</span>
<a href="#l3.227"></a><span id="l3.227" class="difflineminus">-                         nsIRDFResource** source)</span>
<a href="#l3.228"></a><span id="l3.228" class="difflineminus">-    {</span>
<a href="#l3.229"></a><span id="l3.229" class="difflineminus">-        return mInner-&gt;GetSource(property, target, tv, source);</span>
<a href="#l3.230"></a><span id="l3.230" class="difflineminus">-    }</span>
<a href="#l3.231"></a><span id="l3.231" class="difflineminus">-</span>
<a href="#l3.232"></a><span id="l3.232" class="difflineminus">-    NS_IMETHOD GetSources(nsIRDFResource* property,</span>
<a href="#l3.233"></a><span id="l3.233" class="difflineminus">-                          nsIRDFNode* target,</span>
<a href="#l3.234"></a><span id="l3.234" class="difflineminus">-                          PRBool tv,</span>
<a href="#l3.235"></a><span id="l3.235" class="difflineminus">-                          nsISimpleEnumerator** sources)</span>
<a href="#l3.236"></a><span id="l3.236" class="difflineminus">-    {</span>
<a href="#l3.237"></a><span id="l3.237" class="difflineminus">-        return mInner-&gt;GetSources(property, target, tv, sources);</span>
<a href="#l3.238"></a><span id="l3.238" class="difflineminus">-    }</span>
<a href="#l3.239"></a><span id="l3.239" class="difflineminus">-</span>
<a href="#l3.240"></a><span id="l3.240" class="difflineminus">-    NS_IMETHOD GetTarget(nsIRDFResource* source,</span>
<a href="#l3.241"></a><span id="l3.241" class="difflineminus">-                         nsIRDFResource* property,</span>
<a href="#l3.242"></a><span id="l3.242" class="difflineminus">-                         PRBool tv,</span>
<a href="#l3.243"></a><span id="l3.243" class="difflineminus">-                         nsIRDFNode** target);</span>
<a href="#l3.244"></a><span id="l3.244" class="difflineminus">-</span>
<a href="#l3.245"></a><span id="l3.245" class="difflineminus">-    NS_IMETHOD GetTargets(nsIRDFResource* source,</span>
<a href="#l3.246"></a><span id="l3.246" class="difflineminus">-                          nsIRDFResource* property,</span>
<a href="#l3.247"></a><span id="l3.247" class="difflineminus">-                          PRBool tv,</span>
<a href="#l3.248"></a><span id="l3.248" class="difflineminus">-                          nsISimpleEnumerator** targets)</span>
<a href="#l3.249"></a><span id="l3.249" class="difflineminus">-    {</span>
<a href="#l3.250"></a><span id="l3.250" class="difflineminus">-        return mInner-&gt;GetTargets(source, property, tv, targets);</span>
<a href="#l3.251"></a><span id="l3.251" class="difflineminus">-    }</span>
<a href="#l3.252"></a><span id="l3.252" class="difflineminus">-</span>
<a href="#l3.253"></a><span id="l3.253" class="difflineminus">-    NS_IMETHOD Assert(nsIRDFResource* aSource,</span>
<a href="#l3.254"></a><span id="l3.254" class="difflineminus">-                      nsIRDFResource* aProperty,</span>
<a href="#l3.255"></a><span id="l3.255" class="difflineminus">-                      nsIRDFNode* aTarget,</span>
<a href="#l3.256"></a><span id="l3.256" class="difflineminus">-                      PRBool aTruthValue);</span>
<a href="#l3.257"></a><span id="l3.257" class="difflineminus">-</span>
<a href="#l3.258"></a><span id="l3.258" class="difflineminus">-    NS_IMETHOD Unassert(nsIRDFResource* aSource,</span>
<a href="#l3.259"></a><span id="l3.259" class="difflineminus">-                        nsIRDFResource* aProperty,</span>
<a href="#l3.260"></a><span id="l3.260" class="difflineminus">-                        nsIRDFNode* aTarget);</span>
<a href="#l3.261"></a><span id="l3.261" class="difflineminus">-</span>
<a href="#l3.262"></a><span id="l3.262" class="difflineminus">-    NS_IMETHOD Change(nsIRDFResource* aSource,</span>
<a href="#l3.263"></a><span id="l3.263" class="difflineminus">-                      nsIRDFResource* aProperty,</span>
<a href="#l3.264"></a><span id="l3.264" class="difflineminus">-                      nsIRDFNode* aOldTarget,</span>
<a href="#l3.265"></a><span id="l3.265" class="difflineminus">-                      nsIRDFNode* aNewTarget);</span>
<a href="#l3.266"></a><span id="l3.266" class="difflineminus">-    </span>
<a href="#l3.267"></a><span id="l3.267" class="difflineminus">-    NS_IMETHOD Move(nsIRDFResource* aOldSource,</span>
<a href="#l3.268"></a><span id="l3.268" class="difflineminus">-                    nsIRDFResource* aNewSource,</span>
<a href="#l3.269"></a><span id="l3.269" class="difflineminus">-                    nsIRDFResource* aProperty,</span>
<a href="#l3.270"></a><span id="l3.270" class="difflineminus">-                    nsIRDFNode* aTarget);</span>
<a href="#l3.271"></a><span id="l3.271" class="difflineminus">-            </span>
<a href="#l3.272"></a><span id="l3.272" class="difflineminus">-    NS_IMETHOD HasAssertion(nsIRDFResource* source,</span>
<a href="#l3.273"></a><span id="l3.273" class="difflineminus">-                            nsIRDFResource* property,</span>
<a href="#l3.274"></a><span id="l3.274" class="difflineminus">-                            nsIRDFNode* target,</span>
<a href="#l3.275"></a><span id="l3.275" class="difflineminus">-                            PRBool tv,</span>
<a href="#l3.276"></a><span id="l3.276" class="difflineminus">-                            PRBool* hasAssertion);</span>
<a href="#l3.277"></a><span id="l3.277" class="difflineminus">-</span>
<a href="#l3.278"></a><span id="l3.278" class="difflineminus">-    NS_IMETHOD AddObserver(nsIRDFObserver* aObserver);</span>
<a href="#l3.279"></a><span id="l3.279" class="difflineminus">-    NS_IMETHOD RemoveObserver(nsIRDFObserver* aObserver);</span>
<a href="#l3.280"></a><span id="l3.280" class="difflineminus">-</span>
<a href="#l3.281"></a><span id="l3.281" class="difflineminus">-    NS_IMETHOD HasArcIn(nsIRDFNode *aNode, nsIRDFResource *aArc, PRBool *_retval);</span>
<a href="#l3.282"></a><span id="l3.282" class="difflineminus">-    NS_IMETHOD HasArcOut(nsIRDFResource *aSource, nsIRDFResource *aArc, PRBool *_retval);</span>
<a href="#l3.283"></a><span id="l3.283" class="difflineminus">-</span>
<a href="#l3.284"></a><span id="l3.284" class="difflineminus">-    NS_IMETHOD ArcLabelsIn(nsIRDFNode* node,</span>
<a href="#l3.285"></a><span id="l3.285" class="difflineminus">-                           nsISimpleEnumerator** labels)</span>
<a href="#l3.286"></a><span id="l3.286" class="difflineminus">-    {</span>
<a href="#l3.287"></a><span id="l3.287" class="difflineminus">-        return mInner-&gt;ArcLabelsIn(node, labels);</span>
<a href="#l3.288"></a><span id="l3.288" class="difflineminus">-    }</span>
<a href="#l3.289"></a><span id="l3.289" class="difflineminus">-</span>
<a href="#l3.290"></a><span id="l3.290" class="difflineminus">-    NS_IMETHOD ArcLabelsOut(nsIRDFResource* source,</span>
<a href="#l3.291"></a><span id="l3.291" class="difflineminus">-                            nsISimpleEnumerator** labels);</span>
<a href="#l3.292"></a><span id="l3.292" class="difflineminus">-</span>
<a href="#l3.293"></a><span id="l3.293" class="difflineminus">-    NS_IMETHOD GetAllResources(nsISimpleEnumerator** aResult);</span>
<a href="#l3.294"></a><span id="l3.294" class="difflineminus">-</span>
<a href="#l3.295"></a><span id="l3.295" class="difflineminus">-    NS_IMETHOD GetAllCmds(nsIRDFResource* source,</span>
<a href="#l3.296"></a><span id="l3.296" class="difflineminus">-                          nsISimpleEnumerator/*&lt;nsIRDFResource&gt;*/** commands);</span>
<a href="#l3.297"></a><span id="l3.297" class="difflineminus">-</span>
<a href="#l3.298"></a><span id="l3.298" class="difflineminus">-    NS_IMETHOD IsCommandEnabled(nsISupportsArray/*&lt;nsIRDFResource&gt;*/* aSources,</span>
<a href="#l3.299"></a><span id="l3.299" class="difflineminus">-                                nsIRDFResource*   aCommand,</span>
<a href="#l3.300"></a><span id="l3.300" class="difflineminus">-                                nsISupportsArray/*&lt;nsIRDFResource&gt;*/* aArguments,</span>
<a href="#l3.301"></a><span id="l3.301" class="difflineminus">-                                PRBool* aResult);</span>
<a href="#l3.302"></a><span id="l3.302" class="difflineminus">-</span>
<a href="#l3.303"></a><span id="l3.303" class="difflineminus">-    NS_IMETHOD DoCommand(nsISupportsArray/*&lt;nsIRDFResource&gt;*/* aSources,</span>
<a href="#l3.304"></a><span id="l3.304" class="difflineminus">-                         nsIRDFResource*   aCommand,</span>
<a href="#l3.305"></a><span id="l3.305" class="difflineminus">-                         nsISupportsArray/*&lt;nsIRDFResource&gt;*/* aArguments);</span>
<a href="#l3.306"></a><span id="l3.306" class="difflineminus">-</span>
<a href="#l3.307"></a><span id="l3.307" class="difflineminus">-    NS_IMETHOD BeginUpdateBatch() {</span>
<a href="#l3.308"></a><span id="l3.308" class="difflineminus">-        return mInner-&gt;BeginUpdateBatch();</span>
<a href="#l3.309"></a><span id="l3.309" class="difflineminus">-    }</span>
<a href="#l3.310"></a><span id="l3.310" class="difflineminus">-</span>
<a href="#l3.311"></a><span id="l3.311" class="difflineminus">-    NS_IMETHOD EndUpdateBatch() {</span>
<a href="#l3.312"></a><span id="l3.312" class="difflineminus">-        return mInner-&gt;EndUpdateBatch();</span>
<a href="#l3.313"></a><span id="l3.313" class="difflineminus">-    }</span>
<a href="#l3.314"></a><span id="l3.314" class="difflineminus">-</span>
<a href="#l3.315"></a><span id="l3.315" class="difflineminus">-    // nsIRDFRemoteDataSource</span>
<a href="#l3.316"></a><span id="l3.316" class="difflineminus">-    NS_DECL_NSIRDFREMOTEDATASOURCE</span>
<a href="#l3.317"></a><span id="l3.317" class="difflineminus">-</span>
<a href="#l3.318"></a><span id="l3.318" class="difflineminus">-    // nsIRDFPropagatableDataSource</span>
<a href="#l3.319"></a><span id="l3.319" class="difflineminus">-    NS_DECL_NSIRDFPROPAGATABLEDATASOURCE</span>
<a href="#l3.320"></a><span id="l3.320" class="difflineminus">-</span>
<a href="#l3.321"></a><span id="l3.321" class="difflineminus">-    // nsIRDFObserver</span>
<a href="#l3.322"></a><span id="l3.322" class="difflineminus">-    NS_DECL_NSIRDFOBSERVER</span>
<a href="#l3.323"></a><span id="l3.323" class="difflineminus">-};</span>
<a href="#l3.324"></a><span id="l3.324" class="difflineminus">-</span>
<a href="#l3.325"></a><span id="l3.325" class="difflineminus">-#endif // bookmarksservice___h___</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/suite/browser/src/nsInternetSearchService.cpp</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/suite/browser/src/nsInternetSearchService.cpp</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -70,17 +70,16 @@</span>
<a href="#l4.4"></a><span id="l4.4"> #include &quot;nsITextToSubURI.h&quot;</span>
<a href="#l4.5"></a><span id="l4.5"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l4.6"></a><span id="l4.6"> #include &quot;nsINetUtil.h&quot;</span>
<a href="#l4.7"></a><span id="l4.7"> #include &quot;nsIChannel.h&quot;</span>
<a href="#l4.8"></a><span id="l4.8"> #include &quot;nsIFileChannel.h&quot;</span>
<a href="#l4.9"></a><span id="l4.9"> #include &quot;nsIHttpChannel.h&quot;</span>
<a href="#l4.10"></a><span id="l4.10"> #include &quot;nsIUploadChannel.h&quot;</span>
<a href="#l4.11"></a><span id="l4.11"> #include &quot;nsIInputStream.h&quot;</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-#include &quot;nsIBookmarksService.h&quot;</span>
<a href="#l4.13"></a><span id="l4.13"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l4.14"></a><span id="l4.14"> #include &quot;nsIObserverService.h&quot;</span>
<a href="#l4.15"></a><span id="l4.15"> #include &quot;nsIURL.h&quot;</span>
<a href="#l4.16"></a><span id="l4.16"> #include &quot;nsILocalFile.h&quot;</span>
<a href="#l4.17"></a><span id="l4.17"> #include &quot;nsUnicharUtils.h&quot;</span>
<a href="#l4.18"></a><span id="l4.18"> #include &quot;nsIPrefLocalizedString.h&quot;</span>
<a href="#l4.19"></a><span id="l4.19"> #include &quot;nsIPrefBranch2.h&quot;</span>
<a href="#l4.20"></a><span id="l4.20"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineat">@@ -1576,36 +1575,16 @@ InternetSearchDataSource::GetAllCmds(nsI</span>
<a href="#l4.22"></a><span id="l4.22">     }</span>
<a href="#l4.23"></a><span id="l4.23">   }</span>
<a href="#l4.24"></a><span id="l4.24"> </span>
<a href="#l4.25"></a><span id="l4.25">   PRBool        isSearchResult = PR_FALSE;</span>
<a href="#l4.26"></a><span id="l4.26">   rv = mInner-&gt;HasAssertion(source, mRDF_type, mNC_SearchResult, PR_TRUE,</span>
<a href="#l4.27"></a><span id="l4.27">           &amp;isSearchResult);</span>
<a href="#l4.28"></a><span id="l4.28">   if (NS_SUCCEEDED(rv) &amp;&amp; isSearchResult)</span>
<a href="#l4.29"></a><span id="l4.29">   {</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineminus">-#ifndef MOZ_PLACES_BOOKMARKS</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">-    nsCOMPtr&lt;nsIRDFDataSource&gt;  datasource;</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineminus">-    if (NS_SUCCEEDED(rv = mRDFService-&gt;GetDataSource(&quot;rdf:bookmarks&quot;, getter_AddRefs(datasource))))</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineminus">-    {</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineminus">-      nsCOMPtr&lt;nsIBookmarksService&gt; bookmarks (do_QueryInterface(datasource));</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineminus">-      if (bookmarks)</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineminus">-      {</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineminus">-        nsAutoString uri;</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineminus">-        if (getSearchURI(source, uri))</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineminus">-        {</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineminus">-          PRBool  isBookmarkedFlag = PR_FALSE;</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineminus">-          rv = bookmarks-&gt;IsBookmarked(NS_ConvertUTF16toUTF8(uri).get(), &amp;isBookmarkedFlag);</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineminus">-          if (NS_SUCCEEDED(rv) &amp;&amp; !isBookmarkedFlag)</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineminus">-          {</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineminus">-            cmdArray-&gt;AppendElement(mNC_SearchCommand_AddToBookmarks);</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineminus">-          }</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineminus">-        }</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineminus">-      }</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineminus">-    }</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineminus">-#endif</span>
<a href="#l4.50"></a><span id="l4.50">     cmdArray-&gt;AppendElement(mNC_SearchCommand_AddQueryToBookmarks);</span>
<a href="#l4.51"></a><span id="l4.51">     cmdArray-&gt;AppendElement(mNC_BookmarkSeparator);</span>
<a href="#l4.52"></a><span id="l4.52"> </span>
<a href="#l4.53"></a><span id="l4.53">     // if this is a search result, and it isn't filtered, enable command to be able to filter it</span>
<a href="#l4.54"></a><span id="l4.54">     PRBool        isURLFiltered = PR_FALSE;</span>
<a href="#l4.55"></a><span id="l4.55">     rv = mInner-&gt;HasAssertion(mNC_FilterSearchURLsRoot, mNC_Child, source,</span>
<a href="#l4.56"></a><span id="l4.56">                               PR_TRUE, &amp;isURLFiltered);</span>
<a href="#l4.57"></a><span id="l4.57">     if (NS_SUCCEEDED(rv) &amp;&amp; !isURLFiltered)</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineat">@@ -1693,33 +1672,16 @@ InternetSearchDataSource::addToBookmarks</span>
<a href="#l4.59"></a><span id="l4.59">   {</span>
<a href="#l4.60"></a><span id="l4.60">     nameLiteral = do_QueryInterface(nameNode);</span>
<a href="#l4.61"></a><span id="l4.61">     if (nameLiteral)</span>
<a href="#l4.62"></a><span id="l4.62">     {</span>
<a href="#l4.63"></a><span id="l4.63">       nameLiteral-&gt;GetValueConst(&amp;name);</span>
<a href="#l4.64"></a><span id="l4.64">     }</span>
<a href="#l4.65"></a><span id="l4.65">   }</span>
<a href="#l4.66"></a><span id="l4.66"> </span>
<a href="#l4.67"></a><span id="l4.67" class="difflineminus">-#ifndef MOZ_PLACES_BOOKMARKS</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineminus">-  nsCOMPtr&lt;nsIRDFDataSource&gt;  datasource;</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineminus">-  if (NS_SUCCEEDED(rv = mRDFService-&gt;GetDataSource(&quot;rdf:bookmarks&quot;, getter_AddRefs(datasource))))</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineminus">-  {</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineminus">-    nsCOMPtr&lt;nsIBookmarksService&gt; bookmarks (do_QueryInterface(datasource));</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineminus">-    if (bookmarks)</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineminus">-    {</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineminus">-      nsAutoString uri;</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineminus">-      if (getSearchURI(src, uri))</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineminus">-      {</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineminus">-        rv = bookmarks-&gt;AddBookmarkImmediately(uri.get(),</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineminus">-                                               name, nsIBookmarksService::BOOKMARK_SEARCH_TYPE, nsnull);</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineminus">-      }</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineminus">-    }</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineminus">-  }</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineminus">-#endif</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineminus">-</span>
<a href="#l4.84"></a><span id="l4.84">   return(NS_OK);</span>
<a href="#l4.85"></a><span id="l4.85"> }</span>
<a href="#l4.86"></a><span id="l4.86"> </span>
<a href="#l4.87"></a><span id="l4.87"> </span>
<a href="#l4.88"></a><span id="l4.88"> </span>
<a href="#l4.89"></a><span id="l4.89"> nsresult</span>
<a href="#l4.90"></a><span id="l4.90"> InternetSearchDataSource::addQueryToBookmarks(nsIRDFResource *src)</span>
<a href="#l4.91"></a><span id="l4.91"> {</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineat">@@ -1766,27 +1728,16 @@ InternetSearchDataSource::addQueryToBook</span>
<a href="#l4.93"></a><span id="l4.93">       {</span>
<a href="#l4.94"></a><span id="l4.94">         const PRUnichar *strings[] = { name.get() };</span>
<a href="#l4.95"></a><span id="l4.95">         rv = bundle-&gt;FormatStringFromName(NS_LITERAL_STRING(&quot;searchTitle&quot;).get(), strings, 1, </span>
<a href="#l4.96"></a><span id="l4.96">           getter_Copies(value));</span>
<a href="#l4.97"></a><span id="l4.97">       }</span>
<a href="#l4.98"></a><span id="l4.98">     }</span>
<a href="#l4.99"></a><span id="l4.99">   }</span>
<a href="#l4.100"></a><span id="l4.100"> </span>
<a href="#l4.101"></a><span id="l4.101" class="difflineminus">-#ifndef MOZ_PLACES_BOOKMARKS</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineminus">-  nsCOMPtr&lt;nsIRDFDataSource&gt;  datasource;</span>
<a href="#l4.103"></a><span id="l4.103" class="difflineminus">-  if (NS_SUCCEEDED(rv = mRDFService-&gt;GetDataSource(&quot;rdf:bookmarks&quot;, getter_AddRefs(datasource))))</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineminus">-  {</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineminus">-    nsCOMPtr&lt;nsIBookmarksService&gt; bookmarks (do_QueryInterface(datasource));</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineminus">-    if (bookmarks)</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineminus">-      rv = bookmarks-&gt;AddBookmarkImmediately(uriUni, value.get(),</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineminus">-                                             nsIBookmarksService::BOOKMARK_SEARCH_TYPE, nsnull);</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineminus">-  }</span>
<a href="#l4.110"></a><span id="l4.110" class="difflineminus">-#endif</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineminus">-</span>
<a href="#l4.112"></a><span id="l4.112">   return(NS_OK);</span>
<a href="#l4.113"></a><span id="l4.113"> }</span>
<a href="#l4.114"></a><span id="l4.114"> </span>
<a href="#l4.115"></a><span id="l4.115"> </span>
<a href="#l4.116"></a><span id="l4.116"> </span>
<a href="#l4.117"></a><span id="l4.117"> nsresult</span>
<a href="#l4.118"></a><span id="l4.118"> InternetSearchDataSource::filterResult(nsIRDFResource *aResource)</span>
<a href="#l4.119"></a><span id="l4.119"> {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1">deleted file mode 100644</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineminus">--- a/suite/common/bookmarks/addBookmark.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineplus">+++ /dev/null</span>
<a href="#l5.4"></a><span id="l5.4" class="difflineat">@@ -1,341 +0,0 @@</span>
<a href="#l5.5"></a><span id="l5.5" class="difflineminus">-/* -*- Mode: Java; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l5.6"></a><span id="l5.6" class="difflineminus">-/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l5.7"></a><span id="l5.7" class="difflineminus">- * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l5.8"></a><span id="l5.8" class="difflineminus">- *</span>
<a href="#l5.9"></a><span id="l5.9" class="difflineminus">- * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l5.10"></a><span id="l5.10" class="difflineminus">- * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l5.11"></a><span id="l5.11" class="difflineminus">- * the License. You may obtain a copy of the License at</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">- * http://www.mozilla.org/MPL/</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">- *</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineminus">- * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineminus">- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineminus">- * for the specific language governing rights and limitations under the</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineminus">- * License.</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineminus">- *</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineminus">- * The Original Code is mozilla.org code.</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineminus">- *</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineminus">- * The Initial Developer of the Original Code is</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineminus">- * Netscape Communications Corporation.</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineminus">- * Portions created by the Initial Developer are Copyright (C) 1998</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineminus">- * the Initial Developer. All Rights Reserved.</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineminus">- *</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineminus">- * Contributor(s):</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineminus">- *   Ben Goodger &lt;ben@netscape.com&gt; (Original Author)</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineminus">- *</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineminus">- * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineminus">- * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineminus">- * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineminus">- * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineminus">- * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineminus">- * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineminus">- * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineminus">- * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineminus">- * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineminus">- * the provisions above, a recipient may use your version of this file under</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineminus">- * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineminus">- *</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineminus">- * ***** END LICENSE BLOCK ***** */</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineminus">-</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineminus">-/**</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineminus">- * Add Bookmark Dialog. </span>
<a href="#l5.45"></a><span id="l5.45" class="difflineminus">- * ====================</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineminus">- * </span>
<a href="#l5.47"></a><span id="l5.47" class="difflineminus">- * This is a generic bookmark dialog that allows for bookmark addition</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineminus">- * and folder selection. It can be opened with various parameters that </span>
<a href="#l5.49"></a><span id="l5.49" class="difflineminus">- * result in appearance/purpose differences and initial state. </span>
<a href="#l5.50"></a><span id="l5.50" class="difflineminus">- * </span>
<a href="#l5.51"></a><span id="l5.51" class="difflineminus">- * Use: Open with 'openDialog', with the flags </span>
<a href="#l5.52"></a><span id="l5.52" class="difflineminus">- *        'centerscreen,chrome,dialog=no,resizable=yes'</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineminus">- * </span>
<a href="#l5.54"></a><span id="l5.54" class="difflineminus">- * Parameters: </span>
<a href="#l5.55"></a><span id="l5.55" class="difflineminus">- *   Apart from the standard openDialog parameters, this dialog can </span>
<a href="#l5.56"></a><span id="l5.56" class="difflineminus">- *   be passed additional information, which gets mapped to the </span>
<a href="#l5.57"></a><span id="l5.57" class="difflineminus">- *   window.arguments array:</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineminus">- * </span>
<a href="#l5.59"></a><span id="l5.59" class="difflineminus">- *   window.arguments[0]: Bookmark Name. The value to be prefilled</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineminus">- *                        into the &quot;Name: &quot; field (if visible).</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineminus">- *   window.arguments[1]: Bookmark URL: The location of the bookmark.</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineminus">- *                        The value to be filled in the &quot;Location: &quot;</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineminus">- *                        field (if visible).</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineminus">- *   window.arguments[2]: Bookmark Folder. The RDF Resource URI of the</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineminus">- *                        folder that this bookmark should be created in.</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineminus">- *   window.arguments[3]: Bookmark Charset. The charset that should be</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineminus">- *                        used when adding a bookmark to the specified</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineminus">- *                        URL. (Usually the charset of the current </span>
<a href="#l5.69"></a><span id="l5.69" class="difflineminus">- *                        document when launching this window).</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineminus">- *   window.arguments[4]: The mode of operation. See notes for details.</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineminus">- *   window.arguments[5]: If the mode is &quot;addGroup&quot;, this is an array</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineminus">- *                        of objects with name, URL and charset</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineminus">- *                        properties, one for each group member.</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineminus">- *</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineminus">- * Mode of Operation Notes:</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineminus">- * ------------------------</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineminus">- * This dialog can be opened in four different ways by using a parameter</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineminus">- * passed through the call to openDialog. The 'mode' of operation</span>
<a href="#l5.79"></a><span id="l5.79" class="difflineminus">- * of the window is expressed in window.arguments[4]. The valid modes are:</span>
<a href="#l5.80"></a><span id="l5.80" class="difflineminus">- *</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineminus">- * 1) &lt;default&gt; (no fifth open parameter).</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineminus">- *      Opens this dialog with the bookmark Name, URL and folder selection</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineminus">- *      components visible. </span>
<a href="#l5.84"></a><span id="l5.84" class="difflineminus">- * 2) &quot;newBookmark&quot; (fifth open parameter = String(&quot;newBookmark&quot;))</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineminus">- *      Opens the dialog as in (1) above except the folder selection tree</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineminus">- *      is hidden. This type of mode is useful when the creation folder </span>
<a href="#l5.87"></a><span id="l5.87" class="difflineminus">- *      is pre-determined.</span>
<a href="#l5.88"></a><span id="l5.88" class="difflineminus">- * 3) &quot;selectFolder&quot; (fifth open parameter = String(&quot;selectFolder&quot;))</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineminus">- *      Opens the dialog as in (1) above except the Name/Location section</span>
<a href="#l5.90"></a><span id="l5.90" class="difflineminus">- *      is hidden, and the dialog takes on the utility of a Folder chooser.</span>
<a href="#l5.91"></a><span id="l5.91" class="difflineminus">- *      Used when the user must select a Folder for some purpose. </span>
<a href="#l5.92"></a><span id="l5.92" class="difflineminus">- * 4) &quot;addGroup&quot; (fifth open parameter = String(&quot;addGroup&quot;))</span>
<a href="#l5.93"></a><span id="l5.93" class="difflineminus">- *      Opens the dialog like &lt;default&gt;, with a checkbox to select between</span>
<a href="#l5.94"></a><span id="l5.94" class="difflineminus">- *      filing a single bookmark or a group. For the single bookmark the</span>
<a href="#l5.95"></a><span id="l5.95" class="difflineminus">- *      values are taken from the name, URL and charset arguments.</span>
<a href="#l5.96"></a><span id="l5.96" class="difflineminus">- *      For the group, the values are taken from the sixth argument.</span>
<a href="#l5.97"></a><span id="l5.97" class="difflineminus">- *      This parameter can also be String(&quot;addGroup,group&quot;) where &quot;group&quot;</span>
<a href="#l5.98"></a><span id="l5.98" class="difflineminus">- *      specifies that the dialog starts in filing as a group.</span>
<a href="#l5.99"></a><span id="l5.99" class="difflineminus">- */</span>
<a href="#l5.100"></a><span id="l5.100" class="difflineminus">-</span>
<a href="#l5.101"></a><span id="l5.101" class="difflineminus">-var gFld_Name   = null;</span>
<a href="#l5.102"></a><span id="l5.102" class="difflineminus">-var gFld_URL    = null; </span>
<a href="#l5.103"></a><span id="l5.103" class="difflineminus">-var gFld_ShortcutURL = null; </span>
<a href="#l5.104"></a><span id="l5.104" class="difflineminus">-var gFolderTree = null;</span>
<a href="#l5.105"></a><span id="l5.105" class="difflineminus">-var gCB_AddGroup = null;</span>
<a href="#l5.106"></a><span id="l5.106" class="difflineminus">-</span>
<a href="#l5.107"></a><span id="l5.107" class="difflineminus">-var gBookmarkCharset = null;</span>
<a href="#l5.108"></a><span id="l5.108" class="difflineminus">-</span>
<a href="#l5.109"></a><span id="l5.109" class="difflineminus">-const kRDFSContractID = &quot;@mozilla.org/rdf/rdf-service;1&quot;;</span>
<a href="#l5.110"></a><span id="l5.110" class="difflineminus">-const kRDFSIID = Components.interfaces.nsIRDFService;</span>
<a href="#l5.111"></a><span id="l5.111" class="difflineminus">-const kRDF = Components.classes[kRDFSContractID].getService(kRDFSIID);</span>
<a href="#l5.112"></a><span id="l5.112" class="difflineminus">-</span>
<a href="#l5.113"></a><span id="l5.113" class="difflineminus">-var gSelectItemObserver = null;</span>
<a href="#l5.114"></a><span id="l5.114" class="difflineminus">-</span>
<a href="#l5.115"></a><span id="l5.115" class="difflineminus">-var gCreateInFolder = &quot;NC:NewBookmarkFolder&quot;;</span>
<a href="#l5.116"></a><span id="l5.116" class="difflineminus">-</span>
<a href="#l5.117"></a><span id="l5.117" class="difflineminus">-function Startup()</span>
<a href="#l5.118"></a><span id="l5.118" class="difflineminus">-{</span>
<a href="#l5.119"></a><span id="l5.119" class="difflineminus">-  gFld_Name = document.getElementById(&quot;name&quot;);</span>
<a href="#l5.120"></a><span id="l5.120" class="difflineminus">-  gFld_URL = document.getElementById(&quot;url&quot;);</span>
<a href="#l5.121"></a><span id="l5.121" class="difflineminus">-  gFld_ShortcutURL = document.getElementById(&quot;shortcutUrl&quot;);</span>
<a href="#l5.122"></a><span id="l5.122" class="difflineminus">-  gCB_AddGroup = document.getElementById(&quot;addgroup&quot;);</span>
<a href="#l5.123"></a><span id="l5.123" class="difflineminus">-  var bookmarkView = document.getElementById(&quot;bookmarks-view&quot;);</span>
<a href="#l5.124"></a><span id="l5.124" class="difflineminus">-</span>
<a href="#l5.125"></a><span id="l5.125" class="difflineminus">-  var shouldSetOKButton = true;</span>
<a href="#l5.126"></a><span id="l5.126" class="difflineminus">-  var dialogElement = document.documentElement;</span>
<a href="#l5.127"></a><span id="l5.127" class="difflineminus">-  if (&quot;arguments&quot; in window) {</span>
<a href="#l5.128"></a><span id="l5.128" class="difflineminus">-    var ind;</span>
<a href="#l5.129"></a><span id="l5.129" class="difflineminus">-    var folderItem = null;</span>
<a href="#l5.130"></a><span id="l5.130" class="difflineminus">-    var arg;</span>
<a href="#l5.131"></a><span id="l5.131" class="difflineminus">-    if (window.arguments.length &lt; 5)</span>
<a href="#l5.132"></a><span id="l5.132" class="difflineminus">-      arg = null;</span>
<a href="#l5.133"></a><span id="l5.133" class="difflineminus">-    else</span>
<a href="#l5.134"></a><span id="l5.134" class="difflineminus">-      arg = window.arguments[4];</span>
<a href="#l5.135"></a><span id="l5.135" class="difflineminus">-    switch (arg) {</span>
<a href="#l5.136"></a><span id="l5.136" class="difflineminus">-    case &quot;selectFolder&quot;:</span>
<a href="#l5.137"></a><span id="l5.137" class="difflineminus">-      // If we're being opened as a folder selection window</span>
<a href="#l5.138"></a><span id="l5.138" class="difflineminus">-      document.getElementById(&quot;bookmarknamegrid&quot;).hidden = true;</span>
<a href="#l5.139"></a><span id="l5.139" class="difflineminus">-      document.getElementById(&quot;showaddgroup&quot;).hidden = true;</span>
<a href="#l5.140"></a><span id="l5.140" class="difflineminus">-      document.getElementById(&quot;destinationSeparator&quot;).hidden = true;</span>
<a href="#l5.141"></a><span id="l5.141" class="difflineminus">-      document.getElementById(&quot;nameseparator&quot;).hidden = true;</span>
<a href="#l5.142"></a><span id="l5.142" class="difflineminus">-      document.title = dialogElement.getAttribute(&quot;selectFolderTitle&quot;);</span>
<a href="#l5.143"></a><span id="l5.143" class="difflineminus">-      shouldSetOKButton = false;</span>
<a href="#l5.144"></a><span id="l5.144" class="difflineminus">-      if (window.arguments[2])</span>
<a href="#l5.145"></a><span id="l5.145" class="difflineminus">-        folderItem = RDF.GetResource(window.arguments[2]);</span>
<a href="#l5.146"></a><span id="l5.146" class="difflineminus">-      if (folderItem) {</span>
<a href="#l5.147"></a><span id="l5.147" class="difflineminus">-        ind = bookmarkView.treeBuilder.getIndexOfResource(folderItem);</span>
<a href="#l5.148"></a><span id="l5.148" class="difflineminus">-        bookmarkView.tree.view.selection.select(ind);</span>
<a href="#l5.149"></a><span id="l5.149" class="difflineminus">-      }</span>
<a href="#l5.150"></a><span id="l5.150" class="difflineminus">-      break;</span>
<a href="#l5.151"></a><span id="l5.151" class="difflineminus">-    case &quot;newBookmark&quot;:</span>
<a href="#l5.152"></a><span id="l5.152" class="difflineminus">-      document.getElementById(&quot;showaddgroup&quot;).hidden = true;</span>
<a href="#l5.153"></a><span id="l5.153" class="difflineminus">-      document.getElementById(&quot;destinationSeparator&quot;).hidden = true;</span>
<a href="#l5.154"></a><span id="l5.154" class="difflineminus">-      document.getElementById(&quot;folderbox&quot;).hidden = true;</span>
<a href="#l5.155"></a><span id="l5.155" class="difflineminus">-      setupFields();</span>
<a href="#l5.156"></a><span id="l5.156" class="difflineminus">-      if (window.arguments[2])</span>
<a href="#l5.157"></a><span id="l5.157" class="difflineminus">-        gCreateInFolder = window.arguments[2];</span>
<a href="#l5.158"></a><span id="l5.158" class="difflineminus">-      break;</span>
<a href="#l5.159"></a><span id="l5.159" class="difflineminus">-    case &quot;addGroup&quot;:</span>
<a href="#l5.160"></a><span id="l5.160" class="difflineminus">-      setupFields();</span>
<a href="#l5.161"></a><span id="l5.161" class="difflineminus">-      break;</span>
<a href="#l5.162"></a><span id="l5.162" class="difflineminus">-    case &quot;addGroup,group&quot;:</span>
<a href="#l5.163"></a><span id="l5.163" class="difflineminus">-      gCB_AddGroup.checked = true;</span>
<a href="#l5.164"></a><span id="l5.164" class="difflineminus">-      setupFields();</span>
<a href="#l5.165"></a><span id="l5.165" class="difflineminus">-      toggleGroup();</span>
<a href="#l5.166"></a><span id="l5.166" class="difflineminus">-      break;</span>
<a href="#l5.167"></a><span id="l5.167" class="difflineminus">-    default:</span>
<a href="#l5.168"></a><span id="l5.168" class="difflineminus">-      // Regular Add Bookmark</span>
<a href="#l5.169"></a><span id="l5.169" class="difflineminus">-      document.getElementById(&quot;showaddgroup&quot;).hidden = true;</span>
<a href="#l5.170"></a><span id="l5.170" class="difflineminus">-      setupFields();</span>
<a href="#l5.171"></a><span id="l5.171" class="difflineminus">-      if (window.arguments[2]) {</span>
<a href="#l5.172"></a><span id="l5.172" class="difflineminus">-        gCreateInFolder = window.arguments[2];</span>
<a href="#l5.173"></a><span id="l5.173" class="difflineminus">-        folderItem = RDF.GetResource(gCreateInFolder);</span>
<a href="#l5.174"></a><span id="l5.174" class="difflineminus">-        if (folderItem) {</span>
<a href="#l5.175"></a><span id="l5.175" class="difflineminus">-          ind = bookmarkView.treeBuilder.getIndexOfResource(folderItem);</span>
<a href="#l5.176"></a><span id="l5.176" class="difflineminus">-          bookmarkView.tree.view.selection.select(ind);</span>
<a href="#l5.177"></a><span id="l5.177" class="difflineminus">-        }</span>
<a href="#l5.178"></a><span id="l5.178" class="difflineminus">-      }</span>
<a href="#l5.179"></a><span id="l5.179" class="difflineminus">-    }</span>
<a href="#l5.180"></a><span id="l5.180" class="difflineminus">-  }</span>
<a href="#l5.181"></a><span id="l5.181" class="difflineminus">-</span>
<a href="#l5.182"></a><span id="l5.182" class="difflineminus">-  if ((arg != &quot;newBookmark&quot;) &amp;&amp; (bookmarkView.currentIndex == -1)) {</span>
<a href="#l5.183"></a><span id="l5.183" class="difflineminus">-    var folder = BookmarksUtils.getNewBookmarkFolder();</span>
<a href="#l5.184"></a><span id="l5.184" class="difflineminus">-    ind = bookmarkView.treeBuilder.getIndexOfResource(folder);</span>
<a href="#l5.185"></a><span id="l5.185" class="difflineminus">-    if (ind != -1)</span>
<a href="#l5.186"></a><span id="l5.186" class="difflineminus">-      bookmarkView.tree.view.selection.select(ind);</span>
<a href="#l5.187"></a><span id="l5.187" class="difflineminus">-    else</span>
<a href="#l5.188"></a><span id="l5.188" class="difflineminus">-      bookmarkView.tree.view.selection.select(0);</span>
<a href="#l5.189"></a><span id="l5.189" class="difflineminus">-  }</span>
<a href="#l5.190"></a><span id="l5.190" class="difflineminus">-</span>
<a href="#l5.191"></a><span id="l5.191" class="difflineminus">-  if (shouldSetOKButton)</span>
<a href="#l5.192"></a><span id="l5.192" class="difflineminus">-    onFieldInput();</span>
<a href="#l5.193"></a><span id="l5.193" class="difflineminus">-  if (document.getElementById(&quot;bookmarknamegrid&quot;).hidden) {</span>
<a href="#l5.194"></a><span id="l5.194" class="difflineminus">-    bookmarkView.tree.focus();</span>
<a href="#l5.195"></a><span id="l5.195" class="difflineminus">-  } else {</span>
<a href="#l5.196"></a><span id="l5.196" class="difflineminus">-    gFld_Name.select();</span>
<a href="#l5.197"></a><span id="l5.197" class="difflineminus">-    gFld_Name.focus();</span>
<a href="#l5.198"></a><span id="l5.198" class="difflineminus">-  }</span>
<a href="#l5.199"></a><span id="l5.199" class="difflineminus">-</span>
<a href="#l5.200"></a><span id="l5.200" class="difflineminus">-  // XXX fix old profiles</span>
<a href="#l5.201"></a><span id="l5.201" class="difflineminus">-  dialogElement.removeAttribute(&quot;height&quot;);</span>
<a href="#l5.202"></a><span id="l5.202" class="difflineminus">-  dialogElement.removeAttribute(&quot;width&quot;);</span>
<a href="#l5.203"></a><span id="l5.203" class="difflineminus">-  sizeToContent();</span>
<a href="#l5.204"></a><span id="l5.204" class="difflineminus">-}</span>
<a href="#l5.205"></a><span id="l5.205" class="difflineminus">-</span>
<a href="#l5.206"></a><span id="l5.206" class="difflineminus">-function setupFields()</span>
<a href="#l5.207"></a><span id="l5.207" class="difflineminus">-{</span>
<a href="#l5.208"></a><span id="l5.208" class="difflineminus">-  // New bookmark in predetermined folder. </span>
<a href="#l5.209"></a><span id="l5.209" class="difflineminus">-  gFld_Name.value = window.arguments[0] || &quot;&quot;;</span>
<a href="#l5.210"></a><span id="l5.210" class="difflineminus">-  gFld_URL.value = window.arguments[1] || &quot;&quot;;</span>
<a href="#l5.211"></a><span id="l5.211" class="difflineminus">-  onFieldInput();</span>
<a href="#l5.212"></a><span id="l5.212" class="difflineminus">-  gFld_Name.select();</span>
<a href="#l5.213"></a><span id="l5.213" class="difflineminus">-  gFld_Name.focus();</span>
<a href="#l5.214"></a><span id="l5.214" class="difflineminus">-  gBookmarkCharset = window.arguments[3] || null;</span>
<a href="#l5.215"></a><span id="l5.215" class="difflineminus">-}</span>
<a href="#l5.216"></a><span id="l5.216" class="difflineminus">-</span>
<a href="#l5.217"></a><span id="l5.217" class="difflineminus">-function onFieldInput()</span>
<a href="#l5.218"></a><span id="l5.218" class="difflineminus">-{</span>
<a href="#l5.219"></a><span id="l5.219" class="difflineminus">-  const ok = document.documentElement.getButton(&quot;accept&quot;);</span>
<a href="#l5.220"></a><span id="l5.220" class="difflineminus">-  ok.disabled = gFld_URL.value == &quot;&quot; &amp;&amp; !gCB_AddGroup.checked ||</span>
<a href="#l5.221"></a><span id="l5.221" class="difflineminus">-                gFld_Name.value == &quot;&quot;;</span>
<a href="#l5.222"></a><span id="l5.222" class="difflineminus">-}    </span>
<a href="#l5.223"></a><span id="l5.223" class="difflineminus">-</span>
<a href="#l5.224"></a><span id="l5.224" class="difflineminus">-function onOK()</span>
<a href="#l5.225"></a><span id="l5.225" class="difflineminus">-{</span>
<a href="#l5.226"></a><span id="l5.226" class="difflineminus">-  if (!document.getElementById(&quot;folderbox&quot;).hidden) {</span>
<a href="#l5.227"></a><span id="l5.227" class="difflineminus">-    var bookmarkView = document.getElementById(&quot;bookmarks-view&quot;);</span>
<a href="#l5.228"></a><span id="l5.228" class="difflineminus">-    var currentIndex = bookmarkView.currentIndex;</span>
<a href="#l5.229"></a><span id="l5.229" class="difflineminus">-    if (currentIndex != -1)</span>
<a href="#l5.230"></a><span id="l5.230" class="difflineminus">-      gCreateInFolder = bookmarkView.treeBuilder.getResourceAtIndex(currentIndex).Value;</span>
<a href="#l5.231"></a><span id="l5.231" class="difflineminus">-  }</span>
<a href="#l5.232"></a><span id="l5.232" class="difflineminus">-  // In Select Folder Mode, do nothing but tell our caller what</span>
<a href="#l5.233"></a><span id="l5.233" class="difflineminus">-  // folder was selected. </span>
<a href="#l5.234"></a><span id="l5.234" class="difflineminus">-  if (window.arguments.length &gt; 4 &amp;&amp; window.arguments[4] == &quot;selectFolder&quot;) {</span>
<a href="#l5.235"></a><span id="l5.235" class="difflineminus">-    window.arguments[5].target = BookmarksUtils.getTargetFromFolder(bookmarkView.treeBuilder.getResourceAtIndex(currentIndex));</span>
<a href="#l5.236"></a><span id="l5.236" class="difflineminus">-  }</span>
<a href="#l5.237"></a><span id="l5.237" class="difflineminus">-  else {</span>
<a href="#l5.238"></a><span id="l5.238" class="difflineminus">-    // Otherwise add a bookmark to the selected folder. </span>
<a href="#l5.239"></a><span id="l5.239" class="difflineminus">-</span>
<a href="#l5.240"></a><span id="l5.240" class="difflineminus">-    const kBMDS = kRDF.GetDataSource(&quot;rdf:bookmarks&quot;);</span>
<a href="#l5.241"></a><span id="l5.241" class="difflineminus">-    const kBMSContractID = &quot;@mozilla.org/browser/bookmarks-service;1&quot;;</span>
<a href="#l5.242"></a><span id="l5.242" class="difflineminus">-    const kBMSIID = Components.interfaces.nsIBookmarksService;</span>
<a href="#l5.243"></a><span id="l5.243" class="difflineminus">-    const kBMS = Components.classes[kBMSContractID].getService(kBMSIID);</span>
<a href="#l5.244"></a><span id="l5.244" class="difflineminus">-    var rFolder = kRDF.GetResource(gCreateInFolder, true);</span>
<a href="#l5.245"></a><span id="l5.245" class="difflineminus">-    const kRDFCContractID = &quot;@mozilla.org/rdf/container;1&quot;;</span>
<a href="#l5.246"></a><span id="l5.246" class="difflineminus">-    const kRDFIID = Components.interfaces.nsIRDFContainer;</span>
<a href="#l5.247"></a><span id="l5.247" class="difflineminus">-    const kRDFC = Components.classes[kRDFCContractID].createInstance(kRDFIID);</span>
<a href="#l5.248"></a><span id="l5.248" class="difflineminus">-    try {</span>
<a href="#l5.249"></a><span id="l5.249" class="difflineminus">-      kRDFC.Init(kBMDS, rFolder);</span>
<a href="#l5.250"></a><span id="l5.250" class="difflineminus">-    }</span>
<a href="#l5.251"></a><span id="l5.251" class="difflineminus">-    catch (e) {</span>
<a href="#l5.252"></a><span id="l5.252" class="difflineminus">-      // No &quot;NC:NewBookmarkFolder&quot; exists, just append to the root.</span>
<a href="#l5.253"></a><span id="l5.253" class="difflineminus">-      rFolder = kRDF.GetResource(&quot;NC:BookmarksRoot&quot;, true);</span>
<a href="#l5.254"></a><span id="l5.254" class="difflineminus">-      kRDFC.Init(kBMDS, rFolder);</span>
<a href="#l5.255"></a><span id="l5.255" class="difflineminus">-    }</span>
<a href="#l5.256"></a><span id="l5.256" class="difflineminus">-</span>
<a href="#l5.257"></a><span id="l5.257" class="difflineminus">-    var url;</span>
<a href="#l5.258"></a><span id="l5.258" class="difflineminus">-    if (gCB_AddGroup.checked) {</span>
<a href="#l5.259"></a><span id="l5.259" class="difflineminus">-      const group = kBMS.createGroupInContainer(gFld_Name.value, rFolder, -1);</span>
<a href="#l5.260"></a><span id="l5.260" class="difflineminus">-      const groups = window.arguments[5];</span>
<a href="#l5.261"></a><span id="l5.261" class="difflineminus">-      for (var i = 0; i &lt; groups.length; ++i) {</span>
<a href="#l5.262"></a><span id="l5.262" class="difflineminus">-        url = getNormalizedURL(groups[i].url);</span>
<a href="#l5.263"></a><span id="l5.263" class="difflineminus">-        kBMS.createBookmarkInContainer(groups[i].name, url, null, null,</span>
<a href="#l5.264"></a><span id="l5.264" class="difflineminus">-                                       groups[i].charset, group, -1);</span>
<a href="#l5.265"></a><span id="l5.265" class="difflineminus">-      }</span>
<a href="#l5.266"></a><span id="l5.266" class="difflineminus">-    } else if (gFld_URL.value) {</span>
<a href="#l5.267"></a><span id="l5.267" class="difflineminus">-      url = getNormalizedURL(gFld_URL.value);</span>
<a href="#l5.268"></a><span id="l5.268" class="difflineminus">-      var newBookmark = kBMS.createBookmarkInContainer(gFld_Name.value, url, gFld_ShortcutURL.value, null, gBookmarkCharset, rFolder, -1);</span>
<a href="#l5.269"></a><span id="l5.269" class="difflineminus">-      if (window.arguments.length &gt; 4 &amp;&amp; window.arguments[4] == &quot;newBookmark&quot;) {</span>
<a href="#l5.270"></a><span id="l5.270" class="difflineminus">-        window.arguments[5].newBookmark = newBookmark;</span>
<a href="#l5.271"></a><span id="l5.271" class="difflineminus">-      }</span>
<a href="#l5.272"></a><span id="l5.272" class="difflineminus">-    }</span>
<a href="#l5.273"></a><span id="l5.273" class="difflineminus">-  }</span>
<a href="#l5.274"></a><span id="l5.274" class="difflineminus">-}</span>
<a href="#l5.275"></a><span id="l5.275" class="difflineminus">-</span>
<a href="#l5.276"></a><span id="l5.276" class="difflineminus">-function getNormalizedURL(url)</span>
<a href="#l5.277"></a><span id="l5.277" class="difflineminus">-{</span>
<a href="#l5.278"></a><span id="l5.278" class="difflineminus">-  // Check to see if the item is a local directory path, and if so, convert</span>
<a href="#l5.279"></a><span id="l5.279" class="difflineminus">-  // to a file URL so that aggregation with rdf:files works</span>
<a href="#l5.280"></a><span id="l5.280" class="difflineminus">-  try {</span>
<a href="#l5.281"></a><span id="l5.281" class="difflineminus">-    const kLF = Components.classes[&quot;@mozilla.org/file/local;1&quot;]</span>
<a href="#l5.282"></a><span id="l5.282" class="difflineminus">-                          .createInstance(Components.interfaces.nsILocalFile);</span>
<a href="#l5.283"></a><span id="l5.283" class="difflineminus">-    kLF.initWithPath(url);</span>
<a href="#l5.284"></a><span id="l5.284" class="difflineminus">-    if (kLF.exists()) {</span>
<a href="#l5.285"></a><span id="l5.285" class="difflineminus">-      var ioService = Components.classes[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l5.286"></a><span id="l5.286" class="difflineminus">-                                .getService(Components.interfaces.nsIIOService);</span>
<a href="#l5.287"></a><span id="l5.287" class="difflineminus">-      var fileHandler = ioService.getProtocolHandler(&quot;file&quot;)</span>
<a href="#l5.288"></a><span id="l5.288" class="difflineminus">-                                 .QueryInterface(Components.interfaces.nsIFileProtocolHandler);</span>
<a href="#l5.289"></a><span id="l5.289" class="difflineminus">-</span>
<a href="#l5.290"></a><span id="l5.290" class="difflineminus">-      url = fileHandler.getURLSpecFromFile(kLF);</span>
<a href="#l5.291"></a><span id="l5.291" class="difflineminus">-    }</span>
<a href="#l5.292"></a><span id="l5.292" class="difflineminus">-  }</span>
<a href="#l5.293"></a><span id="l5.293" class="difflineminus">-  catch (e) {</span>
<a href="#l5.294"></a><span id="l5.294" class="difflineminus">-  }</span>
<a href="#l5.295"></a><span id="l5.295" class="difflineminus">-</span>
<a href="#l5.296"></a><span id="l5.296" class="difflineminus">-  return url;</span>
<a href="#l5.297"></a><span id="l5.297" class="difflineminus">-}</span>
<a href="#l5.298"></a><span id="l5.298" class="difflineminus">-</span>
<a href="#l5.299"></a><span id="l5.299" class="difflineminus">-var gBookmarksShell = null;</span>
<a href="#l5.300"></a><span id="l5.300" class="difflineminus">-function createNewFolder()</span>
<a href="#l5.301"></a><span id="l5.301" class="difflineminus">-{</span>
<a href="#l5.302"></a><span id="l5.302" class="difflineminus">-  var bookmarksView = document.getElementById(&quot;bookmarks-view&quot;);</span>
<a href="#l5.303"></a><span id="l5.303" class="difflineminus">-  var resource = bookmarksView.treeBuilder.getResourceAtIndex(bookmarksView.currentIndex);</span>
<a href="#l5.304"></a><span id="l5.304" class="difflineminus">-  var target = BookmarksUtils.getTargetFromFolder(resource);</span>
<a href="#l5.305"></a><span id="l5.305" class="difflineminus">-  BookmarksCommand.createNewFolder(target);</span>
<a href="#l5.306"></a><span id="l5.306" class="difflineminus">-}</span>
<a href="#l5.307"></a><span id="l5.307" class="difflineminus">-</span>
<a href="#l5.308"></a><span id="l5.308" class="difflineminus">-var gOldNameValue = &quot;&quot;;</span>
<a href="#l5.309"></a><span id="l5.309" class="difflineminus">-var gOldURLValue = &quot;&quot;;</span>
<a href="#l5.310"></a><span id="l5.310" class="difflineminus">-var gOldShortcutURLValue = &quot;&quot;;</span>
<a href="#l5.311"></a><span id="l5.311" class="difflineminus">-</span>
<a href="#l5.312"></a><span id="l5.312" class="difflineminus">-function toggleGroup()</span>
<a href="#l5.313"></a><span id="l5.313" class="difflineminus">-{</span>
<a href="#l5.314"></a><span id="l5.314" class="difflineminus">-  // swap between single bookmark and group name</span>
<a href="#l5.315"></a><span id="l5.315" class="difflineminus">-  var temp = gOldNameValue;</span>
<a href="#l5.316"></a><span id="l5.316" class="difflineminus">-  gOldNameValue = gFld_Name.value;</span>
<a href="#l5.317"></a><span id="l5.317" class="difflineminus">-  gFld_Name.value = temp;</span>
<a href="#l5.318"></a><span id="l5.318" class="difflineminus">-</span>
<a href="#l5.319"></a><span id="l5.319" class="difflineminus">-  // swap between single bookmark and group url</span>
<a href="#l5.320"></a><span id="l5.320" class="difflineminus">-  temp = gOldURLValue;</span>
<a href="#l5.321"></a><span id="l5.321" class="difflineminus">-  gOldURLValue = gFld_URL.value;</span>
<a href="#l5.322"></a><span id="l5.322" class="difflineminus">-  gFld_URL.value = temp;</span>
<a href="#l5.323"></a><span id="l5.323" class="difflineminus">-  gFld_URL.disabled = gCB_AddGroup.checked;</span>
<a href="#l5.324"></a><span id="l5.324" class="difflineminus">-</span>
<a href="#l5.325"></a><span id="l5.325" class="difflineminus">-  // swap between single bookmark and group shortcut url</span>
<a href="#l5.326"></a><span id="l5.326" class="difflineminus">-  temp = gOldShortcutURLValue;</span>
<a href="#l5.327"></a><span id="l5.327" class="difflineminus">-  gOldShortcutURLValue = gFld_ShortcutURL.value;</span>
<a href="#l5.328"></a><span id="l5.328" class="difflineminus">-  gFld_ShortcutURL.value = temp;</span>
<a href="#l5.329"></a><span id="l5.329" class="difflineminus">-  gFld_ShortcutURL.disabled = gCB_AddGroup.checked;</span>
<a href="#l5.330"></a><span id="l5.330" class="difflineminus">-</span>
<a href="#l5.331"></a><span id="l5.331" class="difflineminus">-  gFld_Name.select();</span>
<a href="#l5.332"></a><span id="l5.332" class="difflineminus">-  gFld_Name.focus();</span>
<a href="#l5.333"></a><span id="l5.333" class="difflineminus">-  onFieldInput();</span>
<a href="#l5.334"></a><span id="l5.334" class="difflineminus">-}</span>
<a href="#l5.335"></a><span id="l5.335" class="difflineminus">-</span>
<a href="#l5.336"></a><span id="l5.336" class="difflineminus">-function persistTreeSize()</span>
<a href="#l5.337"></a><span id="l5.337" class="difflineminus">-{</span>
<a href="#l5.338"></a><span id="l5.338" class="difflineminus">-  if (!document.getElementById(&quot;folderbox&quot;).hidden) {</span>
<a href="#l5.339"></a><span id="l5.339" class="difflineminus">-    var bookmarkView = document.getElementById(&quot;bookmarks-view&quot;);</span>
<a href="#l5.340"></a><span id="l5.340" class="difflineminus">-    bookmarkView.setAttribute(&quot;height&quot;, bookmarkView.boxObject.height);</span>
<a href="#l5.341"></a><span id="l5.341" class="difflineminus">-    document.persist(&quot;bookmarks-view&quot;, &quot;height&quot;);</span>
<a href="#l5.342"></a><span id="l5.342" class="difflineminus">-    bookmarkView.setAttribute(&quot;width&quot;, bookmarkView.boxObject.width);</span>
<a href="#l5.343"></a><span id="l5.343" class="difflineminus">-    document.persist(&quot;bookmarks-view&quot;, &quot;width&quot;);</span>
<a href="#l5.344"></a><span id="l5.344" class="difflineminus">-  }</span>
<a href="#l5.345"></a><span id="l5.345" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1">deleted file mode 100644</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineminus">--- a/suite/common/bookmarks/addBookmark.xul</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineplus">+++ /dev/null</span>
<a href="#l6.4"></a><span id="l6.4" class="difflineat">@@ -1,129 +0,0 @@</span>
<a href="#l6.5"></a><span id="l6.5" class="difflineminus">-&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<a href="#l6.6"></a><span id="l6.6" class="difflineminus">-</span>
<a href="#l6.7"></a><span id="l6.7" class="difflineminus">-&lt;!-- -*- Mode: HTML; indent-tabs-mode: nil; -*- --&gt;</span>
<a href="#l6.8"></a><span id="l6.8" class="difflineminus">-&lt;!--</span>
<a href="#l6.9"></a><span id="l6.9" class="difflineminus">-</span>
<a href="#l6.10"></a><span id="l6.10" class="difflineminus">- ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l6.11"></a><span id="l6.11" class="difflineminus">- Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">- The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">- 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineminus">- the License. You may obtain a copy of the License at</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineminus">- http://www.mozilla.org/MPL/</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineminus">-</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineminus">- Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineminus">- WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineminus">- for the specific language governing rights and limitations under the</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineminus">- License.</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineminus">-</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineminus">- The Original Code is mozilla.org code.</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineminus">-</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineminus">- The Initial Developer of the Original Code is</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineminus">- Netscape Communications Corporation.</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineminus">- Portions created by the Initial Developer are Copyright (C) 1998</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineminus">- the Initial Developer. All Rights Reserved.</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineminus">-</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineminus">- Contributor(s):</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-   Ben Goodger &lt;ben@netscape.com&gt; (Original Author)</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineminus">-   Gervase Markham &lt;gerv@gerv.net&gt;</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineminus">-</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineminus">- Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineminus">- either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineminus">- or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineminus">- in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineminus">- of those above. If you wish to allow use of your version of this file only</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineminus">- under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineminus">- use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineminus">- decision by deleting the provisions above and replace them with the notice</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineminus">- and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineminus">- the provisions above, a recipient may use your version of this file under</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineminus">- the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineminus">-</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineminus">- ***** END LICENSE BLOCK ***** --&gt;</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineminus">-</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineminus">-&lt;?xml-stylesheet href=&quot;chrome://communicator/skin/&quot;?&gt;</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineminus">-&lt;?xml-stylesheet href=&quot;chrome://communicator/skin/bookmarks/bookmarks.css&quot;?&gt;</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineminus">-&lt;?xml-stylesheet href=&quot;chrome://communicator/content/bookmarks/bookmarks.css&quot; type=&quot;text/css&quot;?&gt;</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineminus">-</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineminus">-&lt;!DOCTYPE dialog [</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineminus">-&lt;!ENTITY % brandDTD SYSTEM &quot;chrome://branding/locale/brand.dtd&quot; &gt;</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineminus">-%brandDTD;</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineminus">-&lt;!ENTITY % addBookmarkDTD SYSTEM &quot;chrome://communicator/locale/bookmarks/addBookmark.dtd&quot;&gt;</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineminus">-%addBookmarkDTD;</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineminus">-]&gt;</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineminus">-</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineminus">-&lt;dialog id=&quot;newBookmarkDialog&quot;</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineminus">-        xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineminus">-        ondialogaccept=&quot;return onOK(event)&quot;</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineminus">-        title=&quot;&amp;newBookmark.title;&quot; selectFolderTitle=&quot;&amp;selectFolder.title;&quot;</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineminus">-        onload=&quot;Startup();&quot;</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineminus">-        onunload=&quot;persistTreeSize();&quot;</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineminus">-        persist=&quot;screenX screenY&quot;</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineminus">-        screenX=&quot;24&quot; screenY=&quot;24&quot;&gt;</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineminus">-   </span>
<a href="#l6.68"></a><span id="l6.68" class="difflineminus">-  </span>
<a href="#l6.69"></a><span id="l6.69" class="difflineminus">-  &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://communicator/content/bookmarks/bookmarks.js&quot;/&gt;</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineminus">-  &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://communicator/content/bookmarks/addBookmark.js&quot;/&gt;</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineminus">-</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineminus">-  &lt;stringbundle id=&quot;bookmarksbundle&quot;</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineminus">-                src=&quot;chrome://communicator/locale/bookmarks/bookmarks.properties&quot;/&gt;</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineminus">-</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineminus">-  &lt;broadcaster id=&quot;showaddgroup&quot;/&gt;</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineminus">-</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineminus">-  &lt;separator id=&quot;nameseparator&quot; class=&quot;thin&quot;/&gt;</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineminus">-  </span>
<a href="#l6.79"></a><span id="l6.79" class="difflineminus">-  &lt;grid id=&quot;bookmarknamegrid&quot;&gt;</span>
<a href="#l6.80"></a><span id="l6.80" class="difflineminus">-    &lt;columns&gt;</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineminus">-      &lt;column/&gt;</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineminus">-      &lt;column flex=&quot;1&quot;/&gt;</span>
<a href="#l6.83"></a><span id="l6.83" class="difflineminus">-    &lt;/columns&gt;</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineminus">-    &lt;rows&gt;</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineminus">-      &lt;row align=&quot;center&quot;&gt;</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineminus">-        &lt;hbox pack=&quot;end&quot;&gt;</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineminus">-          &lt;label value=&quot;&amp;name.label;&quot; accesskey=&quot;&amp;name.accesskey;&quot; control=&quot;name&quot;/&gt;</span>
<a href="#l6.88"></a><span id="l6.88" class="difflineminus">-        &lt;/hbox&gt;</span>
<a href="#l6.89"></a><span id="l6.89" class="difflineminus">-        &lt;textbox id=&quot;name&quot; oninput=&quot;onFieldInput();&quot;/&gt;</span>
<a href="#l6.90"></a><span id="l6.90" class="difflineminus">-      &lt;/row&gt;</span>
<a href="#l6.91"></a><span id="l6.91" class="difflineminus">-      &lt;row align=&quot;center&quot;&gt;</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineminus">-        &lt;hbox pack=&quot;end&quot;&gt;</span>
<a href="#l6.93"></a><span id="l6.93" class="difflineminus">-          &lt;label value=&quot;&amp;url.label;&quot; accesskey=&quot;&amp;url.accesskey;&quot; control=&quot;url&quot;/&gt;</span>
<a href="#l6.94"></a><span id="l6.94" class="difflineminus">-        &lt;/hbox&gt;</span>
<a href="#l6.95"></a><span id="l6.95" class="difflineminus">-        &lt;textbox id=&quot;url&quot; oninput=&quot;onFieldInput();&quot;/&gt;</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineminus">-      &lt;/row&gt;</span>
<a href="#l6.97"></a><span id="l6.97" class="difflineminus">-      &lt;row align=&quot;center&quot;&gt;</span>
<a href="#l6.98"></a><span id="l6.98" class="difflineminus">-        &lt;hbox pack=&quot;end&quot;&gt;</span>
<a href="#l6.99"></a><span id="l6.99" class="difflineminus">-          &lt;label value=&quot;&amp;shortcutURL.label;&quot; accesskey=&quot;&amp;shortcutURL.accesskey;&quot; control=&quot;shortcutUrl&quot;/&gt;</span>
<a href="#l6.100"></a><span id="l6.100" class="difflineminus">-        &lt;/hbox&gt;</span>
<a href="#l6.101"></a><span id="l6.101" class="difflineminus">-        &lt;textbox id=&quot;shortcutUrl&quot;/&gt;</span>
<a href="#l6.102"></a><span id="l6.102" class="difflineminus">-      &lt;/row&gt;</span>
<a href="#l6.103"></a><span id="l6.103" class="difflineminus">-    &lt;/rows&gt;</span>
<a href="#l6.104"></a><span id="l6.104" class="difflineminus">-  &lt;/grid&gt;</span>
<a href="#l6.105"></a><span id="l6.105" class="difflineminus">-</span>
<a href="#l6.106"></a><span id="l6.106" class="difflineminus">-  &lt;separator class=&quot;thin&quot; observes=&quot;showaddgroup&quot;/&gt;</span>
<a href="#l6.107"></a><span id="l6.107" class="difflineminus">-  &lt;hbox observes=&quot;showaddgroup&quot;&gt;</span>
<a href="#l6.108"></a><span id="l6.108" class="difflineminus">-    &lt;checkbox id=&quot;addgroup&quot; label=&quot;&amp;addGroup.label;&quot;</span>
<a href="#l6.109"></a><span id="l6.109" class="difflineminus">-              accesskey=&quot;&amp;addGroup.accesskey;&quot;</span>
<a href="#l6.110"></a><span id="l6.110" class="difflineminus">-              oncommand=&quot;toggleGroup();&quot;/&gt;</span>
<a href="#l6.111"></a><span id="l6.111" class="difflineminus">-  &lt;/hbox&gt;</span>
<a href="#l6.112"></a><span id="l6.112" class="difflineminus">-</span>
<a href="#l6.113"></a><span id="l6.113" class="difflineminus">-  &lt;separator id=&quot;destinationSeparator&quot;/&gt;</span>
<a href="#l6.114"></a><span id="l6.114" class="difflineminus">-</span>
<a href="#l6.115"></a><span id="l6.115" class="difflineminus">-  &lt;vbox id=&quot;folderbox&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l6.116"></a><span id="l6.116" class="difflineminus">-    &lt;label id=&quot;destinationLabel&quot; value=&quot;&amp;destination.label;&quot; control=&quot;bookmarks-view&quot;/&gt;</span>
<a href="#l6.117"></a><span id="l6.117" class="difflineminus">-    &lt;bookmarks-tree id=&quot;bookmarks-view&quot; flex=&quot;1&quot; type=&quot;folders&quot;</span>
<a href="#l6.118"></a><span id="l6.118" class="difflineminus">-                    rows=&quot;10&quot; seltype=&quot;single&quot;</span>
<a href="#l6.119"></a><span id="l6.119" class="difflineminus">-                    persist=&quot;width height&quot;/&gt;</span>
<a href="#l6.120"></a><span id="l6.120" class="difflineminus">-</span>
<a href="#l6.121"></a><span id="l6.121" class="difflineminus">-    &lt;separator id=&quot;folderbuttonseparator&quot; class=&quot;thin&quot;/&gt;</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineminus">-</span>
<a href="#l6.123"></a><span id="l6.123" class="difflineminus">-    &lt;hbox pack=&quot;end&quot;&gt;</span>
<a href="#l6.124"></a><span id="l6.124" class="difflineminus">-      &lt;button label=&quot;&amp;newFolder.label;&quot;</span>
<a href="#l6.125"></a><span id="l6.125" class="difflineminus">-              accesskey=&quot;&amp;newFolder.accesskey;&quot;</span>
<a href="#l6.126"></a><span id="l6.126" class="difflineminus">-              oncommand=&quot;createNewFolder();&quot;/&gt;</span>
<a href="#l6.127"></a><span id="l6.127" class="difflineminus">-    &lt;/hbox&gt;</span>
<a href="#l6.128"></a><span id="l6.128" class="difflineminus">-  &lt;/vbox&gt;</span>
<a href="#l6.129"></a><span id="l6.129" class="difflineminus">-</span>
<a href="#l6.130"></a><span id="l6.130" class="difflineminus">-  &lt;!-- Ensure a decent dialog width when the bookmarks-tree is hidden. --&gt;</span>
<a href="#l6.131"></a><span id="l6.131" class="difflineminus">-  &lt;spacer style=&quot;width: 36em;&quot;/&gt;</span>
<a href="#l6.132"></a><span id="l6.132" class="difflineminus">-</span>
<a href="#l6.133"></a><span id="l6.133" class="difflineminus">-&lt;/dialog&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1">deleted file mode 100644</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineminus">--- a/suite/common/bookmarks/bookmarks.css</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineplus">+++ /dev/null</span>
<a href="#l7.4"></a><span id="l7.4" class="difflineat">@@ -1,14 +0,0 @@</span>
<a href="#l7.5"></a><span id="l7.5" class="difflineminus">-bookmarks-tree, bookmarks-tree[type=&quot;multi-column&quot;]</span>
<a href="#l7.6"></a><span id="l7.6" class="difflineminus">-  {</span>
<a href="#l7.7"></a><span id="l7.7" class="difflineminus">-    -moz-binding          : url(&quot;chrome://communicator/content/bookmarks/bookmarksTree.xml#bookmarks-tree-full&quot;);</span>
<a href="#l7.8"></a><span id="l7.8" class="difflineminus">-  }</span>
<a href="#l7.9"></a><span id="l7.9" class="difflineminus">-  </span>
<a href="#l7.10"></a><span id="l7.10" class="difflineminus">-bookmarks-tree[type=&quot;single-column&quot;]</span>
<a href="#l7.11"></a><span id="l7.11" class="difflineminus">-  {</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-    -moz-binding          : url(&quot;chrome://communicator/content/bookmarks/bookmarksTree.xml#bookmarks-tree-name&quot;);</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-  }</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">-</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineminus">-bookmarks-tree[type=&quot;folders&quot;]</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineminus">-  {</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineminus">-    -moz-binding          : url(&quot;chrome://communicator/content/bookmarks/bookmarksTree.xml#bookmarks-tree-folders&quot;);</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineminus">-  }</span>
<a href="#l7.19"></a><span id="l7.19">\ No newline at end of file</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1">deleted file mode 100644</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineminus">--- a/suite/common/bookmarks/bookmarks.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineplus">+++ /dev/null</span>
<a href="#l8.4"></a><span id="l8.4" class="difflineat">@@ -1,1655 +0,0 @@</span>
<a href="#l8.5"></a><span id="l8.5" class="difflineminus">-/* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l8.6"></a><span id="l8.6" class="difflineminus">-/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l8.7"></a><span id="l8.7" class="difflineminus">- * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l8.8"></a><span id="l8.8" class="difflineminus">- *</span>
<a href="#l8.9"></a><span id="l8.9" class="difflineminus">- * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l8.10"></a><span id="l8.10" class="difflineminus">- * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l8.11"></a><span id="l8.11" class="difflineminus">- * the License. You may obtain a copy of the License at</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">- * http://www.mozilla.org/MPL/</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">- *</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineminus">- * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineminus">- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineminus">- * for the specific language governing rights and limitations under the</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineminus">- * License.</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineminus">- *</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineminus">- * The Original Code is mozilla.org code.</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineminus">- *</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineminus">- * The Initial Developer of the Original Code is</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineminus">- * Pierre Chanial &lt;chanial@noos.fr&gt;.</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineminus">- * Portions created by the Initial Developer are Copyright (C) 1998</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineminus">- * the Initial Developer. All Rights Reserved.</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineminus">- *</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineminus">- * Contributor(s):</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineminus">- *</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineminus">- * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineminus">- * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineminus">- * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">- * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineminus">- * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineminus">- * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineminus">- * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineminus">- * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineminus">- * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineminus">- * the provisions above, a recipient may use your version of this file under</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineminus">- * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineminus">- *</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineminus">- * ***** END LICENSE BLOCK ***** */</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineminus">-</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineminus">-var NC_NS, WEB_NS, RDF_NS, XUL_NS, NC_NS_CMD;</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineminus">-</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineminus">-// definition of the services frequently used for bookmarks</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineminus">-var kRDFContractID;</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineminus">-var kRDFSVCIID;</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineminus">-var kRDFRSCIID;</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineminus">-var kRDFLITIID;</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineminus">-var RDF;</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineminus">-</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineminus">-var kRDFCContractID;</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineminus">-var kRDFCIID;</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineminus">-var RDFC;</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineminus">-</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineminus">-var kRDFCUContractID;</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineminus">-var kRDFCUIID;</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineminus">-var RDFCU;</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineminus">-</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineminus">-var BMDS;</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineminus">-var kBMSVCIID;</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineminus">-var BMSVC;</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineminus">-</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineminus">-var kPREFContractID;</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineminus">-var kPREFIID;</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineminus">-var PREF;</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineminus">-</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineminus">-var kSOUNDContractID;</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineminus">-var kSOUNDIID;</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineminus">-var SOUND;</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineminus">-</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineminus">-var kWINDOWContractID;</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineminus">-var kWINDOWIID;</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineminus">-var WINDOWSVC;</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineminus">-</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineminus">-var kDSContractID;</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineminus">-var kDSIID;</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineminus">-var DS;</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineminus">-</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineminus">-// should be moved in a separate file</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineminus">-function initServices()</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineminus">-{</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineminus">-  NC_NS     = &quot;http://home.netscape.com/NC-rdf#&quot;;</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineminus">-  WEB_NS    = &quot;http://home.netscape.com/WEB-rdf#&quot;;</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineminus">-  RDF_NS    = &quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#&quot;;</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineminus">-  XUL_NS    = &quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;;</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineminus">-  NC_NS_CMD = NC_NS + &quot;command?cmd=&quot;;</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineminus">-</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineminus">-  kRDFContractID   = &quot;@mozilla.org/rdf/rdf-service;1&quot;;</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineminus">-  kRDFSVCIID       = Components.interfaces.nsIRDFService;</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineminus">-  kRDFRSCIID       = Components.interfaces.nsIRDFResource;</span>
<a href="#l8.91"></a><span id="l8.91" class="difflineminus">-  kRDFLITIID       = Components.interfaces.nsIRDFLiteral;</span>
<a href="#l8.92"></a><span id="l8.92" class="difflineminus">-  RDF              = Components.classes[kRDFContractID].getService(kRDFSVCIID);</span>
<a href="#l8.93"></a><span id="l8.93" class="difflineminus">-</span>
<a href="#l8.94"></a><span id="l8.94" class="difflineminus">-  kRDFCContractID  = &quot;@mozilla.org/rdf/container;1&quot;;</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineminus">-  kRDFCIID         = Components.interfaces.nsIRDFContainer;</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineminus">-  RDFC             = Components.classes[kRDFCContractID].createInstance(kRDFCIID);</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineminus">-</span>
<a href="#l8.98"></a><span id="l8.98" class="difflineminus">-  kRDFCUContractID = &quot;@mozilla.org/rdf/container-utils;1&quot;;</span>
<a href="#l8.99"></a><span id="l8.99" class="difflineminus">-  kRDFCUIID        = Components.interfaces.nsIRDFContainerUtils;</span>
<a href="#l8.100"></a><span id="l8.100" class="difflineminus">-  RDFCU            = Components.classes[kRDFCUContractID].getService(kRDFCUIID);</span>
<a href="#l8.101"></a><span id="l8.101" class="difflineminus">-</span>
<a href="#l8.102"></a><span id="l8.102" class="difflineminus">-  kPREFContractID  = &quot;@mozilla.org/preferences-service;1&quot;;</span>
<a href="#l8.103"></a><span id="l8.103" class="difflineminus">-  kPREFIID         = Components.interfaces.nsIPrefService;</span>
<a href="#l8.104"></a><span id="l8.104" class="difflineminus">-  try {</span>
<a href="#l8.105"></a><span id="l8.105" class="difflineminus">-    PREF             = Components.classes[kPREFContractID].getService(kPREFIID)</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineminus">-                                 .getBranch(null);</span>
<a href="#l8.107"></a><span id="l8.107" class="difflineminus">-  } catch (e) {}</span>
<a href="#l8.108"></a><span id="l8.108" class="difflineminus">-</span>
<a href="#l8.109"></a><span id="l8.109" class="difflineminus">-  kSOUNDContractID = &quot;@mozilla.org/sound;1&quot;;</span>
<a href="#l8.110"></a><span id="l8.110" class="difflineminus">-  kSOUNDIID        = Components.interfaces.nsISound;</span>
<a href="#l8.111"></a><span id="l8.111" class="difflineminus">-  try {</span>
<a href="#l8.112"></a><span id="l8.112" class="difflineminus">-    SOUND            = Components.classes[kSOUNDContractID].createInstance(kSOUNDIID);</span>
<a href="#l8.113"></a><span id="l8.113" class="difflineminus">-  } catch (e) {}</span>
<a href="#l8.114"></a><span id="l8.114" class="difflineminus">-</span>
<a href="#l8.115"></a><span id="l8.115" class="difflineminus">-  kWINDOWContractID = &quot;@mozilla.org/appshell/window-mediator;1&quot;;</span>
<a href="#l8.116"></a><span id="l8.116" class="difflineminus">-  kWINDOWIID        = Components.interfaces.nsIWindowMediator;</span>
<a href="#l8.117"></a><span id="l8.117" class="difflineminus">-  try {</span>
<a href="#l8.118"></a><span id="l8.118" class="difflineminus">-    WINDOWSVC         = Components.classes[kWINDOWContractID].getService(kWINDOWIID);</span>
<a href="#l8.119"></a><span id="l8.119" class="difflineminus">-  } catch (e) {}</span>
<a href="#l8.120"></a><span id="l8.120" class="difflineminus">-</span>
<a href="#l8.121"></a><span id="l8.121" class="difflineminus">-  kDSContractID     = &quot;@mozilla.org/widget/dragservice;1&quot;;</span>
<a href="#l8.122"></a><span id="l8.122" class="difflineminus">-  kDSIID            = Components.interfaces.nsIDragService;</span>
<a href="#l8.123"></a><span id="l8.123" class="difflineminus">-  try {</span>
<a href="#l8.124"></a><span id="l8.124" class="difflineminus">-    DS                = Components.classes[kDSContractID].getService(kDSIID);</span>
<a href="#l8.125"></a><span id="l8.125" class="difflineminus">-  } catch (e) {}</span>
<a href="#l8.126"></a><span id="l8.126" class="difflineminus">-}</span>
<a href="#l8.127"></a><span id="l8.127" class="difflineminus">-</span>
<a href="#l8.128"></a><span id="l8.128" class="difflineminus">-function initBMService()</span>
<a href="#l8.129"></a><span id="l8.129" class="difflineminus">-{</span>
<a href="#l8.130"></a><span id="l8.130" class="difflineminus">-  kBMSVCIID = Components.interfaces.nsIBookmarksService;</span>
<a href="#l8.131"></a><span id="l8.131" class="difflineminus">-  BMDS  = RDF.GetDataSource(&quot;rdf:bookmarks&quot;);</span>
<a href="#l8.132"></a><span id="l8.132" class="difflineminus">-  BMSVC = BMDS.QueryInterface(kBMSVCIID);</span>
<a href="#l8.133"></a><span id="l8.133" class="difflineminus">-}</span>
<a href="#l8.134"></a><span id="l8.134" class="difflineminus">-</span>
<a href="#l8.135"></a><span id="l8.135" class="difflineminus">-/**</span>
<a href="#l8.136"></a><span id="l8.136" class="difflineminus">- * XXX - 04/16/01</span>
<a href="#l8.137"></a><span id="l8.137" class="difflineminus">- *  ACK! massive command name collision problems are causing big issues</span>
<a href="#l8.138"></a><span id="l8.138" class="difflineminus">- *  in getting this stuff to work in the Navigator window. For sanity's </span>
<a href="#l8.139"></a><span id="l8.139" class="difflineminus">- *  sake, we need to rename all the commands to be of the form cmd_bm_*</span>
<a href="#l8.140"></a><span id="l8.140" class="difflineminus">- *  otherwise there'll continue to be problems. For now, we're just </span>
<a href="#l8.141"></a><span id="l8.141" class="difflineminus">- *  renaming those that affect the personal toolbar (edit operations,</span>
<a href="#l8.142"></a><span id="l8.142" class="difflineminus">- *  which were clashing with the textfield controller)</span>
<a href="#l8.143"></a><span id="l8.143" class="difflineminus">- *</span>
<a href="#l8.144"></a><span id="l8.144" class="difflineminus">- * There are also several places that need to be updated if you need</span>
<a href="#l8.145"></a><span id="l8.145" class="difflineminus">- * to change a command name. </span>
<a href="#l8.146"></a><span id="l8.146" class="difflineminus">- *   1) the controller...</span>
<a href="#l8.147"></a><span id="l8.147" class="difflineminus">- *      - in bookmarksTree.xml if the command is tree-specifc</span>
<a href="#l8.148"></a><span id="l8.148" class="difflineminus">- *      - in bookmarksMenu.js if the command is DOM-specific</span>
<a href="#l8.149"></a><span id="l8.149" class="difflineminus">- *      - in bookmarks.js otherwise</span>
<a href="#l8.150"></a><span id="l8.150" class="difflineminus">- *   2) the command nodes in the overlay or xul file</span>
<a href="#l8.151"></a><span id="l8.151" class="difflineminus">- *   3) the command human-readable name key in bookmarks.properties</span>
<a href="#l8.152"></a><span id="l8.152" class="difflineminus">- *   4) the function 'getCommands' in bookmarks.js</span>
<a href="#l8.153"></a><span id="l8.153" class="difflineminus">- */</span>
<a href="#l8.154"></a><span id="l8.154" class="difflineminus">-</span>
<a href="#l8.155"></a><span id="l8.155" class="difflineminus">-var BookmarksCommand = {</span>
<a href="#l8.156"></a><span id="l8.156" class="difflineminus">-</span>
<a href="#l8.157"></a><span id="l8.157" class="difflineminus">-  /////////////////////////////////////////////////////////////////////////////</span>
<a href="#l8.158"></a><span id="l8.158" class="difflineminus">-  // This method constructs a menuitem for a context menu for the given command.</span>
<a href="#l8.159"></a><span id="l8.159" class="difflineminus">-  // This is implemented by the client so that it can intercept menuitem naming</span>
<a href="#l8.160"></a><span id="l8.160" class="difflineminus">-  // as appropriate.</span>
<a href="#l8.161"></a><span id="l8.161" class="difflineminus">-  createMenuItem: function (aCommandName, aSelection)</span>
<a href="#l8.162"></a><span id="l8.162" class="difflineminus">-  {</span>
<a href="#l8.163"></a><span id="l8.163" class="difflineminus">-    var xulElement = document.createElementNS(XUL_NS, &quot;menuitem&quot;);</span>
<a href="#l8.164"></a><span id="l8.164" class="difflineminus">-    xulElement.setAttribute(&quot;cmd&quot;, aCommandName);</span>
<a href="#l8.165"></a><span id="l8.165" class="difflineminus">-    var cmd = &quot;cmd_&quot; + aCommandName.substring(NC_NS_CMD.length);</span>
<a href="#l8.166"></a><span id="l8.166" class="difflineminus">-    xulElement.setAttribute(&quot;command&quot;, cmd);</span>
<a href="#l8.167"></a><span id="l8.167" class="difflineminus">-    </span>
<a href="#l8.168"></a><span id="l8.168" class="difflineminus">-    switch (aCommandName) {</span>
<a href="#l8.169"></a><span id="l8.169" class="difflineminus">-    case NC_NS_CMD + &quot;bm_expandfolder&quot;:</span>
<a href="#l8.170"></a><span id="l8.170" class="difflineminus">-      var shouldCollapse = true;</span>
<a href="#l8.171"></a><span id="l8.171" class="difflineminus">-      for (var i=0; i&lt;aSelection.length; ++i)</span>
<a href="#l8.172"></a><span id="l8.172" class="difflineminus">-        if (!aSelection.isExpanded[i])</span>
<a href="#l8.173"></a><span id="l8.173" class="difflineminus">-          shouldCollapse = false;</span>
<a href="#l8.174"></a><span id="l8.174" class="difflineminus">-      if (shouldCollapse)</span>
<a href="#l8.175"></a><span id="l8.175" class="difflineminus">-        cmd = &quot;cmd_bm_collapsefolder&quot;;</span>
<a href="#l8.176"></a><span id="l8.176" class="difflineminus">-    break;</span>
<a href="#l8.177"></a><span id="l8.177" class="difflineminus">-    }</span>
<a href="#l8.178"></a><span id="l8.178" class="difflineminus">-    xulElement.setAttribute(&quot;label&quot;, BookmarksUtils.getLocaleString(cmd + &quot;.label&quot;));</span>
<a href="#l8.179"></a><span id="l8.179" class="difflineminus">-    xulElement.setAttribute(&quot;accesskey&quot;, BookmarksUtils.getLocaleString(cmd + &quot;.accesskey&quot;));</span>
<a href="#l8.180"></a><span id="l8.180" class="difflineminus">-</span>
<a href="#l8.181"></a><span id="l8.181" class="difflineminus">-    return xulElement;</span>
<a href="#l8.182"></a><span id="l8.182" class="difflineminus">-  },</span>
<a href="#l8.183"></a><span id="l8.183" class="difflineminus">-</span>
<a href="#l8.184"></a><span id="l8.184" class="difflineminus">-  /////////////////////////////////////////////////////////////////////////////</span>
<a href="#l8.185"></a><span id="l8.185" class="difflineminus">-  // Fill a context menu popup with menuitems that are appropriate for the current</span>
<a href="#l8.186"></a><span id="l8.186" class="difflineminus">-  // selection.</span>
<a href="#l8.187"></a><span id="l8.187" class="difflineminus">-  createContextMenu: function (aEvent, aSelection)</span>
<a href="#l8.188"></a><span id="l8.188" class="difflineminus">-  {</span>
<a href="#l8.189"></a><span id="l8.189" class="difflineminus">-    var popup = aEvent.target;</span>
<a href="#l8.190"></a><span id="l8.190" class="difflineminus">-    // clear out the old context menu contents (if any)</span>
<a href="#l8.191"></a><span id="l8.191" class="difflineminus">-    while (popup.hasChildNodes()) </span>
<a href="#l8.192"></a><span id="l8.192" class="difflineminus">-      popup.removeChild(popup.firstChild);</span>
<a href="#l8.193"></a><span id="l8.193" class="difflineminus">-        </span>
<a href="#l8.194"></a><span id="l8.194" class="difflineminus">-    var commonCommands = this.flattenEnumerator(this.getValidCommands(popup.id));</span>
<a href="#l8.195"></a><span id="l8.195" class="difflineminus">-    for (var i = 0; i &lt; aSelection.length; ++i) {</span>
<a href="#l8.196"></a><span id="l8.196" class="difflineminus">-      var commands = this.getCommands(aSelection.item[i]);</span>
<a href="#l8.197"></a><span id="l8.197" class="difflineminus">-      if (!commands) {</span>
<a href="#l8.198"></a><span id="l8.198" class="difflineminus">-        aEvent.preventDefault();</span>
<a href="#l8.199"></a><span id="l8.199" class="difflineminus">-        return;</span>
<a href="#l8.200"></a><span id="l8.200" class="difflineminus">-      }</span>
<a href="#l8.201"></a><span id="l8.201" class="difflineminus">-      commands = this.flattenEnumerator(commands);</span>
<a href="#l8.202"></a><span id="l8.202" class="difflineminus">-      commonCommands = this.findCommonNodes(commands, commonCommands);</span>
<a href="#l8.203"></a><span id="l8.203" class="difflineminus">-    }</span>
<a href="#l8.204"></a><span id="l8.204" class="difflineminus">-</span>
<a href="#l8.205"></a><span id="l8.205" class="difflineminus">-    if (!commonCommands.length) {</span>
<a href="#l8.206"></a><span id="l8.206" class="difflineminus">-      aEvent.preventDefault();</span>
<a href="#l8.207"></a><span id="l8.207" class="difflineminus">-      return;</span>
<a href="#l8.208"></a><span id="l8.208" class="difflineminus">-    }</span>
<a href="#l8.209"></a><span id="l8.209" class="difflineminus">-    </span>
<a href="#l8.210"></a><span id="l8.210" class="difflineminus">-    // Now that we should have generated a list of commands that is valid</span>
<a href="#l8.211"></a><span id="l8.211" class="difflineminus">-    // for the entire selection, build a context menu.</span>
<a href="#l8.212"></a><span id="l8.212" class="difflineminus">-    for (i = 0; i &lt; commonCommands.length; ++i) {</span>
<a href="#l8.213"></a><span id="l8.213" class="difflineminus">-      var currCommand = commonCommands[i].QueryInterface(kRDFRSCIID).Value;</span>
<a href="#l8.214"></a><span id="l8.214" class="difflineminus">-      var element = null;</span>
<a href="#l8.215"></a><span id="l8.215" class="difflineminus">-      if (currCommand != NC_NS_CMD + &quot;bm_separator&quot;) {</span>
<a href="#l8.216"></a><span id="l8.216" class="difflineminus">-        element = this.createMenuItem(currCommand, aSelection);</span>
<a href="#l8.217"></a><span id="l8.217" class="difflineminus">-      }</span>
<a href="#l8.218"></a><span id="l8.218" class="difflineminus">-      else if (i != 0 &amp;&amp; i &lt; commonCommands.length-1) {</span>
<a href="#l8.219"></a><span id="l8.219" class="difflineminus">-        // Never append a separator as the first or last element in a context</span>
<a href="#l8.220"></a><span id="l8.220" class="difflineminus">-        // menu.</span>
<a href="#l8.221"></a><span id="l8.221" class="difflineminus">-        element = document.createElementNS(XUL_NS, &quot;menuseparator&quot;);</span>
<a href="#l8.222"></a><span id="l8.222" class="difflineminus">-      }</span>
<a href="#l8.223"></a><span id="l8.223" class="difflineminus">-      if (element) </span>
<a href="#l8.224"></a><span id="l8.224" class="difflineminus">-        popup.appendChild(element);</span>
<a href="#l8.225"></a><span id="l8.225" class="difflineminus">-    }</span>
<a href="#l8.226"></a><span id="l8.226" class="difflineminus">-    switch (popup.firstChild.getAttribute(&quot;command&quot;)) {</span>
<a href="#l8.227"></a><span id="l8.227" class="difflineminus">-    case &quot;cmd_bm_open&quot;:</span>
<a href="#l8.228"></a><span id="l8.228" class="difflineminus">-    case &quot;cmd_bm_expandfolder&quot;:</span>
<a href="#l8.229"></a><span id="l8.229" class="difflineminus">-      popup.firstChild.setAttribute(&quot;default&quot;, &quot;true&quot;);</span>
<a href="#l8.230"></a><span id="l8.230" class="difflineminus">-    }</span>
<a href="#l8.231"></a><span id="l8.231" class="difflineminus">-  },</span>
<a href="#l8.232"></a><span id="l8.232" class="difflineminus">-  </span>
<a href="#l8.233"></a><span id="l8.233" class="difflineminus">-  /////////////////////////////////////////////////////////////////////////////</span>
<a href="#l8.234"></a><span id="l8.234" class="difflineminus">-  // Given two unique arrays, return an array that contains only the elements</span>
<a href="#l8.235"></a><span id="l8.235" class="difflineminus">-  // common to both. </span>
<a href="#l8.236"></a><span id="l8.236" class="difflineminus">-  findCommonNodes: function (aNewArray, aOldArray)</span>
<a href="#l8.237"></a><span id="l8.237" class="difflineminus">-  {</span>
<a href="#l8.238"></a><span id="l8.238" class="difflineminus">-    var common = [];</span>
<a href="#l8.239"></a><span id="l8.239" class="difflineminus">-    for (var i = 0; i &lt; aNewArray.length; ++i) {</span>
<a href="#l8.240"></a><span id="l8.240" class="difflineminus">-      for (var j = 0; j &lt; aOldArray.length; ++j) {</span>
<a href="#l8.241"></a><span id="l8.241" class="difflineminus">-        if (common.length &gt; 0 &amp;&amp; common[common.length-1] == aNewArray[i])</span>
<a href="#l8.242"></a><span id="l8.242" class="difflineminus">-          continue;</span>
<a href="#l8.243"></a><span id="l8.243" class="difflineminus">-        if (aNewArray[i] == aOldArray[j])</span>
<a href="#l8.244"></a><span id="l8.244" class="difflineminus">-          common.push(aNewArray[i]);</span>
<a href="#l8.245"></a><span id="l8.245" class="difflineminus">-      }</span>
<a href="#l8.246"></a><span id="l8.246" class="difflineminus">-    }</span>
<a href="#l8.247"></a><span id="l8.247" class="difflineminus">-    return common;</span>
<a href="#l8.248"></a><span id="l8.248" class="difflineminus">-  },</span>
<a href="#l8.249"></a><span id="l8.249" class="difflineminus">-</span>
<a href="#l8.250"></a><span id="l8.250" class="difflineminus">-  flattenEnumerator: function (aEnumerator)</span>
<a href="#l8.251"></a><span id="l8.251" class="difflineminus">-  {</span>
<a href="#l8.252"></a><span id="l8.252" class="difflineminus">-    if (&quot;_index&quot; in aEnumerator)</span>
<a href="#l8.253"></a><span id="l8.253" class="difflineminus">-      return aEnumerator._inner;</span>
<a href="#l8.254"></a><span id="l8.254" class="difflineminus">-    </span>
<a href="#l8.255"></a><span id="l8.255" class="difflineminus">-    var temp = [];</span>
<a href="#l8.256"></a><span id="l8.256" class="difflineminus">-    while (aEnumerator.hasMoreElements()) </span>
<a href="#l8.257"></a><span id="l8.257" class="difflineminus">-      temp.push(aEnumerator.getNext());</span>
<a href="#l8.258"></a><span id="l8.258" class="difflineminus">-    return temp;</span>
<a href="#l8.259"></a><span id="l8.259" class="difflineminus">-  },</span>
<a href="#l8.260"></a><span id="l8.260" class="difflineminus">-  </span>
<a href="#l8.261"></a><span id="l8.261" class="difflineminus">-  /////////////////////////////////////////////////////////////////////////////</span>
<a href="#l8.262"></a><span id="l8.262" class="difflineminus">-  // For a given URI (a unique identifier of a resource in the graph) return </span>
<a href="#l8.263"></a><span id="l8.263" class="difflineminus">-  // an enumeration of applicable commands for that URI. </span>
<a href="#l8.264"></a><span id="l8.264" class="difflineminus">-  getCommands: function (aNodeID)</span>
<a href="#l8.265"></a><span id="l8.265" class="difflineminus">-  {</span>
<a href="#l8.266"></a><span id="l8.266" class="difflineminus">-    var type = BookmarksUtils.resolveType(aNodeID);</span>
<a href="#l8.267"></a><span id="l8.267" class="difflineminus">-    if (!type)</span>
<a href="#l8.268"></a><span id="l8.268" class="difflineminus">-      return null;</span>
<a href="#l8.269"></a><span id="l8.269" class="difflineminus">-    var commands = [];</span>
<a href="#l8.270"></a><span id="l8.270" class="difflineminus">-    // menu order:</span>
<a href="#l8.271"></a><span id="l8.271" class="difflineminus">-    // </span>
<a href="#l8.272"></a><span id="l8.272" class="difflineminus">-    // bm_expandfolder</span>
<a href="#l8.273"></a><span id="l8.273" class="difflineminus">-    // bm_open</span>
<a href="#l8.274"></a><span id="l8.274" class="difflineminus">-    // bm_openinnewwindow</span>
<a href="#l8.275"></a><span id="l8.275" class="difflineminus">-    // bm_openinnewtab</span>
<a href="#l8.276"></a><span id="l8.276" class="difflineminus">-    // ---------------------</span>
<a href="#l8.277"></a><span id="l8.277" class="difflineminus">-    // bm_newfolder</span>
<a href="#l8.278"></a><span id="l8.278" class="difflineminus">-    // ---------------------</span>
<a href="#l8.279"></a><span id="l8.279" class="difflineminus">-    // bm_cut</span>
<a href="#l8.280"></a><span id="l8.280" class="difflineminus">-    // bm_copy</span>
<a href="#l8.281"></a><span id="l8.281" class="difflineminus">-    // bm_paste</span>
<a href="#l8.282"></a><span id="l8.282" class="difflineminus">-    // ---------------------</span>
<a href="#l8.283"></a><span id="l8.283" class="difflineminus">-    // bm_delete</span>
<a href="#l8.284"></a><span id="l8.284" class="difflineminus">-    // ---------------------</span>
<a href="#l8.285"></a><span id="l8.285" class="difflineminus">-    // bm_properties</span>
<a href="#l8.286"></a><span id="l8.286" class="difflineminus">-    switch (type) {</span>
<a href="#l8.287"></a><span id="l8.287" class="difflineminus">-    case &quot;BookmarkSeparator&quot;:</span>
<a href="#l8.288"></a><span id="l8.288" class="difflineminus">-      commands = [&quot;bm_newfolder&quot;, &quot;bm_separator&quot;, </span>
<a href="#l8.289"></a><span id="l8.289" class="difflineminus">-                  &quot;bm_cut&quot;, &quot;bm_copy&quot;, &quot;bm_paste&quot;, &quot;bm_separator&quot;,</span>
<a href="#l8.290"></a><span id="l8.290" class="difflineminus">-                  &quot;bm_delete&quot;, &quot;bm_separator&quot;,</span>
<a href="#l8.291"></a><span id="l8.291" class="difflineminus">-                  &quot;bm_properties&quot;];</span>
<a href="#l8.292"></a><span id="l8.292" class="difflineminus">-      break;</span>
<a href="#l8.293"></a><span id="l8.293" class="difflineminus">-    case &quot;Bookmark&quot;:</span>
<a href="#l8.294"></a><span id="l8.294" class="difflineminus">-      commands = [&quot;bm_open&quot;, &quot;bm_openinnewwindow&quot;, &quot;bm_openinnewtab&quot;, &quot;bm_separator&quot;,</span>
<a href="#l8.295"></a><span id="l8.295" class="difflineminus">-                  &quot;bm_newfolder&quot;, &quot;bm_sortfolder&quot;, &quot;bm_sortfolderbyname&quot;, &quot;bm_separator&quot;,</span>
<a href="#l8.296"></a><span id="l8.296" class="difflineminus">-                  &quot;bm_cut&quot;, &quot;bm_copy&quot;, &quot;bm_paste&quot;, &quot;bm_movebookmark&quot;, &quot;bm_separator&quot;,</span>
<a href="#l8.297"></a><span id="l8.297" class="difflineminus">-                  &quot;bm_rename&quot;, &quot;bm_delete&quot;, &quot;bm_separator&quot;,</span>
<a href="#l8.298"></a><span id="l8.298" class="difflineminus">-                  &quot;bm_properties&quot;];</span>
<a href="#l8.299"></a><span id="l8.299" class="difflineminus">-      break;</span>
<a href="#l8.300"></a><span id="l8.300" class="difflineminus">-    case &quot;Folder&quot;:</span>
<a href="#l8.301"></a><span id="l8.301" class="difflineminus">-      commands = [&quot;bm_expandfolder&quot;, &quot;bm_managefolder&quot;, &quot;bm_separator&quot;, </span>
<a href="#l8.302"></a><span id="l8.302" class="difflineminus">-                  &quot;bm_newfolder&quot;, &quot;bm_sortfolder&quot;, &quot;bm_sortfolderbyname&quot;, &quot;bm_separator&quot;,</span>
<a href="#l8.303"></a><span id="l8.303" class="difflineminus">-                  &quot;bm_cut&quot;, &quot;bm_copy&quot;, &quot;bm_paste&quot;, &quot;bm_movebookmark&quot;, &quot;bm_separator&quot;,</span>
<a href="#l8.304"></a><span id="l8.304" class="difflineminus">-                  &quot;bm_rename&quot;, &quot;bm_delete&quot;, &quot;bm_separator&quot;,</span>
<a href="#l8.305"></a><span id="l8.305" class="difflineminus">-                  &quot;bm_properties&quot;];</span>
<a href="#l8.306"></a><span id="l8.306" class="difflineminus">-      break;</span>
<a href="#l8.307"></a><span id="l8.307" class="difflineminus">-    case &quot;FolderGroup&quot;:</span>
<a href="#l8.308"></a><span id="l8.308" class="difflineminus">-      commands = [&quot;bm_open&quot;, &quot;bm_openinnewwindow&quot;, &quot;bm_expandfolder&quot;, &quot;bm_separator&quot;,</span>
<a href="#l8.309"></a><span id="l8.309" class="difflineminus">-                  &quot;bm_newfolder&quot;, &quot;bm_sortfolder&quot;, &quot;bm_sortfolderbyname&quot;, &quot;bm_separator&quot;,</span>
<a href="#l8.310"></a><span id="l8.310" class="difflineminus">-                  &quot;bm_cut&quot;, &quot;bm_copy&quot;, &quot;bm_paste&quot;, &quot;bm_movebookmark&quot;, &quot;bm_separator&quot;,</span>
<a href="#l8.311"></a><span id="l8.311" class="difflineminus">-                  &quot;bm_rename&quot;, &quot;bm_delete&quot;, &quot;bm_separator&quot;,</span>
<a href="#l8.312"></a><span id="l8.312" class="difflineminus">-                  &quot;bm_properties&quot;];</span>
<a href="#l8.313"></a><span id="l8.313" class="difflineminus">-      break;</span>
<a href="#l8.314"></a><span id="l8.314" class="difflineminus">-    case &quot;PersonalToolbarFolder&quot;:</span>
<a href="#l8.315"></a><span id="l8.315" class="difflineminus">-      commands = [&quot;bm_newfolder&quot;, &quot;bm_sortfolder&quot;, &quot;bm_sortfolderbyname&quot;, &quot;bm_separator&quot;,</span>
<a href="#l8.316"></a><span id="l8.316" class="difflineminus">-                  &quot;bm_cut&quot;, &quot;bm_copy&quot;, &quot;bm_paste&quot;, &quot;bm_movebookmark&quot;, &quot;bm_separator&quot;,</span>
<a href="#l8.317"></a><span id="l8.317" class="difflineminus">-                  &quot;bm_rename&quot;, &quot;bm_delete&quot;, &quot;bm_separator&quot;,</span>
<a href="#l8.318"></a><span id="l8.318" class="difflineminus">-                  &quot;bm_properties&quot;];</span>
<a href="#l8.319"></a><span id="l8.319" class="difflineminus">-      break;</span>
<a href="#l8.320"></a><span id="l8.320" class="difflineminus">-    case &quot;IEFavoriteFolder&quot;:</span>
<a href="#l8.321"></a><span id="l8.321" class="difflineminus">-      commands = [&quot;bm_expandfolder&quot;, &quot;bm_separator&quot;, &quot;bm_delete&quot;];</span>
<a href="#l8.322"></a><span id="l8.322" class="difflineminus">-      break;</span>
<a href="#l8.323"></a><span id="l8.323" class="difflineminus">-    case &quot;IEFavorite&quot;:</span>
<a href="#l8.324"></a><span id="l8.324" class="difflineminus">-      commands = [&quot;bm_open&quot;, &quot;bm_openinnewwindow&quot;, &quot;bm_openinnewtab&quot;, &quot;bm_separator&quot;,</span>
<a href="#l8.325"></a><span id="l8.325" class="difflineminus">-                  &quot;bm_copy&quot;];</span>
<a href="#l8.326"></a><span id="l8.326" class="difflineminus">-      break;</span>
<a href="#l8.327"></a><span id="l8.327" class="difflineminus">-    case &quot;FileSystemObject&quot;:</span>
<a href="#l8.328"></a><span id="l8.328" class="difflineminus">-      commands = [&quot;bm_open&quot;, &quot;bm_openinnewwindow&quot;, &quot;bm_openinnewtab&quot;, &quot;bm_separator&quot;,</span>
<a href="#l8.329"></a><span id="l8.329" class="difflineminus">-                  &quot;bm_copy&quot;];</span>
<a href="#l8.330"></a><span id="l8.330" class="difflineminus">-      break;</span>
<a href="#l8.331"></a><span id="l8.331" class="difflineminus">-    default: </span>
<a href="#l8.332"></a><span id="l8.332" class="difflineminus">-      commands = [];</span>
<a href="#l8.333"></a><span id="l8.333" class="difflineminus">-    }</span>
<a href="#l8.334"></a><span id="l8.334" class="difflineminus">-</span>
<a href="#l8.335"></a><span id="l8.335" class="difflineminus">-    return new CommandArrayEnumerator(commands);</span>
<a href="#l8.336"></a><span id="l8.336" class="difflineminus">-  },</span>
<a href="#l8.337"></a><span id="l8.337" class="difflineminus">-</span>
<a href="#l8.338"></a><span id="l8.338" class="difflineminus">-  /////////////////////////////////////////////////////////////////////////////</span>
<a href="#l8.339"></a><span id="l8.339" class="difflineminus">-  // For a given target ID, return an enumeration that contains the possible</span>
<a href="#l8.340"></a><span id="l8.340" class="difflineminus">-  // commands.</span>
<a href="#l8.341"></a><span id="l8.341" class="difflineminus">-  getValidCommands: function (aTargetID)</span>
<a href="#l8.342"></a><span id="l8.342" class="difflineminus">-  {</span>
<a href="#l8.343"></a><span id="l8.343" class="difflineminus">-    var valid = [&quot;bm_open&quot;, &quot;bm_openinnewwindow&quot;, &quot;bm_openinnewtab&quot;, &quot;bm_managefolder&quot;,</span>
<a href="#l8.344"></a><span id="l8.344" class="difflineminus">-                 &quot;bm_separator&quot;, &quot;bm_newfolder&quot;, &quot;bm_sortfolder&quot;, &quot;bm_sortfolderbyname&quot;,</span>
<a href="#l8.345"></a><span id="l8.345" class="difflineminus">-                 &quot;bm_cut&quot;, &quot;bm_copy&quot;, &quot;bm_paste&quot;, &quot;bm_movebookmark&quot;, &quot;bm_rename&quot;,</span>
<a href="#l8.346"></a><span id="l8.346" class="difflineminus">-                 &quot;bm_delete&quot;, &quot;bm_properties&quot;];</span>
<a href="#l8.347"></a><span id="l8.347" class="difflineminus">-    if (aTargetID != &quot;bookmarks-context-menu&quot;)</span>
<a href="#l8.348"></a><span id="l8.348" class="difflineminus">-      valid.push(&quot;bm_expandfolder&quot;);</span>
<a href="#l8.349"></a><span id="l8.349" class="difflineminus">-</span>
<a href="#l8.350"></a><span id="l8.350" class="difflineminus">-    return new CommandArrayEnumerator(valid);</span>
<a href="#l8.351"></a><span id="l8.351" class="difflineminus">-  },</span>
<a href="#l8.352"></a><span id="l8.352" class="difflineminus">-  </span>
<a href="#l8.353"></a><span id="l8.353" class="difflineminus">-  ///////////////////////////////////////////////////////////////////////////</span>
<a href="#l8.354"></a><span id="l8.354" class="difflineminus">-  // Execute a command with the given source and arguments</span>
<a href="#l8.355"></a><span id="l8.355" class="difflineminus">-  doBookmarksCommand: function (aSource, aCommand, aArgumentsArray)</span>
<a href="#l8.356"></a><span id="l8.356" class="difflineminus">-  {</span>
<a href="#l8.357"></a><span id="l8.357" class="difflineminus">-    var rCommand = RDF.GetResource(aCommand);</span>
<a href="#l8.358"></a><span id="l8.358" class="difflineminus">-  </span>
<a href="#l8.359"></a><span id="l8.359" class="difflineminus">-    var kSuppArrayContractID = &quot;@mozilla.org/supports-array;1&quot;;</span>
<a href="#l8.360"></a><span id="l8.360" class="difflineminus">-    var kSuppArrayIID = Components.interfaces.nsISupportsArray;</span>
<a href="#l8.361"></a><span id="l8.361" class="difflineminus">-    var sourcesArray = Components.classes[kSuppArrayContractID].createInstance(kSuppArrayIID);</span>
<a href="#l8.362"></a><span id="l8.362" class="difflineminus">-    if (aSource) {</span>
<a href="#l8.363"></a><span id="l8.363" class="difflineminus">-      sourcesArray.AppendElement(aSource);</span>
<a href="#l8.364"></a><span id="l8.364" class="difflineminus">-    }</span>
<a href="#l8.365"></a><span id="l8.365" class="difflineminus">-  </span>
<a href="#l8.366"></a><span id="l8.366" class="difflineminus">-    var argsArray = Components.classes[kSuppArrayContractID].createInstance(kSuppArrayIID);</span>
<a href="#l8.367"></a><span id="l8.367" class="difflineminus">-    var length = aArgumentsArray?aArgumentsArray.length:0;</span>
<a href="#l8.368"></a><span id="l8.368" class="difflineminus">-    for (var i = 0; i &lt; length; ++i) {</span>
<a href="#l8.369"></a><span id="l8.369" class="difflineminus">-      var rArc = RDF.GetResource(aArgumentsArray[i].property);</span>
<a href="#l8.370"></a><span id="l8.370" class="difflineminus">-      argsArray.AppendElement(rArc);</span>
<a href="#l8.371"></a><span id="l8.371" class="difflineminus">-      var rValue = null;</span>
<a href="#l8.372"></a><span id="l8.372" class="difflineminus">-      if (&quot;resource&quot; in aArgumentsArray[i]) { </span>
<a href="#l8.373"></a><span id="l8.373" class="difflineminus">-        rValue = RDF.GetResource(aArgumentsArray[i].resource);</span>
<a href="#l8.374"></a><span id="l8.374" class="difflineminus">-      }</span>
<a href="#l8.375"></a><span id="l8.375" class="difflineminus">-      else</span>
<a href="#l8.376"></a><span id="l8.376" class="difflineminus">-        rValue = RDF.GetLiteral(aArgumentsArray[i].literal);</span>
<a href="#l8.377"></a><span id="l8.377" class="difflineminus">-      argsArray.AppendElement(rValue);</span>
<a href="#l8.378"></a><span id="l8.378" class="difflineminus">-    }</span>
<a href="#l8.379"></a><span id="l8.379" class="difflineminus">-</span>
<a href="#l8.380"></a><span id="l8.380" class="difflineminus">-    // Exec the command in the Bookmarks datasource. </span>
<a href="#l8.381"></a><span id="l8.381" class="difflineminus">-    BMDS.DoCommand(sourcesArray, rCommand, argsArray);</span>
<a href="#l8.382"></a><span id="l8.382" class="difflineminus">-  },</span>
<a href="#l8.383"></a><span id="l8.383" class="difflineminus">-</span>
<a href="#l8.384"></a><span id="l8.384" class="difflineminus">-  undoBookmarkTransaction: function ()</span>
<a href="#l8.385"></a><span id="l8.385" class="difflineminus">-  {</span>
<a href="#l8.386"></a><span id="l8.386" class="difflineminus">-    BMSVC.transactionManager.undoTransaction();</span>
<a href="#l8.387"></a><span id="l8.387" class="difflineminus">-    BookmarksUtils.notifyBookmarksChanged();</span>
<a href="#l8.388"></a><span id="l8.388" class="difflineminus">-    BookmarksUtils.flushDataSource();</span>
<a href="#l8.389"></a><span id="l8.389" class="difflineminus">-  },</span>
<a href="#l8.390"></a><span id="l8.390" class="difflineminus">-</span>
<a href="#l8.391"></a><span id="l8.391" class="difflineminus">-  redoBookmarkTransaction: function ()</span>
<a href="#l8.392"></a><span id="l8.392" class="difflineminus">-  {</span>
<a href="#l8.393"></a><span id="l8.393" class="difflineminus">-    BMSVC.transactionManager.redoTransaction();</span>
<a href="#l8.394"></a><span id="l8.394" class="difflineminus">-    BookmarksUtils.notifyBookmarksChanged();</span>
<a href="#l8.395"></a><span id="l8.395" class="difflineminus">-    BookmarksUtils.flushDataSource();</span>
<a href="#l8.396"></a><span id="l8.396" class="difflineminus">-  },</span>
<a href="#l8.397"></a><span id="l8.397" class="difflineminus">-</span>
<a href="#l8.398"></a><span id="l8.398" class="difflineminus">-  manageFolder: function (aSelection)</span>
<a href="#l8.399"></a><span id="l8.399" class="difflineminus">-  {</span>
<a href="#l8.400"></a><span id="l8.400" class="difflineminus">-    openDialog(&quot;chrome://communicator/content/bookmarks/bookmarksManager.xul&quot;, </span>
<a href="#l8.401"></a><span id="l8.401" class="difflineminus">-               &quot;&quot;, &quot;chrome,all,dialog=no&quot;, aSelection.item[0].Value);</span>
<a href="#l8.402"></a><span id="l8.402" class="difflineminus">-  },</span>
<a href="#l8.403"></a><span id="l8.403" class="difflineminus">-  </span>
<a href="#l8.404"></a><span id="l8.404" class="difflineminus">-  cutBookmark: function (aSelection)</span>
<a href="#l8.405"></a><span id="l8.405" class="difflineminus">-  {</span>
<a href="#l8.406"></a><span id="l8.406" class="difflineminus">-    this.copyBookmark(aSelection);</span>
<a href="#l8.407"></a><span id="l8.407" class="difflineminus">-    BookmarksUtils.removeSelection(&quot;cut&quot;, aSelection);</span>
<a href="#l8.408"></a><span id="l8.408" class="difflineminus">-  },</span>
<a href="#l8.409"></a><span id="l8.409" class="difflineminus">-</span>
<a href="#l8.410"></a><span id="l8.410" class="difflineminus">-  copyBookmark: function (aSelection)</span>
<a href="#l8.411"></a><span id="l8.411" class="difflineminus">-  {</span>
<a href="#l8.412"></a><span id="l8.412" class="difflineminus">-</span>
<a href="#l8.413"></a><span id="l8.413" class="difflineminus">-    const kSuppArrayContractID = &quot;@mozilla.org/supports-array;1&quot;;</span>
<a href="#l8.414"></a><span id="l8.414" class="difflineminus">-    const kSuppArrayIID = Components.interfaces.nsISupportsArray;</span>
<a href="#l8.415"></a><span id="l8.415" class="difflineminus">-    var itemArray = Components.classes[kSuppArrayContractID].createInstance(kSuppArrayIID);</span>
<a href="#l8.416"></a><span id="l8.416" class="difflineminus">-</span>
<a href="#l8.417"></a><span id="l8.417" class="difflineminus">-    const kSuppWStringContractID = &quot;@mozilla.org/supports-string;1&quot;;</span>
<a href="#l8.418"></a><span id="l8.418" class="difflineminus">-    const kSuppWStringIID = Components.interfaces.nsISupportsString;</span>
<a href="#l8.419"></a><span id="l8.419" class="difflineminus">-    var bmstring = Components.classes[kSuppWStringContractID].createInstance(kSuppWStringIID);</span>
<a href="#l8.420"></a><span id="l8.420" class="difflineminus">-    var unicodestring = Components.classes[kSuppWStringContractID].createInstance(kSuppWStringIID);</span>
<a href="#l8.421"></a><span id="l8.421" class="difflineminus">-    var htmlstring = Components.classes[kSuppWStringContractID].createInstance(kSuppWStringIID);</span>
<a href="#l8.422"></a><span id="l8.422" class="difflineminus">-  </span>
<a href="#l8.423"></a><span id="l8.423" class="difflineminus">-    var sBookmarkItem = &quot;&quot;; var sTextUnicode = &quot;&quot;; var sTextHTML = &quot;&quot;;</span>
<a href="#l8.424"></a><span id="l8.424" class="difflineminus">-    for (var i = 0; i &lt; aSelection.length; ++i) {</span>
<a href="#l8.425"></a><span id="l8.425" class="difflineminus">-      var url  = BookmarksUtils.getProperty(aSelection.item[i], NC_NS+&quot;URL&quot; );</span>
<a href="#l8.426"></a><span id="l8.426" class="difflineminus">-      var name = BookmarksUtils.getProperty(aSelection.item[i], NC_NS+&quot;Name&quot;);</span>
<a href="#l8.427"></a><span id="l8.427" class="difflineminus">-      sBookmarkItem += aSelection.item[i].Value + &quot;\n&quot;;</span>
<a href="#l8.428"></a><span id="l8.428" class="difflineminus">-      sTextUnicode += url + &quot;\n&quot;;</span>
<a href="#l8.429"></a><span id="l8.429" class="difflineminus">-      sTextHTML += &quot;&lt;A HREF=\&quot;&quot; + url + &quot;\&quot;&gt;&quot; + name + &quot;&lt;/A&gt;\n&quot;;</span>
<a href="#l8.430"></a><span id="l8.430" class="difflineminus">-    }</span>
<a href="#l8.431"></a><span id="l8.431" class="difflineminus">-    sTextUnicode = sTextUnicode.replace(/\n$/, &quot;&quot;);</span>
<a href="#l8.432"></a><span id="l8.432" class="difflineminus">-    sTextHTML = sTextHTML.replace(/\n$/, &quot;&quot;);</span>
<a href="#l8.433"></a><span id="l8.433" class="difflineminus">-</span>
<a href="#l8.434"></a><span id="l8.434" class="difflineminus">-    const kXferableContractID = &quot;@mozilla.org/widget/transferable;1&quot;;</span>
<a href="#l8.435"></a><span id="l8.435" class="difflineminus">-    const kXferableIID = Components.interfaces.nsITransferable;</span>
<a href="#l8.436"></a><span id="l8.436" class="difflineminus">-    var xferable = Components.classes[kXferableContractID].createInstance(kXferableIID);</span>
<a href="#l8.437"></a><span id="l8.437" class="difflineminus">-</span>
<a href="#l8.438"></a><span id="l8.438" class="difflineminus">-    xferable.addDataFlavor(&quot;moz/bookmarkclipboarditem&quot;);</span>
<a href="#l8.439"></a><span id="l8.439" class="difflineminus">-    bmstring.data = sBookmarkItem;</span>
<a href="#l8.440"></a><span id="l8.440" class="difflineminus">-    xferable.setTransferData(&quot;moz/bookmarkclipboarditem&quot;, bmstring, sBookmarkItem.length*2);</span>
<a href="#l8.441"></a><span id="l8.441" class="difflineminus">-    </span>
<a href="#l8.442"></a><span id="l8.442" class="difflineminus">-    xferable.addDataFlavor(&quot;text/html&quot;);</span>
<a href="#l8.443"></a><span id="l8.443" class="difflineminus">-    htmlstring.data = sTextHTML;</span>
<a href="#l8.444"></a><span id="l8.444" class="difflineminus">-    xferable.setTransferData(&quot;text/html&quot;, htmlstring, sTextHTML.length*2);</span>
<a href="#l8.445"></a><span id="l8.445" class="difflineminus">-    </span>
<a href="#l8.446"></a><span id="l8.446" class="difflineminus">-    xferable.addDataFlavor(&quot;text/unicode&quot;);</span>
<a href="#l8.447"></a><span id="l8.447" class="difflineminus">-    unicodestring.data = sTextUnicode;</span>
<a href="#l8.448"></a><span id="l8.448" class="difflineminus">-    xferable.setTransferData(&quot;text/unicode&quot;, unicodestring, sTextUnicode.length*2);</span>
<a href="#l8.449"></a><span id="l8.449" class="difflineminus">-    </span>
<a href="#l8.450"></a><span id="l8.450" class="difflineminus">-    const kClipboardContractID = &quot;@mozilla.org/widget/clipboard;1&quot;;</span>
<a href="#l8.451"></a><span id="l8.451" class="difflineminus">-    const kClipboardIID = Components.interfaces.nsIClipboard;</span>
<a href="#l8.452"></a><span id="l8.452" class="difflineminus">-    var clipboard = Components.classes[kClipboardContractID].getService(kClipboardIID);</span>
<a href="#l8.453"></a><span id="l8.453" class="difflineminus">-    clipboard.setData(xferable, null, kClipboardIID.kGlobalClipboard);</span>
<a href="#l8.454"></a><span id="l8.454" class="difflineminus">-  },</span>
<a href="#l8.455"></a><span id="l8.455" class="difflineminus">-</span>
<a href="#l8.456"></a><span id="l8.456" class="difflineminus">-  pasteBookmark: function (aTarget)</span>
<a href="#l8.457"></a><span id="l8.457" class="difflineminus">-  {</span>
<a href="#l8.458"></a><span id="l8.458" class="difflineminus">-    const kXferableContractID = &quot;@mozilla.org/widget/transferable;1&quot;;</span>
<a href="#l8.459"></a><span id="l8.459" class="difflineminus">-    const kXferableIID = Components.interfaces.nsITransferable;</span>
<a href="#l8.460"></a><span id="l8.460" class="difflineminus">-    var xferable = Components.classes[kXferableContractID].createInstance(kXferableIID);</span>
<a href="#l8.461"></a><span id="l8.461" class="difflineminus">-    xferable.addDataFlavor(&quot;moz/bookmarkclipboarditem&quot;);</span>
<a href="#l8.462"></a><span id="l8.462" class="difflineminus">-    xferable.addDataFlavor(&quot;text/x-moz-url&quot;);</span>
<a href="#l8.463"></a><span id="l8.463" class="difflineminus">-    xferable.addDataFlavor(&quot;text/unicode&quot;);</span>
<a href="#l8.464"></a><span id="l8.464" class="difflineminus">-</span>
<a href="#l8.465"></a><span id="l8.465" class="difflineminus">-    const kClipboardContractID = &quot;@mozilla.org/widget/clipboard;1&quot;;</span>
<a href="#l8.466"></a><span id="l8.466" class="difflineminus">-    const kClipboardIID = Components.interfaces.nsIClipboard;</span>
<a href="#l8.467"></a><span id="l8.467" class="difflineminus">-    var clipboard = Components.classes[kClipboardContractID].getService(kClipboardIID);</span>
<a href="#l8.468"></a><span id="l8.468" class="difflineminus">-    clipboard.getData(xferable, kClipboardIID.kGlobalClipboard);</span>
<a href="#l8.469"></a><span id="l8.469" class="difflineminus">-    </span>
<a href="#l8.470"></a><span id="l8.470" class="difflineminus">-    var flavour = { };</span>
<a href="#l8.471"></a><span id="l8.471" class="difflineminus">-    var data    = { };</span>
<a href="#l8.472"></a><span id="l8.472" class="difflineminus">-    var length  = { };</span>
<a href="#l8.473"></a><span id="l8.473" class="difflineminus">-    xferable.getAnyTransferData(flavour, data, length);</span>
<a href="#l8.474"></a><span id="l8.474" class="difflineminus">-    var items, name, url;</span>
<a href="#l8.475"></a><span id="l8.475" class="difflineminus">-    data = data.value.QueryInterface(Components.interfaces.nsISupportsString).data;</span>
<a href="#l8.476"></a><span id="l8.476" class="difflineminus">-    switch (flavour.value) {</span>
<a href="#l8.477"></a><span id="l8.477" class="difflineminus">-    case &quot;moz/bookmarkclipboarditem&quot;:</span>
<a href="#l8.478"></a><span id="l8.478" class="difflineminus">-      items = data.split(&quot;\n&quot;);</span>
<a href="#l8.479"></a><span id="l8.479" class="difflineminus">-      // since data are ended by \n, remove the last empty node</span>
<a href="#l8.480"></a><span id="l8.480" class="difflineminus">-      items.pop(); </span>
<a href="#l8.481"></a><span id="l8.481" class="difflineminus">-      for (var i=0; i&lt;items.length; ++i) {</span>
<a href="#l8.482"></a><span id="l8.482" class="difflineminus">-        items[i] = RDF.GetResource(items[i]);</span>
<a href="#l8.483"></a><span id="l8.483" class="difflineminus">-      }</span>
<a href="#l8.484"></a><span id="l8.484" class="difflineminus">-      break;</span>
<a href="#l8.485"></a><span id="l8.485" class="difflineminus">-    case &quot;text/x-moz-url&quot;:</span>
<a href="#l8.486"></a><span id="l8.486" class="difflineminus">-      // there should be only one item in this case</span>
<a href="#l8.487"></a><span id="l8.487" class="difflineminus">-      var ix = data.indexOf(&quot;\n&quot;);</span>
<a href="#l8.488"></a><span id="l8.488" class="difflineminus">-      items = data.substring(0, ix != -1 ? ix : data.length);</span>
<a href="#l8.489"></a><span id="l8.489" class="difflineminus">-      name  = data.substring(ix);</span>
<a href="#l8.490"></a><span id="l8.490" class="difflineminus">-      // XXX: we should infer the best charset</span>
<a href="#l8.491"></a><span id="l8.491" class="difflineminus">-      BookmarksUtils.createBookmark(null, items, null, name);</span>
<a href="#l8.492"></a><span id="l8.492" class="difflineminus">-      items = [items];</span>
<a href="#l8.493"></a><span id="l8.493" class="difflineminus">-      break;</span>
<a href="#l8.494"></a><span id="l8.494" class="difflineminus">-    default: </span>
<a href="#l8.495"></a><span id="l8.495" class="difflineminus">-      return;</span>
<a href="#l8.496"></a><span id="l8.496" class="difflineminus">-    }</span>
<a href="#l8.497"></a><span id="l8.497" class="difflineminus">-   </span>
<a href="#l8.498"></a><span id="l8.498" class="difflineminus">-    var selection = {item: items, parent:Array(items.length), length: items.length};</span>
<a href="#l8.499"></a><span id="l8.499" class="difflineminus">-    BookmarksUtils.checkSelection(selection);</span>
<a href="#l8.500"></a><span id="l8.500" class="difflineminus">-    BookmarksUtils.insertSelection(&quot;paste&quot;, selection, aTarget);</span>
<a href="#l8.501"></a><span id="l8.501" class="difflineminus">-  },</span>
<a href="#l8.502"></a><span id="l8.502" class="difflineminus">-  </span>
<a href="#l8.503"></a><span id="l8.503" class="difflineminus">-  deleteBookmark: function (aSelection)</span>
<a href="#l8.504"></a><span id="l8.504" class="difflineminus">-  {</span>
<a href="#l8.505"></a><span id="l8.505" class="difflineminus">-    BookmarksUtils.removeSelection(&quot;delete&quot;, aSelection);</span>
<a href="#l8.506"></a><span id="l8.506" class="difflineminus">-  },</span>
<a href="#l8.507"></a><span id="l8.507" class="difflineminus">-</span>
<a href="#l8.508"></a><span id="l8.508" class="difflineminus">-  moveBookmark: function (aSelection)</span>
<a href="#l8.509"></a><span id="l8.509" class="difflineminus">-  {</span>
<a href="#l8.510"></a><span id="l8.510" class="difflineminus">-    var rv = { selectedFolder: null };      </span>
<a href="#l8.511"></a><span id="l8.511" class="difflineminus">-    openDialog(&quot;chrome://communicator/content/bookmarks/addBookmark.xul&quot;, &quot;&quot;, </span>
<a href="#l8.512"></a><span id="l8.512" class="difflineminus">-               &quot;centerscreen,chrome,modal=yes,dialog=yes,resizable=yes&quot;, null, null, null, null, &quot;selectFolder&quot;, rv);</span>
<a href="#l8.513"></a><span id="l8.513" class="difflineminus">-    if (!rv.target)</span>
<a href="#l8.514"></a><span id="l8.514" class="difflineminus">-      return;</span>
<a href="#l8.515"></a><span id="l8.515" class="difflineminus">-    </span>
<a href="#l8.516"></a><span id="l8.516" class="difflineminus">-    var target = rv.target;</span>
<a href="#l8.517"></a><span id="l8.517" class="difflineminus">-    BookmarksUtils.moveSelection(&quot;move&quot;, aSelection, target);</span>
<a href="#l8.518"></a><span id="l8.518" class="difflineminus">-  },</span>
<a href="#l8.519"></a><span id="l8.519" class="difflineminus">-</span>
<a href="#l8.520"></a><span id="l8.520" class="difflineminus">-  openBookmark: function (aSelection, aTargetBrowser, aDS, aEvent)</span>
<a href="#l8.521"></a><span id="l8.521" class="difflineminus">-  {</span>
<a href="#l8.522"></a><span id="l8.522" class="difflineminus">-    if (!aTargetBrowser)</span>
<a href="#l8.523"></a><span id="l8.523" class="difflineminus">-      return;</span>
<a href="#l8.524"></a><span id="l8.524" class="difflineminus">-    for (var i=0; i&lt;aSelection.length; ++i) {</span>
<a href="#l8.525"></a><span id="l8.525" class="difflineminus">-      var type = aSelection.type[i];</span>
<a href="#l8.526"></a><span id="l8.526" class="difflineminus">-      if (type == &quot;Bookmark&quot; || type == &quot;&quot;)</span>
<a href="#l8.527"></a><span id="l8.527" class="difflineminus">-        this.openOneBookmark(aSelection.item[i].Value, aTargetBrowser, aDS, aEvent);</span>
<a href="#l8.528"></a><span id="l8.528" class="difflineminus">-      else if (type == &quot;FolderGroup&quot; || type == &quot;Folder&quot; || type == &quot;PersonalToolbarFolder&quot;)</span>
<a href="#l8.529"></a><span id="l8.529" class="difflineminus">-        this.openGroupBookmark(aSelection.item[i].Value, aTargetBrowser, aEvent);</span>
<a href="#l8.530"></a><span id="l8.530" class="difflineminus">-    }</span>
<a href="#l8.531"></a><span id="l8.531" class="difflineminus">-  },</span>
<a href="#l8.532"></a><span id="l8.532" class="difflineminus">-  </span>
<a href="#l8.533"></a><span id="l8.533" class="difflineminus">-  openBookmarkProperties: function (aSelection) </span>
<a href="#l8.534"></a><span id="l8.534" class="difflineminus">-  {</span>
<a href="#l8.535"></a><span id="l8.535" class="difflineminus">-    // Bookmark Properties dialog is only ever opened with one selection </span>
<a href="#l8.536"></a><span id="l8.536" class="difflineminus">-    // (command is disabled otherwise)</span>
<a href="#l8.537"></a><span id="l8.537" class="difflineminus">-    var bookmark = aSelection.item[0].Value;</span>
<a href="#l8.538"></a><span id="l8.538" class="difflineminus">-    return openDialog(&quot;chrome://communicator/content/bookmarks/bm-props.xul&quot;, &quot;&quot;, &quot;centerscreen,chrome,dependent,resizable=no&quot;, bookmark);      </span>
<a href="#l8.539"></a><span id="l8.539" class="difflineminus">-  },</span>
<a href="#l8.540"></a><span id="l8.540" class="difflineminus">-</span>
<a href="#l8.541"></a><span id="l8.541" class="difflineminus">-  // requires utilityOverlay.js if opening in new window for getTopWin()</span>
<a href="#l8.542"></a><span id="l8.542" class="difflineminus">-  openOneBookmark: function (aURI, aTargetBrowser, aDS, aEvent)</span>
<a href="#l8.543"></a><span id="l8.543" class="difflineminus">-  {</span>
<a href="#l8.544"></a><span id="l8.544" class="difflineminus">-    var w = getTopWin();</span>
<a href="#l8.545"></a><span id="l8.545" class="difflineminus">-    if (!w) // no browser window open, so we have to open in new window</span>
<a href="#l8.546"></a><span id="l8.546" class="difflineminus">-      aTargetBrowser = &quot;window&quot;;</span>
<a href="#l8.547"></a><span id="l8.547" class="difflineminus">-</span>
<a href="#l8.548"></a><span id="l8.548" class="difflineminus">-    var url = BookmarksUtils.getProperty(aURI, NC_NS + &quot;URL&quot;, aDS);</span>
<a href="#l8.549"></a><span id="l8.549" class="difflineminus">-    // Ignore &quot;NC:&quot; and empty urls.</span>
<a href="#l8.550"></a><span id="l8.550" class="difflineminus">-    if (url == &quot;&quot;)</span>
<a href="#l8.551"></a><span id="l8.551" class="difflineminus">-      return;</span>
<a href="#l8.552"></a><span id="l8.552" class="difflineminus">-</span>
<a href="#l8.553"></a><span id="l8.553" class="difflineminus">-    if (aTargetBrowser == &quot;window&quot;) {</span>
<a href="#l8.554"></a><span id="l8.554" class="difflineminus">-      openDialog(getBrowserURL(), &quot;_blank&quot;, &quot;chrome,all,dialog=no&quot;, url);</span>
<a href="#l8.555"></a><span id="l8.555" class="difflineminus">-      return;</span>
<a href="#l8.556"></a><span id="l8.556" class="difflineminus">-    }</span>
<a href="#l8.557"></a><span id="l8.557" class="difflineminus">-</span>
<a href="#l8.558"></a><span id="l8.558" class="difflineminus">-    var browser = w.getBrowser();</span>
<a href="#l8.559"></a><span id="l8.559" class="difflineminus">-    switch (aTargetBrowser) {</span>
<a href="#l8.560"></a><span id="l8.560" class="difflineminus">-    case &quot;current&quot;:</span>
<a href="#l8.561"></a><span id="l8.561" class="difflineminus">-      browser.loadURI(url);</span>
<a href="#l8.562"></a><span id="l8.562" class="difflineminus">-      w.content.focus();</span>
<a href="#l8.563"></a><span id="l8.563" class="difflineminus">-      break;</span>
<a href="#l8.564"></a><span id="l8.564" class="difflineminus">-    case &quot;tab&quot;:</span>
<a href="#l8.565"></a><span id="l8.565" class="difflineminus">-      var tab = browser.addTab(url);</span>
<a href="#l8.566"></a><span id="l8.566" class="difflineminus">-      if (!BookmarksUtils.shouldLoadTabInBackground(aEvent))</span>
<a href="#l8.567"></a><span id="l8.567" class="difflineminus">-        browser.selectedTab = tab;</span>
<a href="#l8.568"></a><span id="l8.568" class="difflineminus">-      break;</span>
<a href="#l8.569"></a><span id="l8.569" class="difflineminus">-    }</span>
<a href="#l8.570"></a><span id="l8.570" class="difflineminus">-  },</span>
<a href="#l8.571"></a><span id="l8.571" class="difflineminus">-</span>
<a href="#l8.572"></a><span id="l8.572" class="difflineminus">-  openGroupBookmark: function (aURI, aTargetBrowser, aEvent)</span>
<a href="#l8.573"></a><span id="l8.573" class="difflineminus">-  {</span>
<a href="#l8.574"></a><span id="l8.574" class="difflineminus">-    var w = getTopWin();</span>
<a href="#l8.575"></a><span id="l8.575" class="difflineminus">-    if (!w) // no browser window open, so we have to open in new window</span>
<a href="#l8.576"></a><span id="l8.576" class="difflineminus">-      aTargetBrowser = &quot;window&quot;;</span>
<a href="#l8.577"></a><span id="l8.577" class="difflineminus">-</span>
<a href="#l8.578"></a><span id="l8.578" class="difflineminus">-    var resource = RDF.GetResource(aURI);</span>
<a href="#l8.579"></a><span id="l8.579" class="difflineminus">-    RDFC.Init(BMDS, resource);</span>
<a href="#l8.580"></a><span id="l8.580" class="difflineminus">-    var containerChildren = RDFC.GetElements();</span>
<a href="#l8.581"></a><span id="l8.581" class="difflineminus">-</span>
<a href="#l8.582"></a><span id="l8.582" class="difflineminus">-    var URIs = [];</span>
<a href="#l8.583"></a><span id="l8.583" class="difflineminus">-    var urlArc = RDF.GetResource(NC_NS + &quot;URL&quot;);</span>
<a href="#l8.584"></a><span id="l8.584" class="difflineminus">-    while (containerChildren.hasMoreElements()) {</span>
<a href="#l8.585"></a><span id="l8.585" class="difflineminus">-      var res = containerChildren.getNext().QueryInterface(kRDFRSCIID);</span>
<a href="#l8.586"></a><span id="l8.586" class="difflineminus">-      var target = BMDS.GetTarget(res, urlArc, true);</span>
<a href="#l8.587"></a><span id="l8.587" class="difflineminus">-      if (target) {</span>
<a href="#l8.588"></a><span id="l8.588" class="difflineminus">-        if (aTargetBrowser == &quot;window&quot;)</span>
<a href="#l8.589"></a><span id="l8.589" class="difflineminus">-          URIs.push(target.QueryInterface(kRDFLITIID).Value);</span>
<a href="#l8.590"></a><span id="l8.590" class="difflineminus">-        else</span>
<a href="#l8.591"></a><span id="l8.591" class="difflineminus">-          URIs.push({ URI: target.QueryInterface(kRDFLITIID).Value });        </span>
<a href="#l8.592"></a><span id="l8.592" class="difflineminus">-      }</span>
<a href="#l8.593"></a><span id="l8.593" class="difflineminus">-    }</span>
<a href="#l8.594"></a><span id="l8.594" class="difflineminus">-</span>
<a href="#l8.595"></a><span id="l8.595" class="difflineminus">-    if (URIs.length == 0)</span>
<a href="#l8.596"></a><span id="l8.596" class="difflineminus">-      return;</span>
<a href="#l8.597"></a><span id="l8.597" class="difflineminus">-</span>
<a href="#l8.598"></a><span id="l8.598" class="difflineminus">-    if (aTargetBrowser == &quot;window&quot;) {</span>
<a href="#l8.599"></a><span id="l8.599" class="difflineminus">-      // This opens the URIs in separate tabs of a new window</span>
<a href="#l8.600"></a><span id="l8.600" class="difflineminus">-      openDialog(getBrowserURL(), &quot;_blank&quot;, &quot;chrome,all,dialog=no&quot;, URIs.join(&quot;\n&quot;));</span>
<a href="#l8.601"></a><span id="l8.601" class="difflineminus">-      return;</span>
<a href="#l8.602"></a><span id="l8.602" class="difflineminus">-    }</span>
<a href="#l8.603"></a><span id="l8.603" class="difflineminus">-</span>
<a href="#l8.604"></a><span id="l8.604" class="difflineminus">-    var browser = w.getBrowser();</span>
<a href="#l8.605"></a><span id="l8.605" class="difflineminus">-    var tab = browser.loadGroup(URIs);</span>
<a href="#l8.606"></a><span id="l8.606" class="difflineminus">-    if (!BookmarksUtils.shouldLoadTabInBackground(aEvent))</span>
<a href="#l8.607"></a><span id="l8.607" class="difflineminus">-      browser.selectedTab = tab;</span>
<a href="#l8.608"></a><span id="l8.608" class="difflineminus">-  },</span>
<a href="#l8.609"></a><span id="l8.609" class="difflineminus">-</span>
<a href="#l8.610"></a><span id="l8.610" class="difflineminus">-  findBookmark: function ()</span>
<a href="#l8.611"></a><span id="l8.611" class="difflineminus">-  {</span>
<a href="#l8.612"></a><span id="l8.612" class="difflineminus">-    openDialog(&quot;chrome://communicator/content/bookmarks/findBookmark.xul&quot;,</span>
<a href="#l8.613"></a><span id="l8.613" class="difflineminus">-               &quot;FindBookmarksWindow&quot;,</span>
<a href="#l8.614"></a><span id="l8.614" class="difflineminus">-               &quot;centerscreen,resizable=no,chrome,dependent&quot;);</span>
<a href="#l8.615"></a><span id="l8.615" class="difflineminus">-  },</span>
<a href="#l8.616"></a><span id="l8.616" class="difflineminus">-</span>
<a href="#l8.617"></a><span id="l8.617" class="difflineminus">-  createNewFolder: function (aTarget)</span>
<a href="#l8.618"></a><span id="l8.618" class="difflineminus">-  {</span>
<a href="#l8.619"></a><span id="l8.619" class="difflineminus">-    var name      = BookmarksUtils.getLocaleString(&quot;ile_newfolder&quot;);</span>
<a href="#l8.620"></a><span id="l8.620" class="difflineminus">-    var rFolder   = BMSVC.createFolder(name);</span>
<a href="#l8.621"></a><span id="l8.621" class="difflineminus">-    </span>
<a href="#l8.622"></a><span id="l8.622" class="difflineminus">-    var selection = BookmarksUtils.getSelectionFromResource(rFolder, aTarget.parent);</span>
<a href="#l8.623"></a><span id="l8.623" class="difflineminus">-    var ok        = BookmarksUtils.insertSelection(&quot;newfolder&quot;, selection, aTarget);</span>
<a href="#l8.624"></a><span id="l8.624" class="difflineminus">-    if (ok) {</span>
<a href="#l8.625"></a><span id="l8.625" class="difflineminus">-      var propWin = this.openBookmarkProperties(selection);</span>
<a href="#l8.626"></a><span id="l8.626" class="difflineminus">-      </span>
<a href="#l8.627"></a><span id="l8.627" class="difflineminus">-      function canceledNewFolder()</span>
<a href="#l8.628"></a><span id="l8.628" class="difflineminus">-      {</span>
<a href="#l8.629"></a><span id="l8.629" class="difflineminus">-        BookmarksCommand.deleteBookmark(selection);</span>
<a href="#l8.630"></a><span id="l8.630" class="difflineminus">-        propWin.document.documentElement.removeEventListener(&quot;dialogcancel&quot;, canceledNewFolder, false);</span>
<a href="#l8.631"></a><span id="l8.631" class="difflineminus">-        propWin.removeEventListener(&quot;load&quot;, propertiesWindowLoad, false);</span>
<a href="#l8.632"></a><span id="l8.632" class="difflineminus">-      }</span>
<a href="#l8.633"></a><span id="l8.633" class="difflineminus">-      </span>
<a href="#l8.634"></a><span id="l8.634" class="difflineminus">-      function propertiesWindowLoad()</span>
<a href="#l8.635"></a><span id="l8.635" class="difflineminus">-      {</span>
<a href="#l8.636"></a><span id="l8.636" class="difflineminus">-        propWin.document.documentElement.addEventListener(&quot;dialogcancel&quot;, canceledNewFolder, false);</span>
<a href="#l8.637"></a><span id="l8.637" class="difflineminus">-      }</span>
<a href="#l8.638"></a><span id="l8.638" class="difflineminus">-      propWin.addEventListener(&quot;load&quot;, propertiesWindowLoad, false);</span>
<a href="#l8.639"></a><span id="l8.639" class="difflineminus">-    }</span>
<a href="#l8.640"></a><span id="l8.640" class="difflineminus">-  },</span>
<a href="#l8.641"></a><span id="l8.641" class="difflineminus">-</span>
<a href="#l8.642"></a><span id="l8.642" class="difflineminus">-  createNewSeparator: function (aTarget)</span>
<a href="#l8.643"></a><span id="l8.643" class="difflineminus">-  {</span>
<a href="#l8.644"></a><span id="l8.644" class="difflineminus">-    var rSeparator  = BMSVC.createSeparator();</span>
<a href="#l8.645"></a><span id="l8.645" class="difflineminus">-    var selection   = BookmarksUtils.getSelectionFromResource(rSeparator);</span>
<a href="#l8.646"></a><span id="l8.646" class="difflineminus">-    BookmarksUtils.insertSelection(&quot;newseparator&quot;, selection, aTarget);</span>
<a href="#l8.647"></a><span id="l8.647" class="difflineminus">-  },</span>
<a href="#l8.648"></a><span id="l8.648" class="difflineminus">-</span>
<a href="#l8.649"></a><span id="l8.649" class="difflineminus">-  importBookmarks: function ()</span>
<a href="#l8.650"></a><span id="l8.650" class="difflineminus">-  {</span>
<a href="#l8.651"></a><span id="l8.651" class="difflineminus">-    window.fromFile = false;</span>
<a href="#l8.652"></a><span id="l8.652" class="difflineminus">-    window.openDialog(&quot;chrome://communicator/content/migration/migration.xul&quot;,</span>
<a href="#l8.653"></a><span id="l8.653" class="difflineminus">-                      &quot;&quot;, &quot;modal,centerscreen,chrome,resizable=no&quot;, &quot;bookmarks&quot;);</span>
<a href="#l8.654"></a><span id="l8.654" class="difflineminus">-</span>
<a href="#l8.655"></a><span id="l8.655" class="difflineminus">-    if (window.fromFile)</span>
<a href="#l8.656"></a><span id="l8.656" class="difflineminus">-      this.importBookmarksFromFile();</span>
<a href="#l8.657"></a><span id="l8.657" class="difflineminus">-  },</span>
<a href="#l8.658"></a><span id="l8.658" class="difflineminus">-</span>
<a href="#l8.659"></a><span id="l8.659" class="difflineminus">-  importBookmarksFromFile: function ()</span>
<a href="#l8.660"></a><span id="l8.660" class="difflineminus">-  {</span>
<a href="#l8.661"></a><span id="l8.661" class="difflineminus">-    ///transaction...</span>
<a href="#l8.662"></a><span id="l8.662" class="difflineminus">-    try {</span>
<a href="#l8.663"></a><span id="l8.663" class="difflineminus">-      const kFilePickerContractID = &quot;@mozilla.org/filepicker;1&quot;;</span>
<a href="#l8.664"></a><span id="l8.664" class="difflineminus">-      const kFilePickerIID = Components.interfaces.nsIFilePicker;</span>
<a href="#l8.665"></a><span id="l8.665" class="difflineminus">-      const kFilePicker = Components.classes[kFilePickerContractID].createInstance(kFilePickerIID);</span>
<a href="#l8.666"></a><span id="l8.666" class="difflineminus">-    </span>
<a href="#l8.667"></a><span id="l8.667" class="difflineminus">-      const kTitle = BookmarksUtils.getLocaleString(&quot;SelectImport&quot;);</span>
<a href="#l8.668"></a><span id="l8.668" class="difflineminus">-      kFilePicker.init(window, kTitle, kFilePickerIID[&quot;modeOpen&quot;]);</span>
<a href="#l8.669"></a><span id="l8.669" class="difflineminus">-      kFilePicker.appendFilters(kFilePickerIID.filterHTML | kFilePickerIID.filterAll);</span>
<a href="#l8.670"></a><span id="l8.670" class="difflineminus">-      var fileName;</span>
<a href="#l8.671"></a><span id="l8.671" class="difflineminus">-      if (kFilePicker.show() != kFilePickerIID.returnCancel) {</span>
<a href="#l8.672"></a><span id="l8.672" class="difflineminus">-        fileName = kFilePicker.file.path;</span>
<a href="#l8.673"></a><span id="l8.673" class="difflineminus">-        if (!fileName) return;</span>
<a href="#l8.674"></a><span id="l8.674" class="difflineminus">-      }</span>
<a href="#l8.675"></a><span id="l8.675" class="difflineminus">-      else return;</span>
<a href="#l8.676"></a><span id="l8.676" class="difflineminus">-    }</span>
<a href="#l8.677"></a><span id="l8.677" class="difflineminus">-    catch (e) {</span>
<a href="#l8.678"></a><span id="l8.678" class="difflineminus">-      return;</span>
<a href="#l8.679"></a><span id="l8.679" class="difflineminus">-    }</span>
<a href="#l8.680"></a><span id="l8.680" class="difflineminus">-    var rTarget = BookmarksUtils.getNewBookmarkFolder();</span>
<a href="#l8.681"></a><span id="l8.681" class="difflineminus">-    RDFC.Init(BMDS, rTarget);</span>
<a href="#l8.682"></a><span id="l8.682" class="difflineminus">-    var index = RDFC.GetCount();</span>
<a href="#l8.683"></a><span id="l8.683" class="difflineminus">-    var args = [{ property: NC_NS+&quot;URL&quot;, literal: fileName}];</span>
<a href="#l8.684"></a><span id="l8.684" class="difflineminus">-    this.doBookmarksCommand(rTarget, NC_NS_CMD+&quot;import&quot;, args);</span>
<a href="#l8.685"></a><span id="l8.685" class="difflineminus">-    RDFC.Init(BMDS, rTarget); // changing the selection clobbers RDFC</span>
<a href="#l8.686"></a><span id="l8.686" class="difflineminus">-    var count = RDFC.GetCount();</span>
<a href="#l8.687"></a><span id="l8.687" class="difflineminus">-    if (index == count)</span>
<a href="#l8.688"></a><span id="l8.688" class="difflineminus">-      return;</span>
<a href="#l8.689"></a><span id="l8.689" class="difflineminus">-</span>
<a href="#l8.690"></a><span id="l8.690" class="difflineminus">-    var txmgr = BMSVC.transactionManager;</span>
<a href="#l8.691"></a><span id="l8.691" class="difflineminus">-    txmgr.beginBatch();</span>
<a href="#l8.692"></a><span id="l8.692" class="difflineminus">-    while (++index &lt;= count) {</span>
<a href="#l8.693"></a><span id="l8.693" class="difflineminus">-      var rChild = RDFC.RemoveElementAt(index, true);</span>
<a href="#l8.694"></a><span id="l8.694" class="difflineminus">-      var txn = BMSVC.createTransaction(rTarget, rChild, index, false);</span>
<a href="#l8.695"></a><span id="l8.695" class="difflineminus">-      txmgr.doTransaction(txn);</span>
<a href="#l8.696"></a><span id="l8.696" class="difflineminus">-    }</span>
<a href="#l8.697"></a><span id="l8.697" class="difflineminus">-    txmgr.endBatch();</span>
<a href="#l8.698"></a><span id="l8.698" class="difflineminus">-    BookmarksUtils.flushDataSource();</span>
<a href="#l8.699"></a><span id="l8.699" class="difflineminus">-  },</span>
<a href="#l8.700"></a><span id="l8.700" class="difflineminus">-</span>
<a href="#l8.701"></a><span id="l8.701" class="difflineminus">-  exportBookmarks: function ()</span>
<a href="#l8.702"></a><span id="l8.702" class="difflineminus">-  {</span>
<a href="#l8.703"></a><span id="l8.703" class="difflineminus">-    try {</span>
<a href="#l8.704"></a><span id="l8.704" class="difflineminus">-      const kFilePickerContractID = &quot;@mozilla.org/filepicker;1&quot;;</span>
<a href="#l8.705"></a><span id="l8.705" class="difflineminus">-      const kFilePickerIID = Components.interfaces.nsIFilePicker;</span>
<a href="#l8.706"></a><span id="l8.706" class="difflineminus">-      const kFilePicker = Components.classes[kFilePickerContractID].createInstance(kFilePickerIID);</span>
<a href="#l8.707"></a><span id="l8.707" class="difflineminus">-      </span>
<a href="#l8.708"></a><span id="l8.708" class="difflineminus">-      const kTitle = BookmarksUtils.getLocaleString(&quot;EnterExport&quot;);</span>
<a href="#l8.709"></a><span id="l8.709" class="difflineminus">-      kFilePicker.init(window, kTitle, kFilePickerIID[&quot;modeSave&quot;]);</span>
<a href="#l8.710"></a><span id="l8.710" class="difflineminus">-      kFilePicker.appendFilters(kFilePickerIID.filterHTML | kFilePickerIID.filterAll);</span>
<a href="#l8.711"></a><span id="l8.711" class="difflineminus">-      kFilePicker.defaultString = &quot;bookmarks.html&quot;;</span>
<a href="#l8.712"></a><span id="l8.712" class="difflineminus">-      var fileName;</span>
<a href="#l8.713"></a><span id="l8.713" class="difflineminus">-      if (kFilePicker.show() != kFilePickerIID.returnCancel) {</span>
<a href="#l8.714"></a><span id="l8.714" class="difflineminus">-        fileName = kFilePicker.file.path;</span>
<a href="#l8.715"></a><span id="l8.715" class="difflineminus">-        if (!fileName) return;</span>
<a href="#l8.716"></a><span id="l8.716" class="difflineminus">-      }</span>
<a href="#l8.717"></a><span id="l8.717" class="difflineminus">-      else return;</span>
<a href="#l8.718"></a><span id="l8.718" class="difflineminus">-</span>
<a href="#l8.719"></a><span id="l8.719" class="difflineminus">-      var file = Components.classes[&quot;@mozilla.org/file/local;1&quot;]</span>
<a href="#l8.720"></a><span id="l8.720" class="difflineminus">-                           .createInstance(Components.interfaces.nsILocalFile);</span>
<a href="#l8.721"></a><span id="l8.721" class="difflineminus">-      if (!file)</span>
<a href="#l8.722"></a><span id="l8.722" class="difflineminus">-        return;</span>
<a href="#l8.723"></a><span id="l8.723" class="difflineminus">-      file.initWithPath(fileName);</span>
<a href="#l8.724"></a><span id="l8.724" class="difflineminus">-      if (!file.exists()) {</span>
<a href="#l8.725"></a><span id="l8.725" class="difflineminus">-        file.create(Components.interfaces.nsIFile.NORMAL_FILE_TYPE, 0644);</span>
<a href="#l8.726"></a><span id="l8.726" class="difflineminus">-      }</span>
<a href="#l8.727"></a><span id="l8.727" class="difflineminus">-    }</span>
<a href="#l8.728"></a><span id="l8.728" class="difflineminus">-    catch (e) {</span>
<a href="#l8.729"></a><span id="l8.729" class="difflineminus">-      return;</span>
<a href="#l8.730"></a><span id="l8.730" class="difflineminus">-    }</span>
<a href="#l8.731"></a><span id="l8.731" class="difflineminus">-    var selection = RDF.GetResource(&quot;NC:BookmarksRoot&quot;);</span>
<a href="#l8.732"></a><span id="l8.732" class="difflineminus">-    var args = [{ property: NC_NS+&quot;URL&quot;, literal: fileName}];</span>
<a href="#l8.733"></a><span id="l8.733" class="difflineminus">-    this.doBookmarksCommand(selection, NC_NS_CMD+&quot;export&quot;, args);</span>
<a href="#l8.734"></a><span id="l8.734" class="difflineminus">-  },</span>
<a href="#l8.735"></a><span id="l8.735" class="difflineminus">-</span>
<a href="#l8.736"></a><span id="l8.736" class="difflineminus">-  sortFolderByName: function(aSelection)</span>
<a href="#l8.737"></a><span id="l8.737" class="difflineminus">-  {</span>
<a href="#l8.738"></a><span id="l8.738" class="difflineminus">-    var folder;</span>
<a href="#l8.739"></a><span id="l8.739" class="difflineminus">-    var type = aSelection.type[0];</span>
<a href="#l8.740"></a><span id="l8.740" class="difflineminus">-    if (type == &quot;Bookmark&quot;)</span>
<a href="#l8.741"></a><span id="l8.741" class="difflineminus">-      folder = RDF.GetResource(aSelection.parent[0].Value);</span>
<a href="#l8.742"></a><span id="l8.742" class="difflineminus">-    else {</span>
<a href="#l8.743"></a><span id="l8.743" class="difflineminus">-      folder = RDF.GetResource(aSelection.item[0].Value);</span>
<a href="#l8.744"></a><span id="l8.744" class="difflineminus">-    }</span>
<a href="#l8.745"></a><span id="l8.745" class="difflineminus">-    var property = RDF.GetResource(NC_NS + &quot;Name&quot;);</span>
<a href="#l8.746"></a><span id="l8.746" class="difflineminus">-    BMDS.sortFolder(folder, property, kBMSVCIID.SORT_ASCENDING, true, false);</span>
<a href="#l8.747"></a><span id="l8.747" class="difflineminus">-  },</span>
<a href="#l8.748"></a><span id="l8.748" class="difflineminus">-</span>
<a href="#l8.749"></a><span id="l8.749" class="difflineminus">-  sortFolder: function(aSelection)</span>
<a href="#l8.750"></a><span id="l8.750" class="difflineminus">-  {</span>
<a href="#l8.751"></a><span id="l8.751" class="difflineminus">-    var folder;</span>
<a href="#l8.752"></a><span id="l8.752" class="difflineminus">-    var type = aSelection.type[0];</span>
<a href="#l8.753"></a><span id="l8.753" class="difflineminus">-    if (type == &quot;Bookmark&quot;)</span>
<a href="#l8.754"></a><span id="l8.754" class="difflineminus">-      folder = RDF.GetResource(aSelection.parent[0].Value);</span>
<a href="#l8.755"></a><span id="l8.755" class="difflineminus">-    else {</span>
<a href="#l8.756"></a><span id="l8.756" class="difflineminus">-      folder = RDF.GetResource(aSelection.item[0].Value);</span>
<a href="#l8.757"></a><span id="l8.757" class="difflineminus">-    }</span>
<a href="#l8.758"></a><span id="l8.758" class="difflineminus">-</span>
<a href="#l8.759"></a><span id="l8.759" class="difflineminus">-    var sortOptions = { accepted : false };</span>
<a href="#l8.760"></a><span id="l8.760" class="difflineminus">-    openDialog(&quot;chrome://communicator/content/bookmarks/sortFolder.xul&quot;,</span>
<a href="#l8.761"></a><span id="l8.761" class="difflineminus">-               &quot;sortFolder&quot;,</span>
<a href="#l8.762"></a><span id="l8.762" class="difflineminus">-               &quot;centerscreen,chrome,dependent,resizable=no,modal=yes&quot;,</span>
<a href="#l8.763"></a><span id="l8.763" class="difflineminus">-               sortOptions);</span>
<a href="#l8.764"></a><span id="l8.764" class="difflineminus">-</span>
<a href="#l8.765"></a><span id="l8.765" class="difflineminus">-    if (sortOptions.accepted) {</span>
<a href="#l8.766"></a><span id="l8.766" class="difflineminus">-      var property = BookmarksUtils.getResource(sortOptions.sortBy);</span>
<a href="#l8.767"></a><span id="l8.767" class="difflineminus">-      var direction = sortOptions.sortOrder == &quot;ascending&quot;</span>
<a href="#l8.768"></a><span id="l8.768" class="difflineminus">-                      ? kBMSVCIID.SORT_ASCENDING : kBMSVCIID.SORT_DESCENDING;</span>
<a href="#l8.769"></a><span id="l8.769" class="difflineminus">-      var foldersFirst = sortOptions.sortFoldersFirst;</span>
<a href="#l8.770"></a><span id="l8.770" class="difflineminus">-      var recurse = sortOptions.sortRecursively;</span>
<a href="#l8.771"></a><span id="l8.771" class="difflineminus">-      BMDS.sortFolder(folder, property, direction, foldersFirst, recurse);</span>
<a href="#l8.772"></a><span id="l8.772" class="difflineminus">-    }</span>
<a href="#l8.773"></a><span id="l8.773" class="difflineminus">-  }</span>
<a href="#l8.774"></a><span id="l8.774" class="difflineminus">-}</span>
<a href="#l8.775"></a><span id="l8.775" class="difflineminus">-</span>
<a href="#l8.776"></a><span id="l8.776" class="difflineminus">-  /////////////////////////////////////////////////////////////////////////////</span>
<a href="#l8.777"></a><span id="l8.777" class="difflineminus">-  // Command handling &amp; Updating.</span>
<a href="#l8.778"></a><span id="l8.778" class="difflineminus">-var BookmarksController = {</span>
<a href="#l8.779"></a><span id="l8.779" class="difflineminus">-</span>
<a href="#l8.780"></a><span id="l8.780" class="difflineminus">-  supportsCommand: function (aCommand)</span>
<a href="#l8.781"></a><span id="l8.781" class="difflineminus">-  {</span>
<a href="#l8.782"></a><span id="l8.782" class="difflineminus">-    var isCommandSupported;</span>
<a href="#l8.783"></a><span id="l8.783" class="difflineminus">-    switch(aCommand) {</span>
<a href="#l8.784"></a><span id="l8.784" class="difflineminus">-    case &quot;cmd_undo&quot;:</span>
<a href="#l8.785"></a><span id="l8.785" class="difflineminus">-    case &quot;cmd_redo&quot;:</span>
<a href="#l8.786"></a><span id="l8.786" class="difflineminus">-    case &quot;cmd_bm_undo&quot;:</span>
<a href="#l8.787"></a><span id="l8.787" class="difflineminus">-    case &quot;cmd_bm_redo&quot;:</span>
<a href="#l8.788"></a><span id="l8.788" class="difflineminus">-    case &quot;cmd_bm_cut&quot;:</span>
<a href="#l8.789"></a><span id="l8.789" class="difflineminus">-    case &quot;cmd_bm_copy&quot;:</span>
<a href="#l8.790"></a><span id="l8.790" class="difflineminus">-    case &quot;cmd_bm_paste&quot;:</span>
<a href="#l8.791"></a><span id="l8.791" class="difflineminus">-    case &quot;cmd_bm_delete&quot;:</span>
<a href="#l8.792"></a><span id="l8.792" class="difflineminus">-    case &quot;cmd_bm_selectAll&quot;:</span>
<a href="#l8.793"></a><span id="l8.793" class="difflineminus">-    case &quot;cmd_bm_open&quot;:</span>
<a href="#l8.794"></a><span id="l8.794" class="difflineminus">-    case &quot;cmd_bm_openinnewwindow&quot;:</span>
<a href="#l8.795"></a><span id="l8.795" class="difflineminus">-    case &quot;cmd_bm_openinnewtab&quot;:</span>
<a href="#l8.796"></a><span id="l8.796" class="difflineminus">-    case &quot;cmd_bm_expandfolder&quot;:</span>
<a href="#l8.797"></a><span id="l8.797" class="difflineminus">-    case &quot;cmd_bm_managefolder&quot;:</span>
<a href="#l8.798"></a><span id="l8.798" class="difflineminus">-    case &quot;cmd_bm_newbookmark&quot;:</span>
<a href="#l8.799"></a><span id="l8.799" class="difflineminus">-    case &quot;cmd_bm_newfolder&quot;:</span>
<a href="#l8.800"></a><span id="l8.800" class="difflineminus">-    case &quot;cmd_bm_newseparator&quot;:</span>
<a href="#l8.801"></a><span id="l8.801" class="difflineminus">-    case &quot;cmd_bm_find&quot;:</span>
<a href="#l8.802"></a><span id="l8.802" class="difflineminus">-    case &quot;cmd_bm_properties&quot;:</span>
<a href="#l8.803"></a><span id="l8.803" class="difflineminus">-    case &quot;cmd_bm_rename&quot;:</span>
<a href="#l8.804"></a><span id="l8.804" class="difflineminus">-    case &quot;cmd_bm_setnewbookmarkfolder&quot;:</span>
<a href="#l8.805"></a><span id="l8.805" class="difflineminus">-    case &quot;cmd_bm_setpersonaltoolbarfolder&quot;:</span>
<a href="#l8.806"></a><span id="l8.806" class="difflineminus">-    case &quot;cmd_bm_setnewsearchfolder&quot;:</span>
<a href="#l8.807"></a><span id="l8.807" class="difflineminus">-    case &quot;cmd_bm_import&quot;:</span>
<a href="#l8.808"></a><span id="l8.808" class="difflineminus">-    case &quot;cmd_bm_export&quot;:</span>
<a href="#l8.809"></a><span id="l8.809" class="difflineminus">-    case &quot;cmd_bm_movebookmark&quot;:</span>
<a href="#l8.810"></a><span id="l8.810" class="difflineminus">-    case &quot;cmd_bm_sortfolderbyname&quot;:</span>
<a href="#l8.811"></a><span id="l8.811" class="difflineminus">-    case &quot;cmd_bm_sortfolder&quot;:</span>
<a href="#l8.812"></a><span id="l8.812" class="difflineminus">-      isCommandSupported = true;</span>
<a href="#l8.813"></a><span id="l8.813" class="difflineminus">-      break;</span>
<a href="#l8.814"></a><span id="l8.814" class="difflineminus">-    default:</span>
<a href="#l8.815"></a><span id="l8.815" class="difflineminus">-      isCommandSupported = false;</span>
<a href="#l8.816"></a><span id="l8.816" class="difflineminus">-    }</span>
<a href="#l8.817"></a><span id="l8.817" class="difflineminus">-    //if (!isCommandSupported)</span>
<a href="#l8.818"></a><span id="l8.818" class="difflineminus">-    //  dump(&quot;Bookmark command '&quot;+aCommand+&quot;' is not supported!\n&quot;);</span>
<a href="#l8.819"></a><span id="l8.819" class="difflineminus">-    return isCommandSupported;</span>
<a href="#l8.820"></a><span id="l8.820" class="difflineminus">-  },</span>
<a href="#l8.821"></a><span id="l8.821" class="difflineminus">-</span>
<a href="#l8.822"></a><span id="l8.822" class="difflineminus">-  isCommandEnabled: function (aCommand, aSelection, aTarget)</span>
<a href="#l8.823"></a><span id="l8.823" class="difflineminus">-  {</span>
<a href="#l8.824"></a><span id="l8.824" class="difflineminus">-    var item0, type0;</span>
<a href="#l8.825"></a><span id="l8.825" class="difflineminus">-    var length = aSelection.length;</span>
<a href="#l8.826"></a><span id="l8.826" class="difflineminus">-    if (length != 0) {</span>
<a href="#l8.827"></a><span id="l8.827" class="difflineminus">-      item0 = aSelection.item[0].Value;</span>
<a href="#l8.828"></a><span id="l8.828" class="difflineminus">-      type0 = aSelection.type[0];</span>
<a href="#l8.829"></a><span id="l8.829" class="difflineminus">-    }</span>
<a href="#l8.830"></a><span id="l8.830" class="difflineminus">-    var i;</span>
<a href="#l8.831"></a><span id="l8.831" class="difflineminus">-</span>
<a href="#l8.832"></a><span id="l8.832" class="difflineminus">-    switch(aCommand) {</span>
<a href="#l8.833"></a><span id="l8.833" class="difflineminus">-    case &quot;cmd_undo&quot;:</span>
<a href="#l8.834"></a><span id="l8.834" class="difflineminus">-    case &quot;cmd_bm_undo&quot;:</span>
<a href="#l8.835"></a><span id="l8.835" class="difflineminus">-      return BMSVC.transactionManager.numberOfUndoItems &gt; 0;</span>
<a href="#l8.836"></a><span id="l8.836" class="difflineminus">-    case &quot;cmd_redo&quot;:</span>
<a href="#l8.837"></a><span id="l8.837" class="difflineminus">-    case &quot;cmd_bm_redo&quot;:</span>
<a href="#l8.838"></a><span id="l8.838" class="difflineminus">-      return BMSVC.transactionManager.numberOfRedoItems &gt; 0;</span>
<a href="#l8.839"></a><span id="l8.839" class="difflineminus">-    case &quot;cmd_bm_paste&quot;:</span>
<a href="#l8.840"></a><span id="l8.840" class="difflineminus">-      if (!(aTarget &amp;&amp; BookmarksUtils.isValidTargetContainer(aTarget.parent)))</span>
<a href="#l8.841"></a><span id="l8.841" class="difflineminus">-        return false;</span>
<a href="#l8.842"></a><span id="l8.842" class="difflineminus">-      const kClipboardContractID = &quot;@mozilla.org/widget/clipboard;1&quot;;</span>
<a href="#l8.843"></a><span id="l8.843" class="difflineminus">-      const kClipboardIID = Components.interfaces.nsIClipboard;</span>
<a href="#l8.844"></a><span id="l8.844" class="difflineminus">-      var clipboard = Components.classes[kClipboardContractID].getService(kClipboardIID);</span>
<a href="#l8.845"></a><span id="l8.845" class="difflineminus">-      var flavorArray = [&quot;moz/bookmarkclipboarditem&quot;, &quot;text/x-moz-url&quot;];</span>
<a href="#l8.846"></a><span id="l8.846" class="difflineminus">-      var hasFlavours =</span>
<a href="#l8.847"></a><span id="l8.847" class="difflineminus">-        clipboard.hasDataMatchingFlavors(flavorArray,</span>
<a href="#l8.848"></a><span id="l8.848" class="difflineminus">-                                         flavorArray.length,</span>
<a href="#l8.849"></a><span id="l8.849" class="difflineminus">-                                         kClipboardIID.kGlobalClipboard);</span>
<a href="#l8.850"></a><span id="l8.850" class="difflineminus">-      return hasFlavours;</span>
<a href="#l8.851"></a><span id="l8.851" class="difflineminus">-    case &quot;cmd_bm_copy&quot;:</span>
<a href="#l8.852"></a><span id="l8.852" class="difflineminus">-      return length &gt; 0;</span>
<a href="#l8.853"></a><span id="l8.853" class="difflineminus">-    case &quot;cmd_bm_cut&quot;:</span>
<a href="#l8.854"></a><span id="l8.854" class="difflineminus">-    case &quot;cmd_bm_delete&quot;:</span>
<a href="#l8.855"></a><span id="l8.855" class="difflineminus">-      return length &gt; 0 &amp;&amp; aSelection.containsMutable &amp;&amp; !aSelection.containsPTF;</span>
<a href="#l8.856"></a><span id="l8.856" class="difflineminus">-    case &quot;cmd_bm_selectAll&quot;:</span>
<a href="#l8.857"></a><span id="l8.857" class="difflineminus">-      return true;</span>
<a href="#l8.858"></a><span id="l8.858" class="difflineminus">-    case &quot;cmd_bm_open&quot;:</span>
<a href="#l8.859"></a><span id="l8.859" class="difflineminus">-    case &quot;cmd_bm_expandfolder&quot;:</span>
<a href="#l8.860"></a><span id="l8.860" class="difflineminus">-    case &quot;cmd_bm_managefolder&quot;:</span>
<a href="#l8.861"></a><span id="l8.861" class="difflineminus">-      return length == 1;</span>
<a href="#l8.862"></a><span id="l8.862" class="difflineminus">-    case &quot;cmd_bm_openinnewwindow&quot;:</span>
<a href="#l8.863"></a><span id="l8.863" class="difflineminus">-    case &quot;cmd_bm_openinnewtab&quot;:</span>
<a href="#l8.864"></a><span id="l8.864" class="difflineminus">-    case &quot;cmd_bm_find&quot;:</span>
<a href="#l8.865"></a><span id="l8.865" class="difflineminus">-    case &quot;cmd_bm_import&quot;:</span>
<a href="#l8.866"></a><span id="l8.866" class="difflineminus">-    case &quot;cmd_bm_export&quot;:</span>
<a href="#l8.867"></a><span id="l8.867" class="difflineminus">-      return true;</span>
<a href="#l8.868"></a><span id="l8.868" class="difflineminus">-    case &quot;cmd_bm_newbookmark&quot;:</span>
<a href="#l8.869"></a><span id="l8.869" class="difflineminus">-    case &quot;cmd_bm_newfolder&quot;:</span>
<a href="#l8.870"></a><span id="l8.870" class="difflineminus">-    case &quot;cmd_bm_newseparator&quot;:</span>
<a href="#l8.871"></a><span id="l8.871" class="difflineminus">-      return (aTarget &amp;&amp;</span>
<a href="#l8.872"></a><span id="l8.872" class="difflineminus">-              BookmarksUtils.isValidTargetContainer(aTarget.parent));</span>
<a href="#l8.873"></a><span id="l8.873" class="difflineminus">-    case &quot;cmd_bm_properties&quot;:</span>
<a href="#l8.874"></a><span id="l8.874" class="difflineminus">-    case &quot;cmd_bm_rename&quot;:</span>
<a href="#l8.875"></a><span id="l8.875" class="difflineminus">-    case &quot;cmd_bm_sortfolderbyname&quot;:</span>
<a href="#l8.876"></a><span id="l8.876" class="difflineminus">-    case &quot;cmd_bm_sortfolder&quot;:</span>
<a href="#l8.877"></a><span id="l8.877" class="difflineminus">-      return length == 1;</span>
<a href="#l8.878"></a><span id="l8.878" class="difflineminus">-    case &quot;cmd_bm_setnewbookmarkfolder&quot;:</span>
<a href="#l8.879"></a><span id="l8.879" class="difflineminus">-      if (length != 1) </span>
<a href="#l8.880"></a><span id="l8.880" class="difflineminus">-        return false;</span>
<a href="#l8.881"></a><span id="l8.881" class="difflineminus">-      return item0 != &quot;NC:NewBookmarkFolder&quot;     &amp;&amp;</span>
<a href="#l8.882"></a><span id="l8.882" class="difflineminus">-             (type0 == &quot;Folder&quot; || type0 == &quot;PersonalToolbarFolder&quot;);</span>
<a href="#l8.883"></a><span id="l8.883" class="difflineminus">-    case &quot;cmd_bm_setpersonaltoolbarfolder&quot;:</span>
<a href="#l8.884"></a><span id="l8.884" class="difflineminus">-      if (length != 1)</span>
<a href="#l8.885"></a><span id="l8.885" class="difflineminus">-        return false;</span>
<a href="#l8.886"></a><span id="l8.886" class="difflineminus">-      return item0 != &quot;NC:PersonalToolbarFolder&quot; &amp;&amp;</span>
<a href="#l8.887"></a><span id="l8.887" class="difflineminus">-             item0 != &quot;NC:BookmarksRoot&quot; &amp;&amp; type0 == &quot;Folder&quot;;</span>
<a href="#l8.888"></a><span id="l8.888" class="difflineminus">-    case &quot;cmd_bm_setnewsearchfolder&quot;:</span>
<a href="#l8.889"></a><span id="l8.889" class="difflineminus">-      if (length != 1)</span>
<a href="#l8.890"></a><span id="l8.890" class="difflineminus">-        return false;</span>
<a href="#l8.891"></a><span id="l8.891" class="difflineminus">-      return item0 != &quot;NC:NewSearchFolder&quot;       &amp;&amp; </span>
<a href="#l8.892"></a><span id="l8.892" class="difflineminus">-             (type0 == &quot;Folder&quot; || type0 == &quot;PersonalToolbarFolder&quot;);</span>
<a href="#l8.893"></a><span id="l8.893" class="difflineminus">-    case &quot;cmd_bm_movebookmark&quot;:</span>
<a href="#l8.894"></a><span id="l8.894" class="difflineminus">-      return length &gt; 0 &amp;&amp; !aSelection.containsRF;</span>
<a href="#l8.895"></a><span id="l8.895" class="difflineminus">-    default:</span>
<a href="#l8.896"></a><span id="l8.896" class="difflineminus">-      return false;</span>
<a href="#l8.897"></a><span id="l8.897" class="difflineminus">-    }</span>
<a href="#l8.898"></a><span id="l8.898" class="difflineminus">-  },</span>
<a href="#l8.899"></a><span id="l8.899" class="difflineminus">-</span>
<a href="#l8.900"></a><span id="l8.900" class="difflineminus">-  doCommand: function (aCommand, aSelection, aTarget)</span>
<a href="#l8.901"></a><span id="l8.901" class="difflineminus">-  {</span>
<a href="#l8.902"></a><span id="l8.902" class="difflineminus">-    switch (aCommand) {</span>
<a href="#l8.903"></a><span id="l8.903" class="difflineminus">-    case &quot;cmd_undo&quot;:</span>
<a href="#l8.904"></a><span id="l8.904" class="difflineminus">-    case &quot;cmd_bm_undo&quot;:</span>
<a href="#l8.905"></a><span id="l8.905" class="difflineminus">-      BookmarksCommand.undoBookmarkTransaction();</span>
<a href="#l8.906"></a><span id="l8.906" class="difflineminus">-      break;</span>
<a href="#l8.907"></a><span id="l8.907" class="difflineminus">-    case &quot;cmd_redo&quot;:</span>
<a href="#l8.908"></a><span id="l8.908" class="difflineminus">-    case &quot;cmd_bm_redo&quot;:</span>
<a href="#l8.909"></a><span id="l8.909" class="difflineminus">-      BookmarksCommand.redoBookmarkTransaction();</span>
<a href="#l8.910"></a><span id="l8.910" class="difflineminus">-      break;</span>
<a href="#l8.911"></a><span id="l8.911" class="difflineminus">-    case &quot;cmd_bm_open&quot;:</span>
<a href="#l8.912"></a><span id="l8.912" class="difflineminus">-      BookmarksCommand.openBookmark(aSelection, &quot;current&quot;);</span>
<a href="#l8.913"></a><span id="l8.913" class="difflineminus">-      break;</span>
<a href="#l8.914"></a><span id="l8.914" class="difflineminus">-    case &quot;cmd_bm_openinnewwindow&quot;:</span>
<a href="#l8.915"></a><span id="l8.915" class="difflineminus">-      BookmarksCommand.openBookmark(aSelection, &quot;window&quot;);</span>
<a href="#l8.916"></a><span id="l8.916" class="difflineminus">-      break;</span>
<a href="#l8.917"></a><span id="l8.917" class="difflineminus">-    case &quot;cmd_bm_openinnewtab&quot;:</span>
<a href="#l8.918"></a><span id="l8.918" class="difflineminus">-      BookmarksCommand.openBookmark(aSelection, &quot;tab&quot;);</span>
<a href="#l8.919"></a><span id="l8.919" class="difflineminus">-      break;</span>
<a href="#l8.920"></a><span id="l8.920" class="difflineminus">-    case &quot;cmd_bm_managefolder&quot;:</span>
<a href="#l8.921"></a><span id="l8.921" class="difflineminus">-      BookmarksCommand.manageFolder(aSelection);</span>
<a href="#l8.922"></a><span id="l8.922" class="difflineminus">-      break;</span>
<a href="#l8.923"></a><span id="l8.923" class="difflineminus">-    case &quot;cmd_bm_setnewbookmarkfolder&quot;:</span>
<a href="#l8.924"></a><span id="l8.924" class="difflineminus">-    case &quot;cmd_bm_setpersonaltoolbarfolder&quot;:</span>
<a href="#l8.925"></a><span id="l8.925" class="difflineminus">-    case &quot;cmd_bm_setnewsearchfolder&quot;:</span>
<a href="#l8.926"></a><span id="l8.926" class="difflineminus">-      BookmarksCommand.doBookmarksCommand(aSelection.item[0], NC_NS_CMD+aCommand.substring(&quot;cmd_bm_&quot;.length), []);</span>
<a href="#l8.927"></a><span id="l8.927" class="difflineminus">-      break;</span>
<a href="#l8.928"></a><span id="l8.928" class="difflineminus">-    case &quot;cmd_bm_rename&quot;:</span>
<a href="#l8.929"></a><span id="l8.929" class="difflineminus">-    case &quot;cmd_bm_properties&quot;:</span>
<a href="#l8.930"></a><span id="l8.930" class="difflineminus">-      BookmarksCommand.openBookmarkProperties(aSelection);</span>
<a href="#l8.931"></a><span id="l8.931" class="difflineminus">-      break;</span>
<a href="#l8.932"></a><span id="l8.932" class="difflineminus">-    case &quot;cmd_bm_find&quot;:</span>
<a href="#l8.933"></a><span id="l8.933" class="difflineminus">-      BookmarksCommand.findBookmark();</span>
<a href="#l8.934"></a><span id="l8.934" class="difflineminus">-      break;</span>
<a href="#l8.935"></a><span id="l8.935" class="difflineminus">-    case &quot;cmd_bm_cut&quot;:</span>
<a href="#l8.936"></a><span id="l8.936" class="difflineminus">-      BookmarksCommand.cutBookmark(aSelection);</span>
<a href="#l8.937"></a><span id="l8.937" class="difflineminus">-      break;</span>
<a href="#l8.938"></a><span id="l8.938" class="difflineminus">-    case &quot;cmd_bm_copy&quot;:</span>
<a href="#l8.939"></a><span id="l8.939" class="difflineminus">-      BookmarksCommand.copyBookmark(aSelection);</span>
<a href="#l8.940"></a><span id="l8.940" class="difflineminus">-      break;</span>
<a href="#l8.941"></a><span id="l8.941" class="difflineminus">-    case &quot;cmd_bm_paste&quot;:</span>
<a href="#l8.942"></a><span id="l8.942" class="difflineminus">-      BookmarksCommand.pasteBookmark(aTarget);</span>
<a href="#l8.943"></a><span id="l8.943" class="difflineminus">-      break;</span>
<a href="#l8.944"></a><span id="l8.944" class="difflineminus">-    case &quot;cmd_bm_delete&quot;:</span>
<a href="#l8.945"></a><span id="l8.945" class="difflineminus">-      BookmarksCommand.deleteBookmark(aSelection);</span>
<a href="#l8.946"></a><span id="l8.946" class="difflineminus">-      break;</span>
<a href="#l8.947"></a><span id="l8.947" class="difflineminus">-    case &quot;cmd_bm_movebookmark&quot;:</span>
<a href="#l8.948"></a><span id="l8.948" class="difflineminus">-      BookmarksCommand.moveBookmark(aSelection);</span>
<a href="#l8.949"></a><span id="l8.949" class="difflineminus">-      break;</span>
<a href="#l8.950"></a><span id="l8.950" class="difflineminus">-    case &quot;cmd_bm_newfolder&quot;:</span>
<a href="#l8.951"></a><span id="l8.951" class="difflineminus">-      BookmarksCommand.createNewFolder(aTarget);</span>
<a href="#l8.952"></a><span id="l8.952" class="difflineminus">-      break;</span>
<a href="#l8.953"></a><span id="l8.953" class="difflineminus">-    case &quot;cmd_bm_newbookmark&quot;:</span>
<a href="#l8.954"></a><span id="l8.954" class="difflineminus">-      var folder = aTarget.parent.Value;</span>
<a href="#l8.955"></a><span id="l8.955" class="difflineminus">-      var rv = { newBookmark: null };</span>
<a href="#l8.956"></a><span id="l8.956" class="difflineminus">-      openDialog(&quot;chrome://communicator/content/bookmarks/addBookmark.xul&quot;, &quot;&quot;, </span>
<a href="#l8.957"></a><span id="l8.957" class="difflineminus">-                 &quot;centerscreen,chrome,modal=yes,dialog=yes,resizable=yes&quot;, null, null, folder, null, &quot;newBookmark&quot;, rv);</span>
<a href="#l8.958"></a><span id="l8.958" class="difflineminus">-      break;</span>
<a href="#l8.959"></a><span id="l8.959" class="difflineminus">-    case &quot;cmd_bm_newseparator&quot;:</span>
<a href="#l8.960"></a><span id="l8.960" class="difflineminus">-      BookmarksCommand.createNewSeparator(aTarget);</span>
<a href="#l8.961"></a><span id="l8.961" class="difflineminus">-      break;</span>
<a href="#l8.962"></a><span id="l8.962" class="difflineminus">-    case &quot;cmd_bm_import&quot;:</span>
<a href="#l8.963"></a><span id="l8.963" class="difflineminus">-      BookmarksCommand.importBookmarks();</span>
<a href="#l8.964"></a><span id="l8.964" class="difflineminus">-      break;</span>
<a href="#l8.965"></a><span id="l8.965" class="difflineminus">-    case &quot;cmd_bm_export&quot;:</span>
<a href="#l8.966"></a><span id="l8.966" class="difflineminus">-      BookmarksCommand.exportBookmarks();</span>
<a href="#l8.967"></a><span id="l8.967" class="difflineminus">-      break;</span>
<a href="#l8.968"></a><span id="l8.968" class="difflineminus">-    case &quot;cmd_bm_sortfolderbyname&quot;:</span>
<a href="#l8.969"></a><span id="l8.969" class="difflineminus">-      BookmarksCommand.sortFolderByName(aSelection);</span>
<a href="#l8.970"></a><span id="l8.970" class="difflineminus">-      break;</span>
<a href="#l8.971"></a><span id="l8.971" class="difflineminus">-    case &quot;cmd_bm_sortfolder&quot;:</span>
<a href="#l8.972"></a><span id="l8.972" class="difflineminus">-      BookmarksCommand.sortFolder(aSelection);</span>
<a href="#l8.973"></a><span id="l8.973" class="difflineminus">-      break;</span>
<a href="#l8.974"></a><span id="l8.974" class="difflineminus">-    default: </span>
<a href="#l8.975"></a><span id="l8.975" class="difflineminus">-      dump(&quot;Bookmark command &quot;+aCommand+&quot; not handled!\n&quot;);</span>
<a href="#l8.976"></a><span id="l8.976" class="difflineminus">-    }</span>
<a href="#l8.977"></a><span id="l8.977" class="difflineminus">-</span>
<a href="#l8.978"></a><span id="l8.978" class="difflineminus">-  },</span>
<a href="#l8.979"></a><span id="l8.979" class="difflineminus">-</span>
<a href="#l8.980"></a><span id="l8.980" class="difflineminus">-  onCommandUpdate: function (aSelection, aTarget)</span>
<a href="#l8.981"></a><span id="l8.981" class="difflineminus">-  {</span>
<a href="#l8.982"></a><span id="l8.982" class="difflineminus">-    var commands = [&quot;cmd_bm_newbookmark&quot;, &quot;cmd_bm_newfolder&quot;, &quot;cmd_bm_newseparator&quot;, </span>
<a href="#l8.983"></a><span id="l8.983" class="difflineminus">-                    &quot;cmd_bm_properties&quot;, &quot;cmd_bm_rename&quot;, </span>
<a href="#l8.984"></a><span id="l8.984" class="difflineminus">-                    &quot;cmd_bm_copy&quot;, &quot;cmd_bm_paste&quot;, &quot;cmd_bm_cut&quot;, &quot;cmd_bm_delete&quot;,</span>
<a href="#l8.985"></a><span id="l8.985" class="difflineminus">-                    &quot;cmd_bm_setpersonaltoolbarfolder&quot;, </span>
<a href="#l8.986"></a><span id="l8.986" class="difflineminus">-                    &quot;cmd_bm_setnewbookmarkfolder&quot;,</span>
<a href="#l8.987"></a><span id="l8.987" class="difflineminus">-                    &quot;cmd_bm_setnewsearchfolder&quot;, &quot;cmd_bm_movebookmark&quot;, </span>
<a href="#l8.988"></a><span id="l8.988" class="difflineminus">-                    &quot;cmd_bm_managefolder&quot;,</span>
<a href="#l8.989"></a><span id="l8.989" class="difflineminus">-                    &quot;cmd_bm_sortfolder&quot;, &quot;cmd_bm_sortfolderbyname&quot;,</span>
<a href="#l8.990"></a><span id="l8.990" class="difflineminus">-                    &quot;cmd_undo&quot;, &quot;cmd_redo&quot;, &quot;cmd_bm_undo&quot;, &quot;cmd_bm_redo&quot;];</span>
<a href="#l8.991"></a><span id="l8.991" class="difflineminus">-    for (var i = 0; i &lt; commands.length; ++i) {</span>
<a href="#l8.992"></a><span id="l8.992" class="difflineminus">-      var commandNode = document.getElementById(commands[i]);</span>
<a href="#l8.993"></a><span id="l8.993" class="difflineminus">-      if (commandNode) {</span>
<a href="#l8.994"></a><span id="l8.994" class="difflineminus">-        if (this.isCommandEnabled(commands[i], aSelection, aTarget))</span>
<a href="#l8.995"></a><span id="l8.995" class="difflineminus">-          commandNode.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l8.996"></a><span id="l8.996" class="difflineminus">-        else </span>
<a href="#l8.997"></a><span id="l8.997" class="difflineminus">-          commandNode.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l8.998"></a><span id="l8.998" class="difflineminus">-      }</span>
<a href="#l8.999"></a><span id="l8.999" class="difflineminus">-    }</span>
<a href="#l8.1000"></a><span id="l8.1000" class="difflineminus">-  }</span>
<a href="#l8.1001"></a><span id="l8.1001" class="difflineminus">-}</span>
<a href="#l8.1002"></a><span id="l8.1002" class="difflineminus">-</span>
<a href="#l8.1003"></a><span id="l8.1003" class="difflineminus">-function CommandArrayEnumerator (aCommandArray)</span>
<a href="#l8.1004"></a><span id="l8.1004" class="difflineminus">-{</span>
<a href="#l8.1005"></a><span id="l8.1005" class="difflineminus">-  this._inner = [];</span>
<a href="#l8.1006"></a><span id="l8.1006" class="difflineminus">-  for (var i = 0; i &lt; aCommandArray.length; ++i)</span>
<a href="#l8.1007"></a><span id="l8.1007" class="difflineminus">-    this._inner.push(RDF.GetResource(NC_NS_CMD + aCommandArray[i]));</span>
<a href="#l8.1008"></a><span id="l8.1008" class="difflineminus">-    </span>
<a href="#l8.1009"></a><span id="l8.1009" class="difflineminus">-  this._index = 0;</span>
<a href="#l8.1010"></a><span id="l8.1010" class="difflineminus">-}</span>
<a href="#l8.1011"></a><span id="l8.1011" class="difflineminus">-</span>
<a href="#l8.1012"></a><span id="l8.1012" class="difflineminus">-CommandArrayEnumerator.prototype = {</span>
<a href="#l8.1013"></a><span id="l8.1013" class="difflineminus">-  getNext: function () </span>
<a href="#l8.1014"></a><span id="l8.1014" class="difflineminus">-  {</span>
<a href="#l8.1015"></a><span id="l8.1015" class="difflineminus">-    return this._inner[this._index];</span>
<a href="#l8.1016"></a><span id="l8.1016" class="difflineminus">-  },</span>
<a href="#l8.1017"></a><span id="l8.1017" class="difflineminus">-  </span>
<a href="#l8.1018"></a><span id="l8.1018" class="difflineminus">-  hasMoreElements: function ()</span>
<a href="#l8.1019"></a><span id="l8.1019" class="difflineminus">-  {</span>
<a href="#l8.1020"></a><span id="l8.1020" class="difflineminus">-    return this._index &lt; this._inner.length;</span>
<a href="#l8.1021"></a><span id="l8.1021" class="difflineminus">-  }</span>
<a href="#l8.1022"></a><span id="l8.1022" class="difflineminus">-};</span>
<a href="#l8.1023"></a><span id="l8.1023" class="difflineminus">-</span>
<a href="#l8.1024"></a><span id="l8.1024" class="difflineminus">-var BookmarksUtils = {</span>
<a href="#l8.1025"></a><span id="l8.1025" class="difflineminus">-</span>
<a href="#l8.1026"></a><span id="l8.1026" class="difflineminus">-  DROP_BEFORE: Components.interfaces.nsITreeView.DROP_BEFORE,</span>
<a href="#l8.1027"></a><span id="l8.1027" class="difflineminus">-  DROP_ON    : Components.interfaces.nsITreeView.DROP_ON,</span>
<a href="#l8.1028"></a><span id="l8.1028" class="difflineminus">-  DROP_AFTER : Components.interfaces.nsITreeView.DROP_AFTER,</span>
<a href="#l8.1029"></a><span id="l8.1029" class="difflineminus">-</span>
<a href="#l8.1030"></a><span id="l8.1030" class="difflineminus">-  any: function (aArray)</span>
<a href="#l8.1031"></a><span id="l8.1031" class="difflineminus">-  {</span>
<a href="#l8.1032"></a><span id="l8.1032" class="difflineminus">-    for (var i=0; i&lt;aArray.length; ++i)</span>
<a href="#l8.1033"></a><span id="l8.1033" class="difflineminus">-      if (aArray[i]) return true;</span>
<a href="#l8.1034"></a><span id="l8.1034" class="difflineminus">-    return false;</span>
<a href="#l8.1035"></a><span id="l8.1035" class="difflineminus">-  },</span>
<a href="#l8.1036"></a><span id="l8.1036" class="difflineminus">-</span>
<a href="#l8.1037"></a><span id="l8.1037" class="difflineminus">-  all: function (aArray)</span>
<a href="#l8.1038"></a><span id="l8.1038" class="difflineminus">-  {</span>
<a href="#l8.1039"></a><span id="l8.1039" class="difflineminus">-    for (var i=0; i&lt;aArray.length; ++i)</span>
<a href="#l8.1040"></a><span id="l8.1040" class="difflineminus">-      if (!aArray[i]) return false;</span>
<a href="#l8.1041"></a><span id="l8.1041" class="difflineminus">-    return true;</span>
<a href="#l8.1042"></a><span id="l8.1042" class="difflineminus">-  },</span>
<a href="#l8.1043"></a><span id="l8.1043" class="difflineminus">-</span>
<a href="#l8.1044"></a><span id="l8.1044" class="difflineminus">-  _bundle        : null,</span>
<a href="#l8.1045"></a><span id="l8.1045" class="difflineminus">-  _brandShortName: null,</span>
<a href="#l8.1046"></a><span id="l8.1046" class="difflineminus">-</span>
<a href="#l8.1047"></a><span id="l8.1047" class="difflineminus">-  /////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l8.1048"></a><span id="l8.1048" class="difflineminus">-  // returns a property from chrome://communicator/locale/bookmarks/bookmarks.properties</span>
<a href="#l8.1049"></a><span id="l8.1049" class="difflineminus">-  getLocaleString: function (aStringKey, aReplaceString)</span>
<a href="#l8.1050"></a><span id="l8.1050" class="difflineminus">-  {</span>
<a href="#l8.1051"></a><span id="l8.1051" class="difflineminus">-    if (!this._bundle) {</span>
<a href="#l8.1052"></a><span id="l8.1052" class="difflineminus">-      // for those who would xblify Bookmarks.js, there is a need to create string bundle </span>
<a href="#l8.1053"></a><span id="l8.1053" class="difflineminus">-      // manually instead of using &lt;xul:stringbundle/&gt; see bug 63370 for details</span>
<a href="#l8.1054"></a><span id="l8.1054" class="difflineminus">-      var BUNDLESVC = Components.classes[&quot;@mozilla.org/intl/stringbundle;1&quot;]</span>
<a href="#l8.1055"></a><span id="l8.1055" class="difflineminus">-                                .getService(Components.interfaces.nsIStringBundleService);</span>
<a href="#l8.1056"></a><span id="l8.1056" class="difflineminus">-      this._bundle         = BUNDLESVC.createBundle(&quot;chrome://communicator/locale/bookmarks/bookmarks.properties&quot;);</span>
<a href="#l8.1057"></a><span id="l8.1057" class="difflineminus">-      this._brandShortName = BUNDLESVC.createBundle(&quot;chrome://branding/locale/brand.properties&quot;)</span>
<a href="#l8.1058"></a><span id="l8.1058" class="difflineminus">-                                      .GetStringFromName(&quot;brandShortName&quot;);</span>
<a href="#l8.1059"></a><span id="l8.1059" class="difflineminus">-    }</span>
<a href="#l8.1060"></a><span id="l8.1060" class="difflineminus">-   </span>
<a href="#l8.1061"></a><span id="l8.1061" class="difflineminus">-    var bundle;</span>
<a href="#l8.1062"></a><span id="l8.1062" class="difflineminus">-    try {</span>
<a href="#l8.1063"></a><span id="l8.1063" class="difflineminus">-      if (!aReplaceString)</span>
<a href="#l8.1064"></a><span id="l8.1064" class="difflineminus">-        bundle = this._bundle.GetStringFromName(aStringKey);</span>
<a href="#l8.1065"></a><span id="l8.1065" class="difflineminus">-      else if (typeof(aReplaceString) == &quot;string&quot;)</span>
<a href="#l8.1066"></a><span id="l8.1066" class="difflineminus">-        bundle = this._bundle.formatStringFromName(aStringKey, [aReplaceString], 1);</span>
<a href="#l8.1067"></a><span id="l8.1067" class="difflineminus">-      else</span>
<a href="#l8.1068"></a><span id="l8.1068" class="difflineminus">-        bundle = this._bundle.formatStringFromName(aStringKey, aReplaceString, aReplaceString.length);</span>
<a href="#l8.1069"></a><span id="l8.1069" class="difflineminus">-    } catch (e) {</span>
<a href="#l8.1070"></a><span id="l8.1070" class="difflineminus">-      dump(&quot;Bookmark bundle &quot;+aStringKey+&quot; not found!\n&quot;);</span>
<a href="#l8.1071"></a><span id="l8.1071" class="difflineminus">-      bundle = &quot;&quot;;</span>
<a href="#l8.1072"></a><span id="l8.1072" class="difflineminus">-    }</span>
<a href="#l8.1073"></a><span id="l8.1073" class="difflineminus">-</span>
<a href="#l8.1074"></a><span id="l8.1074" class="difflineminus">-    bundle = bundle.replace(/%brandShortName%/, this._brandShortName);</span>
<a href="#l8.1075"></a><span id="l8.1075" class="difflineminus">-    return bundle;</span>
<a href="#l8.1076"></a><span id="l8.1076" class="difflineminus">-  },</span>
<a href="#l8.1077"></a><span id="l8.1077" class="difflineminus">-    </span>
<a href="#l8.1078"></a><span id="l8.1078" class="difflineminus">-  /////////////////////////////////////////////////////////////////////////////</span>
<a href="#l8.1079"></a><span id="l8.1079" class="difflineminus">-  // returns the literal targeted by the URI aArcURI for a resource or uri</span>
<a href="#l8.1080"></a><span id="l8.1080" class="difflineminus">-  getProperty: function (aInput, aArcURI, aDS)</span>
<a href="#l8.1081"></a><span id="l8.1081" class="difflineminus">-  {</span>
<a href="#l8.1082"></a><span id="l8.1082" class="difflineminus">-    var node;</span>
<a href="#l8.1083"></a><span id="l8.1083" class="difflineminus">-    var arc  = RDF.GetResource(aArcURI);</span>
<a href="#l8.1084"></a><span id="l8.1084" class="difflineminus">-    if (typeof(aInput) == &quot;string&quot;) </span>
<a href="#l8.1085"></a><span id="l8.1085" class="difflineminus">-      aInput = RDF.GetResource(aInput);</span>
<a href="#l8.1086"></a><span id="l8.1086" class="difflineminus">-    if (!aDS)</span>
<a href="#l8.1087"></a><span id="l8.1087" class="difflineminus">-      node = BMDS.GetTarget(aInput, arc, true);</span>
<a href="#l8.1088"></a><span id="l8.1088" class="difflineminus">-    else</span>
<a href="#l8.1089"></a><span id="l8.1089" class="difflineminus">-      node = aDS .GetTarget(aInput, arc, true);</span>
<a href="#l8.1090"></a><span id="l8.1090" class="difflineminus">-    return (node instanceof kRDFRSCIID) || (node instanceof kRDFLITIID) ? node.Value : &quot;&quot;;</span>
<a href="#l8.1091"></a><span id="l8.1091" class="difflineminus">-  },</span>
<a href="#l8.1092"></a><span id="l8.1092" class="difflineminus">-</span>
<a href="#l8.1093"></a><span id="l8.1093" class="difflineminus">-  getResource: function (aName)</span>
<a href="#l8.1094"></a><span id="l8.1094" class="difflineminus">-  {</span>
<a href="#l8.1095"></a><span id="l8.1095" class="difflineminus">-    if (aName == &quot;LastModifiedDate&quot; ||</span>
<a href="#l8.1096"></a><span id="l8.1096" class="difflineminus">-        aName == &quot;LastVisitDate&quot;) {</span>
<a href="#l8.1097"></a><span id="l8.1097" class="difflineminus">-      return RDF.GetResource(WEB_NS + aName);</span>
<a href="#l8.1098"></a><span id="l8.1098" class="difflineminus">-    }</span>
<a href="#l8.1099"></a><span id="l8.1099" class="difflineminus">-    else {</span>
<a href="#l8.1100"></a><span id="l8.1100" class="difflineminus">-      return RDF.GetResource(NC_NS + aName);</span>
<a href="#l8.1101"></a><span id="l8.1101" class="difflineminus">-    }</span>
<a href="#l8.1102"></a><span id="l8.1102" class="difflineminus">-  },</span>
<a href="#l8.1103"></a><span id="l8.1103" class="difflineminus">-</span>
<a href="#l8.1104"></a><span id="l8.1104" class="difflineminus">-  /////////////////////////////////////////////////////////////////////////////</span>
<a href="#l8.1105"></a><span id="l8.1105" class="difflineminus">-  // Determine the rdf:type property for the given resource.</span>
<a href="#l8.1106"></a><span id="l8.1106" class="difflineminus">-  resolveType: function (aResource)</span>
<a href="#l8.1107"></a><span id="l8.1107" class="difflineminus">-  {</span>
<a href="#l8.1108"></a><span id="l8.1108" class="difflineminus">-    var type = this.getProperty(aResource, RDF_NS+&quot;type&quot;);</span>
<a href="#l8.1109"></a><span id="l8.1109" class="difflineminus">-    if (type != &quot;&quot;)</span>
<a href="#l8.1110"></a><span id="l8.1110" class="difflineminus">-      type = type.split(&quot;#&quot;)[1];</span>
<a href="#l8.1111"></a><span id="l8.1111" class="difflineminus">-    if (type == &quot;Folder&quot;) {</span>
<a href="#l8.1112"></a><span id="l8.1112" class="difflineminus">-      if (this.isPersonalToolbarFolder(aResource))</span>
<a href="#l8.1113"></a><span id="l8.1113" class="difflineminus">-        type = &quot;PersonalToolbarFolder&quot;;</span>
<a href="#l8.1114"></a><span id="l8.1114" class="difflineminus">-      else if (this.isFolderGroup(aResource))</span>
<a href="#l8.1115"></a><span id="l8.1115" class="difflineminus">-        type = &quot;FolderGroup&quot;;</span>
<a href="#l8.1116"></a><span id="l8.1116" class="difflineminus">-    }</span>
<a href="#l8.1117"></a><span id="l8.1117" class="difflineminus">-    return type;</span>
<a href="#l8.1118"></a><span id="l8.1118" class="difflineminus">-  },</span>
<a href="#l8.1119"></a><span id="l8.1119" class="difflineminus">-</span>
<a href="#l8.1120"></a><span id="l8.1120" class="difflineminus">-  /////////////////////////////////////////////////////////////////////////////</span>
<a href="#l8.1121"></a><span id="l8.1121" class="difflineminus">-  // Returns true if aResource is a folder group</span>
<a href="#l8.1122"></a><span id="l8.1122" class="difflineminus">-  isFolderGroup: function (aResource) {</span>
<a href="#l8.1123"></a><span id="l8.1123" class="difflineminus">-    return this.getProperty(aResource, NC_NS+&quot;FolderGroup&quot;) == &quot;true&quot;;</span>
<a href="#l8.1124"></a><span id="l8.1124" class="difflineminus">-  },</span>
<a href="#l8.1125"></a><span id="l8.1125" class="difflineminus">-</span>
<a href="#l8.1126"></a><span id="l8.1126" class="difflineminus">-  /////////////////////////////////////////////////////////////////////////////</span>
<a href="#l8.1127"></a><span id="l8.1127" class="difflineminus">-  // Returns true if aResource is the Personal Toolbar Folder</span>
<a href="#l8.1128"></a><span id="l8.1128" class="difflineminus">-  isPersonalToolbarFolder: function (aResource) {</span>
<a href="#l8.1129"></a><span id="l8.1129" class="difflineminus">-    return this.getProperty(aResource, NC_NS+&quot;FolderType&quot;) == &quot;NC:PersonalToolbarFolder&quot;;</span>
<a href="#l8.1130"></a><span id="l8.1130" class="difflineminus">-  },</span>
<a href="#l8.1131"></a><span id="l8.1131" class="difflineminus">-</span>
<a href="#l8.1132"></a><span id="l8.1132" class="difflineminus">-  /////////////////////////////////////////////////////////////////////////////</span>
<a href="#l8.1133"></a><span id="l8.1133" class="difflineminus">-  // Returns the folder which 'FolderType' is aProperty</span>
<a href="#l8.1134"></a><span id="l8.1134" class="difflineminus">-  getSpecialFolder: function (aProperty)</span>
<a href="#l8.1135"></a><span id="l8.1135" class="difflineminus">-  {</span>
<a href="#l8.1136"></a><span id="l8.1136" class="difflineminus">-    var sources = BMDS.GetSources(RDF.GetResource(NC_NS+&quot;FolderType&quot;),</span>
<a href="#l8.1137"></a><span id="l8.1137" class="difflineminus">-                                  RDF.GetResource(aProperty), true);</span>
<a href="#l8.1138"></a><span id="l8.1138" class="difflineminus">-    var folder = null;</span>
<a href="#l8.1139"></a><span id="l8.1139" class="difflineminus">-    if (sources.hasMoreElements())</span>
<a href="#l8.1140"></a><span id="l8.1140" class="difflineminus">-      folder = sources.getNext();</span>
<a href="#l8.1141"></a><span id="l8.1141" class="difflineminus">-    else </span>
<a href="#l8.1142"></a><span id="l8.1142" class="difflineminus">-      folder = RDF.GetResource(&quot;NC:BookmarksRoot&quot;);</span>
<a href="#l8.1143"></a><span id="l8.1143" class="difflineminus">-    return folder;</span>
<a href="#l8.1144"></a><span id="l8.1144" class="difflineminus">-  },</span>
<a href="#l8.1145"></a><span id="l8.1145" class="difflineminus">-</span>
<a href="#l8.1146"></a><span id="l8.1146" class="difflineminus">-  /////////////////////////////////////////////////////////////////////////////</span>
<a href="#l8.1147"></a><span id="l8.1147" class="difflineminus">-  // Returns the New Bookmark Folder</span>
<a href="#l8.1148"></a><span id="l8.1148" class="difflineminus">-  getNewBookmarkFolder: function()</span>
<a href="#l8.1149"></a><span id="l8.1149" class="difflineminus">-  {</span>
<a href="#l8.1150"></a><span id="l8.1150" class="difflineminus">-    return this.getSpecialFolder(&quot;NC:NewBookmarkFolder&quot;);</span>
<a href="#l8.1151"></a><span id="l8.1151" class="difflineminus">-  },</span>
<a href="#l8.1152"></a><span id="l8.1152" class="difflineminus">-</span>
<a href="#l8.1153"></a><span id="l8.1153" class="difflineminus">-  /////////////////////////////////////////////////////////////////////////////</span>
<a href="#l8.1154"></a><span id="l8.1154" class="difflineminus">-  // Returns the New Search Folder</span>
<a href="#l8.1155"></a><span id="l8.1155" class="difflineminus">-  getNewSearchFolder: function()</span>
<a href="#l8.1156"></a><span id="l8.1156" class="difflineminus">-  {</span>
<a href="#l8.1157"></a><span id="l8.1157" class="difflineminus">-    return this.getSpecialFolder(&quot;NC:NewSearchFolder&quot;);</span>
<a href="#l8.1158"></a><span id="l8.1158" class="difflineminus">-  },</span>
<a href="#l8.1159"></a><span id="l8.1159" class="difflineminus">-</span>
<a href="#l8.1160"></a><span id="l8.1160" class="difflineminus">-  /////////////////////////////////////////////////////////////////////////////</span>
<a href="#l8.1161"></a><span id="l8.1161" class="difflineminus">-  // Returns the container of a given container</span>
<a href="#l8.1162"></a><span id="l8.1162" class="difflineminus">-  getParentOfContainer: function(aChild)</span>
<a href="#l8.1163"></a><span id="l8.1163" class="difflineminus">-  {</span>
<a href="#l8.1164"></a><span id="l8.1164" class="difflineminus">-    var arcsIn = BMDS.ArcLabelsIn(aChild);</span>
<a href="#l8.1165"></a><span id="l8.1165" class="difflineminus">-    var containerArc;</span>
<a href="#l8.1166"></a><span id="l8.1166" class="difflineminus">-    while (arcsIn.hasMoreElements()) {</span>
<a href="#l8.1167"></a><span id="l8.1167" class="difflineminus">-      containerArc = arcsIn.getNext();</span>
<a href="#l8.1168"></a><span id="l8.1168" class="difflineminus">-      if (RDFCU.IsOrdinalProperty(containerArc)) {</span>
<a href="#l8.1169"></a><span id="l8.1169" class="difflineminus">-        return BMDS.GetSources(containerArc, aChild, true).getNext()</span>
<a href="#l8.1170"></a><span id="l8.1170" class="difflineminus">-                   .QueryInterface(kRDFRSCIID);</span>
<a href="#l8.1171"></a><span id="l8.1171" class="difflineminus">-      }</span>
<a href="#l8.1172"></a><span id="l8.1172" class="difflineminus">-    }</span>
<a href="#l8.1173"></a><span id="l8.1173" class="difflineminus">-    return null;</span>
<a href="#l8.1174"></a><span id="l8.1174" class="difflineminus">-  },</span>
<a href="#l8.1175"></a><span id="l8.1175" class="difflineminus">-  </span>
<a href="#l8.1176"></a><span id="l8.1176" class="difflineminus">-  /////////////////////////////////////////////////////////////////////////////</span>
<a href="#l8.1177"></a><span id="l8.1177" class="difflineminus">-  // Caches frequently used informations about the selection</span>
<a href="#l8.1178"></a><span id="l8.1178" class="difflineminus">-  checkSelection: function (aSelection)</span>
<a href="#l8.1179"></a><span id="l8.1179" class="difflineminus">-  {</span>
<a href="#l8.1180"></a><span id="l8.1180" class="difflineminus">-    if (aSelection.length == 0)</span>
<a href="#l8.1181"></a><span id="l8.1181" class="difflineminus">-      return;</span>
<a href="#l8.1182"></a><span id="l8.1182" class="difflineminus">-</span>
<a href="#l8.1183"></a><span id="l8.1183" class="difflineminus">-    aSelection.type            = new Array(aSelection.length);</span>
<a href="#l8.1184"></a><span id="l8.1184" class="difflineminus">-    aSelection.protocol        = new Array(aSelection.length);</span>
<a href="#l8.1185"></a><span id="l8.1185" class="difflineminus">-    aSelection.isContainer     = new Array(aSelection.length);</span>
<a href="#l8.1186"></a><span id="l8.1186" class="difflineminus">-    aSelection.isImmutable     = new Array(aSelection.length);</span>
<a href="#l8.1187"></a><span id="l8.1187" class="difflineminus">-    aSelection.isValid         = new Array(aSelection.length);</span>
<a href="#l8.1188"></a><span id="l8.1188" class="difflineminus">-    aSelection.containsMutable = false;</span>
<a href="#l8.1189"></a><span id="l8.1189" class="difflineminus">-    aSelection.containsPTF     = false;</span>
<a href="#l8.1190"></a><span id="l8.1190" class="difflineminus">-    aSelection.containsRF      = false;</span>
<a href="#l8.1191"></a><span id="l8.1191" class="difflineminus">-    var index, item, parent, type, protocol, isContainer, isImmutable, isValid;</span>
<a href="#l8.1192"></a><span id="l8.1192" class="difflineminus">-    for (var i=0; i&lt;aSelection.length; ++i) {</span>
<a href="#l8.1193"></a><span id="l8.1193" class="difflineminus">-      item        = aSelection.item[i];</span>
<a href="#l8.1194"></a><span id="l8.1194" class="difflineminus">-      parent      = aSelection.parent[i];</span>
<a href="#l8.1195"></a><span id="l8.1195" class="difflineminus">-      type        = BookmarksUtils.resolveType(item);</span>
<a href="#l8.1196"></a><span id="l8.1196" class="difflineminus">-      protocol    = item.Value.split(&quot;:&quot;)[0];</span>
<a href="#l8.1197"></a><span id="l8.1197" class="difflineminus">-      isContainer = RDFCU.IsContainer(BMDS, item) ||</span>
<a href="#l8.1198"></a><span id="l8.1198" class="difflineminus">-                    protocol == &quot;find&quot; || protocol == &quot;file&quot;;</span>
<a href="#l8.1199"></a><span id="l8.1199" class="difflineminus">-      isValid     = true;</span>
<a href="#l8.1200"></a><span id="l8.1200" class="difflineminus">-      isImmutable = false;</span>
<a href="#l8.1201"></a><span id="l8.1201" class="difflineminus">-      if (item.Value == &quot;NC:BookmarksRoot&quot;) {</span>
<a href="#l8.1202"></a><span id="l8.1202" class="difflineminus">-        isImmutable = true;</span>
<a href="#l8.1203"></a><span id="l8.1203" class="difflineminus">-        aSelection.containsRF = true;</span>
<a href="#l8.1204"></a><span id="l8.1204" class="difflineminus">-      }</span>
<a href="#l8.1205"></a><span id="l8.1205" class="difflineminus">-      else if (type != &quot;Bookmark&quot; &amp;&amp; type != &quot;BookmarkSeparator&quot; &amp;&amp; </span>
<a href="#l8.1206"></a><span id="l8.1206" class="difflineminus">-               type != &quot;Folder&quot;   &amp;&amp; type != &quot;FolderGroup&quot; &amp;&amp; </span>
<a href="#l8.1207"></a><span id="l8.1207" class="difflineminus">-               type != &quot;PersonalToolbarFolder&quot;)</span>
<a href="#l8.1208"></a><span id="l8.1208" class="difflineminus">-        isImmutable = true;</span>
<a href="#l8.1209"></a><span id="l8.1209" class="difflineminus">-      else if (parent) {</span>
<a href="#l8.1210"></a><span id="l8.1210" class="difflineminus">-        var parentProtocol = parent.Value.split(&quot;:&quot;)[0];</span>
<a href="#l8.1211"></a><span id="l8.1211" class="difflineminus">-        if (parentProtocol == &quot;file&quot;)</span>
<a href="#l8.1212"></a><span id="l8.1212" class="difflineminus">-          aSelection.parent[i] = null;</span>
<a href="#l8.1213"></a><span id="l8.1213" class="difflineminus">-        else if (parentProtocol == &quot;find&quot;)</span>
<a href="#l8.1214"></a><span id="l8.1214" class="difflineminus">-          // try to get the real parent so we can delete after searching</span>
<a href="#l8.1215"></a><span id="l8.1215" class="difflineminus">-          aSelection.parent[i] = BookmarksUtils.getParentOfContainer(aSelection.item[i]);</span>
<a href="#l8.1216"></a><span id="l8.1216" class="difflineminus">-      }</span>
<a href="#l8.1217"></a><span id="l8.1217" class="difflineminus">-      if (!isImmutable &amp;&amp; aSelection.parent[i])</span>
<a href="#l8.1218"></a><span id="l8.1218" class="difflineminus">-        aSelection.containsMutable = true;</span>
<a href="#l8.1219"></a><span id="l8.1219" class="difflineminus">-</span>
<a href="#l8.1220"></a><span id="l8.1220" class="difflineminus">-      aSelection.type       [i] = type;</span>
<a href="#l8.1221"></a><span id="l8.1221" class="difflineminus">-      aSelection.protocol   [i] = protocol;</span>
<a href="#l8.1222"></a><span id="l8.1222" class="difflineminus">-      aSelection.isContainer[i] = isContainer;</span>
<a href="#l8.1223"></a><span id="l8.1223" class="difflineminus">-      aSelection.isImmutable[i] = isImmutable;</span>
<a href="#l8.1224"></a><span id="l8.1224" class="difflineminus">-      aSelection.isValid    [i] = isValid;</span>
<a href="#l8.1225"></a><span id="l8.1225" class="difflineminus">-    }</span>
<a href="#l8.1226"></a><span id="l8.1226" class="difflineminus">-    if (this.isContainerChildOrSelf(RDF.GetResource(&quot;NC:PersonalToolbarFolder&quot;), aSelection))</span>
<a href="#l8.1227"></a><span id="l8.1227" class="difflineminus">-      aSelection.containsPTF = true;</span>
<a href="#l8.1228"></a><span id="l8.1228" class="difflineminus">-  },</span>
<a href="#l8.1229"></a><span id="l8.1229" class="difflineminus">-</span>
<a href="#l8.1230"></a><span id="l8.1230" class="difflineminus">-  isSelectionValidForInsertion: function (aSelection, aTarget, aAction)</span>
<a href="#l8.1231"></a><span id="l8.1231" class="difflineminus">-  {</span>
<a href="#l8.1232"></a><span id="l8.1232" class="difflineminus">-    if (!BookmarksUtils.isValidTargetContainer(aTarget.parent, aSelection)) {</span>
<a href="#l8.1233"></a><span id="l8.1233" class="difflineminus">-      var isValid = new Array(aSelection.length);</span>
<a href="#l8.1234"></a><span id="l8.1234" class="difflineminus">-      for (var i=0; i&lt;aSelection.length; ++i)</span>
<a href="#l8.1235"></a><span id="l8.1235" class="difflineminus">-        isValid[i] = false;</span>
<a href="#l8.1236"></a><span id="l8.1236" class="difflineminus">-      return isValid;</span>
<a href="#l8.1237"></a><span id="l8.1237" class="difflineminus">-    }</span>
<a href="#l8.1238"></a><span id="l8.1238" class="difflineminus">-    return aSelection.isValid;</span>
<a href="#l8.1239"></a><span id="l8.1239" class="difflineminus">-  },</span>
<a href="#l8.1240"></a><span id="l8.1240" class="difflineminus">-</span>
<a href="#l8.1241"></a><span id="l8.1241" class="difflineminus">-  isSelectionValidForDeletion: function (aSelection)</span>
<a href="#l8.1242"></a><span id="l8.1242" class="difflineminus">-  {</span>
<a href="#l8.1243"></a><span id="l8.1243" class="difflineminus">-    var isValid = new Array(aSelection.length);</span>
<a href="#l8.1244"></a><span id="l8.1244" class="difflineminus">-    for (var i=0; i&lt;aSelection.length; ++i) {</span>
<a href="#l8.1245"></a><span id="l8.1245" class="difflineminus">-      if (!aSelection.isValid[i] || aSelection.isImmutable[i] || </span>
<a href="#l8.1246"></a><span id="l8.1246" class="difflineminus">-          !aSelection.parent [i])</span>
<a href="#l8.1247"></a><span id="l8.1247" class="difflineminus">-        isValid[i] = false;</span>
<a href="#l8.1248"></a><span id="l8.1248" class="difflineminus">-      else</span>
<a href="#l8.1249"></a><span id="l8.1249" class="difflineminus">-        isValid[i] = true;</span>
<a href="#l8.1250"></a><span id="l8.1250" class="difflineminus">-    }</span>
<a href="#l8.1251"></a><span id="l8.1251" class="difflineminus">-    return isValid;</span>
<a href="#l8.1252"></a><span id="l8.1252" class="difflineminus">-  },</span>
<a href="#l8.1253"></a><span id="l8.1253" class="difflineminus">-</span>
<a href="#l8.1254"></a><span id="l8.1254" class="difflineminus">-  /////////////////////////////////////////////////////////////////////////////</span>
<a href="#l8.1255"></a><span id="l8.1255" class="difflineminus">-  // Returns true is aContainer is a member or a child of the selection</span>
<a href="#l8.1256"></a><span id="l8.1256" class="difflineminus">-  isContainerChildOrSelf: function (aContainer, aSelection)</span>
<a href="#l8.1257"></a><span id="l8.1257" class="difflineminus">-  {</span>
<a href="#l8.1258"></a><span id="l8.1258" class="difflineminus">-    var folder = aContainer;</span>
<a href="#l8.1259"></a><span id="l8.1259" class="difflineminus">-    do {</span>
<a href="#l8.1260"></a><span id="l8.1260" class="difflineminus">-      for (var i=0; i&lt;aSelection.length; ++i) {</span>
<a href="#l8.1261"></a><span id="l8.1261" class="difflineminus">-        if (aSelection.isContainer[i] &amp;&amp; aSelection.item[i] == folder)</span>
<a href="#l8.1262"></a><span id="l8.1262" class="difflineminus">-          return true;</span>
<a href="#l8.1263"></a><span id="l8.1263" class="difflineminus">-      }</span>
<a href="#l8.1264"></a><span id="l8.1264" class="difflineminus">-      folder = BookmarksUtils.getParentOfContainer(folder);</span>
<a href="#l8.1265"></a><span id="l8.1265" class="difflineminus">-      if (!folder)</span>
<a href="#l8.1266"></a><span id="l8.1266" class="difflineminus">-        return false; // sanity check</span>
<a href="#l8.1267"></a><span id="l8.1267" class="difflineminus">-    } while (folder.Value != &quot;NC:BookmarksRoot&quot;)</span>
<a href="#l8.1268"></a><span id="l8.1268" class="difflineminus">-    return false;</span>
<a href="#l8.1269"></a><span id="l8.1269" class="difflineminus">-  },</span>
<a href="#l8.1270"></a><span id="l8.1270" class="difflineminus">-</span>
<a href="#l8.1271"></a><span id="l8.1271" class="difflineminus">-  /////////////////////////////////////////////////////////////////////////////</span>
<a href="#l8.1272"></a><span id="l8.1272" class="difflineminus">-  // Returns true if aSelection can be inserted in aFolder</span>
<a href="#l8.1273"></a><span id="l8.1273" class="difflineminus">-  isValidTargetContainer: function (aFolder, aSelection)</span>
<a href="#l8.1274"></a><span id="l8.1274" class="difflineminus">-  {</span>
<a href="#l8.1275"></a><span id="l8.1275" class="difflineminus">-    if (!aFolder)</span>
<a href="#l8.1276"></a><span id="l8.1276" class="difflineminus">-      return false;</span>
<a href="#l8.1277"></a><span id="l8.1277" class="difflineminus">-    if (aFolder.Value == &quot;NC:BookmarksTopRoot&quot;)</span>
<a href="#l8.1278"></a><span id="l8.1278" class="difflineminus">-      return false;</span>
<a href="#l8.1279"></a><span id="l8.1279" class="difflineminus">-    if (aFolder.Value == &quot;NC:BookmarksRoot&quot;)</span>
<a href="#l8.1280"></a><span id="l8.1280" class="difflineminus">-      return true;</span>
<a href="#l8.1281"></a><span id="l8.1281" class="difflineminus">-</span>
<a href="#l8.1282"></a><span id="l8.1282" class="difflineminus">-    // don't insert items in an invalid container</span>
<a href="#l8.1283"></a><span id="l8.1283" class="difflineminus">-    // 'file:' and 'find:' items have a 'Bookmark' type</span>
<a href="#l8.1284"></a><span id="l8.1284" class="difflineminus">-    var type = BookmarksUtils.resolveType(aFolder);</span>
<a href="#l8.1285"></a><span id="l8.1285" class="difflineminus">-    if (type != &quot;Folder&quot; &amp;&amp; type != &quot;FolderGroup&quot; &amp;&amp; type != &quot;PersonalToolbarFolder&quot;)</span>
<a href="#l8.1286"></a><span id="l8.1286" class="difflineminus">-      return false;</span>
<a href="#l8.1287"></a><span id="l8.1287" class="difflineminus">-</span>
<a href="#l8.1288"></a><span id="l8.1288" class="difflineminus">-    // bail if we just check the container</span>
<a href="#l8.1289"></a><span id="l8.1289" class="difflineminus">-    if (!aSelection)</span>
<a href="#l8.1290"></a><span id="l8.1290" class="difflineminus">-      return true;</span>
<a href="#l8.1291"></a><span id="l8.1291" class="difflineminus">-</span>
<a href="#l8.1292"></a><span id="l8.1292" class="difflineminus">-    // don't insert folders in a group folder except for 'file:' pseudo folders</span>
<a href="#l8.1293"></a><span id="l8.1293" class="difflineminus">-    if (type == &quot;FolderGroup&quot;)</span>
<a href="#l8.1294"></a><span id="l8.1294" class="difflineminus">-      for (var i=0; i&lt;aSelection.length; ++i)</span>
<a href="#l8.1295"></a><span id="l8.1295" class="difflineminus">-        if (aSelection.isContainer[i] &amp;&amp; aSelection.protocol[i] != &quot;file&quot;)</span>
<a href="#l8.1296"></a><span id="l8.1296" class="difflineminus">-          return false;</span>
<a href="#l8.1297"></a><span id="l8.1297" class="difflineminus">-</span>
<a href="#l8.1298"></a><span id="l8.1298" class="difflineminus">-    // check that the selected folder is not the selected item nor its child</span>
<a href="#l8.1299"></a><span id="l8.1299" class="difflineminus">-    if (this.isContainerChildOrSelf(aFolder, aSelection))</span>
<a href="#l8.1300"></a><span id="l8.1300" class="difflineminus">-      return false;</span>
<a href="#l8.1301"></a><span id="l8.1301" class="difflineminus">-</span>
<a href="#l8.1302"></a><span id="l8.1302" class="difflineminus">-    return true;</span>
<a href="#l8.1303"></a><span id="l8.1303" class="difflineminus">-  },</span>
<a href="#l8.1304"></a><span id="l8.1304" class="difflineminus">-</span>
<a href="#l8.1305"></a><span id="l8.1305" class="difflineminus">-  /////////////////////////////////////////////////////////////////////////////</span>
<a href="#l8.1306"></a><span id="l8.1306" class="difflineminus">-  // Returns true is aItem is a child of aContainer</span>
<a href="#l8.1307"></a><span id="l8.1307" class="difflineminus">-  isChildOfContainer: function (aItem, aContainer)</span>
<a href="#l8.1308"></a><span id="l8.1308" class="difflineminus">-  {</span>
<a href="#l8.1309"></a><span id="l8.1309" class="difflineminus">-    RDFC.Init(BMDS, aContainer);</span>
<a href="#l8.1310"></a><span id="l8.1310" class="difflineminus">-    var rChildren = RDFC.GetElements();</span>
<a href="#l8.1311"></a><span id="l8.1311" class="difflineminus">-    while (rChildren.hasMoreElements()) {</span>
<a href="#l8.1312"></a><span id="l8.1312" class="difflineminus">-      if (aItem == rChildren.getNext())</span>
<a href="#l8.1313"></a><span id="l8.1313" class="difflineminus">-        return true;</span>
<a href="#l8.1314"></a><span id="l8.1314" class="difflineminus">-    }</span>
<a href="#l8.1315"></a><span id="l8.1315" class="difflineminus">-    return false;</span>
<a href="#l8.1316"></a><span id="l8.1316" class="difflineminus">-  },</span>
<a href="#l8.1317"></a><span id="l8.1317" class="difflineminus">-</span>
<a href="#l8.1318"></a><span id="l8.1318" class="difflineminus">-  /////////////////////////////////////////////////////////////////////////////</span>
<a href="#l8.1319"></a><span id="l8.1319" class="difflineminus">-  removeSelection: function (aAction, aSelection)</span>
<a href="#l8.1320"></a><span id="l8.1320" class="difflineminus">-  {</span>
<a href="#l8.1321"></a><span id="l8.1321" class="difflineminus">-    var isValid = BookmarksUtils.isSelectionValidForDeletion(aSelection);</span>
<a href="#l8.1322"></a><span id="l8.1322" class="difflineminus">-    if (SOUND &amp;&amp; !BookmarksUtils.all(isValid))</span>
<a href="#l8.1323"></a><span id="l8.1323" class="difflineminus">-      SOUND.beep();</span>
<a href="#l8.1324"></a><span id="l8.1324" class="difflineminus">-    if (!BookmarksUtils.any(isValid))</span>
<a href="#l8.1325"></a><span id="l8.1325" class="difflineminus">-      return false;</span>
<a href="#l8.1326"></a><span id="l8.1326" class="difflineminus">-</span>
<a href="#l8.1327"></a><span id="l8.1327" class="difflineminus">-    var txmgr = BMSVC.transactionManager;</span>
<a href="#l8.1328"></a><span id="l8.1328" class="difflineminus">-    txmgr.beginBatch();</span>
<a href="#l8.1329"></a><span id="l8.1329" class="difflineminus">-    for (var i = 0; i &lt; aSelection.length; ++i) {</span>
<a href="#l8.1330"></a><span id="l8.1330" class="difflineminus">-      if (isValid[i]) {</span>
<a href="#l8.1331"></a><span id="l8.1331" class="difflineminus">-        RDFC.Init(BMDS, aSelection.parent[i]);</span>
<a href="#l8.1332"></a><span id="l8.1332" class="difflineminus">-        var index = RDFC.IndexOf(aSelection.item[i]);</span>
<a href="#l8.1333"></a><span id="l8.1333" class="difflineminus">-        var txn = BMSVC.createTransaction(aSelection.parent[i], aSelection.item[i], index, true);</span>
<a href="#l8.1334"></a><span id="l8.1334" class="difflineminus">-        txmgr.doTransaction(txn);</span>
<a href="#l8.1335"></a><span id="l8.1335" class="difflineminus">-      }</span>
<a href="#l8.1336"></a><span id="l8.1336" class="difflineminus">-    }</span>
<a href="#l8.1337"></a><span id="l8.1337" class="difflineminus">-    txmgr.endBatch();</span>
<a href="#l8.1338"></a><span id="l8.1338" class="difflineminus">-    if (aAction != &quot;move&quot;) {</span>
<a href="#l8.1339"></a><span id="l8.1339" class="difflineminus">-      BookmarksUtils.notifyBookmarksChanged();</span>
<a href="#l8.1340"></a><span id="l8.1340" class="difflineminus">-      BookmarksUtils.flushDataSource();</span>
<a href="#l8.1341"></a><span id="l8.1341" class="difflineminus">-    }</span>
<a href="#l8.1342"></a><span id="l8.1342" class="difflineminus">-    return true;</span>
<a href="#l8.1343"></a><span id="l8.1343" class="difflineminus">-  },</span>
<a href="#l8.1344"></a><span id="l8.1344" class="difflineminus">-      // If the current bookmark is the IE Favorites folder, we have a little</span>
<a href="#l8.1345"></a><span id="l8.1345" class="difflineminus">-      // extra work to do - set the pref |browser.bookmarks.import_system_favorites|</span>
<a href="#l8.1346"></a><span id="l8.1346" class="difflineminus">-      // to ensure that we don't re-import next time. </span>
<a href="#l8.1347"></a><span id="l8.1347" class="difflineminus">-      //if (aSelection[count].getAttribute(&quot;type&quot;) == (NC_NS + &quot;IEFavoriteFolder&quot;)) {</span>
<a href="#l8.1348"></a><span id="l8.1348" class="difflineminus">-      //  const kPrefSvcContractID = &quot;@mozilla.org/preferences-service;1&quot;;</span>
<a href="#l8.1349"></a><span id="l8.1349" class="difflineminus">-      //  const kPrefSvcIID = Components.interfaces.nsIPrefBranch;</span>
<a href="#l8.1350"></a><span id="l8.1350" class="difflineminus">-      //  const kPrefSvc = Components.classes[kPrefSvcContractID].getService(kPrefSvcIID);</span>
<a href="#l8.1351"></a><span id="l8.1351" class="difflineminus">-      //  kPrefSvc.setBoolPref(&quot;browser.bookmarks.import_system_favorites&quot;, false);</span>
<a href="#l8.1352"></a><span id="l8.1352" class="difflineminus">-      //}</span>
<a href="#l8.1353"></a><span id="l8.1353" class="difflineminus">-</span>
<a href="#l8.1354"></a><span id="l8.1354" class="difflineminus">-  notifyBookmarksChanged: function ()</span>
<a href="#l8.1355"></a><span id="l8.1355" class="difflineminus">-  {</span>
<a href="#l8.1356"></a><span id="l8.1356" class="difflineminus">-    Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l8.1357"></a><span id="l8.1357" class="difflineminus">-              .getService(Components.interfaces.nsIObserverService)</span>
<a href="#l8.1358"></a><span id="l8.1358" class="difflineminus">-              .notifyObservers(null, &quot;bookmarks-changed&quot;, &quot;&quot;);</span>
<a href="#l8.1359"></a><span id="l8.1359" class="difflineminus">-  },</span>
<a href="#l8.1360"></a><span id="l8.1360" class="difflineminus">-</span>
<a href="#l8.1361"></a><span id="l8.1361" class="difflineminus">-  insertSelection: function (aAction, aSelection, aTarget)</span>
<a href="#l8.1362"></a><span id="l8.1362" class="difflineminus">-  {</span>
<a href="#l8.1363"></a><span id="l8.1363" class="difflineminus">-    var isValid = BookmarksUtils.isSelectionValidForInsertion(aSelection, aTarget, aAction);</span>
<a href="#l8.1364"></a><span id="l8.1364" class="difflineminus">-    if (SOUND &amp;&amp; !BookmarksUtils.all(isValid))</span>
<a href="#l8.1365"></a><span id="l8.1365" class="difflineminus">-      SOUND.beep();</span>
<a href="#l8.1366"></a><span id="l8.1366" class="difflineminus">-    if (!BookmarksUtils.any(isValid))</span>
<a href="#l8.1367"></a><span id="l8.1367" class="difflineminus">-      return false;</span>
<a href="#l8.1368"></a><span id="l8.1368" class="difflineminus">-</span>
<a href="#l8.1369"></a><span id="l8.1369" class="difflineminus">-    var txmgr = BMSVC.transactionManager;</span>
<a href="#l8.1370"></a><span id="l8.1370" class="difflineminus">-    txmgr.beginBatch();</span>
<a href="#l8.1371"></a><span id="l8.1371" class="difflineminus">-    var index = aTarget.index;</span>
<a href="#l8.1372"></a><span id="l8.1372" class="difflineminus">-    for (var i = 0; i &lt; aSelection.length; ++i) {</span>
<a href="#l8.1373"></a><span id="l8.1373" class="difflineminus">-      if (isValid[i]) {</span>
<a href="#l8.1374"></a><span id="l8.1374" class="difflineminus">-        var rSource = aSelection.item[i];</span>
<a href="#l8.1375"></a><span id="l8.1375" class="difflineminus">-        if (BMSVC.isBookmarkedResource(rSource))</span>
<a href="#l8.1376"></a><span id="l8.1376" class="difflineminus">-          rSource = BMSVC.cloneResource(rSource);</span>
<a href="#l8.1377"></a><span id="l8.1377" class="difflineminus">-        var txn = BMSVC.createTransaction(aTarget.parent, rSource, index++, false);</span>
<a href="#l8.1378"></a><span id="l8.1378" class="difflineminus">-        txmgr.doTransaction(txn);</span>
<a href="#l8.1379"></a><span id="l8.1379" class="difflineminus">-      }</span>
<a href="#l8.1380"></a><span id="l8.1380" class="difflineminus">-    }</span>
<a href="#l8.1381"></a><span id="l8.1381" class="difflineminus">-    txmgr.endBatch();</span>
<a href="#l8.1382"></a><span id="l8.1382" class="difflineminus">-    BookmarksUtils.notifyBookmarksChanged();</span>
<a href="#l8.1383"></a><span id="l8.1383" class="difflineminus">-    BookmarksUtils.flushDataSource();</span>
<a href="#l8.1384"></a><span id="l8.1384" class="difflineminus">-    return true;</span>
<a href="#l8.1385"></a><span id="l8.1385" class="difflineminus">-  },</span>
<a href="#l8.1386"></a><span id="l8.1386" class="difflineminus">-</span>
<a href="#l8.1387"></a><span id="l8.1387" class="difflineminus">-  moveSelection: function (aAction, aSelection, aTarget)</span>
<a href="#l8.1388"></a><span id="l8.1388" class="difflineminus">-  {</span>
<a href="#l8.1389"></a><span id="l8.1389" class="difflineminus">-    var canDelete = BookmarksUtils.isSelectionValidForDeletion(aSelection);</span>
<a href="#l8.1390"></a><span id="l8.1390" class="difflineminus">-    var isValid = BookmarksUtils.isSelectionValidForInsertion(aSelection, aTarget, aAction);</span>
<a href="#l8.1391"></a><span id="l8.1391" class="difflineminus">-    if (SOUND &amp;&amp; !BookmarksUtils.all(isValid))</span>
<a href="#l8.1392"></a><span id="l8.1392" class="difflineminus">-      SOUND.beep();</span>
<a href="#l8.1393"></a><span id="l8.1393" class="difflineminus">-    if (!BookmarksUtils.any(isValid))</span>
<a href="#l8.1394"></a><span id="l8.1394" class="difflineminus">-      return false;</span>
<a href="#l8.1395"></a><span id="l8.1395" class="difflineminus">-</span>
<a href="#l8.1396"></a><span id="l8.1396" class="difflineminus">-    var txmgr = BMSVC.transactionManager;</span>
<a href="#l8.1397"></a><span id="l8.1397" class="difflineminus">-    txmgr.beginBatch();</span>
<a href="#l8.1398"></a><span id="l8.1398" class="difflineminus">-    var index = aTarget.index;</span>
<a href="#l8.1399"></a><span id="l8.1399" class="difflineminus">-    for (var i = 0; i &lt; aSelection.length; ++i) {</span>
<a href="#l8.1400"></a><span id="l8.1400" class="difflineminus">-      if (canDelete[i]) {</span>
<a href="#l8.1401"></a><span id="l8.1401" class="difflineminus">-        RDFC.Init(BMDS, aSelection.parent[i]);</span>
<a href="#l8.1402"></a><span id="l8.1402" class="difflineminus">-        var deleteIndex = RDFC.IndexOf(aSelection.item[i]);</span>
<a href="#l8.1403"></a><span id="l8.1403" class="difflineminus">-        var deleteTxn = BMSVC.createTransaction(aSelection.parent[i], aSelection.item[i], deleteIndex, true);</span>
<a href="#l8.1404"></a><span id="l8.1404" class="difflineminus">-        txmgr.doTransaction(deleteTxn);</span>
<a href="#l8.1405"></a><span id="l8.1405" class="difflineminus">-      }</span>
<a href="#l8.1406"></a><span id="l8.1406" class="difflineminus">-      if (isValid[i]) {</span>
<a href="#l8.1407"></a><span id="l8.1407" class="difflineminus">-        var insertTxn = BMSVC.createTransaction(aTarget.parent, aSelection.item[i], index++, false);</span>
<a href="#l8.1408"></a><span id="l8.1408" class="difflineminus">-        txmgr.doTransaction(insertTxn);</span>
<a href="#l8.1409"></a><span id="l8.1409" class="difflineminus">-      }</span>
<a href="#l8.1410"></a><span id="l8.1410" class="difflineminus">-    }</span>
<a href="#l8.1411"></a><span id="l8.1411" class="difflineminus">-    txmgr.endBatch();</span>
<a href="#l8.1412"></a><span id="l8.1412" class="difflineminus">-    BookmarksUtils.flushDataSource();</span>
<a href="#l8.1413"></a><span id="l8.1413" class="difflineminus">-    return true;</span>
<a href="#l8.1414"></a><span id="l8.1414" class="difflineminus">-  }, </span>
<a href="#l8.1415"></a><span id="l8.1415" class="difflineminus">-</span>
<a href="#l8.1416"></a><span id="l8.1416" class="difflineminus">-  getXferDataFromSelection: function (aSelection)</span>
<a href="#l8.1417"></a><span id="l8.1417" class="difflineminus">-  {</span>
<a href="#l8.1418"></a><span id="l8.1418" class="difflineminus">-    if (aSelection.length == 0)</span>
<a href="#l8.1419"></a><span id="l8.1419" class="difflineminus">-      return null;</span>
<a href="#l8.1420"></a><span id="l8.1420" class="difflineminus">-    var dataSet = new TransferDataSet();</span>
<a href="#l8.1421"></a><span id="l8.1421" class="difflineminus">-    var data, item, itemUrl, itemName, parent, name;</span>
<a href="#l8.1422"></a><span id="l8.1422" class="difflineminus">-    for (var i=0; i&lt;aSelection.length; ++i) {</span>
<a href="#l8.1423"></a><span id="l8.1423" class="difflineminus">-      data     = new TransferData();</span>
<a href="#l8.1424"></a><span id="l8.1424" class="difflineminus">-      item     = aSelection.item[i].Value;</span>
<a href="#l8.1425"></a><span id="l8.1425" class="difflineminus">-      itemUrl  = this.getProperty(item, NC_NS+&quot;URL&quot;);</span>
<a href="#l8.1426"></a><span id="l8.1426" class="difflineminus">-      itemName = this.getProperty(item, NC_NS+&quot;Name&quot;);</span>
<a href="#l8.1427"></a><span id="l8.1427" class="difflineminus">-      parent   = aSelection.parent[i].Value;</span>
<a href="#l8.1428"></a><span id="l8.1428" class="difflineminus">-      data.addDataForFlavour(&quot;moz/rdfitem&quot;,    item+&quot;\n&quot;+(parent?parent:&quot;&quot;));</span>
<a href="#l8.1429"></a><span id="l8.1429" class="difflineminus">-      data.addDataForFlavour(&quot;text/x-moz-url&quot;, itemUrl+&quot;\n&quot;+itemName);</span>
<a href="#l8.1430"></a><span id="l8.1430" class="difflineminus">-      data.addDataForFlavour(&quot;text/html&quot;,      &quot;&lt;A HREF='&quot;+itemUrl+&quot;'&gt;&quot;+itemName+&quot;&lt;/A&gt;&quot;);</span>
<a href="#l8.1431"></a><span id="l8.1431" class="difflineminus">-      data.addDataForFlavour(&quot;text/unicode&quot;,   itemUrl);</span>
<a href="#l8.1432"></a><span id="l8.1432" class="difflineminus">-      dataSet.push(data);</span>
<a href="#l8.1433"></a><span id="l8.1433" class="difflineminus">-    }</span>
<a href="#l8.1434"></a><span id="l8.1434" class="difflineminus">-    return dataSet;</span>
<a href="#l8.1435"></a><span id="l8.1435" class="difflineminus">-  },</span>
<a href="#l8.1436"></a><span id="l8.1436" class="difflineminus">-</span>
<a href="#l8.1437"></a><span id="l8.1437" class="difflineminus">-  getSelectionFromXferData: function (aDragSession)</span>
<a href="#l8.1438"></a><span id="l8.1438" class="difflineminus">-  {</span>
<a href="#l8.1439"></a><span id="l8.1439" class="difflineminus">-    var selection    = {};</span>
<a href="#l8.1440"></a><span id="l8.1440" class="difflineminus">-    selection.item   = [];</span>
<a href="#l8.1441"></a><span id="l8.1441" class="difflineminus">-    selection.parent = [];</span>
<a href="#l8.1442"></a><span id="l8.1442" class="difflineminus">-    var trans = Components.classes[&quot;@mozilla.org/widget/transferable;1&quot;]</span>
<a href="#l8.1443"></a><span id="l8.1443" class="difflineminus">-                          .createInstance(Components.interfaces.nsITransferable);</span>
<a href="#l8.1444"></a><span id="l8.1444" class="difflineminus">-    trans.addDataFlavor(&quot;moz/rdfitem&quot;);</span>
<a href="#l8.1445"></a><span id="l8.1445" class="difflineminus">-    trans.addDataFlavor(&quot;text/x-moz-url&quot;);</span>
<a href="#l8.1446"></a><span id="l8.1446" class="difflineminus">-    trans.addDataFlavor(&quot;text/unicode&quot;);</span>
<a href="#l8.1447"></a><span id="l8.1447" class="difflineminus">-    var uri, extra, rSource, rParent, parent;</span>
<a href="#l8.1448"></a><span id="l8.1448" class="difflineminus">-    for (var i = 0; i &lt; aDragSession.numDropItems; ++i) {</span>
<a href="#l8.1449"></a><span id="l8.1449" class="difflineminus">-      var bestFlavour = {}, dataObj = {}, len = {};</span>
<a href="#l8.1450"></a><span id="l8.1450" class="difflineminus">-      aDragSession.getData(trans, i);</span>
<a href="#l8.1451"></a><span id="l8.1451" class="difflineminus">-      trans.getAnyTransferData(bestFlavour, dataObj, len);</span>
<a href="#l8.1452"></a><span id="l8.1452" class="difflineminus">-      dataObj = dataObj.value.QueryInterface(Components.interfaces.nsISupportsString);</span>
<a href="#l8.1453"></a><span id="l8.1453" class="difflineminus">-      if (!dataObj)</span>
<a href="#l8.1454"></a><span id="l8.1454" class="difflineminus">-        continue;</span>
<a href="#l8.1455"></a><span id="l8.1455" class="difflineminus">-      dataObj = dataObj.data.substring(0, len.value).split(&quot;\n&quot;);</span>
<a href="#l8.1456"></a><span id="l8.1456" class="difflineminus">-      uri     = dataObj[0];</span>
<a href="#l8.1457"></a><span id="l8.1457" class="difflineminus">-      if (dataObj.length &gt; 1 &amp;&amp; dataObj[1] != &quot;&quot;)</span>
<a href="#l8.1458"></a><span id="l8.1458" class="difflineminus">-        extra = dataObj[1];</span>
<a href="#l8.1459"></a><span id="l8.1459" class="difflineminus">-      else</span>
<a href="#l8.1460"></a><span id="l8.1460" class="difflineminus">-        extra = null;</span>
<a href="#l8.1461"></a><span id="l8.1461" class="difflineminus">-      switch (bestFlavour.value) {</span>
<a href="#l8.1462"></a><span id="l8.1462" class="difflineminus">-      case &quot;moz/rdfitem&quot;:</span>
<a href="#l8.1463"></a><span id="l8.1463" class="difflineminus">-        rSource = RDF.GetResource(uri);</span>
<a href="#l8.1464"></a><span id="l8.1464" class="difflineminus">-        parent  = extra;</span>
<a href="#l8.1465"></a><span id="l8.1465" class="difflineminus">-        break;</span>
<a href="#l8.1466"></a><span id="l8.1466" class="difflineminus">-      case &quot;text/x-moz-url&quot;:</span>
<a href="#l8.1467"></a><span id="l8.1467" class="difflineminus">-      case &quot;text/unicode&quot;:</span>
<a href="#l8.1468"></a><span id="l8.1468" class="difflineminus">-        rSource = BookmarksUtils.createBookmark(null, uri, null, extra);</span>
<a href="#l8.1469"></a><span id="l8.1469" class="difflineminus">-        parent = null;</span>
<a href="#l8.1470"></a><span id="l8.1470" class="difflineminus">-        break;</span>
<a href="#l8.1471"></a><span id="l8.1471" class="difflineminus">-      }</span>
<a href="#l8.1472"></a><span id="l8.1472" class="difflineminus">-      selection.item.push(rSource);</span>
<a href="#l8.1473"></a><span id="l8.1473" class="difflineminus">-      if (parent)</span>
<a href="#l8.1474"></a><span id="l8.1474" class="difflineminus">-        rParent = RDF.GetResource(parent);</span>
<a href="#l8.1475"></a><span id="l8.1475" class="difflineminus">-      else</span>
<a href="#l8.1476"></a><span id="l8.1476" class="difflineminus">-        rParent = null;</span>
<a href="#l8.1477"></a><span id="l8.1477" class="difflineminus">-      selection.parent.push(rParent);</span>
<a href="#l8.1478"></a><span id="l8.1478" class="difflineminus">-    }</span>
<a href="#l8.1479"></a><span id="l8.1479" class="difflineminus">-    selection.length = selection.item.length;</span>
<a href="#l8.1480"></a><span id="l8.1480" class="difflineminus">-    BookmarksUtils.checkSelection(selection);</span>
<a href="#l8.1481"></a><span id="l8.1481" class="difflineminus">-    return selection;</span>
<a href="#l8.1482"></a><span id="l8.1482" class="difflineminus">-  },</span>
<a href="#l8.1483"></a><span id="l8.1483" class="difflineminus">-</span>
<a href="#l8.1484"></a><span id="l8.1484" class="difflineminus">-  getTargetFromFolder: function(aResource)</span>
<a href="#l8.1485"></a><span id="l8.1485" class="difflineminus">-  {</span>
<a href="#l8.1486"></a><span id="l8.1486" class="difflineminus">-    var index = parseInt(this.getProperty(aResource, RDF_NS+&quot;nextVal&quot;));</span>
<a href="#l8.1487"></a><span id="l8.1487" class="difflineminus">-    if (isNaN(index))</span>
<a href="#l8.1488"></a><span id="l8.1488" class="difflineminus">-      return {parent: null, index: -1};</span>
<a href="#l8.1489"></a><span id="l8.1489" class="difflineminus">-    else</span>
<a href="#l8.1490"></a><span id="l8.1490" class="difflineminus">-      return {parent: aResource, index: index};</span>
<a href="#l8.1491"></a><span id="l8.1491" class="difflineminus">-  },</span>
<a href="#l8.1492"></a><span id="l8.1492" class="difflineminus">-</span>
<a href="#l8.1493"></a><span id="l8.1493" class="difflineminus">-  getSelectionFromResource: function (aItem, aParent)</span>
<a href="#l8.1494"></a><span id="l8.1494" class="difflineminus">-  {</span>
<a href="#l8.1495"></a><span id="l8.1495" class="difflineminus">-    var selection    = {};</span>
<a href="#l8.1496"></a><span id="l8.1496" class="difflineminus">-    selection.length = 1;</span>
<a href="#l8.1497"></a><span id="l8.1497" class="difflineminus">-    selection.item   = [aItem  ];</span>
<a href="#l8.1498"></a><span id="l8.1498" class="difflineminus">-    selection.parent = [aParent];</span>
<a href="#l8.1499"></a><span id="l8.1499" class="difflineminus">-    this.checkSelection(selection);</span>
<a href="#l8.1500"></a><span id="l8.1500" class="difflineminus">-    return selection;</span>
<a href="#l8.1501"></a><span id="l8.1501" class="difflineminus">-  },</span>
<a href="#l8.1502"></a><span id="l8.1502" class="difflineminus">-</span>
<a href="#l8.1503"></a><span id="l8.1503" class="difflineminus">-  createBookmark: function (aName, aURL, aCharSet, aDefaultName)</span>
<a href="#l8.1504"></a><span id="l8.1504" class="difflineminus">-  {</span>
<a href="#l8.1505"></a><span id="l8.1505" class="difflineminus">-    try {</span>
<a href="#l8.1506"></a><span id="l8.1506" class="difflineminus">-      var uri = makeURI(aURL);</span>
<a href="#l8.1507"></a><span id="l8.1507" class="difflineminus">-      var history =</span>
<a href="#l8.1508"></a><span id="l8.1508" class="difflineminus">-          Components.classes[&quot;@mozilla.org/browser/nav-history-service;1&quot;]</span>
<a href="#l8.1509"></a><span id="l8.1509" class="difflineminus">-                    .getService(Components.interfaces.nsINavHistoryService);</span>
<a href="#l8.1510"></a><span id="l8.1510" class="difflineminus">-      if (!aName)</span>
<a href="#l8.1511"></a><span id="l8.1511" class="difflineminus">-        aName = history.getPageTitle(uri);</span>
<a href="#l8.1512"></a><span id="l8.1512" class="difflineminus">-      if (!aCharSet)</span>
<a href="#l8.1513"></a><span id="l8.1513" class="difflineminus">-        aCharSet = history.getCharsetForURI(uri);</span>
<a href="#l8.1514"></a><span id="l8.1514" class="difflineminus">-    } catch (e) {}</span>
<a href="#l8.1515"></a><span id="l8.1515" class="difflineminus">-    if (!aName)</span>
<a href="#l8.1516"></a><span id="l8.1516" class="difflineminus">-      aName = aDefaultName || aURL;</span>
<a href="#l8.1517"></a><span id="l8.1517" class="difflineminus">-    if (!aCharSet) {</span>
<a href="#l8.1518"></a><span id="l8.1518" class="difflineminus">-      var fw = document.commandDispatcher.focusedWindow;</span>
<a href="#l8.1519"></a><span id="l8.1519" class="difflineminus">-      if (fw)</span>
<a href="#l8.1520"></a><span id="l8.1520" class="difflineminus">-        aCharSet = fw.document.characterSet;</span>
<a href="#l8.1521"></a><span id="l8.1521" class="difflineminus">-    }</span>
<a href="#l8.1522"></a><span id="l8.1522" class="difflineminus">-    return BMSVC.createBookmark(aName, aURL, null, null, aCharSet);</span>
<a href="#l8.1523"></a><span id="l8.1523" class="difflineminus">-  },</span>
<a href="#l8.1524"></a><span id="l8.1524" class="difflineminus">-</span>
<a href="#l8.1525"></a><span id="l8.1525" class="difflineminus">-  flushDataSource: function ()</span>
<a href="#l8.1526"></a><span id="l8.1526" class="difflineminus">-  {</span>
<a href="#l8.1527"></a><span id="l8.1527" class="difflineminus">-    var remoteDS = BMDS.QueryInterface(Components.interfaces.nsIRDFRemoteDataSource);</span>
<a href="#l8.1528"></a><span id="l8.1528" class="difflineminus">-    setTimeout(function () {remoteDS.Flush()}, 100);</span>
<a href="#l8.1529"></a><span id="l8.1529" class="difflineminus">-  },</span>
<a href="#l8.1530"></a><span id="l8.1530" class="difflineminus">-</span>
<a href="#l8.1531"></a><span id="l8.1531" class="difflineminus">-  addBookmarkForTabBrowser: function( aTabBrowser, aSelect )</span>
<a href="#l8.1532"></a><span id="l8.1532" class="difflineminus">-  {</span>
<a href="#l8.1533"></a><span id="l8.1533" class="difflineminus">-    var tabsInfo = [];</span>
<a href="#l8.1534"></a><span id="l8.1534" class="difflineminus">-    var currentTabInfo = { name: &quot;&quot;, url: &quot;&quot;, charset: null };</span>
<a href="#l8.1535"></a><span id="l8.1535" class="difflineminus">-</span>
<a href="#l8.1536"></a><span id="l8.1536" class="difflineminus">-    const activeBrowser = aTabBrowser.selectedBrowser;</span>
<a href="#l8.1537"></a><span id="l8.1537" class="difflineminus">-    const browsers = aTabBrowser.browsers;</span>
<a href="#l8.1538"></a><span id="l8.1538" class="difflineminus">-    for (var i = 0; i &lt; browsers.length; ++i) {</span>
<a href="#l8.1539"></a><span id="l8.1539" class="difflineminus">-      var webNav = browsers[i].webNavigation;</span>
<a href="#l8.1540"></a><span id="l8.1540" class="difflineminus">-      var url = webNav.currentURI.spec;</span>
<a href="#l8.1541"></a><span id="l8.1541" class="difflineminus">-      var name = &quot;&quot;;</span>
<a href="#l8.1542"></a><span id="l8.1542" class="difflineminus">-      var charset;</span>
<a href="#l8.1543"></a><span id="l8.1543" class="difflineminus">-      try {</span>
<a href="#l8.1544"></a><span id="l8.1544" class="difflineminus">-        name = webNav.document.title || url;</span>
<a href="#l8.1545"></a><span id="l8.1545" class="difflineminus">-        charset = webNav.document.characterSet;</span>
<a href="#l8.1546"></a><span id="l8.1546" class="difflineminus">-      } catch (e) {</span>
<a href="#l8.1547"></a><span id="l8.1547" class="difflineminus">-        name = url;</span>
<a href="#l8.1548"></a><span id="l8.1548" class="difflineminus">-      }</span>
<a href="#l8.1549"></a><span id="l8.1549" class="difflineminus">-</span>
<a href="#l8.1550"></a><span id="l8.1550" class="difflineminus">-      tabsInfo[i] = { name: name, url: url, charset: charset };</span>
<a href="#l8.1551"></a><span id="l8.1551" class="difflineminus">-</span>
<a href="#l8.1552"></a><span id="l8.1552" class="difflineminus">-      if (browsers[i] == activeBrowser)</span>
<a href="#l8.1553"></a><span id="l8.1553" class="difflineminus">-        currentTabInfo = tabsInfo[i];</span>
<a href="#l8.1554"></a><span id="l8.1554" class="difflineminus">-    }</span>
<a href="#l8.1555"></a><span id="l8.1555" class="difflineminus">-</span>
<a href="#l8.1556"></a><span id="l8.1556" class="difflineminus">-    openDialog(&quot;chrome://communicator/content/bookmarks/addBookmark.xul&quot;, &quot;&quot;,</span>
<a href="#l8.1557"></a><span id="l8.1557" class="difflineminus">-               &quot;centerscreen,chrome,dialog=yes,resizable=yes,dependent&quot;,</span>
<a href="#l8.1558"></a><span id="l8.1558" class="difflineminus">-               currentTabInfo.name, currentTabInfo.url, null,</span>
<a href="#l8.1559"></a><span id="l8.1559" class="difflineminus">-               currentTabInfo.charset, &quot;addGroup&quot; + (aSelect ? &quot;,group&quot; : &quot;&quot;), tabsInfo);</span>
<a href="#l8.1560"></a><span id="l8.1560" class="difflineminus">-  },</span>
<a href="#l8.1561"></a><span id="l8.1561" class="difflineminus">-</span>
<a href="#l8.1562"></a><span id="l8.1562" class="difflineminus">-  addBookmarkForBrowser: function (aDocShell, aShowDialog)</span>
<a href="#l8.1563"></a><span id="l8.1563" class="difflineminus">-  {</span>
<a href="#l8.1564"></a><span id="l8.1564" class="difflineminus">-    // Bug 52536: We obtain the URL and title from the nsIWebNavigation </span>
<a href="#l8.1565"></a><span id="l8.1565" class="difflineminus">-    //            associated with a &lt;browser/&gt; rather than from a DOMWindow.</span>
<a href="#l8.1566"></a><span id="l8.1566" class="difflineminus">-    //            This is because when a full page plugin is loaded, there is</span>
<a href="#l8.1567"></a><span id="l8.1567" class="difflineminus">-    //            no DOMWindow (?) but information about the loaded document</span>
<a href="#l8.1568"></a><span id="l8.1568" class="difflineminus">-    //            may still be obtained from the webNavigation. </span>
<a href="#l8.1569"></a><span id="l8.1569" class="difflineminus">-    var uri = aDocShell.currentURI;</span>
<a href="#l8.1570"></a><span id="l8.1570" class="difflineminus">-    if (uri.schemeIs(&quot;javascript&quot;) || uri.schemeIs(&quot;data&quot;))</span>
<a href="#l8.1571"></a><span id="l8.1571" class="difflineminus">-      aShowDialog = true;</span>
<a href="#l8.1572"></a><span id="l8.1572" class="difflineminus">-    var url = uri.spec;</span>
<a href="#l8.1573"></a><span id="l8.1573" class="difflineminus">-    var title, docCharset = null;</span>
<a href="#l8.1574"></a><span id="l8.1574" class="difflineminus">-    try {</span>
<a href="#l8.1575"></a><span id="l8.1575" class="difflineminus">-      title = aDocShell.document.title || url;</span>
<a href="#l8.1576"></a><span id="l8.1576" class="difflineminus">-      docCharset = aDocShell.document.characterSet;</span>
<a href="#l8.1577"></a><span id="l8.1577" class="difflineminus">-    }</span>
<a href="#l8.1578"></a><span id="l8.1578" class="difflineminus">-    catch (e) {</span>
<a href="#l8.1579"></a><span id="l8.1579" class="difflineminus">-      title = url;</span>
<a href="#l8.1580"></a><span id="l8.1580" class="difflineminus">-    }</span>
<a href="#l8.1581"></a><span id="l8.1581" class="difflineminus">-</span>
<a href="#l8.1582"></a><span id="l8.1582" class="difflineminus">-    this.addBookmark(url, title, docCharset, aShowDialog);</span>
<a href="#l8.1583"></a><span id="l8.1583" class="difflineminus">-  }, </span>
<a href="#l8.1584"></a><span id="l8.1584" class="difflineminus">-</span>
<a href="#l8.1585"></a><span id="l8.1585" class="difflineminus">-  // should update the caller, aShowDialog is no more necessary</span>
<a href="#l8.1586"></a><span id="l8.1586" class="difflineminus">-  addBookmark: function (aURL, aTitle, aCharset, aShowDialog)</span>
<a href="#l8.1587"></a><span id="l8.1587" class="difflineminus">-  {                                                                             </span>
<a href="#l8.1588"></a><span id="l8.1588" class="difflineminus">-    if (aCharset === undefined) {</span>
<a href="#l8.1589"></a><span id="l8.1589" class="difflineminus">-      var fw = document.commandDispatcher.focusedWindow;</span>
<a href="#l8.1590"></a><span id="l8.1590" class="difflineminus">-      aCharset = fw.document.characterSet;</span>
<a href="#l8.1591"></a><span id="l8.1591" class="difflineminus">-    }</span>
<a href="#l8.1592"></a><span id="l8.1592" class="difflineminus">-</span>
<a href="#l8.1593"></a><span id="l8.1593" class="difflineminus">-    if (aShowDialog) {</span>
<a href="#l8.1594"></a><span id="l8.1594" class="difflineminus">-      openDialog(&quot;chrome://communicator/content/bookmarks/addBookmark.xul&quot;, &quot;&quot;,</span>
<a href="#l8.1595"></a><span id="l8.1595" class="difflineminus">-                 &quot;centerscreen,chrome,dialog=yes,resizable=yes,dependent&quot;, aTitle, aURL, null, aCharset);</span>
<a href="#l8.1596"></a><span id="l8.1596" class="difflineminus">-    }</span>
<a href="#l8.1597"></a><span id="l8.1597" class="difflineminus">-    else {</span>
<a href="#l8.1598"></a><span id="l8.1598" class="difflineminus">-      // User has elected to override the file dialog and always file bookmarks</span>
<a href="#l8.1599"></a><span id="l8.1599" class="difflineminus">-      // into the default bookmark folder.</span>
<a href="#l8.1600"></a><span id="l8.1600" class="difflineminus">-      BMSVC.addBookmarkImmediately(aURL, aTitle, kBMSVCIID.BOOKMARK_DEFAULT_TYPE, aCharset);</span>
<a href="#l8.1601"></a><span id="l8.1601" class="difflineminus">-    }</span>
<a href="#l8.1602"></a><span id="l8.1602" class="difflineminus">-  },</span>
<a href="#l8.1603"></a><span id="l8.1603" class="difflineminus">-</span>
<a href="#l8.1604"></a><span id="l8.1604" class="difflineminus">-  shouldLoadTabInBackground: function(aEvent)</span>
<a href="#l8.1605"></a><span id="l8.1605" class="difflineminus">-  {</span>
<a href="#l8.1606"></a><span id="l8.1606" class="difflineminus">-    var loadInBackground = PREF.getBoolPref(&quot;browser.tabs.loadInBackground&quot;);</span>
<a href="#l8.1607"></a><span id="l8.1607" class="difflineminus">-    if (aEvent &amp;&amp; aEvent.shiftKey)</span>
<a href="#l8.1608"></a><span id="l8.1608" class="difflineminus">-      loadInBackground = !loadInBackground;</span>
<a href="#l8.1609"></a><span id="l8.1609" class="difflineminus">-    return loadInBackground;</span>
<a href="#l8.1610"></a><span id="l8.1610" class="difflineminus">-  },</span>
<a href="#l8.1611"></a><span id="l8.1611" class="difflineminus">-</span>
<a href="#l8.1612"></a><span id="l8.1612" class="difflineminus">-  getBrowserTargetFromEvent: function (aEvent)</span>
<a href="#l8.1613"></a><span id="l8.1613" class="difflineminus">-  {</span>
<a href="#l8.1614"></a><span id="l8.1614" class="difflineminus">-    if (!aEvent)</span>
<a href="#l8.1615"></a><span id="l8.1615" class="difflineminus">-      return null;</span>
<a href="#l8.1616"></a><span id="l8.1616" class="difflineminus">-</span>
<a href="#l8.1617"></a><span id="l8.1617" class="difflineminus">-    switch (aEvent.type) {</span>
<a href="#l8.1618"></a><span id="l8.1618" class="difflineminus">-    case &quot;click&quot;:</span>
<a href="#l8.1619"></a><span id="l8.1619" class="difflineminus">-    case &quot;dblclick&quot;:</span>
<a href="#l8.1620"></a><span id="l8.1620" class="difflineminus">-      if (aEvent.button &gt; 1)</span>
<a href="#l8.1621"></a><span id="l8.1621" class="difflineminus">-        return null;</span>
<a href="#l8.1622"></a><span id="l8.1622" class="difflineminus">-</span>
<a href="#l8.1623"></a><span id="l8.1623" class="difflineminus">-      // Prevent default click handling (e.g. middlemouse.contentLoadURL==true)</span>
<a href="#l8.1624"></a><span id="l8.1624" class="difflineminus">-      aEvent.preventDefault();</span>
<a href="#l8.1625"></a><span id="l8.1625" class="difflineminus">-</span>
<a href="#l8.1626"></a><span id="l8.1626" class="difflineminus">-      if (aEvent.button != 1 &amp;&amp; !aEvent.metaKey &amp;&amp; !aEvent.ctrlKey)</span>
<a href="#l8.1627"></a><span id="l8.1627" class="difflineminus">-        return &quot;current&quot;;</span>
<a href="#l8.1628"></a><span id="l8.1628" class="difflineminus">-</span>
<a href="#l8.1629"></a><span id="l8.1629" class="difflineminus">-      break;</span>
<a href="#l8.1630"></a><span id="l8.1630" class="difflineminus">-    case &quot;keypress&quot;:</span>
<a href="#l8.1631"></a><span id="l8.1631" class="difflineminus">-    case &quot;command&quot;:</span>
<a href="#l8.1632"></a><span id="l8.1632" class="difflineminus">-      if (!aEvent.metaKey &amp;&amp; !aEvent.ctrlKey)</span>
<a href="#l8.1633"></a><span id="l8.1633" class="difflineminus">-        return &quot;current&quot;;</span>
<a href="#l8.1634"></a><span id="l8.1634" class="difflineminus">-</span>
<a href="#l8.1635"></a><span id="l8.1635" class="difflineminus">-      break;</span>
<a href="#l8.1636"></a><span id="l8.1636" class="difflineminus">-    default:</span>
<a href="#l8.1637"></a><span id="l8.1637" class="difflineminus">-      return null;</span>
<a href="#l8.1638"></a><span id="l8.1638" class="difflineminus">-    }</span>
<a href="#l8.1639"></a><span id="l8.1639" class="difflineminus">-</span>
<a href="#l8.1640"></a><span id="l8.1640" class="difflineminus">-    if (PREF &amp;&amp; PREF.getBoolPref(&quot;browser.tabs.opentabfor.middleclick&quot;))</span>
<a href="#l8.1641"></a><span id="l8.1641" class="difflineminus">-      return &quot;tab&quot;;</span>
<a href="#l8.1642"></a><span id="l8.1642" class="difflineminus">-</span>
<a href="#l8.1643"></a><span id="l8.1643" class="difflineminus">-    if (PREF &amp;&amp; PREF.getBoolPref(&quot;middlemouse.openNewWindow&quot;))</span>
<a href="#l8.1644"></a><span id="l8.1644" class="difflineminus">-      return &quot;window&quot;;</span>
<a href="#l8.1645"></a><span id="l8.1645" class="difflineminus">-</span>
<a href="#l8.1646"></a><span id="l8.1646" class="difflineminus">-    return null;</span>
<a href="#l8.1647"></a><span id="l8.1647" class="difflineminus">-  },</span>
<a href="#l8.1648"></a><span id="l8.1648" class="difflineminus">-</span>
<a href="#l8.1649"></a><span id="l8.1649" class="difflineminus">-  loadBookmarkBrowser: function (aEvent, aDS)</span>
<a href="#l8.1650"></a><span id="l8.1650" class="difflineminus">-  {</span>
<a href="#l8.1651"></a><span id="l8.1651" class="difflineminus">-    var target = BookmarksUtils.getBrowserTargetFromEvent(aEvent);</span>
<a href="#l8.1652"></a><span id="l8.1652" class="difflineminus">-    if (!target)</span>
<a href="#l8.1653"></a><span id="l8.1653" class="difflineminus">-      return;</span>
<a href="#l8.1654"></a><span id="l8.1654" class="difflineminus">-</span>
<a href="#l8.1655"></a><span id="l8.1655" class="difflineminus">-    var rSource   = RDF.GetResource(aEvent.target.id);</span>
<a href="#l8.1656"></a><span id="l8.1656" class="difflineminus">-    var selection = BookmarksUtils.getSelectionFromResource(rSource);</span>
<a href="#l8.1657"></a><span id="l8.1657" class="difflineminus">-    BookmarksCommand.openBookmark(selection, target, aDS, aEvent)</span>
<a href="#l8.1658"></a><span id="l8.1658" class="difflineminus">-  }</span>
<a href="#l8.1659"></a><span id="l8.1659" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1">deleted file mode 100644</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineminus">--- a/suite/common/bookmarks/bookmarksMenu.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineplus">+++ /dev/null</span>
<a href="#l9.4"></a><span id="l9.4" class="difflineat">@@ -1,837 +0,0 @@</span>
<a href="#l9.5"></a><span id="l9.5" class="difflineminus">-/* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l9.6"></a><span id="l9.6" class="difflineminus">-/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l9.7"></a><span id="l9.7" class="difflineminus">- * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l9.8"></a><span id="l9.8" class="difflineminus">- *</span>
<a href="#l9.9"></a><span id="l9.9" class="difflineminus">- * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l9.10"></a><span id="l9.10" class="difflineminus">- * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l9.11"></a><span id="l9.11" class="difflineminus">- * the License. You may obtain a copy of the License at</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">- * http://www.mozilla.org/MPL/</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">- *</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineminus">- * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineminus">- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineminus">- * for the specific language governing rights and limitations under the</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineminus">- * License.</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineminus">- *</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineminus">- * The Original Code is mozilla.org code.</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineminus">- *</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineminus">- * The Initial Developer of the Original Code is</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineminus">- * Pierre Chanial &lt;chanial@noos.fr&gt;.</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineminus">- * Portions created by the Initial Developer are Copyright (C) 1998</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineminus">- * the Initial Developer. All Rights Reserved.</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineminus">- *</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineminus">- * Contributor(s):</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineminus">- *</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineminus">- * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineminus">- * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineminus">- * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineminus">- * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineminus">- * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineminus">- * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineminus">- * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineminus">- * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineminus">- * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineminus">- * the provisions above, a recipient may use your version of this file under</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineminus">- * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineminus">- *</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineminus">- * ***** END LICENSE BLOCK ***** */</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineminus">-</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineminus">-var BookmarksMenu = {</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineminus">-  _selection:null,</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineminus">-  _target:null,</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineminus">-  _orientation:null,</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineminus">-</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineminus">-  //////////////////////////////////////////////////////////////////////////</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineminus">-  // Fill a context menu popup with menuitems appropriate for the current</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineminus">-  // selection.</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineminus">-  createContextMenu: function (aEvent)</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineminus">-  {</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineminus">-    var target = document.popupNode;</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineminus">-    if (!this.isBTBookmark(target.id) &amp;&amp; target.id != &quot;bookmarks-ptf&quot;)</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineminus">-      return false;</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineminus">-    target.focus() // buttons in the pt have -moz-user-focus: ignore --&gt;</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineminus">-    this._selection   = this.getBTSelection(target);</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineminus">-    this._orientation = this.getBTOrientation(aEvent, target);</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineminus">-    this._target      = this.getBTTarget(target, this._orientation);</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineminus">-    BookmarksCommand.createContextMenu(aEvent, this._selection);</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineminus">-    this.onCommandUpdate();</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineminus">-    aEvent.target.addEventListener(&quot;mousemove&quot;, BookmarksMenuController.onMouseMove, false);</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineminus">-    return true;</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineminus">-  },</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineminus">-</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineminus">-  /////////////////////////////////////////////////////////////////////////</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineminus">-  // Clean up after closing the context menu popup</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineminus">-  destroyContextMenu: function (aEvent)</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineminus">-  {</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineminus">-    if (content)</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineminus">-      content.focus();</span>
<a href="#l9.71"></a><span id="l9.71" class="difflineminus">-    BookmarksMenuDNDObserver.onDragRemoveFeedBack(document.popupNode); // needed on cancel</span>
<a href="#l9.72"></a><span id="l9.72" class="difflineminus">-    aEvent.target.removeEventListener(&quot;mousemove&quot;, BookmarksMenuController.onMouseMove, false);</span>
<a href="#l9.73"></a><span id="l9.73" class="difflineminus">-  },</span>
<a href="#l9.74"></a><span id="l9.74" class="difflineminus">-</span>
<a href="#l9.75"></a><span id="l9.75" class="difflineminus">-  /////////////////////////////////////////////////////////////////////////////</span>
<a href="#l9.76"></a><span id="l9.76" class="difflineminus">-  // returns the formatted selection from aNode</span>
<a href="#l9.77"></a><span id="l9.77" class="difflineminus">-  getBTSelection: function (aNode)</span>
<a href="#l9.78"></a><span id="l9.78" class="difflineminus">-  {</span>
<a href="#l9.79"></a><span id="l9.79" class="difflineminus">-    var item;</span>
<a href="#l9.80"></a><span id="l9.80" class="difflineminus">-    switch (aNode.id) {</span>
<a href="#l9.81"></a><span id="l9.81" class="difflineminus">-    case &quot;bookmarks-ptf&quot;:</span>
<a href="#l9.82"></a><span id="l9.82" class="difflineminus">-      item = &quot;NC:PersonalToolbarFolder&quot;;</span>
<a href="#l9.83"></a><span id="l9.83" class="difflineminus">-      break;</span>
<a href="#l9.84"></a><span id="l9.84" class="difflineminus">-    case &quot;BookmarksMenu&quot;:</span>
<a href="#l9.85"></a><span id="l9.85" class="difflineminus">-      item = &quot;NC:BookmarksRoot&quot;;</span>
<a href="#l9.86"></a><span id="l9.86" class="difflineminus">-      break;</span>
<a href="#l9.87"></a><span id="l9.87" class="difflineminus">-    default:</span>
<a href="#l9.88"></a><span id="l9.88" class="difflineminus">-      item = aNode.id;</span>
<a href="#l9.89"></a><span id="l9.89" class="difflineminus">-    }</span>
<a href="#l9.90"></a><span id="l9.90" class="difflineminus">-    if (!this.isBTBookmark(item))</span>
<a href="#l9.91"></a><span id="l9.91" class="difflineminus">-      return {length:0};</span>
<a href="#l9.92"></a><span id="l9.92" class="difflineminus">-    var parent           = this.getBTContainer(aNode);</span>
<a href="#l9.93"></a><span id="l9.93" class="difflineminus">-    var isExpanded       = aNode.hasAttribute(&quot;open&quot;) &amp;&amp; aNode.open;</span>
<a href="#l9.94"></a><span id="l9.94" class="difflineminus">-    var selection        = {};</span>
<a href="#l9.95"></a><span id="l9.95" class="difflineminus">-    selection.item       = [RDF.GetResource(item)];</span>
<a href="#l9.96"></a><span id="l9.96" class="difflineminus">-    selection.parent     = [RDF.GetResource(parent)];</span>
<a href="#l9.97"></a><span id="l9.97" class="difflineminus">-    selection.isExpanded = [isExpanded];</span>
<a href="#l9.98"></a><span id="l9.98" class="difflineminus">-    selection.length     = selection.item.length;</span>
<a href="#l9.99"></a><span id="l9.99" class="difflineminus">-    BookmarksUtils.checkSelection(selection);</span>
<a href="#l9.100"></a><span id="l9.100" class="difflineminus">-    return selection;</span>
<a href="#l9.101"></a><span id="l9.101" class="difflineminus">-  },</span>
<a href="#l9.102"></a><span id="l9.102" class="difflineminus">-</span>
<a href="#l9.103"></a><span id="l9.103" class="difflineminus">-  /////////////////////////////////////////////////////////////////////////</span>
<a href="#l9.104"></a><span id="l9.104" class="difflineminus">-  // returns the insertion target from aNode</span>
<a href="#l9.105"></a><span id="l9.105" class="difflineminus">-  getBTTarget: function (aNode, aOrientation)</span>
<a href="#l9.106"></a><span id="l9.106" class="difflineminus">-  {</span>
<a href="#l9.107"></a><span id="l9.107" class="difflineminus">-    var item, parent, index;</span>
<a href="#l9.108"></a><span id="l9.108" class="difflineminus">-</span>
<a href="#l9.109"></a><span id="l9.109" class="difflineminus">-    switch (aNode.id) {</span>
<a href="#l9.110"></a><span id="l9.110" class="difflineminus">-    case &quot;BookmarksMenu&quot;:</span>
<a href="#l9.111"></a><span id="l9.111" class="difflineminus">-    case &quot;bookmarks-button&quot;:</span>
<a href="#l9.112"></a><span id="l9.112" class="difflineminus">-      parent = &quot;NC:BookmarksRoot&quot;;</span>
<a href="#l9.113"></a><span id="l9.113" class="difflineminus">-      break;</span>
<a href="#l9.114"></a><span id="l9.114" class="difflineminus">-    case &quot;bookmarks-ptf&quot;:</span>
<a href="#l9.115"></a><span id="l9.115" class="difflineminus">-      item = BookmarksToolbar.getLastVisibleBookmark();</span>
<a href="#l9.116"></a><span id="l9.116" class="difflineminus">-      // Continue to next case.</span>
<a href="#l9.117"></a><span id="l9.117" class="difflineminus">-    case &quot;bookmarks-chevron&quot;:</span>
<a href="#l9.118"></a><span id="l9.118" class="difflineminus">-      parent = &quot;NC:PersonalToolbarFolder&quot;;</span>
<a href="#l9.119"></a><span id="l9.119" class="difflineminus">-      break;</span>
<a href="#l9.120"></a><span id="l9.120" class="difflineminus">-    default:</span>
<a href="#l9.121"></a><span id="l9.121" class="difflineminus">-      if (aOrientation == BookmarksUtils.DROP_ON)</span>
<a href="#l9.122"></a><span id="l9.122" class="difflineminus">-        parent = aNode.id || aNode.parentNode.parentNode.id;</span>
<a href="#l9.123"></a><span id="l9.123" class="difflineminus">-      else {</span>
<a href="#l9.124"></a><span id="l9.124" class="difflineminus">-        parent = this.getBTContainer(aNode);</span>
<a href="#l9.125"></a><span id="l9.125" class="difflineminus">-        item = aNode;</span>
<a href="#l9.126"></a><span id="l9.126" class="difflineminus">-      }</span>
<a href="#l9.127"></a><span id="l9.127" class="difflineminus">-    }</span>
<a href="#l9.128"></a><span id="l9.128" class="difflineminus">-</span>
<a href="#l9.129"></a><span id="l9.129" class="difflineminus">-    parent = RDF.GetResource(parent);</span>
<a href="#l9.130"></a><span id="l9.130" class="difflineminus">-    if (aOrientation == BookmarksUtils.DROP_ON)</span>
<a href="#l9.131"></a><span id="l9.131" class="difflineminus">-      return BookmarksUtils.getTargetFromFolder(parent);</span>
<a href="#l9.132"></a><span id="l9.132" class="difflineminus">-</span>
<a href="#l9.133"></a><span id="l9.133" class="difflineminus">-    item = RDF.GetResource(item.id);</span>
<a href="#l9.134"></a><span id="l9.134" class="difflineminus">-    RDFC.Init(BMDS, parent);</span>
<a href="#l9.135"></a><span id="l9.135" class="difflineminus">-    index = RDFC.IndexOf(item);</span>
<a href="#l9.136"></a><span id="l9.136" class="difflineminus">-    if (aOrientation == BookmarksUtils.DROP_AFTER)</span>
<a href="#l9.137"></a><span id="l9.137" class="difflineminus">-      ++index;</span>
<a href="#l9.138"></a><span id="l9.138" class="difflineminus">-</span>
<a href="#l9.139"></a><span id="l9.139" class="difflineminus">-    return { parent: parent, index: index };</span>
<a href="#l9.140"></a><span id="l9.140" class="difflineminus">-  },</span>
<a href="#l9.141"></a><span id="l9.141" class="difflineminus">-</span>
<a href="#l9.142"></a><span id="l9.142" class="difflineminus">-  /////////////////////////////////////////////////////////////////////////</span>
<a href="#l9.143"></a><span id="l9.143" class="difflineminus">-  // returns the parent resource of a node in the personal toolbar.</span>
<a href="#l9.144"></a><span id="l9.144" class="difflineminus">-  // this is determined by inspecting the source element and walking up the </span>
<a href="#l9.145"></a><span id="l9.145" class="difflineminus">-  // DOM tree to find the appropriate containing node.</span>
<a href="#l9.146"></a><span id="l9.146" class="difflineminus">-  getBTContainer: function (aNode)</span>
<a href="#l9.147"></a><span id="l9.147" class="difflineminus">-  {</span>
<a href="#l9.148"></a><span id="l9.148" class="difflineminus">-    var parent;</span>
<a href="#l9.149"></a><span id="l9.149" class="difflineminus">-    var item = aNode.id;</span>
<a href="#l9.150"></a><span id="l9.150" class="difflineminus">-    if (!this.isBTBookmark(item))</span>
<a href="#l9.151"></a><span id="l9.151" class="difflineminus">-      return &quot;NC:BookmarksRoot&quot;</span>
<a href="#l9.152"></a><span id="l9.152" class="difflineminus">-    parent = aNode.parentNode.parentNode;</span>
<a href="#l9.153"></a><span id="l9.153" class="difflineminus">-    parent = parent.id;</span>
<a href="#l9.154"></a><span id="l9.154" class="difflineminus">-    switch (parent) {</span>
<a href="#l9.155"></a><span id="l9.155" class="difflineminus">-    case &quot;BookmarksMenu&quot;:</span>
<a href="#l9.156"></a><span id="l9.156" class="difflineminus">-    case &quot;bookmarks-button&quot;:</span>
<a href="#l9.157"></a><span id="l9.157" class="difflineminus">-      return &quot;NC:BookmarksRoot&quot;;</span>
<a href="#l9.158"></a><span id="l9.158" class="difflineminus">-    case &quot;personal-bookmarks&quot;:</span>
<a href="#l9.159"></a><span id="l9.159" class="difflineminus">-    case &quot;bookmarks-chevron&quot;:</span>
<a href="#l9.160"></a><span id="l9.160" class="difflineminus">-      return &quot;NC:PersonalToolbarFolder&quot;;</span>
<a href="#l9.161"></a><span id="l9.161" class="difflineminus">-    default:</span>
<a href="#l9.162"></a><span id="l9.162" class="difflineminus">-      return parent;</span>
<a href="#l9.163"></a><span id="l9.163" class="difflineminus">-    }</span>
<a href="#l9.164"></a><span id="l9.164" class="difflineminus">-  },</span>
<a href="#l9.165"></a><span id="l9.165" class="difflineminus">-</span>
<a href="#l9.166"></a><span id="l9.166" class="difflineminus">-  ///////////////////////////////////////////////////////////////////////////</span>
<a href="#l9.167"></a><span id="l9.167" class="difflineminus">-  // returns true if the node is a bookmark, a folder or a bookmark separator</span>
<a href="#l9.168"></a><span id="l9.168" class="difflineminus">-  isBTBookmark: function (aURI)</span>
<a href="#l9.169"></a><span id="l9.169" class="difflineminus">-  {</span>
<a href="#l9.170"></a><span id="l9.170" class="difflineminus">-    if (!aURI)</span>
<a href="#l9.171"></a><span id="l9.171" class="difflineminus">-      return false;</span>
<a href="#l9.172"></a><span id="l9.172" class="difflineminus">-    var type = BookmarksUtils.resolveType(aURI);</span>
<a href="#l9.173"></a><span id="l9.173" class="difflineminus">-    return (type == &quot;BookmarkSeparator&quot; ||</span>
<a href="#l9.174"></a><span id="l9.174" class="difflineminus">-            type == &quot;Bookmark&quot;          ||</span>
<a href="#l9.175"></a><span id="l9.175" class="difflineminus">-            type == &quot;Folder&quot;            ||</span>
<a href="#l9.176"></a><span id="l9.176" class="difflineminus">-            type == &quot;FolderGroup&quot;       ||</span>
<a href="#l9.177"></a><span id="l9.177" class="difflineminus">-            type == &quot;PersonalToolbarFolder&quot;)</span>
<a href="#l9.178"></a><span id="l9.178" class="difflineminus">-  },</span>
<a href="#l9.179"></a><span id="l9.179" class="difflineminus">-</span>
<a href="#l9.180"></a><span id="l9.180" class="difflineminus">-  /////////////////////////////////////////////////////////////////////////</span>
<a href="#l9.181"></a><span id="l9.181" class="difflineminus">-  // returns true if the node is a container. --&gt;</span>
<a href="#l9.182"></a><span id="l9.182" class="difflineminus">-  isBTContainer: function (aTarget)</span>
<a href="#l9.183"></a><span id="l9.183" class="difflineminus">-  {</span>
<a href="#l9.184"></a><span id="l9.184" class="difflineminus">-    return  aTarget.localName == &quot;menu&quot; || (aTarget.localName == &quot;toolbarbutton&quot; &amp;&amp;</span>
<a href="#l9.185"></a><span id="l9.185" class="difflineminus">-           (aTarget.getAttribute(&quot;container&quot;) == &quot;true&quot; || aTarget.getAttribute(&quot;group&quot;) == &quot;true&quot;));</span>
<a href="#l9.186"></a><span id="l9.186" class="difflineminus">-  },</span>
<a href="#l9.187"></a><span id="l9.187" class="difflineminus">-</span>
<a href="#l9.188"></a><span id="l9.188" class="difflineminus">-  /////////////////////////////////////////////////////////////////////////</span>
<a href="#l9.189"></a><span id="l9.189" class="difflineminus">-  // returns BookmarksUtils.DROP_BEFORE, DROP_ON or DROP_AFTER accordingly</span>
<a href="#l9.190"></a><span id="l9.190" class="difflineminus">-  // to the event coordinates. Skin authors could break us, we'll cross that </span>
<a href="#l9.191"></a><span id="l9.191" class="difflineminus">-  // bridge when they turn us 90degrees.  --&gt;</span>
<a href="#l9.192"></a><span id="l9.192" class="difflineminus">-  getBTOrientation: function (aEvent, aTarget)</span>
<a href="#l9.193"></a><span id="l9.193" class="difflineminus">-  {</span>
<a href="#l9.194"></a><span id="l9.194" class="difflineminus">-    var target = aTarget || aEvent.target;</span>
<a href="#l9.195"></a><span id="l9.195" class="difflineminus">-    if (target.localName == &quot;menu&quot; &amp;&amp;</span>
<a href="#l9.196"></a><span id="l9.196" class="difflineminus">-        target.parentNode.localName != &quot;menupopup&quot;)</span>
<a href="#l9.197"></a><span id="l9.197" class="difflineminus">-      return BookmarksUtils.DROP_ON;</span>
<a href="#l9.198"></a><span id="l9.198" class="difflineminus">-    if (target.id == &quot;bookmarks-ptf&quot;) {</span>
<a href="#l9.199"></a><span id="l9.199" class="difflineminus">-      return target.hasChildNodes() ?</span>
<a href="#l9.200"></a><span id="l9.200" class="difflineminus">-          BookmarksUtils.DROP_AFTER : BookmarksUtils.DROP_ON;</span>
<a href="#l9.201"></a><span id="l9.201" class="difflineminus">-    }</span>
<a href="#l9.202"></a><span id="l9.202" class="difflineminus">-    if (target.id == &quot;bookmarks-chevron&quot;)</span>
<a href="#l9.203"></a><span id="l9.203" class="difflineminus">-      return BookmarksUtils.DROP_ON;</span>
<a href="#l9.204"></a><span id="l9.204" class="difflineminus">-    if (target.className == &quot;isempty&quot;)</span>
<a href="#l9.205"></a><span id="l9.205" class="difflineminus">-      return BookmarksUtils.DROP_ON;</span>
<a href="#l9.206"></a><span id="l9.206" class="difflineminus">-</span>
<a href="#l9.207"></a><span id="l9.207" class="difflineminus">-    var overButtonBoxObject = target.boxObject.QueryInterface(Components.interfaces.nsIBoxObject);</span>
<a href="#l9.208"></a><span id="l9.208" class="difflineminus">-    var overParentBoxObject = target.parentNode.boxObject.QueryInterface(Components.interfaces.nsIBoxObject);</span>
<a href="#l9.209"></a><span id="l9.209" class="difflineminus">-</span>
<a href="#l9.210"></a><span id="l9.210" class="difflineminus">-    var size, border;</span>
<a href="#l9.211"></a><span id="l9.211" class="difflineminus">-    var coordValue, clientCoordValue;</span>
<a href="#l9.212"></a><span id="l9.212" class="difflineminus">-    switch (target.localName) {</span>
<a href="#l9.213"></a><span id="l9.213" class="difflineminus">-      case &quot;toolbarseparator&quot;:</span>
<a href="#l9.214"></a><span id="l9.214" class="difflineminus">-      case &quot;toolbarbutton&quot;:</span>
<a href="#l9.215"></a><span id="l9.215" class="difflineminus">-        size = overButtonBoxObject.width;</span>
<a href="#l9.216"></a><span id="l9.216" class="difflineminus">-        coordValue = overButtonBoxObject.x;</span>
<a href="#l9.217"></a><span id="l9.217" class="difflineminus">-        clientCoordValue = aEvent.clientX;</span>
<a href="#l9.218"></a><span id="l9.218" class="difflineminus">-        break;</span>
<a href="#l9.219"></a><span id="l9.219" class="difflineminus">-      case &quot;menuseparator&quot;: </span>
<a href="#l9.220"></a><span id="l9.220" class="difflineminus">-      case &quot;menu&quot;:</span>
<a href="#l9.221"></a><span id="l9.221" class="difflineminus">-      case &quot;menuitem&quot;:</span>
<a href="#l9.222"></a><span id="l9.222" class="difflineminus">-        size = overButtonBoxObject.height;</span>
<a href="#l9.223"></a><span id="l9.223" class="difflineminus">-        coordValue = overButtonBoxObject.screenY;</span>
<a href="#l9.224"></a><span id="l9.224" class="difflineminus">-        clientCoordValue = aEvent.screenY;</span>
<a href="#l9.225"></a><span id="l9.225" class="difflineminus">-        break;</span>
<a href="#l9.226"></a><span id="l9.226" class="difflineminus">-      default:</span>
<a href="#l9.227"></a><span id="l9.227" class="difflineminus">-        return BookmarksUtils.DROP_ON;</span>
<a href="#l9.228"></a><span id="l9.228" class="difflineminus">-    }</span>
<a href="#l9.229"></a><span id="l9.229" class="difflineminus">-    if (this.isBTContainer(target))</span>
<a href="#l9.230"></a><span id="l9.230" class="difflineminus">-      if (target.localName == &quot;toolbarbutton&quot;) {</span>
<a href="#l9.231"></a><span id="l9.231" class="difflineminus">-        // the DROP_BEFORE area excludes the label</span>
<a href="#l9.232"></a><span id="l9.232" class="difflineminus">-        var iconNode = document.getAnonymousElementByAttribute(target, &quot;class&quot;, &quot;toolbarbutton-icon&quot;);</span>
<a href="#l9.233"></a><span id="l9.233" class="difflineminus">-        border = parseInt(document.defaultView.getComputedStyle(target, &quot;&quot;).getPropertyValue(&quot;padding-left&quot;)) +</span>
<a href="#l9.234"></a><span id="l9.234" class="difflineminus">-                 parseInt(document.defaultView.getComputedStyle(iconNode, &quot;&quot;).getPropertyValue(&quot;width&quot;));</span>
<a href="#l9.235"></a><span id="l9.235" class="difflineminus">-        border = Math.min(size / 5, Math.max(border, 4));</span>
<a href="#l9.236"></a><span id="l9.236" class="difflineminus">-      } else</span>
<a href="#l9.237"></a><span id="l9.237" class="difflineminus">-        border = size / 5;</span>
<a href="#l9.238"></a><span id="l9.238" class="difflineminus">-    else</span>
<a href="#l9.239"></a><span id="l9.239" class="difflineminus">-      border = size / 2;</span>
<a href="#l9.240"></a><span id="l9.240" class="difflineminus">-</span>
<a href="#l9.241"></a><span id="l9.241" class="difflineminus">-    // in the first region?</span>
<a href="#l9.242"></a><span id="l9.242" class="difflineminus">-    if (clientCoordValue - coordValue &lt; border)</span>
<a href="#l9.243"></a><span id="l9.243" class="difflineminus">-      return BookmarksUtils.DROP_BEFORE;</span>
<a href="#l9.244"></a><span id="l9.244" class="difflineminus">-    // in the last region?</span>
<a href="#l9.245"></a><span id="l9.245" class="difflineminus">-    if (clientCoordValue - coordValue &gt;= size - border)</span>
<a href="#l9.246"></a><span id="l9.246" class="difflineminus">-      return BookmarksUtils.DROP_AFTER;</span>
<a href="#l9.247"></a><span id="l9.247" class="difflineminus">-    // must be in the middle somewhere</span>
<a href="#l9.248"></a><span id="l9.248" class="difflineminus">-    return BookmarksUtils.DROP_ON;</span>
<a href="#l9.249"></a><span id="l9.249" class="difflineminus">-  },</span>
<a href="#l9.250"></a><span id="l9.250" class="difflineminus">-</span>
<a href="#l9.251"></a><span id="l9.251" class="difflineminus">-  /////////////////////////////////////////////////////////////////////////</span>
<a href="#l9.252"></a><span id="l9.252" class="difflineminus">-  // expand the folder targeted by the context menu.</span>
<a href="#l9.253"></a><span id="l9.253" class="difflineminus">-  expandBTFolder: function ()</span>
<a href="#l9.254"></a><span id="l9.254" class="difflineminus">-  {</span>
<a href="#l9.255"></a><span id="l9.255" class="difflineminus">-    var target = document.popupNode.lastChild;</span>
<a href="#l9.256"></a><span id="l9.256" class="difflineminus">-    if (document.popupNode.open)</span>
<a href="#l9.257"></a><span id="l9.257" class="difflineminus">-      target.hidePopup();</span>
<a href="#l9.258"></a><span id="l9.258" class="difflineminus">-    else</span>
<a href="#l9.259"></a><span id="l9.259" class="difflineminus">-      target.showPopup(document.popupNode);</span>
<a href="#l9.260"></a><span id="l9.260" class="difflineminus">-  },</span>
<a href="#l9.261"></a><span id="l9.261" class="difflineminus">-</span>
<a href="#l9.262"></a><span id="l9.262" class="difflineminus">-  onCommandUpdate: function ()</span>
<a href="#l9.263"></a><span id="l9.263" class="difflineminus">-  {</span>
<a href="#l9.264"></a><span id="l9.264" class="difflineminus">-    var selection = this._selection;</span>
<a href="#l9.265"></a><span id="l9.265" class="difflineminus">-    var target    = this._target;</span>
<a href="#l9.266"></a><span id="l9.266" class="difflineminus">-    BookmarksController.onCommandUpdate(selection, target);</span>
<a href="#l9.267"></a><span id="l9.267" class="difflineminus">-    if (document.popupNode.id == &quot;bookmarks-ptf&quot;) {</span>
<a href="#l9.268"></a><span id="l9.268" class="difflineminus">-      // disabling 'cut' and 'copy' on the empty area of the personal toolbar</span>
<a href="#l9.269"></a><span id="l9.269" class="difflineminus">-      var commandNode = document.getElementById(&quot;cmd_bm_cut&quot;);</span>
<a href="#l9.270"></a><span id="l9.270" class="difflineminus">-      commandNode.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l9.271"></a><span id="l9.271" class="difflineminus">-      commandNode = document.getElementById(&quot;cmd_bm_copy&quot;);</span>
<a href="#l9.272"></a><span id="l9.272" class="difflineminus">-      commandNode.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l9.273"></a><span id="l9.273" class="difflineminus">-    }</span>
<a href="#l9.274"></a><span id="l9.274" class="difflineminus">-  },</span>
<a href="#l9.275"></a><span id="l9.275" class="difflineminus">-</span>
<a href="#l9.276"></a><span id="l9.276" class="difflineminus">-  loadBookmark: function (aEvent, aDS)</span>
<a href="#l9.277"></a><span id="l9.277" class="difflineminus">-  {</span>
<a href="#l9.278"></a><span id="l9.278" class="difflineminus">-    if (this.isBTBookmark(aEvent.target.id))</span>
<a href="#l9.279"></a><span id="l9.279" class="difflineminus">-      BookmarksUtils.loadBookmarkBrowser(aEvent, aDS);</span>
<a href="#l9.280"></a><span id="l9.280" class="difflineminus">-  },</span>
<a href="#l9.281"></a><span id="l9.281" class="difflineminus">-</span>
<a href="#l9.282"></a><span id="l9.282" class="difflineminus">-  ////////////////////////////////////////////////</span>
<a href="#l9.283"></a><span id="l9.283" class="difflineminus">-  // loads a bookmark with the middle mouse button</span>
<a href="#l9.284"></a><span id="l9.284" class="difflineminus">-  loadBookmarkMiddleClick: function (aEvent, aDS)</span>
<a href="#l9.285"></a><span id="l9.285" class="difflineminus">-  {</span>
<a href="#l9.286"></a><span id="l9.286" class="difflineminus">-    if (aEvent.type != &quot;click&quot; || aEvent.button != 1)</span>
<a href="#l9.287"></a><span id="l9.287" class="difflineminus">-      return;</span>
<a href="#l9.288"></a><span id="l9.288" class="difflineminus">-    // unlike for command events, we have to close the menus manually</span>
<a href="#l9.289"></a><span id="l9.289" class="difflineminus">-    for (var node = aEvent.target; node != aEvent.currentTarget;</span>
<a href="#l9.290"></a><span id="l9.290" class="difflineminus">-         node = node.parentNode) {</span>
<a href="#l9.291"></a><span id="l9.291" class="difflineminus">-      if (node.nodeType == node.ELEMENT_NODE &amp;&amp; node.tagName == &quot;menupopup&quot;)</span>
<a href="#l9.292"></a><span id="l9.292" class="difflineminus">-        node.hidePopup();</span>
<a href="#l9.293"></a><span id="l9.293" class="difflineminus">-    }</span>
<a href="#l9.294"></a><span id="l9.294" class="difflineminus">-    this.loadBookmark(aEvent, aDS);</span>
<a href="#l9.295"></a><span id="l9.295" class="difflineminus">-  }</span>
<a href="#l9.296"></a><span id="l9.296" class="difflineminus">-}</span>
<a href="#l9.297"></a><span id="l9.297" class="difflineminus">-</span>
<a href="#l9.298"></a><span id="l9.298" class="difflineminus">-var BookmarksMenuController = {</span>
<a href="#l9.299"></a><span id="l9.299" class="difflineminus">-</span>
<a href="#l9.300"></a><span id="l9.300" class="difflineminus">-  supportsCommand: function (aCommand)</span>
<a href="#l9.301"></a><span id="l9.301" class="difflineminus">-  {</span>
<a href="#l9.302"></a><span id="l9.302" class="difflineminus">-    var isCommandSupported;</span>
<a href="#l9.303"></a><span id="l9.303" class="difflineminus">-    switch(aCommand) {</span>
<a href="#l9.304"></a><span id="l9.304" class="difflineminus">-    case &quot;cmd_bm_cut&quot;:</span>
<a href="#l9.305"></a><span id="l9.305" class="difflineminus">-    case &quot;cmd_bm_copy&quot;:</span>
<a href="#l9.306"></a><span id="l9.306" class="difflineminus">-    case &quot;cmd_bm_paste&quot;:</span>
<a href="#l9.307"></a><span id="l9.307" class="difflineminus">-    case &quot;cmd_bm_delete&quot;:</span>
<a href="#l9.308"></a><span id="l9.308" class="difflineminus">-    case &quot;cmd_bm_open&quot;:</span>
<a href="#l9.309"></a><span id="l9.309" class="difflineminus">-    case &quot;cmd_bm_openinnewwindow&quot;:</span>
<a href="#l9.310"></a><span id="l9.310" class="difflineminus">-    case &quot;cmd_bm_openinnewtab&quot;:</span>
<a href="#l9.311"></a><span id="l9.311" class="difflineminus">-    case &quot;cmd_bm_managefolder&quot;:</span>
<a href="#l9.312"></a><span id="l9.312" class="difflineminus">-    case &quot;cmd_bm_newfolder&quot;:</span>
<a href="#l9.313"></a><span id="l9.313" class="difflineminus">-    case &quot;cmd_bm_properties&quot;:</span>
<a href="#l9.314"></a><span id="l9.314" class="difflineminus">-    case &quot;cmd_bm_rename&quot;:</span>
<a href="#l9.315"></a><span id="l9.315" class="difflineminus">-    case &quot;cmd_bm_movebookmark&quot;:</span>
<a href="#l9.316"></a><span id="l9.316" class="difflineminus">-    case &quot;cmd_bm_sortfolderbyname&quot;:</span>
<a href="#l9.317"></a><span id="l9.317" class="difflineminus">-    case &quot;cmd_bm_sortfolder&quot;:</span>
<a href="#l9.318"></a><span id="l9.318" class="difflineminus">-      isCommandSupported = true;</span>
<a href="#l9.319"></a><span id="l9.319" class="difflineminus">-      break;</span>
<a href="#l9.320"></a><span id="l9.320" class="difflineminus">-    default:</span>
<a href="#l9.321"></a><span id="l9.321" class="difflineminus">-      isCommandSupported = false;</span>
<a href="#l9.322"></a><span id="l9.322" class="difflineminus">-    }</span>
<a href="#l9.323"></a><span id="l9.323" class="difflineminus">-    return isCommandSupported;</span>
<a href="#l9.324"></a><span id="l9.324" class="difflineminus">-  },</span>
<a href="#l9.325"></a><span id="l9.325" class="difflineminus">-</span>
<a href="#l9.326"></a><span id="l9.326" class="difflineminus">-  isCommandEnabled: function (aCommand)</span>
<a href="#l9.327"></a><span id="l9.327" class="difflineminus">-  {</span>
<a href="#l9.328"></a><span id="l9.328" class="difflineminus">-    // warning: this is not the function called in BookmarksController.onCommandUpdate</span>
<a href="#l9.329"></a><span id="l9.329" class="difflineminus">-    var selection = BookmarksMenu._selection;</span>
<a href="#l9.330"></a><span id="l9.330" class="difflineminus">-    var target    = BookmarksMenu._target;</span>
<a href="#l9.331"></a><span id="l9.331" class="difflineminus">-    if (selection)</span>
<a href="#l9.332"></a><span id="l9.332" class="difflineminus">-      return BookmarksController.isCommandEnabled(aCommand, selection, target);</span>
<a href="#l9.333"></a><span id="l9.333" class="difflineminus">-    return false;</span>
<a href="#l9.334"></a><span id="l9.334" class="difflineminus">-  },</span>
<a href="#l9.335"></a><span id="l9.335" class="difflineminus">-</span>
<a href="#l9.336"></a><span id="l9.336" class="difflineminus">-  doCommand: function (aCommand)</span>
<a href="#l9.337"></a><span id="l9.337" class="difflineminus">-  {</span>
<a href="#l9.338"></a><span id="l9.338" class="difflineminus">-    var selection = BookmarksMenu._selection;</span>
<a href="#l9.339"></a><span id="l9.339" class="difflineminus">-    var target    = BookmarksMenu._target;</span>
<a href="#l9.340"></a><span id="l9.340" class="difflineminus">-    BookmarksController.doCommand(aCommand, selection, target);</span>
<a href="#l9.341"></a><span id="l9.341" class="difflineminus">-  },</span>
<a href="#l9.342"></a><span id="l9.342" class="difflineminus">-</span>
<a href="#l9.343"></a><span id="l9.343" class="difflineminus">-  onMouseMove: function (aEvent)</span>
<a href="#l9.344"></a><span id="l9.344" class="difflineminus">-  {</span>
<a href="#l9.345"></a><span id="l9.345" class="difflineminus">-    var command = aEvent.target.getAttribute(&quot;command&quot;);</span>
<a href="#l9.346"></a><span id="l9.346" class="difflineminus">-    var isDisabled = aEvent.target.getAttribute(&quot;disabled&quot;)</span>
<a href="#l9.347"></a><span id="l9.347" class="difflineminus">-    if (isDisabled != &quot;true&quot; &amp;&amp; (command == &quot;cmd_bm_newfolder&quot; || command == &quot;cmd_bm_paste&quot;)) {</span>
<a href="#l9.348"></a><span id="l9.348" class="difflineminus">-      BookmarksMenuDNDObserver.onDragSetFeedBack(document.popupNode, BookmarksMenu._orientation);</span>
<a href="#l9.349"></a><span id="l9.349" class="difflineminus">-    } else {</span>
<a href="#l9.350"></a><span id="l9.350" class="difflineminus">-      BookmarksMenuDNDObserver.onDragRemoveFeedBack(document.popupNode);</span>
<a href="#l9.351"></a><span id="l9.351" class="difflineminus">-    }</span>
<a href="#l9.352"></a><span id="l9.352" class="difflineminus">-  }</span>
<a href="#l9.353"></a><span id="l9.353" class="difflineminus">-}</span>
<a href="#l9.354"></a><span id="l9.354" class="difflineminus">-</span>
<a href="#l9.355"></a><span id="l9.355" class="difflineminus">-var BookmarksMenuDNDObserver = {</span>
<a href="#l9.356"></a><span id="l9.356" class="difflineminus">-</span>
<a href="#l9.357"></a><span id="l9.357" class="difflineminus">-  ////////////////////</span>
<a href="#l9.358"></a><span id="l9.358" class="difflineminus">-  // Public methods //</span>
<a href="#l9.359"></a><span id="l9.359" class="difflineminus">-  ////////////////////</span>
<a href="#l9.360"></a><span id="l9.360" class="difflineminus">-</span>
<a href="#l9.361"></a><span id="l9.361" class="difflineminus">-  onDragStart: function (aEvent, aXferData, aDragAction)</span>
<a href="#l9.362"></a><span id="l9.362" class="difflineminus">-  {</span>
<a href="#l9.363"></a><span id="l9.363" class="difflineminus">-    var target = aEvent.target;</span>
<a href="#l9.364"></a><span id="l9.364" class="difflineminus">-</span>
<a href="#l9.365"></a><span id="l9.365" class="difflineminus">-    // Prevent dragging from an invalid region</span>
<a href="#l9.366"></a><span id="l9.366" class="difflineminus">-    if (!this.canDrop(aEvent))</span>
<a href="#l9.367"></a><span id="l9.367" class="difflineminus">-      return;</span>
<a href="#l9.368"></a><span id="l9.368" class="difflineminus">-</span>
<a href="#l9.369"></a><span id="l9.369" class="difflineminus">-    // bail if dragging from the empty area of the bookmarks toolbar</span>
<a href="#l9.370"></a><span id="l9.370" class="difflineminus">-    if (target.id == &quot;bookmarks-ptf&quot;)</span>
<a href="#l9.371"></a><span id="l9.371" class="difflineminus">-      return</span>
<a href="#l9.372"></a><span id="l9.372" class="difflineminus">-</span>
<a href="#l9.373"></a><span id="l9.373" class="difflineminus">-    // a drag start is fired when leaving an open toolbarbutton(type=menu) </span>
<a href="#l9.374"></a><span id="l9.374" class="difflineminus">-    // (see bug 143031)</span>
<a href="#l9.375"></a><span id="l9.375" class="difflineminus">-    if (this.isContainer(target) &amp;&amp; </span>
<a href="#l9.376"></a><span id="l9.376" class="difflineminus">-        target.getAttribute(&quot;group&quot;) != &quot;true&quot;) {</span>
<a href="#l9.377"></a><span id="l9.377" class="difflineminus">-      if (!aEvent.shiftKey &amp;&amp; !aEvent.altKey &amp;&amp; !aEvent.ctrlKey)</span>
<a href="#l9.378"></a><span id="l9.378" class="difflineminus">-        return;</span>
<a href="#l9.379"></a><span id="l9.379" class="difflineminus">-      // menus open on mouse down</span>
<a href="#l9.380"></a><span id="l9.380" class="difflineminus">-      target.firstChild.hidePopup();</span>
<a href="#l9.381"></a><span id="l9.381" class="difflineminus">-    }</span>
<a href="#l9.382"></a><span id="l9.382" class="difflineminus">-    var selection  = BookmarksMenu.getBTSelection(target);</span>
<a href="#l9.383"></a><span id="l9.383" class="difflineminus">-    aXferData.data = BookmarksUtils.getXferDataFromSelection(selection);</span>
<a href="#l9.384"></a><span id="l9.384" class="difflineminus">-  },</span>
<a href="#l9.385"></a><span id="l9.385" class="difflineminus">-</span>
<a href="#l9.386"></a><span id="l9.386" class="difflineminus">-  onDragOver: function(aEvent, aFlavour, aDragSession) </span>
<a href="#l9.387"></a><span id="l9.387" class="difflineminus">-  {</span>
<a href="#l9.388"></a><span id="l9.388" class="difflineminus">-    var orientation = BookmarksMenu.getBTOrientation(aEvent)</span>
<a href="#l9.389"></a><span id="l9.389" class="difflineminus">-    if (aDragSession.canDrop)</span>
<a href="#l9.390"></a><span id="l9.390" class="difflineminus">-      this.onDragSetFeedBack(aEvent.target, orientation);</span>
<a href="#l9.391"></a><span id="l9.391" class="difflineminus">-    if (orientation != this.mCurrentDropPosition) {</span>
<a href="#l9.392"></a><span id="l9.392" class="difflineminus">-      // emulating onDragExit and onDragEnter events since the drop region</span>
<a href="#l9.393"></a><span id="l9.393" class="difflineminus">-      // has changed on the target.</span>
<a href="#l9.394"></a><span id="l9.394" class="difflineminus">-      this.onDragExit(aEvent, aDragSession);</span>
<a href="#l9.395"></a><span id="l9.395" class="difflineminus">-      this.onDragEnter(aEvent, aDragSession);</span>
<a href="#l9.396"></a><span id="l9.396" class="difflineminus">-    }</span>
<a href="#l9.397"></a><span id="l9.397" class="difflineminus">-  },</span>
<a href="#l9.398"></a><span id="l9.398" class="difflineminus">-</span>
<a href="#l9.399"></a><span id="l9.399" class="difflineminus">-  onDragEnter: function (aEvent, aDragSession)</span>
<a href="#l9.400"></a><span id="l9.400" class="difflineminus">-  {</span>
<a href="#l9.401"></a><span id="l9.401" class="difflineminus">-    var target = aEvent.target;</span>
<a href="#l9.402"></a><span id="l9.402" class="difflineminus">-    var orientation = BookmarksMenu.getBTOrientation(aEvent);</span>
<a href="#l9.403"></a><span id="l9.403" class="difflineminus">-    if (target.localName == &quot;menupopup&quot; || target.id == &quot;bookmarks-ptf&quot;)</span>
<a href="#l9.404"></a><span id="l9.404" class="difflineminus">-      target = target.parentNode;</span>
<a href="#l9.405"></a><span id="l9.405" class="difflineminus">-    if (aDragSession.canDrop) {</span>
<a href="#l9.406"></a><span id="l9.406" class="difflineminus">-      this.onDragSetFeedBack(target, orientation);</span>
<a href="#l9.407"></a><span id="l9.407" class="difflineminus">-</span>
<a href="#l9.408"></a><span id="l9.408" class="difflineminus">-      clearTimeout(this.loadTimer);</span>
<a href="#l9.409"></a><span id="l9.409" class="difflineminus">-      if (target != aDragSession.sourceNode) {</span>
<a href="#l9.410"></a><span id="l9.410" class="difflineminus">-        var This = this;</span>
<a href="#l9.411"></a><span id="l9.411" class="difflineminus">-        var targetToBeLoaded = target;</span>
<a href="#l9.412"></a><span id="l9.412" class="difflineminus">-        this.loadTimer = setTimeout(function() { This.onDragLoadTarget(targetToBeLoaded); }, This.springLoadedMenuDelay);</span>
<a href="#l9.413"></a><span id="l9.413" class="difflineminus">-      }</span>
<a href="#l9.414"></a><span id="l9.414" class="difflineminus">-    }</span>
<a href="#l9.415"></a><span id="l9.415" class="difflineminus">-    this.mCurrentDragOverTarget = target;</span>
<a href="#l9.416"></a><span id="l9.416" class="difflineminus">-    this.mCurrentDropPosition   = orientation;</span>
<a href="#l9.417"></a><span id="l9.417" class="difflineminus">-  },</span>
<a href="#l9.418"></a><span id="l9.418" class="difflineminus">-</span>
<a href="#l9.419"></a><span id="l9.419" class="difflineminus">-  onDragExit: function (aEvent, aDragSession)</span>
<a href="#l9.420"></a><span id="l9.420" class="difflineminus">-  {</span>
<a href="#l9.421"></a><span id="l9.421" class="difflineminus">-    var target = aEvent.target;</span>
<a href="#l9.422"></a><span id="l9.422" class="difflineminus">-    if (target.localName == &quot;menupopup&quot; || target.id == &quot;bookmarks-ptf&quot;)</span>
<a href="#l9.423"></a><span id="l9.423" class="difflineminus">-      target = target.parentNode;</span>
<a href="#l9.424"></a><span id="l9.424" class="difflineminus">-    this.onDragRemoveFeedBack(target);</span>
<a href="#l9.425"></a><span id="l9.425" class="difflineminus">-</span>
<a href="#l9.426"></a><span id="l9.426" class="difflineminus">-    clearTimeout(this.closeTimer);</span>
<a href="#l9.427"></a><span id="l9.427" class="difflineminus">-    if (this.mDidDrop) {</span>
<a href="#l9.428"></a><span id="l9.428" class="difflineminus">-      // Don't close target after dropping into it.</span>
<a href="#l9.429"></a><span id="l9.429" class="difflineminus">-      this.mDidDrop = false;</span>
<a href="#l9.430"></a><span id="l9.430" class="difflineminus">-    } else {</span>
<a href="#l9.431"></a><span id="l9.431" class="difflineminus">-      // Close target while dragging.</span>
<a href="#l9.432"></a><span id="l9.432" class="difflineminus">-      var This = this;</span>
<a href="#l9.433"></a><span id="l9.433" class="difflineminus">-      this.closeTimer = setTimeout(function() { This.onDragCloseTarget(); }, This.springLoadedMenuDelay);</span>
<a href="#l9.434"></a><span id="l9.434" class="difflineminus">-    }</span>
<a href="#l9.435"></a><span id="l9.435" class="difflineminus">-</span>
<a href="#l9.436"></a><span id="l9.436" class="difflineminus">-    this.mCurrentDragOverTarget = null;</span>
<a href="#l9.437"></a><span id="l9.437" class="difflineminus">-    this.mCurrentDropPosition = null;</span>
<a href="#l9.438"></a><span id="l9.438" class="difflineminus">-  },</span>
<a href="#l9.439"></a><span id="l9.439" class="difflineminus">-</span>
<a href="#l9.440"></a><span id="l9.440" class="difflineminus">-  onDrop: function (aEvent, aXferData, aDragSession)</span>
<a href="#l9.441"></a><span id="l9.441" class="difflineminus">-  {</span>
<a href="#l9.442"></a><span id="l9.442" class="difflineminus">-    var target = aEvent.target;</span>
<a href="#l9.443"></a><span id="l9.443" class="difflineminus">-    this.onDragRemoveFeedBack(target);</span>
<a href="#l9.444"></a><span id="l9.444" class="difflineminus">-</span>
<a href="#l9.445"></a><span id="l9.445" class="difflineminus">-    var selection = BookmarksUtils.getSelectionFromXferData(aDragSession);</span>
<a href="#l9.446"></a><span id="l9.446" class="difflineminus">-</span>
<a href="#l9.447"></a><span id="l9.447" class="difflineminus">-    var orientation = BookmarksMenu.getBTOrientation(aEvent);</span>
<a href="#l9.448"></a><span id="l9.448" class="difflineminus">-</span>
<a href="#l9.449"></a><span id="l9.449" class="difflineminus">-    // For RTL PersonalBar bookmarks buttons, orientation should be inverted (only in drop case)</span>
<a href="#l9.450"></a><span id="l9.450" class="difflineminus">-    // because &quot;before&quot; (to the left) on the screen translates to &quot;after&quot; in the collection of items.</span>
<a href="#l9.451"></a><span id="l9.451" class="difflineminus">-    if (target.localName == &quot;toolbarbutton&quot;)</span>
<a href="#l9.452"></a><span id="l9.452" class="difflineminus">-      if (window.getComputedStyle(document.getElementById(&quot;PersonalToolbar&quot;),'').direction == 'rtl')</span>
<a href="#l9.453"></a><span id="l9.453" class="difflineminus">-        if (orientation == BookmarksUtils.DROP_AFTER)</span>
<a href="#l9.454"></a><span id="l9.454" class="difflineminus">-          orientation = BookmarksUtils.DROP_BEFORE;</span>
<a href="#l9.455"></a><span id="l9.455" class="difflineminus">-        else if (orientation == BookmarksUtils.DROP_BEFORE)</span>
<a href="#l9.456"></a><span id="l9.456" class="difflineminus">-          orientation = BookmarksUtils.DROP_AFTER;</span>
<a href="#l9.457"></a><span id="l9.457" class="difflineminus">-</span>
<a href="#l9.458"></a><span id="l9.458" class="difflineminus">-    var selTarget   = BookmarksMenu.getBTTarget(target, orientation);</span>
<a href="#l9.459"></a><span id="l9.459" class="difflineminus">-</span>
<a href="#l9.460"></a><span id="l9.460" class="difflineminus">-    const kDSIID      = Components.interfaces.nsIDragService;</span>
<a href="#l9.461"></a><span id="l9.461" class="difflineminus">-    const kCopyAction = kDSIID.DRAGDROP_ACTION_COPY + kDSIID.DRAGDROP_ACTION_LINK;</span>
<a href="#l9.462"></a><span id="l9.462" class="difflineminus">-</span>
<a href="#l9.463"></a><span id="l9.463" class="difflineminus">-    // hide the 'open in tab' menuseparator because bookmarks</span>
<a href="#l9.464"></a><span id="l9.464" class="difflineminus">-    // can be inserted after it if they are dropped after the last bookmark</span>
<a href="#l9.465"></a><span id="l9.465" class="difflineminus">-    // a more comprehensive fix would be in the menupopup template builder</span>
<a href="#l9.466"></a><span id="l9.466" class="difflineminus">-    var menuTarget = (target.localName == &quot;toolbarbutton&quot; ||</span>
<a href="#l9.467"></a><span id="l9.467" class="difflineminus">-                      target.localName == &quot;menu&quot;)         &amp;&amp; </span>
<a href="#l9.468"></a><span id="l9.468" class="difflineminus">-                     orientation == BookmarksUtils.DROP_ON?</span>
<a href="#l9.469"></a><span id="l9.469" class="difflineminus">-                     target.lastChild:target.parentNode;</span>
<a href="#l9.470"></a><span id="l9.470" class="difflineminus">-    if (menuTarget.hasChildNodes() &amp;&amp;</span>
<a href="#l9.471"></a><span id="l9.471" class="difflineminus">-        menuTarget.lastChild.id == &quot;openintabs-menuitem&quot;) {</span>
<a href="#l9.472"></a><span id="l9.472" class="difflineminus">-      menuTarget.removeChild(menuTarget.lastChild.previousSibling);</span>
<a href="#l9.473"></a><span id="l9.473" class="difflineminus">-    }</span>
<a href="#l9.474"></a><span id="l9.474" class="difflineminus">-</span>
<a href="#l9.475"></a><span id="l9.475" class="difflineminus">-    if (aDragSession.dragAction &amp; kCopyAction)</span>
<a href="#l9.476"></a><span id="l9.476" class="difflineminus">-      BookmarksUtils.insertSelection(&quot;drag&quot;, selection, selTarget);</span>
<a href="#l9.477"></a><span id="l9.477" class="difflineminus">-    else</span>
<a href="#l9.478"></a><span id="l9.478" class="difflineminus">-      BookmarksUtils.moveSelection(&quot;drag&quot;, selection, selTarget);</span>
<a href="#l9.479"></a><span id="l9.479" class="difflineminus">-</span>
<a href="#l9.480"></a><span id="l9.480" class="difflineminus">-    var chevron = document.getElementById(&quot;bookmarks-chevron&quot;);</span>
<a href="#l9.481"></a><span id="l9.481" class="difflineminus">-    if (chevron.getAttribute(&quot;open&quot;) == &quot;true&quot;) {</span>
<a href="#l9.482"></a><span id="l9.482" class="difflineminus">-      BookmarksToolbar.resizeFunc(null);</span>
<a href="#l9.483"></a><span id="l9.483" class="difflineminus">-      BookmarksToolbar.updateOverflowMenu(document.getElementById(&quot;bookmarks-chevron-popup&quot;));</span>
<a href="#l9.484"></a><span id="l9.484" class="difflineminus">-    }</span>
<a href="#l9.485"></a><span id="l9.485" class="difflineminus">-</span>
<a href="#l9.486"></a><span id="l9.486" class="difflineminus">-    // show again the menuseparator</span>
<a href="#l9.487"></a><span id="l9.487" class="difflineminus">-    if (menuTarget.hasChildNodes() &amp;&amp;</span>
<a href="#l9.488"></a><span id="l9.488" class="difflineminus">-        menuTarget.lastChild.id == &quot;openintabs-menuitem&quot;) {</span>
<a href="#l9.489"></a><span id="l9.489" class="difflineminus">-      var element = document.createElementNS(XUL_NS, &quot;menuseparator&quot;);</span>
<a href="#l9.490"></a><span id="l9.490" class="difflineminus">-      menuTarget.insertBefore(element, menuTarget.lastChild);</span>
<a href="#l9.491"></a><span id="l9.491" class="difflineminus">-    }</span>
<a href="#l9.492"></a><span id="l9.492" class="difflineminus">-</span>
<a href="#l9.493"></a><span id="l9.493" class="difflineminus">-    this.mDidDrop = true;</span>
<a href="#l9.494"></a><span id="l9.494" class="difflineminus">-  },</span>
<a href="#l9.495"></a><span id="l9.495" class="difflineminus">-</span>
<a href="#l9.496"></a><span id="l9.496" class="difflineminus">-  canDrop: function (aEvent, aDragSession)</span>
<a href="#l9.497"></a><span id="l9.497" class="difflineminus">-  {</span>
<a href="#l9.498"></a><span id="l9.498" class="difflineminus">-    var target = aEvent.target;</span>
<a href="#l9.499"></a><span id="l9.499" class="difflineminus">-</span>
<a href="#l9.500"></a><span id="l9.500" class="difflineminus">-    // onDragStart calls this without a drag session</span>
<a href="#l9.501"></a><span id="l9.501" class="difflineminus">-    // There will be no sourceNode for drags from external apps</span>
<a href="#l9.502"></a><span id="l9.502" class="difflineminus">-    if (aDragSession &amp;&amp; aDragSession.sourceNode) {</span>
<a href="#l9.503"></a><span id="l9.503" class="difflineminus">-      var orientation = BookmarksMenu.getBTOrientation(aEvent, target);</span>
<a href="#l9.504"></a><span id="l9.504" class="difflineminus">-      if (target == aDragSession.sourceNode ||</span>
<a href="#l9.505"></a><span id="l9.505" class="difflineminus">-          (target == aDragSession.sourceNode.previousSibling &amp;&amp;</span>
<a href="#l9.506"></a><span id="l9.506" class="difflineminus">-           orientation == BookmarksUtils.DROP_AFTER) ||</span>
<a href="#l9.507"></a><span id="l9.507" class="difflineminus">-          (target == aDragSession.sourceNode.nextSibling &amp;&amp;</span>
<a href="#l9.508"></a><span id="l9.508" class="difflineminus">-           orientation == BookmarksUtils.DROP_BEFORE))</span>
<a href="#l9.509"></a><span id="l9.509" class="difflineminus">-        return false;</span>
<a href="#l9.510"></a><span id="l9.510" class="difflineminus">-    }</span>
<a href="#l9.511"></a><span id="l9.511" class="difflineminus">-</span>
<a href="#l9.512"></a><span id="l9.512" class="difflineminus">-    return BookmarksMenu.isBTBookmark(target.id)       &amp;&amp; </span>
<a href="#l9.513"></a><span id="l9.513" class="difflineminus">-           target.id != &quot;NC:SystemBookmarksStaticRoot&quot; &amp;&amp;</span>
<a href="#l9.514"></a><span id="l9.514" class="difflineminus">-           target.id.substring(0,5) != &quot;find:&quot;         ||</span>
<a href="#l9.515"></a><span id="l9.515" class="difflineminus">-           target.id == &quot;BookmarksMenu&quot;                ||</span>
<a href="#l9.516"></a><span id="l9.516" class="difflineminus">-           target.id == &quot;bookmarks-button&quot;             ||</span>
<a href="#l9.517"></a><span id="l9.517" class="difflineminus">-           target.id == &quot;bookmarks-chevron&quot;            ||</span>
<a href="#l9.518"></a><span id="l9.518" class="difflineminus">-           target.id == &quot;bookmarks-ptf&quot;;</span>
<a href="#l9.519"></a><span id="l9.519" class="difflineminus">-  },</span>
<a href="#l9.520"></a><span id="l9.520" class="difflineminus">-</span>
<a href="#l9.521"></a><span id="l9.521" class="difflineminus">-  canHandleMultipleItems: true,</span>
<a href="#l9.522"></a><span id="l9.522" class="difflineminus">-</span>
<a href="#l9.523"></a><span id="l9.523" class="difflineminus">-  getSupportedFlavours: function () </span>
<a href="#l9.524"></a><span id="l9.524" class="difflineminus">-  {</span>
<a href="#l9.525"></a><span id="l9.525" class="difflineminus">-    var flavourSet = new FlavourSet();</span>
<a href="#l9.526"></a><span id="l9.526" class="difflineminus">-    flavourSet.appendFlavour(&quot;moz/rdfitem&quot;);</span>
<a href="#l9.527"></a><span id="l9.527" class="difflineminus">-    flavourSet.appendFlavour(&quot;text/x-moz-url&quot;);</span>
<a href="#l9.528"></a><span id="l9.528" class="difflineminus">-    flavourSet.appendFlavour(&quot;application/x-moz-file&quot;, &quot;nsIFile&quot;);</span>
<a href="#l9.529"></a><span id="l9.529" class="difflineminus">-    flavourSet.appendFlavour(&quot;text/unicode&quot;);</span>
<a href="#l9.530"></a><span id="l9.530" class="difflineminus">-    return flavourSet;</span>
<a href="#l9.531"></a><span id="l9.531" class="difflineminus">-  },</span>
<a href="#l9.532"></a><span id="l9.532" class="difflineminus">-</span>
<a href="#l9.533"></a><span id="l9.533" class="difflineminus">-</span>
<a href="#l9.534"></a><span id="l9.534" class="difflineminus">-  ////////////////////////////////////</span>
<a href="#l9.535"></a><span id="l9.535" class="difflineminus">-  // Private methods and properties //</span>
<a href="#l9.536"></a><span id="l9.536" class="difflineminus">-  ////////////////////////////////////</span>
<a href="#l9.537"></a><span id="l9.537" class="difflineminus">-</span>
<a href="#l9.538"></a><span id="l9.538" class="difflineminus">-  springLoadedMenuDelay: 350, // milliseconds</span>
<a href="#l9.539"></a><span id="l9.539" class="difflineminus">-</span>
<a href="#l9.540"></a><span id="l9.540" class="difflineminus">-  mCurrentDragOverTarget: null,</span>
<a href="#l9.541"></a><span id="l9.541" class="difflineminus">-  mCurrentDropPosition: null,</span>
<a href="#l9.542"></a><span id="l9.542" class="difflineminus">-  loadTimer  : null,</span>
<a href="#l9.543"></a><span id="l9.543" class="difflineminus">-  closeTimer : null,</span>
<a href="#l9.544"></a><span id="l9.544" class="difflineminus">-  mDidDrop : false,</span>
<a href="#l9.545"></a><span id="l9.545" class="difflineminus">-</span>
<a href="#l9.546"></a><span id="l9.546" class="difflineminus">-  _observers : null,</span>
<a href="#l9.547"></a><span id="l9.547" class="difflineminus">-  get mObservers ()</span>
<a href="#l9.548"></a><span id="l9.548" class="difflineminus">-  {</span>
<a href="#l9.549"></a><span id="l9.549" class="difflineminus">-    if (!this._observers) {</span>
<a href="#l9.550"></a><span id="l9.550" class="difflineminus">-      this._observers = [</span>
<a href="#l9.551"></a><span id="l9.551" class="difflineminus">-        document.getElementById(&quot;bookmarks-ptf&quot;),</span>
<a href="#l9.552"></a><span id="l9.552" class="difflineminus">-        document.getElementById(&quot;BookmarksMenu&quot;).parentNode,</span>
<a href="#l9.553"></a><span id="l9.553" class="difflineminus">-        document.getElementById(&quot;bookmarks-chevron&quot;).parentNode,</span>
<a href="#l9.554"></a><span id="l9.554" class="difflineminus">-        document.getElementById(&quot;PersonalToolbar&quot;)</span>
<a href="#l9.555"></a><span id="l9.555" class="difflineminus">-      ]</span>
<a href="#l9.556"></a><span id="l9.556" class="difflineminus">-    }</span>
<a href="#l9.557"></a><span id="l9.557" class="difflineminus">-    return this._observers;</span>
<a href="#l9.558"></a><span id="l9.558" class="difflineminus">-  },</span>
<a href="#l9.559"></a><span id="l9.559" class="difflineminus">-</span>
<a href="#l9.560"></a><span id="l9.560" class="difflineminus">-  getObserverForNode: function (aNode)</span>
<a href="#l9.561"></a><span id="l9.561" class="difflineminus">-  {</span>
<a href="#l9.562"></a><span id="l9.562" class="difflineminus">-    if (!aNode)</span>
<a href="#l9.563"></a><span id="l9.563" class="difflineminus">-      return null;</span>
<a href="#l9.564"></a><span id="l9.564" class="difflineminus">-    var node = aNode;</span>
<a href="#l9.565"></a><span id="l9.565" class="difflineminus">-    var observer;</span>
<a href="#l9.566"></a><span id="l9.566" class="difflineminus">-    do {</span>
<a href="#l9.567"></a><span id="l9.567" class="difflineminus">-      for (var i=0; i &lt; this.mObservers.length; i++) {</span>
<a href="#l9.568"></a><span id="l9.568" class="difflineminus">-        observer = this.mObservers[i];</span>
<a href="#l9.569"></a><span id="l9.569" class="difflineminus">-        if (observer == node)</span>
<a href="#l9.570"></a><span id="l9.570" class="difflineminus">-          return observer;</span>
<a href="#l9.571"></a><span id="l9.571" class="difflineminus">-      }</span>
<a href="#l9.572"></a><span id="l9.572" class="difflineminus">-      node = node.parentNode;</span>
<a href="#l9.573"></a><span id="l9.573" class="difflineminus">-    } while (node != document)</span>
<a href="#l9.574"></a><span id="l9.574" class="difflineminus">-    return null;</span>
<a href="#l9.575"></a><span id="l9.575" class="difflineminus">-  },</span>
<a href="#l9.576"></a><span id="l9.576" class="difflineminus">-</span>
<a href="#l9.577"></a><span id="l9.577" class="difflineminus">-  onDragCloseMenu: function (aNode)</span>
<a href="#l9.578"></a><span id="l9.578" class="difflineminus">-  {</span>
<a href="#l9.579"></a><span id="l9.579" class="difflineminus">-    var children = aNode.childNodes;</span>
<a href="#l9.580"></a><span id="l9.580" class="difflineminus">-    for (var i = 0; i &lt; children.length; i++) {</span>
<a href="#l9.581"></a><span id="l9.581" class="difflineminus">-      if (this.isContainer(children[i]) &amp;&amp; </span>
<a href="#l9.582"></a><span id="l9.582" class="difflineminus">-          children[i].getAttribute(&quot;open&quot;) == &quot;true&quot;) {</span>
<a href="#l9.583"></a><span id="l9.583" class="difflineminus">-        this.onDragCloseMenu(children[i].lastChild);</span>
<a href="#l9.584"></a><span id="l9.584" class="difflineminus">-        if (children[i] != this.mCurrentDragOverTarget || this.mCurrentDropPosition != BookmarksUtils.DROP_ON)</span>
<a href="#l9.585"></a><span id="l9.585" class="difflineminus">-          children[i].lastChild.hidePopup();</span>
<a href="#l9.586"></a><span id="l9.586" class="difflineminus">-      }</span>
<a href="#l9.587"></a><span id="l9.587" class="difflineminus">-    }</span>
<a href="#l9.588"></a><span id="l9.588" class="difflineminus">-  },</span>
<a href="#l9.589"></a><span id="l9.589" class="difflineminus">-</span>
<a href="#l9.590"></a><span id="l9.590" class="difflineminus">-  onDragCloseTarget: function ()</span>
<a href="#l9.591"></a><span id="l9.591" class="difflineminus">-  {</span>
<a href="#l9.592"></a><span id="l9.592" class="difflineminus">-    var currentObserver = this.getObserverForNode(this.mCurrentDragOverTarget);</span>
<a href="#l9.593"></a><span id="l9.593" class="difflineminus">-    // close all the menus not hovered by the mouse</span>
<a href="#l9.594"></a><span id="l9.594" class="difflineminus">-    for (var i=0; i &lt; this.mObservers.length; i++) {</span>
<a href="#l9.595"></a><span id="l9.595" class="difflineminus">-      if (currentObserver != this.mObservers[i])</span>
<a href="#l9.596"></a><span id="l9.596" class="difflineminus">-        this.onDragCloseMenu(this.mObservers[i]);</span>
<a href="#l9.597"></a><span id="l9.597" class="difflineminus">-      else</span>
<a href="#l9.598"></a><span id="l9.598" class="difflineminus">-        this.onDragCloseMenu(this.mCurrentDragOverTarget.parentNode);</span>
<a href="#l9.599"></a><span id="l9.599" class="difflineminus">-    }</span>
<a href="#l9.600"></a><span id="l9.600" class="difflineminus">-  },</span>
<a href="#l9.601"></a><span id="l9.601" class="difflineminus">-</span>
<a href="#l9.602"></a><span id="l9.602" class="difflineminus">-  onDragLoadTarget: function (aTarget) </span>
<a href="#l9.603"></a><span id="l9.603" class="difflineminus">-  {</span>
<a href="#l9.604"></a><span id="l9.604" class="difflineminus">-    if (!this.mCurrentDragOverTarget)</span>
<a href="#l9.605"></a><span id="l9.605" class="difflineminus">-      return;</span>
<a href="#l9.606"></a><span id="l9.606" class="difflineminus">-    // Load the current menu</span>
<a href="#l9.607"></a><span id="l9.607" class="difflineminus">-    if (this.mCurrentDropPosition == BookmarksUtils.DROP_ON &amp;&amp; </span>
<a href="#l9.608"></a><span id="l9.608" class="difflineminus">-        this.isContainer(aTarget)             &amp;&amp; </span>
<a href="#l9.609"></a><span id="l9.609" class="difflineminus">-        aTarget.getAttribute(&quot;group&quot;) != &quot;true&quot;)</span>
<a href="#l9.610"></a><span id="l9.610" class="difflineminus">-      aTarget.lastChild.showPopup(aTarget);</span>
<a href="#l9.611"></a><span id="l9.611" class="difflineminus">-  },</span>
<a href="#l9.612"></a><span id="l9.612" class="difflineminus">-</span>
<a href="#l9.613"></a><span id="l9.613" class="difflineminus">-  onDragSetFeedBack: function (aTarget, aOrientation)</span>
<a href="#l9.614"></a><span id="l9.614" class="difflineminus">-  {</span>
<a href="#l9.615"></a><span id="l9.615" class="difflineminus">-   switch (aTarget.localName) {</span>
<a href="#l9.616"></a><span id="l9.616" class="difflineminus">-      case &quot;toolbarseparator&quot;:</span>
<a href="#l9.617"></a><span id="l9.617" class="difflineminus">-      case &quot;toolbarbutton&quot;:</span>
<a href="#l9.618"></a><span id="l9.618" class="difflineminus">-        switch (aOrientation) {</span>
<a href="#l9.619"></a><span id="l9.619" class="difflineminus">-          case BookmarksUtils.DROP_BEFORE: </span>
<a href="#l9.620"></a><span id="l9.620" class="difflineminus">-            aTarget.setAttribute(&quot;dragover-left&quot;, &quot;true&quot;);</span>
<a href="#l9.621"></a><span id="l9.621" class="difflineminus">-            break;</span>
<a href="#l9.622"></a><span id="l9.622" class="difflineminus">-          case BookmarksUtils.DROP_AFTER:</span>
<a href="#l9.623"></a><span id="l9.623" class="difflineminus">-            aTarget.setAttribute(&quot;dragover-right&quot;, &quot;true&quot;);</span>
<a href="#l9.624"></a><span id="l9.624" class="difflineminus">-            break;</span>
<a href="#l9.625"></a><span id="l9.625" class="difflineminus">-          case BookmarksUtils.DROP_ON:</span>
<a href="#l9.626"></a><span id="l9.626" class="difflineminus">-            aTarget.setAttribute(&quot;dragover-top&quot;   , &quot;true&quot;);</span>
<a href="#l9.627"></a><span id="l9.627" class="difflineminus">-            aTarget.setAttribute(&quot;dragover-bottom&quot;, &quot;true&quot;);</span>
<a href="#l9.628"></a><span id="l9.628" class="difflineminus">-            aTarget.setAttribute(&quot;dragover-left&quot;  , &quot;true&quot;);</span>
<a href="#l9.629"></a><span id="l9.629" class="difflineminus">-            aTarget.setAttribute(&quot;dragover-right&quot; , &quot;true&quot;);</span>
<a href="#l9.630"></a><span id="l9.630" class="difflineminus">-            break;</span>
<a href="#l9.631"></a><span id="l9.631" class="difflineminus">-        }</span>
<a href="#l9.632"></a><span id="l9.632" class="difflineminus">-        break;</span>
<a href="#l9.633"></a><span id="l9.633" class="difflineminus">-      case &quot;menuseparator&quot;: </span>
<a href="#l9.634"></a><span id="l9.634" class="difflineminus">-      case &quot;menu&quot;:</span>
<a href="#l9.635"></a><span id="l9.635" class="difflineminus">-      case &quot;menuitem&quot;:</span>
<a href="#l9.636"></a><span id="l9.636" class="difflineminus">-        switch (aOrientation) {</span>
<a href="#l9.637"></a><span id="l9.637" class="difflineminus">-          case BookmarksUtils.DROP_BEFORE: </span>
<a href="#l9.638"></a><span id="l9.638" class="difflineminus">-            aTarget.setAttribute(&quot;dragover-top&quot;, &quot;true&quot;);</span>
<a href="#l9.639"></a><span id="l9.639" class="difflineminus">-            break;</span>
<a href="#l9.640"></a><span id="l9.640" class="difflineminus">-          case BookmarksUtils.DROP_AFTER:</span>
<a href="#l9.641"></a><span id="l9.641" class="difflineminus">-            aTarget.setAttribute(&quot;dragover-bottom&quot;, &quot;true&quot;);</span>
<a href="#l9.642"></a><span id="l9.642" class="difflineminus">-            break;</span>
<a href="#l9.643"></a><span id="l9.643" class="difflineminus">-          case BookmarksUtils.DROP_ON:</span>
<a href="#l9.644"></a><span id="l9.644" class="difflineminus">-            break;</span>
<a href="#l9.645"></a><span id="l9.645" class="difflineminus">-        }</span>
<a href="#l9.646"></a><span id="l9.646" class="difflineminus">-        break;</span>
<a href="#l9.647"></a><span id="l9.647" class="difflineminus">-      case &quot;toolbar&quot;: </span>
<a href="#l9.648"></a><span id="l9.648" class="difflineminus">-        var newTarget = BookmarksToolbar.getLastVisibleBookmark();</span>
<a href="#l9.649"></a><span id="l9.649" class="difflineminus">-        if (newTarget)</span>
<a href="#l9.650"></a><span id="l9.650" class="difflineminus">-          newTarget.setAttribute(&quot;dragover-right&quot;, &quot;true&quot;);</span>
<a href="#l9.651"></a><span id="l9.651" class="difflineminus">-        break;</span>
<a href="#l9.652"></a><span id="l9.652" class="difflineminus">-      case &quot;hbox&quot;:</span>
<a href="#l9.653"></a><span id="l9.653" class="difflineminus">-      case &quot;menupopup&quot;: break; </span>
<a href="#l9.654"></a><span id="l9.654" class="difflineminus">-     default: dump(&quot;No feedback for: &quot;+aTarget.localName+&quot;\n&quot;);</span>
<a href="#l9.655"></a><span id="l9.655" class="difflineminus">-    }</span>
<a href="#l9.656"></a><span id="l9.656" class="difflineminus">-  },</span>
<a href="#l9.657"></a><span id="l9.657" class="difflineminus">-</span>
<a href="#l9.658"></a><span id="l9.658" class="difflineminus">-  onDragRemoveFeedBack: function (aTarget)</span>
<a href="#l9.659"></a><span id="l9.659" class="difflineminus">-  {</span>
<a href="#l9.660"></a><span id="l9.660" class="difflineminus">-    var newTarget;</span>
<a href="#l9.661"></a><span id="l9.661" class="difflineminus">-    var bt;</span>
<a href="#l9.662"></a><span id="l9.662" class="difflineminus">-    if (aTarget.id == &quot;PersonalToolbar&quot; || aTarget.id == &quot;bookmarks-ptf&quot;) { </span>
<a href="#l9.663"></a><span id="l9.663" class="difflineminus">-      newTarget = BookmarksToolbar.getLastVisibleBookmark();</span>
<a href="#l9.664"></a><span id="l9.664" class="difflineminus">-      if (newTarget)</span>
<a href="#l9.665"></a><span id="l9.665" class="difflineminus">-        newTarget.removeAttribute(&quot;dragover-right&quot;);</span>
<a href="#l9.666"></a><span id="l9.666" class="difflineminus">-    } else {</span>
<a href="#l9.667"></a><span id="l9.667" class="difflineminus">-      aTarget.removeAttribute(&quot;dragover-left&quot;);</span>
<a href="#l9.668"></a><span id="l9.668" class="difflineminus">-      aTarget.removeAttribute(&quot;dragover-right&quot;);</span>
<a href="#l9.669"></a><span id="l9.669" class="difflineminus">-      aTarget.removeAttribute(&quot;dragover-top&quot;);</span>
<a href="#l9.670"></a><span id="l9.670" class="difflineminus">-      aTarget.removeAttribute(&quot;dragover-bottom&quot;);</span>
<a href="#l9.671"></a><span id="l9.671" class="difflineminus">-    }</span>
<a href="#l9.672"></a><span id="l9.672" class="difflineminus">-  },</span>
<a href="#l9.673"></a><span id="l9.673" class="difflineminus">-</span>
<a href="#l9.674"></a><span id="l9.674" class="difflineminus">-  isContainer: function (aTarget)</span>
<a href="#l9.675"></a><span id="l9.675" class="difflineminus">-  {</span>
<a href="#l9.676"></a><span id="l9.676" class="difflineminus">-    return aTarget.localName == &quot;menu&quot;          || </span>
<a href="#l9.677"></a><span id="l9.677" class="difflineminus">-           aTarget.localName == &quot;toolbarbutton&quot; &amp;&amp;</span>
<a href="#l9.678"></a><span id="l9.678" class="difflineminus">-           aTarget.getAttribute(&quot;type&quot;) == &quot;menu&quot;;</span>
<a href="#l9.679"></a><span id="l9.679" class="difflineminus">-  }</span>
<a href="#l9.680"></a><span id="l9.680" class="difflineminus">-}</span>
<a href="#l9.681"></a><span id="l9.681" class="difflineminus">-</span>
<a href="#l9.682"></a><span id="l9.682" class="difflineminus">-var BookmarksToolbar = </span>
<a href="#l9.683"></a><span id="l9.683" class="difflineminus">-{</span>
<a href="#l9.684"></a><span id="l9.684" class="difflineminus">-  /////////////////////////////////////////////////////////////////////////////</span>
<a href="#l9.685"></a><span id="l9.685" class="difflineminus">-  // make bookmarks toolbar act like menus</span>
<a href="#l9.686"></a><span id="l9.686" class="difflineminus">-  openMenuButton: null,</span>
<a href="#l9.687"></a><span id="l9.687" class="difflineminus">-  autoOpenMenu: function (aTarget)</span>
<a href="#l9.688"></a><span id="l9.688" class="difflineminus">-  {</span>
<a href="#l9.689"></a><span id="l9.689" class="difflineminus">-    if (this.openMenuButton &amp;&amp;</span>
<a href="#l9.690"></a><span id="l9.690" class="difflineminus">-        this.openMenuButton != aTarget &amp;&amp;</span>
<a href="#l9.691"></a><span id="l9.691" class="difflineminus">-        aTarget.localName == &quot;toolbarbutton&quot; &amp;&amp;</span>
<a href="#l9.692"></a><span id="l9.692" class="difflineminus">-        (aTarget.type == &quot;menu&quot; ||</span>
<a href="#l9.693"></a><span id="l9.693" class="difflineminus">-         aTarget.type == &quot;menu-button&quot;)) {</span>
<a href="#l9.694"></a><span id="l9.694" class="difflineminus">-      this.openMenuButton.open = false;</span>
<a href="#l9.695"></a><span id="l9.695" class="difflineminus">-      aTarget.open = true;</span>
<a href="#l9.696"></a><span id="l9.696" class="difflineminus">-    }</span>
<a href="#l9.697"></a><span id="l9.697" class="difflineminus">-  },</span>
<a href="#l9.698"></a><span id="l9.698" class="difflineminus">-  onMenuOpen: function (aTarget)</span>
<a href="#l9.699"></a><span id="l9.699" class="difflineminus">-  {</span>
<a href="#l9.700"></a><span id="l9.700" class="difflineminus">-    if (aTarget.parentNode.localName == &quot;toolbarbutton&quot;)</span>
<a href="#l9.701"></a><span id="l9.701" class="difflineminus">-      this.openMenuButton = aTarget.parentNode;</span>
<a href="#l9.702"></a><span id="l9.702" class="difflineminus">-  },</span>
<a href="#l9.703"></a><span id="l9.703" class="difflineminus">-  onMenuClose: function (aTarget)</span>
<a href="#l9.704"></a><span id="l9.704" class="difflineminus">-  {</span>
<a href="#l9.705"></a><span id="l9.705" class="difflineminus">-    if (aTarget.parentNode.localName == &quot;toolbarbutton&quot;)</span>
<a href="#l9.706"></a><span id="l9.706" class="difflineminus">-      this.openMenuButton = null;</span>
<a href="#l9.707"></a><span id="l9.707" class="difflineminus">-  },</span>
<a href="#l9.708"></a><span id="l9.708" class="difflineminus">-</span>
<a href="#l9.709"></a><span id="l9.709" class="difflineminus">-  /////////////////////////////////////////////////////////////////////////////</span>
<a href="#l9.710"></a><span id="l9.710" class="difflineminus">-  // returns the node of the last visible bookmark on the toolbar --&gt;</span>
<a href="#l9.711"></a><span id="l9.711" class="difflineminus">-  getLastVisibleBookmark: function ()</span>
<a href="#l9.712"></a><span id="l9.712" class="difflineminus">-  {</span>
<a href="#l9.713"></a><span id="l9.713" class="difflineminus">-    var buttons = document.getElementById(&quot;bookmarks-ptf&quot;);</span>
<a href="#l9.714"></a><span id="l9.714" class="difflineminus">-    var button = buttons.firstChild;</span>
<a href="#l9.715"></a><span id="l9.715" class="difflineminus">-    if (!button)</span>
<a href="#l9.716"></a><span id="l9.716" class="difflineminus">-      return null; // empty bookmarks toolbar</span>
<a href="#l9.717"></a><span id="l9.717" class="difflineminus">-    do {</span>
<a href="#l9.718"></a><span id="l9.718" class="difflineminus">-      if (button.collapsed)</span>
<a href="#l9.719"></a><span id="l9.719" class="difflineminus">-        return button.previousSibling;</span>
<a href="#l9.720"></a><span id="l9.720" class="difflineminus">-      button = button.nextSibling;</span>
<a href="#l9.721"></a><span id="l9.721" class="difflineminus">-    } while (button)</span>
<a href="#l9.722"></a><span id="l9.722" class="difflineminus">-    return buttons.lastChild;</span>
<a href="#l9.723"></a><span id="l9.723" class="difflineminus">-  },</span>
<a href="#l9.724"></a><span id="l9.724" class="difflineminus">-</span>
<a href="#l9.725"></a><span id="l9.725" class="difflineminus">-  updateOverflowMenu: function (aMenuPopup)</span>
<a href="#l9.726"></a><span id="l9.726" class="difflineminus">-  {</span>
<a href="#l9.727"></a><span id="l9.727" class="difflineminus">-    var hbox = document.getElementById(&quot;bookmarks-ptf&quot;);</span>
<a href="#l9.728"></a><span id="l9.728" class="difflineminus">-    for (var i = 0; i &lt; hbox.childNodes.length; i++) {</span>
<a href="#l9.729"></a><span id="l9.729" class="difflineminus">-      var button = hbox.childNodes[i];</span>
<a href="#l9.730"></a><span id="l9.730" class="difflineminus">-      var menu = aMenuPopup.childNodes[i];</span>
<a href="#l9.731"></a><span id="l9.731" class="difflineminus">-      if (menu.hidden == button.collapsed)</span>
<a href="#l9.732"></a><span id="l9.732" class="difflineminus">-        menu.hidden = !menu.hidden;</span>
<a href="#l9.733"></a><span id="l9.733" class="difflineminus">-    }</span>
<a href="#l9.734"></a><span id="l9.734" class="difflineminus">-  },</span>
<a href="#l9.735"></a><span id="l9.735" class="difflineminus">-</span>
<a href="#l9.736"></a><span id="l9.736" class="difflineminus">-  resizeFunc: function(event) </span>
<a href="#l9.737"></a><span id="l9.737" class="difflineminus">-  {</span>
<a href="#l9.738"></a><span id="l9.738" class="difflineminus">-    if (!event) // timer callback case</span>
<a href="#l9.739"></a><span id="l9.739" class="difflineminus">-      BookmarksToolbarRDFObserver._overflowTimerInEffect = false;</span>
<a href="#l9.740"></a><span id="l9.740" class="difflineminus">-    else if (event.target != window)</span>
<a href="#l9.741"></a><span id="l9.741" class="difflineminus">-      return; // only interested in chrome resizes</span>
<a href="#l9.742"></a><span id="l9.742" class="difflineminus">-</span>
<a href="#l9.743"></a><span id="l9.743" class="difflineminus">-    var buttons = document.getElementById(&quot;bookmarks-ptf&quot;);</span>
<a href="#l9.744"></a><span id="l9.744" class="difflineminus">-    if (!buttons)</span>
<a href="#l9.745"></a><span id="l9.745" class="difflineminus">-      return;</span>
<a href="#l9.746"></a><span id="l9.746" class="difflineminus">-</span>
<a href="#l9.747"></a><span id="l9.747" class="difflineminus">-    var chevron = document.getElementById(&quot;bookmarks-chevron&quot;);</span>
<a href="#l9.748"></a><span id="l9.748" class="difflineminus">-    if (!buttons.firstChild) {</span>
<a href="#l9.749"></a><span id="l9.749" class="difflineminus">-      // No bookmarks means no chevron</span>
<a href="#l9.750"></a><span id="l9.750" class="difflineminus">-      chevron.collapsed = true;</span>
<a href="#l9.751"></a><span id="l9.751" class="difflineminus">-      return;</span>
<a href="#l9.752"></a><span id="l9.752" class="difflineminus">-    }</span>
<a href="#l9.753"></a><span id="l9.753" class="difflineminus">-</span>
<a href="#l9.754"></a><span id="l9.754" class="difflineminus">-    chevron.collapsed = false;</span>
<a href="#l9.755"></a><span id="l9.755" class="difflineminus">-    var chevronWidth = chevron.boxObject.width;</span>
<a href="#l9.756"></a><span id="l9.756" class="difflineminus">-    chevron.collapsed = true;</span>
<a href="#l9.757"></a><span id="l9.757" class="difflineminus">-</span>
<a href="#l9.758"></a><span id="l9.758" class="difflineminus">-    var remainingWidth = buttons.boxObject.width;</span>
<a href="#l9.759"></a><span id="l9.759" class="difflineminus">-    var overflowed = false;</span>
<a href="#l9.760"></a><span id="l9.760" class="difflineminus">-</span>
<a href="#l9.761"></a><span id="l9.761" class="difflineminus">-    for (var i=0; i&lt;buttons.childNodes.length; i++) {</span>
<a href="#l9.762"></a><span id="l9.762" class="difflineminus">-      var button = buttons.childNodes[i];</span>
<a href="#l9.763"></a><span id="l9.763" class="difflineminus">-      button.collapsed = overflowed;</span>
<a href="#l9.764"></a><span id="l9.764" class="difflineminus">-</span>
<a href="#l9.765"></a><span id="l9.765" class="difflineminus">-      if (i == buttons.childNodes.length - 1)</span>
<a href="#l9.766"></a><span id="l9.766" class="difflineminus">-        chevronWidth = 0;</span>
<a href="#l9.767"></a><span id="l9.767" class="difflineminus">-      remainingWidth -= button.boxObject.width;</span>
<a href="#l9.768"></a><span id="l9.768" class="difflineminus">-      if (remainingWidth &lt; chevronWidth) {</span>
<a href="#l9.769"></a><span id="l9.769" class="difflineminus">-        overflowed = true;</span>
<a href="#l9.770"></a><span id="l9.770" class="difflineminus">-        // This button doesn't fit. Show it in the menu. Hide it in the toolbar.</span>
<a href="#l9.771"></a><span id="l9.771" class="difflineminus">-        if (!button.collapsed)</span>
<a href="#l9.772"></a><span id="l9.772" class="difflineminus">-          button.collapsed = true;</span>
<a href="#l9.773"></a><span id="l9.773" class="difflineminus">-        if (chevron.collapsed) {</span>
<a href="#l9.774"></a><span id="l9.774" class="difflineminus">-          chevron.collapsed = false;</span>
<a href="#l9.775"></a><span id="l9.775" class="difflineminus">-        }</span>
<a href="#l9.776"></a><span id="l9.776" class="difflineminus">-      }</span>
<a href="#l9.777"></a><span id="l9.777" class="difflineminus">-    }</span>
<a href="#l9.778"></a><span id="l9.778" class="difflineminus">-  },</span>
<a href="#l9.779"></a><span id="l9.779" class="difflineminus">-</span>
<a href="#l9.780"></a><span id="l9.780" class="difflineminus">-  // Fill in tooltips for personal toolbar (and Bookmarks menu).</span>
<a href="#l9.781"></a><span id="l9.781" class="difflineminus">-  fillInBTTooltip: function (tipElement)</span>
<a href="#l9.782"></a><span id="l9.782" class="difflineminus">-  {</span>
<a href="#l9.783"></a><span id="l9.783" class="difflineminus">-    // Don't show a tooltip for non bookmark related elements.</span>
<a href="#l9.784"></a><span id="l9.784" class="difflineminus">-    if (!/bookmark/.test(tipElement.className))</span>
<a href="#l9.785"></a><span id="l9.785" class="difflineminus">-      return false;</span>
<a href="#l9.786"></a><span id="l9.786" class="difflineminus">-</span>
<a href="#l9.787"></a><span id="l9.787" class="difflineminus">-    var title = tipElement.label;</span>
<a href="#l9.788"></a><span id="l9.788" class="difflineminus">-    var url = tipElement.statusText;</span>
<a href="#l9.789"></a><span id="l9.789" class="difflineminus">-</span>
<a href="#l9.790"></a><span id="l9.790" class="difflineminus">-    // Don't show a tooltip without any data.</span>
<a href="#l9.791"></a><span id="l9.791" class="difflineminus">-    if (!title &amp;&amp; !url)</span>
<a href="#l9.792"></a><span id="l9.792" class="difflineminus">-      return false;</span>
<a href="#l9.793"></a><span id="l9.793" class="difflineminus">-</span>
<a href="#l9.794"></a><span id="l9.794" class="difflineminus">-    var tooltipElement = document.getElementById(&quot;btTitleText&quot;);</span>
<a href="#l9.795"></a><span id="l9.795" class="difflineminus">-    tooltipElement.hidden = !title || (title == url);</span>
<a href="#l9.796"></a><span id="l9.796" class="difflineminus">-    if (!tooltipElement.hidden)</span>
<a href="#l9.797"></a><span id="l9.797" class="difflineminus">-      tooltipElement.setAttribute(&quot;value&quot;, title);</span>
<a href="#l9.798"></a><span id="l9.798" class="difflineminus">-</span>
<a href="#l9.799"></a><span id="l9.799" class="difflineminus">-    tooltipElement = document.getElementById(&quot;btUrlText&quot;);</span>
<a href="#l9.800"></a><span id="l9.800" class="difflineminus">-    tooltipElement.hidden = !url;</span>
<a href="#l9.801"></a><span id="l9.801" class="difflineminus">-    if (!tooltipElement.hidden)</span>
<a href="#l9.802"></a><span id="l9.802" class="difflineminus">-      tooltipElement.setAttribute(&quot;value&quot;, url);</span>
<a href="#l9.803"></a><span id="l9.803" class="difflineminus">-</span>
<a href="#l9.804"></a><span id="l9.804" class="difflineminus">-    // Show the tooltip.</span>
<a href="#l9.805"></a><span id="l9.805" class="difflineminus">-    return true;</span>
<a href="#l9.806"></a><span id="l9.806" class="difflineminus">-  }</span>
<a href="#l9.807"></a><span id="l9.807" class="difflineminus">-}</span>
<a href="#l9.808"></a><span id="l9.808" class="difflineminus">-</span>
<a href="#l9.809"></a><span id="l9.809" class="difflineminus">-// Implement nsIRDFObserver so we can update our overflow state when items get</span>
<a href="#l9.810"></a><span id="l9.810" class="difflineminus">-// added/removed from the toolbar</span>
<a href="#l9.811"></a><span id="l9.811" class="difflineminus">-var BookmarksToolbarRDFObserver =</span>
<a href="#l9.812"></a><span id="l9.812" class="difflineminus">-{</span>
<a href="#l9.813"></a><span id="l9.813" class="difflineminus">-  onAssert: function (aDataSource, aSource, aProperty, aTarget)</span>
<a href="#l9.814"></a><span id="l9.814" class="difflineminus">-  {</span>
<a href="#l9.815"></a><span id="l9.815" class="difflineminus">-    this.setOverflowTimeout(aSource, aProperty);</span>
<a href="#l9.816"></a><span id="l9.816" class="difflineminus">-  },</span>
<a href="#l9.817"></a><span id="l9.817" class="difflineminus">-  onUnassert: function (aDataSource, aSource, aProperty, aTarget)</span>
<a href="#l9.818"></a><span id="l9.818" class="difflineminus">-  {</span>
<a href="#l9.819"></a><span id="l9.819" class="difflineminus">-    this.setOverflowTimeout(aSource, aProperty);</span>
<a href="#l9.820"></a><span id="l9.820" class="difflineminus">-  },</span>
<a href="#l9.821"></a><span id="l9.821" class="difflineminus">-  onChange: function (aDataSource, aSource, aProperty, aOldTarget, aNewTarget) {},</span>
<a href="#l9.822"></a><span id="l9.822" class="difflineminus">-  onMove: function (aDataSource, aOldSource, aNewSource, aProperty, aTarget) {},</span>
<a href="#l9.823"></a><span id="l9.823" class="difflineminus">-  onBeginUpdateBatch: function (aDataSource) {},</span>
<a href="#l9.824"></a><span id="l9.824" class="difflineminus">-  onEndUpdateBatch: function (aDataSource)</span>
<a href="#l9.825"></a><span id="l9.825" class="difflineminus">-  {</span>
<a href="#l9.826"></a><span id="l9.826" class="difflineminus">-    if (this._overflowTimerInEffect)</span>
<a href="#l9.827"></a><span id="l9.827" class="difflineminus">-      return;</span>
<a href="#l9.828"></a><span id="l9.828" class="difflineminus">-    this._overflowTimerInEffect = true;</span>
<a href="#l9.829"></a><span id="l9.829" class="difflineminus">-    setTimeout(BookmarksToolbar.resizeFunc, 0, null);</span>
<a href="#l9.830"></a><span id="l9.830" class="difflineminus">-  },</span>
<a href="#l9.831"></a><span id="l9.831" class="difflineminus">-  _overflowTimerInEffect: false,</span>
<a href="#l9.832"></a><span id="l9.832" class="difflineminus">-  setOverflowTimeout: function (aSource, aProperty)</span>
<a href="#l9.833"></a><span id="l9.833" class="difflineminus">-  {</span>
<a href="#l9.834"></a><span id="l9.834" class="difflineminus">-    if (this._overflowTimerInEffect)</span>
<a href="#l9.835"></a><span id="l9.835" class="difflineminus">-      return;</span>
<a href="#l9.836"></a><span id="l9.836" class="difflineminus">-    if (aSource.Value != &quot;NC:PersonalToolbarFolder&quot; || aProperty.Value == NC_NS+&quot;LastModifiedDate&quot;)</span>
<a href="#l9.837"></a><span id="l9.837" class="difflineminus">-      return;</span>
<a href="#l9.838"></a><span id="l9.838" class="difflineminus">-    this._overflowTimerInEffect = true;</span>
<a href="#l9.839"></a><span id="l9.839" class="difflineminus">-    setTimeout(BookmarksToolbar.resizeFunc, 0, null);</span>
<a href="#l9.840"></a><span id="l9.840" class="difflineminus">-  }</span>
<a href="#l9.841"></a><span id="l9.841" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1">deleted file mode 100644</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineminus">--- a/suite/common/bookmarks/bookmarksOverlay.xul</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineplus">+++ /dev/null</span>
<a href="#l10.4"></a><span id="l10.4" class="difflineat">@@ -1,115 +0,0 @@</span>
<a href="#l10.5"></a><span id="l10.5" class="difflineminus">-&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<a href="#l10.6"></a><span id="l10.6" class="difflineminus">-</span>
<a href="#l10.7"></a><span id="l10.7" class="difflineminus">-&lt;!-- -*- Mode: HTML; indent-tabs-mode: nil; -*- --&gt;</span>
<a href="#l10.8"></a><span id="l10.8" class="difflineminus">-&lt;!--</span>
<a href="#l10.9"></a><span id="l10.9" class="difflineminus">-</span>
<a href="#l10.10"></a><span id="l10.10" class="difflineminus">- ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l10.11"></a><span id="l10.11" class="difflineminus">- Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">- The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineminus">- 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineminus">- the License. You may obtain a copy of the License at</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineminus">- http://www.mozilla.org/MPL/</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineminus">-</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineminus">- Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineminus">- WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineminus">- for the specific language governing rights and limitations under the</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineminus">- License.</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineminus">-</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineminus">- The Original Code is mozilla.org code.</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineminus">-</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineminus">- The Initial Developer of the Original Code is</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineminus">- Netscape Communications Corporation.</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineminus">- Portions created by the Initial Developer are Copyright (C) 1998</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineminus">- the Initial Developer. All Rights Reserved.</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineminus">-</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineminus">- Contributor(s):</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineminus">-   Ben Goodger &lt;ben@netscape.com&gt; (Original Author)</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineminus">-</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineminus">- Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineminus">- either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineminus">- or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineminus">- in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineminus">- of those above. If you wish to allow use of your version of this file only</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineminus">- under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineminus">- use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineminus">- decision by deleting the provisions above and replace them with the notice</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineminus">- and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineminus">- the provisions above, a recipient may use your version of this file under</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineminus">- the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineminus">-</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineminus">- ***** END LICENSE BLOCK ***** --&gt;</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineminus">-</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineminus">-&lt;!DOCTYPE overlay SYSTEM &quot;chrome://communicator/locale/bookmarks/bookmarks.dtd&quot;&gt;</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineminus">-</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineminus">-&lt;overlay id=&quot;bookmarksOverlay&quot;</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineminus">-         xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;&gt;</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineminus">-</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineminus">-  &lt;stringbundleset id=&quot;stringbundleset&quot;&gt;</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineminus">-    &lt;stringbundle id=&quot;bundle_bookmarks&quot; src=&quot;chrome://communicator/locale/bookmarks/bookmarks.properties&quot;/&gt;</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineminus">-    &lt;stringbundle id=&quot;bundle_brand&quot; src=&quot;chrome://branding/locale/brand.properties&quot;/&gt;</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineminus">-  &lt;/stringbundleset&gt;</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineminus">-</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineminus">-  &lt;commands id=&quot;commands&quot;&gt;</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineminus">-    &lt;commandset id=&quot;bookmarksItems&quot;&gt;</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineminus">-      &lt;command id=&quot;cmd_bm_open&quot;                      oncommand=&quot;goDoCommand('cmd_bm_open');&quot;/&gt;</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineminus">-      &lt;command id=&quot;cmd_bm_openinnewwindow&quot;           oncommand=&quot;goDoCommand('cmd_bm_openinnewwindow');&quot;/&gt;</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineminus">-      &lt;command id=&quot;cmd_bm_openinnewtab&quot;              oncommand=&quot;goDoCommand('cmd_bm_openinnewtab');&quot;/&gt;</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineminus">-      &lt;command id=&quot;cmd_bm_expandfolder&quot;              oncommand=&quot;goDoCommand('cmd_bm_expandfolder');&quot;/&gt;</span>
<a href="#l10.63"></a><span id="l10.63" class="difflineminus">-      &lt;command id=&quot;cmd_bm_managefolder&quot;              oncommand=&quot;goDoCommand('cmd_bm_managefolder');&quot;/&gt;</span>
<a href="#l10.64"></a><span id="l10.64" class="difflineminus">-      &lt;command id=&quot;cmd_bm_newfolder&quot;                 oncommand=&quot;goDoCommand('cmd_bm_newfolder');&quot;/&gt;</span>
<a href="#l10.65"></a><span id="l10.65" class="difflineminus">-      &lt;command id=&quot;cmd_bm_newbookmark&quot;               oncommand=&quot;goDoCommand('cmd_bm_newbookmark');&quot;/&gt;</span>
<a href="#l10.66"></a><span id="l10.66" class="difflineminus">-      &lt;command id=&quot;cmd_bm_newseparator&quot;              oncommand=&quot;goDoCommand('cmd_bm_newseparator');&quot;/&gt;</span>
<a href="#l10.67"></a><span id="l10.67" class="difflineminus">-      &lt;command id=&quot;cmd_bm_find&quot;                      oncommand=&quot;goDoCommand('cmd_bm_find');&quot;/&gt;</span>
<a href="#l10.68"></a><span id="l10.68" class="difflineminus">-      &lt;command id=&quot;cmd_bm_setnewbookmarkfolder&quot;      oncommand=&quot;goDoCommand('cmd_bm_setnewbookmarkfolder');&quot;/&gt;</span>
<a href="#l10.69"></a><span id="l10.69" class="difflineminus">-      &lt;command id=&quot;cmd_bm_setpersonaltoolbarfolder&quot;  oncommand=&quot;goDoCommand('cmd_bm_setpersonaltoolbarfolder');&quot;/&gt;</span>
<a href="#l10.70"></a><span id="l10.70" class="difflineminus">-      &lt;command id=&quot;cmd_bm_setnewsearchfolder&quot;        oncommand=&quot;goDoCommand('cmd_bm_setnewsearchfolder');&quot;/&gt;</span>
<a href="#l10.71"></a><span id="l10.71" class="difflineminus">-      &lt;command id=&quot;cmd_bm_properties&quot;                oncommand=&quot;goDoCommand('cmd_bm_properties');&quot;/&gt;</span>
<a href="#l10.72"></a><span id="l10.72" class="difflineminus">-      &lt;command id=&quot;cmd_bm_rename&quot;                    oncommand=&quot;goDoCommand('cmd_bm_rename');&quot;/&gt;</span>
<a href="#l10.73"></a><span id="l10.73" class="difflineminus">-      &lt;command id=&quot;cmd_bm_import&quot;                    oncommand=&quot;goDoCommand('cmd_bm_import');&quot;/&gt;</span>
<a href="#l10.74"></a><span id="l10.74" class="difflineminus">-      &lt;command id=&quot;cmd_bm_export&quot;                    oncommand=&quot;goDoCommand('cmd_bm_export');&quot;/&gt;</span>
<a href="#l10.75"></a><span id="l10.75" class="difflineminus">-      &lt;command id=&quot;cmd_bm_movebookmark&quot;              oncommand=&quot;goDoCommand('cmd_bm_movebookmark');&quot;/&gt;</span>
<a href="#l10.76"></a><span id="l10.76" class="difflineminus">-      &lt;command id=&quot;cmd_bm_sortfolder&quot;                oncommand=&quot;goDoCommand('cmd_bm_sortfolder');&quot;/&gt;</span>
<a href="#l10.77"></a><span id="l10.77" class="difflineminus">-      &lt;command id=&quot;cmd_bm_sortfolderbyname&quot;          oncommand=&quot;goDoCommand('cmd_bm_sortfolderbyname');&quot;/&gt;</span>
<a href="#l10.78"></a><span id="l10.78" class="difflineminus">-</span>
<a href="#l10.79"></a><span id="l10.79" class="difflineminus">-      &lt;command id=&quot;cmd_bm_cut&quot;                    oncommand=&quot;goDoCommand('cmd_bm_cut');&quot;/&gt;</span>
<a href="#l10.80"></a><span id="l10.80" class="difflineminus">-      &lt;command id=&quot;cmd_bm_copy&quot;                   oncommand=&quot;goDoCommand('cmd_bm_copy');&quot;/&gt;</span>
<a href="#l10.81"></a><span id="l10.81" class="difflineminus">-      &lt;command id=&quot;cmd_bm_paste&quot;                  oncommand=&quot;goDoCommand('cmd_bm_paste');&quot;/&gt;</span>
<a href="#l10.82"></a><span id="l10.82" class="difflineminus">-      &lt;command id=&quot;cmd_bm_delete&quot;                 oncommand=&quot;goDoCommand('cmd_bm_delete');&quot;/&gt;</span>
<a href="#l10.83"></a><span id="l10.83" class="difflineminus">-      &lt;command id=&quot;cmd_bm_selectAll&quot;              oncommand=&quot;goDoCommand('cmd_bm_selectAll');&quot;/&gt;</span>
<a href="#l10.84"></a><span id="l10.84" class="difflineminus">-    &lt;/commandset&gt;</span>
<a href="#l10.85"></a><span id="l10.85" class="difflineminus">-    &lt;commandset id=&quot;selectEditMenuItems&quot;/&gt;</span>
<a href="#l10.86"></a><span id="l10.86" class="difflineminus">-    &lt;commandset id=&quot;globalEditMenuItems&quot;/&gt;</span>
<a href="#l10.87"></a><span id="l10.87" class="difflineminus">-  &lt;/commands&gt;</span>
<a href="#l10.88"></a><span id="l10.88" class="difflineminus">-</span>
<a href="#l10.89"></a><span id="l10.89" class="difflineminus">-  &lt;keyset id=&quot;bookmarks-tasksKeys&quot;&gt;</span>
<a href="#l10.90"></a><span id="l10.90" class="difflineminus">-    &lt;!-- Edit Menu --&gt;</span>
<a href="#l10.91"></a><span id="l10.91" class="difflineminus">-    &lt;key id=&quot;key_undo&quot;/&gt;</span>
<a href="#l10.92"></a><span id="l10.92" class="difflineminus">-    &lt;key id=&quot;key_redo&quot;/&gt;</span>
<a href="#l10.93"></a><span id="l10.93" class="difflineminus">-</span>
<a href="#l10.94"></a><span id="l10.94" class="difflineminus">-    &lt;!-- These keybindings do not have a command specified in the overlay,</span>
<a href="#l10.95"></a><span id="l10.95" class="difflineminus">-         which is good, but we need to specify it ourselves here --&gt;</span>
<a href="#l10.96"></a><span id="l10.96" class="difflineminus">-    &lt;key id=&quot;key_cut&quot; command=&quot;cmd_bm_cut&quot;/&gt;</span>
<a href="#l10.97"></a><span id="l10.97" class="difflineminus">-    &lt;key id=&quot;key_copy&quot; command=&quot;cmd_bm_copy&quot;/&gt;</span>
<a href="#l10.98"></a><span id="l10.98" class="difflineminus">-    &lt;key id=&quot;key_paste&quot; command=&quot;cmd_bm_paste&quot;/&gt;</span>
<a href="#l10.99"></a><span id="l10.99" class="difflineminus">-    &lt;key id=&quot;key_selectAll&quot; command=&quot;cmd_bm_selectAll&quot;/&gt;</span>
<a href="#l10.100"></a><span id="l10.100" class="difflineminus">-</span>
<a href="#l10.101"></a><span id="l10.101" class="difflineminus">-    &lt;!-- These keybindings do have a command specified in the overlay,</span>
<a href="#l10.102"></a><span id="l10.102" class="difflineminus">-         which we need to correct in our Startup() function --&gt;</span>
<a href="#l10.103"></a><span id="l10.103" class="difflineminus">-    &lt;key id=&quot;key_delete&quot;/&gt;</span>
<a href="#l10.104"></a><span id="l10.104" class="difflineminus">-    &lt;key id=&quot;key_delete2&quot;/&gt;</span>
<a href="#l10.105"></a><span id="l10.105" class="difflineminus">-</span>
<a href="#l10.106"></a><span id="l10.106" class="difflineminus">-    &lt;key id=&quot;bm_key_find&quot;</span>
<a href="#l10.107"></a><span id="l10.107" class="difflineminus">-         key=&quot;&amp;menuitem.find.find.key;&quot;</span>
<a href="#l10.108"></a><span id="l10.108" class="difflineminus">-         command=&quot;cmd_bm_find&quot; modifiers=&quot;accel,shift&quot;/&gt;</span>
<a href="#l10.109"></a><span id="l10.109" class="difflineminus">-</span>
<a href="#l10.110"></a><span id="l10.110" class="difflineminus">-    &lt;key id=&quot;bm_key_sortFolder&quot;</span>
<a href="#l10.111"></a><span id="l10.111" class="difflineminus">-         key=&quot;&amp;command.sortFolder.key;&quot;</span>
<a href="#l10.112"></a><span id="l10.112" class="difflineminus">-         command=&quot;cmd_bm_sortfolder&quot; modifiers=&quot;accel&quot;/&gt;</span>
<a href="#l10.113"></a><span id="l10.113" class="difflineminus">-</span>
<a href="#l10.114"></a><span id="l10.114" class="difflineminus">-    &lt;key id=&quot;bm_key_properties&quot;</span>
<a href="#l10.115"></a><span id="l10.115" class="difflineminus">-         key=&quot;&amp;menuitem.properties.key;&quot;</span>
<a href="#l10.116"></a><span id="l10.116" class="difflineminus">-         command=&quot;cmd_bm_properties&quot; modifiers=&quot;accel&quot;/&gt;</span>
<a href="#l10.117"></a><span id="l10.117" class="difflineminus">-  &lt;/keyset&gt;</span>
<a href="#l10.118"></a><span id="l10.118" class="difflineminus">-</span>
<a href="#l10.119"></a><span id="l10.119" class="difflineminus">-&lt;/overlay&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1">deleted file mode 100644</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineminus">--- a/suite/common/bookmarks/bookmarksTree.xml</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineplus">+++ /dev/null</span>
<a href="#l11.4"></a><span id="l11.4" class="difflineat">@@ -1,959 +0,0 @@</span>
<a href="#l11.5"></a><span id="l11.5" class="difflineminus">-&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<a href="#l11.6"></a><span id="l11.6" class="difflineminus">-</span>
<a href="#l11.7"></a><span id="l11.7" class="difflineminus">-&lt;!-- -*- Mode: HTML; indent-tabs-mode: nil; -*- --&gt;</span>
<a href="#l11.8"></a><span id="l11.8" class="difflineminus">-&lt;!--</span>
<a href="#l11.9"></a><span id="l11.9" class="difflineminus">-</span>
<a href="#l11.10"></a><span id="l11.10" class="difflineminus">- ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l11.11"></a><span id="l11.11" class="difflineminus">- Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">- The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineminus">- 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineminus">- the License. You may obtain a copy of the License at</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineminus">- http://www.mozilla.org/MPL/</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineminus">-</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineminus">- Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineminus">- WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineminus">- for the specific language governing rights and limitations under the</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineminus">- License.</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineminus">-</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineminus">- The Original Code is mozilla.org code.</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineminus">-</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineminus">- The Initial Developer of the Original Code is</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineminus">- Netscape Communications Corporation.</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineminus">- Portions created by the Initial Developer are Copyright (C) 1998</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineminus">- the Initial Developer. All Rights Reserved.</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineminus">-</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineminus">- Contributor(s):</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineminus">-   Ben Goodger &lt;ben@netscape.com&gt; (Original Author)</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineminus">-   Blake Ross &lt;blakeross@telocity.com&gt;</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineminus">-   Pierre Chanial &lt;chanial@noos.fr&gt; (v2.0)</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineminus">-   Dan Cannon     &lt;dc2@myrealbox.com&gt;</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineminus">-</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineminus">- Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineminus">- either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineminus">- or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineminus">- in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineminus">- of those above. If you wish to allow use of your version of this file only</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineminus">- under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineminus">- use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineminus">- decision by deleting the provisions above and replace them with the notice</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineminus">- and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineminus">- the provisions above, a recipient may use your version of this file under</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineminus">- the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineminus">-</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineminus">- ***** END LICENSE BLOCK ***** --&gt;</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineminus">-</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineminus">-&lt;!-- bookmarksTree.xml depends on global variables defined in bookmarks.js.</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineminus">-     Before use, these must be initialized by calling initServices() and </span>
<a href="#l11.52"></a><span id="l11.52" class="difflineminus">-     initBMService() --&gt;</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineminus">-</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineminus">-&lt;!DOCTYPE bindings [</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineminus">-  &lt;!ENTITY % bookmarksDTD SYSTEM &quot;chrome://communicator/locale/bookmarks/bookmarks.dtd&quot; &gt;</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineminus">-  %bookmarksDTD;</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineminus">-]&gt;</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineminus">-</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineminus">-&lt;bindings id=&quot;bookmarksBindings&quot; </span>
<a href="#l11.60"></a><span id="l11.60" class="difflineminus">-          xmlns=&quot;http://www.mozilla.org/xbl&quot; </span>
<a href="#l11.61"></a><span id="l11.61" class="difflineminus">-          xmlns:xul=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot; </span>
<a href="#l11.62"></a><span id="l11.62" class="difflineminus">-          xmlns:rdf=&quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#&quot;</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineminus">-          xmlns:xbl=&quot;http://www.mozilla.org/xbl&quot;&gt;</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineminus">-</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineminus">-  &lt;binding id=&quot;bookmarks-tree&quot;&gt;</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineminus">-    &lt;implementation&gt;</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineminus">-      &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l11.68"></a><span id="l11.68" class="difflineminus">-        // This function only reads in the bookmarks from disk if they have not already been read.</span>
<a href="#l11.69"></a><span id="l11.69" class="difflineminus">-        initServices();</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineminus">-        initBMService();</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineminus">-</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineminus">-        BMSVC.readBookmarks();</span>
<a href="#l11.73"></a><span id="l11.73" class="difflineminus">-</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineminus">-        // Add controllers and listeners.</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineminus">-        this.tree.controllers.appendController(this.controller);</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineminus">-</span>
<a href="#l11.77"></a><span id="l11.77" class="difflineminus">-        // XXXvarga this observer should go away once bug 120071 is fixed.</span>
<a href="#l11.78"></a><span id="l11.78" class="difflineminus">-        this.treeBuilder.addObserver(this.builderObserver);</span>
<a href="#l11.79"></a><span id="l11.79" class="difflineminus">-</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineminus">-        this.tree.builder.addListener(this.builderListener);</span>
<a href="#l11.81"></a><span id="l11.81" class="difflineminus">-</span>
<a href="#l11.82"></a><span id="l11.82" class="difflineminus">-        BMSVC.transactionManager.AddListener(this.transactionListener);</span>
<a href="#l11.83"></a><span id="l11.83" class="difflineminus">-</span>
<a href="#l11.84"></a><span id="l11.84" class="difflineminus">-        Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l11.85"></a><span id="l11.85" class="difflineminus">-                  .getService(Components.interfaces.nsIObserverService)</span>
<a href="#l11.86"></a><span id="l11.86" class="difflineminus">-                  .addObserver(this.bookmarksChangedObserver,</span>
<a href="#l11.87"></a><span id="l11.87" class="difflineminus">-                               &quot;bookmarks-changed&quot;, false);</span>
<a href="#l11.88"></a><span id="l11.88" class="difflineminus">-</span>
<a href="#l11.89"></a><span id="l11.89" class="difflineminus">-        // Load column settings from persisted attribute</span>
<a href="#l11.90"></a><span id="l11.90" class="difflineminus">-        var colinfostr = this.getAttribute(&quot;colinfo&quot;);</span>
<a href="#l11.91"></a><span id="l11.91" class="difflineminus">-        var colinfo = colinfostr.split(&quot; &quot;);</span>
<a href="#l11.92"></a><span id="l11.92" class="difflineminus">-        for (var i = 0; i &lt; colinfo.length; ++i) {</span>
<a href="#l11.93"></a><span id="l11.93" class="difflineminus">-          if (colinfo[i] == &quot;&quot;) continue;</span>
<a href="#l11.94"></a><span id="l11.94" class="difflineminus">-</span>
<a href="#l11.95"></a><span id="l11.95" class="difflineminus">-          var querymarker = colinfo[i].indexOf(&quot;?&quot;);</span>
<a href="#l11.96"></a><span id="l11.96" class="difflineminus">-          var anonid = colinfo[i].substring(4, querymarker);</span>
<a href="#l11.97"></a><span id="l11.97" class="difflineminus">-          var col = document.getAnonymousElementByAttribute(this, &quot;id&quot;, anonid);</span>
<a href="#l11.98"></a><span id="l11.98" class="difflineminus">-</span>
<a href="#l11.99"></a><span id="l11.99" class="difflineminus">-          if (!anonid || !col) break;</span>
<a href="#l11.100"></a><span id="l11.100" class="difflineminus">-</span>
<a href="#l11.101"></a><span id="l11.101" class="difflineminus">-          var attrstring = colinfo[i].substr(querymarker + 1);</span>
<a href="#l11.102"></a><span id="l11.102" class="difflineminus">-</span>
<a href="#l11.103"></a><span id="l11.103" class="difflineminus">-          var attrpairs = attrstring.split(&quot;&amp;&quot;);</span>
<a href="#l11.104"></a><span id="l11.104" class="difflineminus">-          for (var j = 0; j &lt; attrpairs.length; ++j) {</span>
<a href="#l11.105"></a><span id="l11.105" class="difflineminus">-            var pair = attrpairs[j].split(&quot;=&quot;);</span>
<a href="#l11.106"></a><span id="l11.106" class="difflineminus">-            col.setAttribute(pair[0], pair[1]);</span>
<a href="#l11.107"></a><span id="l11.107" class="difflineminus">-          }</span>
<a href="#l11.108"></a><span id="l11.108" class="difflineminus">-        }</span>
<a href="#l11.109"></a><span id="l11.109" class="difflineminus">-      ]]&gt;&lt;/constructor&gt;</span>
<a href="#l11.110"></a><span id="l11.110" class="difflineminus">-      &lt;destructor&gt;&lt;![CDATA[</span>
<a href="#l11.111"></a><span id="l11.111" class="difflineminus">-        // Remove controllers and listeners.</span>
<a href="#l11.112"></a><span id="l11.112" class="difflineminus">-        BMSVC.transactionManager.RemoveListener(this.transactionListener);</span>
<a href="#l11.113"></a><span id="l11.113" class="difflineminus">-</span>
<a href="#l11.114"></a><span id="l11.114" class="difflineminus">-        this.tree.builder.removeListener(this.builderListener);</span>
<a href="#l11.115"></a><span id="l11.115" class="difflineminus">-</span>
<a href="#l11.116"></a><span id="l11.116" class="difflineminus">-        this.treeBuilder.removeObserver(this.builderObserver);</span>
<a href="#l11.117"></a><span id="l11.117" class="difflineminus">-</span>
<a href="#l11.118"></a><span id="l11.118" class="difflineminus">-        this.tree.controllers.removeController(this.controller);</span>
<a href="#l11.119"></a><span id="l11.119" class="difflineminus">-</span>
<a href="#l11.120"></a><span id="l11.120" class="difflineminus">-        Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l11.121"></a><span id="l11.121" class="difflineminus">-                  .getService(Components.interfaces.nsIObserverService)</span>
<a href="#l11.122"></a><span id="l11.122" class="difflineminus">-                  .removeObserver(this.bookmarksChangedObserver,</span>
<a href="#l11.123"></a><span id="l11.123" class="difflineminus">-                                  &quot;bookmarks-changed&quot;);</span>
<a href="#l11.124"></a><span id="l11.124" class="difflineminus">-</span>
<a href="#l11.125"></a><span id="l11.125" class="difflineminus">-        // Save column settings and sort info to persisted attribute</span>
<a href="#l11.126"></a><span id="l11.126" class="difflineminus">-        var persistString = &quot;&quot;;</span>
<a href="#l11.127"></a><span id="l11.127" class="difflineminus">-</span>
<a href="#l11.128"></a><span id="l11.128" class="difflineminus">-        var treecols = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;treecols&quot;);</span>
<a href="#l11.129"></a><span id="l11.129" class="difflineminus">-        var child = treecols.firstChild;</span>
<a href="#l11.130"></a><span id="l11.130" class="difflineminus">-        while (child) {</span>
<a href="#l11.131"></a><span id="l11.131" class="difflineminus">-          if (child.localName != &quot;splitter&quot;) {</span>
<a href="#l11.132"></a><span id="l11.132" class="difflineminus">-            var formatString = &quot; col:%1%?width=%2%&amp;hidden=%3%&amp;ordinal=%6%&quot;;</span>
<a href="#l11.133"></a><span id="l11.133" class="difflineminus">-            formatString = formatString.replace(/%1%/, child.getAttribute(&quot;id&quot;));</span>
<a href="#l11.134"></a><span id="l11.134" class="difflineminus">-            formatString = formatString.replace(/%2%/, child.getAttribute(&quot;width&quot;));</span>
<a href="#l11.135"></a><span id="l11.135" class="difflineminus">-            formatString = formatString.replace(/%3%/, child.getAttribute(&quot;hidden&quot;));</span>
<a href="#l11.136"></a><span id="l11.136" class="difflineminus">-            formatString = formatString.replace(/%6%/, child.getAttribute(&quot;ordinal&quot;));</span>
<a href="#l11.137"></a><span id="l11.137" class="difflineminus">-            persistString += formatString;</span>
<a href="#l11.138"></a><span id="l11.138" class="difflineminus">-          }</span>
<a href="#l11.139"></a><span id="l11.139" class="difflineminus">-          child = child.nextSibling;</span>
<a href="#l11.140"></a><span id="l11.140" class="difflineminus">-        }</span>
<a href="#l11.141"></a><span id="l11.141" class="difflineminus">-        this.setAttribute(&quot;colinfo&quot;, persistString);</span>
<a href="#l11.142"></a><span id="l11.142" class="difflineminus">-</span>
<a href="#l11.143"></a><span id="l11.143" class="difflineminus">-        document.persist(this.id, &quot;colinfo&quot;);</span>
<a href="#l11.144"></a><span id="l11.144" class="difflineminus">-      ]]&gt;&lt;/destructor&gt;</span>
<a href="#l11.145"></a><span id="l11.145" class="difflineminus">-</span>
<a href="#l11.146"></a><span id="l11.146" class="difflineminus">-      &lt;property name=&quot;db&quot;&gt;</span>
<a href="#l11.147"></a><span id="l11.147" class="difflineminus">-        &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l11.148"></a><span id="l11.148" class="difflineminus">-          return this.tree.database;</span>
<a href="#l11.149"></a><span id="l11.149" class="difflineminus">-        ]]&gt;&lt;/getter&gt;</span>
<a href="#l11.150"></a><span id="l11.150" class="difflineminus">-      &lt;/property&gt;      </span>
<a href="#l11.151"></a><span id="l11.151" class="difflineminus">-      </span>
<a href="#l11.152"></a><span id="l11.152" class="difflineminus">-      &lt;property name=&quot;columns&quot;&gt;</span>
<a href="#l11.153"></a><span id="l11.153" class="difflineminus">-        &lt;getter&gt;</span>
<a href="#l11.154"></a><span id="l11.154" class="difflineminus">-        &lt;![CDATA[</span>
<a href="#l11.155"></a><span id="l11.155" class="difflineminus">-          var cols = [];</span>
<a href="#l11.156"></a><span id="l11.156" class="difflineminus">-        </span>
<a href="#l11.157"></a><span id="l11.157" class="difflineminus">-          var treecols = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;treecols&quot;);</span>
<a href="#l11.158"></a><span id="l11.158" class="difflineminus">-          var child = treecols.firstChild;</span>
<a href="#l11.159"></a><span id="l11.159" class="difflineminus">-          while (child) {</span>
<a href="#l11.160"></a><span id="l11.160" class="difflineminus">-            if (child.localName != &quot;splitter&quot;) {</span>
<a href="#l11.161"></a><span id="l11.161" class="difflineminus">-              var obj = {</span>
<a href="#l11.162"></a><span id="l11.162" class="difflineminus">-                id: child.getAttribute(&quot;id&quot;),</span>
<a href="#l11.163"></a><span id="l11.163" class="difflineminus">-                label: child.getAttribute(&quot;label&quot;),</span>
<a href="#l11.164"></a><span id="l11.164" class="difflineminus">-                accesskey: child.getAttribute(&quot;accesskey&quot;),</span>
<a href="#l11.165"></a><span id="l11.165" class="difflineminus">-                hidden: child.getAttribute(&quot;hidden&quot;)</span>
<a href="#l11.166"></a><span id="l11.166" class="difflineminus">-              }</span>
<a href="#l11.167"></a><span id="l11.167" class="difflineminus">-              cols.push(obj);</span>
<a href="#l11.168"></a><span id="l11.168" class="difflineminus">-            }</span>
<a href="#l11.169"></a><span id="l11.169" class="difflineminus">-            child = child.nextSibling;</span>
<a href="#l11.170"></a><span id="l11.170" class="difflineminus">-          }</span>
<a href="#l11.171"></a><span id="l11.171" class="difflineminus">-</span>
<a href="#l11.172"></a><span id="l11.172" class="difflineminus">-          return cols;</span>
<a href="#l11.173"></a><span id="l11.173" class="difflineminus">-        ]]&gt;</span>
<a href="#l11.174"></a><span id="l11.174" class="difflineminus">-        &lt;/getter&gt;</span>
<a href="#l11.175"></a><span id="l11.175" class="difflineminus">-      &lt;/property&gt;</span>
<a href="#l11.176"></a><span id="l11.176" class="difflineminus">-      </span>
<a href="#l11.177"></a><span id="l11.177" class="difflineminus">-      &lt;method name=&quot;toggleColumnVisibility&quot;&gt;</span>
<a href="#l11.178"></a><span id="l11.178" class="difflineminus">-        &lt;parameter name=&quot;aColumnId&quot;/&gt;</span>
<a href="#l11.179"></a><span id="l11.179" class="difflineminus">-        &lt;body&gt;</span>
<a href="#l11.180"></a><span id="l11.180" class="difflineminus">-        &lt;![CDATA[</span>
<a href="#l11.181"></a><span id="l11.181" class="difflineminus">-          var elt = document.getAnonymousElementByAttribute(this, &quot;id&quot;, aColumnId);</span>
<a href="#l11.182"></a><span id="l11.182" class="difflineminus">-          if (elt)</span>
<a href="#l11.183"></a><span id="l11.183" class="difflineminus">-            elt.setAttribute(&quot;hidden&quot;, elt.getAttribute(&quot;hidden&quot;) != &quot;true&quot;);</span>
<a href="#l11.184"></a><span id="l11.184" class="difflineminus">-        ]]&gt;</span>
<a href="#l11.185"></a><span id="l11.185" class="difflineminus">-        &lt;/body&gt;</span>
<a href="#l11.186"></a><span id="l11.186" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l11.187"></a><span id="l11.187" class="difflineminus">-      </span>
<a href="#l11.188"></a><span id="l11.188" class="difflineminus">-      &lt;property name=&quot;treeBoxObject&quot;&gt;</span>
<a href="#l11.189"></a><span id="l11.189" class="difflineminus">-        &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l11.190"></a><span id="l11.190" class="difflineminus">-          return this.tree.boxObject.QueryInterface(Components.interfaces.nsITreeBoxObject);</span>
<a href="#l11.191"></a><span id="l11.191" class="difflineminus">-        ]]&gt;&lt;/getter&gt;</span>
<a href="#l11.192"></a><span id="l11.192" class="difflineminus">-      &lt;/property&gt;</span>
<a href="#l11.193"></a><span id="l11.193" class="difflineminus">-</span>
<a href="#l11.194"></a><span id="l11.194" class="difflineminus">-      &lt;property name=&quot;treeBuilder&quot;&gt;</span>
<a href="#l11.195"></a><span id="l11.195" class="difflineminus">-        &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l11.196"></a><span id="l11.196" class="difflineminus">-          return this.tree.builder.QueryInterface(Components.interfaces.nsIXULTreeBuilder);</span>
<a href="#l11.197"></a><span id="l11.197" class="difflineminus">-        ]]&gt;&lt;/getter&gt;</span>
<a href="#l11.198"></a><span id="l11.198" class="difflineminus">-      &lt;/property&gt;</span>
<a href="#l11.199"></a><span id="l11.199" class="difflineminus">-</span>
<a href="#l11.200"></a><span id="l11.200" class="difflineminus">-      &lt;property name=&quot;tree&quot;&gt;</span>
<a href="#l11.201"></a><span id="l11.201" class="difflineminus">-        &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l11.202"></a><span id="l11.202" class="difflineminus">-          return document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;bookmarks-tree&quot;);</span>
<a href="#l11.203"></a><span id="l11.203" class="difflineminus">-        ]]&gt;&lt;/getter&gt;</span>
<a href="#l11.204"></a><span id="l11.204" class="difflineminus">-      &lt;/property&gt;</span>
<a href="#l11.205"></a><span id="l11.205" class="difflineminus">-</span>
<a href="#l11.206"></a><span id="l11.206" class="difflineminus">-      &lt;property name=&quot;currentIndex&quot;&gt;</span>
<a href="#l11.207"></a><span id="l11.207" class="difflineminus">-        &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l11.208"></a><span id="l11.208" class="difflineminus">-          return this.tree.view.selection.currentIndex;</span>
<a href="#l11.209"></a><span id="l11.209" class="difflineminus">-        ]]&gt;&lt;/getter&gt;</span>
<a href="#l11.210"></a><span id="l11.210" class="difflineminus">-      &lt;/property&gt;</span>
<a href="#l11.211"></a><span id="l11.211" class="difflineminus">-</span>
<a href="#l11.212"></a><span id="l11.212" class="difflineminus">-      &lt;property name=&quot;currentRes&quot;&gt;</span>
<a href="#l11.213"></a><span id="l11.213" class="difflineminus">-        &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l11.214"></a><span id="l11.214" class="difflineminus">-          return this.treeBuilder.getResourceAtIndex(this.currentIndex);</span>
<a href="#l11.215"></a><span id="l11.215" class="difflineminus">-        ]]&gt;&lt;/getter&gt;</span>
<a href="#l11.216"></a><span id="l11.216" class="difflineminus">-      &lt;/property&gt;</span>
<a href="#l11.217"></a><span id="l11.217" class="difflineminus">-</span>
<a href="#l11.218"></a><span id="l11.218" class="difflineminus">-      &lt;property name=&quot;parentRes&quot;&gt;</span>
<a href="#l11.219"></a><span id="l11.219" class="difflineminus">-        &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l11.220"></a><span id="l11.220" class="difflineminus">-          const currIndex = this.currentIndex;</span>
<a href="#l11.221"></a><span id="l11.221" class="difflineminus">-</span>
<a href="#l11.222"></a><span id="l11.222" class="difflineminus">-          if (currIndex == -1)</span>
<a href="#l11.223"></a><span id="l11.223" class="difflineminus">-            return RDF.GetResource(&quot;NC:BookmarksRoot&quot;);</span>
<a href="#l11.224"></a><span id="l11.224" class="difflineminus">-</span>
<a href="#l11.225"></a><span id="l11.225" class="difflineminus">-          var parentIndex = this.treeBoxObject.view.getParentIndex(currIndex);</span>
<a href="#l11.226"></a><span id="l11.226" class="difflineminus">-          if (parentIndex != -1)</span>
<a href="#l11.227"></a><span id="l11.227" class="difflineminus">-            return this.treeBuilder.getResourceAtIndex(parentIndex)</span>
<a href="#l11.228"></a><span id="l11.228" class="difflineminus">-          return RDF.GetResource(&quot;NC:BookmarksRoot&quot;); // assume its parent is the root</span>
<a href="#l11.229"></a><span id="l11.229" class="difflineminus">-        ]]&gt;&lt;/getter&gt;</span>
<a href="#l11.230"></a><span id="l11.230" class="difflineminus">-      &lt;/property&gt;</span>
<a href="#l11.231"></a><span id="l11.231" class="difflineminus">-</span>
<a href="#l11.232"></a><span id="l11.232" class="difflineminus">-      &lt;property name=&quot;type&quot;&gt;</span>
<a href="#l11.233"></a><span id="l11.233" class="difflineminus">-        &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l11.234"></a><span id="l11.234" class="difflineminus">-          if (!this._type) {</span>
<a href="#l11.235"></a><span id="l11.235" class="difflineminus">-            var type = this.getAttribute(&quot;type&quot;);</span>
<a href="#l11.236"></a><span id="l11.236" class="difflineminus">-            if (!type)</span>
<a href="#l11.237"></a><span id="l11.237" class="difflineminus">-              type = &quot;multi-column&quot;;</span>
<a href="#l11.238"></a><span id="l11.238" class="difflineminus">-            this._type = type;</span>
<a href="#l11.239"></a><span id="l11.239" class="difflineminus">-          }</span>
<a href="#l11.240"></a><span id="l11.240" class="difflineminus">-          return this._type;</span>
<a href="#l11.241"></a><span id="l11.241" class="difflineminus">-        ]]&gt;&lt;/getter&gt;</span>
<a href="#l11.242"></a><span id="l11.242" class="difflineminus">-      &lt;/property&gt;</span>
<a href="#l11.243"></a><span id="l11.243" class="difflineminus">-      </span>
<a href="#l11.244"></a><span id="l11.244" class="difflineminus">-      &lt;method name=&quot;getRowResource&quot;&gt;</span>
<a href="#l11.245"></a><span id="l11.245" class="difflineminus">-        &lt;parameter name=&quot;aRow&quot;/&gt;</span>
<a href="#l11.246"></a><span id="l11.246" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l11.247"></a><span id="l11.247" class="difflineminus">-          if (aRow != -1)</span>
<a href="#l11.248"></a><span id="l11.248" class="difflineminus">-            return this.treeBuilder.getResourceAtIndex(aRow);</span>
<a href="#l11.249"></a><span id="l11.249" class="difflineminus">-          else</span>
<a href="#l11.250"></a><span id="l11.250" class="difflineminus">-            return this.getRootResource();</span>
<a href="#l11.251"></a><span id="l11.251" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l11.252"></a><span id="l11.252" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l11.253"></a><span id="l11.253" class="difflineminus">-</span>
<a href="#l11.254"></a><span id="l11.254" class="difflineminus">-      &lt;method name=&quot;getParentResource&quot;&gt;</span>
<a href="#l11.255"></a><span id="l11.255" class="difflineminus">-        &lt;parameter name=&quot;aRow&quot;/&gt;</span>
<a href="#l11.256"></a><span id="l11.256" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l11.257"></a><span id="l11.257" class="difflineminus">-          if (aRow != -1) {</span>
<a href="#l11.258"></a><span id="l11.258" class="difflineminus">-            var parentIndex = this.treeBoxObject.view.getParentIndex(aRow);</span>
<a href="#l11.259"></a><span id="l11.259" class="difflineminus">-            return this.getRowResource(parentIndex);</span>
<a href="#l11.260"></a><span id="l11.260" class="difflineminus">-          }</span>
<a href="#l11.261"></a><span id="l11.261" class="difflineminus">-          return this.getRootResource(); // assume its parent is the root</span>
<a href="#l11.262"></a><span id="l11.262" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l11.263"></a><span id="l11.263" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l11.264"></a><span id="l11.264" class="difflineminus">-</span>
<a href="#l11.265"></a><span id="l11.265" class="difflineminus">-      &lt;method name=&quot;getRootResource&quot;&gt;</span>
<a href="#l11.266"></a><span id="l11.266" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l11.267"></a><span id="l11.267" class="difflineminus">-          var tree = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;bookmarks-tree&quot;);</span>
<a href="#l11.268"></a><span id="l11.268" class="difflineminus">-          var rootURI = tree.ref;</span>
<a href="#l11.269"></a><span id="l11.269" class="difflineminus">-          return RDF.GetResource(rootURI);</span>
<a href="#l11.270"></a><span id="l11.270" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l11.271"></a><span id="l11.271" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l11.272"></a><span id="l11.272" class="difflineminus">-</span>
<a href="#l11.273"></a><span id="l11.273" class="difflineminus">-      &lt;field name=&quot;_selection&quot;&gt;null&lt;/field&gt;</span>
<a href="#l11.274"></a><span id="l11.274" class="difflineminus">-      &lt;field name=&quot;_target&quot;&gt;   null&lt;/field&gt;</span>
<a href="#l11.275"></a><span id="l11.275" class="difflineminus">-</span>
<a href="#l11.276"></a><span id="l11.276" class="difflineminus">-      &lt;method name=&quot;getTreeSelection&quot;&gt;</span>
<a href="#l11.277"></a><span id="l11.277" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l11.278"></a><span id="l11.278" class="difflineminus">-          var selection        = {};</span>
<a href="#l11.279"></a><span id="l11.279" class="difflineminus">-          selection.item       = [];</span>
<a href="#l11.280"></a><span id="l11.280" class="difflineminus">-          selection.parent     = [];</span>
<a href="#l11.281"></a><span id="l11.281" class="difflineminus">-          selection.isExpanded = [];</span>
<a href="#l11.282"></a><span id="l11.282" class="difflineminus">-          var rangeCount = this.treeBoxObject.view.selection.getRangeCount();</span>
<a href="#l11.283"></a><span id="l11.283" class="difflineminus">-          // workaround for bug 171547: if rowCount==0, rangeCount==1</span>
<a href="#l11.284"></a><span id="l11.284" class="difflineminus">-          if (this.treeBuilder.rowCount &gt; 0)</span>
<a href="#l11.285"></a><span id="l11.285" class="difflineminus">-          for (var k = 0; k &lt; rangeCount; ++k) {</span>
<a href="#l11.286"></a><span id="l11.286" class="difflineminus">-            var rangeMin = {};</span>
<a href="#l11.287"></a><span id="l11.287" class="difflineminus">-            var rangeMax = {};</span>
<a href="#l11.288"></a><span id="l11.288" class="difflineminus">-            this.treeBoxObject.view.selection.getRangeAt(k, rangeMin, rangeMax);</span>
<a href="#l11.289"></a><span id="l11.289" class="difflineminus">-            for (var i = rangeMin.value; i &lt;= rangeMax.value; ++i) {</span>
<a href="#l11.290"></a><span id="l11.290" class="difflineminus">-              var selectedItem   = this.getRowResource(i);</span>
<a href="#l11.291"></a><span id="l11.291" class="difflineminus">-              var selectedParent = this.getParentResource(i);</span>
<a href="#l11.292"></a><span id="l11.292" class="difflineminus">-              var isExpanded     = this.treeBoxObject.view.isContainerOpen(i)</span>
<a href="#l11.293"></a><span id="l11.293" class="difflineminus">-              selection.item  .push(selectedItem);</span>
<a href="#l11.294"></a><span id="l11.294" class="difflineminus">-              selection.parent.push(selectedParent);</span>
<a href="#l11.295"></a><span id="l11.295" class="difflineminus">-              selection.isExpanded.push(isExpanded);</span>
<a href="#l11.296"></a><span id="l11.296" class="difflineminus">-            }</span>
<a href="#l11.297"></a><span id="l11.297" class="difflineminus">-          }</span>
<a href="#l11.298"></a><span id="l11.298" class="difflineminus">-          selection.length = selection.item.length;</span>
<a href="#l11.299"></a><span id="l11.299" class="difflineminus">-          BookmarksUtils.checkSelection(selection);</span>
<a href="#l11.300"></a><span id="l11.300" class="difflineminus">-          return selection;</span>
<a href="#l11.301"></a><span id="l11.301" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l11.302"></a><span id="l11.302" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l11.303"></a><span id="l11.303" class="difflineminus">-</span>
<a href="#l11.304"></a><span id="l11.304" class="difflineminus">-      &lt;method name=&quot;getTreeTarget&quot;&gt;</span>
<a href="#l11.305"></a><span id="l11.305" class="difflineminus">-        &lt;parameter name=&quot;aItem&quot;/&gt;</span>
<a href="#l11.306"></a><span id="l11.306" class="difflineminus">-        &lt;parameter name=&quot;aParent&quot;/&gt;</span>
<a href="#l11.307"></a><span id="l11.307" class="difflineminus">-        &lt;parameter name=&quot;aOrientation&quot;/&gt;</span>
<a href="#l11.308"></a><span id="l11.308" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l11.309"></a><span id="l11.309" class="difflineminus">-</span>
<a href="#l11.310"></a><span id="l11.310" class="difflineminus">-          if (!aParent || aParent.Value == &quot;NC:BookmarksTopRoot&quot;)</span>
<a href="#l11.311"></a><span id="l11.311" class="difflineminus">-            return BookmarksUtils.getTargetFromFolder(RDF.GetResource(&quot;NC:BookmarksRoot&quot;))</span>
<a href="#l11.312"></a><span id="l11.312" class="difflineminus">-</span>
<a href="#l11.313"></a><span id="l11.313" class="difflineminus">-          if (aOrientation == BookmarksUtils.DROP_ON)</span>
<a href="#l11.314"></a><span id="l11.314" class="difflineminus">-            return BookmarksUtils.getTargetFromFolder(aItem);</span>
<a href="#l11.315"></a><span id="l11.315" class="difflineminus">-</span>
<a href="#l11.316"></a><span id="l11.316" class="difflineminus">-          RDFC.Init(this.db, aParent);</span>
<a href="#l11.317"></a><span id="l11.317" class="difflineminus">-          var index = RDFC.IndexOf(aItem);</span>
<a href="#l11.318"></a><span id="l11.318" class="difflineminus">-          if (aOrientation == BookmarksUtils.DROP_AFTER)</span>
<a href="#l11.319"></a><span id="l11.319" class="difflineminus">-            ++index;</span>
<a href="#l11.320"></a><span id="l11.320" class="difflineminus">-          return { parent: aParent, index: index };</span>
<a href="#l11.321"></a><span id="l11.321" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l11.322"></a><span id="l11.322" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l11.323"></a><span id="l11.323" class="difflineminus">-</span>
<a href="#l11.324"></a><span id="l11.324" class="difflineminus">-      &lt;!--</span>
<a href="#l11.325"></a><span id="l11.325" class="difflineminus">-        This function saves the current selection state before the tree is</span>
<a href="#l11.326"></a><span id="l11.326" class="difflineminus">-        rebuilt.</span>
<a href="#l11.327"></a><span id="l11.327" class="difflineminus">-      --&gt;</span>
<a href="#l11.328"></a><span id="l11.328" class="difflineminus">-      &lt;field name=&quot;_savedSelection&quot;&gt;[]&lt;/field&gt;</span>
<a href="#l11.329"></a><span id="l11.329" class="difflineminus">-      &lt;method name=&quot;saveSelection&quot;&gt;</span>
<a href="#l11.330"></a><span id="l11.330" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l11.331"></a><span id="l11.331" class="difflineminus">-          this._savedSelection = [];</span>
<a href="#l11.332"></a><span id="l11.332" class="difflineminus">-          var selection = this.treeBoxObject.view.selection;</span>
<a href="#l11.333"></a><span id="l11.333" class="difflineminus">-          if (selection) {</span>
<a href="#l11.334"></a><span id="l11.334" class="difflineminus">-            var rangeCount = selection.getRangeCount();</span>
<a href="#l11.335"></a><span id="l11.335" class="difflineminus">-            var min = {}; var max = {};</span>
<a href="#l11.336"></a><span id="l11.336" class="difflineminus">-            for (var i = 0; i &lt; rangeCount; ++i) {</span>
<a href="#l11.337"></a><span id="l11.337" class="difflineminus">-              selection.getRangeAt(i, min, max);</span>
<a href="#l11.338"></a><span id="l11.338" class="difflineminus">-              for (var j = min.value; j &lt;= max.value; ++j) {</span>
<a href="#l11.339"></a><span id="l11.339" class="difflineminus">-                var resource = this.treeBuilder.getResourceAtIndex(j);</span>
<a href="#l11.340"></a><span id="l11.340" class="difflineminus">-                this._savedSelection.push(resource);</span>
<a href="#l11.341"></a><span id="l11.341" class="difflineminus">-              }</span>
<a href="#l11.342"></a><span id="l11.342" class="difflineminus">-            }</span>
<a href="#l11.343"></a><span id="l11.343" class="difflineminus">-          }</span>
<a href="#l11.344"></a><span id="l11.344" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l11.345"></a><span id="l11.345" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l11.346"></a><span id="l11.346" class="difflineminus">-      </span>
<a href="#l11.347"></a><span id="l11.347" class="difflineminus">-      &lt;!--</span>
<a href="#l11.348"></a><span id="l11.348" class="difflineminus">-        This function restores the selection appropriately after the tree has</span>
<a href="#l11.349"></a><span id="l11.349" class="difflineminus">-        been rebuilt.</span>
<a href="#l11.350"></a><span id="l11.350" class="difflineminus">-      --&gt;</span>
<a href="#l11.351"></a><span id="l11.351" class="difflineminus">-      &lt;method name=&quot;restoreSelection&quot;&gt;</span>
<a href="#l11.352"></a><span id="l11.352" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[ </span>
<a href="#l11.353"></a><span id="l11.353" class="difflineminus">-          var selection = this.treeBoxObject.view.selection;</span>
<a href="#l11.354"></a><span id="l11.354" class="difflineminus">-          if (selection) {</span>
<a href="#l11.355"></a><span id="l11.355" class="difflineminus">-            selection.selectEventsSuppressed = true;</span>
<a href="#l11.356"></a><span id="l11.356" class="difflineminus">-</span>
<a href="#l11.357"></a><span id="l11.357" class="difflineminus">-            selection.clearSelection();</span>
<a href="#l11.358"></a><span id="l11.358" class="difflineminus">-            for (var i = 0; i &lt; this._savedSelection.length; ++i) {</span>
<a href="#l11.359"></a><span id="l11.359" class="difflineminus">-              var index = this.treeBuilder.getIndexOfResource(this._savedSelection[i]);</span>
<a href="#l11.360"></a><span id="l11.360" class="difflineminus">-              if (index &gt;= 0) {</span>
<a href="#l11.361"></a><span id="l11.361" class="difflineminus">-                selection.toggleSelect(index);</span>
<a href="#l11.362"></a><span id="l11.362" class="difflineminus">-              }</span>
<a href="#l11.363"></a><span id="l11.363" class="difflineminus">-            }</span>
<a href="#l11.364"></a><span id="l11.364" class="difflineminus">-</span>
<a href="#l11.365"></a><span id="l11.365" class="difflineminus">-            selection.selectEventsSuppressed = false;</span>
<a href="#l11.366"></a><span id="l11.366" class="difflineminus">-          }</span>
<a href="#l11.367"></a><span id="l11.367" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l11.368"></a><span id="l11.368" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l11.369"></a><span id="l11.369" class="difflineminus">-</span>
<a href="#l11.370"></a><span id="l11.370" class="difflineminus">-      &lt;field name=&quot;_itemToBeToggled&quot;&gt;  []&lt;/field&gt;</span>
<a href="#l11.371"></a><span id="l11.371" class="difflineminus">-      &lt;method name=&quot;preUpdateTreeSelection&quot;&gt;</span>
<a href="#l11.372"></a><span id="l11.372" class="difflineminus">-        &lt;parameter name=&quot;aTxn&quot;/&gt;</span>
<a href="#l11.373"></a><span id="l11.373" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l11.374"></a><span id="l11.374" class="difflineminus">-          // aTxn could be null, or possibly some third-party transaction?</span>
<a href="#l11.375"></a><span id="l11.375" class="difflineminus">-          if (aTxn instanceof Components.interfaces.nsIInterfaceRequestor)</span>
<a href="#l11.376"></a><span id="l11.376" class="difflineminus">-            this._itemToBeToggled.push(aTxn.getInterface(Components.interfaces.nsIRDFNode));</span>
<a href="#l11.377"></a><span id="l11.377" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l11.378"></a><span id="l11.378" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l11.379"></a><span id="l11.379" class="difflineminus">-</span>
<a href="#l11.380"></a><span id="l11.380" class="difflineminus">-      &lt;method name=&quot;updateTreeSelection&quot;&gt;</span>
<a href="#l11.381"></a><span id="l11.381" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l11.382"></a><span id="l11.382" class="difflineminus">-          this.treeBoxObject.view.selection.selectEventsSuppressed = true;</span>
<a href="#l11.383"></a><span id="l11.383" class="difflineminus">-          this.treeBoxObject.view.selection.clearSelection();</span>
<a href="#l11.384"></a><span id="l11.384" class="difflineminus">-          for (var i=0; i&lt;this._itemToBeToggled.length; ++i) {</span>
<a href="#l11.385"></a><span id="l11.385" class="difflineminus">-            var index = this.treeBuilder.getIndexOfResource(this._itemToBeToggled[i]);</span>
<a href="#l11.386"></a><span id="l11.386" class="difflineminus">-            if (index &gt;=0)</span>
<a href="#l11.387"></a><span id="l11.387" class="difflineminus">-              this.treeBoxObject.view.selection.toggleSelect(index);</span>
<a href="#l11.388"></a><span id="l11.388" class="difflineminus">-          }</span>
<a href="#l11.389"></a><span id="l11.389" class="difflineminus">-          this.treeBoxObject.view.selection.selectEventsSuppressed = false;</span>
<a href="#l11.390"></a><span id="l11.390" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l11.391"></a><span id="l11.391" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l11.392"></a><span id="l11.392" class="difflineminus">-</span>
<a href="#l11.393"></a><span id="l11.393" class="difflineminus">-      &lt;method name=&quot;createTreeContextMenu&quot;&gt;</span>
<a href="#l11.394"></a><span id="l11.394" class="difflineminus">-        &lt;parameter name=&quot;aEvent&quot;/&gt;</span>
<a href="#l11.395"></a><span id="l11.395" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l11.396"></a><span id="l11.396" class="difflineminus">-          BookmarksCommand.createContextMenu(aEvent, this._selection);</span>
<a href="#l11.397"></a><span id="l11.397" class="difflineminus">-          this.onCommandUpdate();</span>
<a href="#l11.398"></a><span id="l11.398" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l11.399"></a><span id="l11.399" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l11.400"></a><span id="l11.400" class="difflineminus">-</span>
<a href="#l11.401"></a><span id="l11.401" class="difflineminus">-      &lt;method name=&quot;openItemClick&quot;&gt;</span>
<a href="#l11.402"></a><span id="l11.402" class="difflineminus">-        &lt;parameter name=&quot;aEvent&quot;/&gt;</span>
<a href="#l11.403"></a><span id="l11.403" class="difflineminus">-        &lt;parameter name=&quot;aClickCount&quot;/&gt;</span>
<a href="#l11.404"></a><span id="l11.404" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l11.405"></a><span id="l11.405" class="difflineminus">-          if (aEvent.button == 2 || aEvent.originalTarget.localName != &quot;treechildren&quot;)</span>
<a href="#l11.406"></a><span id="l11.406" class="difflineminus">-            return;</span>
<a href="#l11.407"></a><span id="l11.407" class="difflineminus">-          if (aClickCount != this.clickCount &amp;&amp; aEvent.button != 1)</span>
<a href="#l11.408"></a><span id="l11.408" class="difflineminus">-            return;</span>
<a href="#l11.409"></a><span id="l11.409" class="difflineminus">-</span>
<a href="#l11.410"></a><span id="l11.410" class="difflineminus">-          var row = {};</span>
<a href="#l11.411"></a><span id="l11.411" class="difflineminus">-          var col = {};</span>
<a href="#l11.412"></a><span id="l11.412" class="difflineminus">-          var obj = {};</span>
<a href="#l11.413"></a><span id="l11.413" class="difflineminus">-          this.treeBoxObject.getCellAt(aEvent.clientX, aEvent.clientY, row, col, obj);</span>
<a href="#l11.414"></a><span id="l11.414" class="difflineminus">-          row = row.value;</span>
<a href="#l11.415"></a><span id="l11.415" class="difflineminus">-</span>
<a href="#l11.416"></a><span id="l11.416" class="difflineminus">-          if (row == -1 || obj.value == &quot;twisty&quot;)</span>
<a href="#l11.417"></a><span id="l11.417" class="difflineminus">-            return;</span>
<a href="#l11.418"></a><span id="l11.418" class="difflineminus">-          var modifKey = aEvent.shiftKey || aEvent.ctrlKey || aEvent.altKey || </span>
<a href="#l11.419"></a><span id="l11.419" class="difflineminus">-                         aEvent.metaKey  || aEvent.button == 1;</span>
<a href="#l11.420"></a><span id="l11.420" class="difflineminus">-          if (this.clickCount == 2 &amp;&amp; !modifKey &amp;&amp;</span>
<a href="#l11.421"></a><span id="l11.421" class="difflineminus">-              this.treeBoxObject.view.isContainer(row))</span>
<a href="#l11.422"></a><span id="l11.422" class="difflineminus">-            return;</span>
<a href="#l11.423"></a><span id="l11.423" class="difflineminus">-</span>
<a href="#l11.424"></a><span id="l11.424" class="difflineminus">-          if (this.clickCount == 2 &amp;&amp; modifKey) {</span>
<a href="#l11.425"></a><span id="l11.425" class="difflineminus">-            this.treeBoxObject.view.selection.select(row);</span>
<a href="#l11.426"></a><span id="l11.426" class="difflineminus">-            this._selection = this.getTreeSelection();</span>
<a href="#l11.427"></a><span id="l11.427" class="difflineminus">-          }</span>
<a href="#l11.428"></a><span id="l11.428" class="difflineminus">-          var selection = this._selection;</span>
<a href="#l11.429"></a><span id="l11.429" class="difflineminus">-          </span>
<a href="#l11.430"></a><span id="l11.430" class="difflineminus">-          if (selection.type[0] != &quot;FolderGroup&quot; &amp;&amp; selection.isContainer[0]) {</span>
<a href="#l11.431"></a><span id="l11.431" class="difflineminus">-            if (this.clickCount == 1 &amp;&amp; !modifKey) {</span>
<a href="#l11.432"></a><span id="l11.432" class="difflineminus">-              this.treeBoxObject.view.toggleOpenState(row);</span>
<a href="#l11.433"></a><span id="l11.433" class="difflineminus">-              if (selection.protocol[0] != &quot;file&quot;)</span>
<a href="#l11.434"></a><span id="l11.434" class="difflineminus">-                return;</span>
<a href="#l11.435"></a><span id="l11.435" class="difflineminus">-            }</span>
<a href="#l11.436"></a><span id="l11.436" class="difflineminus">-          }</span>
<a href="#l11.437"></a><span id="l11.437" class="difflineminus">-</span>
<a href="#l11.438"></a><span id="l11.438" class="difflineminus">-          var target = BookmarksUtils.getBrowserTargetFromEvent(aEvent);</span>
<a href="#l11.439"></a><span id="l11.439" class="difflineminus">-          if (target)</span>
<a href="#l11.440"></a><span id="l11.440" class="difflineminus">-            BookmarksCommand.openBookmark(selection, target, this.db, aEvent);</span>
<a href="#l11.441"></a><span id="l11.441" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l11.442"></a><span id="l11.442" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l11.443"></a><span id="l11.443" class="difflineminus">-</span>
<a href="#l11.444"></a><span id="l11.444" class="difflineminus">-      &lt;method name=&quot;openItemKey&quot;&gt;</span>
<a href="#l11.445"></a><span id="l11.445" class="difflineminus">-        &lt;parameter name=&quot;aEvent&quot;/&gt;</span>
<a href="#l11.446"></a><span id="l11.446" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l11.447"></a><span id="l11.447" class="difflineminus">-          if (this._selection.length != 1)</span>
<a href="#l11.448"></a><span id="l11.448" class="difflineminus">-            return;</span>
<a href="#l11.449"></a><span id="l11.449" class="difflineminus">-          if (!this._selection.isContainer[0]) {</span>
<a href="#l11.450"></a><span id="l11.450" class="difflineminus">-            var target = BookmarksUtils.getBrowserTargetFromEvent(aEvent);</span>
<a href="#l11.451"></a><span id="l11.451" class="difflineminus">-            if (target)</span>
<a href="#l11.452"></a><span id="l11.452" class="difflineminus">-              BookmarksCommand.openBookmark(this._selection, target, this.db, aEvent)</span>
<a href="#l11.453"></a><span id="l11.453" class="difflineminus">-          }</span>
<a href="#l11.454"></a><span id="l11.454" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l11.455"></a><span id="l11.455" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l11.456"></a><span id="l11.456" class="difflineminus">-</span>
<a href="#l11.457"></a><span id="l11.457" class="difflineminus">-      &lt;method name=&quot;searchBookmarks&quot;&gt;</span>
<a href="#l11.458"></a><span id="l11.458" class="difflineminus">-      &lt;parameter name=&quot;aInput&quot;/&gt;</span>
<a href="#l11.459"></a><span id="l11.459" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l11.460"></a><span id="l11.460" class="difflineminus">-          this.treeBoxObject.view.selection.currentIndex=-1;</span>
<a href="#l11.461"></a><span id="l11.461" class="difflineminus">-          if (!aInput) {</span>
<a href="#l11.462"></a><span id="l11.462" class="difflineminus">-            this.tree.setAttribute(&quot;ref&quot;, this.originalRef);</span>
<a href="#l11.463"></a><span id="l11.463" class="difflineminus">-          }</span>
<a href="#l11.464"></a><span id="l11.464" class="difflineminus">-          else {</span>
<a href="#l11.465"></a><span id="l11.465" class="difflineminus">-            if (!this.originalRef) {</span>
<a href="#l11.466"></a><span id="l11.466" class="difflineminus">-              this.originalRef = this.tree.getAttribute(&quot;ref&quot;);</span>
<a href="#l11.467"></a><span id="l11.467" class="difflineminus">-            }</span>
<a href="#l11.468"></a><span id="l11.468" class="difflineminus">-            this.tree.setAttribute(&quot;ref&quot;,</span>
<a href="#l11.469"></a><span id="l11.469" class="difflineminus">-                                   &quot;find:datasource=rdf:bookmarks&amp;match=http://home.netscape.com/NC-rdf#Name&amp;method=contains&amp;text=&quot; + encodeURIComponent(aInput));</span>
<a href="#l11.470"></a><span id="l11.470" class="difflineminus">-          }</span>
<a href="#l11.471"></a><span id="l11.471" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l11.472"></a><span id="l11.472" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l11.473"></a><span id="l11.473" class="difflineminus">-</span>
<a href="#l11.474"></a><span id="l11.474" class="difflineminus">-      &lt;!-- observer --&gt;</span>
<a href="#l11.475"></a><span id="l11.475" class="difflineminus">-      &lt;field name=&quot;DNDObserver&quot; readonly=&quot;true&quot;&gt;&lt;![CDATA[</span>
<a href="#l11.476"></a><span id="l11.476" class="difflineminus">-      ({</span>
<a href="#l11.477"></a><span id="l11.477" class="difflineminus">-        mOuter: this,</span>
<a href="#l11.478"></a><span id="l11.478" class="difflineminus">-        onDragStart: function (aEvent, aXferData, aDragAction)</span>
<a href="#l11.479"></a><span id="l11.479" class="difflineminus">-        {</span>
<a href="#l11.480"></a><span id="l11.480" class="difflineminus">-          var selection = this.mOuter._selection;</span>
<a href="#l11.481"></a><span id="l11.481" class="difflineminus">-          aXferData.data = BookmarksUtils.getXferDataFromSelection(selection);</span>
<a href="#l11.482"></a><span id="l11.482" class="difflineminus">-          const kDSIID = Components.interfaces.nsIDragService;</span>
<a href="#l11.483"></a><span id="l11.483" class="difflineminus">-          if (aEvent.ctrlKey)</span>
<a href="#l11.484"></a><span id="l11.484" class="difflineminus">-            aDragAction.action = kDSIID.DRAGDROP_ACTION_COPY;</span>
<a href="#l11.485"></a><span id="l11.485" class="difflineminus">-        }</span>
<a href="#l11.486"></a><span id="l11.486" class="difflineminus">-      })</span>
<a href="#l11.487"></a><span id="l11.487" class="difflineminus">-      ]]&gt;&lt;/field&gt;      </span>
<a href="#l11.488"></a><span id="l11.488" class="difflineminus">-        </span>
<a href="#l11.489"></a><span id="l11.489" class="difflineminus">-      &lt;!-- nsIController --&gt;</span>
<a href="#l11.490"></a><span id="l11.490" class="difflineminus">-      &lt;field name=&quot;controller&quot; readonly=&quot;true&quot;&gt;&lt;![CDATA[</span>
<a href="#l11.491"></a><span id="l11.491" class="difflineminus">-      ({</span>
<a href="#l11.492"></a><span id="l11.492" class="difflineminus">-        mOuter: this,</span>
<a href="#l11.493"></a><span id="l11.493" class="difflineminus">-        </span>
<a href="#l11.494"></a><span id="l11.494" class="difflineminus">-        supportsCommand: BookmarksController.supportsCommand,</span>
<a href="#l11.495"></a><span id="l11.495" class="difflineminus">-        </span>
<a href="#l11.496"></a><span id="l11.496" class="difflineminus">-        isCommandEnabled: function (aCommand)</span>
<a href="#l11.497"></a><span id="l11.497" class="difflineminus">-        {</span>
<a href="#l11.498"></a><span id="l11.498" class="difflineminus">-          // warning: this is not the called function in BookmarksController.onCommandUpdate</span>
<a href="#l11.499"></a><span id="l11.499" class="difflineminus">-          return BookmarksController.isCommandEnabled(aCommand,</span>
<a href="#l11.500"></a><span id="l11.500" class="difflineminus">-                                                      this.mOuter._selection,</span>
<a href="#l11.501"></a><span id="l11.501" class="difflineminus">-                                                      this.mOuter._target);</span>
<a href="#l11.502"></a><span id="l11.502" class="difflineminus">-        },</span>
<a href="#l11.503"></a><span id="l11.503" class="difflineminus">-</span>
<a href="#l11.504"></a><span id="l11.504" class="difflineminus">-        doCommand: function (aCommand)</span>
<a href="#l11.505"></a><span id="l11.505" class="difflineminus">-        {</span>
<a href="#l11.506"></a><span id="l11.506" class="difflineminus">-          var selection = this.mOuter._selection;</span>
<a href="#l11.507"></a><span id="l11.507" class="difflineminus">-          var target    = this.mOuter._target;</span>
<a href="#l11.508"></a><span id="l11.508" class="difflineminus">-          switch (aCommand) {</span>
<a href="#l11.509"></a><span id="l11.509" class="difflineminus">-            // Commands that insert rows</span>
<a href="#l11.510"></a><span id="l11.510" class="difflineminus">-            case &quot;cmd_bm_newfolder&quot;:</span>
<a href="#l11.511"></a><span id="l11.511" class="difflineminus">-            case &quot;cmd_bm_newbookmark&quot;:</span>
<a href="#l11.512"></a><span id="l11.512" class="difflineminus">-            case &quot;cmd_bm_newseparator&quot;:</span>
<a href="#l11.513"></a><span id="l11.513" class="difflineminus">-            case &quot;cmd_bm_import&quot;:</span>
<a href="#l11.514"></a><span id="l11.514" class="difflineminus">-            case &quot;cmd_bm_movebookmark&quot;:</span>
<a href="#l11.515"></a><span id="l11.515" class="difflineminus">-            case &quot;cmd_bm_paste&quot;:</span>
<a href="#l11.516"></a><span id="l11.516" class="difflineminus">-            // XXXvarga undo/redo can insert or remove rows.</span>
<a href="#l11.517"></a><span id="l11.517" class="difflineminus">-            case &quot;cmd_undo&quot;:</span>
<a href="#l11.518"></a><span id="l11.518" class="difflineminus">-            case &quot;cmd_redo&quot;:</span>
<a href="#l11.519"></a><span id="l11.519" class="difflineminus">-              // All items inserted will be selected. The implementation of</span>
<a href="#l11.520"></a><span id="l11.520" class="difflineminus">-              // this model is left to |preUpdateTreeSelection|, called when</span>
<a href="#l11.521"></a><span id="l11.521" class="difflineminus">-              // an insert transaction is executed, and |updateTreeSelection|</span>
<a href="#l11.522"></a><span id="l11.522" class="difflineminus">-              // called here. </span>
<a href="#l11.523"></a><span id="l11.523" class="difflineminus">-              BookmarksController.doCommand(aCommand, selection, target);</span>
<a href="#l11.524"></a><span id="l11.524" class="difflineminus">-              this.mOuter.updateTreeSelection();</span>
<a href="#l11.525"></a><span id="l11.525" class="difflineminus">-              break;</span>
<a href="#l11.526"></a><span id="l11.526" class="difflineminus">-            // Commands that remove rows</span>
<a href="#l11.527"></a><span id="l11.527" class="difflineminus">-            case &quot;cmd_bm_cut&quot;:</span>
<a href="#l11.528"></a><span id="l11.528" class="difflineminus">-            case &quot;cmd_bm_delete&quot;:</span>
<a href="#l11.529"></a><span id="l11.529" class="difflineminus">-              // Since rows have been removed, the row immediately after the</span>
<a href="#l11.530"></a><span id="l11.530" class="difflineminus">-              // first range in the original selection now has the index of</span>
<a href="#l11.531"></a><span id="l11.531" class="difflineminus">-              // the first item in the first range.</span>
<a href="#l11.532"></a><span id="l11.532" class="difflineminus">-              var s = this.mOuter.treeBoxObject.view.selection;</span>
<a href="#l11.533"></a><span id="l11.533" class="difflineminus">-              rangeMin = {};</span>
<a href="#l11.534"></a><span id="l11.534" class="difflineminus">-              rangeMax = {};</span>
<a href="#l11.535"></a><span id="l11.535" class="difflineminus">-              s.getRangeAt(0, rangeMin, rangeMax);</span>
<a href="#l11.536"></a><span id="l11.536" class="difflineminus">-              BookmarksController.doCommand(aCommand, selection, target);</span>
<a href="#l11.537"></a><span id="l11.537" class="difflineminus">-              // Select the next remaining row if there is one,</span>
<a href="#l11.538"></a><span id="l11.538" class="difflineminus">-              // or the previous row, even &quot;Bookmarks for &lt;profile name&gt;&quot;(= 0)</span>
<a href="#l11.539"></a><span id="l11.539" class="difflineminus">-              // if no other row remains.</span>
<a href="#l11.540"></a><span id="l11.540" class="difflineminus">-              s.select((rangeMin.value &gt;= this.mOuter.treeBuilder.rowCount)</span>
<a href="#l11.541"></a><span id="l11.541" class="difflineminus">-                       ? this.mOuter.treeBuilder.rowCount - 1</span>
<a href="#l11.542"></a><span id="l11.542" class="difflineminus">-                       : rangeMin.value);</span>
<a href="#l11.543"></a><span id="l11.543" class="difflineminus">-              break;</span>
<a href="#l11.544"></a><span id="l11.544" class="difflineminus">-            case &quot;cmd_bm_expandfolder&quot;:</span>
<a href="#l11.545"></a><span id="l11.545" class="difflineminus">-              this.mOuter.treeBoxObject.view.toggleOpenState(this.mOuter.currentIndex);</span>
<a href="#l11.546"></a><span id="l11.546" class="difflineminus">-              break;</span>
<a href="#l11.547"></a><span id="l11.547" class="difflineminus">-            case &quot;cmd_bm_selectAll&quot;:</span>
<a href="#l11.548"></a><span id="l11.548" class="difflineminus">-              this.mOuter.treeBoxObject.view.selection.selectAll();</span>
<a href="#l11.549"></a><span id="l11.549" class="difflineminus">-              break;</span>
<a href="#l11.550"></a><span id="l11.550" class="difflineminus">-            default:</span>
<a href="#l11.551"></a><span id="l11.551" class="difflineminus">-              BookmarksController.doCommand(aCommand, selection, target);</span>
<a href="#l11.552"></a><span id="l11.552" class="difflineminus">-          }</span>
<a href="#l11.553"></a><span id="l11.553" class="difflineminus">-        }</span>
<a href="#l11.554"></a><span id="l11.554" class="difflineminus">-      })</span>
<a href="#l11.555"></a><span id="l11.555" class="difflineminus">-      ]]&gt;&lt;/field&gt;</span>
<a href="#l11.556"></a><span id="l11.556" class="difflineminus">-</span>
<a href="#l11.557"></a><span id="l11.557" class="difflineminus">-      &lt;method name=&quot;onCommandUpdate&quot;&gt;</span>
<a href="#l11.558"></a><span id="l11.558" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l11.559"></a><span id="l11.559" class="difflineminus">-          BookmarksController.onCommandUpdate(this._selection, this._target);</span>
<a href="#l11.560"></a><span id="l11.560" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l11.561"></a><span id="l11.561" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l11.562"></a><span id="l11.562" class="difflineminus">-</span>
<a href="#l11.563"></a><span id="l11.563" class="difflineminus">-      &lt;method name=&quot;selectionChanged&quot;&gt;</span>
<a href="#l11.564"></a><span id="l11.564" class="difflineminus">-        &lt;parameter name=&quot;aEvent&quot;/&gt;</span>
<a href="#l11.565"></a><span id="l11.565" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l11.566"></a><span id="l11.566" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l11.567"></a><span id="l11.567" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l11.568"></a><span id="l11.568" class="difflineminus">-</span>
<a href="#l11.569"></a><span id="l11.569" class="difflineminus">-      &lt;!-- nsIXULTreeBuilderObserver --&gt;</span>
<a href="#l11.570"></a><span id="l11.570" class="difflineminus">-      &lt;field name=&quot;builderObserver&quot;&gt;&lt;![CDATA[</span>
<a href="#l11.571"></a><span id="l11.571" class="difflineminus">-      ({</span>
<a href="#l11.572"></a><span id="l11.572" class="difflineminus">-        mOuter: this,</span>
<a href="#l11.573"></a><span id="l11.573" class="difflineminus">-        canDrop: function(index, orientation)</span>
<a href="#l11.574"></a><span id="l11.574" class="difflineminus">-        {</span>
<a href="#l11.575"></a><span id="l11.575" class="difflineminus">-          var dragSession = DS &amp;&amp; DS.getCurrentSession();</span>
<a href="#l11.576"></a><span id="l11.576" class="difflineminus">-          if (!dragSession)</span>
<a href="#l11.577"></a><span id="l11.577" class="difflineminus">-            return false;</span>
<a href="#l11.578"></a><span id="l11.578" class="difflineminus">-          var selection = BookmarksUtils.getSelectionFromXferData(dragSession);</span>
<a href="#l11.579"></a><span id="l11.579" class="difflineminus">-          if (selection.containsRF)</span>
<a href="#l11.580"></a><span id="l11.580" class="difflineminus">-            return false;</span>
<a href="#l11.581"></a><span id="l11.581" class="difflineminus">-          if (orientation == BookmarksUtils.DROP_ON)</span>
<a href="#l11.582"></a><span id="l11.582" class="difflineminus">-            return true;</span>
<a href="#l11.583"></a><span id="l11.583" class="difflineminus">-</span>
<a href="#l11.584"></a><span id="l11.584" class="difflineminus">-          if (index != 0)</span>
<a href="#l11.585"></a><span id="l11.585" class="difflineminus">-            return true;</span>
<a href="#l11.586"></a><span id="l11.586" class="difflineminus">-          if (this.mOuter.getRowResource(index).Value != &quot;NC:BookmarksRoot&quot;)</span>
<a href="#l11.587"></a><span id="l11.587" class="difflineminus">-            return true;</span>
<a href="#l11.588"></a><span id="l11.588" class="difflineminus">-          return orientation == BookmarksUtils.DROP_BEFORE ? false : this.mOuter.treeBoxObject.view.isContainerOpen(0)</span>
<a href="#l11.589"></a><span id="l11.589" class="difflineminus">-        },</span>
<a href="#l11.590"></a><span id="l11.590" class="difflineminus">-        onDrop: function(row, orientation)</span>
<a href="#l11.591"></a><span id="l11.591" class="difflineminus">-        {  </span>
<a href="#l11.592"></a><span id="l11.592" class="difflineminus">-          var dragSession = DS &amp;&amp; DS.getCurrentSession();</span>
<a href="#l11.593"></a><span id="l11.593" class="difflineminus">-          if (!dragSession)</span>
<a href="#l11.594"></a><span id="l11.594" class="difflineminus">-            return;</span>
<a href="#l11.595"></a><span id="l11.595" class="difflineminus">-          var selection = BookmarksUtils.getSelectionFromXferData(dragSession);</span>
<a href="#l11.596"></a><span id="l11.596" class="difflineminus">-          var rItem     = this.mOuter.getRowResource(row);</span>
<a href="#l11.597"></a><span id="l11.597" class="difflineminus">-          var rParent   = this.mOuter.getParentResource(row);</span>
<a href="#l11.598"></a><span id="l11.598" class="difflineminus">-          var target;</span>
<a href="#l11.599"></a><span id="l11.599" class="difflineminus">-          if (orientation == BookmarksUtils.DROP_AFTER            &amp;&amp;</span>
<a href="#l11.600"></a><span id="l11.600" class="difflineminus">-              this.mOuter.treeBoxObject.view.isContainer(row)     &amp;&amp;</span>
<a href="#l11.601"></a><span id="l11.601" class="difflineminus">-              this.mOuter.treeBoxObject.view.isContainerOpen(row) &amp;&amp;</span>
<a href="#l11.602"></a><span id="l11.602" class="difflineminus">-             !this.mOuter.treeBoxObject.view.isContainerEmpty(row))</span>
<a href="#l11.603"></a><span id="l11.603" class="difflineminus">-            target = { parent: rItem, index: 1 };</span>
<a href="#l11.604"></a><span id="l11.604" class="difflineminus">-          else {</span>
<a href="#l11.605"></a><span id="l11.605" class="difflineminus">-            target = this.mOuter.getTreeTarget(rItem, rParent, orientation);</span>
<a href="#l11.606"></a><span id="l11.606" class="difflineminus">-          }</span>
<a href="#l11.607"></a><span id="l11.607" class="difflineminus">-          const kDSIID = Components.interfaces.nsIDragService;</span>
<a href="#l11.608"></a><span id="l11.608" class="difflineminus">-          const kCopyAction = kDSIID.DRAGDROP_ACTION_COPY + kDSIID.DRAGDROP_ACTION_LINK;</span>
<a href="#l11.609"></a><span id="l11.609" class="difflineminus">-          if (dragSession.dragAction &amp; kCopyAction)</span>
<a href="#l11.610"></a><span id="l11.610" class="difflineminus">-            BookmarksUtils.insertSelection(&quot;drag&quot;, selection, target);</span>
<a href="#l11.611"></a><span id="l11.611" class="difflineminus">-          else</span>
<a href="#l11.612"></a><span id="l11.612" class="difflineminus">-            BookmarksUtils.moveSelection  (&quot;drag&quot;, selection, target);</span>
<a href="#l11.613"></a><span id="l11.613" class="difflineminus">-        },</span>
<a href="#l11.614"></a><span id="l11.614" class="difflineminus">-</span>
<a href="#l11.615"></a><span id="l11.615" class="difflineminus">-        onToggleOpenState: function (aRow)</span>
<a href="#l11.616"></a><span id="l11.616" class="difflineminus">-        {</span>
<a href="#l11.617"></a><span id="l11.617" class="difflineminus">-          // update the open attribute of the selection</span>
<a href="#l11.618"></a><span id="l11.618" class="difflineminus">-          var resource = this.mOuter.getRowResource(aRow);</span>
<a href="#l11.619"></a><span id="l11.619" class="difflineminus">-          var selection = this.mOuter._selection;</span>
<a href="#l11.620"></a><span id="l11.620" class="difflineminus">-          for (var i=0; i&lt;selection.length; ++i) {</span>
<a href="#l11.621"></a><span id="l11.621" class="difflineminus">-            if (selection.item[i] == resource) {</span>
<a href="#l11.622"></a><span id="l11.622" class="difflineminus">-              selection.isExpanded[i] = !selection.isExpanded[i];</span>
<a href="#l11.623"></a><span id="l11.623" class="difflineminus">-              break;</span>
<a href="#l11.624"></a><span id="l11.624" class="difflineminus">-            }</span>
<a href="#l11.625"></a><span id="l11.625" class="difflineminus">-          }</span>
<a href="#l11.626"></a><span id="l11.626" class="difflineminus">-        },</span>
<a href="#l11.627"></a><span id="l11.627" class="difflineminus">-        </span>
<a href="#l11.628"></a><span id="l11.628" class="difflineminus">-        onCycleHeader: function (aColumnID, aHeaderElement) {},</span>
<a href="#l11.629"></a><span id="l11.629" class="difflineminus">-    </span>
<a href="#l11.630"></a><span id="l11.630" class="difflineminus">-        onSelectionChanged: function ()</span>
<a href="#l11.631"></a><span id="l11.631" class="difflineminus">-        {</span>
<a href="#l11.632"></a><span id="l11.632" class="difflineminus">-          var selection = this.mOuter.getTreeSelection();</span>
<a href="#l11.633"></a><span id="l11.633" class="difflineminus">-          this.mOuter._selection = selection;</span>
<a href="#l11.634"></a><span id="l11.634" class="difflineminus">-          var selectionLength = selection.length;</span>
<a href="#l11.635"></a><span id="l11.635" class="difflineminus">-          if (!selectionLength)</span>
<a href="#l11.636"></a><span id="l11.636" class="difflineminus">-            this.mOuter._target = null;</span>
<a href="#l11.637"></a><span id="l11.637" class="difflineminus">-          else {</span>
<a href="#l11.638"></a><span id="l11.638" class="difflineminus">-            // Paste or create items into an expanded folder, otherwise after the selected item.</span>
<a href="#l11.639"></a><span id="l11.639" class="difflineminus">-            var orient = selection.isExpanded[0] ? BookmarksUtils.DROP_ON : BookmarksUtils.DROP_AFTER;</span>
<a href="#l11.640"></a><span id="l11.640" class="difflineminus">-            this.mOuter._target = this.mOuter.getTreeTarget(selection.item[0], selection.parent[0], orient);</span>
<a href="#l11.641"></a><span id="l11.641" class="difflineminus">-          }</span>
<a href="#l11.642"></a><span id="l11.642" class="difflineminus">-          /* XXX Work around bug 519049</span>
<a href="#l11.643"></a><span id="l11.643" class="difflineminus">-          this.mOuter.onCommandUpdate();</span>
<a href="#l11.644"></a><span id="l11.644" class="difflineminus">-          */</span>
<a href="#l11.645"></a><span id="l11.645" class="difflineminus">-          setTimeout(function(aOuter) { aOuter.onCommandUpdate(); }, 0, this.mOuter);</span>
<a href="#l11.646"></a><span id="l11.646" class="difflineminus">-          const kStatusBar = document.getAnonymousElementByAttribute(this.mOuter, &quot;anonid&quot;, &quot;statusbar-text&quot;);</span>
<a href="#l11.647"></a><span id="l11.647" class="difflineminus">-          var displayValue;</span>
<a href="#l11.648"></a><span id="l11.648" class="difflineminus">-          if (kStatusBar &amp;&amp; selectionLength == 1) {</span>
<a href="#l11.649"></a><span id="l11.649" class="difflineminus">-            var protocol = selection.protocol[0];</span>
<a href="#l11.650"></a><span id="l11.650" class="difflineminus">-            if (selection.isContainer[0] &amp;&amp; protocol != &quot;find&quot; &amp;&amp; protocol != &quot;file&quot;) {</span>
<a href="#l11.651"></a><span id="l11.651" class="difflineminus">-              RDFC.Init(this.mOuter.db, selection.item[0]);</span>
<a href="#l11.652"></a><span id="l11.652" class="difflineminus">-              var count = RDFC.GetCount();</span>
<a href="#l11.653"></a><span id="l11.653" class="difflineminus">-              displayValue = BookmarksUtils.getLocaleString(&quot;status_foldercount&quot;, String(count));</span>
<a href="#l11.654"></a><span id="l11.654" class="difflineminus">-            }</span>
<a href="#l11.655"></a><span id="l11.655" class="difflineminus">-            else if (selection.type[0] == &quot;Bookmark&quot;)</span>
<a href="#l11.656"></a><span id="l11.656" class="difflineminus">-              displayValue = BookmarksUtils.getProperty(selection.item[0], NC_NS+&quot;URL&quot;, this.mOuter.db)</span>
<a href="#l11.657"></a><span id="l11.657" class="difflineminus">-            else</span>
<a href="#l11.658"></a><span id="l11.658" class="difflineminus">-              displayValue = &quot;&quot;;</span>
<a href="#l11.659"></a><span id="l11.659" class="difflineminus">-            kStatusBar.label = displayValue;</span>
<a href="#l11.660"></a><span id="l11.660" class="difflineminus">-          }</span>
<a href="#l11.661"></a><span id="l11.661" class="difflineminus">-        },</span>
<a href="#l11.662"></a><span id="l11.662" class="difflineminus">-        </span>
<a href="#l11.663"></a><span id="l11.663" class="difflineminus">-        onCycleCell          : function (aItemIndex, aColumnID)          {},</span>
<a href="#l11.664"></a><span id="l11.664" class="difflineminus">-        onPerformAction      : function (aAction)                        {},</span>
<a href="#l11.665"></a><span id="l11.665" class="difflineminus">-        onPerformActionOnRow : function (aAction, aItemIndex)            {},</span>
<a href="#l11.666"></a><span id="l11.666" class="difflineminus">-        onPerformActionOnCell: function (aAction, aItemIndex, aColumnID) {}</span>
<a href="#l11.667"></a><span id="l11.667" class="difflineminus">-</span>
<a href="#l11.668"></a><span id="l11.668" class="difflineminus">-      })</span>
<a href="#l11.669"></a><span id="l11.669" class="difflineminus">-      ]]&gt;&lt;/field&gt;</span>
<a href="#l11.670"></a><span id="l11.670" class="difflineminus">-</span>
<a href="#l11.671"></a><span id="l11.671" class="difflineminus">-      &lt;!-- nsIXULBuilderListener --&gt;</span>
<a href="#l11.672"></a><span id="l11.672" class="difflineminus">-      &lt;field name=&quot;builderListener&quot;&gt;&lt;![CDATA[</span>
<a href="#l11.673"></a><span id="l11.673" class="difflineminus">-      ({</span>
<a href="#l11.674"></a><span id="l11.674" class="difflineminus">-        mOuter: this,</span>
<a href="#l11.675"></a><span id="l11.675" class="difflineminus">-</span>
<a href="#l11.676"></a><span id="l11.676" class="difflineminus">-        willRebuild: function(aBuilder) {</span>
<a href="#l11.677"></a><span id="l11.677" class="difflineminus">-          this.mOuter.saveSelection();</span>
<a href="#l11.678"></a><span id="l11.678" class="difflineminus">-        },</span>
<a href="#l11.679"></a><span id="l11.679" class="difflineminus">-</span>
<a href="#l11.680"></a><span id="l11.680" class="difflineminus">-        didRebuild: function(aBuilder) {</span>
<a href="#l11.681"></a><span id="l11.681" class="difflineminus">-          this.mOuter.restoreSelection();</span>
<a href="#l11.682"></a><span id="l11.682" class="difflineminus">-        }</span>
<a href="#l11.683"></a><span id="l11.683" class="difflineminus">-      })</span>
<a href="#l11.684"></a><span id="l11.684" class="difflineminus">-      ]]&gt;&lt;/field&gt;</span>
<a href="#l11.685"></a><span id="l11.685" class="difflineminus">-</span>
<a href="#l11.686"></a><span id="l11.686" class="difflineminus">-      &lt;!-- nsITransactionManager listener --&gt;</span>
<a href="#l11.687"></a><span id="l11.687" class="difflineminus">-      &lt;field name=&quot;transactionListener&quot;&gt;&lt;![CDATA[</span>
<a href="#l11.688"></a><span id="l11.688" class="difflineminus">-      ({</span>
<a href="#l11.689"></a><span id="l11.689" class="difflineminus">-</span>
<a href="#l11.690"></a><span id="l11.690" class="difflineminus">-        mOuter: this,</span>
<a href="#l11.691"></a><span id="l11.691" class="difflineminus">-</span>
<a href="#l11.692"></a><span id="l11.692" class="difflineminus">-        willDo: function (aTxmgr, aTxn) {</span>
<a href="#l11.693"></a><span id="l11.693" class="difflineminus">-          this.mOuter._itemToBeToggled   = [];</span>
<a href="#l11.694"></a><span id="l11.694" class="difflineminus">-        },</span>
<a href="#l11.695"></a><span id="l11.695" class="difflineminus">-</span>
<a href="#l11.696"></a><span id="l11.696" class="difflineminus">-        didDo: function (aTxmgr, aTxn) {</span>
<a href="#l11.697"></a><span id="l11.697" class="difflineminus">-          this.mOuter.preUpdateTreeSelection(aTxn);</span>
<a href="#l11.698"></a><span id="l11.698" class="difflineminus">-        },</span>
<a href="#l11.699"></a><span id="l11.699" class="difflineminus">-</span>
<a href="#l11.700"></a><span id="l11.700" class="difflineminus">-        willUndo: function (aTxmgr, aTxn) {</span>
<a href="#l11.701"></a><span id="l11.701" class="difflineminus">-          this.mOuter._itemToBeToggled   = [];</span>
<a href="#l11.702"></a><span id="l11.702" class="difflineminus">-        },</span>
<a href="#l11.703"></a><span id="l11.703" class="difflineminus">-</span>
<a href="#l11.704"></a><span id="l11.704" class="difflineminus">-        didUndo: function (aTxmgr, aTxn) {</span>
<a href="#l11.705"></a><span id="l11.705" class="difflineminus">-          this.mOuter.preUpdateTreeSelection(aTxn);</span>
<a href="#l11.706"></a><span id="l11.706" class="difflineminus">-        },</span>
<a href="#l11.707"></a><span id="l11.707" class="difflineminus">-</span>
<a href="#l11.708"></a><span id="l11.708" class="difflineminus">-        willRedo: function (aTxmgr, aTxn) {</span>
<a href="#l11.709"></a><span id="l11.709" class="difflineminus">-          this.mOuter._itemToBeToggled   = [];</span>
<a href="#l11.710"></a><span id="l11.710" class="difflineminus">-        },</span>
<a href="#l11.711"></a><span id="l11.711" class="difflineminus">-</span>
<a href="#l11.712"></a><span id="l11.712" class="difflineminus">-        didRedo: function (aTxmgr, aTxn) {</span>
<a href="#l11.713"></a><span id="l11.713" class="difflineminus">-          this.mOuter.preUpdateTreeSelection(aTxn);</span>
<a href="#l11.714"></a><span id="l11.714" class="difflineminus">-        },</span>
<a href="#l11.715"></a><span id="l11.715" class="difflineminus">-</span>
<a href="#l11.716"></a><span id="l11.716" class="difflineminus">-        didMerge       : function (aTxmgr, aTxn) {},</span>
<a href="#l11.717"></a><span id="l11.717" class="difflineminus">-        didBeginBatch  : function (aTxmgr, aTxn) {},</span>
<a href="#l11.718"></a><span id="l11.718" class="difflineminus">-        didEndBatch    : function (aTxmgr, aTxn) {},</span>
<a href="#l11.719"></a><span id="l11.719" class="difflineminus">-        willMerge      : function (aTxmgr, aTxn) {},</span>
<a href="#l11.720"></a><span id="l11.720" class="difflineminus">-        willBeginBatch : function (aTxmgr, aTxn) {},</span>
<a href="#l11.721"></a><span id="l11.721" class="difflineminus">-        willEndBatch   : function (aTxmgr, aTxn) {}</span>
<a href="#l11.722"></a><span id="l11.722" class="difflineminus">-      })</span>
<a href="#l11.723"></a><span id="l11.723" class="difflineminus">-      ]]&gt;&lt;/field&gt;</span>
<a href="#l11.724"></a><span id="l11.724" class="difflineminus">-</span>
<a href="#l11.725"></a><span id="l11.725" class="difflineminus">-      &lt;!-- observer --&gt;</span>
<a href="#l11.726"></a><span id="l11.726" class="difflineminus">-      &lt;field name=&quot;bookmarksChangedObserver&quot;&gt;&lt;![CDATA[</span>
<a href="#l11.727"></a><span id="l11.727" class="difflineminus">-      ({</span>
<a href="#l11.728"></a><span id="l11.728" class="difflineminus">-        mOuter: this,</span>
<a href="#l11.729"></a><span id="l11.729" class="difflineminus">-        observe: function (aSubject, aTopic, aData)</span>
<a href="#l11.730"></a><span id="l11.730" class="difflineminus">-        {</span>
<a href="#l11.731"></a><span id="l11.731" class="difflineminus">-          if (aTopic == &quot;bookmarks-changed&quot;) {</span>
<a href="#l11.732"></a><span id="l11.732" class="difflineminus">-            var aRef = this.mOuter.tree.getAttribute(&quot;ref&quot;);</span>
<a href="#l11.733"></a><span id="l11.733" class="difflineminus">-            var aProtocol = aRef.split(&quot;:&quot;)[0];</span>
<a href="#l11.734"></a><span id="l11.734" class="difflineminus">-            if (aProtocol == &quot;find&quot;)</span>
<a href="#l11.735"></a><span id="l11.735" class="difflineminus">-              this.mOuter.tree.builder.rebuild();</span>
<a href="#l11.736"></a><span id="l11.736" class="difflineminus">-          }</span>
<a href="#l11.737"></a><span id="l11.737" class="difflineminus">-        }</span>
<a href="#l11.738"></a><span id="l11.738" class="difflineminus">-      })</span>
<a href="#l11.739"></a><span id="l11.739" class="difflineminus">-      ]]&gt;&lt;/field&gt;</span>
<a href="#l11.740"></a><span id="l11.740" class="difflineminus">-    &lt;/implementation&gt;</span>
<a href="#l11.741"></a><span id="l11.741" class="difflineminus">-  &lt;/binding&gt;</span>
<a href="#l11.742"></a><span id="l11.742" class="difflineminus">-</span>
<a href="#l11.743"></a><span id="l11.743" class="difflineminus">-  &lt;!-- Full Bookmarks Tree, multi-columned --&gt;</span>
<a href="#l11.744"></a><span id="l11.744" class="difflineminus">-  &lt;!-- Localize column labels! --&gt;</span>
<a href="#l11.745"></a><span id="l11.745" class="difflineminus">-  &lt;binding id=&quot;bookmarks-tree-full&quot; extends=&quot;chrome://communicator/content/bookmarks/bookmarksTree.xml#bookmarks-tree&quot;&gt;</span>
<a href="#l11.746"></a><span id="l11.746" class="difflineminus">-    &lt;xbl:content xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot; xmlns:xbl=&quot;http://www.mozilla.org/xbl&quot;</span>
<a href="#l11.747"></a><span id="l11.747" class="difflineminus">-                 contextmenu=&quot;_child&quot;&gt;</span>
<a href="#l11.748"></a><span id="l11.748" class="difflineminus">-      &lt;!-- XXXben need focus event handler for cmd update --&gt;</span>
<a href="#l11.749"></a><span id="l11.749" class="difflineminus">-      &lt;!-- context menu --&gt;</span>
<a href="#l11.750"></a><span id="l11.750" class="difflineminus">-      &lt;menupopup onpopupshowing=&quot;this.parentNode.createTreeContextMenu(event);&quot;</span>
<a href="#l11.751"></a><span id="l11.751" class="difflineminus">-                 onpopuphidden=&quot;if (content) content.focus()&quot;</span>
<a href="#l11.752"></a><span id="l11.752" class="difflineminus">-                 onclick=&quot;event.stopPropagation();&quot;</span>
<a href="#l11.753"></a><span id="l11.753" class="difflineminus">-                 onkeypress=&quot;event.stopPropagation();&quot;/&gt;</span>
<a href="#l11.754"></a><span id="l11.754" class="difflineminus">-      &lt;vbox flex=&quot;1&quot;&gt;</span>
<a href="#l11.755"></a><span id="l11.755" class="difflineminus">-        &lt;tree anonid=&quot;bookmarks-tree&quot;</span>
<a href="#l11.756"></a><span id="l11.756" class="difflineminus">-              treelines=&quot;true&quot;</span>
<a href="#l11.757"></a><span id="l11.757" class="difflineminus">-              flex=&quot;1&quot;</span>
<a href="#l11.758"></a><span id="l11.758" class="difflineminus">-              class=&quot;plain&quot;</span>
<a href="#l11.759"></a><span id="l11.759" class="difflineminus">-              enableColumnDrag=&quot;true&quot;</span>
<a href="#l11.760"></a><span id="l11.760" class="difflineminus">-              datasources=&quot;rdf:bookmarks rdf:internetsearch rdf:localsearch&quot;</span>
<a href="#l11.761"></a><span id="l11.761" class="difflineminus">-              ref=&quot;NC:BookmarksTopRoot&quot;</span>
<a href="#l11.762"></a><span id="l11.762" class="difflineminus">-              flags=&quot;dont-build-content&quot;</span>
<a href="#l11.763"></a><span id="l11.763" class="difflineminus">-              onkeypress=&quot;if (event.keyCode == 13) this.parentNode.parentNode.openItemKey(event);&quot;</span>
<a href="#l11.764"></a><span id="l11.764" class="difflineminus">-              onclick=&quot;this.parentNode.parentNode.openItemClick(event, 1);&quot;</span>
<a href="#l11.765"></a><span id="l11.765" class="difflineminus">-              ondblclick=&quot;this.parentNode.parentNode.openItemClick(event, 2);&quot;</span>
<a href="#l11.766"></a><span id="l11.766" class="difflineminus">-              ondraggesture=&quot;if (event.originalTarget.localName == 'treechildren') nsDragAndDrop.startDrag(event, this.parentNode.parentNode.DNDObserver);&quot;</span>
<a href="#l11.767"></a><span id="l11.767" class="difflineminus">-              onselect=&quot;this.treeBoxObject.view.selectionChanged();&quot;&gt;</span>
<a href="#l11.768"></a><span id="l11.768" class="difflineminus">-          &lt;template xmlns:nc=&quot;http://home.netscape.com/NC-rdf#&quot;&gt;</span>
<a href="#l11.769"></a><span id="l11.769" class="difflineminus">-            &lt;rule rdf:type=&quot;http://home.netscape.com/NC-rdf#BookmarkSeparator&quot;&gt;</span>
<a href="#l11.770"></a><span id="l11.770" class="difflineminus">-              &lt;treechildren&gt;</span>
<a href="#l11.771"></a><span id="l11.771" class="difflineminus">-                &lt;treeitem uri=&quot;rdf:*&quot;&gt;</span>
<a href="#l11.772"></a><span id="l11.772" class="difflineminus">-                  &lt;treerow properties=&quot;rdf:http://www.w3.org/1999/02/22-rdf-syntax-ns#type separator&quot;&gt;</span>
<a href="#l11.773"></a><span id="l11.773" class="difflineminus">-                    &lt;treecell properties=&quot;separator&quot; label=&quot;rdf:http://home.netscape.com/NC-rdf#Name&quot;/&gt;</span>
<a href="#l11.774"></a><span id="l11.774" class="difflineminus">-                  &lt;/treerow&gt;</span>
<a href="#l11.775"></a><span id="l11.775" class="difflineminus">-                &lt;/treeitem&gt;</span>
<a href="#l11.776"></a><span id="l11.776" class="difflineminus">-              &lt;/treechildren&gt;</span>
<a href="#l11.777"></a><span id="l11.777" class="difflineminus">-            &lt;/rule&gt;</span>
<a href="#l11.778"></a><span id="l11.778" class="difflineminus">-            &lt;rule nc:FolderGroup=&quot;true&quot;&gt;</span>
<a href="#l11.779"></a><span id="l11.779" class="difflineminus">-              &lt;treechildren&gt;</span>
<a href="#l11.780"></a><span id="l11.780" class="difflineminus">-                &lt;treeitem uri=&quot;rdf:*&quot;&gt;</span>
<a href="#l11.781"></a><span id="l11.781" class="difflineminus">-                  &lt;treerow properties=&quot;rdf:http://www.w3.org/1999/02/22-rdf-syntax-ns#type rdf:http://home.netscape.com/NC-rdf#loading rdf:http://home.netscape.com/WEB-rdf#status&quot;&gt;</span>
<a href="#l11.782"></a><span id="l11.782" class="difflineminus">-                    &lt;treecell properties=&quot;group&quot; label=&quot;rdf:http://home.netscape.com/NC-rdf#Name&quot; /&gt;</span>
<a href="#l11.783"></a><span id="l11.783" class="difflineminus">-                    &lt;treecell label=&quot;rdf:http://home.netscape.com/NC-rdf#URL&quot; /&gt;</span>
<a href="#l11.784"></a><span id="l11.784" class="difflineminus">-                    &lt;treecell label=&quot;rdf:http://home.netscape.com/NC-rdf#ShortcutURL&quot; /&gt;</span>
<a href="#l11.785"></a><span id="l11.785" class="difflineminus">-                    &lt;treecell label=&quot;rdf:http://home.netscape.com/NC-rdf#Description&quot; /&gt;</span>
<a href="#l11.786"></a><span id="l11.786" class="difflineminus">-                    &lt;treecell label=&quot;rdf:http://home.netscape.com/NC-rdf#BookmarkAddDate&quot; /&gt;</span>
<a href="#l11.787"></a><span id="l11.787" class="difflineminus">-                    &lt;treecell label=&quot;rdf:http://home.netscape.com/WEB-rdf#LastModifiedDate&quot; /&gt;</span>
<a href="#l11.788"></a><span id="l11.788" class="difflineminus">-                    &lt;treecell label=&quot;rdf:http://home.netscape.com/WEB-rdf#LastVisitDate&quot;/&gt;</span>
<a href="#l11.789"></a><span id="l11.789" class="difflineminus">-                  &lt;/treerow&gt;</span>
<a href="#l11.790"></a><span id="l11.790" class="difflineminus">-                &lt;/treeitem&gt;</span>
<a href="#l11.791"></a><span id="l11.791" class="difflineminus">-              &lt;/treechildren&gt;</span>
<a href="#l11.792"></a><span id="l11.792" class="difflineminus">-            &lt;/rule&gt;</span>
<a href="#l11.793"></a><span id="l11.793" class="difflineminus">-            &lt;rule&gt;</span>
<a href="#l11.794"></a><span id="l11.794" class="difflineminus">-              &lt;treechildren&gt;</span>
<a href="#l11.795"></a><span id="l11.795" class="difflineminus">-                &lt;treeitem uri=&quot;rdf:*&quot;&gt;</span>
<a href="#l11.796"></a><span id="l11.796" class="difflineminus">-                  &lt;treerow properties=&quot;rdf:http://www.w3.org/1999/02/22-rdf-syntax-ns#type rdf:http://home.netscape.com/NC-rdf#loading rdf:http://home.netscape.com/WEB-rdf#status&quot;&gt;</span>
<a href="#l11.797"></a><span id="l11.797" class="difflineminus">-                    &lt;treecell src=&quot;rdf:http://home.netscape.com/NC-rdf#Icon&quot;</span>
<a href="#l11.798"></a><span id="l11.798" class="difflineminus">-                              properties=&quot;rdf:http://home.netscape.com/WEB-rdf#status&quot;</span>
<a href="#l11.799"></a><span id="l11.799" class="difflineminus">-                              label=&quot;rdf:http://home.netscape.com/NC-rdf#Name&quot;/&gt;</span>
<a href="#l11.800"></a><span id="l11.800" class="difflineminus">-                    &lt;treecell label=&quot;rdf:http://home.netscape.com/NC-rdf#URL&quot; /&gt;</span>
<a href="#l11.801"></a><span id="l11.801" class="difflineminus">-                    &lt;treecell label=&quot;rdf:http://home.netscape.com/NC-rdf#ShortcutURL&quot; /&gt;</span>
<a href="#l11.802"></a><span id="l11.802" class="difflineminus">-                    &lt;treecell label=&quot;rdf:http://home.netscape.com/NC-rdf#Description&quot; /&gt;</span>
<a href="#l11.803"></a><span id="l11.803" class="difflineminus">-                    &lt;treecell label=&quot;rdf:http://home.netscape.com/NC-rdf#BookmarkAddDate&quot; /&gt;</span>
<a href="#l11.804"></a><span id="l11.804" class="difflineminus">-                    &lt;treecell label=&quot;rdf:http://home.netscape.com/WEB-rdf#LastModifiedDate&quot; /&gt;</span>
<a href="#l11.805"></a><span id="l11.805" class="difflineminus">-                    &lt;treecell label=&quot;rdf:http://home.netscape.com/WEB-rdf#LastVisitDate&quot;/&gt;</span>
<a href="#l11.806"></a><span id="l11.806" class="difflineminus">-                  &lt;/treerow&gt;</span>
<a href="#l11.807"></a><span id="l11.807" class="difflineminus">-                &lt;/treeitem&gt;</span>
<a href="#l11.808"></a><span id="l11.808" class="difflineminus">-              &lt;/treechildren&gt;</span>
<a href="#l11.809"></a><span id="l11.809" class="difflineminus">-            &lt;/rule&gt;</span>
<a href="#l11.810"></a><span id="l11.810" class="difflineminus">-          &lt;/template&gt;</span>
<a href="#l11.811"></a><span id="l11.811" class="difflineminus">-          &lt;treecols anonid=&quot;treecols&quot;&gt;</span>
<a href="#l11.812"></a><span id="l11.812" class="difflineminus">-            &lt;treecol id=&quot;Name&quot; flex=&quot;1&quot; primary=&quot;true&quot;</span>
<a href="#l11.813"></a><span id="l11.813" class="difflineminus">-                     label=&quot;&amp;treecol.name.label;&quot;</span>
<a href="#l11.814"></a><span id="l11.814" class="difflineminus">-                     tooltiptext=&quot;&amp;treecol.name.tooltip;&quot;</span>
<a href="#l11.815"></a><span id="l11.815" class="difflineminus">-                     sort=&quot;rdf:http://home.netscape.com/NC-rdf#Name&quot;</span>
<a href="#l11.816"></a><span id="l11.816" class="difflineminus">-                     sortActive=&quot;true&quot;</span>
<a href="#l11.817"></a><span id="l11.817" class="difflineminus">-                     persist=&quot;width hidden ordinal&quot;/&gt;</span>
<a href="#l11.818"></a><span id="l11.818" class="difflineminus">-            &lt;splitter class=&quot;tree-splitter&quot; /&gt;</span>
<a href="#l11.819"></a><span id="l11.819" class="difflineminus">-            &lt;treecol id=&quot;URL&quot; flex=&quot;1&quot;</span>
<a href="#l11.820"></a><span id="l11.820" class="difflineminus">-                     label=&quot;&amp;treecol.url.label;&quot;</span>
<a href="#l11.821"></a><span id="l11.821" class="difflineminus">-                     tooltiptext=&quot;&amp;treecol.url.tooltip;&quot;</span>
<a href="#l11.822"></a><span id="l11.822" class="difflineminus">-                     sort=&quot;rdf:http://home.netscape.com/NC-rdf#URL&quot;</span>
<a href="#l11.823"></a><span id="l11.823" class="difflineminus">-                     persist=&quot;width hidden ordinal&quot;/&gt;</span>
<a href="#l11.824"></a><span id="l11.824" class="difflineminus">-            &lt;splitter class=&quot;tree-splitter&quot; /&gt;</span>
<a href="#l11.825"></a><span id="l11.825" class="difflineminus">-            &lt;treecol id=&quot;ShortcutURL&quot; flex=&quot;1&quot; hidden=&quot;true&quot;</span>
<a href="#l11.826"></a><span id="l11.826" class="difflineminus">-                     label=&quot;&amp;treecol.shortcut.label;&quot;</span>
<a href="#l11.827"></a><span id="l11.827" class="difflineminus">-                     tooltiptext=&quot;&amp;treecol.shortcut.tooltip;&quot;</span>
<a href="#l11.828"></a><span id="l11.828" class="difflineminus">-                     sort=&quot;rdf:http://home.netscape.com/NC-rdf#ShortcutURL&quot;</span>
<a href="#l11.829"></a><span id="l11.829" class="difflineminus">-                     persist=&quot;hidden width ordinal&quot;/&gt;</span>
<a href="#l11.830"></a><span id="l11.830" class="difflineminus">-            &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l11.831"></a><span id="l11.831" class="difflineminus">-            &lt;treecol id=&quot;Description&quot; flex=&quot;1&quot;</span>
<a href="#l11.832"></a><span id="l11.832" class="difflineminus">-                     label=&quot;&amp;treecol.description.label;&quot;</span>
<a href="#l11.833"></a><span id="l11.833" class="difflineminus">-                     tooltiptext=&quot;&amp;treecol.description.tooltip;&quot;</span>
<a href="#l11.834"></a><span id="l11.834" class="difflineminus">-                     sort=&quot;rdf:http://home.netscape.com/NC-rdf#Description&quot;</span>
<a href="#l11.835"></a><span id="l11.835" class="difflineminus">-                     persist=&quot;hidden width ordinal&quot;/&gt;</span>
<a href="#l11.836"></a><span id="l11.836" class="difflineminus">-            &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l11.837"></a><span id="l11.837" class="difflineminus">-            &lt;treecol id=&quot;BookmarkAddDate&quot; flex=&quot;1&quot; hidden=&quot;true&quot;</span>
<a href="#l11.838"></a><span id="l11.838" class="difflineminus">-                     label=&quot;&amp;treecol.addedon.label;&quot;</span>
<a href="#l11.839"></a><span id="l11.839" class="difflineminus">-                     tooltiptext=&quot;&amp;treecol.addedon.tooltip;&quot;</span>
<a href="#l11.840"></a><span id="l11.840" class="difflineminus">-                     sort=&quot;rdf:http://home.netscape.com/NC-rdf#BookmarkAddDate&quot;</span>
<a href="#l11.841"></a><span id="l11.841" class="difflineminus">-                     persist=&quot;width hidden ordinal&quot;/&gt;</span>
<a href="#l11.842"></a><span id="l11.842" class="difflineminus">-            &lt;splitter class=&quot;tree-splitter&quot; /&gt;</span>
<a href="#l11.843"></a><span id="l11.843" class="difflineminus">-            &lt;treecol id=&quot;LastModifiedDate&quot; flex=&quot;1&quot; hidden=&quot;true&quot;</span>
<a href="#l11.844"></a><span id="l11.844" class="difflineminus">-                     label=&quot;&amp;treecol.lastmod.label;&quot;</span>
<a href="#l11.845"></a><span id="l11.845" class="difflineminus">-                     tooltiptext=&quot;&amp;treecol.lastmod.tooltip;&quot;</span>
<a href="#l11.846"></a><span id="l11.846" class="difflineminus">-                     sort=&quot;rdf:http://home.netscape.com/WEB-rdf#LastModifiedDate&quot;</span>
<a href="#l11.847"></a><span id="l11.847" class="difflineminus">-                     persist=&quot;width hidden ordinal&quot;/&gt;</span>
<a href="#l11.848"></a><span id="l11.848" class="difflineminus">-            &lt;splitter class=&quot;tree-splitter&quot; /&gt;</span>
<a href="#l11.849"></a><span id="l11.849" class="difflineminus">-            &lt;treecol id=&quot;LastVisitDate&quot; flex=&quot;1&quot; hidden=&quot;true&quot;</span>
<a href="#l11.850"></a><span id="l11.850" class="difflineminus">-                     label=&quot;&amp;treecol.lastvisit.label;&quot;</span>
<a href="#l11.851"></a><span id="l11.851" class="difflineminus">-                     tooltiptext=&quot;&amp;treecol.lastvisit.tooltip;&quot;</span>
<a href="#l11.852"></a><span id="l11.852" class="difflineminus">-                     sort=&quot;rdf:http://home.netscape.com/WEB-rdf#LastVisitDate&quot;</span>
<a href="#l11.853"></a><span id="l11.853" class="difflineminus">-                     persist=&quot;width hidden ordinal&quot;/&gt;</span>
<a href="#l11.854"></a><span id="l11.854" class="difflineminus">-          &lt;/treecols&gt;</span>
<a href="#l11.855"></a><span id="l11.855" class="difflineminus">-        &lt;/tree&gt;</span>
<a href="#l11.856"></a><span id="l11.856" class="difflineminus">-        &lt;statusbar class=&quot;chromeclass-status&quot; xbl:inherits=&quot;hidden=hidestatusbar&quot; hidden=&quot;false&quot;&gt;</span>
<a href="#l11.857"></a><span id="l11.857" class="difflineminus">-          &lt;statusbarpanel anonid=&quot;statusbar-text&quot; flex=&quot;1&quot;/&gt;</span>
<a href="#l11.858"></a><span id="l11.858" class="difflineminus">-        &lt;/statusbar&gt;</span>
<a href="#l11.859"></a><span id="l11.859" class="difflineminus">-      &lt;/vbox&gt;</span>
<a href="#l11.860"></a><span id="l11.860" class="difflineminus">-    &lt;/xbl:content&gt;</span>
<a href="#l11.861"></a><span id="l11.861" class="difflineminus">-    &lt;implementation&gt;</span>
<a href="#l11.862"></a><span id="l11.862" class="difflineminus">-      &lt;field name=&quot;clickCount&quot;&gt;2&lt;/field&gt;</span>
<a href="#l11.863"></a><span id="l11.863" class="difflineminus">-    &lt;/implementation&gt;</span>
<a href="#l11.864"></a><span id="l11.864" class="difflineminus">-  &lt;/binding&gt;</span>
<a href="#l11.865"></a><span id="l11.865" class="difflineminus">-</span>
<a href="#l11.866"></a><span id="l11.866" class="difflineminus">-  &lt;!-- Single column tree --&gt;</span>
<a href="#l11.867"></a><span id="l11.867" class="difflineminus">-  &lt;binding id=&quot;bookmarks-tree-name&quot; extends=&quot;chrome://communicator/content/bookmarks/bookmarksTree.xml#bookmarks-tree&quot;&gt;</span>
<a href="#l11.868"></a><span id="l11.868" class="difflineminus">-    &lt;xbl:content xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot; </span>
<a href="#l11.869"></a><span id="l11.869" class="difflineminus">-                 xmlns:xbl=&quot;http://www.mozilla.org/xbl&quot; contextmenu=&quot;_child&quot;&gt;</span>
<a href="#l11.870"></a><span id="l11.870" class="difflineminus">-      &lt;!-- context menu --&gt;</span>
<a href="#l11.871"></a><span id="l11.871" class="difflineminus">-      &lt;menupopup xbl:inherits=&quot;onpopupshowing&quot;</span>
<a href="#l11.872"></a><span id="l11.872" class="difflineminus">-                 onpopupshowing=&quot;this.parentNode.createTreeContextMenu(event);&quot;</span>
<a href="#l11.873"></a><span id="l11.873" class="difflineminus">-                 onpopuphidden=&quot;if (content) content.focus()&quot;</span>
<a href="#l11.874"></a><span id="l11.874" class="difflineminus">-                 onclick=&quot;event.stopPropagation();&quot;</span>
<a href="#l11.875"></a><span id="l11.875" class="difflineminus">-                 onkeypress=&quot;event.stopPropagation();&quot;/&gt;</span>
<a href="#l11.876"></a><span id="l11.876" class="difflineminus">-      &lt;tree anonid=&quot;bookmarks-tree&quot;</span>
<a href="#l11.877"></a><span id="l11.877" class="difflineminus">-            treelines=&quot;true&quot;</span>
<a href="#l11.878"></a><span id="l11.878" class="difflineminus">-            flex=&quot;1&quot;</span>
<a href="#l11.879"></a><span id="l11.879" class="difflineminus">-            class=&quot;plain&quot;</span>
<a href="#l11.880"></a><span id="l11.880" class="difflineminus">-            hidecolumnpicker=&quot;true&quot;</span>
<a href="#l11.881"></a><span id="l11.881" class="difflineminus">-            datasources=&quot;rdf:bookmarks rdf:internetsearch rdf:localsearch&quot;</span>
<a href="#l11.882"></a><span id="l11.882" class="difflineminus">-            ref=&quot;NC:BookmarksRoot&quot;</span>
<a href="#l11.883"></a><span id="l11.883" class="difflineminus">-            flags=&quot;dont-build-content&quot;</span>
<a href="#l11.884"></a><span id="l11.884" class="difflineminus">-            seltype=&quot;single&quot;</span>
<a href="#l11.885"></a><span id="l11.885" class="difflineminus">-            onselect=&quot;this.parentNode.treeBoxObject.view.selectionChanged();&quot;&gt;</span>
<a href="#l11.886"></a><span id="l11.886" class="difflineminus">-        &lt;template xmlns:nc=&quot;http://home.netscape.com/NC-rdf#&quot;&gt;</span>
<a href="#l11.887"></a><span id="l11.887" class="difflineminus">-          &lt;rule rdf:type=&quot;http://home.netscape.com/NC-rdf#BookmarkSeparator&quot;&gt;</span>
<a href="#l11.888"></a><span id="l11.888" class="difflineminus">-            &lt;treechildren&gt;</span>
<a href="#l11.889"></a><span id="l11.889" class="difflineminus">-              &lt;treeitem uri=&quot;rdf:*&quot;&gt;</span>
<a href="#l11.890"></a><span id="l11.890" class="difflineminus">-                &lt;treerow properties=&quot;rdf:http://www.w3.org/1999/02/22-rdf-syntax-ns#type separator&quot;&gt;</span>
<a href="#l11.891"></a><span id="l11.891" class="difflineminus">-                  &lt;treecell properties=&quot;separator&quot; label=&quot;rdf:http://home.netscape.com/NC-rdf#Name&quot;/&gt;</span>
<a href="#l11.892"></a><span id="l11.892" class="difflineminus">-                &lt;/treerow&gt;</span>
<a href="#l11.893"></a><span id="l11.893" class="difflineminus">-              &lt;/treeitem&gt;</span>
<a href="#l11.894"></a><span id="l11.894" class="difflineminus">-            &lt;/treechildren&gt;</span>
<a href="#l11.895"></a><span id="l11.895" class="difflineminus">-          &lt;/rule&gt;</span>
<a href="#l11.896"></a><span id="l11.896" class="difflineminus">-          &lt;rule nc:FolderGroup=&quot;true&quot;&gt;</span>
<a href="#l11.897"></a><span id="l11.897" class="difflineminus">-            &lt;treechildren&gt;</span>
<a href="#l11.898"></a><span id="l11.898" class="difflineminus">-              &lt;treeitem uri=&quot;rdf:*&quot;&gt;</span>
<a href="#l11.899"></a><span id="l11.899" class="difflineminus">-                &lt;treerow properties=&quot;rdf:http://www.w3.org/1999/02/22-rdf-syntax-ns#type rdf:http://home.netscape.com/NC-rdf#loading rdf:http://home.netscape.com/WEB-rdf#status&quot;&gt;</span>
<a href="#l11.900"></a><span id="l11.900" class="difflineminus">-                  &lt;treecell properties=&quot;group hidetwisty&quot; label=&quot;rdf:http://home.netscape.com/NC-rdf#Name&quot; /&gt;</span>
<a href="#l11.901"></a><span id="l11.901" class="difflineminus">-                &lt;/treerow&gt;</span>
<a href="#l11.902"></a><span id="l11.902" class="difflineminus">-              &lt;/treeitem&gt;</span>
<a href="#l11.903"></a><span id="l11.903" class="difflineminus">-            &lt;/treechildren&gt;</span>
<a href="#l11.904"></a><span id="l11.904" class="difflineminus">-          &lt;/rule&gt;</span>
<a href="#l11.905"></a><span id="l11.905" class="difflineminus">-          &lt;rule&gt;</span>
<a href="#l11.906"></a><span id="l11.906" class="difflineminus">-            &lt;treechildren&gt;</span>
<a href="#l11.907"></a><span id="l11.907" class="difflineminus">-              &lt;treeitem uri=&quot;rdf:*&quot;&gt;</span>
<a href="#l11.908"></a><span id="l11.908" class="difflineminus">-                &lt;treerow properties=&quot;rdf:http://www.w3.org/1999/02/22-rdf-syntax-ns#type rdf:http://home.netscape.com/NC-rdf#loading rdf:http://home.netscape.com/WEB-rdf#status&quot;&gt;</span>
<a href="#l11.909"></a><span id="l11.909" class="difflineminus">-                  &lt;treecell src=&quot;rdf:http://home.netscape.com/NC-rdf#Icon&quot;</span>
<a href="#l11.910"></a><span id="l11.910" class="difflineminus">-                            properties=&quot;rdf:http://home.netscape.com/WEB-rdf#status&quot;</span>
<a href="#l11.911"></a><span id="l11.911" class="difflineminus">-                            label=&quot;rdf:http://home.netscape.com/NC-rdf#Name&quot;/&gt;</span>
<a href="#l11.912"></a><span id="l11.912" class="difflineminus">-                &lt;/treerow&gt;</span>
<a href="#l11.913"></a><span id="l11.913" class="difflineminus">-              &lt;/treeitem&gt;</span>
<a href="#l11.914"></a><span id="l11.914" class="difflineminus">-            &lt;/treechildren&gt;</span>
<a href="#l11.915"></a><span id="l11.915" class="difflineminus">-          &lt;/rule&gt;</span>
<a href="#l11.916"></a><span id="l11.916" class="difflineminus">-        &lt;/template&gt;</span>
<a href="#l11.917"></a><span id="l11.917" class="difflineminus">-        &lt;treecols anonid=&quot;treecols&quot;&gt;</span>
<a href="#l11.918"></a><span id="l11.918" class="difflineminus">-          &lt;treecol id=&quot;Name&quot; flex=&quot;1&quot; primary=&quot;true&quot; hideheader=&quot;true&quot;</span>
<a href="#l11.919"></a><span id="l11.919" class="difflineminus">-                   sort=&quot;rdf:http://home.netscape.com/NC-rdf#Name&quot;</span>
<a href="#l11.920"></a><span id="l11.920" class="difflineminus">-                   sortActive=&quot;true&quot; sortLocked=&quot;true&quot;/&gt;</span>
<a href="#l11.921"></a><span id="l11.921" class="difflineminus">-        &lt;/treecols&gt;</span>
<a href="#l11.922"></a><span id="l11.922" class="difflineminus">-      &lt;/tree&gt;</span>
<a href="#l11.923"></a><span id="l11.923" class="difflineminus">-    &lt;/xbl:content&gt;</span>
<a href="#l11.924"></a><span id="l11.924" class="difflineminus">-    &lt;implementation&gt;</span>
<a href="#l11.925"></a><span id="l11.925" class="difflineminus">-      &lt;field name=&quot;clickCount&quot;&gt;1&lt;/field&gt;</span>
<a href="#l11.926"></a><span id="l11.926" class="difflineminus">-    &lt;/implementation&gt;</span>
<a href="#l11.927"></a><span id="l11.927" class="difflineminus">-  &lt;/binding&gt;</span>
<a href="#l11.928"></a><span id="l11.928" class="difflineminus">-</span>
<a href="#l11.929"></a><span id="l11.929" class="difflineminus">-  &lt;!-- Tree with folders only --&gt;</span>
<a href="#l11.930"></a><span id="l11.930" class="difflineminus">-  &lt;binding id=&quot;bookmarks-tree-folders&quot; extends=&quot;chrome://communicator/content/bookmarks/bookmarksTree.xml#bookmarks-tree&quot;&gt;</span>
<a href="#l11.931"></a><span id="l11.931" class="difflineminus">-    &lt;xbl:content xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot; xmlns:xbl=&quot;http://www.mozilla.org/xbl&quot;&gt;</span>
<a href="#l11.932"></a><span id="l11.932" class="difflineminus">-      &lt;tree anonid=&quot;bookmarks-tree&quot;</span>
<a href="#l11.933"></a><span id="l11.933" class="difflineminus">-            treelines=&quot;true&quot;</span>
<a href="#l11.934"></a><span id="l11.934" class="difflineminus">-            flex=&quot;1&quot;</span>
<a href="#l11.935"></a><span id="l11.935" class="difflineminus">-            hidecolumnpicker=&quot;true&quot;</span>
<a href="#l11.936"></a><span id="l11.936" class="difflineminus">-            xbl:inherits=&quot;rows,seltype&quot;</span>
<a href="#l11.937"></a><span id="l11.937" class="difflineminus">-            datasources=&quot;rdf:bookmarks rdf:internetsearch rdf:localsearch&quot;</span>
<a href="#l11.938"></a><span id="l11.938" class="difflineminus">-            ref=&quot;NC:BookmarksTopRoot&quot;</span>
<a href="#l11.939"></a><span id="l11.939" class="difflineminus">-            flags=&quot;dont-build-content&quot;</span>
<a href="#l11.940"></a><span id="l11.940" class="difflineminus">-            onselect=&quot;this.parentNode.treeBoxObject.view.selectionChanged();&quot;&gt;</span>
<a href="#l11.941"></a><span id="l11.941" class="difflineminus">-        &lt;template&gt;</span>
<a href="#l11.942"></a><span id="l11.942" class="difflineminus">-          &lt;rule iscontainer=&quot;true&quot;&gt;</span>
<a href="#l11.943"></a><span id="l11.943" class="difflineminus">-            &lt;treechildren&gt;</span>
<a href="#l11.944"></a><span id="l11.944" class="difflineminus">-              &lt;treeitem uri=&quot;rdf:*&quot;&gt;</span>
<a href="#l11.945"></a><span id="l11.945" class="difflineminus">-                &lt;treerow properties=&quot;rdf:http://www.w3.org/1999/02/22-rdf-syntax-ns#type rdf:http://home.netscape.com/NC-rdf#loading rdf:http://home.netscape.com/WEB-rdf#status&quot;&gt;</span>
<a href="#l11.946"></a><span id="l11.946" class="difflineminus">-                  &lt;treecell label=&quot;rdf:http://home.netscape.com/NC-rdf#Name&quot; /&gt;</span>
<a href="#l11.947"></a><span id="l11.947" class="difflineminus">-                &lt;/treerow&gt;</span>
<a href="#l11.948"></a><span id="l11.948" class="difflineminus">-              &lt;/treeitem&gt;</span>
<a href="#l11.949"></a><span id="l11.949" class="difflineminus">-            &lt;/treechildren&gt;</span>
<a href="#l11.950"></a><span id="l11.950" class="difflineminus">-          &lt;/rule&gt;</span>
<a href="#l11.951"></a><span id="l11.951" class="difflineminus">-        &lt;/template&gt;</span>
<a href="#l11.952"></a><span id="l11.952" class="difflineminus">-        &lt;treecols anonid=&quot;treecols&quot;&gt;</span>
<a href="#l11.953"></a><span id="l11.953" class="difflineminus">-          &lt;treecol id=&quot;Name&quot; flex=&quot;1&quot; primary=&quot;true&quot; hideheader=&quot;true&quot;</span>
<a href="#l11.954"></a><span id="l11.954" class="difflineminus">-                   sort=&quot;rdf:http://home.netscape.com/NC-rdf#Name&quot;</span>
<a href="#l11.955"></a><span id="l11.955" class="difflineminus">-                   sortActive=&quot;true&quot; sortLocked=&quot;true&quot;/&gt;</span>
<a href="#l11.956"></a><span id="l11.956" class="difflineminus">-        &lt;/treecols&gt;</span>
<a href="#l11.957"></a><span id="l11.957" class="difflineminus">-      &lt;/tree&gt;</span>
<a href="#l11.958"></a><span id="l11.958" class="difflineminus">-    &lt;/xbl:content&gt;</span>
<a href="#l11.959"></a><span id="l11.959" class="difflineminus">-    &lt;implementation&gt;</span>
<a href="#l11.960"></a><span id="l11.960" class="difflineminus">-      &lt;field name=&quot;clickCount&quot;&gt;2&lt;/field&gt;</span>
<a href="#l11.961"></a><span id="l11.961" class="difflineminus">-    &lt;/implementation&gt;</span>
<a href="#l11.962"></a><span id="l11.962" class="difflineminus">-  &lt;/binding&gt;</span>
<a href="#l11.963"></a><span id="l11.963" class="difflineminus">-&lt;/bindings&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1">deleted file mode 100644</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineminus">--- a/suite/common/bookmarks/findBookmark.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineplus">+++ /dev/null</span>
<a href="#l12.4"></a><span id="l12.4" class="difflineat">@@ -1,90 +0,0 @@</span>
<a href="#l12.5"></a><span id="l12.5" class="difflineminus">-/* -*- Mode: Java; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l12.6"></a><span id="l12.6" class="difflineminus">-/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l12.7"></a><span id="l12.7" class="difflineminus">- * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l12.8"></a><span id="l12.8" class="difflineminus">- *</span>
<a href="#l12.9"></a><span id="l12.9" class="difflineminus">- * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l12.10"></a><span id="l12.10" class="difflineminus">- * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l12.11"></a><span id="l12.11" class="difflineminus">- * the License. You may obtain a copy of the License at</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">- * http://www.mozilla.org/MPL/</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">- *</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineminus">- * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineminus">- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineminus">- * for the specific language governing rights and limitations under the</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineminus">- * License.</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineminus">- *</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineminus">- * The Original Code is mozilla.org code.</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineminus">- *</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineminus">- * The Initial Developer of the Original Code is</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineminus">- * Netscape Communications Corporation.</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineminus">- * Portions created by the Initial Developer are Copyright (C) 1998</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineminus">- * the Initial Developer. All Rights Reserved.</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineminus">- *</span>
<a href="#l12.26"></a><span id="l12.26" class="difflineminus">- * Contributor(s):</span>
<a href="#l12.27"></a><span id="l12.27" class="difflineminus">- *   Ben Goodger &lt;ben@netscape.com&gt; (Original Author)</span>
<a href="#l12.28"></a><span id="l12.28" class="difflineminus">- *</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineminus">- * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineminus">- * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineminus">- * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineminus">- * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineminus">- * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineminus">- * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineminus">- * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineminus">- * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineminus">- * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineminus">- * the provisions above, a recipient may use your version of this file under</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineminus">- * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l12.40"></a><span id="l12.40" class="difflineminus">- *</span>
<a href="#l12.41"></a><span id="l12.41" class="difflineminus">- * ***** END LICENSE BLOCK ***** */</span>
<a href="#l12.42"></a><span id="l12.42" class="difflineminus">-</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineminus">-var gOKButton;</span>
<a href="#l12.44"></a><span id="l12.44" class="difflineminus">-var gSearchField;</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineminus">-function Startup()</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineminus">-{</span>
<a href="#l12.47"></a><span id="l12.47" class="difflineminus">-  initServices();</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineminus">-  initBMService();</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineminus">-  gOKButton = document.documentElement.getButton(&quot;accept&quot;);</span>
<a href="#l12.50"></a><span id="l12.50" class="difflineminus">-  gOKButton.disabled = true;</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineminus">-  gSearchField = document.getElementById(&quot;searchField&quot;);</span>
<a href="#l12.52"></a><span id="l12.52" class="difflineminus">-  gSearchField.focus();</span>
<a href="#l12.53"></a><span id="l12.53" class="difflineminus">-}</span>
<a href="#l12.54"></a><span id="l12.54" class="difflineminus">-var gCreatingNewWindow = false;</span>
<a href="#l12.55"></a><span id="l12.55" class="difflineminus">-function find()</span>
<a href="#l12.56"></a><span id="l12.56" class="difflineminus">-{</span>
<a href="#l12.57"></a><span id="l12.57" class="difflineminus">-  // Build up a find URI from the search fields and open a new window</span>
<a href="#l12.58"></a><span id="l12.58" class="difflineminus">-  // rooted on the URI. </span>
<a href="#l12.59"></a><span id="l12.59" class="difflineminus">-  var match = document.getElementById(&quot;matchList&quot;);</span>
<a href="#l12.60"></a><span id="l12.60" class="difflineminus">-  var method = document.getElementById(&quot;methodList&quot;);</span>
<a href="#l12.61"></a><span id="l12.61" class="difflineminus">-  var searchURI = &quot;find:datasource=rdf:bookmarks&quot;</span>
<a href="#l12.62"></a><span id="l12.62" class="difflineminus">-  searchURI += &quot;&amp;match=&quot; + match.selectedItem.value;</span>
<a href="#l12.63"></a><span id="l12.63" class="difflineminus">-  searchURI += &quot;&amp;method=&quot; + method.selectedItem.value;</span>
<a href="#l12.64"></a><span id="l12.64" class="difflineminus">-  searchURI += &quot;&amp;text=&quot; + encodeURIComponent(gSearchField.value);</span>
<a href="#l12.65"></a><span id="l12.65" class="difflineminus">-  var bmWindow = findMostRecentWindow(&quot;bookmarks:searchresults&quot;, &quot;chrome://communicator/content/bookmarks/bookmarksManager.xul&quot;, searchURI);</span>
<a href="#l12.66"></a><span id="l12.66" class="difflineminus">-  </span>
<a href="#l12.67"></a><span id="l12.67" class="difflineminus">-  // Update the root of the tree if we're using an existing search window. </span>
<a href="#l12.68"></a><span id="l12.68" class="difflineminus">-  if (!gCreatingNewWindow) </span>
<a href="#l12.69"></a><span id="l12.69" class="difflineminus">-    bmWindow.document.getElementById(&quot;bookmarks-view&quot;).tree.setAttribute(&quot;ref&quot;, searchURI);</span>
<a href="#l12.70"></a><span id="l12.70" class="difflineminus">- </span>
<a href="#l12.71"></a><span id="l12.71" class="difflineminus">-  bmWindow.focus();</span>
<a href="#l12.72"></a><span id="l12.72" class="difflineminus">-</span>
<a href="#l12.73"></a><span id="l12.73" class="difflineminus">-  if (document.getElementById(&quot;saveQuery&quot;).checked == true)</span>
<a href="#l12.74"></a><span id="l12.74" class="difflineminus">-  {</span>
<a href="#l12.75"></a><span id="l12.75" class="difflineminus">-    var bundle = document.getElementById(&quot;bookmarksBundle&quot;);</span>
<a href="#l12.76"></a><span id="l12.76" class="difflineminus">-    var findTitle = BookmarksUtils.getLocaleString(&quot;ShortFindTitle&quot;, [gSearchField.value]);</span>
<a href="#l12.77"></a><span id="l12.77" class="difflineminus">-    BMSVC.addBookmarkImmediately(searchURI, findTitle, BMSVC.BOOKMARK_FIND_TYPE, null);</span>
<a href="#l12.78"></a><span id="l12.78" class="difflineminus">-  }</span>
<a href="#l12.79"></a><span id="l12.79" class="difflineminus">-</span>
<a href="#l12.80"></a><span id="l12.80" class="difflineminus">-  return true;</span>
<a href="#l12.81"></a><span id="l12.81" class="difflineminus">-}</span>
<a href="#l12.82"></a><span id="l12.82" class="difflineminus">-</span>
<a href="#l12.83"></a><span id="l12.83" class="difflineminus">-function findMostRecentWindow(aType, aURI, aParam)</span>
<a href="#l12.84"></a><span id="l12.84" class="difflineminus">-{</span>
<a href="#l12.85"></a><span id="l12.85" class="difflineminus">-  var topWindow = WINDOWSVC &amp;&amp; WINDOWSVC.getMostRecentWindow(aType);</span>
<a href="#l12.86"></a><span id="l12.86" class="difflineminus">-  if (!topWindow) gCreatingNewWindow = true;</span>
<a href="#l12.87"></a><span id="l12.87" class="difflineminus">-  return topWindow || openDialog(&quot;chrome://communicator/content/bookmarks/bookmarksManager.xul&quot;, </span>
<a href="#l12.88"></a><span id="l12.88" class="difflineminus">-                                 &quot;&quot;, &quot;chrome,all,dialog=no&quot;, aParam);</span>
<a href="#l12.89"></a><span id="l12.89" class="difflineminus">-}</span>
<a href="#l12.90"></a><span id="l12.90" class="difflineminus">-</span>
<a href="#l12.91"></a><span id="l12.91" class="difflineminus">-function doEnabling()</span>
<a href="#l12.92"></a><span id="l12.92" class="difflineminus">-{</span>
<a href="#l12.93"></a><span id="l12.93" class="difflineminus">-  gOKButton.disabled = !gSearchField.value;</span>
<a href="#l12.94"></a><span id="l12.94" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1">deleted file mode 100644</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineminus">--- a/suite/common/bookmarks/findBookmark.xul</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineplus">+++ /dev/null</span>
<a href="#l13.4"></a><span id="l13.4" class="difflineat">@@ -1,87 +0,0 @@</span>
<a href="#l13.5"></a><span id="l13.5" class="difflineminus">-&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<a href="#l13.6"></a><span id="l13.6" class="difflineminus">-</span>
<a href="#l13.7"></a><span id="l13.7" class="difflineminus">-&lt;!-- -*- Mode: HTML; indent-tabs-mode: nil; -*- --&gt;</span>
<a href="#l13.8"></a><span id="l13.8" class="difflineminus">-&lt;!--</span>
<a href="#l13.9"></a><span id="l13.9" class="difflineminus">-</span>
<a href="#l13.10"></a><span id="l13.10" class="difflineminus">- ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l13.11"></a><span id="l13.11" class="difflineminus">- Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">- The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineminus">- 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineminus">- the License. You may obtain a copy of the License at</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineminus">- http://www.mozilla.org/MPL/</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineminus">-</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineminus">- Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineminus">- WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineminus">- for the specific language governing rights and limitations under the</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineminus">- License.</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineminus">-</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineminus">- The Original Code is mozilla.org code.</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineminus">-</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineminus">- The Initial Developer of the Original Code is</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineminus">- Netscape Communications Corporation.</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineminus">- Portions created by the Initial Developer are Copyright (C) 1998</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineminus">- the Initial Developer. All Rights Reserved.</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineminus">-</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineminus">- Contributor(s):</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineminus">-   Ben Goodger &lt;ben@netscape.com&gt; (Original Author)</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineminus">-</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineminus">- Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineminus">- either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineminus">- or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineminus">- in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineminus">- of those above. If you wish to allow use of your version of this file only</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineminus">- under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineminus">- use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineminus">- decision by deleting the provisions above and replace them with the notice</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineminus">- and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineminus">- the provisions above, a recipient may use your version of this file under</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineminus">- the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineminus">-</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineminus">- ***** END LICENSE BLOCK ***** --&gt;</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineminus">-</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineminus">-&lt;!--</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineminus">-    &quot;Find Bookmarks&quot; window</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineminus">-  --&gt;</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineminus">-</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineminus">-&lt;?xml-stylesheet href=&quot;chrome://communicator/skin/&quot;?&gt;</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineminus">-&lt;!DOCTYPE dialog SYSTEM &quot;chrome://communicator/locale/bookmarks/findBookmark.dtd&quot;&gt;</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineminus">-</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineminus">-&lt;dialog id=&quot;findBookmarkWindow&quot; style=&quot;width: 36em;&quot;</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineminus">-        xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;</span>
<a href="#l13.56"></a><span id="l13.56" class="difflineminus">-        title=&quot;&amp;findBookmark.title;&quot; </span>
<a href="#l13.57"></a><span id="l13.57" class="difflineminus">-        onload=&quot;Startup();&quot;</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineminus">-        ondialogaccept=&quot;return find();&quot;</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineminus">-        buttonlabelaccept=&quot;&amp;findButton.label;&quot;</span>
<a href="#l13.60"></a><span id="l13.60" class="difflineminus">-        buttonaccesskeyaccept=&quot;&amp;findButton.accesskey;&quot;&gt;</span>
<a href="#l13.61"></a><span id="l13.61" class="difflineminus">-</span>
<a href="#l13.62"></a><span id="l13.62" class="difflineminus">-  &lt;stringbundle id=&quot;bookmarksBundle&quot; src=&quot;chrome://communicator/locale/bookmarks/bookmarks.properties&quot;/&gt;</span>
<a href="#l13.63"></a><span id="l13.63" class="difflineminus">-  </span>
<a href="#l13.64"></a><span id="l13.64" class="difflineminus">-  &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://communicator/content/bookmarks/bookmarks.js&quot;/&gt;</span>
<a href="#l13.65"></a><span id="l13.65" class="difflineminus">-  &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://communicator/content/bookmarks/findBookmark.js&quot;/&gt;</span>
<a href="#l13.66"></a><span id="l13.66" class="difflineminus">-</span>
<a href="#l13.67"></a><span id="l13.67" class="difflineminus">-  &lt;label value=&quot;&amp;search.for.label;&quot; control=&quot;matchList&quot;/&gt;</span>
<a href="#l13.68"></a><span id="l13.68" class="difflineminus">-  &lt;hbox align=&quot;center&quot;&gt;</span>
<a href="#l13.69"></a><span id="l13.69" class="difflineminus">-    &lt;menulist id=&quot;matchList&quot; class=&quot;menulist-toolbar&quot;&gt;</span>
<a href="#l13.70"></a><span id="l13.70" class="difflineminus">-      &lt;menupopup&gt;</span>
<a href="#l13.71"></a><span id="l13.71" class="difflineminus">-        &lt;menuitem value=&quot;http://home.netscape.com/NC-rdf#Name&quot; label=&quot;&amp;search.name.label;&quot;/&gt;</span>
<a href="#l13.72"></a><span id="l13.72" class="difflineminus">-        &lt;menuitem value=&quot;http://home.netscape.com/NC-rdf#URL&quot; label=&quot;&amp;search.url.label;&quot;/&gt;</span>
<a href="#l13.73"></a><span id="l13.73" class="difflineminus">-        &lt;menuitem value=&quot;http://home.netscape.com/NC-rdf#Description&quot; label=&quot;&amp;search.description.label;&quot;/&gt;</span>
<a href="#l13.74"></a><span id="l13.74" class="difflineminus">-        &lt;menuitem value=&quot;http://home.netscape.com/NC-rdf#ShortcutURL&quot; label=&quot;&amp;search.shortcut.label;&quot;/&gt;</span>
<a href="#l13.75"></a><span id="l13.75" class="difflineminus">-      &lt;/menupopup&gt;</span>
<a href="#l13.76"></a><span id="l13.76" class="difflineminus">-    &lt;/menulist&gt;</span>
<a href="#l13.77"></a><span id="l13.77" class="difflineminus">-    &lt;menulist id=&quot;methodList&quot; class=&quot;menulist-toolbar&quot;&gt;</span>
<a href="#l13.78"></a><span id="l13.78" class="difflineminus">-      &lt;menupopup&gt;</span>
<a href="#l13.79"></a><span id="l13.79" class="difflineminus">-        &lt;menuitem value=&quot;contains&quot; label=&quot;&amp;search.contains.label;&quot;/&gt;</span>
<a href="#l13.80"></a><span id="l13.80" class="difflineminus">-        &lt;menuitem value=&quot;startswith&quot; label=&quot;&amp;search.startswith.label;&quot;/&gt;</span>
<a href="#l13.81"></a><span id="l13.81" class="difflineminus">-        &lt;menuitem value=&quot;endswith&quot; label=&quot;&amp;search.endswith.label;&quot;/&gt;</span>
<a href="#l13.82"></a><span id="l13.82" class="difflineminus">-        &lt;menuitem value=&quot;is&quot; label=&quot;&amp;search.is.label;&quot;/&gt;</span>
<a href="#l13.83"></a><span id="l13.83" class="difflineminus">-        &lt;menuitem value=&quot;isnot&quot; label=&quot;&amp;search.isnot.label;&quot;/&gt;</span>
<a href="#l13.84"></a><span id="l13.84" class="difflineminus">-        &lt;menuitem value=&quot;doesntcontain&quot; label=&quot;&amp;search.doesntcontain.label;&quot;/&gt;</span>
<a href="#l13.85"></a><span id="l13.85" class="difflineminus">-      &lt;/menupopup&gt;</span>
<a href="#l13.86"></a><span id="l13.86" class="difflineminus">-    &lt;/menulist&gt;</span>
<a href="#l13.87"></a><span id="l13.87" class="difflineminus">-    &lt;textbox id=&quot;searchField&quot; flex=&quot;1&quot; oninput=&quot;doEnabling();&quot;/&gt;</span>
<a href="#l13.88"></a><span id="l13.88" class="difflineminus">-  &lt;/hbox&gt;</span>
<a href="#l13.89"></a><span id="l13.89" class="difflineminus">-  &lt;checkbox id=&quot;saveQuery&quot; label=&quot;&amp;save.query.label;&quot; accesskey=&quot;&amp;save.query.accesskey;&quot;/&gt;</span>
<a href="#l13.90"></a><span id="l13.90" class="difflineminus">-&lt;/dialog&gt;</span>
<a href="#l13.91"></a><span id="l13.91" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1">deleted file mode 100644</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineminus">--- a/suite/common/bookmarks/sortFolder.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineplus">+++ /dev/null</span>
<a href="#l14.4"></a><span id="l14.4" class="difflineat">@@ -1,51 +0,0 @@</span>
<a href="#l14.5"></a><span id="l14.5" class="difflineminus">-/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l14.6"></a><span id="l14.6" class="difflineminus">- * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l14.7"></a><span id="l14.7" class="difflineminus">- *</span>
<a href="#l14.8"></a><span id="l14.8" class="difflineminus">- * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l14.9"></a><span id="l14.9" class="difflineminus">- * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l14.10"></a><span id="l14.10" class="difflineminus">- * the License. You may obtain a copy of the License at</span>
<a href="#l14.11"></a><span id="l14.11" class="difflineminus">- * http://www.mozilla.org/MPL/</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">- *</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineminus">- * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineminus">- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineminus">- * for the specific language governing rights and limitations under the</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineminus">- * License.</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineminus">- *</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineminus">- * The Original Code is mozilla.org code.</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineminus">- *</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineminus">- * The Initial Developer of the Original Code is</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineminus">- * Netscape Communications Corporation.</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineminus">- * Portions created by the Initial Developer are Copyright (C) 2002</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineminus">- * the Initial Developer. All Rights Reserved.</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineminus">- *</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineminus">- * Contributor(s):</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineminus">- *   Jan Varga &lt;varga@ku.sk&gt;</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineminus">- *</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineminus">- * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineminus">- * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineminus">- * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineminus">- * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineminus">- * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineminus">- * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineminus">- * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineminus">- * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineminus">- * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineminus">- * the provisions above, a recipient may use your version of this file under</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineminus">- * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineminus">- *</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineminus">- * ***** END LICENSE BLOCK ***** */</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineminus">-</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineminus">-function onAccept() {</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineminus">-  var sortOptions = window.arguments[0];</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineminus">-  sortOptions.accepted = true;</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineminus">-  sortOptions.sortBy = document.getElementById(&quot;sortBy&quot;).value;</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineminus">-  sortOptions.sortOrder = document.getElementById(&quot;sortOrder&quot;).value;</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineminus">-  sortOptions.sortFoldersFirst = document.getElementById(&quot;sortFoldersFirst&quot;).checked;</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineminus">-  sortOptions.sortRecursively = document.getElementById(&quot;sortRecursively&quot;).checked;</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineminus">-}</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineminus">-</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineminus">-function onSortByChanged() {</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineminus">-  var sortBy = document.getElementById(&quot;sortBy&quot;);</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineminus">-  var sortFoldersFirst = document.getElementById(&quot;sortFoldersFirst&quot;);</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineminus">-  sortFoldersFirst.checked = sortBy.value == &quot;Name&quot;;</span>
<a href="#l14.55"></a><span id="l14.55" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1">deleted file mode 100644</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineminus">--- a/suite/common/bookmarks/sortFolder.xul</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineplus">+++ /dev/null</span>
<a href="#l15.4"></a><span id="l15.4" class="difflineat">@@ -1,116 +0,0 @@</span>
<a href="#l15.5"></a><span id="l15.5" class="difflineminus">-&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<a href="#l15.6"></a><span id="l15.6" class="difflineminus">-</span>
<a href="#l15.7"></a><span id="l15.7" class="difflineminus">-&lt;!-- ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l15.8"></a><span id="l15.8" class="difflineminus">-   - Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l15.9"></a><span id="l15.9" class="difflineminus">-   -</span>
<a href="#l15.10"></a><span id="l15.10" class="difflineminus">-   - The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l15.11"></a><span id="l15.11" class="difflineminus">-   - 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-   - the License. You may obtain a copy of the License at</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">-   - http://www.mozilla.org/MPL/</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineminus">-   -</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineminus">-   - Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineminus">-   - WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineminus">-   - for the specific language governing rights and limitations under the</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineminus">-   - License.</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineminus">-   -</span>
<a href="#l15.20"></a><span id="l15.20" class="difflineminus">-   - The Original Code is mozilla.org code.</span>
<a href="#l15.21"></a><span id="l15.21" class="difflineminus">-   -</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineminus">-   - The Initial Developer of the Original Code is</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineminus">-   - Netscape Communications Corp.</span>
<a href="#l15.24"></a><span id="l15.24" class="difflineminus">-   - Portions created by the Initial Developer are Copyright (C) 2003</span>
<a href="#l15.25"></a><span id="l15.25" class="difflineminus">-   - the Initial Developer. All Rights Reserved.</span>
<a href="#l15.26"></a><span id="l15.26" class="difflineminus">-   -</span>
<a href="#l15.27"></a><span id="l15.27" class="difflineminus">-   - Contributor(s):</span>
<a href="#l15.28"></a><span id="l15.28" class="difflineminus">-   -   Jan Varga &lt;varga@ku.sk&gt;</span>
<a href="#l15.29"></a><span id="l15.29" class="difflineminus">-   -</span>
<a href="#l15.30"></a><span id="l15.30" class="difflineminus">-   - Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineminus">-   - either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineminus">-   - the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l15.33"></a><span id="l15.33" class="difflineminus">-   - in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l15.34"></a><span id="l15.34" class="difflineminus">-   - of those above. If you wish to allow use of your version of this file only</span>
<a href="#l15.35"></a><span id="l15.35" class="difflineminus">-   - under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineminus">-   - use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineminus">-   - decision by deleting the provisions above and replace them with the notice</span>
<a href="#l15.38"></a><span id="l15.38" class="difflineminus">-   - and other provisions required by the LGPL or the GPL. If you do not delete</span>
<a href="#l15.39"></a><span id="l15.39" class="difflineminus">-   - the provisions above, a recipient may use your version of this file under</span>
<a href="#l15.40"></a><span id="l15.40" class="difflineminus">-   - the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l15.41"></a><span id="l15.41" class="difflineminus">-   -</span>
<a href="#l15.42"></a><span id="l15.42" class="difflineminus">-   - ***** END LICENSE BLOCK ***** --&gt;</span>
<a href="#l15.43"></a><span id="l15.43" class="difflineminus">-</span>
<a href="#l15.44"></a><span id="l15.44" class="difflineminus">-&lt;?xml-stylesheet href=&quot;chrome://global/skin/&quot; type=&quot;text/css&quot;?&gt;</span>
<a href="#l15.45"></a><span id="l15.45" class="difflineminus">-</span>
<a href="#l15.46"></a><span id="l15.46" class="difflineminus">-&lt;!DOCTYPE dialog [</span>
<a href="#l15.47"></a><span id="l15.47" class="difflineminus">-&lt;!ENTITY % brandDTD SYSTEM &quot;chrome://branding/locale/brand.dtd&quot; &gt;</span>
<a href="#l15.48"></a><span id="l15.48" class="difflineminus">-%brandDTD;</span>
<a href="#l15.49"></a><span id="l15.49" class="difflineminus">-&lt;!ENTITY % sortFolderDTD SYSTEM &quot;chrome://communicator/locale/bookmarks/sortFolder.dtd&quot;&gt;</span>
<a href="#l15.50"></a><span id="l15.50" class="difflineminus">-%sortFolderDTD;</span>
<a href="#l15.51"></a><span id="l15.51" class="difflineminus">-]&gt;</span>
<a href="#l15.52"></a><span id="l15.52" class="difflineminus">-</span>
<a href="#l15.53"></a><span id="l15.53" class="difflineminus">-&lt;dialog id=&quot;sortFolder&quot;</span>
<a href="#l15.54"></a><span id="l15.54" class="difflineminus">-        xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;</span>
<a href="#l15.55"></a><span id="l15.55" class="difflineminus">-        title=&quot;&amp;window.title;&quot;</span>
<a href="#l15.56"></a><span id="l15.56" class="difflineminus">-        style=&quot;width: 30em;&quot;</span>
<a href="#l15.57"></a><span id="l15.57" class="difflineminus">-        buttons=&quot;accept,cancel&quot;</span>
<a href="#l15.58"></a><span id="l15.58" class="difflineminus">-	ondialogaccept=&quot;return onAccept();&quot;&gt;</span>
<a href="#l15.59"></a><span id="l15.59" class="difflineminus">-</span>
<a href="#l15.60"></a><span id="l15.60" class="difflineminus">-  &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://communicator/content/bookmarks/sortFolder.js&quot;/&gt;</span>
<a href="#l15.61"></a><span id="l15.61" class="difflineminus">-</span>
<a href="#l15.62"></a><span id="l15.62" class="difflineminus">-  &lt;tabbox&gt;</span>
<a href="#l15.63"></a><span id="l15.63" class="difflineminus">-    &lt;tabs&gt;</span>
<a href="#l15.64"></a><span id="l15.64" class="difflineminus">-      &lt;tab label=&quot;&amp;sortOptions.label;&quot;/&gt;</span>
<a href="#l15.65"></a><span id="l15.65" class="difflineminus">-    &lt;/tabs&gt;</span>
<a href="#l15.66"></a><span id="l15.66" class="difflineminus">-    &lt;tabpanels&gt;</span>
<a href="#l15.67"></a><span id="l15.67" class="difflineminus">-      &lt;vbox&gt;</span>
<a href="#l15.68"></a><span id="l15.68" class="difflineminus">-        &lt;separator class=&quot;thin&quot;/&gt;</span>
<a href="#l15.69"></a><span id="l15.69" class="difflineminus">-        &lt;hbox align=&quot;start&quot;&gt;</span>
<a href="#l15.70"></a><span id="l15.70" class="difflineminus">-          &lt;image class=&quot;message-icon&quot;/&gt;</span>
<a href="#l15.71"></a><span id="l15.71" class="difflineminus">-          &lt;separator class=&quot;thin&quot; orient=&quot;vertical&quot;/&gt;</span>
<a href="#l15.72"></a><span id="l15.72" class="difflineminus">-          &lt;description flex=&quot;1&quot;&gt;</span>
<a href="#l15.73"></a><span id="l15.73" class="difflineminus">-            &amp;description.label;</span>
<a href="#l15.74"></a><span id="l15.74" class="difflineminus">-          &lt;/description&gt;</span>
<a href="#l15.75"></a><span id="l15.75" class="difflineminus">-        &lt;/hbox&gt;</span>
<a href="#l15.76"></a><span id="l15.76" class="difflineminus">-        &lt;separator class=&quot;thin&quot;/&gt;</span>
<a href="#l15.77"></a><span id="l15.77" class="difflineminus">-        &lt;grid&gt;</span>
<a href="#l15.78"></a><span id="l15.78" class="difflineminus">-          &lt;columns&gt;</span>
<a href="#l15.79"></a><span id="l15.79" class="difflineminus">-            &lt;column/&gt;</span>
<a href="#l15.80"></a><span id="l15.80" class="difflineminus">-            &lt;column flex=&quot;1&quot;/&gt;</span>
<a href="#l15.81"></a><span id="l15.81" class="difflineminus">-          &lt;/columns&gt;</span>
<a href="#l15.82"></a><span id="l15.82" class="difflineminus">-          &lt;rows&gt;</span>
<a href="#l15.83"></a><span id="l15.83" class="difflineminus">-            &lt;row align=&quot;center&quot;&gt;</span>
<a href="#l15.84"></a><span id="l15.84" class="difflineminus">-              &lt;label value=&quot;&amp;sortBy.label;&quot; control=&quot;sortBy&quot;</span>
<a href="#l15.85"></a><span id="l15.85" class="difflineminus">-                     accesskey=&quot;&amp;sortBy.accesskey;&quot;/&gt;</span>
<a href="#l15.86"></a><span id="l15.86" class="difflineminus">-              &lt;menulist id=&quot;sortBy&quot; oncommand=&quot;onSortByChanged()&quot;&gt;</span>
<a href="#l15.87"></a><span id="l15.87" class="difflineminus">-                &lt;menupopup&gt;</span>
<a href="#l15.88"></a><span id="l15.88" class="difflineminus">-                  &lt;menuitem value=&quot;Name&quot; label=&quot;&amp;sortBy.name.label;&quot;/&gt;</span>
<a href="#l15.89"></a><span id="l15.89" class="difflineminus">-                  &lt;menuitem value=&quot;URL&quot; label=&quot;&amp;sortBy.url.label;&quot;/&gt;</span>
<a href="#l15.90"></a><span id="l15.90" class="difflineminus">-                  &lt;menuitem value=&quot;ShortcutURL&quot; label=&quot;&amp;sortBy.shortcutUrl.label;&quot;/&gt;</span>
<a href="#l15.91"></a><span id="l15.91" class="difflineminus">-                  &lt;menuitem value=&quot;Description&quot; label=&quot;&amp;sortBy.description.label;&quot;/&gt;</span>
<a href="#l15.92"></a><span id="l15.92" class="difflineminus">-                  &lt;menuitem value=&quot;BookmarkAddDate&quot; label=&quot;&amp;sortBy.bookmarkAddDate.label;&quot;/&gt;</span>
<a href="#l15.93"></a><span id="l15.93" class="difflineminus">-                  &lt;menuitem value=&quot;LastModifiedDate&quot; label=&quot;&amp;sortBy.lastModifiedDate.label;&quot;/&gt;</span>
<a href="#l15.94"></a><span id="l15.94" class="difflineminus">-                  &lt;menuitem value=&quot;LastVisitDate&quot; label=&quot;&amp;sortBy.lastVisitDate.label;&quot;/&gt;</span>
<a href="#l15.95"></a><span id="l15.95" class="difflineminus">-                &lt;/menupopup&gt;</span>
<a href="#l15.96"></a><span id="l15.96" class="difflineminus">-              &lt;/menulist&gt;</span>
<a href="#l15.97"></a><span id="l15.97" class="difflineminus">-            &lt;/row&gt;</span>
<a href="#l15.98"></a><span id="l15.98" class="difflineminus">-            &lt;row align=&quot;center&quot;&gt;</span>
<a href="#l15.99"></a><span id="l15.99" class="difflineminus">-              &lt;label value=&quot;&amp;sortOrder.label;&quot; control=&quot;sortOrder&quot;</span>
<a href="#l15.100"></a><span id="l15.100" class="difflineminus">-                     accesskey=&quot;&amp;sortOrder.accesskey;&quot;/&gt;</span>
<a href="#l15.101"></a><span id="l15.101" class="difflineminus">-              &lt;menulist id=&quot;sortOrder&quot;&gt;</span>
<a href="#l15.102"></a><span id="l15.102" class="difflineminus">-                &lt;menupopup&gt;</span>
<a href="#l15.103"></a><span id="l15.103" class="difflineminus">-                  &lt;menuitem value=&quot;ascending&quot; label=&quot;&amp;sortAscending.label;&quot;/&gt;</span>
<a href="#l15.104"></a><span id="l15.104" class="difflineminus">-                  &lt;menuitem value=&quot;descending&quot; label=&quot;&amp;sortDescending.label;&quot;/&gt;</span>
<a href="#l15.105"></a><span id="l15.105" class="difflineminus">-                &lt;/menupopup&gt;</span>
<a href="#l15.106"></a><span id="l15.106" class="difflineminus">-              &lt;/menulist&gt;</span>
<a href="#l15.107"></a><span id="l15.107" class="difflineminus">-            &lt;/row&gt;</span>
<a href="#l15.108"></a><span id="l15.108" class="difflineminus">-          &lt;/rows&gt;</span>
<a href="#l15.109"></a><span id="l15.109" class="difflineminus">-        &lt;/grid&gt;</span>
<a href="#l15.110"></a><span id="l15.110" class="difflineminus">-        &lt;separator class=&quot;thin&quot;/&gt;</span>
<a href="#l15.111"></a><span id="l15.111" class="difflineminus">-        &lt;checkbox id=&quot;sortFoldersFirst&quot; label=&quot;&amp;sortFoldersFirst.label;&quot;</span>
<a href="#l15.112"></a><span id="l15.112" class="difflineminus">-                  checked=&quot;true&quot; accesskey=&quot;&amp;sortFoldersFirst.accesskey;&quot;/&gt;</span>
<a href="#l15.113"></a><span id="l15.113" class="difflineminus">-        &lt;checkbox id=&quot;sortRecursively&quot; label=&quot;&amp;sortRecursively.label;&quot;</span>
<a href="#l15.114"></a><span id="l15.114" class="difflineminus">-                  accesskey=&quot;&amp;sortRecursively.accesskey;&quot;/&gt;</span>
<a href="#l15.115"></a><span id="l15.115" class="difflineminus">-        &lt;separator class=&quot;thin&quot;/&gt;</span>
<a href="#l15.116"></a><span id="l15.116" class="difflineminus">-      &lt;/vbox&gt;</span>
<a href="#l15.117"></a><span id="l15.117" class="difflineminus">-    &lt;/tabpanels&gt;</span>
<a href="#l15.118"></a><span id="l15.118" class="difflineminus">-  &lt;/tabbox&gt; </span>
<a href="#l15.119"></a><span id="l15.119" class="difflineminus">-  </span>
<a href="#l15.120"></a><span id="l15.120" class="difflineminus">-&lt;/dialog&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1">deleted file mode 100644</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineminus">--- a/suite/locales/en-US/chrome/common/bookmarks/addBookmark.dtd</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineplus">+++ /dev/null</span>
<a href="#l16.4"></a><span id="l16.4" class="difflineat">@@ -1,50 +0,0 @@</span>
<a href="#l16.5"></a><span id="l16.5" class="difflineminus">-&lt;!-- ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l16.6"></a><span id="l16.6" class="difflineminus">-   - Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l16.7"></a><span id="l16.7" class="difflineminus">-   -</span>
<a href="#l16.8"></a><span id="l16.8" class="difflineminus">-   - The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l16.9"></a><span id="l16.9" class="difflineminus">-   - 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l16.10"></a><span id="l16.10" class="difflineminus">-   - the License. You may obtain a copy of the License at</span>
<a href="#l16.11"></a><span id="l16.11" class="difflineminus">-   - http://www.mozilla.org/MPL/</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-   -</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineminus">-   - Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineminus">-   - WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineminus">-   - for the specific language governing rights and limitations under the</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineminus">-   - License.</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineminus">-   -</span>
<a href="#l16.18"></a><span id="l16.18" class="difflineminus">-   - The Original Code is Mozilla Communicator.</span>
<a href="#l16.19"></a><span id="l16.19" class="difflineminus">-   -</span>
<a href="#l16.20"></a><span id="l16.20" class="difflineminus">-   - The Initial Developer of the Original Code is</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineminus">-   - Netscape Communications Corp.</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineminus">-   - Portions created by the Initial Developer are Copyright (C) 1999</span>
<a href="#l16.23"></a><span id="l16.23" class="difflineminus">-   - the Initial Developer. All Rights Reserved.</span>
<a href="#l16.24"></a><span id="l16.24" class="difflineminus">-   -</span>
<a href="#l16.25"></a><span id="l16.25" class="difflineminus">-   - Contributor(s):</span>
<a href="#l16.26"></a><span id="l16.26" class="difflineminus">-   -   Ben Goodger &lt;ben@netscape.com&gt; (Original Author)</span>
<a href="#l16.27"></a><span id="l16.27" class="difflineminus">-   -</span>
<a href="#l16.28"></a><span id="l16.28" class="difflineminus">-   - Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l16.29"></a><span id="l16.29" class="difflineminus">-   - either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l16.30"></a><span id="l16.30" class="difflineminus">-   - or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l16.31"></a><span id="l16.31" class="difflineminus">-   - in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineminus">-   - of those above. If you wish to allow use of your version of this file only</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineminus">-   - under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l16.34"></a><span id="l16.34" class="difflineminus">-   - use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l16.35"></a><span id="l16.35" class="difflineminus">-   - decision by deleting the provisions above and replace them with the notice</span>
<a href="#l16.36"></a><span id="l16.36" class="difflineminus">-   - and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l16.37"></a><span id="l16.37" class="difflineminus">-   - the provisions above, a recipient may use your version of this file under</span>
<a href="#l16.38"></a><span id="l16.38" class="difflineminus">-   - the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l16.39"></a><span id="l16.39" class="difflineminus">-   -</span>
<a href="#l16.40"></a><span id="l16.40" class="difflineminus">-   - ***** END LICENSE BLOCK ***** --&gt;</span>
<a href="#l16.41"></a><span id="l16.41" class="difflineminus">-  </span>
<a href="#l16.42"></a><span id="l16.42" class="difflineminus">-&lt;!ENTITY newBookmark.title          &quot;File Bookmark&quot;&gt;</span>
<a href="#l16.43"></a><span id="l16.43" class="difflineminus">-&lt;!ENTITY selectFolder.title         &quot;Choose Folder&quot;&gt;</span>
<a href="#l16.44"></a><span id="l16.44" class="difflineminus">-&lt;!ENTITY name.label                 &quot;Name:&quot;&gt;</span>
<a href="#l16.45"></a><span id="l16.45" class="difflineminus">-&lt;!ENTITY name.accesskey             &quot;N&quot;&gt;</span>
<a href="#l16.46"></a><span id="l16.46" class="difflineminus">-&lt;!ENTITY url.label                  &quot;Location:&quot;&gt;</span>
<a href="#l16.47"></a><span id="l16.47" class="difflineminus">-&lt;!ENTITY url.accesskey              &quot;L&quot;&gt;</span>
<a href="#l16.48"></a><span id="l16.48" class="difflineminus">-&lt;!ENTITY shortcutURL.label          &quot;Keyword:&quot;&gt;</span>
<a href="#l16.49"></a><span id="l16.49" class="difflineminus">-&lt;!ENTITY shortcutURL.accesskey      &quot;K&quot;&gt;</span>
<a href="#l16.50"></a><span id="l16.50" class="difflineminus">-&lt;!ENTITY destination.label          &quot;Destination:&quot;&gt;</span>
<a href="#l16.51"></a><span id="l16.51" class="difflineminus">-&lt;!ENTITY newFolder.label            &quot;New Folder…&quot;&gt;</span>
<a href="#l16.52"></a><span id="l16.52" class="difflineminus">-&lt;!ENTITY newFolder.accesskey        &quot;w&quot;&gt;</span>
<a href="#l16.53"></a><span id="l16.53" class="difflineminus">-&lt;!ENTITY addGroup.label             &quot;Bookmark this group of tabs&quot;&gt;</span>
<a href="#l16.54"></a><span id="l16.54" class="difflineminus">-&lt;!ENTITY addGroup.accesskey         &quot;B&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1">deleted file mode 100644</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineminus">--- a/suite/locales/en-US/chrome/common/bookmarks/bm-props.dtd</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineplus">+++ /dev/null</span>
<a href="#l17.4"></a><span id="l17.4" class="difflineat">@@ -1,108 +0,0 @@</span>
<a href="#l17.5"></a><span id="l17.5" class="difflineminus">-&lt;!-- ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l17.6"></a><span id="l17.6" class="difflineminus">-   - Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l17.7"></a><span id="l17.7" class="difflineminus">-   -</span>
<a href="#l17.8"></a><span id="l17.8" class="difflineminus">-   - The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l17.9"></a><span id="l17.9" class="difflineminus">-   - 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l17.10"></a><span id="l17.10" class="difflineminus">-   - the License. You may obtain a copy of the License at</span>
<a href="#l17.11"></a><span id="l17.11" class="difflineminus">-   - http://www.mozilla.org/MPL/</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-   -</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineminus">-   - Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineminus">-   - WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineminus">-   - for the specific language governing rights and limitations under the</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineminus">-   - License.</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineminus">-   -</span>
<a href="#l17.18"></a><span id="l17.18" class="difflineminus">-   - The Original Code is Mozilla Communicator.</span>
<a href="#l17.19"></a><span id="l17.19" class="difflineminus">-   -</span>
<a href="#l17.20"></a><span id="l17.20" class="difflineminus">-   - The Initial Developer of the Original Code is</span>
<a href="#l17.21"></a><span id="l17.21" class="difflineminus">-   - Netscape Communications Corp.</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineminus">-   - Portions created by the Initial Developer are Copyright (C) 1999</span>
<a href="#l17.23"></a><span id="l17.23" class="difflineminus">-   - the Initial Developer. All Rights Reserved.</span>
<a href="#l17.24"></a><span id="l17.24" class="difflineminus">-   -</span>
<a href="#l17.25"></a><span id="l17.25" class="difflineminus">-   - Contributor(s):</span>
<a href="#l17.26"></a><span id="l17.26" class="difflineminus">-   -   Stephen Lamm          &lt;slamm@netscape.com&gt;</span>
<a href="#l17.27"></a><span id="l17.27" class="difflineminus">-   -   Robert John Churchill &lt;rjc@netscape.com&gt;</span>
<a href="#l17.28"></a><span id="l17.28" class="difflineminus">-   -   Ben Goodger           &lt;ben@netscape.com&gt;</span>
<a href="#l17.29"></a><span id="l17.29" class="difflineminus">-   -</span>
<a href="#l17.30"></a><span id="l17.30" class="difflineminus">-   - Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineminus">-   - either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineminus">-   - or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineminus">-   - in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineminus">-   - of those above. If you wish to allow use of your version of this file only</span>
<a href="#l17.35"></a><span id="l17.35" class="difflineminus">-   - under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineminus">-   - use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l17.37"></a><span id="l17.37" class="difflineminus">-   - decision by deleting the provisions above and replace them with the notice</span>
<a href="#l17.38"></a><span id="l17.38" class="difflineminus">-   - and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l17.39"></a><span id="l17.39" class="difflineminus">-   - the provisions above, a recipient may use your version of this file under</span>
<a href="#l17.40"></a><span id="l17.40" class="difflineminus">-   - the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l17.41"></a><span id="l17.41" class="difflineminus">-   -</span>
<a href="#l17.42"></a><span id="l17.42" class="difflineminus">-   - ***** END LICENSE BLOCK ***** --&gt;</span>
<a href="#l17.43"></a><span id="l17.43" class="difflineminus">-</span>
<a href="#l17.44"></a><span id="l17.44" class="difflineminus">-&lt;!ENTITY bookmarks.windowtitle.label  &quot;Properties for &amp;quot;**bm_title**&amp;quot;&quot;&gt;</span>
<a href="#l17.45"></a><span id="l17.45" class="difflineminus">-</span>
<a href="#l17.46"></a><span id="l17.46" class="difflineminus">-&lt;!ENTITY generalInfo.label            &quot;General&quot;&gt;</span>
<a href="#l17.47"></a><span id="l17.47" class="difflineminus">-&lt;!ENTITY bookmarks.name.label         &quot;Name:&quot;&gt;</span>
<a href="#l17.48"></a><span id="l17.48" class="difflineminus">-&lt;!ENTITY bookmarks.name.accesskey     &quot;N&quot;&gt;</span>
<a href="#l17.49"></a><span id="l17.49" class="difflineminus">-&lt;!ENTITY bookmarks.location.label     &quot;Location:&quot;&gt;</span>
<a href="#l17.50"></a><span id="l17.50" class="difflineminus">-&lt;!ENTITY bookmarks.location.accesskey &quot;L&quot;&gt;</span>
<a href="#l17.51"></a><span id="l17.51" class="difflineminus">-&lt;!ENTITY bookmarks.shortcut.label     &quot;Keyword:&quot;&gt;</span>
<a href="#l17.52"></a><span id="l17.52" class="difflineminus">-&lt;!ENTITY bookmarks.shortcut.accesskey &quot;K&quot;&gt;</span>
<a href="#l17.53"></a><span id="l17.53" class="difflineminus">-&lt;!ENTITY bookmarks.description.label  &quot;Description:&quot;&gt;</span>
<a href="#l17.54"></a><span id="l17.54" class="difflineminus">-&lt;!ENTITY bookmarks.description.accesskey &quot;D&quot;&gt;</span>
<a href="#l17.55"></a><span id="l17.55" class="difflineminus">-</span>
<a href="#l17.56"></a><span id="l17.56" class="difflineminus">-&lt;!ENTITY checkforupdates.legend.label &quot;Check this location for updates&quot;&gt;</span>
<a href="#l17.57"></a><span id="l17.57" class="difflineminus">-&lt;!ENTITY when.label                   &quot;When:&quot;&gt;</span>
<a href="#l17.58"></a><span id="l17.58" class="difflineminus">-&lt;!ENTITY when.accesskey               &quot;W&quot;&gt;</span>
<a href="#l17.59"></a><span id="l17.59" class="difflineminus">-&lt;!ENTITY from.label                   &quot;from:&quot;&gt;</span>
<a href="#l17.60"></a><span id="l17.60" class="difflineminus">-&lt;!ENTITY from.accesskey               &quot;f&quot;&gt;</span>
<a href="#l17.61"></a><span id="l17.61" class="difflineminus">-&lt;!ENTITY to.label                     &quot;to: &quot;&gt;</span>
<a href="#l17.62"></a><span id="l17.62" class="difflineminus">-&lt;!ENTITY to.accesskey                 &quot;t&quot;&gt;</span>
<a href="#l17.63"></a><span id="l17.63" class="difflineminus">-&lt;!ENTITY every.label                  &quot;every&quot;&gt;</span>
<a href="#l17.64"></a><span id="l17.64" class="difflineminus">-&lt;!ENTITY every.accesskey              &quot;e&quot;&gt;</span>
<a href="#l17.65"></a><span id="l17.65" class="difflineminus">-&lt;!ENTITY minutes.label                &quot;minute(s)&quot;&gt;</span>
<a href="#l17.66"></a><span id="l17.66" class="difflineminus">-&lt;!ENTITY notifications.legend.label   &quot;Notification&quot;&gt;</span>
<a href="#l17.67"></a><span id="l17.67" class="difflineminus">-</span>
<a href="#l17.68"></a><span id="l17.68" class="difflineminus">-&lt;!ENTITY checknever.label             &quot;Never&quot;&gt;</span>
<a href="#l17.69"></a><span id="l17.69" class="difflineminus">-&lt;!ENTITY checkeveryday.label          &quot;Every day&quot;&gt;</span>
<a href="#l17.70"></a><span id="l17.70" class="difflineminus">-&lt;!ENTITY checkweekdays.label          &quot;Weekdays&quot;&gt;</span>
<a href="#l17.71"></a><span id="l17.71" class="difflineminus">-&lt;!ENTITY checkweekends.label          &quot;Weekends&quot;&gt;</span>
<a href="#l17.72"></a><span id="l17.72" class="difflineminus">-&lt;!ENTITY checkmondays.label           &quot;Mondays&quot;&gt;</span>
<a href="#l17.73"></a><span id="l17.73" class="difflineminus">-&lt;!ENTITY checktuesdays.label          &quot;Tuesdays&quot;&gt;</span>
<a href="#l17.74"></a><span id="l17.74" class="difflineminus">-&lt;!ENTITY checkwednesdays.label        &quot;Wednesdays&quot;&gt;</span>
<a href="#l17.75"></a><span id="l17.75" class="difflineminus">-&lt;!ENTITY checkthursdays.label         &quot;Thursdays&quot;&gt;</span>
<a href="#l17.76"></a><span id="l17.76" class="difflineminus">-&lt;!ENTITY checkfridays.label           &quot;Fridays&quot;&gt;</span>
<a href="#l17.77"></a><span id="l17.77" class="difflineminus">-&lt;!ENTITY checksaturdays.label         &quot;Saturdays&quot;&gt;</span>
<a href="#l17.78"></a><span id="l17.78" class="difflineminus">-&lt;!ENTITY checksundays.label           &quot;Sundays&quot;&gt;</span>
<a href="#l17.79"></a><span id="l17.79" class="difflineminus">-</span>
<a href="#l17.80"></a><span id="l17.80" class="difflineminus">-&lt;!ENTITY midnight.label               &quot;Midnight&quot;&gt;</span>
<a href="#l17.81"></a><span id="l17.81" class="difflineminus">-&lt;!ENTITY AMone.label                  &quot;1 AM&quot;&gt;</span>
<a href="#l17.82"></a><span id="l17.82" class="difflineminus">-&lt;!ENTITY AMtwo.label                  &quot;2 AM&quot;&gt;</span>
<a href="#l17.83"></a><span id="l17.83" class="difflineminus">-&lt;!ENTITY AMthree.label                &quot;3 AM&quot;&gt;</span>
<a href="#l17.84"></a><span id="l17.84" class="difflineminus">-&lt;!ENTITY AMfour.label                 &quot;4 AM&quot;&gt;</span>
<a href="#l17.85"></a><span id="l17.85" class="difflineminus">-&lt;!ENTITY AMfive.label                 &quot;5 AM&quot;&gt;</span>
<a href="#l17.86"></a><span id="l17.86" class="difflineminus">-&lt;!ENTITY AMsix.label                  &quot;6 AM&quot;&gt;</span>
<a href="#l17.87"></a><span id="l17.87" class="difflineminus">-&lt;!ENTITY AMseven.label                &quot;7 AM&quot;&gt;</span>
<a href="#l17.88"></a><span id="l17.88" class="difflineminus">-&lt;!ENTITY AMeight.label                &quot;8 AM&quot;&gt;</span>
<a href="#l17.89"></a><span id="l17.89" class="difflineminus">-&lt;!ENTITY AMnine.label                 &quot;9 AM&quot;&gt;</span>
<a href="#l17.90"></a><span id="l17.90" class="difflineminus">-&lt;!ENTITY AMten.label                  &quot;10 AM&quot;&gt;</span>
<a href="#l17.91"></a><span id="l17.91" class="difflineminus">-&lt;!ENTITY AMeleven.label               &quot;11 AM&quot;&gt;</span>
<a href="#l17.92"></a><span id="l17.92" class="difflineminus">-&lt;!ENTITY noon.label                   &quot;Noon&quot;&gt;</span>
<a href="#l17.93"></a><span id="l17.93" class="difflineminus">-&lt;!ENTITY PMone.label                  &quot;1 PM&quot;&gt;</span>
<a href="#l17.94"></a><span id="l17.94" class="difflineminus">-&lt;!ENTITY PMtwo.label                  &quot;2 PM&quot;&gt;</span>
<a href="#l17.95"></a><span id="l17.95" class="difflineminus">-&lt;!ENTITY PMthree.label                &quot;3 PM&quot;&gt;</span>
<a href="#l17.96"></a><span id="l17.96" class="difflineminus">-&lt;!ENTITY PMfour.label                 &quot;4 PM&quot;&gt;</span>
<a href="#l17.97"></a><span id="l17.97" class="difflineminus">-&lt;!ENTITY PMfive.label                 &quot;5 PM&quot;&gt;</span>
<a href="#l17.98"></a><span id="l17.98" class="difflineminus">-&lt;!ENTITY PMsix.label                  &quot;6 PM&quot;&gt;</span>
<a href="#l17.99"></a><span id="l17.99" class="difflineminus">-&lt;!ENTITY PMseven.label                &quot;7 PM&quot;&gt;</span>
<a href="#l17.100"></a><span id="l17.100" class="difflineminus">-&lt;!ENTITY PMeight.label                &quot;8 PM&quot;&gt;</span>
<a href="#l17.101"></a><span id="l17.101" class="difflineminus">-&lt;!ENTITY PMnine.label                 &quot;9 PM&quot;&gt;</span>
<a href="#l17.102"></a><span id="l17.102" class="difflineminus">-&lt;!ENTITY PMten.label                  &quot;10 PM&quot;&gt;</span>
<a href="#l17.103"></a><span id="l17.103" class="difflineminus">-&lt;!ENTITY PMeleven.label               &quot;11 PM&quot;&gt;</span>
<a href="#l17.104"></a><span id="l17.104" class="difflineminus">-</span>
<a href="#l17.105"></a><span id="l17.105" class="difflineminus">-&lt;!ENTITY notification.icon.label      &quot;Change the bookmark's icon&quot;&gt;</span>
<a href="#l17.106"></a><span id="l17.106" class="difflineminus">-&lt;!ENTITY notification.icon.accesskey  &quot;C&quot;&gt;</span>
<a href="#l17.107"></a><span id="l17.107" class="difflineminus">-&lt;!ENTITY notification.sound.label     &quot;Play a sound&quot;&gt;</span>
<a href="#l17.108"></a><span id="l17.108" class="difflineminus">-&lt;!ENTITY notification.sound.accesskey &quot;P&quot;&gt;</span>
<a href="#l17.109"></a><span id="l17.109" class="difflineminus">-&lt;!ENTITY notification.alert.label     &quot;Display an alert&quot;&gt;</span>
<a href="#l17.110"></a><span id="l17.110" class="difflineminus">-&lt;!ENTITY notification.alert.accesskey &quot;r&quot;&gt;</span>
<a href="#l17.111"></a><span id="l17.111" class="difflineminus">-&lt;!ENTITY notification.window.label    &quot;Open web page in a new window&quot;&gt;</span>
<a href="#l17.112"></a><span id="l17.112" class="difflineminus">-&lt;!ENTITY notification.window.accesskey &quot;O&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1">deleted file mode 100644</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineminus">--- a/suite/locales/en-US/chrome/common/bookmarks/bookmarks.dtd</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineplus">+++ /dev/null</span>
<a href="#l18.4"></a><span id="l18.4" class="difflineat">@@ -1,120 +0,0 @@</span>
<a href="#l18.5"></a><span id="l18.5" class="difflineminus">-&lt;!-- ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l18.6"></a><span id="l18.6" class="difflineminus">-   - Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l18.7"></a><span id="l18.7" class="difflineminus">-   -</span>
<a href="#l18.8"></a><span id="l18.8" class="difflineminus">-   - The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l18.9"></a><span id="l18.9" class="difflineminus">-   - 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l18.10"></a><span id="l18.10" class="difflineminus">-   - the License. You may obtain a copy of the License at</span>
<a href="#l18.11"></a><span id="l18.11" class="difflineminus">-   - http://www.mozilla.org/MPL/</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-   -</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineminus">-   - Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineminus">-   - WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineminus">-   - for the specific language governing rights and limitations under the</span>
<a href="#l18.16"></a><span id="l18.16" class="difflineminus">-   - License.</span>
<a href="#l18.17"></a><span id="l18.17" class="difflineminus">-   -</span>
<a href="#l18.18"></a><span id="l18.18" class="difflineminus">-   - The Original Code is Mozilla Communicator.</span>
<a href="#l18.19"></a><span id="l18.19" class="difflineminus">-   -</span>
<a href="#l18.20"></a><span id="l18.20" class="difflineminus">-   - The Initial Developer of the Original Code is</span>
<a href="#l18.21"></a><span id="l18.21" class="difflineminus">-   - Netscape Communications Corp.</span>
<a href="#l18.22"></a><span id="l18.22" class="difflineminus">-   - Portions created by the Initial Developer are Copyright (C) 1999</span>
<a href="#l18.23"></a><span id="l18.23" class="difflineminus">-   - the Initial Developer. All Rights Reserved.</span>
<a href="#l18.24"></a><span id="l18.24" class="difflineminus">-   -</span>
<a href="#l18.25"></a><span id="l18.25" class="difflineminus">-   - Contributor(s):</span>
<a href="#l18.26"></a><span id="l18.26" class="difflineminus">-   -   Stephen Lamm &lt;slamm@netscape.com&gt;</span>
<a href="#l18.27"></a><span id="l18.27" class="difflineminus">-   -   Blake Ross &lt;blakeross@telocity.com&gt;</span>
<a href="#l18.28"></a><span id="l18.28" class="difflineminus">-   -   Mike Kowalski &lt;mikejk@ameritech.net&gt;</span>
<a href="#l18.29"></a><span id="l18.29" class="difflineminus">-   -</span>
<a href="#l18.30"></a><span id="l18.30" class="difflineminus">-   - Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineminus">-   - either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l18.32"></a><span id="l18.32" class="difflineminus">-   - or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l18.33"></a><span id="l18.33" class="difflineminus">-   - in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l18.34"></a><span id="l18.34" class="difflineminus">-   - of those above. If you wish to allow use of your version of this file only</span>
<a href="#l18.35"></a><span id="l18.35" class="difflineminus">-   - under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l18.36"></a><span id="l18.36" class="difflineminus">-   - use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l18.37"></a><span id="l18.37" class="difflineminus">-   - decision by deleting the provisions above and replace them with the notice</span>
<a href="#l18.38"></a><span id="l18.38" class="difflineminus">-   - and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l18.39"></a><span id="l18.39" class="difflineminus">-   - the provisions above, a recipient may use your version of this file under</span>
<a href="#l18.40"></a><span id="l18.40" class="difflineminus">-   - the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l18.41"></a><span id="l18.41" class="difflineminus">-   -</span>
<a href="#l18.42"></a><span id="l18.42" class="difflineminus">-   - ***** END LICENSE BLOCK ***** --&gt;</span>
<a href="#l18.43"></a><span id="l18.43" class="difflineminus">-</span>
<a href="#l18.44"></a><span id="l18.44" class="difflineminus">-&lt;!-- extracted from ./bookmarks.xul --&gt;</span>
<a href="#l18.45"></a><span id="l18.45" class="difflineminus">-&lt;!ENTITY menuBar.tooltip               &quot;Menu Bar&quot;&gt;</span>
<a href="#l18.46"></a><span id="l18.46" class="difflineminus">-&lt;!ENTITY bookmarkToolbar.tooltip       &quot;Bookmark Toolbar&quot;&gt;</span>
<a href="#l18.47"></a><span id="l18.47" class="difflineminus">-&lt;!ENTITY menuitem.newBookmark.label    &quot;Bookmark&quot;&gt;</span>
<a href="#l18.48"></a><span id="l18.48" class="difflineminus">-&lt;!ENTITY menuitem.newBookmark.accesskey &quot;B&quot;&gt;</span>
<a href="#l18.49"></a><span id="l18.49" class="difflineminus">-&lt;!ENTITY menuitem.newFolder.label      &quot;Folder&quot;&gt;</span>
<a href="#l18.50"></a><span id="l18.50" class="difflineminus">-&lt;!ENTITY menuitem.newFolder.accesskey  &quot;F&quot;&gt;</span>
<a href="#l18.51"></a><span id="l18.51" class="difflineminus">-&lt;!ENTITY button.newFolder.label        &quot;New Folder&quot;&gt;</span>
<a href="#l18.52"></a><span id="l18.52" class="difflineminus">-&lt;!ENTITY button.newFolder.accesskey    &quot;N&quot;&gt;</span>
<a href="#l18.53"></a><span id="l18.53" class="difflineminus">-&lt;!ENTITY menuitem.newSeparator.label   &quot;Separator&quot;&gt;</span>
<a href="#l18.54"></a><span id="l18.54" class="difflineminus">-&lt;!ENTITY menuitem.newSeparator.accesskey &quot;S&quot;&gt;</span>
<a href="#l18.55"></a><span id="l18.55" class="difflineminus">-&lt;!ENTITY button.newSeparator.label     &quot;New Separator&quot;&gt;</span>
<a href="#l18.56"></a><span id="l18.56" class="difflineminus">-&lt;!ENTITY button.newSeparator.accesskey &quot;o&quot;&gt;</span>
<a href="#l18.57"></a><span id="l18.57" class="difflineminus">-&lt;!ENTITY menuitem.open.label           &quot;Open Bookmarks File…&quot;&gt;</span>
<a href="#l18.58"></a><span id="l18.58" class="difflineminus">-&lt;!ENTITY menuitem.open.accesskey       &quot;O&quot;&gt;</span>
<a href="#l18.59"></a><span id="l18.59" class="difflineminus">-&lt;!ENTITY menuitem.import.label         &quot;Import…&quot;&gt;</span>
<a href="#l18.60"></a><span id="l18.60" class="difflineminus">-&lt;!ENTITY menuitem.import.accesskey     &quot;i&quot;&gt;</span>
<a href="#l18.61"></a><span id="l18.61" class="difflineminus">-&lt;!ENTITY menuitem.export.label         &quot;Export…&quot;&gt;</span>
<a href="#l18.62"></a><span id="l18.62" class="difflineminus">-&lt;!ENTITY menuitem.export.accesskey     &quot;e&quot;&gt;</span>
<a href="#l18.63"></a><span id="l18.63" class="difflineminus">-&lt;!ENTITY menuitem.find.label           &quot;Search Bookmarks…&quot;&gt;</span>
<a href="#l18.64"></a><span id="l18.64" class="difflineminus">-&lt;!ENTITY menuitem.find.accesskey       &quot;S&quot;&gt;</span>
<a href="#l18.65"></a><span id="l18.65" class="difflineminus">-&lt;!ENTITY menuitem.find.find.key        &quot;F&quot;&gt;</span>
<a href="#l18.66"></a><span id="l18.66" class="difflineminus">-&lt;!ENTITY command.findBookmarks.label   &quot;Search…&quot;&gt;</span>
<a href="#l18.67"></a><span id="l18.67" class="difflineminus">-&lt;!ENTITY menuitem.properties.label     &quot;Properties…&quot;&gt;</span>
<a href="#l18.68"></a><span id="l18.68" class="difflineminus">-&lt;!ENTITY menuitem.properties.accesskey &quot;o&quot;&gt;</span>
<a href="#l18.69"></a><span id="l18.69" class="difflineminus">-&lt;!ENTITY button.properties.label       &quot;Properties…&quot;&gt;</span>
<a href="#l18.70"></a><span id="l18.70" class="difflineminus">-&lt;!ENTITY button.properties.accesskey   &quot;P&quot;&gt;</span>
<a href="#l18.71"></a><span id="l18.71" class="difflineminus">-&lt;!ENTITY menuitem.properties.key       &quot;I&quot;&gt;</span>
<a href="#l18.72"></a><span id="l18.72" class="difflineminus">-&lt;!ENTITY button.rename.label           &quot;Rename…&quot;&gt;</span>
<a href="#l18.73"></a><span id="l18.73" class="difflineminus">-&lt;!ENTITY button.rename.accesskey       &quot;R&quot;&gt;</span>
<a href="#l18.74"></a><span id="l18.74" class="difflineminus">-&lt;!ENTITY button.delete.label           &quot;Delete&quot;&gt;</span>
<a href="#l18.75"></a><span id="l18.75" class="difflineminus">-&lt;!ENTITY button.delete.accesskey       &quot;D&quot;&gt;</span>
<a href="#l18.76"></a><span id="l18.76" class="difflineminus">-&lt;!ENTITY menuitem.moveBookmark.label   &quot;Move Bookmark(s)…&quot;&gt;</span>
<a href="#l18.77"></a><span id="l18.77" class="difflineminus">-&lt;!ENTITY menuitem.moveBookmark.accesskey &quot;M&quot;&gt;</span>
<a href="#l18.78"></a><span id="l18.78" class="difflineminus">-&lt;!ENTITY button.moveBookmark.label     &quot;Move…&quot;&gt;</span>
<a href="#l18.79"></a><span id="l18.79" class="difflineminus">-&lt;!ENTITY button.moveBookmark.accesskey &quot;M&quot;&gt;</span>
<a href="#l18.80"></a><span id="l18.80" class="difflineminus">-&lt;!ENTITY command.addBookmark.label     &quot;Add…&quot;&gt;</span>
<a href="#l18.81"></a><span id="l18.81" class="difflineminus">-&lt;!ENTITY command.manageBookmarks.label &quot;Manage&quot;&gt;</span>
<a href="#l18.82"></a><span id="l18.82" class="difflineminus">-&lt;!ENTITY command.sortFolder.label      &quot;Sort Folder…&quot;&gt;</span>
<a href="#l18.83"></a><span id="l18.83" class="difflineminus">-&lt;!ENTITY command.sortFolder.accesskey  &quot;S&quot;&gt;</span>
<a href="#l18.84"></a><span id="l18.84" class="difflineminus">-&lt;!ENTITY command.sortFolder.key        &quot;S&quot;&gt;</span>
<a href="#l18.85"></a><span id="l18.85" class="difflineminus">-&lt;!ENTITY command.sortFolderByName.label &quot;Sort Folder by Name&quot;&gt;</span>
<a href="#l18.86"></a><span id="l18.86" class="difflineminus">-&lt;!ENTITY command.sortFolderByName.accesskey &quot;N&quot;&gt;</span>
<a href="#l18.87"></a><span id="l18.87" class="difflineminus">-</span>
<a href="#l18.88"></a><span id="l18.88" class="difflineminus">-&lt;!ENTITY menuitem.view.command.toolbar.label        &quot;Toolbar&quot;&gt;</span>
<a href="#l18.89"></a><span id="l18.89" class="difflineminus">-&lt;!ENTITY menuitem.view.command.toolbar.accesskey    &quot;t&quot;&gt;</span>
<a href="#l18.90"></a><span id="l18.90" class="difflineminus">-&lt;!ENTITY menuitem.view.show_columns.label           &quot;Show columns&quot;&gt;</span>
<a href="#l18.91"></a><span id="l18.91" class="difflineminus">-&lt;!ENTITY menuitem.view.show_columns.accesskey       &quot;c&quot;&gt;</span>
<a href="#l18.92"></a><span id="l18.92" class="difflineminus">-&lt;!ENTITY menuitem.newbookmarkfolder.label           &quot;Set as New Bookmark Folder&quot;&gt;</span>
<a href="#l18.93"></a><span id="l18.93" class="difflineminus">-&lt;!ENTITY menuitem.newbookmarkfolder.accesskey       &quot;b&quot;&gt;</span>
<a href="#l18.94"></a><span id="l18.94" class="difflineminus">-&lt;!ENTITY menuitem.newinternetsearchfolder.label     &quot;Set as New Internet Search Folder&quot;&gt;</span>
<a href="#l18.95"></a><span id="l18.95" class="difflineminus">-&lt;!ENTITY menuitem.newinternetsearchfolder.accesskey &quot;i&quot;&gt;</span>
<a href="#l18.96"></a><span id="l18.96" class="difflineminus">-&lt;!ENTITY menuitem.personaltoolbarfolder.label       &quot;Set as Personal Toolbar Folder&quot;&gt;</span>
<a href="#l18.97"></a><span id="l18.97" class="difflineminus">-&lt;!ENTITY menuitem.personaltoolbarfolder.accesskey   &quot;p&quot;&gt;</span>
<a href="#l18.98"></a><span id="l18.98" class="difflineminus">-</span>
<a href="#l18.99"></a><span id="l18.99" class="difflineminus">-&lt;!ENTITY treecol.name.label             &quot;Name&quot;&gt;</span>
<a href="#l18.100"></a><span id="l18.100" class="difflineminus">-&lt;!ENTITY treecol.name.accesskey         &quot;N&quot;&gt;</span>
<a href="#l18.101"></a><span id="l18.101" class="difflineminus">-&lt;!ENTITY treecol.name.tooltip           &quot;Click to sort by name&quot;&gt;</span>
<a href="#l18.102"></a><span id="l18.102" class="difflineminus">-&lt;!ENTITY treecol.url.label              &quot;Location&quot;&gt;</span>
<a href="#l18.103"></a><span id="l18.103" class="difflineminus">-&lt;!ENTITY treecol.url.accesskey          &quot;L&quot;&gt;</span>
<a href="#l18.104"></a><span id="l18.104" class="difflineminus">-&lt;!ENTITY treecol.url.tooltip            &quot;Click to sort by location&quot;&gt;</span>
<a href="#l18.105"></a><span id="l18.105" class="difflineminus">-&lt;!ENTITY treecol.shortcut.label         &quot;Keyword&quot;&gt;</span>
<a href="#l18.106"></a><span id="l18.106" class="difflineminus">-&lt;!ENTITY treecol.shortcut.accesskey     &quot;K&quot;&gt;</span>
<a href="#l18.107"></a><span id="l18.107" class="difflineminus">-&lt;!ENTITY treecol.shortcut.tooltip       &quot;Click to sort by keyword&quot;&gt;</span>
<a href="#l18.108"></a><span id="l18.108" class="difflineminus">-&lt;!ENTITY treecol.description.label      &quot;Description&quot;&gt;</span>
<a href="#l18.109"></a><span id="l18.109" class="difflineminus">-&lt;!ENTITY treecol.description.accesskey  &quot;D&quot;&gt;</span>
<a href="#l18.110"></a><span id="l18.110" class="difflineminus">-&lt;!ENTITY treecol.description.tooltip    &quot;Click to sort by description&quot;&gt;</span>
<a href="#l18.111"></a><span id="l18.111" class="difflineminus">-&lt;!ENTITY treecol.addedon.label          &quot;Added&quot;&gt;</span>
<a href="#l18.112"></a><span id="l18.112" class="difflineminus">-&lt;!ENTITY treecol.addedon.accesskey      &quot;A&quot;&gt;</span>
<a href="#l18.113"></a><span id="l18.113" class="difflineminus">-&lt;!ENTITY treecol.addedon.tooltip        &quot;Click to sort by added&quot;&gt;</span>
<a href="#l18.114"></a><span id="l18.114" class="difflineminus">-&lt;!ENTITY treecol.lastmod.label          &quot;Last Modified&quot;&gt;</span>
<a href="#l18.115"></a><span id="l18.115" class="difflineminus">-&lt;!ENTITY treecol.lastmod.accesskey      &quot;M&quot;&gt;</span>
<a href="#l18.116"></a><span id="l18.116" class="difflineminus">-&lt;!ENTITY treecol.lastmod.tooltip        &quot;Click to sort by last modified&quot;&gt;</span>
<a href="#l18.117"></a><span id="l18.117" class="difflineminus">-&lt;!ENTITY treecol.lastvisit.label        &quot;Last Visited&quot;&gt;</span>
<a href="#l18.118"></a><span id="l18.118" class="difflineminus">-&lt;!ENTITY treecol.lastvisit.accesskey    &quot;V&quot;&gt;</span>
<a href="#l18.119"></a><span id="l18.119" class="difflineminus">-&lt;!ENTITY treecol.lastvisit.tooltip      &quot;Click to sort by last visit&quot;&gt;</span>
<a href="#l18.120"></a><span id="l18.120" class="difflineminus">-</span>
<a href="#l18.121"></a><span id="l18.121" class="difflineminus">-&lt;!ENTITY bookmarksWindowTitle.label     &quot;Bookmark Manager&quot;&gt;</span>
<a href="#l18.122"></a><span id="l18.122" class="difflineminus">-</span>
<a href="#l18.123"></a><span id="l18.123" class="difflineminus">-&lt;!ENTITY search.placeholder             &quot;Search Bookmarks&quot;&gt;</span>
<a href="#l18.124"></a><span id="l18.124" class="difflineminus">-&lt;!ENTITY search.key                     &quot;f&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1">deleted file mode 100755</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineminus">--- a/suite/locales/en-US/chrome/common/bookmarks/bookmarks.properties</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineplus">+++ /dev/null</span>
<a href="#l19.4"></a><span id="l19.4" class="difflineat">@@ -1,102 +0,0 @@</span>
<a href="#l19.5"></a><span id="l19.5" class="difflineminus">-# ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l19.6"></a><span id="l19.6" class="difflineminus">-# Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l19.7"></a><span id="l19.7" class="difflineminus">-#</span>
<a href="#l19.8"></a><span id="l19.8" class="difflineminus">-# The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l19.9"></a><span id="l19.9" class="difflineminus">-# 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l19.10"></a><span id="l19.10" class="difflineminus">-# the License. You may obtain a copy of the License at</span>
<a href="#l19.11"></a><span id="l19.11" class="difflineminus">-# http://www.mozilla.org/MPL/</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-#</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineminus">-# Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineminus">-# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l19.15"></a><span id="l19.15" class="difflineminus">-# for the specific language governing rights and limitations under the</span>
<a href="#l19.16"></a><span id="l19.16" class="difflineminus">-# License.</span>
<a href="#l19.17"></a><span id="l19.17" class="difflineminus">-#</span>
<a href="#l19.18"></a><span id="l19.18" class="difflineminus">-# The Original Code is mozilla.org code.</span>
<a href="#l19.19"></a><span id="l19.19" class="difflineminus">-#</span>
<a href="#l19.20"></a><span id="l19.20" class="difflineminus">-# The Initial Developer of the Original Code is</span>
<a href="#l19.21"></a><span id="l19.21" class="difflineminus">-# Netscape Communications Corporation.</span>
<a href="#l19.22"></a><span id="l19.22" class="difflineminus">-# Portions created by the Initial Developer are Copyright (C) 1998</span>
<a href="#l19.23"></a><span id="l19.23" class="difflineminus">-# the Initial Developer. All Rights Reserved.</span>
<a href="#l19.24"></a><span id="l19.24" class="difflineminus">-#</span>
<a href="#l19.25"></a><span id="l19.25" class="difflineminus">-# Contributor(s):</span>
<a href="#l19.26"></a><span id="l19.26" class="difflineminus">-#</span>
<a href="#l19.27"></a><span id="l19.27" class="difflineminus">-# Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l19.28"></a><span id="l19.28" class="difflineminus">-# either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l19.29"></a><span id="l19.29" class="difflineminus">-# or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l19.30"></a><span id="l19.30" class="difflineminus">-# in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l19.31"></a><span id="l19.31" class="difflineminus">-# of those above. If you wish to allow use of your version of this file only</span>
<a href="#l19.32"></a><span id="l19.32" class="difflineminus">-# under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l19.33"></a><span id="l19.33" class="difflineminus">-# use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l19.34"></a><span id="l19.34" class="difflineminus">-# decision by deleting the provisions above and replace them with the notice</span>
<a href="#l19.35"></a><span id="l19.35" class="difflineminus">-# and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l19.36"></a><span id="l19.36" class="difflineminus">-# the provisions above, a recipient may use your version of this file under</span>
<a href="#l19.37"></a><span id="l19.37" class="difflineminus">-# the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l19.38"></a><span id="l19.38" class="difflineminus">-#</span>
<a href="#l19.39"></a><span id="l19.39" class="difflineminus">-# ***** END LICENSE BLOCK *****</span>
<a href="#l19.40"></a><span id="l19.40" class="difflineminus">-</span>
<a href="#l19.41"></a><span id="l19.41" class="difflineminus">-cmd_bm_open.label = Open</span>
<a href="#l19.42"></a><span id="l19.42" class="difflineminus">-cmd_bm_open.accesskey = O</span>
<a href="#l19.43"></a><span id="l19.43" class="difflineminus">-cmd_bm_expandfolder.label = Expand</span>
<a href="#l19.44"></a><span id="l19.44" class="difflineminus">-cmd_bm_expandfolder.accesskey = x</span>
<a href="#l19.45"></a><span id="l19.45" class="difflineminus">-cmd_bm_collapsefolder.label = Collapse</span>
<a href="#l19.46"></a><span id="l19.46" class="difflineminus">-cmd_bm_collapsefolder.accesskey = a</span>
<a href="#l19.47"></a><span id="l19.47" class="difflineminus">-cmd_bm_managefolder.label = Open in New Window</span>
<a href="#l19.48"></a><span id="l19.48" class="difflineminus">-cmd_bm_managefolder.accesskey = W</span>
<a href="#l19.49"></a><span id="l19.49" class="difflineminus">-cmd_bm_cut.label = Cut</span>
<a href="#l19.50"></a><span id="l19.50" class="difflineminus">-cmd_bm_cut.accesskey = u</span>
<a href="#l19.51"></a><span id="l19.51" class="difflineminus">-cmd_bm_copy.label = Copy</span>
<a href="#l19.52"></a><span id="l19.52" class="difflineminus">-cmd_bm_copy.accesskey = C</span>
<a href="#l19.53"></a><span id="l19.53" class="difflineminus">-cmd_bm_paste.label = Paste</span>
<a href="#l19.54"></a><span id="l19.54" class="difflineminus">-cmd_bm_paste.accesskey = P</span>
<a href="#l19.55"></a><span id="l19.55" class="difflineminus">-cmd_bm_delete.label = Delete</span>
<a href="#l19.56"></a><span id="l19.56" class="difflineminus">-cmd_bm_delete.accesskey = D</span>
<a href="#l19.57"></a><span id="l19.57" class="difflineminus">-cmd_bm_movebookmark.label = Move Bookmark(s)…</span>
<a href="#l19.58"></a><span id="l19.58" class="difflineminus">-cmd_bm_movebookmark.accesskey = M</span>
<a href="#l19.59"></a><span id="l19.59" class="difflineminus">-cmd_bm_rename.label = Rename…</span>
<a href="#l19.60"></a><span id="l19.60" class="difflineminus">-cmd_bm_rename.accesskey = R</span>
<a href="#l19.61"></a><span id="l19.61" class="difflineminus">-cmd_bm_properties.label = Properties</span>
<a href="#l19.62"></a><span id="l19.62" class="difflineminus">-cmd_bm_properties.accesskey = e</span>
<a href="#l19.63"></a><span id="l19.63" class="difflineminus">-cmd_bm_sortfolderbyname.label = Sort Folder by Name</span>
<a href="#l19.64"></a><span id="l19.64" class="difflineminus">-cmd_bm_sortfolderbyname.accesskey = N</span>
<a href="#l19.65"></a><span id="l19.65" class="difflineminus">-cmd_bm_sortfolder.label = Sort Folder…</span>
<a href="#l19.66"></a><span id="l19.66" class="difflineminus">-cmd_bm_sortfolder.accesskey = S</span>
<a href="#l19.67"></a><span id="l19.67" class="difflineminus">-</span>
<a href="#l19.68"></a><span id="l19.68" class="difflineminus">-cmd_bm_openinnewwindow.label = Open in New Window</span>
<a href="#l19.69"></a><span id="l19.69" class="difflineminus">-cmd_bm_openinnewwindow.accesskey = W</span>
<a href="#l19.70"></a><span id="l19.70" class="difflineminus">-cmd_bm_openinnewtab.label = Open in New Tab </span>
<a href="#l19.71"></a><span id="l19.71" class="difflineminus">-cmd_bm_openinnewtab.accesskey = T </span>
<a href="#l19.72"></a><span id="l19.72" class="difflineminus">-cmd_bm_newfolder.label = New Folder…</span>
<a href="#l19.73"></a><span id="l19.73" class="difflineminus">-cmd_bm_newfolder.accesskey = F</span>
<a href="#l19.74"></a><span id="l19.74" class="difflineminus">-</span>
<a href="#l19.75"></a><span id="l19.75" class="difflineminus">-ile_newfolder = New Folder</span>
<a href="#l19.76"></a><span id="l19.76" class="difflineminus">-</span>
<a href="#l19.77"></a><span id="l19.77" class="difflineminus">-window_title = %S - Bookmarks</span>
<a href="#l19.78"></a><span id="l19.78" class="difflineminus">-search_results_title = Search Results</span>
<a href="#l19.79"></a><span id="l19.79" class="difflineminus">-</span>
<a href="#l19.80"></a><span id="l19.80" class="difflineminus">-bookmarks_default_root = Bookmarks</span>
<a href="#l19.81"></a><span id="l19.81" class="difflineminus">-bookmarks_root = Bookmarks for %S</span>
<a href="#l19.82"></a><span id="l19.82" class="difflineminus">-bookmarks_title = Bookmark Manager</span>
<a href="#l19.83"></a><span id="l19.83" class="difflineminus">-status_foldercount = %S object(s)</span>
<a href="#l19.84"></a><span id="l19.84" class="difflineminus">-</span>
<a href="#l19.85"></a><span id="l19.85" class="difflineminus">-WebPageUpdated = The following web page has been updated:</span>
<a href="#l19.86"></a><span id="l19.86" class="difflineminus">-WebPageTitle = Title:</span>
<a href="#l19.87"></a><span id="l19.87" class="difflineminus">-WebPageURL = URL:</span>
<a href="#l19.88"></a><span id="l19.88" class="difflineminus">-WebPageAskDisplay = Would you like to display it?</span>
<a href="#l19.89"></a><span id="l19.89" class="difflineminus">-WebPageAskStopOption = Stop checking for updates on this web page</span>
<a href="#l19.90"></a><span id="l19.90" class="difflineminus">-</span>
<a href="#l19.91"></a><span id="l19.91" class="difflineminus">-pleaseEnterADuration = Please enter a duration.</span>
<a href="#l19.92"></a><span id="l19.92" class="difflineminus">-pleaseSelectANotification = Please enter at least one notification method.</span>
<a href="#l19.93"></a><span id="l19.93" class="difflineminus">-</span>
<a href="#l19.94"></a><span id="l19.94" class="difflineminus">-SortMenuItem = Sorted by %S</span>
<a href="#l19.95"></a><span id="l19.95" class="difflineminus">-</span>
<a href="#l19.96"></a><span id="l19.96" class="difflineminus">-ShortFindTitle = Find: '%S'</span>
<a href="#l19.97"></a><span id="l19.97" class="difflineminus">-FindTitle = Find: %S %S '%S' in %S</span>
<a href="#l19.98"></a><span id="l19.98" class="difflineminus">-</span>
<a href="#l19.99"></a><span id="l19.99" class="difflineminus">-ImportedIEFavorites = Imported IE Favorites                                     </span>
<a href="#l19.100"></a><span id="l19.100" class="difflineminus">-ImportedIEStaticFavorites = Imported IE Favorites</span>
<a href="#l19.101"></a><span id="l19.101" class="difflineminus">-ImportedNetPositiveBookmarks = Imported NetPositive Bookmarks                   </span>
<a href="#l19.102"></a><span id="l19.102" class="difflineminus">-DefaultPersonalToolbarFolder = Personal Toolbar Folder                          </span>
<a href="#l19.103"></a><span id="l19.103" class="difflineminus">-</span>
<a href="#l19.104"></a><span id="l19.104" class="difflineminus">-SelectOpen = Open Bookmarks File</span>
<a href="#l19.105"></a><span id="l19.105" class="difflineminus">-SelectImport = Import Bookmarks File</span>
<a href="#l19.106"></a><span id="l19.106" class="difflineminus">-EnterExport = Export Bookmarks File</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1">deleted file mode 100644</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineminus">--- a/suite/locales/en-US/chrome/common/bookmarks/findBookmark.dtd</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineplus">+++ /dev/null</span>
<a href="#l20.4"></a><span id="l20.4" class="difflineat">@@ -1,17 +0,0 @@</span>
<a href="#l20.5"></a><span id="l20.5" class="difflineminus">-</span>
<a href="#l20.6"></a><span id="l20.6" class="difflineminus">-&lt;!ENTITY search.name.label              &quot;name&quot;&gt;</span>
<a href="#l20.7"></a><span id="l20.7" class="difflineminus">-&lt;!ENTITY search.url.label               &quot;location&quot;&gt;</span>
<a href="#l20.8"></a><span id="l20.8" class="difflineminus">-&lt;!ENTITY search.shortcut.label          &quot;keyword&quot;&gt;</span>
<a href="#l20.9"></a><span id="l20.9" class="difflineminus">-&lt;!ENTITY search.description.label       &quot;description&quot;&gt;</span>
<a href="#l20.10"></a><span id="l20.10" class="difflineminus">-&lt;!ENTITY search.startswith.label        &quot;starts with&quot;&gt;</span>
<a href="#l20.11"></a><span id="l20.11" class="difflineminus">-&lt;!ENTITY search.endswith.label          &quot;ends with&quot;&gt;</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-&lt;!ENTITY search.is.label                &quot;is&quot;&gt;</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineminus">-&lt;!ENTITY search.isnot.label             &quot;is not&quot;&gt;</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineminus">-&lt;!ENTITY search.contains.label          &quot;contains&quot;&gt;</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineminus">-&lt;!ENTITY search.doesntcontain.label     &quot;doesn't contain&quot;&gt;</span>
<a href="#l20.16"></a><span id="l20.16" class="difflineminus">-&lt;!ENTITY save.query.label               &quot;Save query in bookmarks&quot;&gt;</span>
<a href="#l20.17"></a><span id="l20.17" class="difflineminus">-&lt;!ENTITY save.query.accesskey           &quot;S&quot;&gt;</span>
<a href="#l20.18"></a><span id="l20.18" class="difflineminus">-&lt;!ENTITY search.for.label               &quot;Find Bookmarks whose&quot;&gt;</span>
<a href="#l20.19"></a><span id="l20.19" class="difflineminus">-&lt;!ENTITY findBookmark.title             &quot;Find Bookmarks&quot;&gt;</span>
<a href="#l20.20"></a><span id="l20.20" class="difflineminus">-&lt;!ENTITY findButton.label               &quot;Find&quot;&gt;</span>
<a href="#l20.21"></a><span id="l20.21" class="difflineminus">-&lt;!ENTITY findButton.accesskey           &quot;F&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1">deleted file mode 100644</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineminus">--- a/suite/locales/en-US/chrome/common/bookmarks/sortFolder.dtd</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineplus">+++ /dev/null</span>
<a href="#l21.4"></a><span id="l21.4" class="difflineat">@@ -1,24 +0,0 @@</span>
<a href="#l21.5"></a><span id="l21.5" class="difflineminus">-&lt;!ENTITY window.title &quot;Sort Folder&quot;&gt;</span>
<a href="#l21.6"></a><span id="l21.6" class="difflineminus">-</span>
<a href="#l21.7"></a><span id="l21.7" class="difflineminus">-&lt;!ENTITY sortOptions.label &quot;Sort options&quot;&gt;</span>
<a href="#l21.8"></a><span id="l21.8" class="difflineminus">-&lt;!ENTITY description.label &quot;&amp;brandShortName; can sort individual folders. Use these options to customize the sorting for this Folder.&quot;&gt;</span>
<a href="#l21.9"></a><span id="l21.9" class="difflineminus">-</span>
<a href="#l21.10"></a><span id="l21.10" class="difflineminus">-&lt;!ENTITY sortBy.label &quot;Sort by:&quot;&gt;</span>
<a href="#l21.11"></a><span id="l21.11" class="difflineminus">-&lt;!ENTITY sortBy.accesskey &quot;S&quot;&gt;</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-&lt;!ENTITY sortBy.name.label &quot;Name&quot;&gt;</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineminus">-&lt;!ENTITY sortBy.url.label &quot;Location&quot;&gt;</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineminus">-&lt;!ENTITY sortBy.shortcutUrl.label &quot;Keyword&quot;&gt;</span>
<a href="#l21.15"></a><span id="l21.15" class="difflineminus">-&lt;!ENTITY sortBy.description.label &quot;Description&quot;&gt;</span>
<a href="#l21.16"></a><span id="l21.16" class="difflineminus">-&lt;!ENTITY sortBy.bookmarkAddDate.label &quot;Added&quot;&gt;</span>
<a href="#l21.17"></a><span id="l21.17" class="difflineminus">-&lt;!ENTITY sortBy.lastModifiedDate.label &quot;Last Modified&quot;&gt;</span>
<a href="#l21.18"></a><span id="l21.18" class="difflineminus">-&lt;!ENTITY sortBy.lastVisitDate.label &quot;Last Visited&quot;&gt;</span>
<a href="#l21.19"></a><span id="l21.19" class="difflineminus">-</span>
<a href="#l21.20"></a><span id="l21.20" class="difflineminus">-&lt;!ENTITY sortOrder.label &quot;Sort order:&quot;&gt;</span>
<a href="#l21.21"></a><span id="l21.21" class="difflineminus">-&lt;!ENTITY sortOrder.accesskey &quot;o&quot;&gt;</span>
<a href="#l21.22"></a><span id="l21.22" class="difflineminus">-&lt;!ENTITY sortAscending.label &quot;Ascending&quot;&gt;</span>
<a href="#l21.23"></a><span id="l21.23" class="difflineminus">-&lt;!ENTITY sortDescending.label &quot;Descending&quot;&gt;</span>
<a href="#l21.24"></a><span id="l21.24" class="difflineminus">-</span>
<a href="#l21.25"></a><span id="l21.25" class="difflineminus">-&lt;!ENTITY sortFoldersFirst.label &quot;Sort folders first&quot;&gt;</span>
<a href="#l21.26"></a><span id="l21.26" class="difflineminus">-&lt;!ENTITY sortFoldersFirst.accesskey &quot;d&quot;&gt;</span>
<a href="#l21.27"></a><span id="l21.27" class="difflineminus">-&lt;!ENTITY sortRecursively.label &quot;Sort recursively&quot;&gt;</span>
<a href="#l21.28"></a><span id="l21.28" class="difflineminus">-&lt;!ENTITY sortRecursively.accesskey &quot;c&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/suite/profile/migration/src/nsSuiteProfileMigratorUtils.cpp</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/suite/profile/migration/src/nsSuiteProfileMigratorUtils.cpp</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -33,17 +33,16 @@</span>
<a href="#l22.4"></a><span id="l22.4">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l22.5"></a><span id="l22.5">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l22.6"></a><span id="l22.6">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l22.7"></a><span id="l22.7">  *</span>
<a href="#l22.8"></a><span id="l22.8">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l22.9"></a><span id="l22.9"> </span>
<a href="#l22.10"></a><span id="l22.10"> #include &quot;nsSuiteProfileMigratorUtils.h&quot;</span>
<a href="#l22.11"></a><span id="l22.11"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-#include &quot;nsIBookmarksService.h&quot;</span>
<a href="#l22.13"></a><span id="l22.13"> #include &quot;nsIFile.h&quot;</span>
<a href="#l22.14"></a><span id="l22.14"> #include &quot;nsIInputStream.h&quot;</span>
<a href="#l22.15"></a><span id="l22.15"> #include &quot;nsILineInputStream.h&quot;</span>
<a href="#l22.16"></a><span id="l22.16"> #include &quot;nsIProfileMigrator.h&quot;</span>
<a href="#l22.17"></a><span id="l22.17"> </span>
<a href="#l22.18"></a><span id="l22.18"> #include &quot;nsIURI.h&quot;</span>
<a href="#l22.19"></a><span id="l22.19"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l22.20"></a><span id="l22.20"> #include &quot;nsISupportsPrimitives.h&quot;</span>
<a href="#l22.21"></a><span id="l22.21" class="difflineat">@@ -212,81 +211,11 @@ AnnotatePersonalToolbarFolder(nsIFile* a</span>
<a href="#l22.22"></a><span id="l22.22">   </span>
<a href="#l22.23"></a><span id="l22.23">   return NS_OK;</span>
<a href="#l22.24"></a><span id="l22.24"> }</span>
<a href="#l22.25"></a><span id="l22.25"> </span>
<a href="#l22.26"></a><span id="l22.26"> nsresult</span>
<a href="#l22.27"></a><span id="l22.27"> ImportBookmarksHTML(nsIFile* aBookmarksFile,</span>
<a href="#l22.28"></a><span id="l22.28">                     const PRUnichar* aImportSourceNameKey)</span>
<a href="#l22.29"></a><span id="l22.29"> {</span>
<a href="#l22.30"></a><span id="l22.30" class="difflineminus">-  nsresult rv;</span>
<a href="#l22.31"></a><span id="l22.31" class="difflineminus">-</span>
<a href="#l22.32"></a><span id="l22.32" class="difflineminus">-  nsCOMPtr&lt;nsIBookmarksService&gt; bms =</span>
<a href="#l22.33"></a><span id="l22.33" class="difflineminus">-    do_GetService(&quot;@mozilla.org/browser/bookmarks-service;1&quot;, &amp;rv);</span>
<a href="#l22.34"></a><span id="l22.34" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.35"></a><span id="l22.35" class="difflineminus">-</span>
<a href="#l22.36"></a><span id="l22.36" class="difflineminus">-  nsCOMPtr&lt;nsISupportsArray&gt; params(do_CreateInstance(NS_SUPPORTSARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l22.37"></a><span id="l22.37" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.38"></a><span id="l22.38" class="difflineminus">-</span>
<a href="#l22.39"></a><span id="l22.39" class="difflineminus">-  nsCOMPtr&lt;nsIRDFService&gt; rdfs =</span>
<a href="#l22.40"></a><span id="l22.40" class="difflineminus">-    do_GetService(&quot;@mozilla.org/rdf/rdf-service;1&quot;, &amp;rv);</span>
<a href="#l22.41"></a><span id="l22.41" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.42"></a><span id="l22.42" class="difflineminus">-</span>
<a href="#l22.43"></a><span id="l22.43" class="difflineminus">-  nsCOMPtr&lt;nsIRDFResource&gt; prop;</span>
<a href="#l22.44"></a><span id="l22.44" class="difflineminus">-  rv = rdfs-&gt;GetResource(NC_URI(URL), getter_AddRefs(prop));</span>
<a href="#l22.45"></a><span id="l22.45" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.46"></a><span id="l22.46" class="difflineminus">-</span>
<a href="#l22.47"></a><span id="l22.47" class="difflineminus">-  nsCOMPtr&lt;nsIRDFLiteral&gt; url;</span>
<a href="#l22.48"></a><span id="l22.48" class="difflineminus">-  nsAutoString path;</span>
<a href="#l22.49"></a><span id="l22.49" class="difflineminus">-  aBookmarksFile-&gt;GetPath(path);</span>
<a href="#l22.50"></a><span id="l22.50" class="difflineminus">-  rdfs-&gt;GetLiteral(path.get(), getter_AddRefs(url));</span>
<a href="#l22.51"></a><span id="l22.51" class="difflineminus">-</span>
<a href="#l22.52"></a><span id="l22.52" class="difflineminus">-  params-&gt;AppendElement(prop);</span>
<a href="#l22.53"></a><span id="l22.53" class="difflineminus">-  params-&gt;AppendElement(url);</span>
<a href="#l22.54"></a><span id="l22.54" class="difflineminus">-  </span>
<a href="#l22.55"></a><span id="l22.55" class="difflineminus">-  nsCOMPtr&lt;nsIRDFResource&gt; importCmd;</span>
<a href="#l22.56"></a><span id="l22.56" class="difflineminus">-  rv = rdfs-&gt;GetResource(NC_URI(command?cmd=import), getter_AddRefs(importCmd));</span>
<a href="#l22.57"></a><span id="l22.57" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.58"></a><span id="l22.58" class="difflineminus">-</span>
<a href="#l22.59"></a><span id="l22.59" class="difflineminus">-  nsCOMPtr&lt;nsIRDFResource&gt; root;</span>
<a href="#l22.60"></a><span id="l22.60" class="difflineminus">-  rv = rdfs-&gt;GetResource(NS_LITERAL_CSTRING(&quot;NC:BookmarksRoot&quot;),</span>
<a href="#l22.61"></a><span id="l22.61" class="difflineminus">-                         getter_AddRefs(root));</span>
<a href="#l22.62"></a><span id="l22.62" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.63"></a><span id="l22.63" class="difflineminus">-</span>
<a href="#l22.64"></a><span id="l22.64" class="difflineminus">-  // Look for the localized name of the bookmarks toolbar</span>
<a href="#l22.65"></a><span id="l22.65" class="difflineminus">-  nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l22.66"></a><span id="l22.66" class="difflineminus">-           do_GetService(NS_STRINGBUNDLE_CONTRACTID, &amp;rv);</span>
<a href="#l22.67"></a><span id="l22.67" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.68"></a><span id="l22.68" class="difflineminus">-</span>
<a href="#l22.69"></a><span id="l22.69" class="difflineminus">-  nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l22.70"></a><span id="l22.70" class="difflineminus">-  rv = bundleService-&gt;CreateBundle(MIGRATION_BUNDLE, getter_AddRefs(bundle));</span>
<a href="#l22.71"></a><span id="l22.71" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.72"></a><span id="l22.72" class="difflineminus">-</span>
<a href="#l22.73"></a><span id="l22.73" class="difflineminus">-  nsString sourceName;</span>
<a href="#l22.74"></a><span id="l22.74" class="difflineminus">-  bundle-&gt;GetStringFromName(aImportSourceNameKey, getter_Copies(sourceName));</span>
<a href="#l22.75"></a><span id="l22.75" class="difflineminus">-</span>
<a href="#l22.76"></a><span id="l22.76" class="difflineminus">-  const PRUnichar* sourceNameStrings[] = { sourceName.get() };</span>
<a href="#l22.77"></a><span id="l22.77" class="difflineminus">-  nsString importedBookmarksTitle;</span>
<a href="#l22.78"></a><span id="l22.78" class="difflineminus">-  bundle-&gt;FormatStringFromName(</span>
<a href="#l22.79"></a><span id="l22.79" class="difflineminus">-    NS_LITERAL_STRING(&quot;importedBookmarksFolder&quot;).get(),</span>
<a href="#l22.80"></a><span id="l22.80" class="difflineminus">-    sourceNameStrings, 1,</span>
<a href="#l22.81"></a><span id="l22.81" class="difflineminus">-    getter_Copies(importedBookmarksTitle));</span>
<a href="#l22.82"></a><span id="l22.82" class="difflineminus">-</span>
<a href="#l22.83"></a><span id="l22.83" class="difflineminus">-  nsCOMPtr&lt;nsIRDFResource&gt; folder;</span>
<a href="#l22.84"></a><span id="l22.84" class="difflineminus">-  bms-&gt;CreateFolderInContainer(importedBookmarksTitle.get(), root, -1,</span>
<a href="#l22.85"></a><span id="l22.85" class="difflineminus">-                               getter_AddRefs(folder));</span>
<a href="#l22.86"></a><span id="l22.86" class="difflineminus">-</span>
<a href="#l22.87"></a><span id="l22.87" class="difflineminus">-  nsCOMPtr&lt;nsIRDFResource&gt; folderProp;</span>
<a href="#l22.88"></a><span id="l22.88" class="difflineminus">-  rv = rdfs-&gt;GetResource(NC_URI(Folder), getter_AddRefs(folderProp));</span>
<a href="#l22.89"></a><span id="l22.89" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.90"></a><span id="l22.90" class="difflineminus">-</span>
<a href="#l22.91"></a><span id="l22.91" class="difflineminus">-  params-&gt;AppendElement(folderProp);</span>
<a href="#l22.92"></a><span id="l22.92" class="difflineminus">-  params-&gt;AppendElement(folder);</span>
<a href="#l22.93"></a><span id="l22.93" class="difflineminus">-</span>
<a href="#l22.94"></a><span id="l22.94" class="difflineminus">-  nsCOMPtr&lt;nsISupportsArray&gt; sources(do_CreateInstance(NS_SUPPORTSARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l22.95"></a><span id="l22.95" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.96"></a><span id="l22.96" class="difflineminus">-  sources-&gt;AppendElement(folder);</span>
<a href="#l22.97"></a><span id="l22.97" class="difflineminus">-</span>
<a href="#l22.98"></a><span id="l22.98" class="difflineminus">-  nsCOMPtr&lt;nsIRDFDataSource&gt; ds = do_QueryInterface(bms, &amp;rv);</span>
<a href="#l22.99"></a><span id="l22.99" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.100"></a><span id="l22.100" class="difflineminus">-</span>
<a href="#l22.101"></a><span id="l22.101" class="difflineminus">-  return ds-&gt;DoCommand(sources, importCmd, params);</span>
<a href="#l22.102"></a><span id="l22.102" class="difflineplus">+  // XXX: need to make this work with places</span>
<a href="#l22.103"></a><span id="l22.103" class="difflineplus">+  return NS_OK;</span>
<a href="#l22.104"></a><span id="l22.104"> }</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

