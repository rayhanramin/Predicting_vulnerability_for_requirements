<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 12228:3a6a45f4bf240bc0e87d14e1069dbb60c2692e38</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 3a6a45f4bf240bc0e87d14e1069dbb60c2692e38" />
<meta property="og:url" content="/comm-central/rev/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38" />
<meta property="og:description" content="Bug 852690 - Remaining conversion to mailServices.js in /mail/ and /mailnews/: imap. r=Standard8" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 3a6a45f4bf240bc0e87d14e1069dbb60c2692e38 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38">shortlog</a> |
<a href="/comm-central/log/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38">files</a> |
changeset |
<a href="/comm-central/raw-rev/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38">raw</a>  | <a href="/comm-central/archive/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=852690">Bug 852690</a> - Remaining conversion to mailServices.js in /mail/ and /mailnews/: imap. r=Standard8
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#83;&#101;&#98;&#97;&#115;&#116;&#105;&#97;&#110;&#32;&#72;&#101;&#110;&#103;&#115;&#116;&#32;&#60;&#97;&#114;&#99;&#104;&#97;&#101;&#111;&#112;&#116;&#101;&#114;&#121;&#120;&#64;&#99;&#111;&#111;&#108;&#101;&#45;&#102;&#105;&#108;&#101;&#115;&#46;&#100;&#101;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 29 Mar 2013 10:57:17 +0100</td></tr>

<tr>
 <td>changeset 12228</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38">3a6a45f4bf240bc0e87d14e1069dbb60c2692e38</a></td>
</tr>



<tr>
<td>parent 12227</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/d202d72fc4c19829f5ef1e097e8db1862f28c995">d202d72fc4c19829f5ef1e097e8db1862f28c995</a>
</td>
</tr>

<tr>
<td>child 12229</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/f65892db66d312c89d16c02e815298eecc48f5f5">f65892db66d312c89d16c02e815298eecc48f5f5</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=3a6a45f4bf240bc0e87d14e1069dbb60c2692e38">9052</a></td></tr>
<tr><td>push user</td><td>ryanvm@gmail.com</td></tr>
<tr><td>push date</td><td class="date age">Fri, 29 Mar 2013 18:51:13 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@0e410a62d2d8 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=0e410a62d2d81576f3fe043548d65cd73ab8af03">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=0e410a62d2d81576f3fe043548d65cd73ab8af03&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0e410a62d2d81576f3fe043548d65cd73ab8af03&newProject=comm-central&newRevision=006a18264170c6b44c66df01a863303f605343bf&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0e410a62d2d81576f3fe043548d65cd73ab8af03&newProject=comm-central&newRevision=006a18264170c6b44c66df01a863303f605343bf&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0e410a62d2d81576f3fe043548d65cd73ab8af03&newProject=comm-central&newRevision=006a18264170c6b44c66df01a863303f605343bf&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28Standard8%29&revcount=50">Standard8</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=852690">852690</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=852690">Bug 852690</a> - Remaining conversion to mailServices.js in /mail/ and /mailnews/: imap. r=Standard8</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_copyThenMove.js">mailnews/imap/test/unit/test_copyThenMove.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_copyThenMove.js">file</a> |
<a href="/comm-central/annotate/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_copyThenMove.js">annotate</a> |
<a href="/comm-central/diff/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_copyThenMove.js">diff</a> |
<a href="/comm-central/comparison/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_copyThenMove.js">comparison</a> |
<a href="/comm-central/log/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_copyThenMove.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_dontStatNoSelect.js">mailnews/imap/test/unit/test_dontStatNoSelect.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_dontStatNoSelect.js">file</a> |
<a href="/comm-central/annotate/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_dontStatNoSelect.js">annotate</a> |
<a href="/comm-central/diff/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_dontStatNoSelect.js">diff</a> |
<a href="/comm-central/comparison/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_dontStatNoSelect.js">comparison</a> |
<a href="/comm-central/log/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_dontStatNoSelect.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_filterNeedsBody.js">mailnews/imap/test/unit/test_filterNeedsBody.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_filterNeedsBody.js">file</a> |
<a href="/comm-central/annotate/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_filterNeedsBody.js">annotate</a> |
<a href="/comm-central/diff/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_filterNeedsBody.js">diff</a> |
<a href="/comm-central/comparison/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_filterNeedsBody.js">comparison</a> |
<a href="/comm-central/log/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_filterNeedsBody.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_imapAttachmentSaves.js">mailnews/imap/test/unit/test_imapAttachmentSaves.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_imapAttachmentSaves.js">file</a> |
<a href="/comm-central/annotate/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_imapAttachmentSaves.js">annotate</a> |
<a href="/comm-central/diff/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_imapAttachmentSaves.js">diff</a> |
<a href="/comm-central/comparison/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_imapAttachmentSaves.js">comparison</a> |
<a href="/comm-central/log/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_imapAttachmentSaves.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_imapAuthMethods.js">mailnews/imap/test/unit/test_imapAuthMethods.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_imapAuthMethods.js">file</a> |
<a href="/comm-central/annotate/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_imapAuthMethods.js">annotate</a> |
<a href="/comm-central/diff/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_imapAuthMethods.js">diff</a> |
<a href="/comm-central/comparison/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_imapAuthMethods.js">comparison</a> |
<a href="/comm-central/log/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_imapAuthMethods.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_imapAutoSync.js">mailnews/imap/test/unit/test_imapAutoSync.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_imapAutoSync.js">file</a> |
<a href="/comm-central/annotate/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_imapAutoSync.js">annotate</a> |
<a href="/comm-central/diff/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_imapAutoSync.js">diff</a> |
<a href="/comm-central/comparison/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_imapAutoSync.js">comparison</a> |
<a href="/comm-central/log/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_imapAutoSync.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_imapContentLength.js">mailnews/imap/test/unit/test_imapContentLength.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_imapContentLength.js">file</a> |
<a href="/comm-central/annotate/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_imapContentLength.js">annotate</a> |
<a href="/comm-central/diff/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_imapContentLength.js">diff</a> |
<a href="/comm-central/comparison/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_imapContentLength.js">comparison</a> |
<a href="/comm-central/log/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_imapContentLength.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_imapCopyTimeout.js">mailnews/imap/test/unit/test_imapCopyTimeout.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_imapCopyTimeout.js">file</a> |
<a href="/comm-central/annotate/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_imapCopyTimeout.js">annotate</a> |
<a href="/comm-central/diff/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_imapCopyTimeout.js">diff</a> |
<a href="/comm-central/comparison/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_imapCopyTimeout.js">comparison</a> |
<a href="/comm-central/log/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_imapCopyTimeout.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_imapFilterActions.js">mailnews/imap/test/unit/test_imapFilterActions.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_imapFilterActions.js">file</a> |
<a href="/comm-central/annotate/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_imapFilterActions.js">annotate</a> |
<a href="/comm-central/diff/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_imapFilterActions.js">diff</a> |
<a href="/comm-central/comparison/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_imapFilterActions.js">comparison</a> |
<a href="/comm-central/log/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_imapFilterActions.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_imapFolderCopy.js">mailnews/imap/test/unit/test_imapFolderCopy.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_imapFolderCopy.js">file</a> |
<a href="/comm-central/annotate/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_imapFolderCopy.js">annotate</a> |
<a href="/comm-central/diff/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_imapFolderCopy.js">diff</a> |
<a href="/comm-central/comparison/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_imapFolderCopy.js">comparison</a> |
<a href="/comm-central/log/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_imapFolderCopy.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_imapUndo.js">mailnews/imap/test/unit/test_imapUndo.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_imapUndo.js">file</a> |
<a href="/comm-central/annotate/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_imapUndo.js">annotate</a> |
<a href="/comm-central/diff/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_imapUndo.js">diff</a> |
<a href="/comm-central/comparison/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_imapUndo.js">comparison</a> |
<a href="/comm-central/log/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_imapUndo.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_localToImapFilter.js">mailnews/imap/test/unit/test_localToImapFilter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_localToImapFilter.js">file</a> |
<a href="/comm-central/annotate/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_localToImapFilter.js">annotate</a> |
<a href="/comm-central/diff/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_localToImapFilter.js">diff</a> |
<a href="/comm-central/comparison/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_localToImapFilter.js">comparison</a> |
<a href="/comm-central/log/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_localToImapFilter.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_localToImapFilterQuarantine.js">mailnews/imap/test/unit/test_localToImapFilterQuarantine.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_localToImapFilterQuarantine.js">file</a> |
<a href="/comm-central/annotate/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_localToImapFilterQuarantine.js">annotate</a> |
<a href="/comm-central/diff/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_localToImapFilterQuarantine.js">diff</a> |
<a href="/comm-central/comparison/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_localToImapFilterQuarantine.js">comparison</a> |
<a href="/comm-central/log/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_localToImapFilterQuarantine.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_nsIMsgFolderListenerIMAP.js">mailnews/imap/test/unit/test_nsIMsgFolderListenerIMAP.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_nsIMsgFolderListenerIMAP.js">file</a> |
<a href="/comm-central/annotate/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_nsIMsgFolderListenerIMAP.js">annotate</a> |
<a href="/comm-central/diff/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_nsIMsgFolderListenerIMAP.js">diff</a> |
<a href="/comm-central/comparison/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_nsIMsgFolderListenerIMAP.js">comparison</a> |
<a href="/comm-central/log/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_nsIMsgFolderListenerIMAP.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_offlineDraftDataloss.js">mailnews/imap/test/unit/test_offlineDraftDataloss.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_offlineDraftDataloss.js">file</a> |
<a href="/comm-central/annotate/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_offlineDraftDataloss.js">annotate</a> |
<a href="/comm-central/diff/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_offlineDraftDataloss.js">diff</a> |
<a href="/comm-central/comparison/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_offlineDraftDataloss.js">comparison</a> |
<a href="/comm-central/log/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_offlineDraftDataloss.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_offlinePlayback.js">mailnews/imap/test/unit/test_offlinePlayback.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_offlinePlayback.js">file</a> |
<a href="/comm-central/annotate/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_offlinePlayback.js">annotate</a> |
<a href="/comm-central/diff/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_offlinePlayback.js">diff</a> |
<a href="/comm-central/comparison/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_offlinePlayback.js">comparison</a> |
<a href="/comm-central/log/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_offlinePlayback.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_offlineStoreLocking.js">mailnews/imap/test/unit/test_offlineStoreLocking.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_offlineStoreLocking.js">file</a> |
<a href="/comm-central/annotate/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_offlineStoreLocking.js">annotate</a> |
<a href="/comm-central/diff/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_offlineStoreLocking.js">diff</a> |
<a href="/comm-central/comparison/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_offlineStoreLocking.js">comparison</a> |
<a href="/comm-central/log/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_offlineStoreLocking.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_preserveDataOnMove.js">mailnews/imap/test/unit/test_preserveDataOnMove.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_preserveDataOnMove.js">file</a> |
<a href="/comm-central/annotate/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_preserveDataOnMove.js">annotate</a> |
<a href="/comm-central/diff/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_preserveDataOnMove.js">diff</a> |
<a href="/comm-central/comparison/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_preserveDataOnMove.js">comparison</a> |
<a href="/comm-central/log/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_preserveDataOnMove.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_saveImapDraft.js">mailnews/imap/test/unit/test_saveImapDraft.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_saveImapDraft.js">file</a> |
<a href="/comm-central/annotate/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_saveImapDraft.js">annotate</a> |
<a href="/comm-central/diff/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_saveImapDraft.js">diff</a> |
<a href="/comm-central/comparison/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_saveImapDraft.js">comparison</a> |
<a href="/comm-central/log/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_saveImapDraft.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_starttlsFailure.js">mailnews/imap/test/unit/test_starttlsFailure.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_starttlsFailure.js">file</a> |
<a href="/comm-central/annotate/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_starttlsFailure.js">annotate</a> |
<a href="/comm-central/diff/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_starttlsFailure.js">diff</a> |
<a href="/comm-central/comparison/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_starttlsFailure.js">comparison</a> |
<a href="/comm-central/log/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_starttlsFailure.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_trustSpamAssassin.js">mailnews/imap/test/unit/test_trustSpamAssassin.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_trustSpamAssassin.js">file</a> |
<a href="/comm-central/annotate/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_trustSpamAssassin.js">annotate</a> |
<a href="/comm-central/diff/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_trustSpamAssassin.js">diff</a> |
<a href="/comm-central/comparison/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_trustSpamAssassin.js">comparison</a> |
<a href="/comm-central/log/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38/mailnews/imap/test/unit/test_trustSpamAssassin.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_copyThenMove.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_copyThenMove.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -5,21 +5,22 @@</span>
<a href="#l1.4"></a><span id="l1.4"> </span>
<a href="#l1.5"></a><span id="l1.5"> </span>
<a href="#l1.6"></a><span id="l1.6"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l1.7"></a><span id="l1.7"> load(&quot;../../../resources/mailTestUtils.js&quot;);</span>
<a href="#l1.8"></a><span id="l1.8"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l1.9"></a><span id="l1.9"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l1.10"></a><span id="l1.10"> load(&quot;../../../resources/IMAPpump.js&quot;);</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+</span>
<a href="#l1.14"></a><span id="l1.14"> var gEmptyLocal1, gEmptyLocal2;</span>
<a href="#l1.15"></a><span id="l1.15"> var gLastKey;</span>
<a href="#l1.16"></a><span id="l1.16"> var gMessages = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineminus">-var gCopyService = Cc[&quot;@mozilla.org/messenger/messagecopyservice;1&quot;]</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineminus">-                .getService(Ci.nsIMsgCopyService);</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+var gCopyService = MailServices.copy;</span>
<a href="#l1.20"></a><span id="l1.20"> </span>
<a href="#l1.21"></a><span id="l1.21"> Components.utils.import(&quot;resource:///modules/folderUtils.jsm&quot;);</span>
<a href="#l1.22"></a><span id="l1.22"> Components.utils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l1.23"></a><span id="l1.23"> </span>
<a href="#l1.24"></a><span id="l1.24"> var tests = [</span>
<a href="#l1.25"></a><span id="l1.25">   setup,</span>
<a href="#l1.26"></a><span id="l1.26">   function copyFolder1() {</span>
<a href="#l1.27"></a><span id="l1.27">     dump(&quot;gEmpty1 &quot; + gEmptyLocal1.URI + &quot;\n&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_dontStatNoSelect.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_dontStatNoSelect.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -6,16 +6,18 @@ var gIMAPInbox, gIMAPFolder1, gIMAPFolde</span>
<a href="#l2.4"></a><span id="l2.4"> var gFolder2Mailbox;</span>
<a href="#l2.5"></a><span id="l2.5"> </span>
<a href="#l2.6"></a><span id="l2.6"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l2.7"></a><span id="l2.7"> // async support</span>
<a href="#l2.8"></a><span id="l2.8"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l2.9"></a><span id="l2.9"> load(&quot;../../../resources/mailTestUtils.js&quot;);</span>
<a href="#l2.10"></a><span id="l2.10"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+</span>
<a href="#l2.14"></a><span id="l2.14"> var tests = [</span>
<a href="#l2.15"></a><span id="l2.15">   checkStatSelect,</span>
<a href="#l2.16"></a><span id="l2.16">   checkStatNoSelect,</span>
<a href="#l2.17"></a><span id="l2.17">   endTest</span>
<a href="#l2.18"></a><span id="l2.18"> ];</span>
<a href="#l2.19"></a><span id="l2.19"> </span>
<a href="#l2.20"></a><span id="l2.20"> function run_test() {</span>
<a href="#l2.21"></a><span id="l2.21">   var daemon = new imapDaemon();</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineat">@@ -28,27 +30,25 @@ function run_test() {</span>
<a href="#l2.23"></a><span id="l2.23">   gServer = makeServer(daemon, &quot;&quot;);</span>
<a href="#l2.24"></a><span id="l2.24"> </span>
<a href="#l2.25"></a><span id="l2.25">   gImapServer = createLocalIMAPServer();</span>
<a href="#l2.26"></a><span id="l2.26">   gImapServer.maximumConnectionsNumber = 1;</span>
<a href="#l2.27"></a><span id="l2.27"> </span>
<a href="#l2.28"></a><span id="l2.28">   loadLocalMailAccount();</span>
<a href="#l2.29"></a><span id="l2.29"> </span>
<a href="#l2.30"></a><span id="l2.30">   // We need an identity so that updateFolder doesn't fail</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-  let acctMgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">-                  .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineminus">-  let localAccount = acctMgr.createAccount();</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineminus">-  let identity = acctMgr.createIdentity();</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+  let localAccount = MailServices.accounts.createAccount();</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+  let identity = MailServices.accounts.createIdentity();</span>
<a href="#l2.37"></a><span id="l2.37">   localAccount.addIdentity(identity);</span>
<a href="#l2.38"></a><span id="l2.38">   localAccount.defaultIdentity = identity;</span>
<a href="#l2.39"></a><span id="l2.39">   localAccount.incomingServer = gLocalIncomingServer;</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineminus">-  acctMgr.defaultAccount = localAccount;</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+  MailServices.accounts.defaultAccount = localAccount;</span>
<a href="#l2.42"></a><span id="l2.42"> </span>
<a href="#l2.43"></a><span id="l2.43">   // Let's also have another account, using the same identity</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineminus">-  let imapAccount = acctMgr.createAccount();</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineplus">+  let imapAccount = MailServices.accounts.createAccount();</span>
<a href="#l2.46"></a><span id="l2.46">   imapAccount.addIdentity(identity);</span>
<a href="#l2.47"></a><span id="l2.47">   imapAccount.defaultIdentity = identity;</span>
<a href="#l2.48"></a><span id="l2.48">   imapAccount.incomingServer = gImapServer;</span>
<a href="#l2.49"></a><span id="l2.49"> </span>
<a href="#l2.50"></a><span id="l2.50">   // Get the folder list...</span>
<a href="#l2.51"></a><span id="l2.51">   gImapServer.performExpand(null);</span>
<a href="#l2.52"></a><span id="l2.52">   gServer.performTest(&quot;SUBSCRIBE&quot;);</span>
<a href="#l2.53"></a><span id="l2.53">   // pref tuning: one connection only, turn off notifications</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineat">@@ -89,20 +89,18 @@ function checkStatNoSelect() {</span>
<a href="#l2.55"></a><span id="l2.55">   // is that folder 2 was stat'd and that its unread msg count is 1</span>
<a href="#l2.56"></a><span id="l2.56">   do_check_eq(gFolder2.getNumUnread(false), 1);</span>
<a href="#l2.57"></a><span id="l2.57">   addMessageToFolder(gFolder2Mailbox);</span>
<a href="#l2.58"></a><span id="l2.58">   gFolder1.clearFlag(Ci.nsMsgFolderFlags.ImapNoselect);</span>
<a href="#l2.59"></a><span id="l2.59">   gServer._test = true;</span>
<a href="#l2.60"></a><span id="l2.60">   // we've cleared the ImapNoselect flag, so we will attempt to STAT folder 1,</span>
<a href="#l2.61"></a><span id="l2.61">   // which will fail. So we verify that we go on and STAT folder 2, and that</span>
<a href="#l2.62"></a><span id="l2.62">   // it picks up the message we added to it above.</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineminus">-  let mailSession = Cc[&quot;@mozilla.org/messenger/services/session;1&quot;].</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineminus">-    getService(Ci.nsIMsgMailSession);</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineminus">-  mailSession.AddFolderListener(gFolderListener,</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineminus">-                                Ci.nsIFolderListener.boolPropertyChanged);</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineplus">+  MailServices.mailSession.AddFolderListener(gFolderListener,</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineplus">+                                             Ci.nsIFolderListener.boolPropertyChanged);</span>
<a href="#l2.69"></a><span id="l2.69">   gIMAPInbox.getNewMessages(null, null);</span>
<a href="#l2.70"></a><span id="l2.70">   // Wait for the folder listener to get told about new messages.</span>
<a href="#l2.71"></a><span id="l2.71">   yield false;</span>
<a href="#l2.72"></a><span id="l2.72"> }</span>
<a href="#l2.73"></a><span id="l2.73"> </span>
<a href="#l2.74"></a><span id="l2.74"> function addMessageToFolder(mbox) {</span>
<a href="#l2.75"></a><span id="l2.75">   // make a couple messges</span>
<a href="#l2.76"></a><span id="l2.76">   let messages = [];</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_filterNeedsBody.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_filterNeedsBody.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -6,16 +6,18 @@</span>
<a href="#l3.4"></a><span id="l3.4">  * adapted from test_imapFilterActions.js</span>
<a href="#l3.5"></a><span id="l3.5">  */</span>
<a href="#l3.6"></a><span id="l3.6"> </span>
<a href="#l3.7"></a><span id="l3.7"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l3.8"></a><span id="l3.8"> load(&quot;../../../resources/mailTestUtils.js&quot;);</span>
<a href="#l3.9"></a><span id="l3.9"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l3.10"></a><span id="l3.10"> load(&quot;../../../resources/IMAPpump.js&quot;);</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+</span>
<a href="#l3.14"></a><span id="l3.14"> // Globals</span>
<a href="#l3.15"></a><span id="l3.15"> var gFilter; // a message filter with a subject search</span>
<a href="#l3.16"></a><span id="l3.16"> var gAction; // current message action (reused)</span>
<a href="#l3.17"></a><span id="l3.17"> const gMessage = &quot;draft1&quot;; // message file used as the test message</span>
<a href="#l3.18"></a><span id="l3.18"> </span>
<a href="#l3.19"></a><span id="l3.19"> // Definition of tests</span>
<a href="#l3.20"></a><span id="l3.20"> var tests = [</span>
<a href="#l3.21"></a><span id="l3.21">   setup,</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineat">@@ -47,19 +49,17 @@ function setup() {</span>
<a href="#l3.23"></a><span id="l3.23"> </span>
<a href="#l3.24"></a><span id="l3.24">   gFilter.appendTerm(searchTerm);</span>
<a href="#l3.25"></a><span id="l3.25">   gFilter.enabled = true;</span>
<a href="#l3.26"></a><span id="l3.26"> </span>
<a href="#l3.27"></a><span id="l3.27">   // an action that can be modified by tests</span>
<a href="#l3.28"></a><span id="l3.28">   gAction = gFilter.createAction();</span>
<a href="#l3.29"></a><span id="l3.29"> </span>
<a href="#l3.30"></a><span id="l3.30">   // add the custom actions</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-  var filterService = Cc[&quot;@mozilla.org/messenger/services/filters;1&quot;]</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineminus">-                        .getService(Ci.nsIMsgFilterService);</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineminus">-  filterService.addCustomAction(actionTestOffline);</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+  MailServices.filters.addCustomAction(actionTestOffline);</span>
<a href="#l3.35"></a><span id="l3.35"> }</span>
<a href="#l3.36"></a><span id="l3.36"> </span>
<a href="#l3.37"></a><span id="l3.37"> // basic preparation done for each test</span>
<a href="#l3.38"></a><span id="l3.38"> function runFilterAction(aFilter, aAction) {</span>
<a href="#l3.39"></a><span id="l3.39">   let filterList = gIMAPIncomingServer.getFilterList(null);</span>
<a href="#l3.40"></a><span id="l3.40">   while (filterList.filterCount)</span>
<a href="#l3.41"></a><span id="l3.41">     filterList.removeFilterAt(0);</span>
<a href="#l3.42"></a><span id="l3.42">   if (aFilter) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapAttachmentSaves.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapAttachmentSaves.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -9,16 +9,17 @@</span>
<a href="#l4.4"></a><span id="l4.4"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l4.5"></a><span id="l4.5"> load(&quot;../../../resources/mailTestUtils.js&quot;);</span>
<a href="#l4.6"></a><span id="l4.6"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l4.7"></a><span id="l4.7"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l4.8"></a><span id="l4.8"> </span>
<a href="#l4.9"></a><span id="l4.9"> // javascript mime emitter functions</span>
<a href="#l4.10"></a><span id="l4.10"> mimeMsg = {};</span>
<a href="#l4.11"></a><span id="l4.11"> Components.utils.import(&quot;resource:///modules/gloda/mimemsg.js&quot;, mimeMsg);</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l4.13"></a><span id="l4.13"> </span>
<a href="#l4.14"></a><span id="l4.14"> // IMAP pump</span>
<a href="#l4.15"></a><span id="l4.15"> load(&quot;../../../resources/IMAPpump.js&quot;);</span>
<a href="#l4.16"></a><span id="l4.16"> </span>
<a href="#l4.17"></a><span id="l4.17"> const kAttachFileName = 'bob.txt';</span>
<a href="#l4.18"></a><span id="l4.18"> </span>
<a href="#l4.19"></a><span id="l4.19"> setupIMAPPump();</span>
<a href="#l4.20"></a><span id="l4.20"> </span>
<a href="#l4.21"></a><span id="l4.21" class="difflineat">@@ -131,26 +132,23 @@ SaveAttachmentCallback.prototype = {</span>
<a href="#l4.22"></a><span id="l4.22">   }</span>
<a href="#l4.23"></a><span id="l4.23"> }</span>
<a href="#l4.24"></a><span id="l4.24"> let gCallbackObject = new SaveAttachmentCallback();</span>
<a href="#l4.25"></a><span id="l4.25"> </span>
<a href="#l4.26"></a><span id="l4.26"> function run_test()</span>
<a href="#l4.27"></a><span id="l4.27"> {</span>
<a href="#l4.28"></a><span id="l4.28">   // Add folder listeners that will capture async events</span>
<a href="#l4.29"></a><span id="l4.29">   const nsIMFNService = Ci.nsIMsgFolderNotificationService;</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineminus">-  let MFNService = Cc[&quot;@mozilla.org/messenger/msgnotificationservice;1&quot;]</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">-                      .getService(nsIMFNService);</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineminus">-  MFNService.addListener(mfnListener, nsIMFNService.msgsDeleted);</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+  MailServices.mfn.addListener(mfnListener, nsIMFNService.msgsDeleted);</span>
<a href="#l4.34"></a><span id="l4.34"> </span>
<a href="#l4.35"></a><span id="l4.35">   // We need to register the dummyMsgWindow so that when we've finished running</span>
<a href="#l4.36"></a><span id="l4.36">   // the append url, in nsImapMailFolder::OnStopRunningUrl, we'll think the</span>
<a href="#l4.37"></a><span id="l4.37">   // Inbox is open in a folder and update it, which the detach code relies</span>
<a href="#l4.38"></a><span id="l4.38">   // on to finish the detach.</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineminus">-  Cc[&quot;@mozilla.org/messenger/services/session;1&quot;]</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineminus">-    .getService(Ci.nsIMsgMailSession).AddMsgWindow(dummyMsgWindow);</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+  MailServices.mailSession.AddMsgWindow(dummyMsgWindow);</span>
<a href="#l4.42"></a><span id="l4.42"> </span>
<a href="#l4.43"></a><span id="l4.43">   async_run_tests(tests);</span>
<a href="#l4.44"></a><span id="l4.44"> }</span>
<a href="#l4.45"></a><span id="l4.45"> </span>
<a href="#l4.46"></a><span id="l4.46"> /*</span>
<a href="#l4.47"></a><span id="l4.47">  * Get the full message content.</span>
<a href="#l4.48"></a><span id="l4.48">  *</span>
<a href="#l4.49"></a><span id="l4.49">  * aMsgHdr: nsIMsgDBHdr object whose text body will be read</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapAuthMethods.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapAuthMethods.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -6,23 +6,23 @@</span>
<a href="#l5.4"></a><span id="l5.4">  *</span>
<a href="#l5.5"></a><span id="l5.5">  * BUGS:</span>
<a href="#l5.6"></a><span id="l5.6">  * - cleanup after each test doesn't seem to work correctly. Effects:</span>
<a href="#l5.7"></a><span id="l5.7">  *    - one more &quot;lsub&quot; per test, e.g. &quot;capability&quot;, &quot;auth...&quot;, &quot;lsub&quot;, &quot;lsub&quot;, &quot;lsub&quot;, &quot;list&quot; in the 3. test.,</span>
<a href="#l5.8"></a><span id="l5.8">  *    - root folder check succeeds although login failed</span>
<a href="#l5.9"></a><span id="l5.9">  * - removeIncomingServer(..., true); (cleanup files) fails.</span>
<a href="#l5.10"></a><span id="l5.10">  */</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l5.13"></a><span id="l5.13"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l5.14"></a><span id="l5.14"> load(&quot;../../../resources/alertTestUtils.js&quot;);</span>
<a href="#l5.15"></a><span id="l5.15"> </span>
<a href="#l5.16"></a><span id="l5.16"> //const kUsername = &quot;fred&quot;;</span>
<a href="#l5.17"></a><span id="l5.17"> //const kPassword = &quot;wilma&quot;;</span>
<a href="#l5.18"></a><span id="l5.18"> </span>
<a href="#l5.19"></a><span id="l5.19" class="difflineminus">-var acctMgr;</span>
<a href="#l5.20"></a><span id="l5.20"> var thisTest;</span>
<a href="#l5.21"></a><span id="l5.21"> var test = null;</span>
<a href="#l5.22"></a><span id="l5.22"> </span>
<a href="#l5.23"></a><span id="l5.23"> var tests = [</span>
<a href="#l5.24"></a><span id="l5.24">   { title: &quot;Cleartext password, with server only supporting old-style login&quot;,</span>
<a href="#l5.25"></a><span id="l5.25">     clientAuthMethod : Ci.nsMsgAuthMethod.passwordCleartext,</span>
<a href="#l5.26"></a><span id="l5.26">     serverAuthMethods : [],</span>
<a href="#l5.27"></a><span id="l5.27">     expectSuccess : true,</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineat">@@ -111,45 +111,43 @@ function nextTest() {</span>
<a href="#l5.29"></a><span id="l5.29">     do_check_transaction(server.playTransaction(), thisTest.transaction, false);</span>
<a href="#l5.30"></a><span id="l5.30"> </span>
<a href="#l5.31"></a><span id="l5.31">     do {</span>
<a href="#l5.32"></a><span id="l5.32">       incomingServer.closeCachedConnections();</span>
<a href="#l5.33"></a><span id="l5.33">     } while (incomingServer.serverBusy)</span>
<a href="#l5.34"></a><span id="l5.34">     incomingServer.shutdown();</span>
<a href="#l5.35"></a><span id="l5.35">     incomingServer.clearAllValues();</span>
<a href="#l5.36"></a><span id="l5.36">     deleteIMAPServer(incomingServer);</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineminus">-    acctMgr.closeCachedConnections();</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineminus">-    acctMgr.shutdownServers();</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineminus">-    acctMgr.UnloadAccounts();</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineplus">+    MailServices.accounts.closeCachedConnections();</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineplus">+    MailServices.accounts.shutdownServers();</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineplus">+    MailServices.accounts.UnloadAccounts();</span>
<a href="#l5.43"></a><span id="l5.43">     server.stop();</span>
<a href="#l5.44"></a><span id="l5.44"> </span>
<a href="#l5.45"></a><span id="l5.45">   } catch (e) {</span>
<a href="#l5.46"></a><span id="l5.46">     //server.stop();</span>
<a href="#l5.47"></a><span id="l5.47">     //endTest();</span>
<a href="#l5.48"></a><span id="l5.48">     do_throw(e);</span>
<a href="#l5.49"></a><span id="l5.49">   }</span>
<a href="#l5.50"></a><span id="l5.50"> </span>
<a href="#l5.51"></a><span id="l5.51">   nextTest();</span>
<a href="#l5.52"></a><span id="l5.52"> }</span>
<a href="#l5.53"></a><span id="l5.53"> </span>
<a href="#l5.54"></a><span id="l5.54"> function deleteIMAPServer(incomingServer) {</span>
<a href="#l5.55"></a><span id="l5.55">   if (!incomingServer)</span>
<a href="#l5.56"></a><span id="l5.56">     return;</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineminus">-  acctMgr.removeIncomingServer(incomingServer, false); // TODO cleanup files = true fails</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineplus">+  MailServices.accounts.removeIncomingServer(incomingServer, false); // TODO cleanup files = true fails</span>
<a href="#l5.59"></a><span id="l5.59">   //incomingServer = null;</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineminus">-  acctMgr.removeAccount(acctMgr.defaultAccount);</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineplus">+  MailServices.accounts.removeAccount(MailServices.accounts.defaultAccount);</span>
<a href="#l5.62"></a><span id="l5.62"> }</span>
<a href="#l5.63"></a><span id="l5.63"> </span>
<a href="#l5.64"></a><span id="l5.64"> </span>
<a href="#l5.65"></a><span id="l5.65"> function run_test() {</span>
<a href="#l5.66"></a><span id="l5.66">   do_test_pending();</span>
<a href="#l5.67"></a><span id="l5.67"> </span>
<a href="#l5.68"></a><span id="l5.68">   registerAlertTestUtils();</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineminus">-  acctMgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineminus">-                  .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l5.71"></a><span id="l5.71"> </span>
<a href="#l5.72"></a><span id="l5.72">   nextTest();</span>
<a href="#l5.73"></a><span id="l5.73"> }</span>
<a href="#l5.74"></a><span id="l5.74"> </span>
<a href="#l5.75"></a><span id="l5.75"> function endTest() {</span>
<a href="#l5.76"></a><span id="l5.76">   var thread = gThreadManager.currentThread;</span>
<a href="#l5.77"></a><span id="l5.77">   while (thread.hasPendingEvents())</span>
<a href="#l5.78"></a><span id="l5.78">     thread.processNextEvent(true);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapAutoSync.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapAutoSync.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -22,16 +22,17 @@ load(&quot;../../../resources/IMAPpump.js&quot;);</span>
<a href="#l6.4"></a><span id="l6.4"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l6.5"></a><span id="l6.5"> </span>
<a href="#l6.6"></a><span id="l6.6"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l6.7"></a><span id="l6.7"> </span>
<a href="#l6.8"></a><span id="l6.8"> load(&quot;../../../resources/alertTestUtils.js&quot;);</span>
<a href="#l6.9"></a><span id="l6.9"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l6.10"></a><span id="l6.10"> </span>
<a href="#l6.11"></a><span id="l6.11"> // Globals</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l6.13"></a><span id="l6.13"> </span>
<a href="#l6.14"></a><span id="l6.14"> setupIMAPPump();</span>
<a href="#l6.15"></a><span id="l6.15"> </span>
<a href="#l6.16"></a><span id="l6.16"> const msgFlagOffline = Ci.nsMsgMessageFlags.Offline;</span>
<a href="#l6.17"></a><span id="l6.17"> </span>
<a href="#l6.18"></a><span id="l6.18"> var gGotAlert;</span>
<a href="#l6.19"></a><span id="l6.19"> </span>
<a href="#l6.20"></a><span id="l6.20"> var gAutoSyncManager = Cc[&quot;@mozilla.org/imap/autosyncmgr;1&quot;]</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineat">@@ -103,20 +104,18 @@ function test_moveMessageToTargetFolder(</span>
<a href="#l6.22"></a><span id="l6.22">   observer.observe(null, &quot;mail:appIdle&quot;, &quot;back&quot;);</span>
<a href="#l6.23"></a><span id="l6.23">   let msgHdr = firstMsgHdr(gIMAPInbox);</span>
<a href="#l6.24"></a><span id="l6.24">   do_check_neq(msgHdr, null);</span>
<a href="#l6.25"></a><span id="l6.25"> </span>
<a href="#l6.26"></a><span id="l6.26">   // Now move this message to the target folder.</span>
<a href="#l6.27"></a><span id="l6.27">   let messages = Cc[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l6.28"></a><span id="l6.28">                    .createInstance(Ci.nsIMutableArray);</span>
<a href="#l6.29"></a><span id="l6.29">   messages.appendElement(msgHdr, false);</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineminus">-  let copyService = Cc[&quot;@mozilla.org/messenger/messagecopyservice;1&quot;]</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-                      .getService(Ci.nsIMsgCopyService);</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineminus">-  copyService.CopyMessages(gIMAPInbox, messages, gTargetFolder, true,</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineminus">-                           CopyListener, null, false);</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+  MailServices.copy.CopyMessages(gIMAPInbox, messages, gTargetFolder, true,</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+                                 CopyListener, null, false);</span>
<a href="#l6.36"></a><span id="l6.36">   yield false;</span>
<a href="#l6.37"></a><span id="l6.37"> }</span>
<a href="#l6.38"></a><span id="l6.38"> </span>
<a href="#l6.39"></a><span id="l6.39"> function test_waitForTargetUpdate()</span>
<a href="#l6.40"></a><span id="l6.40"> {</span>
<a href="#l6.41"></a><span id="l6.41">   // After the copy, now we expect to get notified of the gTargetFolder</span>
<a href="#l6.42"></a><span id="l6.42">   // getting updated, after we simulate going idle.</span>
<a href="#l6.43"></a><span id="l6.43">   gAutoSyncListener._waitingForUpdate = true;</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineat">@@ -142,23 +141,21 @@ function endTest()</span>
<a href="#l6.45"></a><span id="l6.45">   do_check_false(gAutoSyncListener._waitingForUpdate);</span>
<a href="#l6.46"></a><span id="l6.46">   teardownIMAPPump();</span>
<a href="#l6.47"></a><span id="l6.47"> }</span>
<a href="#l6.48"></a><span id="l6.48"> </span>
<a href="#l6.49"></a><span id="l6.49"> function run_test()</span>
<a href="#l6.50"></a><span id="l6.50"> {</span>
<a href="#l6.51"></a><span id="l6.51">   // Add folder listeners that will capture async events</span>
<a href="#l6.52"></a><span id="l6.52">   const nsIMFNService = Ci.nsIMsgFolderNotificationService;</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineminus">-  let MFNService = Cc[&quot;@mozilla.org/messenger/msgnotificationservice;1&quot;]</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineminus">-                      .getService(nsIMFNService);</span>
<a href="#l6.55"></a><span id="l6.55">   let flags =</span>
<a href="#l6.56"></a><span id="l6.56">         nsIMFNService.folderAdded |</span>
<a href="#l6.57"></a><span id="l6.57">         nsIMFNService.msgsMoveCopyCompleted |</span>
<a href="#l6.58"></a><span id="l6.58">         nsIMFNService.msgAdded;</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineminus">-  MFNService.addListener(mfnListener, flags);</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineplus">+  MailServices.mfn.addListener(mfnListener, flags);</span>
<a href="#l6.61"></a><span id="l6.61">   addMessageToFolder(gIMAPInbox);</span>
<a href="#l6.62"></a><span id="l6.62"> </span>
<a href="#l6.63"></a><span id="l6.63">   async_run_tests(tests);</span>
<a href="#l6.64"></a><span id="l6.64"> }</span>
<a href="#l6.65"></a><span id="l6.65"> </span>
<a href="#l6.66"></a><span id="l6.66"> // listeners for various events to drive the tests.</span>
<a href="#l6.67"></a><span id="l6.67"> </span>
<a href="#l6.68"></a><span id="l6.68"> mfnListener =</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapContentLength.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapContentLength.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -11,22 +11,22 @@</span>
<a href="#l7.4"></a><span id="l7.4">  * that are run externally.</span>
<a href="#l7.5"></a><span id="l7.5">  */</span>
<a href="#l7.6"></a><span id="l7.6"> </span>
<a href="#l7.7"></a><span id="l7.7"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l7.8"></a><span id="l7.8"> load(&quot;../../../resources/mailTestUtils.js&quot;);</span>
<a href="#l7.9"></a><span id="l7.9"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l7.10"></a><span id="l7.10"> load(&quot;../../../resources/IMAPpump.js&quot;);</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+</span>
<a href="#l7.14"></a><span id="l7.14"> var gMsgHdr = null;</span>
<a href="#l7.15"></a><span id="l7.15"> </span>
<a href="#l7.16"></a><span id="l7.16"> // Take a multipart message as we're testing attachment URLs as well</span>
<a href="#l7.17"></a><span id="l7.17"> const gFile = do_get_file(&quot;../../../data/multipart-complex2&quot;);</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineminus">-const gMFNService = Cc[&quot;@mozilla.org/messenger/msgnotificationservice;1&quot;]</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineminus">-                      .getService(Ci.nsIMsgFolderNotificationService);</span>
<a href="#l7.20"></a><span id="l7.20">                    </span>
<a href="#l7.21"></a><span id="l7.21"> var tests = [</span>
<a href="#l7.22"></a><span id="l7.22">   setup,</span>
<a href="#l7.23"></a><span id="l7.23">   addMessageToServer,</span>
<a href="#l7.24"></a><span id="l7.24">   verifyContentLength,</span>
<a href="#l7.25"></a><span id="l7.25">   teardown</span>
<a href="#l7.26"></a><span id="l7.26"> ];</span>
<a href="#l7.27"></a><span id="l7.27"> </span>
<a href="#l7.28"></a><span id="l7.28" class="difflineat">@@ -45,17 +45,17 @@ var msgFolderListener = {</span>
<a href="#l7.29"></a><span id="l7.29">     do_execute_soon(async_driver);</span>
<a href="#l7.30"></a><span id="l7.30">   },</span>
<a href="#l7.31"></a><span id="l7.31"> };</span>
<a href="#l7.32"></a><span id="l7.32"> </span>
<a href="#l7.33"></a><span id="l7.33"> function setup() {</span>
<a href="#l7.34"></a><span id="l7.34">   setupIMAPPump();</span>
<a href="#l7.35"></a><span id="l7.35"> </span>
<a href="#l7.36"></a><span id="l7.36">   // Set up nsIMsgFolderListener to get the header when it's received</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineminus">-  gMFNService.addListener(msgFolderListener, gMFNService.msgAdded);</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineplus">+  MailServices.mfn.addListener(msgFolderListener, MailServices.mfn.msgAdded);</span>
<a href="#l7.39"></a><span id="l7.39"> </span>
<a href="#l7.40"></a><span id="l7.40">   gIMAPInbox.flags &amp;= ~Ci.nsMsgFolderFlags.Offline;</span>
<a href="#l7.41"></a><span id="l7.41"> }</span>
<a href="#l7.42"></a><span id="l7.42"> </span>
<a href="#l7.43"></a><span id="l7.43"> function verifyContentLength() {</span>
<a href="#l7.44"></a><span id="l7.44">   let messageUri = gIMAPInbox.getUriForMsg(gMsgHdr);</span>
<a href="#l7.45"></a><span id="l7.45">   // Convert this to a URI that necko can run</span>
<a href="#l7.46"></a><span id="l7.46">   let messenger = Cc[&quot;@mozilla.org/messenger;1&quot;].createInstance(Ci.nsIMessenger);</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineat">@@ -75,15 +75,15 @@ function verifyContentLength() {</span>
<a href="#l7.48"></a><span id="l7.48">                                         null, null);</span>
<a href="#l7.49"></a><span id="l7.49">   let attachmentChannel = Services.io.newChannelFromURI(attachmentURL);</span>
<a href="#l7.50"></a><span id="l7.50">   // Currently attachments have their content length set to the length of the</span>
<a href="#l7.51"></a><span id="l7.51">   // entire message</span>
<a href="#l7.52"></a><span id="l7.52">   do_check_eq(attachmentChannel.contentLength, gFile.fileSize);</span>
<a href="#l7.53"></a><span id="l7.53"> }</span>
<a href="#l7.54"></a><span id="l7.54"> </span>
<a href="#l7.55"></a><span id="l7.55"> function teardown() {</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineminus">-  gMFNService.removeListener(msgFolderListener);</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineplus">+  MailServices.mfn.removeListener(msgFolderListener);</span>
<a href="#l7.58"></a><span id="l7.58">   teardownIMAPPump();</span>
<a href="#l7.59"></a><span id="l7.59"> }</span>
<a href="#l7.60"></a><span id="l7.60"> </span>
<a href="#l7.61"></a><span id="l7.61"> function run_test() {</span>
<a href="#l7.62"></a><span id="l7.62">   async_run_tests(tests);</span>
<a href="#l7.63"></a><span id="l7.63"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapCopyTimeout.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapCopyTimeout.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -13,16 +13,17 @@ load(&quot;../../../resources/mailTestUtils.j</span>
<a href="#l8.4"></a><span id="l8.4"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l8.5"></a><span id="l8.5"> load(&quot;../../../resources/alertTestUtils.js&quot;);</span>
<a href="#l8.6"></a><span id="l8.6"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l8.7"></a><span id="l8.7"> </span>
<a href="#l8.8"></a><span id="l8.8"> // IMAP pump</span>
<a href="#l8.9"></a><span id="l8.9"> load(&quot;../../../resources/IMAPpump.js&quot;);</span>
<a href="#l8.10"></a><span id="l8.10"> </span>
<a href="#l8.11"></a><span id="l8.11"> // Globals</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l8.13"></a><span id="l8.13"> </span>
<a href="#l8.14"></a><span id="l8.14"> setupIMAPPump();</span>
<a href="#l8.15"></a><span id="l8.15"> </span>
<a href="#l8.16"></a><span id="l8.16"> var gGotAlert = false;</span>
<a href="#l8.17"></a><span id="l8.17"> var gGotMsgAdded = false;</span>
<a href="#l8.18"></a><span id="l8.18"> </span>
<a href="#l8.19"></a><span id="l8.19"> function alert(aDialogTitle, aText) {</span>
<a href="#l8.20"></a><span id="l8.20">   do_check_true(aText.startsWith(&quot;Connection to server Mail for  timed out.&quot;));</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineat">@@ -89,22 +90,20 @@ function loadImapMessage()</span>
<a href="#l8.22"></a><span id="l8.22"> function moveMessageToTargetFolder()</span>
<a href="#l8.23"></a><span id="l8.23"> {</span>
<a href="#l8.24"></a><span id="l8.24">   let msgHdr = firstMsgHdr(gIMAPInbox);</span>
<a href="#l8.25"></a><span id="l8.25"> </span>
<a href="#l8.26"></a><span id="l8.26">   // Now move this message to the target folder.</span>
<a href="#l8.27"></a><span id="l8.27">   var messages = Cc[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l8.28"></a><span id="l8.28">                    .createInstance(Ci.nsIMutableArray);</span>
<a href="#l8.29"></a><span id="l8.29">   messages.appendElement(msgHdr, false);</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineminus">-  let copyService = Cc[&quot;@mozilla.org/messenger/messagecopyservice;1&quot;]</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-                      .getService(Ci.nsIMsgCopyService);</span>
<a href="#l8.32"></a><span id="l8.32">   // This should cause the move to be done as an offline imap operation</span>
<a href="#l8.33"></a><span id="l8.33">   // that's played back immediately.</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineminus">-  copyService.CopyMessages(gIMAPInbox, messages, gTargetFolder, true,</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineminus">-                           CopyListener, gDummyMsgWindow, true);</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineplus">+  MailServices.copy.CopyMessages(gIMAPInbox, messages, gTargetFolder, true,</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineplus">+                                 CopyListener, gDummyMsgWindow, true);</span>
<a href="#l8.38"></a><span id="l8.38">   yield false;</span>
<a href="#l8.39"></a><span id="l8.39"> }</span>
<a href="#l8.40"></a><span id="l8.40"> </span>
<a href="#l8.41"></a><span id="l8.41"> function waitForOfflinePlayback()</span>
<a href="#l8.42"></a><span id="l8.42"> {</span>
<a href="#l8.43"></a><span id="l8.43">   // just wait for the alert about timed out connection.</span>
<a href="#l8.44"></a><span id="l8.44">   yield false;</span>
<a href="#l8.45"></a><span id="l8.45">   // then, wait for a second so we don't get our next url aborted.</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineat">@@ -153,16 +152,14 @@ mfnListener =</span>
<a href="#l8.47"></a><span id="l8.47"> </span>
<a href="#l8.48"></a><span id="l8.48"> };</span>
<a href="#l8.49"></a><span id="l8.49"> </span>
<a href="#l8.50"></a><span id="l8.50"> function run_test()</span>
<a href="#l8.51"></a><span id="l8.51"> {</span>
<a href="#l8.52"></a><span id="l8.52">   Services.prefs.setBoolPref(&quot;mail.server.default.autosync_offline_stores&quot;, false);</span>
<a href="#l8.53"></a><span id="l8.53">   // Add folder listeners that will capture async events</span>
<a href="#l8.54"></a><span id="l8.54">   const nsIMFNService = Ci.nsIMsgFolderNotificationService;</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineminus">-  let MFNService = Cc[&quot;@mozilla.org/messenger/msgnotificationservice;1&quot;]</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineminus">-                      .getService(nsIMFNService);</span>
<a href="#l8.57"></a><span id="l8.57">   let flags =</span>
<a href="#l8.58"></a><span id="l8.58">         nsIMFNService.folderAdded |</span>
<a href="#l8.59"></a><span id="l8.59">         nsIMFNService.msgAdded;</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineminus">-  MFNService.addListener(mfnListener, flags);</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineplus">+  MailServices.mfn.addListener(mfnListener, flags);</span>
<a href="#l8.62"></a><span id="l8.62">   async_run_tests(tests);</span>
<a href="#l8.63"></a><span id="l8.63"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapFilterActions.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapFilterActions.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -6,16 +6,17 @@</span>
<a href="#l9.4"></a><span id="l9.4">  * flags, if any, are not tested.</span>
<a href="#l9.5"></a><span id="l9.5">  *</span>
<a href="#l9.6"></a><span id="l9.6">  * Original author: Kent James &lt;kent@caspia.com&gt;</span>
<a href="#l9.7"></a><span id="l9.7">  * adapted from test_localToImapFilter.js</span>
<a href="#l9.8"></a><span id="l9.8">  */</span>
<a href="#l9.9"></a><span id="l9.9"> </span>
<a href="#l9.10"></a><span id="l9.10"> Components.utils.import(&quot;resource:///modules/folderUtils.jsm&quot;);</span>
<a href="#l9.11"></a><span id="l9.11"> Components.utils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l9.13"></a><span id="l9.13"> </span>
<a href="#l9.14"></a><span id="l9.14"> const nsMsgSearchScope = Ci.nsMsgSearchScope;</span>
<a href="#l9.15"></a><span id="l9.15"> const nsMsgSearchAttrib = Ci.nsMsgSearchAttrib;</span>
<a href="#l9.16"></a><span id="l9.16"> const nsMsgSearchOp = Ci.nsMsgSearchOp;</span>
<a href="#l9.17"></a><span id="l9.17"> const Is = nsMsgSearchOp.Is;</span>
<a href="#l9.18"></a><span id="l9.18"> const Contains = nsMsgSearchOp.Contains;</span>
<a href="#l9.19"></a><span id="l9.19"> const Subject = nsMsgSearchAttrib.Subject;</span>
<a href="#l9.20"></a><span id="l9.20"> const Body = nsMsgSearchAttrib.Body;</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineat">@@ -45,22 +46,19 @@ const gMessage = &quot;draft1&quot;; // message fi</span>
<a href="#l9.22"></a><span id="l9.22"> </span>
<a href="#l9.23"></a><span id="l9.23"> // subject of the test message</span>
<a href="#l9.24"></a><span id="l9.24"> const gMessageSubject = &quot;Hello, did you receive my bugmail?&quot;;</span>
<a href="#l9.25"></a><span id="l9.25"> </span>
<a href="#l9.26"></a><span id="l9.26"> // a string in the body of the test message</span>
<a href="#l9.27"></a><span id="l9.27"> const gMessageInBody = &quot;an HTML message&quot;;</span>
<a href="#l9.28"></a><span id="l9.28"> </span>
<a href="#l9.29"></a><span id="l9.29"> // various object references</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineminus">-const gCopyService = Cc[&quot;@mozilla.org/messenger/messagecopyservice;1&quot;]</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineminus">-                       .getService(Ci.nsIMsgCopyService);</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+const gCopyService = MailServices.copy;</span>
<a href="#l9.33"></a><span id="l9.33"> const gDbService = Components.classes[&quot;@mozilla.org/msgDatabase/msgDBService;1&quot;]</span>
<a href="#l9.34"></a><span id="l9.34">                              .getService(Components.interfaces.nsIMsgDBService);</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineminus">-const gMailSession = Cc[&quot;@mozilla.org/messenger/services/session;1&quot;]</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineminus">-                     .getService(Ci.nsIMsgMailSession);</span>
<a href="#l9.37"></a><span id="l9.37"> const kFiltersAppliedAtom = Cc[&quot;@mozilla.org/atom-service;1&quot;]</span>
<a href="#l9.38"></a><span id="l9.38">                               .getService(Ci.nsIAtomService)</span>
<a href="#l9.39"></a><span id="l9.39">                               .getAtom(&quot;FiltersApplied&quot;);</span>
<a href="#l9.40"></a><span id="l9.40"> const kDeleteOrMoveMsgCompleted = Cc[&quot;@mozilla.org/atom-service;1&quot;]</span>
<a href="#l9.41"></a><span id="l9.41">                                     .getService(Ci.nsIAtomService)</span>
<a href="#l9.42"></a><span id="l9.42">                                     .getAtom(&quot;DeleteOrMoveMsgCompleted&quot;);</span>
<a href="#l9.43"></a><span id="l9.43"> </span>
<a href="#l9.44"></a><span id="l9.44"> // Definition of tests. The test function name is the filter action</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineat">@@ -330,27 +328,25 @@ function run_test()</span>
<a href="#l9.46"></a><span id="l9.46">   gServer = makeServer(gIMAPDaemon, &quot;&quot;);</span>
<a href="#l9.47"></a><span id="l9.47"> </span>
<a href="#l9.48"></a><span id="l9.48">   gIMAPIncomingServer = createLocalIMAPServer();</span>
<a href="#l9.49"></a><span id="l9.49"> </span>
<a href="#l9.50"></a><span id="l9.50">   if (!gLocalInboxFolder)</span>
<a href="#l9.51"></a><span id="l9.51">     loadLocalMailAccount();</span>
<a href="#l9.52"></a><span id="l9.52"> </span>
<a href="#l9.53"></a><span id="l9.53">   // We need an identity so that updateFolder doesn't fail</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineminus">-  let acctMgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineminus">-                  .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineminus">-  let localAccount = acctMgr.createAccount();</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineminus">-  let identity = acctMgr.createIdentity();</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineplus">+  let localAccount = MailServices.accounts.createAccount();</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineplus">+  let identity = MailServices.accounts.createIdentity();</span>
<a href="#l9.60"></a><span id="l9.60">   localAccount.addIdentity(identity);</span>
<a href="#l9.61"></a><span id="l9.61">   localAccount.defaultIdentity = identity;</span>
<a href="#l9.62"></a><span id="l9.62">   localAccount.incomingServer = gLocalIncomingServer;</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineminus">-  acctMgr.defaultAccount = localAccount;</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineplus">+  MailServices.accounts.defaultAccount = localAccount;</span>
<a href="#l9.65"></a><span id="l9.65"> </span>
<a href="#l9.66"></a><span id="l9.66">   // Let's also have another account, using the same identity</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineminus">-  let imapAccount = acctMgr.createAccount();</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineplus">+  let imapAccount = MailServices.accounts.createAccount();</span>
<a href="#l9.69"></a><span id="l9.69">   imapAccount.addIdentity(identity);</span>
<a href="#l9.70"></a><span id="l9.70">   imapAccount.defaultIdentity = identity;</span>
<a href="#l9.71"></a><span id="l9.71">   imapAccount.incomingServer = gIMAPIncomingServer;</span>
<a href="#l9.72"></a><span id="l9.72"> </span>
<a href="#l9.73"></a><span id="l9.73">   // The server doesn't support more than one connection</span>
<a href="#l9.74"></a><span id="l9.74">   Services.prefs.setIntPref(&quot;mail.server.default.max_cached_connections&quot;, 1);</span>
<a href="#l9.75"></a><span id="l9.75">   // We aren't interested in downloading messages automatically</span>
<a href="#l9.76"></a><span id="l9.76">   Services.prefs.setBoolPref(&quot;mail.server.default.download_on_biff&quot;, false);</span>
<a href="#l9.77"></a><span id="l9.77" class="difflineat">@@ -400,17 +396,17 @@ function run_test()</span>
<a href="#l9.78"></a><span id="l9.78">   searchTerm.value = value;</span>
<a href="#l9.79"></a><span id="l9.79">   searchTerm.booleanAnd = false;</span>
<a href="#l9.80"></a><span id="l9.80">   gBodyFilter.appendTerm(searchTerm);</span>
<a href="#l9.81"></a><span id="l9.81">   gBodyFilter.enabled = true;</span>
<a href="#l9.82"></a><span id="l9.82"> </span>
<a href="#l9.83"></a><span id="l9.83">   // an action that can be modified by tests</span>
<a href="#l9.84"></a><span id="l9.84">   gAction = gFilter.createAction();</span>
<a href="#l9.85"></a><span id="l9.85"> </span>
<a href="#l9.86"></a><span id="l9.86" class="difflineminus">-  gMailSession.AddFolderListener(FolderListener, Ci.nsIFolderListener.event);</span>
<a href="#l9.87"></a><span id="l9.87" class="difflineplus">+  MailServices.mailSession.AddFolderListener(FolderListener, Ci.nsIFolderListener.event);</span>
<a href="#l9.88"></a><span id="l9.88"> </span>
<a href="#l9.89"></a><span id="l9.89">   // &quot;Master&quot; do_test_pending(), paired with a do_test_finished() at the end of</span>
<a href="#l9.90"></a><span id="l9.90">   // all the operations.</span>
<a href="#l9.91"></a><span id="l9.91">   do_test_pending();</span>
<a href="#l9.92"></a><span id="l9.92"> </span>
<a href="#l9.93"></a><span id="l9.93">   //start first test</span>
<a href="#l9.94"></a><span id="l9.94">   gCurTestNum = 1;</span>
<a href="#l9.95"></a><span id="l9.95">   doTest();</span>
<a href="#l9.96"></a><span id="l9.96" class="difflineat">@@ -505,17 +501,17 @@ function doTest()</span>
<a href="#l9.97"></a><span id="l9.97"> </span>
<a href="#l9.98"></a><span id="l9.98"> // Cleanup, null out everything, close all cached connections and stop the</span>
<a href="#l9.99"></a><span id="l9.99"> // server</span>
<a href="#l9.100"></a><span id="l9.100"> function endTest()</span>
<a href="#l9.101"></a><span id="l9.101"> {</span>
<a href="#l9.102"></a><span id="l9.102">   dump(&quot; Exiting mail tests\n&quot;);</span>
<a href="#l9.103"></a><span id="l9.103">   if (gInboxListener)</span>
<a href="#l9.104"></a><span id="l9.104">     gDbService.unregisterPendingListener(gInboxListener);</span>
<a href="#l9.105"></a><span id="l9.105" class="difflineminus">-  gMailSession.RemoveFolderListener(FolderListener);</span>
<a href="#l9.106"></a><span id="l9.106" class="difflineplus">+  MailServices.mailSession.RemoveFolderListener(FolderListener);</span>
<a href="#l9.107"></a><span id="l9.107">   gRootFolder = null;</span>
<a href="#l9.108"></a><span id="l9.108">   gIMAPInbox = null;</span>
<a href="#l9.109"></a><span id="l9.109">   gIMAPTrashFolder = null;</span>
<a href="#l9.110"></a><span id="l9.110">   gSubfolder = null;</span>
<a href="#l9.111"></a><span id="l9.111">   gServer.resetTest();</span>
<a href="#l9.112"></a><span id="l9.112">   gIMAPIncomingServer.closeCachedConnections();</span>
<a href="#l9.113"></a><span id="l9.113">   gServer.performTest();</span>
<a href="#l9.114"></a><span id="l9.114">   gServer.stop();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapFolderCopy.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapFolderCopy.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -4,46 +4,45 @@</span>
<a href="#l10.4"></a><span id="l10.4"> </span>
<a href="#l10.5"></a><span id="l10.5"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l10.6"></a><span id="l10.6"> load(&quot;../../../resources/mailTestUtils.js&quot;);</span>
<a href="#l10.7"></a><span id="l10.7"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l10.8"></a><span id="l10.8"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l10.9"></a><span id="l10.9"> load(&quot;../../../resources/IMAPpump.js&quot;);</span>
<a href="#l10.10"></a><span id="l10.10"> </span>
<a href="#l10.11"></a><span id="l10.11"> var gEmptyLocal1, gEmptyLocal2, gEmptyLocal3, gNotEmptyLocal4;</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-var gCopyService = Cc[&quot;@mozilla.org/messenger/messagecopyservice;1&quot;]</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-                .getService(Ci.nsIMsgCopyService);</span>
<a href="#l10.14"></a><span id="l10.14"> </span>
<a href="#l10.15"></a><span id="l10.15"> Components.utils.import(&quot;resource:///modules/folderUtils.jsm&quot;);</span>
<a href="#l10.16"></a><span id="l10.16"> Components.utils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l10.18"></a><span id="l10.18"> </span>
<a href="#l10.19"></a><span id="l10.19"> var tests = [</span>
<a href="#l10.20"></a><span id="l10.20">   setup,</span>
<a href="#l10.21"></a><span id="l10.21">   function copyFolder1() {</span>
<a href="#l10.22"></a><span id="l10.22">     dump(&quot;gEmpty1 &quot; + gEmptyLocal1.URI + &quot;\n&quot;);</span>
<a href="#l10.23"></a><span id="l10.23">     let folders = new Array;</span>
<a href="#l10.24"></a><span id="l10.24">     folders.push(gEmptyLocal1.QueryInterface(Ci.nsIMsgFolder));</span>
<a href="#l10.25"></a><span id="l10.25">     let array = toXPCOMArray(folders, Ci.nsIMutableArray);</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineminus">-    gCopyService.CopyFolders(array, gIMAPInbox, false, CopyListener, null);</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineplus">+    MailServices.copy.CopyFolders(array, gIMAPInbox, false, CopyListener, null);</span>
<a href="#l10.28"></a><span id="l10.28">     yield false;</span>
<a href="#l10.29"></a><span id="l10.29">   },</span>
<a href="#l10.30"></a><span id="l10.30">   function copyFolder2() {</span>
<a href="#l10.31"></a><span id="l10.31">     dump(&quot;gEmpty2 &quot; + gEmptyLocal2.URI + &quot;\n&quot;);</span>
<a href="#l10.32"></a><span id="l10.32">     let folders = new Array;</span>
<a href="#l10.33"></a><span id="l10.33">     folders.push(gEmptyLocal2);</span>
<a href="#l10.34"></a><span id="l10.34">     let array = toXPCOMArray(folders, Ci.nsIMutableArray);</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineminus">-    gCopyService.CopyFolders(array, gIMAPInbox, false, CopyListener, null);</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineplus">+    MailServices.copy.CopyFolders(array, gIMAPInbox, false, CopyListener, null);</span>
<a href="#l10.37"></a><span id="l10.37">     yield false;</span>
<a href="#l10.38"></a><span id="l10.38">   },</span>
<a href="#l10.39"></a><span id="l10.39">   function copyFolder3() {</span>
<a href="#l10.40"></a><span id="l10.40">     dump(&quot;gEmpty3 &quot; + gEmptyLocal3.URI + &quot;\n&quot;);</span>
<a href="#l10.41"></a><span id="l10.41">     let folders = new Array;</span>
<a href="#l10.42"></a><span id="l10.42">     folders.push(gEmptyLocal3);</span>
<a href="#l10.43"></a><span id="l10.43">     let array = toXPCOMArray(folders, Ci.nsIMutableArray);</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineminus">-    gCopyService.CopyFolders(array, gIMAPInbox, false, CopyListener, null);</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineplus">+    MailServices.copy.CopyFolders(array, gIMAPInbox, false, CopyListener, null);</span>
<a href="#l10.46"></a><span id="l10.46">     yield false;</span>
<a href="#l10.47"></a><span id="l10.47">   },</span>
<a href="#l10.48"></a><span id="l10.48">   function verifyFolders() {</span>
<a href="#l10.49"></a><span id="l10.49">     let folder1 = gIMAPInbox.getChildNamed(&quot;empty 1&quot;);</span>
<a href="#l10.50"></a><span id="l10.50">     dump(&quot;found folder1\n&quot;);</span>
<a href="#l10.51"></a><span id="l10.51">     let folder2 = gIMAPInbox.getChildNamed(&quot;empty 2&quot;);</span>
<a href="#l10.52"></a><span id="l10.52">     dump(&quot;found folder2\n&quot;);</span>
<a href="#l10.53"></a><span id="l10.53">     let folder3 = gIMAPInbox.getChildNamed(&quot;empty 3&quot;);</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineat">@@ -53,26 +52,26 @@ var tests = [</span>
<a href="#l10.55"></a><span id="l10.55">     do_check_neq(folder3, null);</span>
<a href="#l10.56"></a><span id="l10.56">   },</span>
<a href="#l10.57"></a><span id="l10.57">   function moveImapFolder1() {</span>
<a href="#l10.58"></a><span id="l10.58">     let folders = new Array;</span>
<a href="#l10.59"></a><span id="l10.59">     let folder1 = gIMAPInbox.getChildNamed(&quot;empty 1&quot;);</span>
<a href="#l10.60"></a><span id="l10.60">     let folder2 = gIMAPInbox.getChildNamed(&quot;empty 2&quot;);</span>
<a href="#l10.61"></a><span id="l10.61">     folders.push(folder2.QueryInterface(Ci.nsIMsgFolder));</span>
<a href="#l10.62"></a><span id="l10.62">     let array = toXPCOMArray(folders, Ci.nsIMutableArray);</span>
<a href="#l10.63"></a><span id="l10.63" class="difflineminus">-    gCopyService.CopyFolders(array, folder1, true, CopyListener, null);</span>
<a href="#l10.64"></a><span id="l10.64" class="difflineplus">+    MailServices.copy.CopyFolders(array, folder1, true, CopyListener, null);</span>
<a href="#l10.65"></a><span id="l10.65">     yield false;</span>
<a href="#l10.66"></a><span id="l10.66">   },</span>
<a href="#l10.67"></a><span id="l10.67">   function moveImapFolder2() {</span>
<a href="#l10.68"></a><span id="l10.68">     let folders = new Array;</span>
<a href="#l10.69"></a><span id="l10.69">     let folder1 = gIMAPInbox.getChildNamed(&quot;empty 1&quot;);</span>
<a href="#l10.70"></a><span id="l10.70">     let folder3 = gIMAPInbox.getChildNamed(&quot;empty 3&quot;);</span>
<a href="#l10.71"></a><span id="l10.71">     folders.push(folder3.QueryInterface(Ci.nsIMsgFolder));</span>
<a href="#l10.72"></a><span id="l10.72">     let array = toXPCOMArray(folders, Ci.nsIMutableArray);</span>
<a href="#l10.73"></a><span id="l10.73" class="difflineminus">-    gCopyService.CopyFolders(array, folder1, true, CopyListener, null);</span>
<a href="#l10.74"></a><span id="l10.74" class="difflineplus">+    MailServices.copy.CopyFolders(array, folder1, true, CopyListener, null);</span>
<a href="#l10.75"></a><span id="l10.75">     yield false;</span>
<a href="#l10.76"></a><span id="l10.76">   },</span>
<a href="#l10.77"></a><span id="l10.77">   function verifyImapFolders() {</span>
<a href="#l10.78"></a><span id="l10.78">     let folder1 = gIMAPInbox.getChildNamed(&quot;empty 1&quot;);</span>
<a href="#l10.79"></a><span id="l10.79">     dump(&quot;found folder1\n&quot;);</span>
<a href="#l10.80"></a><span id="l10.80">     let folder2 = folder1.getChildNamed(&quot;empty 2&quot;);</span>
<a href="#l10.81"></a><span id="l10.81">     dump(&quot;found folder2\n&quot;);</span>
<a href="#l10.82"></a><span id="l10.82">     let folder3 = folder1.getChildNamed(&quot;empty 3&quot;);</span>
<a href="#l10.83"></a><span id="l10.83" class="difflineat">@@ -83,17 +82,17 @@ var tests = [</span>
<a href="#l10.84"></a><span id="l10.84">   },</span>
<a href="#l10.85"></a><span id="l10.85">   function testImapFolderCopyFailure() {</span>
<a href="#l10.86"></a><span id="l10.86">     let folders = new Array;</span>
<a href="#l10.87"></a><span id="l10.87">     folders.push(gNotEmptyLocal4.QueryInterface(Ci.nsIMsgFolder));</span>
<a href="#l10.88"></a><span id="l10.88">     let array = toXPCOMArray(folders, Ci.nsIMutableArray);</span>
<a href="#l10.89"></a><span id="l10.89">     gIMAPDaemon.commandToFail = &quot;APPEND&quot;;</span>
<a href="#l10.90"></a><span id="l10.90">     // we expect NS_MSG_ERROR_IMAP_COMMAND_FAILED;</span>
<a href="#l10.91"></a><span id="l10.91">     CopyListener._expectedStatus = 0x80550021;</span>
<a href="#l10.92"></a><span id="l10.92" class="difflineminus">-    gCopyService.CopyFolders(array, gIMAPInbox, false, CopyListener, null);</span>
<a href="#l10.93"></a><span id="l10.93" class="difflineplus">+    MailServices.copy.CopyFolders(array, gIMAPInbox, false, CopyListener, null);</span>
<a href="#l10.94"></a><span id="l10.94"> </span>
<a href="#l10.95"></a><span id="l10.95">     // In failure case OnStopCopy is sent twice, the first one comes from</span>
<a href="#l10.96"></a><span id="l10.96">     // nsMsgCopyService, the second one comes from nsImapFolderCopyState.</span>
<a href="#l10.97"></a><span id="l10.97">     yield false;</span>
<a href="#l10.98"></a><span id="l10.98"> </span>
<a href="#l10.99"></a><span id="l10.99">     yield false;</span>
<a href="#l10.100"></a><span id="l10.100">   },</span>
<a href="#l10.101"></a><span id="l10.101">   teardown</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapUndo.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapUndo.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -7,21 +7,22 @@</span>
<a href="#l11.4"></a><span id="l11.4"> // Original Author: David Bienvenu &lt;bienvenu@nventure.com&gt;</span>
<a href="#l11.5"></a><span id="l11.5"> </span>
<a href="#l11.6"></a><span id="l11.6"> </span>
<a href="#l11.7"></a><span id="l11.7"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l11.8"></a><span id="l11.8"> load(&quot;../../../resources/mailTestUtils.js&quot;);</span>
<a href="#l11.9"></a><span id="l11.9"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l11.10"></a><span id="l11.10"> load(&quot;../../../resources/IMAPpump.js&quot;);</span>
<a href="#l11.11"></a><span id="l11.11"> </span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+</span>
<a href="#l11.14"></a><span id="l11.14"> var gRootFolder;</span>
<a href="#l11.15"></a><span id="l11.15"> var gLastKey;</span>
<a href="#l11.16"></a><span id="l11.16"> var gMessages = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineminus">-var gCopyService = Cc[&quot;@mozilla.org/messenger/messagecopyservice;1&quot;]</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineminus">-                .getService(Ci.nsIMsgCopyService);</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineplus">+var gCopyService = MailServices.copy;</span>
<a href="#l11.20"></a><span id="l11.20"> var gMsgWindow;</span>
<a href="#l11.21"></a><span id="l11.21"> </span>
<a href="#l11.22"></a><span id="l11.22"> Components.utils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l11.23"></a><span id="l11.23"> </span>
<a href="#l11.24"></a><span id="l11.24"> const gMsgFile1 = do_get_file(&quot;../../../data/bugmail10&quot;);</span>
<a href="#l11.25"></a><span id="l11.25"> const gMsgFile2 = do_get_file(&quot;../../../data/bugmail11&quot;);</span>
<a href="#l11.26"></a><span id="l11.26"> const gMsgFile3 = do_get_file(&quot;../../../data/draft1&quot;);</span>
<a href="#l11.27"></a><span id="l11.27"> const gMsgFile4 = do_get_file(&quot;../../../data/bugmail7&quot;);</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineat">@@ -104,22 +105,19 @@ var tests = [</span>
<a href="#l11.29"></a><span id="l11.29">     do_check_eq(gIMAPInbox.msgDatabase.dBFolderInfo.numMessages, 4);</span>
<a href="#l11.30"></a><span id="l11.30">   },</span>
<a href="#l11.31"></a><span id="l11.31">   teardown</span>
<a href="#l11.32"></a><span id="l11.32"> ];</span>
<a href="#l11.33"></a><span id="l11.33"> </span>
<a href="#l11.34"></a><span id="l11.34"> function setup() {</span>
<a href="#l11.35"></a><span id="l11.35">   setupIMAPPump();</span>
<a href="#l11.36"></a><span id="l11.36"> </span>
<a href="#l11.37"></a><span id="l11.37" class="difflineminus">-  var mailSession = Cc[&quot;@mozilla.org/messenger/services/session;1&quot;]</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineminus">-    .getService(Ci.nsIMsgMailSession);</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineminus">-</span>
<a href="#l11.40"></a><span id="l11.40">   var listener1 = new alertListener();</span>
<a href="#l11.41"></a><span id="l11.41"> </span>
<a href="#l11.42"></a><span id="l11.42" class="difflineminus">-  mailSession.addUserFeedbackListener(listener1);</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineplus">+  MailServices.mailSession.addUserFeedbackListener(listener1);</span>
<a href="#l11.44"></a><span id="l11.44"> </span>
<a href="#l11.45"></a><span id="l11.45">   Services.prefs.setBoolPref(&quot;mail.server.server1.autosync_offline_stores&quot;, false);</span>
<a href="#l11.46"></a><span id="l11.46">   Services.prefs.setBoolPref(&quot;mail.server.server1.offline_download&quot;, false);</span>
<a href="#l11.47"></a><span id="l11.47"> </span>
<a href="#l11.48"></a><span id="l11.48">   gMsgWindow = Cc[&quot;@mozilla.org/messenger/msgwindow;1&quot;]</span>
<a href="#l11.49"></a><span id="l11.49">                   .createInstance(Components.interfaces.nsIMsgWindow);</span>
<a href="#l11.50"></a><span id="l11.50"> </span>
<a href="#l11.51"></a><span id="l11.51">   gRootFolder = gIMAPIncomingServer.rootFolder;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_localToImapFilter.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_localToImapFilter.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -9,42 +9,41 @@</span>
<a href="#l12.4"></a><span id="l12.4"> </span>
<a href="#l12.5"></a><span id="l12.5"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l12.6"></a><span id="l12.6"> load(&quot;../../../resources/mailTestUtils.js&quot;);</span>
<a href="#l12.7"></a><span id="l12.7"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l12.8"></a><span id="l12.8"> load(&quot;../../../resources/POP3pump.js&quot;);</span>
<a href="#l12.9"></a><span id="l12.9"> load(&quot;../../../resources/IMAPpump.js&quot;);</span>
<a href="#l12.10"></a><span id="l12.10"> Components.utils.import(&quot;resource:///modules/folderUtils.jsm&quot;);</span>
<a href="#l12.11"></a><span id="l12.11"> Components.utils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l12.13"></a><span id="l12.13"> </span>
<a href="#l12.14"></a><span id="l12.14"> var gIMAPTrashFolder;</span>
<a href="#l12.15"></a><span id="l12.15"> var gEmptyLocal1, gEmptyLocal2;</span>
<a href="#l12.16"></a><span id="l12.16"> var gLastKey;</span>
<a href="#l12.17"></a><span id="l12.17"> var gMessages = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineminus">-var gCopyService = Cc[&quot;@mozilla.org/messenger/messagecopyservice;1&quot;]</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineminus">-                .getService(Ci.nsIMsgCopyService);</span>
<a href="#l12.20"></a><span id="l12.20"> const gFiles = [&quot;../../../data/bugmail1&quot;,</span>
<a href="#l12.21"></a><span id="l12.21">                 &quot;../../../data/draft1&quot;];</span>
<a href="#l12.22"></a><span id="l12.22"> </span>
<a href="#l12.23"></a><span id="l12.23"> var tests = [</span>
<a href="#l12.24"></a><span id="l12.24">   setup,</span>
<a href="#l12.25"></a><span id="l12.25">   function copyFolder1() {</span>
<a href="#l12.26"></a><span id="l12.26">     dump(&quot;gEmpty1 &quot; + gEmptyLocal1.URI + &quot;\n&quot;);</span>
<a href="#l12.27"></a><span id="l12.27">     let folders = new Array;</span>
<a href="#l12.28"></a><span id="l12.28">     folders.push(gEmptyLocal1.QueryInterface(Ci.nsIMsgFolder));</span>
<a href="#l12.29"></a><span id="l12.29">     let array = toXPCOMArray(folders, Ci.nsIMutableArray);</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineminus">-    gCopyService.CopyFolders(array, gIMAPInbox, false, CopyListener, null);</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineplus">+    MailServices.copy.CopyFolders(array, gIMAPInbox, false, CopyListener, null);</span>
<a href="#l12.32"></a><span id="l12.32">     yield false;</span>
<a href="#l12.33"></a><span id="l12.33">   },</span>
<a href="#l12.34"></a><span id="l12.34">   function copyFolder2() {</span>
<a href="#l12.35"></a><span id="l12.35">     dump(&quot;gEmpty2 &quot; + gEmptyLocal2.URI + &quot;\n&quot;);</span>
<a href="#l12.36"></a><span id="l12.36">     let folders = new Array;</span>
<a href="#l12.37"></a><span id="l12.37">     folders.push(gEmptyLocal2);</span>
<a href="#l12.38"></a><span id="l12.38">     let array = toXPCOMArray(folders, Ci.nsIMutableArray);</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineminus">-    gCopyService.CopyFolders(array, gIMAPInbox, false, CopyListener, null);</span>
<a href="#l12.40"></a><span id="l12.40" class="difflineplus">+    MailServices.copy.CopyFolders(array, gIMAPInbox, false, CopyListener, null);</span>
<a href="#l12.41"></a><span id="l12.41">     yield false;</span>
<a href="#l12.42"></a><span id="l12.42">   },</span>
<a href="#l12.43"></a><span id="l12.43">   function getLocalMessages() {</span>
<a href="#l12.44"></a><span id="l12.44">     // setup copy then move mail filters on the inbox</span>
<a href="#l12.45"></a><span id="l12.45">     let filterList = gPOP3Pump.fakeServer.getFilterList(null);</span>
<a href="#l12.46"></a><span id="l12.46">     let filter = filterList.createFilter(&quot;copyThenMoveAll&quot;);</span>
<a href="#l12.47"></a><span id="l12.47">     let searchTerm = filter.createTerm();</span>
<a href="#l12.48"></a><span id="l12.48">     searchTerm.matchAll = true;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_localToImapFilterQuarantine.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_localToImapFilterQuarantine.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -5,16 +5,18 @@</span>
<a href="#l13.4"></a><span id="l13.4"> /*</span>
<a href="#l13.5"></a><span id="l13.5">  * This file tests copies of multiple messages using filters</span>
<a href="#l13.6"></a><span id="l13.6">  * from incoming POP3, with filter actions copying and moving</span>
<a href="#l13.7"></a><span id="l13.7">  * messages to an IMAP folder, when the POP3 message uses</span>
<a href="#l13.8"></a><span id="l13.8">  * quarantining to help antivirus software. See bug 387361.</span>
<a href="#l13.9"></a><span id="l13.9">  *</span>
<a href="#l13.10"></a><span id="l13.10">  */</span>
<a href="#l13.11"></a><span id="l13.11"> </span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+</span>
<a href="#l13.14"></a><span id="l13.14"> Services.prefs.setCharPref(&quot;mail.serverDefaultStoreContractID&quot;,</span>
<a href="#l13.15"></a><span id="l13.15">                            &quot;@mozilla.org/msgstore/berkeleystore;1&quot;);</span>
<a href="#l13.16"></a><span id="l13.16"> </span>
<a href="#l13.17"></a><span id="l13.17"> load(&quot;../../../resources/POP3pump.js&quot;);</span>
<a href="#l13.18"></a><span id="l13.18"> </span>
<a href="#l13.19"></a><span id="l13.19"> // async support</span>
<a href="#l13.20"></a><span id="l13.20"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l13.21"></a><span id="l13.21"> load(&quot;../../../resources/mailTestUtils.js&quot;);</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineat">@@ -184,22 +186,20 @@ var urlListener = {</span>
<a href="#l13.23"></a><span id="l13.23"> </span>
<a href="#l13.24"></a><span id="l13.24"> function run_test()</span>
<a href="#l13.25"></a><span id="l13.25"> {</span>
<a href="#l13.26"></a><span id="l13.26">   // quarantine messages</span>
<a href="#l13.27"></a><span id="l13.27">   Services.prefs.setBoolPref(&quot;mailnews.downloadToTempFile&quot;, true);</span>
<a href="#l13.28"></a><span id="l13.28"> </span>
<a href="#l13.29"></a><span id="l13.29">   // Add folder listeners that will capture async events</span>
<a href="#l13.30"></a><span id="l13.30">   const nsIMFNService = Ci.nsIMsgFolderNotificationService;</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineminus">-  var MFNService = Cc[&quot;@mozilla.org/messenger/msgnotificationservice;1&quot;]</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineminus">-                      .getService(nsIMFNService);</span>
<a href="#l13.33"></a><span id="l13.33">   let flags =</span>
<a href="#l13.34"></a><span id="l13.34">         nsIMFNService.folderAdded |</span>
<a href="#l13.35"></a><span id="l13.35">         nsIMFNService.msgAdded;</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineminus">-  MFNService.addListener(mfnListener, flags);</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineplus">+  MailServices.mfn.addListener(mfnListener, flags);</span>
<a href="#l13.38"></a><span id="l13.38"> </span>
<a href="#l13.39"></a><span id="l13.39">   //start first test</span>
<a href="#l13.40"></a><span id="l13.40">   async_run_tests(quarantineTests);</span>
<a href="#l13.41"></a><span id="l13.41"> }</span>
<a href="#l13.42"></a><span id="l13.42"> </span>
<a href="#l13.43"></a><span id="l13.43"> // helper functions</span>
<a href="#l13.44"></a><span id="l13.44"> </span>
<a href="#l13.45"></a><span id="l13.45"> // count of messages in a folder, using the database</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_nsIMsgFolderListenerIMAP.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_nsIMsgFolderListenerIMAP.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -12,16 +12,18 @@</span>
<a href="#l14.4"></a><span id="l14.4"> * Currently tested</span>
<a href="#l14.5"></a><span id="l14.5"> * - Adding new folders</span>
<a href="#l14.6"></a><span id="l14.6"> * - Copying messages from files to mailboxes</span>
<a href="#l14.7"></a><span id="l14.7"> * - Adding new messages directly to mailboxes</span>
<a href="#l14.8"></a><span id="l14.8"> */</span>
<a href="#l14.9"></a><span id="l14.9"> </span>
<a href="#l14.10"></a><span id="l14.10"> load(&quot;../../../resources/msgFolderListenerSetup.js&quot;);</span>
<a href="#l14.11"></a><span id="l14.11"> </span>
<a href="#l14.12"></a><span id="l14.12" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+</span>
<a href="#l14.14"></a><span id="l14.14"> // Globals</span>
<a href="#l14.15"></a><span id="l14.15"> var gRootFolder;</span>
<a href="#l14.16"></a><span id="l14.16"> var gIMAPInbox, gIMAPFolder2, gIMAPFolder3, gIMAPTrashFolder;</span>
<a href="#l14.17"></a><span id="l14.17"> var gIMAPDaemon, gServer, gIMAPIncomingServer;</span>
<a href="#l14.18"></a><span id="l14.18"> const gMsgFile1 = do_get_file(&quot;../../../data/bugmail10&quot;);</span>
<a href="#l14.19"></a><span id="l14.19"> const gMsgFile2 = do_get_file(&quot;../../../data/bugmail11&quot;);</span>
<a href="#l14.20"></a><span id="l14.20"> const gMsgFile3 = do_get_file(&quot;../../../data/draft1&quot;);</span>
<a href="#l14.21"></a><span id="l14.21"> const gMsgFile4 = do_get_file(&quot;../../../data/bugmail7&quot;);</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineat">@@ -202,27 +204,25 @@ function run_test()</span>
<a href="#l14.23"></a><span id="l14.23"> </span>
<a href="#l14.24"></a><span id="l14.24">   gIMAPIncomingServer = createLocalIMAPServer();</span>
<a href="#l14.25"></a><span id="l14.25"> </span>
<a href="#l14.26"></a><span id="l14.26">   // Also make sure a local folders server is created, as that's what is used</span>
<a href="#l14.27"></a><span id="l14.27">   // for sent items</span>
<a href="#l14.28"></a><span id="l14.28">   loadLocalMailAccount();</span>
<a href="#l14.29"></a><span id="l14.29"> </span>
<a href="#l14.30"></a><span id="l14.30">   // We need an identity so that updateFolder doesn't fail</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineminus">-  let acctMgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineminus">-                  .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineminus">-  let localAccount = acctMgr.createAccount();</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineminus">-  let identity = acctMgr.createIdentity();</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineplus">+  let localAccount = MailServices.accounts.createAccount();</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineplus">+  let identity = MailServices.accounts.createIdentity();</span>
<a href="#l14.37"></a><span id="l14.37">   localAccount.addIdentity(identity);</span>
<a href="#l14.38"></a><span id="l14.38">   localAccount.defaultIdentity = identity;</span>
<a href="#l14.39"></a><span id="l14.39">   localAccount.incomingServer = gLocalIncomingServer;</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineminus">-  acctMgr.defaultAccount = localAccount;</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineplus">+  MailServices.accounts.defaultAccount = localAccount;</span>
<a href="#l14.42"></a><span id="l14.42"> </span>
<a href="#l14.43"></a><span id="l14.43">   // Let's also have another account, using the same identity</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineminus">-  let imapAccount = acctMgr.createAccount();</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineplus">+  let imapAccount = MailServices.accounts.createAccount();</span>
<a href="#l14.46"></a><span id="l14.46">   imapAccount.addIdentity(identity);</span>
<a href="#l14.47"></a><span id="l14.47">   imapAccount.defaultIdentity = identity;</span>
<a href="#l14.48"></a><span id="l14.48">   imapAccount.incomingServer = gIMAPIncomingServer;</span>
<a href="#l14.49"></a><span id="l14.49"> </span>
<a href="#l14.50"></a><span id="l14.50">   // The server doesn't support more than one connection</span>
<a href="#l14.51"></a><span id="l14.51">   Services.prefs.setIntPref(&quot;mail.server.server1.max_cached_connections&quot;, 1);</span>
<a href="#l14.52"></a><span id="l14.52">   // Make sure no biff notifications happen</span>
<a href="#l14.53"></a><span id="l14.53">   Services.prefs.setBoolPref(&quot;mail.biff.play_sound&quot;, false);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_offlineDraftDataloss.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_offlineDraftDataloss.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -8,16 +8,17 @@</span>
<a href="#l15.4"></a><span id="l15.4">  * See Bug 805626</span>
<a href="#l15.5"></a><span id="l15.5">  */</span>
<a href="#l15.6"></a><span id="l15.6"> </span>
<a href="#l15.7"></a><span id="l15.7"> // async support</span>
<a href="#l15.8"></a><span id="l15.8"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l15.9"></a><span id="l15.9"> load(&quot;../../../resources/mailTestUtils.js&quot;);</span>
<a href="#l15.10"></a><span id="l15.10"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l15.11"></a><span id="l15.11"> </span>
<a href="#l15.12"></a><span id="l15.12" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l15.13"></a><span id="l15.13"> Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l15.14"></a><span id="l15.14"> </span>
<a href="#l15.15"></a><span id="l15.15"> // IMAP pump</span>
<a href="#l15.16"></a><span id="l15.16"> load(&quot;../../../resources/IMAPpump.js&quot;);</span>
<a href="#l15.17"></a><span id="l15.17"> </span>
<a href="#l15.18"></a><span id="l15.18"> setupIMAPPump();</span>
<a href="#l15.19"></a><span id="l15.19"> </span>
<a href="#l15.20"></a><span id="l15.20"> // Definition of tests</span>
<a href="#l15.21"></a><span id="l15.21" class="difflineat">@@ -65,21 +66,18 @@ function saveDraft()</span>
<a href="#l15.22"></a><span id="l15.22">                      .createInstance(Ci.nsIMsgCompose);</span>
<a href="#l15.23"></a><span id="l15.23">   let fields = Cc[&quot;@mozilla.org/messengercompose/composefields;1&quot;]</span>
<a href="#l15.24"></a><span id="l15.24">                  .createInstance(Ci.nsIMsgCompFields);</span>
<a href="#l15.25"></a><span id="l15.25">   let params = Cc[&quot;@mozilla.org/messengercompose/composeparams;1&quot;]</span>
<a href="#l15.26"></a><span id="l15.26">                  .createInstance(Ci.nsIMsgComposeParams);</span>
<a href="#l15.27"></a><span id="l15.27">   params.composeFields = fields;</span>
<a href="#l15.28"></a><span id="l15.28">   msgCompose.initialize(params);</span>
<a href="#l15.29"></a><span id="l15.29"> </span>
<a href="#l15.30"></a><span id="l15.30" class="difflineminus">-  let acctMgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineminus">-                  .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineminus">-</span>
<a href="#l15.33"></a><span id="l15.33">   // Set up the identity</span>
<a href="#l15.34"></a><span id="l15.34" class="difflineminus">-  let identity = acctMgr.createIdentity();</span>
<a href="#l15.35"></a><span id="l15.35" class="difflineplus">+  let identity = MailServices.accounts.createIdentity();</span>
<a href="#l15.36"></a><span id="l15.36">   identity.draftFolder = gDraftsFolder.URI;</span>
<a href="#l15.37"></a><span id="l15.37"> </span>
<a href="#l15.38"></a><span id="l15.38">   let progress = Cc[&quot;@mozilla.org/messenger/progress;1&quot;]</span>
<a href="#l15.39"></a><span id="l15.39">                    .createInstance(Ci.nsIMsgProgress);</span>
<a href="#l15.40"></a><span id="l15.40">   progress.registerListener(progressListener);</span>
<a href="#l15.41"></a><span id="l15.41">   msgCompose.SendMsg(Ci.nsIMsgSend.nsMsgSaveAsDraft, identity, &quot;&quot;, null,</span>
<a href="#l15.42"></a><span id="l15.42">                      progress);</span>
<a href="#l15.43"></a><span id="l15.43">   yield false;</span>
<a href="#l15.44"></a><span id="l15.44" class="difflineat">@@ -122,24 +120,22 @@ function endTest()</span>
<a href="#l15.45"></a><span id="l15.45"> </span>
<a href="#l15.46"></a><span id="l15.46"> function run_test()</span>
<a href="#l15.47"></a><span id="l15.47"> {</span>
<a href="#l15.48"></a><span id="l15.48">   Services.prefs.setBoolPref(&quot;mail.server.default.autosync_offline_stores&quot;, false);</span>
<a href="#l15.49"></a><span id="l15.49">   let server = gIMAPIncomingServer;</span>
<a href="#l15.50"></a><span id="l15.50"> </span>
<a href="#l15.51"></a><span id="l15.51">   // Add folder listeners that will capture async events</span>
<a href="#l15.52"></a><span id="l15.52">   const nsIMFNService = Ci.nsIMsgFolderNotificationService;</span>
<a href="#l15.53"></a><span id="l15.53" class="difflineminus">-  let MFNService = Cc[&quot;@mozilla.org/messenger/msgnotificationservice;1&quot;]</span>
<a href="#l15.54"></a><span id="l15.54" class="difflineminus">-                      .getService(nsIMFNService);</span>
<a href="#l15.55"></a><span id="l15.55"> </span>
<a href="#l15.56"></a><span id="l15.56">   let flags =</span>
<a href="#l15.57"></a><span id="l15.57">         nsIMFNService.msgsMoveCopyCompleted |</span>
<a href="#l15.58"></a><span id="l15.58">         nsIMFNService.folderAdded |</span>
<a href="#l15.59"></a><span id="l15.59">         nsIMFNService.msgAdded;</span>
<a href="#l15.60"></a><span id="l15.60" class="difflineminus">-  MFNService.addListener(mfnListener, flags);</span>
<a href="#l15.61"></a><span id="l15.61" class="difflineplus">+  MailServices.mfn.addListener(mfnListener, flags);</span>
<a href="#l15.62"></a><span id="l15.62"> </span>
<a href="#l15.63"></a><span id="l15.63">   //start first test</span>
<a href="#l15.64"></a><span id="l15.64">   async_run_tests(tests);</span>
<a href="#l15.65"></a><span id="l15.65"> }</span>
<a href="#l15.66"></a><span id="l15.66"> </span>
<a href="#l15.67"></a><span id="l15.67"> var mfnListener =</span>
<a href="#l15.68"></a><span id="l15.68"> {</span>
<a href="#l15.69"></a><span id="l15.69">   msgsMoveCopyCompleted: function (aMove, aSrcMsgs, aDestFolder, aDestMsgs)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_offlinePlayback.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_offlinePlayback.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -1,16 +1,15 @@</span>
<a href="#l16.4"></a><span id="l16.4"> /* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l16.5"></a><span id="l16.5"> /*</span>
<a href="#l16.6"></a><span id="l16.6">  * Test to ensure that changes made while offline are played back when we</span>
<a href="#l16.7"></a><span id="l16.7">  * go back online.</span>
<a href="#l16.8"></a><span id="l16.8">  */</span>
<a href="#l16.9"></a><span id="l16.9"> </span>
<a href="#l16.10"></a><span id="l16.10" class="difflineminus">-const copyService = Cc[&quot;@mozilla.org/messenger/messagecopyservice;1&quot;]</span>
<a href="#l16.11"></a><span id="l16.11" class="difflineminus">-                      .getService(Ci.nsIMsgCopyService);</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l16.13"></a><span id="l16.13"> </span>
<a href="#l16.14"></a><span id="l16.14"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l16.15"></a><span id="l16.15"> load(&quot;../../../resources/mailTestUtils.js&quot;);</span>
<a href="#l16.16"></a><span id="l16.16"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l16.17"></a><span id="l16.17"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l16.18"></a><span id="l16.18"> load(&quot;../../../resources/IMAPpump.js&quot;);</span>
<a href="#l16.19"></a><span id="l16.19"> </span>
<a href="#l16.20"></a><span id="l16.20"> var gSecondFolder, gThirdFolder;</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineat">@@ -47,23 +46,23 @@ var tests = [</span>
<a href="#l16.22"></a><span id="l16.22">     let headers1 = Cc[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l16.23"></a><span id="l16.23">                      .createInstance(Ci.nsIMutableArray);</span>
<a href="#l16.24"></a><span id="l16.24">     let headers2 = Cc[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l16.25"></a><span id="l16.25">                      .createInstance(Ci.nsIMutableArray);</span>
<a href="#l16.26"></a><span id="l16.26">     headers1.appendElement(msgHdr1, false);</span>
<a href="#l16.27"></a><span id="l16.27">     headers2.appendElement(msgHdr2, false);</span>
<a href="#l16.28"></a><span id="l16.28">     msgHdr1.folder.markMessagesFlagged(headers1, true);</span>
<a href="#l16.29"></a><span id="l16.29">     msgHdr2.folder.markMessagesFlagged(headers2, true);</span>
<a href="#l16.30"></a><span id="l16.30" class="difflineminus">-    copyService.CopyMessages(gIMAPInbox, headers1, gSecondFolder, true, null,</span>
<a href="#l16.31"></a><span id="l16.31" class="difflineminus">-                             null, true);</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineminus">-    copyService.CopyMessages(gIMAPInbox, headers2, gThirdFolder, true, null,</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineminus">-                             null, true);</span>
<a href="#l16.34"></a><span id="l16.34" class="difflineplus">+    MailServices.copy.CopyMessages(gIMAPInbox, headers1, gSecondFolder, true, null,</span>
<a href="#l16.35"></a><span id="l16.35" class="difflineplus">+                                   null, true);</span>
<a href="#l16.36"></a><span id="l16.36" class="difflineplus">+    MailServices.copy.CopyMessages(gIMAPInbox, headers2, gThirdFolder, true, null,</span>
<a href="#l16.37"></a><span id="l16.37" class="difflineplus">+                                   null, true);</span>
<a href="#l16.38"></a><span id="l16.38">     var file = do_get_file(&quot;../../../data/bugmail10&quot;);</span>
<a href="#l16.39"></a><span id="l16.39" class="difflineminus">-    copyService.CopyFileMessage(file, gIMAPInbox, null, false, 0,</span>
<a href="#l16.40"></a><span id="l16.40" class="difflineminus">-                                &quot;&quot;, asyncCopyListener, null);</span>
<a href="#l16.41"></a><span id="l16.41" class="difflineplus">+    MailServices.copy.CopyFileMessage(file, gIMAPInbox, null, false, 0,</span>
<a href="#l16.42"></a><span id="l16.42" class="difflineplus">+                                      &quot;&quot;, asyncCopyListener, null);</span>
<a href="#l16.43"></a><span id="l16.43">     yield false;</span>
<a href="#l16.44"></a><span id="l16.44">   },</span>
<a href="#l16.45"></a><span id="l16.45">   function goOnline() {</span>
<a href="#l16.46"></a><span id="l16.46">     gOfflineManager = Cc[&quot;@mozilla.org/messenger/offline-manager;1&quot;]</span>
<a href="#l16.47"></a><span id="l16.47">                            .getService(Ci.nsIMsgOfflineManager);</span>
<a href="#l16.48"></a><span id="l16.48">     gIMAPDaemon.closing = false;</span>
<a href="#l16.49"></a><span id="l16.49">     Services.io.offline = false;</span>
<a href="#l16.50"></a><span id="l16.50"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_offlineStoreLocking.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_offlineStoreLocking.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -6,16 +6,17 @@</span>
<a href="#l17.4"></a><span id="l17.4"> </span>
<a href="#l17.5"></a><span id="l17.5"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l17.6"></a><span id="l17.6"> load(&quot;../../../resources/mailTestUtils.js&quot;);</span>
<a href="#l17.7"></a><span id="l17.7"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l17.8"></a><span id="l17.8"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l17.9"></a><span id="l17.9"> load(&quot;../../../resources/alertTestUtils.js&quot;);</span>
<a href="#l17.10"></a><span id="l17.10"> load(&quot;../../../resources/IMAPpump.js&quot;);</span>
<a href="#l17.11"></a><span id="l17.11"> </span>
<a href="#l17.12"></a><span id="l17.12" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l17.13"></a><span id="l17.13"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l17.14"></a><span id="l17.14"> </span>
<a href="#l17.15"></a><span id="l17.15"> </span>
<a href="#l17.16"></a><span id="l17.16"> // Globals</span>
<a href="#l17.17"></a><span id="l17.17"> var gIMAPTrashFolder, gMsgImapInboxFolder;</span>
<a href="#l17.18"></a><span id="l17.18"> var gGotAlert = false;</span>
<a href="#l17.19"></a><span id="l17.19"> var gMovedMsgId;</span>
<a href="#l17.20"></a><span id="l17.20"> </span>
<a href="#l17.21"></a><span id="l17.21" class="difflineat">@@ -133,22 +134,19 @@ var tests = [</span>
<a href="#l17.22"></a><span id="l17.22">     gIMAPServer.stop();</span>
<a href="#l17.23"></a><span id="l17.23">     Services.io.offline = true;</span>
<a href="#l17.24"></a><span id="l17.24">     let trashHdr;</span>
<a href="#l17.25"></a><span id="l17.25">     let enumerator = gIMAPTrashFolder.msgDatabase.EnumerateMessages();</span>
<a href="#l17.26"></a><span id="l17.26">     let msgHdr = enumerator.getNext().QueryInterface(Ci.nsIMsgDBHdr);</span>
<a href="#l17.27"></a><span id="l17.27">     gMovedMsgId = msgHdr.messageId;</span>
<a href="#l17.28"></a><span id="l17.28">     let array = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l17.29"></a><span id="l17.29">     array.appendElement(msgHdr, false);</span>
<a href="#l17.30"></a><span id="l17.30" class="difflineminus">-    const gCopyService = Cc[&quot;@mozilla.org/messenger/messagecopyservice;1&quot;]</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineminus">-                          .getService(Ci.nsIMsgCopyService);</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineminus">-</span>
<a href="#l17.33"></a><span id="l17.33">     gIMAPInbox.compact(asyncUrlListener, gDummyMsgWindow);</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineminus">-    gCopyService.CopyMessages(gIMAPTrashFolder, array, gIMAPInbox, true,</span>
<a href="#l17.35"></a><span id="l17.35" class="difflineminus">-                              CopyListener, null, true);</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineplus">+    MailServices.copy.CopyMessages(gIMAPTrashFolder, array, gIMAPInbox, true,</span>
<a href="#l17.37"></a><span id="l17.37" class="difflineplus">+                                   CopyListener, null, true);</span>
<a href="#l17.38"></a><span id="l17.38">   },</span>
<a href="#l17.39"></a><span id="l17.39">   function verifyNoOfflineMsg() {</span>
<a href="#l17.40"></a><span id="l17.40">     try {</span>
<a href="#l17.41"></a><span id="l17.41">     let movedMsg = gIMAPInbox.msgDatabase.getMsgHdrForMessageID(gMovedMsgId);</span>
<a href="#l17.42"></a><span id="l17.42">     do_check_false(movedMsg.flags &amp; Ci.nsMsgMessageFlags.Offline);</span>
<a href="#l17.43"></a><span id="l17.43">     } catch (ex) {dump(ex);}</span>
<a href="#l17.44"></a><span id="l17.44">     yield false;</span>
<a href="#l17.45"></a><span id="l17.45">     yield false;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_preserveDataOnMove.js</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_preserveDataOnMove.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -9,16 +9,17 @@</span>
<a href="#l18.4"></a><span id="l18.4"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l18.5"></a><span id="l18.5"> load(&quot;../../../resources/mailTestUtils.js&quot;);</span>
<a href="#l18.6"></a><span id="l18.6"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l18.7"></a><span id="l18.7"> </span>
<a href="#l18.8"></a><span id="l18.8"> // IMAP pump</span>
<a href="#l18.9"></a><span id="l18.9"> load(&quot;../../../resources/IMAPpump.js&quot;);</span>
<a href="#l18.10"></a><span id="l18.10"> </span>
<a href="#l18.11"></a><span id="l18.11"> // Globals</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l18.13"></a><span id="l18.13"> </span>
<a href="#l18.14"></a><span id="l18.14"> const gMessage = &quot;bugmail10&quot;; // message file used as the test message</span>
<a href="#l18.15"></a><span id="l18.15"> </span>
<a href="#l18.16"></a><span id="l18.16"> setupIMAPPump();</span>
<a href="#l18.17"></a><span id="l18.17"> </span>
<a href="#l18.18"></a><span id="l18.18"> // Definition of tests</span>
<a href="#l18.19"></a><span id="l18.19"> var tests = [</span>
<a href="#l18.20"></a><span id="l18.20">   createSubfolder,</span>
<a href="#l18.21"></a><span id="l18.21" class="difflineat">@@ -72,20 +73,18 @@ function moveMessageToSubfolder()</span>
<a href="#l18.22"></a><span id="l18.22">                     in nsIArray messages,</span>
<a href="#l18.23"></a><span id="l18.23">                     in nsIMsgFolder dstFolder,</span>
<a href="#l18.24"></a><span id="l18.24">                     in boolean isMove,</span>
<a href="#l18.25"></a><span id="l18.25">                     in nsIMsgCopyServiceListener listener,</span>
<a href="#l18.26"></a><span id="l18.26">                     in nsIMsgWindow msgWindow,</span>
<a href="#l18.27"></a><span id="l18.27">                     in boolean allowUndo);</span>
<a href="#l18.28"></a><span id="l18.28">   */</span>
<a href="#l18.29"></a><span id="l18.29"> </span>
<a href="#l18.30"></a><span id="l18.30" class="difflineminus">-  let copyService = Cc[&quot;@mozilla.org/messenger/messagecopyservice;1&quot;]</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineminus">-                      .getService(Ci.nsIMsgCopyService);</span>
<a href="#l18.32"></a><span id="l18.32" class="difflineminus">-  copyService.CopyMessages(gIMAPInbox, messages, gSubfolder, true,</span>
<a href="#l18.33"></a><span id="l18.33" class="difflineminus">-                           asyncCopyListener, null, false);</span>
<a href="#l18.34"></a><span id="l18.34" class="difflineplus">+  MailServices.copy.CopyMessages(gIMAPInbox, messages, gSubfolder, true,</span>
<a href="#l18.35"></a><span id="l18.35" class="difflineplus">+                                 asyncCopyListener, null, false);</span>
<a href="#l18.36"></a><span id="l18.36">   dl('wait for OnStopCopy');</span>
<a href="#l18.37"></a><span id="l18.37">   yield false;</span>
<a href="#l18.38"></a><span id="l18.38"> }</span>
<a href="#l18.39"></a><span id="l18.39"> </span>
<a href="#l18.40"></a><span id="l18.40"> function testPropertyOnMove()</span>
<a href="#l18.41"></a><span id="l18.41"> {</span>
<a href="#l18.42"></a><span id="l18.42">   gSubfolder.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l18.43"></a><span id="l18.43">   dl('wait for msgAdded');</span>
<a href="#l18.44"></a><span id="l18.44" class="difflineat">@@ -123,22 +122,20 @@ mfnListener =</span>
<a href="#l18.45"></a><span id="l18.45"> </span>
<a href="#l18.46"></a><span id="l18.46"> };</span>
<a href="#l18.47"></a><span id="l18.47"> </span>
<a href="#l18.48"></a><span id="l18.48"> function run_test()</span>
<a href="#l18.49"></a><span id="l18.49"> {</span>
<a href="#l18.50"></a><span id="l18.50">   Services.prefs.setBoolPref(&quot;mail.server.default.autosync_offline_stores&quot;, false);</span>
<a href="#l18.51"></a><span id="l18.51">   // Add folder listeners that will capture async events</span>
<a href="#l18.52"></a><span id="l18.52">   const nsIMFNService = Ci.nsIMsgFolderNotificationService;</span>
<a href="#l18.53"></a><span id="l18.53" class="difflineminus">-  var MFNService = Cc[&quot;@mozilla.org/messenger/msgnotificationservice;1&quot;]</span>
<a href="#l18.54"></a><span id="l18.54" class="difflineminus">-                      .getService(nsIMFNService);</span>
<a href="#l18.55"></a><span id="l18.55">   let flags =</span>
<a href="#l18.56"></a><span id="l18.56">         nsIMFNService.folderAdded |</span>
<a href="#l18.57"></a><span id="l18.57">         nsIMFNService.msgAdded;</span>
<a href="#l18.58"></a><span id="l18.58" class="difflineminus">-  MFNService.addListener(mfnListener, flags);</span>
<a href="#l18.59"></a><span id="l18.59" class="difflineplus">+  MailServices.mfn.addListener(mfnListener, flags);</span>
<a href="#l18.60"></a><span id="l18.60">   async_run_tests(tests);</span>
<a href="#l18.61"></a><span id="l18.61"> }</span>
<a href="#l18.62"></a><span id="l18.62"> </span>
<a href="#l18.63"></a><span id="l18.63"> /*</span>
<a href="#l18.64"></a><span id="l18.64">  * helper functions</span>
<a href="#l18.65"></a><span id="l18.65">  */</span>
<a href="#l18.66"></a><span id="l18.66"> </span>
<a href="#l18.67"></a><span id="l18.67"> // given a test file, return the file uri spec</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_saveImapDraft.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_saveImapDraft.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -7,16 +7,17 @@</span>
<a href="#l19.4"></a><span id="l19.4">  * marked as unread.</span>
<a href="#l19.5"></a><span id="l19.5">  */</span>
<a href="#l19.6"></a><span id="l19.6"> </span>
<a href="#l19.7"></a><span id="l19.7"> // async support</span>
<a href="#l19.8"></a><span id="l19.8"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l19.9"></a><span id="l19.9"> load(&quot;../../../resources/mailTestUtils.js&quot;);</span>
<a href="#l19.10"></a><span id="l19.10"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l19.11"></a><span id="l19.11"> </span>
<a href="#l19.12"></a><span id="l19.12" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l19.13"></a><span id="l19.13"> Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l19.14"></a><span id="l19.14"> </span>
<a href="#l19.15"></a><span id="l19.15"> // IMAP pump</span>
<a href="#l19.16"></a><span id="l19.16"> load(&quot;../../../resources/IMAPpump.js&quot;);</span>
<a href="#l19.17"></a><span id="l19.17"> </span>
<a href="#l19.18"></a><span id="l19.18"> setupIMAPPump();</span>
<a href="#l19.19"></a><span id="l19.19"> </span>
<a href="#l19.20"></a><span id="l19.20"> // Definition of tests</span>
<a href="#l19.21"></a><span id="l19.21" class="difflineat">@@ -48,21 +49,18 @@ function saveDraft()</span>
<a href="#l19.22"></a><span id="l19.22">                      .createInstance(Ci.nsIMsgCompose);</span>
<a href="#l19.23"></a><span id="l19.23">   var fields = Cc[&quot;@mozilla.org/messengercompose/composefields;1&quot;]</span>
<a href="#l19.24"></a><span id="l19.24">                  .createInstance(Ci.nsIMsgCompFields);</span>
<a href="#l19.25"></a><span id="l19.25">   var params = Cc[&quot;@mozilla.org/messengercompose/composeparams;1&quot;]</span>
<a href="#l19.26"></a><span id="l19.26">                  .createInstance(Ci.nsIMsgComposeParams);</span>
<a href="#l19.27"></a><span id="l19.27">   params.composeFields = fields;</span>
<a href="#l19.28"></a><span id="l19.28">   msgCompose.initialize(params);</span>
<a href="#l19.29"></a><span id="l19.29"> </span>
<a href="#l19.30"></a><span id="l19.30" class="difflineminus">-  var acctMgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l19.31"></a><span id="l19.31" class="difflineminus">-                  .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l19.32"></a><span id="l19.32" class="difflineminus">-</span>
<a href="#l19.33"></a><span id="l19.33">   // Set up the identity</span>
<a href="#l19.34"></a><span id="l19.34" class="difflineminus">-  var identity = acctMgr.createIdentity();</span>
<a href="#l19.35"></a><span id="l19.35" class="difflineplus">+  var identity = MailServices.accounts.createIdentity();</span>
<a href="#l19.36"></a><span id="l19.36">   identity.draftFolder = gDraftsFolder.URI;</span>
<a href="#l19.37"></a><span id="l19.37"> </span>
<a href="#l19.38"></a><span id="l19.38">   var progress = Cc[&quot;@mozilla.org/messenger/progress;1&quot;]</span>
<a href="#l19.39"></a><span id="l19.39">                    .createInstance(Ci.nsIMsgProgress);</span>
<a href="#l19.40"></a><span id="l19.40">   progress.registerListener(progressListener);</span>
<a href="#l19.41"></a><span id="l19.41">   msgCompose.SendMsg(Ci.nsIMsgSend.nsMsgSaveAsDraft, identity, &quot;&quot;, null,</span>
<a href="#l19.42"></a><span id="l19.42">                      progress);</span>
<a href="#l19.43"></a><span id="l19.43">   yield false;</span>
<a href="#l19.44"></a><span id="l19.44" class="difflineat">@@ -91,24 +89,22 @@ function endTest()</span>
<a href="#l19.45"></a><span id="l19.45"> </span>
<a href="#l19.46"></a><span id="l19.46"> function run_test()</span>
<a href="#l19.47"></a><span id="l19.47"> {</span>
<a href="#l19.48"></a><span id="l19.48">   Services.prefs.setBoolPref(&quot;mail.server.default.autosync_offline_stores&quot;, false);</span>
<a href="#l19.49"></a><span id="l19.49">   let server = gIMAPIncomingServer;</span>
<a href="#l19.50"></a><span id="l19.50"> </span>
<a href="#l19.51"></a><span id="l19.51">   // Add folder listeners that will capture async events</span>
<a href="#l19.52"></a><span id="l19.52">   const nsIMFNService = Ci.nsIMsgFolderNotificationService;</span>
<a href="#l19.53"></a><span id="l19.53" class="difflineminus">-  let MFNService = Cc[&quot;@mozilla.org/messenger/msgnotificationservice;1&quot;]</span>
<a href="#l19.54"></a><span id="l19.54" class="difflineminus">-                      .getService(nsIMFNService);</span>
<a href="#l19.55"></a><span id="l19.55"> </span>
<a href="#l19.56"></a><span id="l19.56">   let flags =</span>
<a href="#l19.57"></a><span id="l19.57">         nsIMFNService.msgsMoveCopyCompleted |</span>
<a href="#l19.58"></a><span id="l19.58">         nsIMFNService.folderAdded |</span>
<a href="#l19.59"></a><span id="l19.59">         nsIMFNService.msgAdded;</span>
<a href="#l19.60"></a><span id="l19.60" class="difflineminus">-  MFNService.addListener(mfnListener, flags);</span>
<a href="#l19.61"></a><span id="l19.61" class="difflineplus">+  MailServices.mfn.addListener(mfnListener, flags);</span>
<a href="#l19.62"></a><span id="l19.62"> </span>
<a href="#l19.63"></a><span id="l19.63">   //start first test</span>
<a href="#l19.64"></a><span id="l19.64">   async_run_tests(tests);</span>
<a href="#l19.65"></a><span id="l19.65"> }</span>
<a href="#l19.66"></a><span id="l19.66"> </span>
<a href="#l19.67"></a><span id="l19.67"> var mfnListener =</span>
<a href="#l19.68"></a><span id="l19.68"> {</span>
<a href="#l19.69"></a><span id="l19.69">   msgsMoveCopyCompleted: function (aMove, aSrcMsgs, aDestFolder, aDestMsgs)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_starttlsFailure.js</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_starttlsFailure.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -1,14 +1,15 @@</span>
<a href="#l20.4"></a><span id="l20.4"> /**</span>
<a href="#l20.5"></a><span id="l20.5">  * This test checks that we handle the server dropping the connection</span>
<a href="#l20.6"></a><span id="l20.6">  * on starttls. Since fakeserver doesn't support STARTTLS, I've made</span>
<a href="#l20.7"></a><span id="l20.7">  * it drop the connection when it's attempted.</span>
<a href="#l20.8"></a><span id="l20.8">  */</span>
<a href="#l20.9"></a><span id="l20.9"> </span>
<a href="#l20.10"></a><span id="l20.10" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l20.11"></a><span id="l20.11"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l20.12"></a><span id="l20.12"> </span>
<a href="#l20.13"></a><span id="l20.13"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l20.14"></a><span id="l20.14"> load(&quot;../../../resources/alertTestUtils.js&quot;);</span>
<a href="#l20.15"></a><span id="l20.15"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l20.16"></a><span id="l20.16"> </span>
<a href="#l20.17"></a><span id="l20.17"> var gGotAlert = false;</span>
<a href="#l20.18"></a><span id="l20.18"> </span>
<a href="#l20.19"></a><span id="l20.19" class="difflineat">@@ -29,24 +30,22 @@ function setup() {</span>
<a href="#l20.20"></a><span id="l20.20">   gIMAPServer = makeServer(gIMAPDaemon, &quot;&quot;, {dropOnStartTLS: true});</span>
<a href="#l20.21"></a><span id="l20.21">   gIMAPIncomingServer = createLocalIMAPServer();</span>
<a href="#l20.22"></a><span id="l20.22">   gIMAPIncomingServer.socketType = Ci.nsMsgSocketType.alwaysSTARTTLS;</span>
<a href="#l20.23"></a><span id="l20.23"> </span>
<a href="#l20.24"></a><span id="l20.24">   // we need a local account for the IMAP server to have its sent messages in</span>
<a href="#l20.25"></a><span id="l20.25">   loadLocalMailAccount();</span>
<a href="#l20.26"></a><span id="l20.26"> </span>
<a href="#l20.27"></a><span id="l20.27">   // We need an identity so that updateFolder doesn't fail</span>
<a href="#l20.28"></a><span id="l20.28" class="difflineminus">-  let acctMgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l20.29"></a><span id="l20.29" class="difflineminus">-                  .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l20.30"></a><span id="l20.30" class="difflineminus">-  let imapAccount = acctMgr.createAccount();</span>
<a href="#l20.31"></a><span id="l20.31" class="difflineminus">-  let identity = acctMgr.createIdentity();</span>
<a href="#l20.32"></a><span id="l20.32" class="difflineplus">+  let imapAccount = MailServices.accounts.createAccount();</span>
<a href="#l20.33"></a><span id="l20.33" class="difflineplus">+  let identity = MailServices.accounts.createIdentity();</span>
<a href="#l20.34"></a><span id="l20.34">   imapAccount.addIdentity(identity);</span>
<a href="#l20.35"></a><span id="l20.35">   imapAccount.defaultIdentity = identity;</span>
<a href="#l20.36"></a><span id="l20.36">   imapAccount.incomingServer = gIMAPIncomingServer;</span>
<a href="#l20.37"></a><span id="l20.37" class="difflineminus">-  acctMgr.defaultAccount = imapAccount;</span>
<a href="#l20.38"></a><span id="l20.38" class="difflineplus">+  MailServices.accounts.defaultAccount = imapAccount;</span>
<a href="#l20.39"></a><span id="l20.39"> </span>
<a href="#l20.40"></a><span id="l20.40">   // The server doesn't support more than one connection</span>
<a href="#l20.41"></a><span id="l20.41">   Services.prefs.setIntPref(&quot;mail.server.server1.max_cached_connections&quot;, 1);</span>
<a href="#l20.42"></a><span id="l20.42">   // We aren't interested in downloading messages automatically</span>
<a href="#l20.43"></a><span id="l20.43">   Services.prefs.setBoolPref(&quot;mail.server.server1.download_on_biff&quot;, false);</span>
<a href="#l20.44"></a><span id="l20.44"> </span>
<a href="#l20.45"></a><span id="l20.45">   gIMAPInbox = gIMAPIncomingServer.rootFolder.getChildNamed(&quot;Inbox&quot;)</span>
<a href="#l20.46"></a><span id="l20.46">                                   .QueryInterface(Ci.nsIMsgImapMailFolder);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_trustSpamAssassin.js</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_trustSpamAssassin.js</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -15,16 +15,18 @@</span>
<a href="#l21.4"></a><span id="l21.4"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l21.5"></a><span id="l21.5"> load(&quot;../../../resources/mailTestUtils.js&quot;);</span>
<a href="#l21.6"></a><span id="l21.6"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l21.7"></a><span id="l21.7"> </span>
<a href="#l21.8"></a><span id="l21.8"> // IMAP pump</span>
<a href="#l21.9"></a><span id="l21.9"> load(&quot;../../../resources/IMAPpump.js&quot;);</span>
<a href="#l21.10"></a><span id="l21.10"> </span>
<a href="#l21.11"></a><span id="l21.11"> // Globals</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+</span>
<a href="#l21.14"></a><span id="l21.14"> const gMessage = &quot;SpamAssassinYes&quot;; // message file used as the test message</span>
<a href="#l21.15"></a><span id="l21.15"> </span>
<a href="#l21.16"></a><span id="l21.16"> setupIMAPPump();</span>
<a href="#l21.17"></a><span id="l21.17"> </span>
<a href="#l21.18"></a><span id="l21.18"> // Definition of tests</span>
<a href="#l21.19"></a><span id="l21.19"> </span>
<a href="#l21.20"></a><span id="l21.20"> var tests = [</span>
<a href="#l21.21"></a><span id="l21.21">   createJunkFolder,</span>
<a href="#l21.22"></a><span id="l21.22" class="difflineat">@@ -92,30 +94,28 @@ function markMessageAsGood()</span>
<a href="#l21.23"></a><span id="l21.23">   /*</span>
<a href="#l21.24"></a><span id="l21.24">    * Now move this message to the inbox. In bug 540385, the message just</span>
<a href="#l21.25"></a><span id="l21.25">    *  gets moved back to the junk folder again. We'll test that we</span>
<a href="#l21.26"></a><span id="l21.26">    *  are now preventing that.</span>
<a href="#l21.27"></a><span id="l21.27">    */</span>
<a href="#l21.28"></a><span id="l21.28">   let messages = Cc[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l21.29"></a><span id="l21.29">                    .createInstance(Ci.nsIMutableArray);</span>
<a href="#l21.30"></a><span id="l21.30">   messages.appendElement(msgHdr, false);</span>
<a href="#l21.31"></a><span id="l21.31" class="difflineminus">-  let copyService = Cc[&quot;@mozilla.org/messenger/messagecopyservice;1&quot;]</span>
<a href="#l21.32"></a><span id="l21.32" class="difflineminus">-                       .getService(Ci.nsIMsgCopyService);</span>
<a href="#l21.33"></a><span id="l21.33">   /*</span>
<a href="#l21.34"></a><span id="l21.34">   void CopyMessages(in nsIMsgFolder srcFolder,</span>
<a href="#l21.35"></a><span id="l21.35">                     in nsIArray messages,</span>
<a href="#l21.36"></a><span id="l21.36">                     in nsIMsgFolder dstFolder,</span>
<a href="#l21.37"></a><span id="l21.37">                     in boolean isMove,</span>
<a href="#l21.38"></a><span id="l21.38">                     in nsIMsgCopyServiceListener listener,</span>
<a href="#l21.39"></a><span id="l21.39">                     in nsIMsgWindow msgWindow,</span>
<a href="#l21.40"></a><span id="l21.40">                     in boolean allowUndo);</span>
<a href="#l21.41"></a><span id="l21.41">   */</span>
<a href="#l21.42"></a><span id="l21.42"> </span>
<a href="#l21.43"></a><span id="l21.43" class="difflineminus">-  copyService.CopyMessages(gJunkFolder, messages, gIMAPInbox, true,</span>
<a href="#l21.44"></a><span id="l21.44" class="difflineminus">-                            null, null, false);</span>
<a href="#l21.45"></a><span id="l21.45" class="difflineplus">+  MailServices.copy.CopyMessages(gJunkFolder, messages, gIMAPInbox, true,</span>
<a href="#l21.46"></a><span id="l21.46" class="difflineplus">+                                 null, null, false);</span>
<a href="#l21.47"></a><span id="l21.47">   dl('wait for msgsMoveCopyCompleted');</span>
<a href="#l21.48"></a><span id="l21.48">   yield false;</span>
<a href="#l21.49"></a><span id="l21.49"> }</span>
<a href="#l21.50"></a><span id="l21.50"> </span>
<a href="#l21.51"></a><span id="l21.51"> function updateFoldersAndCheck()</span>
<a href="#l21.52"></a><span id="l21.52"> {</span>
<a href="#l21.53"></a><span id="l21.53">   gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l21.54"></a><span id="l21.54">   dl('wait for OnStopRunningURL');</span>
<a href="#l21.55"></a><span id="l21.55" class="difflineat">@@ -144,24 +144,22 @@ function run_test()</span>
<a href="#l21.56"></a><span id="l21.56">   server.setBoolValue(&quot;moveOnSpam&quot;, true);</span>
<a href="#l21.57"></a><span id="l21.57">   server.setIntValue(&quot;moveTargetMode&quot;, Ci.nsISpamSettings.MOVE_TARGET_MODE_ACCOUNT);</span>
<a href="#l21.58"></a><span id="l21.58">   server.setCharValue(&quot;spamActionTargetAccount&quot;, server.serverURI);</span>
<a href="#l21.59"></a><span id="l21.59"> </span>
<a href="#l21.60"></a><span id="l21.60">   spamSettings.initialize(server);</span>
<a href="#l21.61"></a><span id="l21.61"> </span>
<a href="#l21.62"></a><span id="l21.62">   // Add folder listeners that will capture async events</span>
<a href="#l21.63"></a><span id="l21.63">   const nsIMFNService = Ci.nsIMsgFolderNotificationService;</span>
<a href="#l21.64"></a><span id="l21.64" class="difflineminus">-  let MFNService = Cc[&quot;@mozilla.org/messenger/msgnotificationservice;1&quot;]</span>
<a href="#l21.65"></a><span id="l21.65" class="difflineminus">-                      .getService(nsIMFNService);</span>
<a href="#l21.66"></a><span id="l21.66"> </span>
<a href="#l21.67"></a><span id="l21.67">   let flags =</span>
<a href="#l21.68"></a><span id="l21.68">         nsIMFNService.msgsMoveCopyCompleted |</span>
<a href="#l21.69"></a><span id="l21.69">         nsIMFNService.folderAdded | </span>
<a href="#l21.70"></a><span id="l21.70">         nsIMFNService.msgAdded;</span>
<a href="#l21.71"></a><span id="l21.71" class="difflineminus">-  MFNService.addListener(mfnListener, flags);</span>
<a href="#l21.72"></a><span id="l21.72" class="difflineplus">+  MailServices.mfn.addListener(mfnListener, flags);</span>
<a href="#l21.73"></a><span id="l21.73"> </span>
<a href="#l21.74"></a><span id="l21.74">   //start first test</span>
<a href="#l21.75"></a><span id="l21.75">   async_run_tests(tests);</span>
<a href="#l21.76"></a><span id="l21.76"> }</span>
<a href="#l21.77"></a><span id="l21.77"> </span>
<a href="#l21.78"></a><span id="l21.78"> mfnListener =</span>
<a href="#l21.79"></a><span id="l21.79"> {</span>
<a href="#l21.80"></a><span id="l21.80">   msgsMoveCopyCompleted: function (aMove, aSrcMsgs, aDestFolder, aDestMsgs)</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

