<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 7250:491fbcf7a1b443860503f245f68941d8f7a1306b</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 491fbcf7a1b443860503f245f68941d8f7a1306b" />
<meta property="og:url" content="/comm-central/rev/491fbcf7a1b443860503f245f68941d8f7a1306b" />
<meta property="og:description" content="Bug 468808 - &quot;Tabs can't be reordered&quot;. r=asuth" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 491fbcf7a1b443860503f245f68941d8f7a1306b 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/491fbcf7a1b443860503f245f68941d8f7a1306b">shortlog</a> |
<a href="/comm-central/log/491fbcf7a1b443860503f245f68941d8f7a1306b">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/491fbcf7a1b443860503f245f68941d8f7a1306b">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/491fbcf7a1b443860503f245f68941d8f7a1306b">files</a> |
changeset |
<a href="/comm-central/raw-rev/491fbcf7a1b443860503f245f68941d8f7a1306b">raw</a>  | <a href="/comm-central/archive/491fbcf7a1b443860503f245f68941d8f7a1306b.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=468808">Bug 468808</a> - &quot;Tabs can't be reordered&quot;. r=asuth
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#84;&#104;&#111;&#109;&#97;&#115;&#32;&#83;&#99;&#104;&#109;&#105;&#100;&#32;&#60;&#115;&#99;&#104;&#109;&#105;&#100;&#45;&#116;&#104;&#111;&#109;&#97;&#115;&#64;&#103;&#109;&#120;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 16 Feb 2011 14:13:00 -0800</td></tr>

<tr>
 <td>changeset 7250</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/491fbcf7a1b443860503f245f68941d8f7a1306b">491fbcf7a1b443860503f245f68941d8f7a1306b</a></td>
</tr>



<tr>
<td>parent 7249</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/5c62105268eb8ee18537521905ba5208a677b0de">5c62105268eb8ee18537521905ba5208a677b0de</a>
</td>
</tr>

<tr>
<td>child 7251</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/33614283e6756b057b026a322b34dfbaa12db5e2">33614283e6756b057b026a322b34dfbaa12db5e2</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=491fbcf7a1b443860503f245f68941d8f7a1306b">5561</a></td></tr>
<tr><td>push user</td><td>bugmail@asutherland.org</td></tr>
<tr><td>push date</td><td class="date age">Fri, 04 Mar 2011 01:38:11 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@33614283e675 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=33614283e6756b057b026a322b34dfbaa12db5e2">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=33614283e6756b057b026a322b34dfbaa12db5e2&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=33614283e6756b057b026a322b34dfbaa12db5e2&newProject=comm-central&newRevision=491fbcf7a1b443860503f245f68941d8f7a1306b&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=33614283e6756b057b026a322b34dfbaa12db5e2&newProject=comm-central&newRevision=491fbcf7a1b443860503f245f68941d8f7a1306b&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=33614283e6756b057b026a322b34dfbaa12db5e2&newProject=comm-central&newRevision=491fbcf7a1b443860503f245f68941d8f7a1306b&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28asuth%29&revcount=50">asuth</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=468808">468808</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=468808">Bug 468808</a> - &quot;Tabs can't be reordered&quot;. r=asuth</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/491fbcf7a1b443860503f245f68941d8f7a1306b/mail/base/content/messageDisplay.js">mail/base/content/messageDisplay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/491fbcf7a1b443860503f245f68941d8f7a1306b/mail/base/content/messageDisplay.js">file</a> |
<a href="/comm-central/annotate/491fbcf7a1b443860503f245f68941d8f7a1306b/mail/base/content/messageDisplay.js">annotate</a> |
<a href="/comm-central/diff/491fbcf7a1b443860503f245f68941d8f7a1306b/mail/base/content/messageDisplay.js">diff</a> |
<a href="/comm-central/comparison/491fbcf7a1b443860503f245f68941d8f7a1306b/mail/base/content/messageDisplay.js">comparison</a> |
<a href="/comm-central/log/491fbcf7a1b443860503f245f68941d8f7a1306b/mail/base/content/messageDisplay.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/491fbcf7a1b443860503f245f68941d8f7a1306b/mail/base/content/msgMail3PaneWindow.js">mail/base/content/msgMail3PaneWindow.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/491fbcf7a1b443860503f245f68941d8f7a1306b/mail/base/content/msgMail3PaneWindow.js">file</a> |
<a href="/comm-central/annotate/491fbcf7a1b443860503f245f68941d8f7a1306b/mail/base/content/msgMail3PaneWindow.js">annotate</a> |
<a href="/comm-central/diff/491fbcf7a1b443860503f245f68941d8f7a1306b/mail/base/content/msgMail3PaneWindow.js">diff</a> |
<a href="/comm-central/comparison/491fbcf7a1b443860503f245f68941d8f7a1306b/mail/base/content/msgMail3PaneWindow.js">comparison</a> |
<a href="/comm-central/log/491fbcf7a1b443860503f245f68941d8f7a1306b/mail/base/content/msgMail3PaneWindow.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/491fbcf7a1b443860503f245f68941d8f7a1306b/mail/base/content/tabmail.xml">mail/base/content/tabmail.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/491fbcf7a1b443860503f245f68941d8f7a1306b/mail/base/content/tabmail.xml">file</a> |
<a href="/comm-central/annotate/491fbcf7a1b443860503f245f68941d8f7a1306b/mail/base/content/tabmail.xml">annotate</a> |
<a href="/comm-central/diff/491fbcf7a1b443860503f245f68941d8f7a1306b/mail/base/content/tabmail.xml">diff</a> |
<a href="/comm-central/comparison/491fbcf7a1b443860503f245f68941d8f7a1306b/mail/base/content/tabmail.xml">comparison</a> |
<a href="/comm-central/log/491fbcf7a1b443860503f245f68941d8f7a1306b/mail/base/content/tabmail.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/491fbcf7a1b443860503f245f68941d8f7a1306b/mail/locales/en-US/chrome/messenger/messenger.dtd">mail/locales/en-US/chrome/messenger/messenger.dtd</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/491fbcf7a1b443860503f245f68941d8f7a1306b/mail/locales/en-US/chrome/messenger/messenger.dtd">file</a> |
<a href="/comm-central/annotate/491fbcf7a1b443860503f245f68941d8f7a1306b/mail/locales/en-US/chrome/messenger/messenger.dtd">annotate</a> |
<a href="/comm-central/diff/491fbcf7a1b443860503f245f68941d8f7a1306b/mail/locales/en-US/chrome/messenger/messenger.dtd">diff</a> |
<a href="/comm-central/comparison/491fbcf7a1b443860503f245f68941d8f7a1306b/mail/locales/en-US/chrome/messenger/messenger.dtd">comparison</a> |
<a href="/comm-central/log/491fbcf7a1b443860503f245f68941d8f7a1306b/mail/locales/en-US/chrome/messenger/messenger.dtd">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/491fbcf7a1b443860503f245f68941d8f7a1306b/mail/test/mozmill/mozmilltests.list">mail/test/mozmill/mozmilltests.list</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/491fbcf7a1b443860503f245f68941d8f7a1306b/mail/test/mozmill/mozmilltests.list">file</a> |
<a href="/comm-central/annotate/491fbcf7a1b443860503f245f68941d8f7a1306b/mail/test/mozmill/mozmilltests.list">annotate</a> |
<a href="/comm-central/diff/491fbcf7a1b443860503f245f68941d8f7a1306b/mail/test/mozmill/mozmilltests.list">diff</a> |
<a href="/comm-central/comparison/491fbcf7a1b443860503f245f68941d8f7a1306b/mail/test/mozmill/mozmilltests.list">comparison</a> |
<a href="/comm-central/log/491fbcf7a1b443860503f245f68941d8f7a1306b/mail/test/mozmill/mozmilltests.list">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/491fbcf7a1b443860503f245f68941d8f7a1306b/mail/test/mozmill/tabmail/test-tabmail-dragndrop.js">mail/test/mozmill/tabmail/test-tabmail-dragndrop.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/491fbcf7a1b443860503f245f68941d8f7a1306b/mail/test/mozmill/tabmail/test-tabmail-dragndrop.js">file</a> |
<a href="/comm-central/annotate/491fbcf7a1b443860503f245f68941d8f7a1306b/mail/test/mozmill/tabmail/test-tabmail-dragndrop.js">annotate</a> |
<a href="/comm-central/diff/491fbcf7a1b443860503f245f68941d8f7a1306b/mail/test/mozmill/tabmail/test-tabmail-dragndrop.js">diff</a> |
<a href="/comm-central/comparison/491fbcf7a1b443860503f245f68941d8f7a1306b/mail/test/mozmill/tabmail/test-tabmail-dragndrop.js">comparison</a> |
<a href="/comm-central/log/491fbcf7a1b443860503f245f68941d8f7a1306b/mail/test/mozmill/tabmail/test-tabmail-dragndrop.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/base/content/messageDisplay.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/base/content/messageDisplay.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -528,17 +528,17 @@ MessageTabDisplayWidget.prototype = {</span>
<a href="#l1.4"></a><span id="l1.4">   onSelectedMessagesChanged:</span>
<a href="#l1.5"></a><span id="l1.5">       function MessageTabDisplayWidget_onSelectedMessagesChanged() {</span>
<a href="#l1.6"></a><span id="l1.6">     // Look at the number of messages left in the db view. If there aren't any,</span>
<a href="#l1.7"></a><span id="l1.7">     // close the tab.</span>
<a href="#l1.8"></a><span id="l1.8">     if (this.folderDisplay.view.dbView.rowCount == 0) {</span>
<a href="#l1.9"></a><span id="l1.9">       if (!this.closing) {</span>
<a href="#l1.10"></a><span id="l1.10">         this.closing = true;</span>
<a href="#l1.11"></a><span id="l1.11">         document.getElementById('tabmail').closeTab(</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-            this.folderDisplay._tabInfo);</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+            this.folderDisplay._tabInfo, true);</span>
<a href="#l1.14"></a><span id="l1.14">       }</span>
<a href="#l1.15"></a><span id="l1.15">       return true;</span>
<a href="#l1.16"></a><span id="l1.16">     }</span>
<a href="#l1.17"></a><span id="l1.17">     else {</span>
<a href="#l1.18"></a><span id="l1.18">       if (!this.closing)</span>
<a href="#l1.19"></a><span id="l1.19">         document.getElementById('tabmail').setTabTitle(</span>
<a href="#l1.20"></a><span id="l1.20">             this.folderDisplay._tabInfo);</span>
<a href="#l1.21"></a><span id="l1.21"> </span>
<a href="#l1.22"></a><span id="l1.22" class="difflineat">@@ -550,29 +550,31 @@ MessageTabDisplayWidget.prototype = {</span>
<a href="#l1.23"></a><span id="l1.23">       this.singleMessageDisplay = true;</span>
<a href="#l1.24"></a><span id="l1.24">       return false;</span>
<a href="#l1.25"></a><span id="l1.25">     }</span>
<a href="#l1.26"></a><span id="l1.26">   },</span>
<a href="#l1.27"></a><span id="l1.27"> </span>
<a href="#l1.28"></a><span id="l1.28">   onMessagesRemoved: function MessageTabDisplayWidget_onMessagesRemoved() {</span>
<a href="#l1.29"></a><span id="l1.29">     if (this.folderDisplay.treeSelection.count == 0 &amp;&amp;</span>
<a href="#l1.30"></a><span id="l1.30">         pref.getBoolPref(&quot;mail.close_message_window.on_delete&quot;)) {</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-      document.getElementById(&quot;tabmail&quot;).closeTab(this.folderDisplay._tabInfo);</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+      document.getElementById(&quot;tabmail&quot;).closeTab(this.folderDisplay._tabInfo,</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+                                                  true);</span>
<a href="#l1.34"></a><span id="l1.34">       return true;</span>
<a href="#l1.35"></a><span id="l1.35">     }</span>
<a href="#l1.36"></a><span id="l1.36">   },</span>
<a href="#l1.37"></a><span id="l1.37"> </span>
<a href="#l1.38"></a><span id="l1.38">   /**</span>
<a href="#l1.39"></a><span id="l1.39">    * A message tab should never ever be blank.  Close the tab if we become</span>
<a href="#l1.40"></a><span id="l1.40">    *  blank.</span>
<a href="#l1.41"></a><span id="l1.41">    */</span>
<a href="#l1.42"></a><span id="l1.42">   clearDisplay: function MessageTabDisplayWidget_clearDisplay() {</span>
<a href="#l1.43"></a><span id="l1.43">     if (!this.closing) {</span>
<a href="#l1.44"></a><span id="l1.44">       this.closing = true;</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineminus">-      document.getElementById('tabmail').closeTab(this.folderDisplay._tabInfo);</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineplus">+      document.getElementById('tabmail').closeTab(this.folderDisplay._tabInfo,</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineplus">+                                                  true);</span>
<a href="#l1.48"></a><span id="l1.48">     }</span>
<a href="#l1.49"></a><span id="l1.49">   }</span>
<a href="#l1.50"></a><span id="l1.50"> };</span>
<a href="#l1.51"></a><span id="l1.51"> </span>
<a href="#l1.52"></a><span id="l1.52"> /**</span>
<a href="#l1.53"></a><span id="l1.53">  * The search dialog has no message preview pane, and so wants a message</span>
<a href="#l1.54"></a><span id="l1.54">  *  display widget that is never visible.  No one other than the search</span>
<a href="#l1.55"></a><span id="l1.55">  *  dialog should use this because the search dialog is bad UI.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/base/content/msgMail3PaneWindow.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/base/content/msgMail3PaneWindow.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -499,16 +499,17 @@ function LoadPostAccountWizard()</span>
<a href="#l2.4"></a><span id="l2.4">   var toolbarset = document.getElementById('customToolbars');</span>
<a href="#l2.5"></a><span id="l2.5">   toolbox.toolbarset = toolbarset;</span>
<a href="#l2.6"></a><span id="l2.6"> </span>
<a href="#l2.7"></a><span id="l2.7">   // XXX Do not select the folder until the window displays or the threadpane</span>
<a href="#l2.8"></a><span id="l2.8">   //  will be at minimum size.  We used to have</span>
<a href="#l2.9"></a><span id="l2.9">   //  gFolderDisplay.ensureRowIsVisible use settimeout itself to defer that</span>
<a href="#l2.10"></a><span id="l2.10">   //  calculation, but that was ugly.  Also, in theory we will open the window</span>
<a href="#l2.11"></a><span id="l2.11">   //  faster if we let the event loop start doing things sooner.</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+</span>
<a href="#l2.13"></a><span id="l2.13">   if (startMsgHdr)</span>
<a href="#l2.14"></a><span id="l2.14">     window.setTimeout(loadStartMsgHdr, 0, startMsgHdr);</span>
<a href="#l2.15"></a><span id="l2.15">   else</span>
<a href="#l2.16"></a><span id="l2.16">     window.setTimeout(loadStartFolder, 0, startFolderURI);</span>
<a href="#l2.17"></a><span id="l2.17"> }</span>
<a href="#l2.18"></a><span id="l2.18"> </span>
<a href="#l2.19"></a><span id="l2.19"> function HandleAppCommandEvent(evt)</span>
<a href="#l2.20"></a><span id="l2.20"> {</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineat">@@ -603,56 +604,112 @@ function getWindowStateForSessionPersist</span>
<a href="#l2.22"></a><span id="l2.22">  * @param aDontRestoreFirstTab If this is true, the first tab will not be</span>
<a href="#l2.23"></a><span id="l2.23">  *                             restored, and will continue to retain focus at</span>
<a href="#l2.24"></a><span id="l2.24">  *                             the end. This is needed if the window was opened</span>
<a href="#l2.25"></a><span id="l2.25">  *                             with a folder or a message as an argument.</span>
<a href="#l2.26"></a><span id="l2.26">  *</span>
<a href="#l2.27"></a><span id="l2.27">  * @return true if the restoration was successful, false otherwise.</span>
<a href="#l2.28"></a><span id="l2.28">  */</span>
<a href="#l2.29"></a><span id="l2.29"> function atStartupRestoreTabs(aDontRestoreFirstTab) {</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineplus">+</span>
<a href="#l2.31"></a><span id="l2.31">   let state = sessionStoreManager.loadingWindow(window);</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+</span>
<a href="#l2.33"></a><span id="l2.33">   if (state) {</span>
<a href="#l2.34"></a><span id="l2.34">     let tabsState = state.tabs;</span>
<a href="#l2.35"></a><span id="l2.35">     let tabmail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l2.36"></a><span id="l2.36">     tabmail.restoreTabs(tabsState, aDontRestoreFirstTab);</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineminus">-    return true;</span>
<a href="#l2.38"></a><span id="l2.38">   }</span>
<a href="#l2.39"></a><span id="l2.39"> </span>
<a href="#l2.40"></a><span id="l2.40" class="difflineminus">-  return false;</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+  // it's now safe to load extra Tabs.</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+  setTimeout(loadExtraTabs, 0);</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineplus">+</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineplus">+  return state ? true : false;</span>
<a href="#l2.45"></a><span id="l2.45"> }</span>
<a href="#l2.46"></a><span id="l2.46"> </span>
<a href="#l2.47"></a><span id="l2.47" class="difflineplus">+/**</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineplus">+ * Loads and restores tabs upon opening a window by evaluating window.arguments[1].</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineplus">+ *</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineplus">+ * The type of the object is specified by it's action property. It can be</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+ * either &quot;restore&quot; or &quot;open&quot;. &quot;restore&quot; invokes tabmail.restoreTab() for each</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineplus">+ * item in the tabs array. While &quot;open&quot; invokes tabmail.openTab() for each item.</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineplus">+ *</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineplus">+ * In case a tab can't be restored it will fail silently</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+ *</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineplus">+ * the object need at least the following properties:</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineplus">+ *</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineplus">+ * {</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+ *   action = &quot;restore&quot; | &quot;open&quot;</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineplus">+ *   tabs = [];</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineplus">+ * }</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineplus">+ *</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineplus">+ */</span>
<a href="#l2.64"></a><span id="l2.64"> function loadExtraTabs()</span>
<a href="#l2.65"></a><span id="l2.65"> {</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineminus">-  if (&quot;arguments&quot; in window &amp;&amp; window.arguments.length &gt;= 2) {</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineminus">-    if (window.arguments[1] &amp;&amp; (typeof window.arguments[1] == &quot;object&quot;) &amp;&amp;</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineminus">-        (&quot;tabType&quot; in window.arguments[1])) {</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineminus">-      document.getElementById('tabmail').openTab(window.arguments[1].tabType, window.arguments[1].tabParams);</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineminus">-    }</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineplus">+</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineplus">+  if (!(&quot;arguments&quot; in window) || window.arguments.length &lt; 2)</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineplus">+    return;</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineplus">+</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineplus">+  let tab = window.arguments[1];</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineplus">+  if ((!tab) || (typeof tab != &quot;object&quot;))</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineplus">+    return;</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineplus">+</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineplus">+  let tabmail =  document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineplus">+</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineplus">+  // we got no action, so suppose its &quot;legacy&quot; code</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineplus">+  if (!(&quot;action&quot; in tab)) {</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineplus">+</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineplus">+    if (&quot;tabType&quot; in tab)</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineplus">+      tabmail.openTab(tab.tabType, tab.tabParams);</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineplus">+</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineplus">+    return;</span>
<a href="#l2.88"></a><span id="l2.88">   }</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineplus">+</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineplus">+  if (!(&quot;tabs&quot; in tab))</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineplus">+    return;</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineplus">+</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineplus">+  // this is used if a tab is detached to a new window.</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineplus">+  if (tab.action == &quot;restore&quot;) {</span>
<a href="#l2.95"></a><span id="l2.95" class="difflineplus">+</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineplus">+    for (let i = 0; i &lt; tab.tabs.length; i++)</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineplus">+      tabmail.restoreTab(tab.tabs[i]);</span>
<a href="#l2.98"></a><span id="l2.98" class="difflineplus">+</span>
<a href="#l2.99"></a><span id="l2.99" class="difflineplus">+    // we currently do not support opening in background or opening a</span>
<a href="#l2.100"></a><span id="l2.100" class="difflineplus">+    // special position. So select the last tab opened.</span>
<a href="#l2.101"></a><span id="l2.101" class="difflineplus">+    tabmail.switchToTab(tabmail.tabInfo[tabmail.tabInfo.length-1])</span>
<a href="#l2.102"></a><span id="l2.102" class="difflineplus">+</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineplus">+    return;</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineplus">+  }</span>
<a href="#l2.105"></a><span id="l2.105" class="difflineplus">+</span>
<a href="#l2.106"></a><span id="l2.106" class="difflineplus">+  if (tab.action == &quot;open&quot;) {</span>
<a href="#l2.107"></a><span id="l2.107" class="difflineplus">+</span>
<a href="#l2.108"></a><span id="l2.108" class="difflineplus">+    for (let i = 0; i &lt; tab.tabs.length; i++)</span>
<a href="#l2.109"></a><span id="l2.109" class="difflineplus">+      if(&quot;tabType&quot; in tabs.tab[i])</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineplus">+        tabmail.openTab(tabs.tab[i].tabType,tabs.tab[i].tabParams);</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineplus">+</span>
<a href="#l2.112"></a><span id="l2.112" class="difflineplus">+    return;</span>
<a href="#l2.113"></a><span id="l2.113" class="difflineplus">+  }</span>
<a href="#l2.114"></a><span id="l2.114" class="difflineplus">+</span>
<a href="#l2.115"></a><span id="l2.115"> }</span>
<a href="#l2.116"></a><span id="l2.116"> </span>
<a href="#l2.117"></a><span id="l2.117"> /**</span>
<a href="#l2.118"></a><span id="l2.118">  * Loads the given message header at window open. Exactly one out of this and</span>
<a href="#l2.119"></a><span id="l2.119">  * |loadStartFolder| should be called.</span>
<a href="#l2.120"></a><span id="l2.120">  *</span>
<a href="#l2.121"></a><span id="l2.121">  * @param aStartMsgHdr The message header to load at window open</span>
<a href="#l2.122"></a><span id="l2.122">  */</span>
<a href="#l2.123"></a><span id="l2.123"> function loadStartMsgHdr(aStartMsgHdr)</span>
<a href="#l2.124"></a><span id="l2.124"> {</span>
<a href="#l2.125"></a><span id="l2.125" class="difflineminus">-  setTimeout(loadExtraTabs, 0);</span>
<a href="#l2.126"></a><span id="l2.126" class="difflineminus">-</span>
<a href="#l2.127"></a><span id="l2.127">   // We'll just clobber the default tab</span>
<a href="#l2.128"></a><span id="l2.128">   atStartupRestoreTabs(true);</span>
<a href="#l2.129"></a><span id="l2.129"> </span>
<a href="#l2.130"></a><span id="l2.130">   MsgDisplayMessageInFolderTab(aStartMsgHdr);</span>
<a href="#l2.131"></a><span id="l2.131"> }</span>
<a href="#l2.132"></a><span id="l2.132"> </span>
<a href="#l2.133"></a><span id="l2.133"> function loadStartFolder(initialUri)</span>
<a href="#l2.134"></a><span id="l2.134"> {</span>
<a href="#l2.135"></a><span id="l2.135" class="difflineminus">-  setTimeout(loadExtraTabs, 0);</span>
<a href="#l2.136"></a><span id="l2.136">     var defaultServer = null;</span>
<a href="#l2.137"></a><span id="l2.137">     var startFolder;</span>
<a href="#l2.138"></a><span id="l2.138">     var isLoginAtStartUpEnabled = false;</span>
<a href="#l2.139"></a><span id="l2.139"> </span>
<a href="#l2.140"></a><span id="l2.140">     // If a URI was explicitly specified, we'll just clobber the default tab</span>
<a href="#l2.141"></a><span id="l2.141">     let loadFolder = !atStartupRestoreTabs(!!initialUri);</span>
<a href="#l2.142"></a><span id="l2.142">     if (initialUri)</span>
<a href="#l2.143"></a><span id="l2.143">       loadFolder = true;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/base/content/tabmail.xml</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/base/content/tabmail.xml</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -18,16 +18,17 @@</span>
<a href="#l3.4"></a><span id="l3.4">   -   David Bienvenu &lt;bienvenu@nventure.com&gt;.</span>
<a href="#l3.5"></a><span id="l3.5">   - Portions created by the Initial Developer are Copyright (C) 2007</span>
<a href="#l3.6"></a><span id="l3.6">   - the Initial Developer. All Rights Reserved.</span>
<a href="#l3.7"></a><span id="l3.7">   -</span>
<a href="#l3.8"></a><span id="l3.8">   - Contributor(s):</span>
<a href="#l3.9"></a><span id="l3.9">   -  Scott MacGregor &lt;mscott@mozilla.org&gt;</span>
<a href="#l3.10"></a><span id="l3.10">   -  Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l3.11"></a><span id="l3.11">   -  Magnus Melin &lt;mkmelin+mozilla@iki.fi&gt;</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+  -  Thomas Schmid &lt;schmid-thomas@gmx.net&gt;</span>
<a href="#l3.13"></a><span id="l3.13">   -</span>
<a href="#l3.14"></a><span id="l3.14">   - Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l3.15"></a><span id="l3.15">   - either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l3.16"></a><span id="l3.16">   - the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l3.17"></a><span id="l3.17">   - in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l3.18"></a><span id="l3.18">   - of those above. If you wish to allow use of your version of this file only</span>
<a href="#l3.19"></a><span id="l3.19">   - under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l3.20"></a><span id="l3.20">   - use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineat">@@ -67,38 +68,59 @@</span>
<a href="#l3.22"></a><span id="l3.22">     -</span>
<a href="#l3.23"></a><span id="l3.23">     - From a javascript perspective, there are three types of code that we</span>
<a href="#l3.24"></a><span id="l3.24">     -  expect to interact with:</span>
<a href="#l3.25"></a><span id="l3.25">     - 1) Code that wants to open new tabs.</span>
<a href="#l3.26"></a><span id="l3.26">     - 2) Code that wants to contribute one or more varieties of tabs.</span>
<a href="#l3.27"></a><span id="l3.27">     - 3) Code that wants to monitor to know when the active tab changes.</span>
<a href="#l3.28"></a><span id="l3.28">     -</span>
<a href="#l3.29"></a><span id="l3.29">     - Consumer code should use the following methods:</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineminus">-    - * openTab(aTabModeName, aArgs): Open a tab of the given &quot;mode&quot;,</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-    -   passing the provided arguments as an object.  The tab type author</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineminus">-    -   should tell you the modes they implement and the required/optional</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineminus">-    -   arguments.</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineminus">-    -   One of the arguments you can pass is &quot;background&quot;: if this is true,</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineminus">-    -   the tab will be loaded in the background.</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineminus">-    - * closeTab(aOptionalTabIndexInfoOrTabNode): If no argument is provided,</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineminus">-    -   the current tab is closed.  If an argument is provided, it can be</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineminus">-    -   a tab index, a tab info object, or the tabmail-tab bound element</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineminus">-    -   that _is_ the tab.  Some tabs cannot be closed, in which case this</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineminus">-    -   will do nothing.</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineminus">-    - * switchToTab(aTabIndexInfoOrTabNode): Switch to the tab by providing</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineminus">-    -   a tab index, tab info object, or tab node (tabmail-tab bound</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineminus">-    -   element.)  You can also just poke at tabmail.tabContainer and its</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineminus">-    -   selectedIndex and selectedItem properties.</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+    - * openTab(aTabModeName, aArgs)</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineplus">+    -     Open a tab of the given &quot;mode&quot;, passing the provided arguments as an </span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+    -     object. The tab type author should tell you the modes they implement </span>
<a href="#l3.48"></a><span id="l3.48" class="difflineplus">+    -     and the required/optional arguments.</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineplus">+    -     One of the arguments you can pass is &quot;background&quot;: if this is true,</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+    -     the tab will be loaded in the background.</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+    - * closeTab(aOptionalTabIndexInfoOrTabNode,aNoUndo): </span>
<a href="#l3.52"></a><span id="l3.52" class="difflineplus">+    -     If no argument is provided, the current tab is closed. The first </span>
<a href="#l3.53"></a><span id="l3.53" class="difflineplus">+    -     argument specifies a specific tab to be closed. It can be a tab index,</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineplus">+    -     a tab info object, or a tab's DOM element. In case the second </span>
<a href="#l3.55"></a><span id="l3.55" class="difflineplus">+    -     argument is true, the closed tab can't be restored by calling</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineplus">+    -     undoCloseTab(). </span>
<a href="#l3.57"></a><span id="l3.57" class="difflineplus">+    -     Please note, some tabs cannot be closed. Trying to close such tab, </span>
<a href="#l3.58"></a><span id="l3.58" class="difflineplus">+    -     willd fail silently.</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineplus">+    - * undoCloseTab(): </span>
<a href="#l3.60"></a><span id="l3.60" class="difflineplus">+    -     Restores the most recent tab closed by the user. </span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+    - * switchToTab(aTabIndexInfoOrTabNode): </span>
<a href="#l3.62"></a><span id="l3.62" class="difflineplus">+    -     Switch to the tab by providing a tab index, tab info object, or tab </span>
<a href="#l3.63"></a><span id="l3.63" class="difflineplus">+    -     node (tabmail-tab bound element.) You can also just poke at </span>
<a href="#l3.64"></a><span id="l3.64" class="difflineplus">+    -     tabmail.tabContainer and its selectedIndex and selectedItem</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineplus">+    -     properties.</span>
<a href="#l3.66"></a><span id="l3.66">     - * setTabIcon(aTabNodeorInfo, aIcon): Sets the tab icon to the specified</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineminus">-    -   url or removes the icon if no url is specified. Note that this may</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineminus">-    -   overrride css provided images.</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineplus">+    -     url or removes the icon if no url is specified. Note that this may</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineplus">+    -     overrride css provided images.</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineplus">+    - * replaceTabWithWindow(aTab):</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineplus">+    -     Detaches a tab from this tabbar to new window. The argument &quot;aTab&quot; is </span>
<a href="#l3.73"></a><span id="l3.73" class="difflineplus">+    -     required and can be a tab index, a tab info object or a tabs's </span>
<a href="#l3.74"></a><span id="l3.74" class="difflineplus">+    -     DOM element. Calling this method works only for tabs implementing</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineplus">+    -     session restore.</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineplus">+    - * moveTabTo(aTab,aIndex):</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineplus">+    -     moves the given tab to the given Index. The first argument can be</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineplus">+    -     a tab index, a tab info object or a tab's DOM element. The second</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineplus">+    -     argument specifies the tabs new absolute position within the tabbar.</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineplus">+    - </span>
<a href="#l3.81"></a><span id="l3.81">     - Less-friendly consumer methods:</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineminus">-    - * removeCurrentTab(): Close the current tab.</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineminus">-    - * removeTabByNode(aTabElement): Close the tab whose tabmail-tab bound</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineminus">-    -   element is passed in.</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineplus">+    - * persistTab(tab):</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineplus">+    -     serializes a tab into an object, by passing  a tab info object as </span>
<a href="#l3.87"></a><span id="l3.87" class="difflineplus">+    -     argument. It is used for session restore and moving tabs between </span>
<a href="#l3.88"></a><span id="l3.88" class="difflineplus">+    -     windows. Returns null in case persist failes.</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineplus">+    - * removeCurrentTab():</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineplus">+    -     Close the current tab.</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineplus">+    - * removeTabByNode(aTabElement):</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineplus">+    -     Close the tab whose tabmail-tab bound element is passed in.</span>
<a href="#l3.93"></a><span id="l3.93">     - Changing the currently displayed tab is accomplished by changing</span>
<a href="#l3.94"></a><span id="l3.94">     -  tabmail.tabContainer's selectedIndex or selectedItem property.</span>
<a href="#l3.95"></a><span id="l3.95">     -</span>
<a href="#l3.96"></a><span id="l3.96">     - Code that lives in a tab should use the following methods:</span>
<a href="#l3.97"></a><span id="l3.97">     - * setTabTitle([aOptionalTabInfo]): Tells us that the title of the current</span>
<a href="#l3.98"></a><span id="l3.98">     -   tab (if no argument is provided) or provided tab needs to be updated.</span>
<a href="#l3.99"></a><span id="l3.99">     -   This will result in a call to the tab mode's logic to update the title.</span>
<a href="#l3.100"></a><span id="l3.100">     -   In the event this is not for the current tab, the caller is responsible</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineat">@@ -270,38 +292,52 @@</span>
<a href="#l3.102"></a><span id="l3.102">     &lt;resources&gt;</span>
<a href="#l3.103"></a><span id="l3.103">       &lt;stylesheet src=&quot;chrome://messenger/content/tabmail.css&quot;/&gt;</span>
<a href="#l3.104"></a><span id="l3.104">       &lt;stylesheet src=&quot;chrome://messenger/skin/tabmail.css&quot;/&gt;</span>
<a href="#l3.105"></a><span id="l3.105">     &lt;/resources&gt;</span>
<a href="#l3.106"></a><span id="l3.106">     &lt;content&gt;</span>
<a href="#l3.107"></a><span id="l3.107">       &lt;xul:tabbox anonid=&quot;tabbox&quot; flex=&quot;1&quot; eventnode=&quot;document&quot; xbl:inherits=&quot;handleCtrlPageUpDown&quot;</span>
<a href="#l3.108"></a><span id="l3.108">                   onselect=&quot;if (!('updateCurrentTab' in this.parentNode) || event.target.localName != 'tabs')</span>
<a href="#l3.109"></a><span id="l3.109">                             return; this.parentNode.updateCurrentTab();&quot;&gt;</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineminus">-        &lt;xul:hbox class=&quot;tab-drop-indicator-bar&quot; collapsed=&quot;true&quot;&gt;</span>
<a href="#l3.111"></a><span id="l3.111" class="difflineminus">-          &lt;xul:hbox class=&quot;tab-drop-indicator&quot; mousethrough=&quot;always&quot;/&gt;</span>
<a href="#l3.112"></a><span id="l3.112" class="difflineminus">-        &lt;/xul:hbox&gt;</span>
<a href="#l3.113"></a><span id="l3.113" class="difflineplus">+        &lt;xul:hbox align=&quot;start&quot;&gt;</span>
<a href="#l3.114"></a><span id="l3.114" class="difflineplus">+          &lt;xul:image class=&quot;tab-drop-indicator&quot; anonid=&quot;tab-drop-indicator&quot; collapsed=&quot;true&quot;/&gt;</span>
<a href="#l3.115"></a><span id="l3.115" class="difflineplus">+        &lt;/xul:hbox&gt;        </span>
<a href="#l3.116"></a><span id="l3.116" class="difflineplus">+        </span>
<a href="#l3.117"></a><span id="l3.117">         &lt;xul:hbox class=&quot;tabmail-strip&quot; collapsed=&quot;false&quot; tooltip=&quot;_child&quot; context=&quot;_child&quot;</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineminus">-                  anonid=&quot;strip&quot;</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineminus">-                  ondraggesture=&quot;nsDragAndDrop.startDrag(event, this.parentNode.parentNode); event.stopPropagation();&quot;</span>
<a href="#l3.120"></a><span id="l3.120" class="difflineminus">-                  ondragover=&quot;nsDragAndDrop.dragOver(event, this.parentNode.parentNode); event.stopPropagation();&quot;</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineminus">-                  ondragdrop=&quot;nsDragAndDrop.drop(event, this.parentNode.parentNode); event.stopPropagation();&quot;</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineminus">-                  ondragexit=&quot;nsDragAndDrop.dragExit(event, this.parentNode.parentNode); event.stopPropagation();&quot;&gt;</span>
<a href="#l3.123"></a><span id="l3.123" class="difflineplus">+                  anonid=&quot;strip&quot;&gt;</span>
<a href="#l3.124"></a><span id="l3.124">           &lt;xul:tooltip onpopupshowing=&quot;return CreateToolbarTooltip(document, event);&quot;/&gt;</span>
<a href="#l3.125"></a><span id="l3.125">           &lt;xul:menupopup anonid=&quot;tabContextMenu&quot;</span>
<a href="#l3.126"></a><span id="l3.126">                 onpopupshowing=&quot;</span>
<a href="#l3.127"></a><span id="l3.127" class="difflineminus">-                  var tabmail = this.parentNode.parentNode.parentNode;</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineplus">+                  var tabmail = document.getElementById('tabmail');</span>
<a href="#l3.129"></a><span id="l3.129">                   return tabmail.onTabContextMenuShowing(document.popupNode);&quot;&gt;</span>
<a href="#l3.130"></a><span id="l3.130" class="difflineminus">-            &lt;xul:menuitem label=&quot;&amp;closeTabCmd.label;&quot; accesskey=&quot;&amp;closeTabCmd.accesskey;&quot;</span>
<a href="#l3.131"></a><span id="l3.131" class="difflineplus">+            </span>
<a href="#l3.132"></a><span id="l3.132" class="difflineplus">+            &lt;xul:menuitem label=&quot;&amp;moveToNewWindow.label;&quot; </span>
<a href="#l3.133"></a><span id="l3.133" class="difflineplus">+                          accesskey=&quot;&amp;moveToNewWindow.accesskey;&quot;</span>
<a href="#l3.134"></a><span id="l3.134" class="difflineplus">+                          anonid=&quot;openTabInWindow&quot;</span>
<a href="#l3.135"></a><span id="l3.135" class="difflineplus">+                          oncommand=&quot;document.getElementById('tabmail').replaceTabWithWindow(document.popupNode);&quot;/&gt;</span>
<a href="#l3.136"></a><span id="l3.136" class="difflineplus">+                                     </span>
<a href="#l3.137"></a><span id="l3.137" class="difflineplus">+            &lt;xul:menuseparator /&gt;</span>
<a href="#l3.138"></a><span id="l3.138" class="difflineplus">+            </span>
<a href="#l3.139"></a><span id="l3.139" class="difflineplus">+            &lt;xul:menuitem label=&quot;&amp;closeOtherTabsCmd2.label;&quot; </span>
<a href="#l3.140"></a><span id="l3.140" class="difflineplus">+                          accesskey=&quot;&amp;closeOtherTabsCmd2.accesskey;&quot;</span>
<a href="#l3.141"></a><span id="l3.141" class="difflineplus">+                          anonid=&quot;closeOtherTabs&quot;</span>
<a href="#l3.142"></a><span id="l3.142" class="difflineplus">+                          oncommand=&quot;document.getElementById('tabmail').closeOtherTabs(document.popupNode);&quot;/&gt;</span>
<a href="#l3.143"></a><span id="l3.143" class="difflineplus">+                                                 </span>
<a href="#l3.144"></a><span id="l3.144" class="difflineplus">+            &lt;xul:menuseparator /&gt;</span>
<a href="#l3.145"></a><span id="l3.145" class="difflineplus">+            </span>
<a href="#l3.146"></a><span id="l3.146" class="difflineplus">+            &lt;xul:menuitem label=&quot;&amp;undoCloseTabCmd.label;&quot;</span>
<a href="#l3.147"></a><span id="l3.147" class="difflineplus">+                          accesskey=&quot;&amp;undoCloseTabCmd.accesskey;&quot;</span>
<a href="#l3.148"></a><span id="l3.148" class="difflineplus">+                          anonid=&quot;undoCloseTab&quot;</span>
<a href="#l3.149"></a><span id="l3.149" class="difflineplus">+                          oncommand=&quot;document.getElementById('tabmail').undoCloseTab();&quot;/&gt;</span>
<a href="#l3.150"></a><span id="l3.150" class="difflineplus">+                                                                         </span>
<a href="#l3.151"></a><span id="l3.151" class="difflineplus">+            &lt;xul:menuitem label=&quot;&amp;closeTabCmd2.label;&quot; </span>
<a href="#l3.152"></a><span id="l3.152" class="difflineplus">+                          accesskey=&quot;&amp;closeTabCmd2.accesskey;&quot;</span>
<a href="#l3.153"></a><span id="l3.153">                           anonid=&quot;closeTab&quot;</span>
<a href="#l3.154"></a><span id="l3.154" class="difflineminus">-                          oncommand=&quot;var tabmail = this.parentNode.parentNode.parentNode.parentNode;</span>
<a href="#l3.155"></a><span id="l3.155" class="difflineminus">-                                     tabmail.removeTabByNode(document.popupNode);&quot;/&gt;</span>
<a href="#l3.156"></a><span id="l3.156" class="difflineminus">-            &lt;xul:menuitem label=&quot;&amp;closeOtherTabsCmd.label;&quot; accesskey=&quot;&amp;closeOtherTabsCmd.accesskey;&quot;</span>
<a href="#l3.157"></a><span id="l3.157" class="difflineminus">-                          anonid=&quot;closeOtherTabs&quot;</span>
<a href="#l3.158"></a><span id="l3.158" class="difflineminus">-                          oncommand=&quot;var tabmail = this.parentNode.parentNode.parentNode.parentNode;</span>
<a href="#l3.159"></a><span id="l3.159" class="difflineminus">-                                     tabmail.closeOtherTabs(document.popupNode);&quot;/&gt;</span>
<a href="#l3.160"></a><span id="l3.160" class="difflineplus">+                          oncommand=&quot;document.getElementById('tabmail').closeTab(document.popupNode);&quot;/&gt;</span>
<a href="#l3.161"></a><span id="l3.161" class="difflineplus">+                                                                          </span>
<a href="#l3.162"></a><span id="l3.162">           &lt;/xul:menupopup&gt;</span>
<a href="#l3.163"></a><span id="l3.163">           &lt;xul:tabs class=&quot;tabmail-tabs&quot; flex=&quot;1&quot;</span>
<a href="#l3.164"></a><span id="l3.164">                     anonid=&quot;tabcontainer&quot;</span>
<a href="#l3.165"></a><span id="l3.165">                     setfocus=&quot;false&quot;</span>
<a href="#l3.166"></a><span id="l3.166">                     onclick=&quot;this.parentNode.parentNode.parentNode.onTabClick(event);&quot;&gt;</span>
<a href="#l3.167"></a><span id="l3.167">             &lt;xul:tab selected=&quot;true&quot; validate=&quot;never&quot; type=&quot;folder&quot;</span>
<a href="#l3.168"></a><span id="l3.168">                      maxwidth=&quot;250&quot; width=&quot;0&quot; minwidth=&quot;100&quot; flex=&quot;100&quot;</span>
<a href="#l3.169"></a><span id="l3.169">                      class=&quot;tabmail-tab&quot; crop=&quot;end&quot;/&gt;</span>
<a href="#l3.170"></a><span id="l3.170" class="difflineat">@@ -312,16 +348,17 @@</span>
<a href="#l3.171"></a><span id="l3.171">         &lt;children includes=&quot;tabpanels&quot;/&gt;</span>
<a href="#l3.172"></a><span id="l3.172">       &lt;/xul:tabbox&gt;</span>
<a href="#l3.173"></a><span id="l3.173">     &lt;/content&gt;</span>
<a href="#l3.174"></a><span id="l3.174"> </span>
<a href="#l3.175"></a><span id="l3.175">     &lt;implementation implements=&quot;nsIController&quot;&gt;</span>
<a href="#l3.176"></a><span id="l3.176">       &lt;constructor&gt;</span>
<a href="#l3.177"></a><span id="l3.177">         window.controllers.insertControllerAt(0, this);</span>
<a href="#l3.178"></a><span id="l3.178">         this._restoringTabState = null;</span>
<a href="#l3.179"></a><span id="l3.179" class="difflineplus">+        this._tabUndo = [];</span>
<a href="#l3.180"></a><span id="l3.180">       &lt;/constructor&gt;</span>
<a href="#l3.181"></a><span id="l3.181">       &lt;destructor&gt;</span>
<a href="#l3.182"></a><span id="l3.182">         window.controllers.removeController(this);</span>
<a href="#l3.183"></a><span id="l3.183">       &lt;/destructor&gt;</span>
<a href="#l3.184"></a><span id="l3.184">       &lt;field name=&quot;currentTabInfo&quot;&gt;</span>
<a href="#l3.185"></a><span id="l3.185">         null</span>
<a href="#l3.186"></a><span id="l3.186">       &lt;/field&gt;</span>
<a href="#l3.187"></a><span id="l3.187">       &lt;!-- Temporary field that only has a non-null value during a call to</span>
<a href="#l3.188"></a><span id="l3.188" class="difflineat">@@ -634,30 +671,62 @@</span>
<a href="#l3.189"></a><span id="l3.189">           if (tabToConsider &amp;&amp; tabToConsider.mode == aTabMode)</span>
<a href="#l3.190"></a><span id="l3.190">             return tabToConsider;</span>
<a href="#l3.191"></a><span id="l3.191">           else if (aTabMode.tabs.length)</span>
<a href="#l3.192"></a><span id="l3.192">             return aTabMode.tabs[0];</span>
<a href="#l3.193"></a><span id="l3.193">           else</span>
<a href="#l3.194"></a><span id="l3.194">             return null;</span>
<a href="#l3.195"></a><span id="l3.195">         ]]&gt;&lt;/body&gt;</span>
<a href="#l3.196"></a><span id="l3.196">       &lt;/method&gt;</span>
<a href="#l3.197"></a><span id="l3.197" class="difflineplus">+      &lt;method name=&quot;undoCloseTab&quot;&gt;</span>
<a href="#l3.198"></a><span id="l3.198" class="difflineplus">+        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l3.199"></a><span id="l3.199" class="difflineplus">+          let history = this._tabUndo.pop();</span>
<a href="#l3.200"></a><span id="l3.200" class="difflineplus">+          </span>
<a href="#l3.201"></a><span id="l3.201" class="difflineplus">+          if (!history.tab)</span>
<a href="#l3.202"></a><span id="l3.202" class="difflineplus">+            return;</span>
<a href="#l3.203"></a><span id="l3.203" class="difflineplus">+</span>
<a href="#l3.204"></a><span id="l3.204" class="difflineplus">+          if (!this.restoreTab(JSON.parse(history.tab)))</span>
<a href="#l3.205"></a><span id="l3.205" class="difflineplus">+            return;</span>
<a href="#l3.206"></a><span id="l3.206" class="difflineplus">+          </span>
<a href="#l3.207"></a><span id="l3.207" class="difflineplus">+          let idx = Math.min(history.idx,this.tabInfo.length);          </span>
<a href="#l3.208"></a><span id="l3.208" class="difflineplus">+          let tab = this.tabContainer.childNodes[this.tabInfo.length - 1];</span>
<a href="#l3.209"></a><span id="l3.209" class="difflineplus">+          this.moveTabTo(tab, idx);</span>
<a href="#l3.210"></a><span id="l3.210" class="difflineplus">+          </span>
<a href="#l3.211"></a><span id="l3.211" class="difflineplus">+          this.switchToTab(tab);</span>
<a href="#l3.212"></a><span id="l3.212" class="difflineplus">+          </span>
<a href="#l3.213"></a><span id="l3.213" class="difflineplus">+        ]]&gt;&lt;/body&gt;</span>
<a href="#l3.214"></a><span id="l3.214" class="difflineplus">+      &lt;/method&gt;</span>
<a href="#l3.215"></a><span id="l3.215">       &lt;method name=&quot;closeTab&quot;&gt;</span>
<a href="#l3.216"></a><span id="l3.216">         &lt;parameter name=&quot;aOptTabIndexNodeOrInfo&quot;/&gt;</span>
<a href="#l3.217"></a><span id="l3.217" class="difflineminus">-        &lt;body&gt;</span>
<a href="#l3.218"></a><span id="l3.218" class="difflineminus">-          &lt;![CDATA[</span>
<a href="#l3.219"></a><span id="l3.219" class="difflineplus">+        &lt;parameter name=&quot;aNoUndo&quot; /&gt;</span>
<a href="#l3.220"></a><span id="l3.220" class="difflineplus">+        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l3.221"></a><span id="l3.221" class="difflineplus">+        </span>
<a href="#l3.222"></a><span id="l3.222">             let [iTab, tab, tabNode] =</span>
<a href="#l3.223"></a><span id="l3.223">               this._getTabContextForTabbyThing(aOptTabIndexNodeOrInfo, true);</span>
<a href="#l3.224"></a><span id="l3.224"> </span>
<a href="#l3.225"></a><span id="l3.225">             if (!tab.canClose)</span>
<a href="#l3.226"></a><span id="l3.226">               return;</span>
<a href="#l3.227"></a><span id="l3.227"> </span>
<a href="#l3.228"></a><span id="l3.228">             for each (let [i, tabMonitor] in Iterator(this.tabMonitors)) {</span>
<a href="#l3.229"></a><span id="l3.229">               if (&quot;onTabClosing&quot; in tabMonitor)</span>
<a href="#l3.230"></a><span id="l3.230">                 tabMonitor.onTabClosing(tab);</span>
<a href="#l3.231"></a><span id="l3.231">             }</span>
<a href="#l3.232"></a><span id="l3.232" class="difflineplus">+</span>
<a href="#l3.233"></a><span id="l3.233" class="difflineplus">+            if (!aNoUndo) {</span>
<a href="#l3.234"></a><span id="l3.234" class="difflineplus">+              // Allow user to undo accidentially closed tabs</span>
<a href="#l3.235"></a><span id="l3.235" class="difflineplus">+              let session = this.persistTab(tab);</span>
<a href="#l3.236"></a><span id="l3.236" class="difflineplus">+</span>
<a href="#l3.237"></a><span id="l3.237" class="difflineplus">+              if (session) {</span>
<a href="#l3.238"></a><span id="l3.238" class="difflineplus">+                this._tabUndo.push(</span>
<a href="#l3.239"></a><span id="l3.239" class="difflineplus">+                    { tab: JSON.stringify(session), idx: iTab } );</span>
<a href="#l3.240"></a><span id="l3.240" class="difflineplus">+</span>
<a href="#l3.241"></a><span id="l3.241" class="difflineplus">+                if (this._tabUndo.length &gt; 10)</span>
<a href="#l3.242"></a><span id="l3.242" class="difflineplus">+                  this._tabUndo.shift();    </span>
<a href="#l3.243"></a><span id="l3.243" class="difflineplus">+              }</span>
<a href="#l3.244"></a><span id="l3.244" class="difflineplus">+            }</span>
<a href="#l3.245"></a><span id="l3.245">             </span>
<a href="#l3.246"></a><span id="l3.246">             let closeFunc = tab.mode.closeTab || tab.mode.tabType.closeTab;</span>
<a href="#l3.247"></a><span id="l3.247">             closeFunc.call(tab.mode.tabType, tab);</span>
<a href="#l3.248"></a><span id="l3.248">              </span>
<a href="#l3.249"></a><span id="l3.249">             this.tabInfo.splice(iTab, 1);</span>
<a href="#l3.250"></a><span id="l3.250">             tab.mode.tabs.splice(tab.mode.tabs.indexOf(tab), 1);</span>
<a href="#l3.251"></a><span id="l3.251">             this.tabContainer.removeChild(tabNode);</span>
<a href="#l3.252"></a><span id="l3.252">             if (this.tabContainer.selectedIndex == -1)</span>
<a href="#l3.253"></a><span id="l3.253" class="difflineat">@@ -704,16 +773,154 @@</span>
<a href="#l3.254"></a><span id="l3.254">             for (let i = this.tabInfo.length - 1; i &gt;= 0; i--) {</span>
<a href="#l3.255"></a><span id="l3.255">               let tab = this.tabInfo[i];</span>
<a href="#l3.256"></a><span id="l3.256">               if ((tab != thisTab) &amp;&amp; tab.canClose)</span>
<a href="#l3.257"></a><span id="l3.257">                 this.closeTab(tab);</span>
<a href="#l3.258"></a><span id="l3.258">             }</span>
<a href="#l3.259"></a><span id="l3.259">           ]]&gt;</span>
<a href="#l3.260"></a><span id="l3.260">         &lt;/body&gt;</span>
<a href="#l3.261"></a><span id="l3.261">       &lt;/method&gt;</span>
<a href="#l3.262"></a><span id="l3.262" class="difflineplus">+      &lt;method name=&quot;replaceTabWithWindow&quot;&gt;</span>
<a href="#l3.263"></a><span id="l3.263" class="difflineplus">+        &lt;parameter name=&quot;aTab&quot;/&gt;</span>
<a href="#l3.264"></a><span id="l3.264" class="difflineplus">+        &lt;body&gt;</span>
<a href="#l3.265"></a><span id="l3.265" class="difflineplus">+          &lt;![CDATA[</span>
<a href="#l3.266"></a><span id="l3.266" class="difflineplus">+            if (this.tabInfo.length &lt;= 1)</span>
<a href="#l3.267"></a><span id="l3.267" class="difflineplus">+              return null;</span>
<a href="#l3.268"></a><span id="l3.268" class="difflineplus">+</span>
<a href="#l3.269"></a><span id="l3.269" class="difflineplus">+            let tab = this._getTabContextForTabbyThing(aTab, false)[1];</span>
<a href="#l3.270"></a><span id="l3.270" class="difflineplus">+                                                         </span>
<a href="#l3.271"></a><span id="l3.271" class="difflineplus">+            if (!tab.canClose)</span>
<a href="#l3.272"></a><span id="l3.272" class="difflineplus">+              return null;</span>
<a href="#l3.273"></a><span id="l3.273" class="difflineplus">+            </span>
<a href="#l3.274"></a><span id="l3.274" class="difflineplus">+            // We use Json and session restore transfer the tab to the new window.</span>
<a href="#l3.275"></a><span id="l3.275" class="difflineplus">+            tab = this.persistTab(tab);</span>
<a href="#l3.276"></a><span id="l3.276" class="difflineplus">+            if (!tab)</span>
<a href="#l3.277"></a><span id="l3.277" class="difflineplus">+              return null;</span>
<a href="#l3.278"></a><span id="l3.278" class="difflineplus">+        </span>
<a href="#l3.279"></a><span id="l3.279" class="difflineplus">+            // Converting to JSON and back again creates clean javascript </span>
<a href="#l3.280"></a><span id="l3.280" class="difflineplus">+            // object with absolutely no references to our current window.</span>
<a href="#l3.281"></a><span id="l3.281" class="difflineplus">+            let tab = JSON.parse(JSON.stringify(tab));            </span>
<a href="#l3.282"></a><span id="l3.282" class="difflineplus">+            </span>
<a href="#l3.283"></a><span id="l3.283" class="difflineplus">+            this.closeTab(aTab,true);</span>
<a href="#l3.284"></a><span id="l3.284" class="difflineplus">+                      </span>
<a href="#l3.285"></a><span id="l3.285" class="difflineplus">+            return window.openDialog(&quot;chrome://messenger/content/&quot;, &quot;_blank&quot;,</span>
<a href="#l3.286"></a><span id="l3.286" class="difflineplus">+               &quot;chrome,dialog=no,all&quot;, null,  </span>
<a href="#l3.287"></a><span id="l3.287" class="difflineplus">+               { action : &quot;restore&quot;, tabs: [tab] } ).focus();</span>
<a href="#l3.288"></a><span id="l3.288" class="difflineplus">+          ]]&gt;</span>
<a href="#l3.289"></a><span id="l3.289" class="difflineplus">+        &lt;/body&gt;</span>
<a href="#l3.290"></a><span id="l3.290" class="difflineplus">+      &lt;/method&gt;      </span>
<a href="#l3.291"></a><span id="l3.291" class="difflineplus">+      &lt;method name=&quot;moveTabTo&quot;&gt;</span>
<a href="#l3.292"></a><span id="l3.292" class="difflineplus">+        &lt;parameter name=&quot;aTab&quot;/&gt;</span>
<a href="#l3.293"></a><span id="l3.293" class="difflineplus">+        &lt;parameter name=&quot;aIndex&quot;/&gt;</span>
<a href="#l3.294"></a><span id="l3.294" class="difflineplus">+        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l3.295"></a><span id="l3.295" class="difflineplus">+          </span>
<a href="#l3.296"></a><span id="l3.296" class="difflineplus">+          if ((!aTab) || (aTab.tagName != &quot;tab&quot;))</span>
<a href="#l3.297"></a><span id="l3.297" class="difflineplus">+            return -1;</span>
<a href="#l3.298"></a><span id="l3.298" class="difflineplus">+</span>
<a href="#l3.299"></a><span id="l3.299" class="difflineplus">+          let oldIdx = this.tabContainer.getIndexOfItem(aTab);</span>
<a href="#l3.300"></a><span id="l3.300" class="difflineplus">+          if (oldIdx &lt; 0)</span>
<a href="#l3.301"></a><span id="l3.301" class="difflineplus">+            return -1;</span>
<a href="#l3.302"></a><span id="l3.302" class="difflineplus">+          </span>
<a href="#l3.303"></a><span id="l3.303" class="difflineplus">+          if (oldIdx == aIndex)</span>
<a href="#l3.304"></a><span id="l3.304" class="difflineplus">+            return -1;</span>
<a href="#l3.305"></a><span id="l3.305" class="difflineplus">+            </span>
<a href="#l3.306"></a><span id="l3.306" class="difflineplus">+          // Cache the old tabInfo</span>
<a href="#l3.307"></a><span id="l3.307" class="difflineplus">+          let tab = this.tabInfo[oldIdx];          </span>
<a href="#l3.308"></a><span id="l3.308" class="difflineplus">+          </span>
<a href="#l3.309"></a><span id="l3.309" class="difflineplus">+          if (!tab)</span>
<a href="#l3.310"></a><span id="l3.310" class="difflineplus">+            return -1;</span>
<a href="#l3.311"></a><span id="l3.311" class="difflineplus">+                     </span>
<a href="#l3.312"></a><span id="l3.312" class="difflineplus">+          // remove the entries form tabInfo, tabMode and tabStrip</span>
<a href="#l3.313"></a><span id="l3.313" class="difflineplus">+          this.tabInfo.splice(oldIdx, 1);</span>
<a href="#l3.314"></a><span id="l3.314" class="difflineplus">+          tab.mode.tabs.splice(tab.mode.tabs.indexOf(tab), 1);</span>
<a href="#l3.315"></a><span id="l3.315" class="difflineplus">+          this.tabContainer.removeChild(aTab);</span>
<a href="#l3.316"></a><span id="l3.316" class="difflineplus">+          </span>
<a href="#l3.317"></a><span id="l3.317" class="difflineplus">+</span>
<a href="#l3.318"></a><span id="l3.318" class="difflineplus">+          // as we removed items, we might need to update indices</span>
<a href="#l3.319"></a><span id="l3.319" class="difflineplus">+          if (oldIdx &lt; aIndex)</span>
<a href="#l3.320"></a><span id="l3.320" class="difflineplus">+            aIndex --;</span>
<a href="#l3.321"></a><span id="l3.321" class="difflineplus">+                       </span>
<a href="#l3.322"></a><span id="l3.322" class="difflineplus">+          // Read it into tabInfo and tabStrip.</span>
<a href="#l3.323"></a><span id="l3.323" class="difflineplus">+          this.tabInfo.splice(aIndex, 0, tab);</span>
<a href="#l3.324"></a><span id="l3.324" class="difflineplus">+          this.tabContainer.insertBefore(aTab, this.tabContainer.childNodes[aIndex]);</span>
<a href="#l3.325"></a><span id="l3.325" class="difflineplus">+          </span>
<a href="#l3.326"></a><span id="l3.326" class="difflineplus">+          // Now it's getting a bit ugly, as tabModes stores redundant</span>
<a href="#l3.327"></a><span id="l3.327" class="difflineplus">+          // information we need to get it in sync with tabInfo.</span>
<a href="#l3.328"></a><span id="l3.328" class="difflineplus">+          //              </span>
<a href="#l3.329"></a><span id="l3.329" class="difflineplus">+          // As tabModes.tabs is a subset of tabInfo, every tab can be mapped </span>
<a href="#l3.330"></a><span id="l3.330" class="difflineplus">+          // to a tabInfo index. So we check for each tab in tabModes if it is </span>
<a href="#l3.331"></a><span id="l3.331" class="difflineplus">+          // directly in front of our moved tab. We do this by looking up the </span>
<a href="#l3.332"></a><span id="l3.332" class="difflineplus">+          // index in tabInfo and compare it with the moved tab's index. If we</span>
<a href="#l3.333"></a><span id="l3.333" class="difflineplus">+          // found our tab, we insert the moved tab directly behind into tabModes</span>
<a href="#l3.334"></a><span id="l3.334" class="difflineplus">+          </span>
<a href="#l3.335"></a><span id="l3.335" class="difflineplus">+          // In case find no tab we simply append it </span>
<a href="#l3.336"></a><span id="l3.336" class="difflineplus">+          let modeIdx = tab.mode.tabs.length+1;</span>
<a href="#l3.337"></a><span id="l3.337" class="difflineplus">+          </span>
<a href="#l3.338"></a><span id="l3.338" class="difflineplus">+          for (let i = 0; i &lt; tab.mode.tabs.length; i++) {</span>
<a href="#l3.339"></a><span id="l3.339" class="difflineplus">+                    </span>
<a href="#l3.340"></a><span id="l3.340" class="difflineplus">+            if (this.tabInfo.indexOf(tab.mode.tabs[i]) &lt; aIndex)</span>
<a href="#l3.341"></a><span id="l3.341" class="difflineplus">+              continue;</span>
<a href="#l3.342"></a><span id="l3.342" class="difflineplus">+              </span>
<a href="#l3.343"></a><span id="l3.343" class="difflineplus">+            modeIdx = i;</span>
<a href="#l3.344"></a><span id="l3.344" class="difflineplus">+            break;</span>
<a href="#l3.345"></a><span id="l3.345" class="difflineplus">+          }</span>
<a href="#l3.346"></a><span id="l3.346" class="difflineplus">+                            </span>
<a href="#l3.347"></a><span id="l3.347" class="difflineplus">+          tab.mode.tabs.splice(modeIdx, 0, tab);          </span>
<a href="#l3.348"></a><span id="l3.348" class="difflineplus">+          </span>
<a href="#l3.349"></a><span id="l3.349" class="difflineplus">+          return aIndex;</span>
<a href="#l3.350"></a><span id="l3.350" class="difflineplus">+         ]]&gt;</span>
<a href="#l3.351"></a><span id="l3.351" class="difflineplus">+         &lt;/body&gt;</span>
<a href="#l3.352"></a><span id="l3.352" class="difflineplus">+       &lt;/method&gt;</span>
<a href="#l3.353"></a><span id="l3.353" class="difflineplus">+       &lt;method name=&quot;persistTab&quot;&gt;</span>
<a href="#l3.354"></a><span id="l3.354" class="difflineplus">+         &lt;parameter name=&quot;tab&quot;/&gt;        </span>
<a href="#l3.355"></a><span id="l3.355" class="difflineplus">+         &lt;body&gt;&lt;![CDATA[              </span>
<a href="#l3.356"></a><span id="l3.356" class="difflineplus">+           /* Returns null in case persist fails */</span>
<a href="#l3.357"></a><span id="l3.357" class="difflineplus">+           </span>
<a href="#l3.358"></a><span id="l3.358" class="difflineplus">+           let persistFunc = tab.mode.persistTab || tab.mode.tabType.persistTab;</span>
<a href="#l3.359"></a><span id="l3.359" class="difflineplus">+        </span>
<a href="#l3.360"></a><span id="l3.360" class="difflineplus">+           // if we can't restore the tab we can't move it</span>
<a href="#l3.361"></a><span id="l3.361" class="difflineplus">+           if (!persistFunc)</span>
<a href="#l3.362"></a><span id="l3.362" class="difflineplus">+             return null; </span>
<a href="#l3.363"></a><span id="l3.363" class="difflineplus">+                 </span>
<a href="#l3.364"></a><span id="l3.364" class="difflineplus">+           //  If there is a non-null tab-state, then persisting succeeded and</span>
<a href="#l3.365"></a><span id="l3.365" class="difflineplus">+           //  we should store it.  We store the tab's persisted state in its</span>
<a href="#l3.366"></a><span id="l3.366" class="difflineplus">+           //  own distinct object rather than mixing things up in a dictionary</span>
<a href="#l3.367"></a><span id="l3.367" class="difflineplus">+           //  to avoid bugs and because we may eventually let extensions store</span>
<a href="#l3.368"></a><span id="l3.368" class="difflineplus">+           //  per-tab information in the persisted state.</span>
<a href="#l3.369"></a><span id="l3.369" class="difflineplus">+           </span>
<a href="#l3.370"></a><span id="l3.370" class="difflineplus">+           let tabState;</span>
<a href="#l3.371"></a><span id="l3.371" class="difflineplus">+           // Wrap this in an exception handler so that if the persistence</span>
<a href="#l3.372"></a><span id="l3.372" class="difflineplus">+           // logic fails, things like tab closure still run to completion.</span>
<a href="#l3.373"></a><span id="l3.373" class="difflineplus">+           try {</span>
<a href="#l3.374"></a><span id="l3.374" class="difflineplus">+             tabState = persistFunc.call(tab.mode.tabType, tab);</span>
<a href="#l3.375"></a><span id="l3.375" class="difflineplus">+           }</span>
<a href="#l3.376"></a><span id="l3.376" class="difflineplus">+           catch(ex) {</span>
<a href="#l3.377"></a><span id="l3.377" class="difflineplus">+             // Report this so that our unit testing framework sees this</span>
<a href="#l3.378"></a><span id="l3.378" class="difflineplus">+             // error and (extension) developers likewise can see when their</span>
<a href="#l3.379"></a><span id="l3.379" class="difflineplus">+             // extensions are ill-behaved.</span>
<a href="#l3.380"></a><span id="l3.380" class="difflineplus">+             Components.utils.reportError(ex);</span>
<a href="#l3.381"></a><span id="l3.381" class="difflineplus">+           }</span>
<a href="#l3.382"></a><span id="l3.382" class="difflineplus">+</span>
<a href="#l3.383"></a><span id="l3.383" class="difflineplus">+           if (!tabState)</span>
<a href="#l3.384"></a><span id="l3.384" class="difflineplus">+             return null;</span>
<a href="#l3.385"></a><span id="l3.385" class="difflineplus">+             </span>
<a href="#l3.386"></a><span id="l3.386" class="difflineplus">+           let ext = {};</span>
<a href="#l3.387"></a><span id="l3.387" class="difflineplus">+</span>
<a href="#l3.388"></a><span id="l3.388" class="difflineplus">+           for each (let [i, tabMonitor] in Iterator(this.tabMonitors)) {</span>
<a href="#l3.389"></a><span id="l3.389" class="difflineplus">+             if (&quot;onTabPersist&quot; in tabMonitor) {</span>
<a href="#l3.390"></a><span id="l3.390" class="difflineplus">+               let monState = tabMonitor.onTabPersist(tab);</span>
<a href="#l3.391"></a><span id="l3.391" class="difflineplus">+               if (monState !== null)</span>
<a href="#l3.392"></a><span id="l3.392" class="difflineplus">+                 ext[tabMonitor.monitorName] = monState;</span>
<a href="#l3.393"></a><span id="l3.393" class="difflineplus">+             }</span>
<a href="#l3.394"></a><span id="l3.394" class="difflineplus">+           }</span>
<a href="#l3.395"></a><span id="l3.395" class="difflineplus">+           </span>
<a href="#l3.396"></a><span id="l3.396" class="difflineplus">+           return {mode: tab.mode.name, state: tabState, ext: ext}           </span>
<a href="#l3.397"></a><span id="l3.397" class="difflineplus">+        ]]&gt;&lt;/body&gt;</span>
<a href="#l3.398"></a><span id="l3.398" class="difflineplus">+      &lt;/method&gt;</span>
<a href="#l3.399"></a><span id="l3.399" class="difflineplus">+      </span>
<a href="#l3.400"></a><span id="l3.400">       &lt;method name=&quot;persistTabs&quot;&gt;</span>
<a href="#l3.401"></a><span id="l3.401">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l3.402"></a><span id="l3.402">           /**</span>
<a href="#l3.403"></a><span id="l3.403">            * Persist the state of all tab modes implementing persistTab methods</span>
<a href="#l3.404"></a><span id="l3.404">            *  to a JSON-serializable object representation and return it.  Call</span>
<a href="#l3.405"></a><span id="l3.405">            *  restoreTabs with the result to restore the tab state.</span>
<a href="#l3.406"></a><span id="l3.406">            * Calling this method should have no side effects; tabs will not be</span>
<a href="#l3.407"></a><span id="l3.407">            *  closed, displays will not change, etc.  This means the method is</span>
<a href="#l3.408"></a><span id="l3.408" class="difflineat">@@ -723,94 +930,88 @@</span>
<a href="#l3.409"></a><span id="l3.409">            * @return {Object} The persisted tab states.</span>
<a href="#l3.410"></a><span id="l3.410">            */</span>
<a href="#l3.411"></a><span id="l3.411">           let state = {</span>
<a href="#l3.412"></a><span id="l3.412">             // Explicitly specify a revision so we don't wish we had later.</span>
<a href="#l3.413"></a><span id="l3.413">             rev: 0,</span>
<a href="#l3.414"></a><span id="l3.414">             // If our currently selected tab gets persisted, we will update this</span>
<a href="#l3.415"></a><span id="l3.415">             selectedIndex: null,</span>
<a href="#l3.416"></a><span id="l3.416">           };</span>
<a href="#l3.417"></a><span id="l3.417" class="difflineplus">+          </span>
<a href="#l3.418"></a><span id="l3.418">           let tabs = state.tabs = [];</span>
<a href="#l3.419"></a><span id="l3.419"> </span>
<a href="#l3.420"></a><span id="l3.420">           for each (let [iTab, tab] in Iterator(this.tabInfo)) {</span>
<a href="#l3.421"></a><span id="l3.421" class="difflineminus">-            let persistFunc = tab.mode.persistTab ||</span>
<a href="#l3.422"></a><span id="l3.422" class="difflineminus">-                              tab.mode.tabType.persistTab;</span>
<a href="#l3.423"></a><span id="l3.423" class="difflineminus">-            if (!persistFunc)</span>
<a href="#l3.424"></a><span id="l3.424" class="difflineplus">+          </span>
<a href="#l3.425"></a><span id="l3.425" class="difflineplus">+            let persistTab = this.persistTab(tab);</span>
<a href="#l3.426"></a><span id="l3.426" class="difflineplus">+            </span>
<a href="#l3.427"></a><span id="l3.427" class="difflineplus">+            if (!persistTab)</span>
<a href="#l3.428"></a><span id="l3.428">               continue;</span>
<a href="#l3.429"></a><span id="l3.429" class="difflineminus">-            let tabState = persistFunc.call(tab.mode.tabType, tab);</span>
<a href="#l3.430"></a><span id="l3.430" class="difflineminus">-            // If there is a non-null tab-state, then persisting succeeded and</span>
<a href="#l3.431"></a><span id="l3.431" class="difflineminus">-            //  we should store it.  We store the tab's persisted state in its</span>
<a href="#l3.432"></a><span id="l3.432" class="difflineminus">-            //  own distinct object rather than mixing things up in a dictionary</span>
<a href="#l3.433"></a><span id="l3.433" class="difflineminus">-            //  to avoid bugs and because we may eventually let extensions store</span>
<a href="#l3.434"></a><span id="l3.434" class="difflineminus">-            //  per-tab information in the persisted state.</span>
<a href="#l3.435"></a><span id="l3.435" class="difflineminus">-            if (tabState != null) {</span>
<a href="#l3.436"></a><span id="l3.436" class="difflineminus">-              let ext = {};</span>
<a href="#l3.437"></a><span id="l3.437" class="difflineminus">-</span>
<a href="#l3.438"></a><span id="l3.438" class="difflineminus">-              for each (let [i, tabMonitor] in Iterator(this.tabMonitors)) {</span>
<a href="#l3.439"></a><span id="l3.439" class="difflineminus">-                if (&quot;onTabPersist&quot; in tabMonitor) {</span>
<a href="#l3.440"></a><span id="l3.440" class="difflineminus">-                  let monState = tabMonitor.onTabPersist(tab);</span>
<a href="#l3.441"></a><span id="l3.441" class="difflineminus">-                  if (monState !== null)</span>
<a href="#l3.442"></a><span id="l3.442" class="difflineminus">-                    ext[tabMonitor.monitorName] = monState;</span>
<a href="#l3.443"></a><span id="l3.443" class="difflineminus">-                }</span>
<a href="#l3.444"></a><span id="l3.444" class="difflineminus">-              }</span>
<a href="#l3.445"></a><span id="l3.445" class="difflineminus">-</span>
<a href="#l3.446"></a><span id="l3.446" class="difflineminus">-              tabs.push({</span>
<a href="#l3.447"></a><span id="l3.447" class="difflineminus">-                mode: tab.mode.name,</span>
<a href="#l3.448"></a><span id="l3.448" class="difflineminus">-                state: tabState,</span>
<a href="#l3.449"></a><span id="l3.449" class="difflineminus">-                ext: ext,</span>
<a href="#l3.450"></a><span id="l3.450" class="difflineminus">-              });</span>
<a href="#l3.451"></a><span id="l3.451" class="difflineminus">-              // Mark this persisted tab as selected</span>
<a href="#l3.452"></a><span id="l3.452" class="difflineminus">-              if (iTab == this.tabContainer.selectedIndex)</span>
<a href="#l3.453"></a><span id="l3.453" class="difflineminus">-                state.selectedIndex = tabs.length - 1;</span>
<a href="#l3.454"></a><span id="l3.454" class="difflineminus">-            }</span>
<a href="#l3.455"></a><span id="l3.455" class="difflineplus">+            </span>
<a href="#l3.456"></a><span id="l3.456" class="difflineplus">+            tabs.push(persistTab);</span>
<a href="#l3.457"></a><span id="l3.457" class="difflineplus">+            </span>
<a href="#l3.458"></a><span id="l3.458" class="difflineplus">+            // Mark this persisted tab as selected</span>
<a href="#l3.459"></a><span id="l3.459" class="difflineplus">+            if (iTab == this.tabContainer.selectedIndex)</span>
<a href="#l3.460"></a><span id="l3.460" class="difflineplus">+              state.selectedIndex = tabs.length - 1;</span>
<a href="#l3.461"></a><span id="l3.461">           }</span>
<a href="#l3.462"></a><span id="l3.462"> </span>
<a href="#l3.463"></a><span id="l3.463">           return state;</span>
<a href="#l3.464"></a><span id="l3.464">         ]]&gt;&lt;/body&gt;</span>
<a href="#l3.465"></a><span id="l3.465" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l3.466"></a><span id="l3.466" class="difflineplus">+      &lt;/method&gt;      </span>
<a href="#l3.467"></a><span id="l3.467" class="difflineplus">+      &lt;method name=&quot;restoreTab&quot;&gt;</span>
<a href="#l3.468"></a><span id="l3.468" class="difflineplus">+        &lt;parameter name=&quot;aState&quot;/&gt;</span>
<a href="#l3.469"></a><span id="l3.469" class="difflineplus">+        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l3.470"></a><span id="l3.470" class="difflineplus">+                    </span>
<a href="#l3.471"></a><span id="l3.471" class="difflineplus">+          // if we no longer know about the mode, we can't restore the tab        </span>
<a href="#l3.472"></a><span id="l3.472" class="difflineplus">+          let mode = this.tabModes[aState.mode];        </span>
<a href="#l3.473"></a><span id="l3.473" class="difflineplus">+          if (!mode)</span>
<a href="#l3.474"></a><span id="l3.474" class="difflineplus">+            return false;</span>
<a href="#l3.475"></a><span id="l3.475" class="difflineplus">+          </span>
<a href="#l3.476"></a><span id="l3.476" class="difflineplus">+          let restoreFunc = mode.restoreTab || mode.tabType.restoreTab;</span>
<a href="#l3.477"></a><span id="l3.477" class="difflineplus">+        </span>
<a href="#l3.478"></a><span id="l3.478" class="difflineplus">+          if (!restoreFunc)</span>
<a href="#l3.479"></a><span id="l3.479" class="difflineplus">+            return false;</span>
<a href="#l3.480"></a><span id="l3.480" class="difflineplus">+            </span>
<a href="#l3.481"></a><span id="l3.481" class="difflineplus">+          // normalize the state to have an ext attribute if it does not.</span>
<a href="#l3.482"></a><span id="l3.482" class="difflineplus">+          if (!(&quot;ext&quot; in aState))</span>
<a href="#l3.483"></a><span id="l3.483" class="difflineplus">+            aState.ext = {};</span>
<a href="#l3.484"></a><span id="l3.484" class="difflineplus">+            </span>
<a href="#l3.485"></a><span id="l3.485" class="difflineplus">+          this._restoringTabState = aState;  </span>
<a href="#l3.486"></a><span id="l3.486" class="difflineplus">+          restoreFunc.call(mode.tabType, this, aState.state);</span>
<a href="#l3.487"></a><span id="l3.487" class="difflineplus">+          this._restoringTabState = null;</span>
<a href="#l3.488"></a><span id="l3.488" class="difflineplus">+          </span>
<a href="#l3.489"></a><span id="l3.489" class="difflineplus">+          return true;</span>
<a href="#l3.490"></a><span id="l3.490" class="difflineplus">+          </span>
<a href="#l3.491"></a><span id="l3.491" class="difflineplus">+        ]]&gt;&lt;/body&gt;</span>
<a href="#l3.492"></a><span id="l3.492" class="difflineplus">+      &lt;/method&gt;          </span>
<a href="#l3.493"></a><span id="l3.493">       &lt;method name=&quot;restoreTabs&quot;&gt;</span>
<a href="#l3.494"></a><span id="l3.494">         &lt;parameter name=&quot;aPersistedState&quot;/&gt;</span>
<a href="#l3.495"></a><span id="l3.495">         &lt;parameter name=&quot;aDontRestoreFirstTab&quot;/&gt;</span>
<a href="#l3.496"></a><span id="l3.496">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l3.497"></a><span id="l3.497">           /**</span>
<a href="#l3.498"></a><span id="l3.498">            * Attempts to restore tabs persisted from a prior call to</span>
<a href="#l3.499"></a><span id="l3.499">            *  |persistTabs|.  This is currently a synchronous operation, but in</span>
<a href="#l3.500"></a><span id="l3.500">            *  the future this may kick off an asynchronous mechanism to restore</span>
<a href="#l3.501"></a><span id="l3.501">            *  the tabs one-by-one.</span>
<a href="#l3.502"></a><span id="l3.502">            */</span>
<a href="#l3.503"></a><span id="l3.503">           let tabs = aPersistedState.tabs;</span>
<a href="#l3.504"></a><span id="l3.504">           let indexToSelect = null;</span>
<a href="#l3.505"></a><span id="l3.505">           for each (let [iTab, tabState] in Iterator(tabs)) {</span>
<a href="#l3.506"></a><span id="l3.506" class="difflineminus">-            // if we no longer know about the mode, we can't restore the tab</span>
<a href="#l3.507"></a><span id="l3.507" class="difflineminus">-            if (!(tabState.mode in this.tabModes))</span>
<a href="#l3.508"></a><span id="l3.508" class="difflineminus">-              continue;</span>
<a href="#l3.509"></a><span id="l3.509" class="difflineminus">-</span>
<a href="#l3.510"></a><span id="l3.510" class="difflineminus">-            let mode = this.tabModes[tabState.mode];</span>
<a href="#l3.511"></a><span id="l3.511" class="difflineminus">-            let restoreFunc = mode.restoreTab || mode.tabType.restoreTab;</span>
<a href="#l3.512"></a><span id="l3.512" class="difflineminus">-            if (!restoreFunc)</span>
<a href="#l3.513"></a><span id="l3.513" class="difflineminus">-              continue;</span>
<a href="#l3.514"></a><span id="l3.514" class="difflineminus">-</span>
<a href="#l3.515"></a><span id="l3.515" class="difflineminus">-            // The first tab is a folder tab (we know that from our</span>
<a href="#l3.516"></a><span id="l3.516" class="difflineminus">-            // implementation). Tell the folder tab to back off if necessary.</span>
<a href="#l3.517"></a><span id="l3.517" class="difflineminus">-            // XXX find a better way to do this.</span>
<a href="#l3.518"></a><span id="l3.518" class="difflineplus">+          </span>
<a href="#l3.519"></a><span id="l3.519">             if (tabState.state.firstTab &amp;&amp; aDontRestoreFirstTab)</span>
<a href="#l3.520"></a><span id="l3.520">               tabState.state.dontRestoreFirstTab = aDontRestoreFirstTab;</span>
<a href="#l3.521"></a><span id="l3.521" class="difflineminus">-</span>
<a href="#l3.522"></a><span id="l3.522" class="difflineminus">-            // normalize the state to have an ext attribute if it does not.</span>
<a href="#l3.523"></a><span id="l3.523" class="difflineminus">-            if (!(&quot;ext&quot; in tabState))</span>
<a href="#l3.524"></a><span id="l3.524" class="difflineminus">-              tabState.ext = {};</span>
<a href="#l3.525"></a><span id="l3.525" class="difflineminus">-            this._restoringTabState = tabState;</span>
<a href="#l3.526"></a><span id="l3.526" class="difflineminus">-            restoreFunc.call(mode.tabType, this, tabState.state);</span>
<a href="#l3.527"></a><span id="l3.527" class="difflineminus">-            this._restoringTabState = null;</span>
<a href="#l3.528"></a><span id="l3.528" class="difflineplus">+          </span>
<a href="#l3.529"></a><span id="l3.529" class="difflineplus">+            if (!this.restoreTab(tabState))</span>
<a href="#l3.530"></a><span id="l3.530" class="difflineplus">+              continue;</span>
<a href="#l3.531"></a><span id="l3.531"> </span>
<a href="#l3.532"></a><span id="l3.532">             // If this persisted tab was the selected one, then mark the newest</span>
<a href="#l3.533"></a><span id="l3.533">             //  tab as the guy to select.</span>
<a href="#l3.534"></a><span id="l3.534">             if (iTab == aPersistedState.selectedIndex)</span>
<a href="#l3.535"></a><span id="l3.535">               indexToSelect = this.tabInfo.length - 1;</span>
<a href="#l3.536"></a><span id="l3.536">           }</span>
<a href="#l3.537"></a><span id="l3.537" class="difflineplus">+          </span>
<a href="#l3.538"></a><span id="l3.538">           if (indexToSelect != null &amp;&amp; !aDontRestoreFirstTab)</span>
<a href="#l3.539"></a><span id="l3.539">             this.tabContainer.selectedIndex = indexToSelect;</span>
<a href="#l3.540"></a><span id="l3.540">           else</span>
<a href="#l3.541"></a><span id="l3.541">             this.tabContainer.selectedIndex = 0;</span>
<a href="#l3.542"></a><span id="l3.542">         ]]&gt;&lt;/body&gt;</span>
<a href="#l3.543"></a><span id="l3.543">       &lt;/method&gt;</span>
<a href="#l3.544"></a><span id="l3.544"> </span>
<a href="#l3.545"></a><span id="l3.545">       &lt;!-- Called when the window is being unloaded, this calls the close</span>
<a href="#l3.546"></a><span id="l3.546" class="difflineat">@@ -1091,31 +1292,54 @@</span>
<a href="#l3.547"></a><span id="l3.547">         &lt;parameter name=&quot;aTabNode&quot;/&gt;</span>
<a href="#l3.548"></a><span id="l3.548">         &lt;body&gt;</span>
<a href="#l3.549"></a><span id="l3.549">           &lt;![CDATA[</span>
<a href="#l3.550"></a><span id="l3.550">             // this happens when the user did not actually-click on a tab but</span>
<a href="#l3.551"></a><span id="l3.551">             // instead on the strip behind it.</span>
<a href="#l3.552"></a><span id="l3.552">             if (aTabNode.localName != &quot;tab&quot;)</span>
<a href="#l3.553"></a><span id="l3.553">               return false;</span>
<a href="#l3.554"></a><span id="l3.554"> </span>
<a href="#l3.555"></a><span id="l3.555" class="difflineminus">-            // If there is only one tab, then then &quot;close all tabs&quot; menu item</span>
<a href="#l3.556"></a><span id="l3.556" class="difflineminus">-            // should not be enabled</span>
<a href="#l3.557"></a><span id="l3.557" class="difflineminus">-            let otherTabs = document.getAnonymousElementByAttribute(this,</span>
<a href="#l3.558"></a><span id="l3.558" class="difflineminus">-              &quot;anonid&quot;, &quot;closeOtherTabs&quot;);</span>
<a href="#l3.559"></a><span id="l3.559" class="difflineminus">-            otherTabs.setAttribute(&quot;disabled&quot;,</span>
<a href="#l3.560"></a><span id="l3.560" class="difflineminus">-              (this.tabContainer.childNodes.length == 1) ? &quot;true&quot; : &quot;false&quot;)</span>
<a href="#l3.561"></a><span id="l3.561" class="difflineplus">+            let tab = this._getTabContextForTabbyThing(aTabNode, true) [1];</span>
<a href="#l3.562"></a><span id="l3.562" class="difflineplus">+             </span>
<a href="#l3.563"></a><span id="l3.563" class="difflineplus">+            // by default &quot;close other tabs&quot; is disabled...</span>
<a href="#l3.564"></a><span id="l3.564" class="difflineplus">+            document</span>
<a href="#l3.565"></a><span id="l3.565" class="difflineplus">+              .getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;closeOtherTabs&quot;)</span>
<a href="#l3.566"></a><span id="l3.566" class="difflineplus">+              .setAttribute(&quot;disabled&quot;,&quot;true&quot;)</span>
<a href="#l3.567"></a><span id="l3.567" class="difflineplus">+                          </span>
<a href="#l3.568"></a><span id="l3.568" class="difflineplus">+            // ... except if we find at least one other tab that can be closed.</span>
<a href="#l3.569"></a><span id="l3.569" class="difflineplus">+            for (let i = 0; i &lt; this.tabInfo.length; i++) {</span>
<a href="#l3.570"></a><span id="l3.570" class="difflineplus">+            </span>
<a href="#l3.571"></a><span id="l3.571" class="difflineplus">+              if (this.tabInfo[i].canClose &amp;&amp; this.tabInfo[i] != tab) {</span>
<a href="#l3.572"></a><span id="l3.572" class="difflineplus">+              </span>
<a href="#l3.573"></a><span id="l3.573" class="difflineplus">+                document</span>
<a href="#l3.574"></a><span id="l3.574" class="difflineplus">+                  .getAnonymousElementByAttribute(this,&quot;anonid&quot;, &quot;closeOtherTabs&quot;)</span>
<a href="#l3.575"></a><span id="l3.575" class="difflineplus">+                  .setAttribute(&quot;disabled&quot;,&quot;false&quot;)</span>
<a href="#l3.576"></a><span id="l3.576" class="difflineplus">+                  </span>
<a href="#l3.577"></a><span id="l3.577" class="difflineplus">+                break;</span>
<a href="#l3.578"></a><span id="l3.578" class="difflineplus">+              }</span>
<a href="#l3.579"></a><span id="l3.579" class="difflineplus">+            }</span>
<a href="#l3.580"></a><span id="l3.580" class="difflineplus">+            </span>
<a href="#l3.581"></a><span id="l3.581" class="difflineplus">+            document</span>
<a href="#l3.582"></a><span id="l3.582" class="difflineplus">+              .getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;closeTab&quot;)</span>
<a href="#l3.583"></a><span id="l3.583" class="difflineplus">+              .setAttribute(&quot;disabled&quot;, tab.canClose ? &quot;false&quot; : &quot;true&quot;);       </span>
<a href="#l3.584"></a><span id="l3.584" class="difflineplus">+            </span>
<a href="#l3.585"></a><span id="l3.585" class="difflineplus">+            // enable &quot;Open in new Window&quot; iff tab is closable and...</span>
<a href="#l3.586"></a><span id="l3.586" class="difflineplus">+            // ... it can persist its state. Other wise it would get destroyed...</span>
<a href="#l3.587"></a><span id="l3.587" class="difflineplus">+            // ... while moving it to a new window.</span>
<a href="#l3.588"></a><span id="l3.588" class="difflineplus">+            document</span>
<a href="#l3.589"></a><span id="l3.589" class="difflineplus">+              .getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;openTabInWindow&quot;)</span>
<a href="#l3.590"></a><span id="l3.590" class="difflineplus">+              .setAttribute(&quot;disabled&quot;, </span>
<a href="#l3.591"></a><span id="l3.591" class="difflineplus">+                  (tab.canClose &amp;&amp; this.persistTab(tab)) ? &quot;false&quot; : &quot;true&quot;)</span>
<a href="#l3.592"></a><span id="l3.592"> </span>
<a href="#l3.593"></a><span id="l3.593" class="difflineminus">-            let closeTabItem = document.getAnonymousElementByAttribute(this,</span>
<a href="#l3.594"></a><span id="l3.594" class="difflineminus">-              &quot;anonid&quot;, &quot;closeTab&quot;);</span>
<a href="#l3.595"></a><span id="l3.595" class="difflineminus">-</span>
<a href="#l3.596"></a><span id="l3.596" class="difflineminus">-            // If the tab node is not closable, the &quot;Close Tab&quot; item should not</span>
<a href="#l3.597"></a><span id="l3.597" class="difflineminus">-            // be enabled.</span>
<a href="#l3.598"></a><span id="l3.598" class="difflineminus">-            let [iTab, tab, tabNode] =</span>
<a href="#l3.599"></a><span id="l3.599" class="difflineminus">-              this._getTabContextForTabbyThing(aTabNode, true);</span>
<a href="#l3.600"></a><span id="l3.600" class="difflineminus">-            closeTabItem.setAttribute(&quot;disabled&quot;, tab.canClose ? &quot;false&quot; : &quot;true&quot;);</span>
<a href="#l3.601"></a><span id="l3.601" class="difflineplus">+            // If the tab history is empty, disable &quot;Undo Close Tab&quot;</span>
<a href="#l3.602"></a><span id="l3.602" class="difflineplus">+            document</span>
<a href="#l3.603"></a><span id="l3.603" class="difflineplus">+              .getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;undoCloseTab&quot;)</span>
<a href="#l3.604"></a><span id="l3.604" class="difflineplus">+              .setAttribute(&quot;disabled&quot;,</span>
<a href="#l3.605"></a><span id="l3.605" class="difflineplus">+                  (this._tabUndo.length) ? &quot;false&quot; : &quot;true&quot;);</span>
<a href="#l3.606"></a><span id="l3.606" class="difflineplus">+                          </span>
<a href="#l3.607"></a><span id="l3.607">             return true;</span>
<a href="#l3.608"></a><span id="l3.608">           ]]&gt;</span>
<a href="#l3.609"></a><span id="l3.609">         &lt;/body&gt;</span>
<a href="#l3.610"></a><span id="l3.610">       &lt;/method&gt;</span>
<a href="#l3.611"></a><span id="l3.611">       &lt;method name=&quot;supportsCommand&quot;&gt;</span>
<a href="#l3.612"></a><span id="l3.612">         &lt;parameter name=&quot;aCommand&quot;/&gt;</span>
<a href="#l3.613"></a><span id="l3.613">         &lt;body&gt;</span>
<a href="#l3.614"></a><span id="l3.614">           &lt;![CDATA[</span>
<a href="#l3.615"></a><span id="l3.615" class="difflineat">@@ -1510,16 +1734,26 @@</span>
<a href="#l3.616"></a><span id="l3.616">         {</span>
<a href="#l3.617"></a><span id="l3.617">           if (aIID.equals(Components.interfaces.nsIObserver) ||</span>
<a href="#l3.618"></a><span id="l3.618">               aIID.equals(Components.interfaces.nsISupports))</span>
<a href="#l3.619"></a><span id="l3.619">             return this;</span>
<a href="#l3.620"></a><span id="l3.620">           throw Components.results.NS_NOINTERFACE;</span>
<a href="#l3.621"></a><span id="l3.621">         }</span>
<a href="#l3.622"></a><span id="l3.622">         });</span>
<a href="#l3.623"></a><span id="l3.623">       &lt;/field&gt;</span>
<a href="#l3.624"></a><span id="l3.624" class="difflineplus">+      </span>
<a href="#l3.625"></a><span id="l3.625" class="difflineplus">+      &lt;field name=&quot;_tabDropIndicator&quot;&gt;</span>
<a href="#l3.626"></a><span id="l3.626" class="difflineplus">+        document.getAnonymousElementByAttribute(</span>
<a href="#l3.627"></a><span id="l3.627" class="difflineplus">+            this.parentNode.parentNode.parentNode, </span>
<a href="#l3.628"></a><span id="l3.628" class="difflineplus">+            &quot;anonid&quot;, &quot;tab-drop-indicator&quot;);</span>
<a href="#l3.629"></a><span id="l3.629" class="difflineplus">+      &lt;/field&gt;</span>
<a href="#l3.630"></a><span id="l3.630" class="difflineplus">+      </span>
<a href="#l3.631"></a><span id="l3.631" class="difflineplus">+      &lt;field name=&quot;_dragOverDelay&quot;&gt;350&lt;/field&gt;</span>
<a href="#l3.632"></a><span id="l3.632" class="difflineplus">+      &lt;field name=&quot;_dragTime&quot;&gt;0&lt;/field&gt;</span>
<a href="#l3.633"></a><span id="l3.633" class="difflineplus">+      </span>
<a href="#l3.634"></a><span id="l3.634">       &lt;field name=&quot;mTabMinWidth&quot;&gt;100&lt;/field&gt;</span>
<a href="#l3.635"></a><span id="l3.635">       &lt;field name=&quot;mTabMaxWidth&quot;&gt;250&lt;/field&gt;</span>
<a href="#l3.636"></a><span id="l3.636">       &lt;field name=&quot;mTabClipWidth&quot;&gt;140&lt;/field&gt;</span>
<a href="#l3.637"></a><span id="l3.637">       &lt;field name=&quot;mCloseButtons&quot;&gt;1&lt;/field&gt;</span>
<a href="#l3.638"></a><span id="l3.638"> </span>
<a href="#l3.639"></a><span id="l3.639">       &lt;field name=&quot;_mAutoHide&quot;&gt;false&lt;/field&gt;</span>
<a href="#l3.640"></a><span id="l3.640">       &lt;property name=&quot;mAutoHide&quot; onget=&quot;return this._mAutoHide;&quot;&gt;</span>
<a href="#l3.641"></a><span id="l3.641">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l3.642"></a><span id="l3.642" class="difflineat">@@ -1693,28 +1927,372 @@</span>
<a href="#l3.643"></a><span id="l3.643">           this.mDownBoxAnimate.style.opacity = percent;</span>
<a href="#l3.644"></a><span id="l3.644"> </span>
<a href="#l3.645"></a><span id="l3.645">           if (this._animateStep &lt; (this._animatePercents.length - 1))</span>
<a href="#l3.646"></a><span id="l3.646">             this._animateStep++;</span>
<a href="#l3.647"></a><span id="l3.647">           else</span>
<a href="#l3.648"></a><span id="l3.648">             this._stopAnimation();</span>
<a href="#l3.649"></a><span id="l3.649">         ]]&gt;&lt;/body&gt;</span>
<a href="#l3.650"></a><span id="l3.650">       &lt;/method&gt;</span>
<a href="#l3.651"></a><span id="l3.651" class="difflineplus">+      </span>
<a href="#l3.652"></a><span id="l3.652" class="difflineplus">+      &lt;method name=&quot;_getDragTargetTab&quot;&gt;</span>
<a href="#l3.653"></a><span id="l3.653" class="difflineplus">+        &lt;parameter name=&quot;event&quot;/&gt;</span>
<a href="#l3.654"></a><span id="l3.654" class="difflineplus">+        &lt;body&gt;&lt;![CDATA[     </span>
<a href="#l3.655"></a><span id="l3.655" class="difflineplus">+                                   </span>
<a href="#l3.656"></a><span id="l3.656" class="difflineplus">+          if (event.target.localName != &quot;tab&quot;)</span>
<a href="#l3.657"></a><span id="l3.657" class="difflineplus">+            return null;</span>
<a href="#l3.658"></a><span id="l3.658" class="difflineplus">+                      </span>
<a href="#l3.659"></a><span id="l3.659" class="difflineplus">+          let tab = event.target;</span>
<a href="#l3.660"></a><span id="l3.660" class="difflineplus">+          </span>
<a href="#l3.661"></a><span id="l3.661" class="difflineplus">+          if ((event.type != &quot;drop&quot;) &amp;&amp; (event.type != &quot;dragover&quot;)) </span>
<a href="#l3.662"></a><span id="l3.662" class="difflineplus">+            return tab;</span>
<a href="#l3.663"></a><span id="l3.663" class="difflineplus">+            </span>
<a href="#l3.664"></a><span id="l3.664" class="difflineplus">+          let boxObject = tab.boxObject;</span>
<a href="#l3.665"></a><span id="l3.665" class="difflineplus">+          </span>
<a href="#l3.666"></a><span id="l3.666" class="difflineplus">+          if (event.screenX &lt; boxObject.screenX + boxObject.width * .25)</span>
<a href="#l3.667"></a><span id="l3.667" class="difflineplus">+            return null</span>
<a href="#l3.668"></a><span id="l3.668" class="difflineplus">+          </span>
<a href="#l3.669"></a><span id="l3.669" class="difflineplus">+          if (event.screenX &gt; boxObject.screenX + boxObject.width * .75)</span>
<a href="#l3.670"></a><span id="l3.670" class="difflineplus">+            return null;</span>
<a href="#l3.671"></a><span id="l3.671" class="difflineplus">+           </span>
<a href="#l3.672"></a><span id="l3.672" class="difflineplus">+          return tab; </span>
<a href="#l3.673"></a><span id="l3.673" class="difflineplus">+        ]]&gt;&lt;/body&gt;</span>
<a href="#l3.674"></a><span id="l3.674" class="difflineplus">+      &lt;/method&gt;</span>
<a href="#l3.675"></a><span id="l3.675" class="difflineplus">+    </span>
<a href="#l3.676"></a><span id="l3.676" class="difflineplus">+      </span>
<a href="#l3.677"></a><span id="l3.677" class="difflineplus">+      &lt;method name=&quot;_getDropIndex&quot;&gt;</span>
<a href="#l3.678"></a><span id="l3.678" class="difflineplus">+        &lt;parameter name=&quot;event&quot;/&gt;</span>
<a href="#l3.679"></a><span id="l3.679" class="difflineplus">+        &lt;body&gt;&lt;![CDATA[        </span>
<a href="#l3.680"></a><span id="l3.680" class="difflineplus">+          let tabs = this.childNodes;                   </span>
<a href="#l3.681"></a><span id="l3.681" class="difflineplus">+            </span>
<a href="#l3.682"></a><span id="l3.682" class="difflineplus">+          if (window.getComputedStyle(this, null).direction == &quot;ltr&quot;) {                      </span>
<a href="#l3.683"></a><span id="l3.683" class="difflineplus">+            for (let i = 0; i &lt; tabs.length; i++)              </span>
<a href="#l3.684"></a><span id="l3.684" class="difflineplus">+              if (event.screenX &lt; (tabs[i].boxObject.screenX + (tabs[i].boxObject.width / 2)))</span>
<a href="#l3.685"></a><span id="l3.685" class="difflineplus">+                return i;</span>
<a href="#l3.686"></a><span id="l3.686" class="difflineplus">+          }</span>
<a href="#l3.687"></a><span id="l3.687" class="difflineplus">+          else  {</span>
<a href="#l3.688"></a><span id="l3.688" class="difflineplus">+            for (let i = 0; i &lt; tabs.length; i++)</span>
<a href="#l3.689"></a><span id="l3.689" class="difflineplus">+              if (event.screenX &gt; (tabs[i].boxObject.screenX + (tabs[i].boxObject.width / 2)))</span>
<a href="#l3.690"></a><span id="l3.690" class="difflineplus">+                return i;         </span>
<a href="#l3.691"></a><span id="l3.691" class="difflineplus">+          }          </span>
<a href="#l3.692"></a><span id="l3.692" class="difflineplus">+         </span>
<a href="#l3.693"></a><span id="l3.693" class="difflineplus">+           return tabs.length;           </span>
<a href="#l3.694"></a><span id="l3.694" class="difflineplus">+        ]]&gt;&lt;/body&gt;</span>
<a href="#l3.695"></a><span id="l3.695" class="difflineplus">+      &lt;/method&gt;        </span>
<a href="#l3.696"></a><span id="l3.696">     &lt;/implementation&gt;</span>
<a href="#l3.697"></a><span id="l3.697">     &lt;handlers&gt;</span>
<a href="#l3.698"></a><span id="l3.698">       &lt;handler event=&quot;TabSelect&quot; action=&quot;this._handleTabSelect();&quot;/&gt;</span>
<a href="#l3.699"></a><span id="l3.699">       &lt;handler event=&quot;mouseover&quot;&gt;&lt;![CDATA[</span>
<a href="#l3.700"></a><span id="l3.700">         if (event.originalTarget == this.mAllTabsButton) {</span>
<a href="#l3.701"></a><span id="l3.701">           this.mAllTabsButton</span>
<a href="#l3.702"></a><span id="l3.702">               .setAttribute(&quot;tooltiptext&quot;,</span>
<a href="#l3.703"></a><span id="l3.703">                             this.mAllTabsButton.getAttribute(&quot;tooltipstring&quot;));</span>
<a href="#l3.704"></a><span id="l3.704">         }</span>
<a href="#l3.705"></a><span id="l3.705">         else</span>
<a href="#l3.706"></a><span id="l3.706">           this.mAllTabsButton.removeAttribute(&quot;tooltiptext&quot;);</span>
<a href="#l3.707"></a><span id="l3.707">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l3.708"></a><span id="l3.708" class="difflineplus">+      &lt;handler event=&quot;dragstart&quot;&gt;&lt;![CDATA[          </span>
<a href="#l3.709"></a><span id="l3.709" class="difflineplus">+        let draggedTab = this._getDragTargetTab(event);</span>
<a href="#l3.710"></a><span id="l3.710" class="difflineplus">+        </span>
<a href="#l3.711"></a><span id="l3.711" class="difflineplus">+        if (!draggedTab)</span>
<a href="#l3.712"></a><span id="l3.712" class="difflineplus">+          return;  </span>
<a href="#l3.713"></a><span id="l3.713" class="difflineplus">+</span>
<a href="#l3.714"></a><span id="l3.714" class="difflineplus">+        let tabmail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l3.715"></a><span id="l3.715" class="difflineplus">+        let tab = tabmail.selectedTab;</span>
<a href="#l3.716"></a><span id="l3.716" class="difflineplus">+        </span>
<a href="#l3.717"></a><span id="l3.717" class="difflineplus">+        if (!tab || !tab.canClose)</span>
<a href="#l3.718"></a><span id="l3.718" class="difflineplus">+          return;</span>
<a href="#l3.719"></a><span id="l3.719" class="difflineplus">+                                          </span>
<a href="#l3.720"></a><span id="l3.720" class="difflineplus">+        let dt = event.dataTransfer;</span>
<a href="#l3.721"></a><span id="l3.721" class="difflineplus">+        </span>
<a href="#l3.722"></a><span id="l3.722" class="difflineplus">+        // If we drag within the same window, we use the tab directly</span>
<a href="#l3.723"></a><span id="l3.723" class="difflineplus">+        dt.mozSetDataAt(&quot;application/x-moz-tabmail-tab&quot;, draggedTab, 0);</span>
<a href="#l3.724"></a><span id="l3.724" class="difflineplus">+        </span>
<a href="#l3.725"></a><span id="l3.725" class="difflineplus">+        // otherwise we use session restore &amp; JSON to migrate the tab.        </span>
<a href="#l3.726"></a><span id="l3.726" class="difflineplus">+        let uri = tabmail.persistTab(tab);</span>
<a href="#l3.727"></a><span id="l3.727" class="difflineplus">+        </span>
<a href="#l3.728"></a><span id="l3.728" class="difflineplus">+        // In case the tab implements session restore, we use JSON to convert</span>
<a href="#l3.729"></a><span id="l3.729" class="difflineplus">+        // it into a string</span>
<a href="#l3.730"></a><span id="l3.730" class="difflineplus">+        // </span>
<a href="#l3.731"></a><span id="l3.731" class="difflineplus">+        // If a tab does not support session restore it retuns null. We can't </span>
<a href="#l3.732"></a><span id="l3.732" class="difflineplus">+        // moved such tabs to a new window. However moving them within the same</span>
<a href="#l3.733"></a><span id="l3.733" class="difflineplus">+        // window works perfectly fine</span>
<a href="#l3.734"></a><span id="l3.734" class="difflineplus">+        </span>
<a href="#l3.735"></a><span id="l3.735" class="difflineplus">+        if (uri)</span>
<a href="#l3.736"></a><span id="l3.736" class="difflineplus">+          uri = JSON.stringify(uri);</span>
<a href="#l3.737"></a><span id="l3.737" class="difflineplus">+        </span>
<a href="#l3.738"></a><span id="l3.738" class="difflineplus">+        dt.mozSetDataAt(&quot;application/x-moz-tabmail-json&quot;, uri, 0);</span>
<a href="#l3.739"></a><span id="l3.739" class="difflineplus">+</span>
<a href="#l3.740"></a><span id="l3.740" class="difflineplus">+        dt.mozCursor = &quot;default&quot;;</span>
<a href="#l3.741"></a><span id="l3.741" class="difflineplus">+            </span>
<a href="#l3.742"></a><span id="l3.742" class="difflineplus">+        // Create Drag Image</span>
<a href="#l3.743"></a><span id="l3.743" class="difflineplus">+        let panel = document.getElementById(&quot;tabpanelcontainer&quot;);</span>
<a href="#l3.744"></a><span id="l3.744" class="difflineplus">+        </span>
<a href="#l3.745"></a><span id="l3.745" class="difflineplus">+        let thumbnail = document.createElementNS(&quot;http://www.w3.org/1999/xhtml&quot;, &quot;canvas&quot;); </span>
<a href="#l3.746"></a><span id="l3.746" class="difflineplus">+        thumbnail.width = Math.ceil(screen.availWidth / 5.75);</span>
<a href="#l3.747"></a><span id="l3.747" class="difflineplus">+        thumbnail.height = Math.round(width * 0.5625);</span>
<a href="#l3.748"></a><span id="l3.748" class="difflineplus">+        </span>
<a href="#l3.749"></a><span id="l3.749" class="difflineplus">+        let snippetWidth = panel.boxObject.width * .6;</span>
<a href="#l3.750"></a><span id="l3.750" class="difflineplus">+        let scale = thumbnail.width / snippetWidth;</span>
<a href="#l3.751"></a><span id="l3.751" class="difflineplus">+</span>
<a href="#l3.752"></a><span id="l3.752" class="difflineplus">+        let ctx = thumbnail.getContext(&quot;2d&quot;);</span>
<a href="#l3.753"></a><span id="l3.753" class="difflineplus">+    </span>
<a href="#l3.754"></a><span id="l3.754" class="difflineplus">+        ctx.scale(scale, scale);</span>
<a href="#l3.755"></a><span id="l3.755" class="difflineplus">+          </span>
<a href="#l3.756"></a><span id="l3.756" class="difflineplus">+        ctx.drawWindow(window,</span>
<a href="#l3.757"></a><span id="l3.757" class="difflineplus">+                panel.boxObject.screenX - window.mozInnerScreenX,</span>
<a href="#l3.758"></a><span id="l3.758" class="difflineplus">+                panel.boxObject.screenY - window.mozInnerScreenY, </span>
<a href="#l3.759"></a><span id="l3.759" class="difflineplus">+                snippetWidth,</span>
<a href="#l3.760"></a><span id="l3.760" class="difflineplus">+                snippetWidth * 0.5625,</span>
<a href="#l3.761"></a><span id="l3.761" class="difflineplus">+                &quot;rgb(255,255,255)&quot;); </span>
<a href="#l3.762"></a><span id="l3.762" class="difflineplus">+</span>
<a href="#l3.763"></a><span id="l3.763" class="difflineplus">+        var dt = event.dataTransfer;</span>
<a href="#l3.764"></a><span id="l3.764" class="difflineplus">+        dt.setDragImage(thumbnail, 0, 0);        </span>
<a href="#l3.765"></a><span id="l3.765" class="difflineplus">+                </span>
<a href="#l3.766"></a><span id="l3.766" class="difflineplus">+        event.stopPropagation();        </span>
<a href="#l3.767"></a><span id="l3.767" class="difflineplus">+      ]]&gt;&lt;/handler&gt;</span>
<a href="#l3.768"></a><span id="l3.768" class="difflineplus">+      &lt;handler event=&quot;dragover&quot;&gt;&lt;![CDATA[</span>
<a href="#l3.769"></a><span id="l3.769" class="difflineplus">+        let dt = event.dataTransfer;</span>
<a href="#l3.770"></a><span id="l3.770" class="difflineplus">+        </span>
<a href="#l3.771"></a><span id="l3.771" class="difflineplus">+        if (dt.mozItemCount == 0)</span>
<a href="#l3.772"></a><span id="l3.772" class="difflineplus">+          return;</span>
<a href="#l3.773"></a><span id="l3.773" class="difflineplus">+                </span>
<a href="#l3.774"></a><span id="l3.774" class="difflineplus">+        // Bug 516247:</span>
<a href="#l3.775"></a><span id="l3.775" class="difflineplus">+        // incase the user is dragging something else than a tab, and</span>
<a href="#l3.776"></a><span id="l3.776" class="difflineplus">+        // keeps hovering over a tab, we assume he wants to switch to this tab. </span>
<a href="#l3.777"></a><span id="l3.777" class="difflineplus">+        </span>
<a href="#l3.778"></a><span id="l3.778" class="difflineplus">+        if ((dt.mozTypesAt(0)[0] != &quot;application/x-moz-tabmail-tab&quot;)</span>
<a href="#l3.779"></a><span id="l3.779" class="difflineplus">+            &amp;&amp; (dt.mozTypesAt(0)[1] != &quot;application/x-moz-tabmail-json&quot;))  {</span>
<a href="#l3.780"></a><span id="l3.780" class="difflineplus">+          </span>
<a href="#l3.781"></a><span id="l3.781" class="difflineplus">+          let tab = this._getDragTargetTab(event); </span>
<a href="#l3.782"></a><span id="l3.782" class="difflineplus">+         </span>
<a href="#l3.783"></a><span id="l3.783" class="difflineplus">+          if (!tab)</span>
<a href="#l3.784"></a><span id="l3.784" class="difflineplus">+            return;</span>
<a href="#l3.785"></a><span id="l3.785" class="difflineplus">+          </span>
<a href="#l3.786"></a><span id="l3.786" class="difflineplus">+          event.preventDefault();</span>
<a href="#l3.787"></a><span id="l3.787" class="difflineplus">+          event.stopPropagation();          </span>
<a href="#l3.788"></a><span id="l3.788" class="difflineplus">+          </span>
<a href="#l3.789"></a><span id="l3.789" class="difflineplus">+          if (!this._dragTime) {</span>
<a href="#l3.790"></a><span id="l3.790" class="difflineplus">+            this._dragTime = Date.now();</span>
<a href="#l3.791"></a><span id="l3.791" class="difflineplus">+            return;</span>
<a href="#l3.792"></a><span id="l3.792" class="difflineplus">+          }</span>
<a href="#l3.793"></a><span id="l3.793" class="difflineplus">+          </span>
<a href="#l3.794"></a><span id="l3.794" class="difflineplus">+          if (Date.now() &lt;= this._dragTime + this._dragOverDelay)</span>
<a href="#l3.795"></a><span id="l3.795" class="difflineplus">+            return;</span>
<a href="#l3.796"></a><span id="l3.796" class="difflineplus">+          </span>
<a href="#l3.797"></a><span id="l3.797" class="difflineplus">+          let tabmail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l3.798"></a><span id="l3.798" class="difflineplus">+          </span>
<a href="#l3.799"></a><span id="l3.799" class="difflineplus">+          if (tabmail.tabContainer.selectedItem == tab)</span>
<a href="#l3.800"></a><span id="l3.800" class="difflineplus">+            return;</span>
<a href="#l3.801"></a><span id="l3.801" class="difflineplus">+             </span>
<a href="#l3.802"></a><span id="l3.802" class="difflineplus">+          tabmail.tabContainer.selectedItem = tab;         </span>
<a href="#l3.803"></a><span id="l3.803" class="difflineplus">+          </span>
<a href="#l3.804"></a><span id="l3.804" class="difflineplus">+          return;</span>
<a href="#l3.805"></a><span id="l3.805" class="difflineplus">+        }</span>
<a href="#l3.806"></a><span id="l3.806" class="difflineplus">+                            </span>
<a href="#l3.807"></a><span id="l3.807" class="difflineplus">+        // as some tabs do not support session restore they can't be </span>
<a href="#l3.808"></a><span id="l3.808" class="difflineplus">+        // moved to a different or new window. We should not show </span>
<a href="#l3.809"></a><span id="l3.809" class="difflineplus">+        // a dropmarker in such a case</span>
<a href="#l3.810"></a><span id="l3.810" class="difflineplus">+        if (!dt.mozGetDataAt(&quot;application/x-moz-tabmail-json&quot;, 0)) {</span>
<a href="#l3.811"></a><span id="l3.811" class="difflineplus">+        </span>
<a href="#l3.812"></a><span id="l3.812" class="difflineplus">+          let draggedTab = dt.mozGetDataAt(&quot;application/x-moz-tabmail-tab&quot;, 0);</span>
<a href="#l3.813"></a><span id="l3.813" class="difflineplus">+           </span>
<a href="#l3.814"></a><span id="l3.814" class="difflineplus">+          if (!draggedTab)</span>
<a href="#l3.815"></a><span id="l3.815" class="difflineplus">+            return;</span>
<a href="#l3.816"></a><span id="l3.816" class="difflineplus">+</span>
<a href="#l3.817"></a><span id="l3.817" class="difflineplus">+          let tabmail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l3.818"></a><span id="l3.818" class="difflineplus">+          </span>
<a href="#l3.819"></a><span id="l3.819" class="difflineplus">+          if (tabmail.tabContainer.getIndexOfItem(draggedTab) == -1)</span>
<a href="#l3.820"></a><span id="l3.820" class="difflineplus">+            return;</span>
<a href="#l3.821"></a><span id="l3.821" class="difflineplus">+        }</span>
<a href="#l3.822"></a><span id="l3.822" class="difflineplus">+</span>
<a href="#l3.823"></a><span id="l3.823" class="difflineplus">+        dt.effectAllowed = &quot;copyMove&quot;;</span>
<a href="#l3.824"></a><span id="l3.824" class="difflineplus">+</span>
<a href="#l3.825"></a><span id="l3.825" class="difflineplus">+        event.preventDefault();</span>
<a href="#l3.826"></a><span id="l3.826" class="difflineplus">+        event.stopPropagation();</span>
<a href="#l3.827"></a><span id="l3.827" class="difflineplus">+                </span>
<a href="#l3.828"></a><span id="l3.828" class="difflineplus">+        let ltr = (window.getComputedStyle(this, null).direction == &quot;ltr&quot;);        </span>
<a href="#l3.829"></a><span id="l3.829" class="difflineplus">+        let ind = this._tabDropIndicator;</span>
<a href="#l3.830"></a><span id="l3.830" class="difflineplus">+        </span>
<a href="#l3.831"></a><span id="l3.831" class="difflineplus">+        // Let's scroll</span>
<a href="#l3.832"></a><span id="l3.832" class="difflineplus">+        if (this.hasAttribute(&quot;overflow&quot;)) {</span>
<a href="#l3.833"></a><span id="l3.833" class="difflineplus">+                 </span>
<a href="#l3.834"></a><span id="l3.834" class="difflineplus">+          let target = event.originalTarget.getAttribute(&quot;anonid&quot;);</span>
<a href="#l3.835"></a><span id="l3.835" class="difflineplus">+                    </span>
<a href="#l3.836"></a><span id="l3.836" class="difflineplus">+          let pixelsToScroll = 0;</span>
<a href="#l3.837"></a><span id="l3.837" class="difflineplus">+          </span>
<a href="#l3.838"></a><span id="l3.838" class="difflineplus">+          if (target == &quot;scrollbutton-up&quot;)</span>
<a href="#l3.839"></a><span id="l3.839" class="difflineplus">+            pixelsToScroll = this.mTabstrip.scrollIncrement;</span>
<a href="#l3.840"></a><span id="l3.840" class="difflineplus">+            </span>
<a href="#l3.841"></a><span id="l3.841" class="difflineplus">+          if (target == &quot;scrollbutton-down&quot;)</span>
<a href="#l3.842"></a><span id="l3.842" class="difflineplus">+            pixelsToScroll = this.mTabstrip.scrollIncrement * -1;</span>
<a href="#l3.843"></a><span id="l3.843" class="difflineplus">+            </span>
<a href="#l3.844"></a><span id="l3.844" class="difflineplus">+          if (ltr)</span>
<a href="#l3.845"></a><span id="l3.845" class="difflineplus">+            pixelsToScroll = pixelsToScroll * -1;</span>
<a href="#l3.846"></a><span id="l3.846" class="difflineplus">+          </span>
<a href="#l3.847"></a><span id="l3.847" class="difflineplus">+          if (pixelsToScroll) {</span>
<a href="#l3.848"></a><span id="l3.848" class="difflineplus">+            // Hide Indicator while Scrolling</span>
<a href="#l3.849"></a><span id="l3.849" class="difflineplus">+            ind.collapsed = true;</span>
<a href="#l3.850"></a><span id="l3.850" class="difflineplus">+            this.mTabstrip.scrollByPixels(pixelsToScroll);            </span>
<a href="#l3.851"></a><span id="l3.851" class="difflineplus">+            return;</span>
<a href="#l3.852"></a><span id="l3.852" class="difflineplus">+          }</span>
<a href="#l3.853"></a><span id="l3.853" class="difflineplus">+        }</span>
<a href="#l3.854"></a><span id="l3.854" class="difflineplus">+                                 </span>
<a href="#l3.855"></a><span id="l3.855" class="difflineplus">+        let newIndex = this._getDropIndex(event);</span>
<a href="#l3.856"></a><span id="l3.856" class="difflineplus">+        </span>
<a href="#l3.857"></a><span id="l3.857" class="difflineplus">+        // fix the DropIndex in case it points to tab that can't be closed        </span>
<a href="#l3.858"></a><span id="l3.858" class="difflineplus">+        let tabInfo = document.getElementById(&quot;tabmail&quot;).tabInfo;</span>
<a href="#l3.859"></a><span id="l3.859" class="difflineplus">+                </span>
<a href="#l3.860"></a><span id="l3.860" class="difflineplus">+        while ((newIndex &lt; tabInfo.length) &amp;&amp; !(tabInfo[newIndex].canClose))</span>
<a href="#l3.861"></a><span id="l3.861" class="difflineplus">+          newIndex++;  </span>
<a href="#l3.862"></a><span id="l3.862" class="difflineplus">+                </span>
<a href="#l3.863"></a><span id="l3.863" class="difflineplus">+                  </span>
<a href="#l3.864"></a><span id="l3.864" class="difflineplus">+        var scrollRect = this.mTabstrip.scrollClientRect;</span>
<a href="#l3.865"></a><span id="l3.865" class="difflineplus">+        var rect = this.getBoundingClientRect();</span>
<a href="#l3.866"></a><span id="l3.866" class="difflineplus">+        var minMargin = scrollRect.left - rect.left;</span>
<a href="#l3.867"></a><span id="l3.867" class="difflineplus">+        var maxMargin = Math.min(minMargin + scrollRect.width,scrollRect.right);</span>
<a href="#l3.868"></a><span id="l3.868" class="difflineplus">+         </span>
<a href="#l3.869"></a><span id="l3.869" class="difflineplus">+        if (!ltr)</span>
<a href="#l3.870"></a><span id="l3.870" class="difflineplus">+          [minMargin, maxMargin] = [this.clientWidth - maxMargin, this.clientWidth - minMargin];</span>
<a href="#l3.871"></a><span id="l3.871" class="difflineplus">+           </span>
<a href="#l3.872"></a><span id="l3.872" class="difflineplus">+        var newMargin;</span>
<a href="#l3.873"></a><span id="l3.873" class="difflineplus">+         </span>
<a href="#l3.874"></a><span id="l3.874" class="difflineplus">+        if (newIndex == this.childNodes.length) {</span>
<a href="#l3.875"></a><span id="l3.875" class="difflineplus">+                 </span>
<a href="#l3.876"></a><span id="l3.876" class="difflineplus">+          let tabRect = this.childNodes[newIndex-1].getBoundingClientRect();</span>
<a href="#l3.877"></a><span id="l3.877" class="difflineplus">+                   </span>
<a href="#l3.878"></a><span id="l3.878" class="difflineplus">+          if (ltr)</span>
<a href="#l3.879"></a><span id="l3.879" class="difflineplus">+            newMargin = tabRect.right - rect.left;</span>
<a href="#l3.880"></a><span id="l3.880" class="difflineplus">+          else</span>
<a href="#l3.881"></a><span id="l3.881" class="difflineplus">+            newMargin = rect.right - tabRect.left;</span>
<a href="#l3.882"></a><span id="l3.882" class="difflineplus">+        }</span>
<a href="#l3.883"></a><span id="l3.883" class="difflineplus">+        else  {</span>
<a href="#l3.884"></a><span id="l3.884" class="difflineplus">+        </span>
<a href="#l3.885"></a><span id="l3.885" class="difflineplus">+          let tabRect = this.childNodes[newIndex].getBoundingClientRect();</span>
<a href="#l3.886"></a><span id="l3.886" class="difflineplus">+</span>
<a href="#l3.887"></a><span id="l3.887" class="difflineplus">+          if (ltr)</span>
<a href="#l3.888"></a><span id="l3.888" class="difflineplus">+            newMargin = tabRect.left - rect.left;</span>
<a href="#l3.889"></a><span id="l3.889" class="difflineplus">+          else</span>
<a href="#l3.890"></a><span id="l3.890" class="difflineplus">+            newMargin = rect.right - tabRect.right;</span>
<a href="#l3.891"></a><span id="l3.891" class="difflineplus">+        }</span>
<a href="#l3.892"></a><span id="l3.892" class="difflineplus">+                         </span>
<a href="#l3.893"></a><span id="l3.893" class="difflineplus">+        ind.collapsed = false;</span>
<a href="#l3.894"></a><span id="l3.894" class="difflineplus">+ </span>
<a href="#l3.895"></a><span id="l3.895" class="difflineplus">+        newMargin += ind.clientWidth / 2;</span>
<a href="#l3.896"></a><span id="l3.896" class="difflineplus">+        if (!ltr)</span>
<a href="#l3.897"></a><span id="l3.897" class="difflineplus">+          newMargin *= -1;</span>
<a href="#l3.898"></a><span id="l3.898" class="difflineplus">+ </span>
<a href="#l3.899"></a><span id="l3.899" class="difflineplus">+        ind.style.MozTransform = &quot;translate(&quot; + Math.round(newMargin) + &quot;px)&quot;;</span>
<a href="#l3.900"></a><span id="l3.900" class="difflineplus">+        ind.style.MozMarginStart = (-ind.clientWidth) + &quot;px&quot;;</span>
<a href="#l3.901"></a><span id="l3.901" class="difflineplus">+        ind.style.marginTop = (-ind.clientHeight) + &quot;px&quot;;</span>
<a href="#l3.902"></a><span id="l3.902" class="difflineplus">+      ]]&gt;&lt;/handler&gt;</span>
<a href="#l3.903"></a><span id="l3.903" class="difflineplus">+      &lt;handler event=&quot;drop&quot;&gt;&lt;![CDATA[</span>
<a href="#l3.904"></a><span id="l3.904" class="difflineplus">+        let dt = event.dataTransfer;</span>
<a href="#l3.905"></a><span id="l3.905" class="difflineplus">+    </span>
<a href="#l3.906"></a><span id="l3.906" class="difflineplus">+        if (dt.mozItemCount != 1)</span>
<a href="#l3.907"></a><span id="l3.907" class="difflineplus">+          return;</span>
<a href="#l3.908"></a><span id="l3.908" class="difflineplus">+        </span>
<a href="#l3.909"></a><span id="l3.909" class="difflineplus">+        let draggedTab = dt.mozGetDataAt(&quot;application/x-moz-tabmail-tab&quot;,0);</span>
<a href="#l3.910"></a><span id="l3.910" class="difflineplus">+        </span>
<a href="#l3.911"></a><span id="l3.911" class="difflineplus">+        if (!draggedTab)</span>
<a href="#l3.912"></a><span id="l3.912" class="difflineplus">+          return;</span>
<a href="#l3.913"></a><span id="l3.913" class="difflineplus">+        </span>
<a href="#l3.914"></a><span id="l3.914" class="difflineplus">+        event.stopPropagation();        </span>
<a href="#l3.915"></a><span id="l3.915" class="difflineplus">+        this._tabDropIndicator.collapsed = true;</span>
<a href="#l3.916"></a><span id="l3.916" class="difflineplus">+      </span>
<a href="#l3.917"></a><span id="l3.917" class="difflineplus">+        let tabmail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l3.918"></a><span id="l3.918" class="difflineplus">+        </span>
<a href="#l3.919"></a><span id="l3.919" class="difflineplus">+        // Is the tab one of our children?</span>
<a href="#l3.920"></a><span id="l3.920" class="difflineplus">+        if (tabmail.tabContainer.getIndexOfItem(draggedTab) == -1) {</span>
<a href="#l3.921"></a><span id="l3.921" class="difflineplus">+        </span>
<a href="#l3.922"></a><span id="l3.922" class="difflineplus">+          // It's a tab from an other window, so we have to trigger session</span>
<a href="#l3.923"></a><span id="l3.923" class="difflineplus">+          // restore to get our tab</span>
<a href="#l3.924"></a><span id="l3.924" class="difflineplus">+</span>
<a href="#l3.925"></a><span id="l3.925" class="difflineplus">+          let tabmail2 = draggedTab.ownerDocument.getElementById(&quot;tabmail&quot;);        </span>
<a href="#l3.926"></a><span id="l3.926" class="difflineplus">+          if (!tabmail2)</span>
<a href="#l3.927"></a><span id="l3.927" class="difflineplus">+            return;</span>
<a href="#l3.928"></a><span id="l3.928" class="difflineplus">+          </span>
<a href="#l3.929"></a><span id="l3.929" class="difflineplus">+          let draggedJson = dt.mozGetDataAt(&quot;application/x-moz-tabmail-json&quot;, 0);                        </span>
<a href="#l3.930"></a><span id="l3.930" class="difflineplus">+          if (!draggedJson)</span>
<a href="#l3.931"></a><span id="l3.931" class="difflineplus">+            return;</span>
<a href="#l3.932"></a><span id="l3.932" class="difflineplus">+        </span>
<a href="#l3.933"></a><span id="l3.933" class="difflineplus">+          draggedJson = JSON.parse(draggedJson);</span>
<a href="#l3.934"></a><span id="l3.934" class="difflineplus">+          </span>
<a href="#l3.935"></a><span id="l3.935" class="difflineplus">+          // Some tab exist only once, so we have to gamble a bit. We close </span>
<a href="#l3.936"></a><span id="l3.936" class="difflineplus">+          // the tab and try to reopen it. If something fails the tab is gone.</span>
<a href="#l3.937"></a><span id="l3.937" class="difflineplus">+ </span>
<a href="#l3.938"></a><span id="l3.938" class="difflineplus">+          tabmail2.closeTab(draggedTab,true);</span>
<a href="#l3.939"></a><span id="l3.939" class="difflineplus">+          </span>
<a href="#l3.940"></a><span id="l3.940" class="difflineplus">+          if (! tabmail.restoreTab(draggedJson))</span>
<a href="#l3.941"></a><span id="l3.941" class="difflineplus">+            return;</span>
<a href="#l3.942"></a><span id="l3.942" class="difflineplus">+                           </span>
<a href="#l3.943"></a><span id="l3.943" class="difflineplus">+          draggedTab = tabmail.tabContainer.childNodes[tabmail.tabContainer.childNodes.length-1];</span>
<a href="#l3.944"></a><span id="l3.944" class="difflineplus">+        }</span>
<a href="#l3.945"></a><span id="l3.945" class="difflineplus">+</span>
<a href="#l3.946"></a><span id="l3.946" class="difflineplus">+        let idx = this._getDropIndex(event);</span>
<a href="#l3.947"></a><span id="l3.947" class="difflineplus">+        </span>
<a href="#l3.948"></a><span id="l3.948" class="difflineplus">+        // fix the DropIndex in case it points to tab that can't be closed        </span>
<a href="#l3.949"></a><span id="l3.949" class="difflineplus">+        let tabInfo = tabmail.tabInfo;                </span>
<a href="#l3.950"></a><span id="l3.950" class="difflineplus">+        while ((idx &lt; tabInfo.length) &amp;&amp; !(tabInfo[idx].canClose))</span>
<a href="#l3.951"></a><span id="l3.951" class="difflineplus">+          idx++;  </span>
<a href="#l3.952"></a><span id="l3.952" class="difflineplus">+                            </span>
<a href="#l3.953"></a><span id="l3.953" class="difflineplus">+        tabmail.moveTabTo(draggedTab, idx);</span>
<a href="#l3.954"></a><span id="l3.954" class="difflineplus">+                  </span>
<a href="#l3.955"></a><span id="l3.955" class="difflineplus">+        tabmail.switchToTab(draggedTab);</span>
<a href="#l3.956"></a><span id="l3.956" class="difflineplus">+        tabmail.updateCurrentTab();          </span>
<a href="#l3.957"></a><span id="l3.957" class="difflineplus">+      ]]&gt;&lt;/handler&gt;</span>
<a href="#l3.958"></a><span id="l3.958" class="difflineplus">+      </span>
<a href="#l3.959"></a><span id="l3.959" class="difflineplus">+      &lt;handler event=&quot;dragend&quot;&gt;&lt;![CDATA[</span>
<a href="#l3.960"></a><span id="l3.960" class="difflineplus">+            </span>
<a href="#l3.961"></a><span id="l3.961" class="difflineplus">+        // Note: while this case is correctly handled here, this event</span>
<a href="#l3.962"></a><span id="l3.962" class="difflineplus">+        // isn't dispatched when the tab is moved within the tabstrip,</span>
<a href="#l3.963"></a><span id="l3.963" class="difflineplus">+        // see bug 460801.</span>
<a href="#l3.964"></a><span id="l3.964" class="difflineplus">+</span>
<a href="#l3.965"></a><span id="l3.965" class="difflineplus">+        // the user pressed ESC to cancel the drag, or the drag succeded</span>
<a href="#l3.966"></a><span id="l3.966" class="difflineplus">+        var dt = event.dataTransfer;</span>
<a href="#l3.967"></a><span id="l3.967" class="difflineplus">+        if ((dt.mozUserCancelled) || (dt.dropEffect != &quot;none&quot;))</span>
<a href="#l3.968"></a><span id="l3.968" class="difflineplus">+          return;</span>
<a href="#l3.969"></a><span id="l3.969" class="difflineplus">+          </span>
<a href="#l3.970"></a><span id="l3.970" class="difflineplus">+        // Disable detach within the browser toolbox</span>
<a href="#l3.971"></a><span id="l3.971" class="difflineplus">+        var eX = event.screenX;</span>
<a href="#l3.972"></a><span id="l3.972" class="difflineplus">+        var wX = window.screenX;</span>
<a href="#l3.973"></a><span id="l3.973" class="difflineplus">+        </span>
<a href="#l3.974"></a><span id="l3.974" class="difflineplus">+        // check if the drop point is horizontally within the window</span>
<a href="#l3.975"></a><span id="l3.975" class="difflineplus">+        if (eX &gt; wX &amp;&amp; eX &lt; (wX + window.outerWidth)) {</span>
<a href="#l3.976"></a><span id="l3.976" class="difflineplus">+        </span>
<a href="#l3.977"></a><span id="l3.977" class="difflineplus">+          let bo = this.mTabstrip.boxObject;</span>
<a href="#l3.978"></a><span id="l3.978" class="difflineplus">+          // also avoid detaching if the the tab was dropped too close to</span>
<a href="#l3.979"></a><span id="l3.979" class="difflineplus">+          // the tabbar (half a tab)</span>
<a href="#l3.980"></a><span id="l3.980" class="difflineplus">+          let endScreenY = bo.screenY + 1.5 * bo.height;</span>
<a href="#l3.981"></a><span id="l3.981" class="difflineplus">+          let eY = event.screenY;</span>
<a href="#l3.982"></a><span id="l3.982" class="difflineplus">+          </span>
<a href="#l3.983"></a><span id="l3.983" class="difflineplus">+          if (eY &lt; endScreenY &amp;&amp; eY &gt; window.screenY)        </span>
<a href="#l3.984"></a><span id="l3.984" class="difflineplus">+            return;</span>
<a href="#l3.985"></a><span id="l3.985" class="difflineplus">+        }</span>
<a href="#l3.986"></a><span id="l3.986" class="difflineplus">+</span>
<a href="#l3.987"></a><span id="l3.987" class="difflineplus">+        // user wants to deatach tab from window...        </span>
<a href="#l3.988"></a><span id="l3.988" class="difflineplus">+        if (dt.mozItemCount != 1)</span>
<a href="#l3.989"></a><span id="l3.989" class="difflineplus">+          return;</span>
<a href="#l3.990"></a><span id="l3.990" class="difflineplus">+        </span>
<a href="#l3.991"></a><span id="l3.991" class="difflineplus">+        let draggedTab = dt.mozGetDataAt(&quot;application/x-moz-tabmail-tab&quot;,0);</span>
<a href="#l3.992"></a><span id="l3.992" class="difflineplus">+        </span>
<a href="#l3.993"></a><span id="l3.993" class="difflineplus">+        if (!draggedTab)</span>
<a href="#l3.994"></a><span id="l3.994" class="difflineplus">+          return;</span>
<a href="#l3.995"></a><span id="l3.995" class="difflineplus">+        </span>
<a href="#l3.996"></a><span id="l3.996" class="difflineplus">+        document.getElementById(&quot;tabmail&quot;).replaceTabWithWindow(draggedTab);                    </span>
<a href="#l3.997"></a><span id="l3.997" class="difflineplus">+                            </span>
<a href="#l3.998"></a><span id="l3.998" class="difflineplus">+      ]]&gt;&lt;/handler&gt;</span>
<a href="#l3.999"></a><span id="l3.999" class="difflineplus">+      </span>
<a href="#l3.1000"></a><span id="l3.1000" class="difflineplus">+      &lt;handler event=&quot;dragexit&quot;&gt;&lt;![CDATA[</span>
<a href="#l3.1001"></a><span id="l3.1001" class="difflineplus">+        this._dragTime = 0;</span>
<a href="#l3.1002"></a><span id="l3.1002" class="difflineplus">+        </span>
<a href="#l3.1003"></a><span id="l3.1003" class="difflineplus">+        this._tabDropIndicator.collapsed = true;                </span>
<a href="#l3.1004"></a><span id="l3.1004" class="difflineplus">+        event.stopPropagation();</span>
<a href="#l3.1005"></a><span id="l3.1005" class="difflineplus">+        </span>
<a href="#l3.1006"></a><span id="l3.1006" class="difflineplus">+      ]]&gt;&lt;/handler&gt;      </span>
<a href="#l3.1007"></a><span id="l3.1007">     &lt;/handlers&gt;</span>
<a href="#l3.1008"></a><span id="l3.1008">   &lt;/binding&gt;</span>
<a href="#l3.1009"></a><span id="l3.1009">   </span>
<a href="#l3.1010"></a><span id="l3.1010">   &lt;!-- alltabs-popup binding</span>
<a href="#l3.1011"></a><span id="l3.1011">        This binding relies on the structure of the tabbrowser binding.</span>
<a href="#l3.1012"></a><span id="l3.1012">        Therefore it should only be used as a child of the tabs element.</span>
<a href="#l3.1013"></a><span id="l3.1013">        This binding is exposed as a pseudo-public-API so themes can customize</span>
<a href="#l3.1014"></a><span id="l3.1014">        the tabbar appearance without having to be scriptable</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/messenger.dtd</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/messenger.dtd</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -1,19 +1,30 @@</span>
<a href="#l4.4"></a><span id="l4.4"> &lt;!ENTITY messengerWindow.title &quot;Mail &amp;amp; Newsgroups&quot;&gt;</span>
<a href="#l4.5"></a><span id="l4.5"> &lt;!ENTITY titledefault.label    &quot;&amp;brandFullName;&quot;&gt;</span>
<a href="#l4.6"></a><span id="l4.6"> &lt;!ENTITY titleSeparator.label &quot; - &quot;&gt;</span>
<a href="#l4.7"></a><span id="l4.7"> </span>
<a href="#l4.8"></a><span id="l4.8"> &lt;!-- File Menu --&gt;</span>
<a href="#l4.9"></a><span id="l4.9"> &lt;!ENTITY newFolderCmd.label &quot;Folder…&quot;&gt;</span>
<a href="#l4.10"></a><span id="l4.10"> &lt;!ENTITY newFolderCmd.accesskey &quot;F&quot;&gt;</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineminus">-&lt;!ENTITY closeTabCmd.label &quot;Close Tab&quot;&gt;</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-&lt;!ENTITY closeTabCmd.accesskey &quot;e&quot;&gt;</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-&lt;!ENTITY closeOtherTabsCmd.label &quot;Close Other Tabs&quot;&gt;</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-&lt;!ENTITY closeOtherTabsCmd.accesskey &quot;L&quot;&gt;</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+&lt;!ENTITY closeTabCmd2.label &quot;Close Tab&quot;&gt;</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+&lt;!ENTITY closeTabCmd2.accesskey &quot;C&quot;&gt;</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+&lt;!ENTITY closeOtherTabsCmd2.label &quot;Close Other Tabs&quot;&gt;</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+&lt;!ENTITY closeOtherTabsCmd2.accesskey &quot;o&quot;&gt;</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+&lt;!-- LOCALIZATION NOTE (undoCloseTabCmd.label):</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+     Menu option to attempt to re-open a recently closed tab.</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+     --&gt;</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+&lt;!ENTITY undoCloseTabCmd.label &quot;Undo Close Tab&quot;&gt;</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+&lt;!ENTITY undoCloseTabCmd.accesskey &quot;U&quot;&gt;</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+&lt;!-- LOCALIZATION NOTE (moveToNewWindow.label):</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+     Menu option to cause the current tab to be migrated to a new Thunderbird</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineplus">+     window.</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineplus">+     --&gt;</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+&lt;!ENTITY moveToNewWindow.label &quot;Move to New Window&quot;&gt;</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+&lt;!ENTITY moveToNewWindow.accesskey &quot;W&quot;&gt;</span>
<a href="#l4.30"></a><span id="l4.30"> &lt;!ENTITY newVirtualFolderCmd.label &quot;Saved Search…&quot;&gt;</span>
<a href="#l4.31"></a><span id="l4.31"> &lt;!ENTITY newVirtualFolderCmd.accesskey &quot;S&quot;&gt;</span>
<a href="#l4.32"></a><span id="l4.32"> &lt;!ENTITY newOtherAccountsCmd.label &quot;Other Accounts…&quot;&gt;</span>
<a href="#l4.33"></a><span id="l4.33"> &lt;!ENTITY newOtherAccountsCmd.accesskey &quot;O&quot;&gt;</span>
<a href="#l4.34"></a><span id="l4.34"> &lt;!ENTITY newEmailAccountCmd.label &quot;Mail Account…&quot;&gt;</span>
<a href="#l4.35"></a><span id="l4.35"> &lt;!ENTITY newEmailAccountCmd.accesskey &quot;A&quot;&gt;</span>
<a href="#l4.36"></a><span id="l4.36"> &lt;!ENTITY openMessageFileCmd.label &quot;Open Saved Message…&quot;&gt;</span>
<a href="#l4.37"></a><span id="l4.37"> &lt;!ENTITY openMessageFileCmd.accesskey &quot;O&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/test/mozmill/mozmilltests.list</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/test/mozmill/mozmilltests.list</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -11,8 +11,9 @@ junk-commands</span>
<a href="#l5.4"></a><span id="l5.4"> message-header</span>
<a href="#l5.5"></a><span id="l5.5"> message-window</span>
<a href="#l5.6"></a><span id="l5.6"> migration</span>
<a href="#l5.7"></a><span id="l5.7"> migration-from-tb2</span>
<a href="#l5.8"></a><span id="l5.8"> pref-window</span>
<a href="#l5.9"></a><span id="l5.9"> quick-filter-bar</span>
<a href="#l5.10"></a><span id="l5.10"> search-window</span>
<a href="#l5.11"></a><span id="l5.11"> session-store</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+tabmail</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1">new file mode 100644</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineminus">--- /dev/null</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineplus">+++ b/mail/test/mozmill/tabmail/test-tabmail-dragndrop.js</span>
<a href="#l6.4"></a><span id="l6.4" class="difflineat">@@ -0,0 +1,457 @@</span>
<a href="#l6.5"></a><span id="l6.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l6.6"></a><span id="l6.6" class="difflineplus">+ *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l6.7"></a><span id="l6.7" class="difflineplus">+ *</span>
<a href="#l6.8"></a><span id="l6.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l6.9"></a><span id="l6.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l6.10"></a><span id="l6.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l6.11"></a><span id="l6.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+ *</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+ * License.</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+ *</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+ * The Original Code is Thunderbird Mail Client.</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+ *</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineplus">+ *   Thomas Schmid &lt;schmid-thomas@gmx.net&gt;</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2011</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineplus">+ *</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineplus">+ *</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineplus">+ *</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineplus">+</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineplus">+/*</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineplus">+ * Test rearanging tabs via drag'n'drop.</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineplus">+ */</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineplus">+</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineplus">+var MODULE_NAME = &quot;test-tabmail-dragndrop&quot;;</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineplus">+</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineplus">+</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineplus">+var folder;</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineplus">+let msgHdrsInFolder = [];</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineplus">+</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineplus">+// The number of messages in folder.</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineplus">+const NUM_MESSAGES_IN_FOLDER = 10;</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineplus">+</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineplus">+function setupModule(module) {</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineplus">+  let fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineplus">+  fdh.installInto(module);</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineplus">+  let wh = collector.getModule(&quot;window-helpers&quot;);</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineplus">+  wh.installInto(module);</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineplus">+</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineplus">+  folder = create_folder(&quot;MessageFolder&quot;);</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineplus">+  make_new_sets_in_folder(folder, [{count: NUM_MESSAGES_IN_FOLDER}]);</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineplus">+}</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineplus">+</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineplus">+/**</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineplus">+ * Verifies our test environment is setup correctly and initializes</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineplus">+ * all global variables.</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineplus">+ */</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineplus">+function test_tab_reorder_setup_globals() {</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineplus">+</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineplus">+  // Scroll to the top</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineplus">+  mc.folderDisplay.ensureRowIsVisible(0);</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineplus">+  let msgHdr = mc.dbView.getMsgHdrAt(1);</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineplus">+</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineplus">+  display_message_in_folder_tab(msgHdr, false);</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineplus">+</span>
<a href="#l6.79"></a><span id="l6.79" class="difflineplus">+  // Check that the right message is displayed</span>
<a href="#l6.80"></a><span id="l6.80" class="difflineplus">+  assert_number_of_tabs_open(1);</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineplus">+  assert_folder_selected_and_displayed(folder);</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineplus">+  assert_selected_and_displayed(msgHdr);</span>
<a href="#l6.83"></a><span id="l6.83" class="difflineplus">+</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineplus">+  assert_row_visible(1);</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineplus">+</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineplus">+  //Initialize the globals we'll need for all our tests.</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineplus">+</span>
<a href="#l6.88"></a><span id="l6.88" class="difflineplus">+  // Stash messages into arrays for convenience. We do it this way so that the</span>
<a href="#l6.89"></a><span id="l6.89" class="difflineplus">+  // order of messages in the arrays is the same as in the views.</span>
<a href="#l6.90"></a><span id="l6.90" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l6.91"></a><span id="l6.91" class="difflineplus">+  for (let i = 0; i &lt; NUM_MESSAGES_IN_FOLDER; i++)</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineplus">+    msgHdrsInFolder.push(mc.dbView.getMsgHdrAt(i));</span>
<a href="#l6.93"></a><span id="l6.93" class="difflineplus">+</span>
<a href="#l6.94"></a><span id="l6.94" class="difflineplus">+  // Mark all messages read</span>
<a href="#l6.95"></a><span id="l6.95" class="difflineplus">+  folder.markAllMessagesRead(null);</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineplus">+}</span>
<a href="#l6.97"></a><span id="l6.97" class="difflineplus">+</span>
<a href="#l6.98"></a><span id="l6.98" class="difflineplus">+/**</span>
<a href="#l6.99"></a><span id="l6.99" class="difflineplus">+ * Tests reordering tabs by drag'n'drop within the tabbar</span>
<a href="#l6.100"></a><span id="l6.100" class="difflineplus">+ *</span>
<a href="#l6.101"></a><span id="l6.101" class="difflineplus">+ * It opens aditional movable and closable tabs. The picks the first</span>
<a href="#l6.102"></a><span id="l6.102" class="difflineplus">+ * movable tab and drops it onto the third movable tab.</span>
<a href="#l6.103"></a><span id="l6.103" class="difflineplus">+ */</span>
<a href="#l6.104"></a><span id="l6.104" class="difflineplus">+function test_tab_reorder_tabbar(){</span>
<a href="#l6.105"></a><span id="l6.105" class="difflineplus">+</span>
<a href="#l6.106"></a><span id="l6.106" class="difflineplus">+  // Ensure only one tab is open, otherwise our test most likey fail anyway.</span>
<a href="#l6.107"></a><span id="l6.107" class="difflineplus">+  mc.tabmail.closeOtherTabs(0);</span>
<a href="#l6.108"></a><span id="l6.108" class="difflineplus">+  assert_number_of_tabs_open(1);</span>
<a href="#l6.109"></a><span id="l6.109" class="difflineplus">+</span>
<a href="#l6.110"></a><span id="l6.110" class="difflineplus">+  try {</span>
<a href="#l6.111"></a><span id="l6.111" class="difflineplus">+</span>
<a href="#l6.112"></a><span id="l6.112" class="difflineplus">+    be_in_folder(folder);</span>
<a href="#l6.113"></a><span id="l6.113" class="difflineplus">+</span>
<a href="#l6.114"></a><span id="l6.114" class="difflineplus">+    // Open four tabs</span>
<a href="#l6.115"></a><span id="l6.115" class="difflineplus">+    for (let idx=0; idx &lt; 4 ; idx++) {</span>
<a href="#l6.116"></a><span id="l6.116" class="difflineplus">+      select_click_row(idx);</span>
<a href="#l6.117"></a><span id="l6.117" class="difflineplus">+      open_selected_message_in_new_tab(true);</span>
<a href="#l6.118"></a><span id="l6.118" class="difflineplus">+    }</span>
<a href="#l6.119"></a><span id="l6.119" class="difflineplus">+</span>
<a href="#l6.120"></a><span id="l6.120" class="difflineplus">+    // Check if every thing is correctly initalized</span>
<a href="#l6.121"></a><span id="l6.121" class="difflineplus">+    assert_number_of_tabs_open(5);</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineplus">+</span>
<a href="#l6.123"></a><span id="l6.123" class="difflineplus">+    assert_true(mc.tabmail.tabModes[&quot;message&quot;].tabs[0] == mc.tabmail.tabInfo[1],</span>
<a href="#l6.124"></a><span id="l6.124" class="difflineplus">+        &quot; tabMode.tabs and tabInfo out of sync&quot;);</span>
<a href="#l6.125"></a><span id="l6.125" class="difflineplus">+</span>
<a href="#l6.126"></a><span id="l6.126" class="difflineplus">+    assert_true(mc.tabmail.tabModes[&quot;message&quot;].tabs[1] == mc.tabmail.tabInfo[2],</span>
<a href="#l6.127"></a><span id="l6.127" class="difflineplus">+        &quot; tabMode.tabs and tabInfo out of sync&quot;);</span>
<a href="#l6.128"></a><span id="l6.128" class="difflineplus">+</span>
<a href="#l6.129"></a><span id="l6.129" class="difflineplus">+    assert_true(mc.tabmail.tabModes[&quot;message&quot;].tabs[2] == mc.tabmail.tabInfo[3],</span>
<a href="#l6.130"></a><span id="l6.130" class="difflineplus">+        &quot; tabMode.tabs and tabInfo out of sync&quot;);</span>
<a href="#l6.131"></a><span id="l6.131" class="difflineplus">+</span>
<a href="#l6.132"></a><span id="l6.132" class="difflineplus">+    // Start dragging the first tab</span>
<a href="#l6.133"></a><span id="l6.133" class="difflineplus">+    switch_tab(1);</span>
<a href="#l6.134"></a><span id="l6.134" class="difflineplus">+    assert_selected_and_displayed(msgHdrsInFolder[0]);</span>
<a href="#l6.135"></a><span id="l6.135" class="difflineplus">+</span>
<a href="#l6.136"></a><span id="l6.136" class="difflineplus">+    let tab1 = mc.tabmail.tabContainer.childNodes[1];</span>
<a href="#l6.137"></a><span id="l6.137" class="difflineplus">+    let tab3 = mc.tabmail.tabContainer.childNodes[3];</span>
<a href="#l6.138"></a><span id="l6.138" class="difflineplus">+</span>
<a href="#l6.139"></a><span id="l6.139" class="difflineplus">+    let dt = _synthesizeDragStart(mc.window, tab1, mc.tabmail);</span>
<a href="#l6.140"></a><span id="l6.140" class="difflineplus">+</span>
<a href="#l6.141"></a><span id="l6.141" class="difflineplus">+    // Drop it onto the third tab ...</span>
<a href="#l6.142"></a><span id="l6.142" class="difflineplus">+    _synthesizeDragOver(mc.window, tab3, dt);</span>
<a href="#l6.143"></a><span id="l6.143" class="difflineplus">+</span>
<a href="#l6.144"></a><span id="l6.144" class="difflineplus">+    _synthesizeDrop(mc.window, tab3, dt,</span>
<a href="#l6.145"></a><span id="l6.145" class="difflineplus">+        { screenX : tab3.boxObject.screenX + (tab3.boxObject.width * 0.75),</span>
<a href="#l6.146"></a><span id="l6.146" class="difflineplus">+          screenY : tab3.boxObject.screenY });</span>
<a href="#l6.147"></a><span id="l6.147" class="difflineplus">+</span>
<a href="#l6.148"></a><span id="l6.148" class="difflineplus">+    wait_for_message_display_completion(mc);</span>
<a href="#l6.149"></a><span id="l6.149" class="difflineplus">+</span>
<a href="#l6.150"></a><span id="l6.150" class="difflineplus">+    // if every thing went well...</span>
<a href="#l6.151"></a><span id="l6.151" class="difflineplus">+    assert_number_of_tabs_open(5);</span>
<a href="#l6.152"></a><span id="l6.152" class="difflineplus">+</span>
<a href="#l6.153"></a><span id="l6.153" class="difflineplus">+    // ... we should find tab1 at the third position...</span>
<a href="#l6.154"></a><span id="l6.154" class="difflineplus">+    assert_true(tab1 == mc.tabmail.tabContainer.childNodes[3],</span>
<a href="#l6.155"></a><span id="l6.155" class="difflineplus">+                &quot;Moving tab1 failed&quot;);</span>
<a href="#l6.156"></a><span id="l6.156" class="difflineplus">+    switch_tab(3);</span>
<a href="#l6.157"></a><span id="l6.157" class="difflineplus">+    assert_selected_and_displayed(msgHdrsInFolder[0]);</span>
<a href="#l6.158"></a><span id="l6.158" class="difflineplus">+</span>
<a href="#l6.159"></a><span id="l6.159" class="difflineplus">+    // ... while tab3 moves one up and gets second.</span>
<a href="#l6.160"></a><span id="l6.160" class="difflineplus">+    assert_true(tab3 == mc.tabmail.tabContainer.childNodes[2],</span>
<a href="#l6.161"></a><span id="l6.161" class="difflineplus">+                &quot;Moving tab3 failed&quot;);</span>
<a href="#l6.162"></a><span id="l6.162" class="difflineplus">+    switch_tab(2);</span>
<a href="#l6.163"></a><span id="l6.163" class="difflineplus">+    assert_selected_and_displayed(msgHdrsInFolder[2]);</span>
<a href="#l6.164"></a><span id="l6.164" class="difflineplus">+</span>
<a href="#l6.165"></a><span id="l6.165" class="difflineplus">+    // we have one &quot;message&quot; tab and three &quot;folder&quot; tabs, thus tabInfo[1-3] and</span>
<a href="#l6.166"></a><span id="l6.166" class="difflineplus">+    // tabMode[&quot;message&quot;].tabs[0-2] have to be same, otherwise something went</span>
<a href="#l6.167"></a><span id="l6.167" class="difflineplus">+    // wrong while moving tabs around</span>
<a href="#l6.168"></a><span id="l6.168" class="difflineplus">+    assert_true(mc.tabmail.tabModes[&quot;message&quot;].tabs[0] == mc.tabmail.tabInfo[1],</span>
<a href="#l6.169"></a><span id="l6.169" class="difflineplus">+        &quot; tabMode.tabs and tabInfo out of sync&quot;);</span>
<a href="#l6.170"></a><span id="l6.170" class="difflineplus">+</span>
<a href="#l6.171"></a><span id="l6.171" class="difflineplus">+    assert_true(mc.tabmail.tabModes[&quot;message&quot;].tabs[1] == mc.tabmail.tabInfo[2],</span>
<a href="#l6.172"></a><span id="l6.172" class="difflineplus">+        &quot; tabMode.tabs and tabInfo out of sync&quot;);</span>
<a href="#l6.173"></a><span id="l6.173" class="difflineplus">+</span>
<a href="#l6.174"></a><span id="l6.174" class="difflineplus">+    assert_true(mc.tabmail.tabModes[&quot;message&quot;].tabs[2] == mc.tabmail.tabInfo[3],</span>
<a href="#l6.175"></a><span id="l6.175" class="difflineplus">+        &quot; tabMode.tabs and tabInfo out of sync&quot;);</span>
<a href="#l6.176"></a><span id="l6.176" class="difflineplus">+  }</span>
<a href="#l6.177"></a><span id="l6.177" class="difflineplus">+  finally {</span>
<a href="#l6.178"></a><span id="l6.178" class="difflineplus">+    // finally close the tabs we opened.</span>
<a href="#l6.179"></a><span id="l6.179" class="difflineplus">+    mc.tabmail.closeOtherTabs(0);</span>
<a href="#l6.180"></a><span id="l6.180" class="difflineplus">+    assert_number_of_tabs_open(1);</span>
<a href="#l6.181"></a><span id="l6.181" class="difflineplus">+  }</span>
<a href="#l6.182"></a><span id="l6.182" class="difflineplus">+}</span>
<a href="#l6.183"></a><span id="l6.183" class="difflineplus">+</span>
<a href="#l6.184"></a><span id="l6.184" class="difflineplus">+/**</span>
<a href="#l6.185"></a><span id="l6.185" class="difflineplus">+ * Tests drag'n'drop tab reordering between windows</span>
<a href="#l6.186"></a><span id="l6.186" class="difflineplus">+ */</span>
<a href="#l6.187"></a><span id="l6.187" class="difflineplus">+function test_tab_reorder_window(){</span>
<a href="#l6.188"></a><span id="l6.188" class="difflineplus">+</span>
<a href="#l6.189"></a><span id="l6.189" class="difflineplus">+  // Ensure only one tab is open, otherwise our test most likey fail anyway.</span>
<a href="#l6.190"></a><span id="l6.190" class="difflineplus">+  mc.tabmail.closeOtherTabs(0);</span>
<a href="#l6.191"></a><span id="l6.191" class="difflineplus">+  assert_number_of_tabs_open(1);</span>
<a href="#l6.192"></a><span id="l6.192" class="difflineplus">+</span>
<a href="#l6.193"></a><span id="l6.193" class="difflineplus">+  let mc2 = null;</span>
<a href="#l6.194"></a><span id="l6.194" class="difflineplus">+</span>
<a href="#l6.195"></a><span id="l6.195" class="difflineplus">+  try {</span>
<a href="#l6.196"></a><span id="l6.196" class="difflineplus">+</span>
<a href="#l6.197"></a><span id="l6.197" class="difflineplus">+    be_in_folder(folder);</span>
<a href="#l6.198"></a><span id="l6.198" class="difflineplus">+</span>
<a href="#l6.199"></a><span id="l6.199" class="difflineplus">+    // Open a new tab...</span>
<a href="#l6.200"></a><span id="l6.200" class="difflineplus">+    select_click_row(1);</span>
<a href="#l6.201"></a><span id="l6.201" class="difflineplus">+    open_selected_message_in_new_tab(false);</span>
<a href="#l6.202"></a><span id="l6.202" class="difflineplus">+</span>
<a href="#l6.203"></a><span id="l6.203" class="difflineplus">+    assert_number_of_tabs_open(2);</span>
<a href="#l6.204"></a><span id="l6.204" class="difflineplus">+</span>
<a href="#l6.205"></a><span id="l6.205" class="difflineplus">+    switch_tab(1);</span>
<a href="#l6.206"></a><span id="l6.206" class="difflineplus">+    assert_selected_and_displayed(msgHdrsInFolder[1]);</span>
<a href="#l6.207"></a><span id="l6.207" class="difflineplus">+</span>
<a href="#l6.208"></a><span id="l6.208" class="difflineplus">+    // ...and then a new 3 pane as our drop target.</span>
<a href="#l6.209"></a><span id="l6.209" class="difflineplus">+    plan_for_new_window(&quot;mail:3pane&quot;);</span>
<a href="#l6.210"></a><span id="l6.210" class="difflineplus">+</span>
<a href="#l6.211"></a><span id="l6.211" class="difflineplus">+    let ww = Cc[&quot;@mozilla.org/embedcomp/window-watcher;1&quot;]</span>
<a href="#l6.212"></a><span id="l6.212" class="difflineplus">+                          .getService(Ci.nsIWindowWatcher);</span>
<a href="#l6.213"></a><span id="l6.213" class="difflineplus">+</span>
<a href="#l6.214"></a><span id="l6.214" class="difflineplus">+    let args = {msgHdr: msgHdrsInFolder[3]};</span>
<a href="#l6.215"></a><span id="l6.215" class="difflineplus">+    args.wrappedJSObject = args;</span>
<a href="#l6.216"></a><span id="l6.216" class="difflineplus">+</span>
<a href="#l6.217"></a><span id="l6.217" class="difflineplus">+    let aWnd2 = ww.openWindow(null,</span>
<a href="#l6.218"></a><span id="l6.218" class="difflineplus">+        &quot;chrome://messenger/content/&quot;, &quot;&quot;,</span>
<a href="#l6.219"></a><span id="l6.219" class="difflineplus">+        &quot;all,chrome,dialog=no,status,toolbar&quot;, args);</span>
<a href="#l6.220"></a><span id="l6.220" class="difflineplus">+</span>
<a href="#l6.221"></a><span id="l6.221" class="difflineplus">+    mc2 = wait_for_new_window(&quot;mail:3pane&quot;);</span>
<a href="#l6.222"></a><span id="l6.222" class="difflineplus">+    wait_for_message_display_completion(mc2,true);</span>
<a href="#l6.223"></a><span id="l6.223" class="difflineplus">+</span>
<a href="#l6.224"></a><span id="l6.224" class="difflineplus">+    // Double check if we are listening to the right window.</span>
<a href="#l6.225"></a><span id="l6.225" class="difflineplus">+    assert_true(aWnd2 == mc2.window, &quot;Opening Window failed&quot; );</span>
<a href="#l6.226"></a><span id="l6.226" class="difflineplus">+</span>
<a href="#l6.227"></a><span id="l6.227" class="difflineplus">+    // Start dragging the first tab ...</span>
<a href="#l6.228"></a><span id="l6.228" class="difflineplus">+    let tabA = mc.tabmail.tabContainer.childNodes[1];</span>
<a href="#l6.229"></a><span id="l6.229" class="difflineplus">+    assert_true(tabA, &quot;No movable Tab&quot;);</span>
<a href="#l6.230"></a><span id="l6.230" class="difflineplus">+</span>
<a href="#l6.231"></a><span id="l6.231" class="difflineplus">+    // We drop onto the Folder Tab, it is guaranteed to exist.</span>
<a href="#l6.232"></a><span id="l6.232" class="difflineplus">+    let tabB = mc2.tabmail.tabContainer.childNodes[0];</span>
<a href="#l6.233"></a><span id="l6.233" class="difflineplus">+    assert_true(tabB, &quot;No movable Tab&quot;);</span>
<a href="#l6.234"></a><span id="l6.234" class="difflineplus">+</span>
<a href="#l6.235"></a><span id="l6.235" class="difflineplus">+    let dt = _synthesizeDragStart(mc.window,tabA,mc.tabmail);</span>
<a href="#l6.236"></a><span id="l6.236" class="difflineplus">+</span>
<a href="#l6.237"></a><span id="l6.237" class="difflineplus">+    _synthesizeDragOver(mc2.window, tabB,dt);</span>
<a href="#l6.238"></a><span id="l6.238" class="difflineplus">+</span>
<a href="#l6.239"></a><span id="l6.239" class="difflineplus">+    _synthesizeDrop(mc2.window,tabB, dt,</span>
<a href="#l6.240"></a><span id="l6.240" class="difflineplus">+        { screenX : tabB.boxObject.screenX + (tabB.boxObject.width * 0.75),</span>
<a href="#l6.241"></a><span id="l6.241" class="difflineplus">+          screenY : tabB.boxObject.screenY });</span>
<a href="#l6.242"></a><span id="l6.242" class="difflineplus">+</span>
<a href="#l6.243"></a><span id="l6.243" class="difflineplus">+    wait_for_message_display_completion(mc2);</span>
<a href="#l6.244"></a><span id="l6.244" class="difflineplus">+</span>
<a href="#l6.245"></a><span id="l6.245" class="difflineplus">+    assert_true( !! (mc.tabmail.tabContainer.childNodes.length == 1),</span>
<a href="#l6.246"></a><span id="l6.246" class="difflineplus">+      &quot;Moving tab to new window failed, tab still in old window&quot;);</span>
<a href="#l6.247"></a><span id="l6.247" class="difflineplus">+</span>
<a href="#l6.248"></a><span id="l6.248" class="difflineplus">+    assert_true( !! (mc2.tabmail.tabContainer.childNodes.length == 2),</span>
<a href="#l6.249"></a><span id="l6.249" class="difflineplus">+      &quot;Moving tab to new window failed, no new tab in new window&quot;);</span>
<a href="#l6.250"></a><span id="l6.250" class="difflineplus">+</span>
<a href="#l6.251"></a><span id="l6.251" class="difflineplus">+    assert_selected_and_displayed(mc2,msgHdrsInFolder[1]);</span>
<a href="#l6.252"></a><span id="l6.252" class="difflineplus">+</span>
<a href="#l6.253"></a><span id="l6.253" class="difflineplus">+  }</span>
<a href="#l6.254"></a><span id="l6.254" class="difflineplus">+  finally {</span>
<a href="#l6.255"></a><span id="l6.255" class="difflineplus">+    // finally close the tabs and windows we opened.</span>
<a href="#l6.256"></a><span id="l6.256" class="difflineplus">+    mc.tabmail.closeOtherTabs(0);</span>
<a href="#l6.257"></a><span id="l6.257" class="difflineplus">+    assert_number_of_tabs_open(1);</span>
<a href="#l6.258"></a><span id="l6.258" class="difflineplus">+</span>
<a href="#l6.259"></a><span id="l6.259" class="difflineplus">+    if (mc2)</span>
<a href="#l6.260"></a><span id="l6.260" class="difflineplus">+      mc2.window.close();</span>
<a href="#l6.261"></a><span id="l6.261" class="difflineplus">+  }</span>
<a href="#l6.262"></a><span id="l6.262" class="difflineplus">+</span>
<a href="#l6.263"></a><span id="l6.263" class="difflineplus">+</span>
<a href="#l6.264"></a><span id="l6.264" class="difflineplus">+}</span>
<a href="#l6.265"></a><span id="l6.265" class="difflineplus">+</span>
<a href="#l6.266"></a><span id="l6.266" class="difflineplus">+/**</span>
<a href="#l6.267"></a><span id="l6.267" class="difflineplus">+ * Tests detaching tabs into windows via drag'n'drop</span>
<a href="#l6.268"></a><span id="l6.268" class="difflineplus">+ */</span>
<a href="#l6.269"></a><span id="l6.269" class="difflineplus">+function test_tab_reorder_detach(){</span>
<a href="#l6.270"></a><span id="l6.270" class="difflineplus">+</span>
<a href="#l6.271"></a><span id="l6.271" class="difflineplus">+  // Ensure only one tab is open, otherwise our test most likey fail anyway.</span>
<a href="#l6.272"></a><span id="l6.272" class="difflineplus">+  mc.tabmail.closeOtherTabs(0);</span>
<a href="#l6.273"></a><span id="l6.273" class="difflineplus">+  assert_number_of_tabs_open(1);</span>
<a href="#l6.274"></a><span id="l6.274" class="difflineplus">+</span>
<a href="#l6.275"></a><span id="l6.275" class="difflineplus">+  let mc2 = null;</span>
<a href="#l6.276"></a><span id="l6.276" class="difflineplus">+</span>
<a href="#l6.277"></a><span id="l6.277" class="difflineplus">+  try {</span>
<a href="#l6.278"></a><span id="l6.278" class="difflineplus">+</span>
<a href="#l6.279"></a><span id="l6.279" class="difflineplus">+    be_in_folder(folder);</span>
<a href="#l6.280"></a><span id="l6.280" class="difflineplus">+</span>
<a href="#l6.281"></a><span id="l6.281" class="difflineplus">+    // Open a new tab...</span>
<a href="#l6.282"></a><span id="l6.282" class="difflineplus">+    select_click_row(2);</span>
<a href="#l6.283"></a><span id="l6.283" class="difflineplus">+    open_selected_message_in_new_tab(false);</span>
<a href="#l6.284"></a><span id="l6.284" class="difflineplus">+</span>
<a href="#l6.285"></a><span id="l6.285" class="difflineplus">+    assert_number_of_tabs_open(2);</span>
<a href="#l6.286"></a><span id="l6.286" class="difflineplus">+</span>
<a href="#l6.287"></a><span id="l6.287" class="difflineplus">+    // ... if every thing works we should expect a new window...</span>
<a href="#l6.288"></a><span id="l6.288" class="difflineplus">+    plan_for_new_window(&quot;mail:3pane&quot;);</span>
<a href="#l6.289"></a><span id="l6.289" class="difflineplus">+</span>
<a href="#l6.290"></a><span id="l6.290" class="difflineplus">+    // ... now start dragging</span>
<a href="#l6.291"></a><span id="l6.291" class="difflineplus">+</span>
<a href="#l6.292"></a><span id="l6.292" class="difflineplus">+    mc.tabmail.switchToTab(1);</span>
<a href="#l6.293"></a><span id="l6.293" class="difflineplus">+</span>
<a href="#l6.294"></a><span id="l6.294" class="difflineplus">+    let tab1 = mc.tabmail.tabContainer.childNodes[1];</span>
<a href="#l6.295"></a><span id="l6.295" class="difflineplus">+    let dropContent = mc.e(&quot;tabpanelcontainer&quot;);</span>
<a href="#l6.296"></a><span id="l6.296" class="difflineplus">+    let box = dropContent.boxObject;</span>
<a href="#l6.297"></a><span id="l6.297" class="difflineplus">+</span>
<a href="#l6.298"></a><span id="l6.298" class="difflineplus">+    let dt = _synthesizeDragStart(mc.window, tab1, mc.tabmail);</span>
<a href="#l6.299"></a><span id="l6.299" class="difflineplus">+</span>
<a href="#l6.300"></a><span id="l6.300" class="difflineplus">+    _synthesizeDragOver(mc.window, dropContent, dt);</span>
<a href="#l6.301"></a><span id="l6.301" class="difflineplus">+</span>
<a href="#l6.302"></a><span id="l6.302" class="difflineplus">+    // notify tab1 drag has ended</span>
<a href="#l6.303"></a><span id="l6.303" class="difflineplus">+    _synthesizeDragEnd(mc.window, dropContent, tab1, dt,</span>
<a href="#l6.304"></a><span id="l6.304" class="difflineplus">+        { screenX : (box.screenX + box.width / 2 ),</span>
<a href="#l6.305"></a><span id="l6.305" class="difflineplus">+          screenY : (box.screenY + box.height / 2 ) });</span>
<a href="#l6.306"></a><span id="l6.306" class="difflineplus">+</span>
<a href="#l6.307"></a><span id="l6.307" class="difflineplus">+    // ... and wait for the new window</span>
<a href="#l6.308"></a><span id="l6.308" class="difflineplus">+    mc2 = wait_for_new_window(&quot;mail:3pane&quot;);</span>
<a href="#l6.309"></a><span id="l6.309" class="difflineplus">+    wait_for_message_display_completion(mc2, true);</span>
<a href="#l6.310"></a><span id="l6.310" class="difflineplus">+</span>
<a href="#l6.311"></a><span id="l6.311" class="difflineplus">+    assert_true(mc.tabmail.tabContainer.childNodes.length == 1,</span>
<a href="#l6.312"></a><span id="l6.312" class="difflineplus">+        &quot;Moving tab to new window failed, tab still in old window&quot;);</span>
<a href="#l6.313"></a><span id="l6.313" class="difflineplus">+</span>
<a href="#l6.314"></a><span id="l6.314" class="difflineplus">+    assert_true(mc2.tabmail.tabContainer.childNodes.length == 2,</span>
<a href="#l6.315"></a><span id="l6.315" class="difflineplus">+        &quot;Moving tab to new window failed, no new tab in new window&quot;);</span>
<a href="#l6.316"></a><span id="l6.316" class="difflineplus">+</span>
<a href="#l6.317"></a><span id="l6.317" class="difflineplus">+    assert_selected_and_displayed(mc2, msgHdrsInFolder[2]);</span>
<a href="#l6.318"></a><span id="l6.318" class="difflineplus">+</span>
<a href="#l6.319"></a><span id="l6.319" class="difflineplus">+  }</span>
<a href="#l6.320"></a><span id="l6.320" class="difflineplus">+  finally {</span>
<a href="#l6.321"></a><span id="l6.321" class="difflineplus">+    // finally close the tabs and window we opened.</span>
<a href="#l6.322"></a><span id="l6.322" class="difflineplus">+    mc.tabmail.closeOtherTabs(0);</span>
<a href="#l6.323"></a><span id="l6.323" class="difflineplus">+    assert_number_of_tabs_open(1);</span>
<a href="#l6.324"></a><span id="l6.324" class="difflineplus">+</span>
<a href="#l6.325"></a><span id="l6.325" class="difflineplus">+    if (mc2)</span>
<a href="#l6.326"></a><span id="l6.326" class="difflineplus">+      mc2.window.close();</span>
<a href="#l6.327"></a><span id="l6.327" class="difflineplus">+  }</span>
<a href="#l6.328"></a><span id="l6.328" class="difflineplus">+}</span>
<a href="#l6.329"></a><span id="l6.329" class="difflineplus">+</span>
<a href="#l6.330"></a><span id="l6.330" class="difflineplus">+/**</span>
<a href="#l6.331"></a><span id="l6.331" class="difflineplus">+ * Test undo of recently closed tabs.</span>
<a href="#l6.332"></a><span id="l6.332" class="difflineplus">+ */</span>
<a href="#l6.333"></a><span id="l6.333" class="difflineplus">+function test_tab_undo() {</span>
<a href="#l6.334"></a><span id="l6.334" class="difflineplus">+  // Ensure only one tab is open, otherwise our test most likey fail anyway.</span>
<a href="#l6.335"></a><span id="l6.335" class="difflineplus">+  mc.tabmail.closeOtherTabs(0);</span>
<a href="#l6.336"></a><span id="l6.336" class="difflineplus">+  assert_number_of_tabs_open(1);</span>
<a href="#l6.337"></a><span id="l6.337" class="difflineplus">+</span>
<a href="#l6.338"></a><span id="l6.338" class="difflineplus">+  try {</span>
<a href="#l6.339"></a><span id="l6.339" class="difflineplus">+</span>
<a href="#l6.340"></a><span id="l6.340" class="difflineplus">+    be_in_folder(folder);</span>
<a href="#l6.341"></a><span id="l6.341" class="difflineplus">+</span>
<a href="#l6.342"></a><span id="l6.342" class="difflineplus">+    // Open five tabs...</span>
<a href="#l6.343"></a><span id="l6.343" class="difflineplus">+    for (let idx = 0; idx &lt; 5; idx++) {</span>
<a href="#l6.344"></a><span id="l6.344" class="difflineplus">+      select_click_row(idx);</span>
<a href="#l6.345"></a><span id="l6.345" class="difflineplus">+      open_selected_message_in_new_tab(true);</span>
<a href="#l6.346"></a><span id="l6.346" class="difflineplus">+    }</span>
<a href="#l6.347"></a><span id="l6.347" class="difflineplus">+</span>
<a href="#l6.348"></a><span id="l6.348" class="difflineplus">+    assert_number_of_tabs_open(6);</span>
<a href="#l6.349"></a><span id="l6.349" class="difflineplus">+</span>
<a href="#l6.350"></a><span id="l6.350" class="difflineplus">+    switch_tab(2);</span>
<a href="#l6.351"></a><span id="l6.351" class="difflineplus">+    assert_selected_and_displayed(msgHdrsInFolder[1]);</span>
<a href="#l6.352"></a><span id="l6.352" class="difflineplus">+</span>
<a href="#l6.353"></a><span id="l6.353" class="difflineplus">+    mc.tabmail.closeTab(2);</span>
<a href="#l6.354"></a><span id="l6.354" class="difflineplus">+    mc.tabmail.closeTab(2, true);</span>
<a href="#l6.355"></a><span id="l6.355" class="difflineplus">+    mc.tabmail.closeTab(2);</span>
<a href="#l6.356"></a><span id="l6.356" class="difflineplus">+</span>
<a href="#l6.357"></a><span id="l6.357" class="difflineplus">+    assert_number_of_tabs_open(3);</span>
<a href="#l6.358"></a><span id="l6.358" class="difflineplus">+    assert_selected_and_displayed(mc, msgHdrsInFolder[4]);</span>
<a href="#l6.359"></a><span id="l6.359" class="difflineplus">+</span>
<a href="#l6.360"></a><span id="l6.360" class="difflineplus">+    mc.tabmail.undoCloseTab();</span>
<a href="#l6.361"></a><span id="l6.361" class="difflineplus">+    assert_number_of_tabs_open(4);</span>
<a href="#l6.362"></a><span id="l6.362" class="difflineplus">+    assert_selected_and_displayed(mc, msgHdrsInFolder[3]);</span>
<a href="#l6.363"></a><span id="l6.363" class="difflineplus">+</span>
<a href="#l6.364"></a><span id="l6.364" class="difflineplus">+    // msgHdrsInFolder[2] won't be restorend it was closed with disabled undo.</span>
<a href="#l6.365"></a><span id="l6.365" class="difflineplus">+</span>
<a href="#l6.366"></a><span id="l6.366" class="difflineplus">+    mc.tabmail.undoCloseTab();</span>
<a href="#l6.367"></a><span id="l6.367" class="difflineplus">+    assert_number_of_tabs_open(5);</span>
<a href="#l6.368"></a><span id="l6.368" class="difflineplus">+    assert_selected_and_displayed(mc, msgHdrsInFolder[1]);</span>
<a href="#l6.369"></a><span id="l6.369" class="difflineplus">+</span>
<a href="#l6.370"></a><span id="l6.370" class="difflineplus">+  }</span>
<a href="#l6.371"></a><span id="l6.371" class="difflineplus">+  finally  {</span>
<a href="#l6.372"></a><span id="l6.372" class="difflineplus">+    // finally close the tabs opened.</span>
<a href="#l6.373"></a><span id="l6.373" class="difflineplus">+    mc.tabmail.closeOtherTabs(0);</span>
<a href="#l6.374"></a><span id="l6.374" class="difflineplus">+    assert_number_of_tabs_open(1);</span>
<a href="#l6.375"></a><span id="l6.375" class="difflineplus">+  }</span>
<a href="#l6.376"></a><span id="l6.376" class="difflineplus">+}</span>
<a href="#l6.377"></a><span id="l6.377" class="difflineplus">+</span>
<a href="#l6.378"></a><span id="l6.378" class="difflineplus">+/*</span>
<a href="#l6.379"></a><span id="l6.379" class="difflineplus">+ * A set of private helper functions for drag'n'drop</span>
<a href="#l6.380"></a><span id="l6.380" class="difflineplus">+ */</span>
<a href="#l6.381"></a><span id="l6.381" class="difflineplus">+</span>
<a href="#l6.382"></a><span id="l6.382" class="difflineplus">+/**</span>
<a href="#l6.383"></a><span id="l6.383" class="difflineplus">+ * Starts a drag new session.</span>
<a href="#l6.384"></a><span id="l6.384" class="difflineplus">+ * @param {} aWindow</span>
<a href="#l6.385"></a><span id="l6.385" class="difflineplus">+ * @param {XULElement} aDispatcher</span>
<a href="#l6.386"></a><span id="l6.386" class="difflineplus">+ *   the element from which the drag session should be started.</span>
<a href="#l6.387"></a><span id="l6.387" class="difflineplus">+ * @param {XULElement} aListener</span>
<a href="#l6.388"></a><span id="l6.388" class="difflineplus">+ *   the element who's drop target should be captured and returned.</span>
<a href="#l6.389"></a><span id="l6.389" class="difflineplus">+ * @return {nsIDataTransfer}</span>
<a href="#l6.390"></a><span id="l6.390" class="difflineplus">+ *   returns the DataTransfer Object of captured by aListener.</span>
<a href="#l6.391"></a><span id="l6.391" class="difflineplus">+ */</span>
<a href="#l6.392"></a><span id="l6.392" class="difflineplus">+function _synthesizeDragStart(aWindow, aDispatcher, aListener)</span>
<a href="#l6.393"></a><span id="l6.393" class="difflineplus">+{</span>
<a href="#l6.394"></a><span id="l6.394" class="difflineplus">+  let dt;</span>
<a href="#l6.395"></a><span id="l6.395" class="difflineplus">+</span>
<a href="#l6.396"></a><span id="l6.396" class="difflineplus">+  var trapDrag = function(event) {</span>
<a href="#l6.397"></a><span id="l6.397" class="difflineplus">+</span>
<a href="#l6.398"></a><span id="l6.398" class="difflineplus">+    if ( !event.dataTransfer )</span>
<a href="#l6.399"></a><span id="l6.399" class="difflineplus">+      throw &quot;no DataTransfer&quot;;</span>
<a href="#l6.400"></a><span id="l6.400" class="difflineplus">+</span>
<a href="#l6.401"></a><span id="l6.401" class="difflineplus">+    dt = event.dataTransfer;</span>
<a href="#l6.402"></a><span id="l6.402" class="difflineplus">+</span>
<a href="#l6.403"></a><span id="l6.403" class="difflineplus">+    //event.stopPropagation();</span>
<a href="#l6.404"></a><span id="l6.404" class="difflineplus">+    event.preventDefault();</span>
<a href="#l6.405"></a><span id="l6.405" class="difflineplus">+  };</span>
<a href="#l6.406"></a><span id="l6.406" class="difflineplus">+</span>
<a href="#l6.407"></a><span id="l6.407" class="difflineplus">+  aListener.addEventListener(&quot;dragstart&quot;, trapDrag, true);</span>
<a href="#l6.408"></a><span id="l6.408" class="difflineplus">+</span>
<a href="#l6.409"></a><span id="l6.409" class="difflineplus">+  EventUtils.synthesizeMouse(aDispatcher, 5, 5, {type:&quot;mousedown&quot;}, aWindow);</span>
<a href="#l6.410"></a><span id="l6.410" class="difflineplus">+  EventUtils.synthesizeMouse(aDispatcher, 5, 10, {type:&quot;mousemove&quot;}, aWindow);</span>
<a href="#l6.411"></a><span id="l6.411" class="difflineplus">+  EventUtils.synthesizeMouse(aDispatcher, 5, 15, {type:&quot;mousemove&quot;}, aWindow);</span>
<a href="#l6.412"></a><span id="l6.412" class="difflineplus">+</span>
<a href="#l6.413"></a><span id="l6.413" class="difflineplus">+  aListener.removeEventListener(&quot;dragstart&quot;, trapDrag, true);</span>
<a href="#l6.414"></a><span id="l6.414" class="difflineplus">+</span>
<a href="#l6.415"></a><span id="l6.415" class="difflineplus">+  return dt;</span>
<a href="#l6.416"></a><span id="l6.416" class="difflineplus">+}</span>
<a href="#l6.417"></a><span id="l6.417" class="difflineplus">+</span>
<a href="#l6.418"></a><span id="l6.418" class="difflineplus">+function _synthesizeDragOver(aWindow, aDispatcher, aDt, aArgs)</span>
<a href="#l6.419"></a><span id="l6.419" class="difflineplus">+{</span>
<a href="#l6.420"></a><span id="l6.420" class="difflineplus">+  _synthesizeDragEvent(&quot;dragover&quot;, aWindow, aDispatcher, aDt, aArgs);</span>
<a href="#l6.421"></a><span id="l6.421" class="difflineplus">+}</span>
<a href="#l6.422"></a><span id="l6.422" class="difflineplus">+</span>
<a href="#l6.423"></a><span id="l6.423" class="difflineplus">+function _synthesizeDragEnd(aWindow, aDispatcher, aListener, aDt, aArgs)</span>
<a href="#l6.424"></a><span id="l6.424" class="difflineplus">+{</span>
<a href="#l6.425"></a><span id="l6.425" class="difflineplus">+  _synthesizeDragEvent(&quot;dragend&quot;, aWindow, aListener, aDt, aArgs);</span>
<a href="#l6.426"></a><span id="l6.426" class="difflineplus">+</span>
<a href="#l6.427"></a><span id="l6.427" class="difflineplus">+  //Ensure drag has ended.</span>
<a href="#l6.428"></a><span id="l6.428" class="difflineplus">+  EventUtils.synthesizeMouse(aDispatcher, 5, 5, {type:&quot;mousemove&quot;}, aWindow);</span>
<a href="#l6.429"></a><span id="l6.429" class="difflineplus">+  EventUtils.synthesizeMouse(aDispatcher, 5, 10, {type:&quot;mousemove&quot;}, aWindow);</span>
<a href="#l6.430"></a><span id="l6.430" class="difflineplus">+  EventUtils.synthesizeMouse(aDispatcher, 5, 5, {type:&quot;mouseup&quot;}, aWindow);</span>
<a href="#l6.431"></a><span id="l6.431" class="difflineplus">+}</span>
<a href="#l6.432"></a><span id="l6.432" class="difflineplus">+</span>
<a href="#l6.433"></a><span id="l6.433" class="difflineplus">+function _synthesizeDrop(aWindow, aDispatcher, aDt, aArgs)</span>
<a href="#l6.434"></a><span id="l6.434" class="difflineplus">+{</span>
<a href="#l6.435"></a><span id="l6.435" class="difflineplus">+  _synthesizeDragEvent(&quot;drop&quot;, aWindow, aDispatcher, aDt, aArgs);</span>
<a href="#l6.436"></a><span id="l6.436" class="difflineplus">+</span>
<a href="#l6.437"></a><span id="l6.437" class="difflineplus">+  // Ensure drag has ended.</span>
<a href="#l6.438"></a><span id="l6.438" class="difflineplus">+  EventUtils.synthesizeMouse(aDispatcher, 5, 5, {type:&quot;mousemove&quot;}, aWindow);</span>
<a href="#l6.439"></a><span id="l6.439" class="difflineplus">+  EventUtils.synthesizeMouse(aDispatcher, 5, 10, {type:&quot;mousemove&quot;}, aWindow);</span>
<a href="#l6.440"></a><span id="l6.440" class="difflineplus">+  EventUtils.synthesizeMouse(aDispatcher, 5, 5, {type:&quot;mouseup&quot;}, aWindow);</span>
<a href="#l6.441"></a><span id="l6.441" class="difflineplus">+}</span>
<a href="#l6.442"></a><span id="l6.442" class="difflineplus">+</span>
<a href="#l6.443"></a><span id="l6.443" class="difflineplus">+function _synthesizeDragEvent(aType, aWindow, aDispatcher, aDt, aArgs)</span>
<a href="#l6.444"></a><span id="l6.444" class="difflineplus">+{</span>
<a href="#l6.445"></a><span id="l6.445" class="difflineplus">+  let screenX;</span>
<a href="#l6.446"></a><span id="l6.446" class="difflineplus">+  if (aArgs &amp;&amp; (&quot;screenX&quot; in aArgs))</span>
<a href="#l6.447"></a><span id="l6.447" class="difflineplus">+    screenX = aArgs.screenX;</span>
<a href="#l6.448"></a><span id="l6.448" class="difflineplus">+  else</span>
<a href="#l6.449"></a><span id="l6.449" class="difflineplus">+    screenX = aDispatcher.boxObject.ScreenX;;</span>
<a href="#l6.450"></a><span id="l6.450" class="difflineplus">+</span>
<a href="#l6.451"></a><span id="l6.451" class="difflineplus">+  let screenY;</span>
<a href="#l6.452"></a><span id="l6.452" class="difflineplus">+  if (aArgs &amp;&amp; (&quot;screenY&quot; in aArgs))</span>
<a href="#l6.453"></a><span id="l6.453" class="difflineplus">+    screenY = aArgs.screenY;</span>
<a href="#l6.454"></a><span id="l6.454" class="difflineplus">+  else</span>
<a href="#l6.455"></a><span id="l6.455" class="difflineplus">+    screenY = aDispatcher.boxObject.ScreenY;</span>
<a href="#l6.456"></a><span id="l6.456" class="difflineplus">+</span>
<a href="#l6.457"></a><span id="l6.457" class="difflineplus">+  let event = aWindow.document.createEvent(&quot;DragEvents&quot;);</span>
<a href="#l6.458"></a><span id="l6.458" class="difflineplus">+  event.initDragEvent(aType, true, true, aWindow, 0,</span>
<a href="#l6.459"></a><span id="l6.459" class="difflineplus">+      screenX, screenY, 0, 0, false, false, false, false, 0, null, aDt);</span>
<a href="#l6.460"></a><span id="l6.460" class="difflineplus">+  aDispatcher.dispatchEvent(event);</span>
<a href="#l6.461"></a><span id="l6.461" class="difflineplus">+}</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

