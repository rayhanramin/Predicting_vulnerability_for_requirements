<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 3378:5de0a596f65c6b3a96a11a241a27676684a6fee6</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 5de0a596f65c6b3a96a11a241a27676684a6fee6" />
<meta property="og:url" content="/comm-central/rev/5de0a596f65c6b3a96a11a241a27676684a6fee6" />
<meta property="og:description" content="Bug 506397 - &quot;Support multiple spam corpus files&quot; [r=Standard8 sr=bienvenu]" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 5de0a596f65c6b3a96a11a241a27676684a6fee6 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/5de0a596f65c6b3a96a11a241a27676684a6fee6">shortlog</a> |
<a href="/comm-central/log/5de0a596f65c6b3a96a11a241a27676684a6fee6">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/5de0a596f65c6b3a96a11a241a27676684a6fee6">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/5de0a596f65c6b3a96a11a241a27676684a6fee6">files</a> |
changeset |
<a href="/comm-central/raw-rev/5de0a596f65c6b3a96a11a241a27676684a6fee6">raw</a>  | <a href="/comm-central/archive/5de0a596f65c6b3a96a11a241a27676684a6fee6.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=506397">Bug 506397</a> - &quot;Support multiple spam corpus files&quot; [r=Standard8 sr=bienvenu]
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#75;&#101;&#110;&#116;&#32;&#74;&#97;&#109;&#101;&#115;&#32;&#60;&#107;&#101;&#110;&#116;&#64;&#99;&#97;&#115;&#112;&#105;&#97;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Sat, 22 Aug 2009 09:27:25 +0100</td></tr>

<tr>
 <td>changeset 3378</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/5de0a596f65c6b3a96a11a241a27676684a6fee6">5de0a596f65c6b3a96a11a241a27676684a6fee6</a></td>
</tr>



<tr>
<td>parent 3377</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/7369d04a6047a98bbaf4dc858f586f856fd49096">7369d04a6047a98bbaf4dc858f586f856fd49096</a>
</td>
</tr>

<tr>
<td>child 3379</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/092911915d6089b9c8128c2ba83dd693332f281e">092911915d6089b9c8128c2ba83dd693332f281e</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=5de0a596f65c6b3a96a11a241a27676684a6fee6">2744</a></td></tr>
<tr><td>push user</td><td>bugzilla@standard8.plus.com</td></tr>
<tr><td>push date</td><td class="date age">Sat, 22 Aug 2009 08:29:12 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@5de0a596f65c [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=5de0a596f65c6b3a96a11a241a27676684a6fee6">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=5de0a596f65c6b3a96a11a241a27676684a6fee6&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=5de0a596f65c6b3a96a11a241a27676684a6fee6&newProject=comm-central&newRevision=9bfc76e9dc6ade5057a8b4a00d36b495cbe59a43&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=5de0a596f65c6b3a96a11a241a27676684a6fee6&newProject=comm-central&newRevision=9bfc76e9dc6ade5057a8b4a00d36b495cbe59a43&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=5de0a596f65c6b3a96a11a241a27676684a6fee6&newProject=comm-central&newRevision=9bfc76e9dc6ade5057a8b4a00d36b495cbe59a43&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28Standard8%29&revcount=50">Standard8</a>, <a href="/comm-central/log?rev=reviewer%28bienvenu%29&revcount=50">bienvenu</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=506397">506397</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=506397">Bug 506397</a> - &quot;Support multiple spam corpus files&quot; [r=Standard8 sr=bienvenu]</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/base/search/public/nsIMsgFilterPlugin.idl">mailnews/base/search/public/nsIMsgFilterPlugin.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/base/search/public/nsIMsgFilterPlugin.idl">file</a> |
<a href="/comm-central/annotate/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/base/search/public/nsIMsgFilterPlugin.idl">annotate</a> |
<a href="/comm-central/diff/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/base/search/public/nsIMsgFilterPlugin.idl">diff</a> |
<a href="/comm-central/comparison/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/base/search/public/nsIMsgFilterPlugin.idl">comparison</a> |
<a href="/comm-central/log/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/base/search/public/nsIMsgFilterPlugin.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/base/search/public/nsIMsgTraitService.idl">mailnews/base/search/public/nsIMsgTraitService.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/base/search/public/nsIMsgTraitService.idl">file</a> |
<a href="/comm-central/annotate/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/base/search/public/nsIMsgTraitService.idl">annotate</a> |
<a href="/comm-central/diff/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/base/search/public/nsIMsgTraitService.idl">diff</a> |
<a href="/comm-central/comparison/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/base/search/public/nsIMsgTraitService.idl">comparison</a> |
<a href="/comm-central/log/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/base/search/public/nsIMsgTraitService.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/base/search/src/nsMsgTraitService.js">mailnews/base/search/src/nsMsgTraitService.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/base/search/src/nsMsgTraitService.js">file</a> |
<a href="/comm-central/annotate/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/base/search/src/nsMsgTraitService.js">annotate</a> |
<a href="/comm-central/diff/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/base/search/src/nsMsgTraitService.js">diff</a> |
<a href="/comm-central/comparison/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/base/search/src/nsMsgTraitService.js">comparison</a> |
<a href="/comm-central/log/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/base/search/src/nsMsgTraitService.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/base/test/unit/test_nsMsgTraitService.js">mailnews/base/test/unit/test_nsMsgTraitService.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/base/test/unit/test_nsMsgTraitService.js">file</a> |
<a href="/comm-central/annotate/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/base/test/unit/test_nsMsgTraitService.js">annotate</a> |
<a href="/comm-central/diff/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/base/test/unit/test_nsMsgTraitService.js">diff</a> |
<a href="/comm-central/comparison/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/base/test/unit/test_nsMsgTraitService.js">comparison</a> |
<a href="/comm-central/log/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/base/test/unit/test_nsMsgTraitService.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.cpp">mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.cpp">file</a> |
<a href="/comm-central/annotate/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.cpp">annotate</a> |
<a href="/comm-central/diff/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.cpp">diff</a> |
<a href="/comm-central/comparison/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.cpp">comparison</a> |
<a href="/comm-central/log/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.h">mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.h">file</a> |
<a href="/comm-central/annotate/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.h">annotate</a> |
<a href="/comm-central/diff/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.h">diff</a> |
<a href="/comm-central/comparison/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.h">comparison</a> |
<a href="/comm-central/log/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/extensions/bayesian-spam-filter/test/unit/resources/aliases.dat">mailnews/extensions/bayesian-spam-filter/test/unit/resources/aliases.dat</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/extensions/bayesian-spam-filter/test/unit/resources/aliases.dat">file</a> |
<a href="/comm-central/annotate/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/extensions/bayesian-spam-filter/test/unit/resources/aliases.dat">annotate</a> |
<a href="/comm-central/diff/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/extensions/bayesian-spam-filter/test/unit/resources/aliases.dat">diff</a> |
<a href="/comm-central/comparison/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/extensions/bayesian-spam-filter/test/unit/resources/aliases.dat">comparison</a> |
<a href="/comm-central/log/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/extensions/bayesian-spam-filter/test/unit/resources/aliases.dat">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/extensions/bayesian-spam-filter/test/unit/resources/aliases1.eml">mailnews/extensions/bayesian-spam-filter/test/unit/resources/aliases1.eml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/extensions/bayesian-spam-filter/test/unit/resources/aliases1.eml">file</a> |
<a href="/comm-central/annotate/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/extensions/bayesian-spam-filter/test/unit/resources/aliases1.eml">annotate</a> |
<a href="/comm-central/diff/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/extensions/bayesian-spam-filter/test/unit/resources/aliases1.eml">diff</a> |
<a href="/comm-central/comparison/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/extensions/bayesian-spam-filter/test/unit/resources/aliases1.eml">comparison</a> |
<a href="/comm-central/log/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/extensions/bayesian-spam-filter/test/unit/resources/aliases1.eml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/extensions/bayesian-spam-filter/test/unit/resources/aliases2.eml">mailnews/extensions/bayesian-spam-filter/test/unit/resources/aliases2.eml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/extensions/bayesian-spam-filter/test/unit/resources/aliases2.eml">file</a> |
<a href="/comm-central/annotate/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/extensions/bayesian-spam-filter/test/unit/resources/aliases2.eml">annotate</a> |
<a href="/comm-central/diff/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/extensions/bayesian-spam-filter/test/unit/resources/aliases2.eml">diff</a> |
<a href="/comm-central/comparison/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/extensions/bayesian-spam-filter/test/unit/resources/aliases2.eml">comparison</a> |
<a href="/comm-central/log/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/extensions/bayesian-spam-filter/test/unit/resources/aliases2.eml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/extensions/bayesian-spam-filter/test/unit/resources/aliases3.eml">mailnews/extensions/bayesian-spam-filter/test/unit/resources/aliases3.eml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/extensions/bayesian-spam-filter/test/unit/resources/aliases3.eml">file</a> |
<a href="/comm-central/annotate/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/extensions/bayesian-spam-filter/test/unit/resources/aliases3.eml">annotate</a> |
<a href="/comm-central/diff/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/extensions/bayesian-spam-filter/test/unit/resources/aliases3.eml">diff</a> |
<a href="/comm-central/comparison/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/extensions/bayesian-spam-filter/test/unit/resources/aliases3.eml">comparison</a> |
<a href="/comm-central/log/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/extensions/bayesian-spam-filter/test/unit/resources/aliases3.eml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/extensions/bayesian-spam-filter/test/unit/resources/msgCorpus.dat">mailnews/extensions/bayesian-spam-filter/test/unit/resources/msgCorpus.dat</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/extensions/bayesian-spam-filter/test/unit/resources/msgCorpus.dat">file</a> |
<a href="/comm-central/annotate/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/extensions/bayesian-spam-filter/test/unit/resources/msgCorpus.dat">annotate</a> |
<a href="/comm-central/diff/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/extensions/bayesian-spam-filter/test/unit/resources/msgCorpus.dat">diff</a> |
<a href="/comm-central/comparison/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/extensions/bayesian-spam-filter/test/unit/resources/msgCorpus.dat">comparison</a> |
<a href="/comm-central/log/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/extensions/bayesian-spam-filter/test/unit/resources/msgCorpus.dat">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/extensions/bayesian-spam-filter/test/unit/test_junkAsTraits.js">mailnews/extensions/bayesian-spam-filter/test/unit/test_junkAsTraits.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/extensions/bayesian-spam-filter/test/unit/test_junkAsTraits.js">file</a> |
<a href="/comm-central/annotate/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/extensions/bayesian-spam-filter/test/unit/test_junkAsTraits.js">annotate</a> |
<a href="/comm-central/diff/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/extensions/bayesian-spam-filter/test/unit/test_junkAsTraits.js">diff</a> |
<a href="/comm-central/comparison/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/extensions/bayesian-spam-filter/test/unit/test_junkAsTraits.js">comparison</a> |
<a href="/comm-central/log/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/extensions/bayesian-spam-filter/test/unit/test_junkAsTraits.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/extensions/bayesian-spam-filter/test/unit/test_msgCorpus.js">mailnews/extensions/bayesian-spam-filter/test/unit/test_msgCorpus.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/extensions/bayesian-spam-filter/test/unit/test_msgCorpus.js">file</a> |
<a href="/comm-central/annotate/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/extensions/bayesian-spam-filter/test/unit/test_msgCorpus.js">annotate</a> |
<a href="/comm-central/diff/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/extensions/bayesian-spam-filter/test/unit/test_msgCorpus.js">diff</a> |
<a href="/comm-central/comparison/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/extensions/bayesian-spam-filter/test/unit/test_msgCorpus.js">comparison</a> |
<a href="/comm-central/log/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/extensions/bayesian-spam-filter/test/unit/test_msgCorpus.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/extensions/bayesian-spam-filter/test/unit/test_traitAliases.js">mailnews/extensions/bayesian-spam-filter/test/unit/test_traitAliases.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/extensions/bayesian-spam-filter/test/unit/test_traitAliases.js">file</a> |
<a href="/comm-central/annotate/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/extensions/bayesian-spam-filter/test/unit/test_traitAliases.js">annotate</a> |
<a href="/comm-central/diff/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/extensions/bayesian-spam-filter/test/unit/test_traitAliases.js">diff</a> |
<a href="/comm-central/comparison/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/extensions/bayesian-spam-filter/test/unit/test_traitAliases.js">comparison</a> |
<a href="/comm-central/log/5de0a596f65c6b3a96a11a241a27676684a6fee6/mailnews/extensions/bayesian-spam-filter/test/unit/test_traitAliases.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/base/search/public/nsIMsgFilterPlugin.idl</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/base/search/public/nsIMsgFilterPlugin.idl</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -40,16 +40,17 @@</span>
<a href="#l1.4"></a><span id="l1.4"> </span>
<a href="#l1.5"></a><span id="l1.5"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l1.6"></a><span id="l1.6"> #include &quot;MailNewsTypes2.idl&quot;</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8"> interface nsIMsgFilterHitNotify;</span>
<a href="#l1.9"></a><span id="l1.9"> interface nsIMsgWindow;</span>
<a href="#l1.10"></a><span id="l1.10"> interface nsIMsgDBHdr;</span>
<a href="#l1.11"></a><span id="l1.11"> interface nsIStreamListener;</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+interface nsILocalFile;</span>
<a href="#l1.13"></a><span id="l1.13"> </span>
<a href="#l1.14"></a><span id="l1.14"> /**</span>
<a href="#l1.15"></a><span id="l1.15">  * This interface is still very much under development, and is not yet stable.</span>
<a href="#l1.16"></a><span id="l1.16">  */</span>
<a href="#l1.17"></a><span id="l1.17"> </span>
<a href="#l1.18"></a><span id="l1.18"> [scriptable, uuid(e2e56690-a676-11d6-80c9-00008646b737)]</span>
<a href="#l1.19"></a><span id="l1.19"> interface nsIMsgFilterPlugin : nsISupports</span>
<a href="#l1.20"></a><span id="l1.20"> {</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineat">@@ -140,17 +141,17 @@ interface nsIMsgTraitDetailListener : ns</span>
<a href="#l1.22"></a><span id="l1.22">   void onMessageTraitDetails(in string aMsgUri,</span>
<a href="#l1.23"></a><span id="l1.23">     in unsigned long aProTrait,</span>
<a href="#l1.24"></a><span id="l1.24">     in unsigned long tokenCount,</span>
<a href="#l1.25"></a><span id="l1.25">     [array, size_is(tokenCount)] in wstring tokenStrings,</span>
<a href="#l1.26"></a><span id="l1.26">     [array, size_is(tokenCount)] in unsigned long tokenPercents,</span>
<a href="#l1.27"></a><span id="l1.27">     [array, size_is(tokenCount)] in unsigned long runningPercents);</span>
<a href="#l1.28"></a><span id="l1.28"> };</span>
<a href="#l1.29"></a><span id="l1.29"> </span>
<a href="#l1.30"></a><span id="l1.30" class="difflineminus">-[scriptable, uuid(EDB05079-3F8A-46a6-A596-E7FD8E12216B)]</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+[scriptable, uuid(8EA5BBCA-F735-4d43-8541-D203D8E2FF2F)]</span>
<a href="#l1.32"></a><span id="l1.32"> interface nsIJunkMailPlugin : nsIMsgFilterPlugin</span>
<a href="#l1.33"></a><span id="l1.33"> {</span>
<a href="#l1.34"></a><span id="l1.34">     /**</span>
<a href="#l1.35"></a><span id="l1.35">      * Message classifications.</span>
<a href="#l1.36"></a><span id="l1.36">      */</span>
<a href="#l1.37"></a><span id="l1.37">     const nsMsgJunkStatus UNCLASSIFIED = 0;</span>
<a href="#l1.38"></a><span id="l1.38">     const nsMsgJunkStatus GOOD = 1;</span>
<a href="#l1.39"></a><span id="l1.39">     const nsMsgJunkStatus JUNK = 2;</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineat">@@ -302,20 +303,85 @@ interface nsIJunkMailPlugin : nsIMsgFilt</span>
<a href="#l1.41"></a><span id="l1.41">      */</span>
<a href="#l1.42"></a><span id="l1.42">     void detailMessage(</span>
<a href="#l1.43"></a><span id="l1.43">         in string aMsgURI,</span>
<a href="#l1.44"></a><span id="l1.44">         in unsigned long aProTrait,</span>
<a href="#l1.45"></a><span id="l1.45">         in unsigned long aAntiTrait,</span>
<a href="#l1.46"></a><span id="l1.46">         in nsIMsgTraitDetailListener aListener,</span>
<a href="#l1.47"></a><span id="l1.47">         [optional] in nsIMsgWindow aMsgWindow);</span>
<a href="#l1.48"></a><span id="l1.48"> </span>
<a href="#l1.49"></a><span id="l1.49" class="difflineminus">-    /**</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineminus">-     * Gives information on token and message count information in the</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineminus">-     * training data corpus</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineminus">-     *</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineminus">-     * @param aTrait           trait id (may be null)</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineminus">-     * @param aMessageCount    count of messages that have been trained with aTrait</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineminus">-     *</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineminus">-     * @return                 token count for all traits</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineminus">-     */</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineplus">+};</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineplus">+</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineplus">+/**</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineplus">+ * The nsIMsgCorpus interface manages a corpus of mail data used for</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineplus">+ * statistical analysis of messages.</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineplus">+ */</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineplus">+[scriptable, uuid(70BAD26F-DFD4-41bd-8FAB-4C09B9C1E845)]</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineplus">+interface nsIMsgCorpus : nsISupports</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineplus">+{</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineplus">+  /**</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineplus">+   * Clear the corpus data for a trait id.</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineplus">+   *</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineplus">+   * @param aTrait       trait id</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineplus">+   */</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineplus">+   void clearTrait(in unsigned long aTrait);</span>
<a href="#l1.73"></a><span id="l1.73"> </span>
<a href="#l1.74"></a><span id="l1.74" class="difflineminus">-    unsigned long corpusCounts(in unsigned long aTrait, out unsigned long aMessageCount);</span>
<a href="#l1.75"></a><span id="l1.75" class="difflineplus">+  /**</span>
<a href="#l1.76"></a><span id="l1.76" class="difflineplus">+   * Update corpus data from a file.</span>
<a href="#l1.77"></a><span id="l1.77" class="difflineplus">+   *</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineplus">+   * @param aFile       the file with the data, in the format:</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineplus">+   *</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineplus">+   *                    Format of the trait file for version 1:</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineplus">+   *                    [0xFCA93601]  (the 01 is the version)</span>
<a href="#l1.82"></a><span id="l1.82" class="difflineplus">+   *                    for each trait to write:</span>
<a href="#l1.83"></a><span id="l1.83" class="difflineplus">+   *                    [id of trait to write] (0 means end of list)</span>
<a href="#l1.84"></a><span id="l1.84" class="difflineplus">+   *                    [number of messages per trait]</span>
<a href="#l1.85"></a><span id="l1.85" class="difflineplus">+   *                    for each token with non-zero count</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineplus">+   *                    [count]</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineplus">+   *                    [length of word]word</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineplus">+   *</span>
<a href="#l1.89"></a><span id="l1.89" class="difflineplus">+   * @param aIsAdd      should the data be added, or removed? True if</span>
<a href="#l1.90"></a><span id="l1.90" class="difflineplus">+   *                    adding, false if removing.</span>
<a href="#l1.91"></a><span id="l1.91" class="difflineplus">+   *</span>
<a href="#l1.92"></a><span id="l1.92" class="difflineplus">+   * @param aRemapCount number of items in the parallel arrays aFromTraits,</span>
<a href="#l1.93"></a><span id="l1.93" class="difflineplus">+   *                    aToTraits. These arrays allow conversion of the</span>
<a href="#l1.94"></a><span id="l1.94" class="difflineplus">+   *                    trait id stored in the file (which may be originated</span>
<a href="#l1.95"></a><span id="l1.95" class="difflineplus">+   *                    externally) to the trait id used in the local corpus</span>
<a href="#l1.96"></a><span id="l1.96" class="difflineplus">+   *                    (which is defined locally using nsIMsgTraitService, and</span>
<a href="#l1.97"></a><span id="l1.97" class="difflineplus">+   *                    mapped by that interface to a globally unique trait</span>
<a href="#l1.98"></a><span id="l1.98" class="difflineplus">+   *                    id string).</span>
<a href="#l1.99"></a><span id="l1.99" class="difflineplus">+   *</span>
<a href="#l1.100"></a><span id="l1.100" class="difflineplus">+   * @param aFromTraits array of trait ids used in aFile. If aFile contains</span>
<a href="#l1.101"></a><span id="l1.101" class="difflineplus">+   *                    trait ids that are not in this array, they are not</span>
<a href="#l1.102"></a><span id="l1.102" class="difflineplus">+   *                    remapped, but assummed to be local trait ids.</span>
<a href="#l1.103"></a><span id="l1.103" class="difflineplus">+   *</span>
<a href="#l1.104"></a><span id="l1.104" class="difflineplus">+   * @param aToTraits   array of trait ids, corresponding to elements of</span>
<a href="#l1.105"></a><span id="l1.105" class="difflineplus">+   *                    aFromTraits, that represent the local trait ids to</span>
<a href="#l1.106"></a><span id="l1.106" class="difflineplus">+   *                    be used in storing data from aFile into the local corpus.</span>
<a href="#l1.107"></a><span id="l1.107" class="difflineplus">+   */</span>
<a href="#l1.108"></a><span id="l1.108" class="difflineplus">+  void updateData(in nsILocalFile aFile, in boolean aIsAdd,</span>
<a href="#l1.109"></a><span id="l1.109" class="difflineplus">+                  [optional] in unsigned long aRemapCount,</span>
<a href="#l1.110"></a><span id="l1.110" class="difflineplus">+                  [optional, array, size_is(aRemapCount)] in unsigned long aFromTraits,</span>
<a href="#l1.111"></a><span id="l1.111" class="difflineplus">+                  [optional, array, size_is(aRemapCount)] in unsigned long aToTraits);</span>
<a href="#l1.112"></a><span id="l1.112" class="difflineplus">+</span>
<a href="#l1.113"></a><span id="l1.113" class="difflineplus">+  /**</span>
<a href="#l1.114"></a><span id="l1.114" class="difflineplus">+   * Get the corpus count for a token as a string.</span>
<a href="#l1.115"></a><span id="l1.115" class="difflineplus">+   *</span>
<a href="#l1.116"></a><span id="l1.116" class="difflineplus">+   * @param aWord    string of characters representing the token</span>
<a href="#l1.117"></a><span id="l1.117" class="difflineplus">+   * @param aTrait   trait id</span>
<a href="#l1.118"></a><span id="l1.118" class="difflineplus">+   *</span>
<a href="#l1.119"></a><span id="l1.119" class="difflineplus">+   * @return         count of that token in the corpus</span>
<a href="#l1.120"></a><span id="l1.120" class="difflineplus">+   *</span>
<a href="#l1.121"></a><span id="l1.121" class="difflineplus">+   */</span>
<a href="#l1.122"></a><span id="l1.122" class="difflineplus">+  unsigned long getTokenCount(in AUTF8String aWord, in unsigned long aTrait);</span>
<a href="#l1.123"></a><span id="l1.123" class="difflineplus">+</span>
<a href="#l1.124"></a><span id="l1.124" class="difflineplus">+  /**</span>
<a href="#l1.125"></a><span id="l1.125" class="difflineplus">+   * Gives information on token and message count information in the</span>
<a href="#l1.126"></a><span id="l1.126" class="difflineplus">+   * training data corpus.</span>
<a href="#l1.127"></a><span id="l1.127" class="difflineplus">+   *</span>
<a href="#l1.128"></a><span id="l1.128" class="difflineplus">+   * @param aTrait           trait id (may be null)</span>
<a href="#l1.129"></a><span id="l1.129" class="difflineplus">+   * @param aMessageCount    count of messages that have been trained with aTrait</span>
<a href="#l1.130"></a><span id="l1.130" class="difflineplus">+   *</span>
<a href="#l1.131"></a><span id="l1.131" class="difflineplus">+   * @return                 token count for all traits</span>
<a href="#l1.132"></a><span id="l1.132" class="difflineplus">+   */</span>
<a href="#l1.133"></a><span id="l1.133" class="difflineplus">+</span>
<a href="#l1.134"></a><span id="l1.134" class="difflineplus">+  unsigned long corpusCounts(in unsigned long aTrait, out unsigned long aMessageCount);</span>
<a href="#l1.135"></a><span id="l1.135"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/base/search/public/nsIMsgTraitService.idl</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/base/search/public/nsIMsgTraitService.idl</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -44,17 +44,17 @@</span>
<a href="#l2.4"></a><span id="l2.4">   * provide the mapping between those forms.</span>
<a href="#l2.5"></a><span id="l2.5">   *</span>
<a href="#l2.6"></a><span id="l2.6">   * Recommended (but not required) format for id:</span>
<a href="#l2.7"></a><span id="l2.7">   * &quot;extensionName@example.org#traitName&quot;</span>
<a href="#l2.8"></a><span id="l2.8">   */</span>
<a href="#l2.9"></a><span id="l2.9"> </span>
<a href="#l2.10"></a><span id="l2.10"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-[scriptable, uuid(e3e47690-a676-12d6-81c9-00308646b737)]</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+[scriptable, uuid(2CB15FB0-A912-40d3-8882-F2765C75655F)]</span>
<a href="#l2.14"></a><span id="l2.14"> interface nsIMsgTraitService : nsISupports</span>
<a href="#l2.15"></a><span id="l2.15"> {</span>
<a href="#l2.16"></a><span id="l2.16">   /**</span>
<a href="#l2.17"></a><span id="l2.17">    *  the highest ever index for a registered trait. The first trait is 1,</span>
<a href="#l2.18"></a><span id="l2.18">    *  == 0 means no traits are defined</span>
<a href="#l2.19"></a><span id="l2.19">    */</span>
<a href="#l2.20"></a><span id="l2.20">   readonly attribute long lastIndex;</span>
<a href="#l2.21"></a><span id="l2.21"> </span>
<a href="#l2.22"></a><span id="l2.22" class="difflineat">@@ -167,9 +167,40 @@ interface nsIMsgTraitService : nsISuppor</span>
<a href="#l2.23"></a><span id="l2.23">    *</span>
<a href="#l2.24"></a><span id="l2.24">    * @param count        length of proIndices and antiIndices arrays</span>
<a href="#l2.25"></a><span id="l2.25">    * @param proIndices   trait internal index for &quot;pro&quot; trait to analyze</span>
<a href="#l2.26"></a><span id="l2.26">    * @param antiIndices  trait internal index for corresponding &quot;anti&quot; traits</span>
<a href="#l2.27"></a><span id="l2.27">    */</span>
<a href="#l2.28"></a><span id="l2.28">   void getEnabledIndices(out unsigned long count,</span>
<a href="#l2.29"></a><span id="l2.29">                          [array, size_is(count)] out unsigned long proIndices,</span>
<a href="#l2.30"></a><span id="l2.30">                          [array, size_is(count)] out unsigned long antiIndices);</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+  /**</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+   * Add a trait as an alias of another trait. An alias is a trait whose</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+   * counts will be combined with the aliased trait. This allows multiple sets</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+   * of corpus data to be used to provide information on a single message</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+   * characteristic, while allowing each individual set of corpus data to</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+   * retain its own identity.</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+   *</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+   * @param aTraitIndex  the internal identifier for the aliased trait</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+   * @param aTraitAlias  the internal identifier for the alias to add</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+   */</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+  void addAlias(in unsigned long aTraitIndex, in unsigned long aTraitAlias);</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineplus">+</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineplus">+  /**</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineplus">+   * Removes a trait as an alias of another trait.</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineplus">+   *</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineplus">+   * @param aTraitIndex  the internal identifier for the aliased trait</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineplus">+   * @param aTraitAlias  the internal identifier for the alias to remove</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineplus">+   */</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineplus">+  void removeAlias(in unsigned long aTraitIndex, in unsigned long aTraitAlias);</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineplus">+  /**</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineplus">+   * Get an array of trait aliases for a trait index, if any</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineplus">+   *</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+   * @param aTraitIndex  the internal identifier for the aliased trait</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineplus">+   * @param aLength      length of array of aliases</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineplus">+   * @param aAliases     array of internal identifiers for aliases</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineplus">+   */</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+  void getAliases(in unsigned long aTraitIndex, out unsigned long aLength,</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineplus">+                  [retval, array, size_is(aLength)] out unsigned long aAliases);</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineplus">+</span>
<a href="#l2.62"></a><span id="l2.62"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgTraitService.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgTraitService.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -160,16 +160,74 @@ nsMsgTraitService.prototype =</span>
<a href="#l3.4"></a><span id="l3.4">         proIndices.push(_traits[id].index);</span>
<a href="#l3.5"></a><span id="l3.5">         antiIndices.push(_traits[_traits[id].antiId].index);</span>
<a href="#l3.6"></a><span id="l3.6">       }</span>
<a href="#l3.7"></a><span id="l3.7">     aCount.value = proIndices.length;</span>
<a href="#l3.8"></a><span id="l3.8">     aProIndices.value = proIndices;</span>
<a href="#l3.9"></a><span id="l3.9">     aAntiIndices.value = antiIndices;</span>
<a href="#l3.10"></a><span id="l3.10">     return;</span>
<a href="#l3.11"></a><span id="l3.11">   },</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+  addAlias: function addAlias(aTraitIndex, aTraitAliasIndex)</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+  {</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+    let aliasesString = &quot;&quot;;</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+    try {</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+      aliasesString = traitsBranch.getCharPref(&quot;aliases.&quot; + aTraitIndex);</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+    }</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+    catch (e) {}</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+    let aliases;</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+    if (aliasesString.length)</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+      aliases = aliasesString.split(&quot;,&quot;);</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+    else</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+      aliases = [];</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+    if (aliases.indexOf(aTraitAliasIndex.toString()) == -1)</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+    {</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+      aliases.push(aTraitAliasIndex);</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+      traitsBranch.setCharPref(&quot;aliases.&quot; + aTraitIndex, aliases.join());</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineplus">+    }</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+  },</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+  removeAlias: function removeAlias(aTraitIndex, aTraitAliasIndex)</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+  {</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+    let aliasesString = &quot;&quot;;</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+    try {</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+      aliasesString = traitsBranch.getCharPref(&quot;aliases.&quot; + aTraitIndex);</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+    }</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+    catch (e) {</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+      return;</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+    }</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+    let aliases;</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+    if (aliasesString.length)</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+      aliases = aliasesString.split(&quot;,&quot;);</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+    else</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+      aliases = [];</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineplus">+    let location;</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+    if ((location = aliases.indexOf(aTraitAliasIndex.toString())) != -1)</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineplus">+    {</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineplus">+      aliases.splice(location, 1);</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+      traitsBranch.setCharPref(&quot;aliases.&quot; + aTraitIndex, aliases.join());</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+    }</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineplus">+  },</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineplus">+</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineplus">+  getAliases: function getAliases(aTraitIndex, aLength)</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineplus">+  {</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineplus">+    let aliasesString = &quot;&quot;;</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineplus">+    try {</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineplus">+      aliasesString = traitsBranch.getCharPref(&quot;aliases.&quot; + aTraitIndex);</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineplus">+    }</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineplus">+    catch (e) {}</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineplus">+    let aliases;</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineplus">+    if (aliasesString.length)</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineplus">+      aliases = aliasesString.split(&quot;,&quot;);</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineplus">+    else</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineplus">+      aliases = [];</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineplus">+    aLength.value = aliases.length;</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineplus">+    return aliases;</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineplus">+  },</span>
<a href="#l3.70"></a><span id="l3.70"> };</span>
<a href="#l3.71"></a><span id="l3.71"> </span>
<a href="#l3.72"></a><span id="l3.72"> // initialization</span>
<a href="#l3.73"></a><span id="l3.73"> </span>
<a href="#l3.74"></a><span id="l3.74"> _init();</span>
<a href="#l3.75"></a><span id="l3.75"> </span>
<a href="#l3.76"></a><span id="l3.76"> function _init()</span>
<a href="#l3.77"></a><span id="l3.77"> {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/base/test/unit/test_nsMsgTraitService.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_nsMsgTraitService.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -85,16 +85,40 @@ function run_test()</span>
<a href="#l4.4"></a><span id="l4.4">   var proArray = {};</span>
<a href="#l4.5"></a><span id="l4.5">   var antiArray = {};</span>
<a href="#l4.6"></a><span id="l4.6">   ts.getEnabledIndices({}, proArray, antiArray);</span>
<a href="#l4.7"></a><span id="l4.7">   do_check_eq(proArray.value.length, 2);</span>
<a href="#l4.8"></a><span id="l4.8">   do_check_eq(antiArray.value.length, 2);</span>
<a href="#l4.9"></a><span id="l4.9">   do_check_eq(proArray.value[1], proIndex);</span>
<a href="#l4.10"></a><span id="l4.10">   do_check_eq(antiArray.value[1], antiIndex);</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+  // check of aliases</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+  // add three random aliases</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+  ts.addAlias(1, 501);</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+  ts.addAlias(1, 502);</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+  ts.addAlias(1, 601);</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+  let aliases = ts.getAliases(1, {});</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+  do_check_eq(aliases[0], 501);</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+  do_check_eq(aliases[1], 502);</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+  do_check_eq(aliases[2], 601);</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+  // remove the middle one</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+  ts.removeAlias(1, 502);</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+  aliases = ts.getAliases(1, {});</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+  do_check_eq(aliases.length, 2);</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineplus">+  do_check_eq(aliases[0], 501);</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineplus">+  do_check_eq(aliases[1], 601);</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+  // try to add an existing value</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+  ts.addAlias(1, 501);</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+  aliases = ts.getAliases(1, {});</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+  do_check_eq(aliases.length, 2);</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+  do_check_eq(aliases[0], 501);</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+  do_check_eq(aliases[1], 601);</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+</span>
<a href="#l4.36"></a><span id="l4.36">   // now let's make sure this got saved in preferences</span>
<a href="#l4.37"></a><span id="l4.37">   do_check_eq(proId, traitsBranch.getCharPref(&quot;id.&quot; + proIndex));</span>
<a href="#l4.38"></a><span id="l4.38">   do_check_eq(proName, traitsBranch.getCharPref(&quot;name.&quot; + proIndex));</span>
<a href="#l4.39"></a><span id="l4.39">   do_check_true(traitsBranch.getBoolPref(&quot;enabled.&quot; + proIndex));</span>
<a href="#l4.40"></a><span id="l4.40">   do_check_eq(antiId, traitsBranch.getCharPref(&quot;antiId.&quot; + proIndex));</span>
<a href="#l4.41"></a><span id="l4.41"> </span>
<a href="#l4.42"></a><span id="l4.42">   // remove the pro trait</span>
<a href="#l4.43"></a><span id="l4.43">   ts.unRegisterTrait(proId);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.cpp</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.cpp</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -82,16 +82,17 @@</span>
<a href="#l5.4"></a><span id="l5.4"> #include &quot;nsIContentSerializer.h&quot;</span>
<a href="#l5.5"></a><span id="l5.5"> #include &quot;nsLayoutCID.h&quot;</span>
<a href="#l5.6"></a><span id="l5.6"> #include &quot;nsIHTMLToTextSink.h&quot;</span>
<a href="#l5.7"></a><span id="l5.7"> #include &quot;nsIDocumentEncoder.h&quot;</span>
<a href="#l5.8"></a><span id="l5.8"> </span>
<a href="#l5.9"></a><span id="l5.9"> #include &quot;nsIncompleteGamma.h&quot;</span>
<a href="#l5.10"></a><span id="l5.10"> #include &lt;math.h&gt;</span>
<a href="#l5.11"></a><span id="l5.11"> #include &lt;prmem.h&gt;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+#include &quot;nsIMsgTraitService.h&quot;</span>
<a href="#l5.13"></a><span id="l5.13"> </span>
<a href="#l5.14"></a><span id="l5.14"> static PRLogModuleInfo *BayesianFilterLogModule = nsnull;</span>
<a href="#l5.15"></a><span id="l5.15"> </span>
<a href="#l5.16"></a><span id="l5.16"> static NS_DEFINE_CID(kParserCID, NS_PARSER_CID);</span>
<a href="#l5.17"></a><span id="l5.17"> </span>
<a href="#l5.18"></a><span id="l5.18"> #define kDefaultJunkThreshold .99 // we override this value via a pref</span>
<a href="#l5.19"></a><span id="l5.19"> static const char* kBayesianFilterTokenDelimiters = &quot; \t\n\r\f.&quot;;</span>
<a href="#l5.20"></a><span id="l5.20"> static int kMinLengthForToken = 3; // lower bound on the number of characters in a word before we treat it as a token</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineat">@@ -1196,17 +1197,18 @@ NS_IMETHODIMP TokenStreamListener::OnSto</span>
<a href="#l5.22"></a><span id="l5.22">     if (mAnalyzer)</span>
<a href="#l5.23"></a><span id="l5.23">         mAnalyzer-&gt;analyzeTokens(mTokenizer);</span>
<a href="#l5.24"></a><span id="l5.24"> </span>
<a href="#l5.25"></a><span id="l5.25">     return NS_OK;</span>
<a href="#l5.26"></a><span id="l5.26"> }</span>
<a href="#l5.27"></a><span id="l5.27"> </span>
<a href="#l5.28"></a><span id="l5.28"> /* Implementation file */</span>
<a href="#l5.29"></a><span id="l5.29"> </span>
<a href="#l5.30"></a><span id="l5.30" class="difflineminus">-NS_IMPL_ISUPPORTS2(nsBayesianFilter, nsIMsgFilterPlugin, nsIJunkMailPlugin)</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+NS_IMPL_ISUPPORTS3(nsBayesianFilter, nsIMsgFilterPlugin,</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+                   nsIJunkMailPlugin, nsIMsgCorpus)</span>
<a href="#l5.33"></a><span id="l5.33"> </span>
<a href="#l5.34"></a><span id="l5.34"> nsBayesianFilter::nsBayesianFilter()</span>
<a href="#l5.35"></a><span id="l5.35">     :   mTrainingDataDirty(PR_FALSE)</span>
<a href="#l5.36"></a><span id="l5.36"> {</span>
<a href="#l5.37"></a><span id="l5.37">     if (!BayesianFilterLogModule)</span>
<a href="#l5.38"></a><span id="l5.38">       BayesianFilterLogModule = PR_NewLogModule(&quot;BayesianFilter&quot;);</span>
<a href="#l5.39"></a><span id="l5.39"> </span>
<a href="#l5.40"></a><span id="l5.40">     PRInt32 junkThreshold = 0;</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineat">@@ -1293,17 +1295,17 @@ public:</span>
<a href="#l5.42"></a><span id="l5.42">                       nsIMsgTraitClassificationListener* aTraitListener,</span>
<a href="#l5.43"></a><span id="l5.43">                       nsIMsgTraitDetailListener* aDetailListener,</span>
<a href="#l5.44"></a><span id="l5.44">                       nsTArray&lt;PRUint32&gt;&amp; aProTraits,</span>
<a href="#l5.45"></a><span id="l5.45">                       nsTArray&lt;PRUint32&gt;&amp; aAntiTraits,</span>
<a href="#l5.46"></a><span id="l5.46">                       nsIMsgWindow *aMsgWindow,</span>
<a href="#l5.47"></a><span id="l5.47">                       PRUint32 aNumMessagesToClassify,</span>
<a href="#l5.48"></a><span id="l5.48">                       const char **aMessageURIs)</span>
<a href="#l5.49"></a><span id="l5.49">     :   mFilter(aFilter),</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineminus">-        mSupports(aFilter),</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineplus">+        mJunkMailPlugin(aFilter),</span>
<a href="#l5.52"></a><span id="l5.52">         mJunkListener(aJunkListener),</span>
<a href="#l5.53"></a><span id="l5.53">         mTraitListener(aTraitListener),</span>
<a href="#l5.54"></a><span id="l5.54">         mDetailListener(aDetailListener),</span>
<a href="#l5.55"></a><span id="l5.55">         mProTraits(aProTraits),</span>
<a href="#l5.56"></a><span id="l5.56">         mAntiTraits(aAntiTraits),</span>
<a href="#l5.57"></a><span id="l5.57">         mMsgWindow(aMsgWindow)</span>
<a href="#l5.58"></a><span id="l5.58">     {</span>
<a href="#l5.59"></a><span id="l5.59">       mCurMessageToClassify = 0;</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineat">@@ -1316,17 +1318,17 @@ public:</span>
<a href="#l5.61"></a><span id="l5.61"> </span>
<a href="#l5.62"></a><span id="l5.62">     // junk-only classifier</span>
<a href="#l5.63"></a><span id="l5.63">     MessageClassifier(nsBayesianFilter* aFilter,</span>
<a href="#l5.64"></a><span id="l5.64">                       nsIJunkMailClassificationListener* aJunkListener,</span>
<a href="#l5.65"></a><span id="l5.65">                       nsIMsgWindow *aMsgWindow,</span>
<a href="#l5.66"></a><span id="l5.66">                       PRUint32 aNumMessagesToClassify,</span>
<a href="#l5.67"></a><span id="l5.67">                       const char **aMessageURIs)</span>
<a href="#l5.68"></a><span id="l5.68">     :   mFilter(aFilter),</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineminus">-        mSupports(aFilter),</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineplus">+        mJunkMailPlugin(aFilter),</span>
<a href="#l5.71"></a><span id="l5.71">         mJunkListener(aJunkListener),</span>
<a href="#l5.72"></a><span id="l5.72">         mTraitListener(nsnull),</span>
<a href="#l5.73"></a><span id="l5.73">         mDetailListener(nsnull),</span>
<a href="#l5.74"></a><span id="l5.74">         mMsgWindow(aMsgWindow)</span>
<a href="#l5.75"></a><span id="l5.75">     {</span>
<a href="#l5.76"></a><span id="l5.76">       mCurMessageToClassify = 0;</span>
<a href="#l5.77"></a><span id="l5.77">       mNumMessagesToClassify = aNumMessagesToClassify;</span>
<a href="#l5.78"></a><span id="l5.78">       mMessageURIs = (char **) nsMemory::Alloc(sizeof(char *) * aNumMessagesToClassify);</span>
<a href="#l5.79"></a><span id="l5.79" class="difflineat">@@ -1373,17 +1375,17 @@ public:</span>
<a href="#l5.80"></a><span id="l5.80">           mTraitListener-&gt;OnMessageTraitsClassified(nsnull, nsnull, nsnull, nsnull);</span>
<a href="#l5.81"></a><span id="l5.81">         mTokenListener = nsnull; // this breaks the circular ref that keeps this object alive</span>
<a href="#l5.82"></a><span id="l5.82">                                  // so we will be destroyed as a result.</span>
<a href="#l5.83"></a><span id="l5.83">       }</span>
<a href="#l5.84"></a><span id="l5.84">     }</span>
<a href="#l5.85"></a><span id="l5.85"> </span>
<a href="#l5.86"></a><span id="l5.86"> private:</span>
<a href="#l5.87"></a><span id="l5.87">     nsBayesianFilter* mFilter;</span>
<a href="#l5.88"></a><span id="l5.88" class="difflineminus">-    nsCOMPtr&lt;nsISupports&gt; mSupports;</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineplus">+    nsCOMPtr&lt;nsIJunkMailPlugin&gt; mJunkMailPlugin;</span>
<a href="#l5.90"></a><span id="l5.90">     nsCOMPtr&lt;nsIJunkMailClassificationListener&gt; mJunkListener;</span>
<a href="#l5.91"></a><span id="l5.91">     nsCOMPtr&lt;nsIMsgTraitClassificationListener&gt; mTraitListener;</span>
<a href="#l5.92"></a><span id="l5.92">     nsCOMPtr&lt;nsIMsgTraitDetailListener&gt; mDetailListener;</span>
<a href="#l5.93"></a><span id="l5.93">     nsTArray&lt;PRUint32&gt; mProTraits;</span>
<a href="#l5.94"></a><span id="l5.94">     nsTArray&lt;PRUint32&gt; mAntiTraits;</span>
<a href="#l5.95"></a><span id="l5.95">     nsCOMPtr&lt;nsIMsgWindow&gt; mMsgWindow;</span>
<a href="#l5.96"></a><span id="l5.96">     PRInt32 mNumMessagesToClassify;</span>
<a href="#l5.97"></a><span id="l5.97">     PRInt32 mCurMessageToClassify; // 0-based index</span>
<a href="#l5.98"></a><span id="l5.98" class="difflineat">@@ -1485,47 +1487,112 @@ void nsBayesianFilter::classifyMessage(</span>
<a href="#l5.99"></a><span id="l5.99"> </span>
<a href="#l5.100"></a><span id="l5.100">     /* this part is similar to the Graham algorithm with some adjustments. */</span>
<a href="#l5.101"></a><span id="l5.101">     PRUint32 traitCount = aProTraits.Length();</span>
<a href="#l5.102"></a><span id="l5.102"> </span>
<a href="#l5.103"></a><span id="l5.103">     // pro message counts per trait index</span>
<a href="#l5.104"></a><span id="l5.104">     nsAutoTArray&lt;PRUint32, kTraitAutoCapacity&gt; numProMessages;</span>
<a href="#l5.105"></a><span id="l5.105">     // anti message counts per trait index</span>
<a href="#l5.106"></a><span id="l5.106">     nsAutoTArray&lt;PRUint32, kTraitAutoCapacity&gt; numAntiMessages;</span>
<a href="#l5.107"></a><span id="l5.107" class="difflineplus">+    // array of pro aliases per trait index</span>
<a href="#l5.108"></a><span id="l5.108" class="difflineplus">+    nsAutoTArray&lt;PRUint32*, kTraitAutoCapacity &gt; proAliasArrays;</span>
<a href="#l5.109"></a><span id="l5.109" class="difflineplus">+    // number of pro aliases per trait index</span>
<a href="#l5.110"></a><span id="l5.110" class="difflineplus">+    nsAutoTArray&lt;PRUint32, kTraitAutoCapacity &gt; proAliasesLengths;    </span>
<a href="#l5.111"></a><span id="l5.111" class="difflineplus">+    // array of anti aliases per trait index</span>
<a href="#l5.112"></a><span id="l5.112" class="difflineplus">+    nsAutoTArray&lt;PRUint32*, kTraitAutoCapacity&gt; antiAliasArrays;</span>
<a href="#l5.113"></a><span id="l5.113" class="difflineplus">+    // number of anti aliases per trait index</span>
<a href="#l5.114"></a><span id="l5.114" class="difflineplus">+    nsAutoTArray&lt;PRUint32, kTraitAutoCapacity &gt; antiAliasesLengths;    </span>
<a href="#l5.115"></a><span id="l5.115">     // construct the outgoing listener arrays</span>
<a href="#l5.116"></a><span id="l5.116">     nsAutoTArray&lt;PRUint32, kTraitAutoCapacity&gt; traits;</span>
<a href="#l5.117"></a><span id="l5.117">     nsAutoTArray&lt;PRUint32, kTraitAutoCapacity&gt; percents;</span>
<a href="#l5.118"></a><span id="l5.118">     if (traitCount &gt; kTraitAutoCapacity)</span>
<a href="#l5.119"></a><span id="l5.119">     {</span>
<a href="#l5.120"></a><span id="l5.120">       traits.SetCapacity(traitCount);</span>
<a href="#l5.121"></a><span id="l5.121">       percents.SetCapacity(traitCount);</span>
<a href="#l5.122"></a><span id="l5.122">       numProMessages.SetCapacity(traitCount);</span>
<a href="#l5.123"></a><span id="l5.123">       numAntiMessages.SetCapacity(traitCount);</span>
<a href="#l5.124"></a><span id="l5.124" class="difflineplus">+      proAliasesLengths.SetCapacity(traitCount);</span>
<a href="#l5.125"></a><span id="l5.125" class="difflineplus">+      antiAliasesLengths.SetCapacity(traitCount);</span>
<a href="#l5.126"></a><span id="l5.126" class="difflineplus">+      proAliasArrays.SetCapacity(traitCount);</span>
<a href="#l5.127"></a><span id="l5.127" class="difflineplus">+      antiAliasArrays.SetCapacity(traitCount);</span>
<a href="#l5.128"></a><span id="l5.128">     }</span>
<a href="#l5.129"></a><span id="l5.129"> </span>
<a href="#l5.130"></a><span id="l5.130" class="difflineplus">+    nsresult rv;</span>
<a href="#l5.131"></a><span id="l5.131" class="difflineplus">+    nsCOMPtr&lt;nsIMsgTraitService&gt; traitService(do_GetService(&quot;@mozilla.org/msg-trait-service;1&quot;, &amp;rv));</span>
<a href="#l5.132"></a><span id="l5.132" class="difflineplus">+    if (NS_FAILED(rv))</span>
<a href="#l5.133"></a><span id="l5.133" class="difflineplus">+    {</span>
<a href="#l5.134"></a><span id="l5.134" class="difflineplus">+      NS_ERROR(&quot;Failed to get trait service&quot;);</span>
<a href="#l5.135"></a><span id="l5.135" class="difflineplus">+      PR_LOG(BayesianFilterLogModule, PR_LOG_ERROR, (&quot;Failed to get trait service&quot;));</span>
<a href="#l5.136"></a><span id="l5.136" class="difflineplus">+    }</span>
<a href="#l5.137"></a><span id="l5.137" class="difflineplus">+</span>
<a href="#l5.138"></a><span id="l5.138" class="difflineplus">+    // get aliases and message counts for the pro and anti traits</span>
<a href="#l5.139"></a><span id="l5.139">     for (PRUint32 traitIndex = 0; traitIndex &lt; traitCount; traitIndex++)</span>
<a href="#l5.140"></a><span id="l5.140">     {</span>
<a href="#l5.141"></a><span id="l5.141" class="difflineminus">-      numProMessages.AppendElement(</span>
<a href="#l5.142"></a><span id="l5.142" class="difflineminus">-        mCorpus.getMessageCount(aProTraits[traitIndex]));</span>
<a href="#l5.143"></a><span id="l5.143" class="difflineminus">-      numAntiMessages.AppendElement(</span>
<a href="#l5.144"></a><span id="l5.144" class="difflineminus">-        mCorpus.getMessageCount(aAntiTraits[traitIndex]));</span>
<a href="#l5.145"></a><span id="l5.145" class="difflineplus">+      nsresult rv;</span>
<a href="#l5.146"></a><span id="l5.146" class="difflineplus">+</span>
<a href="#l5.147"></a><span id="l5.147" class="difflineplus">+      // pro trait</span>
<a href="#l5.148"></a><span id="l5.148" class="difflineplus">+      PRUint32 proAliasesLength = 0;</span>
<a href="#l5.149"></a><span id="l5.149" class="difflineplus">+      PRUint32* proAliases = nsnull;</span>
<a href="#l5.150"></a><span id="l5.150" class="difflineplus">+      PRUint32 proTrait = aProTraits[traitIndex];</span>
<a href="#l5.151"></a><span id="l5.151" class="difflineplus">+      if (traitService)</span>
<a href="#l5.152"></a><span id="l5.152" class="difflineplus">+      {</span>
<a href="#l5.153"></a><span id="l5.153" class="difflineplus">+        rv = traitService-&gt;GetAliases(proTrait, &amp;proAliasesLength, &amp;proAliases);</span>
<a href="#l5.154"></a><span id="l5.154" class="difflineplus">+        if (NS_FAILED(rv))</span>
<a href="#l5.155"></a><span id="l5.155" class="difflineplus">+        {</span>
<a href="#l5.156"></a><span id="l5.156" class="difflineplus">+          NS_ERROR(&quot;trait service failed to get aliases&quot;);</span>
<a href="#l5.157"></a><span id="l5.157" class="difflineplus">+          PR_LOG(BayesianFilterLogModule, PR_LOG_ERROR, (&quot;trait service failed to get aliases&quot;));</span>
<a href="#l5.158"></a><span id="l5.158" class="difflineplus">+        }</span>
<a href="#l5.159"></a><span id="l5.159" class="difflineplus">+      }</span>
<a href="#l5.160"></a><span id="l5.160" class="difflineplus">+      proAliasesLengths.AppendElement(proAliasesLength);</span>
<a href="#l5.161"></a><span id="l5.161" class="difflineplus">+      proAliasArrays.AppendElement(proAliases);</span>
<a href="#l5.162"></a><span id="l5.162" class="difflineplus">+      PRUint32 proMessageCount = mCorpus.getMessageCount(proTrait);</span>
<a href="#l5.163"></a><span id="l5.163" class="difflineplus">+      for (PRUint32 aliasIndex = 0; aliasIndex &lt; proAliasesLength; aliasIndex++)</span>
<a href="#l5.164"></a><span id="l5.164" class="difflineplus">+        proMessageCount += mCorpus.getMessageCount(proAliases[aliasIndex]);</span>
<a href="#l5.165"></a><span id="l5.165" class="difflineplus">+      numProMessages.AppendElement(proMessageCount);</span>
<a href="#l5.166"></a><span id="l5.166" class="difflineplus">+</span>
<a href="#l5.167"></a><span id="l5.167" class="difflineplus">+      // anti trait</span>
<a href="#l5.168"></a><span id="l5.168" class="difflineplus">+      PRUint32 antiAliasesLength = 0;</span>
<a href="#l5.169"></a><span id="l5.169" class="difflineplus">+      PRUint32* antiAliases = nsnull;</span>
<a href="#l5.170"></a><span id="l5.170" class="difflineplus">+      PRUint32 antiTrait = aAntiTraits[traitIndex];</span>
<a href="#l5.171"></a><span id="l5.171" class="difflineplus">+      if (traitService)</span>
<a href="#l5.172"></a><span id="l5.172" class="difflineplus">+      {</span>
<a href="#l5.173"></a><span id="l5.173" class="difflineplus">+        rv = traitService-&gt;GetAliases(antiTrait, &amp;antiAliasesLength, &amp;antiAliases);</span>
<a href="#l5.174"></a><span id="l5.174" class="difflineplus">+        if (NS_FAILED(rv))</span>
<a href="#l5.175"></a><span id="l5.175" class="difflineplus">+        {</span>
<a href="#l5.176"></a><span id="l5.176" class="difflineplus">+          NS_ERROR(&quot;trait service failed to get aliases&quot;);</span>
<a href="#l5.177"></a><span id="l5.177" class="difflineplus">+          PR_LOG(BayesianFilterLogModule, PR_LOG_ERROR, (&quot;trait service failed to get aliases&quot;));</span>
<a href="#l5.178"></a><span id="l5.178" class="difflineplus">+        }</span>
<a href="#l5.179"></a><span id="l5.179" class="difflineplus">+      }</span>
<a href="#l5.180"></a><span id="l5.180" class="difflineplus">+      antiAliasesLengths.AppendElement(antiAliasesLength);</span>
<a href="#l5.181"></a><span id="l5.181" class="difflineplus">+      antiAliasArrays.AppendElement(antiAliases);</span>
<a href="#l5.182"></a><span id="l5.182" class="difflineplus">+      PRUint32 antiMessageCount = mCorpus.getMessageCount(antiTrait);</span>
<a href="#l5.183"></a><span id="l5.183" class="difflineplus">+      for (PRUint32 aliasIndex = 0; aliasIndex &lt; antiAliasesLength; aliasIndex++)</span>
<a href="#l5.184"></a><span id="l5.184" class="difflineplus">+        antiMessageCount += mCorpus.getMessageCount(antiAliases[aliasIndex]);</span>
<a href="#l5.185"></a><span id="l5.185" class="difflineplus">+      numAntiMessages.AppendElement(antiMessageCount);</span>
<a href="#l5.186"></a><span id="l5.186">     }</span>
<a href="#l5.187"></a><span id="l5.187"> </span>
<a href="#l5.188"></a><span id="l5.188">     for (PRUint32 i = 0; i &lt; tokenCount; ++i)</span>
<a href="#l5.189"></a><span id="l5.189">     {</span>
<a href="#l5.190"></a><span id="l5.190">       Token&amp; token = tokens[i];</span>
<a href="#l5.191"></a><span id="l5.191">       CorpusToken* t = mCorpus.get(token.mWord);</span>
<a href="#l5.192"></a><span id="l5.192">       if (!t)</span>
<a href="#l5.193"></a><span id="l5.193">         continue;</span>
<a href="#l5.194"></a><span id="l5.194">       for (PRUint32 traitIndex = 0; traitIndex &lt; traitCount; traitIndex++)</span>
<a href="#l5.195"></a><span id="l5.195">       {</span>
<a href="#l5.196"></a><span id="l5.196" class="difflineminus">-        double proCount =</span>
<a href="#l5.197"></a><span id="l5.197" class="difflineminus">-          static_cast&lt;double&gt;(mCorpus.getTraitCount(t, aProTraits[traitIndex]));</span>
<a href="#l5.198"></a><span id="l5.198" class="difflineminus">-        double antiCount =</span>
<a href="#l5.199"></a><span id="l5.199" class="difflineminus">-          static_cast&lt;double&gt;(mCorpus.getTraitCount(t, aAntiTraits[traitIndex]));</span>
<a href="#l5.200"></a><span id="l5.200" class="difflineplus">+        PRUint32 iProCount = mCorpus.getTraitCount(t, aProTraits[traitIndex]);</span>
<a href="#l5.201"></a><span id="l5.201" class="difflineplus">+        // add in any counts for aliases to proTrait</span>
<a href="#l5.202"></a><span id="l5.202" class="difflineplus">+        for (PRUint32 aliasIndex = 0; aliasIndex &lt; proAliasesLengths[traitIndex]; aliasIndex++)</span>
<a href="#l5.203"></a><span id="l5.203" class="difflineplus">+          iProCount += mCorpus.getTraitCount(t, proAliasArrays[traitIndex][aliasIndex]);</span>
<a href="#l5.204"></a><span id="l5.204" class="difflineplus">+        double proCount = static_cast&lt;double&gt;(iProCount);</span>
<a href="#l5.205"></a><span id="l5.205" class="difflineplus">+</span>
<a href="#l5.206"></a><span id="l5.206" class="difflineplus">+        PRUint32 iAntiCount = mCorpus.getTraitCount(t, aAntiTraits[traitIndex]);</span>
<a href="#l5.207"></a><span id="l5.207" class="difflineplus">+        // add in any counts for aliases to antiTrait</span>
<a href="#l5.208"></a><span id="l5.208" class="difflineplus">+        for (PRUint32 aliasIndex = 0; aliasIndex &lt; antiAliasesLengths[traitIndex]; aliasIndex++)</span>
<a href="#l5.209"></a><span id="l5.209" class="difflineplus">+          iAntiCount += mCorpus.getTraitCount(t, antiAliasArrays[traitIndex][aliasIndex]);</span>
<a href="#l5.210"></a><span id="l5.210" class="difflineplus">+        double antiCount = static_cast&lt;double&gt;(iAntiCount);</span>
<a href="#l5.211"></a><span id="l5.211"> </span>
<a href="#l5.212"></a><span id="l5.212">         double prob, denom;</span>
<a href="#l5.213"></a><span id="l5.213">         // Prevent a divide by zero error by setting defaults for prob</span>
<a href="#l5.214"></a><span id="l5.214"> </span>
<a href="#l5.215"></a><span id="l5.215">         // If there are no matching tokens at all, ignore.</span>
<a href="#l5.216"></a><span id="l5.216">         if (antiCount == 0.0 &amp;&amp; proCount == 0.0)</span>
<a href="#l5.217"></a><span id="l5.217">           continue;</span>
<a href="#l5.218"></a><span id="l5.218">         // if only anti match, set probability to 0%</span>
<a href="#l5.219"></a><span id="l5.219" class="difflineat">@@ -1710,16 +1777,22 @@ void nsBayesianFilter::classifyMessage(</span>
<a href="#l5.220"></a><span id="l5.220">             nsMsgJunkStatus(nsIJunkMailPlugin::GOOD), proPercent);</span>
<a href="#l5.221"></a><span id="l5.221">       }</span>
<a href="#l5.222"></a><span id="l5.222"> </span>
<a href="#l5.223"></a><span id="l5.223">       if (aTraitListener)</span>
<a href="#l5.224"></a><span id="l5.224">       {</span>
<a href="#l5.225"></a><span id="l5.225">         traits.AppendElement(aProTraits[traitIndex]);</span>
<a href="#l5.226"></a><span id="l5.226">         percents.AppendElement(proPercent);</span>
<a href="#l5.227"></a><span id="l5.227">       }</span>
<a href="#l5.228"></a><span id="l5.228" class="difflineplus">+</span>
<a href="#l5.229"></a><span id="l5.229" class="difflineplus">+      // free aliases arrays returned from XPCOM</span>
<a href="#l5.230"></a><span id="l5.230" class="difflineplus">+      if (proAliasesLengths[traitIndex])</span>
<a href="#l5.231"></a><span id="l5.231" class="difflineplus">+        NS_Free(proAliasArrays[traitIndex]);</span>
<a href="#l5.232"></a><span id="l5.232" class="difflineplus">+      if (antiAliasesLengths[traitIndex])</span>
<a href="#l5.233"></a><span id="l5.233" class="difflineplus">+        NS_Free(antiAliasArrays[traitIndex]);</span>
<a href="#l5.234"></a><span id="l5.234">     }</span>
<a href="#l5.235"></a><span id="l5.235"> </span>
<a href="#l5.236"></a><span id="l5.236">     if (aTraitListener)</span>
<a href="#l5.237"></a><span id="l5.237">       aTraitListener-&gt;OnMessageTraitsClassified(messageURI,</span>
<a href="#l5.238"></a><span id="l5.238">           traits.Length(), traits.Elements(), percents.Elements());</span>
<a href="#l5.239"></a><span id="l5.239"> </span>
<a href="#l5.240"></a><span id="l5.240">     delete[] tokens;</span>
<a href="#l5.241"></a><span id="l5.241">     // reuse mAnalysisStore without clearing memory</span>
<a href="#l5.242"></a><span id="l5.242" class="difflineat">@@ -1898,34 +1971,34 @@ NS_IMETHODIMP nsBayesianFilter::Classify</span>
<a href="#l5.243"></a><span id="l5.243"> </span>
<a href="#l5.244"></a><span id="l5.244"> class MessageObserver : public TokenAnalyzer {</span>
<a href="#l5.245"></a><span id="l5.245"> public:</span>
<a href="#l5.246"></a><span id="l5.246">   MessageObserver(nsBayesianFilter* filter,</span>
<a href="#l5.247"></a><span id="l5.247">                   nsTArray&lt;PRUint32&gt;&amp; aOldClassifications,</span>
<a href="#l5.248"></a><span id="l5.248">                   nsTArray&lt;PRUint32&gt;&amp; aNewClassifications,</span>
<a href="#l5.249"></a><span id="l5.249">                   nsIJunkMailClassificationListener* aJunkListener,</span>
<a href="#l5.250"></a><span id="l5.250">                   nsIMsgTraitClassificationListener* aTraitListener)</span>
<a href="#l5.251"></a><span id="l5.251" class="difflineminus">-      :   mFilter(filter), mSupports(filter), mJunkListener(aJunkListener),</span>
<a href="#l5.252"></a><span id="l5.252" class="difflineplus">+      :   mFilter(filter), mJunkMailPlugin(filter), mJunkListener(aJunkListener),</span>
<a href="#l5.253"></a><span id="l5.253">           mTraitListener(aTraitListener),</span>
<a href="#l5.254"></a><span id="l5.254">           mOldClassifications(aOldClassifications),</span>
<a href="#l5.255"></a><span id="l5.255">           mNewClassifications(aNewClassifications)</span>
<a href="#l5.256"></a><span id="l5.256">   {</span>
<a href="#l5.257"></a><span id="l5.257">   }</span>
<a href="#l5.258"></a><span id="l5.258"> </span>
<a href="#l5.259"></a><span id="l5.259">   virtual void analyzeTokens(Tokenizer&amp; tokenizer)</span>
<a href="#l5.260"></a><span id="l5.260">   {</span>
<a href="#l5.261"></a><span id="l5.261">     mFilter-&gt;observeMessage(tokenizer, mTokenSource.get(), mOldClassifications,</span>
<a href="#l5.262"></a><span id="l5.262">                             mNewClassifications, mJunkListener, mTraitListener);</span>
<a href="#l5.263"></a><span id="l5.263">     // release reference to listener, which will allow us to go away as well.</span>
<a href="#l5.264"></a><span id="l5.264">     mTokenListener = nsnull;</span>
<a href="#l5.265"></a><span id="l5.265">   }</span>
<a href="#l5.266"></a><span id="l5.266"> </span>
<a href="#l5.267"></a><span id="l5.267"> private:</span>
<a href="#l5.268"></a><span id="l5.268">   nsBayesianFilter* mFilter;</span>
<a href="#l5.269"></a><span id="l5.269" class="difflineminus">-  nsCOMPtr&lt;nsISupports&gt; mSupports;</span>
<a href="#l5.270"></a><span id="l5.270" class="difflineplus">+  nsCOMPtr&lt;nsIJunkMailPlugin&gt; mJunkMailPlugin;</span>
<a href="#l5.271"></a><span id="l5.271">   nsCOMPtr&lt;nsIJunkMailClassificationListener&gt; mJunkListener;</span>
<a href="#l5.272"></a><span id="l5.272">   nsCOMPtr&lt;nsIMsgTraitClassificationListener&gt; mTraitListener;</span>
<a href="#l5.273"></a><span id="l5.273">   nsTArray&lt;PRUint32&gt; mOldClassifications;</span>
<a href="#l5.274"></a><span id="l5.274">   nsTArray&lt;PRUint32&gt; mNewClassifications;</span>
<a href="#l5.275"></a><span id="l5.275"> };</span>
<a href="#l5.276"></a><span id="l5.276"> </span>
<a href="#l5.277"></a><span id="l5.277"> NS_IMETHODIMP nsBayesianFilter::SetMsgTraitClassification(</span>
<a href="#l5.278"></a><span id="l5.278">     const char *aMsgURI,</span>
<a href="#l5.279"></a><span id="l5.279" class="difflineat">@@ -2117,31 +2190,60 @@ NS_IMETHODIMP nsBayesianFilter::DetailMe</span>
<a href="#l5.280"></a><span id="l5.280">   TokenStreamListener *tokenListener = new TokenStreamListener(analyzer);</span>
<a href="#l5.281"></a><span id="l5.281">   if (!tokenListener)</span>
<a href="#l5.282"></a><span id="l5.282">     return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l5.283"></a><span id="l5.283"> </span>
<a href="#l5.284"></a><span id="l5.284">   analyzer-&gt;setTokenListener(tokenListener);</span>
<a href="#l5.285"></a><span id="l5.285">   return tokenizeMessage(aMsgURI, aMsgWindow, analyzer);</span>
<a href="#l5.286"></a><span id="l5.286"> }</span>
<a href="#l5.287"></a><span id="l5.287"> </span>
<a href="#l5.288"></a><span id="l5.288" class="difflineplus">+// nsIMsgCorpus implementation</span>
<a href="#l5.289"></a><span id="l5.289" class="difflineplus">+</span>
<a href="#l5.290"></a><span id="l5.290"> NS_IMETHODIMP nsBayesianFilter::CorpusCounts(PRUint32 aTrait,</span>
<a href="#l5.291"></a><span id="l5.291">                                              PRUint32 *aMessageCount,</span>
<a href="#l5.292"></a><span id="l5.292">                                              PRUint32 *aTokenCount)</span>
<a href="#l5.293"></a><span id="l5.293"> {</span>
<a href="#l5.294"></a><span id="l5.294">   NS_ENSURE_ARG_POINTER(aTokenCount);</span>
<a href="#l5.295"></a><span id="l5.295">   if (mCorpus)</span>
<a href="#l5.296"></a><span id="l5.296">   {</span>
<a href="#l5.297"></a><span id="l5.297">     *aTokenCount = mCorpus.countTokens();</span>
<a href="#l5.298"></a><span id="l5.298">     if (aTrait &amp;&amp; aMessageCount)</span>
<a href="#l5.299"></a><span id="l5.299">       *aMessageCount = mCorpus.getMessageCount(aTrait);</span>
<a href="#l5.300"></a><span id="l5.300">     return NS_OK;</span>
<a href="#l5.301"></a><span id="l5.301">   }</span>
<a href="#l5.302"></a><span id="l5.302">   return NS_ERROR_FAILURE;</span>
<a href="#l5.303"></a><span id="l5.303"> }</span>
<a href="#l5.304"></a><span id="l5.304"> </span>
<a href="#l5.305"></a><span id="l5.305" class="difflineplus">+NS_IMETHODIMP nsBayesianFilter::ClearTrait(PRUint32 aTrait)</span>
<a href="#l5.306"></a><span id="l5.306" class="difflineplus">+{</span>
<a href="#l5.307"></a><span id="l5.307" class="difflineplus">+    return mCorpus.ClearTrait(aTrait);</span>
<a href="#l5.308"></a><span id="l5.308" class="difflineplus">+}</span>
<a href="#l5.309"></a><span id="l5.309" class="difflineplus">+</span>
<a href="#l5.310"></a><span id="l5.310" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l5.311"></a><span id="l5.311" class="difflineplus">+nsBayesianFilter::UpdateData(nsILocalFile *aFile,</span>
<a href="#l5.312"></a><span id="l5.312" class="difflineplus">+                             PRBool aIsAdd,</span>
<a href="#l5.313"></a><span id="l5.313" class="difflineplus">+                             PRUint32 aRemapCount,</span>
<a href="#l5.314"></a><span id="l5.314" class="difflineplus">+                             PRUint32 *aFromTraits,</span>
<a href="#l5.315"></a><span id="l5.315" class="difflineplus">+                             PRUint32 *aToTraits)</span>
<a href="#l5.316"></a><span id="l5.316" class="difflineplus">+{</span>
<a href="#l5.317"></a><span id="l5.317" class="difflineplus">+  return mCorpus.UpdateData(aFile, aIsAdd, aRemapCount, aFromTraits, aToTraits);</span>
<a href="#l5.318"></a><span id="l5.318" class="difflineplus">+}</span>
<a href="#l5.319"></a><span id="l5.319" class="difflineplus">+</span>
<a href="#l5.320"></a><span id="l5.320" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l5.321"></a><span id="l5.321" class="difflineplus">+nsBayesianFilter::GetTokenCount(const nsACString &amp;aWord,</span>
<a href="#l5.322"></a><span id="l5.322" class="difflineplus">+                                PRUint32 aTrait,</span>
<a href="#l5.323"></a><span id="l5.323" class="difflineplus">+                                PRUint32 *aCount)</span>
<a href="#l5.324"></a><span id="l5.324" class="difflineplus">+{</span>
<a href="#l5.325"></a><span id="l5.325" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aCount);</span>
<a href="#l5.326"></a><span id="l5.326" class="difflineplus">+  CorpusToken* t = mCorpus.get(PromiseFlatCString(aWord).get());</span>
<a href="#l5.327"></a><span id="l5.327" class="difflineplus">+  PRUint32 count = mCorpus.getTraitCount(t, aTrait);</span>
<a href="#l5.328"></a><span id="l5.328" class="difflineplus">+  *aCount = count;</span>
<a href="#l5.329"></a><span id="l5.329" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.330"></a><span id="l5.330" class="difflineplus">+}</span>
<a href="#l5.331"></a><span id="l5.331" class="difflineplus">+</span>
<a href="#l5.332"></a><span id="l5.332"> /* Corpus Store */</span>
<a href="#l5.333"></a><span id="l5.333"> </span>
<a href="#l5.334"></a><span id="l5.334"> /*</span>
<a href="#l5.335"></a><span id="l5.335">     Format of the training file for version 1:</span>
<a href="#l5.336"></a><span id="l5.336">     [0xFEEDFACE]</span>
<a href="#l5.337"></a><span id="l5.337">     [number good messages][number bad messages]</span>
<a href="#l5.338"></a><span id="l5.338">     [number good tokens]</span>
<a href="#l5.339"></a><span id="l5.339">     [count][length of word]word</span>
<a href="#l5.340"></a><span id="l5.340" class="difflineat">@@ -2257,17 +2359,18 @@ PRBool CorpusStore::writeTokens(FILE* st</span>
<a href="#l5.341"></a><span id="l5.341">         return PR_FALSE;</span>
<a href="#l5.342"></a><span id="l5.342">       if (fwrite(token-&gt;mWord, tokenLength, 1, stream) != 1)</span>
<a href="#l5.343"></a><span id="l5.343">         return PR_FALSE;</span>
<a href="#l5.344"></a><span id="l5.344">     }</span>
<a href="#l5.345"></a><span id="l5.345">   }</span>
<a href="#l5.346"></a><span id="l5.346">   return PR_TRUE;</span>
<a href="#l5.347"></a><span id="l5.347"> }</span>
<a href="#l5.348"></a><span id="l5.348"> </span>
<a href="#l5.349"></a><span id="l5.349" class="difflineminus">-PRBool CorpusStore::readTokens(FILE* stream, PRInt64 fileSize, PRUint32 aTraitId)</span>
<a href="#l5.350"></a><span id="l5.350" class="difflineplus">+PRBool CorpusStore::readTokens(FILE* stream, PRInt64 fileSize,</span>
<a href="#l5.351"></a><span id="l5.351" class="difflineplus">+                               PRUint32 aTraitId, PRBool aIsAdd)</span>
<a href="#l5.352"></a><span id="l5.352"> {</span>
<a href="#l5.353"></a><span id="l5.353">     PRUint32 tokenCount;</span>
<a href="#l5.354"></a><span id="l5.354">     if (readUInt32(stream, &amp;tokenCount) != 1)</span>
<a href="#l5.355"></a><span id="l5.355">         return PR_FALSE;</span>
<a href="#l5.356"></a><span id="l5.356"> </span>
<a href="#l5.357"></a><span id="l5.357">     PRInt64 fpos = ftell(stream);</span>
<a href="#l5.358"></a><span id="l5.358">     if (fpos &lt; 0)</span>
<a href="#l5.359"></a><span id="l5.359">         return PR_FALSE;</span>
<a href="#l5.360"></a><span id="l5.360" class="difflineat">@@ -2297,17 +2400,20 @@ PRBool CorpusStore::readTokens(FILE* str</span>
<a href="#l5.361"></a><span id="l5.361">             }</span>
<a href="#l5.362"></a><span id="l5.362">             buffer = new char[bufferSize];</span>
<a href="#l5.363"></a><span id="l5.363">             if (!buffer) return PR_FALSE;</span>
<a href="#l5.364"></a><span id="l5.364">         }</span>
<a href="#l5.365"></a><span id="l5.365">         if (fread(buffer, size, 1, stream) != 1)</span>
<a href="#l5.366"></a><span id="l5.366">             break;</span>
<a href="#l5.367"></a><span id="l5.367">         fpos += size;</span>
<a href="#l5.368"></a><span id="l5.368">         buffer[size] = '\0';</span>
<a href="#l5.369"></a><span id="l5.369" class="difflineminus">-        add(buffer, aTraitId, count);</span>
<a href="#l5.370"></a><span id="l5.370" class="difflineplus">+        if (aIsAdd)</span>
<a href="#l5.371"></a><span id="l5.371" class="difflineplus">+          add(buffer, aTraitId, count);</span>
<a href="#l5.372"></a><span id="l5.372" class="difflineplus">+        else</span>
<a href="#l5.373"></a><span id="l5.373" class="difflineplus">+          remove(buffer, aTraitId, count);</span>
<a href="#l5.374"></a><span id="l5.374">     }</span>
<a href="#l5.375"></a><span id="l5.375"> </span>
<a href="#l5.376"></a><span id="l5.376">     delete[] buffer;</span>
<a href="#l5.377"></a><span id="l5.377"> </span>
<a href="#l5.378"></a><span id="l5.378">     return PR_TRUE;</span>
<a href="#l5.379"></a><span id="l5.379"> }</span>
<a href="#l5.380"></a><span id="l5.380"> </span>
<a href="#l5.381"></a><span id="l5.381"> nsresult CorpusStore::getTrainingFile(nsILocalFile ** aTrainingFile)</span>
<a href="#l5.382"></a><span id="l5.382" class="difflineat">@@ -2478,18 +2584,18 @@ void CorpusStore::readTrainingData()</span>
<a href="#l5.383"></a><span id="l5.383"> </span>
<a href="#l5.384"></a><span id="l5.384">   // FIXME:  should make sure that the tokenizers are empty.</span>
<a href="#l5.385"></a><span id="l5.385">   char cookie[4];</span>
<a href="#l5.386"></a><span id="l5.386">   PRUint32 goodMessageCount, junkMessageCount;</span>
<a href="#l5.387"></a><span id="l5.387">   if (!((fread(cookie, sizeof(cookie), 1, stream) == 1) &amp;&amp;</span>
<a href="#l5.388"></a><span id="l5.388">         (memcmp(cookie, kMagicCookie, sizeof(cookie)) == 0) &amp;&amp;</span>
<a href="#l5.389"></a><span id="l5.389">         (readUInt32(stream, &amp;goodMessageCount) == 1) &amp;&amp;</span>
<a href="#l5.390"></a><span id="l5.390">         (readUInt32(stream, &amp;junkMessageCount) == 1) &amp;&amp;</span>
<a href="#l5.391"></a><span id="l5.391" class="difflineminus">-         readTokens(stream, fileSize, kGoodTrait) &amp;&amp;</span>
<a href="#l5.392"></a><span id="l5.392" class="difflineminus">-         readTokens(stream, fileSize, kJunkTrait))) {</span>
<a href="#l5.393"></a><span id="l5.393" class="difflineplus">+         readTokens(stream, fileSize, kGoodTrait, PR_TRUE) &amp;&amp;</span>
<a href="#l5.394"></a><span id="l5.394" class="difflineplus">+         readTokens(stream, fileSize, kJunkTrait, PR_TRUE))) {</span>
<a href="#l5.395"></a><span id="l5.395">       NS_WARNING(&quot;failed to read training data.&quot;);</span>
<a href="#l5.396"></a><span id="l5.396">       PR_LOG(BayesianFilterLogModule, PR_LOG_ERROR, (&quot;failed to read training data.&quot;));</span>
<a href="#l5.397"></a><span id="l5.397">   }</span>
<a href="#l5.398"></a><span id="l5.398">   setMessageCount(kGoodTrait, goodMessageCount);</span>
<a href="#l5.399"></a><span id="l5.399">   setMessageCount(kJunkTrait, junkMessageCount);</span>
<a href="#l5.400"></a><span id="l5.400"> </span>
<a href="#l5.401"></a><span id="l5.401">   fclose(stream);</span>
<a href="#l5.402"></a><span id="l5.402"> </span>
<a href="#l5.403"></a><span id="l5.403" class="difflineat">@@ -2503,49 +2609,19 @@ void CorpusStore::readTrainingData()</span>
<a href="#l5.404"></a><span id="l5.404">     if (!mTraitFile)</span>
<a href="#l5.405"></a><span id="l5.405">      return;</span>
<a href="#l5.406"></a><span id="l5.406">   }</span>
<a href="#l5.407"></a><span id="l5.407"> </span>
<a href="#l5.408"></a><span id="l5.408">   rv = mTraitFile-&gt;Exists(&amp;exists);</span>
<a href="#l5.409"></a><span id="l5.409">   if (NS_FAILED(rv) || !exists)</span>
<a href="#l5.410"></a><span id="l5.410">     return;</span>
<a href="#l5.411"></a><span id="l5.411"> </span>
<a href="#l5.412"></a><span id="l5.412" class="difflineminus">-  rv = mTraitFile-&gt;OpenANSIFileDesc(&quot;rb&quot;, &amp;stream);</span>
<a href="#l5.413"></a><span id="l5.413" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l5.414"></a><span id="l5.414" class="difflineminus">-    return;</span>
<a href="#l5.415"></a><span id="l5.415" class="difflineminus">-</span>
<a href="#l5.416"></a><span id="l5.416" class="difflineminus">-  rv = mTraitFile-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l5.417"></a><span id="l5.417" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l5.418"></a><span id="l5.418" class="difflineminus">-    return;</span>
<a href="#l5.419"></a><span id="l5.419" class="difflineminus">-</span>
<a href="#l5.420"></a><span id="l5.420" class="difflineminus">-  PRBool error;</span>
<a href="#l5.421"></a><span id="l5.421" class="difflineminus">-</span>
<a href="#l5.422"></a><span id="l5.422" class="difflineminus">-  while(1) // break on error or done</span>
<a href="#l5.423"></a><span id="l5.423" class="difflineminus">-  {</span>
<a href="#l5.424"></a><span id="l5.424" class="difflineminus">-    if (error = (fread(cookie, sizeof(cookie), 1, stream) != 1))</span>
<a href="#l5.425"></a><span id="l5.425" class="difflineminus">-      break;</span>
<a href="#l5.426"></a><span id="l5.426" class="difflineplus">+  rv = UpdateData(mTraitFile, PR_TRUE, 0, nsnull, nsnull);</span>
<a href="#l5.427"></a><span id="l5.427"> </span>
<a href="#l5.428"></a><span id="l5.428" class="difflineminus">-    if (error = memcmp(cookie, kTraitCookie, sizeof(cookie)))</span>
<a href="#l5.429"></a><span id="l5.429" class="difflineminus">-      break;</span>
<a href="#l5.430"></a><span id="l5.430" class="difflineminus">-</span>
<a href="#l5.431"></a><span id="l5.431" class="difflineminus">-    PRUint32 trait;</span>
<a href="#l5.432"></a><span id="l5.432" class="difflineminus">-    while ( !(error = (readUInt32(stream, &amp;trait) != 1)) &amp;&amp; trait)</span>
<a href="#l5.433"></a><span id="l5.433" class="difflineminus">-    {</span>
<a href="#l5.434"></a><span id="l5.434" class="difflineminus">-      PRUint32 count;</span>
<a href="#l5.435"></a><span id="l5.435" class="difflineminus">-      if (error = (readUInt32(stream, &amp;count) != 1))</span>
<a href="#l5.436"></a><span id="l5.436" class="difflineminus">-        break;</span>
<a href="#l5.437"></a><span id="l5.437" class="difflineminus">-</span>
<a href="#l5.438"></a><span id="l5.438" class="difflineminus">-      setMessageCount(trait, count);</span>
<a href="#l5.439"></a><span id="l5.439" class="difflineminus">-</span>
<a href="#l5.440"></a><span id="l5.440" class="difflineminus">-      if (error = !readTokens(stream, fileSize, trait))</span>
<a href="#l5.441"></a><span id="l5.441" class="difflineminus">-        break;</span>
<a href="#l5.442"></a><span id="l5.442" class="difflineminus">-    }</span>
<a href="#l5.443"></a><span id="l5.443" class="difflineminus">-    break;</span>
<a href="#l5.444"></a><span id="l5.444" class="difflineminus">-  }</span>
<a href="#l5.445"></a><span id="l5.445" class="difflineminus">-  if (error)</span>
<a href="#l5.446"></a><span id="l5.446" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l5.447"></a><span id="l5.447">   {</span>
<a href="#l5.448"></a><span id="l5.448">     NS_WARNING(&quot;failed to read training data.&quot;);</span>
<a href="#l5.449"></a><span id="l5.449">     PR_LOG(BayesianFilterLogModule, PR_LOG_ERROR, (&quot;failed to read training data.&quot;));</span>
<a href="#l5.450"></a><span id="l5.450">   }</span>
<a href="#l5.451"></a><span id="l5.451">   return;</span>
<a href="#l5.452"></a><span id="l5.452"> }</span>
<a href="#l5.453"></a><span id="l5.453"> </span>
<a href="#l5.454"></a><span id="l5.454"> nsresult CorpusStore::resetTrainingData()</span>
<a href="#l5.455"></a><span id="l5.455" class="difflineat">@@ -2679,8 +2755,92 @@ void CorpusStore::setMessageCount(PRUint</span>
<a href="#l5.456"></a><span id="l5.456">     mMessageCounts.AppendElement(aCount);</span>
<a href="#l5.457"></a><span id="l5.457">     mMessageCountsId.AppendElement(aTraitId);</span>
<a href="#l5.458"></a><span id="l5.458">   }</span>
<a href="#l5.459"></a><span id="l5.459">   else</span>
<a href="#l5.460"></a><span id="l5.460">   {</span>
<a href="#l5.461"></a><span id="l5.461">     mMessageCounts[index] = aCount;</span>
<a href="#l5.462"></a><span id="l5.462">   }</span>
<a href="#l5.463"></a><span id="l5.463"> }</span>
<a href="#l5.464"></a><span id="l5.464" class="difflineplus">+</span>
<a href="#l5.465"></a><span id="l5.465" class="difflineplus">+nsresult</span>
<a href="#l5.466"></a><span id="l5.466" class="difflineplus">+CorpusStore::UpdateData(nsILocalFile *aFile,</span>
<a href="#l5.467"></a><span id="l5.467" class="difflineplus">+                        PRBool aIsAdd,</span>
<a href="#l5.468"></a><span id="l5.468" class="difflineplus">+                        PRUint32 aRemapCount,</span>
<a href="#l5.469"></a><span id="l5.469" class="difflineplus">+                        PRUint32 *aFromTraits,</span>
<a href="#l5.470"></a><span id="l5.470" class="difflineplus">+                        PRUint32 *aToTraits)</span>
<a href="#l5.471"></a><span id="l5.471" class="difflineplus">+{</span>
<a href="#l5.472"></a><span id="l5.472" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aFile);</span>
<a href="#l5.473"></a><span id="l5.473" class="difflineplus">+  if (aRemapCount)</span>
<a href="#l5.474"></a><span id="l5.474" class="difflineplus">+  {</span>
<a href="#l5.475"></a><span id="l5.475" class="difflineplus">+    NS_ENSURE_ARG_POINTER(aFromTraits);</span>
<a href="#l5.476"></a><span id="l5.476" class="difflineplus">+    NS_ENSURE_ARG_POINTER(aToTraits);</span>
<a href="#l5.477"></a><span id="l5.477" class="difflineplus">+  }</span>
<a href="#l5.478"></a><span id="l5.478" class="difflineplus">+</span>
<a href="#l5.479"></a><span id="l5.479" class="difflineplus">+  FILE* stream;</span>
<a href="#l5.480"></a><span id="l5.480" class="difflineplus">+  nsresult rv = aFile-&gt;OpenANSIFileDesc(&quot;rb&quot;, &amp;stream);</span>
<a href="#l5.481"></a><span id="l5.481" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.482"></a><span id="l5.482" class="difflineplus">+</span>
<a href="#l5.483"></a><span id="l5.483" class="difflineplus">+  PRInt64 fileSize;</span>
<a href="#l5.484"></a><span id="l5.484" class="difflineplus">+  rv = aFile-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l5.485"></a><span id="l5.485" class="difflineplus">+</span>
<a href="#l5.486"></a><span id="l5.486" class="difflineplus">+  PRBool error;</span>
<a href="#l5.487"></a><span id="l5.487" class="difflineplus">+  while(NS_SUCCEEDED(rv)) // break on error or done</span>
<a href="#l5.488"></a><span id="l5.488" class="difflineplus">+  {</span>
<a href="#l5.489"></a><span id="l5.489" class="difflineplus">+    char cookie[4];</span>
<a href="#l5.490"></a><span id="l5.490" class="difflineplus">+    if (error = (fread(cookie, sizeof(cookie), 1, stream) != 1))</span>
<a href="#l5.491"></a><span id="l5.491" class="difflineplus">+      break;</span>
<a href="#l5.492"></a><span id="l5.492" class="difflineplus">+</span>
<a href="#l5.493"></a><span id="l5.493" class="difflineplus">+    if (error = memcmp(cookie, kTraitCookie, sizeof(cookie)))</span>
<a href="#l5.494"></a><span id="l5.494" class="difflineplus">+      break;</span>
<a href="#l5.495"></a><span id="l5.495" class="difflineplus">+</span>
<a href="#l5.496"></a><span id="l5.496" class="difflineplus">+    PRUint32 fileTrait;</span>
<a href="#l5.497"></a><span id="l5.497" class="difflineplus">+    while ( !(error = (readUInt32(stream, &amp;fileTrait) != 1)) &amp;&amp; fileTrait)</span>
<a href="#l5.498"></a><span id="l5.498" class="difflineplus">+    {</span>
<a href="#l5.499"></a><span id="l5.499" class="difflineplus">+      PRUint32 count;</span>
<a href="#l5.500"></a><span id="l5.500" class="difflineplus">+      if (error = (readUInt32(stream, &amp;count) != 1))</span>
<a href="#l5.501"></a><span id="l5.501" class="difflineplus">+        break;</span>
<a href="#l5.502"></a><span id="l5.502" class="difflineplus">+</span>
<a href="#l5.503"></a><span id="l5.503" class="difflineplus">+      PRUint32 localTrait = fileTrait;</span>
<a href="#l5.504"></a><span id="l5.504" class="difflineplus">+      // remap the trait</span>
<a href="#l5.505"></a><span id="l5.505" class="difflineplus">+      for (PRUint32 i = 0; i &lt; aRemapCount; i++)</span>
<a href="#l5.506"></a><span id="l5.506" class="difflineplus">+      {</span>
<a href="#l5.507"></a><span id="l5.507" class="difflineplus">+        if (aFromTraits[i] == fileTrait)</span>
<a href="#l5.508"></a><span id="l5.508" class="difflineplus">+          localTrait = aToTraits[i];</span>
<a href="#l5.509"></a><span id="l5.509" class="difflineplus">+      }</span>
<a href="#l5.510"></a><span id="l5.510" class="difflineplus">+</span>
<a href="#l5.511"></a><span id="l5.511" class="difflineplus">+      PRUint32 messageCount = getMessageCount(localTrait);</span>
<a href="#l5.512"></a><span id="l5.512" class="difflineplus">+      if (aIsAdd)</span>
<a href="#l5.513"></a><span id="l5.513" class="difflineplus">+        messageCount += count;</span>
<a href="#l5.514"></a><span id="l5.514" class="difflineplus">+      else if (count &gt; messageCount)</span>
<a href="#l5.515"></a><span id="l5.515" class="difflineplus">+        messageCount = 0;</span>
<a href="#l5.516"></a><span id="l5.516" class="difflineplus">+      else</span>
<a href="#l5.517"></a><span id="l5.517" class="difflineplus">+        messageCount -= count;</span>
<a href="#l5.518"></a><span id="l5.518" class="difflineplus">+      setMessageCount(localTrait, messageCount);</span>
<a href="#l5.519"></a><span id="l5.519" class="difflineplus">+</span>
<a href="#l5.520"></a><span id="l5.520" class="difflineplus">+      if (error = !readTokens(stream, fileSize, localTrait, aIsAdd))</span>
<a href="#l5.521"></a><span id="l5.521" class="difflineplus">+        break;</span>
<a href="#l5.522"></a><span id="l5.522" class="difflineplus">+    }</span>
<a href="#l5.523"></a><span id="l5.523" class="difflineplus">+    break;</span>
<a href="#l5.524"></a><span id="l5.524" class="difflineplus">+  }</span>
<a href="#l5.525"></a><span id="l5.525" class="difflineplus">+</span>
<a href="#l5.526"></a><span id="l5.526" class="difflineplus">+  fclose(stream);</span>
<a href="#l5.527"></a><span id="l5.527" class="difflineplus">+  if (error || NS_FAILED(rv))</span>
<a href="#l5.528"></a><span id="l5.528" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l5.529"></a><span id="l5.529" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.530"></a><span id="l5.530" class="difflineplus">+}</span>
<a href="#l5.531"></a><span id="l5.531" class="difflineplus">+</span>
<a href="#l5.532"></a><span id="l5.532" class="difflineplus">+nsresult CorpusStore::ClearTrait(PRUint32 aTrait)</span>
<a href="#l5.533"></a><span id="l5.533" class="difflineplus">+{</span>
<a href="#l5.534"></a><span id="l5.534" class="difflineplus">+  // clear message counts</span>
<a href="#l5.535"></a><span id="l5.535" class="difflineplus">+  setMessageCount(aTrait, 0);</span>
<a href="#l5.536"></a><span id="l5.536" class="difflineplus">+</span>
<a href="#l5.537"></a><span id="l5.537" class="difflineplus">+  // clear token counts</span>
<a href="#l5.538"></a><span id="l5.538" class="difflineplus">+  PRUint32 tokenCount = countTokens();</span>
<a href="#l5.539"></a><span id="l5.539" class="difflineplus">+  TokenEnumeration tokens = getTokens();</span>
<a href="#l5.540"></a><span id="l5.540" class="difflineplus">+  while (tokens.hasMoreTokens())</span>
<a href="#l5.541"></a><span id="l5.541" class="difflineplus">+  {</span>
<a href="#l5.542"></a><span id="l5.542" class="difflineplus">+    CorpusToken* token = static_cast&lt;CorpusToken*&gt;(tokens.nextToken());</span>
<a href="#l5.543"></a><span id="l5.543" class="difflineplus">+    PRInt32 wordCount = static_cast&lt;PRInt32&gt;(getTraitCount(token, aTrait));</span>
<a href="#l5.544"></a><span id="l5.544" class="difflineplus">+    updateTrait(token, aTrait, -wordCount);</span>
<a href="#l5.545"></a><span id="l5.545" class="difflineplus">+  }</span>
<a href="#l5.546"></a><span id="l5.546" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.547"></a><span id="l5.547" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.h</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.h</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -272,32 +272,83 @@ public:</span>
<a href="#l6.4"></a><span id="l6.4">     /**</span>
<a href="#l6.5"></a><span id="l6.5">      * get the count of messages associated with a particular token and trait</span>
<a href="#l6.6"></a><span id="l6.6">      *</span>
<a href="#l6.7"></a><span id="l6.7">      * @param  token     the token string and associated counts</span>
<a href="#l6.8"></a><span id="l6.8">      * @param  aTraitId  identifier for the trait</span>
<a href="#l6.9"></a><span id="l6.9">      */</span>
<a href="#l6.10"></a><span id="l6.10">     PRUint32 getTraitCount(CorpusToken *token, PRUint32 aTraitId);</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+    /**</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+     * Add (or remove) data from a particular file to the corpus data.</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+     *</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+     * @param aFile       the file with the data, in the format:</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+     *</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+     *                    Format of the trait file for version 1:</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+     *                    [0xFCA93601]  (the 01 is the version)</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+     *                    for each trait to write:</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+     *                    [id of trait to write] (0 means end of list)</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineplus">+     *                    [number of messages per trait]</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+     *                    for each token with non-zero count</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineplus">+     *                    [count]</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineplus">+     *                    [length of word]word</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineplus">+     *</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineplus">+     * @param aIsAdd      should the data be added, or removed? PR_TRUE if adding,</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineplus">+     *                    else removing.</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineplus">+     *</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineplus">+     * @param aRemapCount number of items in the parallel arrays aFromTraits,</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineplus">+     *                    aToTraits. These arrays allow conversion of the</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+     *                    trait id stored in the file (which may be originated</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+     *                    externally) to the trait id used in the local corpus</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+     *                    (which is defined locally using nsIMsgTraitService).</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+     *</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+     * @param aFromTraits array of trait ids used in aFile. If aFile contains</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineplus">+     *                    trait ids that are not in this array, they are not</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineplus">+     *                    remapped, but assummed to be local trait ids.</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineplus">+     *</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineplus">+     * @param aToTraits   array of trait ids, corresponding to elements of</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineplus">+     *                    aFromTraits, that represent the local trait ids to be</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineplus">+     *                    used in storing data from aFile into the local corpus.</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineplus">+     *</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineplus">+     */</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineplus">+    nsresult UpdateData(nsILocalFile *aFile, PRBool aIsAdd,</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineplus">+                        PRUint32 aRemapCount, PRUint32 *aFromTraits,</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineplus">+                        PRUint32 *aToTraits);</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineplus">+</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineplus">+    /**</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineplus">+     * remove all counts (message and tokens) for a trait id</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineplus">+     *</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineplus">+     * @param aTrait  trait id for the trait to remove</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineplus">+     */</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineplus">+    nsresult ClearTrait(PRUint32 aTrait);</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineplus">+</span>
<a href="#l6.55"></a><span id="l6.55"> protected:</span>
<a href="#l6.56"></a><span id="l6.56"> </span>
<a href="#l6.57"></a><span id="l6.57">     /**</span>
<a href="#l6.58"></a><span id="l6.58">      * return the local corpus storage file for junk traits</span>
<a href="#l6.59"></a><span id="l6.59">      */</span>
<a href="#l6.60"></a><span id="l6.60">     nsresult getTrainingFile(nsILocalFile ** aFile);</span>
<a href="#l6.61"></a><span id="l6.61"> </span>
<a href="#l6.62"></a><span id="l6.62">     /**</span>
<a href="#l6.63"></a><span id="l6.63">      * return the local corpus storage file for non-junk traits</span>
<a href="#l6.64"></a><span id="l6.64">      */</span>
<a href="#l6.65"></a><span id="l6.65">     nsresult getTraitFile(nsILocalFile ** aFile);</span>
<a href="#l6.66"></a><span id="l6.66"> </span>
<a href="#l6.67"></a><span id="l6.67">     /**</span>
<a href="#l6.68"></a><span id="l6.68">      * read token strings from the data file</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineplus">+     *</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineplus">+     * @param stream     file stream with token data</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineplus">+     * @param fileSize   file size</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineplus">+     * @param aTraitId   id for the trait whose counts will be read</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineplus">+     * @param aIsAdd     true to add the counts, false to remove them</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineplus">+     *</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineplus">+     * @return           true if successful, false if error</span>
<a href="#l6.76"></a><span id="l6.76">      */</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineminus">-    PRBool readTokens(FILE* stream, PRInt64 fileSize, PRUint32 aTraitId);</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineplus">+    PRBool readTokens(FILE* stream, PRInt64 fileSize, PRUint32 aTraitId,</span>
<a href="#l6.79"></a><span id="l6.79" class="difflineplus">+                      PRBool aIsAdd);</span>
<a href="#l6.80"></a><span id="l6.80"> </span>
<a href="#l6.81"></a><span id="l6.81">     /**</span>
<a href="#l6.82"></a><span id="l6.82">      * write token strings to the data file</span>
<a href="#l6.83"></a><span id="l6.83">      */</span>
<a href="#l6.84"></a><span id="l6.84">     PRBool writeTokens(FILE* stream, PRBool shrink, PRUint32 aTraitId);</span>
<a href="#l6.85"></a><span id="l6.85"> </span>
<a href="#l6.86"></a><span id="l6.86">     /**</span>
<a href="#l6.87"></a><span id="l6.87">      * remove counts for a token string</span>
<a href="#l6.88"></a><span id="l6.88" class="difflineat">@@ -321,21 +372,22 @@ protected:</span>
<a href="#l6.89"></a><span id="l6.89">     PRUint32 mNextTraitIndex;              // index in mTraitStore to first empty</span>
<a href="#l6.90"></a><span id="l6.90">                                            // TraitPerToken</span>
<a href="#l6.91"></a><span id="l6.91">     nsTArray&lt;PRUint32&gt; mMessageCounts;     // count of messages per trait</span>
<a href="#l6.92"></a><span id="l6.92">                                            // represented in the store</span>
<a href="#l6.93"></a><span id="l6.93">     nsTArray&lt;PRUint32&gt; mMessageCountsId;   // Parallel array to mMessageCounts, with</span>
<a href="#l6.94"></a><span id="l6.94">                                            // the corresponding trait ID</span>
<a href="#l6.95"></a><span id="l6.95"> };</span>
<a href="#l6.96"></a><span id="l6.96"> </span>
<a href="#l6.97"></a><span id="l6.97" class="difflineminus">-class nsBayesianFilter : public nsIJunkMailPlugin {</span>
<a href="#l6.98"></a><span id="l6.98" class="difflineplus">+class nsBayesianFilter : public nsIJunkMailPlugin, nsIMsgCorpus {</span>
<a href="#l6.99"></a><span id="l6.99"> public:</span>
<a href="#l6.100"></a><span id="l6.100">     NS_DECL_ISUPPORTS</span>
<a href="#l6.101"></a><span id="l6.101">     NS_DECL_NSIMSGFILTERPLUGIN</span>
<a href="#l6.102"></a><span id="l6.102">     NS_DECL_NSIJUNKMAILPLUGIN</span>
<a href="#l6.103"></a><span id="l6.103" class="difflineplus">+    NS_DECL_NSIMSGCORPUS</span>
<a href="#l6.104"></a><span id="l6.104"> </span>
<a href="#l6.105"></a><span id="l6.105">     nsBayesianFilter();</span>
<a href="#l6.106"></a><span id="l6.106">     virtual ~nsBayesianFilter();</span>
<a href="#l6.107"></a><span id="l6.107"> </span>
<a href="#l6.108"></a><span id="l6.108">     nsresult tokenizeMessage(const char* messageURI, nsIMsgWindow *aMsgWindow, TokenAnalyzer* analyzer);</span>
<a href="#l6.109"></a><span id="l6.109">     void classifyMessage(Tokenizer&amp; tokens, const char* messageURI,</span>
<a href="#l6.110"></a><span id="l6.110">                         nsIJunkMailClassificationListener* listener);</span>
<a href="#l6.111"></a><span id="l6.111"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1">new file mode 100644</span>
<a href="#l7.2"></a><span id="l7.2">index e69de29bb2d1d6434b8b29ae775ad8c2e48c5391..31162459e40e9b59f1ff4c4d921aa7bc0a093ad8</span>
<a href="#l7.3"></a><span id="l7.3">GIT binary patch
literal 446
zc%1vQ(u|RTf%zo^0|Ss|V1d#?$r*`7#i=D$nZ^0K78a(Kx`t30ndJPulGMBs-IB_J
zRDBR(Rgzj!qF&lt;1cn3)Gv!&amp;_XMl$DxX0+cB(fobH-%q_?-DoM;M0owN-D8K}@j|r!J
lOhnkngv~xCbo&lt;_-`42^h5mh|RQl4Lw4YcYb-K=6@003EhYEl3I</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1">new file mode 100644</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineminus">--- /dev/null</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineplus">+++ b/mailnews/extensions/bayesian-spam-filter/test/unit/resources/aliases1.eml</span>
<a href="#l8.4"></a><span id="l8.4" class="difflineat">@@ -0,0 +1,6 @@</span>
<a href="#l8.5"></a><span id="l8.5" class="difflineplus">+From - Sat Jan 26 08:43:42 2008</span>
<a href="#l8.6"></a><span id="l8.6" class="difflineplus">+Subject: test1</span>
<a href="#l8.7"></a><span id="l8.7" class="difflineplus">+Content-Type: text/plain; charset=iso-8859-1</span>
<a href="#l8.8"></a><span id="l8.8" class="difflineplus">+</span>
<a href="#l8.9"></a><span id="l8.9" class="difflineplus">+important</span>
<a href="#l8.10"></a><span id="l8.10" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1">new file mode 100644</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineminus">--- /dev/null</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineplus">+++ b/mailnews/extensions/bayesian-spam-filter/test/unit/resources/aliases2.eml</span>
<a href="#l9.4"></a><span id="l9.4" class="difflineat">@@ -0,0 +1,6 @@</span>
<a href="#l9.5"></a><span id="l9.5" class="difflineplus">+From - Sat Jan 26 08:43:42 2008</span>
<a href="#l9.6"></a><span id="l9.6" class="difflineplus">+Subject: test2</span>
<a href="#l9.7"></a><span id="l9.7" class="difflineplus">+Content-Type: text/plain; charset=iso-8859-1</span>
<a href="#l9.8"></a><span id="l9.8" class="difflineplus">+</span>
<a href="#l9.9"></a><span id="l9.9" class="difflineplus">+work</span>
<a href="#l9.10"></a><span id="l9.10" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1">new file mode 100644</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineminus">--- /dev/null</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineplus">+++ b/mailnews/extensions/bayesian-spam-filter/test/unit/resources/aliases3.eml</span>
<a href="#l10.4"></a><span id="l10.4" class="difflineat">@@ -0,0 +1,6 @@</span>
<a href="#l10.5"></a><span id="l10.5" class="difflineplus">+From - Sat Jan 26 08:43:42 2008</span>
<a href="#l10.6"></a><span id="l10.6" class="difflineplus">+Subject: test3</span>
<a href="#l10.7"></a><span id="l10.7" class="difflineplus">+Content-Type: text/plain; charset=iso-8859-1</span>
<a href="#l10.8"></a><span id="l10.8" class="difflineplus">+</span>
<a href="#l10.9"></a><span id="l10.9" class="difflineplus">+very important work</span>
<a href="#l10.10"></a><span id="l10.10" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1">new file mode 100644</span>
<a href="#l11.2"></a><span id="l11.2">index e69de29bb2d1d6434b8b29ae775ad8c2e48c5391..f273a4f10ca94add10bc131e34c1150592378dc7</span>
<a href="#l11.3"></a><span id="l11.3">GIT binary patch
literal 2447
zc%0Q#!EV$r5ZwSms&gt;A^h0-+u-7gVG=vAs&lt;;by&gt;tO@CB7OaT~XZz1U8&gt;OVtY}j{F9n
zhWG^zj2D;ErG=G1qG*$&gt;GoEo~-pqSnJ{HMfaP!k(Ft`EtI^6I+cs#?ss#^{ZM#%_M
zTI6LxXjw$Zr+e0P{7`C-4n!v%dJ)#ID&amp;eL|q?PGjM#sCI&gt;Lfmr)+wVoO-cO19oJ6|
zWaYW)#5CI0TBT)WdhKKI{i+exNpNxomu0?&lt;Y20}|!)_`%Ts5*fl=k}vf&gt;AgJm(pmM
zvUCe=FhWX9C|u8x(QA!yen@B&lt;{yU?cmo_9EbJ&amp;1loY&lt;FG)%?YlC`Lt@lXOIKG9uec
z^#%WDOa3LvE0UJrJ-P&amp;qCsH5D)=VY#W`UlU?nl(3+rt?a)dC27DCaz`*)nt!Q_q)e
z;lOxGGlQhy8){F&lt;8uw0GenM%vP5BiN@NbD!hM#A2icTDyF`4tJHTza{$o5(*y$?_#
zI1+$AjXB_2whG?oxE5Y=-}IY^4beg0B51)jB7|=dP8q_aAms9(V_8EGI}f5m&amp;PvXT
z3qcpgla@b^=exgKy6gNDiQYG;7^QRs^T1L{^My&amp;)=vcwd()^!+aw|3@tnZyQX?f1q
zE2BNcV?UqDEIgo(GoLlSYop7DPy~iS)1G(ct!i75&lt;tafM$4b}c*zKTx2gNl4R^}&lt;)
zK~h8QJIEdZ@ye8@ls!lLKp2w+P7p?i2)d+eX(!6o8A}QLph0Iw3x~-p(1-w$IxTfG
z&amp;!GA=U+_5O^*$2OdEtA&lt;wb?|jGFFaB%8-?BdSzuj4w(iZ+*q{juD3nlUT=o-b|Zf_
z*Md;&amp;E=)$ZbL1LheWh&amp;GD?ipIU~O6{tRC0OiAf8%N79cMJU^q(mBb1ic(fR@QN~#I
zZMqmt7n)wVO&lt;`isw{I(V(Cb6c%g@pBU=_VgR@KYo7kYU?8&lt;Q)wF}Y6KxPsaxtE=4)
fMEb|dwwg%&amp;M;es;UW1ZrszJ#$)1c%}G-&amp;V@Ubn|~</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/extensions/bayesian-spam-filter/test/unit/test_junkAsTraits.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/extensions/bayesian-spam-filter/test/unit/test_junkAsTraits.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -515,20 +515,21 @@ function startCommand()</span>
<a href="#l12.4"></a><span id="l12.4">         null,        // in nsIMsgWindow aMsgWindow</span>
<a href="#l12.5"></a><span id="l12.5">         jListener ? junkListener :</span>
<a href="#l12.6"></a><span id="l12.6">           null);     // in nsIJunkMailClassificationListener aJunkListener</span>
<a href="#l12.7"></a><span id="l12.7">       break;</span>
<a href="#l12.8"></a><span id="l12.8"> </span>
<a href="#l12.9"></a><span id="l12.9">     case kCounts:</span>
<a href="#l12.10"></a><span id="l12.10">       // test counts</span>
<a href="#l12.11"></a><span id="l12.11">       let msgCount = {};</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-      let tokenCount = nsIJunkMailPlugin.corpusCounts(null, {});</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">-      nsIJunkMailPlugin.corpusCounts(kJunkTrait, msgCount);</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+      let nsIMsgCorpus = nsIJunkMailPlugin.QueryInterface(Ci.nsIMsgCorpus);</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+      let tokenCount = nsIMsgCorpus.corpusCounts(null, {});</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineplus">+      nsIMsgCorpus.corpusCounts(kJunkTrait, msgCount);</span>
<a href="#l12.17"></a><span id="l12.17">       let junkCount = msgCount.value;</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineminus">-      nsIJunkMailPlugin.corpusCounts(kGoodTrait, msgCount);</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineplus">+      nsIMsgCorpus.corpusCounts(kGoodTrait, msgCount);</span>
<a href="#l12.20"></a><span id="l12.20">       let goodCount = msgCount.value;</span>
<a href="#l12.21"></a><span id="l12.21">       print(&quot;tokenCount, junkCount, goodCount is &quot; + tokenCount, junkCount, goodCount);</span>
<a href="#l12.22"></a><span id="l12.22">       do_check_eq(tokenCount, gTest.tokenCount);</span>
<a href="#l12.23"></a><span id="l12.23">       do_check_eq(junkCount, gTest.junkCount);</span>
<a href="#l12.24"></a><span id="l12.24">       do_check_eq(goodCount, gTest.goodCount);</span>
<a href="#l12.25"></a><span id="l12.25">       do_timeout(0, &quot;startCommand();&quot;);</span>
<a href="#l12.26"></a><span id="l12.26">       break;</span>
<a href="#l12.27"></a><span id="l12.27">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1">new file mode 100644</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineminus">--- /dev/null</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineplus">+++ b/mailnews/extensions/bayesian-spam-filter/test/unit/test_msgCorpus.js</span>
<a href="#l13.4"></a><span id="l13.4" class="difflineat">@@ -0,0 +1,178 @@</span>
<a href="#l13.5"></a><span id="l13.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l13.6"></a><span id="l13.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l13.7"></a><span id="l13.7" class="difflineplus">+ *</span>
<a href="#l13.8"></a><span id="l13.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l13.9"></a><span id="l13.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l13.10"></a><span id="l13.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l13.11"></a><span id="l13.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+ *</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineplus">+ * License.</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineplus">+ *</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineplus">+ *</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineplus">+ * Kent James &lt;kent@caspia.com&gt;.</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineplus">+ *</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineplus">+ *</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineplus">+ *</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineplus">+</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineplus">+// Tests corpus management functions using nsIMsgCorpus</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineplus">+</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineplus">+var msgCorpus =</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineplus">+  Cc[&quot;@mozilla.org/messenger/filter-plugin;1?name=bayesianfilter&quot;]</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineplus">+    .getService(Ci.nsIMsgCorpus);</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineplus">+</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineplus">+// tokens found in the test corpus file. trait 1001 was trained with</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineplus">+// 2 messages, and trait 1003 with 1.</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineplus">+</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineplus">+var tokenData = [</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineplus">+// [traitid, count, token]</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineplus">+  [1001, 0, &quot;iDoNotExist&quot;],</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineplus">+  [1001, 1, &quot;linecount&quot;],</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineplus">+  [1001, 2, &quot;envelope-to:kenttest@caspia.com&quot;],</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineplus">+  [1003, 0, &quot;iAlsoDoNotExist&quot;],</span>
<a href="#l13.56"></a><span id="l13.56" class="difflineplus">+  [1003, 0, &quot;isjunk&quot;], // in 1001 but not 1003</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineplus">+  [1003, 1, &quot;linecount&quot;],</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineplus">+  [1003, 1, &quot;subject:test&quot;],</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineplus">+  [1003, 1, &quot;envelope-to:kenttest@caspia.com&quot;],</span>
<a href="#l13.60"></a><span id="l13.60" class="difflineplus">+]</span>
<a href="#l13.61"></a><span id="l13.61" class="difflineplus">+</span>
<a href="#l13.62"></a><span id="l13.62" class="difflineplus">+// list of tests</span>
<a href="#l13.63"></a><span id="l13.63" class="difflineplus">+</span>
<a href="#l13.64"></a><span id="l13.64" class="difflineplus">+var gTests =</span>
<a href="#l13.65"></a><span id="l13.65" class="difflineplus">+[</span>
<a href="#l13.66"></a><span id="l13.66" class="difflineplus">+  // train two different combinations of messages</span>
<a href="#l13.67"></a><span id="l13.67" class="difflineplus">+  function checkLoadOnce() {</span>
<a href="#l13.68"></a><span id="l13.68" class="difflineplus">+    let fileName = &quot;msgCorpus.dat&quot;;</span>
<a href="#l13.69"></a><span id="l13.69" class="difflineplus">+    let file = do_get_file(&quot;resources/&quot; + fileName);</span>
<a href="#l13.70"></a><span id="l13.70" class="difflineplus">+    msgCorpus.updateData(file, true);</span>
<a href="#l13.71"></a><span id="l13.71" class="difflineplus">+</span>
<a href="#l13.72"></a><span id="l13.72" class="difflineplus">+    // check message counts</span>
<a href="#l13.73"></a><span id="l13.73" class="difflineplus">+    let messageCount = {};</span>
<a href="#l13.74"></a><span id="l13.74" class="difflineplus">+    msgCorpus.corpusCounts(1001, messageCount);</span>
<a href="#l13.75"></a><span id="l13.75" class="difflineplus">+    do_check_eq(2, messageCount.value);</span>
<a href="#l13.76"></a><span id="l13.76" class="difflineplus">+    msgCorpus.corpusCounts(1003, messageCount);</span>
<a href="#l13.77"></a><span id="l13.77" class="difflineplus">+    do_check_eq(1, messageCount.value);</span>
<a href="#l13.78"></a><span id="l13.78" class="difflineplus">+</span>
<a href="#l13.79"></a><span id="l13.79" class="difflineplus">+    for (i = 0; i &lt; tokenData.length; i++) {</span>
<a href="#l13.80"></a><span id="l13.80" class="difflineplus">+      let id = tokenData[i][0];</span>
<a href="#l13.81"></a><span id="l13.81" class="difflineplus">+      let count = tokenData[i][1];</span>
<a href="#l13.82"></a><span id="l13.82" class="difflineplus">+      let word = tokenData[i][2];</span>
<a href="#l13.83"></a><span id="l13.83" class="difflineplus">+      do_check_eq(count, msgCorpus.getTokenCount(word, id));</span>
<a href="#l13.84"></a><span id="l13.84" class="difflineplus">+    }</span>
<a href="#l13.85"></a><span id="l13.85" class="difflineplus">+  },</span>
<a href="#l13.86"></a><span id="l13.86" class="difflineplus">+  function checkLoadTwice() {</span>
<a href="#l13.87"></a><span id="l13.87" class="difflineplus">+    let fileName = &quot;msgCorpus.dat&quot;;</span>
<a href="#l13.88"></a><span id="l13.88" class="difflineplus">+    let file = do_get_file(&quot;resources/&quot; + fileName);</span>
<a href="#l13.89"></a><span id="l13.89" class="difflineplus">+    msgCorpus.updateData(file, true);</span>
<a href="#l13.90"></a><span id="l13.90" class="difflineplus">+</span>
<a href="#l13.91"></a><span id="l13.91" class="difflineplus">+    // check message counts</span>
<a href="#l13.92"></a><span id="l13.92" class="difflineplus">+    let messageCount = {};</span>
<a href="#l13.93"></a><span id="l13.93" class="difflineplus">+    msgCorpus.corpusCounts(1001, messageCount);</span>
<a href="#l13.94"></a><span id="l13.94" class="difflineplus">+    do_check_eq(4, messageCount.value);</span>
<a href="#l13.95"></a><span id="l13.95" class="difflineplus">+    msgCorpus.corpusCounts(1003, messageCount);</span>
<a href="#l13.96"></a><span id="l13.96" class="difflineplus">+    do_check_eq(2, messageCount.value);</span>
<a href="#l13.97"></a><span id="l13.97" class="difflineplus">+</span>
<a href="#l13.98"></a><span id="l13.98" class="difflineplus">+    for (i = 0; i &lt; tokenData.length; i++) {</span>
<a href="#l13.99"></a><span id="l13.99" class="difflineplus">+      let id = tokenData[i][0];</span>
<a href="#l13.100"></a><span id="l13.100" class="difflineplus">+      let count = 2 * tokenData[i][1];</span>
<a href="#l13.101"></a><span id="l13.101" class="difflineplus">+      let word = tokenData[i][2];</span>
<a href="#l13.102"></a><span id="l13.102" class="difflineplus">+      do_check_eq(count, msgCorpus.getTokenCount(word, id));</span>
<a href="#l13.103"></a><span id="l13.103" class="difflineplus">+    }</span>
<a href="#l13.104"></a><span id="l13.104" class="difflineplus">+  },</span>
<a href="#l13.105"></a><span id="l13.105" class="difflineplus">+  // remap the ids in the file to different local ids</span>
<a href="#l13.106"></a><span id="l13.106" class="difflineplus">+  function loadWithRemap() {</span>
<a href="#l13.107"></a><span id="l13.107" class="difflineplus">+    let fileName = &quot;msgCorpus.dat&quot;;</span>
<a href="#l13.108"></a><span id="l13.108" class="difflineplus">+    let file = do_get_file(&quot;resources/&quot; + fileName);</span>
<a href="#l13.109"></a><span id="l13.109" class="difflineplus">+    msgCorpus.updateData(file, true, 2, [1001, 1003], [1, 3]);</span>
<a href="#l13.110"></a><span id="l13.110" class="difflineplus">+</span>
<a href="#l13.111"></a><span id="l13.111" class="difflineplus">+    for (i = 0; i &lt; tokenData.length; i++) {</span>
<a href="#l13.112"></a><span id="l13.112" class="difflineplus">+      let id = tokenData[i][0] - 1000;</span>
<a href="#l13.113"></a><span id="l13.113" class="difflineplus">+      let count = tokenData[i][1];</span>
<a href="#l13.114"></a><span id="l13.114" class="difflineplus">+      let word = tokenData[i][2];</span>
<a href="#l13.115"></a><span id="l13.115" class="difflineplus">+      do_check_eq(count, msgCorpus.getTokenCount(word, id));</span>
<a href="#l13.116"></a><span id="l13.116" class="difflineplus">+    }</span>
<a href="#l13.117"></a><span id="l13.117" class="difflineplus">+  },</span>
<a href="#l13.118"></a><span id="l13.118" class="difflineplus">+  // test removing data</span>
<a href="#l13.119"></a><span id="l13.119" class="difflineplus">+  function checkRemove() {</span>
<a href="#l13.120"></a><span id="l13.120" class="difflineplus">+    let fileName = &quot;msgCorpus.dat&quot;;</span>
<a href="#l13.121"></a><span id="l13.121" class="difflineplus">+    let file = do_get_file(&quot;resources/&quot; + fileName);</span>
<a href="#l13.122"></a><span id="l13.122" class="difflineplus">+    msgCorpus.updateData(file, false);</span>
<a href="#l13.123"></a><span id="l13.123" class="difflineplus">+</span>
<a href="#l13.124"></a><span id="l13.124" class="difflineplus">+    // check message counts</span>
<a href="#l13.125"></a><span id="l13.125" class="difflineplus">+    let messageCount = {};</span>
<a href="#l13.126"></a><span id="l13.126" class="difflineplus">+    msgCorpus.corpusCounts(1001, messageCount);</span>
<a href="#l13.127"></a><span id="l13.127" class="difflineplus">+    do_check_eq(2, messageCount.value);</span>
<a href="#l13.128"></a><span id="l13.128" class="difflineplus">+    msgCorpus.corpusCounts(1003, messageCount);</span>
<a href="#l13.129"></a><span id="l13.129" class="difflineplus">+    do_check_eq(1, messageCount.value);</span>
<a href="#l13.130"></a><span id="l13.130" class="difflineplus">+</span>
<a href="#l13.131"></a><span id="l13.131" class="difflineplus">+    for (i = 0; i &lt; tokenData.length; i++) {</span>
<a href="#l13.132"></a><span id="l13.132" class="difflineplus">+      let id = tokenData[i][0];</span>
<a href="#l13.133"></a><span id="l13.133" class="difflineplus">+      let count = tokenData[i][1];</span>
<a href="#l13.134"></a><span id="l13.134" class="difflineplus">+      let word = tokenData[i][2];</span>
<a href="#l13.135"></a><span id="l13.135" class="difflineplus">+      do_check_eq(count, msgCorpus.getTokenCount(word, id));</span>
<a href="#l13.136"></a><span id="l13.136" class="difflineplus">+    }</span>
<a href="#l13.137"></a><span id="l13.137" class="difflineplus">+  },</span>
<a href="#l13.138"></a><span id="l13.138" class="difflineplus">+  // test clearing a trait</span>
<a href="#l13.139"></a><span id="l13.139" class="difflineplus">+  function checkClear() {</span>
<a href="#l13.140"></a><span id="l13.140" class="difflineplus">+    let messageCountObject = {};</span>
<a href="#l13.141"></a><span id="l13.141" class="difflineplus">+    /*</span>
<a href="#l13.142"></a><span id="l13.142" class="difflineplus">+    msgCorpus.corpusCounts(1001, messageCountObject);</span>
<a href="#l13.143"></a><span id="l13.143" class="difflineplus">+    let v1001 = messageCountObject.value;</span>
<a href="#l13.144"></a><span id="l13.144" class="difflineplus">+    msgCorpus.corpusCounts(1003, messageCountObject);</span>
<a href="#l13.145"></a><span id="l13.145" class="difflineplus">+    let v1003 = messageCountObject.value;</span>
<a href="#l13.146"></a><span id="l13.146" class="difflineplus">+    dump(&quot;pre-clear value &quot; + v1001 + &quot; &quot; + v1003 + &quot;\n&quot;);</span>
<a href="#l13.147"></a><span id="l13.147" class="difflineplus">+    /**/</span>
<a href="#l13.148"></a><span id="l13.148" class="difflineplus">+    msgCorpus.clearTrait(1001);</span>
<a href="#l13.149"></a><span id="l13.149" class="difflineplus">+    // check that the message count is zero</span>
<a href="#l13.150"></a><span id="l13.150" class="difflineplus">+    msgCorpus.corpusCounts(1001, messageCountObject);</span>
<a href="#l13.151"></a><span id="l13.151" class="difflineplus">+    do_check_eq(0, messageCountObject.value);</span>
<a href="#l13.152"></a><span id="l13.152" class="difflineplus">+    // but the other trait should still have counts</span>
<a href="#l13.153"></a><span id="l13.153" class="difflineplus">+    msgCorpus.corpusCounts(1003, messageCountObject);</span>
<a href="#l13.154"></a><span id="l13.154" class="difflineplus">+    do_check_eq(1, messageCountObject.value);</span>
<a href="#l13.155"></a><span id="l13.155" class="difflineplus">+    // check that token count was cleared</span>
<a href="#l13.156"></a><span id="l13.156" class="difflineplus">+    for (i = 0; i &lt; tokenData.length; i++) {</span>
<a href="#l13.157"></a><span id="l13.157" class="difflineplus">+      let id = tokenData[i][0];</span>
<a href="#l13.158"></a><span id="l13.158" class="difflineplus">+      let count = tokenData[i][1];</span>
<a href="#l13.159"></a><span id="l13.159" class="difflineplus">+      let word = tokenData[i][2];</span>
<a href="#l13.160"></a><span id="l13.160" class="difflineplus">+      do_check_eq(id == 1001 ? 0 : count, msgCorpus.getTokenCount(word, id));</span>
<a href="#l13.161"></a><span id="l13.161" class="difflineplus">+    }</span>
<a href="#l13.162"></a><span id="l13.162" class="difflineplus">+  },</span>
<a href="#l13.163"></a><span id="l13.163" class="difflineplus">+</span>
<a href="#l13.164"></a><span id="l13.164" class="difflineplus">+]</span>
<a href="#l13.165"></a><span id="l13.165" class="difflineplus">+</span>
<a href="#l13.166"></a><span id="l13.166" class="difflineplus">+// main test</span>
<a href="#l13.167"></a><span id="l13.167" class="difflineplus">+function run_test()</span>
<a href="#l13.168"></a><span id="l13.168" class="difflineplus">+{</span>
<a href="#l13.169"></a><span id="l13.169" class="difflineplus">+  do_test_pending();</span>
<a href="#l13.170"></a><span id="l13.170" class="difflineplus">+  while(1)</span>
<a href="#l13.171"></a><span id="l13.171" class="difflineplus">+  {</span>
<a href="#l13.172"></a><span id="l13.172" class="difflineplus">+    if (!gTests.length)       // Do we have more commands?</span>
<a href="#l13.173"></a><span id="l13.173" class="difflineplus">+    {</span>
<a href="#l13.174"></a><span id="l13.174" class="difflineplus">+      // no, all done</span>
<a href="#l13.175"></a><span id="l13.175" class="difflineplus">+      do_test_finished();</span>
<a href="#l13.176"></a><span id="l13.176" class="difflineplus">+      return;</span>
<a href="#l13.177"></a><span id="l13.177" class="difflineplus">+    }</span>
<a href="#l13.178"></a><span id="l13.178" class="difflineplus">+</span>
<a href="#l13.179"></a><span id="l13.179" class="difflineplus">+    let test = gTests.shift();</span>
<a href="#l13.180"></a><span id="l13.180" class="difflineplus">+    test();</span>
<a href="#l13.181"></a><span id="l13.181" class="difflineplus">+  }</span>
<a href="#l13.182"></a><span id="l13.182" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1">new file mode 100644</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineminus">--- /dev/null</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineplus">+++ b/mailnews/extensions/bayesian-spam-filter/test/unit/test_traitAliases.js</span>
<a href="#l14.4"></a><span id="l14.4" class="difflineat">@@ -0,0 +1,194 @@</span>
<a href="#l14.5"></a><span id="l14.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l14.6"></a><span id="l14.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l14.7"></a><span id="l14.7" class="difflineplus">+ *</span>
<a href="#l14.8"></a><span id="l14.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l14.9"></a><span id="l14.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l14.10"></a><span id="l14.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l14.11"></a><span id="l14.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineplus">+ *</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineplus">+ * License.</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineplus">+ *</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineplus">+ *</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineplus">+ * Kent James &lt;kent@caspia.com&gt;.</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineplus">+ *</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineplus">+ *</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineplus">+ *</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineplus">+</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineplus">+// Tests bayes trait analysis with aliases. Adapted from test_traits.js</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineplus">+</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineplus">+/*</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineplus">+ * These tests rely on data stored in a file, with the same format as traits.dat,</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineplus">+ * that was trained in the following manner. There are two training messages,</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineplus">+ * included here as files aliases1.eml and aliases2.eml  Aliases.dat was trained on</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineplus">+ * each of these messages, for different trait indices, as follows, with</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineplus">+ * columns showing the training count for each trait index:</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineplus">+ *</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineplus">+ *     file   count(1001)  count(1005) count(1007) count(1009)</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineplus">+ *</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineplus">+ *   aliases1.eml      1            0           2           0</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineplus">+ *   aliases2.eml      0            1           0           1</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineplus">+ *</span>
<a href="#l14.55"></a><span id="l14.55" class="difflineplus">+ * There is also a third email file, aliases3.eml, which combines tokens</span>
<a href="#l14.56"></a><span id="l14.56" class="difflineplus">+ * from aliases1.eml and aliases2.eml</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineplus">+ *</span>
<a href="#l14.58"></a><span id="l14.58" class="difflineplus">+ * The goal here is to demonstrate that traits 1001 and 1007, and traits</span>
<a href="#l14.59"></a><span id="l14.59" class="difflineplus">+ * 1005 and 1009, can be combined using aliases. We classify messages with</span>
<a href="#l14.60"></a><span id="l14.60" class="difflineplus">+ * trait 1001 as the PRO trait, and 1005 as the ANTI trait.</span>
<a href="#l14.61"></a><span id="l14.61" class="difflineplus">+ *</span>
<a href="#l14.62"></a><span id="l14.62" class="difflineplus">+ * With these characteristics, I've run a trait analysis without aliases, and</span>
<a href="#l14.63"></a><span id="l14.63" class="difflineplus">+ * determined that the following is the correct percentage results from the</span>
<a href="#l14.64"></a><span id="l14.64" class="difflineplus">+ * analysis for each message. &quot;Train11&quot; means that the training was 1 pro count</span>
<a href="#l14.65"></a><span id="l14.65" class="difflineplus">+ * from aliases1.eml, and 1 anti count from alias2.eml. &quot;Train32&quot; is 3 pro counts,</span>
<a href="#l14.66"></a><span id="l14.66" class="difflineplus">+ * and 2 anti counts.</span>
<a href="#l14.67"></a><span id="l14.67" class="difflineplus">+ *</span>
<a href="#l14.68"></a><span id="l14.68" class="difflineplus">+ *                 percentage</span>
<a href="#l14.69"></a><span id="l14.69" class="difflineplus">+ *    file         Train11       Train32</span>
<a href="#l14.70"></a><span id="l14.70" class="difflineplus">+ *</span>
<a href="#l14.71"></a><span id="l14.71" class="difflineplus">+ * alias1.eml        92             98</span>
<a href="#l14.72"></a><span id="l14.72" class="difflineplus">+ * alias2.eml         8              3</span>
<a href="#l14.73"></a><span id="l14.73" class="difflineplus">+ * alias3.eml        50             53</span>
<a href="#l14.74"></a><span id="l14.74" class="difflineplus">+ */</span>
<a href="#l14.75"></a><span id="l14.75" class="difflineplus">+</span>
<a href="#l14.76"></a><span id="l14.76" class="difflineplus">+const nsIJunkMailPlugin =</span>
<a href="#l14.77"></a><span id="l14.77" class="difflineplus">+    Cc[&quot;@mozilla.org/messenger/filter-plugin;1?name=bayesianfilter&quot;]</span>
<a href="#l14.78"></a><span id="l14.78" class="difflineplus">+      .getService(Ci.nsIJunkMailPlugin);</span>
<a href="#l14.79"></a><span id="l14.79" class="difflineplus">+const traitService = Cc[&quot;@mozilla.org/msg-trait-service;1&quot;]</span>
<a href="#l14.80"></a><span id="l14.80" class="difflineplus">+                       .getService(Ci.nsIMsgTraitService);</span>
<a href="#l14.81"></a><span id="l14.81" class="difflineplus">+const kProTrait = 1001;</span>
<a href="#l14.82"></a><span id="l14.82" class="difflineplus">+const kAntiTrait = 1005;</span>
<a href="#l14.83"></a><span id="l14.83" class="difflineplus">+const kProAlias = 1007;</span>
<a href="#l14.84"></a><span id="l14.84" class="difflineplus">+const kAntiAlias = 1009;</span>
<a href="#l14.85"></a><span id="l14.85" class="difflineplus">+</span>
<a href="#l14.86"></a><span id="l14.86" class="difflineplus">+var gTest; // currently active test</span>
<a href="#l14.87"></a><span id="l14.87" class="difflineplus">+</span>
<a href="#l14.88"></a><span id="l14.88" class="difflineplus">+// The tests array defines the tests to attempt. Format of</span>
<a href="#l14.89"></a><span id="l14.89" class="difflineplus">+// an element &quot;test&quot; of this array:</span>
<a href="#l14.90"></a><span id="l14.90" class="difflineplus">+//</span>
<a href="#l14.91"></a><span id="l14.91" class="difflineplus">+//   test.fileName: file containing message to test</span>
<a href="#l14.92"></a><span id="l14.92" class="difflineplus">+//   test.proAliases: array of aliases for the pro trait</span>
<a href="#l14.93"></a><span id="l14.93" class="difflineplus">+//   test.antiAliases: array of aliases for the anti trait</span>
<a href="#l14.94"></a><span id="l14.94" class="difflineplus">+//   test.percent: expected results from the classifier</span>
<a href="#l14.95"></a><span id="l14.95" class="difflineplus">+</span>
<a href="#l14.96"></a><span id="l14.96" class="difflineplus">+var tests =</span>
<a href="#l14.97"></a><span id="l14.97" class="difflineplus">+[</span>
<a href="#l14.98"></a><span id="l14.98" class="difflineplus">+  {fileName: &quot;aliases1.eml&quot;,</span>
<a href="#l14.99"></a><span id="l14.99" class="difflineplus">+   proAliases: [],</span>
<a href="#l14.100"></a><span id="l14.100" class="difflineplus">+   antiAliases: [],</span>
<a href="#l14.101"></a><span id="l14.101" class="difflineplus">+   percent: 92</span>
<a href="#l14.102"></a><span id="l14.102" class="difflineplus">+  },</span>
<a href="#l14.103"></a><span id="l14.103" class="difflineplus">+  {fileName: &quot;aliases2.eml&quot;,</span>
<a href="#l14.104"></a><span id="l14.104" class="difflineplus">+   proAliases: [],</span>
<a href="#l14.105"></a><span id="l14.105" class="difflineplus">+   antiAliases: [],</span>
<a href="#l14.106"></a><span id="l14.106" class="difflineplus">+   percent: 8</span>
<a href="#l14.107"></a><span id="l14.107" class="difflineplus">+  },</span>
<a href="#l14.108"></a><span id="l14.108" class="difflineplus">+  {fileName: &quot;aliases3.eml&quot;,</span>
<a href="#l14.109"></a><span id="l14.109" class="difflineplus">+   proAliases: [],</span>
<a href="#l14.110"></a><span id="l14.110" class="difflineplus">+   antiAliases: [],</span>
<a href="#l14.111"></a><span id="l14.111" class="difflineplus">+   percent: 50</span>
<a href="#l14.112"></a><span id="l14.112" class="difflineplus">+  },</span>
<a href="#l14.113"></a><span id="l14.113" class="difflineplus">+  {fileName: &quot;aliases1.eml&quot;,</span>
<a href="#l14.114"></a><span id="l14.114" class="difflineplus">+   proAliases: [kProAlias],</span>
<a href="#l14.115"></a><span id="l14.115" class="difflineplus">+   antiAliases: [kAntiAlias],</span>
<a href="#l14.116"></a><span id="l14.116" class="difflineplus">+   percent: 98</span>
<a href="#l14.117"></a><span id="l14.117" class="difflineplus">+  },</span>
<a href="#l14.118"></a><span id="l14.118" class="difflineplus">+  {fileName: &quot;aliases2.eml&quot;,</span>
<a href="#l14.119"></a><span id="l14.119" class="difflineplus">+   proAliases: [kProAlias],</span>
<a href="#l14.120"></a><span id="l14.120" class="difflineplus">+   antiAliases: [kAntiAlias],</span>
<a href="#l14.121"></a><span id="l14.121" class="difflineplus">+   percent: 3</span>
<a href="#l14.122"></a><span id="l14.122" class="difflineplus">+  },</span>
<a href="#l14.123"></a><span id="l14.123" class="difflineplus">+  {fileName: &quot;aliases3.eml&quot;,</span>
<a href="#l14.124"></a><span id="l14.124" class="difflineplus">+   proAliases: [kProAlias],</span>
<a href="#l14.125"></a><span id="l14.125" class="difflineplus">+   antiAliases: [kAntiAlias],</span>
<a href="#l14.126"></a><span id="l14.126" class="difflineplus">+   percent: 53</span>
<a href="#l14.127"></a><span id="l14.127" class="difflineplus">+  },</span>
<a href="#l14.128"></a><span id="l14.128" class="difflineplus">+]</span>
<a href="#l14.129"></a><span id="l14.129" class="difflineplus">+</span>
<a href="#l14.130"></a><span id="l14.130" class="difflineplus">+// main test</span>
<a href="#l14.131"></a><span id="l14.131" class="difflineplus">+function run_test()</span>
<a href="#l14.132"></a><span id="l14.132" class="difflineplus">+{</span>
<a href="#l14.133"></a><span id="l14.133" class="difflineplus">+  loadLocalMailAccount();</span>
<a href="#l14.134"></a><span id="l14.134" class="difflineplus">+</span>
<a href="#l14.135"></a><span id="l14.135" class="difflineplus">+  // load in the aliases trait testing file</span>
<a href="#l14.136"></a><span id="l14.136" class="difflineplus">+  nsIJunkMailPlugin.QueryInterface(Ci.nsIMsgCorpus)</span>
<a href="#l14.137"></a><span id="l14.137" class="difflineplus">+                   .updateData(do_get_file(&quot;resources/aliases.dat&quot;), true);</span>
<a href="#l14.138"></a><span id="l14.138" class="difflineplus">+  do_test_pending();</span>
<a href="#l14.139"></a><span id="l14.139" class="difflineplus">+</span>
<a href="#l14.140"></a><span id="l14.140" class="difflineplus">+  startCommand();</span>
<a href="#l14.141"></a><span id="l14.141" class="difflineplus">+}</span>
<a href="#l14.142"></a><span id="l14.142" class="difflineplus">+</span>
<a href="#l14.143"></a><span id="l14.143" class="difflineplus">+var listener =</span>
<a href="#l14.144"></a><span id="l14.144" class="difflineplus">+{</span>
<a href="#l14.145"></a><span id="l14.145" class="difflineplus">+  //nsIMsgTraitClassificationListener implementation</span>
<a href="#l14.146"></a><span id="l14.146" class="difflineplus">+  onMessageTraitsClassified: function(aMsgURI, {}, aTraits, aPercents)</span>
<a href="#l14.147"></a><span id="l14.147" class="difflineplus">+  {</span>
<a href="#l14.148"></a><span id="l14.148" class="difflineplus">+    //print(&quot;Message URI is &quot; + aMsgURI);</span>
<a href="#l14.149"></a><span id="l14.149" class="difflineplus">+    if (!aMsgURI)</span>
<a href="#l14.150"></a><span id="l14.150" class="difflineplus">+      return; //ignore end-of-batch signal</span>
<a href="#l14.151"></a><span id="l14.151" class="difflineplus">+</span>
<a href="#l14.152"></a><span id="l14.152" class="difflineplus">+    do_check_eq(aPercents[0], gTest.percent)</span>
<a href="#l14.153"></a><span id="l14.153" class="difflineplus">+    // All done, start the next test</span>
<a href="#l14.154"></a><span id="l14.154" class="difflineplus">+    startCommand();</span>
<a href="#l14.155"></a><span id="l14.155" class="difflineplus">+  },</span>
<a href="#l14.156"></a><span id="l14.156" class="difflineplus">+};</span>
<a href="#l14.157"></a><span id="l14.157" class="difflineplus">+</span>
<a href="#l14.158"></a><span id="l14.158" class="difflineplus">+// start the next test command</span>
<a href="#l14.159"></a><span id="l14.159" class="difflineplus">+function startCommand()</span>
<a href="#l14.160"></a><span id="l14.160" class="difflineplus">+{</span>
<a href="#l14.161"></a><span id="l14.161" class="difflineplus">+  if (!tests.length)       // Do we have more commands?</span>
<a href="#l14.162"></a><span id="l14.162" class="difflineplus">+  {</span>
<a href="#l14.163"></a><span id="l14.163" class="difflineplus">+    // no, all done</span>
<a href="#l14.164"></a><span id="l14.164" class="difflineplus">+    do_test_finished();</span>
<a href="#l14.165"></a><span id="l14.165" class="difflineplus">+    return;</span>
<a href="#l14.166"></a><span id="l14.166" class="difflineplus">+  }</span>
<a href="#l14.167"></a><span id="l14.167" class="difflineplus">+</span>
<a href="#l14.168"></a><span id="l14.168" class="difflineplus">+  gTest = tests.shift();</span>
<a href="#l14.169"></a><span id="l14.169" class="difflineplus">+</span>
<a href="#l14.170"></a><span id="l14.170" class="difflineplus">+  // classify message</span>
<a href="#l14.171"></a><span id="l14.171" class="difflineplus">+  var antiArray = [kAntiTrait];</span>
<a href="#l14.172"></a><span id="l14.172" class="difflineplus">+  var proArray = [kProTrait];</span>
<a href="#l14.173"></a><span id="l14.173" class="difflineplus">+</span>
<a href="#l14.174"></a><span id="l14.174" class="difflineplus">+  // remove any existing aliases</span>
<a href="#l14.175"></a><span id="l14.175" class="difflineplus">+  let proAliases = traitService.getAliases(kProTrait, {});</span>
<a href="#l14.176"></a><span id="l14.176" class="difflineplus">+  let antiAliases = traitService.getAliases(kAntiTrait, {});</span>
<a href="#l14.177"></a><span id="l14.177" class="difflineplus">+  let proAlias;</span>
<a href="#l14.178"></a><span id="l14.178" class="difflineplus">+  let antiAlias;</span>
<a href="#l14.179"></a><span id="l14.179" class="difflineplus">+  while (proAlias = proAliases.pop())</span>
<a href="#l14.180"></a><span id="l14.180" class="difflineplus">+    traitService.removeAlias(kProTrait, proAlias);</span>
<a href="#l14.181"></a><span id="l14.181" class="difflineplus">+  while (antiAlias = antiAliases.pop())</span>
<a href="#l14.182"></a><span id="l14.182" class="difflineplus">+    traitService.removeAlias(kAntiTrait, antiAlias);</span>
<a href="#l14.183"></a><span id="l14.183" class="difflineplus">+</span>
<a href="#l14.184"></a><span id="l14.184" class="difflineplus">+  // add new aliases</span>
<a href="#l14.185"></a><span id="l14.185" class="difflineplus">+  while (proAlias = gTest.proAliases.pop())</span>
<a href="#l14.186"></a><span id="l14.186" class="difflineplus">+    traitService.addAlias(kProTrait, proAlias);</span>
<a href="#l14.187"></a><span id="l14.187" class="difflineplus">+  while (antiAlias = gTest.antiAliases.pop())</span>
<a href="#l14.188"></a><span id="l14.188" class="difflineplus">+    traitService.addAlias(kAntiTrait, antiAlias);</span>
<a href="#l14.189"></a><span id="l14.189" class="difflineplus">+  </span>
<a href="#l14.190"></a><span id="l14.190" class="difflineplus">+  nsIJunkMailPlugin.classifyTraitsInMessage(</span>
<a href="#l14.191"></a><span id="l14.191" class="difflineplus">+    getSpec(gTest.fileName), // in string aMsgURI</span>
<a href="#l14.192"></a><span id="l14.192" class="difflineplus">+    proArray.length, // length of traits arrays</span>
<a href="#l14.193"></a><span id="l14.193" class="difflineplus">+    proArray,    // in array aProTraits,</span>
<a href="#l14.194"></a><span id="l14.194" class="difflineplus">+    antiArray,   // in array aAntiTraits</span>
<a href="#l14.195"></a><span id="l14.195" class="difflineplus">+    listener);   // in nsIMsgTraitClassificationListener aTraitListener</span>
<a href="#l14.196"></a><span id="l14.196" class="difflineplus">+    //null,      // [optional] in nsIMsgWindow aMsgWindow</span>
<a href="#l14.197"></a><span id="l14.197" class="difflineplus">+    //null,      // [optional] in nsIJunkMailClassificationListener aJunkListener</span>
<a href="#l14.198"></a><span id="l14.198" class="difflineplus">+}</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

