<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 8889:c016e832aabb8c66e333736740e5f894b7949414</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ c016e832aabb8c66e333736740e5f894b7949414" />
<meta property="og:url" content="/comm-central/rev/c016e832aabb8c66e333736740e5f894b7949414" />
<meta property="og:description" content="Bug 590494 Move ldap/xpcom/src to frozen linkage r=Neil" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / c016e832aabb8c66e333736740e5f894b7949414 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/c016e832aabb8c66e333736740e5f894b7949414">shortlog</a> |
<a href="/comm-central/log/c016e832aabb8c66e333736740e5f894b7949414">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/c016e832aabb8c66e333736740e5f894b7949414">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/c016e832aabb8c66e333736740e5f894b7949414">files</a> |
changeset |
<a href="/comm-central/raw-rev/c016e832aabb8c66e333736740e5f894b7949414">raw</a>  | <a href="/comm-central/archive/c016e832aabb8c66e333736740e5f894b7949414.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=590494">Bug 590494</a> Move ldap/xpcom/src to frozen linkage r=Neil
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#97;&#110;&#32;&#72;&#111;&#114;&#97;&#107;&#32;&#60;&#106;&#104;&#111;&#114;&#97;&#107;&#64;&#114;&#101;&#100;&#104;&#97;&#116;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 25 Nov 2011 14:03:49 +0000</td></tr>

<tr>
 <td>changeset 8889</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/c016e832aabb8c66e333736740e5f894b7949414">c016e832aabb8c66e333736740e5f894b7949414</a></td>
</tr>



<tr>
<td>parent 8888</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/a1d41a4a5c1149d87a19a07a3d86c39ba5706b21">a1d41a4a5c1149d87a19a07a3d86c39ba5706b21</a>
</td>
</tr>

<tr>
<td>child 8890</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/2606d4d378c826eab102cc5b3f43680818362904">2606d4d378c826eab102cc5b3f43680818362904</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=c016e832aabb8c66e333736740e5f894b7949414">6817</a></td></tr>
<tr><td>push user</td><td>neil@parkwaycc.co.uk</td></tr>
<tr><td>push date</td><td class="date age">Fri, 25 Nov 2011 14:04:00 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@c016e832aabb [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=c016e832aabb8c66e333736740e5f894b7949414">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=c016e832aabb8c66e333736740e5f894b7949414&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=c016e832aabb8c66e333736740e5f894b7949414&newProject=comm-central&newRevision=c016e832aabb8c66e333736740e5f894b7949414&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=c016e832aabb8c66e333736740e5f894b7949414&newProject=comm-central&newRevision=c016e832aabb8c66e333736740e5f894b7949414&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=c016e832aabb8c66e333736740e5f894b7949414&newProject=comm-central&newRevision=c016e832aabb8c66e333736740e5f894b7949414&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28Neil%29&revcount=50">Neil</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=590494">590494</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=590494">Bug 590494</a> Move ldap/xpcom/src to frozen linkage r=Neil</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/Makefile.in">ldap/xpcom/src/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/Makefile.in">file</a> |
<a href="/comm-central/annotate/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/Makefile.in">annotate</a> |
<a href="/comm-central/diff/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/Makefile.in">diff</a> |
<a href="/comm-central/comparison/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/Makefile.in">comparison</a> |
<a href="/comm-central/log/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPBERElement.cpp">ldap/xpcom/src/nsLDAPBERElement.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPBERElement.cpp">file</a> |
<a href="/comm-central/annotate/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPBERElement.cpp">annotate</a> |
<a href="/comm-central/diff/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPBERElement.cpp">diff</a> |
<a href="/comm-central/comparison/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPBERElement.cpp">comparison</a> |
<a href="/comm-central/log/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPBERElement.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPBERValue.cpp">ldap/xpcom/src/nsLDAPBERValue.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPBERValue.cpp">file</a> |
<a href="/comm-central/annotate/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPBERValue.cpp">annotate</a> |
<a href="/comm-central/diff/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPBERValue.cpp">diff</a> |
<a href="/comm-central/comparison/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPBERValue.cpp">comparison</a> |
<a href="/comm-central/log/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPBERValue.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPConnection.cpp">ldap/xpcom/src/nsLDAPConnection.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPConnection.cpp">file</a> |
<a href="/comm-central/annotate/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPConnection.cpp">annotate</a> |
<a href="/comm-central/diff/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPConnection.cpp">diff</a> |
<a href="/comm-central/comparison/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPConnection.cpp">comparison</a> |
<a href="/comm-central/log/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPConnection.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPConnection.h">ldap/xpcom/src/nsLDAPConnection.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPConnection.h">file</a> |
<a href="/comm-central/annotate/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPConnection.h">annotate</a> |
<a href="/comm-central/diff/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPConnection.h">diff</a> |
<a href="/comm-central/comparison/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPConnection.h">comparison</a> |
<a href="/comm-central/log/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPConnection.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPControl.h">ldap/xpcom/src/nsLDAPControl.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPControl.h">file</a> |
<a href="/comm-central/annotate/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPControl.h">annotate</a> |
<a href="/comm-central/diff/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPControl.h">diff</a> |
<a href="/comm-central/comparison/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPControl.h">comparison</a> |
<a href="/comm-central/log/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPControl.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPMessage.cpp">ldap/xpcom/src/nsLDAPMessage.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPMessage.cpp">file</a> |
<a href="/comm-central/annotate/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPMessage.cpp">annotate</a> |
<a href="/comm-central/diff/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPMessage.cpp">diff</a> |
<a href="/comm-central/comparison/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPMessage.cpp">comparison</a> |
<a href="/comm-central/log/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPMessage.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPMessage.h">ldap/xpcom/src/nsLDAPMessage.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPMessage.h">file</a> |
<a href="/comm-central/annotate/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPMessage.h">annotate</a> |
<a href="/comm-central/diff/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPMessage.h">diff</a> |
<a href="/comm-central/comparison/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPMessage.h">comparison</a> |
<a href="/comm-central/log/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPMessage.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPModification.cpp">ldap/xpcom/src/nsLDAPModification.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPModification.cpp">file</a> |
<a href="/comm-central/annotate/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPModification.cpp">annotate</a> |
<a href="/comm-central/diff/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPModification.cpp">diff</a> |
<a href="/comm-central/comparison/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPModification.cpp">comparison</a> |
<a href="/comm-central/log/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPModification.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPModification.h">ldap/xpcom/src/nsLDAPModification.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPModification.h">file</a> |
<a href="/comm-central/annotate/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPModification.h">annotate</a> |
<a href="/comm-central/diff/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPModification.h">diff</a> |
<a href="/comm-central/comparison/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPModification.h">comparison</a> |
<a href="/comm-central/log/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPModification.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPOperation.cpp">ldap/xpcom/src/nsLDAPOperation.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPOperation.cpp">file</a> |
<a href="/comm-central/annotate/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPOperation.cpp">annotate</a> |
<a href="/comm-central/diff/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPOperation.cpp">diff</a> |
<a href="/comm-central/comparison/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPOperation.cpp">comparison</a> |
<a href="/comm-central/log/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPOperation.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPOperation.h">ldap/xpcom/src/nsLDAPOperation.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPOperation.h">file</a> |
<a href="/comm-central/annotate/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPOperation.h">annotate</a> |
<a href="/comm-central/diff/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPOperation.h">diff</a> |
<a href="/comm-central/comparison/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPOperation.h">comparison</a> |
<a href="/comm-central/log/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPOperation.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPSecurityGlue.cpp">ldap/xpcom/src/nsLDAPSecurityGlue.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPSecurityGlue.cpp">file</a> |
<a href="/comm-central/annotate/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPSecurityGlue.cpp">annotate</a> |
<a href="/comm-central/diff/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPSecurityGlue.cpp">diff</a> |
<a href="/comm-central/comparison/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPSecurityGlue.cpp">comparison</a> |
<a href="/comm-central/log/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPSecurityGlue.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPServer.cpp">ldap/xpcom/src/nsLDAPServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPServer.cpp">file</a> |
<a href="/comm-central/annotate/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPServer.cpp">annotate</a> |
<a href="/comm-central/diff/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPServer.cpp">diff</a> |
<a href="/comm-central/comparison/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPServer.cpp">comparison</a> |
<a href="/comm-central/log/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPServer.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPServer.h">ldap/xpcom/src/nsLDAPServer.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPServer.h">file</a> |
<a href="/comm-central/annotate/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPServer.h">annotate</a> |
<a href="/comm-central/diff/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPServer.h">diff</a> |
<a href="/comm-central/comparison/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPServer.h">comparison</a> |
<a href="/comm-central/log/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPServer.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPService.cpp">ldap/xpcom/src/nsLDAPService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPService.cpp">file</a> |
<a href="/comm-central/annotate/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPService.cpp">annotate</a> |
<a href="/comm-central/diff/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPService.cpp">diff</a> |
<a href="/comm-central/comparison/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPService.cpp">comparison</a> |
<a href="/comm-central/log/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPService.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPService.h">ldap/xpcom/src/nsLDAPService.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPService.h">file</a> |
<a href="/comm-central/annotate/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPService.h">annotate</a> |
<a href="/comm-central/diff/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPService.h">diff</a> |
<a href="/comm-central/comparison/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPService.h">comparison</a> |
<a href="/comm-central/log/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPService.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPSyncQuery.cpp">ldap/xpcom/src/nsLDAPSyncQuery.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPSyncQuery.cpp">file</a> |
<a href="/comm-central/annotate/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPSyncQuery.cpp">annotate</a> |
<a href="/comm-central/diff/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPSyncQuery.cpp">diff</a> |
<a href="/comm-central/comparison/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPSyncQuery.cpp">comparison</a> |
<a href="/comm-central/log/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPSyncQuery.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPSyncQuery.h">ldap/xpcom/src/nsLDAPSyncQuery.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPSyncQuery.h">file</a> |
<a href="/comm-central/annotate/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPSyncQuery.h">annotate</a> |
<a href="/comm-central/diff/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPSyncQuery.h">diff</a> |
<a href="/comm-central/comparison/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPSyncQuery.h">comparison</a> |
<a href="/comm-central/log/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPSyncQuery.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPURL.cpp">ldap/xpcom/src/nsLDAPURL.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPURL.cpp">file</a> |
<a href="/comm-central/annotate/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPURL.cpp">annotate</a> |
<a href="/comm-central/diff/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPURL.cpp">diff</a> |
<a href="/comm-central/comparison/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPURL.cpp">comparison</a> |
<a href="/comm-central/log/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPURL.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPUtils.h">ldap/xpcom/src/nsLDAPUtils.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPUtils.h">file</a> |
<a href="/comm-central/annotate/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPUtils.h">annotate</a> |
<a href="/comm-central/diff/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPUtils.h">diff</a> |
<a href="/comm-central/comparison/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPUtils.h">comparison</a> |
<a href="/comm-central/log/c016e832aabb8c66e333736740e5f894b7949414/ldap/xpcom/src/nsLDAPUtils.h">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/ldap/xpcom/src/Makefile.in</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/ldap/xpcom/src/Makefile.in</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -43,18 +43,24 @@ VPATH		= @srcdir@</span>
<a href="#l1.4"></a><span id="l1.4"> </span>
<a href="#l1.5"></a><span id="l1.5"> include $(DEPTH)/config/autoconf.mk</span>
<a href="#l1.6"></a><span id="l1.6"> </span>
<a href="#l1.7"></a><span id="l1.7"> MODULE		= mozldap</span>
<a href="#l1.8"></a><span id="l1.8"> LIBRARY_NAME	= mozldap</span>
<a href="#l1.9"></a><span id="l1.9"> EXPORT_LIBRARY	= 1</span>
<a href="#l1.10"></a><span id="l1.10"> IS_COMPONENT	= 1</span>
<a href="#l1.11"></a><span id="l1.11"> MODULE_NAME	= nsLDAPProtocolModule</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+ifndef MOZ_INCOMPLETE_EXTERNAL_LINKAGE</span>
<a href="#l1.14"></a><span id="l1.14"> MOZILLA_INTERNAL_API = 1</span>
<a href="#l1.15"></a><span id="l1.15"> LIBXUL_LIBRARY	= 1</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+else</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+FORCE_SHARED_LIB = 1</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+GRE_MODULE	= 1</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+endif</span>
<a href="#l1.20"></a><span id="l1.20"> </span>
<a href="#l1.21"></a><span id="l1.21"> EXTRA_COMPONENTS = \</span>
<a href="#l1.22"></a><span id="l1.22"> 		nsLDAPProtocolHandler.js \</span>
<a href="#l1.23"></a><span id="l1.23"> 		ldapComponents.manifest \</span>
<a href="#l1.24"></a><span id="l1.24"> 		$(NULL)</span>
<a href="#l1.25"></a><span id="l1.25"> </span>
<a href="#l1.26"></a><span id="l1.26"> CPPSRCS		= \</span>
<a href="#l1.27"></a><span id="l1.27"> 		nsLDAPProtocolModule.cpp \</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineat">@@ -79,12 +85,18 @@ endif</span>
<a href="#l1.29"></a><span id="l1.29"> ifdef MOZ_PSM</span>
<a href="#l1.30"></a><span id="l1.30"> DEFINES		+= -DMOZ_PSM</span>
<a href="#l1.31"></a><span id="l1.31"> CPPSRCS		+= \</span>
<a href="#l1.32"></a><span id="l1.32"> 		nsLDAPSecurityGlue.cpp \</span>
<a href="#l1.33"></a><span id="l1.33"> 		$(NULL)</span>
<a href="#l1.34"></a><span id="l1.34"> endif</span>
<a href="#l1.35"></a><span id="l1.35"> </span>
<a href="#l1.36"></a><span id="l1.36"> EXTRA_DSO_LDOPTS += $(MOZ_COMPONENT_LIBS) $(LDAP_LIBS)</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+ifdef MOZ_INCOMPLETE_EXTERNAL_LINKAGE</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+EXTRA_DSO_LDOPTS += \</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+	$(XPCOM_GLUE_LDOPTS) \</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+	$(NULL)</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineplus">+endif</span>
<a href="#l1.42"></a><span id="l1.42"> </span>
<a href="#l1.43"></a><span id="l1.43"> include $(topsrcdir)/config/rules.mk</span>
<a href="#l1.44"></a><span id="l1.44"> </span>
<a href="#l1.45"></a><span id="l1.45"> LOCAL_INCLUDES	= $(LDAP_CFLAGS)</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/ldap/xpcom/src/nsLDAPBERElement.cpp</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/ldap/xpcom/src/nsLDAPBERElement.cpp</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -33,17 +33,17 @@</span>
<a href="#l2.4"></a><span id="l2.4">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l2.5"></a><span id="l2.5">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l2.6"></a><span id="l2.6">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l2.7"></a><span id="l2.7">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l2.8"></a><span id="l2.8">  *</span>
<a href="#l2.9"></a><span id="l2.9">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l2.10"></a><span id="l2.10"> </span>
<a href="#l2.11"></a><span id="l2.11"> #include &quot;nsLDAPBERElement.h&quot;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-#include &quot;nsString.h&quot;</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+#include &quot;nsStringGlue.h&quot;</span>
<a href="#l2.14"></a><span id="l2.14"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l2.15"></a><span id="l2.15"> #include &quot;nsLDAPBERValue.h&quot;</span>
<a href="#l2.16"></a><span id="l2.16"> </span>
<a href="#l2.17"></a><span id="l2.17"> NS_IMPL_ISUPPORTS1(nsLDAPBERElement, nsILDAPBERElement)</span>
<a href="#l2.18"></a><span id="l2.18"> </span>
<a href="#l2.19"></a><span id="l2.19"> nsLDAPBERElement::nsLDAPBERElement()</span>
<a href="#l2.20"></a><span id="l2.20">   : mElement(0)</span>
<a href="#l2.21"></a><span id="l2.21"> {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/ldap/xpcom/src/nsLDAPBERValue.cpp</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/ldap/xpcom/src/nsLDAPBERValue.cpp</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -34,18 +34,17 @@</span>
<a href="#l3.4"></a><span id="l3.4">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l3.5"></a><span id="l3.5">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l3.6"></a><span id="l3.6">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l3.7"></a><span id="l3.7">  *</span>
<a href="#l3.8"></a><span id="l3.8">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l3.9"></a><span id="l3.9"> </span>
<a href="#l3.10"></a><span id="l3.10"> #include &quot;nsLDAPBERValue.h&quot;</span>
<a href="#l3.11"></a><span id="l3.11"> #include &quot;nsMemory.h&quot;</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-#include &quot;nsString.h&quot;</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-#include &quot;nsReadableUtils.h&quot;</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+#include &quot;nsStringGlue.h&quot;</span>
<a href="#l3.15"></a><span id="l3.15"> </span>
<a href="#l3.16"></a><span id="l3.16"> NS_IMPL_THREADSAFE_ISUPPORTS1(nsLDAPBERValue, nsILDAPBERValue)</span>
<a href="#l3.17"></a><span id="l3.17"> </span>
<a href="#l3.18"></a><span id="l3.18"> nsLDAPBERValue::nsLDAPBERValue() : mValue(0), mSize(0)</span>
<a href="#l3.19"></a><span id="l3.19"> {</span>
<a href="#l3.20"></a><span id="l3.20"> }</span>
<a href="#l3.21"></a><span id="l3.21"> </span>
<a href="#l3.22"></a><span id="l3.22"> nsLDAPBERValue::~nsLDAPBERValue()</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/ldap/xpcom/src/nsLDAPConnection.cpp</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/ldap/xpcom/src/nsLDAPConnection.cpp</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -40,34 +40,34 @@</span>
<a href="#l4.4"></a><span id="l4.4">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l4.5"></a><span id="l4.5">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l4.6"></a><span id="l4.6">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l4.7"></a><span id="l4.7">  *</span>
<a href="#l4.8"></a><span id="l4.8">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l4.9"></a><span id="l4.9"> </span>
<a href="#l4.10"></a><span id="l4.10"> #include &quot;nsLDAPInternal.h&quot;</span>
<a href="#l4.11"></a><span id="l4.11"> #include &quot;nsIServiceManager.h&quot;</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-#include &quot;nsString.h&quot;</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-#include &quot;nsReadableUtils.h&quot;</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+#include &quot;nsStringGlue.h&quot;</span>
<a href="#l4.15"></a><span id="l4.15"> #include &quot;nsIComponentManager.h&quot;</span>
<a href="#l4.16"></a><span id="l4.16"> #include &quot;nsLDAPConnection.h&quot;</span>
<a href="#l4.17"></a><span id="l4.17"> #include &quot;nsLDAPMessage.h&quot;</span>
<a href="#l4.18"></a><span id="l4.18"> #include &quot;nsThreadUtils.h&quot;</span>
<a href="#l4.19"></a><span id="l4.19"> #include &quot;nsIConsoleService.h&quot;</span>
<a href="#l4.20"></a><span id="l4.20"> #include &quot;nsIDNSService.h&quot;</span>
<a href="#l4.21"></a><span id="l4.21"> #include &quot;nsIDNSRecord.h&quot;</span>
<a href="#l4.22"></a><span id="l4.22"> #include &quot;nsIRequestObserver.h&quot;</span>
<a href="#l4.23"></a><span id="l4.23"> #include &quot;nsNetError.h&quot;</span>
<a href="#l4.24"></a><span id="l4.24"> #include &quot;nsLDAPOperation.h&quot;</span>
<a href="#l4.25"></a><span id="l4.25"> #include &quot;nsILDAPErrors.h&quot;</span>
<a href="#l4.26"></a><span id="l4.26"> #include &quot;nsIClassInfoImpl.h&quot;</span>
<a href="#l4.27"></a><span id="l4.27"> #include &quot;nsILDAPURL.h&quot;</span>
<a href="#l4.28"></a><span id="l4.28"> #include &quot;nsIObserverService.h&quot;</span>
<a href="#l4.29"></a><span id="l4.29"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l4.30"></a><span id="l4.30"> #include &quot;nsCRT.h&quot;</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+#include &quot;nsLDAPUtils.h&quot;</span>
<a href="#l4.32"></a><span id="l4.32"> </span>
<a href="#l4.33"></a><span id="l4.33"> const char kConsoleServiceContractId[] = &quot;@mozilla.org/consoleservice;1&quot;;</span>
<a href="#l4.34"></a><span id="l4.34"> const char kDNSServiceContractId[] = &quot;@mozilla.org/network/dns-service;1&quot;;</span>
<a href="#l4.35"></a><span id="l4.35"> </span>
<a href="#l4.36"></a><span id="l4.36"> // constructor</span>
<a href="#l4.37"></a><span id="l4.37"> //</span>
<a href="#l4.38"></a><span id="l4.38"> nsLDAPConnection::nsLDAPConnection()</span>
<a href="#l4.39"></a><span id="l4.39">     : mConnectionHandle(0),</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineat">@@ -77,17 +77,17 @@ nsLDAPConnection::nsLDAPConnection()</span>
<a href="#l4.41"></a><span id="l4.41"> {</span>
<a href="#l4.42"></a><span id="l4.42"> }</span>
<a href="#l4.43"></a><span id="l4.43"> </span>
<a href="#l4.44"></a><span id="l4.44"> // destructor</span>
<a href="#l4.45"></a><span id="l4.45"> //</span>
<a href="#l4.46"></a><span id="l4.46"> nsLDAPConnection::~nsLDAPConnection()</span>
<a href="#l4.47"></a><span id="l4.47"> {</span>
<a href="#l4.48"></a><span id="l4.48">   nsCOMPtr&lt;nsIObserverService&gt; obsServ =</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineminus">-      mozilla::services::GetObserverService();</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineplus">+      do_GetService(NS_OBSERVERSERVICE_CONTRACTID);</span>
<a href="#l4.51"></a><span id="l4.51">   if (obsServ)</span>
<a href="#l4.52"></a><span id="l4.52">       obsServ-&gt;RemoveObserver(this, &quot;profile-change-net-teardown&quot;);</span>
<a href="#l4.53"></a><span id="l4.53">   Close();</span>
<a href="#l4.54"></a><span id="l4.54"> }</span>
<a href="#l4.55"></a><span id="l4.55"> </span>
<a href="#l4.56"></a><span id="l4.56"> NS_IMPL_THREADSAFE_ADDREF(nsLDAPConnection)</span>
<a href="#l4.57"></a><span id="l4.57"> NS_IMPL_THREADSAFE_RELEASE(nsLDAPConnection)</span>
<a href="#l4.58"></a><span id="l4.58"> NS_IMPL_CLASSINFO(nsLDAPConnection, NULL, nsIClassInfo::THREADSAFE,</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineat">@@ -108,19 +108,20 @@ NS_IMPL_CI_INTERFACE_GETTER4(nsLDAPConne</span>
<a href="#l4.60"></a><span id="l4.60"> NS_IMETHODIMP</span>
<a href="#l4.61"></a><span id="l4.61"> nsLDAPConnection::Init(nsILDAPURL *aUrl, const nsACString &amp;aBindName,</span>
<a href="#l4.62"></a><span id="l4.62">                        nsILDAPMessageListener *aMessageListener,</span>
<a href="#l4.63"></a><span id="l4.63">                        nsISupports *aClosure, PRUint32 aVersion)</span>
<a href="#l4.64"></a><span id="l4.64"> {</span>
<a href="#l4.65"></a><span id="l4.65">   NS_ENSURE_ARG_POINTER(aUrl);</span>
<a href="#l4.66"></a><span id="l4.66">   NS_ENSURE_ARG_POINTER(aMessageListener);</span>
<a href="#l4.67"></a><span id="l4.67"> </span>
<a href="#l4.68"></a><span id="l4.68" class="difflineplus">+  nsresult rv;</span>
<a href="#l4.69"></a><span id="l4.69">   nsCOMPtr&lt;nsIObserverService&gt; obsServ =</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineminus">-      mozilla::services::GetObserverService();</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineminus">-</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineplus">+        do_GetService(NS_OBSERVERSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.74"></a><span id="l4.74">   // We have to abort all LDAP pending operation before shutdown.</span>
<a href="#l4.75"></a><span id="l4.75">   obsServ-&gt;AddObserver(this, &quot;profile-change-net-teardown&quot;, PR_TRUE);</span>
<a href="#l4.76"></a><span id="l4.76"> </span>
<a href="#l4.77"></a><span id="l4.77">   // Save various items that we'll use later</span>
<a href="#l4.78"></a><span id="l4.78">   mBindName.Assign(aBindName);</span>
<a href="#l4.79"></a><span id="l4.79">   mClosure = aClosure;</span>
<a href="#l4.80"></a><span id="l4.80">   mInitListener = aMessageListener;</span>
<a href="#l4.81"></a><span id="l4.81"> </span>
<a href="#l4.82"></a><span id="l4.82" class="difflineat">@@ -132,18 +133,16 @@ nsLDAPConnection::Init(nsILDAPURL *aUrl,</span>
<a href="#l4.83"></a><span id="l4.83">   // Check and save the version number</span>
<a href="#l4.84"></a><span id="l4.84">   if (aVersion != nsILDAPConnection::VERSION2 &amp;&amp;</span>
<a href="#l4.85"></a><span id="l4.85">       aVersion != nsILDAPConnection::VERSION3) {</span>
<a href="#l4.86"></a><span id="l4.86">     NS_ERROR(&quot;nsLDAPConnection::Init(): illegal version&quot;);</span>
<a href="#l4.87"></a><span id="l4.87">     return NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l4.88"></a><span id="l4.88">   }</span>
<a href="#l4.89"></a><span id="l4.89">   mVersion = aVersion;</span>
<a href="#l4.90"></a><span id="l4.90"> </span>
<a href="#l4.91"></a><span id="l4.91" class="difflineminus">-  nsresult rv;</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineminus">-</span>
<a href="#l4.93"></a><span id="l4.93">   // Get the port number, SSL flag for use later, once the DNS server(s)</span>
<a href="#l4.94"></a><span id="l4.94">   // has resolved the host part.</span>
<a href="#l4.95"></a><span id="l4.95">   rv = aUrl-&gt;GetPort(&amp;mPort);</span>
<a href="#l4.96"></a><span id="l4.96">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.97"></a><span id="l4.97"> </span>
<a href="#l4.98"></a><span id="l4.98">   PRUint32 options;</span>
<a href="#l4.99"></a><span id="l4.99">   rv = aUrl-&gt;GetOptions(&amp;options);</span>
<a href="#l4.100"></a><span id="l4.100">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.101"></a><span id="l4.101" class="difflineat">@@ -180,22 +179,22 @@ nsLDAPConnection::Init(nsILDAPURL *aUrl,</span>
<a href="#l4.102"></a><span id="l4.102"> </span>
<a href="#l4.103"></a><span id="l4.103">   rv = aUrl-&gt;GetAsciiHost(mDNSHost);</span>
<a href="#l4.104"></a><span id="l4.104">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.105"></a><span id="l4.105"> </span>
<a href="#l4.106"></a><span id="l4.106">   // if the caller has passed in a space-delimited set of hosts, as the</span>
<a href="#l4.107"></a><span id="l4.107">   // ldap c-sdk allows, strip off the trailing hosts for now.</span>
<a href="#l4.108"></a><span id="l4.108">   // Soon, we'd like to make multiple hosts work, but now make</span>
<a href="#l4.109"></a><span id="l4.109">   // at least the first one work.</span>
<a href="#l4.110"></a><span id="l4.110" class="difflineminus">-  mDNSHost.CompressWhitespace(PR_TRUE, PR_TRUE);</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineplus">+  LdapCompressWhitespace(mDNSHost);</span>
<a href="#l4.112"></a><span id="l4.112"> </span>
<a href="#l4.113"></a><span id="l4.113">   PRInt32 spacePos = mDNSHost.FindChar(' ');</span>
<a href="#l4.114"></a><span id="l4.114">   // trim off trailing host(s)</span>
<a href="#l4.115"></a><span id="l4.115">   if (spacePos != kNotFound)</span>
<a href="#l4.116"></a><span id="l4.116" class="difflineminus">-    mDNSHost.Truncate(spacePos);</span>
<a href="#l4.117"></a><span id="l4.117" class="difflineplus">+    mDNSHost.SetLength(spacePos);</span>
<a href="#l4.118"></a><span id="l4.118"> </span>
<a href="#l4.119"></a><span id="l4.119">   rv = pDNSService-&gt;AsyncResolve(mDNSHost, 0, this, curThread,</span>
<a href="#l4.120"></a><span id="l4.120">                                  getter_AddRefs(mDNSRequest));</span>
<a href="#l4.121"></a><span id="l4.121"> </span>
<a href="#l4.122"></a><span id="l4.122">   if (NS_FAILED(rv)) {</span>
<a href="#l4.123"></a><span id="l4.123">     switch (rv) {</span>
<a href="#l4.124"></a><span id="l4.124">     case NS_ERROR_OUT_OF_MEMORY:</span>
<a href="#l4.125"></a><span id="l4.125">     case NS_ERROR_UNKNOWN_HOST:</span>
<a href="#l4.126"></a><span id="l4.126" class="difflineat">@@ -346,17 +345,17 @@ nsLDAPConnection::GetErrorString(PRUnich</span>
<a href="#l4.127"></a><span id="l4.127">     //</span>
<a href="#l4.128"></a><span id="l4.128">     char *rv = ldap_err2string(ldap_get_lderrno(mConnectionHandle, 0, 0));</span>
<a href="#l4.129"></a><span id="l4.129">     if (!rv) {</span>
<a href="#l4.130"></a><span id="l4.130">         return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l4.131"></a><span id="l4.131">     }</span>
<a href="#l4.132"></a><span id="l4.132"> </span>
<a href="#l4.133"></a><span id="l4.133">     // make a copy using the XPCOM shared allocator</span>
<a href="#l4.134"></a><span id="l4.134">     //</span>
<a href="#l4.135"></a><span id="l4.135" class="difflineminus">-    *_retval = UTF8ToNewUnicode(nsDependentCString(rv));</span>
<a href="#l4.136"></a><span id="l4.136" class="difflineplus">+    *_retval = ToNewUnicode(NS_ConvertUTF8toUTF16(rv));</span>
<a href="#l4.137"></a><span id="l4.137">     if (!*_retval) {</span>
<a href="#l4.138"></a><span id="l4.138">         return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l4.139"></a><span id="l4.139">     }</span>
<a href="#l4.140"></a><span id="l4.140">     return NS_OK;</span>
<a href="#l4.141"></a><span id="l4.141"> }</span>
<a href="#l4.142"></a><span id="l4.142"> </span>
<a href="#l4.143"></a><span id="l4.143"> /**</span>
<a href="#l4.144"></a><span id="l4.144">  * Add an nsILDAPOperation to the list of operations pending on</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/ldap/xpcom/src/nsLDAPConnection.h</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/ldap/xpcom/src/nsLDAPConnection.h</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -38,17 +38,17 @@</span>
<a href="#l5.4"></a><span id="l5.4">  *</span>
<a href="#l5.5"></a><span id="l5.5">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l5.6"></a><span id="l5.6"> </span>
<a href="#l5.7"></a><span id="l5.7"> #ifndef _nsLDAPConnection_h_</span>
<a href="#l5.8"></a><span id="l5.8"> #define _nsLDAPConnection_h_</span>
<a href="#l5.9"></a><span id="l5.9"> </span>
<a href="#l5.10"></a><span id="l5.10"> #include &quot;nsILDAPConnection.h&quot;</span>
<a href="#l5.11"></a><span id="l5.11"> #include &quot;ldap.h&quot;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-#include &quot;nsString.h&quot;</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+#include &quot;nsStringGlue.h&quot;</span>
<a href="#l5.14"></a><span id="l5.14"> #include &quot;nsIThread.h&quot;</span>
<a href="#l5.15"></a><span id="l5.15"> #include &quot;nsIRunnable.h&quot;</span>
<a href="#l5.16"></a><span id="l5.16"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l5.17"></a><span id="l5.17"> #include &quot;nsILDAPMessageListener.h&quot;</span>
<a href="#l5.18"></a><span id="l5.18"> #include &quot;nsInterfaceHashtable.h&quot;</span>
<a href="#l5.19"></a><span id="l5.19"> #include &quot;nspr.h&quot;</span>
<a href="#l5.20"></a><span id="l5.20"> #include &quot;nsWeakReference.h&quot;</span>
<a href="#l5.21"></a><span id="l5.21"> #include &quot;nsWeakPtr.h&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/ldap/xpcom/src/nsLDAPControl.h</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/ldap/xpcom/src/nsLDAPControl.h</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -35,17 +35,17 @@</span>
<a href="#l6.4"></a><span id="l6.4">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l6.5"></a><span id="l6.5">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l6.6"></a><span id="l6.6">  *</span>
<a href="#l6.7"></a><span id="l6.7">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l6.8"></a><span id="l6.8"> </span>
<a href="#l6.9"></a><span id="l6.9"> #include &quot;nsILDAPControl.h&quot;</span>
<a href="#l6.10"></a><span id="l6.10"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l6.11"></a><span id="l6.11"> #include &quot;nsILDAPBERValue.h&quot;</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-#include &quot;nsString.h&quot;</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+#include &quot;nsStringGlue.h&quot;</span>
<a href="#l6.14"></a><span id="l6.14"> #include &quot;ldap.h&quot;</span>
<a href="#l6.15"></a><span id="l6.15"> </span>
<a href="#l6.16"></a><span id="l6.16"> // {5B608BBE-C0EA-4f74-B209-9CDCD79EC401}</span>
<a href="#l6.17"></a><span id="l6.17"> #define NS_LDAPCONTROL_CID \</span>
<a href="#l6.18"></a><span id="l6.18">   { 0x5b608bbe, 0xc0ea, 0x4f74, \</span>
<a href="#l6.19"></a><span id="l6.19">       { 0xb2, 0x9, 0x9c, 0xdc, 0xd7, 0x9e, 0xc4, 0x1 } }</span>
<a href="#l6.20"></a><span id="l6.20"> </span>
<a href="#l6.21"></a><span id="l6.21"> class nsLDAPControl : public nsILDAPControl</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/ldap/xpcom/src/nsLDAPMessage.cpp</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/ldap/xpcom/src/nsLDAPMessage.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -38,21 +38,21 @@</span>
<a href="#l7.4"></a><span id="l7.4">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l7.5"></a><span id="l7.5"> </span>
<a href="#l7.6"></a><span id="l7.6"> #include &quot;nsLDAPInternal.h&quot;</span>
<a href="#l7.7"></a><span id="l7.7"> #include &quot;nsLDAPMessage.h&quot;</span>
<a href="#l7.8"></a><span id="l7.8"> #include &quot;nspr.h&quot;</span>
<a href="#l7.9"></a><span id="l7.9"> #include &quot;nsDebug.h&quot;</span>
<a href="#l7.10"></a><span id="l7.10"> #include &quot;nsCRT.h&quot;</span>
<a href="#l7.11"></a><span id="l7.11"> #include &quot;nsLDAPConnection.h&quot;</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-#include &quot;nsReadableUtils.h&quot;</span>
<a href="#l7.13"></a><span id="l7.13"> #include &quot;nsISupportsUtils.h&quot;</span>
<a href="#l7.14"></a><span id="l7.14"> #include &quot;nsLDAPBERValue.h&quot;</span>
<a href="#l7.15"></a><span id="l7.15"> #include &quot;nsILDAPErrors.h&quot;</span>
<a href="#l7.16"></a><span id="l7.16"> #include &quot;nsIClassInfoImpl.h&quot;</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+#include &quot;nsLDAPUtils.h&quot;</span>
<a href="#l7.18"></a><span id="l7.18"> </span>
<a href="#l7.19"></a><span id="l7.19"> NS_IMPL_CLASSINFO(nsLDAPMessage, NULL, nsIClassInfo::THREADSAFE,</span>
<a href="#l7.20"></a><span id="l7.20">                   NS_LDAPMESSAGE_CID)</span>
<a href="#l7.21"></a><span id="l7.21"> </span>
<a href="#l7.22"></a><span id="l7.22"> NS_IMPL_THREADSAFE_ADDREF(nsLDAPMessage)</span>
<a href="#l7.23"></a><span id="l7.23"> NS_IMPL_THREADSAFE_RELEASE(nsLDAPMessage)</span>
<a href="#l7.24"></a><span id="l7.24"> NS_INTERFACE_MAP_BEGIN(nsLDAPMessage)</span>
<a href="#l7.25"></a><span id="l7.25">   NS_INTERFACE_MAP_ENTRY(nsILDAPMessage)</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineat">@@ -532,19 +532,19 @@ nsLDAPMessage::GetValues(const char *aAt</span>
<a href="#l7.27"></a><span id="l7.27"> </span>
<a href="#l7.28"></a><span id="l7.28">     // clone the array (except for the trailing NULL entry) using the </span>
<a href="#l7.29"></a><span id="l7.29">     // shared allocator for XPCOM correctness</span>
<a href="#l7.30"></a><span id="l7.30">     //</span>
<a href="#l7.31"></a><span id="l7.31">     PRUint32 i;</span>
<a href="#l7.32"></a><span id="l7.32">     for ( i = 0 ; i &lt; numVals ; i++ ) {</span>
<a href="#l7.33"></a><span id="l7.33">         nsDependentCString sValue(values[i]);</span>
<a href="#l7.34"></a><span id="l7.34">         if (IsUTF8(sValue))</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineminus">-            (*aValues)[i] = UTF8ToNewUnicode(sValue);</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+            (*aValues)[i] = ToNewUnicode(NS_ConvertUTF8toUTF16(sValue));</span>
<a href="#l7.37"></a><span id="l7.37">         else</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineminus">-            (*aValues)[i] = ToNewUnicode(sValue);</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineplus">+            (*aValues)[i] = ToNewUnicode(NS_ConvertASCIItoUTF16(sValue));</span>
<a href="#l7.40"></a><span id="l7.40">         if ( ! (*aValues)[i] ) {</span>
<a href="#l7.41"></a><span id="l7.41">             NS_FREE_XPCOM_ALLOCATED_POINTER_ARRAY(i, aValues);</span>
<a href="#l7.42"></a><span id="l7.42">             ldap_value_free(values);</span>
<a href="#l7.43"></a><span id="l7.43">             return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l7.44"></a><span id="l7.44">         }</span>
<a href="#l7.45"></a><span id="l7.45">     }</span>
<a href="#l7.46"></a><span id="l7.46"> </span>
<a href="#l7.47"></a><span id="l7.47">     // now free our value array since we already cloned the values array </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/ldap/xpcom/src/nsLDAPMessage.h</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/ldap/xpcom/src/nsLDAPMessage.h</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -39,17 +39,16 @@</span>
<a href="#l8.4"></a><span id="l8.4"> </span>
<a href="#l8.5"></a><span id="l8.5"> #ifndef _nsLDAPMessage_h_</span>
<a href="#l8.6"></a><span id="l8.6"> #define _nsLDAPMessage_h_</span>
<a href="#l8.7"></a><span id="l8.7"> </span>
<a href="#l8.8"></a><span id="l8.8"> #include &quot;ldap.h&quot;</span>
<a href="#l8.9"></a><span id="l8.9"> #include &quot;nsILDAPMessage.h&quot;</span>
<a href="#l8.10"></a><span id="l8.10"> #include &quot;nsILDAPOperation.h&quot;</span>
<a href="#l8.11"></a><span id="l8.11"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-#include &quot;nsHashtable.h&quot;</span>
<a href="#l8.13"></a><span id="l8.13"> </span>
<a href="#l8.14"></a><span id="l8.14"> // 76e061ad-a59f-43b6-b812-ee6e8e69423f</span>
<a href="#l8.15"></a><span id="l8.15"> //</span>
<a href="#l8.16"></a><span id="l8.16"> #define NS_LDAPMESSAGE_CID \</span>
<a href="#l8.17"></a><span id="l8.17"> { 0x76e061ad, 0xa59f, 0x43b6, \</span>
<a href="#l8.18"></a><span id="l8.18">   { 0xb8, 0x12, 0xee, 0x6e, 0x8e, 0x69, 0x42, 0x3f }}</span>
<a href="#l8.19"></a><span id="l8.19"> </span>
<a href="#l8.20"></a><span id="l8.20"> class nsLDAPMessage : public nsILDAPMessage</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/ldap/xpcom/src/nsLDAPModification.cpp</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/ldap/xpcom/src/nsLDAPModification.cpp</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -36,16 +36,17 @@</span>
<a href="#l9.4"></a><span id="l9.4">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l9.5"></a><span id="l9.5">  *</span>
<a href="#l9.6"></a><span id="l9.6">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l9.7"></a><span id="l9.7"> </span>
<a href="#l9.8"></a><span id="l9.8"> #include &quot;nsLDAPModification.h&quot;</span>
<a href="#l9.9"></a><span id="l9.9"> #include &quot;nsILDAPBERValue.h&quot;</span>
<a href="#l9.10"></a><span id="l9.10"> #include &quot;nsISimpleEnumerator.h&quot;</span>
<a href="#l9.11"></a><span id="l9.11"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+#include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l9.13"></a><span id="l9.13"> </span>
<a href="#l9.14"></a><span id="l9.14"> using namespace mozilla;</span>
<a href="#l9.15"></a><span id="l9.15"> </span>
<a href="#l9.16"></a><span id="l9.16"> NS_IMPL_THREADSAFE_ISUPPORTS1(nsLDAPModification, nsILDAPModification)</span>
<a href="#l9.17"></a><span id="l9.17"> </span>
<a href="#l9.18"></a><span id="l9.18"> // constructor</span>
<a href="#l9.19"></a><span id="l9.19"> //</span>
<a href="#l9.20"></a><span id="l9.20"> nsLDAPModification::nsLDAPModification()</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/ldap/xpcom/src/nsLDAPModification.h</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/ldap/xpcom/src/nsLDAPModification.h</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -36,17 +36,17 @@</span>
<a href="#l10.4"></a><span id="l10.4">  *</span>
<a href="#l10.5"></a><span id="l10.5">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l10.6"></a><span id="l10.6"> </span>
<a href="#l10.7"></a><span id="l10.7"> #ifndef _nsLDAPModification_h_</span>
<a href="#l10.8"></a><span id="l10.8"> #define _nsLDAPModification_h_</span>
<a href="#l10.9"></a><span id="l10.9"> </span>
<a href="#l10.10"></a><span id="l10.10"> #include &quot;nsILDAPModification.h&quot;</span>
<a href="#l10.11"></a><span id="l10.11"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-#include &quot;nsString.h&quot;</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+#include &quot;nsStringGlue.h&quot;</span>
<a href="#l10.14"></a><span id="l10.14"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l10.15"></a><span id="l10.15"> #include &quot;mozilla/Mutex.h&quot;</span>
<a href="#l10.16"></a><span id="l10.16"> </span>
<a href="#l10.17"></a><span id="l10.17"> // 5b0f4d00-062e-11d6-a7f2-fc943c3c039c</span>
<a href="#l10.18"></a><span id="l10.18"> //</span>
<a href="#l10.19"></a><span id="l10.19"> #define NS_LDAPMODIFICATION_CID \</span>
<a href="#l10.20"></a><span id="l10.20"> { 0x5b0f4d00, 0x062e, 0x11d6, \</span>
<a href="#l10.21"></a><span id="l10.21">   { 0xa7, 0xf2, 0xfc, 0x94, 0x3c, 0x3c, 0x03, 0x9c }}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/ldap/xpcom/src/nsLDAPOperation.cpp</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/ldap/xpcom/src/nsLDAPOperation.cpp</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -39,24 +39,24 @@</span>
<a href="#l11.4"></a><span id="l11.4">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l11.5"></a><span id="l11.5"> </span>
<a href="#l11.6"></a><span id="l11.6"> #include &quot;nsLDAPInternal.h&quot;</span>
<a href="#l11.7"></a><span id="l11.7"> #include &quot;nsLDAPOperation.h&quot;</span>
<a href="#l11.8"></a><span id="l11.8"> #include &quot;nsLDAPBERValue.h&quot;</span>
<a href="#l11.9"></a><span id="l11.9"> #include &quot;nsILDAPMessage.h&quot;</span>
<a href="#l11.10"></a><span id="l11.10"> #include &quot;nsILDAPModification.h&quot;</span>
<a href="#l11.11"></a><span id="l11.11"> #include &quot;nsIComponentManager.h&quot;</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-#include &quot;nsReadableUtils.h&quot;</span>
<a href="#l11.13"></a><span id="l11.13"> #include &quot;nspr.h&quot;</span>
<a href="#l11.14"></a><span id="l11.14"> #include &quot;nsISimpleEnumerator.h&quot;</span>
<a href="#l11.15"></a><span id="l11.15"> #include &quot;nsLDAPControl.h&quot;</span>
<a href="#l11.16"></a><span id="l11.16"> #include &quot;nsILDAPErrors.h&quot;</span>
<a href="#l11.17"></a><span id="l11.17"> #include &quot;nsIClassInfoImpl.h&quot;</span>
<a href="#l11.18"></a><span id="l11.18"> #include &quot;nsIAuthModule.h&quot;</span>
<a href="#l11.19"></a><span id="l11.19"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineplus">+#include &quot;nsMemory.h&quot;</span>
<a href="#l11.21"></a><span id="l11.21"> </span>
<a href="#l11.22"></a><span id="l11.22"> // Helper function</span>
<a href="#l11.23"></a><span id="l11.23"> static nsresult TranslateLDAPErrorToNSError(const int ldapError)</span>
<a href="#l11.24"></a><span id="l11.24"> {</span>
<a href="#l11.25"></a><span id="l11.25">   switch (ldapError) {</span>
<a href="#l11.26"></a><span id="l11.26">   case LDAP_SUCCESS:</span>
<a href="#l11.27"></a><span id="l11.27">     return NS_OK;</span>
<a href="#l11.28"></a><span id="l11.28"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/ldap/xpcom/src/nsLDAPOperation.h</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/ldap/xpcom/src/nsLDAPOperation.h</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -41,17 +41,17 @@</span>
<a href="#l12.4"></a><span id="l12.4"> #ifndef _nsLDAPOperation_h_</span>
<a href="#l12.5"></a><span id="l12.5"> #define _nsLDAPOperation_h_</span>
<a href="#l12.6"></a><span id="l12.6"> </span>
<a href="#l12.7"></a><span id="l12.7"> #include &quot;ldap.h&quot;</span>
<a href="#l12.8"></a><span id="l12.8"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l12.9"></a><span id="l12.9"> #include &quot;nsILDAPConnection.h&quot;</span>
<a href="#l12.10"></a><span id="l12.10"> #include &quot;nsILDAPOperation.h&quot;</span>
<a href="#l12.11"></a><span id="l12.11"> #include &quot;nsILDAPMessageListener.h&quot;</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-#include &quot;nsString.h&quot;</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+#include &quot;nsStringGlue.h&quot;</span>
<a href="#l12.14"></a><span id="l12.14"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l12.15"></a><span id="l12.15"> #include &quot;nsLDAPConnection.h&quot;</span>
<a href="#l12.16"></a><span id="l12.16"> </span>
<a href="#l12.17"></a><span id="l12.17"> // 97a479d0-9a44-47c6-a17a-87f9b00294bb</span>
<a href="#l12.18"></a><span id="l12.18"> #define NS_LDAPOPERATION_CID \</span>
<a href="#l12.19"></a><span id="l12.19"> { 0x97a479d0, 0x9a44, 0x47c6, \</span>
<a href="#l12.20"></a><span id="l12.20">   { 0xa1, 0x7a, 0x87, 0xf9, 0xb0, 0x02, 0x94, 0xbb}}</span>
<a href="#l12.21"></a><span id="l12.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/ldap/xpcom/src/nsLDAPSecurityGlue.cpp</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/ldap/xpcom/src/nsLDAPSecurityGlue.cpp</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -49,16 +49,18 @@</span>
<a href="#l13.4"></a><span id="l13.4"> #include &quot;nsIInterfaceRequestor.h&quot;</span>
<a href="#l13.5"></a><span id="l13.5"> #include &quot;nsNetCID.h&quot;</span>
<a href="#l13.6"></a><span id="l13.6"> #include &quot;nsISocketProvider.h&quot;</span>
<a href="#l13.7"></a><span id="l13.7"> #include &quot;nsISSLSocketControl.h&quot;</span>
<a href="#l13.8"></a><span id="l13.8"> #include &quot;nsMemory.h&quot;</span>
<a href="#l13.9"></a><span id="l13.9"> #include &quot;plstr.h&quot;</span>
<a href="#l13.10"></a><span id="l13.10"> #include &quot;ldap.h&quot;</span>
<a href="#l13.11"></a><span id="l13.11"> #include &quot;ldappr.h&quot;</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+#include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+#include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l13.14"></a><span id="l13.14"> </span>
<a href="#l13.15"></a><span id="l13.15"> // LDAP per-session data structure.</span>
<a href="#l13.16"></a><span id="l13.16"> //</span>
<a href="#l13.17"></a><span id="l13.17"> typedef struct {</span>
<a href="#l13.18"></a><span id="l13.18">     char *hostname;</span>
<a href="#l13.19"></a><span id="l13.19">     LDAP_X_EXTIOF_CLOSE_CALLBACK *realClose;</span>
<a href="#l13.20"></a><span id="l13.20">     LDAP_X_EXTIOF_CONNECT_CALLBACK *realConnect;</span>
<a href="#l13.21"></a><span id="l13.21">     LDAP_X_EXTIOF_DISPOSEHANDLE_CALLBACK *realDisposeHandle;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/ldap/xpcom/src/nsLDAPServer.cpp</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/ldap/xpcom/src/nsLDAPServer.cpp</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -34,17 +34,16 @@</span>
<a href="#l14.4"></a><span id="l14.4">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l14.5"></a><span id="l14.5">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l14.6"></a><span id="l14.6">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l14.7"></a><span id="l14.7">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l14.8"></a><span id="l14.8">  *</span>
<a href="#l14.9"></a><span id="l14.9">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l14.10"></a><span id="l14.10"> </span>
<a href="#l14.11"></a><span id="l14.11"> #include &quot;nsLDAPServer.h&quot;</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-#include &quot;nsReadableUtils.h&quot;</span>
<a href="#l14.13"></a><span id="l14.13"> </span>
<a href="#l14.14"></a><span id="l14.14"> NS_IMPL_THREADSAFE_ISUPPORTS1(nsLDAPServer, nsILDAPServer)</span>
<a href="#l14.15"></a><span id="l14.15"> </span>
<a href="#l14.16"></a><span id="l14.16"> nsLDAPServer::nsLDAPServer()</span>
<a href="#l14.17"></a><span id="l14.17">     : mSizeLimit(0),</span>
<a href="#l14.18"></a><span id="l14.18">       mProtocolVersion(nsILDAPConnection::VERSION3)</span>
<a href="#l14.19"></a><span id="l14.19"> {</span>
<a href="#l14.20"></a><span id="l14.20"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/ldap/xpcom/src/nsLDAPServer.h</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/ldap/xpcom/src/nsLDAPServer.h</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -33,17 +33,17 @@</span>
<a href="#l15.4"></a><span id="l15.4">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l15.5"></a><span id="l15.5">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l15.6"></a><span id="l15.6">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l15.7"></a><span id="l15.7">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l15.8"></a><span id="l15.8">  *</span>
<a href="#l15.9"></a><span id="l15.9">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l15.10"></a><span id="l15.10"> </span>
<a href="#l15.11"></a><span id="l15.11"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-#include &quot;nsString.h&quot;</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+#include &quot;nsStringGlue.h&quot;</span>
<a href="#l15.14"></a><span id="l15.14"> #include &quot;nsILDAPServer.h&quot;</span>
<a href="#l15.15"></a><span id="l15.15"> #include &quot;nsILDAPURL.h&quot;</span>
<a href="#l15.16"></a><span id="l15.16"> </span>
<a href="#l15.17"></a><span id="l15.17"> // 8bbbaa54-f316-4271-87c3-d52b5b1c1f5b</span>
<a href="#l15.18"></a><span id="l15.18"> #define NS_LDAPSERVER_CID \</span>
<a href="#l15.19"></a><span id="l15.19"> { 0x8bbbaa54, 0xf316, 0x4271, \</span>
<a href="#l15.20"></a><span id="l15.20">   { 0x87, 0xc3, 0xd5, 0x2b, 0x5b, 0x1c, 0x1f, 0x5b}}</span>
<a href="#l15.21"></a><span id="l15.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/ldap/xpcom/src/nsLDAPService.cpp</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/ldap/xpcom/src/nsLDAPService.cpp</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -37,23 +37,23 @@</span>
<a href="#l16.4"></a><span id="l16.4">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l16.5"></a><span id="l16.5">  *</span>
<a href="#l16.6"></a><span id="l16.6">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l16.7"></a><span id="l16.7"> </span>
<a href="#l16.8"></a><span id="l16.8"> #include &quot;nsLDAPInternal.h&quot;</span>
<a href="#l16.9"></a><span id="l16.9"> #include &quot;nsLDAPService.h&quot;</span>
<a href="#l16.10"></a><span id="l16.10"> #include &quot;nsLDAPConnection.h&quot;</span>
<a href="#l16.11"></a><span id="l16.11"> #include &quot;nsLDAPOperation.h&quot;</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-#include &quot;nsXPIDLString.h&quot;</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineminus">-#include &quot;nsReadableUtils.h&quot;</span>
<a href="#l16.14"></a><span id="l16.14"> #include &quot;nsIServiceManager.h&quot;</span>
<a href="#l16.15"></a><span id="l16.15"> #include &quot;nsIConsoleService.h&quot;</span>
<a href="#l16.16"></a><span id="l16.16"> #include &quot;nsILDAPURL.h&quot;</span>
<a href="#l16.17"></a><span id="l16.17"> #include &quot;nsCRT.h&quot;</span>
<a href="#l16.18"></a><span id="l16.18"> #include &quot;nsILDAPErrors.h&quot;</span>
<a href="#l16.19"></a><span id="l16.19" class="difflineplus">+#include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l16.20"></a><span id="l16.20" class="difflineplus">+#include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l16.21"></a><span id="l16.21"> </span>
<a href="#l16.22"></a><span id="l16.22"> using namespace mozilla;</span>
<a href="#l16.23"></a><span id="l16.23"> </span>
<a href="#l16.24"></a><span id="l16.24"> // Constants for CIDs used here.</span>
<a href="#l16.25"></a><span id="l16.25"> //</span>
<a href="#l16.26"></a><span id="l16.26"> static NS_DEFINE_CID(kLDAPConnectionCID, NS_LDAPCONNECTION_CID);</span>
<a href="#l16.27"></a><span id="l16.27"> static NS_DEFINE_CID(kLDAPOperationCID, NS_LDAPOPERATION_CID);</span>
<a href="#l16.28"></a><span id="l16.28"> </span>
<a href="#l16.29"></a><span id="l16.29" class="difflineat">@@ -67,22 +67,16 @@ nsLDAPServiceEntry::nsLDAPServiceEntry()</span>
<a href="#l16.30"></a><span id="l16.30">     : mLeases(0),</span>
<a href="#l16.31"></a><span id="l16.31">       mDelete(PR_FALSE),</span>
<a href="#l16.32"></a><span id="l16.32">       mRebinding(PR_FALSE)</span>
<a href="#l16.33"></a><span id="l16.33"> </span>
<a href="#l16.34"></a><span id="l16.34"> {</span>
<a href="#l16.35"></a><span id="l16.35">     mTimestamp = LL_Zero();</span>
<a href="#l16.36"></a><span id="l16.36"> }</span>
<a href="#l16.37"></a><span id="l16.37"> </span>
<a href="#l16.38"></a><span id="l16.38" class="difflineminus">-// destructor</span>
<a href="#l16.39"></a><span id="l16.39" class="difflineminus">-//</span>
<a href="#l16.40"></a><span id="l16.40" class="difflineminus">-nsLDAPServiceEntry::~nsLDAPServiceEntry()</span>
<a href="#l16.41"></a><span id="l16.41" class="difflineminus">-{</span>
<a href="#l16.42"></a><span id="l16.42" class="difflineminus">-}</span>
<a href="#l16.43"></a><span id="l16.43" class="difflineminus">-</span>
<a href="#l16.44"></a><span id="l16.44"> // Init function</span>
<a href="#l16.45"></a><span id="l16.45"> //</span>
<a href="#l16.46"></a><span id="l16.46"> bool nsLDAPServiceEntry::Init()</span>
<a href="#l16.47"></a><span id="l16.47"> {</span>
<a href="#l16.48"></a><span id="l16.48">     return PR_TRUE;</span>
<a href="#l16.49"></a><span id="l16.49"> }</span>
<a href="#l16.50"></a><span id="l16.50"> </span>
<a href="#l16.51"></a><span id="l16.51"> // Set/Get the timestamp when this server was last used. We might have</span>
<a href="#l16.52"></a><span id="l16.52" class="difflineat">@@ -223,65 +217,48 @@ bool nsLDAPServiceEntry::DeleteEntry()</span>
<a href="#l16.53"></a><span id="l16.53"> NS_IMPL_THREADSAFE_ISUPPORTS2(nsLDAPService,</span>
<a href="#l16.54"></a><span id="l16.54">                               nsILDAPService,</span>
<a href="#l16.55"></a><span id="l16.55">                               nsILDAPMessageListener)</span>
<a href="#l16.56"></a><span id="l16.56"> </span>
<a href="#l16.57"></a><span id="l16.57"> </span>
<a href="#l16.58"></a><span id="l16.58"> // constructor</span>
<a href="#l16.59"></a><span id="l16.59"> //</span>
<a href="#l16.60"></a><span id="l16.60"> nsLDAPService::nsLDAPService()</span>
<a href="#l16.61"></a><span id="l16.61" class="difflineminus">-    : mLock(&quot;nsLDAPService.mLock&quot;),</span>
<a href="#l16.62"></a><span id="l16.62" class="difflineminus">-      mServers(0),</span>
<a href="#l16.63"></a><span id="l16.63" class="difflineminus">-      mConnections(0)</span>
<a href="#l16.64"></a><span id="l16.64" class="difflineplus">+    : mLock(&quot;nsLDAPService.mLock&quot;)</span>
<a href="#l16.65"></a><span id="l16.65"> {</span>
<a href="#l16.66"></a><span id="l16.66"> }</span>
<a href="#l16.67"></a><span id="l16.67"> </span>
<a href="#l16.68"></a><span id="l16.68"> // destructor</span>
<a href="#l16.69"></a><span id="l16.69"> //</span>
<a href="#l16.70"></a><span id="l16.70"> nsLDAPService::~nsLDAPService()</span>
<a href="#l16.71"></a><span id="l16.71"> {</span>
<a href="#l16.72"></a><span id="l16.72" class="difflineminus">-    // Delete the hash table holding the entries</span>
<a href="#l16.73"></a><span id="l16.73" class="difflineminus">-    if (mServers) {</span>
<a href="#l16.74"></a><span id="l16.74" class="difflineminus">-        delete mServers;</span>
<a href="#l16.75"></a><span id="l16.75" class="difflineminus">-    }</span>
<a href="#l16.76"></a><span id="l16.76" class="difflineminus">-</span>
<a href="#l16.77"></a><span id="l16.77" class="difflineminus">-    // Delete the hash holding the &quot;reverse&quot; lookups from conn to server</span>
<a href="#l16.78"></a><span id="l16.78" class="difflineminus">-    if (mConnections) {</span>
<a href="#l16.79"></a><span id="l16.79" class="difflineminus">-        delete mConnections;</span>
<a href="#l16.80"></a><span id="l16.80" class="difflineminus">-    }</span>
<a href="#l16.81"></a><span id="l16.81"> }</span>
<a href="#l16.82"></a><span id="l16.82"> </span>
<a href="#l16.83"></a><span id="l16.83"> // Initializer, create some internal hash tables etc.</span>
<a href="#l16.84"></a><span id="l16.84"> //</span>
<a href="#l16.85"></a><span id="l16.85"> nsresult nsLDAPService::Init()</span>
<a href="#l16.86"></a><span id="l16.86"> {</span>
<a href="#l16.87"></a><span id="l16.87" class="difflineminus">-    if (!mServers) {</span>
<a href="#l16.88"></a><span id="l16.88" class="difflineminus">-        mServers = new nsHashtable(16, PR_FALSE);</span>
<a href="#l16.89"></a><span id="l16.89" class="difflineminus">-        if (!mServers) {</span>
<a href="#l16.90"></a><span id="l16.90" class="difflineminus">-            NS_ERROR(&quot;nsLDAPService::Init: out of memory &quot;);</span>
<a href="#l16.91"></a><span id="l16.91" class="difflineminus">-            return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l16.92"></a><span id="l16.92" class="difflineminus">-        }</span>
<a href="#l16.93"></a><span id="l16.93" class="difflineplus">+    if (!mServers.Init()) {</span>
<a href="#l16.94"></a><span id="l16.94" class="difflineplus">+        NS_ERROR(&quot;nsLDAPService::Init: out of memory &quot;);</span>
<a href="#l16.95"></a><span id="l16.95" class="difflineplus">+        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l16.96"></a><span id="l16.96">     }</span>
<a href="#l16.97"></a><span id="l16.97"> </span>
<a href="#l16.98"></a><span id="l16.98" class="difflineminus">-    if (!mConnections) {</span>
<a href="#l16.99"></a><span id="l16.99" class="difflineminus">-        mConnections = new nsHashtable(16, PR_FALSE);</span>
<a href="#l16.100"></a><span id="l16.100" class="difflineminus">-        if (!mConnections) {</span>
<a href="#l16.101"></a><span id="l16.101" class="difflineminus">-            NS_ERROR(&quot;nsLDAPService::Init: out of memory &quot;);</span>
<a href="#l16.102"></a><span id="l16.102" class="difflineminus">-            return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l16.103"></a><span id="l16.103" class="difflineminus">-        }</span>
<a href="#l16.104"></a><span id="l16.104" class="difflineplus">+    if (!mConnections.Init()) {</span>
<a href="#l16.105"></a><span id="l16.105" class="difflineplus">+        NS_ERROR(&quot;nsLDAPService::Init: out of memory &quot;);</span>
<a href="#l16.106"></a><span id="l16.106" class="difflineplus">+        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l16.107"></a><span id="l16.107">     }</span>
<a href="#l16.108"></a><span id="l16.108"> </span>
<a href="#l16.109"></a><span id="l16.109">     return NS_OK;</span>
<a href="#l16.110"></a><span id="l16.110"> }</span>
<a href="#l16.111"></a><span id="l16.111"> </span>
<a href="#l16.112"></a><span id="l16.112"> // void addServer (in nsILDAPServer aServer);</span>
<a href="#l16.113"></a><span id="l16.113"> NS_IMETHODIMP nsLDAPService::AddServer(nsILDAPServer *aServer)</span>
<a href="#l16.114"></a><span id="l16.114"> {</span>
<a href="#l16.115"></a><span id="l16.115">     nsLDAPServiceEntry *entry;</span>
<a href="#l16.116"></a><span id="l16.116" class="difflineminus">-    nsXPIDLString key;</span>
<a href="#l16.117"></a><span id="l16.117" class="difflineplus">+    nsString key;</span>
<a href="#l16.118"></a><span id="l16.118">     nsresult rv;</span>
<a href="#l16.119"></a><span id="l16.119">     </span>
<a href="#l16.120"></a><span id="l16.120">     if (!aServer) {</span>
<a href="#l16.121"></a><span id="l16.121">         NS_ERROR(&quot;nsLDAPService::AddServer: null pointer &quot;);</span>
<a href="#l16.122"></a><span id="l16.122">         return NS_ERROR_NULL_POINTER;</span>
<a href="#l16.123"></a><span id="l16.123">     }</span>
<a href="#l16.124"></a><span id="l16.124"> </span>
<a href="#l16.125"></a><span id="l16.125">     // Set up the hash key for the server entry</span>
<a href="#l16.126"></a><span id="l16.126" class="difflineat">@@ -318,45 +295,43 @@ NS_IMETHODIMP nsLDAPService::AddServer(n</span>
<a href="#l16.127"></a><span id="l16.127">         return NS_ERROR_FAILURE;</span>
<a href="#l16.128"></a><span id="l16.128">     }</span>
<a href="#l16.129"></a><span id="l16.129"> </span>
<a href="#l16.130"></a><span id="l16.130">     // We increment the refcount here for the server entry, when</span>
<a href="#l16.131"></a><span id="l16.131">     // we purge a server completely from the service (TBD), we</span>
<a href="#l16.132"></a><span id="l16.132">     // need to decrement the counter as well.</span>
<a href="#l16.133"></a><span id="l16.133">     //</span>
<a href="#l16.134"></a><span id="l16.134">     {</span>
<a href="#l16.135"></a><span id="l16.135" class="difflineminus">-        nsStringKey hashKey(key);</span>
<a href="#l16.136"></a><span id="l16.136">         MutexAutoLock lock(mLock);</span>
<a href="#l16.137"></a><span id="l16.137"> </span>
<a href="#l16.138"></a><span id="l16.138" class="difflineminus">-        if (mServers-&gt;Exists(&amp;hashKey)) {</span>
<a href="#l16.139"></a><span id="l16.139" class="difflineplus">+        if (mServers.Get(key)) {</span>
<a href="#l16.140"></a><span id="l16.140">             // Collision detected, lets just throw away this service entry</span>
<a href="#l16.141"></a><span id="l16.141">             // and keep the old one.</span>
<a href="#l16.142"></a><span id="l16.142">             //</span>
<a href="#l16.143"></a><span id="l16.143">             delete entry;</span>
<a href="#l16.144"></a><span id="l16.144">             return NS_ERROR_FAILURE;</span>
<a href="#l16.145"></a><span id="l16.145">         }</span>
<a href="#l16.146"></a><span id="l16.146" class="difflineminus">-        mServers-&gt;Put(&amp;hashKey, entry);</span>
<a href="#l16.147"></a><span id="l16.147" class="difflineplus">+        mServers.Put(key, entry);</span>
<a href="#l16.148"></a><span id="l16.148">     }</span>
<a href="#l16.149"></a><span id="l16.149">     NS_ADDREF(aServer);</span>
<a href="#l16.150"></a><span id="l16.150"> </span>
<a href="#l16.151"></a><span id="l16.151">     return NS_OK;</span>
<a href="#l16.152"></a><span id="l16.152"> }</span>
<a href="#l16.153"></a><span id="l16.153"> </span>
<a href="#l16.154"></a><span id="l16.154"> // void deleteServer (in wstring aKey);</span>
<a href="#l16.155"></a><span id="l16.155"> NS_IMETHODIMP nsLDAPService::DeleteServer(const PRUnichar *aKey)</span>
<a href="#l16.156"></a><span id="l16.156"> {</span>
<a href="#l16.157"></a><span id="l16.157">     nsLDAPServiceEntry *entry;</span>
<a href="#l16.158"></a><span id="l16.158" class="difflineminus">-    nsStringKey hashKey(aKey, -1, nsStringKey::NEVER_OWN);</span>
<a href="#l16.159"></a><span id="l16.159">     MutexAutoLock lock(mLock);</span>
<a href="#l16.160"></a><span id="l16.160">         </span>
<a href="#l16.161"></a><span id="l16.161">     // We should probably rename the key for this entry now that it's</span>
<a href="#l16.162"></a><span id="l16.162">     // &quot;deleted&quot;, so that we can add in a new one with the same ID.</span>
<a href="#l16.163"></a><span id="l16.163">     // This is bug #77669.</span>
<a href="#l16.164"></a><span id="l16.164">     //</span>
<a href="#l16.165"></a><span id="l16.165" class="difflineminus">-    entry = static_cast&lt;nsLDAPServiceEntry *&gt;(mServers-&gt;Get(&amp;hashKey));</span>
<a href="#l16.166"></a><span id="l16.166" class="difflineplus">+    mServers.Get(nsDependentString(aKey), &amp;entry);</span>
<a href="#l16.167"></a><span id="l16.167">     if (entry) {</span>
<a href="#l16.168"></a><span id="l16.168">         if (entry-&gt;GetLeases() &gt; 0) {</span>
<a href="#l16.169"></a><span id="l16.169">             return NS_ERROR_FAILURE;</span>
<a href="#l16.170"></a><span id="l16.170">         }</span>
<a href="#l16.171"></a><span id="l16.171">         entry-&gt;DeleteEntry();</span>
<a href="#l16.172"></a><span id="l16.172">     } else {</span>
<a href="#l16.173"></a><span id="l16.173">         // There is no Server entry for this key</span>
<a href="#l16.174"></a><span id="l16.174">         //</span>
<a href="#l16.175"></a><span id="l16.175" class="difflineat">@@ -366,26 +341,24 @@ NS_IMETHODIMP nsLDAPService::DeleteServe</span>
<a href="#l16.176"></a><span id="l16.176">     return NS_OK;</span>
<a href="#l16.177"></a><span id="l16.177"> }</span>
<a href="#l16.178"></a><span id="l16.178"> </span>
<a href="#l16.179"></a><span id="l16.179"> // nsILDAPServer getServer (in wstring aKey);</span>
<a href="#l16.180"></a><span id="l16.180"> NS_IMETHODIMP nsLDAPService::GetServer(const PRUnichar *aKey,</span>
<a href="#l16.181"></a><span id="l16.181">                                        nsILDAPServer **_retval)</span>
<a href="#l16.182"></a><span id="l16.182"> {</span>
<a href="#l16.183"></a><span id="l16.183">     nsLDAPServiceEntry *entry;</span>
<a href="#l16.184"></a><span id="l16.184" class="difflineminus">-    nsStringKey hashKey(aKey, -1, nsStringKey::NEVER_OWN);</span>
<a href="#l16.185"></a><span id="l16.185">     MutexAutoLock lock(mLock);</span>
<a href="#l16.186"></a><span id="l16.186"> </span>
<a href="#l16.187"></a><span id="l16.187">     if (!_retval) {</span>
<a href="#l16.188"></a><span id="l16.188">         NS_ERROR(&quot;nsLDAPService::GetServer: null pointer &quot;);</span>
<a href="#l16.189"></a><span id="l16.189">         return NS_ERROR_NULL_POINTER;</span>
<a href="#l16.190"></a><span id="l16.190">     }</span>
<a href="#l16.191"></a><span id="l16.191"> </span>
<a href="#l16.192"></a><span id="l16.192" class="difflineminus">-    entry = static_cast&lt;nsLDAPServiceEntry *&gt;(mServers-&gt;Get(&amp;hashKey));</span>
<a href="#l16.193"></a><span id="l16.193" class="difflineminus">-    if (!entry) {</span>
<a href="#l16.194"></a><span id="l16.194" class="difflineplus">+    if (!mServers.Get(nsDependentString(aKey), &amp;entry)) {</span>
<a href="#l16.195"></a><span id="l16.195">         *_retval = 0;</span>
<a href="#l16.196"></a><span id="l16.196">         return NS_ERROR_FAILURE;</span>
<a href="#l16.197"></a><span id="l16.197">     }</span>
<a href="#l16.198"></a><span id="l16.198">     if (!(*_retval = entry-&gt;GetServer().get())) {</span>
<a href="#l16.199"></a><span id="l16.199">         return NS_ERROR_FAILURE;</span>
<a href="#l16.200"></a><span id="l16.200">     }</span>
<a href="#l16.201"></a><span id="l16.201"> </span>
<a href="#l16.202"></a><span id="l16.202">     return NS_OK;</span>
<a href="#l16.203"></a><span id="l16.203" class="difflineat">@@ -395,30 +368,28 @@ NS_IMETHODIMP nsLDAPService::GetServer(c</span>
<a href="#l16.204"></a><span id="l16.204"> //                        in nsILDAPMessageListener aMessageListener);</span>
<a href="#l16.205"></a><span id="l16.205"> NS_IMETHODIMP nsLDAPService::RequestConnection(const PRUnichar *aKey,</span>
<a href="#l16.206"></a><span id="l16.206">                                  nsILDAPMessageListener *aListener)</span>
<a href="#l16.207"></a><span id="l16.207"> {</span>
<a href="#l16.208"></a><span id="l16.208">     nsLDAPServiceEntry *entry;</span>
<a href="#l16.209"></a><span id="l16.209">     nsCOMPtr&lt;nsILDAPConnection&gt; conn;</span>
<a href="#l16.210"></a><span id="l16.210">     nsCOMPtr&lt;nsILDAPMessage&gt; message;</span>
<a href="#l16.211"></a><span id="l16.211">     nsresult rv;</span>
<a href="#l16.212"></a><span id="l16.212" class="difflineminus">-    nsStringKey hashKey(aKey, -1, nsStringKey::NEVER_OWN);</span>
<a href="#l16.213"></a><span id="l16.213"> </span>
<a href="#l16.214"></a><span id="l16.214">     if (!aListener) {</span>
<a href="#l16.215"></a><span id="l16.215">         NS_ERROR(&quot;nsLDAPService::RequestConection: null pointer &quot;);</span>
<a href="#l16.216"></a><span id="l16.216">         return NS_ERROR_NULL_POINTER;</span>
<a href="#l16.217"></a><span id="l16.217">     }</span>
<a href="#l16.218"></a><span id="l16.218"> </span>
<a href="#l16.219"></a><span id="l16.219">     // Try to find a possibly cached connection and LDAP message.</span>
<a href="#l16.220"></a><span id="l16.220">     //</span>
<a href="#l16.221"></a><span id="l16.221">     {</span>
<a href="#l16.222"></a><span id="l16.222">         MutexAutoLock lock(mLock);</span>
<a href="#l16.223"></a><span id="l16.223"> </span>
<a href="#l16.224"></a><span id="l16.224" class="difflineminus">-        entry = static_cast&lt;nsLDAPServiceEntry *&gt;(mServers-&gt;Get(&amp;hashKey));</span>
<a href="#l16.225"></a><span id="l16.225" class="difflineminus">-        if (!entry) {</span>
<a href="#l16.226"></a><span id="l16.226" class="difflineplus">+        if (!mServers.Get(nsDependentString(aKey), &amp;entry)) {</span>
<a href="#l16.227"></a><span id="l16.227">             return NS_ERROR_FAILURE;</span>
<a href="#l16.228"></a><span id="l16.228">         }</span>
<a href="#l16.229"></a><span id="l16.229">         entry-&gt;SetTimestamp();</span>
<a href="#l16.230"></a><span id="l16.230"> </span>
<a href="#l16.231"></a><span id="l16.231">         conn = entry-&gt;GetConnection();</span>
<a href="#l16.232"></a><span id="l16.232">         message = entry-&gt;GetMessage();</span>
<a href="#l16.233"></a><span id="l16.233">     }</span>
<a href="#l16.234"></a><span id="l16.234"> </span>
<a href="#l16.235"></a><span id="l16.235" class="difflineat">@@ -440,63 +411,58 @@ NS_IMETHODIMP nsLDAPService::RequestConn</span>
<a href="#l16.236"></a><span id="l16.236">     }</span>
<a href="#l16.237"></a><span id="l16.237"> </span>
<a href="#l16.238"></a><span id="l16.238">     // We got a new connection, now push the listeners on our stack,</span>
<a href="#l16.239"></a><span id="l16.239">     // until we get the LDAP message back.</span>
<a href="#l16.240"></a><span id="l16.240">     //</span>
<a href="#l16.241"></a><span id="l16.241">     {</span>
<a href="#l16.242"></a><span id="l16.242">         MutexAutoLock lock(mLock);</span>
<a href="#l16.243"></a><span id="l16.243">             </span>
<a href="#l16.244"></a><span id="l16.244" class="difflineminus">-        entry = static_cast&lt;nsLDAPServiceEntry *&gt;(mServers-&gt;Get(&amp;hashKey));</span>
<a href="#l16.245"></a><span id="l16.245" class="difflineminus">-        if (!entry ||</span>
<a href="#l16.246"></a><span id="l16.246" class="difflineplus">+        if (!mServers.Get(nsDependentString(aKey), &amp;entry) ||</span>
<a href="#l16.247"></a><span id="l16.247">             !entry-&gt;PushListener(static_cast&lt;nsILDAPMessageListener *&gt;</span>
<a href="#l16.248"></a><span id="l16.248">                                             (aListener))) {</span>
<a href="#l16.249"></a><span id="l16.249">             return NS_ERROR_FAILURE;</span>
<a href="#l16.250"></a><span id="l16.250">         }</span>
<a href="#l16.251"></a><span id="l16.251">     }</span>
<a href="#l16.252"></a><span id="l16.252"> </span>
<a href="#l16.253"></a><span id="l16.253">     return NS_OK;</span>
<a href="#l16.254"></a><span id="l16.254"> }</span>
<a href="#l16.255"></a><span id="l16.255"> </span>
<a href="#l16.256"></a><span id="l16.256"> // nsILDAPConnection getConnection (in wstring aKey);</span>
<a href="#l16.257"></a><span id="l16.257"> NS_IMETHODIMP nsLDAPService::GetConnection(const PRUnichar *aKey,</span>
<a href="#l16.258"></a><span id="l16.258">                                            nsILDAPConnection **_retval)</span>
<a href="#l16.259"></a><span id="l16.259"> {</span>
<a href="#l16.260"></a><span id="l16.260">     nsLDAPServiceEntry *entry;</span>
<a href="#l16.261"></a><span id="l16.261" class="difflineminus">-    nsStringKey hashKey(aKey, -1, nsStringKey::NEVER_OWN);</span>
<a href="#l16.262"></a><span id="l16.262">     MutexAutoLock lock(mLock);</span>
<a href="#l16.263"></a><span id="l16.263"> </span>
<a href="#l16.264"></a><span id="l16.264">     if (!_retval) {</span>
<a href="#l16.265"></a><span id="l16.265">         NS_ERROR(&quot;nsLDAPService::GetConnection: null pointer &quot;);</span>
<a href="#l16.266"></a><span id="l16.266">         return NS_ERROR_NULL_POINTER;</span>
<a href="#l16.267"></a><span id="l16.267">     }</span>
<a href="#l16.268"></a><span id="l16.268"> </span>
<a href="#l16.269"></a><span id="l16.269" class="difflineminus">-    entry = static_cast&lt;nsLDAPServiceEntry *&gt;(mServers-&gt;Get(&amp;hashKey));</span>
<a href="#l16.270"></a><span id="l16.270" class="difflineminus">-    if (!entry) {</span>
<a href="#l16.271"></a><span id="l16.271" class="difflineplus">+    if (!mServers.Get(nsDependentString(aKey), &amp;entry)) {</span>
<a href="#l16.272"></a><span id="l16.272">         *_retval = 0;</span>
<a href="#l16.273"></a><span id="l16.273">         return NS_ERROR_FAILURE;</span>
<a href="#l16.274"></a><span id="l16.274">     }</span>
<a href="#l16.275"></a><span id="l16.275">     entry-&gt;SetTimestamp();</span>
<a href="#l16.276"></a><span id="l16.276">     entry-&gt;IncrementLeases();</span>
<a href="#l16.277"></a><span id="l16.277">     if (!(*_retval = entry-&gt;GetConnection().get())){</span>
<a href="#l16.278"></a><span id="l16.278">         return NS_ERROR_FAILURE;</span>
<a href="#l16.279"></a><span id="l16.279">     }</span>
<a href="#l16.280"></a><span id="l16.280"> </span>
<a href="#l16.281"></a><span id="l16.281">     return NS_OK;</span>
<a href="#l16.282"></a><span id="l16.282"> }</span>
<a href="#l16.283"></a><span id="l16.283"> </span>
<a href="#l16.284"></a><span id="l16.284"> // void releaseConnection (in wstring aKey);</span>
<a href="#l16.285"></a><span id="l16.285"> NS_IMETHODIMP nsLDAPService::ReleaseConnection(const PRUnichar *aKey)</span>
<a href="#l16.286"></a><span id="l16.286"> {</span>
<a href="#l16.287"></a><span id="l16.287">     nsLDAPServiceEntry *entry;</span>
<a href="#l16.288"></a><span id="l16.288" class="difflineminus">-    nsStringKey hashKey(aKey, -1, nsStringKey::NEVER_OWN);</span>
<a href="#l16.289"></a><span id="l16.289">     MutexAutoLock lock(mLock);</span>
<a href="#l16.290"></a><span id="l16.290"> </span>
<a href="#l16.291"></a><span id="l16.291" class="difflineminus">-    entry = static_cast&lt;nsLDAPServiceEntry *&gt;(mServers-&gt;Get(&amp;hashKey));</span>
<a href="#l16.292"></a><span id="l16.292" class="difflineminus">-    if (!entry) {</span>
<a href="#l16.293"></a><span id="l16.293" class="difflineplus">+    if (!mServers.Get(nsDependentString(aKey), &amp;entry)) {</span>
<a href="#l16.294"></a><span id="l16.294">         return NS_ERROR_FAILURE;</span>
<a href="#l16.295"></a><span id="l16.295">     }</span>
<a href="#l16.296"></a><span id="l16.296"> </span>
<a href="#l16.297"></a><span id="l16.297">     if (entry-&gt;GetLeases() &gt; 0) {</span>
<a href="#l16.298"></a><span id="l16.298">         entry-&gt;SetTimestamp();</span>
<a href="#l16.299"></a><span id="l16.299">         entry-&gt;DecrementLeases();</span>
<a href="#l16.300"></a><span id="l16.300">     } else {</span>
<a href="#l16.301"></a><span id="l16.301">         // Releasing a non-leased connection is currently a No-Op.</span>
<a href="#l16.302"></a><span id="l16.302" class="difflineat">@@ -508,28 +474,26 @@ NS_IMETHODIMP nsLDAPService::ReleaseConn</span>
<a href="#l16.303"></a><span id="l16.303"> </span>
<a href="#l16.304"></a><span id="l16.304"> // void reconnectConnection (in wstring aKey,</span>
<a href="#l16.305"></a><span id="l16.305"> //                           in nsILDAPMessageListener aMessageListener);</span>
<a href="#l16.306"></a><span id="l16.306"> NS_IMETHODIMP nsLDAPService::ReconnectConnection(const PRUnichar *aKey,</span>
<a href="#l16.307"></a><span id="l16.307">                                  nsILDAPMessageListener *aListener)</span>
<a href="#l16.308"></a><span id="l16.308"> {</span>
<a href="#l16.309"></a><span id="l16.309">     nsLDAPServiceEntry *entry;</span>
<a href="#l16.310"></a><span id="l16.310">     nsresult rv;</span>
<a href="#l16.311"></a><span id="l16.311" class="difflineminus">-    nsStringKey hashKey(aKey, -1, nsStringKey::NEVER_OWN);</span>
<a href="#l16.312"></a><span id="l16.312"> </span>
<a href="#l16.313"></a><span id="l16.313">     if (!aListener) {</span>
<a href="#l16.314"></a><span id="l16.314">         NS_ERROR(&quot;nsLDAPService::ReconnectConnection: null pointer &quot;);</span>
<a href="#l16.315"></a><span id="l16.315">         return NS_ERROR_NULL_POINTER;</span>
<a href="#l16.316"></a><span id="l16.316">     }</span>
<a href="#l16.317"></a><span id="l16.317"> </span>
<a href="#l16.318"></a><span id="l16.318">     {</span>
<a href="#l16.319"></a><span id="l16.319">         MutexAutoLock lock(mLock);</span>
<a href="#l16.320"></a><span id="l16.320">         </span>
<a href="#l16.321"></a><span id="l16.321" class="difflineminus">-        entry = static_cast&lt;nsLDAPServiceEntry *&gt;(mServers-&gt;Get(&amp;hashKey));</span>
<a href="#l16.322"></a><span id="l16.322" class="difflineminus">-        if (!entry) {</span>
<a href="#l16.323"></a><span id="l16.323" class="difflineplus">+        if (!mServers.Get(nsDependentString(aKey), &amp;entry)) {</span>
<a href="#l16.324"></a><span id="l16.324">             return NS_ERROR_FAILURE;</span>
<a href="#l16.325"></a><span id="l16.325">         }</span>
<a href="#l16.326"></a><span id="l16.326">         entry-&gt;SetTimestamp();</span>
<a href="#l16.327"></a><span id="l16.327"> </span>
<a href="#l16.328"></a><span id="l16.328">         if (entry-&gt;IsRebinding()) {</span>
<a href="#l16.329"></a><span id="l16.329">             if (!entry-&gt;PushListener(aListener)) {</span>
<a href="#l16.330"></a><span id="l16.330">                 return NS_ERROR_FAILURE;</span>
<a href="#l16.331"></a><span id="l16.331">             }</span>
<a href="#l16.332"></a><span id="l16.332" class="difflineat">@@ -616,23 +580,19 @@ nsLDAPService::OnLDAPMessage(nsILDAPMess</span>
<a href="#l16.333"></a><span id="l16.333"> </span>
<a href="#l16.334"></a><span id="l16.334">         // Now we have the connection, lets find the corresponding</span>
<a href="#l16.335"></a><span id="l16.335">         // server entry in the Service.</span>
<a href="#l16.336"></a><span id="l16.336">         //</span>
<a href="#l16.337"></a><span id="l16.337">         {</span>
<a href="#l16.338"></a><span id="l16.338">             nsCOMPtr&lt;nsILDAPMessageListener&gt; listener;</span>
<a href="#l16.339"></a><span id="l16.339">             nsCOMPtr&lt;nsILDAPMessage&gt; message;</span>
<a href="#l16.340"></a><span id="l16.340">             nsLDAPServiceEntry *entry;</span>
<a href="#l16.341"></a><span id="l16.341" class="difflineminus">-            nsVoidKey connKey(static_cast&lt;nsILDAPConnection *&gt;</span>
<a href="#l16.342"></a><span id="l16.342" class="difflineminus">-                                         (connection));</span>
<a href="#l16.343"></a><span id="l16.343">             MutexAutoLock lock(mLock);</span>
<a href="#l16.344"></a><span id="l16.344"> </span>
<a href="#l16.345"></a><span id="l16.345" class="difflineminus">-            entry = static_cast&lt;nsLDAPServiceEntry *&gt;</span>
<a href="#l16.346"></a><span id="l16.346" class="difflineminus">-                               (mConnections-&gt;Get(&amp;connKey));</span>
<a href="#l16.347"></a><span id="l16.347" class="difflineminus">-            if (!entry) {</span>
<a href="#l16.348"></a><span id="l16.348" class="difflineplus">+            if (!mConnections.Get(connection, &amp;entry)) {</span>
<a href="#l16.349"></a><span id="l16.349">                 return NS_ERROR_FAILURE;</span>
<a href="#l16.350"></a><span id="l16.350">             }</span>
<a href="#l16.351"></a><span id="l16.351"> </span>
<a href="#l16.352"></a><span id="l16.352">             message = entry-&gt;GetMessage();</span>
<a href="#l16.353"></a><span id="l16.353">             if (message) {</span>
<a href="#l16.354"></a><span id="l16.354">                 // We already have a message, lets keep that one.</span>
<a href="#l16.355"></a><span id="l16.355">                 //</span>
<a href="#l16.356"></a><span id="l16.356">                 return NS_ERROR_FAILURE;</span>
<a href="#l16.357"></a><span id="l16.357" class="difflineat">@@ -787,21 +747,20 @@ nsLDAPService::EstablishConnection(nsLDA</span>
<a href="#l16.358"></a><span id="l16.358">         return NS_OK;</span>
<a href="#l16.359"></a><span id="l16.359">     }</span>
<a href="#l16.360"></a><span id="l16.360"> </span>
<a href="#l16.361"></a><span id="l16.361">     // We made the connection, lets store it to the server entry,</span>
<a href="#l16.362"></a><span id="l16.362">     // and also update the reverse lookup tables (for finding the</span>
<a href="#l16.363"></a><span id="l16.363">     // server entry related to a particular connection).</span>
<a href="#l16.364"></a><span id="l16.364">     //</span>
<a href="#l16.365"></a><span id="l16.365">     {</span>
<a href="#l16.366"></a><span id="l16.366" class="difflineminus">-        nsVoidKey connKey(static_cast&lt;nsILDAPConnection *&gt;(conn));</span>
<a href="#l16.367"></a><span id="l16.367">         MutexAutoLock lock(mLock);</span>
<a href="#l16.368"></a><span id="l16.368"> </span>
<a href="#l16.369"></a><span id="l16.369">         aEntry-&gt;SetConnection(conn);</span>
<a href="#l16.370"></a><span id="l16.370" class="difflineminus">-        mConnections-&gt;Put(&amp;connKey, aEntry);</span>
<a href="#l16.371"></a><span id="l16.371" class="difflineplus">+        mConnections.Put(conn, aEntry);</span>
<a href="#l16.372"></a><span id="l16.372">     }</span>
<a href="#l16.373"></a><span id="l16.373"> </span>
<a href="#l16.374"></a><span id="l16.374">     // Setup the bind() operation.</span>
<a href="#l16.375"></a><span id="l16.375">     //</span>
<a href="#l16.376"></a><span id="l16.376">     operation = do_CreateInstance(kLDAPOperationCID, &amp;rv);</span>
<a href="#l16.377"></a><span id="l16.377">     if (NS_FAILED(rv)) {</span>
<a href="#l16.378"></a><span id="l16.378">         return NS_ERROR_FAILURE;</span>
<a href="#l16.379"></a><span id="l16.379">     }</span>
<a href="#l16.380"></a><span id="l16.380" class="difflineat">@@ -841,38 +800,34 @@ NS_IMETHODIMP nsLDAPService::CreateFilte</span>
<a href="#l16.381"></a><span id="l16.381">                                           const nsACString &amp; aAttr,</span>
<a href="#l16.382"></a><span id="l16.382">                                           const nsACString &amp; aValue,</span>
<a href="#l16.383"></a><span id="l16.383">                                           nsACString &amp; _retval)</span>
<a href="#l16.384"></a><span id="l16.384"> {</span>
<a href="#l16.385"></a><span id="l16.385">     if (!aMaxSize) {</span>
<a href="#l16.386"></a><span id="l16.386">         return NS_ERROR_INVALID_ARG;</span>
<a href="#l16.387"></a><span id="l16.387">     }</span>
<a href="#l16.388"></a><span id="l16.388"> </span>
<a href="#l16.389"></a><span id="l16.389" class="difflineminus">-    // prepare to tokenize |value| for %vM ... %vN</span>
<a href="#l16.390"></a><span id="l16.390" class="difflineminus">-    //</span>
<a href="#l16.391"></a><span id="l16.391" class="difflineminus">-    nsReadingIterator&lt;char&gt; iter, iterEnd; // setup the iterators</span>
<a href="#l16.392"></a><span id="l16.392" class="difflineminus">-    aValue.BeginReading(iter);</span>
<a href="#l16.393"></a><span id="l16.393" class="difflineminus">-    aValue.EndReading(iterEnd);</span>
<a href="#l16.394"></a><span id="l16.394" class="difflineminus">-</span>
<a href="#l16.395"></a><span id="l16.395">     // figure out how big of an array we're going to need for the tokens,</span>
<a href="#l16.396"></a><span id="l16.396">     // including a trailing NULL, and allocate space for it.</span>
<a href="#l16.397"></a><span id="l16.397">     //</span>
<a href="#l16.398"></a><span id="l16.398" class="difflineplus">+    const char *iter = aValue.BeginReading();</span>
<a href="#l16.399"></a><span id="l16.399" class="difflineplus">+    const char *iterEnd = aValue.EndReading();</span>
<a href="#l16.400"></a><span id="l16.400">     PRUint32 numTokens = CountTokens(iter, iterEnd); </span>
<a href="#l16.401"></a><span id="l16.401">     char **valueWords;</span>
<a href="#l16.402"></a><span id="l16.402">     valueWords = static_cast&lt;char **&gt;(nsMemory::Alloc((numTokens + 1) *</span>
<a href="#l16.403"></a><span id="l16.403">                                                 sizeof(char *)));</span>
<a href="#l16.404"></a><span id="l16.404">     if (!valueWords) {</span>
<a href="#l16.405"></a><span id="l16.405">         return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l16.406"></a><span id="l16.406">     }</span>
<a href="#l16.407"></a><span id="l16.407"> </span>
<a href="#l16.408"></a><span id="l16.408">     // build the array of values</span>
<a href="#l16.409"></a><span id="l16.409">     //</span>
<a href="#l16.410"></a><span id="l16.410">     PRUint32 curToken = 0;</span>
<a href="#l16.411"></a><span id="l16.411">     while (iter != iterEnd &amp;&amp; curToken &lt; numTokens ) {</span>
<a href="#l16.412"></a><span id="l16.412" class="difflineminus">-        valueWords[curToken] = NextToken(iter, iterEnd);</span>
<a href="#l16.413"></a><span id="l16.413" class="difflineplus">+        valueWords[curToken] = NextToken(&amp;iter, &amp;iterEnd);</span>
<a href="#l16.414"></a><span id="l16.414">         if ( !valueWords[curToken] ) {</span>
<a href="#l16.415"></a><span id="l16.415">             NS_FREE_XPCOM_ALLOCATED_POINTER_ARRAY(curToken, valueWords);</span>
<a href="#l16.416"></a><span id="l16.416">             return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l16.417"></a><span id="l16.417">         }</span>
<a href="#l16.418"></a><span id="l16.418">         curToken++;</span>
<a href="#l16.419"></a><span id="l16.419">     }</span>
<a href="#l16.420"></a><span id="l16.420">     valueWords[numTokens] = 0;  // end of array signal to LDAP C SDK</span>
<a href="#l16.421"></a><span id="l16.421"> </span>
<a href="#l16.422"></a><span id="l16.422" class="difflineat">@@ -1020,37 +975,37 @@ NS_IMETHODIMP nsLDAPService::ParseDn(con</span>
<a href="#l16.423"></a><span id="l16.423">     ldap_value_free(dnComponents);</span>
<a href="#l16.424"></a><span id="l16.424">     ldap_value_free(rdnComponents);</span>
<a href="#l16.425"></a><span id="l16.425">     return NS_OK;</span>
<a href="#l16.426"></a><span id="l16.426"> }</span>
<a href="#l16.427"></a><span id="l16.427"> </span>
<a href="#l16.428"></a><span id="l16.428"> // Count the number of space-separated tokens between aIter and aIterEnd</span>
<a href="#l16.429"></a><span id="l16.429"> //</span>
<a href="#l16.430"></a><span id="l16.430"> PRUint32</span>
<a href="#l16.431"></a><span id="l16.431" class="difflineminus">-nsLDAPService::CountTokens(nsReadingIterator&lt;char&gt; aIter,</span>
<a href="#l16.432"></a><span id="l16.432" class="difflineminus">-                           nsReadingIterator&lt;char&gt; aIterEnd)</span>
<a href="#l16.433"></a><span id="l16.433" class="difflineplus">+nsLDAPService::CountTokens(const char *aIter,</span>
<a href="#l16.434"></a><span id="l16.434" class="difflineplus">+                           const char *aIterEnd)</span>
<a href="#l16.435"></a><span id="l16.435"> {</span>
<a href="#l16.436"></a><span id="l16.436">     PRUint32 count(0);</span>
<a href="#l16.437"></a><span id="l16.437"> </span>
<a href="#l16.438"></a><span id="l16.438">     // keep iterating through the string until we hit the end</span>
<a href="#l16.439"></a><span id="l16.439">     //</span>
<a href="#l16.440"></a><span id="l16.440">     while (aIter != aIterEnd) {</span>
<a href="#l16.441"></a><span id="l16.441">     </span>
<a href="#l16.442"></a><span id="l16.442">         // move past any leading spaces</span>
<a href="#l16.443"></a><span id="l16.443">         //</span>
<a href="#l16.444"></a><span id="l16.444">         while (aIter != aIterEnd &amp;&amp;</span>
<a href="#l16.445"></a><span id="l16.445" class="difflineminus">-               ldap_utf8isspace(const_cast&lt;char *&gt;(aIter.get()))){</span>
<a href="#l16.446"></a><span id="l16.446" class="difflineplus">+               ldap_utf8isspace(const_cast&lt;char *&gt;(aIter))){</span>
<a href="#l16.447"></a><span id="l16.447">             ++aIter;</span>
<a href="#l16.448"></a><span id="l16.448">         }</span>
<a href="#l16.449"></a><span id="l16.449"> </span>
<a href="#l16.450"></a><span id="l16.450">         // move past all chars in this token</span>
<a href="#l16.451"></a><span id="l16.451">         //</span>
<a href="#l16.452"></a><span id="l16.452">         while (aIter != aIterEnd) {</span>
<a href="#l16.453"></a><span id="l16.453"> </span>
<a href="#l16.454"></a><span id="l16.454" class="difflineminus">-            if (ldap_utf8isspace(const_cast&lt;char *&gt;(aIter.get()))) {</span>
<a href="#l16.455"></a><span id="l16.455" class="difflineplus">+            if (ldap_utf8isspace(const_cast&lt;char *&gt;(aIter))) {</span>
<a href="#l16.456"></a><span id="l16.456">                 ++count;    // token finished; increment the count</span>
<a href="#l16.457"></a><span id="l16.457">                 ++aIter;    // move past the space</span>
<a href="#l16.458"></a><span id="l16.458">                 break;</span>
<a href="#l16.459"></a><span id="l16.459">             }</span>
<a href="#l16.460"></a><span id="l16.460"> </span>
<a href="#l16.461"></a><span id="l16.461">             ++aIter; // move to next char</span>
<a href="#l16.462"></a><span id="l16.462"> </span>
<a href="#l16.463"></a><span id="l16.463">             // if we've hit the end of this token and the end of this </span>
<a href="#l16.464"></a><span id="l16.464" class="difflineat">@@ -1065,29 +1020,29 @@ nsLDAPService::CountTokens(nsReadingIter</span>
<a href="#l16.465"></a><span id="l16.465">     }</span>
<a href="#l16.466"></a><span id="l16.466"> </span>
<a href="#l16.467"></a><span id="l16.467">     return count;</span>
<a href="#l16.468"></a><span id="l16.468"> }</span>
<a href="#l16.469"></a><span id="l16.469"> </span>
<a href="#l16.470"></a><span id="l16.470"> // return the next token in this iterator</span>
<a href="#l16.471"></a><span id="l16.471"> //</span>
<a href="#l16.472"></a><span id="l16.472"> char*</span>
<a href="#l16.473"></a><span id="l16.473" class="difflineminus">-nsLDAPService::NextToken(nsReadingIterator&lt;char&gt; &amp; aIter,</span>
<a href="#l16.474"></a><span id="l16.474" class="difflineminus">-                         nsReadingIterator&lt;char&gt; &amp; aIterEnd)</span>
<a href="#l16.475"></a><span id="l16.475" class="difflineplus">+nsLDAPService::NextToken(const char **aIter,</span>
<a href="#l16.476"></a><span id="l16.476" class="difflineplus">+                         const char **aIterEnd)</span>
<a href="#l16.477"></a><span id="l16.477"> {</span>
<a href="#l16.478"></a><span id="l16.478">     // move past any leading whitespace</span>
<a href="#l16.479"></a><span id="l16.479">     //</span>
<a href="#l16.480"></a><span id="l16.480" class="difflineminus">-    while (aIter != aIterEnd &amp;&amp;</span>
<a href="#l16.481"></a><span id="l16.481" class="difflineminus">-           ldap_utf8isspace(const_cast&lt;char *&gt;(aIter.get()))) {</span>
<a href="#l16.482"></a><span id="l16.482" class="difflineminus">-        ++aIter;</span>
<a href="#l16.483"></a><span id="l16.483" class="difflineplus">+    while (*aIter != *aIterEnd &amp;&amp;</span>
<a href="#l16.484"></a><span id="l16.484" class="difflineplus">+           ldap_utf8isspace(const_cast&lt;char *&gt;(*aIter))) {</span>
<a href="#l16.485"></a><span id="l16.485" class="difflineplus">+        ++(*aIter);</span>
<a href="#l16.486"></a><span id="l16.486">     }</span>
<a href="#l16.487"></a><span id="l16.487"> </span>
<a href="#l16.488"></a><span id="l16.488" class="difflineminus">-    nsACString::const_iterator start(aIter);</span>
<a href="#l16.489"></a><span id="l16.489" class="difflineplus">+    const char *start = *aIter;</span>
<a href="#l16.490"></a><span id="l16.490"> </span>
<a href="#l16.491"></a><span id="l16.491">     // copy the token into our local variable</span>
<a href="#l16.492"></a><span id="l16.492">     //</span>
<a href="#l16.493"></a><span id="l16.493" class="difflineminus">-    while (aIter != aIterEnd &amp;&amp;</span>
<a href="#l16.494"></a><span id="l16.494" class="difflineminus">-           !ldap_utf8isspace(const_cast&lt;char *&gt;(aIter.get()))) {</span>
<a href="#l16.495"></a><span id="l16.495" class="difflineminus">-        ++aIter;</span>
<a href="#l16.496"></a><span id="l16.496" class="difflineplus">+    while (*aIter != *aIterEnd &amp;&amp;</span>
<a href="#l16.497"></a><span id="l16.497" class="difflineplus">+           !ldap_utf8isspace(const_cast&lt;char *&gt;(*aIter))) {</span>
<a href="#l16.498"></a><span id="l16.498" class="difflineplus">+        ++(*aIter);</span>
<a href="#l16.499"></a><span id="l16.499">     }</span>
<a href="#l16.500"></a><span id="l16.500"> </span>
<a href="#l16.501"></a><span id="l16.501" class="difflineminus">-    return ToNewCString(Substring(start, aIter));</span>
<a href="#l16.502"></a><span id="l16.502" class="difflineplus">+    return ToNewCString(Substring(start, *aIter));</span>
<a href="#l16.503"></a><span id="l16.503"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/ldap/xpcom/src/nsLDAPService.h</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/ldap/xpcom/src/nsLDAPService.h</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -33,19 +33,19 @@</span>
<a href="#l17.4"></a><span id="l17.4">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l17.5"></a><span id="l17.5">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l17.6"></a><span id="l17.6">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l17.7"></a><span id="l17.7">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l17.8"></a><span id="l17.8">  *</span>
<a href="#l17.9"></a><span id="l17.9">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l17.10"></a><span id="l17.10"> </span>
<a href="#l17.11"></a><span id="l17.11"> #include &quot;ldap.h&quot;</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-#include &quot;nsString.h&quot;</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+#include &quot;nsStringGlue.h&quot;</span>
<a href="#l17.14"></a><span id="l17.14"> #include &quot;nsCOMArray.h&quot;</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineminus">-#include &quot;nsHashtable.h&quot;</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineplus">+#include &quot;nsDataHashtable.h&quot;</span>
<a href="#l17.17"></a><span id="l17.17"> #include &quot;nsILDAPService.h&quot;</span>
<a href="#l17.18"></a><span id="l17.18"> #include &quot;nsILDAPMessage.h&quot;</span>
<a href="#l17.19"></a><span id="l17.19"> #include &quot;nsILDAPMessageListener.h&quot;</span>
<a href="#l17.20"></a><span id="l17.20"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l17.21"></a><span id="l17.21"> #include &quot;nsILDAPServer.h&quot;</span>
<a href="#l17.22"></a><span id="l17.22"> #include &quot;nsILDAPConnection.h&quot;</span>
<a href="#l17.23"></a><span id="l17.23"> #include &quot;nsILDAPMessage.h&quot;</span>
<a href="#l17.24"></a><span id="l17.24"> #include &quot;mozilla/Mutex.h&quot;</span>
<a href="#l17.25"></a><span id="l17.25" class="difflineat">@@ -60,17 +60,17 @@</span>
<a href="#l17.26"></a><span id="l17.26"> </span>
<a href="#l17.27"></a><span id="l17.27"> // This is a little &quot;helper&quot; class, we use to store information</span>
<a href="#l17.28"></a><span id="l17.28"> // related to one Service entry (one LDAP server).</span>
<a href="#l17.29"></a><span id="l17.29"> //</span>
<a href="#l17.30"></a><span id="l17.30"> class nsLDAPServiceEntry</span>
<a href="#l17.31"></a><span id="l17.31"> {</span>
<a href="#l17.32"></a><span id="l17.32">   public:</span>
<a href="#l17.33"></a><span id="l17.33">     nsLDAPServiceEntry();</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineminus">-    virtual ~nsLDAPServiceEntry();</span>
<a href="#l17.35"></a><span id="l17.35" class="difflineplus">+    virtual ~nsLDAPServiceEntry() {};</span>
<a href="#l17.36"></a><span id="l17.36">     bool Init();</span>
<a href="#l17.37"></a><span id="l17.37"> </span>
<a href="#l17.38"></a><span id="l17.38">     inline PRUint32 GetLeases();</span>
<a href="#l17.39"></a><span id="l17.39">     inline void IncrementLeases();</span>
<a href="#l17.40"></a><span id="l17.40">     inline bool DecrementLeases();</span>
<a href="#l17.41"></a><span id="l17.41"> </span>
<a href="#l17.42"></a><span id="l17.42">     inline PRTime GetTimestamp();</span>
<a href="#l17.43"></a><span id="l17.43">     inline void SetTimestamp();</span>
<a href="#l17.44"></a><span id="l17.44" class="difflineat">@@ -126,24 +126,24 @@ class nsLDAPService : public nsILDAPServ</span>
<a href="#l17.45"></a><span id="l17.45"> </span>
<a href="#l17.46"></a><span id="l17.46">   protected:</span>
<a href="#l17.47"></a><span id="l17.47">     nsresult EstablishConnection(nsLDAPServiceEntry *,</span>
<a href="#l17.48"></a><span id="l17.48">                                  nsILDAPMessageListener *);</span>
<a href="#l17.49"></a><span id="l17.49"> </span>
<a href="#l17.50"></a><span id="l17.50">     // kinda like strtok_r, but with iterators.  for use by </span>
<a href="#l17.51"></a><span id="l17.51">     // createFilter</span>
<a href="#l17.52"></a><span id="l17.52">     //</span>
<a href="#l17.53"></a><span id="l17.53" class="difflineminus">-    char *NextToken(nsReadingIterator&lt;char&gt; &amp; aIter,</span>
<a href="#l17.54"></a><span id="l17.54" class="difflineminus">-                    nsReadingIterator&lt;char&gt; &amp; aIterEnd);</span>
<a href="#l17.55"></a><span id="l17.55" class="difflineplus">+    char *NextToken(const char **aIter, const char **aIterEnd);</span>
<a href="#l17.56"></a><span id="l17.56"> </span>
<a href="#l17.57"></a><span id="l17.57">     // count how many tokens are in this string; for use by</span>
<a href="#l17.58"></a><span id="l17.58">     // createFilter; note that unlike with NextToken, these params</span>
<a href="#l17.59"></a><span id="l17.59">     // are copies, not references.</span>
<a href="#l17.60"></a><span id="l17.60">     //</span>
<a href="#l17.61"></a><span id="l17.61" class="difflineminus">-    PRUint32 CountTokens(nsReadingIterator&lt;char&gt; aIter,</span>
<a href="#l17.62"></a><span id="l17.62" class="difflineminus">-                         nsReadingIterator&lt;char&gt; aIterEnd);</span>
<a href="#l17.63"></a><span id="l17.63" class="difflineplus">+    PRUint32 CountTokens(const char * aIter, const char * aIterEnd);</span>
<a href="#l17.64"></a><span id="l17.64">                    </span>
<a href="#l17.65"></a><span id="l17.65">     </span>
<a href="#l17.66"></a><span id="l17.66">     mozilla::Mutex mLock;       // Lock mechanism</span>
<a href="#l17.67"></a><span id="l17.67" class="difflineminus">-    nsHashtable *mServers;      // Hash table holding server entries</span>
<a href="#l17.68"></a><span id="l17.68" class="difflineminus">-    nsHashtable *mConnections;  // Hash table holding &quot;reverse&quot;</span>
<a href="#l17.69"></a><span id="l17.69" class="difflineminus">-                                // lookups from connection to server</span>
<a href="#l17.70"></a><span id="l17.70" class="difflineplus">+</span>
<a href="#l17.71"></a><span id="l17.71" class="difflineplus">+    // Hash table holding server entries</span>
<a href="#l17.72"></a><span id="l17.72" class="difflineplus">+    nsDataHashtable&lt;nsStringHashKey, nsLDAPServiceEntry*&gt; mServers;</span>
<a href="#l17.73"></a><span id="l17.73" class="difflineplus">+    // Hash table holding &quot;reverse&quot; lookups from connection to server</span>
<a href="#l17.74"></a><span id="l17.74" class="difflineplus">+    nsDataHashtable&lt;nsVoidPtrHashKey, nsLDAPServiceEntry*&gt; mConnections;</span>
<a href="#l17.75"></a><span id="l17.75"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/ldap/xpcom/src/nsLDAPSyncQuery.cpp</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/ldap/xpcom/src/nsLDAPSyncQuery.cpp</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -34,21 +34,22 @@</span>
<a href="#l18.4"></a><span id="l18.4">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l18.5"></a><span id="l18.5">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l18.6"></a><span id="l18.6">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l18.7"></a><span id="l18.7">  *</span>
<a href="#l18.8"></a><span id="l18.8">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l18.9"></a><span id="l18.9"> </span>
<a href="#l18.10"></a><span id="l18.10"> #include &quot;nsLDAPSyncQuery.h&quot;</span>
<a href="#l18.11"></a><span id="l18.11"> #include &quot;nsIServiceManager.h&quot;</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-#include &quot;nsXPIDLString.h&quot;</span>
<a href="#l18.13"></a><span id="l18.13"> #include &quot;nsILDAPErrors.h&quot;</span>
<a href="#l18.14"></a><span id="l18.14"> #include &quot;nsThreadUtils.h&quot;</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineminus">-#include &quot;nsReadableUtils.h&quot;</span>
<a href="#l18.16"></a><span id="l18.16"> #include &quot;nsILDAPMessage.h&quot;</span>
<a href="#l18.17"></a><span id="l18.17" class="difflineplus">+#include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l18.18"></a><span id="l18.18" class="difflineplus">+#include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l18.19"></a><span id="l18.19" class="difflineplus">+#include &quot;nsMemory.h&quot;</span>
<a href="#l18.20"></a><span id="l18.20"> </span>
<a href="#l18.21"></a><span id="l18.21"> // nsISupports Implementation</span>
<a href="#l18.22"></a><span id="l18.22"> </span>
<a href="#l18.23"></a><span id="l18.23"> NS_IMPL_THREADSAFE_ISUPPORTS2(nsLDAPSyncQuery, nsILDAPSyncQuery, nsILDAPMessageListener)</span>
<a href="#l18.24"></a><span id="l18.24"> </span>
<a href="#l18.25"></a><span id="l18.25"> // Constructor</span>
<a href="#l18.26"></a><span id="l18.26"> //</span>
<a href="#l18.27"></a><span id="l18.27"> nsLDAPSyncQuery::nsLDAPSyncQuery() :</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/ldap/xpcom/src/nsLDAPSyncQuery.h</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/ldap/xpcom/src/nsLDAPSyncQuery.h</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -37,17 +37,17 @@</span>
<a href="#l19.4"></a><span id="l19.4">  *</span>
<a href="#l19.5"></a><span id="l19.5">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l19.6"></a><span id="l19.6"> </span>
<a href="#l19.7"></a><span id="l19.7"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l19.8"></a><span id="l19.8"> #include &quot;nsILDAPConnection.h&quot;</span>
<a href="#l19.9"></a><span id="l19.9"> #include &quot;nsILDAPOperation.h&quot;</span>
<a href="#l19.10"></a><span id="l19.10"> #include &quot;nsILDAPMessageListener.h&quot;</span>
<a href="#l19.11"></a><span id="l19.11"> #include &quot;nsILDAPURL.h&quot;</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-#include &quot;nsString.h&quot;</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+#include &quot;nsStringGlue.h&quot;</span>
<a href="#l19.14"></a><span id="l19.14"> #include &quot;nsILDAPSyncQuery.h&quot;</span>
<a href="#l19.15"></a><span id="l19.15"> </span>
<a href="#l19.16"></a><span id="l19.16"> // DDDEE14E-ED81-4182-9323-C2AB22FBA68E</span>
<a href="#l19.17"></a><span id="l19.17"> #define NS_LDAPSYNCQUERY_CID \</span>
<a href="#l19.18"></a><span id="l19.18"> { 0xdddee14e, 0xed81, 0x4182, \</span>
<a href="#l19.19"></a><span id="l19.19">  { 0x93, 0x23, 0xc2, 0xab, 0x22, 0xfb, 0xa6, 0x8e }}</span>
<a href="#l19.20"></a><span id="l19.20"> </span>
<a href="#l19.21"></a><span id="l19.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/ldap/xpcom/src/nsLDAPURL.cpp</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/ldap/xpcom/src/nsLDAPURL.cpp</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -192,17 +192,17 @@ nsLDAPURL::SetSpec(const nsACString &amp;aSp</span>
<a href="#l20.4"></a><span id="l20.4">   // need to reset ourselves.</span>
<a href="#l20.5"></a><span id="l20.5">   nsCString originalSpec;</span>
<a href="#l20.6"></a><span id="l20.6">   nsresult rv = mBaseURL-&gt;GetSpec(originalSpec);</span>
<a href="#l20.7"></a><span id="l20.7">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.8"></a><span id="l20.8"> </span>
<a href="#l20.9"></a><span id="l20.9">   rv = mBaseURL-&gt;SetSpec(aSpec);</span>
<a href="#l20.10"></a><span id="l20.10">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.11"></a><span id="l20.11"> </span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-  rv = SetPathInternal(nsPromiseFlatCString(aSpec));</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+  rv = SetPathInternal(PromiseFlatCString(aSpec));</span>
<a href="#l20.14"></a><span id="l20.14">   if (NS_FAILED(rv))</span>
<a href="#l20.15"></a><span id="l20.15">     mBaseURL-&gt;SetSpec(originalSpec);</span>
<a href="#l20.16"></a><span id="l20.16"> </span>
<a href="#l20.17"></a><span id="l20.17">   return rv;</span>
<a href="#l20.18"></a><span id="l20.18"> }</span>
<a href="#l20.19"></a><span id="l20.19"> </span>
<a href="#l20.20"></a><span id="l20.20"> NS_IMETHODIMP nsLDAPURL::GetPrePath(nsACString &amp;_retval)</span>
<a href="#l20.21"></a><span id="l20.21"> {</span>
<a href="#l20.22"></a><span id="l20.22" class="difflineat">@@ -337,17 +337,17 @@ NS_IMETHODIMP nsLDAPURL::GetPath(nsACStr</span>
<a href="#l20.23"></a><span id="l20.23">   return mBaseURL-&gt;GetPath(_retval);</span>
<a href="#l20.24"></a><span id="l20.24"> }</span>
<a href="#l20.25"></a><span id="l20.25"> </span>
<a href="#l20.26"></a><span id="l20.26"> NS_IMETHODIMP nsLDAPURL::SetPath(const nsACString &amp;aPath)</span>
<a href="#l20.27"></a><span id="l20.27"> {</span>
<a href="#l20.28"></a><span id="l20.28">   if (!mBaseURL)</span>
<a href="#l20.29"></a><span id="l20.29">     return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l20.30"></a><span id="l20.30"> </span>
<a href="#l20.31"></a><span id="l20.31" class="difflineminus">-  nsresult rv = SetPathInternal(nsPromiseFlatCString(aPath));</span>
<a href="#l20.32"></a><span id="l20.32" class="difflineplus">+  nsresult rv = SetPathInternal(PromiseFlatCString(aPath));</span>
<a href="#l20.33"></a><span id="l20.33">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.34"></a><span id="l20.34"> </span>
<a href="#l20.35"></a><span id="l20.35">   return mBaseURL-&gt;SetPath(aPath);</span>
<a href="#l20.36"></a><span id="l20.36"> }</span>
<a href="#l20.37"></a><span id="l20.37"> </span>
<a href="#l20.38"></a><span id="l20.38"> NS_IMETHODIMP nsLDAPURL::GetAsciiSpec(nsACString &amp;_retval)</span>
<a href="#l20.39"></a><span id="l20.39"> {</span>
<a href="#l20.40"></a><span id="l20.40">   if (!mBaseURL)</span>
<a href="#l20.41"></a><span id="l20.41" class="difflineat">@@ -543,17 +543,17 @@ NS_IMETHODIMP nsLDAPURL::AddAttribute(co</span>
<a href="#l20.42"></a><span id="l20.42">   {</span>
<a href="#l20.43"></a><span id="l20.43">     mAttributes = ',';</span>
<a href="#l20.44"></a><span id="l20.44">     mAttributes.Append(aAttribute);</span>
<a href="#l20.45"></a><span id="l20.45">     mAttributes.Append(',');</span>
<a href="#l20.46"></a><span id="l20.46">   }</span>
<a href="#l20.47"></a><span id="l20.47">   else</span>
<a href="#l20.48"></a><span id="l20.48">   {</span>
<a href="#l20.49"></a><span id="l20.49">     // Wrap the attribute in commas, so that we can do an exact match.</span>
<a href="#l20.50"></a><span id="l20.50" class="difflineminus">-    nsCAutoString findAttribute(',');</span>
<a href="#l20.51"></a><span id="l20.51" class="difflineplus">+    nsCAutoString findAttribute(&quot;,&quot;);</span>
<a href="#l20.52"></a><span id="l20.52">     findAttribute.Append(aAttribute);</span>
<a href="#l20.53"></a><span id="l20.53">     findAttribute.Append(',');</span>
<a href="#l20.54"></a><span id="l20.54"> </span>
<a href="#l20.55"></a><span id="l20.55">     // Check to see if the attribute is already stored. If it is, then also</span>
<a href="#l20.56"></a><span id="l20.56">     // check to see if it is the last attribute in the string, or if the next</span>
<a href="#l20.57"></a><span id="l20.57">     // character is a comma, this means we won't match substrings.</span>
<a href="#l20.58"></a><span id="l20.58">     PRInt32 pos = mAttributes.Find(findAttribute, CaseInsensitiveCompare);</span>
<a href="#l20.59"></a><span id="l20.59">     if (pos != -1)</span>
<a href="#l20.60"></a><span id="l20.60" class="difflineat">@@ -573,17 +573,17 @@ NS_IMETHODIMP nsLDAPURL::AddAttribute(co</span>
<a href="#l20.61"></a><span id="l20.61"> NS_IMETHODIMP nsLDAPURL::RemoveAttribute(const nsACString &amp;aAttribute)</span>
<a href="#l20.62"></a><span id="l20.62"> {</span>
<a href="#l20.63"></a><span id="l20.63">   if (!mBaseURL)</span>
<a href="#l20.64"></a><span id="l20.64">     return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l20.65"></a><span id="l20.65"> </span>
<a href="#l20.66"></a><span id="l20.66">   if (mAttributes.IsEmpty())</span>
<a href="#l20.67"></a><span id="l20.67">     return NS_OK;</span>
<a href="#l20.68"></a><span id="l20.68"> </span>
<a href="#l20.69"></a><span id="l20.69" class="difflineminus">-  nsCAutoString findAttribute(',');</span>
<a href="#l20.70"></a><span id="l20.70" class="difflineplus">+  nsCAutoString findAttribute(&quot;,&quot;);</span>
<a href="#l20.71"></a><span id="l20.71">   findAttribute.Append(aAttribute);</span>
<a href="#l20.72"></a><span id="l20.72">   findAttribute.Append(',');</span>
<a href="#l20.73"></a><span id="l20.73"> </span>
<a href="#l20.74"></a><span id="l20.74">   if (mAttributes.Equals(findAttribute, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l20.75"></a><span id="l20.75">     mAttributes.Truncate();</span>
<a href="#l20.76"></a><span id="l20.76">   else</span>
<a href="#l20.77"></a><span id="l20.77">   {</span>
<a href="#l20.78"></a><span id="l20.78">     PRInt32 pos = mAttributes.Find(findAttribute, CaseInsensitiveCompare);</span>
<a href="#l20.79"></a><span id="l20.79" class="difflineat">@@ -601,17 +601,17 @@ NS_IMETHODIMP nsLDAPURL::RemoveAttribute</span>
<a href="#l20.80"></a><span id="l20.80">   return mBaseURL-&gt;SetPath(newPath);</span>
<a href="#l20.81"></a><span id="l20.81"> }</span>
<a href="#l20.82"></a><span id="l20.82"> </span>
<a href="#l20.83"></a><span id="l20.83"> NS_IMETHODIMP nsLDAPURL::HasAttribute(const nsACString &amp;aAttribute,</span>
<a href="#l20.84"></a><span id="l20.84">                                       bool *_retval)</span>
<a href="#l20.85"></a><span id="l20.85"> {</span>
<a href="#l20.86"></a><span id="l20.86">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l20.87"></a><span id="l20.87"> </span>
<a href="#l20.88"></a><span id="l20.88" class="difflineminus">-  nsCAutoString findAttribute(',');</span>
<a href="#l20.89"></a><span id="l20.89" class="difflineplus">+  nsCAutoString findAttribute(&quot;,&quot;);</span>
<a href="#l20.90"></a><span id="l20.90">   findAttribute.Append(aAttribute);</span>
<a href="#l20.91"></a><span id="l20.91">   findAttribute.Append(',');</span>
<a href="#l20.92"></a><span id="l20.92"> </span>
<a href="#l20.93"></a><span id="l20.93">   *_retval = mAttributes.Find(findAttribute, CaseInsensitiveCompare) != -1;</span>
<a href="#l20.94"></a><span id="l20.94">   return NS_OK;</span>
<a href="#l20.95"></a><span id="l20.95"> }</span>
<a href="#l20.96"></a><span id="l20.96"> </span>
<a href="#l20.97"></a><span id="l20.97"> NS_IMETHODIMP nsLDAPURL::GetScope(PRInt32 *_retval)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1">new file mode 100644</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineminus">--- /dev/null</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineplus">+++ b/ldap/xpcom/src/nsLDAPUtils.h</span>
<a href="#l21.4"></a><span id="l21.4" class="difflineat">@@ -0,0 +1,181 @@</span>
<a href="#l21.5"></a><span id="l21.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l21.6"></a><span id="l21.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l21.7"></a><span id="l21.7" class="difflineplus">+ *</span>
<a href="#l21.8"></a><span id="l21.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l21.9"></a><span id="l21.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l21.10"></a><span id="l21.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l21.11"></a><span id="l21.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineplus">+ *</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l21.15"></a><span id="l21.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l21.16"></a><span id="l21.16" class="difflineplus">+ * License.</span>
<a href="#l21.17"></a><span id="l21.17" class="difflineplus">+ *</span>
<a href="#l21.18"></a><span id="l21.18" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l21.19"></a><span id="l21.19" class="difflineplus">+ *</span>
<a href="#l21.20"></a><span id="l21.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l21.21"></a><span id="l21.21" class="difflineplus">+ * Netscape Communications Corporation.</span>
<a href="#l21.22"></a><span id="l21.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2010</span>
<a href="#l21.23"></a><span id="l21.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l21.24"></a><span id="l21.24" class="difflineplus">+ *</span>
<a href="#l21.25"></a><span id="l21.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l21.26"></a><span id="l21.26" class="difflineplus">+ *   Jan Horak &lt;jhorak@redhat.com&gt;</span>
<a href="#l21.27"></a><span id="l21.27" class="difflineplus">+ *</span>
<a href="#l21.28"></a><span id="l21.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l21.29"></a><span id="l21.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l21.30"></a><span id="l21.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l21.31"></a><span id="l21.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l21.32"></a><span id="l21.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l21.33"></a><span id="l21.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l21.34"></a><span id="l21.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l21.35"></a><span id="l21.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l21.36"></a><span id="l21.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l21.37"></a><span id="l21.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l21.38"></a><span id="l21.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l21.39"></a><span id="l21.39" class="difflineplus">+ *</span>
<a href="#l21.40"></a><span id="l21.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l21.41"></a><span id="l21.41" class="difflineplus">+</span>
<a href="#l21.42"></a><span id="l21.42" class="difflineplus">+/* This module contains helper functions and macros for converting directory</span>
<a href="#l21.43"></a><span id="l21.43" class="difflineplus">+   module to frozen linkage.</span>
<a href="#l21.44"></a><span id="l21.44" class="difflineplus">+ */</span>
<a href="#l21.45"></a><span id="l21.45" class="difflineplus">+#include &quot;nsIProxyObjectManager.h&quot;</span>
<a href="#l21.46"></a><span id="l21.46" class="difflineplus">+#include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l21.47"></a><span id="l21.47" class="difflineplus">+#include &quot;nsStringGlue.h&quot;</span>
<a href="#l21.48"></a><span id="l21.48" class="difflineplus">+#include &lt;ctype.h&gt;</span>
<a href="#l21.49"></a><span id="l21.49" class="difflineplus">+</span>
<a href="#l21.50"></a><span id="l21.50" class="difflineplus">+#ifdef MOZILLA_INTERNAL_API</span>
<a href="#l21.51"></a><span id="l21.51" class="difflineplus">+/* Internal API helper macros */</span>
<a href="#l21.52"></a><span id="l21.52" class="difflineplus">+</span>
<a href="#l21.53"></a><span id="l21.53" class="difflineplus">+#define LdapCompressWhitespace(str) \</span>
<a href="#l21.54"></a><span id="l21.54" class="difflineplus">+        (str).CompressWhitespace()</span>
<a href="#l21.55"></a><span id="l21.55" class="difflineplus">+</span>
<a href="#l21.56"></a><span id="l21.56" class="difflineplus">+#else // MOZILLA_INTERNAL_API</span>
<a href="#l21.57"></a><span id="l21.57" class="difflineplus">+/* Frozen linkage helper functions */</span>
<a href="#l21.58"></a><span id="l21.58" class="difflineplus">+</span>
<a href="#l21.59"></a><span id="l21.59" class="difflineplus">+/* This macro has been copied from msgcore.h */</span>
<a href="#l21.60"></a><span id="l21.60" class="difflineplus">+#define IS_SPACE(VAL) \</span>
<a href="#l21.61"></a><span id="l21.61" class="difflineplus">+  (((((intn)(VAL)) &amp; 0x7f) == ((intn)(VAL))) &amp;&amp; isspace((intn)(VAL)))</span>
<a href="#l21.62"></a><span id="l21.62" class="difflineplus">+</span>
<a href="#l21.63"></a><span id="l21.63" class="difflineplus">+/* This function has been copied from nsMsgUtils.cpp */</span>
<a href="#l21.64"></a><span id="l21.64" class="difflineplus">+inline void LdapCompressWhitespace(nsCString&amp; aString)</span>
<a href="#l21.65"></a><span id="l21.65" class="difflineplus">+{</span>
<a href="#l21.66"></a><span id="l21.66" class="difflineplus">+  // This code is frozen linkage specific</span>
<a href="#l21.67"></a><span id="l21.67" class="difflineplus">+  aString.Trim(&quot; \f\n\r\t\v&quot;);</span>
<a href="#l21.68"></a><span id="l21.68" class="difflineplus">+</span>
<a href="#l21.69"></a><span id="l21.69" class="difflineplus">+  char *start, *end;</span>
<a href="#l21.70"></a><span id="l21.70" class="difflineplus">+  aString.BeginWriting(&amp;start, &amp;end);</span>
<a href="#l21.71"></a><span id="l21.71" class="difflineplus">+</span>
<a href="#l21.72"></a><span id="l21.72" class="difflineplus">+  for (char *cur = start; cur &lt; end; ++cur) {</span>
<a href="#l21.73"></a><span id="l21.73" class="difflineplus">+    if (!IS_SPACE(*cur))</span>
<a href="#l21.74"></a><span id="l21.74" class="difflineplus">+      continue;</span>
<a href="#l21.75"></a><span id="l21.75" class="difflineplus">+</span>
<a href="#l21.76"></a><span id="l21.76" class="difflineplus">+    *cur = ' ';</span>
<a href="#l21.77"></a><span id="l21.77" class="difflineplus">+</span>
<a href="#l21.78"></a><span id="l21.78" class="difflineplus">+    if (!IS_SPACE(*(cur + 1)))</span>
<a href="#l21.79"></a><span id="l21.79" class="difflineplus">+      continue;</span>
<a href="#l21.80"></a><span id="l21.80" class="difflineplus">+</span>
<a href="#l21.81"></a><span id="l21.81" class="difflineplus">+    // Loop through the white space</span>
<a href="#l21.82"></a><span id="l21.82" class="difflineplus">+    char *wend = cur + 2;</span>
<a href="#l21.83"></a><span id="l21.83" class="difflineplus">+    while (IS_SPACE(*wend))</span>
<a href="#l21.84"></a><span id="l21.84" class="difflineplus">+      ++wend;</span>
<a href="#l21.85"></a><span id="l21.85" class="difflineplus">+</span>
<a href="#l21.86"></a><span id="l21.86" class="difflineplus">+    PRUint32 wlen = wend - cur - 1;</span>
<a href="#l21.87"></a><span id="l21.87" class="difflineplus">+</span>
<a href="#l21.88"></a><span id="l21.88" class="difflineplus">+    // fix &quot;end&quot;</span>
<a href="#l21.89"></a><span id="l21.89" class="difflineplus">+    end -= wlen;</span>
<a href="#l21.90"></a><span id="l21.90" class="difflineplus">+</span>
<a href="#l21.91"></a><span id="l21.91" class="difflineplus">+    // move everything forwards a bit</span>
<a href="#l21.92"></a><span id="l21.92" class="difflineplus">+    for (char *m = cur + 1; m &lt; end; ++m) {</span>
<a href="#l21.93"></a><span id="l21.93" class="difflineplus">+      *m = *(m + wlen);</span>
<a href="#l21.94"></a><span id="l21.94" class="difflineplus">+    }</span>
<a href="#l21.95"></a><span id="l21.95" class="difflineplus">+  }</span>
<a href="#l21.96"></a><span id="l21.96" class="difflineplus">+</span>
<a href="#l21.97"></a><span id="l21.97" class="difflineplus">+  // Set the new length.</span>
<a href="#l21.98"></a><span id="l21.98" class="difflineplus">+  aString.SetLength(end - start);</span>
<a href="#l21.99"></a><span id="l21.99" class="difflineplus">+}</span>
<a href="#l21.100"></a><span id="l21.100" class="difflineplus">+</span>
<a href="#l21.101"></a><span id="l21.101" class="difflineplus">+/*</span>
<a href="#l21.102"></a><span id="l21.102" class="difflineplus">+ * Function copied from nsReadableUtils.</span>
<a href="#l21.103"></a><span id="l21.103" class="difflineplus">+ * Migrating to frozen linkage is the only change done</span>
<a href="#l21.104"></a><span id="l21.104" class="difflineplus">+ */</span>
<a href="#l21.105"></a><span id="l21.105" class="difflineplus">+inline</span>
<a href="#l21.106"></a><span id="l21.106" class="difflineplus">+bool IsUTF8(const nsACString&amp; aString)</span>
<a href="#l21.107"></a><span id="l21.107" class="difflineplus">+{</span>
<a href="#l21.108"></a><span id="l21.108" class="difflineplus">+  const char *done_reading = aString.EndReading();</span>
<a href="#l21.109"></a><span id="l21.109" class="difflineplus">+</span>
<a href="#l21.110"></a><span id="l21.110" class="difflineplus">+  PRInt32 state = 0;</span>
<a href="#l21.111"></a><span id="l21.111" class="difflineplus">+  bool overlong = false;</span>
<a href="#l21.112"></a><span id="l21.112" class="difflineplus">+  bool surrogate = false;</span>
<a href="#l21.113"></a><span id="l21.113" class="difflineplus">+  bool nonchar = false;</span>
<a href="#l21.114"></a><span id="l21.114" class="difflineplus">+  PRUint16 olupper = 0; // overlong byte upper bound.</span>
<a href="#l21.115"></a><span id="l21.115" class="difflineplus">+  PRUint16 slower = 0;  // surrogate byte lower bound.</span>
<a href="#l21.116"></a><span id="l21.116" class="difflineplus">+</span>
<a href="#l21.117"></a><span id="l21.117" class="difflineplus">+  const char *ptr = aString.BeginReading();</span>
<a href="#l21.118"></a><span id="l21.118" class="difflineplus">+</span>
<a href="#l21.119"></a><span id="l21.119" class="difflineplus">+  while (ptr &lt; done_reading) {</span>
<a href="#l21.120"></a><span id="l21.120" class="difflineplus">+    PRUint8 c;</span>
<a href="#l21.121"></a><span id="l21.121" class="difflineplus">+</span>
<a href="#l21.122"></a><span id="l21.122" class="difflineplus">+    if (0 == state) {</span>
<a href="#l21.123"></a><span id="l21.123" class="difflineplus">+</span>
<a href="#l21.124"></a><span id="l21.124" class="difflineplus">+      c = *ptr++;</span>
<a href="#l21.125"></a><span id="l21.125" class="difflineplus">+</span>
<a href="#l21.126"></a><span id="l21.126" class="difflineplus">+      if ((c &amp; 0x80) == 0x00)</span>
<a href="#l21.127"></a><span id="l21.127" class="difflineplus">+        continue;</span>
<a href="#l21.128"></a><span id="l21.128" class="difflineplus">+</span>
<a href="#l21.129"></a><span id="l21.129" class="difflineplus">+      if ( c &lt;= 0xC1 ) // [80-BF] where not expected, [C0-C1] for overlong.</span>
<a href="#l21.130"></a><span id="l21.130" class="difflineplus">+        return PR_FALSE;</span>
<a href="#l21.131"></a><span id="l21.131" class="difflineplus">+      else if ((c &amp; 0xE0) == 0xC0)</span>
<a href="#l21.132"></a><span id="l21.132" class="difflineplus">+        state = 1;</span>
<a href="#l21.133"></a><span id="l21.133" class="difflineplus">+      else if ((c &amp; 0xF0) == 0xE0) {</span>
<a href="#l21.134"></a><span id="l21.134" class="difflineplus">+        state = 2;</span>
<a href="#l21.135"></a><span id="l21.135" class="difflineplus">+        if ( c == 0xE0 ) { // to exclude E0[80-9F][80-BF]</span>
<a href="#l21.136"></a><span id="l21.136" class="difflineplus">+          overlong = PR_TRUE;</span>
<a href="#l21.137"></a><span id="l21.137" class="difflineplus">+          olupper = 0x9F;</span>
<a href="#l21.138"></a><span id="l21.138" class="difflineplus">+        } else if ( c == 0xED ) { // ED[A0-BF][80-BF] : surrogate codepoint</span>
<a href="#l21.139"></a><span id="l21.139" class="difflineplus">+          surrogate = PR_TRUE;</span>
<a href="#l21.140"></a><span id="l21.140" class="difflineplus">+          slower = 0xA0;</span>
<a href="#l21.141"></a><span id="l21.141" class="difflineplus">+        } else if ( c == 0xEF ) // EF BF [BE-BF] : non-character</span>
<a href="#l21.142"></a><span id="l21.142" class="difflineplus">+          nonchar = PR_TRUE;</span>
<a href="#l21.143"></a><span id="l21.143" class="difflineplus">+      } else if ( c &lt;= 0xF4 ) { // XXX replace /w UTF8traits::is4byte when it's updated to exclude [F5-F7].(bug 199090)</span>
<a href="#l21.144"></a><span id="l21.144" class="difflineplus">+        state = 3;</span>
<a href="#l21.145"></a><span id="l21.145" class="difflineplus">+        nonchar = PR_TRUE;</span>
<a href="#l21.146"></a><span id="l21.146" class="difflineplus">+        if ( c == 0xF0 ) { // to exclude F0[80-8F][80-BF]{2}</span>
<a href="#l21.147"></a><span id="l21.147" class="difflineplus">+          overlong = PR_TRUE;</span>
<a href="#l21.148"></a><span id="l21.148" class="difflineplus">+          olupper = 0x8F;</span>
<a href="#l21.149"></a><span id="l21.149" class="difflineplus">+        }</span>
<a href="#l21.150"></a><span id="l21.150" class="difflineplus">+        else if ( c == 0xF4 ) { // to exclude F4[90-BF][80-BF]</span>
<a href="#l21.151"></a><span id="l21.151" class="difflineplus">+          // actually not surrogates but codepoints beyond 0x10FFFF</span>
<a href="#l21.152"></a><span id="l21.152" class="difflineplus">+          surrogate = PR_TRUE;</span>
<a href="#l21.153"></a><span id="l21.153" class="difflineplus">+          slower = 0x90;</span>
<a href="#l21.154"></a><span id="l21.154" class="difflineplus">+        }</span>
<a href="#l21.155"></a><span id="l21.155" class="difflineplus">+      } else</span>
<a href="#l21.156"></a><span id="l21.156" class="difflineplus">+        return PR_FALSE; // Not UTF-8 string</span>
<a href="#l21.157"></a><span id="l21.157" class="difflineplus">+    }</span>
<a href="#l21.158"></a><span id="l21.158" class="difflineplus">+</span>
<a href="#l21.159"></a><span id="l21.159" class="difflineplus">+    while (ptr &lt; done_reading &amp;&amp; state) {</span>
<a href="#l21.160"></a><span id="l21.160" class="difflineplus">+      c = *ptr++;</span>
<a href="#l21.161"></a><span id="l21.161" class="difflineplus">+      --state;</span>
<a href="#l21.162"></a><span id="l21.162" class="difflineplus">+</span>
<a href="#l21.163"></a><span id="l21.163" class="difflineplus">+      // non-character : EF BF [BE-BF] or F[0-7] [89AB]F BF [BE-BF]</span>
<a href="#l21.164"></a><span id="l21.164" class="difflineplus">+      if ( nonchar &amp;&amp;  ( !state &amp;&amp;  c &lt; 0xBE ||</span>
<a href="#l21.165"></a><span id="l21.165" class="difflineplus">+           state == 1 &amp;&amp; c != 0xBF  ||</span>
<a href="#l21.166"></a><span id="l21.166" class="difflineplus">+           state == 2 &amp;&amp; 0x0F != (0x0F &amp; c) ))</span>
<a href="#l21.167"></a><span id="l21.167" class="difflineplus">+        nonchar = PR_FALSE;</span>
<a href="#l21.168"></a><span id="l21.168" class="difflineplus">+</span>
<a href="#l21.169"></a><span id="l21.169" class="difflineplus">+      if ((c &amp; 0xC0) != 0x80 || overlong &amp;&amp; c &lt;= olupper ||</span>
<a href="#l21.170"></a><span id="l21.170" class="difflineplus">+           surrogate &amp;&amp; slower &lt;= c || nonchar &amp;&amp; !state )</span>
<a href="#l21.171"></a><span id="l21.171" class="difflineplus">+        return PR_FALSE; // Not UTF-8 string</span>
<a href="#l21.172"></a><span id="l21.172" class="difflineplus">+      overlong = surrogate = PR_FALSE;</span>
<a href="#l21.173"></a><span id="l21.173" class="difflineplus">+    }</span>
<a href="#l21.174"></a><span id="l21.174" class="difflineplus">+  }</span>
<a href="#l21.175"></a><span id="l21.175" class="difflineplus">+  return !state; // state != 0 at the end indicates an invalid UTF-8 seq.</span>
<a href="#l21.176"></a><span id="l21.176" class="difflineplus">+}</span>
<a href="#l21.177"></a><span id="l21.177" class="difflineplus">+</span>
<a href="#l21.178"></a><span id="l21.178" class="difflineplus">+#define kNotFound -1</span>
<a href="#l21.179"></a><span id="l21.179" class="difflineplus">+</span>
<a href="#l21.180"></a><span id="l21.180" class="difflineplus">+#define nsCaseInsensitiveCStringComparator() \</span>
<a href="#l21.181"></a><span id="l21.181" class="difflineplus">+        CaseInsensitiveCompare</span>
<a href="#l21.182"></a><span id="l21.182" class="difflineplus">+#define nsCaseInsensitiveStringComparator() \</span>
<a href="#l21.183"></a><span id="l21.183" class="difflineplus">+        CaseInsensitiveCompare</span>
<a href="#l21.184"></a><span id="l21.184" class="difflineplus">+</span>
<a href="#l21.185"></a><span id="l21.185" class="difflineplus">+#endif // MOZILLA_INTERNAL_API</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

