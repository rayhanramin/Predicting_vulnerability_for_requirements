<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 10232:436d34c9eba12831fecbbcfa0d38cd7d8cd6795b</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 436d34c9eba12831fecbbcfa0d38cd7d8cd6795b" />
<meta property="og:url" content="/comm-central/rev/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b" />
<meta property="og:description" content="Bug 744037 - Add an Ubuntu One backend for the CloudFileProvider subsystem." />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 436d34c9eba12831fecbbcfa0d38cd7d8cd6795b 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b">shortlog</a> |
<a href="/comm-central/log/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b">files</a> |
changeset |
<a href="/comm-central/raw-rev/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b">raw</a>  | <a href="/comm-central/archive/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=744037">Bug 744037</a> - Add an Ubuntu One backend for the CloudFileProvider subsystem.
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#97;&#109;&#101;&#115;&#32;&#72;&#101;&#110;&#115;&#116;&#114;&#105;&#100;&#103;&#101;&#32;&#60;&#106;&#97;&#109;&#101;&#115;&#46;&#104;&#101;&#110;&#115;&#116;&#114;&#105;&#100;&#103;&#101;&#64;&#99;&#97;&#110;&#111;&#110;&#105;&#99;&#97;&#108;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 09 Apr 2012 22:23:10 +0800</td></tr>

<tr>
 <td>changeset 10232</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b">436d34c9eba12831fecbbcfa0d38cd7d8cd6795b</a></td>
</tr>



<tr>
<td>parent 10231</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/2e9cb0ffa579e67cf0ecb3ca602c60b2887c35db">2e9cb0ffa579e67cf0ecb3ca602c60b2887c35db</a>
</td>
</tr>

<tr>
<td>child 10233</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/c61f4fd56f6a2241d001e8679542f29b92319ed0">c61f4fd56f6a2241d001e8679542f29b92319ed0</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=436d34c9eba12831fecbbcfa0d38cd7d8cd6795b">7759</a></td></tr>
<tr><td>push user</td><td>bienvenu@nventure.com</td></tr>
<tr><td>push date</td><td class="date age">Tue, 22 May 2012 17:57:02 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@436d34c9eba1 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=436d34c9eba12831fecbbcfa0d38cd7d8cd6795b">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=436d34c9eba12831fecbbcfa0d38cd7d8cd6795b&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=436d34c9eba12831fecbbcfa0d38cd7d8cd6795b&newProject=comm-central&newRevision=436d34c9eba12831fecbbcfa0d38cd7d8cd6795b&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=436d34c9eba12831fecbbcfa0d38cd7d8cd6795b&newProject=comm-central&newRevision=436d34c9eba12831fecbbcfa0d38cd7d8cd6795b&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=436d34c9eba12831fecbbcfa0d38cd7d8cd6795b&newProject=comm-central&newRevision=436d34c9eba12831fecbbcfa0d38cd7d8cd6795b&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>

<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=744037">744037</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=744037">Bug 744037</a> - Add an Ubuntu One backend for the CloudFileProvider subsystem.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/base/modules/http.jsm">mail/base/modules/http.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/base/modules/http.jsm">file</a> |
<a href="/comm-central/annotate/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/base/modules/http.jsm">annotate</a> |
<a href="/comm-central/diff/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/base/modules/http.jsm">diff</a> |
<a href="/comm-central/comparison/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/base/modules/http.jsm">comparison</a> |
<a href="/comm-central/log/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/base/modules/http.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/components/cloudfile/Makefile.in">mail/components/cloudfile/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/components/cloudfile/Makefile.in">file</a> |
<a href="/comm-central/annotate/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/components/cloudfile/Makefile.in">annotate</a> |
<a href="/comm-central/diff/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/components/cloudfile/Makefile.in">diff</a> |
<a href="/comm-central/comparison/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/components/cloudfile/Makefile.in">comparison</a> |
<a href="/comm-central/log/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/components/cloudfile/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/components/cloudfile/cloudFileComponents.manifest">mail/components/cloudfile/cloudFileComponents.manifest</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/components/cloudfile/cloudFileComponents.manifest">file</a> |
<a href="/comm-central/annotate/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/components/cloudfile/cloudFileComponents.manifest">annotate</a> |
<a href="/comm-central/diff/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/components/cloudfile/cloudFileComponents.manifest">diff</a> |
<a href="/comm-central/comparison/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/components/cloudfile/cloudFileComponents.manifest">comparison</a> |
<a href="/comm-central/log/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/components/cloudfile/cloudFileComponents.manifest">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/components/cloudfile/content/UbuntuOne/management.xhtml">mail/components/cloudfile/content/UbuntuOne/management.xhtml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/components/cloudfile/content/UbuntuOne/management.xhtml">file</a> |
<a href="/comm-central/annotate/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/components/cloudfile/content/UbuntuOne/management.xhtml">annotate</a> |
<a href="/comm-central/diff/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/components/cloudfile/content/UbuntuOne/management.xhtml">diff</a> |
<a href="/comm-central/comparison/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/components/cloudfile/content/UbuntuOne/management.xhtml">comparison</a> |
<a href="/comm-central/log/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/components/cloudfile/content/UbuntuOne/management.xhtml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/components/cloudfile/content/UbuntuOne/settings.js">mail/components/cloudfile/content/UbuntuOne/settings.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/components/cloudfile/content/UbuntuOne/settings.js">file</a> |
<a href="/comm-central/annotate/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/components/cloudfile/content/UbuntuOne/settings.js">annotate</a> |
<a href="/comm-central/diff/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/components/cloudfile/content/UbuntuOne/settings.js">diff</a> |
<a href="/comm-central/comparison/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/components/cloudfile/content/UbuntuOne/settings.js">comparison</a> |
<a href="/comm-central/log/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/components/cloudfile/content/UbuntuOne/settings.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/components/cloudfile/content/UbuntuOne/settings.xhtml">mail/components/cloudfile/content/UbuntuOne/settings.xhtml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/components/cloudfile/content/UbuntuOne/settings.xhtml">file</a> |
<a href="/comm-central/annotate/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/components/cloudfile/content/UbuntuOne/settings.xhtml">annotate</a> |
<a href="/comm-central/diff/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/components/cloudfile/content/UbuntuOne/settings.xhtml">diff</a> |
<a href="/comm-central/comparison/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/components/cloudfile/content/UbuntuOne/settings.xhtml">comparison</a> |
<a href="/comm-central/log/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/components/cloudfile/content/UbuntuOne/settings.xhtml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/components/cloudfile/jar.mn">mail/components/cloudfile/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/components/cloudfile/jar.mn">file</a> |
<a href="/comm-central/annotate/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/components/cloudfile/jar.mn">annotate</a> |
<a href="/comm-central/diff/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/components/cloudfile/jar.mn">diff</a> |
<a href="/comm-central/comparison/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/components/cloudfile/jar.mn">comparison</a> |
<a href="/comm-central/log/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/components/cloudfile/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/components/cloudfile/nsUbuntuOne.js">mail/components/cloudfile/nsUbuntuOne.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/components/cloudfile/nsUbuntuOne.js">file</a> |
<a href="/comm-central/annotate/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/components/cloudfile/nsUbuntuOne.js">annotate</a> |
<a href="/comm-central/diff/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/components/cloudfile/nsUbuntuOne.js">diff</a> |
<a href="/comm-central/comparison/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/components/cloudfile/nsUbuntuOne.js">comparison</a> |
<a href="/comm-central/log/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/components/cloudfile/nsUbuntuOne.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/installer/package-manifest.in">mail/installer/package-manifest.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/installer/package-manifest.in">file</a> |
<a href="/comm-central/annotate/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/installer/package-manifest.in">annotate</a> |
<a href="/comm-central/diff/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/installer/package-manifest.in">diff</a> |
<a href="/comm-central/comparison/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/installer/package-manifest.in">comparison</a> |
<a href="/comm-central/log/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/installer/package-manifest.in">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/locales/en-US/chrome/messenger/cloudfile/UbuntuOne/management.dtd">mail/locales/en-US/chrome/messenger/cloudfile/UbuntuOne/management.dtd</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/locales/en-US/chrome/messenger/cloudfile/UbuntuOne/management.dtd">file</a> |
<a href="/comm-central/annotate/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/locales/en-US/chrome/messenger/cloudfile/UbuntuOne/management.dtd">annotate</a> |
<a href="/comm-central/diff/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/locales/en-US/chrome/messenger/cloudfile/UbuntuOne/management.dtd">diff</a> |
<a href="/comm-central/comparison/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/locales/en-US/chrome/messenger/cloudfile/UbuntuOne/management.dtd">comparison</a> |
<a href="/comm-central/log/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/locales/en-US/chrome/messenger/cloudfile/UbuntuOne/management.dtd">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/locales/en-US/chrome/messenger/cloudfile/UbuntuOne/settings.dtd">mail/locales/en-US/chrome/messenger/cloudfile/UbuntuOne/settings.dtd</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/locales/en-US/chrome/messenger/cloudfile/UbuntuOne/settings.dtd">file</a> |
<a href="/comm-central/annotate/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/locales/en-US/chrome/messenger/cloudfile/UbuntuOne/settings.dtd">annotate</a> |
<a href="/comm-central/diff/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/locales/en-US/chrome/messenger/cloudfile/UbuntuOne/settings.dtd">diff</a> |
<a href="/comm-central/comparison/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/locales/en-US/chrome/messenger/cloudfile/UbuntuOne/settings.dtd">comparison</a> |
<a href="/comm-central/log/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/locales/en-US/chrome/messenger/cloudfile/UbuntuOne/settings.dtd">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/locales/jar.mn">mail/locales/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/locales/jar.mn">file</a> |
<a href="/comm-central/annotate/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/locales/jar.mn">annotate</a> |
<a href="/comm-central/diff/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/locales/jar.mn">diff</a> |
<a href="/comm-central/comparison/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/locales/jar.mn">comparison</a> |
<a href="/comm-central/log/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/locales/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/test/mozmill/cloudfile/test-cloudfile-backend-ubuntuone.js">mail/test/mozmill/cloudfile/test-cloudfile-backend-ubuntuone.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/test/mozmill/cloudfile/test-cloudfile-backend-ubuntuone.js">file</a> |
<a href="/comm-central/annotate/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/test/mozmill/cloudfile/test-cloudfile-backend-ubuntuone.js">annotate</a> |
<a href="/comm-central/diff/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/test/mozmill/cloudfile/test-cloudfile-backend-ubuntuone.js">diff</a> |
<a href="/comm-central/comparison/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/test/mozmill/cloudfile/test-cloudfile-backend-ubuntuone.js">comparison</a> |
<a href="/comm-central/log/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/test/mozmill/cloudfile/test-cloudfile-backend-ubuntuone.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/test/mozmill/shared-modules/test-cloudfile-ubuntuone-helpers.js">mail/test/mozmill/shared-modules/test-cloudfile-ubuntuone-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/test/mozmill/shared-modules/test-cloudfile-ubuntuone-helpers.js">file</a> |
<a href="/comm-central/annotate/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/test/mozmill/shared-modules/test-cloudfile-ubuntuone-helpers.js">annotate</a> |
<a href="/comm-central/diff/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/test/mozmill/shared-modules/test-cloudfile-ubuntuone-helpers.js">diff</a> |
<a href="/comm-central/comparison/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/test/mozmill/shared-modules/test-cloudfile-ubuntuone-helpers.js">comparison</a> |
<a href="/comm-central/log/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/test/mozmill/shared-modules/test-cloudfile-ubuntuone-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/themes/gnomestripe/jar.mn">mail/themes/gnomestripe/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/themes/gnomestripe/jar.mn">file</a> |
<a href="/comm-central/annotate/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/themes/gnomestripe/jar.mn">annotate</a> |
<a href="/comm-central/diff/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/themes/gnomestripe/jar.mn">diff</a> |
<a href="/comm-central/comparison/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/themes/gnomestripe/jar.mn">comparison</a> |
<a href="/comm-central/log/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/themes/gnomestripe/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/themes/gnomestripe/mail/icons/ubuntuone.png">mail/themes/gnomestripe/mail/icons/ubuntuone.png</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/themes/gnomestripe/mail/icons/ubuntuone.png">file</a> |
<a href="/comm-central/annotate/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/themes/gnomestripe/mail/icons/ubuntuone.png">annotate</a> |
<a href="/comm-central/diff/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/themes/gnomestripe/mail/icons/ubuntuone.png">diff</a> |
<a href="/comm-central/comparison/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/themes/gnomestripe/mail/icons/ubuntuone.png">comparison</a> |
<a href="/comm-central/log/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/themes/gnomestripe/mail/icons/ubuntuone.png">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/themes/pinstripe/jar.mn">mail/themes/pinstripe/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/themes/pinstripe/jar.mn">file</a> |
<a href="/comm-central/annotate/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/themes/pinstripe/jar.mn">annotate</a> |
<a href="/comm-central/diff/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/themes/pinstripe/jar.mn">diff</a> |
<a href="/comm-central/comparison/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/themes/pinstripe/jar.mn">comparison</a> |
<a href="/comm-central/log/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/themes/pinstripe/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/themes/pinstripe/mail/icons/ubuntuone.png">mail/themes/pinstripe/mail/icons/ubuntuone.png</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/themes/pinstripe/mail/icons/ubuntuone.png">file</a> |
<a href="/comm-central/annotate/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/themes/pinstripe/mail/icons/ubuntuone.png">annotate</a> |
<a href="/comm-central/diff/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/themes/pinstripe/mail/icons/ubuntuone.png">diff</a> |
<a href="/comm-central/comparison/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/themes/pinstripe/mail/icons/ubuntuone.png">comparison</a> |
<a href="/comm-central/log/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/themes/pinstripe/mail/icons/ubuntuone.png">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/themes/qute/jar.mn">mail/themes/qute/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/themes/qute/jar.mn">file</a> |
<a href="/comm-central/annotate/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/themes/qute/jar.mn">annotate</a> |
<a href="/comm-central/diff/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/themes/qute/jar.mn">diff</a> |
<a href="/comm-central/comparison/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/themes/qute/jar.mn">comparison</a> |
<a href="/comm-central/log/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/themes/qute/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/themes/qute/mail/icons/ubuntuone.png">mail/themes/qute/mail/icons/ubuntuone.png</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/themes/qute/mail/icons/ubuntuone.png">file</a> |
<a href="/comm-central/annotate/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/themes/qute/mail/icons/ubuntuone.png">annotate</a> |
<a href="/comm-central/diff/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/themes/qute/mail/icons/ubuntuone.png">diff</a> |
<a href="/comm-central/comparison/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/themes/qute/mail/icons/ubuntuone.png">comparison</a> |
<a href="/comm-central/log/436d34c9eba12831fecbbcfa0d38cd7d8cd6795b/mail/themes/qute/mail/icons/ubuntuone.png">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/base/modules/http.jsm</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/base/modules/http.jsm</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -30,17 +30,17 @@ function doXHRequest(aUrl, aHeaders, aPO</span>
<a href="#l1.4"></a><span id="l1.4">       // When status is 0 we don't have a valid channel.</span>
<a href="#l1.5"></a><span id="l1.5">       let statusText = status ? request.statusText : &quot;offline&quot;;</span>
<a href="#l1.6"></a><span id="l1.6">       aOnError.call(aThis, statusText, null, this);</span>
<a href="#l1.7"></a><span id="l1.7">     }</span>
<a href="#l1.8"></a><span id="l1.8">   };</span>
<a href="#l1.9"></a><span id="l1.9">   xhr.onload = function (aRequest) {</span>
<a href="#l1.10"></a><span id="l1.10">     try {</span>
<a href="#l1.11"></a><span id="l1.11">       let target = aRequest.target;</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-      if (target.status != 200) {</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+      if (target.status &lt; 200 || target.status &gt;= 300) {</span>
<a href="#l1.14"></a><span id="l1.14">         let errorText = target.responseText;</span>
<a href="#l1.15"></a><span id="l1.15">         if (!errorText || /&lt;(ht|\?x)ml\b/i.test(errorText))</span>
<a href="#l1.16"></a><span id="l1.16">           errorText = target.statusText;</span>
<a href="#l1.17"></a><span id="l1.17">         throw target.status + &quot; - &quot; + errorText;</span>
<a href="#l1.18"></a><span id="l1.18">       }</span>
<a href="#l1.19"></a><span id="l1.19">       if (aOnLoad)</span>
<a href="#l1.20"></a><span id="l1.20">         aOnLoad.call(aThis, target.responseText, this);</span>
<a href="#l1.21"></a><span id="l1.21">     } catch (e) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/components/cloudfile/Makefile.in</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/components/cloudfile/Makefile.in</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -9,16 +9,17 @@ VPATH		= @srcdir@</span>
<a href="#l2.4"></a><span id="l2.4"> </span>
<a href="#l2.5"></a><span id="l2.5"> include $(DEPTH)/config/autoconf.mk</span>
<a href="#l2.6"></a><span id="l2.6"> </span>
<a href="#l2.7"></a><span id="l2.7"> MODULE    = cloudfile</span>
<a href="#l2.8"></a><span id="l2.8"> </span>
<a href="#l2.9"></a><span id="l2.9"> EXTRA_COMPONENTS = \</span>
<a href="#l2.10"></a><span id="l2.10">   nsYouSendIt.js \</span>
<a href="#l2.11"></a><span id="l2.11">   nsDropbox.js \</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+  nsUbuntuOne.js \</span>
<a href="#l2.13"></a><span id="l2.13">   cloudFileComponents.manifest \</span>
<a href="#l2.14"></a><span id="l2.14">   $(NULL)</span>
<a href="#l2.15"></a><span id="l2.15"> </span>
<a href="#l2.16"></a><span id="l2.16"> EXTRA_JS_MODULES = \</span>
<a href="#l2.17"></a><span id="l2.17">   cloudFileAccounts.js \</span>
<a href="#l2.18"></a><span id="l2.18">   $(NULL)</span>
<a href="#l2.19"></a><span id="l2.19"> </span>
<a href="#l2.20"></a><span id="l2.20"> XPIDLSRCS = nsIMsgCloudFileProvider.idl \</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/components/cloudfile/cloudFileComponents.manifest</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/components/cloudfile/cloudFileComponents.manifest</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -1,7 +1,11 @@</span>
<a href="#l3.4"></a><span id="l3.4"> component {32fd439f-9eb6-4907-ac0b-2c88eb14d98d} nsYouSendIt.js</span>
<a href="#l3.5"></a><span id="l3.5"> contract @mozilla.org/mail/yousendit;1 {32fd439f-9eb6-4907-ac0b-2c88eb14d98d}</span>
<a href="#l3.6"></a><span id="l3.6"> category cloud-files YouSendIt @mozilla.org/mail/yousendit;1</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8"> component {2fd8a64a-a496-4cf4-9d6b-d3f9800c6322} nsDropbox.js</span>
<a href="#l3.9"></a><span id="l3.9"> contract @mozilla.org/mail/dropbox;1 {2fd8a64a-a496-4cf4-9d6b-d3f9800c6322}</span>
<a href="#l3.10"></a><span id="l3.10"> category cloud-files Dropbox @mozilla.org/mail/dropbox;1</span>
<a href="#l3.11"></a><span id="l3.11" class="difflineplus">+</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+component {9a44742b-a7b1-4f44-919e-6f3b28902c1a} nsUbuntuOne.js</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+contract @mozilla.org/mail/ubuntuone;1 {9a44742b-a7b1-4f44-919e-6f3b28902c1a}</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+category cloud-files UbuntuOne @mozilla.org/mail/ubuntuone;1</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1">new file mode 100644</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineminus">--- /dev/null</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineplus">+++ b/mail/components/cloudfile/content/UbuntuOne/management.xhtml</span>
<a href="#l4.4"></a><span id="l4.4" class="difflineat">@@ -0,0 +1,43 @@</span>
<a href="#l4.5"></a><span id="l4.5" class="difflineplus">+&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<a href="#l4.6"></a><span id="l4.6" class="difflineplus">+&lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l4.7"></a><span id="l4.7" class="difflineplus">+   - License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l4.8"></a><span id="l4.8" class="difflineplus">+   - You can obtain one at http://mozilla.org/MPL/2.0/.  --&gt;</span>
<a href="#l4.9"></a><span id="l4.9" class="difflineplus">+</span>
<a href="#l4.10"></a><span id="l4.10" class="difflineplus">+&lt;!DOCTYPE html [</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineplus">+  &lt;!ENTITY % htmlDTD PUBLIC &quot;-//W3C//DTD XHTML 1.0 Strict//EN&quot; &quot;DTD/xhtml1-strict.dtd&quot;&gt; %htmlDTD;</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+  &lt;!ENTITY % managementDTD SYSTEM &quot;chrome://messenger/locale/cloudfile/management.dtd&quot;&gt; %managementDTD;</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+  &lt;!ENTITY % u1DTD SYSTEM &quot;chrome://messenger/locale/cloudfile/UbuntuOne/management.dtd&quot;&gt; %u1DTD;</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+]&gt;</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+&lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot; xml:lang=&quot;en&quot; lang=&quot;en&quot;&gt;</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+  &lt;head&gt;</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+    &lt;script type=&quot;application/javascript;version=1.8&quot;</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+            src=&quot;chrome://messenger/content/protovis-r2.6-modded.js&quot;/&gt;</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+    &lt;script type=&quot;text/javascript;version=1.8&quot;</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+            src=&quot;chrome://messenger/content/cloudfile/Dropbox/management.js&quot;/&gt;</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+    &lt;link rel=&quot;stylesheet&quot;</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+        type=&quot;text/css&quot;</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+        href=&quot;chrome://messenger/skin/preferences/preferences.css&quot; /&gt;</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+  &lt;/head&gt;</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+  &lt;body id=&quot;provider-management&quot;&gt;</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineplus">+    &lt;div id=&quot;provider-header&quot;&gt;</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineplus">+      &lt;div id=&quot;provider-terms&quot;&gt;</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+      &lt;a href=&quot;https://one.ubuntu.com/privacy/&quot;&gt;&amp;cloudfileMgmt.privacyPolicy;&lt;/a&gt;</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+      &lt;a href=&quot;https://one.ubuntu.com/terms/&quot;&gt;&amp;cloudfileMgmt.termsOfService;&lt;/a&gt;</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+      &lt;/div&gt;</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+      &lt;div id=&quot;provider-name&quot;&gt;</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+      &lt;h1&gt;Ubuntu One&lt;/h1&gt;</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+      &lt;/div&gt;</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+    &lt;/div&gt;</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+    &lt;div id=&quot;provider-spacebox&quot;&gt;</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+      &lt;div id=&quot;provider-space-visuals&quot;&gt;&lt;/div&gt;</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+      &lt;div id=&quot;provider-space&quot;&gt;</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+        &lt;div&gt;&amp;cloudfileMgmt.usedSpace;&lt;span id=&quot;file-space-used&quot;/&gt;&lt;span id=&quot;file-space-used-swatch&quot; class=&quot;space-swatch&quot;/&gt;&lt;/div&gt;</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+        &lt;div&gt;&amp;cloudfileMgmt.unusedSpace;&lt;span id=&quot;remaining-file-space&quot;/&gt;&lt;span id=&quot;remaining-file-space-swatch&quot; class=&quot;space-swatch&quot;/&gt;&lt;/div&gt;</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+        &lt;div id=&quot;upgrade&quot;&gt;&lt;a href=&quot;https://one.ubuntu.com/services/add-storage/&quot;&gt;&amp;cloudfileMgmt.upgradeOffer;&lt;/a&gt;&lt;/div&gt;</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+      &lt;/div&gt;</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+      &lt;/div&gt;</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+    &lt;div id=&quot;provider-account-settings&quot;&gt;&lt;a href=&quot;https://one.ubuntu.com/account/&quot;&gt;&amp;ubuntuOneMgmt.viewSettings;&lt;/a&gt;&lt;/div&gt;</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+  &lt;/body&gt;</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+&lt;/html&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1">new file mode 100644</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineminus">--- /dev/null</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineplus">+++ b/mail/components/cloudfile/content/UbuntuOne/settings.js</span>
<a href="#l5.4"></a><span id="l5.4" class="difflineat">@@ -0,0 +1,10 @@</span>
<a href="#l5.5"></a><span id="l5.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l5.6"></a><span id="l5.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l5.7"></a><span id="l5.7" class="difflineplus">+ * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l5.8"></a><span id="l5.8" class="difflineplus">+</span>
<a href="#l5.9"></a><span id="l5.9" class="difflineplus">+function extraArgs() {</span>
<a href="#l5.10"></a><span id="l5.10" class="difflineplus">+  var emailaddressValue = document.getElementById(&quot;emailaddress&quot;).value;</span>
<a href="#l5.11"></a><span id="l5.11" class="difflineplus">+  return {</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+    &quot;emailaddress&quot;: {type: &quot;char&quot;, value: emailaddressValue},</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+  };</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1">new file mode 100644</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineminus">--- /dev/null</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineplus">+++ b/mail/components/cloudfile/content/UbuntuOne/settings.xhtml</span>
<a href="#l6.4"></a><span id="l6.4" class="difflineat">@@ -0,0 +1,30 @@</span>
<a href="#l6.5"></a><span id="l6.5" class="difflineplus">+&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<a href="#l6.6"></a><span id="l6.6" class="difflineplus">+&lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l6.7"></a><span id="l6.7" class="difflineplus">+   - License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l6.8"></a><span id="l6.8" class="difflineplus">+   - You can obtain one at http://mozilla.org/MPL/2.0/.  --&gt;</span>
<a href="#l6.9"></a><span id="l6.9" class="difflineplus">+</span>
<a href="#l6.10"></a><span id="l6.10" class="difflineplus">+&lt;!DOCTYPE html [</span>
<a href="#l6.11"></a><span id="l6.11" class="difflineplus">+  &lt;!ENTITY % htmlDTD PUBLIC &quot;-//W3C//DTD XHTML 1.0 Strict//EN&quot; &quot;DTD/xhtml1-strict.dtd&quot;&gt; %htmlDTD;</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+  &lt;!ENTITY % u1DTD SYSTEM &quot;chrome://messenger/locale/cloudfile/UbuntuOne/settings.dtd&quot;&gt; %u1DTD;</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+]&gt;</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+&lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot; xml:lang=&quot;en&quot; lang=&quot;en&quot;&gt;</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+  &lt;head&gt;</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+    &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+            src=&quot;chrome://messenger/content/cloudfile/UbuntuOne/settings.js&quot;/&gt;</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+    &lt;link rel=&quot;stylesheet&quot;</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+        type=&quot;text/css&quot;</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+        href=&quot;chrome://messenger/skin/cloudfile/addAccountDialog.css&quot; /&gt;</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineplus">+  &lt;/head&gt;</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+  &lt;body id=&quot;provider-settings&quot;&gt;</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineplus">+    &lt;form id=&quot;provider-form&quot; onsubmit=&quot;return false;&quot;&gt;</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineplus">+      &lt;label for=&quot;username&quot;&gt;&amp;UbuntuOneSettings.emailAddress;&lt;/label&gt;</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineplus">+      &lt;input id=&quot;emailaddress&quot; type=&quot;text&quot; required=&quot;true&quot;/&gt;</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineplus">+      &lt;div id=&quot;learn-more&quot; class=&quot;float-right&quot;&gt;</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineplus">+        &lt;a href=&quot;https://one.ubuntu.com/&quot;&gt;&amp;UbuntuOneSettings.learnMore;&lt;/a&gt;</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineplus">+      &lt;/div&gt;</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineplus">+      &lt;div&gt;</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineplus">+        &lt;a href=&quot;https://one.ubuntu.com/services/&quot;&gt;&amp;UbuntuOneSettings.needAnAccount;&lt;/a&gt;</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+      &lt;/div&gt;</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+    &lt;/form&gt;</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+  &lt;/body&gt;</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+&lt;/html&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/components/cloudfile/jar.mn</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/components/cloudfile/jar.mn</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -1,12 +1,15 @@</span>
<a href="#l7.4"></a><span id="l7.4"> messenger.jar:</span>
<a href="#l7.5"></a><span id="l7.5"> *   content/messenger/cloudfile/addAccountDialog.xul (content/addAccountDialog.xul)</span>
<a href="#l7.6"></a><span id="l7.6">     content/messenger/cloudfile/addAccountDialog.js  (content/addAccountDialog.js)</span>
<a href="#l7.7"></a><span id="l7.7">     content/messenger/cloudfile/attachment-24.png (content/attachment-24.png)</span>
<a href="#l7.8"></a><span id="l7.8">     content/messenger/cloudfile/emptySettings.xhtml (content/emptySettings.xhtml)</span>
<a href="#l7.9"></a><span id="l7.9">     content/messenger/cloudfile/Dropbox/management.xhtml (content/Dropbox/management.xhtml)</span>
<a href="#l7.10"></a><span id="l7.10">     content/messenger/cloudfile/Dropbox/management.js    (content/Dropbox/management.js)</span>
<a href="#l7.11"></a><span id="l7.11">     content/messenger/cloudfile/Dropbox/settings.xhtml (content/Dropbox/settings.xhtml)</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+    content/messenger/cloudfile/UbuntuOne/management.xhtml (content/UbuntuOne/management.xhtml)</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+    content/messenger/cloudfile/UbuntuOne/settings.js (content/UbuntuOne/settings.js)</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+    content/messenger/cloudfile/UbuntuOne/settings.xhtml (content/UbuntuOne/settings.xhtml)</span>
<a href="#l7.15"></a><span id="l7.15">     content/messenger/cloudfile/YouSendIt/management.xhtml (content/YouSendIt/management.xhtml)</span>
<a href="#l7.16"></a><span id="l7.16">     content/messenger/cloudfile/YouSendIt/management.js (content/YouSendIt/management.js)</span>
<a href="#l7.17"></a><span id="l7.17">     content/messenger/cloudfile/YouSendIt/settings.js (content/YouSendIt/settings.js)</span>
<a href="#l7.18"></a><span id="l7.18">     content/messenger/cloudfile/YouSendIt/settings.xhtml (content/YouSendIt/settings.xhtml)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1">new file mode 100644</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineminus">--- /dev/null</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineplus">+++ b/mail/components/cloudfile/nsUbuntuOne.js</span>
<a href="#l8.4"></a><span id="l8.4" class="difflineat">@@ -0,0 +1,758 @@</span>
<a href="#l8.5"></a><span id="l8.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l8.6"></a><span id="l8.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l8.7"></a><span id="l8.7" class="difflineplus">+ * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l8.8"></a><span id="l8.8" class="difflineplus">+</span>
<a href="#l8.9"></a><span id="l8.9" class="difflineplus">+/* This file implements the nsIMsgCloudFileProvider interface.</span>
<a href="#l8.10"></a><span id="l8.10" class="difflineplus">+ *</span>
<a href="#l8.11"></a><span id="l8.11" class="difflineplus">+ * This component handles the UbuntuOne implementation of the</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+ * nsIMsgCloudFileProvider interface.</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+ */</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+const Cc = Components.classes;</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+const Ci = Components.interfaces;</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+const Cu = Components.utils;</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+const Cr = Components.results;</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineplus">+Cu.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineplus">+Cu.import(&quot;resource:///modules/http.jsm&quot;);</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineplus">+Cu.import(&quot;resource:///modules/oauth.jsm&quot;);</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineplus">+Cu.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+Cu.import(&quot;resource:///modules/gloda/log4moz.js&quot;);</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineplus">+Cu.import(&quot;resource:///modules/cloudFileAccounts.js&quot;);</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineplus">+</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineplus">+const kBadAccessToken = 401;</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineplus">+const kAuthSecretRealm = &quot;Ubuntu One Auth Secret&quot;;</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineplus">+const kConsumerKeyRealm = &quot;Ubuntu One Consumer Key&quot;;</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineplus">+const kConsumerSecretRealm = &quot;Ubuntu One Consumer Secret&quot;;</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineplus">+const kAttachmentsVolume = &quot;/~/Thunderbird Attachments&quot;;</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+const kVolumesPath = &quot;/volumes&quot;;</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+var gServerUrl = &quot;https://one.ubuntu.com/api/file_storage/v1&quot;;</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineplus">+var gContentUrl = &quot;https://files.one.ubuntu.com/content&quot;;</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineplus">+var gSsoUrl = &quot;https://login.ubuntu.com/api/1.0/authentications&quot;;</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineplus">+var gSsoPingUrl = &quot;https://one.ubuntu.com/oauth/sso-finished-so-get-tokens/&quot;;</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineplus">+</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineplus">+</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineplus">+function encodePathForURI(aStr) {</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineplus">+  return encodeURIComponent(aStr).replace(/%2F/g, '/');</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineplus">+}</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineplus">+</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineplus">+</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineplus">+function nsUbuntuOne() {</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineplus">+  this.log = Log4Moz.getConfiguredLogger(&quot;UbuntuOne&quot;);</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineplus">+}</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineplus">+</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineplus">+nsUbuntuOne.prototype = {</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineplus">+  /* nsISupports */</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+  QueryInterface: XPCOMUtils.generateQI([Ci.nsIMsgCloudFileProvider]),</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineplus">+</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineplus">+  classID: Components.ID(&quot;{9a44742b-a7b1-4f44-919e-6f3b28902c1a}&quot;),</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineplus">+</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineplus">+  get type() &quot;UbuntuOne&quot;,</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineplus">+  get displayName() &quot;Ubuntu One&quot;,</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineplus">+  get serviceURL() &quot;https://one.ubuntu.com/&quot;,</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineplus">+  get iconClass() &quot;chrome://messenger/skin/icons/ubuntuone.png&quot;,</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineplus">+  get accountKey() this._accountKey,</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineplus">+  get lastError() this._lastErrorText,</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineplus">+  get settingsURL() &quot;chrome://messenger/content/cloudfile/UbuntuOne/settings.xhtml&quot;,</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineplus">+  get managementURL() &quot;chrome://messenger/content/cloudfile/UbuntuOne/management.xhtml&quot;,</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineplus">+</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineplus">+  _accountKey: false,</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineplus">+  _prefBranch: null,</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineplus">+  _emailAddress: &quot;&quot;,</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineplus">+  _loggedIn: false,</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineplus">+  _userInfo: null,</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineplus">+  _connection: null,</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineplus">+  _uploadingFile : null,</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineplus">+  _uploader : null,</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineplus">+  _availableStorage : -1,</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineplus">+  _fileSpaceUsed : -1,</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineplus">+  _uploads: [],</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineplus">+  _urlsForFiles : {},</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineplus">+  _uploadInfo : {}, // upload info keyed on aFiles.</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineplus">+</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineplus">+  /**</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineplus">+   * Initialize this instance of nsUbuntuOne, setting the accountKey.</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineplus">+   *</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineplus">+   * @param aAccountKey the account key to initialize this provider with</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineplus">+   */</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineplus">+  init: function nsUbuntuOne_init(aAccountKey) {</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineplus">+    this._accountKey = aAccountKey;</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineplus">+    this._prefBranch = Services.prefs.getBranch(&quot;mail.cloud_files.accounts.&quot; + </span>
<a href="#l8.86"></a><span id="l8.86" class="difflineplus">+                                                aAccountKey + &quot;.&quot;);</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineplus">+    this._emailAddress = this._prefBranch.getCharPref(&quot;emailaddress&quot;)</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineplus">+  },</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineplus">+</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineplus">+  /**</span>
<a href="#l8.91"></a><span id="l8.91" class="difflineplus">+   * The callback passed to an nsUbuntuOneFileUploader, which is fired when</span>
<a href="#l8.92"></a><span id="l8.92" class="difflineplus">+   * nsUbuntuOneFileUploader exits.</span>
<a href="#l8.93"></a><span id="l8.93" class="difflineplus">+   *</span>
<a href="#l8.94"></a><span id="l8.94" class="difflineplus">+   * @param aRequestObserver the request observer originally passed to</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineplus">+   *                         uploadFile for the file associated with the</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineplus">+   *                         nsUbuntuOneFileUploader</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineplus">+   * @param aStatus the result of the upload</span>
<a href="#l8.98"></a><span id="l8.98" class="difflineplus">+   */</span>
<a href="#l8.99"></a><span id="l8.99" class="difflineplus">+  _uploaderCallback : function nsUbuntuOne__uploaderCallback(aRequestObserver,</span>
<a href="#l8.100"></a><span id="l8.100" class="difflineplus">+                                                             aStatus) {</span>
<a href="#l8.101"></a><span id="l8.101" class="difflineplus">+    aRequestObserver.onStopRequest(null, null, aStatus);</span>
<a href="#l8.102"></a><span id="l8.102" class="difflineplus">+    this._uploadingFile = null;</span>
<a href="#l8.103"></a><span id="l8.103" class="difflineplus">+    this._uploads.shift();</span>
<a href="#l8.104"></a><span id="l8.104" class="difflineplus">+    if (this._uploads.length &gt; 0) {</span>
<a href="#l8.105"></a><span id="l8.105" class="difflineplus">+      let nextUpload = this._uploads[0];</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineplus">+      this.log.info(&quot;chaining upload, file = &quot; + nextUpload.file.leafName);</span>
<a href="#l8.107"></a><span id="l8.107" class="difflineplus">+      this._uploadingFile = nextUpload.file;</span>
<a href="#l8.108"></a><span id="l8.108" class="difflineplus">+      this._uploader = nextUpload;</span>
<a href="#l8.109"></a><span id="l8.109" class="difflineplus">+      try {</span>
<a href="#l8.110"></a><span id="l8.110" class="difflineplus">+        this.uploadFile(nextUpload.file, nextUpload.callback);</span>
<a href="#l8.111"></a><span id="l8.111" class="difflineplus">+      }</span>
<a href="#l8.112"></a><span id="l8.112" class="difflineplus">+      catch (ex) {</span>
<a href="#l8.113"></a><span id="l8.113" class="difflineplus">+        // I'd like to pass ex.result, but that doesn't seem to be defined.</span>
<a href="#l8.114"></a><span id="l8.114" class="difflineplus">+        nextUpload.callback(nextUpload.requestObserver, Cr.NS_ERROR_FAILURE);</span>
<a href="#l8.115"></a><span id="l8.115" class="difflineplus">+      }</span>
<a href="#l8.116"></a><span id="l8.116" class="difflineplus">+    }</span>
<a href="#l8.117"></a><span id="l8.117" class="difflineplus">+    else</span>
<a href="#l8.118"></a><span id="l8.118" class="difflineplus">+      this._uploader = null;</span>
<a href="#l8.119"></a><span id="l8.119" class="difflineplus">+  },</span>
<a href="#l8.120"></a><span id="l8.120" class="difflineplus">+</span>
<a href="#l8.121"></a><span id="l8.121" class="difflineplus">+  /** </span>
<a href="#l8.122"></a><span id="l8.122" class="difflineplus">+   * Attempts to upload a file to UbuntuOne.</span>
<a href="#l8.123"></a><span id="l8.123" class="difflineplus">+   *</span>
<a href="#l8.124"></a><span id="l8.124" class="difflineplus">+   * @param aFile the nsILocalFile to be uploaded</span>
<a href="#l8.125"></a><span id="l8.125" class="difflineplus">+   * @param aCallback an nsIRequestObserver for listening for the starting</span>
<a href="#l8.126"></a><span id="l8.126" class="difflineplus">+   *                  and ending states of the upload.</span>
<a href="#l8.127"></a><span id="l8.127" class="difflineplus">+   */</span>
<a href="#l8.128"></a><span id="l8.128" class="difflineplus">+  uploadFile: function nsUbuntuOne_uploadFile(aFile, aCallback) {</span>
<a href="#l8.129"></a><span id="l8.129" class="difflineplus">+    if (Services.io.offline)</span>
<a href="#l8.130"></a><span id="l8.130" class="difflineplus">+      throw Ci.nsIMsgCloudFileProvider.offlineErr;</span>
<a href="#l8.131"></a><span id="l8.131" class="difflineplus">+</span>
<a href="#l8.132"></a><span id="l8.132" class="difflineplus">+    this.log.info(&quot;uploading &quot; + aFile.leafName);</span>
<a href="#l8.133"></a><span id="l8.133" class="difflineplus">+</span>
<a href="#l8.134"></a><span id="l8.134" class="difflineplus">+    // Some ugliness here - we stash requestObserver here, because we might</span>
<a href="#l8.135"></a><span id="l8.135" class="difflineplus">+    // use it again in _getUserInfo.</span>
<a href="#l8.136"></a><span id="l8.136" class="difflineplus">+    this.requestObserver = aCallback;</span>
<a href="#l8.137"></a><span id="l8.137" class="difflineplus">+</span>
<a href="#l8.138"></a><span id="l8.138" class="difflineplus">+    // if we're uploading a file, queue this request.</span>
<a href="#l8.139"></a><span id="l8.139" class="difflineplus">+    if (this._uploadingFile &amp;&amp; !this._uploadingFile.equals(aFile)) {</span>
<a href="#l8.140"></a><span id="l8.140" class="difflineplus">+      let uploader = new nsUbuntuOneFileUploader(this, aFile,</span>
<a href="#l8.141"></a><span id="l8.141" class="difflineplus">+                                                 this._uploaderCallback</span>
<a href="#l8.142"></a><span id="l8.142" class="difflineplus">+                                                   .bind(this),</span>
<a href="#l8.143"></a><span id="l8.143" class="difflineplus">+                                                 aCallback);</span>
<a href="#l8.144"></a><span id="l8.144" class="difflineplus">+      this._uploads.push(uploader);</span>
<a href="#l8.145"></a><span id="l8.145" class="difflineplus">+      return;</span>
<a href="#l8.146"></a><span id="l8.146" class="difflineplus">+    }</span>
<a href="#l8.147"></a><span id="l8.147" class="difflineplus">+    this._uploadingFile = aFile;</span>
<a href="#l8.148"></a><span id="l8.148" class="difflineplus">+</span>
<a href="#l8.149"></a><span id="l8.149" class="difflineplus">+    let successCallback = this._finishUpload.bind(this, aFile, aCallback);</span>
<a href="#l8.150"></a><span id="l8.150" class="difflineplus">+    if (!this._loggedIn)</span>
<a href="#l8.151"></a><span id="l8.151" class="difflineplus">+      return this._logonAndGetUserInfo(successCallback, null, true);</span>
<a href="#l8.152"></a><span id="l8.152" class="difflineplus">+    this.log.info(&quot;getting user info&quot;);</span>
<a href="#l8.153"></a><span id="l8.153" class="difflineplus">+    if (!this._userInfo)</span>
<a href="#l8.154"></a><span id="l8.154" class="difflineplus">+      return this._getUserInfo(successCallback);</span>
<a href="#l8.155"></a><span id="l8.155" class="difflineplus">+    successCallback();</span>
<a href="#l8.156"></a><span id="l8.156" class="difflineplus">+  },</span>
<a href="#l8.157"></a><span id="l8.157" class="difflineplus">+</span>
<a href="#l8.158"></a><span id="l8.158" class="difflineplus">+  /**</span>
<a href="#l8.159"></a><span id="l8.159" class="difflineplus">+   * A private function used to ensure that we can actually upload the file</span>
<a href="#l8.160"></a><span id="l8.160" class="difflineplus">+   * (we haven't exceeded file size or quota limitations), and then attempts</span>
<a href="#l8.161"></a><span id="l8.161" class="difflineplus">+   * to kick-off the upload.</span>
<a href="#l8.162"></a><span id="l8.162" class="difflineplus">+   *</span>
<a href="#l8.163"></a><span id="l8.163" class="difflineplus">+   * @param aFile the nsILocalFile to upload</span>
<a href="#l8.164"></a><span id="l8.164" class="difflineplus">+   * @param aCallback an nsIRequestObserver for monitoring the starting and</span>
<a href="#l8.165"></a><span id="l8.165" class="difflineplus">+   *                  ending states of the upload.</span>
<a href="#l8.166"></a><span id="l8.166" class="difflineplus">+   */</span>
<a href="#l8.167"></a><span id="l8.167" class="difflineplus">+  _finishUpload: function nsUbuntuOne__finishUpload(aFile, aCallback) {</span>
<a href="#l8.168"></a><span id="l8.168" class="difflineplus">+    let exceedsFileLimit = Ci.nsIMsgCloudFileProvider.uploadExceedsFileLimit;</span>
<a href="#l8.169"></a><span id="l8.169" class="difflineplus">+    let exceedsQuota = Ci.nsIMsgCloudFileProvider.uploadWouldExceedQuota;</span>
<a href="#l8.170"></a><span id="l8.170" class="difflineplus">+    if (aFile.fileSize &gt; this._availableStorage)</span>
<a href="#l8.171"></a><span id="l8.171" class="difflineplus">+      return aCallback.onStopRequest(null, null, exceedsQuota);</span>
<a href="#l8.172"></a><span id="l8.172" class="difflineplus">+</span>
<a href="#l8.173"></a><span id="l8.173" class="difflineplus">+    delete this._userInfo; // force us to update userInfo on every upload.</span>
<a href="#l8.174"></a><span id="l8.174" class="difflineplus">+</span>
<a href="#l8.175"></a><span id="l8.175" class="difflineplus">+    if (!this._uploader) {</span>
<a href="#l8.176"></a><span id="l8.176" class="difflineplus">+      this._uploader = new nsUbuntuOneFileUploader(this, aFile,</span>
<a href="#l8.177"></a><span id="l8.177" class="difflineplus">+                                                   this._uploaderCallback</span>
<a href="#l8.178"></a><span id="l8.178" class="difflineplus">+                                                     .bind(this),</span>
<a href="#l8.179"></a><span id="l8.179" class="difflineplus">+                                                   aCallback);</span>
<a href="#l8.180"></a><span id="l8.180" class="difflineplus">+      this._uploads.unshift(this._uploader);</span>
<a href="#l8.181"></a><span id="l8.181" class="difflineplus">+    }</span>
<a href="#l8.182"></a><span id="l8.182" class="difflineplus">+</span>
<a href="#l8.183"></a><span id="l8.183" class="difflineplus">+    this._uploadingFile = aFile;</span>
<a href="#l8.184"></a><span id="l8.184" class="difflineplus">+    this._uploader.uploadFile();</span>
<a href="#l8.185"></a><span id="l8.185" class="difflineplus">+  },</span>
<a href="#l8.186"></a><span id="l8.186" class="difflineplus">+</span>
<a href="#l8.187"></a><span id="l8.187" class="difflineplus">+  /**</span>
<a href="#l8.188"></a><span id="l8.188" class="difflineplus">+   * Attempts to cancel a file upload.</span>
<a href="#l8.189"></a><span id="l8.189" class="difflineplus">+   *</span>
<a href="#l8.190"></a><span id="l8.190" class="difflineplus">+   * @param aFile the nsILocalFile to cancel the upload for.</span>
<a href="#l8.191"></a><span id="l8.191" class="difflineplus">+   */</span>
<a href="#l8.192"></a><span id="l8.192" class="difflineplus">+  cancelFileUpload: function nsUbuntuOne_cancelFileUpload(aFile) {</span>
<a href="#l8.193"></a><span id="l8.193" class="difflineplus">+    this.log.info(&quot;Cancelling upload of file &quot; + aFile.leafName);</span>
<a href="#l8.194"></a><span id="l8.194" class="difflineplus">+    if (this._uploadingFile.equals(aFile)) {</span>
<a href="#l8.195"></a><span id="l8.195" class="difflineplus">+      this._uploader.cancel();</span>
<a href="#l8.196"></a><span id="l8.196" class="difflineplus">+    }</span>
<a href="#l8.197"></a><span id="l8.197" class="difflineplus">+    else {</span>
<a href="#l8.198"></a><span id="l8.198" class="difflineplus">+      for (let i = 0; i &lt; this._uploads.length; i++)</span>
<a href="#l8.199"></a><span id="l8.199" class="difflineplus">+        if (this._uploads[i].file.equals(aFile)) {</span>
<a href="#l8.200"></a><span id="l8.200" class="difflineplus">+          // We bypass the cancel() method here so that</span>
<a href="#l8.201"></a><span id="l8.201" class="difflineplus">+          // _uploaderCallback doesn't get called and chain to the</span>
<a href="#l8.202"></a><span id="l8.202" class="difflineplus">+          // next upload.</span>
<a href="#l8.203"></a><span id="l8.203" class="difflineplus">+          this._uploads[i].requestObserver.onStopRequest(</span>
<a href="#l8.204"></a><span id="l8.204" class="difflineplus">+            null, null, Ci.nsIMsgCloudFileProvider.uploadCanceled);</span>
<a href="#l8.205"></a><span id="l8.205" class="difflineplus">+          this._uploads.splice(i, 1);</span>
<a href="#l8.206"></a><span id="l8.206" class="difflineplus">+          return;</span>
<a href="#l8.207"></a><span id="l8.207" class="difflineplus">+        }</span>
<a href="#l8.208"></a><span id="l8.208" class="difflineplus">+    }</span>
<a href="#l8.209"></a><span id="l8.209" class="difflineplus">+  },</span>
<a href="#l8.210"></a><span id="l8.210" class="difflineplus">+</span>
<a href="#l8.211"></a><span id="l8.211" class="difflineplus">+  /**</span>
<a href="#l8.212"></a><span id="l8.212" class="difflineplus">+   * A private function used to retrieve the profile information for the</span>
<a href="#l8.213"></a><span id="l8.213" class="difflineplus">+   * user account associated with the accountKey.</span>
<a href="#l8.214"></a><span id="l8.214" class="difflineplus">+   *</span>
<a href="#l8.215"></a><span id="l8.215" class="difflineplus">+   * @param successCallback the function called if information retrieval</span>
<a href="#l8.216"></a><span id="l8.216" class="difflineplus">+   *                        is successful</span>
<a href="#l8.217"></a><span id="l8.217" class="difflineplus">+   * @param failureCallback the function called if information retrieval fails</span>
<a href="#l8.218"></a><span id="l8.218" class="difflineplus">+   */</span>
<a href="#l8.219"></a><span id="l8.219" class="difflineplus">+  _getUserInfo: function nsUbuntuOne__getUserInfo(successCallback,</span>
<a href="#l8.220"></a><span id="l8.220" class="difflineplus">+                                                  failureCallback) {</span>
<a href="#l8.221"></a><span id="l8.221" class="difflineplus">+    if (!successCallback)</span>
<a href="#l8.222"></a><span id="l8.222" class="difflineplus">+      successCallback = function() {</span>
<a href="#l8.223"></a><span id="l8.223" class="difflineplus">+        this.requestObserver</span>
<a href="#l8.224"></a><span id="l8.224" class="difflineplus">+            .onStopRequest(null, null,</span>
<a href="#l8.225"></a><span id="l8.225" class="difflineplus">+                           this._loggedIn ? Cr.NS_OK : Ci.nsIMsgCloudFileProvider.authErr);</span>
<a href="#l8.226"></a><span id="l8.226" class="difflineplus">+      }.bind(this);</span>
<a href="#l8.227"></a><span id="l8.227" class="difflineplus">+</span>
<a href="#l8.228"></a><span id="l8.228" class="difflineplus">+    if (!failureCallback)</span>
<a href="#l8.229"></a><span id="l8.229" class="difflineplus">+      failureCallback = function () {</span>
<a href="#l8.230"></a><span id="l8.230" class="difflineplus">+        this.requestObserver</span>
<a href="#l8.231"></a><span id="l8.231" class="difflineplus">+            .onStopRequest(null, null, Ci.nsIMsgCloudFileProvider.authErr);</span>
<a href="#l8.232"></a><span id="l8.232" class="difflineplus">+      }.bind(this);</span>
<a href="#l8.233"></a><span id="l8.233" class="difflineplus">+</span>
<a href="#l8.234"></a><span id="l8.234" class="difflineplus">+    let requestFailed = function(aException, aResponseText, aRequest) {</span>
<a href="#l8.235"></a><span id="l8.235" class="difflineplus">+      // Treat bad token specially, and fallback to</span>
<a href="#l8.236"></a><span id="l8.236" class="difflineplus">+      // going through the uploadFiles process</span>
<a href="#l8.237"></a><span id="l8.237" class="difflineplus">+      // again, and getting new tokens.</span>
<a href="#l8.238"></a><span id="l8.238" class="difflineplus">+      if (aRequest.status == kBadAccessToken) {</span>
<a href="#l8.239"></a><span id="l8.239" class="difflineplus">+        this.log.info(&quot;got bad token&quot;);</span>
<a href="#l8.240"></a><span id="l8.240" class="difflineplus">+        this._loggedIn = false;</span>
<a href="#l8.241"></a><span id="l8.241" class="difflineplus">+        this._cachedAuthToken = &quot;&quot;;</span>
<a href="#l8.242"></a><span id="l8.242" class="difflineplus">+        this._cachedAuthSecret = &quot;&quot;;</span>
<a href="#l8.243"></a><span id="l8.243" class="difflineplus">+        successCallback();</span>
<a href="#l8.244"></a><span id="l8.244" class="difflineplus">+        return;</span>
<a href="#l8.245"></a><span id="l8.245" class="difflineplus">+      }</span>
<a href="#l8.246"></a><span id="l8.246" class="difflineplus">+      this.log.error(&quot;user info failed, status = &quot; + aRequest.status);</span>
<a href="#l8.247"></a><span id="l8.247" class="difflineplus">+      this.log.error(&quot;response text = &quot; + aResponseText);</span>
<a href="#l8.248"></a><span id="l8.248" class="difflineplus">+      this.log.error(&quot;exception = &quot; + aException);</span>
<a href="#l8.249"></a><span id="l8.249" class="difflineplus">+      failureCallback();</span>
<a href="#l8.250"></a><span id="l8.250" class="difflineplus">+    }.bind(this)</span>
<a href="#l8.251"></a><span id="l8.251" class="difflineplus">+</span>
<a href="#l8.252"></a><span id="l8.252" class="difflineplus">+    this.log.info(&quot;Getting user info&quot;)</span>
<a href="#l8.253"></a><span id="l8.253" class="difflineplus">+    this._connection.signAndSend(</span>
<a href="#l8.254"></a><span id="l8.254" class="difflineplus">+      gServerUrl, [], &quot;GET&quot;, &quot;&quot;,</span>
<a href="#l8.255"></a><span id="l8.255" class="difflineplus">+      function(aResponseText, aRequest) {</span>
<a href="#l8.256"></a><span id="l8.256" class="difflineplus">+        this.log.info(&quot;user info = &quot; + aResponseText);</span>
<a href="#l8.257"></a><span id="l8.257" class="difflineplus">+        this._userInfo = JSON.parse(aResponseText);</span>
<a href="#l8.258"></a><span id="l8.258" class="difflineplus">+        this._fileSpaceUsed = this._userInfo.used_bytes;</span>
<a href="#l8.259"></a><span id="l8.259" class="difflineplus">+        this._availableStorage = this._userInfo.max_bytes - this._fileSpaceUsed;</span>
<a href="#l8.260"></a><span id="l8.260" class="difflineplus">+        this.log.info(&quot;avail storage = &quot; + this._availableStorage);</span>
<a href="#l8.261"></a><span id="l8.261" class="difflineplus">+</span>
<a href="#l8.262"></a><span id="l8.262" class="difflineplus">+        // Ensure that the volume where we will store attachments exists.</span>
<a href="#l8.263"></a><span id="l8.263" class="difflineplus">+        if (this._userInfo.user_node_paths.indexOf(kAttachmentsVolume) &lt; 0) {</span>
<a href="#l8.264"></a><span id="l8.264" class="difflineplus">+          this.log.info(&quot;Creating attachments volume&quot;);</span>
<a href="#l8.265"></a><span id="l8.265" class="difflineplus">+          let volumeUrl = (gServerUrl + kVolumesPath +</span>
<a href="#l8.266"></a><span id="l8.266" class="difflineplus">+                           encodePathForURI(kAttachmentsVolume));</span>
<a href="#l8.267"></a><span id="l8.267" class="difflineplus">+          this._connection.signAndSend(</span>
<a href="#l8.268"></a><span id="l8.268" class="difflineplus">+            volumeUrl, [], &quot;PUT&quot;, &quot;&quot;,</span>
<a href="#l8.269"></a><span id="l8.269" class="difflineplus">+            function(aResponseText, aRequest) {</span>
<a href="#l8.270"></a><span id="l8.270" class="difflineplus">+              this.log.info(&quot;Created new volume &quot; + kAttachmentsVolume);</span>
<a href="#l8.271"></a><span id="l8.271" class="difflineplus">+              successCallback();</span>
<a href="#l8.272"></a><span id="l8.272" class="difflineplus">+            }.bind(this),</span>
<a href="#l8.273"></a><span id="l8.273" class="difflineplus">+            requestFailed, this);</span>
<a href="#l8.274"></a><span id="l8.274" class="difflineplus">+        }</span>
<a href="#l8.275"></a><span id="l8.275" class="difflineplus">+        else {</span>
<a href="#l8.276"></a><span id="l8.276" class="difflineplus">+          successCallback();</span>
<a href="#l8.277"></a><span id="l8.277" class="difflineplus">+        }</span>
<a href="#l8.278"></a><span id="l8.278" class="difflineplus">+      }.bind(this),</span>
<a href="#l8.279"></a><span id="l8.279" class="difflineplus">+      requestFailed, this);</span>
<a href="#l8.280"></a><span id="l8.280" class="difflineplus">+  },</span>
<a href="#l8.281"></a><span id="l8.281" class="difflineplus">+</span>
<a href="#l8.282"></a><span id="l8.282" class="difflineplus">+  /**</span>
<a href="#l8.283"></a><span id="l8.283" class="difflineplus">+   * A private function that first ensures that the user is logged in, and then</span>
<a href="#l8.284"></a><span id="l8.284" class="difflineplus">+   * retrieves the user's profile information.</span>
<a href="#l8.285"></a><span id="l8.285" class="difflineplus">+   *</span>
<a href="#l8.286"></a><span id="l8.286" class="difflineplus">+   * @param aSuccessCallback the function called on successful information</span>
<a href="#l8.287"></a><span id="l8.287" class="difflineplus">+   *                         retrieval</span>
<a href="#l8.288"></a><span id="l8.288" class="difflineplus">+   * @param aFailureCallback the function called on failed information retrieval</span>
<a href="#l8.289"></a><span id="l8.289" class="difflineplus">+   * @param aWithUI a boolean for whether or not we should display authorization</span>
<a href="#l8.290"></a><span id="l8.290" class="difflineplus">+   *                UI if we don't have a valid token anymore, or just fail out.</span>
<a href="#l8.291"></a><span id="l8.291" class="difflineplus">+   */</span>
<a href="#l8.292"></a><span id="l8.292" class="difflineplus">+  _logonAndGetUserInfo: function nsUbuntuOne_logonAndGetUserInfo(aSuccessCallback,</span>
<a href="#l8.293"></a><span id="l8.293" class="difflineplus">+                                                                 aFailureCallback,</span>
<a href="#l8.294"></a><span id="l8.294" class="difflineplus">+                                                                 aWithUI) {</span>
<a href="#l8.295"></a><span id="l8.295" class="difflineplus">+    if (!aFailureCallback)</span>
<a href="#l8.296"></a><span id="l8.296" class="difflineplus">+      aFailureCallback = function () {</span>
<a href="#l8.297"></a><span id="l8.297" class="difflineplus">+        this.requestObserver</span>
<a href="#l8.298"></a><span id="l8.298" class="difflineplus">+            .onStopRequest(null, null, Ci.nsIMsgCloudFileProvider.authErr);</span>
<a href="#l8.299"></a><span id="l8.299" class="difflineplus">+      }.bind(this);</span>
<a href="#l8.300"></a><span id="l8.300" class="difflineplus">+</span>
<a href="#l8.301"></a><span id="l8.301" class="difflineplus">+    return this.logon(function() {</span>
<a href="#l8.302"></a><span id="l8.302" class="difflineplus">+      this._getUserInfo(aSuccessCallback, aFailureCallback);</span>
<a href="#l8.303"></a><span id="l8.303" class="difflineplus">+    }.bind(this), aFailureCallback, aWithUI);</span>
<a href="#l8.304"></a><span id="l8.304" class="difflineplus">+  },</span>
<a href="#l8.305"></a><span id="l8.305" class="difflineplus">+</span>
<a href="#l8.306"></a><span id="l8.306" class="difflineplus">+  /**</span>
<a href="#l8.307"></a><span id="l8.307" class="difflineplus">+   * For some nsILocalFile, return the associated sharing URL.</span>
<a href="#l8.308"></a><span id="l8.308" class="difflineplus">+   *</span>
<a href="#l8.309"></a><span id="l8.309" class="difflineplus">+   * @param aFile the nsILocalFile to retrieve the URL for</span>
<a href="#l8.310"></a><span id="l8.310" class="difflineplus">+   */</span>
<a href="#l8.311"></a><span id="l8.311" class="difflineplus">+  urlForFile: function nsUbuntuOne_urlForFile(aFile) {</span>
<a href="#l8.312"></a><span id="l8.312" class="difflineplus">+    return this._urlsForFiles[aFile.path];</span>
<a href="#l8.313"></a><span id="l8.313" class="difflineplus">+  },</span>
<a href="#l8.314"></a><span id="l8.314" class="difflineplus">+</span>
<a href="#l8.315"></a><span id="l8.315" class="difflineplus">+  /**</span>
<a href="#l8.316"></a><span id="l8.316" class="difflineplus">+   * Updates the profile information for the account associated with the</span>
<a href="#l8.317"></a><span id="l8.317" class="difflineplus">+   * account key.</span>
<a href="#l8.318"></a><span id="l8.318" class="difflineplus">+   *</span>
<a href="#l8.319"></a><span id="l8.319" class="difflineplus">+   * @param aWithUI a boolean for whether or not we should display authorization</span>
<a href="#l8.320"></a><span id="l8.320" class="difflineplus">+   *                UI if we don't have a valid token anymore, or just fail out.</span>
<a href="#l8.321"></a><span id="l8.321" class="difflineplus">+   * @param aCallback an nsIRequestObserver for observing the starting and</span>
<a href="#l8.322"></a><span id="l8.322" class="difflineplus">+   *                  ending states of the request.</span>
<a href="#l8.323"></a><span id="l8.323" class="difflineplus">+   */</span>
<a href="#l8.324"></a><span id="l8.324" class="difflineplus">+  refreshUserInfo: function nsUbuntuOne_refreshUserInfo(aWithUI, aCallback) {</span>
<a href="#l8.325"></a><span id="l8.325" class="difflineplus">+    if (Services.io.offline)</span>
<a href="#l8.326"></a><span id="l8.326" class="difflineplus">+      throw Ci.nsIMsgCloudFileProvider.offlineErr;</span>
<a href="#l8.327"></a><span id="l8.327" class="difflineplus">+    this.requestObserver = aCallback;</span>
<a href="#l8.328"></a><span id="l8.328" class="difflineplus">+    aCallback.onStartRequest(null, null);</span>
<a href="#l8.329"></a><span id="l8.329" class="difflineplus">+    if (!this._loggedIn)</span>
<a href="#l8.330"></a><span id="l8.330" class="difflineplus">+      return this._logonAndGetUserInfo(null, null, aWithUI);</span>
<a href="#l8.331"></a><span id="l8.331" class="difflineplus">+    if (!this._userInfo)</span>
<a href="#l8.332"></a><span id="l8.332" class="difflineplus">+      return this._getUserInfo();</span>
<a href="#l8.333"></a><span id="l8.333" class="difflineplus">+    return this._userInfo;</span>
<a href="#l8.334"></a><span id="l8.334" class="difflineplus">+  },</span>
<a href="#l8.335"></a><span id="l8.335" class="difflineplus">+</span>
<a href="#l8.336"></a><span id="l8.336" class="difflineplus">+</span>
<a href="#l8.337"></a><span id="l8.337" class="difflineplus">+  /**</span>
<a href="#l8.338"></a><span id="l8.338" class="difflineplus">+   * Our UbuntuOne implementation does not implement the createNewAccount</span>
<a href="#l8.339"></a><span id="l8.339" class="difflineplus">+   * function defined in nsIMsgCloudFileProvider.idl.</span>
<a href="#l8.340"></a><span id="l8.340" class="difflineplus">+   */</span>
<a href="#l8.341"></a><span id="l8.341" class="difflineplus">+  createNewAccount: function nsUbuntuOne_createNewAccount(aEmailAddress,</span>
<a href="#l8.342"></a><span id="l8.342" class="difflineplus">+                                                          aPassword, aFirstName,</span>
<a href="#l8.343"></a><span id="l8.343" class="difflineplus">+                                                          aLastName) {</span>
<a href="#l8.344"></a><span id="l8.344" class="difflineplus">+    return Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l8.345"></a><span id="l8.345" class="difflineplus">+  },</span>
<a href="#l8.346"></a><span id="l8.346" class="difflineplus">+</span>
<a href="#l8.347"></a><span id="l8.347" class="difflineplus">+  /**</span>
<a href="#l8.348"></a><span id="l8.348" class="difflineplus">+   * If the user already has an account, we can get the user to just login</span>
<a href="#l8.349"></a><span id="l8.349" class="difflineplus">+   * to it via OAuth.</span>
<a href="#l8.350"></a><span id="l8.350" class="difflineplus">+   *</span>
<a href="#l8.351"></a><span id="l8.351" class="difflineplus">+   * This function does not appear to be called from the BigFiles UI, and</span>
<a href="#l8.352"></a><span id="l8.352" class="difflineplus">+   * might be excisable.</span>
<a href="#l8.353"></a><span id="l8.353" class="difflineplus">+   */</span>
<a href="#l8.354"></a><span id="l8.354" class="difflineplus">+  createExistingAccount: function nsUbuntuOne_createExistingAccount(aRequestObserver) {</span>
<a href="#l8.355"></a><span id="l8.355" class="difflineplus">+     // XXX: replace this with a better function</span>
<a href="#l8.356"></a><span id="l8.356" class="difflineplus">+    let successCb = function(aResponseText, aRequest) {</span>
<a href="#l8.357"></a><span id="l8.357" class="difflineplus">+      aRequestObserver.onStopRequest(null, this, Cr.NS_OK);</span>
<a href="#l8.358"></a><span id="l8.358" class="difflineplus">+    }.bind(this);</span>
<a href="#l8.359"></a><span id="l8.359" class="difflineplus">+</span>
<a href="#l8.360"></a><span id="l8.360" class="difflineplus">+    let failureCb = function(aResponseText, aRequest) {</span>
<a href="#l8.361"></a><span id="l8.361" class="difflineplus">+      aRequestObserver.onStopRequest(null, this,</span>
<a href="#l8.362"></a><span id="l8.362" class="difflineplus">+                                     Ci.nsIMsgCloudFileProvider.authErr);</span>
<a href="#l8.363"></a><span id="l8.363" class="difflineplus">+    }.bind(this);</span>
<a href="#l8.364"></a><span id="l8.364" class="difflineplus">+</span>
<a href="#l8.365"></a><span id="l8.365" class="difflineplus">+    this.logon(successCb, failureCb, true);</span>
<a href="#l8.366"></a><span id="l8.366" class="difflineplus">+  },</span>
<a href="#l8.367"></a><span id="l8.367" class="difflineplus">+</span>
<a href="#l8.368"></a><span id="l8.368" class="difflineplus">+  /**</span>
<a href="#l8.369"></a><span id="l8.369" class="difflineplus">+   * If the provider doesn't have an API for creating an account, perhaps</span>
<a href="#l8.370"></a><span id="l8.370" class="difflineplus">+   * there's a url we can load in a content tab that will allow the user</span>
<a href="#l8.371"></a><span id="l8.371" class="difflineplus">+   * to create an account.</span>
<a href="#l8.372"></a><span id="l8.372" class="difflineplus">+   */</span>
<a href="#l8.373"></a><span id="l8.373" class="difflineplus">+  get createNewAccountUrl() &quot;&quot;,</span>
<a href="#l8.374"></a><span id="l8.374" class="difflineplus">+</span>
<a href="#l8.375"></a><span id="l8.375" class="difflineplus">+  /**</span>
<a href="#l8.376"></a><span id="l8.376" class="difflineplus">+   * For a particular error, return a URL if UbuntuOne has a page for handling</span>
<a href="#l8.377"></a><span id="l8.377" class="difflineplus">+   * that particular error.</span>
<a href="#l8.378"></a><span id="l8.378" class="difflineplus">+   *</span>
<a href="#l8.379"></a><span id="l8.379" class="difflineplus">+   * @param aError the error to get the URL for</span>
<a href="#l8.380"></a><span id="l8.380" class="difflineplus">+   */</span>
<a href="#l8.381"></a><span id="l8.381" class="difflineplus">+  providerUrlForError: function nsUbuntuOne_providerUrlForError(aError) {</span>
<a href="#l8.382"></a><span id="l8.382" class="difflineplus">+    if (aError == Ci.nsIMsgCloudFileProvider.uploadWouldExceedQuota)</span>
<a href="#l8.383"></a><span id="l8.383" class="difflineplus">+      return &quot;https://one.ubuntu.com/services/add-storage/&quot;;</span>
<a href="#l8.384"></a><span id="l8.384" class="difflineplus">+    return &quot;&quot;;</span>
<a href="#l8.385"></a><span id="l8.385" class="difflineplus">+  },</span>
<a href="#l8.386"></a><span id="l8.386" class="difflineplus">+</span>
<a href="#l8.387"></a><span id="l8.387" class="difflineplus">+  /**</span>
<a href="#l8.388"></a><span id="l8.388" class="difflineplus">+   * If we don't know the limit, this will return -1.</span>
<a href="#l8.389"></a><span id="l8.389" class="difflineplus">+   */</span>
<a href="#l8.390"></a><span id="l8.390" class="difflineplus">+  get fileUploadSizeLimit() -1,</span>
<a href="#l8.391"></a><span id="l8.391" class="difflineplus">+  get remainingFileSpace() this._availableStorage,</span>
<a href="#l8.392"></a><span id="l8.392" class="difflineplus">+  get fileSpaceUsed() this._fileSpaceUsed,</span>
<a href="#l8.393"></a><span id="l8.393" class="difflineplus">+</span>
<a href="#l8.394"></a><span id="l8.394" class="difflineplus">+  /**</span>
<a href="#l8.395"></a><span id="l8.395" class="difflineplus">+   * Attempt to delete an upload file if we've uploaded it.</span>
<a href="#l8.396"></a><span id="l8.396" class="difflineplus">+   *</span>
<a href="#l8.397"></a><span id="l8.397" class="difflineplus">+   * @param aFile the file that was originall uploaded</span>
<a href="#l8.398"></a><span id="l8.398" class="difflineplus">+   * @param aCallback an nsIRequestObserver for monitoring the starting and</span>
<a href="#l8.399"></a><span id="l8.399" class="difflineplus">+   *                  ending states of the deletion request.</span>
<a href="#l8.400"></a><span id="l8.400" class="difflineplus">+   */</span>
<a href="#l8.401"></a><span id="l8.401" class="difflineplus">+  deleteFile: function nsUbuntuOne_deleteFile(aFile, aCallback) {</span>
<a href="#l8.402"></a><span id="l8.402" class="difflineplus">+    if (Services.io.offline)</span>
<a href="#l8.403"></a><span id="l8.403" class="difflineplus">+      throw Ci.nsIMsgCloudFileProvider.offlineErr;</span>
<a href="#l8.404"></a><span id="l8.404" class="difflineplus">+</span>
<a href="#l8.405"></a><span id="l8.405" class="difflineplus">+    let uploadInfo = this._uploadInfo[aFile.path];</span>
<a href="#l8.406"></a><span id="l8.406" class="difflineplus">+    if (!uploadInfo)</span>
<a href="#l8.407"></a><span id="l8.407" class="difflineplus">+      throw Cr.NS_ERROR_FAILURE;</span>
<a href="#l8.408"></a><span id="l8.408" class="difflineplus">+</span>
<a href="#l8.409"></a><span id="l8.409" class="difflineplus">+    this.requestObserver = aCallback;</span>
<a href="#l8.410"></a><span id="l8.410" class="difflineplus">+    let url = gServerUrl + encodePathForURI(uploadInfo.resource_path);</span>
<a href="#l8.411"></a><span id="l8.411" class="difflineplus">+    this.log.info(&quot;Sending delete request to &quot; + url);</span>
<a href="#l8.412"></a><span id="l8.412" class="difflineplus">+    this._connection.signAndSend(url, [], &quot;DELETE&quot;, null,</span>
<a href="#l8.413"></a><span id="l8.413" class="difflineplus">+      function(aResponseText, aRequest) {</span>
<a href="#l8.414"></a><span id="l8.414" class="difflineplus">+        this.log.info(&quot;success deleting file; response = &quot; + aResponseText);</span>
<a href="#l8.415"></a><span id="l8.415" class="difflineplus">+        aCallback.onStopRequest(null, null, Cr.NS_OK);</span>
<a href="#l8.416"></a><span id="l8.416" class="difflineplus">+      }.bind(this),</span>
<a href="#l8.417"></a><span id="l8.417" class="difflineplus">+      function(aException, aResponseText, aRequest) {</span>
<a href="#l8.418"></a><span id="l8.418" class="difflineplus">+        this.log.error(&quot;failed deleting file; response = &quot; + aResponseText);</span>
<a href="#l8.419"></a><span id="l8.419" class="difflineplus">+        aCallback.onStopRequest(null, null, Ci.nsIMsgCloudFileProvider.uploadErr);</span>
<a href="#l8.420"></a><span id="l8.420" class="difflineplus">+      }.bind(this), this);</span>
<a href="#l8.421"></a><span id="l8.421" class="difflineplus">+  },</span>
<a href="#l8.422"></a><span id="l8.422" class="difflineplus">+</span>
<a href="#l8.423"></a><span id="l8.423" class="difflineplus">+  /**</span>
<a href="#l8.424"></a><span id="l8.424" class="difflineplus">+   * This function is used by our testing framework to override the default</span>
<a href="#l8.425"></a><span id="l8.425" class="difflineplus">+   * URL's that nsUbuntuOne connects to.</span>
<a href="#l8.426"></a><span id="l8.426" class="difflineplus">+   */</span>
<a href="#l8.427"></a><span id="l8.427" class="difflineplus">+  overrideUrls : function nsUbuntuOne_overrideUrls(aNumUrls, aUrls) {</span>
<a href="#l8.428"></a><span id="l8.428" class="difflineplus">+    gServerUrl = aUrls[0];</span>
<a href="#l8.429"></a><span id="l8.429" class="difflineplus">+    gContentUrl = aUrls[1];</span>
<a href="#l8.430"></a><span id="l8.430" class="difflineplus">+    gSsoUrl = aUrls[2];</span>
<a href="#l8.431"></a><span id="l8.431" class="difflineplus">+    gSsoPingUrl = aUrls[3];</span>
<a href="#l8.432"></a><span id="l8.432" class="difflineplus">+  },</span>
<a href="#l8.433"></a><span id="l8.433" class="difflineplus">+</span>
<a href="#l8.434"></a><span id="l8.434" class="difflineplus">+  _getPassword: function nsUbuntuOne__getPassword(aEmailAddress) {</span>
<a href="#l8.435"></a><span id="l8.435" class="difflineplus">+    this.log.info(&quot;Getting password for user: &quot; + aEmailAddress);</span>
<a href="#l8.436"></a><span id="l8.436" class="difflineplus">+</span>
<a href="#l8.437"></a><span id="l8.437" class="difflineplus">+    // OK, let's prompt for it.</span>
<a href="#l8.438"></a><span id="l8.438" class="difflineplus">+    let win = Services.wm.getMostRecentWindow(null);</span>
<a href="#l8.439"></a><span id="l8.439" class="difflineplus">+    let authPrompter = Services.ww.getNewAuthPrompter(win);</span>
<a href="#l8.440"></a><span id="l8.440" class="difflineplus">+    var password = { value: &quot;&quot; };</span>
<a href="#l8.441"></a><span id="l8.441" class="difflineplus">+    let userPos = gSsoUrl.indexOf(&quot;//&quot;) + 2;</span>
<a href="#l8.442"></a><span id="l8.442" class="difflineplus">+    let userNamePart = encodeURIComponent(this._emailAddress) + &quot;@&quot;;</span>
<a href="#l8.443"></a><span id="l8.443" class="difflineplus">+    let ssoUrl = (gSsoUrl.substr(0, userPos) + userNamePart +</span>
<a href="#l8.444"></a><span id="l8.444" class="difflineplus">+                  gSsoUrl.substring(userPos));</span>
<a href="#l8.445"></a><span id="l8.445" class="difflineplus">+    let messengerBundle = Services.strings.createBundle(</span>
<a href="#l8.446"></a><span id="l8.446" class="difflineplus">+      &quot;chrome://messenger/locale/messenger.properties&quot;);</span>
<a href="#l8.447"></a><span id="l8.447" class="difflineplus">+    let promptString = messengerBundle.formatStringFromName(&quot;passwordPrompt&quot;,</span>
<a href="#l8.448"></a><span id="l8.448" class="difflineplus">+                                                            [this._emailAddress,</span>
<a href="#l8.449"></a><span id="l8.449" class="difflineplus">+                                                             this.displayName],</span>
<a href="#l8.450"></a><span id="l8.450" class="difflineplus">+                                                            2);</span>
<a href="#l8.451"></a><span id="l8.451" class="difflineplus">+    if (authPrompter.promptPassword(this.displayName, promptString, ssoUrl,</span>
<a href="#l8.452"></a><span id="l8.452" class="difflineplus">+                                    authPrompter.SAVE_PASSWORD_NEVER,</span>
<a href="#l8.453"></a><span id="l8.453" class="difflineplus">+                                    password))</span>
<a href="#l8.454"></a><span id="l8.454" class="difflineplus">+      return password.value;</span>
<a href="#l8.455"></a><span id="l8.455" class="difflineplus">+</span>
<a href="#l8.456"></a><span id="l8.456" class="difflineplus">+    return &quot;&quot;;</span>
<a href="#l8.457"></a><span id="l8.457" class="difflineplus">+  },</span>
<a href="#l8.458"></a><span id="l8.458" class="difflineplus">+</span>
<a href="#l8.459"></a><span id="l8.459" class="difflineplus">+  _acquireToken: function nsUbuntuOne__acquireToken(successCallback,</span>
<a href="#l8.460"></a><span id="l8.460" class="difflineplus">+                                                    failureCallback) {</span>
<a href="#l8.461"></a><span id="l8.461" class="difflineplus">+    this.log.info(&quot;Acquiring a token&quot;);</span>
<a href="#l8.462"></a><span id="l8.462" class="difflineplus">+    let password = this._getPassword(this._emailAddress);</span>
<a href="#l8.463"></a><span id="l8.463" class="difflineplus">+</span>
<a href="#l8.464"></a><span id="l8.464" class="difflineplus">+    if (!password) {</span>
<a href="#l8.465"></a><span id="l8.465" class="difflineplus">+      this.log.info(&quot;No password provided&quot;);</span>
<a href="#l8.466"></a><span id="l8.466" class="difflineplus">+      failureCallback();</span>
<a href="#l8.467"></a><span id="l8.467" class="difflineplus">+    }</span>
<a href="#l8.468"></a><span id="l8.468" class="difflineplus">+</span>
<a href="#l8.469"></a><span id="l8.469" class="difflineplus">+    let userPos = gSsoUrl.indexOf(&quot;//&quot;) + 2;</span>
<a href="#l8.470"></a><span id="l8.470" class="difflineplus">+    let credentials = &quot;Basic &quot; + btoa(this._emailAddress + &quot;:&quot; + password);</span>
<a href="#l8.471"></a><span id="l8.471" class="difflineplus">+    let dnsService = Cc[&quot;@mozilla.org/network/dns-service;1&quot;]</span>
<a href="#l8.472"></a><span id="l8.472" class="difflineplus">+      .getService(Components.interfaces.nsIDNSService);</span>
<a href="#l8.473"></a><span id="l8.473" class="difflineplus">+    let tokenName = &quot;Ubuntu One @ &quot; + dnsService.myHostName + &quot; [thunderbird]&quot;;</span>
<a href="#l8.474"></a><span id="l8.474" class="difflineplus">+    let newTokenUrl = gSsoUrl + &quot;?ws.op=authenticate&amp;token_name=&quot; +</span>
<a href="#l8.475"></a><span id="l8.475" class="difflineplus">+      encodeURIComponent(tokenName);</span>
<a href="#l8.476"></a><span id="l8.476" class="difflineplus">+</span>
<a href="#l8.477"></a><span id="l8.477" class="difflineplus">+    this.log.info(&quot;Requesting Authentication token&quot;);</span>
<a href="#l8.478"></a><span id="l8.478" class="difflineplus">+    doXHRequest(</span>
<a href="#l8.479"></a><span id="l8.479" class="difflineplus">+      newTokenUrl, [[&quot;Authorization&quot;, credentials]], &quot;&quot;,</span>
<a href="#l8.480"></a><span id="l8.480" class="difflineplus">+      function(aResponseText, aRequest) {</span>
<a href="#l8.481"></a><span id="l8.481" class="difflineplus">+        this.log.info(&quot;Retrieved a new token from SSO&quot;);</span>
<a href="#l8.482"></a><span id="l8.482" class="difflineplus">+        let tokenInfo = JSON.parse(aResponseText);</span>
<a href="#l8.483"></a><span id="l8.483" class="difflineplus">+</span>
<a href="#l8.484"></a><span id="l8.484" class="difflineplus">+        // We need to tell Ubuntu One to pull the token from the SSO</span>
<a href="#l8.485"></a><span id="l8.485" class="difflineplus">+        // service now.</span>
<a href="#l8.486"></a><span id="l8.486" class="difflineplus">+        this._connection = new OAuth(this.displayName, null, null,</span>
<a href="#l8.487"></a><span id="l8.487" class="difflineplus">+                                     tokenInfo.token, tokenInfo.token_secret,</span>
<a href="#l8.488"></a><span id="l8.488" class="difflineplus">+                                     tokenInfo.consumer_key,</span>
<a href="#l8.489"></a><span id="l8.489" class="difflineplus">+                                     tokenInfo.consumer_secret);</span>
<a href="#l8.490"></a><span id="l8.490" class="difflineplus">+        this._connection.signAndSend(</span>
<a href="#l8.491"></a><span id="l8.491" class="difflineplus">+          gSsoPingUrl, [], &quot;POST&quot;, &quot;&quot;,</span>
<a href="#l8.492"></a><span id="l8.492" class="difflineplus">+          function(aResponseText, aRequest) {</span>
<a href="#l8.493"></a><span id="l8.493" class="difflineplus">+            this.log.info(&quot;Token transferred to Ubuntu One: &quot; + aResponseText);</span>
<a href="#l8.494"></a><span id="l8.494" class="difflineplus">+            // Now that the token has successfully been transferred,</span>
<a href="#l8.495"></a><span id="l8.495" class="difflineplus">+            // save it locally.</span>
<a href="#l8.496"></a><span id="l8.496" class="difflineplus">+            this._cachedAuthToken = tokenInfo.token;</span>
<a href="#l8.497"></a><span id="l8.497" class="difflineplus">+            this._cachedAuthSecret = tokenInfo.token_secret;</span>
<a href="#l8.498"></a><span id="l8.498" class="difflineplus">+            this._cachedConsumerKey = tokenInfo.consumer_key;</span>
<a href="#l8.499"></a><span id="l8.499" class="difflineplus">+            this._cachedConsumerSecret = tokenInfo.consumer_secret;</span>
<a href="#l8.500"></a><span id="l8.500" class="difflineplus">+            successCallback();</span>
<a href="#l8.501"></a><span id="l8.501" class="difflineplus">+          }.bind(this),</span>
<a href="#l8.502"></a><span id="l8.502" class="difflineplus">+          function(aException, aResponseText, aRequest) {</span>
<a href="#l8.503"></a><span id="l8.503" class="difflineplus">+            this.log.info(&quot;Failed to transfer access token to Ubuntu One:&quot; +</span>
<a href="#l8.504"></a><span id="l8.504" class="difflineplus">+                          aResponseText);</span>
<a href="#l8.505"></a><span id="l8.505" class="difflineplus">+            failureCallback();</span>
<a href="#l8.506"></a><span id="l8.506" class="difflineplus">+          }.bind(this). this);</span>
<a href="#l8.507"></a><span id="l8.507" class="difflineplus">+      }.bind(this),</span>
<a href="#l8.508"></a><span id="l8.508" class="difflineplus">+      function(aException, aResponseText, aRequest) {</span>
<a href="#l8.509"></a><span id="l8.509" class="difflineplus">+        this.log.info(&quot;Failed to acquire an access token:&quot; + aResponseText);</span>
<a href="#l8.510"></a><span id="l8.510" class="difflineplus">+        failureCallback();</span>
<a href="#l8.511"></a><span id="l8.511" class="difflineplus">+      }.bind(this), this, &quot;GET&quot;);</span>
<a href="#l8.512"></a><span id="l8.512" class="difflineplus">+  },</span>
<a href="#l8.513"></a><span id="l8.513" class="difflineplus">+</span>
<a href="#l8.514"></a><span id="l8.514" class="difflineplus">+  /**</span>
<a href="#l8.515"></a><span id="l8.515" class="difflineplus">+   * logon to the Ubuntu One account.</span>
<a href="#l8.516"></a><span id="l8.516" class="difflineplus">+   *</span>
<a href="#l8.517"></a><span id="l8.517" class="difflineplus">+   * @param successCallback - called if logon is successful</span>
<a href="#l8.518"></a><span id="l8.518" class="difflineplus">+   * @param failureCallback - called back on error.</span>
<a href="#l8.519"></a><span id="l8.519" class="difflineplus">+   * @param aWithUI if false, logon fails if it would have needed to put up UI.</span>
<a href="#l8.520"></a><span id="l8.520" class="difflineplus">+   *                This is used for things like displaying account settings,</span>
<a href="#l8.521"></a><span id="l8.521" class="difflineplus">+   *                where we don't want to pop up the oauth ui.</span>
<a href="#l8.522"></a><span id="l8.522" class="difflineplus">+   */</span>
<a href="#l8.523"></a><span id="l8.523" class="difflineplus">+  logon: function nsUbuntuOne_logon(successCallback, failureCallback, aWithUI) {</span>
<a href="#l8.524"></a><span id="l8.524" class="difflineplus">+    let authToken = this._cachedAuthToken;</span>
<a href="#l8.525"></a><span id="l8.525" class="difflineplus">+    let authSecret = this._cachedAuthSecret;</span>
<a href="#l8.526"></a><span id="l8.526" class="difflineplus">+    let consumerKey = this._cachedConsumerKey;</span>
<a href="#l8.527"></a><span id="l8.527" class="difflineplus">+    let consumerSecret = this._cachedConsumerSecret;</span>
<a href="#l8.528"></a><span id="l8.528" class="difflineplus">+    if (!aWithUI &amp;&amp; (!authToken.length || !authSecret.length ||</span>
<a href="#l8.529"></a><span id="l8.529" class="difflineplus">+                     !consumerKey.length || !consumerSecret.length)) {</span>
<a href="#l8.530"></a><span id="l8.530" class="difflineplus">+      failureCallback();</span>
<a href="#l8.531"></a><span id="l8.531" class="difflineplus">+      return;</span>
<a href="#l8.532"></a><span id="l8.532" class="difflineplus">+    }</span>
<a href="#l8.533"></a><span id="l8.533" class="difflineplus">+</span>
<a href="#l8.534"></a><span id="l8.534" class="difflineplus">+    let haveTokenCb = function() {</span>
<a href="#l8.535"></a><span id="l8.535" class="difflineplus">+      // Should probably perform a verification step to ensure that</span>
<a href="#l8.536"></a><span id="l8.536" class="difflineplus">+      // the token is still valid.</span>
<a href="#l8.537"></a><span id="l8.537" class="difflineplus">+      this._loggedIn = true;</span>
<a href="#l8.538"></a><span id="l8.538" class="difflineplus">+      successCallback();</span>
<a href="#l8.539"></a><span id="l8.539" class="difflineplus">+    }.bind(this);</span>
<a href="#l8.540"></a><span id="l8.540" class="difflineplus">+</span>
<a href="#l8.541"></a><span id="l8.541" class="difflineplus">+    if (authToken.length &amp;&amp; authSecret.length &amp;&amp;</span>
<a href="#l8.542"></a><span id="l8.542" class="difflineplus">+        consumerKey.length &amp;&amp; consumerSecret.length) {</span>
<a href="#l8.543"></a><span id="l8.543" class="difflineplus">+      this._connection = new OAuth(this.displayName, null, null,</span>
<a href="#l8.544"></a><span id="l8.544" class="difflineplus">+                                   authToken, authSecret,</span>
<a href="#l8.545"></a><span id="l8.545" class="difflineplus">+                                   consumerKey, consumerSecret);</span>
<a href="#l8.546"></a><span id="l8.546" class="difflineplus">+      haveTokenCb();</span>
<a href="#l8.547"></a><span id="l8.547" class="difflineplus">+    }</span>
<a href="#l8.548"></a><span id="l8.548" class="difflineplus">+    else {</span>
<a href="#l8.549"></a><span id="l8.549" class="difflineplus">+      if (!aWithUI) {</span>
<a href="#l8.550"></a><span id="l8.550" class="difflineplus">+        failureCallback();</span>
<a href="#l8.551"></a><span id="l8.551" class="difflineplus">+        return;</span>
<a href="#l8.552"></a><span id="l8.552" class="difflineplus">+      }</span>
<a href="#l8.553"></a><span id="l8.553" class="difflineplus">+      this._acquireToken(haveTokenCb, failureCallback);</span>
<a href="#l8.554"></a><span id="l8.554" class="difflineplus">+    }</span>
<a href="#l8.555"></a><span id="l8.555" class="difflineplus">+  },</span>
<a href="#l8.556"></a><span id="l8.556" class="difflineplus">+</span>
<a href="#l8.557"></a><span id="l8.557" class="difflineplus">+  /**</span>
<a href="#l8.558"></a><span id="l8.558" class="difflineplus">+   * Retrieves the cached auth token for this account.</span>
<a href="#l8.559"></a><span id="l8.559" class="difflineplus">+   */</span>
<a href="#l8.560"></a><span id="l8.560" class="difflineplus">+  get _cachedAuthToken() {</span>
<a href="#l8.561"></a><span id="l8.561" class="difflineplus">+    let authToken = cloudFileAccounts.getSecretValue(this.accountKey,</span>
<a href="#l8.562"></a><span id="l8.562" class="difflineplus">+                                                     cloudFileAccounts.kTokenRealm);</span>
<a href="#l8.563"></a><span id="l8.563" class="difflineplus">+    if (!authToken)</span>
<a href="#l8.564"></a><span id="l8.564" class="difflineplus">+      return &quot;&quot;;</span>
<a href="#l8.565"></a><span id="l8.565" class="difflineplus">+</span>
<a href="#l8.566"></a><span id="l8.566" class="difflineplus">+    return authToken;</span>
<a href="#l8.567"></a><span id="l8.567" class="difflineplus">+  },</span>
<a href="#l8.568"></a><span id="l8.568" class="difflineplus">+</span>
<a href="#l8.569"></a><span id="l8.569" class="difflineplus">+  /**</span>
<a href="#l8.570"></a><span id="l8.570" class="difflineplus">+   * Sets the cached auth token for this account.</span>
<a href="#l8.571"></a><span id="l8.571" class="difflineplus">+   *</span>
<a href="#l8.572"></a><span id="l8.572" class="difflineplus">+   * @param aAuthToken the auth token to cache.</span>
<a href="#l8.573"></a><span id="l8.573" class="difflineplus">+   */</span>
<a href="#l8.574"></a><span id="l8.574" class="difflineplus">+  set _cachedAuthToken(aAuthToken) {</span>
<a href="#l8.575"></a><span id="l8.575" class="difflineplus">+    cloudFileAccounts.setSecretValue(this.accountKey,</span>
<a href="#l8.576"></a><span id="l8.576" class="difflineplus">+                                     cloudFileAccounts.kTokenRealm,</span>
<a href="#l8.577"></a><span id="l8.577" class="difflineplus">+                                     aAuthToken);</span>
<a href="#l8.578"></a><span id="l8.578" class="difflineplus">+  },</span>
<a href="#l8.579"></a><span id="l8.579" class="difflineplus">+</span>
<a href="#l8.580"></a><span id="l8.580" class="difflineplus">+  /**</span>
<a href="#l8.581"></a><span id="l8.581" class="difflineplus">+   * Retrieves the cached auth secret for this account.</span>
<a href="#l8.582"></a><span id="l8.582" class="difflineplus">+   */</span>
<a href="#l8.583"></a><span id="l8.583" class="difflineplus">+  get _cachedAuthSecret() {</span>
<a href="#l8.584"></a><span id="l8.584" class="difflineplus">+    let authSecret = cloudFileAccounts.getSecretValue(this.accountKey,</span>
<a href="#l8.585"></a><span id="l8.585" class="difflineplus">+                                                      kAuthSecretRealm);</span>
<a href="#l8.586"></a><span id="l8.586" class="difflineplus">+</span>
<a href="#l8.587"></a><span id="l8.587" class="difflineplus">+    if (!authSecret)</span>
<a href="#l8.588"></a><span id="l8.588" class="difflineplus">+      return &quot;&quot;;</span>
<a href="#l8.589"></a><span id="l8.589" class="difflineplus">+</span>
<a href="#l8.590"></a><span id="l8.590" class="difflineplus">+    return authSecret;</span>
<a href="#l8.591"></a><span id="l8.591" class="difflineplus">+  },</span>
<a href="#l8.592"></a><span id="l8.592" class="difflineplus">+</span>
<a href="#l8.593"></a><span id="l8.593" class="difflineplus">+  /**</span>
<a href="#l8.594"></a><span id="l8.594" class="difflineplus">+   * Sets the cached auth secret for this account.</span>
<a href="#l8.595"></a><span id="l8.595" class="difflineplus">+   *</span>
<a href="#l8.596"></a><span id="l8.596" class="difflineplus">+   * @param aAuthSecret the auth secret to cache.</span>
<a href="#l8.597"></a><span id="l8.597" class="difflineplus">+   */</span>
<a href="#l8.598"></a><span id="l8.598" class="difflineplus">+  set _cachedAuthSecret(aAuthSecret) {</span>
<a href="#l8.599"></a><span id="l8.599" class="difflineplus">+    cloudFileAccounts.setSecretValue(this.accountKey,</span>
<a href="#l8.600"></a><span id="l8.600" class="difflineplus">+                                     kAuthSecretRealm,</span>
<a href="#l8.601"></a><span id="l8.601" class="difflineplus">+                                     aAuthSecret);</span>
<a href="#l8.602"></a><span id="l8.602" class="difflineplus">+  },</span>
<a href="#l8.603"></a><span id="l8.603" class="difflineplus">+</span>
<a href="#l8.604"></a><span id="l8.604" class="difflineplus">+  /**</span>
<a href="#l8.605"></a><span id="l8.605" class="difflineplus">+   * Retrieves the cached consumer key for this account.</span>
<a href="#l8.606"></a><span id="l8.606" class="difflineplus">+   */</span>
<a href="#l8.607"></a><span id="l8.607" class="difflineplus">+  get _cachedConsumerKey() {</span>
<a href="#l8.608"></a><span id="l8.608" class="difflineplus">+    let consumerKey = cloudFileAccounts.getSecretValue(this.accountKey,</span>
<a href="#l8.609"></a><span id="l8.609" class="difflineplus">+                                                       kConsumerKeyRealm);</span>
<a href="#l8.610"></a><span id="l8.610" class="difflineplus">+</span>
<a href="#l8.611"></a><span id="l8.611" class="difflineplus">+    if (!consumerKey)</span>
<a href="#l8.612"></a><span id="l8.612" class="difflineplus">+      return &quot;&quot;;</span>
<a href="#l8.613"></a><span id="l8.613" class="difflineplus">+</span>
<a href="#l8.614"></a><span id="l8.614" class="difflineplus">+    return consumerKey;</span>
<a href="#l8.615"></a><span id="l8.615" class="difflineplus">+  },</span>
<a href="#l8.616"></a><span id="l8.616" class="difflineplus">+</span>
<a href="#l8.617"></a><span id="l8.617" class="difflineplus">+  /**</span>
<a href="#l8.618"></a><span id="l8.618" class="difflineplus">+   * Sets the cached consumer key for this account.</span>
<a href="#l8.619"></a><span id="l8.619" class="difflineplus">+   *</span>
<a href="#l8.620"></a><span id="l8.620" class="difflineplus">+   * @param aConsumerKey the consumer key to cache.</span>
<a href="#l8.621"></a><span id="l8.621" class="difflineplus">+   */</span>
<a href="#l8.622"></a><span id="l8.622" class="difflineplus">+  set _cachedConsumerKey(aConsumerKey) {</span>
<a href="#l8.623"></a><span id="l8.623" class="difflineplus">+    cloudFileAccounts.setSecretValue(this.accountKey,</span>
<a href="#l8.624"></a><span id="l8.624" class="difflineplus">+                                     kConsumerKeyRealm,</span>
<a href="#l8.625"></a><span id="l8.625" class="difflineplus">+                                     aConsumerKey);</span>
<a href="#l8.626"></a><span id="l8.626" class="difflineplus">+  },</span>
<a href="#l8.627"></a><span id="l8.627" class="difflineplus">+</span>
<a href="#l8.628"></a><span id="l8.628" class="difflineplus">+  /**</span>
<a href="#l8.629"></a><span id="l8.629" class="difflineplus">+   * Retrieves the cached consumer secret for this account.</span>
<a href="#l8.630"></a><span id="l8.630" class="difflineplus">+   */</span>
<a href="#l8.631"></a><span id="l8.631" class="difflineplus">+  get _cachedConsumerSecret() {</span>
<a href="#l8.632"></a><span id="l8.632" class="difflineplus">+    let consumerSecret = cloudFileAccounts.getSecretValue(this.accountKey,</span>
<a href="#l8.633"></a><span id="l8.633" class="difflineplus">+                                                          kConsumerSecretRealm);</span>
<a href="#l8.634"></a><span id="l8.634" class="difflineplus">+</span>
<a href="#l8.635"></a><span id="l8.635" class="difflineplus">+    if (!consumerSecret)</span>
<a href="#l8.636"></a><span id="l8.636" class="difflineplus">+      return &quot;&quot;;</span>
<a href="#l8.637"></a><span id="l8.637" class="difflineplus">+</span>
<a href="#l8.638"></a><span id="l8.638" class="difflineplus">+    return consumerSecret;</span>
<a href="#l8.639"></a><span id="l8.639" class="difflineplus">+  },</span>
<a href="#l8.640"></a><span id="l8.640" class="difflineplus">+</span>
<a href="#l8.641"></a><span id="l8.641" class="difflineplus">+  /**</span>
<a href="#l8.642"></a><span id="l8.642" class="difflineplus">+   * Sets the cached consumer secret for this account.</span>
<a href="#l8.643"></a><span id="l8.643" class="difflineplus">+   *</span>
<a href="#l8.644"></a><span id="l8.644" class="difflineplus">+   * @param aConsumerSecret the auth secret to cache.</span>
<a href="#l8.645"></a><span id="l8.645" class="difflineplus">+   */</span>
<a href="#l8.646"></a><span id="l8.646" class="difflineplus">+  set _cachedConsumerSecret(aConsumerSecret) {</span>
<a href="#l8.647"></a><span id="l8.647" class="difflineplus">+    cloudFileAccounts.setSecretValue(this.accountKey,</span>
<a href="#l8.648"></a><span id="l8.648" class="difflineplus">+                                     kConsumerSecretRealm,</span>
<a href="#l8.649"></a><span id="l8.649" class="difflineplus">+                                     aConsumerSecret);</span>
<a href="#l8.650"></a><span id="l8.650" class="difflineplus">+  },</span>
<a href="#l8.651"></a><span id="l8.651" class="difflineplus">+</span>
<a href="#l8.652"></a><span id="l8.652" class="difflineplus">+};</span>
<a href="#l8.653"></a><span id="l8.653" class="difflineplus">+</span>
<a href="#l8.654"></a><span id="l8.654" class="difflineplus">+function nsUbuntuOneFileUploader(aUbuntuOne, aFile, aCallback,</span>
<a href="#l8.655"></a><span id="l8.655" class="difflineplus">+                                 aRequestObserver) {</span>
<a href="#l8.656"></a><span id="l8.656" class="difflineplus">+  this.ubuntuone = aUbuntuOne;</span>
<a href="#l8.657"></a><span id="l8.657" class="difflineplus">+  this.log = this.ubuntuone.log;</span>
<a href="#l8.658"></a><span id="l8.658" class="difflineplus">+  this.log.info(&quot;new nsUbuntuOneFileUploader file = &quot; + aFile.leafName);</span>
<a href="#l8.659"></a><span id="l8.659" class="difflineplus">+  this.file = aFile;</span>
<a href="#l8.660"></a><span id="l8.660" class="difflineplus">+  this.callback = aCallback;</span>
<a href="#l8.661"></a><span id="l8.661" class="difflineplus">+  this.requestObserver = aRequestObserver;</span>
<a href="#l8.662"></a><span id="l8.662" class="difflineplus">+}</span>
<a href="#l8.663"></a><span id="l8.663" class="difflineplus">+</span>
<a href="#l8.664"></a><span id="l8.664" class="difflineplus">+nsUbuntuOneFileUploader.prototype = {</span>
<a href="#l8.665"></a><span id="l8.665" class="difflineplus">+  ubuntuone: null,</span>
<a href="#l8.666"></a><span id="l8.666" class="difflineplus">+  file: null,</span>
<a href="#l8.667"></a><span id="l8.667" class="difflineplus">+  callback: null,</span>
<a href="#l8.668"></a><span id="l8.668" class="difflineplus">+  request: null,</span>
<a href="#l8.669"></a><span id="l8.669" class="difflineplus">+</span>
<a href="#l8.670"></a><span id="l8.670" class="difflineplus">+  /**</span>
<a href="#l8.671"></a><span id="l8.671" class="difflineplus">+   * Kicks off the upload request for the file associated with this Uploader.</span>
<a href="#l8.672"></a><span id="l8.672" class="difflineplus">+   */</span>
<a href="#l8.673"></a><span id="l8.673" class="difflineplus">+  uploadFile: function nsU1FU_uploadFile() {</span>
<a href="#l8.674"></a><span id="l8.674" class="difflineplus">+    this.requestObserver.onStartRequest(null, null);</span>
<a href="#l8.675"></a><span id="l8.675" class="difflineplus">+    // XXX: should check to see if there is another file by this name</span>
<a href="#l8.676"></a><span id="l8.676" class="difflineplus">+    // in the folder.  Perhaps put attachments in date oriented</span>
<a href="#l8.677"></a><span id="l8.677" class="difflineplus">+    // directories?</span>
<a href="#l8.678"></a><span id="l8.678" class="difflineplus">+    let path = kAttachmentsVolume + &quot;/&quot; + this.file.leafName;</span>
<a href="#l8.679"></a><span id="l8.679" class="difflineplus">+    this.log.info(&quot;ready to upload file &quot; + path);</span>
<a href="#l8.680"></a><span id="l8.680" class="difflineplus">+    let url = gContentUrl + encodePathForURI(path);</span>
<a href="#l8.681"></a><span id="l8.681" class="difflineplus">+    let mimeService = Cc[&quot;@mozilla.org/mime;1&quot;].getService(Ci.nsIMIMEService);</span>
<a href="#l8.682"></a><span id="l8.682" class="difflineplus">+    let contentType;</span>
<a href="#l8.683"></a><span id="l8.683" class="difflineplus">+    try {</span>
<a href="#l8.684"></a><span id="l8.684" class="difflineplus">+      contentType = mimeService.getTypeFromFile(this.file);</span>
<a href="#l8.685"></a><span id="l8.685" class="difflineplus">+    }</span>
<a href="#l8.686"></a><span id="l8.686" class="difflineplus">+    catch (ex) {</span>
<a href="#l8.687"></a><span id="l8.687" class="difflineplus">+      contentType = &quot;application/octet-stream&quot;;</span>
<a href="#l8.688"></a><span id="l8.688" class="difflineplus">+    }</span>
<a href="#l8.689"></a><span id="l8.689" class="difflineplus">+    let headers = [[&quot;Content-Type&quot;, contentType]];</span>
<a href="#l8.690"></a><span id="l8.690" class="difflineplus">+    let fstream = Cc[&quot;@mozilla.org/network/file-input-stream;1&quot;]</span>
<a href="#l8.691"></a><span id="l8.691" class="difflineplus">+                     .createInstance(Ci.nsIFileInputStream);</span>
<a href="#l8.692"></a><span id="l8.692" class="difflineplus">+    fstream.init(this.file, -1, 0, 0);</span>
<a href="#l8.693"></a><span id="l8.693" class="difflineplus">+    let bufStream = Cc[&quot;@mozilla.org/network/buffered-input-stream;1&quot;].</span>
<a href="#l8.694"></a><span id="l8.694" class="difflineplus">+      createInstance(Ci.nsIBufferedInputStream);</span>
<a href="#l8.695"></a><span id="l8.695" class="difflineplus">+    bufStream.init(fstream, this.file.fileSize);</span>
<a href="#l8.696"></a><span id="l8.696" class="difflineplus">+    bufStream = bufStream.QueryInterface(Ci.nsIInputStream);</span>
<a href="#l8.697"></a><span id="l8.697" class="difflineplus">+    this.request = this.ubuntuone._connection.signAndSend(</span>
<a href="#l8.698"></a><span id="l8.698" class="difflineplus">+      url, headers, &quot;PUT&quot;, bufStream,</span>
<a href="#l8.699"></a><span id="l8.699" class="difflineplus">+      function(aResponseText, aRequest) {</span>
<a href="#l8.700"></a><span id="l8.700" class="difflineplus">+        this.request = null;</span>
<a href="#l8.701"></a><span id="l8.701" class="difflineplus">+        this.log.info(&quot;success putting file &quot; + aResponseText);</span>
<a href="#l8.702"></a><span id="l8.702" class="difflineplus">+        let nodeInfo = JSON.parse(aResponseText);</span>
<a href="#l8.703"></a><span id="l8.703" class="difflineplus">+        this._getShareUrl(nodeInfo);</span>
<a href="#l8.704"></a><span id="l8.704" class="difflineplus">+      }.bind(this),</span>
<a href="#l8.705"></a><span id="l8.705" class="difflineplus">+      function(aException, aResponseText, aRequest) {</span>
<a href="#l8.706"></a><span id="l8.706" class="difflineplus">+        this.request = null;</span>
<a href="#l8.707"></a><span id="l8.707" class="difflineplus">+        this.log.info(&quot;failed putting file response = &quot; + aException);</span>
<a href="#l8.708"></a><span id="l8.708" class="difflineplus">+        if (this.callback)</span>
<a href="#l8.709"></a><span id="l8.709" class="difflineplus">+          this.callback(this.requestObserver,</span>
<a href="#l8.710"></a><span id="l8.710" class="difflineplus">+                        Ci.nsIMsgCloudFileProvider.uploadErr);</span>
<a href="#l8.711"></a><span id="l8.711" class="difflineplus">+      }.bind(this), this);</span>
<a href="#l8.712"></a><span id="l8.712" class="difflineplus">+  },</span>
<a href="#l8.713"></a><span id="l8.713" class="difflineplus">+</span>
<a href="#l8.714"></a><span id="l8.714" class="difflineplus">+  /**</span>
<a href="#l8.715"></a><span id="l8.715" class="difflineplus">+   * Cancels the upload request for the file associated with this Uploader.</span>
<a href="#l8.716"></a><span id="l8.716" class="difflineplus">+   */</span>
<a href="#l8.717"></a><span id="l8.717" class="difflineplus">+  cancel: function nsU1FU_cancel() {</span>
<a href="#l8.718"></a><span id="l8.718" class="difflineplus">+    this.log.info(&quot;Cancelling upload of &quot; + this.file.leafName);</span>
<a href="#l8.719"></a><span id="l8.719" class="difflineplus">+    this.callback(this.requestObserver, Ci.nsIMsgCloudFileProvider.uploadCanceled);</span>
<a href="#l8.720"></a><span id="l8.720" class="difflineplus">+    this.callback = null;</span>
<a href="#l8.721"></a><span id="l8.721" class="difflineplus">+    if (this.request) {</span>
<a href="#l8.722"></a><span id="l8.722" class="difflineplus">+      let req = this.request;</span>
<a href="#l8.723"></a><span id="l8.723" class="difflineplus">+      if (req.channel) {</span>
<a href="#l8.724"></a><span id="l8.724" class="difflineplus">+        this.log.info(&quot;canceling channel upload&quot;);</span>
<a href="#l8.725"></a><span id="l8.725" class="difflineplus">+        req.channel.cancel(Cr.NS_BINDING_ABORTED);</span>
<a href="#l8.726"></a><span id="l8.726" class="difflineplus">+      }</span>
<a href="#l8.727"></a><span id="l8.727" class="difflineplus">+      this.request = null;</span>
<a href="#l8.728"></a><span id="l8.728" class="difflineplus">+    }</span>
<a href="#l8.729"></a><span id="l8.729" class="difflineplus">+  },</span>
<a href="#l8.730"></a><span id="l8.730" class="difflineplus">+</span>
<a href="#l8.731"></a><span id="l8.731" class="difflineplus">+  /**</span>
<a href="#l8.732"></a><span id="l8.732" class="difflineplus">+   * Private function that attempts to retrieve the sharing URL for the file</span>
<a href="#l8.733"></a><span id="l8.733" class="difflineplus">+   * uploaded with this Uploader.</span>
<a href="#l8.734"></a><span id="l8.734" class="difflineplus">+   *</span>
<a href="#l8.735"></a><span id="l8.735" class="difflineplus">+   * @param aNodeInfo the node info for the file on the server.</span>
<a href="#l8.736"></a><span id="l8.736" class="difflineplus">+   */</span>
<a href="#l8.737"></a><span id="l8.737" class="difflineplus">+  _getShareUrl: function nsU1FU__getShareUrl(aNodeInfo) {</span>
<a href="#l8.738"></a><span id="l8.738" class="difflineplus">+    this.log.info(&quot;Making file &quot; + aNodeInfo.resource_path + &quot; public&quot;);</span>
<a href="#l8.739"></a><span id="l8.739" class="difflineplus">+    let url = gServerUrl + encodePathForURI(aNodeInfo.resource_path);</span>
<a href="#l8.740"></a><span id="l8.740" class="difflineplus">+    let headers = [[&quot;Content-Type&quot;, &quot;application/json&quot;]];</span>
<a href="#l8.741"></a><span id="l8.741" class="difflineplus">+    let body = JSON.stringify({is_public: true});</span>
<a href="#l8.742"></a><span id="l8.742" class="difflineplus">+    this.request = this.ubuntuone._connection.signAndSend(</span>
<a href="#l8.743"></a><span id="l8.743" class="difflineplus">+      url, headers, &quot;PUT&quot;, body,</span>
<a href="#l8.744"></a><span id="l8.744" class="difflineplus">+      function(aResponseText, aRequest) {</span>
<a href="#l8.745"></a><span id="l8.745" class="difflineplus">+        this.request = null;</span>
<a href="#l8.746"></a><span id="l8.746" class="difflineplus">+        this.log.info(&quot;Successfully made node public with response text: &quot;</span>
<a href="#l8.747"></a><span id="l8.747" class="difflineplus">+                      + aResponseText);</span>
<a href="#l8.748"></a><span id="l8.748" class="difflineplus">+        let nodeInfo = JSON.parse(aResponseText);</span>
<a href="#l8.749"></a><span id="l8.749" class="difflineplus">+        this.ubuntuone._uploadInfo[this.file.path] = nodeInfo;</span>
<a href="#l8.750"></a><span id="l8.750" class="difflineplus">+        this.ubuntuone._urlsForFiles[this.file.path] = nodeInfo.public_url;</span>
<a href="#l8.751"></a><span id="l8.751" class="difflineplus">+        this.callback(this.requestObserver, Cr.NS_OK);</span>
<a href="#l8.752"></a><span id="l8.752" class="difflineplus">+      }.bind(this),</span>
<a href="#l8.753"></a><span id="l8.753" class="difflineplus">+      function(aException, aResponseText, aRequest) {</span>
<a href="#l8.754"></a><span id="l8.754" class="difflineplus">+        this.request = null;</span>
<a href="#l8.755"></a><span id="l8.755" class="difflineplus">+        this.log.error(&quot;Getting share URL failed: &quot; + aException);</span>
<a href="#l8.756"></a><span id="l8.756" class="difflineplus">+        if (this.callback)</span>
<a href="#l8.757"></a><span id="l8.757" class="difflineplus">+          this.callback(this.requestObserver, Cr.NS_ERROR_FAILURE);</span>
<a href="#l8.758"></a><span id="l8.758" class="difflineplus">+      }.bind(this), this);</span>
<a href="#l8.759"></a><span id="l8.759" class="difflineplus">+  },</span>
<a href="#l8.760"></a><span id="l8.760" class="difflineplus">+};</span>
<a href="#l8.761"></a><span id="l8.761" class="difflineplus">+</span>
<a href="#l8.762"></a><span id="l8.762" class="difflineplus">+const NSGetFactory = XPCOMUtils.generateNSGetFactory([nsUbuntuOne]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mail/installer/package-manifest.in</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mail/installer/package-manifest.in</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -166,16 +166,17 @@</span>
<a href="#l9.4"></a><span id="l9.4"> @BINPATH@/components/mailprofilemigration.xpt</span>
<a href="#l9.5"></a><span id="l9.5"> @BINPATH@/components/messageWakeupService.js</span>
<a href="#l9.6"></a><span id="l9.6"> @BINPATH@/components/messageWakeupService.manifest</span>
<a href="#l9.7"></a><span id="l9.7"> @BINPATH@/components/nsActivity.js</span>
<a href="#l9.8"></a><span id="l9.8"> @BINPATH@/components/nsActivityManager.js</span>
<a href="#l9.9"></a><span id="l9.9"> @BINPATH@/components/nsActivityManagerUI.js</span>
<a href="#l9.10"></a><span id="l9.10"> @BINPATH@/components/nsYouSendIt.js</span>
<a href="#l9.11"></a><span id="l9.11"> @BINPATH@/components/nsDropbox.js</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+@BINPATH@/components/nsUbuntuOne.js</span>
<a href="#l9.13"></a><span id="l9.13"> @BINPATH@/components/cloudFileAccounts.js</span>
<a href="#l9.14"></a><span id="l9.14"> @BINPATH@/components/nsAddrbook.manifest</span>
<a href="#l9.15"></a><span id="l9.15"> @BINPATH@/components/nsMailNewsCommandLineHandler.js</span>
<a href="#l9.16"></a><span id="l9.16"> @BINPATH@/components/services-crypto-component.xpt</span>
<a href="#l9.17"></a><span id="l9.17"> #ifndef XP_OS2</span>
<a href="#l9.18"></a><span id="l9.18"> @BINPATH@/components/shellservice.xpt</span>
<a href="#l9.19"></a><span id="l9.19"> #endif</span>
<a href="#l9.20"></a><span id="l9.20"> @BINPATH@/components/xpcom_base.xpt</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1">new file mode 100644</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineminus">--- /dev/null</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/cloudfile/UbuntuOne/management.dtd</span>
<a href="#l10.4"></a><span id="l10.4" class="difflineat">@@ -0,0 +1,4 @@</span>
<a href="#l10.5"></a><span id="l10.5" class="difflineplus">+&lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l10.6"></a><span id="l10.6" class="difflineplus">+   - License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l10.7"></a><span id="l10.7" class="difflineplus">+   - You can obtain one at http://mozilla.org/MPL/2.0/.  --&gt;</span>
<a href="#l10.8"></a><span id="l10.8" class="difflineplus">+&lt;!ENTITY ubuntuOneMgmt.viewSettings &quot;View my account settings on one.ubuntu.com&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1">new file mode 100644</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineminus">--- /dev/null</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/cloudfile/UbuntuOne/settings.dtd</span>
<a href="#l11.4"></a><span id="l11.4" class="difflineat">@@ -0,0 +1,6 @@</span>
<a href="#l11.5"></a><span id="l11.5" class="difflineplus">+&lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l11.6"></a><span id="l11.6" class="difflineplus">+   - License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l11.7"></a><span id="l11.7" class="difflineplus">+   - You can obtain one at http://mozilla.org/MPL/2.0/.  --&gt;</span>
<a href="#l11.8"></a><span id="l11.8" class="difflineplus">+&lt;!ENTITY UbuntuOneSettings.emailAddress &quot;Email Address:&quot;&gt;</span>
<a href="#l11.9"></a><span id="l11.9" class="difflineplus">+&lt;!ENTITY UbuntuOneSettings.needAnAccount &quot;Need an account?&quot;&gt;</span>
<a href="#l11.10"></a><span id="l11.10" class="difflineplus">+&lt;!ENTITY UbuntuOneSettings.learnMore &quot;Learn more…&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mail/locales/jar.mn</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mail/locales/jar.mn</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -120,16 +120,18 @@</span>
<a href="#l12.4"></a><span id="l12.4">   locale/@AB_CD@/messenger/addressbook/ldapAutoCompErrs.properties      (%chrome/messenger/addressbook/ldapAutoCompErrs.properties)</span>
<a href="#l12.5"></a><span id="l12.5">   locale/@AB_CD@/messenger/addressbook/pref-directory.dtd               (%chrome/messenger/addressbook/pref-directory.dtd)</span>
<a href="#l12.6"></a><span id="l12.6">   locale/@AB_CD@/messenger/addressbook/pref-directory-add.dtd           (%chrome/messenger/addressbook/pref-directory-add.dtd)</span>
<a href="#l12.7"></a><span id="l12.7">   locale/@AB_CD@/messenger/addressbook/replicationProgress.properties   (%chrome/messenger/addressbook/replicationProgress.properties)</span>
<a href="#l12.8"></a><span id="l12.8">   locale/@AB_CD@/messenger/cloudfile/addAccountDialog.dtd               (%chrome/messenger/cloudfile/addAccountDialog.dtd)</span>
<a href="#l12.9"></a><span id="l12.9">   locale/@AB_CD@/messenger/cloudfile/management.dtd                     (%chrome/messenger/cloudfile/management.dtd)</span>
<a href="#l12.10"></a><span id="l12.10">   locale/@AB_CD@/messenger/cloudfile/Dropbox/management.dtd             (%chrome/messenger/cloudfile/Dropbox/management.dtd)</span>
<a href="#l12.11"></a><span id="l12.11">   locale/@AB_CD@/messenger/cloudfile/Dropbox/settings.dtd               (%chrome/messenger/cloudfile/Dropbox/settings.dtd)</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+  locale/@AB_CD@/messenger/cloudfile/UbuntuOne/management.dtd           (%chrome/messenger/cloudfile/UbuntuOne/management.dtd)</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+  locale/@AB_CD@/messenger/cloudfile/UbuntuOne/settings.dtd             (%chrome/messenger/cloudfile/UbuntuOne/settings.dtd)</span>
<a href="#l12.14"></a><span id="l12.14">   locale/@AB_CD@/messenger/cloudfile/YouSendIt/management.dtd           (%chrome/messenger/cloudfile/YouSendIt/management.dtd)</span>
<a href="#l12.15"></a><span id="l12.15">   locale/@AB_CD@/messenger/cloudfile/YouSendIt/settings.dtd             (%chrome/messenger/cloudfile/YouSendIt/settings.dtd)</span>
<a href="#l12.16"></a><span id="l12.16">   locale/@AB_CD@/messenger/messengercompose/messengercompose.dtd        (%chrome/messenger/messengercompose/messengercompose.dtd)</span>
<a href="#l12.17"></a><span id="l12.17">   locale/@AB_CD@/messenger/messengercompose/addressingWidgetOverlay.dtd (%chrome/messenger/messengercompose/addressingWidgetOverlay.dtd)</span>
<a href="#l12.18"></a><span id="l12.18">   locale/@AB_CD@/messenger/messengercompose/askSendFormat.dtd           (%chrome/messenger/messengercompose/askSendFormat.dtd)</span>
<a href="#l12.19"></a><span id="l12.19">   locale/@AB_CD@/messenger/messengercompose/askSendFormat.properties    (%chrome/messenger/messengercompose/askSendFormat.properties)</span>
<a href="#l12.20"></a><span id="l12.20">   locale/@AB_CD@/messenger/messengercompose/sendProgress.dtd            (%chrome/messenger/messengercompose/sendProgress.dtd)</span>
<a href="#l12.21"></a><span id="l12.21">   locale/@AB_CD@/messenger/messengercompose/sendProgress.properties     (%chrome/messenger/messengercompose/sendProgress.properties)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1">new file mode 100644</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineminus">--- /dev/null</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineplus">+++ b/mail/test/mozmill/cloudfile/test-cloudfile-backend-ubuntuone.js</span>
<a href="#l13.4"></a><span id="l13.4" class="difflineat">@@ -0,0 +1,272 @@</span>
<a href="#l13.5"></a><span id="l13.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l13.6"></a><span id="l13.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l13.7"></a><span id="l13.7" class="difflineplus">+  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l13.8"></a><span id="l13.8" class="difflineplus">+</span>
<a href="#l13.9"></a><span id="l13.9" class="difflineplus">+/**</span>
<a href="#l13.10"></a><span id="l13.10" class="difflineplus">+ * Tests the Ubuntu One Bigfile backend.</span>
<a href="#l13.11"></a><span id="l13.11" class="difflineplus">+ */</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+let Cu = Components.utils;</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+let Cc = Components.classes;</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+let Ci = Components.interfaces;</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineplus">+</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineplus">+const MODULE_NAME = 'test-cloudfile-backend-ubuntuone';</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineplus">+</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineplus">+const RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineplus">+const MODULE_REQUIRES = ['folder-display-helpers',</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineplus">+                         'compose-helpers',</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineplus">+                         'cloudfile-ubuntuone-helpers',</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineplus">+                         'observer-helpers',</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineplus">+                         'prompt-helpers',];</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineplus">+</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineplus">+const kAttachmentsVolume = '/~/Thunderbird Attachments';</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineplus">+</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineplus">+Cu.import('resource://gre/modules/Services.jsm');</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineplus">+</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineplus">+var gServer, gObsManager;</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineplus">+</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineplus">+function setupModule(module) {</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineplus">+  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineplus">+  fdh.installInto(module);</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineplus">+</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineplus">+  let ch = collector.getModule('compose-helpers');</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineplus">+  ch.installInto(module);</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineplus">+</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineplus">+  let cfh = collector.getModule('cloudfile-helpers');</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineplus">+  cfh.installInto(module);</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineplus">+</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineplus">+  let cbh = collector.getModule('cloudfile-backend-helpers');</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineplus">+  cbh.installInto(module);</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineplus">+</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineplus">+  let cdh = collector.getModule('cloudfile-ubuntuone-helpers');</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineplus">+  cdh.installInto(module);</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineplus">+</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineplus">+  let oh = collector.getModule('observer-helpers');</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineplus">+  oh.installInto(module);</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineplus">+</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineplus">+  let ph = collector.getModule('prompt-helpers');</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineplus">+  ph.installInto(module);</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineplus">+</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineplus">+  gObsManager = new cbh.SimpleRequestObserverManager();</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineplus">+</span>
<a href="#l13.56"></a><span id="l13.56" class="difflineplus">+  // Enable logging for this test.</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineplus">+  Services.prefs.setCharPref(&quot;UbuntuOne.logging.dump&quot;, &quot;All&quot;);</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineplus">+  Services.prefs.setCharPref(&quot;TBOAuth.logging.dump&quot;, &quot;All&quot;);</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineplus">+};</span>
<a href="#l13.60"></a><span id="l13.60" class="difflineplus">+</span>
<a href="#l13.61"></a><span id="l13.61" class="difflineplus">+function teardownModule() {</span>
<a href="#l13.62"></a><span id="l13.62" class="difflineplus">+  Services.prefs.QueryInterface(Ci.nsIPrefBranch)</span>
<a href="#l13.63"></a><span id="l13.63" class="difflineplus">+          .deleteBranch(&quot;mail.cloud_files.accounts&quot;);</span>
<a href="#l13.64"></a><span id="l13.64" class="difflineplus">+  Services.prefs.clearUserPref(&quot;UbuntuOne.logging.dump&quot;);</span>
<a href="#l13.65"></a><span id="l13.65" class="difflineplus">+  Services.prefs.clearUserPref(&quot;TBOAuth.logging.dump&quot;);</span>
<a href="#l13.66"></a><span id="l13.66" class="difflineplus">+}</span>
<a href="#l13.67"></a><span id="l13.67" class="difflineplus">+</span>
<a href="#l13.68"></a><span id="l13.68" class="difflineplus">+function setupTest() {</span>
<a href="#l13.69"></a><span id="l13.69" class="difflineplus">+  gServer = new MockUbuntuOneServer();</span>
<a href="#l13.70"></a><span id="l13.70" class="difflineplus">+  gServer.init();</span>
<a href="#l13.71"></a><span id="l13.71" class="difflineplus">+  gServer.start();</span>
<a href="#l13.72"></a><span id="l13.72" class="difflineplus">+}</span>
<a href="#l13.73"></a><span id="l13.73" class="difflineplus">+</span>
<a href="#l13.74"></a><span id="l13.74" class="difflineplus">+function teardownTest() {</span>
<a href="#l13.75"></a><span id="l13.75" class="difflineplus">+  gObsManager.check();</span>
<a href="#l13.76"></a><span id="l13.76" class="difflineplus">+  gObsManager.reset();</span>
<a href="#l13.77"></a><span id="l13.77" class="difflineplus">+  gServer.stop(mc);</span>
<a href="#l13.78"></a><span id="l13.78" class="difflineplus">+}</span>
<a href="#l13.79"></a><span id="l13.79" class="difflineplus">+</span>
<a href="#l13.80"></a><span id="l13.80" class="difflineplus">+function test_simple_case() {</span>
<a href="#l13.81"></a><span id="l13.81" class="difflineplus">+  const kExpectedUrl = &quot;http://www.example.com/expectedUrl&quot;;</span>
<a href="#l13.82"></a><span id="l13.82" class="difflineplus">+  const kTopics = [kUploadFile, kGetFileURL];</span>
<a href="#l13.83"></a><span id="l13.83" class="difflineplus">+</span>
<a href="#l13.84"></a><span id="l13.84" class="difflineplus">+  gServer.setupUser();</span>
<a href="#l13.85"></a><span id="l13.85" class="difflineplus">+  gServer.planForCreateVolume(kAttachmentsVolume);</span>
<a href="#l13.86"></a><span id="l13.86" class="difflineplus">+  gServer.planForUploadFile(kAttachmentsVolume + &quot;/testFile1&quot;);</span>
<a href="#l13.87"></a><span id="l13.87" class="difflineplus">+  gServer.planForMetadataUpdate(kAttachmentsVolume + &quot;/testFile1&quot;,</span>
<a href="#l13.88"></a><span id="l13.88" class="difflineplus">+                                kExpectedUrl);</span>
<a href="#l13.89"></a><span id="l13.89" class="difflineplus">+</span>
<a href="#l13.90"></a><span id="l13.90" class="difflineplus">+  let obs = new ObservationRecorder();</span>
<a href="#l13.91"></a><span id="l13.91" class="difflineplus">+  for each (let [, topic] in Iterator(kTopics)) {</span>
<a href="#l13.92"></a><span id="l13.92" class="difflineplus">+    obs.planFor(topic);</span>
<a href="#l13.93"></a><span id="l13.93" class="difflineplus">+    Services.obs.addObserver(obs, topic, false);</span>
<a href="#l13.94"></a><span id="l13.94" class="difflineplus">+  }</span>
<a href="#l13.95"></a><span id="l13.95" class="difflineplus">+</span>
<a href="#l13.96"></a><span id="l13.96" class="difflineplus">+  let requestObserver = gObsManager.create(&quot;test_simple_case - Upload 1&quot;);</span>
<a href="#l13.97"></a><span id="l13.97" class="difflineplus">+  let file = getFile(&quot;./data/testFile1&quot;, __file__);</span>
<a href="#l13.98"></a><span id="l13.98" class="difflineplus">+  let provider = gServer.getPreparedBackend(&quot;someAccountKey&quot;);</span>
<a href="#l13.99"></a><span id="l13.99" class="difflineplus">+  provider.uploadFile(file, requestObserver);</span>
<a href="#l13.100"></a><span id="l13.100" class="difflineplus">+</span>
<a href="#l13.101"></a><span id="l13.101" class="difflineplus">+  mc.waitFor(function () requestObserver.success);</span>
<a href="#l13.102"></a><span id="l13.102" class="difflineplus">+</span>
<a href="#l13.103"></a><span id="l13.103" class="difflineplus">+  let urlForFile = provider.urlForFile(file);</span>
<a href="#l13.104"></a><span id="l13.104" class="difflineplus">+  assert_equals(kExpectedUrl, urlForFile);</span>
<a href="#l13.105"></a><span id="l13.105" class="difflineplus">+  assert_equals(1, obs.numSightings(kUploadFile));</span>
<a href="#l13.106"></a><span id="l13.106" class="difflineplus">+  assert_equals(1, obs.numSightings(kGetFileURL));</span>
<a href="#l13.107"></a><span id="l13.107" class="difflineplus">+</span>
<a href="#l13.108"></a><span id="l13.108" class="difflineplus">+  gServer.planForUploadFile(kAttachmentsVolume + &quot;/testFile1&quot;);</span>
<a href="#l13.109"></a><span id="l13.109" class="difflineplus">+  gServer.planForMetadataUpdate(kAttachmentsVolume + &quot;/testFile1&quot;,</span>
<a href="#l13.110"></a><span id="l13.110" class="difflineplus">+                                kExpectedUrl);</span>
<a href="#l13.111"></a><span id="l13.111" class="difflineplus">+  requestObserver = gObsManager.create(&quot;test_simple_case - Upload 2&quot;);</span>
<a href="#l13.112"></a><span id="l13.112" class="difflineplus">+  provider.uploadFile(file, requestObserver);</span>
<a href="#l13.113"></a><span id="l13.113" class="difflineplus">+  mc.waitFor(function () requestObserver.success);</span>
<a href="#l13.114"></a><span id="l13.114" class="difflineplus">+  urlForFile = provider.urlForFile(file);</span>
<a href="#l13.115"></a><span id="l13.115" class="difflineplus">+  assert_equals(kExpectedUrl, urlForFile);</span>
<a href="#l13.116"></a><span id="l13.116" class="difflineplus">+</span>
<a href="#l13.117"></a><span id="l13.117" class="difflineplus">+  assert_equals(2, obs.numSightings(kUploadFile));</span>
<a href="#l13.118"></a><span id="l13.118" class="difflineplus">+  assert_equals(2, obs.numSightings(kGetFileURL));</span>
<a href="#l13.119"></a><span id="l13.119" class="difflineplus">+</span>
<a href="#l13.120"></a><span id="l13.120" class="difflineplus">+  for each (let [, topic] in Iterator(kTopics)) {</span>
<a href="#l13.121"></a><span id="l13.121" class="difflineplus">+    Services.obs.removeObserver(obs, topic);</span>
<a href="#l13.122"></a><span id="l13.122" class="difflineplus">+  }</span>
<a href="#l13.123"></a><span id="l13.123" class="difflineplus">+}</span>
<a href="#l13.124"></a><span id="l13.124" class="difflineplus">+</span>
<a href="#l13.125"></a><span id="l13.125" class="difflineplus">+function test_chained_uploads() {</span>
<a href="#l13.126"></a><span id="l13.126" class="difflineplus">+  const kExpectedUrlRoot = &quot;http://www.example.com/&quot;;</span>
<a href="#l13.127"></a><span id="l13.127" class="difflineplus">+  const kTopics = [kUploadFile, kGetFileURL];</span>
<a href="#l13.128"></a><span id="l13.128" class="difflineplus">+  const kFilenames = [&quot;testFile1&quot;, &quot;testFile2&quot;, &quot;testFile3&quot;];</span>
<a href="#l13.129"></a><span id="l13.129" class="difflineplus">+</span>
<a href="#l13.130"></a><span id="l13.130" class="difflineplus">+  gServer.setupUser();</span>
<a href="#l13.131"></a><span id="l13.131" class="difflineplus">+</span>
<a href="#l13.132"></a><span id="l13.132" class="difflineplus">+  gServer.planForCreateVolume(kAttachmentsVolume);</span>
<a href="#l13.133"></a><span id="l13.133" class="difflineplus">+  for each (let [, filename] in Iterator(kFilenames)) {</span>
<a href="#l13.134"></a><span id="l13.134" class="difflineplus">+    let path = kAttachmentsVolume + &quot;/&quot; + filename;</span>
<a href="#l13.135"></a><span id="l13.135" class="difflineplus">+    let expectedUrl = kExpectedUrlRoot + filename;</span>
<a href="#l13.136"></a><span id="l13.136" class="difflineplus">+    gServer.planForUploadFile(path);</span>
<a href="#l13.137"></a><span id="l13.137" class="difflineplus">+    gServer.planForMetadataUpdate(path, expectedUrl);</span>
<a href="#l13.138"></a><span id="l13.138" class="difflineplus">+  }</span>
<a href="#l13.139"></a><span id="l13.139" class="difflineplus">+</span>
<a href="#l13.140"></a><span id="l13.140" class="difflineplus">+  let obs = new ObservationRecorder();</span>
<a href="#l13.141"></a><span id="l13.141" class="difflineplus">+  for each (let [, topic] in Iterator(kTopics)) {</span>
<a href="#l13.142"></a><span id="l13.142" class="difflineplus">+    obs.planFor(topic);</span>
<a href="#l13.143"></a><span id="l13.143" class="difflineplus">+    Services.obs.addObserver(obs, topic, false);</span>
<a href="#l13.144"></a><span id="l13.144" class="difflineplus">+  }</span>
<a href="#l13.145"></a><span id="l13.145" class="difflineplus">+</span>
<a href="#l13.146"></a><span id="l13.146" class="difflineplus">+  let provider = gServer.getPreparedBackend(&quot;someAccountKey&quot;);</span>
<a href="#l13.147"></a><span id="l13.147" class="difflineplus">+</span>
<a href="#l13.148"></a><span id="l13.148" class="difflineplus">+  let files = [];</span>
<a href="#l13.149"></a><span id="l13.149" class="difflineplus">+</span>
<a href="#l13.150"></a><span id="l13.150" class="difflineplus">+  let observers = kFilenames.map(function(aFilename) {</span>
<a href="#l13.151"></a><span id="l13.151" class="difflineplus">+    let requestObserver = gObsManager.create(&quot;test_chained_uploads for filename &quot; + aFilename);</span>
<a href="#l13.152"></a><span id="l13.152" class="difflineplus">+    let file = getFile(&quot;./data/&quot; + aFilename, __file__);</span>
<a href="#l13.153"></a><span id="l13.153" class="difflineplus">+    files.push(file);</span>
<a href="#l13.154"></a><span id="l13.154" class="difflineplus">+    provider.uploadFile(file, requestObserver);</span>
<a href="#l13.155"></a><span id="l13.155" class="difflineplus">+    return requestObserver;</span>
<a href="#l13.156"></a><span id="l13.156" class="difflineplus">+  });</span>
<a href="#l13.157"></a><span id="l13.157" class="difflineplus">+</span>
<a href="#l13.158"></a><span id="l13.158" class="difflineplus">+  mc.waitFor(function() {</span>
<a href="#l13.159"></a><span id="l13.159" class="difflineplus">+    return observers.every(function(aListener) aListener.success);</span>
<a href="#l13.160"></a><span id="l13.160" class="difflineplus">+  }, &quot;Timed out waiting for chained uploads to complete.&quot;);</span>
<a href="#l13.161"></a><span id="l13.161" class="difflineplus">+</span>
<a href="#l13.162"></a><span id="l13.162" class="difflineplus">+  assert_equals(kFilenames.length, obs.numSightings(kUploadFile));</span>
<a href="#l13.163"></a><span id="l13.163" class="difflineplus">+</span>
<a href="#l13.164"></a><span id="l13.164" class="difflineplus">+  for (let [index, filename] in Iterator(kFilenames)) {</span>
<a href="#l13.165"></a><span id="l13.165" class="difflineplus">+    let path = kAttachmentsVolume + &quot;/&quot; + filename;</span>
<a href="#l13.166"></a><span id="l13.166" class="difflineplus">+    assert_equals(obs.data[kUploadFile][index], path);</span>
<a href="#l13.167"></a><span id="l13.167" class="difflineplus">+    let file = getFile(&quot;./data/&quot; + filename, __file__);</span>
<a href="#l13.168"></a><span id="l13.168" class="difflineplus">+    let expectedUriForFile = kExpectedUrlRoot + filename;</span>
<a href="#l13.169"></a><span id="l13.169" class="difflineplus">+    let uriForFile = provider.urlForFile(files[index]);</span>
<a href="#l13.170"></a><span id="l13.170" class="difflineplus">+    assert_equals(expectedUriForFile, uriForFile);</span>
<a href="#l13.171"></a><span id="l13.171" class="difflineplus">+  }</span>
<a href="#l13.172"></a><span id="l13.172" class="difflineplus">+</span>
<a href="#l13.173"></a><span id="l13.173" class="difflineplus">+  assert_equals(kFilenames.length, obs.numSightings(kGetFileURL));</span>
<a href="#l13.174"></a><span id="l13.174" class="difflineplus">+</span>
<a href="#l13.175"></a><span id="l13.175" class="difflineplus">+  for each (let [, topic] in Iterator(kTopics)) {</span>
<a href="#l13.176"></a><span id="l13.176" class="difflineplus">+    Services.obs.removeObserver(obs, topic);</span>
<a href="#l13.177"></a><span id="l13.177" class="difflineplus">+  }</span>
<a href="#l13.178"></a><span id="l13.178" class="difflineplus">+}</span>
<a href="#l13.179"></a><span id="l13.179" class="difflineplus">+</span>
<a href="#l13.180"></a><span id="l13.180" class="difflineplus">+function test_deleting_uploads() {</span>
<a href="#l13.181"></a><span id="l13.181" class="difflineplus">+  const kFilename = &quot;testFile1&quot;;</span>
<a href="#l13.182"></a><span id="l13.182" class="difflineplus">+  let path = kAttachmentsVolume + &quot;/&quot; + kFilename;</span>
<a href="#l13.183"></a><span id="l13.183" class="difflineplus">+</span>
<a href="#l13.184"></a><span id="l13.184" class="difflineplus">+  gServer.setupUser();</span>
<a href="#l13.185"></a><span id="l13.185" class="difflineplus">+  let provider = gServer.getPreparedBackend(&quot;someAccountKey&quot;);</span>
<a href="#l13.186"></a><span id="l13.186" class="difflineplus">+  // Upload a file</span>
<a href="#l13.187"></a><span id="l13.187" class="difflineplus">+</span>
<a href="#l13.188"></a><span id="l13.188" class="difflineplus">+  gServer.planForCreateVolume(kAttachmentsVolume);</span>
<a href="#l13.189"></a><span id="l13.189" class="difflineplus">+  gServer.planForUploadFile(path);</span>
<a href="#l13.190"></a><span id="l13.190" class="difflineplus">+  gServer.planForMetadataUpdate(path, &quot;http://www.example.com/someFile&quot;);</span>
<a href="#l13.191"></a><span id="l13.191" class="difflineplus">+  let requestObserver = gObsManager.create(&quot;test_deleting_uploads - upload 1&quot;);</span>
<a href="#l13.192"></a><span id="l13.192" class="difflineplus">+  let file = getFile(&quot;./data/&quot; + kFilename, __file__);</span>
<a href="#l13.193"></a><span id="l13.193" class="difflineplus">+  provider.uploadFile(file, requestObserver);</span>
<a href="#l13.194"></a><span id="l13.194" class="difflineplus">+  mc.waitFor(function() requestObserver.success);</span>
<a href="#l13.195"></a><span id="l13.195" class="difflineplus">+</span>
<a href="#l13.196"></a><span id="l13.196" class="difflineplus">+  // Try deleting a file</span>
<a href="#l13.197"></a><span id="l13.197" class="difflineplus">+  let obs = new ObservationRecorder();</span>
<a href="#l13.198"></a><span id="l13.198" class="difflineplus">+  obs.planFor(kDeleteFile);</span>
<a href="#l13.199"></a><span id="l13.199" class="difflineplus">+  Services.obs.addObserver(obs, kDeleteFile, false);</span>
<a href="#l13.200"></a><span id="l13.200" class="difflineplus">+</span>
<a href="#l13.201"></a><span id="l13.201" class="difflineplus">+  //gServer.planForDeleteFile(kFilename);</span>
<a href="#l13.202"></a><span id="l13.202" class="difflineplus">+  let deleteObserver = gObsManager.create(&quot;test_deleting_uploads - delete 1&quot;);</span>
<a href="#l13.203"></a><span id="l13.203" class="difflineplus">+  provider.deleteFile(file, deleteObserver);</span>
<a href="#l13.204"></a><span id="l13.204" class="difflineplus">+  mc.waitFor(function() deleteObserver.success);</span>
<a href="#l13.205"></a><span id="l13.205" class="difflineplus">+</span>
<a href="#l13.206"></a><span id="l13.206" class="difflineplus">+  // Check to make sure the file was deleted on the server</span>
<a href="#l13.207"></a><span id="l13.207" class="difflineplus">+  assert_equals(1, obs.numSightings(kDeleteFile));</span>
<a href="#l13.208"></a><span id="l13.208" class="difflineplus">+  assert_equals(obs.data[kDeleteFile][0], path);</span>
<a href="#l13.209"></a><span id="l13.209" class="difflineplus">+  Services.obs.removeObserver(obs, kDeleteFile);</span>
<a href="#l13.210"></a><span id="l13.210" class="difflineplus">+}</span>
<a href="#l13.211"></a><span id="l13.211" class="difflineplus">+</span>
<a href="#l13.212"></a><span id="l13.212" class="difflineplus">+/**</span>
<a href="#l13.213"></a><span id="l13.213" class="difflineplus">+ * Test that when we call createExistingAccount, onStopRequest is successfully</span>
<a href="#l13.214"></a><span id="l13.214" class="difflineplus">+ * called, and we pass the correct parameters.</span>
<a href="#l13.215"></a><span id="l13.215" class="difflineplus">+ */</span>
<a href="#l13.216"></a><span id="l13.216" class="difflineplus">+function test_create_existing_account() {</span>
<a href="#l13.217"></a><span id="l13.217" class="difflineplus">+  gMockAuthPromptReg.register();</span>
<a href="#l13.218"></a><span id="l13.218" class="difflineplus">+  try {</span>
<a href="#l13.219"></a><span id="l13.219" class="difflineplus">+    gMockAuthPrompt.password = &quot;account_password&quot;;</span>
<a href="#l13.220"></a><span id="l13.220" class="difflineplus">+    let accountKey = &quot;someNewAccount&quot;;</span>
<a href="#l13.221"></a><span id="l13.221" class="difflineplus">+    // Prepare the backend without preloading any token.</span>
<a href="#l13.222"></a><span id="l13.222" class="difflineplus">+    let provider = gServer.getPreparedBackend(accountKey, true);</span>
<a href="#l13.223"></a><span id="l13.223" class="difflineplus">+    let done = false;</span>
<a href="#l13.224"></a><span id="l13.224" class="difflineplus">+    let myObs = {</span>
<a href="#l13.225"></a><span id="l13.225" class="difflineplus">+      onStartRequest: function(aRequest, aContext) {</span>
<a href="#l13.226"></a><span id="l13.226" class="difflineplus">+      },</span>
<a href="#l13.227"></a><span id="l13.227" class="difflineplus">+      onStopRequest: function(aRequest, aContext, aStatusCode) {</span>
<a href="#l13.228"></a><span id="l13.228" class="difflineplus">+        assert_true(aContext instanceof Ci.nsIMsgCloudFileProvider);</span>
<a href="#l13.229"></a><span id="l13.229" class="difflineplus">+        assert_equals(aStatusCode, Components.results.NS_OK);</span>
<a href="#l13.230"></a><span id="l13.230" class="difflineplus">+        done = true;</span>
<a href="#l13.231"></a><span id="l13.231" class="difflineplus">+      },</span>
<a href="#l13.232"></a><span id="l13.232" class="difflineplus">+    }</span>
<a href="#l13.233"></a><span id="l13.233" class="difflineplus">+</span>
<a href="#l13.234"></a><span id="l13.234" class="difflineplus">+    provider.createExistingAccount(myObs);</span>
<a href="#l13.235"></a><span id="l13.235" class="difflineplus">+    mc.waitFor(function() done);</span>
<a href="#l13.236"></a><span id="l13.236" class="difflineplus">+    let newToken = cloudFileAccounts.getSecretValue(</span>
<a href="#l13.237"></a><span id="l13.237" class="difflineplus">+      accountKey, cloudFileAccounts.kTokenRealm);</span>
<a href="#l13.238"></a><span id="l13.238" class="difflineplus">+    assert_not_equals(newToken, &quot;&quot;);</span>
<a href="#l13.239"></a><span id="l13.239" class="difflineplus">+  }</span>
<a href="#l13.240"></a><span id="l13.240" class="difflineplus">+  finally {</span>
<a href="#l13.241"></a><span id="l13.241" class="difflineplus">+    gMockAuthPromptReg.unregister();</span>
<a href="#l13.242"></a><span id="l13.242" class="difflineplus">+  }</span>
<a href="#l13.243"></a><span id="l13.243" class="difflineplus">+}</span>
<a href="#l13.244"></a><span id="l13.244" class="difflineplus">+</span>
<a href="#l13.245"></a><span id="l13.245" class="difflineplus">+/**</span>
<a href="#l13.246"></a><span id="l13.246" class="difflineplus">+ * Test that cancelling an upload causes onStopRequest to be</span>
<a href="#l13.247"></a><span id="l13.247" class="difflineplus">+ * called with nsIMsgCloudFileProvider.uploadCanceled.</span>
<a href="#l13.248"></a><span id="l13.248" class="difflineplus">+ */</span>
<a href="#l13.249"></a><span id="l13.249" class="difflineplus">+function test_can_cancel_upload() {</span>
<a href="#l13.250"></a><span id="l13.250" class="difflineplus">+  const kFilename = &quot;testFile1&quot;;</span>
<a href="#l13.251"></a><span id="l13.251" class="difflineplus">+  let path = kAttachmentsVolume + &quot;/&quot; + kFilename;</span>
<a href="#l13.252"></a><span id="l13.252" class="difflineplus">+  gServer.setupUser();</span>
<a href="#l13.253"></a><span id="l13.253" class="difflineplus">+  let provider = gServer.getPreparedBackend(&quot;someNewAccount&quot;);</span>
<a href="#l13.254"></a><span id="l13.254" class="difflineplus">+  let file = getFile(&quot;./data/&quot; + kFilename, __file__);</span>
<a href="#l13.255"></a><span id="l13.255" class="difflineplus">+  gServer.planForCreateVolume(kAttachmentsVolume);</span>
<a href="#l13.256"></a><span id="l13.256" class="difflineplus">+  gServer.planForUploadFile(path, 2000);</span>
<a href="#l13.257"></a><span id="l13.257" class="difflineplus">+  assert_can_cancel_uploads(mc, provider, [file]);</span>
<a href="#l13.258"></a><span id="l13.258" class="difflineplus">+}</span>
<a href="#l13.259"></a><span id="l13.259" class="difflineplus">+</span>
<a href="#l13.260"></a><span id="l13.260" class="difflineplus">+/**</span>
<a href="#l13.261"></a><span id="l13.261" class="difflineplus">+ * Test that cancelling several uploads causes onStopRequest to be</span>
<a href="#l13.262"></a><span id="l13.262" class="difflineplus">+ * called with nsIMsgCloudFileProvider.uploadCanceled.</span>
<a href="#l13.263"></a><span id="l13.263" class="difflineplus">+ */</span>
<a href="#l13.264"></a><span id="l13.264" class="difflineplus">+function test_can_cancel_uploads() {</span>
<a href="#l13.265"></a><span id="l13.265" class="difflineplus">+  const kFiles = [&quot;testFile1&quot;, &quot;testFile2&quot;, &quot;testFile3&quot;];</span>
<a href="#l13.266"></a><span id="l13.266" class="difflineplus">+  gServer.setupUser();</span>
<a href="#l13.267"></a><span id="l13.267" class="difflineplus">+  let provider = gServer.getPreparedBackend(&quot;someNewAccount&quot;);</span>
<a href="#l13.268"></a><span id="l13.268" class="difflineplus">+  let files = [];</span>
<a href="#l13.269"></a><span id="l13.269" class="difflineplus">+  gServer.planForCreateVolume(kAttachmentsVolume);</span>
<a href="#l13.270"></a><span id="l13.270" class="difflineplus">+  for each (let [, filename] in Iterator(kFiles)) {</span>
<a href="#l13.271"></a><span id="l13.271" class="difflineplus">+    let path = kAttachmentsVolume + &quot;/&quot; + filename;</span>
<a href="#l13.272"></a><span id="l13.272" class="difflineplus">+    gServer.planForUploadFile(path, 2000);</span>
<a href="#l13.273"></a><span id="l13.273" class="difflineplus">+    files.push(getFile(&quot;./data/&quot; + filename, __file__));</span>
<a href="#l13.274"></a><span id="l13.274" class="difflineplus">+  }</span>
<a href="#l13.275"></a><span id="l13.275" class="difflineplus">+  assert_can_cancel_uploads(mc, provider, files);</span>
<a href="#l13.276"></a><span id="l13.276" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1">new file mode 100644</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineminus">--- /dev/null</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-cloudfile-ubuntuone-helpers.js</span>
<a href="#l14.4"></a><span id="l14.4" class="difflineat">@@ -0,0 +1,345 @@</span>
<a href="#l14.5"></a><span id="l14.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l14.6"></a><span id="l14.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l14.7"></a><span id="l14.7" class="difflineplus">+ * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l14.8"></a><span id="l14.8" class="difflineplus">+</span>
<a href="#l14.9"></a><span id="l14.9" class="difflineplus">+let Cu = Components.utils;</span>
<a href="#l14.10"></a><span id="l14.10" class="difflineplus">+let Cc = Components.classes;</span>
<a href="#l14.11"></a><span id="l14.11" class="difflineplus">+let Ci = Components.interfaces;</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineplus">+</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+const MODULE_NAME = 'cloudfile-ubuntuone-helpers';</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineplus">+const RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineplus">+const MODULE_REQUIRES = [];</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineplus">+</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineplus">+let httpd = {};</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineplus">+Cu.import('resource://mozmill/stdlib/httpd.js', httpd);</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineplus">+Cu.import('resource://gre/modules/Services.jsm');</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineplus">+Cu.import('resource:///modules/cloudFileAccounts.js');</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineplus">+</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineplus">+const kDefaultServerPort = 4444;</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineplus">+const kServerRoot = &quot;http://localhost:&quot; + kDefaultServerPort;</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineplus">+const kServerPath = &quot;/server&quot;;</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineplus">+const kContentPath = &quot;/content&quot;;</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineplus">+const kSsoPath = &quot;/sso/authentications&quot;;</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineplus">+const kSsoPingPath = &quot;/sso-ping/&quot;;</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineplus">+const kServerURL = kServerRoot + kServerPath;</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineplus">+const kContentURL = kServerRoot + kContentPath;</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineplus">+const kSsoURL = kServerRoot + kSsoPath;</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineplus">+const kSsoPingURL = kServerRoot + kSsoPingPath;</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineplus">+const kVolumesPath = &quot;/volumes&quot;;</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineplus">+</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineplus">+const kDefaultConfig = {</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineplus">+  port: kDefaultServerPort</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineplus">+}</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineplus">+</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineplus">+const kAuthToken = {</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineplus">+  token: &quot;oauth_token&quot;,</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineplus">+  token_secret: &quot;oauth_token_secret&quot;,</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineplus">+  consumer_key: &quot;oauth_consumer_key&quot;,</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineplus">+  consumer_secret: &quot;oauth_consumer_secret&quot;,</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineplus">+  description: &quot;Ubuntu One @ hostname [thunderbird]&quot;</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineplus">+};</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineplus">+</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineplus">+const kDefaultUser = {</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineplus">+  visible_name: &quot;Example User&quot;,</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineplus">+  user_id: 42,</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineplus">+  root_node_path: &quot;/~/Ubuntu One&quot;,</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineplus">+  user_node_paths: [</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineplus">+    &quot;/~/.ubuntuone/Purchased from Ubuntu One&quot;</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineplus">+  ],</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineplus">+  resource_path: &quot;&quot;,</span>
<a href="#l14.55"></a><span id="l14.55" class="difflineplus">+  max_bytes: 91268055040,</span>
<a href="#l14.56"></a><span id="l14.56" class="difflineplus">+  used_bytes: 134506915</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineplus">+};</span>
<a href="#l14.58"></a><span id="l14.58" class="difflineplus">+</span>
<a href="#l14.59"></a><span id="l14.59" class="difflineplus">+const kDefaultVolume = {</span>
<a href="#l14.60"></a><span id="l14.60" class="difflineplus">+  resource_path: &quot;/volumes/~/Thunderbird Attachments&quot;,</span>
<a href="#l14.61"></a><span id="l14.61" class="difflineplus">+  type: &quot;udf&quot;,</span>
<a href="#l14.62"></a><span id="l14.62" class="difflineplus">+  when_created: &quot;2012-04-09T05:32:57Z&quot;,</span>
<a href="#l14.63"></a><span id="l14.63" class="difflineplus">+  generation: 14,</span>
<a href="#l14.64"></a><span id="l14.64" class="difflineplus">+  path: &quot;~/Thunderbird Attachments&quot;,</span>
<a href="#l14.65"></a><span id="l14.65" class="difflineplus">+  content_path: &quot;/content/~/Thunderbird Attachments&quot;,</span>
<a href="#l14.66"></a><span id="l14.66" class="difflineplus">+  node_path: &quot;/~/Thunderbird Attachments&quot;</span>
<a href="#l14.67"></a><span id="l14.67" class="difflineplus">+};</span>
<a href="#l14.68"></a><span id="l14.68" class="difflineplus">+</span>
<a href="#l14.69"></a><span id="l14.69" class="difflineplus">+const kDefaultFileInfo = {</span>
<a href="#l14.70"></a><span id="l14.70" class="difflineplus">+  kind: &quot;file&quot;,</span>
<a href="#l14.71"></a><span id="l14.71" class="difflineplus">+  resource_path: &quot;/~/Thunderbird Attachments/placeholder.txt&quot;,</span>
<a href="#l14.72"></a><span id="l14.72" class="difflineplus">+  content_path: &quot;/content/~/Thunderbird Attachments/placeholder.txt&quot;,</span>
<a href="#l14.73"></a><span id="l14.73" class="difflineplus">+  key: &quot;D0b30fjbSs-8oYWplbgi2A:jBK7FHshSCi8rpTRbUUkag&quot;,</span>
<a href="#l14.74"></a><span id="l14.74" class="difflineplus">+  hash: &quot;sha1:39e9d7d7689f94b61237a0c5d642331bbec4268c&quot;,</span>
<a href="#l14.75"></a><span id="l14.75" class="difflineplus">+  when_created: &quot;2012-04-09T10:51:30Z&quot;,</span>
<a href="#l14.76"></a><span id="l14.76" class="difflineplus">+  when_changed: &quot;2012-04-09T10:51:31Z&quot;,</span>
<a href="#l14.77"></a><span id="l14.77" class="difflineplus">+  size: 39452,</span>
<a href="#l14.78"></a><span id="l14.78" class="difflineplus">+  volume_path: &quot;/volumes/~/Thunderbird Attachments&quot;,</span>
<a href="#l14.79"></a><span id="l14.79" class="difflineplus">+  path: &quot;/placeholder.txt&quot;,</span>
<a href="#l14.80"></a><span id="l14.80" class="difflineplus">+  parent_path: &quot;/~/Thunderbird Attachments&quot;,</span>
<a href="#l14.81"></a><span id="l14.81" class="difflineplus">+  generation: 10,</span>
<a href="#l14.82"></a><span id="l14.82" class="difflineplus">+  generation_created: 8,</span>
<a href="#l14.83"></a><span id="l14.83" class="difflineplus">+  is_live: true,</span>
<a href="#l14.84"></a><span id="l14.84" class="difflineplus">+  is_public: false,</span>
<a href="#l14.85"></a><span id="l14.85" class="difflineplus">+};</span>
<a href="#l14.86"></a><span id="l14.86" class="difflineplus">+</span>
<a href="#l14.87"></a><span id="l14.87" class="difflineplus">+const kDefaultReturnHeader = {</span>
<a href="#l14.88"></a><span id="l14.88" class="difflineplus">+  statusCode: 200,</span>
<a href="#l14.89"></a><span id="l14.89" class="difflineplus">+  statusString: &quot;OK&quot;,</span>
<a href="#l14.90"></a><span id="l14.90" class="difflineplus">+  contentType: &quot;text/plain&quot;,</span>
<a href="#l14.91"></a><span id="l14.91" class="difflineplus">+}</span>
<a href="#l14.92"></a><span id="l14.92" class="difflineplus">+</span>
<a href="#l14.93"></a><span id="l14.93" class="difflineplus">+function installInto(module) {</span>
<a href="#l14.94"></a><span id="l14.94" class="difflineplus">+  module.MockUbuntuOneServer = MockUbuntuOneServer;</span>
<a href="#l14.95"></a><span id="l14.95" class="difflineplus">+}</span>
<a href="#l14.96"></a><span id="l14.96" class="difflineplus">+</span>
<a href="#l14.97"></a><span id="l14.97" class="difflineplus">+function MockUbuntuOneServer() {}</span>
<a href="#l14.98"></a><span id="l14.98" class="difflineplus">+</span>
<a href="#l14.99"></a><span id="l14.99" class="difflineplus">+MockUbuntuOneServer.prototype = {</span>
<a href="#l14.100"></a><span id="l14.100" class="difflineplus">+  _server: null,</span>
<a href="#l14.101"></a><span id="l14.101" class="difflineplus">+  _toDelete: [],</span>
<a href="#l14.102"></a><span id="l14.102" class="difflineplus">+  _timers: [],</span>
<a href="#l14.103"></a><span id="l14.103" class="difflineplus">+</span>
<a href="#l14.104"></a><span id="l14.104" class="difflineplus">+  getPreparedBackend: function MU1S_getPreparedBackend(aAccountKey, aDontAuth) {</span>
<a href="#l14.105"></a><span id="l14.105" class="difflineplus">+    let emailaddress = &quot;somebody@example.org&quot;;</span>
<a href="#l14.106"></a><span id="l14.106" class="difflineplus">+    Services.prefs.setCharPref(&quot;mail.cloud_files.accounts.&quot; + aAccountKey</span>
<a href="#l14.107"></a><span id="l14.107" class="difflineplus">+                               + &quot;.emailaddress&quot;, emailaddress);</span>
<a href="#l14.108"></a><span id="l14.108" class="difflineplus">+    if (!aDontAuth) {</span>
<a href="#l14.109"></a><span id="l14.109" class="difflineplus">+      cloudFileAccounts.setSecretValue(aAccountKey, cloudFileAccounts.kTokenRealm,</span>
<a href="#l14.110"></a><span id="l14.110" class="difflineplus">+                                       &quot;someAuthToken&quot;);</span>
<a href="#l14.111"></a><span id="l14.111" class="difflineplus">+      cloudFileAccounts.setSecretValue(aAccountKey, &quot;Ubuntu One Auth Secret&quot;,</span>
<a href="#l14.112"></a><span id="l14.112" class="difflineplus">+                                       &quot;someAuthSecret&quot;);</span>
<a href="#l14.113"></a><span id="l14.113" class="difflineplus">+      cloudFileAccounts.setSecretValue(aAccountKey, &quot;Ubuntu One Consumer Key&quot;,</span>
<a href="#l14.114"></a><span id="l14.114" class="difflineplus">+                                       &quot;someConsumerKey&quot;);</span>
<a href="#l14.115"></a><span id="l14.115" class="difflineplus">+      cloudFileAccounts.setSecretValue(aAccountKey, &quot;Ubuntu One Consumer Secret&quot;,</span>
<a href="#l14.116"></a><span id="l14.116" class="difflineplus">+                                       &quot;someConsumerSecret&quot;);</span>
<a href="#l14.117"></a><span id="l14.117" class="difflineplus">+    }</span>
<a href="#l14.118"></a><span id="l14.118" class="difflineplus">+</span>
<a href="#l14.119"></a><span id="l14.119" class="difflineplus">+    let ubuntuone = Cc[&quot;@mozilla.org/mail/ubuntuone;1&quot;]</span>
<a href="#l14.120"></a><span id="l14.120" class="difflineplus">+      .createInstance(Ci.nsIMsgCloudFileProvider);</span>
<a href="#l14.121"></a><span id="l14.121" class="difflineplus">+</span>
<a href="#l14.122"></a><span id="l14.122" class="difflineplus">+    let urls = [kServerURL, kContentURL, kSsoURL, kSsoPingURL];</span>
<a href="#l14.123"></a><span id="l14.123" class="difflineplus">+    ubuntuone.overrideUrls(urls.length, urls);</span>
<a href="#l14.124"></a><span id="l14.124" class="difflineplus">+    ubuntuone.init(aAccountKey);</span>
<a href="#l14.125"></a><span id="l14.125" class="difflineplus">+    return ubuntuone;</span>
<a href="#l14.126"></a><span id="l14.126" class="difflineplus">+  },</span>
<a href="#l14.127"></a><span id="l14.127" class="difflineplus">+</span>
<a href="#l14.128"></a><span id="l14.128" class="difflineplus">+  init: function MU1S_init(aConfig) {</span>
<a href="#l14.129"></a><span id="l14.129" class="difflineplus">+    this._config = this._overrideDefault(kDefaultConfig, aConfig);</span>
<a href="#l14.130"></a><span id="l14.130" class="difflineplus">+    this._server = httpd.getServer(this._config.port, '');</span>
<a href="#l14.131"></a><span id="l14.131" class="difflineplus">+    this._pathInfo = {}</span>
<a href="#l14.132"></a><span id="l14.132" class="difflineplus">+    this._wireSso();</span>
<a href="#l14.133"></a><span id="l14.133" class="difflineplus">+  },</span>
<a href="#l14.134"></a><span id="l14.134" class="difflineplus">+</span>
<a href="#l14.135"></a><span id="l14.135" class="difflineplus">+  start: function MU1S_start() {</span>
<a href="#l14.136"></a><span id="l14.136" class="difflineplus">+    this._server.start(this._config.port);</span>
<a href="#l14.137"></a><span id="l14.137" class="difflineplus">+  },</span>
<a href="#l14.138"></a><span id="l14.138" class="difflineplus">+</span>
<a href="#l14.139"></a><span id="l14.139" class="difflineplus">+  stop: function MU1S_stop(aController) {</span>
<a href="#l14.140"></a><span id="l14.140" class="difflineplus">+    let allDone = false;</span>
<a href="#l14.141"></a><span id="l14.141" class="difflineplus">+    this._server.stop(function() {</span>
<a href="#l14.142"></a><span id="l14.142" class="difflineplus">+      allDone = true;</span>
<a href="#l14.143"></a><span id="l14.143" class="difflineplus">+    });</span>
<a href="#l14.144"></a><span id="l14.144" class="difflineplus">+    aController.waitFor(function () allDone,</span>
<a href="#l14.145"></a><span id="l14.145" class="difflineplus">+                        &quot;Timed out waiting for Dropbox server to stop!&quot;,</span>
<a href="#l14.146"></a><span id="l14.146" class="difflineplus">+                        10000);</span>
<a href="#l14.147"></a><span id="l14.147" class="difflineplus">+  },</span>
<a href="#l14.148"></a><span id="l14.148" class="difflineplus">+</span>
<a href="#l14.149"></a><span id="l14.149" class="difflineplus">+  setupUser: function MU1S_wireUser(aData) {</span>
<a href="#l14.150"></a><span id="l14.150" class="difflineplus">+    this._userInfo = this._overrideDefault(kDefaultUser, aData);</span>
<a href="#l14.151"></a><span id="l14.151" class="difflineplus">+    this._server.registerPathHandler(kServerPath, this._getUserInfo.bind(this));</span>
<a href="#l14.152"></a><span id="l14.152" class="difflineplus">+  },</span>
<a href="#l14.153"></a><span id="l14.153" class="difflineplus">+</span>
<a href="#l14.154"></a><span id="l14.154" class="difflineplus">+  _getUserInfo: function MU1S__delete(aRequest, aResponse) {</span>
<a href="#l14.155"></a><span id="l14.155" class="difflineplus">+    Services.obs.notifyObservers(null, &quot;cloudfile:user&quot;, &quot;&quot;);</span>
<a href="#l14.156"></a><span id="l14.156" class="difflineplus">+    aResponse.setStatusLine(null, 200, &quot;OK&quot;);</span>
<a href="#l14.157"></a><span id="l14.157" class="difflineplus">+    aResponse.setHeader(&quot;Content-Type&quot;, &quot;application/json&quot;);</span>
<a href="#l14.158"></a><span id="l14.158" class="difflineplus">+    aResponse.write(JSON.stringify(this._userInfo));</span>
<a href="#l14.159"></a><span id="l14.159" class="difflineplus">+  },</span>
<a href="#l14.160"></a><span id="l14.160" class="difflineplus">+</span>
<a href="#l14.161"></a><span id="l14.161" class="difflineplus">+  planForCreateVolume: function MU1S_planForCreateVolume(aVolumeName) {</span>
<a href="#l14.162"></a><span id="l14.162" class="difflineplus">+    let volume_info = this._overrideDefault(kDefaultVolume, {</span>
<a href="#l14.163"></a><span id="l14.163" class="difflineplus">+      resource_path: kVolumesPath + aVolumeName,</span>
<a href="#l14.164"></a><span id="l14.164" class="difflineplus">+      path: aVolumeName.substring(1),</span>
<a href="#l14.165"></a><span id="l14.165" class="difflineplus">+      content_path: kContentPath + aVolumeName,</span>
<a href="#l14.166"></a><span id="l14.166" class="difflineplus">+      node_path: aVolumeName</span>
<a href="#l14.167"></a><span id="l14.167" class="difflineplus">+    });</span>
<a href="#l14.168"></a><span id="l14.168" class="difflineplus">+    let putFileFunc = function(aRequest, aResponse) {</span>
<a href="#l14.169"></a><span id="l14.169" class="difflineplus">+      if (aRequest.method != &quot;PUT&quot;) {</span>
<a href="#l14.170"></a><span id="l14.170" class="difflineplus">+        returnError(aResponse, &quot;Volume should be created with a PUT request&quot;);</span>
<a href="#l14.171"></a><span id="l14.171" class="difflineplus">+        return</span>
<a href="#l14.172"></a><span id="l14.172" class="difflineplus">+      }</span>
<a href="#l14.173"></a><span id="l14.173" class="difflineplus">+      Services.obs.notifyObservers(null, &quot;cloudfile:createvolume&quot;, aVolumeName);</span>
<a href="#l14.174"></a><span id="l14.174" class="difflineplus">+      if (this._userInfo.user_node_paths.indexOf(aVolumeName) &lt; 0) {</span>
<a href="#l14.175"></a><span id="l14.175" class="difflineplus">+        this._userInfo.user_node_paths.push(aVolumeName);</span>
<a href="#l14.176"></a><span id="l14.176" class="difflineplus">+      }</span>
<a href="#l14.177"></a><span id="l14.177" class="difflineplus">+</span>
<a href="#l14.178"></a><span id="l14.178" class="difflineplus">+      aResponse.setStatusLine(null, 200, &quot;OK&quot;);</span>
<a href="#l14.179"></a><span id="l14.179" class="difflineplus">+      aResponse.setHeader(&quot;Content-Type&quot;, &quot;application/json&quot;);</span>
<a href="#l14.180"></a><span id="l14.180" class="difflineplus">+      aResponse.write(JSON.stringify(volume_info));</span>
<a href="#l14.181"></a><span id="l14.181" class="difflineplus">+    }.bind(this);</span>
<a href="#l14.182"></a><span id="l14.182" class="difflineplus">+    this._server.registerPathHandler(</span>
<a href="#l14.183"></a><span id="l14.183" class="difflineplus">+      kServerPath + kVolumesPath + encodePathForURI(aVolumeName),</span>
<a href="#l14.184"></a><span id="l14.184" class="difflineplus">+      putFileFunc);</span>
<a href="#l14.185"></a><span id="l14.185" class="difflineplus">+  },</span>
<a href="#l14.186"></a><span id="l14.186" class="difflineplus">+</span>
<a href="#l14.187"></a><span id="l14.187" class="difflineplus">+  /**</span>
<a href="#l14.188"></a><span id="l14.188" class="difflineplus">+   * Plan to upload a file with a particular filename.</span>
<a href="#l14.189"></a><span id="l14.189" class="difflineplus">+   *</span>
<a href="#l14.190"></a><span id="l14.190" class="difflineplus">+   * @param aPath the path of the file that will be uploaded.</span>
<a href="#l14.191"></a><span id="l14.191" class="difflineplus">+   * @param aMSeconds an optional argument, for how long the upload should</span>
<a href="#l14.192"></a><span id="l14.192" class="difflineplus">+   *                  last in milliseconds.</span>
<a href="#l14.193"></a><span id="l14.193" class="difflineplus">+   */</span>
<a href="#l14.194"></a><span id="l14.194" class="difflineplus">+  planForUploadFile: function MU1S_planForUploadFile(aPath, aMSeconds) {</span>
<a href="#l14.195"></a><span id="l14.195" class="difflineplus">+    let lastSlash = aPath.lastIndexOf('/');</span>
<a href="#l14.196"></a><span id="l14.196" class="difflineplus">+    let parent = aPath.substring(0, lastSlash);</span>
<a href="#l14.197"></a><span id="l14.197" class="difflineplus">+    let filename = aPath.substring(lastSlash);</span>
<a href="#l14.198"></a><span id="l14.198" class="difflineplus">+    let info = this._overrideDefault(kDefaultFileInfo, {</span>
<a href="#l14.199"></a><span id="l14.199" class="difflineplus">+      resource_path: aPath,</span>
<a href="#l14.200"></a><span id="l14.200" class="difflineplus">+      content_path: kContentPath + aPath,</span>
<a href="#l14.201"></a><span id="l14.201" class="difflineplus">+      volume_path: kVolumesPath + parent,</span>
<a href="#l14.202"></a><span id="l14.202" class="difflineplus">+      path: filename,</span>
<a href="#l14.203"></a><span id="l14.203" class="difflineplus">+      parent_path: parent,</span>
<a href="#l14.204"></a><span id="l14.204" class="difflineplus">+    });</span>
<a href="#l14.205"></a><span id="l14.205" class="difflineplus">+    this._pathInfo[aPath] = info;</span>
<a href="#l14.206"></a><span id="l14.206" class="difflineplus">+</span>
<a href="#l14.207"></a><span id="l14.207" class="difflineplus">+    // Prepare the function that will receive the upload and respond</span>
<a href="#l14.208"></a><span id="l14.208" class="difflineplus">+    // appropriately.</span>
<a href="#l14.209"></a><span id="l14.209" class="difflineplus">+    let putFileFunc = function(aRequest, aResponse) {</span>
<a href="#l14.210"></a><span id="l14.210" class="difflineplus">+      if (aRequest.method != &quot;PUT&quot;) {</span>
<a href="#l14.211"></a><span id="l14.211" class="difflineplus">+        returnError(aResponse, &quot;Files should be created with a PUT request&quot;);</span>
<a href="#l14.212"></a><span id="l14.212" class="difflineplus">+        return;</span>
<a href="#l14.213"></a><span id="l14.213" class="difflineplus">+      }</span>
<a href="#l14.214"></a><span id="l14.214" class="difflineplus">+      Services.obs.notifyObservers(null, &quot;cloudfile:uploadFile&quot;, aPath);</span>
<a href="#l14.215"></a><span id="l14.215" class="difflineplus">+      info.size = aRequest.getHeader(&quot;Content-Length&quot;);</span>
<a href="#l14.216"></a><span id="l14.216" class="difflineplus">+      info.is_live = true;</span>
<a href="#l14.217"></a><span id="l14.217" class="difflineplus">+      aResponse.setStatusLine(null, 201, &quot;OK&quot;);</span>
<a href="#l14.218"></a><span id="l14.218" class="difflineplus">+      aResponse.setHeader(&quot;Content-Type&quot;, &quot;application/json&quot;);</span>
<a href="#l14.219"></a><span id="l14.219" class="difflineplus">+      aResponse.write(JSON.stringify(info));</span>
<a href="#l14.220"></a><span id="l14.220" class="difflineplus">+    }.bind(this);</span>
<a href="#l14.221"></a><span id="l14.221" class="difflineplus">+</span>
<a href="#l14.222"></a><span id="l14.222" class="difflineplus">+    // Also prepare a function that will, if necessary, wait aMSeconds before</span>
<a href="#l14.223"></a><span id="l14.223" class="difflineplus">+    // firing putFileFunc.</span>
<a href="#l14.224"></a><span id="l14.224" class="difflineplus">+    let waitWrapperFunc = function(aRequest, aResponse) {</span>
<a href="#l14.225"></a><span id="l14.225" class="difflineplus">+      Services.obs.notifyObservers(null, &quot;cloudfile:uploadStarted&quot;, aPath);</span>
<a href="#l14.226"></a><span id="l14.226" class="difflineplus">+</span>
<a href="#l14.227"></a><span id="l14.227" class="difflineplus">+      if (!aMSeconds) {</span>
<a href="#l14.228"></a><span id="l14.228" class="difflineplus">+        putFileFunc(aRequest, aResponse);</span>
<a href="#l14.229"></a><span id="l14.229" class="difflineplus">+        return;</span>
<a href="#l14.230"></a><span id="l14.230" class="difflineplus">+      }</span>
<a href="#l14.231"></a><span id="l14.231" class="difflineplus">+</span>
<a href="#l14.232"></a><span id="l14.232" class="difflineplus">+      // Ok, we're waiting a bit.  Tell the HTTP server that we're going to</span>
<a href="#l14.233"></a><span id="l14.233" class="difflineplus">+      // generate a response asynchronously, then set a timer to send the</span>
<a href="#l14.234"></a><span id="l14.234" class="difflineplus">+      // response after aMSeconds milliseconds.</span>
<a href="#l14.235"></a><span id="l14.235" class="difflineplus">+      aResponse.processAsync();</span>
<a href="#l14.236"></a><span id="l14.236" class="difflineplus">+      let timer = Cc[&quot;@mozilla.org/timer;1&quot;].createInstance(Ci.nsITimer);</span>
<a href="#l14.237"></a><span id="l14.237" class="difflineplus">+      let timerEvent = {</span>
<a href="#l14.238"></a><span id="l14.238" class="difflineplus">+        notify: function(aTimer) {</span>
<a href="#l14.239"></a><span id="l14.239" class="difflineplus">+          putFileFunc(aRequest, aResponse);</span>
<a href="#l14.240"></a><span id="l14.240" class="difflineplus">+          aResponse.finish();</span>
<a href="#l14.241"></a><span id="l14.241" class="difflineplus">+        },</span>
<a href="#l14.242"></a><span id="l14.242" class="difflineplus">+      };</span>
<a href="#l14.243"></a><span id="l14.243" class="difflineplus">+      timer.initWithCallback(timerEvent, aMSeconds,</span>
<a href="#l14.244"></a><span id="l14.244" class="difflineplus">+                             Ci.nsITimer.TYPE_ONE_SHOT);</span>
<a href="#l14.245"></a><span id="l14.245" class="difflineplus">+      // We can't let the timer get garbage collected, so we store it.</span>
<a href="#l14.246"></a><span id="l14.246" class="difflineplus">+      this._timers.push(timer);</span>
<a href="#l14.247"></a><span id="l14.247" class="difflineplus">+    }.bind(this);</span>
<a href="#l14.248"></a><span id="l14.248" class="difflineplus">+</span>
<a href="#l14.249"></a><span id="l14.249" class="difflineplus">+    this._server.registerPathHandler(kContentPath + encodePathForURI(aPath),</span>
<a href="#l14.250"></a><span id="l14.250" class="difflineplus">+                                     waitWrapperFunc);</span>
<a href="#l14.251"></a><span id="l14.251" class="difflineplus">+  },</span>
<a href="#l14.252"></a><span id="l14.252" class="difflineplus">+</span>
<a href="#l14.253"></a><span id="l14.253" class="difflineplus">+  planForMetadataUpdate: function MU1S_planForMetadataUpdate(aPath,</span>
<a href="#l14.254"></a><span id="l14.254" class="difflineplus">+                                                             aPublicURL) {</span>
<a href="#l14.255"></a><span id="l14.255" class="difflineplus">+    let fileMetadataFunc = function(aRequest, aResponse) {</span>
<a href="#l14.256"></a><span id="l14.256" class="difflineplus">+      let info = this._pathInfo[aPath];</span>
<a href="#l14.257"></a><span id="l14.257" class="difflineplus">+      if (aRequest.method == &quot;GET&quot;) {</span>
<a href="#l14.258"></a><span id="l14.258" class="difflineplus">+        Services.obs.notifyObservers(null, &quot;cloudfile:getMetadata&quot;, aPath);</span>
<a href="#l14.259"></a><span id="l14.259" class="difflineplus">+      }</span>
<a href="#l14.260"></a><span id="l14.260" class="difflineplus">+      else if (aRequest.method == &quot;PUT&quot;) {</span>
<a href="#l14.261"></a><span id="l14.261" class="difflineplus">+        Services.obs.notifyObservers(null, &quot;cloudfile:getFileURL&quot;, aPath);</span>
<a href="#l14.262"></a><span id="l14.262" class="difflineplus">+        let body = JSON.parse(readBody(aRequest));</span>
<a href="#l14.263"></a><span id="l14.263" class="difflineplus">+        info.is_public = body.is_public;</span>
<a href="#l14.264"></a><span id="l14.264" class="difflineplus">+        if (info.is_public) {</span>
<a href="#l14.265"></a><span id="l14.265" class="difflineplus">+          info.public_url = aPublicURL;</span>
<a href="#l14.266"></a><span id="l14.266" class="difflineplus">+        }</span>
<a href="#l14.267"></a><span id="l14.267" class="difflineplus">+      }</span>
<a href="#l14.268"></a><span id="l14.268" class="difflineplus">+      else if (aRequest.method == &quot;DELETE&quot;) {</span>
<a href="#l14.269"></a><span id="l14.269" class="difflineplus">+        Services.obs.notifyObservers(null, &quot;cloudfile:deleteFile&quot;, aPath);</span>
<a href="#l14.270"></a><span id="l14.270" class="difflineplus">+        info.is_live = false;</span>
<a href="#l14.271"></a><span id="l14.271" class="difflineplus">+        info = &quot;&quot;;</span>
<a href="#l14.272"></a><span id="l14.272" class="difflineplus">+      }</span>
<a href="#l14.273"></a><span id="l14.273" class="difflineplus">+      aResponse.setStatusLine(null, 200, &quot;OK&quot;);</span>
<a href="#l14.274"></a><span id="l14.274" class="difflineplus">+      aResponse.setHeader(&quot;Content-Type&quot;, &quot;application/json&quot;);</span>
<a href="#l14.275"></a><span id="l14.275" class="difflineplus">+      aResponse.write(JSON.stringify(info));</span>
<a href="#l14.276"></a><span id="l14.276" class="difflineplus">+    }.bind(this);</span>
<a href="#l14.277"></a><span id="l14.277" class="difflineplus">+    this._server.registerPathHandler(kServerPath + encodePathForURI(aPath),</span>
<a href="#l14.278"></a><span id="l14.278" class="difflineplus">+                                     fileMetadataFunc);</span>
<a href="#l14.279"></a><span id="l14.279" class="difflineplus">+  },</span>
<a href="#l14.280"></a><span id="l14.280" class="difflineplus">+</span>
<a href="#l14.281"></a><span id="l14.281" class="difflineplus">+  _noteAndReturnString: function MU1S__noteAndReturnString(aKey, aValue,</span>
<a href="#l14.282"></a><span id="l14.282" class="difflineplus">+                                                           aString,</span>
<a href="#l14.283"></a><span id="l14.283" class="difflineplus">+                                                           aOptions) {</span>
<a href="#l14.284"></a><span id="l14.284" class="difflineplus">+</span>
<a href="#l14.285"></a><span id="l14.285" class="difflineplus">+    aOptions = this._overrideDefault(kDefaultReturnHeader, aOptions);</span>
<a href="#l14.286"></a><span id="l14.286" class="difflineplus">+    let func = function(aMeta, aResponse) {</span>
<a href="#l14.287"></a><span id="l14.287" class="difflineplus">+      try {</span>
<a href="#l14.288"></a><span id="l14.288" class="difflineplus">+        aResponse.setStatusLine(null, aOptions.statusCode,</span>
<a href="#l14.289"></a><span id="l14.289" class="difflineplus">+                                aOptions.statusString);</span>
<a href="#l14.290"></a><span id="l14.290" class="difflineplus">+        aResponse.setHeader(&quot;Content-Type&quot;, aOptions.contentType);</span>
<a href="#l14.291"></a><span id="l14.291" class="difflineplus">+        aResponse.write(aString);</span>
<a href="#l14.292"></a><span id="l14.292" class="difflineplus">+        Services.obs.notifyObservers(aString, aKey, aValue);</span>
<a href="#l14.293"></a><span id="l14.293" class="difflineplus">+      }</span>
<a href="#l14.294"></a><span id="l14.294" class="difflineplus">+      catch(ex) {</span>
<a href="#l14.295"></a><span id="l14.295" class="difflineplus">+        dump(&quot;Failed to generate server response: &quot; + ex);</span>
<a href="#l14.296"></a><span id="l14.296" class="difflineplus">+      }</span>
<a href="#l14.297"></a><span id="l14.297" class="difflineplus">+    }</span>
<a href="#l14.298"></a><span id="l14.298" class="difflineplus">+    return func;</span>
<a href="#l14.299"></a><span id="l14.299" class="difflineplus">+  },</span>
<a href="#l14.300"></a><span id="l14.300" class="difflineplus">+</span>
<a href="#l14.301"></a><span id="l14.301" class="difflineplus">+  _overrideDefault: function MU1S__overrideDefault(aDefault, aData) {</span>
<a href="#l14.302"></a><span id="l14.302" class="difflineplus">+    let result = {}</span>
<a href="#l14.303"></a><span id="l14.303" class="difflineplus">+</span>
<a href="#l14.304"></a><span id="l14.304" class="difflineplus">+    if (aData === undefined)</span>
<a href="#l14.305"></a><span id="l14.305" class="difflineplus">+      aData = {};</span>
<a href="#l14.306"></a><span id="l14.306" class="difflineplus">+</span>
<a href="#l14.307"></a><span id="l14.307" class="difflineplus">+    for (let param in aDefault) {</span>
<a href="#l14.308"></a><span id="l14.308" class="difflineplus">+      if (param in aData)</span>
<a href="#l14.309"></a><span id="l14.309" class="difflineplus">+        result[param] = aData[param];</span>
<a href="#l14.310"></a><span id="l14.310" class="difflineplus">+      else</span>
<a href="#l14.311"></a><span id="l14.311" class="difflineplus">+        result[param] = aDefault[param];</span>
<a href="#l14.312"></a><span id="l14.312" class="difflineplus">+    }</span>
<a href="#l14.313"></a><span id="l14.313" class="difflineplus">+    return result;</span>
<a href="#l14.314"></a><span id="l14.314" class="difflineplus">+  },</span>
<a href="#l14.315"></a><span id="l14.315" class="difflineplus">+</span>
<a href="#l14.316"></a><span id="l14.316" class="difflineplus">+  _wireSso: function MU1S__wireSso() {</span>
<a href="#l14.317"></a><span id="l14.317" class="difflineplus">+    let authFunc = this._noteAndReturnString(&quot;cloudfile:auth&quot;, &quot;&quot;,</span>
<a href="#l14.318"></a><span id="l14.318" class="difflineplus">+                                             JSON.stringify(kAuthToken),</span>
<a href="#l14.319"></a><span id="l14.319" class="difflineplus">+                                             {contentType: 'application/json'});</span>
<a href="#l14.320"></a><span id="l14.320" class="difflineplus">+    this._server.registerPathHandler(kSsoPath, authFunc);</span>
<a href="#l14.321"></a><span id="l14.321" class="difflineplus">+</span>
<a href="#l14.322"></a><span id="l14.322" class="difflineplus">+    let pingFunc = this._noteAndReturnString(&quot;cloudfile:ping&quot;, &quot;&quot;,</span>
<a href="#l14.323"></a><span id="l14.323" class="difflineplus">+                                             &quot;ok 1/1&quot;);</span>
<a href="#l14.324"></a><span id="l14.324" class="difflineplus">+    this._server.registerPathHandler(kSsoPingPath, pingFunc)</span>
<a href="#l14.325"></a><span id="l14.325" class="difflineplus">+  },</span>
<a href="#l14.326"></a><span id="l14.326" class="difflineplus">+}</span>
<a href="#l14.327"></a><span id="l14.327" class="difflineplus">+</span>
<a href="#l14.328"></a><span id="l14.328" class="difflineplus">+function encodePathForURI(aStr) {</span>
<a href="#l14.329"></a><span id="l14.329" class="difflineplus">+  return encodeURIComponent(aStr).replace(/%2F/g, '/');</span>
<a href="#l14.330"></a><span id="l14.330" class="difflineplus">+}</span>
<a href="#l14.331"></a><span id="l14.331" class="difflineplus">+</span>
<a href="#l14.332"></a><span id="l14.332" class="difflineplus">+const ScriptableInputStream = Components.Constructor(</span>
<a href="#l14.333"></a><span id="l14.333" class="difflineplus">+  &quot;@mozilla.org/scriptableinputstream;1&quot;,</span>
<a href="#l14.334"></a><span id="l14.334" class="difflineplus">+  &quot;nsIScriptableInputStream&quot;,</span>
<a href="#l14.335"></a><span id="l14.335" class="difflineplus">+  &quot;init&quot;);</span>
<a href="#l14.336"></a><span id="l14.336" class="difflineplus">+</span>
<a href="#l14.337"></a><span id="l14.337" class="difflineplus">+function readBody(aRequest) {</span>
<a href="#l14.338"></a><span id="l14.338" class="difflineplus">+  //let body = Cc['@mozilla.org/scriptableinputstream;1']</span>
<a href="#l14.339"></a><span id="l14.339" class="difflineplus">+  //  .createInstance(Ci.nsIScriptableInputStream);</span>
<a href="#l14.340"></a><span id="l14.340" class="difflineplus">+  //body.setInputStream(aRequest.bodyInputStream);</span>
<a href="#l14.341"></a><span id="l14.341" class="difflineplus">+  let body = new ScriptableInputStream(aRequest.bodyInputStream)</span>
<a href="#l14.342"></a><span id="l14.342" class="difflineplus">+  return body.read(-1);</span>
<a href="#l14.343"></a><span id="l14.343" class="difflineplus">+}</span>
<a href="#l14.344"></a><span id="l14.344" class="difflineplus">+</span>
<a href="#l14.345"></a><span id="l14.345" class="difflineplus">+function returnError(aResponse, aMessage) {</span>
<a href="#l14.346"></a><span id="l14.346" class="difflineplus">+  aResponse.setStatusLine(null, 50, &quot;Server Error&quot;);</span>
<a href="#l14.347"></a><span id="l14.347" class="difflineplus">+  aResponse.setHeader(&quot;Content-Type&quot;, &quot;text/plain&quot;);</span>
<a href="#l14.348"></a><span id="l14.348" class="difflineplus">+  aResponse.write(aMessage);</span>
<a href="#l14.349"></a><span id="l14.349" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mail/themes/gnomestripe/jar.mn</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mail/themes/gnomestripe/jar.mn</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -247,9 +247,10 @@ classic.jar:</span>
<a href="#l15.4"></a><span id="l15.4">   skin/classic/messenger/newmailaccount/search.gif                      (mail/newmailaccount/search.gif)</span>
<a href="#l15.5"></a><span id="l15.5">   skin/classic/messenger/newmailaccount/spinner.gif                     (mail/newmailaccount/spinner.gif)</span>
<a href="#l15.6"></a><span id="l15.6">   skin/classic/messenger/newmailaccount/success-addons.png              (mail/newmailaccount/success-addons.png)</span>
<a href="#l15.7"></a><span id="l15.7">   skin/classic/messenger/newmailaccount/success-border.png              (mail/newmailaccount/success-border.png)</span>
<a href="#l15.8"></a><span id="l15.8">   skin/classic/messenger/newmailaccount/success-compose.png             (mail/newmailaccount/success-compose.png)</span>
<a href="#l15.9"></a><span id="l15.9">   skin/classic/messenger/newmailaccount/success-signature.png           (mail/newmailaccount/success-signature.png)</span>
<a href="#l15.10"></a><span id="l15.10">   skin/classic/messenger/newmailaccount/search.png                      (mail/newmailaccount/search.png)</span>
<a href="#l15.11"></a><span id="l15.11">   skin/classic/messenger/icons/dropbox.png                    (mail/icons/dropbox.png)</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineplus">+  skin/classic/messenger/icons/ubuntuone.png                    (mail/icons/ubuntuone.png)</span>
<a href="#l15.13"></a><span id="l15.13">   skin/classic/messenger/icons/yousendit.png                  (mail/icons/yousendit.png)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1">new file mode 100644</span>
<a href="#l16.2"></a><span id="l16.2">index e69de29bb2d1d6434b8b29ae775ad8c2e48c5391..bb61a6debea27e6d0f923a0ff8b34ca86e5a5421</span>
<a href="#l16.3"></a><span id="l16.3">GIT binary patch
literal 367
zc%17D@N?(olHy`uVBq!ia0vp^0w65F1|&lt;EHm6d=LTavfC%YQK7jQD;BD8gCb5m^kR
zJ;2!QWVRiUvDVYYF~s9|a!Nzf?s8ij6_r=775B8UvF%x~&amp;@r;|c%Qhwl=Q_^g=c^M
z`&gt;&amp;}}W1DoKnSF&lt;jn)rkl3{Hy9#_R`b_7yy2uyk-_6x%Lv&gt;)yO`d&lt;$eHN)N1HX1l|v
zv*Hf7c*o_m1csA+A&gt;{`enFW3wX6MjVXo$Vt!g+;@u|mYbYgfO#;vQD+6{(CD`5ag`
z7|p+-v2YP{f+FKWUS7pToSaWAImD)JSkdY#+jIT^14Ff-@3wTl;~&lt;BtmbgZgq$HN4
zS|t~y0x1R~14AQS0~1{X(-1&gt;LD^o)&amp;0}E{f3o8SI_x|_yplHa=PsvQH#I0eTP&amp;xw$
Nc)I$ztaD0e0svq2bu$0}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mail/themes/pinstripe/jar.mn</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mail/themes/pinstripe/jar.mn</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -292,9 +292,10 @@ classic.jar:</span>
<a href="#l17.4"></a><span id="l17.4">   skin/classic/messenger/newmailaccount/search.gif                      (mail/newmailaccount/search.gif)</span>
<a href="#l17.5"></a><span id="l17.5">   skin/classic/messenger/newmailaccount/spinner.gif                     (mail/newmailaccount/spinner.gif)</span>
<a href="#l17.6"></a><span id="l17.6">   skin/classic/messenger/newmailaccount/success-addons.png              (mail/newmailaccount/success-addons.png)</span>
<a href="#l17.7"></a><span id="l17.7">   skin/classic/messenger/newmailaccount/success-border.png              (mail/newmailaccount/success-border.png)</span>
<a href="#l17.8"></a><span id="l17.8">   skin/classic/messenger/newmailaccount/success-compose.png             (mail/newmailaccount/success-compose.png)</span>
<a href="#l17.9"></a><span id="l17.9">   skin/classic/messenger/newmailaccount/success-signature.png           (mail/newmailaccount/success-signature.png)</span>
<a href="#l17.10"></a><span id="l17.10">   skin/classic/messenger/newmailaccount/search.png                      (mail/newmailaccount/search.png)</span>
<a href="#l17.11"></a><span id="l17.11">   skin/classic/messenger/icons/dropbox.png                    (mail/icons/dropbox.png)</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineplus">+  skin/classic/messenger/icons/ubuntuone.png                    (mail/icons/ubuntuone.png)</span>
<a href="#l17.13"></a><span id="l17.13">   skin/classic/messenger/icons/yousendit.png                  (mail/icons/yousendit.png)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1">new file mode 100644</span>
<a href="#l18.2"></a><span id="l18.2">index e69de29bb2d1d6434b8b29ae775ad8c2e48c5391..bb61a6debea27e6d0f923a0ff8b34ca86e5a5421</span>
<a href="#l18.3"></a><span id="l18.3">GIT binary patch
literal 367
zc%17D@N?(olHy`uVBq!ia0vp^0w65F1|&lt;EHm6d=LTavfC%YQK7jQD;BD8gCb5m^kR
zJ;2!QWVRiUvDVYYF~s9|a!Nzf?s8ij6_r=775B8UvF%x~&amp;@r;|c%Qhwl=Q_^g=c^M
z`&gt;&amp;}}W1DoKnSF&lt;jn)rkl3{Hy9#_R`b_7yy2uyk-_6x%Lv&gt;)yO`d&lt;$eHN)N1HX1l|v
zv*Hf7c*o_m1csA+A&gt;{`enFW3wX6MjVXo$Vt!g+;@u|mYbYgfO#;vQD+6{(CD`5ag`
z7|p+-v2YP{f+FKWUS7pToSaWAImD)JSkdY#+jIT^14Ff-@3wTl;~&lt;BtmbgZgq$HN4
zS|t~y0x1R~14AQS0~1{X(-1&gt;LD^o)&amp;0}E{f3o8SI_x|_yplHa=PsvQH#I0eTP&amp;xw$
Nc)I$ztaD0e0svq2bu$0}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mail/themes/qute/jar.mn</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mail/themes/qute/jar.mn</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -259,16 +259,17 @@ classic.jar:</span>
<a href="#l19.4"></a><span id="l19.4">   skin/classic/messenger/newmailaccount/search.gif                      (mail/newmailaccount/search.gif)</span>
<a href="#l19.5"></a><span id="l19.5">   skin/classic/messenger/newmailaccount/spinner.gif                     (mail/newmailaccount/spinner.gif)</span>
<a href="#l19.6"></a><span id="l19.6">   skin/classic/messenger/newmailaccount/success-addons.png              (mail/newmailaccount/success-addons.png)</span>
<a href="#l19.7"></a><span id="l19.7">   skin/classic/messenger/newmailaccount/success-border.png              (mail/newmailaccount/success-border.png)</span>
<a href="#l19.8"></a><span id="l19.8">   skin/classic/messenger/newmailaccount/success-compose.png             (mail/newmailaccount/success-compose.png)</span>
<a href="#l19.9"></a><span id="l19.9">   skin/classic/messenger/newmailaccount/success-signature.png           (mail/newmailaccount/success-signature.png)</span>
<a href="#l19.10"></a><span id="l19.10">   skin/classic/messenger/newmailaccount/search.png                      (mail/newmailaccount/search.png)</span>
<a href="#l19.11"></a><span id="l19.11">  skin/classic/messenger/icons/dropbox.png                    (mail/icons/dropbox.png)</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineplus">+ skin/classic/messenger/icons/ubuntuone.png                    (mail/icons/ubuntuone.png)</span>
<a href="#l19.13"></a><span id="l19.13">  skin/classic/messenger/icons/yousendit.png                  (mail/icons/yousendit.png)</span>
<a href="#l19.14"></a><span id="l19.14"> #ifdef XP_WIN</span>
<a href="#l19.15"></a><span id="l19.15"> % skin communicator classic/1.0 %skin/classic/aero/communicator/ os=WINNT osversion&gt;=6</span>
<a href="#l19.16"></a><span id="l19.16">   skin/classic/aero/communicator/communicator.css                       (mail/communicator.css)</span>
<a href="#l19.17"></a><span id="l19.17">   skin/classic/aero/communicator/smileys.css                            (mail/smileys.css)</span>
<a href="#l19.18"></a><span id="l19.18">   skin/classic/aero/communicator/icons/smileys/smiley-smile.png         (mail/icons/smiley-smile-aero.png)</span>
<a href="#l19.19"></a><span id="l19.19">   skin/classic/aero/communicator/icons/smileys/smiley-frown.png         (mail/icons/smiley-frown-aero.png)</span>
<a href="#l19.20"></a><span id="l19.20">   skin/classic/aero/communicator/icons/smileys/smiley-wink.png          (mail/icons/smiley-wink-aero.png)</span>
<a href="#l19.21"></a><span id="l19.21" class="difflineat">@@ -511,10 +512,11 @@ classic.jar:</span>
<a href="#l19.22"></a><span id="l19.22">   skin/classic/aero/messenger/newmailaccount/search.gif                      (mail/newmailaccount/search.gif)</span>
<a href="#l19.23"></a><span id="l19.23">   skin/classic/aero/messenger/newmailaccount/spinner.gif                     (mail/newmailaccount/spinner.gif)</span>
<a href="#l19.24"></a><span id="l19.24">   skin/classic/aero/messenger/newmailaccount/success-addons.png              (mail/newmailaccount/success-addons.png)</span>
<a href="#l19.25"></a><span id="l19.25">   skin/classic/aero/messenger/newmailaccount/success-border.png              (mail/newmailaccount/success-border.png)</span>
<a href="#l19.26"></a><span id="l19.26">   skin/classic/aero/messenger/newmailaccount/success-compose.png             (mail/newmailaccount/success-compose.png)</span>
<a href="#l19.27"></a><span id="l19.27">   skin/classic/aero/messenger/newmailaccount/success-signature.png           (mail/newmailaccount/success-signature.png)</span>
<a href="#l19.28"></a><span id="l19.28">   skin/classic/aero/messenger/newmailaccount/search.png                      (mail/newmailaccount/search.png)</span>
<a href="#l19.29"></a><span id="l19.29">   skin/classic/aero/messenger/icons/dropbox.png                    (mail/icons/dropbox.png)</span>
<a href="#l19.30"></a><span id="l19.30" class="difflineplus">+  skin/classic/aero/messenger/icons/ubuntuone.png                    (mail/icons/ubuntuone.png)</span>
<a href="#l19.31"></a><span id="l19.31">   skin/classic/aero/messenger/icons/yousendit.png                  (mail/icons/yousendit.png)</span>
<a href="#l19.32"></a><span id="l19.32"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1">new file mode 100644</span>
<a href="#l20.2"></a><span id="l20.2">index e69de29bb2d1d6434b8b29ae775ad8c2e48c5391..bb61a6debea27e6d0f923a0ff8b34ca86e5a5421</span>
<a href="#l20.3"></a><span id="l20.3">GIT binary patch
literal 367
zc%17D@N?(olHy`uVBq!ia0vp^0w65F1|&lt;EHm6d=LTavfC%YQK7jQD;BD8gCb5m^kR
zJ;2!QWVRiUvDVYYF~s9|a!Nzf?s8ij6_r=775B8UvF%x~&amp;@r;|c%Qhwl=Q_^g=c^M
z`&gt;&amp;}}W1DoKnSF&lt;jn)rkl3{Hy9#_R`b_7yy2uyk-_6x%Lv&gt;)yO`d&lt;$eHN)N1HX1l|v
zv*Hf7c*o_m1csA+A&gt;{`enFW3wX6MjVXo$Vt!g+;@u|mYbYgfO#;vQD+6{(CD`5ag`
z7|p+-v2YP{f+FKWUS7pToSaWAImD)JSkdY#+jIT^14Ff-@3wTl;~&lt;BtmbgZgq$HN4
zS|t~y0x1R~14AQS0~1{X(-1&gt;LD^o)&amp;0}E{f3o8SI_x|_yplHa=PsvQH#I0eTP&amp;xw$
Nc)I$ztaD0e0svq2bu$0}</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

