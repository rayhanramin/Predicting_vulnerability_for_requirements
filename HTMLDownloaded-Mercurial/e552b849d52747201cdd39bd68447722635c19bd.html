<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 11073:e552b849d52747201cdd39bd68447722635c19bd</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ e552b849d52747201cdd39bd68447722635c19bd" />
<meta property="og:url" content="/comm-central/rev/e552b849d52747201cdd39bd68447722635c19bd" />
<meta property="og:description" content="Fix bug 785733 - Move some properties to use icalString in database / Support extra parameters on attachments. r=mmecca" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / e552b849d52747201cdd39bd68447722635c19bd 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/e552b849d52747201cdd39bd68447722635c19bd">shortlog</a> |
<a href="/comm-central/log/e552b849d52747201cdd39bd68447722635c19bd">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/e552b849d52747201cdd39bd68447722635c19bd">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/e552b849d52747201cdd39bd68447722635c19bd">files</a> |
changeset |
<a href="/comm-central/raw-rev/e552b849d52747201cdd39bd68447722635c19bd">raw</a>  | <a href="/comm-central/archive/e552b849d52747201cdd39bd68447722635c19bd.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
Fix <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=785733">bug 785733</a> - Move some properties to use icalString in database / Support extra parameters on attachments. r=mmecca
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#80;&#104;&#105;&#108;&#105;&#112;&#112;&#32;&#75;&#101;&#119;&#105;&#115;&#99;&#104;&#32;&#60;&#109;&#111;&#122;&#105;&#108;&#108;&#97;&#64;&#107;&#101;&#119;&#105;&#115;&#46;&#99;&#104;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 17 Sep 2012 20:10:24 +0200</td></tr>

<tr>
 <td>changeset 11073</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/e552b849d52747201cdd39bd68447722635c19bd">e552b849d52747201cdd39bd68447722635c19bd</a></td>
</tr>



<tr>
<td>parent 11072</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/4d4a3558f2935c0d54e90fbd3224fb1f084ec585">4d4a3558f2935c0d54e90fbd3224fb1f084ec585</a>
</td>
</tr>

<tr>
<td>child 11074</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/c05d43695bef401ffdf25ec0b16d29a811737013">c05d43695bef401ffdf25ec0b16d29a811737013</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=e552b849d52747201cdd39bd68447722635c19bd">8308</a></td></tr>
<tr><td>push user</td><td>mozilla@kewis.ch</td></tr>
<tr><td>push date</td><td class="date age">Mon, 17 Sep 2012 18:10:28 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@e552b849d527 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=e552b849d52747201cdd39bd68447722635c19bd">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=e552b849d52747201cdd39bd68447722635c19bd&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=e552b849d52747201cdd39bd68447722635c19bd&newProject=comm-central&newRevision=e552b849d52747201cdd39bd68447722635c19bd&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=e552b849d52747201cdd39bd68447722635c19bd&newProject=comm-central&newRevision=e552b849d52747201cdd39bd68447722635c19bd&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=e552b849d52747201cdd39bd68447722635c19bd&newProject=comm-central&newRevision=e552b849d52747201cdd39bd68447722635c19bd&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mmecca%29&revcount=50">mmecca</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=785733">785733</a></td></tr>




</table></div>

<div class="page_body description">Fix <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=785733">bug 785733</a> - Move some properties to use icalString in database / Support extra parameters on attachments. r=mmecca</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/public/calIAttachment.idl">calendar/base/public/calIAttachment.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/public/calIAttachment.idl">file</a> |
<a href="/comm-central/annotate/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/public/calIAttachment.idl">annotate</a> |
<a href="/comm-central/diff/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/public/calIAttachment.idl">diff</a> |
<a href="/comm-central/comparison/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/public/calIAttachment.idl">comparison</a> |
<a href="/comm-central/log/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/public/calIAttachment.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/public/calIAttendee.idl">calendar/base/public/calIAttendee.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/public/calIAttendee.idl">file</a> |
<a href="/comm-central/annotate/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/public/calIAttendee.idl">annotate</a> |
<a href="/comm-central/diff/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/public/calIAttendee.idl">diff</a> |
<a href="/comm-central/comparison/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/public/calIAttendee.idl">comparison</a> |
<a href="/comm-central/log/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/public/calIAttendee.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/public/calIICSService.idl">calendar/base/public/calIICSService.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/public/calIICSService.idl">file</a> |
<a href="/comm-central/annotate/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/public/calIICSService.idl">annotate</a> |
<a href="/comm-central/diff/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/public/calIICSService.idl">diff</a> |
<a href="/comm-central/comparison/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/public/calIICSService.idl">comparison</a> |
<a href="/comm-central/log/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/public/calIICSService.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/public/calIRecurrenceItem.idl">calendar/base/public/calIRecurrenceItem.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/public/calIRecurrenceItem.idl">file</a> |
<a href="/comm-central/annotate/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/public/calIRecurrenceItem.idl">annotate</a> |
<a href="/comm-central/diff/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/public/calIRecurrenceItem.idl">diff</a> |
<a href="/comm-central/comparison/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/public/calIRecurrenceItem.idl">comparison</a> |
<a href="/comm-central/log/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/public/calIRecurrenceItem.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/public/calIRelation.idl">calendar/base/public/calIRelation.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/public/calIRelation.idl">file</a> |
<a href="/comm-central/annotate/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/public/calIRelation.idl">annotate</a> |
<a href="/comm-central/diff/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/public/calIRelation.idl">diff</a> |
<a href="/comm-central/comparison/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/public/calIRelation.idl">comparison</a> |
<a href="/comm-central/log/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/public/calIRelation.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/src/calAlarm.js">calendar/base/src/calAlarm.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/src/calAlarm.js">file</a> |
<a href="/comm-central/annotate/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/src/calAlarm.js">annotate</a> |
<a href="/comm-central/diff/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/src/calAlarm.js">diff</a> |
<a href="/comm-central/comparison/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/src/calAlarm.js">comparison</a> |
<a href="/comm-central/log/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/src/calAlarm.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/src/calAttachment.js">calendar/base/src/calAttachment.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/src/calAttachment.js">file</a> |
<a href="/comm-central/annotate/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/src/calAttachment.js">annotate</a> |
<a href="/comm-central/diff/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/src/calAttachment.js">diff</a> |
<a href="/comm-central/comparison/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/src/calAttachment.js">comparison</a> |
<a href="/comm-central/log/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/src/calAttachment.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/src/calAttendee.js">calendar/base/src/calAttendee.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/src/calAttendee.js">file</a> |
<a href="/comm-central/annotate/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/src/calAttendee.js">annotate</a> |
<a href="/comm-central/diff/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/src/calAttendee.js">diff</a> |
<a href="/comm-central/comparison/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/src/calAttendee.js">comparison</a> |
<a href="/comm-central/log/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/src/calAttendee.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/src/calICSService.cpp">calendar/base/src/calICSService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/src/calICSService.cpp">file</a> |
<a href="/comm-central/annotate/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/src/calICSService.cpp">annotate</a> |
<a href="/comm-central/diff/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/src/calICSService.cpp">diff</a> |
<a href="/comm-central/comparison/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/src/calICSService.cpp">comparison</a> |
<a href="/comm-central/log/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/src/calICSService.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/src/calRecurrenceDate.cpp">calendar/base/src/calRecurrenceDate.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/src/calRecurrenceDate.cpp">file</a> |
<a href="/comm-central/annotate/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/src/calRecurrenceDate.cpp">annotate</a> |
<a href="/comm-central/diff/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/src/calRecurrenceDate.cpp">diff</a> |
<a href="/comm-central/comparison/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/src/calRecurrenceDate.cpp">comparison</a> |
<a href="/comm-central/log/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/src/calRecurrenceDate.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/src/calRecurrenceDate.h">calendar/base/src/calRecurrenceDate.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/src/calRecurrenceDate.h">file</a> |
<a href="/comm-central/annotate/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/src/calRecurrenceDate.h">annotate</a> |
<a href="/comm-central/diff/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/src/calRecurrenceDate.h">diff</a> |
<a href="/comm-central/comparison/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/src/calRecurrenceDate.h">comparison</a> |
<a href="/comm-central/log/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/src/calRecurrenceDate.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/src/calRecurrenceRule.cpp">calendar/base/src/calRecurrenceRule.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/src/calRecurrenceRule.cpp">file</a> |
<a href="/comm-central/annotate/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/src/calRecurrenceRule.cpp">annotate</a> |
<a href="/comm-central/diff/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/src/calRecurrenceRule.cpp">diff</a> |
<a href="/comm-central/comparison/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/src/calRecurrenceRule.cpp">comparison</a> |
<a href="/comm-central/log/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/src/calRecurrenceRule.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/src/calRelation.js">calendar/base/src/calRelation.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/src/calRelation.js">file</a> |
<a href="/comm-central/annotate/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/src/calRelation.js">annotate</a> |
<a href="/comm-central/diff/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/src/calRelation.js">diff</a> |
<a href="/comm-central/comparison/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/src/calRelation.js">comparison</a> |
<a href="/comm-central/log/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/src/calRelation.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/src/calUtils.js">calendar/base/src/calUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/src/calUtils.js">file</a> |
<a href="/comm-central/annotate/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/src/calUtils.js">annotate</a> |
<a href="/comm-central/diff/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/src/calUtils.js">diff</a> |
<a href="/comm-central/comparison/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/src/calUtils.js">comparison</a> |
<a href="/comm-central/log/e552b849d52747201cdd39bd68447722635c19bd/calendar/base/src/calUtils.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e552b849d52747201cdd39bd68447722635c19bd/calendar/providers/storage/calStorageCalendar.js">calendar/providers/storage/calStorageCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e552b849d52747201cdd39bd68447722635c19bd/calendar/providers/storage/calStorageCalendar.js">file</a> |
<a href="/comm-central/annotate/e552b849d52747201cdd39bd68447722635c19bd/calendar/providers/storage/calStorageCalendar.js">annotate</a> |
<a href="/comm-central/diff/e552b849d52747201cdd39bd68447722635c19bd/calendar/providers/storage/calStorageCalendar.js">diff</a> |
<a href="/comm-central/comparison/e552b849d52747201cdd39bd68447722635c19bd/calendar/providers/storage/calStorageCalendar.js">comparison</a> |
<a href="/comm-central/log/e552b849d52747201cdd39bd68447722635c19bd/calendar/providers/storage/calStorageCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e552b849d52747201cdd39bd68447722635c19bd/calendar/providers/storage/calStorageUpgrade.jsm">calendar/providers/storage/calStorageUpgrade.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e552b849d52747201cdd39bd68447722635c19bd/calendar/providers/storage/calStorageUpgrade.jsm">file</a> |
<a href="/comm-central/annotate/e552b849d52747201cdd39bd68447722635c19bd/calendar/providers/storage/calStorageUpgrade.jsm">annotate</a> |
<a href="/comm-central/diff/e552b849d52747201cdd39bd68447722635c19bd/calendar/providers/storage/calStorageUpgrade.jsm">diff</a> |
<a href="/comm-central/comparison/e552b849d52747201cdd39bd68447722635c19bd/calendar/providers/storage/calStorageUpgrade.jsm">comparison</a> |
<a href="/comm-central/log/e552b849d52747201cdd39bd68447722635c19bd/calendar/providers/storage/calStorageUpgrade.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e552b849d52747201cdd39bd68447722635c19bd/calendar/test/unit/head_consts.js">calendar/test/unit/head_consts.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e552b849d52747201cdd39bd68447722635c19bd/calendar/test/unit/head_consts.js">file</a> |
<a href="/comm-central/annotate/e552b849d52747201cdd39bd68447722635c19bd/calendar/test/unit/head_consts.js">annotate</a> |
<a href="/comm-central/diff/e552b849d52747201cdd39bd68447722635c19bd/calendar/test/unit/head_consts.js">diff</a> |
<a href="/comm-central/comparison/e552b849d52747201cdd39bd68447722635c19bd/calendar/test/unit/head_consts.js">comparison</a> |
<a href="/comm-central/log/e552b849d52747201cdd39bd68447722635c19bd/calendar/test/unit/head_consts.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e552b849d52747201cdd39bd68447722635c19bd/calendar/test/unit/test_ics_service.js">calendar/test/unit/test_ics_service.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e552b849d52747201cdd39bd68447722635c19bd/calendar/test/unit/test_ics_service.js">file</a> |
<a href="/comm-central/annotate/e552b849d52747201cdd39bd68447722635c19bd/calendar/test/unit/test_ics_service.js">annotate</a> |
<a href="/comm-central/diff/e552b849d52747201cdd39bd68447722635c19bd/calendar/test/unit/test_ics_service.js">diff</a> |
<a href="/comm-central/comparison/e552b849d52747201cdd39bd68447722635c19bd/calendar/test/unit/test_ics_service.js">comparison</a> |
<a href="/comm-central/log/e552b849d52747201cdd39bd68447722635c19bd/calendar/test/unit/test_ics_service.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e552b849d52747201cdd39bd68447722635c19bd/calendar/test/unit/test_storage.js">calendar/test/unit/test_storage.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e552b849d52747201cdd39bd68447722635c19bd/calendar/test/unit/test_storage.js">file</a> |
<a href="/comm-central/annotate/e552b849d52747201cdd39bd68447722635c19bd/calendar/test/unit/test_storage.js">annotate</a> |
<a href="/comm-central/diff/e552b849d52747201cdd39bd68447722635c19bd/calendar/test/unit/test_storage.js">diff</a> |
<a href="/comm-central/comparison/e552b849d52747201cdd39bd68447722635c19bd/calendar/test/unit/test_storage.js">comparison</a> |
<a href="/comm-central/log/e552b849d52747201cdd39bd68447722635c19bd/calendar/test/unit/test_storage.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e552b849d52747201cdd39bd68447722635c19bd/calendar/test/unit/xpcshell.ini">calendar/test/unit/xpcshell.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e552b849d52747201cdd39bd68447722635c19bd/calendar/test/unit/xpcshell.ini">file</a> |
<a href="/comm-central/annotate/e552b849d52747201cdd39bd68447722635c19bd/calendar/test/unit/xpcshell.ini">annotate</a> |
<a href="/comm-central/diff/e552b849d52747201cdd39bd68447722635c19bd/calendar/test/unit/xpcshell.ini">diff</a> |
<a href="/comm-central/comparison/e552b849d52747201cdd39bd68447722635c19bd/calendar/test/unit/xpcshell.ini">comparison</a> |
<a href="/comm-central/log/e552b849d52747201cdd39bd68447722635c19bd/calendar/test/unit/xpcshell.ini">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/base/public/calIAttachment.idl</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/base/public/calIAttachment.idl</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -3,17 +3,17 @@</span>
<a href="#l1.4"></a><span id="l1.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l1.5"></a><span id="l1.5"> </span>
<a href="#l1.6"></a><span id="l1.6"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8"> interface nsIURI;</span>
<a href="#l1.9"></a><span id="l1.9"> interface calIIcalProperty;</span>
<a href="#l1.10"></a><span id="l1.10"> interface calIItemBase;</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-[scriptable,uuid(327a73e3-ba20-4dfc-92b9-80446b7d0d1b)]</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+[scriptable,uuid(7a17d45d-1c0e-4877-baa3-0eb67e770498)]</span>
<a href="#l1.14"></a><span id="l1.14"> interface calIAttachment : nsISupports</span>
<a href="#l1.15"></a><span id="l1.15"> {</span>
<a href="#l1.16"></a><span id="l1.16">     /**</span>
<a href="#l1.17"></a><span id="l1.17">      * The hash id is used to identify this attachment and compare it to others.</span>
<a href="#l1.18"></a><span id="l1.18">      */</span>
<a href="#l1.19"></a><span id="l1.19">     readonly attribute AUTF8String hashId;</span>
<a href="#l1.20"></a><span id="l1.20"> </span>
<a href="#l1.21"></a><span id="l1.21">     /**</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineat">@@ -36,16 +36,17 @@ interface calIAttachment : nsISupports</span>
<a href="#l1.23"></a><span id="l1.23">      */</span>
<a href="#l1.24"></a><span id="l1.24">     attribute AUTF8String encoding;</span>
<a href="#l1.25"></a><span id="l1.25"> </span>
<a href="#l1.26"></a><span id="l1.26">     /**</span>
<a href="#l1.27"></a><span id="l1.27">      * The calIIcalProperty corresponding to this object.  Can be used for</span>
<a href="#l1.28"></a><span id="l1.28">      * serializing/unserializing from ics files.</span>
<a href="#l1.29"></a><span id="l1.29">      */</span>
<a href="#l1.30"></a><span id="l1.30">     attribute calIIcalProperty icalProperty;</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+    attribute AUTF8String icalString;</span>
<a href="#l1.32"></a><span id="l1.32"> </span>
<a href="#l1.33"></a><span id="l1.33">     /**</span>
<a href="#l1.34"></a><span id="l1.34">      * For accessing additional parameters, such as x-params.</span>
<a href="#l1.35"></a><span id="l1.35">      */</span>
<a href="#l1.36"></a><span id="l1.36">     AUTF8String getParameter(in AString name);</span>
<a href="#l1.37"></a><span id="l1.37">     void setParameter(in AString name, in AUTF8String value);</span>
<a href="#l1.38"></a><span id="l1.38">     void deleteParameter(in AString name);</span>
<a href="#l1.39"></a><span id="l1.39"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/calendar/base/public/calIAttendee.idl</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/calendar/base/public/calIAttendee.idl</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -3,17 +3,17 @@</span>
<a href="#l2.4"></a><span id="l2.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l2.5"></a><span id="l2.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l2.6"></a><span id="l2.6"> </span>
<a href="#l2.7"></a><span id="l2.7"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l2.8"></a><span id="l2.8"> </span>
<a href="#l2.9"></a><span id="l2.9"> interface calIIcalProperty;</span>
<a href="#l2.10"></a><span id="l2.10"> interface nsISimpleEnumerator;</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-[scriptable,uuid(5d1f2c7c-29bb-4090-94c2-cabe278fe567)]</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+[scriptable,uuid(73a074ad-8812-4055-af75-14b509b8c5fe)]</span>
<a href="#l2.14"></a><span id="l2.14"> interface calIAttendee : nsISupports</span>
<a href="#l2.15"></a><span id="l2.15"> {</span>
<a href="#l2.16"></a><span id="l2.16">   readonly attribute boolean isMutable;</span>
<a href="#l2.17"></a><span id="l2.17"> </span>
<a href="#l2.18"></a><span id="l2.18">   // makes this item immutable</span>
<a href="#l2.19"></a><span id="l2.19">   void makeImmutable();</span>
<a href="#l2.20"></a><span id="l2.20"> </span>
<a href="#l2.21"></a><span id="l2.21">   // clone always returns a mutable event</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineat">@@ -64,16 +64,17 @@ interface calIAttendee : nsISupports</span>
<a href="#l2.23"></a><span id="l2.23">   // </span>
<a href="#l2.24"></a><span id="l2.24">   // For purposes of ICS serialization, all property names in</span>
<a href="#l2.25"></a><span id="l2.25">   // the hashbag are in uppercase.</span>
<a href="#l2.26"></a><span id="l2.26">   AUTF8String getProperty(in AString name);</span>
<a href="#l2.27"></a><span id="l2.27">   void setProperty(in AString name, in AUTF8String value);</span>
<a href="#l2.28"></a><span id="l2.28">   void deleteProperty(in AString name);</span>
<a href="#l2.29"></a><span id="l2.29"> </span>
<a href="#l2.30"></a><span id="l2.30">   attribute calIIcalProperty icalProperty;</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+  attribute AUTF8String icalString;</span>
<a href="#l2.32"></a><span id="l2.32"> </span>
<a href="#l2.33"></a><span id="l2.33">   /**</span>
<a href="#l2.34"></a><span id="l2.34">    * The display name of the attendee. If the attendee has a common name, this</span>
<a href="#l2.35"></a><span id="l2.35">    * is used. Otherwise, the attendee id is displayed (often an email), with the</span>
<a href="#l2.36"></a><span id="l2.36">    * mailto: prefix dropped.</span>
<a href="#l2.37"></a><span id="l2.37">    */</span>
<a href="#l2.38"></a><span id="l2.38">   AUTF8String toString();</span>
<a href="#l2.39"></a><span id="l2.39"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/calendar/base/public/calIICSService.idl</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/calendar/base/public/calIICSService.idl</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -211,17 +211,17 @@ interface calIIcsComponentParsingListene</span>
<a href="#l3.4"></a><span id="l3.4">      * Called when the parsing has completed.</span>
<a href="#l3.5"></a><span id="l3.5">      *</span>
<a href="#l3.6"></a><span id="l3.6">      * @param rc            The result code of parsing</span>
<a href="#l3.7"></a><span id="l3.7">      * @param rootComp      The root ical component that was parsed</span>
<a href="#l3.8"></a><span id="l3.8">      */</span>
<a href="#l3.9"></a><span id="l3.9">     void onParsingComplete(in nsresult rc, in calIIcalComponent rootComp);</span>
<a href="#l3.10"></a><span id="l3.10"> };</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-[scriptable,uuid(ae4ca6c3-981b-4f66-a0ce-2f2c218ad9e3)]</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+[scriptable,uuid(ff407e5b-9780-4644-b594-b49f6612a9bf)]</span>
<a href="#l3.14"></a><span id="l3.14"> interface calIICSService : nsISupports</span>
<a href="#l3.15"></a><span id="l3.15"> {</span>
<a href="#l3.16"></a><span id="l3.16">     /**</span>
<a href="#l3.17"></a><span id="l3.17">      * Parses an ICS string and uses the passed tzProvider instance to</span>
<a href="#l3.18"></a><span id="l3.18">      * resolve timezones not contained withing the VCALENDAR.</span>
<a href="#l3.19"></a><span id="l3.19">      *</span>
<a href="#l3.20"></a><span id="l3.20">      * @param serialized     an ICS string</span>
<a href="#l3.21"></a><span id="l3.21">      * @param tzProvider     timezone provider used to resolve TZIDs</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineat">@@ -243,13 +243,14 @@ interface calIICSService : nsISupports</span>
<a href="#l3.23"></a><span id="l3.23">      * @param listener       The listener that notifies the root component</span>
<a href="#l3.24"></a><span id="l3.24">      */</span>
<a href="#l3.25"></a><span id="l3.25">     void parseICSAsync(in AUTF8String serialized,</span>
<a href="#l3.26"></a><span id="l3.26">                        in calITimezoneProvider tzProvider,</span>
<a href="#l3.27"></a><span id="l3.27">                        in calIIcsComponentParsingListener listener);</span>
<a href="#l3.28"></a><span id="l3.28"> </span>
<a href="#l3.29"></a><span id="l3.29">     calIIcalComponent createIcalComponent(in AUTF8String kind);</span>
<a href="#l3.30"></a><span id="l3.30">     calIIcalProperty createIcalProperty(in AUTF8String kind);</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+    calIIcalProperty createIcalPropertyFromString(in AUTF8String str);</span>
<a href="#l3.32"></a><span id="l3.32">     /* I wish I could write this function atop libical!</span>
<a href="#l3.33"></a><span id="l3.33">     boolean isLegalParameterValue(in AUTF8String paramKind,</span>
<a href="#l3.34"></a><span id="l3.34">                                   in AUTF8String paramValue);</span>
<a href="#l3.35"></a><span id="l3.35">     */</span>
<a href="#l3.36"></a><span id="l3.36"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/calendar/base/public/calIRecurrenceItem.idl</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/calendar/base/public/calIRecurrenceItem.idl</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -4,17 +4,17 @@</span>
<a href="#l4.4"></a><span id="l4.4"> </span>
<a href="#l4.5"></a><span id="l4.5"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l4.6"></a><span id="l4.6"> </span>
<a href="#l4.7"></a><span id="l4.7"> interface calIItemBase;</span>
<a href="#l4.8"></a><span id="l4.8"> interface calIDateTime;</span>
<a href="#l4.9"></a><span id="l4.9"> </span>
<a href="#l4.10"></a><span id="l4.10"> interface calIIcalProperty;</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-[scriptable, uuid(943be334-4995-477e-b325-f0c2319183e8)]</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+[scriptable, uuid(918a243b-d887-41b0-8b4b-9cd56a9dd55f)]</span>
<a href="#l4.14"></a><span id="l4.14"> interface calIRecurrenceItem : nsISupports</span>
<a href="#l4.15"></a><span id="l4.15"> {</span>
<a href="#l4.16"></a><span id="l4.16">   // returns true if this thing is able to be modified;</span>
<a href="#l4.17"></a><span id="l4.17">   // if the item is not mutable, attempts to modify</span>
<a href="#l4.18"></a><span id="l4.18">   // any data will throw CAL_ERROR_ITEM_IS_IMMUTABLE</span>
<a href="#l4.19"></a><span id="l4.19">   readonly attribute boolean isMutable;</span>
<a href="#l4.20"></a><span id="l4.20"> </span>
<a href="#l4.21"></a><span id="l4.21">   // makes this item immutable</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineat">@@ -47,9 +47,10 @@ interface calIRecurrenceItem : nsISuppor</span>
<a href="#l4.23"></a><span id="l4.23">   // optional rangeEnd</span>
<a href="#l4.24"></a><span id="l4.24">   void getOccurrences (in calIDateTime aStartTime,</span>
<a href="#l4.25"></a><span id="l4.25">                        in calIDateTime aRangeStart,</span>
<a href="#l4.26"></a><span id="l4.26">                        in calIDateTime aRangeEnd,</span>
<a href="#l4.27"></a><span id="l4.27">                        in unsigned long aMaxCount,</span>
<a href="#l4.28"></a><span id="l4.28">                        out unsigned long aCount, [array,size_is(aCount),retval] out calIDateTime aDates);</span>
<a href="#l4.29"></a><span id="l4.29"> </span>
<a href="#l4.30"></a><span id="l4.30">   attribute calIIcalProperty icalProperty;</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+  attribute AUTF8String icalString;</span>
<a href="#l4.32"></a><span id="l4.32"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/calendar/base/public/calIRelation.idl</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/calendar/base/public/calIRelation.idl</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -2,17 +2,17 @@</span>
<a href="#l5.4"></a><span id="l5.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l5.5"></a><span id="l5.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l5.6"></a><span id="l5.6"> </span>
<a href="#l5.7"></a><span id="l5.7"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l5.8"></a><span id="l5.8"> </span>
<a href="#l5.9"></a><span id="l5.9"> interface calIIcalProperty;</span>
<a href="#l5.10"></a><span id="l5.10"> interface calIItemBase;</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-[scriptable,uuid(44a4eda2-539e-11de-a9ee-cc1556d89593)]</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+[scriptable,uuid(77f0820a-2b49-4c8e-86bf-2b6bda46e391)]</span>
<a href="#l5.14"></a><span id="l5.14"> interface calIRelation : nsISupports</span>
<a href="#l5.15"></a><span id="l5.15"> {</span>
<a href="#l5.16"></a><span id="l5.16">     /**</span>
<a href="#l5.17"></a><span id="l5.17">      * The type of the relation between the items:</span>
<a href="#l5.18"></a><span id="l5.18">      * PARENT</span>
<a href="#l5.19"></a><span id="l5.19">      * CHILD</span>
<a href="#l5.20"></a><span id="l5.20">      * SIBLING</span>
<a href="#l5.21"></a><span id="l5.21">      */</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineat">@@ -23,18 +23,18 @@ interface calIRelation : nsISupports</span>
<a href="#l5.23"></a><span id="l5.23">      **/</span>
<a href="#l5.24"></a><span id="l5.24"> </span>
<a href="#l5.25"></a><span id="l5.25">     attribute AUTF8String relId;</span>
<a href="#l5.26"></a><span id="l5.26"> </span>
<a href="#l5.27"></a><span id="l5.27">     /**</span>
<a href="#l5.28"></a><span id="l5.28">      * The calIIcalProperty corresponding to this object.  Can be used for</span>
<a href="#l5.29"></a><span id="l5.29">      * serializing/unserializing from ics files.</span>
<a href="#l5.30"></a><span id="l5.30">      */</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineminus">-</span>
<a href="#l5.32"></a><span id="l5.32">     attribute calIIcalProperty icalProperty;</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineplus">+    attribute AUTF8String icalString;</span>
<a href="#l5.34"></a><span id="l5.34"> </span>
<a href="#l5.35"></a><span id="l5.35">     /**</span>
<a href="#l5.36"></a><span id="l5.36">      * For accessing additional parameters, such as x-params.</span>
<a href="#l5.37"></a><span id="l5.37">      */</span>
<a href="#l5.38"></a><span id="l5.38">     AUTF8String getParameter(in AString name);</span>
<a href="#l5.39"></a><span id="l5.39">     void setParameter(in AString name, in AUTF8String value);</span>
<a href="#l5.40"></a><span id="l5.40">     void deleteParameter(in AString name);</span>
<a href="#l5.41"></a><span id="l5.41"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/calendar/base/src/calAlarm.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/calendar/base/src/calAlarm.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -398,17 +398,17 @@ calAlarm.prototype = {</span>
<a href="#l6.4"></a><span id="l6.4">         actionProp.value = this.action;</span>
<a href="#l6.5"></a><span id="l6.5">         comp.addProperty(actionProp);</span>
<a href="#l6.6"></a><span id="l6.6"> </span>
<a href="#l6.7"></a><span id="l6.7">         // Set up trigger (REQUIRED)</span>
<a href="#l6.8"></a><span id="l6.8">         let triggerProp = icssvc.createIcalProperty(&quot;TRIGGER&quot;);</span>
<a href="#l6.9"></a><span id="l6.9">         if (this.related == ALARM_RELATED_ABSOLUTE &amp;&amp; this.mAbsoluteDate) {</span>
<a href="#l6.10"></a><span id="l6.10">             // Set the trigger to a specific datetime</span>
<a href="#l6.11"></a><span id="l6.11">             triggerProp.setParameter(&quot;VALUE&quot;, &quot;DATE-TIME&quot;);</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-            triggerProp.valueAsDatetime = this.mAbsoluteDate.getInTimezone(UTC());</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+            triggerProp.valueAsDatetime = this.mAbsoluteDate.getInTimezone(cal.UTC());</span>
<a href="#l6.14"></a><span id="l6.14">         } else if (this.related != ALARM_RELATED_ABSOLUTE &amp;&amp; this.mOffset) {</span>
<a href="#l6.15"></a><span id="l6.15">             triggerProp.valueAsIcalString = this.mOffset.icalString;</span>
<a href="#l6.16"></a><span id="l6.16">             if (this.related == ALARM_RELATED_END) {</span>
<a href="#l6.17"></a><span id="l6.17">                 // An alarm related to the end of the event.</span>
<a href="#l6.18"></a><span id="l6.18">                 triggerProp.setParameter(&quot;RELATED&quot;, &quot;END&quot;);</span>
<a href="#l6.19"></a><span id="l6.19">             }</span>
<a href="#l6.20"></a><span id="l6.20">         } else {</span>
<a href="#l6.21"></a><span id="l6.21">             // No offset or absolute date is not valid.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/calendar/base/src/calAttachment.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/calendar/base/src/calAttachment.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -114,18 +114,17 @@ calAttachment.prototype = {</span>
<a href="#l7.4"></a><span id="l7.4">     get encoding() {</span>
<a href="#l7.5"></a><span id="l7.5">         return this.getParameter(&quot;ENCODING&quot;);</span>
<a href="#l7.6"></a><span id="l7.6">     },</span>
<a href="#l7.7"></a><span id="l7.7">     set encoding(aValue) {</span>
<a href="#l7.8"></a><span id="l7.8">         return this.setParameter(&quot;ENCODING&quot;, aValue);</span>
<a href="#l7.9"></a><span id="l7.9">     },</span>
<a href="#l7.10"></a><span id="l7.10"> </span>
<a href="#l7.11"></a><span id="l7.11">     get icalProperty() {</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-        var icssvc = getIcsService();</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-        var icalatt = icssvc.createIcalProperty(&quot;ATTACH&quot;);</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+        let icalatt = cal.getIcsService().createIcalProperty(&quot;ATTACH&quot;);</span>
<a href="#l7.15"></a><span id="l7.15"> </span>
<a href="#l7.16"></a><span id="l7.16">         for each (let [key, value] in this.mProperties) {</span>
<a href="#l7.17"></a><span id="l7.17">             try {</span>
<a href="#l7.18"></a><span id="l7.18">                 icalatt.setParameter(key, value);</span>
<a href="#l7.19"></a><span id="l7.19">             } catch (e if e.result == Components.results.NS_ERROR_ILLEGAL_VALUE) {</span>
<a href="#l7.20"></a><span id="l7.20">                 // Illegal values should be ignored, but we could log them if</span>
<a href="#l7.21"></a><span id="l7.21">                 // the user has enabled logging.</span>
<a href="#l7.22"></a><span id="l7.22">                 cal.LOG(&quot;Warning: Invalid attachment parameter value &quot; + key + &quot;=&quot; + value);</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineat">@@ -144,22 +143,39 @@ calAttachment.prototype = {</span>
<a href="#l7.24"></a><span id="l7.24">         this.mProperties = new cal.calPropertyBag();</span>
<a href="#l7.25"></a><span id="l7.25">         this.setData(attProp.value);</span>
<a href="#l7.26"></a><span id="l7.26"> </span>
<a href="#l7.27"></a><span id="l7.27">         for each (let [name, value] in cal.ical.paramIterator(attProp)) {</span>
<a href="#l7.28"></a><span id="l7.28">             this.setParameter(name, value);</span>
<a href="#l7.29"></a><span id="l7.29">         }</span>
<a href="#l7.30"></a><span id="l7.30">     },</span>
<a href="#l7.31"></a><span id="l7.31"> </span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+    get icalString() {</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+        let comp = this.icalProperty;</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+        return (comp ? comp.icalString : &quot;&quot;);</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+    },</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+    set icalString(val) {</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+        let prop = cal.getIcsService().createIcalPropertyFromString(val);</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineplus">+        if (prop.propertyName != &quot;ATTACH&quot;) {</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineplus">+            throw Components.results.NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+        }</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineplus">+        this.icalProperty = prop;</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineplus">+        return val;</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineplus">+    },</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+</span>
<a href="#l7.45"></a><span id="l7.45">     getParameter: function (aName) {</span>
<a href="#l7.46"></a><span id="l7.46">         return this.mProperties.getProperty(aName);</span>
<a href="#l7.47"></a><span id="l7.47">     },</span>
<a href="#l7.48"></a><span id="l7.48"> </span>
<a href="#l7.49"></a><span id="l7.49">     setParameter: function (aName, aValue) {</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineminus">-        return this.mProperties.setProperty(aName, aValue);</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineplus">+        if (aValue || aValue === 0) {</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineplus">+            return this.mProperties.setProperty(aName, aValue);</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineplus">+        } else {</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineplus">+            return this.mProperties.deleteProperty(aName);</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineplus">+        }</span>
<a href="#l7.56"></a><span id="l7.56">     },</span>
<a href="#l7.57"></a><span id="l7.57"> </span>
<a href="#l7.58"></a><span id="l7.58">     deleteParameter: function (aName) {</span>
<a href="#l7.59"></a><span id="l7.59">         this.mProperties.deleteProperty(aName);</span>
<a href="#l7.60"></a><span id="l7.60">     },</span>
<a href="#l7.61"></a><span id="l7.61"> </span>
<a href="#l7.62"></a><span id="l7.62">     clone: function cA_clone() {</span>
<a href="#l7.63"></a><span id="l7.63">         let newAttachment = new calAttachment();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/calendar/base/src/calAttendee.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/calendar/base/src/calAttendee.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -78,16 +78,17 @@ calAttendee.prototype = {</span>
<a href="#l8.4"></a><span id="l8.4">     mIsOrganizer: false,</span>
<a href="#l8.5"></a><span id="l8.5">     get isOrganizer() { return this.mIsOrganizer; },</span>
<a href="#l8.6"></a><span id="l8.6">     set isOrganizer(bool) { this.mIsOrganizer = bool; },</span>
<a href="#l8.7"></a><span id="l8.7"> </span>
<a href="#l8.8"></a><span id="l8.8">     // icalatt is a calIcalProperty of type attendee</span>
<a href="#l8.9"></a><span id="l8.9">     set icalProperty (icalatt) {</span>
<a href="#l8.10"></a><span id="l8.10">         this.modify();</span>
<a href="#l8.11"></a><span id="l8.11">         this.id = icalatt.valueAsIcalString;</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+        this.mIsOrganizer = (icalatt.propertyName == &quot;ORGANIZER&quot;);</span>
<a href="#l8.13"></a><span id="l8.13"> </span>
<a href="#l8.14"></a><span id="l8.14">         let promotedProps = { };</span>
<a href="#l8.15"></a><span id="l8.15">         for each (let prop in this.icalAttendeePropMap) {</span>
<a href="#l8.16"></a><span id="l8.16">             this[prop.cal] = icalatt.getParameter(prop.ics);</span>
<a href="#l8.17"></a><span id="l8.17">             // Don't copy these to the property bag.</span>
<a href="#l8.18"></a><span id="l8.18">             promotedProps[prop.ics] = true;</span>
<a href="#l8.19"></a><span id="l8.19">         }</span>
<a href="#l8.20"></a><span id="l8.20"> </span>
<a href="#l8.21"></a><span id="l8.21" class="difflineat">@@ -134,16 +135,29 @@ calAttendee.prototype = {</span>
<a href="#l8.22"></a><span id="l8.22">                 // Illegal values should be ignored, but we could log them if</span>
<a href="#l8.23"></a><span id="l8.23">                 // the user has enabled logging.</span>
<a href="#l8.24"></a><span id="l8.24">                 cal.LOG(&quot;Warning: Invalid attendee parameter value &quot; + key + &quot;=&quot; + value);</span>
<a href="#l8.25"></a><span id="l8.25">             }</span>
<a href="#l8.26"></a><span id="l8.26">         }</span>
<a href="#l8.27"></a><span id="l8.27">         return icalatt;</span>
<a href="#l8.28"></a><span id="l8.28">     },</span>
<a href="#l8.29"></a><span id="l8.29"> </span>
<a href="#l8.30"></a><span id="l8.30" class="difflineplus">+    get icalString() {</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineplus">+        let comp = this.icalProperty;</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+        return (comp ? comp.icalString : &quot;&quot;);</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+    },</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+    set icalString(val) {</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineplus">+        let prop = cal.getIcsService().createIcalPropertyFromString(val);</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineplus">+        if (prop.propertyName != &quot;ORGANIZER&quot; &amp;&amp; prop.propertyName != &quot;ATTENDEE&quot;) {</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineplus">+            throw Components.results.NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineplus">+        }</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineplus">+        this.icalProperty = prop;</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineplus">+        return val;</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineplus">+    },</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineplus">+</span>
<a href="#l8.43"></a><span id="l8.43">     get propertyEnumerator() { return this.mProperties.enumerator; },</span>
<a href="#l8.44"></a><span id="l8.44"> </span>
<a href="#l8.45"></a><span id="l8.45">     // The has/get/set/deleteProperty methods are case-insensitive.</span>
<a href="#l8.46"></a><span id="l8.46">     getProperty: function (aName) {</span>
<a href="#l8.47"></a><span id="l8.47">         return this.mProperties.getProperty(aName.toUpperCase());</span>
<a href="#l8.48"></a><span id="l8.48">     },</span>
<a href="#l8.49"></a><span id="l8.49">     setProperty: function (aName, aValue) {</span>
<a href="#l8.50"></a><span id="l8.50">         this.modify();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/calendar/base/src/calICSService.cpp</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/calendar/base/src/calICSService.cpp</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -1322,8 +1322,21 @@ calICSService::CreateIcalProperty(const </span>
<a href="#l9.4"></a><span id="l9.4">     if (propkind == ICAL_X_PROPERTY)</span>
<a href="#l9.5"></a><span id="l9.5">         icalproperty_set_x_name(icalprop, PromiseFlatCString(kind).get());</span>
<a href="#l9.6"></a><span id="l9.6"> </span>
<a href="#l9.7"></a><span id="l9.7">     *prop = new calIcalProperty(icalprop, nullptr);</span>
<a href="#l9.8"></a><span id="l9.8">     CAL_ENSURE_MEMORY(*prop);</span>
<a href="#l9.9"></a><span id="l9.9">     NS_ADDREF(*prop);</span>
<a href="#l9.10"></a><span id="l9.10">     return NS_OK;</span>
<a href="#l9.11"></a><span id="l9.11"> }</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+calICSService::CreateIcalPropertyFromString(const nsACString &amp;str, calIIcalProperty **prop)</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+{</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+    NS_ENSURE_ARG_POINTER(prop);</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+    icalproperty *icalprop = icalproperty_new_from_string(PromiseFlatCString(str).get());</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineplus">+</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineplus">+    *prop = new calIcalProperty(icalprop, nullptr);</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineplus">+    CAL_ENSURE_MEMORY(*prop);</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineplus">+    NS_ADDREF(*prop);</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineplus">+    return NS_OK;</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/calendar/base/src/calRecurrenceDate.cpp</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/calendar/base/src/calRecurrenceDate.cpp</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -202,8 +202,45 @@ calRecurrenceDate::SetIcalProperty(calII</span>
<a href="#l10.4"></a><span id="l10.4">         }</span>
<a href="#l10.5"></a><span id="l10.5">     } else if (name.EqualsLiteral(&quot;EXDATE&quot;))</span>
<a href="#l10.6"></a><span id="l10.6">         mIsNegative = true;</span>
<a href="#l10.7"></a><span id="l10.7">     else</span>
<a href="#l10.8"></a><span id="l10.8">         return NS_ERROR_INVALID_ARG;</span>
<a href="#l10.9"></a><span id="l10.9"> </span>
<a href="#l10.10"></a><span id="l10.10">     return aProp-&gt;GetValueAsDatetime(getter_AddRefs(mDate));</span>
<a href="#l10.11"></a><span id="l10.11"> }</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+calRecurrenceDate::SetIcalString(const nsACString &amp;str)</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+{</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+    nsresult rv = NS_OK;</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+    nsCAutoString name;</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineplus">+    nsCOMPtr&lt;calIICSService&gt; icsSvc = cal::getICSService();</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineplus">+    nsCOMPtr&lt;calIIcalProperty&gt; prop;</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineplus">+</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineplus">+    rv = icsSvc-&gt;CreateIcalPropertyFromString(str, getter_AddRefs(prop));</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineplus">+</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineplus">+    rv = prop-&gt;GetPropertyName(name);</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineplus">+</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineplus">+    if (!name.EqualsLiteral(&quot;RDATE&quot;) &amp;&amp; !name.EqualsLiteral(&quot;EXDATE&quot;)) {</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineplus">+        return NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineplus">+    }</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineplus">+</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineplus">+    return SetIcalProperty(prop);</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineplus">+}</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineplus">+</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineplus">+calRecurrenceDate::GetIcalString(nsACString &amp;str)</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineplus">+{</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineplus">+    nsresult rv = NS_OK;</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineplus">+</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineplus">+    nsCOMPtr&lt;calIIcalProperty&gt; prop;</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineplus">+</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineplus">+    rv = this-&gt;GetIcalProperty(getter_AddRefs(prop));</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineplus">+</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineplus">+        rv = prop-&gt;GetIcalString(str);</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineplus">+    }</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineplus">+</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineplus">+    return rv;</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/calendar/base/src/calRecurrenceDate.h</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/calendar/base/src/calRecurrenceDate.h</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -17,15 +17,17 @@ public:</span>
<a href="#l11.4"></a><span id="l11.4">     calRecurrenceDate();</span>
<a href="#l11.5"></a><span id="l11.5"> </span>
<a href="#l11.6"></a><span id="l11.6">     NS_DECL_ISUPPORTS</span>
<a href="#l11.7"></a><span id="l11.7"> </span>
<a href="#l11.8"></a><span id="l11.8">     NS_DECL_CALIRECURRENCEITEM</span>
<a href="#l11.9"></a><span id="l11.9"> </span>
<a href="#l11.10"></a><span id="l11.10">     NS_DECL_CALIRECURRENCEDATE</span>
<a href="#l11.11"></a><span id="l11.11"> protected:</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+    virtual ~calRecurrenceDate() {};</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+</span>
<a href="#l11.14"></a><span id="l11.14">     bool mImmutable;</span>
<a href="#l11.15"></a><span id="l11.15">     bool mIsNegative;</span>
<a href="#l11.16"></a><span id="l11.16"> </span>
<a href="#l11.17"></a><span id="l11.17">     nsCOMPtr&lt;calIDateTime&gt; mDate;</span>
<a href="#l11.18"></a><span id="l11.18"> };</span>
<a href="#l11.19"></a><span id="l11.19"> </span>
<a href="#l11.20"></a><span id="l11.20"> #endif /* CALRECURRENCEDATE_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/calendar/base/src/calRecurrenceRule.cpp</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/calendar/base/src/calRecurrenceRule.cpp</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -513,22 +513,21 @@ calRecurrenceRule::SetIcalProperty(calII</span>
<a href="#l12.4"></a><span id="l12.4">     NS_ENSURE_ARG_POINTER(aProp);</span>
<a href="#l12.5"></a><span id="l12.5"> </span>
<a href="#l12.6"></a><span id="l12.6">     if (mImmutable)</span>
<a href="#l12.7"></a><span id="l12.7">         return NS_ERROR_OBJECT_IS_IMMUTABLE;</span>
<a href="#l12.8"></a><span id="l12.8"> </span>
<a href="#l12.9"></a><span id="l12.9">     nsAutoCString propname;</span>
<a href="#l12.10"></a><span id="l12.10">     nsresult rv = aProp-&gt;GetPropertyName(propname);</span>
<a href="#l12.11"></a><span id="l12.11">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-    if (propname.EqualsLiteral(&quot;RRULE&quot;))</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+    if (propname.EqualsLiteral(&quot;RRULE&quot;)) {</span>
<a href="#l12.14"></a><span id="l12.14">         mIsNegative = false;</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineminus">-    else if (propname.EqualsLiteral(&quot;EXRULE&quot;))</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineminus">-        mIsNegative = true;</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineminus">-    else</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineplus">+    } else {</span>
<a href="#l12.19"></a><span id="l12.19">         return NS_ERROR_INVALID_ARG;</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineplus">+    }</span>
<a href="#l12.21"></a><span id="l12.21"> </span>
<a href="#l12.22"></a><span id="l12.22">     icalproperty *prop;</span>
<a href="#l12.23"></a><span id="l12.23">     struct icalrecurrencetype icalrecur;</span>
<a href="#l12.24"></a><span id="l12.24"> </span>
<a href="#l12.25"></a><span id="l12.25">     prop = aProp-&gt;GetIcalProperty();</span>
<a href="#l12.26"></a><span id="l12.26"> </span>
<a href="#l12.27"></a><span id="l12.27">     icalrecur = icalproperty_get_rrule(prop);</span>
<a href="#l12.28"></a><span id="l12.28"> </span>
<a href="#l12.29"></a><span id="l12.29" class="difflineat">@@ -546,8 +545,45 @@ calRecurrenceRule::SetIcalProperty(calII</span>
<a href="#l12.30"></a><span id="l12.30">         mIsByCount = true;</span>
<a href="#l12.31"></a><span id="l12.31">     else</span>
<a href="#l12.32"></a><span id="l12.32">         mIsByCount = false;</span>
<a href="#l12.33"></a><span id="l12.33"> </span>
<a href="#l12.34"></a><span id="l12.34">     mIcalRecur = icalrecur;</span>
<a href="#l12.35"></a><span id="l12.35"> </span>
<a href="#l12.36"></a><span id="l12.36">     return NS_OK;</span>
<a href="#l12.37"></a><span id="l12.37"> }</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineplus">+</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l12.40"></a><span id="l12.40" class="difflineplus">+calRecurrenceRule::SetIcalString(const nsACString &amp;str)</span>
<a href="#l12.41"></a><span id="l12.41" class="difflineplus">+{</span>
<a href="#l12.42"></a><span id="l12.42" class="difflineplus">+    nsresult rv = NS_OK;</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineplus">+    nsCAutoString name;</span>
<a href="#l12.44"></a><span id="l12.44" class="difflineplus">+    nsCOMPtr&lt;calIICSService&gt; icsSvc = cal::getICSService();</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineplus">+    nsCOMPtr&lt;calIIcalProperty&gt; prop;</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineplus">+</span>
<a href="#l12.47"></a><span id="l12.47" class="difflineplus">+    rv = icsSvc-&gt;CreateIcalPropertyFromString(str, getter_AddRefs(prop));</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineplus">+</span>
<a href="#l12.50"></a><span id="l12.50" class="difflineplus">+    rv = prop-&gt;GetPropertyName(name);</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.52"></a><span id="l12.52" class="difflineplus">+</span>
<a href="#l12.53"></a><span id="l12.53" class="difflineplus">+    if (!name.EqualsLiteral(&quot;RRULE&quot;)) {</span>
<a href="#l12.54"></a><span id="l12.54" class="difflineplus">+        return NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l12.55"></a><span id="l12.55" class="difflineplus">+    }</span>
<a href="#l12.56"></a><span id="l12.56" class="difflineplus">+</span>
<a href="#l12.57"></a><span id="l12.57" class="difflineplus">+    return SetIcalProperty(prop);</span>
<a href="#l12.58"></a><span id="l12.58" class="difflineplus">+}</span>
<a href="#l12.59"></a><span id="l12.59" class="difflineplus">+</span>
<a href="#l12.60"></a><span id="l12.60" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l12.61"></a><span id="l12.61" class="difflineplus">+calRecurrenceRule::GetIcalString(nsACString &amp;str)</span>
<a href="#l12.62"></a><span id="l12.62" class="difflineplus">+{</span>
<a href="#l12.63"></a><span id="l12.63" class="difflineplus">+    nsresult rv = NS_OK;</span>
<a href="#l12.64"></a><span id="l12.64" class="difflineplus">+</span>
<a href="#l12.65"></a><span id="l12.65" class="difflineplus">+    nsCOMPtr&lt;calIIcalProperty&gt; prop;</span>
<a href="#l12.66"></a><span id="l12.66" class="difflineplus">+</span>
<a href="#l12.67"></a><span id="l12.67" class="difflineplus">+    rv = this-&gt;GetIcalProperty(getter_AddRefs(prop));</span>
<a href="#l12.68"></a><span id="l12.68" class="difflineplus">+</span>
<a href="#l12.69"></a><span id="l12.69" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l12.70"></a><span id="l12.70" class="difflineplus">+        rv = prop-&gt;GetIcalString(str);</span>
<a href="#l12.71"></a><span id="l12.71" class="difflineplus">+    }</span>
<a href="#l12.72"></a><span id="l12.72" class="difflineplus">+</span>
<a href="#l12.73"></a><span id="l12.73" class="difflineplus">+    return rv;</span>
<a href="#l12.74"></a><span id="l12.74" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/calendar/base/src/calRelation.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/calendar/base/src/calRelation.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -108,16 +108,29 @@ calRelation.prototype = {</span>
<a href="#l13.4"></a><span id="l13.4">                 this.mType = value;</span>
<a href="#l13.5"></a><span id="l13.5">                 continue;</span>
<a href="#l13.6"></a><span id="l13.6">             }</span>
<a href="#l13.7"></a><span id="l13.7"> </span>
<a href="#l13.8"></a><span id="l13.8">             this.setParameter(name, value);</span>
<a href="#l13.9"></a><span id="l13.9">         }</span>
<a href="#l13.10"></a><span id="l13.10">     },</span>
<a href="#l13.11"></a><span id="l13.11"> </span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+    get icalString() {</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+        let comp = this.icalProperty;</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+        return (comp ? comp.icalString : &quot;&quot;);</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+    },</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineplus">+    set icalString(val) {</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineplus">+        let prop = cal.getIcsService().createIcalPropertyFromString(val);</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineplus">+        if (prop.propertyName != &quot;RELATED-TO&quot;) {</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineplus">+            throw Components.results.NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineplus">+        }</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineplus">+        this.icalProperty = prop;</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineplus">+        return val;</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineplus">+    },</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineplus">+</span>
<a href="#l13.25"></a><span id="l13.25">     getParameter: function (aName) {</span>
<a href="#l13.26"></a><span id="l13.26">         return this.mProperties.getProperty(aName);</span>
<a href="#l13.27"></a><span id="l13.27">     },</span>
<a href="#l13.28"></a><span id="l13.28"> </span>
<a href="#l13.29"></a><span id="l13.29">     setParameter: function (aName, aValue) {</span>
<a href="#l13.30"></a><span id="l13.30">         return this.mProperties.setProperty(aName, aValue);</span>
<a href="#l13.31"></a><span id="l13.31">     },</span>
<a href="#l13.32"></a><span id="l13.32"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/calendar/base/src/calUtils.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/calendar/base/src/calUtils.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -4,107 +4,55 @@</span>
<a href="#l14.4"></a><span id="l14.4"> </span>
<a href="#l14.5"></a><span id="l14.5"> /* This file contains commonly used functions in a centralized place so that</span>
<a href="#l14.6"></a><span id="l14.6">  * various components (and other js scopes) don't need to replicate them. Note</span>
<a href="#l14.7"></a><span id="l14.7">  * that loading this file twice in the same scope will throw errors.</span>
<a href="#l14.8"></a><span id="l14.8">  */</span>
<a href="#l14.9"></a><span id="l14.9"> </span>
<a href="#l14.10"></a><span id="l14.10"> Components.utils.import(&quot;resource:///modules/Services.jsm&quot;);</span>
<a href="#l14.11"></a><span id="l14.11"> </span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-/**</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineminus">- * Returns a clean new calIEvent</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineminus">- *</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineminus">- * @param aIcalString       (optional) The icalString to read event details from.</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineminus">- */</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineminus">-function createEvent(aIcalString) {</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineminus">-    let event = Components.classes[&quot;@mozilla.org/calendar/event;1&quot;]</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineminus">-                          .createInstance(Components.interfaces.calIEvent);</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineminus">-    if (aIcalString) {</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineminus">-        event.icalString = aIcalString;</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineminus">-    }</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineminus">-    return event;</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineplus">+function _calIcalCreator(cid, iid) {</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineplus">+    return function(icalString) {</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineplus">+        let thing = Components.classes[cid].createInstance(iid);</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineplus">+        if (icalString) {</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineplus">+            thing.icalString = icalString;</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineplus">+        }</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineplus">+        return thing;</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineplus">+    };</span>
<a href="#l14.32"></a><span id="l14.32"> }</span>
<a href="#l14.33"></a><span id="l14.33"> </span>
<a href="#l14.34"></a><span id="l14.34" class="difflineminus">-/**</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineminus">- * Returns a clean new calITodo</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineminus">- *</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineminus">- * @param aIcalString       (optional) The icalString to read task details from.</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineminus">- */</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineminus">-function createTodo(aIcalString) {</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineminus">-    let todo = Components.classes[&quot;@mozilla.org/calendar/todo;1&quot;]</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineminus">-                         .createInstance(Components.interfaces.calITodo);</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineminus">-    if (aIcalString) {</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineminus">-        todo.icalString = aIcalString;</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineminus">-    }</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineminus">-    return todo;</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineminus">-}</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineplus">+let createEvent = _calIcalCreator(&quot;@mozilla.org/calendar/event;1&quot;,</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineplus">+                                  Components.interfaces.calIEvent);</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineplus">+let createTodo = _calIcalCreator(&quot;@mozilla.org/calendar/todo;1&quot;,</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineplus">+                                 Components.interfaces.calITodo);</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineplus">+let createDateTime  = _calIcalCreator(&quot;@mozilla.org/calendar/datetime;1&quot;,</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineplus">+                                      Components.interfaces.calIDateTime);</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineplus">+let createDuration = _calIcalCreator(&quot;@mozilla.org/calendar/duration;1&quot;,</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineplus">+                                     Components.interfaces.calIDuration);</span>
<a href="#l14.55"></a><span id="l14.55" class="difflineplus">+let createAttendee = _calIcalCreator(&quot;@mozilla.org/calendar/attendee;1&quot;,</span>
<a href="#l14.56"></a><span id="l14.56" class="difflineplus">+                                     Components.interfaces.calIAttendee);</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineplus">+let createAttachment = _calIcalCreator(&quot;@mozilla.org/calendar/attachment;1&quot;,</span>
<a href="#l14.58"></a><span id="l14.58" class="difflineplus">+                                       Components.interfaces.calIAttachment);</span>
<a href="#l14.59"></a><span id="l14.59" class="difflineplus">+let createAlarm = _calIcalCreator(&quot;@mozilla.org/calendar/alarm;1&quot;,</span>
<a href="#l14.60"></a><span id="l14.60" class="difflineplus">+                                  Components.interfaces.calIAlarm);</span>
<a href="#l14.61"></a><span id="l14.61" class="difflineplus">+let createRelation = _calIcalCreator(&quot;@mozilla.org/calendar/relation;1&quot;,</span>
<a href="#l14.62"></a><span id="l14.62" class="difflineplus">+                                     Components.interfaces.calIRelation);</span>
<a href="#l14.63"></a><span id="l14.63" class="difflineplus">+let createRecurrenceDate = _calIcalCreator(&quot;@mozilla.org/calendar/recurrence-date;1&quot;,</span>
<a href="#l14.64"></a><span id="l14.64" class="difflineplus">+                                           Components.interfaces.calIRecurrenceDate);</span>
<a href="#l14.65"></a><span id="l14.65" class="difflineplus">+let createRecurrenceRule = _calIcalCreator(&quot;@mozilla.org/calendar/recurrence-rule;1&quot;,</span>
<a href="#l14.66"></a><span id="l14.66" class="difflineplus">+                                           Components.interfaces.calIRecurrenceRule);</span>
<a href="#l14.67"></a><span id="l14.67"> </span>
<a href="#l14.68"></a><span id="l14.68" class="difflineminus">-/* Returns a clean new calIDateTime */</span>
<a href="#l14.69"></a><span id="l14.69" class="difflineminus">-function createDateTime(aIcalString) {</span>
<a href="#l14.70"></a><span id="l14.70" class="difflineminus">-    var dt = Components.classes[&quot;@mozilla.org/calendar/datetime;1&quot;]</span>
<a href="#l14.71"></a><span id="l14.71" class="difflineminus">-                       .createInstance(Components.interfaces.calIDateTime);</span>
<a href="#l14.72"></a><span id="l14.72" class="difflineminus">-    if (aIcalString) {</span>
<a href="#l14.73"></a><span id="l14.73" class="difflineminus">-        dt.icalString = aIcalString;</span>
<a href="#l14.74"></a><span id="l14.74" class="difflineminus">-    }</span>
<a href="#l14.75"></a><span id="l14.75" class="difflineminus">-    return dt;</span>
<a href="#l14.76"></a><span id="l14.76" class="difflineminus">-}</span>
<a href="#l14.77"></a><span id="l14.77" class="difflineminus">-</span>
<a href="#l14.78"></a><span id="l14.78" class="difflineminus">-/* Returns a clean new calIDuration */</span>
<a href="#l14.79"></a><span id="l14.79" class="difflineminus">-function createDuration(aIcalString) {</span>
<a href="#l14.80"></a><span id="l14.80" class="difflineminus">-    var dur = Components.classes[&quot;@mozilla.org/calendar/duration;1&quot;]</span>
<a href="#l14.81"></a><span id="l14.81" class="difflineminus">-                        .createInstance(Components.interfaces.calIDuration);</span>
<a href="#l14.82"></a><span id="l14.82" class="difflineminus">-    if (aIcalString) {</span>
<a href="#l14.83"></a><span id="l14.83" class="difflineminus">-        dur.icalString = aIcalString;</span>
<a href="#l14.84"></a><span id="l14.84" class="difflineminus">-    }</span>
<a href="#l14.85"></a><span id="l14.85" class="difflineminus">-    return dur;</span>
<a href="#l14.86"></a><span id="l14.86" class="difflineminus">-}</span>
<a href="#l14.87"></a><span id="l14.87"> /* Returns a clean new calIRecurrenceInfo */</span>
<a href="#l14.88"></a><span id="l14.88"> function createRecurrenceInfo(aItem) {</span>
<a href="#l14.89"></a><span id="l14.89">     var recInfo = Components.classes[&quot;@mozilla.org/calendar/recurrence-info;1&quot;].</span>
<a href="#l14.90"></a><span id="l14.90">            createInstance(Components.interfaces.calIRecurrenceInfo);</span>
<a href="#l14.91"></a><span id="l14.91">     recInfo.item = aItem;</span>
<a href="#l14.92"></a><span id="l14.92">     return recInfo;</span>
<a href="#l14.93"></a><span id="l14.93"> }</span>
<a href="#l14.94"></a><span id="l14.94"> </span>
<a href="#l14.95"></a><span id="l14.95" class="difflineminus">-/* Returns a clean new calIRecurrenceRule */</span>
<a href="#l14.96"></a><span id="l14.96" class="difflineminus">-function createRecurrenceRule() {</span>
<a href="#l14.97"></a><span id="l14.97" class="difflineminus">-    return Components.classes[&quot;@mozilla.org/calendar/recurrence-rule;1&quot;].</span>
<a href="#l14.98"></a><span id="l14.98" class="difflineminus">-           createInstance(Components.interfaces.calIRecurrenceRule);</span>
<a href="#l14.99"></a><span id="l14.99" class="difflineminus">-}</span>
<a href="#l14.100"></a><span id="l14.100" class="difflineminus">-</span>
<a href="#l14.101"></a><span id="l14.101" class="difflineminus">-/* Returns a clean new calIRecurrenceRule */</span>
<a href="#l14.102"></a><span id="l14.102" class="difflineminus">-function createRecurrenceDate() {</span>
<a href="#l14.103"></a><span id="l14.103" class="difflineminus">-    return Components.classes[&quot;@mozilla.org/calendar/recurrence-date;1&quot;].</span>
<a href="#l14.104"></a><span id="l14.104" class="difflineminus">-           createInstance(Components.interfaces.calIRecurrenceDate);</span>
<a href="#l14.105"></a><span id="l14.105" class="difflineminus">-}</span>
<a href="#l14.106"></a><span id="l14.106" class="difflineminus">-</span>
<a href="#l14.107"></a><span id="l14.107" class="difflineminus">-/* Returns a clean new calIAttendee */</span>
<a href="#l14.108"></a><span id="l14.108" class="difflineminus">-function createAttendee() {</span>
<a href="#l14.109"></a><span id="l14.109" class="difflineminus">-    return Components.classes[&quot;@mozilla.org/calendar/attendee;1&quot;].</span>
<a href="#l14.110"></a><span id="l14.110" class="difflineminus">-           createInstance(Components.interfaces.calIAttendee);</span>
<a href="#l14.111"></a><span id="l14.111" class="difflineminus">-}</span>
<a href="#l14.112"></a><span id="l14.112" class="difflineminus">-</span>
<a href="#l14.113"></a><span id="l14.113" class="difflineminus">-/* Returns a clean new calIAttachment */</span>
<a href="#l14.114"></a><span id="l14.114" class="difflineminus">-function createAttachment() {</span>
<a href="#l14.115"></a><span id="l14.115" class="difflineminus">-    return Components.classes[&quot;@mozilla.org/calendar/attachment;1&quot;].</span>
<a href="#l14.116"></a><span id="l14.116" class="difflineminus">-           createInstance(Components.interfaces.calIAttachment);</span>
<a href="#l14.117"></a><span id="l14.117" class="difflineminus">-}</span>
<a href="#l14.118"></a><span id="l14.118" class="difflineminus">-</span>
<a href="#l14.119"></a><span id="l14.119" class="difflineminus">-/* Returns a clean new calIAlarm*/</span>
<a href="#l14.120"></a><span id="l14.120" class="difflineminus">-function createAlarm() {</span>
<a href="#l14.121"></a><span id="l14.121" class="difflineminus">-    return Components.classes[&quot;@mozilla.org/calendar/alarm;1&quot;].</span>
<a href="#l14.122"></a><span id="l14.122" class="difflineminus">-           createInstance(Components.interfaces.calIAlarm);</span>
<a href="#l14.123"></a><span id="l14.123" class="difflineminus">-}</span>
<a href="#l14.124"></a><span id="l14.124" class="difflineminus">-</span>
<a href="#l14.125"></a><span id="l14.125" class="difflineminus">-/* Returns a clean new calIRelation */</span>
<a href="#l14.126"></a><span id="l14.126" class="difflineminus">-function createRelation() {</span>
<a href="#l14.127"></a><span id="l14.127" class="difflineminus">-    return Components.classes[&quot;@mozilla.org/calendar/relation;1&quot;].</span>
<a href="#l14.128"></a><span id="l14.128" class="difflineminus">-           createInstance(Components.interfaces.calIRelation);</span>
<a href="#l14.129"></a><span id="l14.129" class="difflineminus">-}</span>
<a href="#l14.130"></a><span id="l14.130" class="difflineminus">-</span>
<a href="#l14.131"></a><span id="l14.131"> /* Shortcut to the console service */</span>
<a href="#l14.132"></a><span id="l14.132"> function getConsoleService() {</span>
<a href="#l14.133"></a><span id="l14.133">     return Components.classes[&quot;@mozilla.org/consoleservice;1&quot;]</span>
<a href="#l14.134"></a><span id="l14.134">                      .getService(Components.interfaces.nsIConsoleService);</span>
<a href="#l14.135"></a><span id="l14.135"> }</span>
<a href="#l14.136"></a><span id="l14.136"> </span>
<a href="#l14.137"></a><span id="l14.137"> /* Shortcut to the account manager service */</span>
<a href="#l14.138"></a><span id="l14.138"> function getAccountManager() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/calendar/providers/storage/calStorageCalendar.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/calendar/providers/storage/calStorageCalendar.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -1233,18 +1233,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l15.4"></a><span id="l15.4">                 &quot;SELECT * FROM cal_properties &quot; +</span>
<a href="#l15.5"></a><span id="l15.5">                 &quot;WHERE item_id = :item_id AND cal_id = :cal_id&quot; +</span>
<a href="#l15.6"></a><span id="l15.6">                 &quot;  AND recurrence_id = :recurrence_id&quot; +</span>
<a href="#l15.7"></a><span id="l15.7">                 &quot;  AND recurrence_id_tz = :recurrence_id_tz&quot;</span>
<a href="#l15.8"></a><span id="l15.8">                 );</span>
<a href="#l15.9"></a><span id="l15.9"> </span>
<a href="#l15.10"></a><span id="l15.10">             this.mSelectRecurrenceForItem = this.mDB.createStatement(</span>
<a href="#l15.11"></a><span id="l15.11">                 &quot;SELECT * FROM cal_recurrence &quot; +</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-                &quot;WHERE item_id = :item_id AND cal_id = :cal_id&quot; +</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">-                &quot; ORDER BY recur_index&quot;</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineplus">+                &quot;WHERE item_id = :item_id AND cal_id = :cal_id&quot;</span>
<a href="#l15.15"></a><span id="l15.15">                 );</span>
<a href="#l15.16"></a><span id="l15.16"> </span>
<a href="#l15.17"></a><span id="l15.17">             this.mSelectAttachmentsForItem = this.mDB.createStatement(</span>
<a href="#l15.18"></a><span id="l15.18">                 &quot;SELECT * FROM cal_attachments &quot; +</span>
<a href="#l15.19"></a><span id="l15.19">                 &quot;WHERE item_id = :item_id AND cal_id = :cal_id&quot; +</span>
<a href="#l15.20"></a><span id="l15.20">                 &quot; AND recurrence_id IS NULL&quot;</span>
<a href="#l15.21"></a><span id="l15.21">                 );</span>
<a href="#l15.22"></a><span id="l15.22">             this.mSelectAttachmentsForItemWithRecurrenceId = this.mDB.createStatement(</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineat">@@ -1314,35 +1313,35 @@ calStorageCalendar.prototype = {</span>
<a href="#l15.24"></a><span id="l15.24">                 &quot;        :recurrence_id, :recurrence_id_tz, :alarm_last_ack)&quot;</span>
<a href="#l15.25"></a><span id="l15.25">                 );</span>
<a href="#l15.26"></a><span id="l15.26">             this.mInsertProperty = this.mDB.createStatement(</span>
<a href="#l15.27"></a><span id="l15.27">                 &quot;INSERT INTO cal_properties (cal_id, item_id, recurrence_id, recurrence_id_tz, key, value) &quot; +</span>
<a href="#l15.28"></a><span id="l15.28">                 &quot;VALUES (:cal_id, :item_id, :recurrence_id, :recurrence_id_tz, :key, :value)&quot;</span>
<a href="#l15.29"></a><span id="l15.29">                 );</span>
<a href="#l15.30"></a><span id="l15.30">             this.mInsertAttendee = this.mDB.createStatement(</span>
<a href="#l15.31"></a><span id="l15.31">                 &quot;INSERT INTO cal_attendees &quot; +</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineminus">-                &quot;  (cal_id, item_id, recurrence_id, recurrence_id_tz, attendee_id, common_name, rsvp, role, status, type, is_organizer, properties) &quot; +</span>
<a href="#l15.33"></a><span id="l15.33" class="difflineminus">-                &quot;VALUES (:cal_id, :item_id, :recurrence_id, :recurrence_id_tz, :attendee_id, :common_name, :rsvp, :role, :status, :type, :is_organizer, :properties)&quot;</span>
<a href="#l15.34"></a><span id="l15.34" class="difflineplus">+                &quot;  (cal_id, item_id, recurrence_id, recurrence_id_tz, icalString) &quot; +</span>
<a href="#l15.35"></a><span id="l15.35" class="difflineplus">+                &quot;VALUES (:cal_id, :item_id, :recurrence_id, :recurrence_id_tz, :icalString)&quot;</span>
<a href="#l15.36"></a><span id="l15.36">                 );</span>
<a href="#l15.37"></a><span id="l15.37">             this.mInsertRecurrence = this.mDB.createStatement(</span>
<a href="#l15.38"></a><span id="l15.38">                 &quot;INSERT INTO cal_recurrence &quot; +</span>
<a href="#l15.39"></a><span id="l15.39" class="difflineminus">-                &quot;  (cal_id, item_id, recur_index, recur_type, is_negative, dates, count, end_date, interval, second, minute, hour, day, monthday, yearday, weekno, month, setpos) &quot; +</span>
<a href="#l15.40"></a><span id="l15.40" class="difflineminus">-                &quot;VALUES (:cal_id, :item_id, :recur_index, :recur_type, :is_negative, :dates, :count, :end_date, :interval, :second, :minute, :hour, :day, :monthday, :yearday, :weekno, :month, :setpos)&quot;</span>
<a href="#l15.41"></a><span id="l15.41" class="difflineplus">+                &quot;  (cal_id, item_id, icalString) &quot; +</span>
<a href="#l15.42"></a><span id="l15.42" class="difflineplus">+                &quot;VALUES (:cal_id, :item_id, :icalString)&quot;</span>
<a href="#l15.43"></a><span id="l15.43">                 );</span>
<a href="#l15.44"></a><span id="l15.44"> </span>
<a href="#l15.45"></a><span id="l15.45">             this.mInsertAttachment = this.mDB.createStatement(</span>
<a href="#l15.46"></a><span id="l15.46">                 &quot;INSERT INTO cal_attachments &quot; +</span>
<a href="#l15.47"></a><span id="l15.47" class="difflineminus">-                &quot; (cal_id, item_id, data, format_type, encoding, recurrence_id, recurrence_id_tz) &quot; +</span>
<a href="#l15.48"></a><span id="l15.48" class="difflineminus">-                &quot;VALUES (:cal_id, :item_id, :data, :format_type, :encoding, :recurrence_id, :recurrence_id_tz)&quot;</span>
<a href="#l15.49"></a><span id="l15.49" class="difflineplus">+                &quot; (cal_id, item_id, icalString, recurrence_id, recurrence_id_tz) &quot; +</span>
<a href="#l15.50"></a><span id="l15.50" class="difflineplus">+                &quot;VALUES (:cal_id, :item_id, :icalString, :recurrence_id, :recurrence_id_tz)&quot;</span>
<a href="#l15.51"></a><span id="l15.51">                 );</span>
<a href="#l15.52"></a><span id="l15.52"> </span>
<a href="#l15.53"></a><span id="l15.53">             this.mInsertRelation = this.mDB.createStatement(</span>
<a href="#l15.54"></a><span id="l15.54">                 &quot;INSERT INTO cal_relations &quot; +</span>
<a href="#l15.55"></a><span id="l15.55" class="difflineminus">-                &quot; (cal_id, item_id, rel_type, rel_id, recurrence_id, recurrence_id_tz) &quot; +</span>
<a href="#l15.56"></a><span id="l15.56" class="difflineminus">-                &quot;VALUES (:cal_id, :item_id, :rel_type, :rel_id, :recurrence_id, :recurrence_id_tz)&quot;</span>
<a href="#l15.57"></a><span id="l15.57" class="difflineplus">+                &quot; (cal_id, item_id, icalString, recurrence_id, recurrence_id_tz) &quot; +</span>
<a href="#l15.58"></a><span id="l15.58" class="difflineplus">+                &quot;VALUES (:cal_id, :item_id, :icalString, :recurrence_id, :recurrence_id_tz)&quot;</span>
<a href="#l15.59"></a><span id="l15.59">                 );</span>
<a href="#l15.60"></a><span id="l15.60"> </span>
<a href="#l15.61"></a><span id="l15.61">             this.mInsertMetaData = this.mDB.createStatement(</span>
<a href="#l15.62"></a><span id="l15.62">                 &quot;INSERT INTO cal_metadata&quot;</span>
<a href="#l15.63"></a><span id="l15.63">                 + &quot; (cal_id, item_id, value)&quot;</span>
<a href="#l15.64"></a><span id="l15.64">                 + &quot; VALUES (:cal_id, :item_id, :value)&quot;);</span>
<a href="#l15.65"></a><span id="l15.65"> </span>
<a href="#l15.66"></a><span id="l15.66">             this.mInsertAlarm = this.mDB.createStatement(</span>
<a href="#l15.67"></a><span id="l15.67" class="difflineat">@@ -1613,17 +1612,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l15.68"></a><span id="l15.68">                 selectItem = this.mSelectAttendeesForItemWithRecurrenceId;</span>
<a href="#l15.69"></a><span id="l15.69">                 this.setDateParamHelper(selectItem.params, &quot;recurrence_id&quot;, item.recurrenceId);</span>
<a href="#l15.70"></a><span id="l15.70">             }</span>
<a href="#l15.71"></a><span id="l15.71"> </span>
<a href="#l15.72"></a><span id="l15.72">             try {</span>
<a href="#l15.73"></a><span id="l15.73">                 this.prepareStatement(selectItem);</span>
<a href="#l15.74"></a><span id="l15.74">                 selectItem.params.item_id = item.id;</span>
<a href="#l15.75"></a><span id="l15.75">                 while (selectItem.executeStep()) {</span>
<a href="#l15.76"></a><span id="l15.76" class="difflineminus">-                    var attendee = this.getAttendeeFromRow(selectItem.row);</span>
<a href="#l15.77"></a><span id="l15.77" class="difflineplus">+                    let attendee = cal.createAttendee(selectItem.row.icalString);</span>
<a href="#l15.78"></a><span id="l15.78">                     if (attendee &amp;&amp; attendee.id) {</span>
<a href="#l15.79"></a><span id="l15.79">                         if (attendee.isOrganizer) {</span>
<a href="#l15.80"></a><span id="l15.80">                             item.organizer = attendee;</span>
<a href="#l15.81"></a><span id="l15.81">                         } else {</span>
<a href="#l15.82"></a><span id="l15.82">                             item.addAttendee(attendee);</span>
<a href="#l15.83"></a><span id="l15.83">                         }</span>
<a href="#l15.84"></a><span id="l15.84">                     } else {</span>
<a href="#l15.85"></a><span id="l15.85">                         cal.WARN(&quot;[calStorageCalendar] Skipping invalid attendee for item '&quot; +</span>
<a href="#l15.86"></a><span id="l15.86" class="difflineat">@@ -1677,24 +1676,26 @@ calStorageCalendar.prototype = {</span>
<a href="#l15.87"></a><span id="l15.87">         }</span>
<a href="#l15.88"></a><span id="l15.88"> </span>
<a href="#l15.89"></a><span id="l15.89">         var i;</span>
<a href="#l15.90"></a><span id="l15.90">         if (flags &amp; CAL_ITEM_FLAG.HAS_RECURRENCE) {</span>
<a href="#l15.91"></a><span id="l15.91">             if (item.recurrenceId) {</span>
<a href="#l15.92"></a><span id="l15.92">                 throw Components.results.NS_ERROR_UNEXPECTED;</span>
<a href="#l15.93"></a><span id="l15.93">             }</span>
<a href="#l15.94"></a><span id="l15.94"> </span>
<a href="#l15.95"></a><span id="l15.95" class="difflineminus">-            item.recurrenceInfo = cal.createRecurrenceInfo(item);</span>
<a href="#l15.96"></a><span id="l15.96" class="difflineplus">+            let recInfo = cal.createRecurrenceInfo(item);</span>
<a href="#l15.97"></a><span id="l15.97" class="difflineplus">+            item.recurrenceInfo = recInfo;</span>
<a href="#l15.98"></a><span id="l15.98"> </span>
<a href="#l15.99"></a><span id="l15.99">             try {</span>
<a href="#l15.100"></a><span id="l15.100">                 this.prepareStatement(this.mSelectRecurrenceForItem);</span>
<a href="#l15.101"></a><span id="l15.101">                 this.mSelectRecurrenceForItem.params.item_id = item.id;</span>
<a href="#l15.102"></a><span id="l15.102">                 while (this.mSelectRecurrenceForItem.executeStep()) {</span>
<a href="#l15.103"></a><span id="l15.103">                     let row = this.mSelectRecurrenceForItem.row;</span>
<a href="#l15.104"></a><span id="l15.104" class="difflineminus">-                    this.addRecurrenceItemsFromRow(row, item);</span>
<a href="#l15.105"></a><span id="l15.105" class="difflineplus">+                    let ritem = this.getRecurrenceItemFromRow(row);</span>
<a href="#l15.106"></a><span id="l15.106" class="difflineplus">+                    recInfo.appendRecurrenceItem(ritem);</span>
<a href="#l15.107"></a><span id="l15.107">                 }</span>
<a href="#l15.108"></a><span id="l15.108">             } catch (e) {</span>
<a href="#l15.109"></a><span id="l15.109">                 this.logError(&quot;Error getting recurrence for item '&quot; +</span>
<a href="#l15.110"></a><span id="l15.110">                               item.title + &quot;' (&quot; + item.id + &quot;)!&quot;, e);</span>
<a href="#l15.111"></a><span id="l15.111">             } finally {</span>
<a href="#l15.112"></a><span id="l15.112">                 this.mSelectRecurrenceForItem.reset();</span>
<a href="#l15.113"></a><span id="l15.113">             }</span>
<a href="#l15.114"></a><span id="l15.114">         }</span>
<a href="#l15.115"></a><span id="l15.115" class="difflineat">@@ -1749,18 +1750,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l15.116"></a><span id="l15.116">                 selectAttachment = this.mSelectAttachmentsForItemWithRecurrenceId;</span>
<a href="#l15.117"></a><span id="l15.117">                 this.setDateParamHelper(selectAttachment.params, &quot;recurrence_id&quot;, item.recurrenceId);</span>
<a href="#l15.118"></a><span id="l15.118">             }</span>
<a href="#l15.119"></a><span id="l15.119">             try {</span>
<a href="#l15.120"></a><span id="l15.120">                 this.prepareStatement(selectAttachment);</span>
<a href="#l15.121"></a><span id="l15.121">                 selectAttachment.params.item_id = item.id;</span>
<a href="#l15.122"></a><span id="l15.122">                 while (selectAttachment.executeStep()) {</span>
<a href="#l15.123"></a><span id="l15.123">                     let row = selectAttachment.row;</span>
<a href="#l15.124"></a><span id="l15.124" class="difflineminus">-                    let attachment = this.getAttachmentFromRow(row);</span>
<a href="#l15.125"></a><span id="l15.125" class="difflineminus">-                    item.addAttachment(attachment);</span>
<a href="#l15.126"></a><span id="l15.126" class="difflineplus">+                    item.addAttachment(cal.createAttachment(row.icalString));</span>
<a href="#l15.127"></a><span id="l15.127">                 }</span>
<a href="#l15.128"></a><span id="l15.128">             } catch (e) {</span>
<a href="#l15.129"></a><span id="l15.129">                 this.logError(&quot;Error getting attachments for item '&quot; +</span>
<a href="#l15.130"></a><span id="l15.130">                               item.title + &quot;' (&quot; + item.id + &quot;)!&quot;, e);</span>
<a href="#l15.131"></a><span id="l15.131">             } finally {</span>
<a href="#l15.132"></a><span id="l15.132">                 selectAttachment.reset();</span>
<a href="#l15.133"></a><span id="l15.133">             }</span>
<a href="#l15.134"></a><span id="l15.134">         }</span>
<a href="#l15.135"></a><span id="l15.135" class="difflineat">@@ -1771,18 +1771,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l15.136"></a><span id="l15.136">                 selectRelation = this.mSelectRelationsForItemWithRecurrenceId;</span>
<a href="#l15.137"></a><span id="l15.137">                 this.setDateParamHelper(selectRelation.params, &quot;recurrence_id&quot;, item.recurrenceId);</span>
<a href="#l15.138"></a><span id="l15.138">             }</span>
<a href="#l15.139"></a><span id="l15.139">             try {</span>
<a href="#l15.140"></a><span id="l15.140">                 this.prepareStatement(selectRelation);</span>
<a href="#l15.141"></a><span id="l15.141">                 selectRelation.params.item_id = item.id;</span>
<a href="#l15.142"></a><span id="l15.142">                 while (selectRelation.executeStep()) {</span>
<a href="#l15.143"></a><span id="l15.143">                     let row = selectRelation.row;</span>
<a href="#l15.144"></a><span id="l15.144" class="difflineminus">-                    let relation = this.getRelationFromRow(row);</span>
<a href="#l15.145"></a><span id="l15.145" class="difflineminus">-                    item.addRelation(relation);</span>
<a href="#l15.146"></a><span id="l15.146" class="difflineplus">+                    item.addRelation(cal.createRelation(row.icalString));</span>
<a href="#l15.147"></a><span id="l15.147">                 }</span>
<a href="#l15.148"></a><span id="l15.148">             } catch (e) {</span>
<a href="#l15.149"></a><span id="l15.149">                 this.logError(&quot;Error getting relations for item '&quot; +</span>
<a href="#l15.150"></a><span id="l15.150">                               item.title + &quot;' (&quot; + item.id + &quot;)!&quot;, e);</span>
<a href="#l15.151"></a><span id="l15.151">             } finally {</span>
<a href="#l15.152"></a><span id="l15.152">                 selectRelation.reset();</span>
<a href="#l15.153"></a><span id="l15.153">             }</span>
<a href="#l15.154"></a><span id="l15.154">         }</span>
<a href="#l15.155"></a><span id="l15.155" class="difflineat">@@ -1793,127 +1792,49 @@ calStorageCalendar.prototype = {</span>
<a href="#l15.156"></a><span id="l15.156">                 selectAlarm = this.mSelectAlarmsForItemWithRecurrenceId;</span>
<a href="#l15.157"></a><span id="l15.157">                 this.setDateParamHelper(selectAlarm.params, &quot;recurrence_id&quot;, item.recurrenceId);</span>
<a href="#l15.158"></a><span id="l15.158">             }</span>
<a href="#l15.159"></a><span id="l15.159">             try {</span>
<a href="#l15.160"></a><span id="l15.160">                 selectAlarm.params.item_id = item.id;</span>
<a href="#l15.161"></a><span id="l15.161">                 this.prepareStatement(selectAlarm);</span>
<a href="#l15.162"></a><span id="l15.162">                 while (selectAlarm.executeStep()) {</span>
<a href="#l15.163"></a><span id="l15.163">                     let row = selectAlarm.row;</span>
<a href="#l15.164"></a><span id="l15.164" class="difflineminus">-                    let alarm = cal.createAlarm();</span>
<a href="#l15.165"></a><span id="l15.165" class="difflineminus">-                    alarm.icalString = row.icalString;</span>
<a href="#l15.166"></a><span id="l15.166" class="difflineminus">-                    item.addAlarm(alarm);</span>
<a href="#l15.167"></a><span id="l15.167" class="difflineplus">+                    item.addAlarm(cal.createAlarm(row.icalString));</span>
<a href="#l15.168"></a><span id="l15.168">                 }</span>
<a href="#l15.169"></a><span id="l15.169">             } catch (e) {</span>
<a href="#l15.170"></a><span id="l15.170">                 this.logError(&quot;Error getting alarms for item '&quot; +</span>
<a href="#l15.171"></a><span id="l15.171">                               item.title + &quot;' (&quot; + item.id + &quot;)!&quot;, e);</span>
<a href="#l15.172"></a><span id="l15.172">             } finally {</span>
<a href="#l15.173"></a><span id="l15.173">                 selectAlarm.reset();</span>
<a href="#l15.174"></a><span id="l15.174">             }</span>
<a href="#l15.175"></a><span id="l15.175">         }</span>
<a href="#l15.176"></a><span id="l15.176"> </span>
<a href="#l15.177"></a><span id="l15.177">         // Restore the saved modification time</span>
<a href="#l15.178"></a><span id="l15.178">         item.setProperty(&quot;LAST-MODIFIED&quot;, savedLastModifiedTime);</span>
<a href="#l15.179"></a><span id="l15.179">     },</span>
<a href="#l15.180"></a><span id="l15.180"> </span>
<a href="#l15.181"></a><span id="l15.181" class="difflineminus">-    addRecurrenceItemsFromRow: function cSC_getRecurrenceItemFromRow(row, item) {</span>
<a href="#l15.182"></a><span id="l15.182" class="difflineminus">-        let recInfo = item.recurrenceInfo;</span>
<a href="#l15.183"></a><span id="l15.183" class="difflineminus">-</span>
<a href="#l15.184"></a><span id="l15.184" class="difflineminus">-        if (row.recur_type == &quot;x-date&quot;) {</span>
<a href="#l15.185"></a><span id="l15.185" class="difflineminus">-            let ritem = Components.classes[&quot;@mozilla.org/calendar/recurrence-date;1&quot;]</span>
<a href="#l15.186"></a><span id="l15.186" class="difflineplus">+    getRecurrenceItemFromRow: function cSC_getRecurrenceItemFromRow(row, item) {</span>
<a href="#l15.187"></a><span id="l15.187" class="difflineplus">+        let prop = cal.getIcsService().createIcalPropertyFromString(row.icalString);</span>
<a href="#l15.188"></a><span id="l15.188" class="difflineplus">+        switch (prop.propertyName) {</span>
<a href="#l15.189"></a><span id="l15.189" class="difflineplus">+            case &quot;RDATE&quot;:</span>
<a href="#l15.190"></a><span id="l15.190" class="difflineplus">+            case &quot;EXDATE&quot;:</span>
<a href="#l15.191"></a><span id="l15.191" class="difflineplus">+                ritem = Components.classes[&quot;@mozilla.org/calendar/recurrence-date;1&quot;]</span>
<a href="#l15.192"></a><span id="l15.192">                                   .createInstance(Components.interfaces.calIRecurrenceDate);</span>
<a href="#l15.193"></a><span id="l15.193" class="difflineminus">-            ritem.date = textToDate(row.dates);</span>
<a href="#l15.194"></a><span id="l15.194" class="difflineminus">-            ritem.isNegative = !!row.is_negative;</span>
<a href="#l15.195"></a><span id="l15.195" class="difflineminus">-            recInfo.appendRecurrenceItem(ritem);</span>
<a href="#l15.196"></a><span id="l15.196" class="difflineminus">-        } else {</span>
<a href="#l15.197"></a><span id="l15.197" class="difflineminus">-            let ritem = cal.createRecurrenceRule();</span>
<a href="#l15.198"></a><span id="l15.198" class="difflineminus">-            ritem.type = row.recur_type;</span>
<a href="#l15.199"></a><span id="l15.199" class="difflineminus">-            ritem.isNegative = !!row.is_negative;</span>
<a href="#l15.200"></a><span id="l15.200" class="difflineminus">-            if (row.count) {</span>
<a href="#l15.201"></a><span id="l15.201" class="difflineminus">-                try {</span>
<a href="#l15.202"></a><span id="l15.202" class="difflineminus">-                    ritem.count = row.count;</span>
<a href="#l15.203"></a><span id="l15.203" class="difflineminus">-                } catch (exc) {</span>
<a href="#l15.204"></a><span id="l15.204" class="difflineminus">-                }</span>
<a href="#l15.205"></a><span id="l15.205" class="difflineminus">-            } else {</span>
<a href="#l15.206"></a><span id="l15.206" class="difflineminus">-                if (row.end_date) {</span>
<a href="#l15.207"></a><span id="l15.207" class="difflineminus">-                    let dtstart = item.startDate || item.entryDate;</span>
<a href="#l15.208"></a><span id="l15.208" class="difflineminus">-                    let allday = dtstart.isDate &amp;&amp; dtstart.timezone == &quot;floating&quot;;</span>
<a href="#l15.209"></a><span id="l15.209" class="difflineminus">-                    let untilDate = newDateTime(row.end_date, allday ? &quot;&quot; : &quot;UTC&quot;);</span>
<a href="#l15.210"></a><span id="l15.210" class="difflineminus">-                    if (allday) {</span>
<a href="#l15.211"></a><span id="l15.211" class="difflineminus">-                        untilDate.isDate = true;</span>
<a href="#l15.212"></a><span id="l15.212" class="difflineminus">-                    }</span>
<a href="#l15.213"></a><span id="l15.213" class="difflineminus">-                    ritem.untilDate = untilDate;</span>
<a href="#l15.214"></a><span id="l15.214" class="difflineminus">-                } else {</span>
<a href="#l15.215"></a><span id="l15.215" class="difflineminus">-                    ritem.untilDate = null;</span>
<a href="#l15.216"></a><span id="l15.216" class="difflineminus">-                }</span>
<a href="#l15.217"></a><span id="l15.217" class="difflineminus">-            }</span>
<a href="#l15.218"></a><span id="l15.218" class="difflineminus">-            try {</span>
<a href="#l15.219"></a><span id="l15.219" class="difflineminus">-                ritem.interval = row.interval;</span>
<a href="#l15.220"></a><span id="l15.220" class="difflineminus">-            } catch (exc) {</span>
<a href="#l15.221"></a><span id="l15.221" class="difflineminus">-            }</span>
<a href="#l15.222"></a><span id="l15.222" class="difflineminus">-</span>
<a href="#l15.223"></a><span id="l15.223" class="difflineminus">-            let rtypes = [&quot;second&quot;, &quot;minute&quot;, &quot;hour&quot;, &quot;day&quot;, &quot;monthday&quot;,</span>
<a href="#l15.224"></a><span id="l15.224" class="difflineminus">-                          &quot;yearday&quot;, &quot;weekno&quot;, &quot;month&quot;, &quot;setpos&quot;];</span>
<a href="#l15.225"></a><span id="l15.225" class="difflineminus">-</span>
<a href="#l15.226"></a><span id="l15.226" class="difflineminus">-            for each (let rtype in rtypes) {</span>
<a href="#l15.227"></a><span id="l15.227" class="difflineminus">-                if (row[rtype]) {</span>
<a href="#l15.228"></a><span id="l15.228" class="difflineminus">-                    let comp = &quot;BY&quot; + rtype.toUpperCase();</span>
<a href="#l15.229"></a><span id="l15.229" class="difflineminus">-                    let rarray = row[rtype].toString().split(&quot;,&quot;).map(function(x) parseInt(x, 10));</span>
<a href="#l15.230"></a><span id="l15.230" class="difflineminus">-                    ritem.setComponent (comp, rarray.length, rarray);</span>
<a href="#l15.231"></a><span id="l15.231" class="difflineminus">-                }</span>
<a href="#l15.232"></a><span id="l15.232" class="difflineminus">-            }</span>
<a href="#l15.233"></a><span id="l15.233" class="difflineminus">-            recInfo.appendRecurrenceItem(ritem);</span>
<a href="#l15.234"></a><span id="l15.234" class="difflineminus">-        }</span>
<a href="#l15.235"></a><span id="l15.235" class="difflineminus">-    },</span>
<a href="#l15.236"></a><span id="l15.236" class="difflineminus">-</span>
<a href="#l15.237"></a><span id="l15.237" class="difflineminus">-    getAttendeeFromRow: function cSC_getAttendeeFromRow(row) {</span>
<a href="#l15.238"></a><span id="l15.238" class="difflineminus">-        let a = cal.createAttendee();</span>
<a href="#l15.239"></a><span id="l15.239" class="difflineminus">-</span>
<a href="#l15.240"></a><span id="l15.240" class="difflineminus">-        a.id = row.attendee_id;</span>
<a href="#l15.241"></a><span id="l15.241" class="difflineminus">-        a.commonName = row.common_name;</span>
<a href="#l15.242"></a><span id="l15.242" class="difflineminus">-        switch (row.rsvp) {</span>
<a href="#l15.243"></a><span id="l15.243" class="difflineminus">-            case 0:</span>
<a href="#l15.244"></a><span id="l15.244" class="difflineminus">-                a.rsvp = &quot;FALSE&quot;;</span>
<a href="#l15.245"></a><span id="l15.245">                 break;</span>
<a href="#l15.246"></a><span id="l15.246" class="difflineminus">-            case 1:</span>
<a href="#l15.247"></a><span id="l15.247" class="difflineminus">-                a.rsvp = &quot;TRUE&quot;;</span>
<a href="#l15.248"></a><span id="l15.248" class="difflineplus">+            case &quot;RRULE&quot;:</span>
<a href="#l15.249"></a><span id="l15.249" class="difflineplus">+            case &quot;EXRULE&quot;:</span>
<a href="#l15.250"></a><span id="l15.250" class="difflineplus">+                ritem = cal.createRecurrenceRule();</span>
<a href="#l15.251"></a><span id="l15.251">                 break;</span>
<a href="#l15.252"></a><span id="l15.252" class="difflineminus">-            // default: keep undefined</span>
<a href="#l15.253"></a><span id="l15.253" class="difflineminus">-        }</span>
<a href="#l15.254"></a><span id="l15.254" class="difflineminus">-        a.role = row.role;</span>
<a href="#l15.255"></a><span id="l15.255" class="difflineminus">-        a.participationStatus = row.status;</span>
<a href="#l15.256"></a><span id="l15.256" class="difflineminus">-        a.userType = row.type;</span>
<a href="#l15.257"></a><span id="l15.257" class="difflineminus">-        a.isOrganizer = row.is_organizer;</span>
<a href="#l15.258"></a><span id="l15.258" class="difflineminus">-        let props = row.properties;</span>
<a href="#l15.259"></a><span id="l15.259" class="difflineminus">-        if (props) {</span>
<a href="#l15.260"></a><span id="l15.260" class="difflineminus">-            for each (let pair in props.split(&quot;,&quot;)) {</span>
<a href="#l15.261"></a><span id="l15.261" class="difflineminus">-                [key, value] = pair.split(&quot;:&quot;);</span>
<a href="#l15.262"></a><span id="l15.262" class="difflineminus">-                a.setProperty(decodeURIComponent(key), decodeURIComponent(value));</span>
<a href="#l15.263"></a><span id="l15.263" class="difflineminus">-            }</span>
<a href="#l15.264"></a><span id="l15.264" class="difflineplus">+            default:</span>
<a href="#l15.265"></a><span id="l15.265" class="difflineplus">+                throw &quot;Unknown recurrence item: &quot; + prop.propertyName;</span>
<a href="#l15.266"></a><span id="l15.266" class="difflineplus">+                break;</span>
<a href="#l15.267"></a><span id="l15.267">         }</span>
<a href="#l15.268"></a><span id="l15.268"> </span>
<a href="#l15.269"></a><span id="l15.269" class="difflineminus">-        return a;</span>
<a href="#l15.270"></a><span id="l15.270" class="difflineminus">-    },</span>
<a href="#l15.271"></a><span id="l15.271" class="difflineminus">-</span>
<a href="#l15.272"></a><span id="l15.272" class="difflineminus">-    getAttachmentFromRow: function cSC_getAttachmentFromRow(row) {</span>
<a href="#l15.273"></a><span id="l15.273" class="difflineminus">-        let a = cal.createAttachment();</span>
<a href="#l15.274"></a><span id="l15.274" class="difflineminus">-</span>
<a href="#l15.275"></a><span id="l15.275" class="difflineminus">-        // TODO we don't support binary data here, libical doesn't either.</span>
<a href="#l15.276"></a><span id="l15.276" class="difflineminus">-        a.uri = makeURL(row.data);</span>
<a href="#l15.277"></a><span id="l15.277" class="difflineminus">-        a.formatType = row.format_type;</span>
<a href="#l15.278"></a><span id="l15.278" class="difflineminus">-        a.encoding = row.encoding;</span>
<a href="#l15.279"></a><span id="l15.279" class="difflineminus">-</span>
<a href="#l15.280"></a><span id="l15.280" class="difflineminus">-        return a;</span>
<a href="#l15.281"></a><span id="l15.281" class="difflineminus">-    },</span>
<a href="#l15.282"></a><span id="l15.282" class="difflineminus">-</span>
<a href="#l15.283"></a><span id="l15.283" class="difflineminus">-    getRelationFromRow: function cSC_getRelationFromRow(row) {</span>
<a href="#l15.284"></a><span id="l15.284" class="difflineminus">-        let r = cal.createRelation();</span>
<a href="#l15.285"></a><span id="l15.285" class="difflineminus">-        r.relType = row.rel_type;</span>
<a href="#l15.286"></a><span id="l15.286" class="difflineminus">-        r.relId = row.rel_id;</span>
<a href="#l15.287"></a><span id="l15.287" class="difflineminus">-        return r;</span>
<a href="#l15.288"></a><span id="l15.288" class="difflineplus">+        ritem.icalProperty = prop;</span>
<a href="#l15.289"></a><span id="l15.289" class="difflineplus">+        return ritem;</span>
<a href="#l15.290"></a><span id="l15.290">     },</span>
<a href="#l15.291"></a><span id="l15.291"> </span>
<a href="#l15.292"></a><span id="l15.292">     //</span>
<a href="#l15.293"></a><span id="l15.293">     // get item from db or from cache with given iid</span>
<a href="#l15.294"></a><span id="l15.294">     //</span>
<a href="#l15.295"></a><span id="l15.295">     getItemById: function cSC_getItemById(aID) {</span>
<a href="#l15.296"></a><span id="l15.296">         this.assureRecurringItemCaches();</span>
<a href="#l15.297"></a><span id="l15.297"> </span>
<a href="#l15.298"></a><span id="l15.298" class="difflineat">@@ -2108,49 +2029,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l15.299"></a><span id="l15.299">         }</span>
<a href="#l15.300"></a><span id="l15.300">         if (attendees.length &gt; 0) {</span>
<a href="#l15.301"></a><span id="l15.301">             for each (var att in attendees) {</span>
<a href="#l15.302"></a><span id="l15.302">                 var ap = this.mInsertAttendee.params;</span>
<a href="#l15.303"></a><span id="l15.303">                 ap.item_id = item.id;</span>
<a href="#l15.304"></a><span id="l15.304">                 try {</span>
<a href="#l15.305"></a><span id="l15.305">                     this.prepareStatement(this.mInsertAttendee);</span>
<a href="#l15.306"></a><span id="l15.306">                     this.setDateParamHelper(ap, &quot;recurrence_id&quot;, item.recurrenceId);</span>
<a href="#l15.307"></a><span id="l15.307" class="difflineminus">-                    ap.attendee_id = att.id;</span>
<a href="#l15.308"></a><span id="l15.308" class="difflineminus">-                    ap.common_name = att.commonName;</span>
<a href="#l15.309"></a><span id="l15.309" class="difflineminus">-                    switch (att.rsvp) {</span>
<a href="#l15.310"></a><span id="l15.310" class="difflineminus">-                        case &quot;FALSE&quot;:</span>
<a href="#l15.311"></a><span id="l15.311" class="difflineminus">-                            ap.rsvp = 0;</span>
<a href="#l15.312"></a><span id="l15.312" class="difflineminus">-                            break;</span>
<a href="#l15.313"></a><span id="l15.313" class="difflineminus">-                        case &quot;TRUE&quot;:</span>
<a href="#l15.314"></a><span id="l15.314" class="difflineminus">-                            ap.rsvp = 1;</span>
<a href="#l15.315"></a><span id="l15.315" class="difflineminus">-                            break;</span>
<a href="#l15.316"></a><span id="l15.316" class="difflineminus">-                        default:</span>
<a href="#l15.317"></a><span id="l15.317" class="difflineminus">-                            ap.rsvp = 2;</span>
<a href="#l15.318"></a><span id="l15.318" class="difflineminus">-                            break;</span>
<a href="#l15.319"></a><span id="l15.319" class="difflineminus">-                    }</span>
<a href="#l15.320"></a><span id="l15.320" class="difflineminus">-                    ap.role = att.role;</span>
<a href="#l15.321"></a><span id="l15.321" class="difflineminus">-                    ap.status = att.participationStatus;</span>
<a href="#l15.322"></a><span id="l15.322" class="difflineminus">-                    ap.type = att.userType;</span>
<a href="#l15.323"></a><span id="l15.323" class="difflineminus">-                    ap.is_organizer = att.isOrganizer;</span>
<a href="#l15.324"></a><span id="l15.324" class="difflineminus">-</span>
<a href="#l15.325"></a><span id="l15.325" class="difflineminus">-                    var props = &quot;&quot;;</span>
<a href="#l15.326"></a><span id="l15.326" class="difflineminus">-                    var propEnum = att.propertyEnumerator;</span>
<a href="#l15.327"></a><span id="l15.327" class="difflineminus">-                    while (propEnum &amp;&amp; propEnum.hasMoreElements()) {</span>
<a href="#l15.328"></a><span id="l15.328" class="difflineminus">-                        var prop = propEnum.getNext().QueryInterface(Components.interfaces.nsIProperty);</span>
<a href="#l15.329"></a><span id="l15.329" class="difflineminus">-                        if (props.length) {</span>
<a href="#l15.330"></a><span id="l15.330" class="difflineminus">-                            props += &quot;,&quot;;</span>
<a href="#l15.331"></a><span id="l15.331" class="difflineminus">-                        }</span>
<a href="#l15.332"></a><span id="l15.332" class="difflineminus">-                        props += encodeURIComponent(prop.name);</span>
<a href="#l15.333"></a><span id="l15.333" class="difflineminus">-                        props += &quot;:&quot;;</span>
<a href="#l15.334"></a><span id="l15.334" class="difflineminus">-                        props += encodeURIComponent(prop.value);</span>
<a href="#l15.335"></a><span id="l15.335" class="difflineminus">-                    }</span>
<a href="#l15.336"></a><span id="l15.336" class="difflineminus">-                    if (props.length) {</span>
<a href="#l15.337"></a><span id="l15.337" class="difflineminus">-                        ap.properties = props;</span>
<a href="#l15.338"></a><span id="l15.338" class="difflineminus">-                    }</span>
<a href="#l15.339"></a><span id="l15.339" class="difflineminus">-</span>
<a href="#l15.340"></a><span id="l15.340" class="difflineplus">+                    ap.icalString = att.icalString;</span>
<a href="#l15.341"></a><span id="l15.341">                     this.mInsertAttendee.executeStep();</span>
<a href="#l15.342"></a><span id="l15.342">                 } finally {</span>
<a href="#l15.343"></a><span id="l15.343">                     this.mInsertAttendee.reset();</span>
<a href="#l15.344"></a><span id="l15.344">                 }</span>
<a href="#l15.345"></a><span id="l15.345">             }</span>
<a href="#l15.346"></a><span id="l15.346"> </span>
<a href="#l15.347"></a><span id="l15.347">             return CAL_ITEM_FLAG.HAS_ATTENDEES;</span>
<a href="#l15.348"></a><span id="l15.348">         }</span>
<a href="#l15.349"></a><span id="l15.349" class="difflineat">@@ -2206,60 +2095,23 @@ calStorageCalendar.prototype = {</span>
<a href="#l15.350"></a><span id="l15.350">     },</span>
<a href="#l15.351"></a><span id="l15.351"> </span>
<a href="#l15.352"></a><span id="l15.352">     writeRecurrence: function cSC_writeRecurrence(item, olditem) {</span>
<a href="#l15.353"></a><span id="l15.353">         var flags = 0;</span>
<a href="#l15.354"></a><span id="l15.354"> </span>
<a href="#l15.355"></a><span id="l15.355">         var rec = item.recurrenceInfo;</span>
<a href="#l15.356"></a><span id="l15.356">         if (rec) {</span>
<a href="#l15.357"></a><span id="l15.357">             flags = CAL_ITEM_FLAG.HAS_RECURRENCE;</span>
<a href="#l15.358"></a><span id="l15.358" class="difflineminus">-            var ritems = rec.getRecurrenceItems ({});</span>
<a href="#l15.359"></a><span id="l15.359" class="difflineminus">-            for (let i in ritems) {</span>
<a href="#l15.360"></a><span id="l15.360" class="difflineminus">-                var ritem = ritems[i];</span>
<a href="#l15.361"></a><span id="l15.361" class="difflineminus">-                var ap = this.mInsertRecurrence.params;</span>
<a href="#l15.362"></a><span id="l15.362" class="difflineplus">+            let ritems = rec.getRecurrenceItems({});</span>
<a href="#l15.363"></a><span id="l15.363" class="difflineplus">+            for each (let ritem in ritems) {</span>
<a href="#l15.364"></a><span id="l15.364" class="difflineplus">+                let ap = this.mInsertRecurrence.params;</span>
<a href="#l15.365"></a><span id="l15.365">                 try {</span>
<a href="#l15.366"></a><span id="l15.366">                     this.prepareStatement(this.mInsertRecurrence);</span>
<a href="#l15.367"></a><span id="l15.367">                     ap.item_id = item.id;</span>
<a href="#l15.368"></a><span id="l15.368" class="difflineminus">-                    ap.recur_index = i;</span>
<a href="#l15.369"></a><span id="l15.369" class="difflineminus">-                    ap.is_negative = ritem.isNegative;</span>
<a href="#l15.370"></a><span id="l15.370" class="difflineminus">-                    if (calInstanceOf(ritem, Components.interfaces.calIRecurrenceDate)) {</span>
<a href="#l15.371"></a><span id="l15.371" class="difflineminus">-                        ap.recur_type = &quot;x-date&quot;;</span>
<a href="#l15.372"></a><span id="l15.372" class="difflineminus">-                        ap.dates = dateToText(getInUtcOrKeepFloating(ritem.date));</span>
<a href="#l15.373"></a><span id="l15.373" class="difflineminus">-                    } else if (calInstanceOf(ritem, Components.interfaces.calIRecurrenceRule)) {</span>
<a href="#l15.374"></a><span id="l15.374" class="difflineminus">-                        ap.recur_type = ritem.type;</span>
<a href="#l15.375"></a><span id="l15.375" class="difflineminus">-</span>
<a href="#l15.376"></a><span id="l15.376" class="difflineminus">-                        if (ritem.isByCount) {</span>
<a href="#l15.377"></a><span id="l15.377" class="difflineminus">-                            ap.count = ritem.count;</span>
<a href="#l15.378"></a><span id="l15.378" class="difflineminus">-                        } else {</span>
<a href="#l15.379"></a><span id="l15.379" class="difflineminus">-                            ap.end_date = ritem.untilDate ? ritem.untilDate.nativeTime : null;</span>
<a href="#l15.380"></a><span id="l15.380" class="difflineminus">-                        }</span>
<a href="#l15.381"></a><span id="l15.381" class="difflineminus">-</span>
<a href="#l15.382"></a><span id="l15.382" class="difflineminus">-                        ap.interval = ritem.interval;</span>
<a href="#l15.383"></a><span id="l15.383" class="difflineminus">-</span>
<a href="#l15.384"></a><span id="l15.384" class="difflineminus">-                        var rtypes = [&quot;second&quot;,</span>
<a href="#l15.385"></a><span id="l15.385" class="difflineminus">-                                      &quot;minute&quot;,</span>
<a href="#l15.386"></a><span id="l15.386" class="difflineminus">-                                      &quot;hour&quot;,</span>
<a href="#l15.387"></a><span id="l15.387" class="difflineminus">-                                      &quot;day&quot;,</span>
<a href="#l15.388"></a><span id="l15.388" class="difflineminus">-                                      &quot;monthday&quot;,</span>
<a href="#l15.389"></a><span id="l15.389" class="difflineminus">-                                      &quot;yearday&quot;,</span>
<a href="#l15.390"></a><span id="l15.390" class="difflineminus">-                                      &quot;weekno&quot;,</span>
<a href="#l15.391"></a><span id="l15.391" class="difflineminus">-                                      &quot;month&quot;,</span>
<a href="#l15.392"></a><span id="l15.392" class="difflineminus">-                                      &quot;setpos&quot;];</span>
<a href="#l15.393"></a><span id="l15.393" class="difflineminus">-                        for (var j = 0; j &lt; rtypes.length; j++) {</span>
<a href="#l15.394"></a><span id="l15.394" class="difflineminus">-                            var comp = &quot;BY&quot; + rtypes[j].toUpperCase();</span>
<a href="#l15.395"></a><span id="l15.395" class="difflineminus">-                            var comps = ritem.getComponent(comp, {});</span>
<a href="#l15.396"></a><span id="l15.396" class="difflineminus">-                            if (comps &amp;&amp; comps.length &gt; 0) {</span>
<a href="#l15.397"></a><span id="l15.397" class="difflineminus">-                                var compstr = comps.join(&quot;,&quot;);</span>
<a href="#l15.398"></a><span id="l15.398" class="difflineminus">-                                ap[rtypes[j]] = compstr;</span>
<a href="#l15.399"></a><span id="l15.399" class="difflineminus">-                            }</span>
<a href="#l15.400"></a><span id="l15.400" class="difflineminus">-                        }</span>
<a href="#l15.401"></a><span id="l15.401" class="difflineminus">-                    } else {</span>
<a href="#l15.402"></a><span id="l15.402" class="difflineminus">-                        dump (&quot;##### Don't know how to serialize recurrence item &quot; + ritem + &quot;!\n&quot;);</span>
<a href="#l15.403"></a><span id="l15.403" class="difflineminus">-                    }</span>
<a href="#l15.404"></a><span id="l15.404" class="difflineminus">-</span>
<a href="#l15.405"></a><span id="l15.405" class="difflineplus">+                    ap.icalString = ritem.icalString;</span>
<a href="#l15.406"></a><span id="l15.406">                     this.mInsertRecurrence.executeStep();</span>
<a href="#l15.407"></a><span id="l15.407">                 } finally {</span>
<a href="#l15.408"></a><span id="l15.408">                     this.mInsertRecurrence.reset();</span>
<a href="#l15.409"></a><span id="l15.409">                 }</span>
<a href="#l15.410"></a><span id="l15.410">             }</span>
<a href="#l15.411"></a><span id="l15.411"> </span>
<a href="#l15.412"></a><span id="l15.412">             var exceptions = rec.getExceptionIds ({});</span>
<a href="#l15.413"></a><span id="l15.413">             if (exceptions.length &gt; 0) {</span>
<a href="#l15.414"></a><span id="l15.414" class="difflineat">@@ -2286,19 +2138,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l15.415"></a><span id="l15.415">         let attachments = item.getAttachments({});</span>
<a href="#l15.416"></a><span id="l15.416">         if (attachments &amp;&amp; attachments.length &gt; 0) {</span>
<a href="#l15.417"></a><span id="l15.417">             for each (let att in attachments) {</span>
<a href="#l15.418"></a><span id="l15.418">                 let ap = this.mInsertAttachment.params;</span>
<a href="#l15.419"></a><span id="l15.419">                 try {</span>
<a href="#l15.420"></a><span id="l15.420">                     this.prepareStatement(this.mInsertAttachment);</span>
<a href="#l15.421"></a><span id="l15.421">                     this.setDateParamHelper(ap, &quot;recurrence_id&quot;, item.recurrenceId);</span>
<a href="#l15.422"></a><span id="l15.422">                     ap.item_id = item.id;</span>
<a href="#l15.423"></a><span id="l15.423" class="difflineminus">-                    ap.data = (att.uri ? att.uri.spec : &quot;&quot;);</span>
<a href="#l15.424"></a><span id="l15.424" class="difflineminus">-                    ap.format_type = att.formatType;</span>
<a href="#l15.425"></a><span id="l15.425" class="difflineminus">-                    ap.encoding = att.encoding;</span>
<a href="#l15.426"></a><span id="l15.426" class="difflineplus">+                    ap.icalString = att.icalString;</span>
<a href="#l15.427"></a><span id="l15.427"> </span>
<a href="#l15.428"></a><span id="l15.428">                     this.mInsertAttachment.executeStep();</span>
<a href="#l15.429"></a><span id="l15.429">                 } finally {</span>
<a href="#l15.430"></a><span id="l15.430">                     this.mInsertAttachment.reset();</span>
<a href="#l15.431"></a><span id="l15.431">                 }</span>
<a href="#l15.432"></a><span id="l15.432">             }</span>
<a href="#l15.433"></a><span id="l15.433">             return CAL_ITEM_FLAG.HAS_ATTACHMENTS;</span>
<a href="#l15.434"></a><span id="l15.434">         }</span>
<a href="#l15.435"></a><span id="l15.435" class="difflineat">@@ -2309,18 +2159,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l15.436"></a><span id="l15.436">         let relations = item.getRelations({});</span>
<a href="#l15.437"></a><span id="l15.437">         if (relations &amp;&amp; relations.length &gt; 0) {</span>
<a href="#l15.438"></a><span id="l15.438">             for each (var rel in relations) {</span>
<a href="#l15.439"></a><span id="l15.439">                 let rp = this.mInsertRelation.params;</span>
<a href="#l15.440"></a><span id="l15.440">                 try {</span>
<a href="#l15.441"></a><span id="l15.441">                     this.prepareStatement(this.mInsertRelation);</span>
<a href="#l15.442"></a><span id="l15.442">                     this.setDateParamHelper(rp, &quot;recurrence_id&quot;, item.recurrenceId);</span>
<a href="#l15.443"></a><span id="l15.443">                     rp.item_id = item.id;</span>
<a href="#l15.444"></a><span id="l15.444" class="difflineminus">-                    rp.rel_type = rel.relType;</span>
<a href="#l15.445"></a><span id="l15.445" class="difflineminus">-                    rp.rel_id = rel.relId;</span>
<a href="#l15.446"></a><span id="l15.446" class="difflineplus">+                    rp.icalString = rel.icalString;</span>
<a href="#l15.447"></a><span id="l15.447"> </span>
<a href="#l15.448"></a><span id="l15.448">                     this.mInsertRelation.executeStep();</span>
<a href="#l15.449"></a><span id="l15.449">                 } finally {</span>
<a href="#l15.450"></a><span id="l15.450">                     this.mInsertRelation.reset();</span>
<a href="#l15.451"></a><span id="l15.451">                 }</span>
<a href="#l15.452"></a><span id="l15.452">             }</span>
<a href="#l15.453"></a><span id="l15.453">             return CAL_ITEM_FLAG.HAS_RELATIONS;</span>
<a href="#l15.454"></a><span id="l15.454">         }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/calendar/providers/storage/calStorageUpgrade.jsm</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/calendar/providers/storage/calStorageUpgrade.jsm</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -67,17 +67,17 @@</span>
<a href="#l16.4"></a><span id="l16.4">  */</span>
<a href="#l16.5"></a><span id="l16.5"> </span>
<a href="#l16.6"></a><span id="l16.6"> Components.utils.import(&quot;resource:///modules/Services.jsm&quot;);</span>
<a href="#l16.7"></a><span id="l16.7"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l16.8"></a><span id="l16.8"> Components.utils.import(&quot;resource://calendar/modules/calStorageHelpers.jsm&quot;);</span>
<a href="#l16.9"></a><span id="l16.9"> </span>
<a href="#l16.10"></a><span id="l16.10"> // The current database version. Be sure to increment this when you create a new</span>
<a href="#l16.11"></a><span id="l16.11"> // updater.</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-var DB_SCHEMA_VERSION = 21;</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+var DB_SCHEMA_VERSION = 22;</span>
<a href="#l16.14"></a><span id="l16.14"> </span>
<a href="#l16.15"></a><span id="l16.15"> var EXPORTED_SYMBOLS = [&quot;DB_SCHEMA_VERSION&quot;, &quot;getSql&quot;, &quot;getAllSql&quot;, &quot;getSqlTable&quot;, &quot;upgradeDB&quot;, &quot;backupDB&quot;];</span>
<a href="#l16.16"></a><span id="l16.16"> </span>
<a href="#l16.17"></a><span id="l16.17"> /**</span>
<a href="#l16.18"></a><span id="l16.18">  * Gets the SQL for the given table data and table name. This can be both a real</span>
<a href="#l16.19"></a><span id="l16.19">  * table or the name of an index. Indexes must contain the idx_ prefix.</span>
<a href="#l16.20"></a><span id="l16.20">  *</span>
<a href="#l16.21"></a><span id="l16.21">  * @param tblName       The name of the table or index to retrieve sql for</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineat">@@ -296,17 +296,16 @@ var commitTransaction = createDBDelegate</span>
<a href="#l16.23"></a><span id="l16.23"> var rollbackTransaction = createDBDelegate(&quot;rollbackTransaction&quot;);</span>
<a href="#l16.24"></a><span id="l16.24"> var createStatement = createDBDelegate(&quot;createStatement&quot;);</span>
<a href="#l16.25"></a><span id="l16.25"> var executeSimpleSQL = createDBDelegate(&quot;executeSimpleSQL&quot;);</span>
<a href="#l16.26"></a><span id="l16.26"> var removeFunction = createDBDelegate(&quot;removeFunction&quot;);</span>
<a href="#l16.27"></a><span id="l16.27"> var createFunction = createDBDelegate(&quot;createFunction&quot;);</span>
<a href="#l16.28"></a><span id="l16.28"> </span>
<a href="#l16.29"></a><span id="l16.29"> var lastErrorString = createDBDelegateGetter(&quot;lastErrorString&quot;);</span>
<a href="#l16.30"></a><span id="l16.30"> </span>
<a href="#l16.31"></a><span id="l16.31" class="difflineminus">-</span>
<a href="#l16.32"></a><span id="l16.32"> /**</span>
<a href="#l16.33"></a><span id="l16.33">  * Helper function to create an index on the database if it doesn't already</span>
<a href="#l16.34"></a><span id="l16.34">  * exist.</span>
<a href="#l16.35"></a><span id="l16.35">  *</span>
<a href="#l16.36"></a><span id="l16.36">  * @param tblData       The table data object to save the index in.</span>
<a href="#l16.37"></a><span id="l16.37">  * @param tblName       The name of the table to index.</span>
<a href="#l16.38"></a><span id="l16.38">  * @param colNameArray  An array of columns to index over.</span>
<a href="#l16.39"></a><span id="l16.39">  * @param db            (optional) The database to create the index on.</span>
<a href="#l16.40"></a><span id="l16.40" class="difflineat">@@ -579,16 +578,69 @@ function dropTable(tblData, tblName, db)</span>
<a href="#l16.41"></a><span id="l16.41">  * @param db            (optional) The database to apply the operation on.</span>
<a href="#l16.42"></a><span id="l16.42">  */</span>
<a href="#l16.43"></a><span id="l16.43"> function addTable(tblData, tblName, def, db) {</span>
<a href="#l16.44"></a><span id="l16.44">     tblData[tblName] = def;</span>
<a href="#l16.45"></a><span id="l16.45"> </span>
<a href="#l16.46"></a><span id="l16.46">     executeSimpleSQL(db, getSql(tblName, tblData));</span>
<a href="#l16.47"></a><span id="l16.47"> }</span>
<a href="#l16.48"></a><span id="l16.48"> </span>
<a href="#l16.49"></a><span id="l16.49" class="difflineplus">+/**</span>
<a href="#l16.50"></a><span id="l16.50" class="difflineplus">+ * Migrates the given columns to a single icalString, using the (previously</span>
<a href="#l16.51"></a><span id="l16.51" class="difflineplus">+ * created) user function for processing.</span>
<a href="#l16.52"></a><span id="l16.52" class="difflineplus">+ *</span>
<a href="#l16.53"></a><span id="l16.53" class="difflineplus">+ * @param tblData       The table data object to apply the operation on.</span>
<a href="#l16.54"></a><span id="l16.54" class="difflineplus">+ * @param tblName       The table name to migrate.</span>
<a href="#l16.55"></a><span id="l16.55" class="difflineplus">+ * @param userFuncName  The name of the user function to call for migration</span>
<a href="#l16.56"></a><span id="l16.56" class="difflineplus">+ * @param oldColumns    An array of columns to migrate to the new icalString</span>
<a href="#l16.57"></a><span id="l16.57" class="difflineplus">+ *                        column</span>
<a href="#l16.58"></a><span id="l16.58" class="difflineplus">+ * @param db            (optional) The database to apply the operation on.</span>
<a href="#l16.59"></a><span id="l16.59" class="difflineplus">+ */</span>
<a href="#l16.60"></a><span id="l16.60" class="difflineplus">+function migrateToIcalString(tblData, tblName, userFuncName, oldColumns, db) {</span>
<a href="#l16.61"></a><span id="l16.61" class="difflineplus">+    addColumn(tblData, tblName, [&quot;icalString&quot;], &quot;TEXT&quot;, db);</span>
<a href="#l16.62"></a><span id="l16.62" class="difflineplus">+    let updateSql =</span>
<a href="#l16.63"></a><span id="l16.63" class="difflineplus">+        &quot;UPDATE &quot; + tblName + &quot; &quot; +</span>
<a href="#l16.64"></a><span id="l16.64" class="difflineplus">+           &quot;SET icalString = &quot; + userFuncName + &quot;(&quot; + oldColumns.join(&quot;,&quot;) + &quot;)&quot;;</span>
<a href="#l16.65"></a><span id="l16.65" class="difflineplus">+    executeSimpleSQL(db, updateSql);</span>
<a href="#l16.66"></a><span id="l16.66" class="difflineplus">+    deleteColumns(tblData, tblName, oldColumns, db);</span>
<a href="#l16.67"></a><span id="l16.67" class="difflineplus">+</span>
<a href="#l16.68"></a><span id="l16.68" class="difflineplus">+    // If null was returned, its an invalid attendee. Make sure to remove them,</span>
<a href="#l16.69"></a><span id="l16.69" class="difflineplus">+    // they might break things later on.</span>
<a href="#l16.70"></a><span id="l16.70" class="difflineplus">+    let cleanupSql = &quot;DELETE FROM &quot; + tblName + &quot; WHERE icalString IS NULL&quot;;</span>
<a href="#l16.71"></a><span id="l16.71" class="difflineplus">+    executeSimpleSQL(db, cleanupSql);</span>
<a href="#l16.72"></a><span id="l16.72" class="difflineplus">+}</span>
<a href="#l16.73"></a><span id="l16.73" class="difflineplus">+</span>
<a href="#l16.74"></a><span id="l16.74" class="difflineplus">+/**</span>
<a href="#l16.75"></a><span id="l16.75" class="difflineplus">+ * Maps a mozIStorageValueArray to a JS array, converting types correctly.</span>
<a href="#l16.76"></a><span id="l16.76" class="difflineplus">+ *</span>
<a href="#l16.77"></a><span id="l16.77" class="difflineplus">+ * @param storArgs      The storage value array to convert</span>
<a href="#l16.78"></a><span id="l16.78" class="difflineplus">+ * @return              An array with the arguments as js values.</span>
<a href="#l16.79"></a><span id="l16.79" class="difflineplus">+ */</span>
<a href="#l16.80"></a><span id="l16.80" class="difflineplus">+function mapStorageArgs(storArgs) {</span>
<a href="#l16.81"></a><span id="l16.81" class="difflineplus">+    const mISVA = Components.interfaces.mozIStorageValueArray;</span>
<a href="#l16.82"></a><span id="l16.82" class="difflineplus">+    let mappedArgs = [];</span>
<a href="#l16.83"></a><span id="l16.83" class="difflineplus">+    for (let i = 0; i &lt; storArgs.numEntries; i++) {</span>
<a href="#l16.84"></a><span id="l16.84" class="difflineplus">+        switch(storArgs.getTypeOfIndex(i)) {</span>
<a href="#l16.85"></a><span id="l16.85" class="difflineplus">+            case mISVA.VALUE_TYPE_NULL: mappedArgs.push(null); break;</span>
<a href="#l16.86"></a><span id="l16.86" class="difflineplus">+            case mISVA.VALUE_TYPE_INTEGER:</span>
<a href="#l16.87"></a><span id="l16.87" class="difflineplus">+                mappedArgs.push(storArgs.getInt64(i));</span>
<a href="#l16.88"></a><span id="l16.88" class="difflineplus">+                break;</span>
<a href="#l16.89"></a><span id="l16.89" class="difflineplus">+            case mISVA.VALUE_TYPE_FLOAT:</span>
<a href="#l16.90"></a><span id="l16.90" class="difflineplus">+                mappedArgs.push(storArgs.getDouble(i));</span>
<a href="#l16.91"></a><span id="l16.91" class="difflineplus">+                break;</span>
<a href="#l16.92"></a><span id="l16.92" class="difflineplus">+            case mISVA.VALUE_TYPE_TEXT:</span>
<a href="#l16.93"></a><span id="l16.93" class="difflineplus">+            case mISVA.VALUE_TYPE_BLOB:</span>
<a href="#l16.94"></a><span id="l16.94" class="difflineplus">+                mappedArgs.push(storArgs.getUTF8String(i));</span>
<a href="#l16.95"></a><span id="l16.95" class="difflineplus">+                break;</span>
<a href="#l16.96"></a><span id="l16.96" class="difflineplus">+        }</span>
<a href="#l16.97"></a><span id="l16.97" class="difflineplus">+    }</span>
<a href="#l16.98"></a><span id="l16.98" class="difflineplus">+</span>
<a href="#l16.99"></a><span id="l16.99" class="difflineplus">+    return mappedArgs;</span>
<a href="#l16.100"></a><span id="l16.100" class="difflineplus">+}</span>
<a href="#l16.101"></a><span id="l16.101" class="difflineplus">+</span>
<a href="#l16.102"></a><span id="l16.102"> /** Object holding upgraders */</span>
<a href="#l16.103"></a><span id="l16.103"> var upgrade = {};</span>
<a href="#l16.104"></a><span id="l16.104"> </span>
<a href="#l16.105"></a><span id="l16.105"> /**</span>
<a href="#l16.106"></a><span id="l16.106">  * Returns the initial storage database schema. Note this is not the current</span>
<a href="#l16.107"></a><span id="l16.107">  * schema, it will be modified by the upgrade.vNN() functions. This function</span>
<a href="#l16.108"></a><span id="l16.108">  * returns the initial v1 with modifications from v2 applied.</span>
<a href="#l16.109"></a><span id="l16.109">  *</span>
<a href="#l16.110"></a><span id="l16.110" class="difflineat">@@ -1054,17 +1106,17 @@ upgrade.v16 = function upgrade_v16(db, v</span>
<a href="#l16.111"></a><span id="l16.111">     let tbl = upgrade.v15(version &lt; 15 &amp;&amp; db, version);</span>
<a href="#l16.112"></a><span id="l16.112">     LOGdb(db, &quot;Storage: Upgrading to v16&quot;);</span>
<a href="#l16.113"></a><span id="l16.113">     beginTransaction(db);</span>
<a href="#l16.114"></a><span id="l16.114">     try {</span>
<a href="#l16.115"></a><span id="l16.115">         createFunction(db, &quot;translateAlarm&quot;, 4, {</span>
<a href="#l16.116"></a><span id="l16.116">             onFunctionCall: function translateAlarm(storArgs) {</span>
<a href="#l16.117"></a><span id="l16.117">                 try {</span>
<a href="#l16.118"></a><span id="l16.118">                     let [aOffset, aRelated, aAlarmTime, aTzId] =</span>
<a href="#l16.119"></a><span id="l16.119" class="difflineminus">-                        [0,1,2,3].map(function(i) storArgs.getUTF8String(i));</span>
<a href="#l16.120"></a><span id="l16.120" class="difflineplus">+                        mapStorageArgs(storArgs);</span>
<a href="#l16.121"></a><span id="l16.121"> </span>
<a href="#l16.122"></a><span id="l16.122">                     let alarm = cal.createAlarm();</span>
<a href="#l16.123"></a><span id="l16.123">                     if (aOffset) {</span>
<a href="#l16.124"></a><span id="l16.124">                         alarm.related = parseInt(aRelated, 10) + 1;</span>
<a href="#l16.125"></a><span id="l16.125">                         alarm.offset = cal.createDuration();</span>
<a href="#l16.126"></a><span id="l16.126">                         alarm.offset.inSeconds = aOffset;</span>
<a href="#l16.127"></a><span id="l16.127">                     } else if (aAlarmTime) {</span>
<a href="#l16.128"></a><span id="l16.128">                         alarm.related = Components.interfaces.calIAlarm.ALARM_RELATED_ABSOLUTE;</span>
<a href="#l16.129"></a><span id="l16.129" class="difflineat">@@ -1385,8 +1437,199 @@ upgrade.v21 = function upgrade_v21(db, v</span>
<a href="#l16.130"></a><span id="l16.130">         }</span>
<a href="#l16.131"></a><span id="l16.131"> </span>
<a href="#l16.132"></a><span id="l16.132">         setDbVersionAndCommit(db, 21);</span>
<a href="#l16.133"></a><span id="l16.133">     } catch (e) {</span>
<a href="#l16.134"></a><span id="l16.134">         throw reportErrorAndRollback(db,e);</span>
<a href="#l16.135"></a><span id="l16.135">     }</span>
<a href="#l16.136"></a><span id="l16.136">     return tbl;</span>
<a href="#l16.137"></a><span id="l16.137"> }</span>
<a href="#l16.138"></a><span id="l16.138" class="difflineplus">+</span>
<a href="#l16.139"></a><span id="l16.139" class="difflineplus">+/**</span>
<a href="#l16.140"></a><span id="l16.140" class="difflineplus">+ * Bug 785733 - Move some properties to use icalString in database.</span>
<a href="#l16.141"></a><span id="l16.141" class="difflineplus">+ * Use the full icalString in attendees, attachments, relations and recurrence</span>
<a href="#l16.142"></a><span id="l16.142" class="difflineplus">+ * tables.</span>
<a href="#l16.143"></a><span id="l16.143" class="difflineplus">+ * r=mmecca, p=philipp</span>
<a href="#l16.144"></a><span id="l16.144" class="difflineplus">+ */</span>
<a href="#l16.145"></a><span id="l16.145" class="difflineplus">+upgrade.v22 = function upgrade_v22(db, version) {</span>
<a href="#l16.146"></a><span id="l16.146" class="difflineplus">+    let tbl = upgrade.v21(version &lt; 21 &amp;&amp; db, version);</span>
<a href="#l16.147"></a><span id="l16.147" class="difflineplus">+    LOGdb(db, &quot;Storage: Upgrading to v22&quot;);</span>
<a href="#l16.148"></a><span id="l16.148" class="difflineplus">+    beginTransaction(db);</span>
<a href="#l16.149"></a><span id="l16.149" class="difflineplus">+    try {</span>
<a href="#l16.150"></a><span id="l16.150" class="difflineplus">+        // Update attachments to using icalString directly</span>
<a href="#l16.151"></a><span id="l16.151" class="difflineplus">+        createFunction(db, &quot;translateAttachment&quot;, 3, {</span>
<a href="#l16.152"></a><span id="l16.152" class="difflineplus">+            onFunctionCall: function translateAttachment(storArgs) {</span>
<a href="#l16.153"></a><span id="l16.153" class="difflineplus">+                try {</span>
<a href="#l16.154"></a><span id="l16.154" class="difflineplus">+                    let [aData, aFmtType, aEncoding] = mapStorageArgs(storArgs);</span>
<a href="#l16.155"></a><span id="l16.155" class="difflineplus">+</span>
<a href="#l16.156"></a><span id="l16.156" class="difflineplus">+                    let attach = cal.createAttachment();</span>
<a href="#l16.157"></a><span id="l16.157" class="difflineplus">+                    attach.uri = cal.makeURL(aData);</span>
<a href="#l16.158"></a><span id="l16.158" class="difflineplus">+                    attach.formatType = aFmtType;</span>
<a href="#l16.159"></a><span id="l16.159" class="difflineplus">+                    attach.encoding = aEncoding;</span>
<a href="#l16.160"></a><span id="l16.160" class="difflineplus">+                    return attach.icalString;</span>
<a href="#l16.161"></a><span id="l16.161" class="difflineplus">+                } catch (e) {</span>
<a href="#l16.162"></a><span id="l16.162" class="difflineplus">+                    cal.ERROR(&quot;Error converting attachment: &quot; + e);</span>
<a href="#l16.163"></a><span id="l16.163" class="difflineplus">+                    throw e;</span>
<a href="#l16.164"></a><span id="l16.164" class="difflineplus">+                }</span>
<a href="#l16.165"></a><span id="l16.165" class="difflineplus">+            }</span>
<a href="#l16.166"></a><span id="l16.166" class="difflineplus">+        });</span>
<a href="#l16.167"></a><span id="l16.167" class="difflineplus">+        migrateToIcalString(tbl, &quot;cal_attachments&quot;, &quot;translateAttachment&quot;,</span>
<a href="#l16.168"></a><span id="l16.168" class="difflineplus">+                           [&quot;data&quot;, &quot;format_type&quot;, &quot;encoding&quot;], db);</span>
<a href="#l16.169"></a><span id="l16.169" class="difflineplus">+</span>
<a href="#l16.170"></a><span id="l16.170" class="difflineplus">+        // Update relations to using icalString directly</span>
<a href="#l16.171"></a><span id="l16.171" class="difflineplus">+        createFunction(db, &quot;translateRelation&quot;, 2, {</span>
<a href="#l16.172"></a><span id="l16.172" class="difflineplus">+            onFunctionCall: function translateAttachment(storArgs) {</span>
<a href="#l16.173"></a><span id="l16.173" class="difflineplus">+                try {</span>
<a href="#l16.174"></a><span id="l16.174" class="difflineplus">+                    let [aRelType, aRelId] = mapStorageArgs(storArgs);</span>
<a href="#l16.175"></a><span id="l16.175" class="difflineplus">+                    let relation = cal.createRelation();</span>
<a href="#l16.176"></a><span id="l16.176" class="difflineplus">+                    relation.relType = aRelType;</span>
<a href="#l16.177"></a><span id="l16.177" class="difflineplus">+                    relation.relId = aRelId;</span>
<a href="#l16.178"></a><span id="l16.178" class="difflineplus">+                    return relation.icalString;</span>
<a href="#l16.179"></a><span id="l16.179" class="difflineplus">+                } catch (e) {</span>
<a href="#l16.180"></a><span id="l16.180" class="difflineplus">+                    cal.ERROR(&quot;Error converting relation: &quot; + e);</span>
<a href="#l16.181"></a><span id="l16.181" class="difflineplus">+                    throw e;</span>
<a href="#l16.182"></a><span id="l16.182" class="difflineplus">+                }</span>
<a href="#l16.183"></a><span id="l16.183" class="difflineplus">+            }</span>
<a href="#l16.184"></a><span id="l16.184" class="difflineplus">+        });</span>
<a href="#l16.185"></a><span id="l16.185" class="difflineplus">+        migrateToIcalString(tbl, &quot;cal_relations&quot;, &quot;translateRelation&quot;,</span>
<a href="#l16.186"></a><span id="l16.186" class="difflineplus">+                           [&quot;rel_type&quot;, &quot;rel_id&quot;], db);</span>
<a href="#l16.187"></a><span id="l16.187" class="difflineplus">+</span>
<a href="#l16.188"></a><span id="l16.188" class="difflineplus">+        // Update attendees table to using icalString directly</span>
<a href="#l16.189"></a><span id="l16.189" class="difflineplus">+        createFunction(db, &quot;translateAttendee&quot;, 8, {</span>
<a href="#l16.190"></a><span id="l16.190" class="difflineplus">+            onFunctionCall: function translateAttachment(storArgs) {</span>
<a href="#l16.191"></a><span id="l16.191" class="difflineplus">+                try {</span>
<a href="#l16.192"></a><span id="l16.192" class="difflineplus">+                    let [aAttendeeId, aCommonName, aRsvp, aRole,</span>
<a href="#l16.193"></a><span id="l16.193" class="difflineplus">+                         aStatus, aType, aIsOrganizer, aProperties] =</span>
<a href="#l16.194"></a><span id="l16.194" class="difflineplus">+                         mapStorageArgs(storArgs);</span>
<a href="#l16.195"></a><span id="l16.195" class="difflineplus">+</span>
<a href="#l16.196"></a><span id="l16.196" class="difflineplus">+                    let attendee = cal.createAttendee();</span>
<a href="#l16.197"></a><span id="l16.197" class="difflineplus">+</span>
<a href="#l16.198"></a><span id="l16.198" class="difflineplus">+                    attendee.id = aAttendeeId;</span>
<a href="#l16.199"></a><span id="l16.199" class="difflineplus">+                    attendee.commonName = aCommonName;</span>
<a href="#l16.200"></a><span id="l16.200" class="difflineplus">+</span>
<a href="#l16.201"></a><span id="l16.201" class="difflineplus">+                    if (aRsvp === 0) attendee.rsvp = &quot;FALSE&quot;;</span>
<a href="#l16.202"></a><span id="l16.202" class="difflineplus">+                    if (aRsvp === 1) attendee.rsvp = &quot;TRUE&quot;;</span>
<a href="#l16.203"></a><span id="l16.203" class="difflineplus">+                    // default: keep undefined</span>
<a href="#l16.204"></a><span id="l16.204" class="difflineplus">+</span>
<a href="#l16.205"></a><span id="l16.205" class="difflineplus">+                    attendee.role = aRole;</span>
<a href="#l16.206"></a><span id="l16.206" class="difflineplus">+                    attendee.participationStatus = aStatus;</span>
<a href="#l16.207"></a><span id="l16.207" class="difflineplus">+                    attendee.userType = aType;</span>
<a href="#l16.208"></a><span id="l16.208" class="difflineplus">+                    attendee.isOrganizer = !!aIsOrganizer;</span>
<a href="#l16.209"></a><span id="l16.209" class="difflineplus">+                    if (aProperties) {</span>
<a href="#l16.210"></a><span id="l16.210" class="difflineplus">+                        for each (let pair in aProperties.split(&quot;,&quot;)) {</span>
<a href="#l16.211"></a><span id="l16.211" class="difflineplus">+                            let [key, value] = pair.split(&quot;:&quot;);</span>
<a href="#l16.212"></a><span id="l16.212" class="difflineplus">+                            attendee.setProperty(decodeURIComponent(key),</span>
<a href="#l16.213"></a><span id="l16.213" class="difflineplus">+                                                 decodeURIComponent(value));</span>
<a href="#l16.214"></a><span id="l16.214" class="difflineplus">+                        }</span>
<a href="#l16.215"></a><span id="l16.215" class="difflineplus">+                    }</span>
<a href="#l16.216"></a><span id="l16.216" class="difflineplus">+</span>
<a href="#l16.217"></a><span id="l16.217" class="difflineplus">+                    return attendee.icalString;</span>
<a href="#l16.218"></a><span id="l16.218" class="difflineplus">+                } catch (e) {</span>
<a href="#l16.219"></a><span id="l16.219" class="difflineplus">+                    // There are some attendees with a null ID. We are taking</span>
<a href="#l16.220"></a><span id="l16.220" class="difflineplus">+                    // the opportunity to remove them here.</span>
<a href="#l16.221"></a><span id="l16.221" class="difflineplus">+                    cal.ERROR(&quot;Error converting attendee, removing: &quot; + e);</span>
<a href="#l16.222"></a><span id="l16.222" class="difflineplus">+                    return null;</span>
<a href="#l16.223"></a><span id="l16.223" class="difflineplus">+                }</span>
<a href="#l16.224"></a><span id="l16.224" class="difflineplus">+            }</span>
<a href="#l16.225"></a><span id="l16.225" class="difflineplus">+        });</span>
<a href="#l16.226"></a><span id="l16.226" class="difflineplus">+        migrateToIcalString(tbl, &quot;cal_attendees&quot;, &quot;translateAttendee&quot;,</span>
<a href="#l16.227"></a><span id="l16.227" class="difflineplus">+                            [&quot;attendee_id&quot;, &quot;common_name&quot;, &quot;rsvp&quot;, &quot;role&quot;,</span>
<a href="#l16.228"></a><span id="l16.228" class="difflineplus">+                             &quot;status&quot;, &quot;type&quot;, &quot;is_organizer&quot;, &quot;properties&quot;], db);</span>
<a href="#l16.229"></a><span id="l16.229" class="difflineplus">+</span>
<a href="#l16.230"></a><span id="l16.230" class="difflineplus">+        // Update recurrence table to using icalString directly</span>
<a href="#l16.231"></a><span id="l16.231" class="difflineplus">+        createFunction(db, &quot;translateRecurrence&quot;, 17, {</span>
<a href="#l16.232"></a><span id="l16.232" class="difflineplus">+            onFunctionCall: function translateRecurrence(storArgs) {</span>
<a href="#l16.233"></a><span id="l16.233" class="difflineplus">+                try {</span>
<a href="#l16.234"></a><span id="l16.234" class="difflineplus">+                    let [aIndex, aType, aIsNegative, aDates, aCount,</span>
<a href="#l16.235"></a><span id="l16.235" class="difflineplus">+                         aEndDate, aInterval, aSecond, aMinute, aHour,</span>
<a href="#l16.236"></a><span id="l16.236" class="difflineplus">+                         aDay, aMonthday, aYearday, aWeekno, aMonth,</span>
<a href="#l16.237"></a><span id="l16.237" class="difflineplus">+                         aSetPos, aTmpFlags] = mapStorageArgs(storArgs);</span>
<a href="#l16.238"></a><span id="l16.238" class="difflineplus">+</span>
<a href="#l16.239"></a><span id="l16.239" class="difflineplus">+                    let ritem;</span>
<a href="#l16.240"></a><span id="l16.240" class="difflineplus">+                    if (aType == &quot;x-date&quot;) {</span>
<a href="#l16.241"></a><span id="l16.241" class="difflineplus">+                        ritem = Components.classes[&quot;@mozilla.org/calendar/recurrence-date;1&quot;]</span>
<a href="#l16.242"></a><span id="l16.242" class="difflineplus">+                                          .createInstance(Components.interfaces.calIRecurrenceDate);</span>
<a href="#l16.243"></a><span id="l16.243" class="difflineplus">+                        ritem.date = textToDate(aDates);</span>
<a href="#l16.244"></a><span id="l16.244" class="difflineplus">+                        ritem.isNegative = !!aIsNegative;</span>
<a href="#l16.245"></a><span id="l16.245" class="difflineplus">+                    } else {</span>
<a href="#l16.246"></a><span id="l16.246" class="difflineplus">+                        ritem = cal.createRecurrenceRule();</span>
<a href="#l16.247"></a><span id="l16.247" class="difflineplus">+                        ritem.type = aType;</span>
<a href="#l16.248"></a><span id="l16.248" class="difflineplus">+                        ritem.isNegative = !!aIsNegative;</span>
<a href="#l16.249"></a><span id="l16.249" class="difflineplus">+                        if (aCount) {</span>
<a href="#l16.250"></a><span id="l16.250" class="difflineplus">+                            try {</span>
<a href="#l16.251"></a><span id="l16.251" class="difflineplus">+                                ritem.count = aCount;</span>
<a href="#l16.252"></a><span id="l16.252" class="difflineplus">+                            } catch (exc) {</span>
<a href="#l16.253"></a><span id="l16.253" class="difflineplus">+                            }</span>
<a href="#l16.254"></a><span id="l16.254" class="difflineplus">+                        } else {</span>
<a href="#l16.255"></a><span id="l16.255" class="difflineplus">+                            if (aEndDate) {</span>
<a href="#l16.256"></a><span id="l16.256" class="difflineplus">+                                let allday = ((aTmpFlags &amp; CAL_ITEM_FLAG.EVENT_ALLDAY) != 0);</span>
<a href="#l16.257"></a><span id="l16.257" class="difflineplus">+                                let untilDate = newDateTime(aEndDate, allday ? &quot;&quot; : &quot;UTC&quot;);</span>
<a href="#l16.258"></a><span id="l16.258" class="difflineplus">+                                if (allday) {</span>
<a href="#l16.259"></a><span id="l16.259" class="difflineplus">+                                    untilDate.isDate = true;</span>
<a href="#l16.260"></a><span id="l16.260" class="difflineplus">+                                }</span>
<a href="#l16.261"></a><span id="l16.261" class="difflineplus">+                                ritem.untilDate = untilDate;</span>
<a href="#l16.262"></a><span id="l16.262" class="difflineplus">+                            } else {</span>
<a href="#l16.263"></a><span id="l16.263" class="difflineplus">+                                ritem.untilDate = null;</span>
<a href="#l16.264"></a><span id="l16.264" class="difflineplus">+                            }</span>
<a href="#l16.265"></a><span id="l16.265" class="difflineplus">+                        }</span>
<a href="#l16.266"></a><span id="l16.266" class="difflineplus">+                        try {</span>
<a href="#l16.267"></a><span id="l16.267" class="difflineplus">+                            ritem.interval = aInterval;</span>
<a href="#l16.268"></a><span id="l16.268" class="difflineplus">+                        } catch (exc) {</span>
<a href="#l16.269"></a><span id="l16.269" class="difflineplus">+                        }</span>
<a href="#l16.270"></a><span id="l16.270" class="difflineplus">+</span>
<a href="#l16.271"></a><span id="l16.271" class="difflineplus">+                        let rtypes = {</span>
<a href="#l16.272"></a><span id="l16.272" class="difflineplus">+                            SECOND: aSecond,</span>
<a href="#l16.273"></a><span id="l16.273" class="difflineplus">+                            MINUTE: aMinute,</span>
<a href="#l16.274"></a><span id="l16.274" class="difflineplus">+                            HOUR: aHour,</span>
<a href="#l16.275"></a><span id="l16.275" class="difflineplus">+                            DAY: aDay,</span>
<a href="#l16.276"></a><span id="l16.276" class="difflineplus">+                            MONTHDAY: aMonthday,</span>
<a href="#l16.277"></a><span id="l16.277" class="difflineplus">+                            YEARDAY: aYearday,</span>
<a href="#l16.278"></a><span id="l16.278" class="difflineplus">+                            WEEKNO: aWeekno,</span>
<a href="#l16.279"></a><span id="l16.279" class="difflineplus">+                            MONTH: aMonth,</span>
<a href="#l16.280"></a><span id="l16.280" class="difflineplus">+                            SETPOS: aSetPos</span>
<a href="#l16.281"></a><span id="l16.281" class="difflineplus">+                        };</span>
<a href="#l16.282"></a><span id="l16.282" class="difflineplus">+</span>
<a href="#l16.283"></a><span id="l16.283" class="difflineplus">+                        function parseInt10(x) parseInt(x, 10);</span>
<a href="#l16.284"></a><span id="l16.284" class="difflineplus">+                        for (let rtype in rtypes) {</span>
<a href="#l16.285"></a><span id="l16.285" class="difflineplus">+                            if (rtypes[rtype]) {</span>
<a href="#l16.286"></a><span id="l16.286" class="difflineplus">+                                let comp = &quot;BY&quot; + rtype;</span>
<a href="#l16.287"></a><span id="l16.287" class="difflineplus">+                                let rstr = rtypes[rtype].toString()</span>
<a href="#l16.288"></a><span id="l16.288" class="difflineplus">+                                let rarray = rstr.split(&quot;,&quot;).map(parseInt10);</span>
<a href="#l16.289"></a><span id="l16.289" class="difflineplus">+                                ritem.setComponent(comp, rarray.length, rarray);</span>
<a href="#l16.290"></a><span id="l16.290" class="difflineplus">+                            }</span>
<a href="#l16.291"></a><span id="l16.291" class="difflineplus">+                        }</span>
<a href="#l16.292"></a><span id="l16.292" class="difflineplus">+                    }</span>
<a href="#l16.293"></a><span id="l16.293" class="difflineplus">+</span>
<a href="#l16.294"></a><span id="l16.294" class="difflineplus">+                    return ritem.icalString;</span>
<a href="#l16.295"></a><span id="l16.295" class="difflineplus">+                } catch (e) {</span>
<a href="#l16.296"></a><span id="l16.296" class="difflineplus">+                    cal.ERROR(&quot;Error converting recurrence: &quot; + e);</span>
<a href="#l16.297"></a><span id="l16.297" class="difflineplus">+                    throw e;</span>
<a href="#l16.298"></a><span id="l16.298" class="difflineplus">+                }</span>
<a href="#l16.299"></a><span id="l16.299" class="difflineplus">+            }</span>
<a href="#l16.300"></a><span id="l16.300" class="difflineplus">+        });</span>
<a href="#l16.301"></a><span id="l16.301" class="difflineplus">+</span>
<a href="#l16.302"></a><span id="l16.302" class="difflineplus">+        // The old code relies on the item allday state, we need to temporarily</span>
<a href="#l16.303"></a><span id="l16.303" class="difflineplus">+        // copy this into the rec table so the above function can update easier.</span>
<a href="#l16.304"></a><span id="l16.304" class="difflineplus">+        // This column will be deleted during the migrateToIcalString call.</span>
<a href="#l16.305"></a><span id="l16.305" class="difflineplus">+        addColumn(tbl, &quot;cal_recurrence&quot;, [&quot;tmp_date_tz&quot;], &quot;&quot;, db);</span>
<a href="#l16.306"></a><span id="l16.306" class="difflineplus">+        executeSimpleSQL(db, &quot;UPDATE cal_recurrence SET tmp_date_tz = &quot; +</span>
<a href="#l16.307"></a><span id="l16.307" class="difflineplus">+                               &quot;(SELECT e.flags &quot; +</span>
<a href="#l16.308"></a><span id="l16.308" class="difflineplus">+                                  &quot;FROM cal_events AS e &quot; +</span>
<a href="#l16.309"></a><span id="l16.309" class="difflineplus">+                                 &quot;WHERE e.id = cal_recurrence.item_id &quot; +</span>
<a href="#l16.310"></a><span id="l16.310" class="difflineplus">+                                   &quot;AND e.cal_id = cal_recurrence.cal_id &quot; +</span>
<a href="#l16.311"></a><span id="l16.311" class="difflineplus">+                                 &quot;UNION &quot; +</span>
<a href="#l16.312"></a><span id="l16.312" class="difflineplus">+                                &quot;SELECT t.flags &quot; +</span>
<a href="#l16.313"></a><span id="l16.313" class="difflineplus">+                                  &quot;FROM cal_todos AS t &quot; +</span>
<a href="#l16.314"></a><span id="l16.314" class="difflineplus">+                                 &quot;WHERE t.id = cal_recurrence.item_id &quot; +</span>
<a href="#l16.315"></a><span id="l16.315" class="difflineplus">+                                   &quot;AND t.cal_id = cal_recurrence.cal_id)&quot;);</span>
<a href="#l16.316"></a><span id="l16.316" class="difflineplus">+</span>
<a href="#l16.317"></a><span id="l16.317" class="difflineplus">+        migrateToIcalString(tbl, &quot;cal_recurrence&quot;, &quot;translateRecurrence&quot;,</span>
<a href="#l16.318"></a><span id="l16.318" class="difflineplus">+                            [&quot;recur_index&quot;, &quot;recur_type&quot;, &quot;is_negative&quot;,</span>
<a href="#l16.319"></a><span id="l16.319" class="difflineplus">+                             &quot;dates&quot;, &quot;count&quot;, &quot;end_date&quot;, &quot;interval&quot;, &quot;second&quot;,</span>
<a href="#l16.320"></a><span id="l16.320" class="difflineplus">+                             &quot;minute&quot;, &quot;hour&quot;, &quot;day&quot;, &quot;monthday&quot;, &quot;yearday&quot;,</span>
<a href="#l16.321"></a><span id="l16.321" class="difflineplus">+                             &quot;weekno&quot;, &quot;month&quot;, &quot;setpos&quot;, &quot;tmp_date_tz&quot;], db);</span>
<a href="#l16.322"></a><span id="l16.322" class="difflineplus">+</span>
<a href="#l16.323"></a><span id="l16.323" class="difflineplus">+        setDbVersionAndCommit(db, 22);</span>
<a href="#l16.324"></a><span id="l16.324" class="difflineplus">+    } catch (e) {</span>
<a href="#l16.325"></a><span id="l16.325" class="difflineplus">+        throw reportErrorAndRollback(db, e);</span>
<a href="#l16.326"></a><span id="l16.326" class="difflineplus">+    }</span>
<a href="#l16.327"></a><span id="l16.327" class="difflineplus">+    return tbl;</span>
<a href="#l16.328"></a><span id="l16.328" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/calendar/test/unit/head_consts.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/calendar/test/unit/head_consts.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -180,8 +180,51 @@ function compareItemsSpecific(aLeftItem,</span>
<a href="#l17.4"></a><span id="l17.4">                       &quot;recurrenceStartDate&quot;];</span>
<a href="#l17.5"></a><span id="l17.5">     }</span>
<a href="#l17.6"></a><span id="l17.6">     for (var i = 0; i &lt; aPropArray.length; i++) {</span>
<a href="#l17.7"></a><span id="l17.7">         do_check_eq(getProps(aLeftItem, aPropArray[i]),</span>
<a href="#l17.8"></a><span id="l17.8">                     getProps(aRightItem,</span>
<a href="#l17.9"></a><span id="l17.9">                     aPropArray[i]));</span>
<a href="#l17.10"></a><span id="l17.10">     }</span>
<a href="#l17.11"></a><span id="l17.11"> }</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineplus">+</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+/**</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineplus">+ * Test whether specified function throws exception with expected</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineplus">+ * result.</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineplus">+ *</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineplus">+ * @param func</span>
<a href="#l17.18"></a><span id="l17.18" class="difflineplus">+ *        Function to be tested.</span>
<a href="#l17.19"></a><span id="l17.19" class="difflineplus">+ * @param result</span>
<a href="#l17.20"></a><span id="l17.20" class="difflineplus">+ *        Expected result. &lt;code&gt;null&lt;/code&gt; for no throws.</span>
<a href="#l17.21"></a><span id="l17.21" class="difflineplus">+ * @param stack</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineplus">+ *        Optional stack object to be printed. &lt;code&gt;null&lt;/code&gt; for</span>
<a href="#l17.23"></a><span id="l17.23" class="difflineplus">+ *        Components#stack#caller.</span>
<a href="#l17.24"></a><span id="l17.24" class="difflineplus">+ */</span>
<a href="#l17.25"></a><span id="l17.25" class="difflineplus">+function do_check_throws(func, result, stack)</span>
<a href="#l17.26"></a><span id="l17.26" class="difflineplus">+{</span>
<a href="#l17.27"></a><span id="l17.27" class="difflineplus">+  if (!stack)</span>
<a href="#l17.28"></a><span id="l17.28" class="difflineplus">+    stack = Components.stack.caller;</span>
<a href="#l17.29"></a><span id="l17.29" class="difflineplus">+</span>
<a href="#l17.30"></a><span id="l17.30" class="difflineplus">+  try {</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineplus">+    func();</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineplus">+  } catch (exc) {</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineplus">+    if (exc.result == result)</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineplus">+      return;</span>
<a href="#l17.35"></a><span id="l17.35" class="difflineplus">+    do_throw(&quot;expected result &quot; + result + &quot;, caught &quot; + exc, stack);</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineplus">+  }</span>
<a href="#l17.37"></a><span id="l17.37" class="difflineplus">+</span>
<a href="#l17.38"></a><span id="l17.38" class="difflineplus">+  if (result) {</span>
<a href="#l17.39"></a><span id="l17.39" class="difflineplus">+    do_throw(&quot;expected result &quot; + result + &quot;, none thrown&quot;, stack);</span>
<a href="#l17.40"></a><span id="l17.40" class="difflineplus">+  }</span>
<a href="#l17.41"></a><span id="l17.41" class="difflineplus">+}</span>
<a href="#l17.42"></a><span id="l17.42" class="difflineplus">+</span>
<a href="#l17.43"></a><span id="l17.43" class="difflineplus">+function ics_foldline(aLine) {</span>
<a href="#l17.44"></a><span id="l17.44" class="difflineplus">+  const NEWLINE_CHAR = &quot;\r\n&quot;;</span>
<a href="#l17.45"></a><span id="l17.45" class="difflineplus">+  const FOLD_LENGTH = 74;</span>
<a href="#l17.46"></a><span id="l17.46" class="difflineplus">+  let result = &quot;&quot;;</span>
<a href="#l17.47"></a><span id="l17.47" class="difflineplus">+  let line = aLine || &quot;&quot;;</span>
<a href="#l17.48"></a><span id="l17.48" class="difflineplus">+</span>
<a href="#l17.49"></a><span id="l17.49" class="difflineplus">+  while (line.length) {</span>
<a href="#l17.50"></a><span id="l17.50" class="difflineplus">+    result += NEWLINE_CHAR + &quot; &quot; + line.substr(0, FOLD_LENGTH);</span>
<a href="#l17.51"></a><span id="l17.51" class="difflineplus">+    line = line.substr(FOLD_LENGTH);</span>
<a href="#l17.52"></a><span id="l17.52" class="difflineplus">+  }</span>
<a href="#l17.53"></a><span id="l17.53" class="difflineplus">+  return result.substr(NEWLINE_CHAR.length + 1);</span>
<a href="#l17.54"></a><span id="l17.54" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1">new file mode 100644</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineminus">--- /dev/null</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineplus">+++ b/calendar/test/unit/test_ics_service.js</span>
<a href="#l18.4"></a><span id="l18.4" class="difflineat">@@ -0,0 +1,96 @@</span>
<a href="#l18.5"></a><span id="l18.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l18.6"></a><span id="l18.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l18.7"></a><span id="l18.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l18.8"></a><span id="l18.8" class="difflineplus">+</span>
<a href="#l18.9"></a><span id="l18.9" class="difflineplus">+function run_test() {</span>
<a href="#l18.10"></a><span id="l18.10" class="difflineplus">+    test_icsservice();</span>
<a href="#l18.11"></a><span id="l18.11" class="difflineplus">+    test_icalstring();</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineplus">+}</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineplus">+function test_icalstring() {</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineplus">+    function checkComp(createFunc, icalString, members, properties) {</span>
<a href="#l18.16"></a><span id="l18.16" class="difflineplus">+        let thing = createFunc(icalString);</span>
<a href="#l18.17"></a><span id="l18.17" class="difflineplus">+        do_check_eq(thing.icalString, ics_foldline(icalString) + &quot;\r\n&quot;);</span>
<a href="#l18.18"></a><span id="l18.18" class="difflineplus">+</span>
<a href="#l18.19"></a><span id="l18.19" class="difflineplus">+        if (members) {</span>
<a href="#l18.20"></a><span id="l18.20" class="difflineplus">+            for (let k in members) {</span>
<a href="#l18.21"></a><span id="l18.21" class="difflineplus">+                do_check_eq(thing[k], members[k]);</span>
<a href="#l18.22"></a><span id="l18.22" class="difflineplus">+            }</span>
<a href="#l18.23"></a><span id="l18.23" class="difflineplus">+        }</span>
<a href="#l18.24"></a><span id="l18.24" class="difflineplus">+</span>
<a href="#l18.25"></a><span id="l18.25" class="difflineplus">+        if (properties) {</span>
<a href="#l18.26"></a><span id="l18.26" class="difflineplus">+            for (let k in properties) {</span>
<a href="#l18.27"></a><span id="l18.27" class="difflineplus">+                if (&quot;getParameter&quot; in thing) {</span>
<a href="#l18.28"></a><span id="l18.28" class="difflineplus">+                    do_check_eq(thing.getParameter(k), properties[k]);</span>
<a href="#l18.29"></a><span id="l18.29" class="difflineplus">+                } else if (&quot;getProperty&quot; in thing) {</span>
<a href="#l18.30"></a><span id="l18.30" class="difflineplus">+                    do_check_eq(thing.getProperty(k), properties[k]);</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineplus">+                }</span>
<a href="#l18.32"></a><span id="l18.32" class="difflineplus">+            }</span>
<a href="#l18.33"></a><span id="l18.33" class="difflineplus">+        }</span>
<a href="#l18.34"></a><span id="l18.34" class="difflineplus">+        return thing;</span>
<a href="#l18.35"></a><span id="l18.35" class="difflineplus">+    }</span>
<a href="#l18.36"></a><span id="l18.36" class="difflineplus">+</span>
<a href="#l18.37"></a><span id="l18.37" class="difflineplus">+    let attach = checkComp(cal.createAttachment.bind(cal),</span>
<a href="#l18.38"></a><span id="l18.38" class="difflineplus">+                           &quot;ATTACH;ENCODING=BASE64;FMTTYPE=text/calendar;FILENAME=test.ics:http://example.com/test.ics&quot;,</span>
<a href="#l18.39"></a><span id="l18.39" class="difflineplus">+                           { formatType: &quot;text/calendar&quot;, encoding: &quot;BASE64&quot; },</span>
<a href="#l18.40"></a><span id="l18.40" class="difflineplus">+                           { FILENAME: &quot;test.ics&quot; });</span>
<a href="#l18.41"></a><span id="l18.41" class="difflineplus">+    do_check_eq(attach.uri.spec, &quot;http://example.com/test.ics&quot;);</span>
<a href="#l18.42"></a><span id="l18.42" class="difflineplus">+</span>
<a href="#l18.43"></a><span id="l18.43" class="difflineplus">+    checkComp(cal.createAttendee.bind(cal),</span>
<a href="#l18.44"></a><span id="l18.44" class="difflineplus">+              &quot;ATTENDEE;RSVP=TRUE;CN=Name;PARTSTAT=ACCEPTED;CUTYPE=RESOURCE;ROLE=REQ-PARTICIPANT;X-THING=BAR:mailto:test@example.com&quot;,</span>
<a href="#l18.45"></a><span id="l18.45" class="difflineplus">+              { id: &quot;mailto:test@example.com&quot;, commonName: &quot;Name&quot;, rsvp: &quot;TRUE&quot;,</span>
<a href="#l18.46"></a><span id="l18.46" class="difflineplus">+                isOrganizer: false, role: &quot;REQ-PARTICIPANT&quot;, participationStatus: &quot;ACCEPTED&quot;,</span>
<a href="#l18.47"></a><span id="l18.47" class="difflineplus">+                userType: &quot;RESOURCE&quot; },</span>
<a href="#l18.48"></a><span id="l18.48" class="difflineplus">+              { &quot;X-THING&quot;: &quot;BAR&quot; });</span>
<a href="#l18.49"></a><span id="l18.49" class="difflineplus">+</span>
<a href="#l18.50"></a><span id="l18.50" class="difflineplus">+    checkComp(cal.createRelation.bind(cal),</span>
<a href="#l18.51"></a><span id="l18.51" class="difflineplus">+              &quot;RELATED-TO;RELTYPE=SIBLING;FOO=BAR:VALUE&quot;,</span>
<a href="#l18.52"></a><span id="l18.52" class="difflineplus">+              { relType: &quot;SIBLING&quot;, relId: &quot;VALUE&quot; },</span>
<a href="#l18.53"></a><span id="l18.53" class="difflineplus">+              { FOO: &quot;BAR&quot; });</span>
<a href="#l18.54"></a><span id="l18.54" class="difflineplus">+</span>
<a href="#l18.55"></a><span id="l18.55" class="difflineplus">+    let rrule = checkComp(cal.createRecurrenceRule.bind(cal),</span>
<a href="#l18.56"></a><span id="l18.56" class="difflineplus">+                          &quot;RRULE:FREQ=WEEKLY;COUNT=5;INTERVAL=2;BYDAY=MO&quot;,</span>
<a href="#l18.57"></a><span id="l18.57" class="difflineplus">+                          { count: 5, isByCount: true, type: &quot;WEEKLY&quot;, interval: 2 });</span>
<a href="#l18.58"></a><span id="l18.58" class="difflineplus">+    do_check_eq(rrule.getComponent(&quot;BYDAY&quot;, {}).toString(), [2].toString());</span>
<a href="#l18.59"></a><span id="l18.59" class="difflineplus">+</span>
<a href="#l18.60"></a><span id="l18.60" class="difflineplus">+    let rdate = checkComp(cal.createRecurrenceDate.bind(cal),</span>
<a href="#l18.61"></a><span id="l18.61" class="difflineplus">+                          &quot;RDATE;VALUE=DATE-TIME:20120101T000000&quot;,</span>
<a href="#l18.62"></a><span id="l18.62" class="difflineplus">+                          { isNegative: false });</span>
<a href="#l18.63"></a><span id="l18.63" class="difflineplus">+    do_check_eq(rdate.date.compare(cal.createDateTime(&quot;20120101T000000&quot;)), 0);</span>
<a href="#l18.64"></a><span id="l18.64" class="difflineplus">+</span>
<a href="#l18.65"></a><span id="l18.65" class="difflineplus">+    let exdate = checkComp(cal.createRecurrenceDate.bind(cal),</span>
<a href="#l18.66"></a><span id="l18.66" class="difflineplus">+                           &quot;EXDATE:20120101T000000&quot;,</span>
<a href="#l18.67"></a><span id="l18.67" class="difflineplus">+                           { isNegative: true });</span>
<a href="#l18.68"></a><span id="l18.68" class="difflineplus">+    do_check_eq(rdate.date.compare(cal.createDateTime(&quot;20120101T000000&quot;)), 0);</span>
<a href="#l18.69"></a><span id="l18.69" class="difflineplus">+}</span>
<a href="#l18.70"></a><span id="l18.70" class="difflineplus">+</span>
<a href="#l18.71"></a><span id="l18.71" class="difflineplus">+function test_icsservice() {</span>
<a href="#l18.72"></a><span id="l18.72" class="difflineplus">+    let svc = cal.getIcsService();</span>
<a href="#l18.73"></a><span id="l18.73" class="difflineplus">+</span>
<a href="#l18.74"></a><span id="l18.74" class="difflineplus">+    function checkProp(createFunc, icalString, members, parameters) {</span>
<a href="#l18.75"></a><span id="l18.75" class="difflineplus">+        let thing = createFunc(icalString);</span>
<a href="#l18.76"></a><span id="l18.76" class="difflineplus">+        do_check_eq(thing.icalString, ics_foldline(icalString) + &quot;\r\n&quot;);</span>
<a href="#l18.77"></a><span id="l18.77" class="difflineplus">+</span>
<a href="#l18.78"></a><span id="l18.78" class="difflineplus">+        for (let k in members) {</span>
<a href="#l18.79"></a><span id="l18.79" class="difflineplus">+            do_check_eq(thing[k], members[k]);</span>
<a href="#l18.80"></a><span id="l18.80" class="difflineplus">+        }</span>
<a href="#l18.81"></a><span id="l18.81" class="difflineplus">+</span>
<a href="#l18.82"></a><span id="l18.82" class="difflineplus">+        for (let k in parameters) {</span>
<a href="#l18.83"></a><span id="l18.83" class="difflineplus">+            do_check_eq(thing.getParameter(k), parameters[k]);</span>
<a href="#l18.84"></a><span id="l18.84" class="difflineplus">+        }</span>
<a href="#l18.85"></a><span id="l18.85" class="difflineplus">+        return thing;</span>
<a href="#l18.86"></a><span id="l18.86" class="difflineplus">+    }</span>
<a href="#l18.87"></a><span id="l18.87" class="difflineplus">+</span>
<a href="#l18.88"></a><span id="l18.88" class="difflineplus">+    // Test ::createIcalPropertyFromString</span>
<a href="#l18.89"></a><span id="l18.89" class="difflineplus">+    checkProp(svc.createIcalPropertyFromString.bind(svc),</span>
<a href="#l18.90"></a><span id="l18.90" class="difflineplus">+              &quot;ATTACH;ENCODING=BASE64;FMTTYPE=text/calendar;FILENAME=test.ics:http://example.com/test.ics&quot;,</span>
<a href="#l18.91"></a><span id="l18.91" class="difflineplus">+              { value: &quot;http://example.com/test.ics&quot;, propertyName: &quot;ATTACH&quot; },</span>
<a href="#l18.92"></a><span id="l18.92" class="difflineplus">+              { ENCODING: &quot;BASE64&quot;, FMTTYPE: &quot;text/calendar&quot;, FILENAME: &quot;test.ics&quot; });</span>
<a href="#l18.93"></a><span id="l18.93" class="difflineplus">+</span>
<a href="#l18.94"></a><span id="l18.94" class="difflineplus">+    // Test ::createIcalProperty</span>
<a href="#l18.95"></a><span id="l18.95" class="difflineplus">+    let attach2 = svc.createIcalProperty(&quot;ATTACH&quot;);</span>
<a href="#l18.96"></a><span id="l18.96" class="difflineplus">+    do_check_eq(attach2.propertyName, &quot;ATTACH&quot;);</span>
<a href="#l18.97"></a><span id="l18.97" class="difflineplus">+    do_check_throws(function() {</span>
<a href="#l18.98"></a><span id="l18.98" class="difflineplus">+        attach2.value;</span>
<a href="#l18.99"></a><span id="l18.99" class="difflineplus">+    }, Components.results.NS_ERROR_FAILURE);</span>
<a href="#l18.100"></a><span id="l18.100" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1">new file mode 100644</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineminus">--- /dev/null</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineplus">+++ b/calendar/test/unit/test_storage.js</span>
<a href="#l19.4"></a><span id="l19.4" class="difflineat">@@ -0,0 +1,102 @@</span>
<a href="#l19.5"></a><span id="l19.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l19.6"></a><span id="l19.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l19.7"></a><span id="l19.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l19.8"></a><span id="l19.8" class="difflineplus">+</span>
<a href="#l19.9"></a><span id="l19.9" class="difflineplus">+function run_test() {</span>
<a href="#l19.10"></a><span id="l19.10" class="difflineplus">+    testAttachRoundtrip();</span>
<a href="#l19.11"></a><span id="l19.11" class="difflineplus">+}</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineplus">+</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+function testAttachRoundtrip() {</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineplus">+    let storage = getStorageCal();</span>
<a href="#l19.15"></a><span id="l19.15" class="difflineplus">+    let str = [&quot;BEGIN:VEVENT&quot;,</span>
<a href="#l19.16"></a><span id="l19.16" class="difflineplus">+               &quot;UID:attachItem&quot;,</span>
<a href="#l19.17"></a><span id="l19.17" class="difflineplus">+               &quot;DTSTART:20120101T010101Z&quot;,</span>
<a href="#l19.18"></a><span id="l19.18" class="difflineplus">+               &quot;ATTACH;FMTTYPE=text/calendar;ENCODING=BASE64;FILENAME=test.ics:http://example.com/test.ics&quot;,</span>
<a href="#l19.19"></a><span id="l19.19" class="difflineplus">+               &quot;ATTENDEE;RSVP=TRUE;CUTYPE=INDIVIDUAL;CN=Name;PARTSTAT=ACCEPTED;ROLE=REQ-PARTICIPANT;X-THING=BAR:mailto:test@example.com&quot;,</span>
<a href="#l19.20"></a><span id="l19.20" class="difflineplus">+               &quot;RELATED-TO;RELTYPE=SIBLING;FOO=BAR:VALUE&quot;,</span>
<a href="#l19.21"></a><span id="l19.21" class="difflineplus">+               &quot;RRULE:FREQ=MONTHLY;INTERVAL=2;COUNT=5;BYDAY=MO&quot;,</span>
<a href="#l19.22"></a><span id="l19.22" class="difflineplus">+               &quot;RDATE:20120201T010101Z&quot;,</span>
<a href="#l19.23"></a><span id="l19.23" class="difflineplus">+               &quot;EXDATE:20120301T010101Z&quot;,</span>
<a href="#l19.24"></a><span id="l19.24" class="difflineplus">+               &quot;END:VEVENT&quot;].join(&quot;\r\n&quot;);</span>
<a href="#l19.25"></a><span id="l19.25" class="difflineplus">+</span>
<a href="#l19.26"></a><span id="l19.26" class="difflineplus">+    let item = createEventFromIcalString(str);</span>
<a href="#l19.27"></a><span id="l19.27" class="difflineplus">+</span>
<a href="#l19.28"></a><span id="l19.28" class="difflineplus">+    do_test_pending();</span>
<a href="#l19.29"></a><span id="l19.29" class="difflineplus">+    storage.addItem(item, {</span>
<a href="#l19.30"></a><span id="l19.30" class="difflineplus">+        onOperationComplete: function checkAddedItem(c, s, o, i, addedItem) {</span>
<a href="#l19.31"></a><span id="l19.31" class="difflineplus">+            do_execute_soon(function() {</span>
<a href="#l19.32"></a><span id="l19.32" class="difflineplus">+                // Make sure the cache is cleared, otherwise we'll get the cached item.</span>
<a href="#l19.33"></a><span id="l19.33" class="difflineplus">+                delete storage.wrappedJSObject.mItemCache[addedItem.id];</span>
<a href="#l19.34"></a><span id="l19.34" class="difflineplus">+                storage.getItem(addedItem.id, retrieveItem);</span>
<a href="#l19.35"></a><span id="l19.35" class="difflineplus">+            });</span>
<a href="#l19.36"></a><span id="l19.36" class="difflineplus">+        }</span>
<a href="#l19.37"></a><span id="l19.37" class="difflineplus">+    });</span>
<a href="#l19.38"></a><span id="l19.38" class="difflineplus">+</span>
<a href="#l19.39"></a><span id="l19.39" class="difflineplus">+    let retrieveItem = {</span>
<a href="#l19.40"></a><span id="l19.40" class="difflineplus">+        found: false,</span>
<a href="#l19.41"></a><span id="l19.41" class="difflineplus">+        onGetResult: function(c, s, t, d, c, items) {</span>
<a href="#l19.42"></a><span id="l19.42" class="difflineplus">+            let item = items[0];</span>
<a href="#l19.43"></a><span id="l19.43" class="difflineplus">+</span>
<a href="#l19.44"></a><span id="l19.44" class="difflineplus">+            // Check start date</span>
<a href="#l19.45"></a><span id="l19.45" class="difflineplus">+            do_check_eq(item.startDate.compare(cal.createDateTime(&quot;20120101T010101Z&quot;)), 0);</span>
<a href="#l19.46"></a><span id="l19.46" class="difflineplus">+</span>
<a href="#l19.47"></a><span id="l19.47" class="difflineplus">+            // Check attachment</span>
<a href="#l19.48"></a><span id="l19.48" class="difflineplus">+            let attaches = item.getAttachments({});</span>
<a href="#l19.49"></a><span id="l19.49" class="difflineplus">+            let attach = attaches[0];</span>
<a href="#l19.50"></a><span id="l19.50" class="difflineplus">+            do_check_eq(attaches.length, 1);</span>
<a href="#l19.51"></a><span id="l19.51" class="difflineplus">+            do_check_eq(attach.uri.spec, &quot;http://example.com/test.ics&quot;);</span>
<a href="#l19.52"></a><span id="l19.52" class="difflineplus">+            do_check_eq(attach.formatType, &quot;text/calendar&quot;);</span>
<a href="#l19.53"></a><span id="l19.53" class="difflineplus">+            do_check_eq(attach.encoding, &quot;BASE64&quot;);</span>
<a href="#l19.54"></a><span id="l19.54" class="difflineplus">+            do_check_eq(attach.getParameter(&quot;FILENAME&quot;), &quot;test.ics&quot;);</span>
<a href="#l19.55"></a><span id="l19.55" class="difflineplus">+</span>
<a href="#l19.56"></a><span id="l19.56" class="difflineplus">+            // Check attendee</span>
<a href="#l19.57"></a><span id="l19.57" class="difflineplus">+            let attendees = item.getAttendees({});</span>
<a href="#l19.58"></a><span id="l19.58" class="difflineplus">+            let attendee = attendees[0];</span>
<a href="#l19.59"></a><span id="l19.59" class="difflineplus">+            do_check_eq(attendees.length, 1);</span>
<a href="#l19.60"></a><span id="l19.60" class="difflineplus">+            do_check_eq(attendee.id, &quot;mailto:test@example.com&quot;);</span>
<a href="#l19.61"></a><span id="l19.61" class="difflineplus">+            do_check_eq(attendee.commonName, &quot;Name&quot;);</span>
<a href="#l19.62"></a><span id="l19.62" class="difflineplus">+            do_check_eq(attendee.rsvp, &quot;TRUE&quot;);</span>
<a href="#l19.63"></a><span id="l19.63" class="difflineplus">+            do_check_eq(attendee.isOrganizer, false);</span>
<a href="#l19.64"></a><span id="l19.64" class="difflineplus">+            do_check_eq(attendee.role, &quot;REQ-PARTICIPANT&quot;);</span>
<a href="#l19.65"></a><span id="l19.65" class="difflineplus">+            do_check_eq(attendee.participationStatus, &quot;ACCEPTED&quot;);</span>
<a href="#l19.66"></a><span id="l19.66" class="difflineplus">+            do_check_eq(attendee.userType, &quot;INDIVIDUAL&quot;);</span>
<a href="#l19.67"></a><span id="l19.67" class="difflineplus">+            do_check_eq(attendee.getProperty(&quot;X-THING&quot;), &quot;BAR&quot;);</span>
<a href="#l19.68"></a><span id="l19.68" class="difflineplus">+</span>
<a href="#l19.69"></a><span id="l19.69" class="difflineplus">+            // Check relation</span>
<a href="#l19.70"></a><span id="l19.70" class="difflineplus">+            let relations = item.getRelations({});</span>
<a href="#l19.71"></a><span id="l19.71" class="difflineplus">+            let rel = relations[0];</span>
<a href="#l19.72"></a><span id="l19.72" class="difflineplus">+            do_check_eq(relations.length, 1);</span>
<a href="#l19.73"></a><span id="l19.73" class="difflineplus">+            do_check_eq(rel.relType, &quot;SIBLING&quot;);</span>
<a href="#l19.74"></a><span id="l19.74" class="difflineplus">+            do_check_eq(rel.relId, &quot;VALUE&quot;);</span>
<a href="#l19.75"></a><span id="l19.75" class="difflineplus">+            do_check_eq(rel.getParameter(&quot;FOO&quot;), &quot;BAR&quot;);</span>
<a href="#l19.76"></a><span id="l19.76" class="difflineplus">+</span>
<a href="#l19.77"></a><span id="l19.77" class="difflineplus">+            // Check recurrence item</span>
<a href="#l19.78"></a><span id="l19.78" class="difflineplus">+            for each (let ritem in item.recurrenceInfo.getRecurrenceItems({})) {</span>
<a href="#l19.79"></a><span id="l19.79" class="difflineplus">+                if (ritem instanceof Components.interfaces.calIRecurrenceRule) {</span>
<a href="#l19.80"></a><span id="l19.80" class="difflineplus">+                    do_check_eq(ritem.type, &quot;MONTHLY&quot;);</span>
<a href="#l19.81"></a><span id="l19.81" class="difflineplus">+                    do_check_eq(ritem.interval, 2);</span>
<a href="#l19.82"></a><span id="l19.82" class="difflineplus">+                    do_check_eq(ritem.count, 5);</span>
<a href="#l19.83"></a><span id="l19.83" class="difflineplus">+                    do_check_eq(ritem.isByCount, true);</span>
<a href="#l19.84"></a><span id="l19.84" class="difflineplus">+                    do_check_eq(ritem.getComponent(&quot;BYDAY&quot;, {}).toString(), [2].toString());</span>
<a href="#l19.85"></a><span id="l19.85" class="difflineplus">+                    do_check_eq(ritem.isNegative, false);</span>
<a href="#l19.86"></a><span id="l19.86" class="difflineplus">+                } else if (ritem instanceof Components.interfaces.calIRecurrenceDate) {</span>
<a href="#l19.87"></a><span id="l19.87" class="difflineplus">+                    if (ritem.isNegative) {</span>
<a href="#l19.88"></a><span id="l19.88" class="difflineplus">+                        do_check_eq(ritem.date.compare(cal.createDateTime(&quot;20120301T010101Z&quot;)), 0);</span>
<a href="#l19.89"></a><span id="l19.89" class="difflineplus">+                    } else {</span>
<a href="#l19.90"></a><span id="l19.90" class="difflineplus">+                        do_check_eq(ritem.date.compare(cal.createDateTime(&quot;20120201T010101Z&quot;)), 0);</span>
<a href="#l19.91"></a><span id="l19.91" class="difflineplus">+                    }</span>
<a href="#l19.92"></a><span id="l19.92" class="difflineplus">+                } else {</span>
<a href="#l19.93"></a><span id="l19.93" class="difflineplus">+                    do_throw(&quot;Found unknown recurrence item &quot; + ritem);</span>
<a href="#l19.94"></a><span id="l19.94" class="difflineplus">+                }</span>
<a href="#l19.95"></a><span id="l19.95" class="difflineplus">+            }</span>
<a href="#l19.96"></a><span id="l19.96" class="difflineplus">+</span>
<a href="#l19.97"></a><span id="l19.97" class="difflineplus">+            this.found = true;</span>
<a href="#l19.98"></a><span id="l19.98" class="difflineplus">+        },</span>
<a href="#l19.99"></a><span id="l19.99" class="difflineplus">+        onOperationComplete: function() {</span>
<a href="#l19.100"></a><span id="l19.100" class="difflineplus">+            if (!this.found) {</span>
<a href="#l19.101"></a><span id="l19.101" class="difflineplus">+                do_throw(&quot;Could not find item&quot;);</span>
<a href="#l19.102"></a><span id="l19.102" class="difflineplus">+            }</span>
<a href="#l19.103"></a><span id="l19.103" class="difflineplus">+            do_test_finished();</span>
<a href="#l19.104"></a><span id="l19.104" class="difflineplus">+        }</span>
<a href="#l19.105"></a><span id="l19.105" class="difflineplus">+    };</span>
<a href="#l19.106"></a><span id="l19.106" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/calendar/test/unit/xpcshell.ini</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/calendar/test/unit/xpcshell.ini</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -16,17 +16,19 @@ tail =</span>
<a href="#l20.4"></a><span id="l20.4"> [test_bug653924.js]</span>
<a href="#l20.5"></a><span id="l20.5"> [test_bug668222.js]</span>
<a href="#l20.6"></a><span id="l20.6"> [test_bug759324.js]</span>
<a href="#l20.7"></a><span id="l20.7"> [test_datetime.js]</span>
<a href="#l20.8"></a><span id="l20.8"> [test_datetime_before_1970.js]</span>
<a href="#l20.9"></a><span id="l20.9"> [test_freebusy.js]</span>
<a href="#l20.10"></a><span id="l20.10"> [test_hashedarray.js]</span>
<a href="#l20.11"></a><span id="l20.11"> [test_ics.js]</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineplus">+[test_ics_service.js]</span>
<a href="#l20.13"></a><span id="l20.13"> [test_providers.js]</span>
<a href="#l20.14"></a><span id="l20.14"> [test_recur.js]</span>
<a href="#l20.15"></a><span id="l20.15"> [test_relation.js]</span>
<a href="#l20.16"></a><span id="l20.16" class="difflineplus">+[test_storage.js]</span>
<a href="#l20.17"></a><span id="l20.17"> [test_calmgr.js]</span>
<a href="#l20.18"></a><span id="l20.18"> [test_deleted_items.js]</span>
<a href="#l20.19"></a><span id="l20.19"> </span>
<a href="#l20.20"></a><span id="l20.20"> # Bug 680201 Skip this test because it doesn't work properly yet.</span>
<a href="#l20.21"></a><span id="l20.21"> [test_webcal.js]</span>
<a href="#l20.22"></a><span id="l20.22"> skip-if = true</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

