<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 17935:ee0620ac1185699823a4665e732b22b96c8c0071</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ ee0620ac1185699823a4665e732b22b96c8c0071" />
<meta property="og:url" content="/comm-central/rev/ee0620ac1185699823a4665e732b22b96c8c0071" />
<meta property="og:description" content="Bug 1049591 - Fix lots of Calendar strict warnings. r=redDragon" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / ee0620ac1185699823a4665e732b22b96c8c0071 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/ee0620ac1185699823a4665e732b22b96c8c0071">shortlog</a> |
<a href="/comm-central/log/ee0620ac1185699823a4665e732b22b96c8c0071">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/ee0620ac1185699823a4665e732b22b96c8c0071">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/ee0620ac1185699823a4665e732b22b96c8c0071">files</a> |
changeset |
<a href="/comm-central/raw-rev/ee0620ac1185699823a4665e732b22b96c8c0071">raw</a>  | <a href="/comm-central/archive/ee0620ac1185699823a4665e732b22b96c8c0071.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1049591">Bug 1049591</a> - Fix lots of Calendar strict warnings. r=redDragon
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#80;&#104;&#105;&#108;&#105;&#112;&#112;&#32;&#75;&#101;&#119;&#105;&#115;&#99;&#104;&#32;&#60;&#109;&#111;&#122;&#105;&#108;&#108;&#97;&#64;&#107;&#101;&#119;&#105;&#115;&#46;&#99;&#104;&#62;</td></tr>
<tr><td></td><td class="date age">Sat, 09 May 2015 15:05:42 +0200</td></tr>

<tr>
 <td>changeset 17935</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/ee0620ac1185699823a4665e732b22b96c8c0071">ee0620ac1185699823a4665e732b22b96c8c0071</a></td>
</tr>



<tr>
<td>parent 17934</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/1bf87d31938fd6e6e64b5a78aaaf17c6c0f25a07">1bf87d31938fd6e6e64b5a78aaaf17c6c0f25a07</a>
</td>
</tr>

<tr>
<td>child 17936</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/18c1c077059f48eae410971b26b03a9efffff330">18c1c077059f48eae410971b26b03a9efffff330</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=ee0620ac1185699823a4665e732b22b96c8c0071">11027</a></td></tr>
<tr><td>push user</td><td>aleth@instantbird.org</td></tr>
<tr><td>push date</td><td class="date age">Wed, 13 May 2015 21:59:05 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@18c1c077059f [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=18c1c077059f48eae410971b26b03a9efffff330">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=18c1c077059f48eae410971b26b03a9efffff330&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=18c1c077059f48eae410971b26b03a9efffff330&newProject=comm-central&newRevision=1bf87d31938fd6e6e64b5a78aaaf17c6c0f25a07&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=18c1c077059f48eae410971b26b03a9efffff330&newProject=comm-central&newRevision=1bf87d31938fd6e6e64b5a78aaaf17c6c0f25a07&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=18c1c077059f48eae410971b26b03a9efffff330&newProject=comm-central&newRevision=1bf87d31938fd6e6e64b5a78aaaf17c6c0f25a07&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28redDragon%29&revcount=50">redDragon</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1049591">1049591</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1049591">Bug 1049591</a> - Fix lots of Calendar strict warnings. r=redDragon</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/backend/icaljs/calICSService.js">calendar/base/backend/icaljs/calICSService.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/backend/icaljs/calICSService.js">file</a> |
<a href="/comm-central/annotate/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/backend/icaljs/calICSService.js">annotate</a> |
<a href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/backend/icaljs/calICSService.js">diff</a> |
<a href="/comm-central/comparison/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/backend/icaljs/calICSService.js">comparison</a> |
<a href="/comm-central/log/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/backend/icaljs/calICSService.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/content/calendar-item-editing.js">calendar/base/content/calendar-item-editing.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/content/calendar-item-editing.js">file</a> |
<a href="/comm-central/annotate/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/content/calendar-item-editing.js">annotate</a> |
<a href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/content/calendar-item-editing.js">diff</a> |
<a href="/comm-central/comparison/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/content/calendar-item-editing.js">comparison</a> |
<a href="/comm-central/log/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/content/calendar-item-editing.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/content/calendar-month-view.xml">calendar/base/content/calendar-month-view.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/content/calendar-month-view.xml">file</a> |
<a href="/comm-central/annotate/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/content/calendar-month-view.xml">annotate</a> |
<a href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/content/calendar-month-view.xml">diff</a> |
<a href="/comm-central/comparison/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/content/calendar-month-view.xml">comparison</a> |
<a href="/comm-central/log/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/content/calendar-month-view.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/content/calendar-multiday-view.xml">calendar/base/content/calendar-multiday-view.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/content/calendar-multiday-view.xml">file</a> |
<a href="/comm-central/annotate/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/content/calendar-multiday-view.xml">annotate</a> |
<a href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/content/calendar-multiday-view.xml">diff</a> |
<a href="/comm-central/comparison/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/content/calendar-multiday-view.xml">comparison</a> |
<a href="/comm-central/log/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/content/calendar-multiday-view.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/content/dialogs/calendar-event-dialog-attendees.js">calendar/base/content/dialogs/calendar-event-dialog-attendees.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/content/dialogs/calendar-event-dialog-attendees.js">file</a> |
<a href="/comm-central/annotate/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/content/dialogs/calendar-event-dialog-attendees.js">annotate</a> |
<a href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/content/dialogs/calendar-event-dialog-attendees.js">diff</a> |
<a href="/comm-central/comparison/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/content/dialogs/calendar-event-dialog-attendees.js">comparison</a> |
<a href="/comm-central/log/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/content/dialogs/calendar-event-dialog-attendees.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/content/dialogs/calendar-event-dialog.js">calendar/base/content/dialogs/calendar-event-dialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/content/dialogs/calendar-event-dialog.js">file</a> |
<a href="/comm-central/annotate/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/content/dialogs/calendar-event-dialog.js">annotate</a> |
<a href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/content/dialogs/calendar-event-dialog.js">diff</a> |
<a href="/comm-central/comparison/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/content/dialogs/calendar-event-dialog.js">comparison</a> |
<a href="/comm-central/log/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/content/dialogs/calendar-event-dialog.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/content/dialogs/calendar-migration-dialog.js">calendar/base/content/dialogs/calendar-migration-dialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/content/dialogs/calendar-migration-dialog.js">file</a> |
<a href="/comm-central/annotate/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/content/dialogs/calendar-migration-dialog.js">annotate</a> |
<a href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/content/dialogs/calendar-migration-dialog.js">diff</a> |
<a href="/comm-central/comparison/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/content/dialogs/calendar-migration-dialog.js">comparison</a> |
<a href="/comm-central/log/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/content/dialogs/calendar-migration-dialog.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/content/dialogs/calendar-properties-dialog.js">calendar/base/content/dialogs/calendar-properties-dialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/content/dialogs/calendar-properties-dialog.js">file</a> |
<a href="/comm-central/annotate/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/content/dialogs/calendar-properties-dialog.js">annotate</a> |
<a href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/content/dialogs/calendar-properties-dialog.js">diff</a> |
<a href="/comm-central/comparison/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/content/dialogs/calendar-properties-dialog.js">comparison</a> |
<a href="/comm-central/log/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/content/dialogs/calendar-properties-dialog.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/content/widgets/calendar-list-tree.xml">calendar/base/content/widgets/calendar-list-tree.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/content/widgets/calendar-list-tree.xml">file</a> |
<a href="/comm-central/annotate/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/content/widgets/calendar-list-tree.xml">annotate</a> |
<a href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/content/widgets/calendar-list-tree.xml">diff</a> |
<a href="/comm-central/comparison/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/content/widgets/calendar-list-tree.xml">comparison</a> |
<a href="/comm-central/log/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/content/widgets/calendar-list-tree.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calAlarmUtils.jsm">calendar/base/modules/calAlarmUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calAlarmUtils.jsm">file</a> |
<a href="/comm-central/annotate/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calAlarmUtils.jsm">annotate</a> |
<a href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calAlarmUtils.jsm">diff</a> |
<a href="/comm-central/comparison/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calAlarmUtils.jsm">comparison</a> |
<a href="/comm-central/log/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calAlarmUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calAsyncUtils.jsm">calendar/base/modules/calAsyncUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calAsyncUtils.jsm">file</a> |
<a href="/comm-central/annotate/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calAsyncUtils.jsm">annotate</a> |
<a href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calAsyncUtils.jsm">diff</a> |
<a href="/comm-central/comparison/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calAsyncUtils.jsm">comparison</a> |
<a href="/comm-central/log/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calAsyncUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calAuthUtils.jsm">calendar/base/modules/calAuthUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calAuthUtils.jsm">file</a> |
<a href="/comm-central/annotate/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calAuthUtils.jsm">annotate</a> |
<a href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calAuthUtils.jsm">diff</a> |
<a href="/comm-central/comparison/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calAuthUtils.jsm">comparison</a> |
<a href="/comm-central/log/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calAuthUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calExtract.jsm">calendar/base/modules/calExtract.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calExtract.jsm">file</a> |
<a href="/comm-central/annotate/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calExtract.jsm">annotate</a> |
<a href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calExtract.jsm">diff</a> |
<a href="/comm-central/comparison/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calExtract.jsm">comparison</a> |
<a href="/comm-central/log/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calExtract.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calHashedArray.jsm">calendar/base/modules/calHashedArray.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calHashedArray.jsm">file</a> |
<a href="/comm-central/annotate/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calHashedArray.jsm">annotate</a> |
<a href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calHashedArray.jsm">diff</a> |
<a href="/comm-central/comparison/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calHashedArray.jsm">comparison</a> |
<a href="/comm-central/log/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calHashedArray.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calItemUtils.jsm">calendar/base/modules/calItemUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calItemUtils.jsm">file</a> |
<a href="/comm-central/annotate/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calItemUtils.jsm">annotate</a> |
<a href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calItemUtils.jsm">diff</a> |
<a href="/comm-central/comparison/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calItemUtils.jsm">comparison</a> |
<a href="/comm-central/log/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calItemUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calIteratorUtils.jsm">calendar/base/modules/calIteratorUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calIteratorUtils.jsm">file</a> |
<a href="/comm-central/annotate/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calIteratorUtils.jsm">annotate</a> |
<a href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calIteratorUtils.jsm">diff</a> |
<a href="/comm-central/comparison/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calIteratorUtils.jsm">comparison</a> |
<a href="/comm-central/log/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calIteratorUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calItipUtils.jsm">calendar/base/modules/calItipUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calItipUtils.jsm">file</a> |
<a href="/comm-central/annotate/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calItipUtils.jsm">annotate</a> |
<a href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calItipUtils.jsm">diff</a> |
<a href="/comm-central/comparison/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calItipUtils.jsm">comparison</a> |
<a href="/comm-central/log/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calItipUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calProviderUtils.jsm">calendar/base/modules/calProviderUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calProviderUtils.jsm">file</a> |
<a href="/comm-central/annotate/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calProviderUtils.jsm">annotate</a> |
<a href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calProviderUtils.jsm">diff</a> |
<a href="/comm-central/comparison/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calProviderUtils.jsm">comparison</a> |
<a href="/comm-central/log/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calProviderUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calRecurrenceUtils.jsm">calendar/base/modules/calRecurrenceUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calRecurrenceUtils.jsm">file</a> |
<a href="/comm-central/annotate/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calRecurrenceUtils.jsm">annotate</a> |
<a href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calRecurrenceUtils.jsm">diff</a> |
<a href="/comm-central/comparison/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calRecurrenceUtils.jsm">comparison</a> |
<a href="/comm-central/log/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calRecurrenceUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calUtils.jsm">calendar/base/modules/calUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calUtils.jsm">file</a> |
<a href="/comm-central/annotate/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calUtils.jsm">annotate</a> |
<a href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calUtils.jsm">diff</a> |
<a href="/comm-central/comparison/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calUtils.jsm">comparison</a> |
<a href="/comm-central/log/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calXMLUtils.jsm">calendar/base/modules/calXMLUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calXMLUtils.jsm">file</a> |
<a href="/comm-central/annotate/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calXMLUtils.jsm">annotate</a> |
<a href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calXMLUtils.jsm">diff</a> |
<a href="/comm-central/comparison/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calXMLUtils.jsm">comparison</a> |
<a href="/comm-central/log/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/modules/calXMLUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/src/calAlarm.js">calendar/base/src/calAlarm.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/src/calAlarm.js">file</a> |
<a href="/comm-central/annotate/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/src/calAlarm.js">annotate</a> |
<a href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/src/calAlarm.js">diff</a> |
<a href="/comm-central/comparison/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/src/calAlarm.js">comparison</a> |
<a href="/comm-central/log/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/src/calAlarm.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/src/calCalendarManager.js">calendar/base/src/calCalendarManager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/src/calCalendarManager.js">file</a> |
<a href="/comm-central/annotate/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/src/calCalendarManager.js">annotate</a> |
<a href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/src/calCalendarManager.js">diff</a> |
<a href="/comm-central/comparison/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/src/calCalendarManager.js">comparison</a> |
<a href="/comm-central/log/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/src/calCalendarManager.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/src/calTimezoneService.js">calendar/base/src/calTimezoneService.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/src/calTimezoneService.js">file</a> |
<a href="/comm-central/annotate/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/src/calTimezoneService.js">annotate</a> |
<a href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/src/calTimezoneService.js">diff</a> |
<a href="/comm-central/comparison/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/src/calTimezoneService.js">comparison</a> |
<a href="/comm-central/log/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/src/calTimezoneService.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/src/calTransactionManager.js">calendar/base/src/calTransactionManager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/src/calTransactionManager.js">file</a> |
<a href="/comm-central/annotate/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/src/calTransactionManager.js">annotate</a> |
<a href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/src/calTransactionManager.js">diff</a> |
<a href="/comm-central/comparison/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/src/calTransactionManager.js">comparison</a> |
<a href="/comm-central/log/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/src/calTransactionManager.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/src/calUtils.js">calendar/base/src/calUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/src/calUtils.js">file</a> |
<a href="/comm-central/annotate/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/src/calUtils.js">annotate</a> |
<a href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/src/calUtils.js">diff</a> |
<a href="/comm-central/comparison/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/src/calUtils.js">comparison</a> |
<a href="/comm-central/log/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/base/src/calUtils.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/providers/caldav/calDavCalendar.js">calendar/providers/caldav/calDavCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/providers/caldav/calDavCalendar.js">file</a> |
<a href="/comm-central/annotate/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/providers/caldav/calDavCalendar.js">annotate</a> |
<a href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/providers/caldav/calDavCalendar.js">diff</a> |
<a href="/comm-central/comparison/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/providers/caldav/calDavCalendar.js">comparison</a> |
<a href="/comm-central/log/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/providers/caldav/calDavCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/providers/composite/calCompositeCalendar.js">calendar/providers/composite/calCompositeCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/providers/composite/calCompositeCalendar.js">file</a> |
<a href="/comm-central/annotate/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/providers/composite/calCompositeCalendar.js">annotate</a> |
<a href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/providers/composite/calCompositeCalendar.js">diff</a> |
<a href="/comm-central/comparison/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/providers/composite/calCompositeCalendar.js">comparison</a> |
<a href="/comm-central/log/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/providers/composite/calCompositeCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/providers/gdata/modules/gdataSession.jsm">calendar/providers/gdata/modules/gdataSession.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/providers/gdata/modules/gdataSession.jsm">file</a> |
<a href="/comm-central/annotate/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/providers/gdata/modules/gdataSession.jsm">annotate</a> |
<a href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/providers/gdata/modules/gdataSession.jsm">diff</a> |
<a href="/comm-central/comparison/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/providers/gdata/modules/gdataSession.jsm">comparison</a> |
<a href="/comm-central/log/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/providers/gdata/modules/gdataSession.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/providers/gdata/modules/gdataUtils.jsm">calendar/providers/gdata/modules/gdataUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/providers/gdata/modules/gdataUtils.jsm">file</a> |
<a href="/comm-central/annotate/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/providers/gdata/modules/gdataUtils.jsm">annotate</a> |
<a href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/providers/gdata/modules/gdataUtils.jsm">diff</a> |
<a href="/comm-central/comparison/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/providers/gdata/modules/gdataUtils.jsm">comparison</a> |
<a href="/comm-central/log/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/providers/gdata/modules/gdataUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/providers/memory/calMemoryCalendar.js">calendar/providers/memory/calMemoryCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/providers/memory/calMemoryCalendar.js">file</a> |
<a href="/comm-central/annotate/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/providers/memory/calMemoryCalendar.js">annotate</a> |
<a href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/providers/memory/calMemoryCalendar.js">diff</a> |
<a href="/comm-central/comparison/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/providers/memory/calMemoryCalendar.js">comparison</a> |
<a href="/comm-central/log/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/providers/memory/calMemoryCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/providers/storage/calStorageCalendar.js">calendar/providers/storage/calStorageCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/providers/storage/calStorageCalendar.js">file</a> |
<a href="/comm-central/annotate/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/providers/storage/calStorageCalendar.js">annotate</a> |
<a href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/providers/storage/calStorageCalendar.js">diff</a> |
<a href="/comm-central/comparison/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/providers/storage/calStorageCalendar.js">comparison</a> |
<a href="/comm-central/log/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/providers/storage/calStorageCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/providers/storage/calStorageUpgrade.jsm">calendar/providers/storage/calStorageUpgrade.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/providers/storage/calStorageUpgrade.jsm">file</a> |
<a href="/comm-central/annotate/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/providers/storage/calStorageUpgrade.jsm">annotate</a> |
<a href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/providers/storage/calStorageUpgrade.jsm">diff</a> |
<a href="/comm-central/comparison/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/providers/storage/calStorageUpgrade.jsm">comparison</a> |
<a href="/comm-central/log/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/providers/storage/calStorageUpgrade.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/providers/wcap/calWcapCalendarItems.js">calendar/providers/wcap/calWcapCalendarItems.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/providers/wcap/calWcapCalendarItems.js">file</a> |
<a href="/comm-central/annotate/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/providers/wcap/calWcapCalendarItems.js">annotate</a> |
<a href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/providers/wcap/calWcapCalendarItems.js">diff</a> |
<a href="/comm-central/comparison/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/providers/wcap/calWcapCalendarItems.js">comparison</a> |
<a href="/comm-central/log/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/providers/wcap/calWcapCalendarItems.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/providers/wcap/calWcapSession.js">calendar/providers/wcap/calWcapSession.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/providers/wcap/calWcapSession.js">file</a> |
<a href="/comm-central/annotate/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/providers/wcap/calWcapSession.js">annotate</a> |
<a href="/comm-central/diff/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/providers/wcap/calWcapSession.js">diff</a> |
<a href="/comm-central/comparison/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/providers/wcap/calWcapSession.js">comparison</a> |
<a href="/comm-central/log/ee0620ac1185699823a4665e732b22b96c8c0071/calendar/providers/wcap/calWcapSession.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/base/backend/icaljs/calICSService.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/base/backend/icaljs/calICSService.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -44,19 +44,19 @@ calIcalProperty.prototype = {</span>
<a href="#l1.4"></a><span id="l1.4">         if (this.innerObject.type == &quot;text&quot;) {</span>
<a href="#l1.5"></a><span id="l1.5">             this.innerObject.setValue(val);</span>
<a href="#l1.6"></a><span id="l1.6">             return val;</span>
<a href="#l1.7"></a><span id="l1.7">         }</span>
<a href="#l1.8"></a><span id="l1.8">         return this.valueAsIcalString = val;</span>
<a href="#l1.9"></a><span id="l1.9">     },</span>
<a href="#l1.10"></a><span id="l1.10"> </span>
<a href="#l1.11"></a><span id="l1.11">     get valueAsIcalString() {</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-        let type = this.innerObject.type;</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-        function stringifyValue(x) ICAL.stringify.value(x.toString(), type);</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-        return this.innerObject.getValues().map(stringifyValue).join(&quot;,&quot;);</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+        return this.innerObject.getValues().map(v =&gt; {</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+            return ICAL.stringify.value(v.toString(), this.innerObject.type);</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+        }).join(&quot;,&quot;);</span>
<a href="#l1.18"></a><span id="l1.18">     },</span>
<a href="#l1.19"></a><span id="l1.19">     set valueAsIcalString(val) {</span>
<a href="#l1.20"></a><span id="l1.20">         var icalval = ICAL.parse._parseValue(val, this.innerObject.type);</span>
<a href="#l1.21"></a><span id="l1.21">         this.innerObject.setValue(icalval);</span>
<a href="#l1.22"></a><span id="l1.22">         return val;</span>
<a href="#l1.23"></a><span id="l1.23">     },</span>
<a href="#l1.24"></a><span id="l1.24"> </span>
<a href="#l1.25"></a><span id="l1.25">     get valueAsDatetime() {</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineat">@@ -102,41 +102,43 @@ calIcalProperty.prototype = {</span>
<a href="#l1.27"></a><span id="l1.27">     },</span>
<a href="#l1.28"></a><span id="l1.28">     setParameter: function(n, v) {</span>
<a href="#l1.29"></a><span id="l1.29">         // Similar problems for setting the value parameter. Lightning code</span>
<a href="#l1.30"></a><span id="l1.30">         // expects setting the value parameter to just change the value type</span>
<a href="#l1.31"></a><span id="l1.31">         // and attempt to use the previous value as the new one. To do this in</span>
<a href="#l1.32"></a><span id="l1.32">         // ICAL.js we need to save the value, reset the type and then try to</span>
<a href="#l1.33"></a><span id="l1.33">         // set the value again.</span>
<a href="#l1.34"></a><span id="l1.34">         if (n == &quot;VALUE&quot;) {</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineminus">-            function stringifyValue(x) ICAL.stringify.value(x.toString(), type);</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineminus">-            function reparseValue(x) ICAL.parse._parseValue(stringifyValue(x), v);</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+            let oldValues;</span>
<a href="#l1.38"></a><span id="l1.38">             let type = this.innerObject.type;</span>
<a href="#l1.39"></a><span id="l1.39"> </span>
<a href="#l1.40"></a><span id="l1.40" class="difflineminus">-            let oldValue;</span>
<a href="#l1.41"></a><span id="l1.41">             let wasMultiValue = this.innerObject.isMultiValue;</span>
<a href="#l1.42"></a><span id="l1.42">             if (wasMultiValue) {</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineminus">-                oldValue = this.innerObject.getValues();</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineplus">+                oldValues = this.innerObject.getValues();</span>
<a href="#l1.45"></a><span id="l1.45">             } else {</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineminus">-                oldValue = [this.innerObject.getFirstValue()];</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineplus">+                oldValues = [this.innerObject.getFirstValue()];</span>
<a href="#l1.48"></a><span id="l1.48">             }</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineplus">+</span>
<a href="#l1.50"></a><span id="l1.50">             this.innerObject.resetType(v.toLowerCase());</span>
<a href="#l1.51"></a><span id="l1.51">             try {</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineminus">-                oldValue = oldValue.map(reparseValue);</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineplus">+                oldValues = oldValues.map(oldValue =&gt; {</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineplus">+                    let strvalue = ICAL.stringify.value(oldValue.toString(), type);</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineplus">+                    return ICAL.parse._parseValue(strvalue, v)</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineplus">+                });</span>
<a href="#l1.57"></a><span id="l1.57">             } catch (e) {</span>
<a href="#l1.58"></a><span id="l1.58">                 // If there was an error reparsing the value, then just keep it</span>
<a href="#l1.59"></a><span id="l1.59">                 // empty.</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineminus">-                oldValue = null;</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineplus">+                oldValues = null;</span>
<a href="#l1.62"></a><span id="l1.62">             }</span>
<a href="#l1.63"></a><span id="l1.63"> </span>
<a href="#l1.64"></a><span id="l1.64" class="difflineminus">-            if (oldValue) {</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineplus">+            if (oldValues) {</span>
<a href="#l1.66"></a><span id="l1.66">                 if (wasMultiValue &amp;&amp; this.innerObject.isMultiValue) {</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineminus">-                    this.innerObject.setValues(oldValue);</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineminus">-                } else if (oldValue) {</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineminus">-                    this.innerObject.setValue(oldValue.join(&quot;,&quot;));</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineplus">+                    this.innerObject.setValues(oldValues);</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineplus">+                } else {</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineplus">+                    this.innerObject.setValue(oldValues.join(&quot;,&quot;));</span>
<a href="#l1.73"></a><span id="l1.73">                 }</span>
<a href="#l1.74"></a><span id="l1.74">             }</span>
<a href="#l1.75"></a><span id="l1.75">         } else {</span>
<a href="#l1.76"></a><span id="l1.76">             this.innerObject.setParameter(n.toLowerCase(), v);</span>
<a href="#l1.77"></a><span id="l1.77">         }</span>
<a href="#l1.78"></a><span id="l1.78">     },</span>
<a href="#l1.79"></a><span id="l1.79">     removeParameter: function(n) {</span>
<a href="#l1.80"></a><span id="l1.80">         // Again, VALUE needs special handling. Removing the value parameter is</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/calendar/base/content/calendar-item-editing.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/calendar/base/content/calendar-item-editing.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -394,29 +394,28 @@ function openEventDialog(calendarItem, c</span>
<a href="#l2.4"></a><span id="l2.4"> </span>
<a href="#l2.5"></a><span id="l2.5">     // Filter out calendars that don't support the given calendar item</span>
<a href="#l2.6"></a><span id="l2.6">     calendars = calendars.filter(isItemSupported);</span>
<a href="#l2.7"></a><span id="l2.7"> </span>
<a href="#l2.8"></a><span id="l2.8">     // Filter out calendar/items that we cannot write to/modify</span>
<a href="#l2.9"></a><span id="l2.9">     if (mode == &quot;new&quot;) {</span>
<a href="#l2.10"></a><span id="l2.10">         calendars = calendars.filter(userCanAddItemsToCalendar);</span>
<a href="#l2.11"></a><span id="l2.11">     } else { /* modify */</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-        function calendarCanModifyItems(aCalendar) {</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+        calendars = calendars.filter((aCalendar) =&gt; {</span>
<a href="#l2.14"></a><span id="l2.14">             /* If the calendar is the item calendar, we check that the item</span>
<a href="#l2.15"></a><span id="l2.15">              * can be modified. If the calendar is NOT the item calendar, we</span>
<a href="#l2.16"></a><span id="l2.16">              * check that the user can remove items from that calendar and</span>
<a href="#l2.17"></a><span id="l2.17">              * add items to the current one.</span>
<a href="#l2.18"></a><span id="l2.18">              */</span>
<a href="#l2.19"></a><span id="l2.19">             return (((calendarItem.calendar != aCalendar)</span>
<a href="#l2.20"></a><span id="l2.20">                      &amp;&amp; userCanDeleteItemsFromCalendar(calendarItem.calendar)</span>
<a href="#l2.21"></a><span id="l2.21">                      &amp;&amp; userCanAddItemsToCalendar(aCalendar))</span>
<a href="#l2.22"></a><span id="l2.22">                     || ((calendarItem.calendar == aCalendar)</span>
<a href="#l2.23"></a><span id="l2.23">                         &amp;&amp; userCanModifyItem(calendarItem)));</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineminus">-        }</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineminus">-        calendars = calendars.filter(calendarCanModifyItems);</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineplus">+        });</span>
<a href="#l2.27"></a><span id="l2.27">     }</span>
<a href="#l2.28"></a><span id="l2.28"> </span>
<a href="#l2.29"></a><span id="l2.29">     if (mode == &quot;new&quot;</span>
<a href="#l2.30"></a><span id="l2.30">         &amp;&amp; (!isCalendarWritable(calendar)</span>
<a href="#l2.31"></a><span id="l2.31">             || !userCanAddItemsToCalendar(calendar)</span>
<a href="#l2.32"></a><span id="l2.32">             || !isItemSupported(calendar))) {</span>
<a href="#l2.33"></a><span id="l2.33">         if (calendars.length &lt; 1) {</span>
<a href="#l2.34"></a><span id="l2.34">             // There are no writable calendars or no calendar supports the given</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/calendar/base/content/calendar-month-view.xml</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/calendar/base/content/calendar-month-view.xml</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -744,66 +744,65 @@</span>
<a href="#l3.4"></a><span id="l3.4">             if (finished) {</span>
<a href="#l3.5"></a><span id="l3.5">               row.setAttribute(&quot;collapsed&quot;, true);</span>
<a href="#l3.6"></a><span id="l3.6">               continue;</span>
<a href="#l3.7"></a><span id="l3.7">             } else {</span>
<a href="#l3.8"></a><span id="l3.8">               row.removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l3.9"></a><span id="l3.9">             }</span>
<a href="#l3.10"></a><span id="l3.10">             for (var j = 0; j &lt; row.childNodes.length; j++) {</span>
<a href="#l3.11"></a><span id="l3.11">               var daybox = row.childNodes[j];</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-              var date = dateList[dateBoxes.length];</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+              var dt = dateList[dateBoxes.length];</span>
<a href="#l3.14"></a><span id="l3.14"> </span>
<a href="#l3.15"></a><span id="l3.15">               // Remove the attribute &quot;relation&quot; for all the column headers.</span>
<a href="#l3.16"></a><span id="l3.16">               // Consider only the first row index otherwise it will be</span>
<a href="#l3.17"></a><span id="l3.17">               // removed again afterwards the correct setting.</span>
<a href="#l3.18"></a><span id="l3.18">               if (i == 0) {</span>
<a href="#l3.19"></a><span id="l3.19">                   this.labeldaybox.childNodes[j].removeAttribute(&quot;relation&quot;);</span>
<a href="#l3.20"></a><span id="l3.20">               }</span>
<a href="#l3.21"></a><span id="l3.21"> </span>
<a href="#l3.22"></a><span id="l3.22">               daybox.setAttribute(&quot;context&quot;, this.getAttribute(&quot;context&quot;));</span>
<a href="#l3.23"></a><span id="l3.23">               daybox.setAttribute(&quot;item-context&quot;, this.getAttribute(&quot;item-context&quot;) || this.getAttribute(&quot;context&quot;));</span>
<a href="#l3.24"></a><span id="l3.24"> </span>
<a href="#l3.25"></a><span id="l3.25">               // Set the box-class depending on if this box displays a day in</span>
<a href="#l3.26"></a><span id="l3.26">               // the month being currently shown or not.</span>
<a href="#l3.27"></a><span id="l3.27">               var boxClass;</span>
<a href="#l3.28"></a><span id="l3.28">               if (this.showFullMonth) {</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineminus">-                  boxClass = &quot;calendar-month-day-box-&quot; + </span>
<a href="#l3.30"></a><span id="l3.30" class="difflineminus">-                             (mainMonth == date.month ? &quot;current-month&quot; : &quot;other-month&quot;);</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+                  boxClass = &quot;calendar-month-day-box-&quot; +</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+                             (mainMonth == dt.month ? &quot;current-month&quot; : &quot;other-month&quot;);</span>
<a href="#l3.33"></a><span id="l3.33">               } else {</span>
<a href="#l3.34"></a><span id="l3.34">                   boxClass = &quot;calendar-month-day-box-current-month&quot;;</span>
<a href="#l3.35"></a><span id="l3.35">               }</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineminus">-              function matchesDayOff(dayOffNum) { return dayOffNum == date.weekday; }</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineminus">-              if (this.mDaysOffArray.some(matchesDayOff)) {</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+              if (this.mDaysOffArray.some(dayOffNum =&gt; dayOffNum == dt.weekday)) {</span>
<a href="#l3.39"></a><span id="l3.39">                 boxClass = &quot;calendar-month-day-box-day-off &quot; + boxClass;</span>
<a href="#l3.40"></a><span id="l3.40">               }</span>
<a href="#l3.41"></a><span id="l3.41"> </span>
<a href="#l3.42"></a><span id="l3.42">               // Set up date relations</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineminus">-              switch (date.compare(today)) {</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+              switch (dt.compare(today)) {</span>
<a href="#l3.45"></a><span id="l3.45">                   case -1:</span>
<a href="#l3.46"></a><span id="l3.46">                       daybox.setAttribute(&quot;relation&quot;, &quot;past&quot;);</span>
<a href="#l3.47"></a><span id="l3.47">                       break;</span>
<a href="#l3.48"></a><span id="l3.48">                   case 0:</span>
<a href="#l3.49"></a><span id="l3.49">                       daybox.setAttribute(&quot;relation&quot;, &quot;today&quot;);</span>
<a href="#l3.50"></a><span id="l3.50">                       this.labeldaybox.childNodes[j].setAttribute(&quot;relation&quot;, &quot;today&quot;);</span>
<a href="#l3.51"></a><span id="l3.51">                       break;</span>
<a href="#l3.52"></a><span id="l3.52">                   case 1:</span>
<a href="#l3.53"></a><span id="l3.53">                       daybox.setAttribute(&quot;relation&quot;, &quot;future&quot;);</span>
<a href="#l3.54"></a><span id="l3.54">                       break;</span>
<a href="#l3.55"></a><span id="l3.55">               }</span>
<a href="#l3.56"></a><span id="l3.56"> </span>
<a href="#l3.57"></a><span id="l3.57">               daybox.setAttribute(&quot;class&quot;, boxClass);</span>
<a href="#l3.58"></a><span id="l3.58"> </span>
<a href="#l3.59"></a><span id="l3.59" class="difflineminus">-              daybox.setDate(date);</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineminus">-              if (date.day == 1 || date.day == date.endOfMonth.day) {</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+              daybox.setDate(dt);</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineplus">+              if (dt.day == 1 || dt.day == dt.endOfMonth.day) {</span>
<a href="#l3.63"></a><span id="l3.63">                 daybox.showMonthLabel = true;</span>
<a href="#l3.64"></a><span id="l3.64">               } else {</span>
<a href="#l3.65"></a><span id="l3.65">                 daybox.showMonthLabel = false;</span>
<a href="#l3.66"></a><span id="l3.66">               }</span>
<a href="#l3.67"></a><span id="l3.67">               daybox.calendarView = this;</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineminus">-              daybox.date = date;</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineplus">+              daybox.date = dt;</span>
<a href="#l3.70"></a><span id="l3.70">               dateBoxes.push(daybox);</span>
<a href="#l3.71"></a><span id="l3.71"> </span>
<a href="#l3.72"></a><span id="l3.72">               // If we've now assigned all of our dates, set this to true so we</span>
<a href="#l3.73"></a><span id="l3.73">               // know we can just collapse the rest of the rows.</span>
<a href="#l3.74"></a><span id="l3.74">               if (dateBoxes.length == dateList.length) {</span>
<a href="#l3.75"></a><span id="l3.75">                 finished = true;</span>
<a href="#l3.76"></a><span id="l3.76">               }</span>
<a href="#l3.77"></a><span id="l3.77">             }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/calendar/base/content/calendar-multiday-view.xml</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/calendar/base/content/calendar-multiday-view.xml</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -483,30 +483,27 @@</span>
<a href="#l4.4"></a><span id="l4.4"> </span>
<a href="#l4.5"></a><span id="l4.5">       &lt;method name=&quot;internalDeleteEvent&quot;&gt;</span>
<a href="#l4.6"></a><span id="l4.6">         &lt;parameter name=&quot;aOccurrence&quot;/&gt;</span>
<a href="#l4.7"></a><span id="l4.7">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l4.8"></a><span id="l4.8">            var itemIndex = -1;</span>
<a href="#l4.9"></a><span id="l4.9">            var occ;</span>
<a href="#l4.10"></a><span id="l4.10">            for (var i in this.mEventInfos) {</span>
<a href="#l4.11"></a><span id="l4.11">                occ = this.mEventInfos[i].event;</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-               if (occ.hashId == aOccurrence.hashId)</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-               {</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+               if (occ.hashId == aOccurrence.hashId) {</span>
<a href="#l4.15"></a><span id="l4.15">                    itemIndex = i;</span>
<a href="#l4.16"></a><span id="l4.16">                    break;</span>
<a href="#l4.17"></a><span id="l4.17">                }</span>
<a href="#l4.18"></a><span id="l4.18">            }</span>
<a href="#l4.19"></a><span id="l4.19"> </span>
<a href="#l4.20"></a><span id="l4.20">            if (itemIndex != -1) {</span>
<a href="#l4.21"></a><span id="l4.21">                delete this.mSelectedItemIds[occ.hashId];</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineminus">-               function isNotItem(a) {</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineminus">-                  return !a.occurrence || (a.occurrence.hashId != aOccurrence.hashId);</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineminus">-               }</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineminus">-               this.mSelectedChunks = this.mSelectedChunks.filter(isNotItem);</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineminus">-</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineplus">+               this.mSelectedChunks = this.mSelectedChunks.filter((item) =&gt; {</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+                   return !item.occurrence || (item.occurrence.hashId != aOccurrence.hashId);</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+               });</span>
<a href="#l4.30"></a><span id="l4.30">                this.mEventInfos.splice(itemIndex, 1);</span>
<a href="#l4.31"></a><span id="l4.31">                return true;</span>
<a href="#l4.32"></a><span id="l4.32">            } else {</span>
<a href="#l4.33"></a><span id="l4.33">                return false;</span>
<a href="#l4.34"></a><span id="l4.34">            }</span>
<a href="#l4.35"></a><span id="l4.35">         ]]&gt;&lt;/body&gt;</span>
<a href="#l4.36"></a><span id="l4.36">       &lt;/method&gt;</span>
<a href="#l4.37"></a><span id="l4.37"> </span>
<a href="#l4.38"></a><span id="l4.38" class="difflineat">@@ -3615,21 +3612,20 @@</span>
<a href="#l4.39"></a><span id="l4.39"> </span>
<a href="#l4.40"></a><span id="l4.40">       &lt;method name=&quot;doDeleteItem&quot;&gt;</span>
<a href="#l4.41"></a><span id="l4.41">         &lt;parameter name=&quot;aEvent&quot;/&gt;</span>
<a href="#l4.42"></a><span id="l4.42">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l4.43"></a><span id="l4.43">           var cols = this.findColumnsForItem(aEvent);</span>
<a href="#l4.44"></a><span id="l4.44">           if (!cols.length)</span>
<a href="#l4.45"></a><span id="l4.45">               return;</span>
<a href="#l4.46"></a><span id="l4.46"> </span>
<a href="#l4.47"></a><span id="l4.47" class="difflineminus">-          function isNotItem(a) {</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineminus">-              return (a.hashId != aEvent.hashId);</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineminus">-          }</span>
<a href="#l4.50"></a><span id="l4.50">           var oldLength = this.mSelectedItems.length;</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineminus">-          this.mSelectedItems = this.mSelectedItems.filter(isNotItem);</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineplus">+          this.mSelectedItems = this.mSelectedItems.filter((item) =&gt; {</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineplus">+              return item.hashId != aEvent.hashId;</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineplus">+          });</span>
<a href="#l4.55"></a><span id="l4.55"> </span>
<a href="#l4.56"></a><span id="l4.56">           for each (let col in cols) {</span>
<a href="#l4.57"></a><span id="l4.57">               let column = col.column;</span>
<a href="#l4.58"></a><span id="l4.58">               let header = col.header;</span>
<a href="#l4.59"></a><span id="l4.59"> </span>
<a href="#l4.60"></a><span id="l4.60">               let estart = aEvent.startDate || aEvent.entryDate || aEvent.dueDate;</span>
<a href="#l4.61"></a><span id="l4.61">               if (estart.isDate) {</span>
<a href="#l4.62"></a><span id="l4.62">                   header.deleteEvent(aEvent);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-event-dialog-attendees.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-event-dialog-attendees.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -993,18 +993,15 @@ function calFreeBusyListener(aFbElement,</span>
<a href="#l5.4"></a><span id="l5.4">     this.mFbElement = aFbElement;</span>
<a href="#l5.5"></a><span id="l5.5">     this.mBinding = aBinding;</span>
<a href="#l5.6"></a><span id="l5.6"> }</span>
<a href="#l5.7"></a><span id="l5.7"> </span>
<a href="#l5.8"></a><span id="l5.8"> calFreeBusyListener.prototype = {</span>
<a href="#l5.9"></a><span id="l5.9">     onResult: function cFBL_onResult(aRequest, aEntries) {</span>
<a href="#l5.10"></a><span id="l5.10">         if (aRequest &amp;&amp; !aRequest.isPending) {</span>
<a href="#l5.11"></a><span id="l5.11">             // Find request in list of pending requests and remove from queue:</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-            function neq(aOp) {</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-                return (aRequest.id != aOp.id);</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineminus">-            }</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineminus">-            this.mBinding.mPendingRequests = this.mBinding.mPendingRequests.filter(neq);</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+            this.mBinding.mPendingRequests = this.mBinding.mPendingRequests.filter(aOp =&gt; aRequest.id != aOp.id);</span>
<a href="#l5.17"></a><span id="l5.17">         }</span>
<a href="#l5.18"></a><span id="l5.18">         if (aEntries) {</span>
<a href="#l5.19"></a><span id="l5.19">             this.mFbElement.onFreeBusy(aEntries);</span>
<a href="#l5.20"></a><span id="l5.20">         }</span>
<a href="#l5.21"></a><span id="l5.21">     }</span>
<a href="#l5.22"></a><span id="l5.22"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-event-dialog.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-event-dialog.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -3355,68 +3355,65 @@ function updateDateTime() {</span>
<a href="#l6.4"></a><span id="l6.4">  * This function initializes the following controls:</span>
<a href="#l6.5"></a><span id="l6.5">  * - 'timezone-starttime'</span>
<a href="#l6.6"></a><span id="l6.6">  * - 'timezone-endtime'</span>
<a href="#l6.7"></a><span id="l6.7">  * the timezone-links show the corrosponding names of the</span>
<a href="#l6.8"></a><span id="l6.8">  * start/end times. If 'cmd_timezone' is not checked</span>
<a href="#l6.9"></a><span id="l6.9">  * the links will be collapsed.</span>
<a href="#l6.10"></a><span id="l6.10">  */</span>
<a href="#l6.11"></a><span id="l6.11"> function updateTimezone() {</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+    function updateTimezoneElement(aTimezone, aId, aDateTime) {</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+        let element = document.getElementById(aId);</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+        if (!element) {</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+            return;</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+        }</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+        if (aTimezone) {</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+            element.removeAttribute('collapsed');</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+            element.value = aTimezone.displayName || aTimezone.tzid;</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineplus">+            if (!aDateTime || !aDateTime.isValid || gIsReadOnly || aDateTime.isDate) {</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+                if (element.hasAttribute('class')) {</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineplus">+                    element.setAttribute('class-on-enabled',</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineplus">+                                         element.getAttribute('class'));</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineplus">+                    element.removeAttribute('class');</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineplus">+                }</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineplus">+                if (element.hasAttribute('onclick')) {</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineplus">+                    element.setAttribute('onclick-on-enabled',</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineplus">+                                         element.getAttribute('onclick'));</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineplus">+                    element.removeAttribute('onclick');</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+                }</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+                element.setAttribute('disabled', 'true');</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+            } else {</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+                if (element.hasAttribute('class-on-enabled')) {</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+                    element.setAttribute('class',</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineplus">+                                         element.getAttribute('class-on-enabled'));</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineplus">+                    element.removeAttribute('class-on-enabled');</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineplus">+                }</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineplus">+                if (element.hasAttribute('onclick-on-enabled')) {</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineplus">+                    element.setAttribute('onclick',</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineplus">+                                         element.getAttribute('onclick-on-enabled'));</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineplus">+                    element.removeAttribute('onclick-on-enabled');</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineplus">+                }</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineplus">+                element.removeAttribute('disabled');</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineplus">+            }</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineplus">+        } else {</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineplus">+            element.setAttribute('collapsed', 'true');</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineplus">+        }</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineplus">+    }</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineplus">+</span>
<a href="#l6.51"></a><span id="l6.51">     let timezonesEnabled = document.getElementById('cmd_timezone')</span>
<a href="#l6.52"></a><span id="l6.52">                                    .getAttribute('checked') == 'true';</span>
<a href="#l6.53"></a><span id="l6.53">     // convert to default timezone if the timezone option</span>
<a href="#l6.54"></a><span id="l6.54">     // is *not* checked, otherwise keep the specific timezone</span>
<a href="#l6.55"></a><span id="l6.55">     // and display the labels in order to modify the timezone.</span>
<a href="#l6.56"></a><span id="l6.56">     if (timezonesEnabled) {</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineminus">-        let startTimezone = gStartTimezone;</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineminus">-        let endTimezone = gEndTimezone;</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineminus">-</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineminus">-        function updateTimezoneElement(aTimezone, aId, aDateTime) {</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineminus">-            let element = document.getElementById(aId);</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineminus">-            if (!element) {</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineminus">-                return;</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineminus">-            }</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineminus">-</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineminus">-            if (aTimezone) {</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineminus">-                element.removeAttribute('collapsed');</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineminus">-                element.value = aTimezone.displayName || aTimezone.tzid;</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineminus">-                if (!aDateTime || !aDateTime.isValid || gIsReadOnly || aDateTime.isDate) {</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineminus">-                    if (element.hasAttribute('class')) {</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineminus">-                        element.setAttribute('class-on-enabled',</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineminus">-                                             element.getAttribute('class'));</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineminus">-                        element.removeAttribute('class');</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineminus">-                    }</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineminus">-                    if (element.hasAttribute('onclick')) {</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineminus">-                        element.setAttribute('onclick-on-enabled',</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineminus">-                                             element.getAttribute('onclick'));</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineminus">-                        element.removeAttribute('onclick');</span>
<a href="#l6.79"></a><span id="l6.79" class="difflineminus">-                    }</span>
<a href="#l6.80"></a><span id="l6.80" class="difflineminus">-                    element.setAttribute('disabled', 'true');</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineminus">-                } else {</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineminus">-                    if (element.hasAttribute('class-on-enabled')) {</span>
<a href="#l6.83"></a><span id="l6.83" class="difflineminus">-                        element.setAttribute('class',</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineminus">-                                             element.getAttribute('class-on-enabled'));</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineminus">-                        element.removeAttribute('class-on-enabled');</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineminus">-                    }</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineminus">-                    if (element.hasAttribute('onclick-on-enabled')) {</span>
<a href="#l6.88"></a><span id="l6.88" class="difflineminus">-                        element.setAttribute('onclick',</span>
<a href="#l6.89"></a><span id="l6.89" class="difflineminus">-                                             element.getAttribute('onclick-on-enabled'));</span>
<a href="#l6.90"></a><span id="l6.90" class="difflineminus">-                        element.removeAttribute('onclick-on-enabled');</span>
<a href="#l6.91"></a><span id="l6.91" class="difflineminus">-                    }</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineminus">-                    element.removeAttribute('disabled');</span>
<a href="#l6.93"></a><span id="l6.93" class="difflineminus">-                }</span>
<a href="#l6.94"></a><span id="l6.94" class="difflineminus">-            } else {</span>
<a href="#l6.95"></a><span id="l6.95" class="difflineminus">-                element.setAttribute('collapsed', 'true');</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineminus">-            }</span>
<a href="#l6.97"></a><span id="l6.97" class="difflineminus">-        }</span>
<a href="#l6.98"></a><span id="l6.98" class="difflineminus">-</span>
<a href="#l6.99"></a><span id="l6.99" class="difflineminus">-        updateTimezoneElement(startTimezone,</span>
<a href="#l6.100"></a><span id="l6.100" class="difflineplus">+        updateTimezoneElement(gStartTimezone,</span>
<a href="#l6.101"></a><span id="l6.101">                               'timezone-starttime',</span>
<a href="#l6.102"></a><span id="l6.102">                               gStartTime);</span>
<a href="#l6.103"></a><span id="l6.103" class="difflineminus">-        updateTimezoneElement(endTimezone,</span>
<a href="#l6.104"></a><span id="l6.104" class="difflineplus">+        updateTimezoneElement(gEndTimezone,</span>
<a href="#l6.105"></a><span id="l6.105">                               'timezone-endtime',</span>
<a href="#l6.106"></a><span id="l6.106">                               gEndTime);</span>
<a href="#l6.107"></a><span id="l6.107">     } else {</span>
<a href="#l6.108"></a><span id="l6.108">         document.getElementById('timezone-starttime')</span>
<a href="#l6.109"></a><span id="l6.109">                 .setAttribute('collapsed', 'true');</span>
<a href="#l6.110"></a><span id="l6.110">         document.getElementById('timezone-endtime')</span>
<a href="#l6.111"></a><span id="l6.111">                 .setAttribute('collapsed', 'true');</span>
<a href="#l6.112"></a><span id="l6.112">     }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-migration-dialog.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-migration-dialog.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -456,85 +456,85 @@ var gDataMigrator = {</span>
<a href="#l7.4"></a><span id="l7.4">         var evoDir = this.dirService.get(&quot;Home&quot;, Components.interfaces.nsILocalFile);</span>
<a href="#l7.5"></a><span id="l7.5">         evoDir.append(&quot;.evolution&quot;);</span>
<a href="#l7.6"></a><span id="l7.6">         evoDir.append(&quot;calendar&quot;);</span>
<a href="#l7.7"></a><span id="l7.7">         evoDir.append(&quot;local&quot;);</span>
<a href="#l7.8"></a><span id="l7.8">         return (evoDir.exists() ? [new dataMigrator(&quot;Evolution&quot;, evoMigrate, [evoDir])] : []);</span>
<a href="#l7.9"></a><span id="l7.9">     },</span>
<a href="#l7.10"></a><span id="l7.10"> </span>
<a href="#l7.11"></a><span id="l7.11">     checkWindowsMail: function gdm_windowsMail() {</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+        function doMigrate(aCalendarNodes, aMailDir, aCallback) {</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+            let calManager = cal.getCalendarManager();</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+            for (let node of aCalendarNodes) {</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+                let name = node.getElementsByTagName(&quot;Name&quot;)[0].textContent;</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+                let color = node.getElementsByTagName(&quot;Color&quot;)[0].textContent;</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+                let enabled = node.getElementsByTagName(&quot;Enabled&quot;)[0].textContent == &quot;True&quot;;</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+                // The name is quoted, and the color also contains an alpha</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+                // value. Lets just ignore the alpha value and take the</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineplus">+                // color part.</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineplus">+                name = name.replace(/(^'|'$)/g, &quot;&quot;);</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineplus">+                color = color.replace(/0x[0-9a-fA-F]{2}([0-9a-fA-F]{4})/, &quot;#$1&quot;);</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineplus">+</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineplus">+                let calfile = aMailDir.clone();</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineplus">+                calfile.append(name + &quot;.ics&quot;);</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineplus">+</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineplus">+                if (calfile.exists()) {</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineplus">+                    let storage = gDataMigrator.importICSToStorage(calfile)</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineplus">+                    storage.name = name;</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+                    if (color) {</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+                        storage.setProperty(&quot;color&quot;, color);</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+                    }</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+                    calManager.registerCalendar(storage);</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineplus">+                    if (enabled) {</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineplus">+                        getCompositeCalendar().addCalendar(storage);</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+                    }</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineplus">+                }</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineplus">+            }</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineplus">+            aCallback();</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+        }</span>
<a href="#l7.45"></a><span id="l7.45"> </span>
<a href="#l7.46"></a><span id="l7.46">         if (!this.dirService.has(&quot;LocalAppData&quot;)) {</span>
<a href="#l7.47"></a><span id="l7.47">             // We are probably not on windows</span>
<a href="#l7.48"></a><span id="l7.48">             return [];</span>
<a href="#l7.49"></a><span id="l7.49">         }</span>
<a href="#l7.50"></a><span id="l7.50"> </span>
<a href="#l7.51"></a><span id="l7.51">         let maildir = this.dirService.get(&quot;LocalAppData&quot;,</span>
<a href="#l7.52"></a><span id="l7.52">                                           Components.interfaces.nsILocalFile);</span>
<a href="#l7.53"></a><span id="l7.53"> </span>
<a href="#l7.54"></a><span id="l7.54">         maildir.append(&quot;Microsoft&quot;);</span>
<a href="#l7.55"></a><span id="l7.55">         maildir.append(&quot;Windows Calendar&quot;);</span>
<a href="#l7.56"></a><span id="l7.56">         maildir.append(&quot;Calendars&quot;);</span>
<a href="#l7.57"></a><span id="l7.57"> </span>
<a href="#l7.58"></a><span id="l7.58">         let settingsxml = maildir.clone();</span>
<a href="#l7.59"></a><span id="l7.59">         settingsxml.append(&quot;Settings.xml&quot;);</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineminus">-        if (!settingsxml || !settingsxml.exists()) {</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineminus">-            // No Settings.xml, maybe Windows Calendar was never started?</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineminus">-            return [];</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineminus">-        }</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineminus">-        let settingsXmlUri = Services.io.newFileURI(settingsxml);</span>
<a href="#l7.65"></a><span id="l7.65"> </span>
<a href="#l7.66"></a><span id="l7.66" class="difflineminus">-        let req = new XMLHttpRequest();</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineminus">-        req.open(&quot;GET&quot;, settingsXmlUri.spec, false);</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineminus">-        req.send(null);</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineminus">-        if (req.status == 0) {</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineminus">-            // The file was found, it seems we are on windows vista.</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineminus">-            let doc = req.responseXML;</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineminus">-            let root = doc.documentElement;</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineminus">-</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineminus">-            // Get all calendar property tags and return the migrator.</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineminus">-            let calendars = doc.getElementsByTagName(&quot;VCalendar&quot;);</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineminus">-            function doMigrate(aCallback) {</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineminus">-                for each (let node in Array.slice(calendars)) {</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineminus">-                    let name = node.getElementsByTagName(&quot;Name&quot;)[0].textContent;</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineminus">-                    let color = node.getElementsByTagName(&quot;Color&quot;)[0].textContent;</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineminus">-                    let enabled = node.getElementsByTagName(&quot;Enabled&quot;)[0].textContent == &quot;True&quot;;</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineplus">+        let migrators = [];</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineplus">+        if (settingsxml.exists()) {</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineplus">+            let settingsXmlUri = Services.io.newFileURI(settingsxml);</span>
<a href="#l7.84"></a><span id="l7.84"> </span>
<a href="#l7.85"></a><span id="l7.85" class="difflineminus">-                    // The name is quoted, and the color also contains an alpha</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineminus">-                    // value. Lets just ignore the alpha value and take the</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineminus">-                    // color part.</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineminus">-                    name = name.replace(/(^'|'$)/g, &quot;&quot;);</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineminus">-                    color = color.replace(/0x[0-9a-fA-F]{2}([0-9a-fA-F]{4})/, &quot;#$1&quot;);</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineminus">-</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineminus">-                    let calfile = maildir.clone();</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineminus">-                    calfile.append(name + &quot;.ics&quot;);</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineminus">-</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineminus">-                    if (calfile.exists()) {</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineminus">-                        let storage = gDataMigrator.importICSToStorage(calfile)</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineminus">-</span>
<a href="#l7.97"></a><span id="l7.97" class="difflineminus">-                        storage.name = name;</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineplus">+            let req = new XMLHttpRequest();</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineplus">+            req.open(&quot;GET&quot;, settingsXmlUri.spec, false);</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineplus">+            req.send(null);</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineplus">+            if (req.status == 0) {</span>
<a href="#l7.102"></a><span id="l7.102" class="difflineplus">+                // The file was found, it seems we are on windows vista.</span>
<a href="#l7.103"></a><span id="l7.103" class="difflineplus">+                let doc = req.responseXML;</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineplus">+                let root = doc.documentElement;</span>
<a href="#l7.105"></a><span id="l7.105"> </span>
<a href="#l7.106"></a><span id="l7.106" class="difflineminus">-                        if (color) {</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineminus">-                            storage.setProperty(&quot;color&quot;, color);</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineminus">-                        }</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineminus">-                        let calManager = cal.getCalendarManager();</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineminus">-                        calManager.registerCalendar(storage);</span>
<a href="#l7.111"></a><span id="l7.111" class="difflineminus">-</span>
<a href="#l7.112"></a><span id="l7.112" class="difflineminus">-                        if (enabled) {</span>
<a href="#l7.113"></a><span id="l7.113" class="difflineminus">-                            getCompositeCalendar().addCalendar(storage);</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineminus">-                        }</span>
<a href="#l7.115"></a><span id="l7.115" class="difflineminus">-                    }</span>
<a href="#l7.116"></a><span id="l7.116" class="difflineplus">+                // Get all calendar property tags and return the migrator.</span>
<a href="#l7.117"></a><span id="l7.117" class="difflineplus">+                let calendars = doc.getElementsByTagName(&quot;VCalendar&quot;);</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineplus">+                if (calendars.length &gt; 0) {</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineplus">+                    migrators = [new dataMigrator(&quot;Windows Calendar&quot;, doMigrate.bind(null, calendars, maildir))];</span>
<a href="#l7.120"></a><span id="l7.120">                 }</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineminus">-                aCallback();</span>
<a href="#l7.122"></a><span id="l7.122" class="difflineminus">-            }</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineminus">-            if (calendars.length &gt; 0) {</span>
<a href="#l7.124"></a><span id="l7.124" class="difflineminus">-                return [new dataMigrator(&quot;Windows Calendar&quot;, doMigrate)];</span>
<a href="#l7.125"></a><span id="l7.125">             }</span>
<a href="#l7.126"></a><span id="l7.126">         }</span>
<a href="#l7.127"></a><span id="l7.127" class="difflineminus">-        return [];</span>
<a href="#l7.128"></a><span id="l7.128" class="difflineplus">+        return migrators;</span>
<a href="#l7.129"></a><span id="l7.129">     },</span>
<a href="#l7.130"></a><span id="l7.130"> </span>
<a href="#l7.131"></a><span id="l7.131">     /**</span>
<a href="#l7.132"></a><span id="l7.132">      * Creates and registers a storage calendar and imports the given ics file into it.</span>
<a href="#l7.133"></a><span id="l7.133">      *</span>
<a href="#l7.134"></a><span id="l7.134">      * @param icsFile     The nsI(Local)File to import.</span>
<a href="#l7.135"></a><span id="l7.135">      */</span>
<a href="#l7.136"></a><span id="l7.136">     importICSToStorage: function migrateIcsStorage(icsFile) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-properties-dialog.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-properties-dialog.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -124,30 +124,30 @@ function setupEnabledCheckbox() {</span>
<a href="#l8.4"></a><span id="l8.4"> function unsubscribeCalendar() {</span>
<a href="#l8.5"></a><span id="l8.5">     let calmgr =  cal.getCalendarManager();</span>
<a href="#l8.6"></a><span id="l8.6"> </span>
<a href="#l8.7"></a><span id="l8.7">     calmgr.unregisterCalendar(gCalendar);</span>
<a href="#l8.8"></a><span id="l8.8">     window.close();</span>
<a href="#l8.9"></a><span id="l8.9"> }</span>
<a href="#l8.10"></a><span id="l8.10"> </span>
<a href="#l8.11"></a><span id="l8.11"> function initRefreshInterval() {</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+    function createMenuItem(minutes) {</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+        let menuitem = createXULElement(&quot;menuitem&quot;);</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+        menuitem.setAttribute(&quot;value&quot;, minutes);</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+        let everyMinuteString = cal.calGetString(&quot;calendar&quot;, &quot;calendarPropertiesEveryMinute&quot;);</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+        let label = PluralForm.get(minutes, everyMinuteString).replace(&quot;#1&quot;, minutes);</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+        menuitem.setAttribute(&quot;label&quot;, label);</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineplus">+        return menuitem;</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineplus">+    }</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineplus">+</span>
<a href="#l8.23"></a><span id="l8.23">     setBooleanAttribute(&quot;calendar-refreshInterval-row&quot;, &quot;hidden&quot;, !gCalendar.canRefresh);</span>
<a href="#l8.24"></a><span id="l8.24"> </span>
<a href="#l8.25"></a><span id="l8.25">     if (gCalendar.canRefresh) {</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineminus">-        function createMenuItem(minutes) {</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineminus">-            let menuitem = createXULElement(&quot;menuitem&quot;);</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineminus">-            menuitem.setAttribute(&quot;value&quot;, minutes);</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineminus">-</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineminus">-            let everyMinuteString = cal.calGetString(&quot;calendar&quot;, &quot;calendarPropertiesEveryMinute&quot;);</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-            let label = PluralForm.get(minutes, everyMinuteString).replace(&quot;#1&quot;, minutes);</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineminus">-            menuitem.setAttribute(&quot;label&quot;, label);</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineminus">-</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineminus">-            return menuitem;</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineminus">-        }</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineminus">-</span>
<a href="#l8.37"></a><span id="l8.37">         let refreshInterval = gCalendar.getProperty(&quot;refreshInterval&quot;);</span>
<a href="#l8.38"></a><span id="l8.38">         if (refreshInterval === null) refreshInterval = 30;</span>
<a href="#l8.39"></a><span id="l8.39"> </span>
<a href="#l8.40"></a><span id="l8.40">         let foundValue = false;</span>
<a href="#l8.41"></a><span id="l8.41">         let separator = document.getElementById(&quot;calendar-refreshInterval-manual-separator&quot;);</span>
<a href="#l8.42"></a><span id="l8.42">         let menulist = document.getElementById(&quot;calendar-refreshInterval-menulist&quot;);</span>
<a href="#l8.43"></a><span id="l8.43">         for each (let min in [1, 5, 15, 30, 60]) {</span>
<a href="#l8.44"></a><span id="l8.44">             let menuitem = createMenuItem(min);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/calendar/base/content/widgets/calendar-list-tree.xml</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/calendar/base/content/widgets/calendar-list-tree.xml</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -637,16 +637,17 @@</span>
<a href="#l9.4"></a><span id="l9.4">           try {</span>
<a href="#l9.5"></a><span id="l9.5">               let rowProps = this.getRowProperties(aRow);</span>
<a href="#l9.6"></a><span id="l9.6">               let colProps = this.getColumnProperties(aCol);</span>
<a href="#l9.7"></a><span id="l9.7">               return rowProps + (rowProps &amp;&amp; colProps ? &quot; &quot; : &quot;&quot;) + colProps;</span>
<a href="#l9.8"></a><span id="l9.8">           } catch (e) {</span>
<a href="#l9.9"></a><span id="l9.9">               // It seems errors in these functions are not shown, do this</span>
<a href="#l9.10"></a><span id="l9.10">               // explicitly.</span>
<a href="#l9.11"></a><span id="l9.11">               cal.ERROR(&quot;Error getting cell props: &quot; + e);</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+              return &quot;&quot;;</span>
<a href="#l9.13"></a><span id="l9.13">           }</span>
<a href="#l9.14"></a><span id="l9.14">         ]]&gt;&lt;/body&gt;</span>
<a href="#l9.15"></a><span id="l9.15">       &lt;/method&gt;</span>
<a href="#l9.16"></a><span id="l9.16"> </span>
<a href="#l9.17"></a><span id="l9.17">       &lt;method name=&quot;getRowProperties&quot;&gt;</span>
<a href="#l9.18"></a><span id="l9.18">         &lt;parameter name=&quot;aRow&quot;/&gt;</span>
<a href="#l9.19"></a><span id="l9.19">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l9.20"></a><span id="l9.20">           let properties = [];</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/calendar/base/modules/calAlarmUtils.jsm</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/calendar/base/modules/calAlarmUtils.jsm</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -1,16 +1,16 @@</span>
<a href="#l10.4"></a><span id="l10.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l10.5"></a><span id="l10.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l10.6"></a><span id="l10.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l10.7"></a><span id="l10.7"> </span>
<a href="#l10.8"></a><span id="l10.8"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l10.9"></a><span id="l10.9"> Components.utils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l10.10"></a><span id="l10.10"> </span>
<a href="#l10.11"></a><span id="l10.11" class="difflineminus">-EXPORTED_SYMBOLS = [&quot;cal&quot;]; // even though it's defined in calUtils.jsm, import needs this</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+this.EXPORTED_SYMBOLS = [&quot;cal&quot;]; // even though it's defined in calUtils.jsm, import needs this</span>
<a href="#l10.13"></a><span id="l10.13"> cal.alarms = {</span>
<a href="#l10.14"></a><span id="l10.14">     /**</span>
<a href="#l10.15"></a><span id="l10.15">      * Read default alarm settings from user preferences and apply them to the</span>
<a href="#l10.16"></a><span id="l10.16">      * event/todo passed in. The item's calendar should be set to ensure the</span>
<a href="#l10.17"></a><span id="l10.17">      * correct alarm type is set.</span>
<a href="#l10.18"></a><span id="l10.18">      *</span>
<a href="#l10.19"></a><span id="l10.19">      * @param aItem     The item to apply the default alarm values to.</span>
<a href="#l10.20"></a><span id="l10.20">      */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/calendar/base/modules/calAsyncUtils.jsm</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/calendar/base/modules/calAsyncUtils.jsm</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -5,17 +5,17 @@</span>
<a href="#l11.4"></a><span id="l11.4"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l11.5"></a><span id="l11.5"> Components.utils.import(&quot;resource://gre/modules/Promise.jsm&quot;);</span>
<a href="#l11.6"></a><span id="l11.6"> Components.utils.import(&quot;resource://gre/modules/PromiseUtils.jsm&quot;);</span>
<a href="#l11.7"></a><span id="l11.7"> </span>
<a href="#l11.8"></a><span id="l11.8"> /*</span>
<a href="#l11.9"></a><span id="l11.9">  * Asynchronous tools for handling calendar operations.</span>
<a href="#l11.10"></a><span id="l11.10">  */</span>
<a href="#l11.11"></a><span id="l11.11"> </span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-EXPORTED_SYMBOLS = [&quot;cal&quot;]; // even though it's defined in calUtils.jsm, import needs this</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+this.EXPORTED_SYMBOLS = [&quot;cal&quot;]; // even though it's defined in calUtils.jsm, import needs this</span>
<a href="#l11.14"></a><span id="l11.14"> const cIOL = Components.interfaces.calIOperationListener;</span>
<a href="#l11.15"></a><span id="l11.15"> const cIC = Components.interfaces.calICalendar;</span>
<a href="#l11.16"></a><span id="l11.16"> </span>
<a href="#l11.17"></a><span id="l11.17"> const promisifyProxyHandler = {</span>
<a href="#l11.18"></a><span id="l11.18">     promiseOperation: function(target, name, args) {</span>
<a href="#l11.19"></a><span id="l11.19">         let deferred = PromiseUtils.defer();</span>
<a href="#l11.20"></a><span id="l11.20">         let listener = cal.async.promiseOperationListener(deferred);</span>
<a href="#l11.21"></a><span id="l11.21">         args.push(listener);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/calendar/base/modules/calAuthUtils.jsm</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/calendar/base/modules/calAuthUtils.jsm</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -5,17 +5,17 @@</span>
<a href="#l12.4"></a><span id="l12.4"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l12.5"></a><span id="l12.5"> Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l12.6"></a><span id="l12.6"> Components.utils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l12.7"></a><span id="l12.7"> </span>
<a href="#l12.8"></a><span id="l12.8"> /*</span>
<a href="#l12.9"></a><span id="l12.9">  * Authentication helper code</span>
<a href="#l12.10"></a><span id="l12.10">  */</span>
<a href="#l12.11"></a><span id="l12.11"> </span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-EXPORTED_SYMBOLS = [&quot;cal&quot;]; // even though it's defined in calUtils.jsm, import needs this</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+this.EXPORTED_SYMBOLS = [&quot;cal&quot;]; // even though it's defined in calUtils.jsm, import needs this</span>
<a href="#l12.14"></a><span id="l12.14"> cal.auth = {</span>
<a href="#l12.15"></a><span id="l12.15">     /**</span>
<a href="#l12.16"></a><span id="l12.16">      * Auth prompt implementation - Uses password manager if at all possible.</span>
<a href="#l12.17"></a><span id="l12.17">      */</span>
<a href="#l12.18"></a><span id="l12.18">     Prompt: function calPrompt() {</span>
<a href="#l12.19"></a><span id="l12.19">         this.mWindow = cal.getCalendarWindow();</span>
<a href="#l12.20"></a><span id="l12.20">         this.mReturnedLogins = {};</span>
<a href="#l12.21"></a><span id="l12.21">     },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/calendar/base/modules/calExtract.jsm</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/calendar/base/modules/calExtract.jsm</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -1080,17 +1080,17 @@ Extractor.prototype = {</span>
<a href="#l13.4"></a><span id="l13.4">         return alts;</span>
<a href="#l13.5"></a><span id="l13.5">     },</span>
<a href="#l13.6"></a><span id="l13.6"> </span>
<a href="#l13.7"></a><span id="l13.7">     getPositionsFor: function getPositionsFor(s, name, count) {</span>
<a href="#l13.8"></a><span id="l13.8">         let positions = new Array();</span>
<a href="#l13.9"></a><span id="l13.9">         let re = /\%(\d)\$S/g;</span>
<a href="#l13.10"></a><span id="l13.10">         let match;</span>
<a href="#l13.11"></a><span id="l13.11">         let i = 0;</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-        while (match = re.exec(s)) {</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+        while ((match = re.exec(s))) {</span>
<a href="#l13.14"></a><span id="l13.14">             i++;</span>
<a href="#l13.15"></a><span id="l13.15">             positions[parseInt(match[1], 10)] = i;</span>
<a href="#l13.16"></a><span id="l13.16">         }</span>
<a href="#l13.17"></a><span id="l13.17"> </span>
<a href="#l13.18"></a><span id="l13.18">         // correctness checking</span>
<a href="#l13.19"></a><span id="l13.19">         for (i = 1; i &lt;= count; i++) {</span>
<a href="#l13.20"></a><span id="l13.20">             if (positions[i] === undefined) {</span>
<a href="#l13.21"></a><span id="l13.21">                 Components.utils.reportError(&quot;[calExtract] Faulty extraction pattern &quot; + name +</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/calendar/base/modules/calHashedArray.jsm</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/calendar/base/modules/calHashedArray.jsm</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -1,15 +1,15 @@</span>
<a href="#l14.4"></a><span id="l14.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l14.5"></a><span id="l14.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l14.6"></a><span id="l14.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l14.7"></a><span id="l14.7"> </span>
<a href="#l14.8"></a><span id="l14.8"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l14.9"></a><span id="l14.9"> </span>
<a href="#l14.10"></a><span id="l14.10" class="difflineminus">-EXPORTED_SYMBOLS = [&quot;cal&quot;]; // even though it's defined in calUtils.jsm, import needs this</span>
<a href="#l14.11"></a><span id="l14.11" class="difflineplus">+var EXPORTED_SYMBOLS = [&quot;cal&quot;]; // even though it's defined in calUtils.jsm, import needs this</span>
<a href="#l14.12"></a><span id="l14.12"> </span>
<a href="#l14.13"></a><span id="l14.13"> /**</span>
<a href="#l14.14"></a><span id="l14.14">  * An unsorted array of hashable items with some extra functions to quickly</span>
<a href="#l14.15"></a><span id="l14.15">  * retrieve the item by its hash id.</span>
<a href="#l14.16"></a><span id="l14.16">  *</span>
<a href="#l14.17"></a><span id="l14.17">  * Performance Considerations:</span>
<a href="#l14.18"></a><span id="l14.18">  *  - Accessing items is fast</span>
<a href="#l14.19"></a><span id="l14.19">  *  - Adding items is fast (they are added to the end)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/calendar/base/modules/calItemUtils.jsm</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/calendar/base/modules/calItemUtils.jsm</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -1,15 +1,16 @@</span>
<a href="#l15.4"></a><span id="l15.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l15.5"></a><span id="l15.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l15.6"></a><span id="l15.6">  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l15.7"></a><span id="l15.7"> </span>
<a href="#l15.8"></a><span id="l15.8" class="difflineminus">-var EXPORTED_SYMBOLS = [&quot;itemDiff&quot;];</span>
<a href="#l15.9"></a><span id="l15.9"> &quot;use strict&quot;;</span>
<a href="#l15.10"></a><span id="l15.10"> </span>
<a href="#l15.11"></a><span id="l15.11" class="difflineplus">+this.EXPORTED_SYMBOLS = [&quot;itemDiff&quot;];</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineplus">+</span>
<a href="#l15.13"></a><span id="l15.13"> Components.utils.import(&quot;resource://calendar/modules/calHashedArray.jsm&quot;);</span>
<a href="#l15.14"></a><span id="l15.14"> </span>
<a href="#l15.15"></a><span id="l15.15"> /**</span>
<a href="#l15.16"></a><span id="l15.16">  * Given two sets of items, find out which items were added, changed or</span>
<a href="#l15.17"></a><span id="l15.17">  * removed.</span>
<a href="#l15.18"></a><span id="l15.18">  *</span>
<a href="#l15.19"></a><span id="l15.19">  * The general flow is to first use load/load1 methods to load the engine with</span>
<a href="#l15.20"></a><span id="l15.20">  * the first set of items, then use difference/difference1 to load the set of</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/calendar/base/modules/calIteratorUtils.jsm</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/calendar/base/modules/calIteratorUtils.jsm</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -1,17 +1,17 @@</span>
<a href="#l16.4"></a><span id="l16.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l16.5"></a><span id="l16.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l16.6"></a><span id="l16.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l16.7"></a><span id="l16.7"> </span>
<a href="#l16.8"></a><span id="l16.8"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l16.9"></a><span id="l16.9"> Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l16.10"></a><span id="l16.10"> Components.utils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l16.11"></a><span id="l16.11"> </span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-EXPORTED_SYMBOLS = [&quot;cal&quot;]; // even though it's defined in calUtils.jsm, import needs this</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+this.EXPORTED_SYMBOLS = [&quot;cal&quot;]; // even though it's defined in calUtils.jsm, import needs this</span>
<a href="#l16.14"></a><span id="l16.14"> </span>
<a href="#l16.15"></a><span id="l16.15"> /**</span>
<a href="#l16.16"></a><span id="l16.16">  * Iterates an array of items, i.e. the passed item including all</span>
<a href="#l16.17"></a><span id="l16.17">  * overridden instances of a recurring series.</span>
<a href="#l16.18"></a><span id="l16.18">  *</span>
<a href="#l16.19"></a><span id="l16.19">  * @param items array of items</span>
<a href="#l16.20"></a><span id="l16.20">  */</span>
<a href="#l16.21"></a><span id="l16.21"> cal.itemIterator = function cal_itemIterator(items) {</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineat">@@ -115,25 +115,26 @@ cal.ical = {</span>
<a href="#l16.23"></a><span id="l16.23">      *  @param aCompType        The type of item to iterate.</span>
<a href="#l16.24"></a><span id="l16.24">      *  @return                 The iterator that yields all items.</span>
<a href="#l16.25"></a><span id="l16.25">      */</span>
<a href="#l16.26"></a><span id="l16.26">     calendarComponentIterator: function cal_ical_calendarComponentIterator(aComponent, aCompType) {</span>
<a href="#l16.27"></a><span id="l16.27">         let compType = (aCompType || &quot;ANY&quot;);</span>
<a href="#l16.28"></a><span id="l16.28">         if (aComponent &amp;&amp; aComponent.componentType == &quot;VCALENDAR&quot;) {</span>
<a href="#l16.29"></a><span id="l16.29">             return cal.ical.subcomponentIterator(aComponent, compType);</span>
<a href="#l16.30"></a><span id="l16.30">         } else if (aComponent &amp;&amp; aComponent.componentType == &quot;XROOT&quot;) {</span>
<a href="#l16.31"></a><span id="l16.31" class="difflineminus">-            function calVCALENDARIterator(aWantKeys) {</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineminus">-                cal.ASSERT(aWantKeys, &quot;Please use for() on the calendar component iterator&quot;);</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineminus">-                for (let calComp in cal.ical.subcomponentIterator(aComponent, &quot;VCALENDAR&quot;)) {</span>
<a href="#l16.34"></a><span id="l16.34" class="difflineminus">-                    for (let itemComp in cal.ical.subcomponentIterator(calComp, compType)) {</span>
<a href="#l16.35"></a><span id="l16.35" class="difflineminus">-                        yield itemComp;</span>
<a href="#l16.36"></a><span id="l16.36" class="difflineplus">+            return {</span>
<a href="#l16.37"></a><span id="l16.37" class="difflineplus">+                __iterator__: function calVCALENDARIterator(aWantKeys) {</span>
<a href="#l16.38"></a><span id="l16.38" class="difflineplus">+                    cal.ASSERT(aWantKeys, &quot;Please use for() on the calendar component iterator&quot;);</span>
<a href="#l16.39"></a><span id="l16.39" class="difflineplus">+                    for (let calComp in cal.ical.subcomponentIterator(aComponent, &quot;VCALENDAR&quot;)) {</span>
<a href="#l16.40"></a><span id="l16.40" class="difflineplus">+                        for (let itemComp in cal.ical.subcomponentIterator(calComp, compType)) {</span>
<a href="#l16.41"></a><span id="l16.41" class="difflineplus">+                            yield itemComp;</span>
<a href="#l16.42"></a><span id="l16.42" class="difflineplus">+                        }</span>
<a href="#l16.43"></a><span id="l16.43">                     }</span>
<a href="#l16.44"></a><span id="l16.44">                 }</span>
<a href="#l16.45"></a><span id="l16.45">             };</span>
<a href="#l16.46"></a><span id="l16.46" class="difflineminus">-            return { __iterator__: calVCALENDARIterator };</span>
<a href="#l16.47"></a><span id="l16.47">         } else if (aComponent &amp;&amp; (compType == &quot;ANY&quot; || compType == aComponent.componentType)) {</span>
<a href="#l16.48"></a><span id="l16.48">             return {</span>
<a href="#l16.49"></a><span id="l16.49">                 __iterator__: function singleItemIterator(aWantKeys) {</span>
<a href="#l16.50"></a><span id="l16.50">                     cal.ASSERT(aWantKeys, &quot;Please use for() on the calendar component iterator&quot;);</span>
<a href="#l16.51"></a><span id="l16.51">                     yield aComponent;</span>
<a href="#l16.52"></a><span id="l16.52">                 }</span>
<a href="#l16.53"></a><span id="l16.53">             }</span>
<a href="#l16.54"></a><span id="l16.54">         } else {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/calendar/base/modules/calItipUtils.jsm</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/calendar/base/modules/calItipUtils.jsm</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -7,17 +7,17 @@ Components.utils.import(&quot;resource://cale</span>
<a href="#l17.4"></a><span id="l17.4"> Components.utils.import(&quot;resource://calendar/modules/calAlarmUtils.jsm&quot;);</span>
<a href="#l17.5"></a><span id="l17.5"> Components.utils.import(&quot;resource://calendar/modules/calIteratorUtils.jsm&quot;);</span>
<a href="#l17.6"></a><span id="l17.6"> Components.utils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l17.7"></a><span id="l17.7"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l17.8"></a><span id="l17.8"> </span>
<a href="#l17.9"></a><span id="l17.9"> /**</span>
<a href="#l17.10"></a><span id="l17.10">  * Scheduling and iTIP helper code</span>
<a href="#l17.11"></a><span id="l17.11">  */</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-EXPORTED_SYMBOLS = [&quot;cal&quot;]; // even though it's defined in calUtils.jsm, import needs this</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+this.EXPORTED_SYMBOLS = [&quot;cal&quot;]; // even though it's defined in calUtils.jsm, import needs this</span>
<a href="#l17.14"></a><span id="l17.14"> cal.itip = {</span>
<a href="#l17.15"></a><span id="l17.15">     /**</span>
<a href="#l17.16"></a><span id="l17.16">      * Gets the sequence/revision number, either of the passed item or</span>
<a href="#l17.17"></a><span id="l17.17">      * the last received one of an attendee; see</span>
<a href="#l17.18"></a><span id="l17.18">      * &lt;http://tools.ietf.org/html/draft-desruisseaux-caldav-sched-04#section-7.1&gt;.</span>
<a href="#l17.19"></a><span id="l17.19">      */</span>
<a href="#l17.20"></a><span id="l17.20">      getSequence: function cal_itip_getSequence(item) {</span>
<a href="#l17.21"></a><span id="l17.21">         let seq = null;</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineat">@@ -170,26 +170,28 @@ cal.itip = {</span>
<a href="#l17.23"></a><span id="l17.23">      * @param aOperationType  An operation type from calIOperationListener</span>
<a href="#l17.24"></a><span id="l17.24">      * @return                The suggested text.</span>
<a href="#l17.25"></a><span id="l17.25">      */</span>
<a href="#l17.26"></a><span id="l17.26">     getCompleteText: function getCompleteText(aStatus, aOperationType) {</span>
<a href="#l17.27"></a><span id="l17.27">         function _gs(strName, param) {</span>
<a href="#l17.28"></a><span id="l17.28">             return cal.calGetString(&quot;lightning&quot;, strName, param, &quot;lightning&quot;);</span>
<a href="#l17.29"></a><span id="l17.29">         }</span>
<a href="#l17.30"></a><span id="l17.30"> </span>
<a href="#l17.31"></a><span id="l17.31" class="difflineplus">+        let text = &quot;&quot;;</span>
<a href="#l17.32"></a><span id="l17.32">         const cIOL = Components.interfaces.calIOperationListener;</span>
<a href="#l17.33"></a><span id="l17.33">         if (Components.isSuccessCode(aStatus)) {</span>
<a href="#l17.34"></a><span id="l17.34">             switch (aOperationType) {</span>
<a href="#l17.35"></a><span id="l17.35" class="difflineminus">-                case cIOL.ADD: return _gs(&quot;imipAddedItemToCal&quot;);</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineminus">-                case cIOL.MODIFY: return _gs(&quot;imipUpdatedItem&quot;);</span>
<a href="#l17.37"></a><span id="l17.37" class="difflineminus">-                case cIOL.DELETE: return _gs(&quot;imipCanceledItem&quot;);</span>
<a href="#l17.38"></a><span id="l17.38" class="difflineplus">+                case cIOL.ADD: text = gs(&quot;imipAddedItemToCal&quot;); break;</span>
<a href="#l17.39"></a><span id="l17.39" class="difflineplus">+                case cIOL.MODIFY: text = _gs(&quot;imipUpdatedItem&quot;); break;</span>
<a href="#l17.40"></a><span id="l17.40" class="difflineplus">+                case cIOL.DELETE: text = _gs(&quot;imipCanceledItem&quot;); break;</span>
<a href="#l17.41"></a><span id="l17.41">             }</span>
<a href="#l17.42"></a><span id="l17.42">         } else {</span>
<a href="#l17.43"></a><span id="l17.43" class="difflineminus">-            return _gs(&quot;imipBarProcessingFailed&quot;, [aStatus.toString(16)]);</span>
<a href="#l17.44"></a><span id="l17.44" class="difflineplus">+            text = _gs(&quot;imipBarProcessingFailed&quot;, [aStatus.toString(16)]);</span>
<a href="#l17.45"></a><span id="l17.45">         }</span>
<a href="#l17.46"></a><span id="l17.46" class="difflineplus">+        return text;</span>
<a href="#l17.47"></a><span id="l17.47">     },</span>
<a href="#l17.48"></a><span id="l17.48"> </span>
<a href="#l17.49"></a><span id="l17.49">     /**</span>
<a href="#l17.50"></a><span id="l17.50">      * Scope: iTIP message receiver</span>
<a href="#l17.51"></a><span id="l17.51">      *</span>
<a href="#l17.52"></a><span id="l17.52">      * Gets a text describing the given itip method. The text is of the form</span>
<a href="#l17.53"></a><span id="l17.53">      * &quot;This Message contains a ... &quot;.</span>
<a href="#l17.54"></a><span id="l17.54">      *</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/calendar/base/modules/calProviderUtils.jsm</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/calendar/base/modules/calProviderUtils.jsm</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -8,17 +8,17 @@ Components.utils.import(&quot;resource://cale</span>
<a href="#l18.4"></a><span id="l18.4"> Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l18.5"></a><span id="l18.5"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l18.6"></a><span id="l18.6"> Components.utils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l18.7"></a><span id="l18.7"> </span>
<a href="#l18.8"></a><span id="l18.8"> /*</span>
<a href="#l18.9"></a><span id="l18.9">  * Provider helper code</span>
<a href="#l18.10"></a><span id="l18.10">  */</span>
<a href="#l18.11"></a><span id="l18.11"> </span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-EXPORTED_SYMBOLS = [&quot;cal&quot;]; // even though it's defined in calUtils.jsm, import needs this</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+this.EXPORTED_SYMBOLS = [&quot;cal&quot;]; // even though it's defined in calUtils.jsm, import needs this</span>
<a href="#l18.14"></a><span id="l18.14"> </span>
<a href="#l18.15"></a><span id="l18.15"> /**</span>
<a href="#l18.16"></a><span id="l18.16">  * Prepare HTTP channel with standard request headers and upload</span>
<a href="#l18.17"></a><span id="l18.17">  * data/content-type if needed</span>
<a href="#l18.18"></a><span id="l18.18">  *</span>
<a href="#l18.19"></a><span id="l18.19">  * @param arUri                      Channel Uri, will only be used for a new</span>
<a href="#l18.20"></a><span id="l18.20">  *                                     channel.</span>
<a href="#l18.21"></a><span id="l18.21">  * @param aUploadData                Data to be uploaded, if any. This may be a</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/calendar/base/modules/calRecurrenceUtils.jsm</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/calendar/base/modules/calRecurrenceUtils.jsm</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -1,28 +1,52 @@</span>
<a href="#l19.4"></a><span id="l19.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l19.5"></a><span id="l19.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l19.6"></a><span id="l19.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l19.7"></a><span id="l19.7"> </span>
<a href="#l19.8"></a><span id="l19.8"> Components.utils.import(&quot;resource://gre/modules/PluralForm.jsm&quot;);</span>
<a href="#l19.9"></a><span id="l19.9"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l19.10"></a><span id="l19.10" class="difflineminus">-EXPORTED_SYMBOLS = [&quot;recurrenceRule2String&quot;, &quot;splitRecurrenceRules&quot;, &quot;checkRecurrenceRule&quot;];</span>
<a href="#l19.11"></a><span id="l19.11" class="difflineplus">+this.EXPORTED_SYMBOLS = [&quot;recurrenceRule2String&quot;, &quot;splitRecurrenceRules&quot;, &quot;checkRecurrenceRule&quot;];</span>
<a href="#l19.12"></a><span id="l19.12"> </span>
<a href="#l19.13"></a><span id="l19.13"> /**</span>
<a href="#l19.14"></a><span id="l19.14">  * This function takes the recurrence info passed as argument and creates a</span>
<a href="#l19.15"></a><span id="l19.15">  * literal string representing the repeat pattern in natural language.</span>
<a href="#l19.16"></a><span id="l19.16">  *</span>
<a href="#l19.17"></a><span id="l19.17">  * @param recurrenceInfo    An item's recurrence info to parse.</span>
<a href="#l19.18"></a><span id="l19.18">  * @param startDate         The start date to base rules on.</span>
<a href="#l19.19"></a><span id="l19.19">  * @param endDate           The end date to base rules on.</span>
<a href="#l19.20"></a><span id="l19.20">  * @param allDay            If true, the pattern should assume an allday item.</span>
<a href="#l19.21"></a><span id="l19.21">  * @return                  A human readable string describing the recurrence.</span>
<a href="#l19.22"></a><span id="l19.22">  */</span>
<a href="#l19.23"></a><span id="l19.23"> function recurrenceRule2String(recurrenceInfo, startDate, endDate, allDay) {</span>
<a href="#l19.24"></a><span id="l19.24" class="difflineminus">-    function getRString(name, args) cal.calGetString(&quot;calendar-event-dialog&quot;, name, args);</span>
<a href="#l19.25"></a><span id="l19.25" class="difflineplus">+    function getRString(name, args) {</span>
<a href="#l19.26"></a><span id="l19.26" class="difflineplus">+        return cal.calGetString(&quot;calendar-event-dialog&quot;, name, args);</span>
<a href="#l19.27"></a><span id="l19.27" class="difflineplus">+    }</span>
<a href="#l19.28"></a><span id="l19.28" class="difflineplus">+    function day_of_week(day) {</span>
<a href="#l19.29"></a><span id="l19.29" class="difflineplus">+        return Math.abs(day) % 8;</span>
<a href="#l19.30"></a><span id="l19.30" class="difflineplus">+    }</span>
<a href="#l19.31"></a><span id="l19.31" class="difflineplus">+    function day_position(day) {</span>
<a href="#l19.32"></a><span id="l19.32" class="difflineplus">+        return (Math.abs(day) - day_of_week(day)) / 8 * (day &lt; 0 ? -1 : 1);</span>
<a href="#l19.33"></a><span id="l19.33" class="difflineplus">+    }</span>
<a href="#l19.34"></a><span id="l19.34" class="difflineplus">+    function nounClass(aDayString, aRuleString) {</span>
<a href="#l19.35"></a><span id="l19.35" class="difflineplus">+        // Select noun class (grammatical gender) for rule string</span>
<a href="#l19.36"></a><span id="l19.36" class="difflineplus">+        let nounClass = getRString(aDayString + &quot;Nounclass&quot;);</span>
<a href="#l19.37"></a><span id="l19.37" class="difflineplus">+        return aRuleString + nounClass.substr(0, 1).toUpperCase() +</span>
<a href="#l19.38"></a><span id="l19.38" class="difflineplus">+               nounClass.substr(1);</span>
<a href="#l19.39"></a><span id="l19.39" class="difflineplus">+    }</span>
<a href="#l19.40"></a><span id="l19.40" class="difflineplus">+    function pluralWeekday(aDayString) {</span>
<a href="#l19.41"></a><span id="l19.41" class="difflineplus">+        let plural = getRString(&quot;pluralForWeekdays&quot;) == &quot;true&quot;;</span>
<a href="#l19.42"></a><span id="l19.42" class="difflineplus">+        return (plural ? aDayString + &quot;Plural&quot; : aDayString);</span>
<a href="#l19.43"></a><span id="l19.43" class="difflineplus">+    }</span>
<a href="#l19.44"></a><span id="l19.44" class="difflineplus">+    function everyWeekDay(aByDay) {</span>
<a href="#l19.45"></a><span id="l19.45" class="difflineplus">+        // Checks if aByDay contains only values from 1 to 7 with any order.</span>
<a href="#l19.46"></a><span id="l19.46" class="difflineplus">+        let mask = aByDay.reduce((v, c) =&gt; v | (1 &lt;&lt; c), 1);</span>
<a href="#l19.47"></a><span id="l19.47" class="difflineplus">+        return aByDay.length == 7 &amp;&amp; mask == Math.pow(2, 8) - 1;</span>
<a href="#l19.48"></a><span id="l19.48" class="difflineplus">+    }</span>
<a href="#l19.49"></a><span id="l19.49" class="difflineplus">+</span>
<a href="#l19.50"></a><span id="l19.50"> </span>
<a href="#l19.51"></a><span id="l19.51">     // Retrieve a valid recurrence rule from the currently</span>
<a href="#l19.52"></a><span id="l19.52">     // set recurrence info. Bail out if there's more</span>
<a href="#l19.53"></a><span id="l19.53">     // than a single rule or something other than a rule.</span>
<a href="#l19.54"></a><span id="l19.54">     recurrenceInfo = recurrenceInfo.clone();</span>
<a href="#l19.55"></a><span id="l19.55">     let rrules = splitRecurrenceRules(recurrenceInfo);</span>
<a href="#l19.56"></a><span id="l19.56">     if (rrules[0].length == 1) {</span>
<a href="#l19.57"></a><span id="l19.57">         let rule = cal.wrapInstance(rrules[0][0], Components.interfaces.calIRecurrenceRule);</span>
<a href="#l19.58"></a><span id="l19.58" class="difflineat">@@ -32,39 +56,16 @@ function recurrenceRule2String(recurrenc</span>
<a href="#l19.59"></a><span id="l19.59">                                         'BYMINUTE',</span>
<a href="#l19.60"></a><span id="l19.60">                                         //'BYDAY',</span>
<a href="#l19.61"></a><span id="l19.61">                                         'BYHOUR',</span>
<a href="#l19.62"></a><span id="l19.62">                                         //'BYMONTHDAY',</span>
<a href="#l19.63"></a><span id="l19.63">                                         'BYYEARDAY',</span>
<a href="#l19.64"></a><span id="l19.64">                                         'BYWEEKNO',</span>
<a href="#l19.65"></a><span id="l19.65">                                         //'BYMONTH',</span>
<a href="#l19.66"></a><span id="l19.66">                                         'BYSETPOS'])) {</span>
<a href="#l19.67"></a><span id="l19.67" class="difflineminus">-            function day_of_week(day) {</span>
<a href="#l19.68"></a><span id="l19.68" class="difflineminus">-                return Math.abs(day) % 8;</span>
<a href="#l19.69"></a><span id="l19.69" class="difflineminus">-            }</span>
<a href="#l19.70"></a><span id="l19.70" class="difflineminus">-            function day_position(day) {</span>
<a href="#l19.71"></a><span id="l19.71" class="difflineminus">-                let dow = day_of_week(day);</span>
<a href="#l19.72"></a><span id="l19.72" class="difflineminus">-                return (Math.abs(day) - dow) / 8 * (day &lt; 0 ? -1 : 1);</span>
<a href="#l19.73"></a><span id="l19.73" class="difflineminus">-            }</span>
<a href="#l19.74"></a><span id="l19.74" class="difflineminus">-            function nounClass(aDayString, aRuleString) {</span>
<a href="#l19.75"></a><span id="l19.75" class="difflineminus">-                // Select noun class (grammatical gender) for rule string</span>
<a href="#l19.76"></a><span id="l19.76" class="difflineminus">-                let nounClass = getRString(aDayString + &quot;Nounclass&quot;);</span>
<a href="#l19.77"></a><span id="l19.77" class="difflineminus">-                return aRuleString + nounClass.substr(0, 1).toUpperCase() +</span>
<a href="#l19.78"></a><span id="l19.78" class="difflineminus">-                       nounClass.substr(1);</span>
<a href="#l19.79"></a><span id="l19.79" class="difflineminus">-            }</span>
<a href="#l19.80"></a><span id="l19.80" class="difflineminus">-            function pluralWeekday(aDayString) {</span>
<a href="#l19.81"></a><span id="l19.81" class="difflineminus">-                let plural = getRString(&quot;pluralForWeekdays&quot;) == &quot;true&quot;;</span>
<a href="#l19.82"></a><span id="l19.82" class="difflineminus">-                return (plural ? aDayString + &quot;Plural&quot; : aDayString);</span>
<a href="#l19.83"></a><span id="l19.83" class="difflineminus">-            }</span>
<a href="#l19.84"></a><span id="l19.84" class="difflineminus">-            function everyWeekDay(aByDay) {</span>
<a href="#l19.85"></a><span id="l19.85" class="difflineminus">-                // Checks if aByDay contains only values from 1 to 7 with any order.</span>
<a href="#l19.86"></a><span id="l19.86" class="difflineminus">-                let mask = aByDay.reduce(function(v, c) v | (1 &lt;&lt; c), 1);</span>
<a href="#l19.87"></a><span id="l19.87" class="difflineminus">-                return aByDay.length == 7 &amp;&amp; mask == Math.pow(2, 8) - 1;</span>
<a href="#l19.88"></a><span id="l19.88" class="difflineminus">-            }</span>
<a href="#l19.89"></a><span id="l19.89" class="difflineminus">-</span>
<a href="#l19.90"></a><span id="l19.90">             let dateFormatter = cal.getDateFormatter();</span>
<a href="#l19.91"></a><span id="l19.91">             let ruleString;</span>
<a href="#l19.92"></a><span id="l19.92">             if (rule.type == 'DAILY') {</span>
<a href="#l19.93"></a><span id="l19.93">                 if (checkRecurrenceRule(rule, ['BYDAY'])) {</span>
<a href="#l19.94"></a><span id="l19.94">                     let days = rule.getComponent(&quot;BYDAY&quot;, {});</span>
<a href="#l19.95"></a><span id="l19.95">                     let weekdays = [2, 3, 4, 5, 6];</span>
<a href="#l19.96"></a><span id="l19.96">                     if (weekdays.length == days.length) {</span>
<a href="#l19.97"></a><span id="l19.97">                         let i;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/calendar/base/modules/calUtils.jsm</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/calendar/base/modules/calUtils.jsm</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -10,17 +10,17 @@ Components.utils.import(&quot;resource://gre/</span>
<a href="#l20.4"></a><span id="l20.4"> Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l20.5"></a><span id="l20.5"> Components.utils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l20.6"></a><span id="l20.6"> </span>
<a href="#l20.7"></a><span id="l20.7"> // Usually the backend loader gets loaded via profile-after-change, but in case</span>
<a href="#l20.8"></a><span id="l20.8"> // a calendar component hooks in earlier, its very likely it will use calUtils.</span>
<a href="#l20.9"></a><span id="l20.9"> // Getting the service here will load if its not already loaded</span>
<a href="#l20.10"></a><span id="l20.10"> Components.classes[&quot;@mozilla.org/calendar/backend-loader;1&quot;].getService();</span>
<a href="#l20.11"></a><span id="l20.11"> </span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-EXPORTED_SYMBOLS = [&quot;cal&quot;];</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+this.EXPORTED_SYMBOLS = [&quot;cal&quot;];</span>
<a href="#l20.14"></a><span id="l20.14"> let cal = {</span>
<a href="#l20.15"></a><span id="l20.15">     // new code should land here,</span>
<a href="#l20.16"></a><span id="l20.16">     // and more code should be moved from calUtils.js into this object to avoid</span>
<a href="#l20.17"></a><span id="l20.17">     // clashes with other extensions</span>
<a href="#l20.18"></a><span id="l20.18"> </span>
<a href="#l20.19"></a><span id="l20.19">     getDragService: generateServiceAccessor(&quot;@mozilla.org/widget/dragservice;1&quot;,</span>
<a href="#l20.20"></a><span id="l20.20">                                                 Components.interfaces.nsIDragService),</span>
<a href="#l20.21"></a><span id="l20.21"> </span>
<a href="#l20.22"></a><span id="l20.22" class="difflineat">@@ -407,61 +407,55 @@ let cal = {</span>
<a href="#l20.23"></a><span id="l20.23">       b = Number(b);</span>
<a href="#l20.24"></a><span id="l20.24">       return ((a &lt; b) ? -1 :      // avoid underflow problems of subtraction</span>
<a href="#l20.25"></a><span id="l20.25">               (a &gt; b) ?  1 : 0);</span>
<a href="#l20.26"></a><span id="l20.26">     },</span>
<a href="#l20.27"></a><span id="l20.27"> </span>
<a href="#l20.28"></a><span id="l20.28">     sortEntryComparer: function cal_sortEntryComparer(sortType, modifier) {</span>
<a href="#l20.29"></a><span id="l20.29">       switch (sortType) {</span>
<a href="#l20.30"></a><span id="l20.30">         case &quot;number&quot;:</span>
<a href="#l20.31"></a><span id="l20.31" class="difflineminus">-          function compareNumbers(sortEntryA, sortEntryB) {</span>
<a href="#l20.32"></a><span id="l20.32" class="difflineplus">+          return function compareNumbers(sortEntryA, sortEntryB) {</span>
<a href="#l20.33"></a><span id="l20.33">             let nsA = cal.sortEntryKey(sortEntryA);</span>
<a href="#l20.34"></a><span id="l20.34">             let nsB = cal.sortEntryKey(sortEntryB);</span>
<a href="#l20.35"></a><span id="l20.35">             return cal.compareNumber(nsA, nsB) * modifier;</span>
<a href="#l20.36"></a><span id="l20.36" class="difflineminus">-          }</span>
<a href="#l20.37"></a><span id="l20.37" class="difflineminus">-          return compareNumbers;</span>
<a href="#l20.38"></a><span id="l20.38" class="difflineplus">+          };</span>
<a href="#l20.39"></a><span id="l20.39">         case &quot;date&quot;:</span>
<a href="#l20.40"></a><span id="l20.40" class="difflineminus">-          function compareTimes(sortEntryA, sortEntryB) {</span>
<a href="#l20.41"></a><span id="l20.41" class="difflineplus">+          return function compareTimes(sortEntryA, sortEntryB) {</span>
<a href="#l20.42"></a><span id="l20.42">             let nsA = cal.sortEntryKey(sortEntryA);</span>
<a href="#l20.43"></a><span id="l20.43">             let nsB = cal.sortEntryKey(sortEntryB);</span>
<a href="#l20.44"></a><span id="l20.44">             return cal.compareNativeTime(nsA, nsB) * modifier;</span>
<a href="#l20.45"></a><span id="l20.45" class="difflineminus">-          }</span>
<a href="#l20.46"></a><span id="l20.46" class="difflineminus">-          return compareTimes;</span>
<a href="#l20.47"></a><span id="l20.47" class="difflineplus">+          };</span>
<a href="#l20.48"></a><span id="l20.48">         case &quot;date_filled&quot;:</span>
<a href="#l20.49"></a><span id="l20.49" class="difflineminus">-          function compareTimesFilled(sortEntryA, sortEntryB) {</span>
<a href="#l20.50"></a><span id="l20.50" class="difflineplus">+          return function compareTimesFilled(sortEntryA, sortEntryB) {</span>
<a href="#l20.51"></a><span id="l20.51">             let nsA = cal.sortEntryKey(sortEntryA);</span>
<a href="#l20.52"></a><span id="l20.52">             let nsB = cal.sortEntryKey(sortEntryB);</span>
<a href="#l20.53"></a><span id="l20.53">             if (modifier == 1) {</span>
<a href="#l20.54"></a><span id="l20.54">               return cal.compareNativeTimeFilledAsc(nsA, nsB);</span>
<a href="#l20.55"></a><span id="l20.55">             } else {</span>
<a href="#l20.56"></a><span id="l20.56">               return cal.compareNativeTimeFilledDesc(nsA, nsB);</span>
<a href="#l20.57"></a><span id="l20.57">             }</span>
<a href="#l20.58"></a><span id="l20.58" class="difflineminus">-          }</span>
<a href="#l20.59"></a><span id="l20.59" class="difflineminus">-          return compareTimesFilled</span>
<a href="#l20.60"></a><span id="l20.60" class="difflineplus">+          };</span>
<a href="#l20.61"></a><span id="l20.61">         case &quot;string&quot;:</span>
<a href="#l20.62"></a><span id="l20.62" class="difflineminus">-          let collator = cal.createLocaleCollator();</span>
<a href="#l20.63"></a><span id="l20.63" class="difflineminus">-          function compareStrings(sortEntryA, sortEntryB) {</span>
<a href="#l20.64"></a><span id="l20.64" class="difflineplus">+          return function compareStrings(sortEntryA, sortEntryB) {</span>
<a href="#l20.65"></a><span id="l20.65">             let sA = cal.sortEntryKey(sortEntryA);</span>
<a href="#l20.66"></a><span id="l20.66">             let sB = cal.sortEntryKey(sortEntryB);</span>
<a href="#l20.67"></a><span id="l20.67">             if (sA.length == 0 || sB.length == 0) {</span>
<a href="#l20.68"></a><span id="l20.68">               // sort empty values to end (so when users first sort by a</span>
<a href="#l20.69"></a><span id="l20.69">               // column, they can see and find the desired values in that</span>
<a href="#l20.70"></a><span id="l20.70">               // column without scrolling past all the empty values).</span>
<a href="#l20.71"></a><span id="l20.71">               return -(sA.length - sB.length) * modifier;</span>
<a href="#l20.72"></a><span id="l20.72">             }</span>
<a href="#l20.73"></a><span id="l20.73" class="difflineplus">+            let collator = cal.createLocaleCollator();</span>
<a href="#l20.74"></a><span id="l20.74">             let comparison = collator.compareString(0, sA, sB);</span>
<a href="#l20.75"></a><span id="l20.75">             return comparison * modifier;</span>
<a href="#l20.76"></a><span id="l20.76" class="difflineminus">-          }</span>
<a href="#l20.77"></a><span id="l20.77" class="difflineminus">-          return compareStrings;</span>
<a href="#l20.78"></a><span id="l20.78" class="difflineminus">-</span>
<a href="#l20.79"></a><span id="l20.79" class="difflineplus">+          };</span>
<a href="#l20.80"></a><span id="l20.80">         default:</span>
<a href="#l20.81"></a><span id="l20.81" class="difflineminus">-          function compareOther(sortEntryA, sortEntryB) {</span>
<a href="#l20.82"></a><span id="l20.82" class="difflineplus">+          return function compareOther(sortEntryA, sortEntryB) {</span>
<a href="#l20.83"></a><span id="l20.83">             return 0;</span>
<a href="#l20.84"></a><span id="l20.84" class="difflineminus">-          }</span>
<a href="#l20.85"></a><span id="l20.85" class="difflineminus">-          return compareOther;</span>
<a href="#l20.86"></a><span id="l20.86" class="difflineplus">+          };</span>
<a href="#l20.87"></a><span id="l20.87">       }</span>
<a href="#l20.88"></a><span id="l20.88">     },</span>
<a href="#l20.89"></a><span id="l20.89"> </span>
<a href="#l20.90"></a><span id="l20.90">     getItemSortKey: function cal_getItemSortKey(aItem, aKey, aStartTime) {</span>
<a href="#l20.91"></a><span id="l20.91">       switch(aKey) {</span>
<a href="#l20.92"></a><span id="l20.92">         case &quot;priority&quot;:</span>
<a href="#l20.93"></a><span id="l20.93">           return aItem.priority || 5;</span>
<a href="#l20.94"></a><span id="l20.94"> </span>
<a href="#l20.95"></a><span id="l20.95" class="difflineat">@@ -521,16 +515,18 @@ let cal = {</span>
<a href="#l20.96"></a><span id="l20.96">         case &quot;dueDate&quot;:</span>
<a href="#l20.97"></a><span id="l20.97">         case &quot;entryDate&quot;:</span>
<a href="#l20.98"></a><span id="l20.98">           return &quot;date_filled&quot;;</span>
<a href="#l20.99"></a><span id="l20.99"> </span>
<a href="#l20.100"></a><span id="l20.100">         case &quot;priority&quot;:</span>
<a href="#l20.101"></a><span id="l20.101">         case &quot;percentComplete&quot;:</span>
<a href="#l20.102"></a><span id="l20.102">         case &quot;status&quot;:</span>
<a href="#l20.103"></a><span id="l20.103">           return &quot;number&quot;;</span>
<a href="#l20.104"></a><span id="l20.104" class="difflineplus">+        default:</span>
<a href="#l20.105"></a><span id="l20.105" class="difflineplus">+          return &quot;unknown&quot;;</span>
<a href="#l20.106"></a><span id="l20.106">       }</span>
<a href="#l20.107"></a><span id="l20.107">     },</span>
<a href="#l20.108"></a><span id="l20.108"> </span>
<a href="#l20.109"></a><span id="l20.109">     nativeTimeOrNow: function cal_nativeTimeOrNow(calDateTime, sortStartedTime) {</span>
<a href="#l20.110"></a><span id="l20.110">         // Treat null/0 as 'now' when sort started, so incomplete tasks stay current.</span>
<a href="#l20.111"></a><span id="l20.111">         // Time is computed once per sort (just before sort) so sort is stable.</span>
<a href="#l20.112"></a><span id="l20.112">         if (calDateTime == null) {</span>
<a href="#l20.113"></a><span id="l20.113">             return sortStartedTime.nativeTime;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/calendar/base/modules/calXMLUtils.jsm</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/calendar/base/modules/calXMLUtils.jsm</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -1,17 +1,17 @@</span>
<a href="#l21.4"></a><span id="l21.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l21.5"></a><span id="l21.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l21.6"></a><span id="l21.6">  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l21.7"></a><span id="l21.7"> </span>
<a href="#l21.8"></a><span id="l21.8"> /** Helper functions for parsing and serializing XML */</span>
<a href="#l21.9"></a><span id="l21.9"> </span>
<a href="#l21.10"></a><span id="l21.10"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l21.11"></a><span id="l21.11"> </span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-EXPORTED_SYMBOLS = [&quot;cal&quot;];</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+this.EXPORTED_SYMBOLS = [&quot;cal&quot;];</span>
<a href="#l21.14"></a><span id="l21.14"> cal.xml = {} || cal.xml;</span>
<a href="#l21.15"></a><span id="l21.15"> </span>
<a href="#l21.16"></a><span id="l21.16"> /**</span>
<a href="#l21.17"></a><span id="l21.17">  * Evaluate an XPath query for the given node. Be careful with the return value</span>
<a href="#l21.18"></a><span id="l21.18">  * here, as it may be:</span>
<a href="#l21.19"></a><span id="l21.19">  *</span>
<a href="#l21.20"></a><span id="l21.20">  * - null, if there are no results</span>
<a href="#l21.21"></a><span id="l21.21">  * - a number, string or boolean value</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/calendar/base/src/calAlarm.js</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/calendar/base/src/calAlarm.js</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -618,32 +618,33 @@ calAlarm.prototype = {</span>
<a href="#l22.4"></a><span id="l22.4">         }</span>
<a href="#l22.5"></a><span id="l22.5">     },</span>
<a href="#l22.6"></a><span id="l22.6"> </span>
<a href="#l22.7"></a><span id="l22.7">     get propertyEnumerator() {</span>
<a href="#l22.8"></a><span id="l22.8">         return this.mProperties.enumerator;</span>
<a href="#l22.9"></a><span id="l22.9">     },</span>
<a href="#l22.10"></a><span id="l22.10"> </span>
<a href="#l22.11"></a><span id="l22.11">     toString: function cA_toString(aItem) {</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineplus">+        function getItemBundleStringName(aPrefix) {</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineplus">+            if (!aItem || isEvent(aItem)) {</span>
<a href="#l22.14"></a><span id="l22.14" class="difflineplus">+                return aPrefix + &quot;Event&quot;;</span>
<a href="#l22.15"></a><span id="l22.15" class="difflineplus">+            } else if (isToDo(aItem)) {</span>
<a href="#l22.16"></a><span id="l22.16" class="difflineplus">+                return aPrefix + &quot;Task&quot;;</span>
<a href="#l22.17"></a><span id="l22.17" class="difflineplus">+            } else {</span>
<a href="#l22.18"></a><span id="l22.18" class="difflineplus">+                return aPrefix;</span>
<a href="#l22.19"></a><span id="l22.19" class="difflineplus">+            }</span>
<a href="#l22.20"></a><span id="l22.20" class="difflineplus">+        }</span>
<a href="#l22.21"></a><span id="l22.21" class="difflineplus">+</span>
<a href="#l22.22"></a><span id="l22.22">         if (this.related == ALARM_RELATED_ABSOLUTE &amp;&amp; this.mAbsoluteDate) {</span>
<a href="#l22.23"></a><span id="l22.23">             // this is an absolute alarm. Use the calendar default timezone and</span>
<a href="#l22.24"></a><span id="l22.24">             // format it.</span>
<a href="#l22.25"></a><span id="l22.25">             let formatter = cal.getDateFormatter();</span>
<a href="#l22.26"></a><span id="l22.26">             let formatDate = this.mAbsoluteDate.getInTimezone(cal.calendarDefaultTimezone());</span>
<a href="#l22.27"></a><span id="l22.27">             return formatter.formatDateTime(formatDate);</span>
<a href="#l22.28"></a><span id="l22.28">         } else if (this.related != ALARM_RELATED_ABSOLUTE &amp;&amp; this.mOffset) {</span>
<a href="#l22.29"></a><span id="l22.29" class="difflineminus">-            function getItemBundleStringName(aPrefix) {</span>
<a href="#l22.30"></a><span id="l22.30" class="difflineminus">-                if (!aItem || isEvent(aItem)) {</span>
<a href="#l22.31"></a><span id="l22.31" class="difflineminus">-                    return aPrefix + &quot;Event&quot;;</span>
<a href="#l22.32"></a><span id="l22.32" class="difflineminus">-                } else if (isToDo(aItem)) {</span>
<a href="#l22.33"></a><span id="l22.33" class="difflineminus">-                    return aPrefix + &quot;Task&quot;;</span>
<a href="#l22.34"></a><span id="l22.34" class="difflineminus">-                } else {</span>
<a href="#l22.35"></a><span id="l22.35" class="difflineminus">-                    return aPrefix;</span>
<a href="#l22.36"></a><span id="l22.36" class="difflineminus">-                }</span>
<a href="#l22.37"></a><span id="l22.37" class="difflineminus">-            }</span>
<a href="#l22.38"></a><span id="l22.38"> </span>
<a href="#l22.39"></a><span id="l22.39">             // Relative alarm length</span>
<a href="#l22.40"></a><span id="l22.40">             let alarmlen = Math.abs(this.mOffset.inSeconds / 60);</span>
<a href="#l22.41"></a><span id="l22.41">             if (alarmlen == 0) {</span>
<a href="#l22.42"></a><span id="l22.42">                 // No need to get the other information if the alarm is at the start</span>
<a href="#l22.43"></a><span id="l22.43">                 // of the event/task.</span>
<a href="#l22.44"></a><span id="l22.44">                 if (this.related == ALARM_RELATED_START) {</span>
<a href="#l22.45"></a><span id="l22.45">                     return calGetString(&quot;calendar-alarms&quot;,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/calendar/base/src/calCalendarManager.js</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/calendar/base/src/calCalendarManager.js</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -447,17 +447,17 @@ calCalendarManager.prototype = {</span>
<a href="#l23.4"></a><span id="l23.4">             if (ex instanceof Components.interfaces.nsIException) {</span>
<a href="#l23.5"></a><span id="l23.5">                 rc = ex.result;</span>
<a href="#l23.6"></a><span id="l23.6">                 uiMessage = ex.message;</span>
<a href="#l23.7"></a><span id="l23.7">             }</span>
<a href="#l23.8"></a><span id="l23.8">             switch (rc) {</span>
<a href="#l23.9"></a><span id="l23.9">                 case Components.interfaces.calIErrors.STORAGE_UNKNOWN_SCHEMA_ERROR:</span>
<a href="#l23.10"></a><span id="l23.10">                     // For now we alert and quit on schema errors like we've done before:</span>
<a href="#l23.11"></a><span id="l23.11">                     this.alertAndQuit();</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-                    return;</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineplus">+                    return null;</span>
<a href="#l23.14"></a><span id="l23.14">                 case Components.interfaces.calIErrors.STORAGE_UNKNOWN_TIMEZONES_ERROR:</span>
<a href="#l23.15"></a><span id="l23.15">                     uiMessage = calGetString(&quot;calendar&quot;, &quot;unknownTimezonesError&quot;, [uri.spec]);</span>
<a href="#l23.16"></a><span id="l23.16">                     break;</span>
<a href="#l23.17"></a><span id="l23.17">                 default:</span>
<a href="#l23.18"></a><span id="l23.18">                     uiMessage = calGetString(&quot;calendar&quot;, &quot;unableToCreateProvider&quot;, [uri.spec]);</span>
<a href="#l23.19"></a><span id="l23.19">                     break;</span>
<a href="#l23.20"></a><span id="l23.20">             }</span>
<a href="#l23.21"></a><span id="l23.21">             // Log the original exception via error console to provide more debug info</span>
<a href="#l23.22"></a><span id="l23.22" class="difflineat">@@ -941,73 +941,64 @@ calMgrCalendarObserver.prototype = {</span>
<a href="#l23.23"></a><span id="l23.23"> </span>
<a href="#l23.24"></a><span id="l23.24">         this.storedReadOnly = this.calendar.readOnly;</span>
<a href="#l23.25"></a><span id="l23.25">         var errorCode = calGetString(&quot;calendar&quot;,&quot;errorCode&quot;, [errCode]);</span>
<a href="#l23.26"></a><span id="l23.26">         var errorDescription = calGetString(&quot;calendar&quot;,&quot;errorDescription&quot;, [message]);</span>
<a href="#l23.27"></a><span id="l23.27">         var summary = errMsg + &quot; &quot; + errorCode + &quot;. &quot; + errorDescription;</span>
<a href="#l23.28"></a><span id="l23.28"> </span>
<a href="#l23.29"></a><span id="l23.29">         // Log warnings in error console.</span>
<a href="#l23.30"></a><span id="l23.30">         // Report serious errors in both error console and in prompt window.</span>
<a href="#l23.31"></a><span id="l23.31" class="difflineminus">-        var isSerious = (aErrNo == calIErrors.MODIFICATION_FAILED);</span>
<a href="#l23.32"></a><span id="l23.32" class="difflineminus">-        if (!isSerious) {</span>
<a href="#l23.33"></a><span id="l23.33" class="difflineminus">-            WARN(summary);</span>
<a href="#l23.34"></a><span id="l23.34" class="difflineminus">-        } else {</span>
<a href="#l23.35"></a><span id="l23.35" class="difflineminus">-            // Write error to console.</span>
<a href="#l23.36"></a><span id="l23.36" class="difflineplus">+        if (aErrNo == calIErrors.MODIFICATION_FAILED) {</span>
<a href="#l23.37"></a><span id="l23.37">             Components.utils.reportError(summary);</span>
<a href="#l23.38"></a><span id="l23.38" class="difflineminus">-</span>
<a href="#l23.39"></a><span id="l23.39" class="difflineminus">-            // silently don't do anything if this message already has</span>
<a href="#l23.40"></a><span id="l23.40" class="difflineminus">-            // been announced without being acknowledged.</span>
<a href="#l23.41"></a><span id="l23.41" class="difflineminus">-            if (this.announcedMessages.some(</span>
<a href="#l23.42"></a><span id="l23.42" class="difflineminus">-                function(element, index, array) {</span>
<a href="#l23.43"></a><span id="l23.43" class="difflineminus">-                    return equalMessage(paramBlock, element);</span>
<a href="#l23.44"></a><span id="l23.44" class="difflineminus">-                })) {</span>
<a href="#l23.45"></a><span id="l23.45" class="difflineminus">-                return;</span>
<a href="#l23.46"></a><span id="l23.46" class="difflineminus">-            }</span>
<a href="#l23.47"></a><span id="l23.47" class="difflineminus">-</span>
<a href="#l23.48"></a><span id="l23.48" class="difflineminus">-            // this message hasn't been announced recently, remember the</span>
<a href="#l23.49"></a><span id="l23.49" class="difflineminus">-            // details of the message for future reference.</span>
<a href="#l23.50"></a><span id="l23.50" class="difflineminus">-            this.announcedMessages.push(paramBlock);</span>
<a href="#l23.51"></a><span id="l23.51" class="difflineplus">+            this.announceParamBlock(paramBlock);</span>
<a href="#l23.52"></a><span id="l23.52" class="difflineplus">+        } else {</span>
<a href="#l23.53"></a><span id="l23.53" class="difflineplus">+            cal.WARN(summary);</span>
<a href="#l23.54"></a><span id="l23.54" class="difflineplus">+        }</span>
<a href="#l23.55"></a><span id="l23.55" class="difflineplus">+    },</span>
<a href="#l23.56"></a><span id="l23.56"> </span>
<a href="#l23.57"></a><span id="l23.57" class="difflineminus">-            // Display in prompt window.</span>
<a href="#l23.58"></a><span id="l23.58" class="difflineminus">-            var promptWindow =</span>
<a href="#l23.59"></a><span id="l23.59" class="difflineminus">-                Services.ww.openWindow</span>
<a href="#l23.60"></a><span id="l23.60" class="difflineminus">-                    (null, &quot;chrome://calendar/content/calendar-error-prompt.xul&quot;,</span>
<a href="#l23.61"></a><span id="l23.61" class="difflineminus">-                     &quot;_blank&quot;, &quot;chrome,dialog=yes,alwaysRaised=yes&quot;,</span>
<a href="#l23.62"></a><span id="l23.62" class="difflineminus">-                     paramBlock);</span>
<a href="#l23.63"></a><span id="l23.63" class="difflineminus">-            // Will remove paramBlock from announced messages when</span>
<a href="#l23.64"></a><span id="l23.64" class="difflineminus">-            // promptWindow is closed.  (Closing fires unloaded event, but</span>
<a href="#l23.65"></a><span id="l23.65" class="difflineminus">-            // promptWindow is also unloaded [to clean it?] before loading,</span>
<a href="#l23.66"></a><span id="l23.66" class="difflineminus">-            // so wait for detected load event before detecting unload event</span>
<a href="#l23.67"></a><span id="l23.67" class="difflineminus">-            // that signifies user closed this prompt window.)</span>
<a href="#l23.68"></a><span id="l23.68" class="difflineminus">-            var observer = this;</span>
<a href="#l23.69"></a><span id="l23.69" class="difflineminus">-            function awaitLoad(event) {</span>
<a href="#l23.70"></a><span id="l23.70" class="difflineminus">-                // #2 loaded, remove load listener</span>
<a href="#l23.71"></a><span id="l23.71" class="difflineminus">-                promptWindow.removeEventListener(&quot;load&quot;, awaitLoad, false);</span>
<a href="#l23.72"></a><span id="l23.72" class="difflineminus">-                function awaitUnload(event) {</span>
<a href="#l23.73"></a><span id="l23.73" class="difflineminus">-                    // #4 unloaded (user closed prompt window),</span>
<a href="#l23.74"></a><span id="l23.74" class="difflineminus">-                    // remove paramBlock and unload listener.</span>
<a href="#l23.75"></a><span id="l23.75" class="difflineminus">-                    try {</span>
<a href="#l23.76"></a><span id="l23.76" class="difflineminus">-                        // remove the message that has been shown from</span>
<a href="#l23.77"></a><span id="l23.77" class="difflineminus">-                        // the list of all announced messages.</span>
<a href="#l23.78"></a><span id="l23.78" class="difflineminus">-                        observer.announcedMessages =</span>
<a href="#l23.79"></a><span id="l23.79" class="difflineminus">-                            observer.announcedMessages.filter(function(msg) {</span>
<a href="#l23.80"></a><span id="l23.80" class="difflineminus">-                                return !equalMessage(msg, paramBlock);</span>
<a href="#l23.81"></a><span id="l23.81" class="difflineminus">-                            });</span>
<a href="#l23.82"></a><span id="l23.82" class="difflineminus">-                        promptWindow.removeEventListener(&quot;unload&quot;, awaitUnload,</span>
<a href="#l23.83"></a><span id="l23.83" class="difflineminus">-                                                         false);</span>
<a href="#l23.84"></a><span id="l23.84" class="difflineminus">-                    } catch (e) {</span>
<a href="#l23.85"></a><span id="l23.85" class="difflineminus">-                        Components.utils.reportError(e);</span>
<a href="#l23.86"></a><span id="l23.86" class="difflineminus">-                    }</span>
<a href="#l23.87"></a><span id="l23.87" class="difflineminus">-                }</span>
<a href="#l23.88"></a><span id="l23.88" class="difflineminus">-                // #3 add unload listener (wait for user to close promptWindow)</span>
<a href="#l23.89"></a><span id="l23.89" class="difflineminus">-                promptWindow.addEventListener(&quot;unload&quot;, awaitUnload, false);</span>
<a href="#l23.90"></a><span id="l23.90" class="difflineplus">+    announceParamBlock: function(paramBlock) {</span>
<a href="#l23.91"></a><span id="l23.91" class="difflineplus">+        function awaitLoad(event) {</span>
<a href="#l23.92"></a><span id="l23.92" class="difflineplus">+            promptWindow.removeEventListener(&quot;load&quot;, awaitLoad, false);</span>
<a href="#l23.93"></a><span id="l23.93" class="difflineplus">+            promptWindow.addEventListener(&quot;unload&quot;, awaitUnload, false);</span>
<a href="#l23.94"></a><span id="l23.94" class="difflineplus">+        }</span>
<a href="#l23.95"></a><span id="l23.95" class="difflineplus">+        let awaitUnload = (event) =&gt; {</span>
<a href="#l23.96"></a><span id="l23.96" class="difflineplus">+            promptWindow.removeEventListener(&quot;unload&quot;, awaitUnload, false);</span>
<a href="#l23.97"></a><span id="l23.97" class="difflineplus">+            // unloaded (user closed prompt window),</span>
<a href="#l23.98"></a><span id="l23.98" class="difflineplus">+            // remove paramBlock and unload listener.</span>
<a href="#l23.99"></a><span id="l23.99" class="difflineplus">+            try {</span>
<a href="#l23.100"></a><span id="l23.100" class="difflineplus">+                // remove the message that has been shown from</span>
<a href="#l23.101"></a><span id="l23.101" class="difflineplus">+                // the list of all announced messages.</span>
<a href="#l23.102"></a><span id="l23.102" class="difflineplus">+                this.announcedMessages = this.announcedMessages.filter((msg) =&gt; {</span>
<a href="#l23.103"></a><span id="l23.103" class="difflineplus">+                    return !equalMessage(msg, paramBlock);</span>
<a href="#l23.104"></a><span id="l23.104" class="difflineplus">+                });</span>
<a href="#l23.105"></a><span id="l23.105" class="difflineplus">+            } catch (e) {</span>
<a href="#l23.106"></a><span id="l23.106" class="difflineplus">+                Components.utils.reportError(e);</span>
<a href="#l23.107"></a><span id="l23.107">             }</span>
<a href="#l23.108"></a><span id="l23.108" class="difflineminus">-            // #1 add load listener</span>
<a href="#l23.109"></a><span id="l23.109" class="difflineminus">-            promptWindow.addEventListener(&quot;load&quot;, awaitLoad, false);</span>
<a href="#l23.110"></a><span id="l23.110" class="difflineplus">+        };</span>
<a href="#l23.111"></a><span id="l23.111" class="difflineplus">+</span>
<a href="#l23.112"></a><span id="l23.112" class="difflineplus">+        // silently don't do anything if this message already has been</span>
<a href="#l23.113"></a><span id="l23.113" class="difflineplus">+        // announced without being acknowledged.</span>
<a href="#l23.114"></a><span id="l23.114" class="difflineplus">+        if (this.announcedMessages.some(equalMessage.bind(null, paramBlock))) {</span>
<a href="#l23.115"></a><span id="l23.115" class="difflineplus">+            return;</span>
<a href="#l23.116"></a><span id="l23.116">         }</span>
<a href="#l23.117"></a><span id="l23.117" class="difflineplus">+</span>
<a href="#l23.118"></a><span id="l23.118" class="difflineplus">+        // this message hasn't been announced recently, remember the details of</span>
<a href="#l23.119"></a><span id="l23.119" class="difflineplus">+        // the message for future reference.</span>
<a href="#l23.120"></a><span id="l23.120" class="difflineplus">+        this.announcedMessages.push(paramBlock);</span>
<a href="#l23.121"></a><span id="l23.121" class="difflineplus">+</span>
<a href="#l23.122"></a><span id="l23.122" class="difflineplus">+        // Will remove paramBlock from announced messages when promptWindow is</span>
<a href="#l23.123"></a><span id="l23.123" class="difflineplus">+        // closed.  (Closing fires unloaded event, but promptWindow is also</span>
<a href="#l23.124"></a><span id="l23.124" class="difflineplus">+        // unloaded [to clean it?] before loading, so wait for detected load</span>
<a href="#l23.125"></a><span id="l23.125" class="difflineplus">+        // event before detecting unload event that signifies user closed this</span>
<a href="#l23.126"></a><span id="l23.126" class="difflineplus">+        // prompt window.)</span>
<a href="#l23.127"></a><span id="l23.127" class="difflineplus">+        let promptUrl = &quot;chrome://calendar/content/calendar-error-prompt.xul&quot;;</span>
<a href="#l23.128"></a><span id="l23.128" class="difflineplus">+        let features = &quot;chrome,dialog=yes,alwaysRaised=yes&quot;;</span>
<a href="#l23.129"></a><span id="l23.129" class="difflineplus">+        let promptWindow =  Services.ww.openWindow(null, url, &quot;_blank&quot;,</span>
<a href="#l23.130"></a><span id="l23.130" class="difflineplus">+                                                   features, paramBlock);</span>
<a href="#l23.131"></a><span id="l23.131" class="difflineplus">+        promptWindow.addEventListener(&quot;load&quot;, awaitLoad, false);</span>
<a href="#l23.132"></a><span id="l23.132">     }</span>
<a href="#l23.133"></a><span id="l23.133"> };</span>
<a href="#l23.134"></a><span id="l23.134"> </span>
<a href="#l23.135"></a><span id="l23.135"> function calDummyCalendar(type) {</span>
<a href="#l23.136"></a><span id="l23.136">     this.initProviderBase();</span>
<a href="#l23.137"></a><span id="l23.137">     this.type = type;</span>
<a href="#l23.138"></a><span id="l23.138"> }</span>
<a href="#l23.139"></a><span id="l23.139"> calDummyCalendar.prototype = {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/calendar/base/src/calTimezoneService.js</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/calendar/base/src/calTimezoneService.js</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -284,16 +284,21 @@ function guessSystemTimezone() {</span>
<a href="#l24.4"></a><span id="l24.4">     const tzNameJun = nameDataJun &amp;&amp; nameDataJun[2];</span>
<a href="#l24.5"></a><span id="l24.5">     const tzNameDec = nameDataDec &amp;&amp; nameDataDec[2];</span>
<a href="#l24.6"></a><span id="l24.6">     const offsetRegex = /[+-]\d{4}/;</span>
<a href="#l24.7"></a><span id="l24.7">     const offsetJun = dateJun.match(offsetRegex)[0];</span>
<a href="#l24.8"></a><span id="l24.8">     const offsetDec = dateDec.match(offsetRegex)[0];</span>
<a href="#l24.9"></a><span id="l24.9"> </span>
<a href="#l24.10"></a><span id="l24.10">     const tzSvc = cal.getTimezoneService();</span>
<a href="#l24.11"></a><span id="l24.11"> </span>
<a href="#l24.12"></a><span id="l24.12" class="difflineplus">+    var continent = &quot;Africa|America|Antarctica|Asia|Australia|Europe&quot;;</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineplus">+    var ocean     = &quot;Arctic|Atlantic|Indian|Pacific&quot;;</span>
<a href="#l24.14"></a><span id="l24.14" class="difflineplus">+    var tzRegex   = new RegExp(&quot;.*((?:&quot;+continent+&quot;|&quot;+ocean+&quot;)&quot;+</span>
<a href="#l24.15"></a><span id="l24.15" class="difflineplus">+                               &quot;(?:[/][-A-Z_a-z]+)+)&quot;);</span>
<a href="#l24.16"></a><span id="l24.16" class="difflineplus">+</span>
<a href="#l24.17"></a><span id="l24.17">     function getIcalString(component, property) {</span>
<a href="#l24.18"></a><span id="l24.18">         var prop = (component &amp;&amp; component.getFirstProperty(property));</span>
<a href="#l24.19"></a><span id="l24.19">         return (prop ? prop.valueAsIcalString : null);</span>
<a href="#l24.20"></a><span id="l24.20">     }</span>
<a href="#l24.21"></a><span id="l24.21"> </span>
<a href="#l24.22"></a><span id="l24.22">     // Check if Olson ZoneInfo timezone matches OS/JSDate timezone properties:</span>
<a href="#l24.23"></a><span id="l24.23">     // * standard offset and daylight/summer offset if present (longitude),</span>
<a href="#l24.24"></a><span id="l24.24">     // * if has summer time, direction of change (northern/southern hemisphere)</span>
<a href="#l24.25"></a><span id="l24.25" class="difflineat">@@ -476,16 +481,79 @@ function guessSystemTimezone() {</span>
<a href="#l24.26"></a><span id="l24.26">                     }</span>
<a href="#l24.27"></a><span id="l24.27">                 }</span>
<a href="#l24.28"></a><span id="l24.28">             }</span>
<a href="#l24.29"></a><span id="l24.29">         }</span>
<a href="#l24.30"></a><span id="l24.30">         // no such period found</span>
<a href="#l24.31"></a><span id="l24.31">         return null;</span>
<a href="#l24.32"></a><span id="l24.32">     }</span>
<a href="#l24.33"></a><span id="l24.33"> </span>
<a href="#l24.34"></a><span id="l24.34" class="difflineplus">+    function environmentVariableValue(varName) {</span>
<a href="#l24.35"></a><span id="l24.35" class="difflineplus">+        let envSvc = Components.classes[&quot;@mozilla.org/process/environment;1&quot;]</span>
<a href="#l24.36"></a><span id="l24.36" class="difflineplus">+                                .getService(Components.interfaces.nsIEnvironment);</span>
<a href="#l24.37"></a><span id="l24.37" class="difflineplus">+        let value = envSvc.get(varName);</span>
<a href="#l24.38"></a><span id="l24.38" class="difflineplus">+        if (!value) return &quot;&quot;;</span>
<a href="#l24.39"></a><span id="l24.39" class="difflineplus">+        if (!value.match(tzRegex)) return &quot;&quot;;</span>
<a href="#l24.40"></a><span id="l24.40" class="difflineplus">+        return varName+&quot;=&quot;+value;</span>
<a href="#l24.41"></a><span id="l24.41" class="difflineplus">+    }</span>
<a href="#l24.42"></a><span id="l24.42" class="difflineplus">+</span>
<a href="#l24.43"></a><span id="l24.43" class="difflineplus">+    function symbolicLinkTarget(filepath) {</span>
<a href="#l24.44"></a><span id="l24.44" class="difflineplus">+        try {</span>
<a href="#l24.45"></a><span id="l24.45" class="difflineplus">+            let file = Components.classes[&quot;@mozilla.org/file/local;1&quot;]</span>
<a href="#l24.46"></a><span id="l24.46" class="difflineplus">+                                 .createInstance(Components.interfaces.nsILocalFile);</span>
<a href="#l24.47"></a><span id="l24.47" class="difflineplus">+            file.initWithPath(filepath);</span>
<a href="#l24.48"></a><span id="l24.48" class="difflineplus">+            file.QueryInterface(Components.interfaces.nsIFile);</span>
<a href="#l24.49"></a><span id="l24.49" class="difflineplus">+            if (!file.exists()) return &quot;&quot;;</span>
<a href="#l24.50"></a><span id="l24.50" class="difflineplus">+            if (!file.isSymlink()) return &quot;&quot;;</span>
<a href="#l24.51"></a><span id="l24.51" class="difflineplus">+            if (!file.target.match(tzRegex)) return &quot;&quot;;</span>
<a href="#l24.52"></a><span id="l24.52" class="difflineplus">+            return filepath +&quot; -&gt; &quot;+file.target;</span>
<a href="#l24.53"></a><span id="l24.53" class="difflineplus">+        } catch (ex) {</span>
<a href="#l24.54"></a><span id="l24.54" class="difflineplus">+            Components.utils.reportError(filepath+&quot;: &quot;+ex);</span>
<a href="#l24.55"></a><span id="l24.55" class="difflineplus">+            return &quot;&quot;;</span>
<a href="#l24.56"></a><span id="l24.56" class="difflineplus">+        }</span>
<a href="#l24.57"></a><span id="l24.57" class="difflineplus">+    }</span>
<a href="#l24.58"></a><span id="l24.58" class="difflineplus">+</span>
<a href="#l24.59"></a><span id="l24.59" class="difflineplus">+    function fileFirstZoneLineString(filepath) {</span>
<a href="#l24.60"></a><span id="l24.60" class="difflineplus">+        // return first line of file that matches tzRegex (ZoneInfo id),</span>
<a href="#l24.61"></a><span id="l24.61" class="difflineplus">+        // or &quot;&quot; if no file or no matching line.</span>
<a href="#l24.62"></a><span id="l24.62" class="difflineplus">+        try {</span>
<a href="#l24.63"></a><span id="l24.63" class="difflineplus">+            let file = Components.classes[&quot;@mozilla.org/file/local;1&quot;]</span>
<a href="#l24.64"></a><span id="l24.64" class="difflineplus">+                                 .createInstance(Components.interfaces.nsILocalFile);</span>
<a href="#l24.65"></a><span id="l24.65" class="difflineplus">+            file.initWithPath(filepath);</span>
<a href="#l24.66"></a><span id="l24.66" class="difflineplus">+            file.QueryInterface(Components.interfaces.nsIFile);</span>
<a href="#l24.67"></a><span id="l24.67" class="difflineplus">+            if (!file.exists()) return &quot;&quot;;</span>
<a href="#l24.68"></a><span id="l24.68" class="difflineplus">+            let fileInstream = Components.classes[&quot;@mozilla.org/network/file-input-stream;1&quot;]</span>
<a href="#l24.69"></a><span id="l24.69" class="difflineplus">+                                         .createInstance(Components.interfaces.nsIFileInputStream);</span>
<a href="#l24.70"></a><span id="l24.70" class="difflineplus">+            const PR_RDONLY = 0x1;</span>
<a href="#l24.71"></a><span id="l24.71" class="difflineplus">+            fileInstream.init(file, PR_RDONLY, 0, 0);</span>
<a href="#l24.72"></a><span id="l24.72" class="difflineplus">+            fileInstream.QueryInterface(Components.interfaces.nsILineInputStream);</span>
<a href="#l24.73"></a><span id="l24.73" class="difflineplus">+            try {</span>
<a href="#l24.74"></a><span id="l24.74" class="difflineplus">+                let line = {}, hasMore = true, MAXLINES = 10;</span>
<a href="#l24.75"></a><span id="l24.75" class="difflineplus">+                for (let i = 0; hasMore &amp;&amp; i &lt; MAXLINES; i++) {</span>
<a href="#l24.76"></a><span id="l24.76" class="difflineplus">+                    hasMore = fileInstream.readLine(line);</span>
<a href="#l24.77"></a><span id="l24.77" class="difflineplus">+                    if (line.value &amp;&amp; line.value.match(tzRegex)) {</span>
<a href="#l24.78"></a><span id="l24.78" class="difflineplus">+                        return filepath+&quot;: &quot;+line.value;</span>
<a href="#l24.79"></a><span id="l24.79" class="difflineplus">+                    }</span>
<a href="#l24.80"></a><span id="l24.80" class="difflineplus">+                }</span>
<a href="#l24.81"></a><span id="l24.81" class="difflineplus">+                return &quot;&quot;; // not found</span>
<a href="#l24.82"></a><span id="l24.82" class="difflineplus">+            } finally {</span>
<a href="#l24.83"></a><span id="l24.83" class="difflineplus">+                fileInstream.close();</span>
<a href="#l24.84"></a><span id="l24.84" class="difflineplus">+            }</span>
<a href="#l24.85"></a><span id="l24.85" class="difflineplus">+        } catch (ex) {</span>
<a href="#l24.86"></a><span id="l24.86" class="difflineplus">+            Components.utils.reportError(filepath+&quot;: &quot;+ex);</span>
<a href="#l24.87"></a><span id="l24.87" class="difflineplus">+            return &quot;&quot;;</span>
<a href="#l24.88"></a><span id="l24.88" class="difflineplus">+        }</span>
<a href="#l24.89"></a><span id="l24.89" class="difflineplus">+    }</span>
<a href="#l24.90"></a><span id="l24.90" class="difflineplus">+</span>
<a href="#l24.91"></a><span id="l24.91" class="difflineplus">+    function weekday(icsDate, tz) {</span>
<a href="#l24.92"></a><span id="l24.92" class="difflineplus">+        let calDate = cal.createDateTime(icsDate);</span>
<a href="#l24.93"></a><span id="l24.93" class="difflineplus">+        calDate.timezone = tz;</span>
<a href="#l24.94"></a><span id="l24.94" class="difflineplus">+        return calDate.jsDate.toLocaleFormat(&quot;%a&quot;);</span>
<a href="#l24.95"></a><span id="l24.95" class="difflineplus">+    }</span>
<a href="#l24.96"></a><span id="l24.96" class="difflineplus">+</span>
<a href="#l24.97"></a><span id="l24.97">     // Try to find a tz that matches OS/JSDate timezone.  If no name match,</span>
<a href="#l24.98"></a><span id="l24.98">     // will use first of probable timezone(s) with highest score.</span>
<a href="#l24.99"></a><span id="l24.99">     var probableTZId = &quot;floating&quot;; // default fallback tz if no tz matches.</span>
<a href="#l24.100"></a><span id="l24.100">     var probableTZScore = 0;</span>
<a href="#l24.101"></a><span id="l24.101">     var probableTZSource = null;</span>
<a href="#l24.102"></a><span id="l24.102"> </span>
<a href="#l24.103"></a><span id="l24.103">     const calProperties = Services.strings.createBundle(&quot;chrome://calendar/locale/calendar.properties&quot;);</span>
<a href="#l24.104"></a><span id="l24.104"> </span>
<a href="#l24.105"></a><span id="l24.105" class="difflineat">@@ -554,84 +622,22 @@ function guessSystemTimezone() {</span>
<a href="#l24.106"></a><span id="l24.106">             // The timezone is set per user via the TZ environment variable.</span>
<a href="#l24.107"></a><span id="l24.107">             // TZ may contain a path that may start with a colon and ends with</span>
<a href="#l24.108"></a><span id="l24.108">             // a ZoneInfo timezone identifier, such as &quot;:America/New_York&quot; or</span>
<a href="#l24.109"></a><span id="l24.109">             // &quot;:/share/lib/zoneinfo/America/New_York&quot;.  The others are</span>
<a href="#l24.110"></a><span id="l24.110">             // in the filesystem so they give one timezone for the system;</span>
<a href="#l24.111"></a><span id="l24.111">             // the values are similar (but cannot have a leading colon).</span>
<a href="#l24.112"></a><span id="l24.112">             // (Note: the OS ZoneInfo database may be a different version from</span>
<a href="#l24.113"></a><span id="l24.113">             // the one we use, so still need to check that DST dates match.)</span>
<a href="#l24.114"></a><span id="l24.114" class="difflineminus">-            var continent = &quot;Africa|America|Antarctica|Asia|Australia|Europe&quot;;</span>
<a href="#l24.115"></a><span id="l24.115" class="difflineminus">-            var ocean     = &quot;Arctic|Atlantic|Indian|Pacific&quot;;</span>
<a href="#l24.116"></a><span id="l24.116" class="difflineminus">-            var tzRegex   = new RegExp(&quot;.*((?:&quot;+continent+&quot;|&quot;+ocean+&quot;)&quot;+</span>
<a href="#l24.117"></a><span id="l24.117" class="difflineminus">-                                       &quot;(?:[/][-A-Z_a-z]+)+)&quot;);</span>
<a href="#l24.118"></a><span id="l24.118" class="difflineminus">-            const CC = Components.classes;</span>
<a href="#l24.119"></a><span id="l24.119" class="difflineminus">-            const CI = Components.interfaces;</span>
<a href="#l24.120"></a><span id="l24.120" class="difflineminus">-            var envSvc = (CC[&quot;@mozilla.org/process/environment;1&quot;]</span>
<a href="#l24.121"></a><span id="l24.121" class="difflineminus">-                          .getService(Components.interfaces.nsIEnvironment));</span>
<a href="#l24.122"></a><span id="l24.122" class="difflineminus">-            function environmentVariableValue(varName) {</span>
<a href="#l24.123"></a><span id="l24.123" class="difflineminus">-                var value = envSvc.get(varName);</span>
<a href="#l24.124"></a><span id="l24.124" class="difflineminus">-                if (!value) return &quot;&quot;;</span>
<a href="#l24.125"></a><span id="l24.125" class="difflineminus">-                if (!value.match(tzRegex)) return &quot;&quot;;</span>
<a href="#l24.126"></a><span id="l24.126" class="difflineminus">-                return varName+&quot;=&quot;+value;</span>
<a href="#l24.127"></a><span id="l24.127" class="difflineminus">-            }</span>
<a href="#l24.128"></a><span id="l24.128" class="difflineminus">-            function symbolicLinkTarget(filepath) {</span>
<a href="#l24.129"></a><span id="l24.129" class="difflineminus">-                try {</span>
<a href="#l24.130"></a><span id="l24.130" class="difflineminus">-                    var file = (CC[&quot;@mozilla.org/file/local;1&quot;]</span>
<a href="#l24.131"></a><span id="l24.131" class="difflineminus">-                                .createInstance(CI.nsILocalFile));</span>
<a href="#l24.132"></a><span id="l24.132" class="difflineminus">-                    file.initWithPath(filepath);</span>
<a href="#l24.133"></a><span id="l24.133" class="difflineminus">-                    file.QueryInterface(CI.nsIFile);</span>
<a href="#l24.134"></a><span id="l24.134" class="difflineminus">-                    if (!file.exists()) return &quot;&quot;;</span>
<a href="#l24.135"></a><span id="l24.135" class="difflineminus">-                    if (!file.isSymlink()) return &quot;&quot;;</span>
<a href="#l24.136"></a><span id="l24.136" class="difflineminus">-                    if (!file.target.match(tzRegex)) return &quot;&quot;;</span>
<a href="#l24.137"></a><span id="l24.137" class="difflineminus">-                    return filepath +&quot; -&gt; &quot;+file.target;</span>
<a href="#l24.138"></a><span id="l24.138" class="difflineminus">-                } catch (ex) {</span>
<a href="#l24.139"></a><span id="l24.139" class="difflineminus">-                    Components.utils.reportError(filepath+&quot;: &quot;+ex);</span>
<a href="#l24.140"></a><span id="l24.140" class="difflineminus">-                    return &quot;&quot;;</span>
<a href="#l24.141"></a><span id="l24.141" class="difflineminus">-                }</span>
<a href="#l24.142"></a><span id="l24.142" class="difflineminus">-            }</span>
<a href="#l24.143"></a><span id="l24.143" class="difflineminus">-            function fileFirstZoneLineString(filepath) {</span>
<a href="#l24.144"></a><span id="l24.144" class="difflineminus">-                // return first line of file that matches tzRegex (ZoneInfo id),</span>
<a href="#l24.145"></a><span id="l24.145" class="difflineminus">-                // or &quot;&quot; if no file or no matching line.</span>
<a href="#l24.146"></a><span id="l24.146" class="difflineminus">-                try {</span>
<a href="#l24.147"></a><span id="l24.147" class="difflineminus">-                    var file = (CC[&quot;@mozilla.org/file/local;1&quot;]</span>
<a href="#l24.148"></a><span id="l24.148" class="difflineminus">-                                .createInstance(CI.nsILocalFile));</span>
<a href="#l24.149"></a><span id="l24.149" class="difflineminus">-                    file.initWithPath(filepath);</span>
<a href="#l24.150"></a><span id="l24.150" class="difflineminus">-                    file.QueryInterface(CI.nsIFile);</span>
<a href="#l24.151"></a><span id="l24.151" class="difflineminus">-                    if (!file.exists()) return &quot;&quot;;</span>
<a href="#l24.152"></a><span id="l24.152" class="difflineminus">-                    var fileInstream =</span>
<a href="#l24.153"></a><span id="l24.153" class="difflineminus">-                        (CC[&quot;@mozilla.org/network/file-input-stream;1&quot;].</span>
<a href="#l24.154"></a><span id="l24.154" class="difflineminus">-                         createInstance(CI.nsIFileInputStream));</span>
<a href="#l24.155"></a><span id="l24.155" class="difflineminus">-                    const PR_RDONLY = 0x1;</span>
<a href="#l24.156"></a><span id="l24.156" class="difflineminus">-                    fileInstream.init(file, PR_RDONLY, 0, 0);</span>
<a href="#l24.157"></a><span id="l24.157" class="difflineminus">-                    fileInstream.QueryInterface(CI.nsILineInputStream);</span>
<a href="#l24.158"></a><span id="l24.158" class="difflineminus">-                    try {</span>
<a href="#l24.159"></a><span id="l24.159" class="difflineminus">-                        var line = {}, hasMore = true, MAXLINES = 10;</span>
<a href="#l24.160"></a><span id="l24.160" class="difflineminus">-                        for (var i = 0; hasMore &amp;&amp; i &lt; MAXLINES; i++) {</span>
<a href="#l24.161"></a><span id="l24.161" class="difflineminus">-                            hasMore = fileInstream.readLine(line);</span>
<a href="#l24.162"></a><span id="l24.162" class="difflineminus">-                            if (line.value &amp;&amp; line.value.match(tzRegex)) {</span>
<a href="#l24.163"></a><span id="l24.163" class="difflineminus">-                                return filepath+&quot;: &quot;+line.value;</span>
<a href="#l24.164"></a><span id="l24.164" class="difflineminus">-                            }</span>
<a href="#l24.165"></a><span id="l24.165" class="difflineminus">-                        }</span>
<a href="#l24.166"></a><span id="l24.166" class="difflineminus">-                        return &quot;&quot;; // not found</span>
<a href="#l24.167"></a><span id="l24.167" class="difflineminus">-                    } finally {</span>
<a href="#l24.168"></a><span id="l24.168" class="difflineminus">-                        fileInstream.close();</span>
<a href="#l24.169"></a><span id="l24.169" class="difflineminus">-                    }</span>
<a href="#l24.170"></a><span id="l24.170" class="difflineminus">-                } catch (ex) {</span>
<a href="#l24.171"></a><span id="l24.171" class="difflineminus">-                    Components.utils.reportError(filepath+&quot;: &quot;+ex);</span>
<a href="#l24.172"></a><span id="l24.172" class="difflineminus">-                    return &quot;&quot;;</span>
<a href="#l24.173"></a><span id="l24.173" class="difflineminus">-                }</span>
<a href="#l24.174"></a><span id="l24.174" class="difflineminus">-</span>
<a href="#l24.175"></a><span id="l24.175" class="difflineminus">-            }</span>
<a href="#l24.176"></a><span id="l24.176">             osUserTimeZone = (environmentVariableValue(&quot;TZ&quot;) ||</span>
<a href="#l24.177"></a><span id="l24.177">                               symbolicLinkTarget(&quot;/etc/localtime&quot;) ||</span>
<a href="#l24.178"></a><span id="l24.178">                               fileFirstZoneLineString(&quot;/etc/TIMEZONE&quot;) ||</span>
<a href="#l24.179"></a><span id="l24.179">                               fileFirstZoneLineString(&quot;/etc/timezone&quot;) ||</span>
<a href="#l24.180"></a><span id="l24.180">                               fileFirstZoneLineString(&quot;/etc/sysconfig/clock&quot;));</span>
<a href="#l24.181"></a><span id="l24.181" class="difflineminus">-            var results = osUserTimeZone.match(tzRegex);</span>
<a href="#l24.182"></a><span id="l24.182" class="difflineplus">+            let results = osUserTimeZone.match(tzRegex);</span>
<a href="#l24.183"></a><span id="l24.183">             if (results) {</span>
<a href="#l24.184"></a><span id="l24.184">                 zoneInfoIdFromOSUserTimeZone = results[1];</span>
<a href="#l24.185"></a><span id="l24.185">             }</span>
<a href="#l24.186"></a><span id="l24.186">         }</span>
<a href="#l24.187"></a><span id="l24.187"> </span>
<a href="#l24.188"></a><span id="l24.188">         // check how well OS tz matches tz defined in our version of zoneinfo db</span>
<a href="#l24.189"></a><span id="l24.189">         if (zoneInfoIdFromOSUserTimeZone != null) {</span>
<a href="#l24.190"></a><span id="l24.190">             var tzId = zoneInfoIdFromOSUserTimeZone;</span>
<a href="#l24.191"></a><span id="l24.191" class="difflineat">@@ -744,30 +750,24 @@ function guessSystemTimezone() {</span>
<a href="#l24.192"></a><span id="l24.192">             var standard = findCurrentTimePeriod(tz, subComp, &quot;STANDARD&quot;);</span>
<a href="#l24.193"></a><span id="l24.193">             var standardTZOffset = getIcalString(standard, &quot;TZOFFSETTO&quot;);</span>
<a href="#l24.194"></a><span id="l24.194">             var daylight = findCurrentTimePeriod(tz, subComp, &quot;DAYLIGHT&quot;);</span>
<a href="#l24.195"></a><span id="l24.195">             var daylightTZOffset = getIcalString(daylight, &quot;TZOFFSETTO&quot;);</span>
<a href="#l24.196"></a><span id="l24.196">             var warningDetail;</span>
<a href="#l24.197"></a><span id="l24.197">             if (probableTZScore == 1) {</span>
<a href="#l24.198"></a><span id="l24.198">                 // score 1 means has daylight time,</span>
<a href="#l24.199"></a><span id="l24.199">                 // but transitions start on different weekday from os timezone.</span>
<a href="#l24.200"></a><span id="l24.200" class="difflineminus">-                function weekday(icsDate) {</span>
<a href="#l24.201"></a><span id="l24.201" class="difflineminus">-                    var calDate = cal.createDateTime();</span>
<a href="#l24.202"></a><span id="l24.202" class="difflineminus">-                    calDate.icalString = icsDate;</span>
<a href="#l24.203"></a><span id="l24.203" class="difflineminus">-                    calDate.timezone = tz;</span>
<a href="#l24.204"></a><span id="l24.204" class="difflineminus">-                    return cal.dateTimeToJsDate(calDate).toLocaleFormat(&quot;%a&quot;);</span>
<a href="#l24.205"></a><span id="l24.205" class="difflineminus">-                }</span>
<a href="#l24.206"></a><span id="l24.206">                 var standardStart = getIcalString(standard, &quot;DTSTART&quot;);</span>
<a href="#l24.207"></a><span id="l24.207" class="difflineminus">-                var standardStartWeekday = weekday(standardStart);</span>
<a href="#l24.208"></a><span id="l24.208" class="difflineplus">+                var standardStartWeekday = weekday(standardStart, tz);</span>
<a href="#l24.209"></a><span id="l24.209">                 var standardRule  = getIcalString(standard, &quot;RRULE&quot;);</span>
<a href="#l24.210"></a><span id="l24.210">                 var standardText =</span>
<a href="#l24.211"></a><span id="l24.211">                     (&quot;  Standard: &quot;+standardStart+&quot; &quot;+standardStartWeekday+&quot;\n&quot;+</span>
<a href="#l24.212"></a><span id="l24.212">                      &quot;            &quot;+standardRule+&quot;\n&quot;);</span>
<a href="#l24.213"></a><span id="l24.213">                 var daylightStart = getIcalString(daylight, &quot;DTSTART&quot;);</span>
<a href="#l24.214"></a><span id="l24.214" class="difflineminus">-                var daylightStartWeekday = weekday(daylightStart);</span>
<a href="#l24.215"></a><span id="l24.215" class="difflineplus">+                var daylightStartWeekday = weekday(daylightStart, tz);</span>
<a href="#l24.216"></a><span id="l24.216">                 var daylightRule  = getIcalString(daylight, &quot;RRULE&quot;);</span>
<a href="#l24.217"></a><span id="l24.217">                 var daylightText =</span>
<a href="#l24.218"></a><span id="l24.218">                     (&quot;  Daylight: &quot;+daylightStart+&quot; &quot;+daylightStartWeekday+&quot;\n&quot;+</span>
<a href="#l24.219"></a><span id="l24.219">                      &quot;            &quot;+daylightRule+&quot;\n&quot;);</span>
<a href="#l24.220"></a><span id="l24.220">                 warningDetail =</span>
<a href="#l24.221"></a><span id="l24.221">                     ((standardStart &lt; daylightStart</span>
<a href="#l24.222"></a><span id="l24.222">                       ? standardText + daylightText</span>
<a href="#l24.223"></a><span id="l24.223">                       : daylightText + standardText)+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/calendar/base/src/calTransactionManager.js</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/calendar/base/src/calTransactionManager.js</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -46,36 +46,24 @@ calTransactionManager.prototype = {</span>
<a href="#l25.4"></a><span id="l25.4">         this.transactionManager.beginBatch(null);</span>
<a href="#l25.5"></a><span id="l25.5">     },</span>
<a href="#l25.6"></a><span id="l25.6"> </span>
<a href="#l25.7"></a><span id="l25.7">     endBatch: function cTM_endBatch() {</span>
<a href="#l25.8"></a><span id="l25.8">         this.transactionManager.endBatch(false);</span>
<a href="#l25.9"></a><span id="l25.9">     },</span>
<a href="#l25.10"></a><span id="l25.10"> </span>
<a href="#l25.11"></a><span id="l25.11">     checkWritable: function cTM_checkWritable(transaction) {</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-        if (transaction) {</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineminus">-            transaction = transaction.wrappedJSObject;</span>
<a href="#l25.14"></a><span id="l25.14" class="difflineminus">-            if (transaction) {</span>
<a href="#l25.15"></a><span id="l25.15" class="difflineminus">-                function checkItem(item) {</span>
<a href="#l25.16"></a><span id="l25.16" class="difflineminus">-                    if (item) {</span>
<a href="#l25.17"></a><span id="l25.17" class="difflineminus">-                        var calendar = item.calendar;</span>
<a href="#l25.18"></a><span id="l25.18" class="difflineminus">-                        if (calendar &amp;&amp; (!isCalendarWritable(calendar) || !userCanAddItemsToCalendar(calendar))) {</span>
<a href="#l25.19"></a><span id="l25.19" class="difflineminus">-                            return false;</span>
<a href="#l25.20"></a><span id="l25.20" class="difflineminus">-                        }</span>
<a href="#l25.21"></a><span id="l25.21" class="difflineminus">-                    }</span>
<a href="#l25.22"></a><span id="l25.22" class="difflineminus">-                    return true;</span>
<a href="#l25.23"></a><span id="l25.23" class="difflineminus">-                }</span>
<a href="#l25.24"></a><span id="l25.24" class="difflineplus">+        function checkItem(item) {</span>
<a href="#l25.25"></a><span id="l25.25" class="difflineplus">+            return item &amp;&amp; item.calendar &amp;&amp;</span>
<a href="#l25.26"></a><span id="l25.26" class="difflineplus">+                   isCalendarWritable(item.calendar) &amp;&amp;</span>
<a href="#l25.27"></a><span id="l25.27" class="difflineplus">+                   userCanAddItemsToCalendar(item.calendar);</span>
<a href="#l25.28"></a><span id="l25.28" class="difflineplus">+        }</span>
<a href="#l25.29"></a><span id="l25.29"> </span>
<a href="#l25.30"></a><span id="l25.30" class="difflineminus">-                if (!checkItem(transaction.mItem) ||</span>
<a href="#l25.31"></a><span id="l25.31" class="difflineminus">-                    !checkItem(transaction.mOldItem)) {</span>
<a href="#l25.32"></a><span id="l25.32" class="difflineminus">-                    return false;</span>
<a href="#l25.33"></a><span id="l25.33" class="difflineminus">-                }</span>
<a href="#l25.34"></a><span id="l25.34" class="difflineminus">-            }</span>
<a href="#l25.35"></a><span id="l25.35" class="difflineminus">-        }</span>
<a href="#l25.36"></a><span id="l25.36" class="difflineminus">-        return true;</span>
<a href="#l25.37"></a><span id="l25.37" class="difflineplus">+        let trans = transaction &amp;&amp; transaction.wrappedJSObject;</span>
<a href="#l25.38"></a><span id="l25.38" class="difflineplus">+        return trans &amp;&amp; checkItem(trans.mItem) &amp;&amp; checkItem(trans.mOldItem);</span>
<a href="#l25.39"></a><span id="l25.39">     },</span>
<a href="#l25.40"></a><span id="l25.40"> </span>
<a href="#l25.41"></a><span id="l25.41">     undo: function cTM_undo() {</span>
<a href="#l25.42"></a><span id="l25.42">         this.transactionManager.undoTransaction();</span>
<a href="#l25.43"></a><span id="l25.43">     },</span>
<a href="#l25.44"></a><span id="l25.44"> </span>
<a href="#l25.45"></a><span id="l25.45">     canUndo: function cTM_canUndo() {</span>
<a href="#l25.46"></a><span id="l25.46">         return ((this.transactionManager.numberOfUndoItems &gt; 0) &amp;&amp;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/calendar/base/src/calUtils.js</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/calendar/base/src/calUtils.js</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -1181,35 +1181,32 @@ calInterfaceBag.prototype = {</span>
<a href="#l26.4"></a><span id="l26.4">     },</span>
<a href="#l26.5"></a><span id="l26.5"> </span>
<a href="#l26.6"></a><span id="l26.6">     get interfaceArray() {</span>
<a href="#l26.7"></a><span id="l26.7">         return this.mInterfaces;</span>
<a href="#l26.8"></a><span id="l26.8">     },</span>
<a href="#l26.9"></a><span id="l26.9"> </span>
<a href="#l26.10"></a><span id="l26.10">     add: function calInterfaceBag_add(iface) {</span>
<a href="#l26.11"></a><span id="l26.11">         if (iface) {</span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-            var iid = this.mIid;</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineminus">-            function eq(obj) {</span>
<a href="#l26.14"></a><span id="l26.14" class="difflineminus">-                return compareObjects(obj, iface, iid);</span>
<a href="#l26.15"></a><span id="l26.15" class="difflineplus">+            let existing = this.mInterfaces.some(obj =&gt; {</span>
<a href="#l26.16"></a><span id="l26.16" class="difflineplus">+                return compareObjects(obj, iface, this.mIid);</span>
<a href="#l26.17"></a><span id="l26.17" class="difflineplus">+            });</span>
<a href="#l26.18"></a><span id="l26.18" class="difflineplus">+            if (!existing) {</span>
<a href="#l26.19"></a><span id="l26.19" class="difflineplus">+                this.mInterfaces.push(iface);</span>
<a href="#l26.20"></a><span id="l26.20">             }</span>
<a href="#l26.21"></a><span id="l26.21" class="difflineminus">-            if (!this.mInterfaces.some(eq)) {</span>
<a href="#l26.22"></a><span id="l26.22" class="difflineminus">-                this.mInterfaces.push(iface);</span>
<a href="#l26.23"></a><span id="l26.23" class="difflineminus">-                return true;</span>
<a href="#l26.24"></a><span id="l26.24" class="difflineminus">-            }</span>
<a href="#l26.25"></a><span id="l26.25" class="difflineplus">+            return !existing;</span>
<a href="#l26.26"></a><span id="l26.26">         }</span>
<a href="#l26.27"></a><span id="l26.27">         return false;</span>
<a href="#l26.28"></a><span id="l26.28">     },</span>
<a href="#l26.29"></a><span id="l26.29"> </span>
<a href="#l26.30"></a><span id="l26.30">     remove: function calInterfaceBag_remove(iface) {</span>
<a href="#l26.31"></a><span id="l26.31">         if (iface) {</span>
<a href="#l26.32"></a><span id="l26.32" class="difflineminus">-            var iid = this.mIid;</span>
<a href="#l26.33"></a><span id="l26.33" class="difflineminus">-            function neq(obj) {</span>
<a href="#l26.34"></a><span id="l26.34" class="difflineminus">-                return !compareObjects(obj, iface, iid);</span>
<a href="#l26.35"></a><span id="l26.35" class="difflineminus">-            }</span>
<a href="#l26.36"></a><span id="l26.36" class="difflineminus">-            this.mInterfaces = this.mInterfaces.filter(neq);</span>
<a href="#l26.37"></a><span id="l26.37" class="difflineplus">+            this.mInterfaces = this.mInterfaces.filter((obj) =&gt; {</span>
<a href="#l26.38"></a><span id="l26.38" class="difflineplus">+                return !compareObjects(obj, iface, this.mIid);</span>
<a href="#l26.39"></a><span id="l26.39" class="difflineplus">+            });</span>
<a href="#l26.40"></a><span id="l26.40">         }</span>
<a href="#l26.41"></a><span id="l26.41">     },</span>
<a href="#l26.42"></a><span id="l26.42"> </span>
<a href="#l26.43"></a><span id="l26.43">     forEach: function calInterfaceBag_forEach(func) {</span>
<a href="#l26.44"></a><span id="l26.44">         this.mInterfaces.forEach(func);</span>
<a href="#l26.45"></a><span id="l26.45">     }</span>
<a href="#l26.46"></a><span id="l26.46"> };</span>
<a href="#l26.47"></a><span id="l26.47"> </span>
<a href="#l26.48"></a><span id="l26.48" class="difflineat">@@ -1282,20 +1279,17 @@ calOperationGroup.prototype = {</span>
<a href="#l26.49"></a><span id="l26.49">     add: function calOperationGroup_add(op) {</span>
<a href="#l26.50"></a><span id="l26.50">         if (op &amp;&amp; op.isPending) {</span>
<a href="#l26.51"></a><span id="l26.51">             this.mSubOperations.push(op);</span>
<a href="#l26.52"></a><span id="l26.52">         }</span>
<a href="#l26.53"></a><span id="l26.53">     },</span>
<a href="#l26.54"></a><span id="l26.54"> </span>
<a href="#l26.55"></a><span id="l26.55">     remove: function calOperationGroup_remove(op) {</span>
<a href="#l26.56"></a><span id="l26.56">         if (op) {</span>
<a href="#l26.57"></a><span id="l26.57" class="difflineminus">-            function filterFunc(op_) {</span>
<a href="#l26.58"></a><span id="l26.58" class="difflineminus">-                return (op.id != op_.id);</span>
<a href="#l26.59"></a><span id="l26.59" class="difflineminus">-            }</span>
<a href="#l26.60"></a><span id="l26.60" class="difflineminus">-            this.mSubOperations = this.mSubOperations.filter(filterFunc);</span>
<a href="#l26.61"></a><span id="l26.61" class="difflineplus">+            this.mSubOperations = this.mSubOperations.filter(op_ =&gt; op.id != op_.id);</span>
<a href="#l26.62"></a><span id="l26.62">         }</span>
<a href="#l26.63"></a><span id="l26.63">     },</span>
<a href="#l26.64"></a><span id="l26.64"> </span>
<a href="#l26.65"></a><span id="l26.65">     get isEmpty() {</span>
<a href="#l26.66"></a><span id="l26.66">         return (this.mSubOperations.length == 0);</span>
<a href="#l26.67"></a><span id="l26.67">     },</span>
<a href="#l26.68"></a><span id="l26.68"> </span>
<a href="#l26.69"></a><span id="l26.69">     notifyCompleted: function calOperationGroup_notifyCompleted(status) {</span>
<a href="#l26.70"></a><span id="l26.70" class="difflineat">@@ -1333,20 +1327,19 @@ calOperationGroup.prototype = {</span>
<a href="#l26.71"></a><span id="l26.71">             this.notifyCompleted(status);</span>
<a href="#l26.72"></a><span id="l26.72">             var cancelFunc = this.mCancelFunc;</span>
<a href="#l26.73"></a><span id="l26.73">             if (cancelFunc) {</span>
<a href="#l26.74"></a><span id="l26.74">                 this.mCancelFunc = null;</span>
<a href="#l26.75"></a><span id="l26.75">                 cancelFunc();</span>
<a href="#l26.76"></a><span id="l26.76">             }</span>
<a href="#l26.77"></a><span id="l26.77">             var subOperations = this.mSubOperations;</span>
<a href="#l26.78"></a><span id="l26.78">             this.mSubOperations = [];</span>
<a href="#l26.79"></a><span id="l26.79" class="difflineminus">-            function forEachFunc(op) {</span>
<a href="#l26.80"></a><span id="l26.80" class="difflineplus">+            for (let op of subOperations) {</span>
<a href="#l26.81"></a><span id="l26.81">                 op.cancel(Components.interfaces.calIErrors.OPERATION_CANCELLED);</span>
<a href="#l26.82"></a><span id="l26.82">             }</span>
<a href="#l26.83"></a><span id="l26.83" class="difflineminus">-            subOperations.forEach(forEachFunc);</span>
<a href="#l26.84"></a><span id="l26.84">         }</span>
<a href="#l26.85"></a><span id="l26.85">     }</span>
<a href="#l26.86"></a><span id="l26.86"> };</span>
<a href="#l26.87"></a><span id="l26.87"> </span>
<a href="#l26.88"></a><span id="l26.88"> function sameDay(date1, date2) {</span>
<a href="#l26.89"></a><span id="l26.89">     if (date1 &amp;&amp; date2) {</span>
<a href="#l26.90"></a><span id="l26.90">         if ((date1.day == date2.day) &amp;&amp;</span>
<a href="#l26.91"></a><span id="l26.91">             (date1.month == date2.month) &amp;&amp;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/calendar/providers/caldav/calDavCalendar.js</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/calendar/providers/caldav/calDavCalendar.js</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -624,23 +624,25 @@ calDavCalendar.prototype = {</span>
<a href="#l27.4"></a><span id="l27.4">             let method = pure ? &quot;notifyPureOperationComplete&quot; : &quot;notifyOperationComplete&quot;;</span>
<a href="#l27.5"></a><span id="l27.5">             this[method](aListener, status, cIOL.ADD, aItem.id, detail);</span>
<a href="#l27.6"></a><span id="l27.6">         };</span>
<a href="#l27.7"></a><span id="l27.7">         if (aItem.id == null &amp;&amp; aItem.isMutable) {</span>
<a href="#l27.8"></a><span id="l27.8">             aItem.id = cal.getUUID();</span>
<a href="#l27.9"></a><span id="l27.9">         }</span>
<a href="#l27.10"></a><span id="l27.10"> </span>
<a href="#l27.11"></a><span id="l27.11">         if (aItem.id == null) {</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-            return notifyListener(Components.results.NS_ERROR_FAILURE,</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineminus">-                                  &quot;Can't set ID on non-mutable item to addItem&quot;);</span>
<a href="#l27.14"></a><span id="l27.14" class="difflineplus">+            notifyListener(Components.results.NS_ERROR_FAILURE,</span>
<a href="#l27.15"></a><span id="l27.15" class="difflineplus">+                           &quot;Can't set ID on non-mutable item to addItem&quot;);</span>
<a href="#l27.16"></a><span id="l27.16" class="difflineplus">+            return;</span>
<a href="#l27.17"></a><span id="l27.17">         }</span>
<a href="#l27.18"></a><span id="l27.18"> </span>
<a href="#l27.19"></a><span id="l27.19">         if (!isItemSupported(aItem, this)) {</span>
<a href="#l27.20"></a><span id="l27.20" class="difflineminus">-            return notifyListener(Components.results.NS_ERROR_FAILURE,</span>
<a href="#l27.21"></a><span id="l27.21" class="difflineminus">-                                  &quot;Server does not support item type&quot;);</span>
<a href="#l27.22"></a><span id="l27.22" class="difflineplus">+            notifyListener(Components.results.NS_ERROR_FAILURE,</span>
<a href="#l27.23"></a><span id="l27.23" class="difflineplus">+                           &quot;Server does not support item type&quot;);</span>
<a href="#l27.24"></a><span id="l27.24" class="difflineplus">+            return;</span>
<a href="#l27.25"></a><span id="l27.25">         }</span>
<a href="#l27.26"></a><span id="l27.26"> </span>
<a href="#l27.27"></a><span id="l27.27">         let parentItem = aItem.parentItem;</span>
<a href="#l27.28"></a><span id="l27.28">         parentItem.calendar = this.superCalendar;</span>
<a href="#l27.29"></a><span id="l27.29"> </span>
<a href="#l27.30"></a><span id="l27.30">         let locationPath = this.getItemLocationPath(parentItem);</span>
<a href="#l27.31"></a><span id="l27.31">         let itemUri = this.makeUri(locationPath);</span>
<a href="#l27.32"></a><span id="l27.32">         cal.LOG(&quot;CalDAV: itemUri.spec = &quot; + itemUri.spec);</span>
<a href="#l27.33"></a><span id="l27.33" class="difflineat">@@ -742,18 +744,19 @@ calDavCalendar.prototype = {</span>
<a href="#l27.34"></a><span id="l27.34">      * @param aIgnoreEtag ignore item etag</span>
<a href="#l27.35"></a><span id="l27.35">      */</span>
<a href="#l27.36"></a><span id="l27.36">     doModifyItem: function caldav_doModifyItem(aNewItem, aOldItem, aListener, aIgnoreEtag){</span>
<a href="#l27.37"></a><span id="l27.37">         let notifyListener = (status, detail, pure=false) =&gt; {</span>
<a href="#l27.38"></a><span id="l27.38">             let method = pure ? &quot;notifyPureOperationComplete&quot; : &quot;notifyOperationComplete&quot;;</span>
<a href="#l27.39"></a><span id="l27.39">             this[method](aListener, status, cIOL.MODIFY, aNewItem.id, detail);</span>
<a href="#l27.40"></a><span id="l27.40">         };</span>
<a href="#l27.41"></a><span id="l27.41">         if (aNewItem.id == null) {</span>
<a href="#l27.42"></a><span id="l27.42" class="difflineminus">-            return notifyListener(Components.results.NS_ERROR_FAILURE,</span>
<a href="#l27.43"></a><span id="l27.43" class="difflineminus">-                                  &quot;ID for modifyItem doesn't exist or is null&quot;);</span>
<a href="#l27.44"></a><span id="l27.44" class="difflineplus">+            notifyListener(Components.results.NS_ERROR_FAILURE,</span>
<a href="#l27.45"></a><span id="l27.45" class="difflineplus">+                           &quot;ID for modifyItem doesn't exist or is null&quot;);</span>
<a href="#l27.46"></a><span id="l27.46" class="difflineplus">+            return;</span>
<a href="#l27.47"></a><span id="l27.47">         }</span>
<a href="#l27.48"></a><span id="l27.48"> </span>
<a href="#l27.49"></a><span id="l27.49">         let wasInboxItem = this.mItemInfoCache[aNewItem.id].isInboxItem;</span>
<a href="#l27.50"></a><span id="l27.50"> </span>
<a href="#l27.51"></a><span id="l27.51">         let newItem_ = aNewItem;</span>
<a href="#l27.52"></a><span id="l27.52">         aNewItem = aNewItem.parentItem.clone();</span>
<a href="#l27.53"></a><span id="l27.53">         if (newItem_.parentItem != newItem_) {</span>
<a href="#l27.54"></a><span id="l27.54">             aNewItem.recurrenceInfo.modifyException(newItem_, false);</span>
<a href="#l27.55"></a><span id="l27.55" class="difflineat">@@ -866,33 +869,35 @@ calDavCalendar.prototype = {</span>
<a href="#l27.56"></a><span id="l27.56">      * */</span>
<a href="#l27.57"></a><span id="l27.57">     doDeleteItem: function caldav_doDeleteItem(aItem, aListener, aIgnoreEtag, aFromInbox, aUri){</span>
<a href="#l27.58"></a><span id="l27.58">         let notifyListener = (status, detail, pure=false) =&gt; {</span>
<a href="#l27.59"></a><span id="l27.59">             let method = pure ? &quot;notifyPureOperationComplete&quot; : &quot;notifyOperationComplete&quot;;</span>
<a href="#l27.60"></a><span id="l27.60">             this[method](aListener, status, cIOL.DELETE, aItem.id, detail);</span>
<a href="#l27.61"></a><span id="l27.61">         };</span>
<a href="#l27.62"></a><span id="l27.62"> </span>
<a href="#l27.63"></a><span id="l27.63">         if (aItem.id == null) {</span>
<a href="#l27.64"></a><span id="l27.64" class="difflineminus">-            return notifyListener(Components.results.NS_ERROR_FAILURE,</span>
<a href="#l27.65"></a><span id="l27.65" class="difflineminus">-                                  &quot;ID doesn't exist for deleteItem&quot;);</span>
<a href="#l27.66"></a><span id="l27.66" class="difflineplus">+            notifyListener(Components.results.NS_ERROR_FAILURE,</span>
<a href="#l27.67"></a><span id="l27.67" class="difflineplus">+                           &quot;ID doesn't exist for deleteItem&quot;);</span>
<a href="#l27.68"></a><span id="l27.68" class="difflineplus">+            return;</span>
<a href="#l27.69"></a><span id="l27.69">         }</span>
<a href="#l27.70"></a><span id="l27.70"> </span>
<a href="#l27.71"></a><span id="l27.71">         var eventUri;</span>
<a href="#l27.72"></a><span id="l27.72">         if (aUri) {</span>
<a href="#l27.73"></a><span id="l27.73">             eventUri = aUri;</span>
<a href="#l27.74"></a><span id="l27.74">         } else if (aFromInbox || this.mItemInfoCache[aItem.id].isInboxItem) {</span>
<a href="#l27.75"></a><span id="l27.75">             eventUri = this.makeUri(this.mItemInfoCache[aItem.id].locationPath, this.mInboxUrl);</span>
<a href="#l27.76"></a><span id="l27.76">         } else {</span>
<a href="#l27.77"></a><span id="l27.77">             eventUri = this.makeUri(this.mItemInfoCache[aItem.id].locationPath);</span>
<a href="#l27.78"></a><span id="l27.78">         }</span>
<a href="#l27.79"></a><span id="l27.79"> </span>
<a href="#l27.80"></a><span id="l27.80">         if (eventUri.path == this.calendarUri.path) {</span>
<a href="#l27.81"></a><span id="l27.81" class="difflineminus">-            return notifyListener(Components.results.NS_ERROR_FAILURE,</span>
<a href="#l27.82"></a><span id="l27.82" class="difflineminus">-                                  &quot;eventUri and calendarUri paths are the same, &quot; +</span>
<a href="#l27.83"></a><span id="l27.83" class="difflineminus">-                                  &quot;will not go on to delete entire calendar&quot;);</span>
<a href="#l27.84"></a><span id="l27.84" class="difflineplus">+            notifyListener(Components.results.NS_ERROR_FAILURE,</span>
<a href="#l27.85"></a><span id="l27.85" class="difflineplus">+                           &quot;eventUri and calendarUri paths are the same, &quot; +</span>
<a href="#l27.86"></a><span id="l27.86" class="difflineplus">+                           &quot;will not go on to delete entire calendar&quot;);</span>
<a href="#l27.87"></a><span id="l27.87" class="difflineplus">+            return;</span>
<a href="#l27.88"></a><span id="l27.88">         }</span>
<a href="#l27.89"></a><span id="l27.89"> </span>
<a href="#l27.90"></a><span id="l27.90">         var thisCalendar = this;</span>
<a href="#l27.91"></a><span id="l27.91"> </span>
<a href="#l27.92"></a><span id="l27.92">         let delListener = {</span>
<a href="#l27.93"></a><span id="l27.93">             onStreamComplete: function caldav_dDI_del_onStreamComplete(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l27.94"></a><span id="l27.94">                 let request = aLoader.request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l27.95"></a><span id="l27.95">                 let listenerStatus = Components.results.NS_OK;</span>
<a href="#l27.96"></a><span id="l27.96" class="difflineat">@@ -933,17 +938,17 @@ calDavCalendar.prototype = {</span>
<a href="#l27.97"></a><span id="l27.97">                     cal.LOG(&quot;CalDAV: Item has been modified on server, checking if it has been deleted&quot;);</span>
<a href="#l27.98"></a><span id="l27.98">                     thisCalendar.sendHttpRequest(eventUri, null, null, null, (channel) =&gt; {</span>
<a href="#l27.99"></a><span id="l27.99">                         channel.requestMethod = &quot;HEAD&quot;;</span>
<a href="#l27.100"></a><span id="l27.100">                         return delListener2;</span>
<a href="#l27.101"></a><span id="l27.101">                     }, () =&gt; {</span>
<a href="#l27.102"></a><span id="l27.102">                         notifyListener(Components.results.NS_ERROR_NOT_AVAILABLE,</span>
<a href="#l27.103"></a><span id="l27.103">                                        &quot;Error preparing http channel&quot;);</span>
<a href="#l27.104"></a><span id="l27.104">                     });</span>
<a href="#l27.105"></a><span id="l27.105" class="difflineminus">-                    return</span>
<a href="#l27.106"></a><span id="l27.106" class="difflineplus">+                    return;</span>
<a href="#l27.107"></a><span id="l27.107">                 } else if (responseStatus &gt;= 500 &amp;&amp; responseStatus &lt;= 510) {</span>
<a href="#l27.108"></a><span id="l27.108">                     listenerStatus = Components.results.NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l27.109"></a><span id="l27.109">                     listenerDetail = &quot;Server Replied with &quot; + responseStatus;</span>
<a href="#l27.110"></a><span id="l27.110">                 } else if (responseStatus) {</span>
<a href="#l27.111"></a><span id="l27.111">                     cal.ERROR(&quot;CalDAV: Unexpected status deleting item from &quot; +</span>
<a href="#l27.112"></a><span id="l27.112">                               thisCalendar.name + &quot;: &quot; + responseStatus + &quot;\n&quot; +</span>
<a href="#l27.113"></a><span id="l27.113">                               &quot;uri: &quot; + eventUri.spec);</span>
<a href="#l27.114"></a><span id="l27.114"> </span>
<a href="#l27.115"></a><span id="l27.115" class="difflineat">@@ -1390,23 +1395,25 @@ calDavCalendar.prototype = {</span>
<a href="#l27.116"></a><span id="l27.116">             function safeRefresh_safeRefresh_onStreamComplete(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l27.117"></a><span id="l27.117">             let request = aLoader.request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l27.118"></a><span id="l27.118">             try {</span>
<a href="#l27.119"></a><span id="l27.119">                 cal.LOG(&quot;CalDAV: Status &quot; + request.responseStatus +</span>
<a href="#l27.120"></a><span id="l27.120">                         &quot; checking ctag for calendar &quot; + thisCalendar.name);</span>
<a href="#l27.121"></a><span id="l27.121">             } catch (ex) {</span>
<a href="#l27.122"></a><span id="l27.122">                 cal.LOG(&quot;CalDAV: Error without status on checking ctag for calendar &quot; +</span>
<a href="#l27.123"></a><span id="l27.123">                         thisCalendar.name);</span>
<a href="#l27.124"></a><span id="l27.124" class="difflineminus">-                return notifyListener(Components.results.NS_OK);</span>
<a href="#l27.125"></a><span id="l27.125" class="difflineplus">+                notifyListener(Components.results.NS_OK);</span>
<a href="#l27.126"></a><span id="l27.126" class="difflineplus">+                return;</span>
<a href="#l27.127"></a><span id="l27.127">             }</span>
<a href="#l27.128"></a><span id="l27.128"> </span>
<a href="#l27.129"></a><span id="l27.129">             if (request.responseStatus == 404) {</span>
<a href="#l27.130"></a><span id="l27.130">                 cal.LOG(&quot;CalDAV: Disabling calendar &quot; + thisCalendar.name +</span>
<a href="#l27.131"></a><span id="l27.131">                         &quot; due to 404&quot;);</span>
<a href="#l27.132"></a><span id="l27.132" class="difflineminus">-                return notifyListener(Components.results.NS_ERROR_FAILURE);</span>
<a href="#l27.133"></a><span id="l27.133" class="difflineplus">+                notifyListener(Components.results.NS_ERROR_FAILURE);</span>
<a href="#l27.134"></a><span id="l27.134" class="difflineplus">+                return;</span>
<a href="#l27.135"></a><span id="l27.135">             } else if (request.responseStatus == 207 &amp;&amp; thisCalendar.mDisabled) {</span>
<a href="#l27.136"></a><span id="l27.136">                 // Looks like the calendar is there again, check its resource</span>
<a href="#l27.137"></a><span id="l27.137">                 // type first.</span>
<a href="#l27.138"></a><span id="l27.138">                 thisCalendar.setupAuthentication(aChangeLogListener);</span>
<a href="#l27.139"></a><span id="l27.139">                 return;</span>
<a href="#l27.140"></a><span id="l27.140">              }</span>
<a href="#l27.141"></a><span id="l27.141"> </span>
<a href="#l27.142"></a><span id="l27.142">             let str = cal.convertByteArray(aResult, aResultLength);</span>
<a href="#l27.143"></a><span id="l27.143" class="difflineat">@@ -1417,17 +1424,18 @@ calDavCalendar.prototype = {</span>
<a href="#l27.144"></a><span id="l27.144">                 cal.LOG(&quot;CalDAV: recv: &quot; + str);</span>
<a href="#l27.145"></a><span id="l27.145">             }</span>
<a href="#l27.146"></a><span id="l27.146"> </span>
<a href="#l27.147"></a><span id="l27.147">             try {</span>
<a href="#l27.148"></a><span id="l27.148">                 var multistatus = cal.xml.parseString(str);</span>
<a href="#l27.149"></a><span id="l27.149">             } catch (ex) {</span>
<a href="#l27.150"></a><span id="l27.150">                 cal.LOG(&quot;CalDAV: Failed to get ctag from server for calendar &quot; +</span>
<a href="#l27.151"></a><span id="l27.151">                         thisCalendar.name);</span>
<a href="#l27.152"></a><span id="l27.152" class="difflineminus">-                return notifyListener(Components.results.NS_OK);</span>
<a href="#l27.153"></a><span id="l27.153" class="difflineplus">+                notifyListener(Components.results.NS_OK);</span>
<a href="#l27.154"></a><span id="l27.154" class="difflineplus">+                return;</span>
<a href="#l27.155"></a><span id="l27.155">             }</span>
<a href="#l27.156"></a><span id="l27.156"> </span>
<a href="#l27.157"></a><span id="l27.157">             let ctag = caldavXPathFirst(multistatus, &quot;/D:multistatus/D:response/D:propstat/D:prop/CS:getctag/text()&quot;);</span>
<a href="#l27.158"></a><span id="l27.158">             if (!ctag || ctag != thisCalendar.mCtag) {</span>
<a href="#l27.159"></a><span id="l27.159">                 // ctag mismatch, need to fetch calendar-data</span>
<a href="#l27.160"></a><span id="l27.160">                 thisCalendar.mProposedCtag = ctag;</span>
<a href="#l27.161"></a><span id="l27.161">                 thisCalendar.getUpdatedItems(thisCalendar.calendarUri,</span>
<a href="#l27.162"></a><span id="l27.162">                                              aChangeLogListener);</span>
<a href="#l27.163"></a><span id="l27.163" class="difflineat">@@ -1634,26 +1642,24 @@ calDavCalendar.prototype = {</span>
<a href="#l27.164"></a><span id="l27.164"> </span>
<a href="#l27.165"></a><span id="l27.165">             if (this.oauth.accessToken) {</span>
<a href="#l27.166"></a><span id="l27.166">                 authSuccess();</span>
<a href="#l27.167"></a><span id="l27.167">             } else {</span>
<a href="#l27.168"></a><span id="l27.168">                 // bug 901329: If the calendar window isn't loaded yet the</span>
<a href="#l27.169"></a><span id="l27.169">                 // master password prompt will show just the buttons and</span>
<a href="#l27.170"></a><span id="l27.170">                 // possibly hang. If we postpone until the window is loaded,</span>
<a href="#l27.171"></a><span id="l27.171">                 // all is well.</span>
<a href="#l27.172"></a><span id="l27.172" class="difflineminus">-                function postpone() {</span>
<a href="#l27.173"></a><span id="l27.173" class="difflineplus">+                setTimeout(function postpone() {</span>
<a href="#l27.174"></a><span id="l27.174">                     let win = cal.getCalendarWindow();</span>
<a href="#l27.175"></a><span id="l27.175">                     if (!win || win.document.readyState != &quot;complete&quot;) {</span>
<a href="#l27.176"></a><span id="l27.176">                         setTimeout(postpone, 0);</span>
<a href="#l27.177"></a><span id="l27.177">                     } else {</span>
<a href="#l27.178"></a><span id="l27.178">                         connect();</span>
<a href="#l27.179"></a><span id="l27.179">                     }</span>
<a href="#l27.180"></a><span id="l27.180" class="difflineminus">-                }</span>
<a href="#l27.181"></a><span id="l27.181" class="difflineminus">-</span>
<a href="#l27.182"></a><span id="l27.182" class="difflineminus">-                setTimeout(postpone, 0);</span>
<a href="#l27.183"></a><span id="l27.183" class="difflineplus">+                }, 0);</span>
<a href="#l27.184"></a><span id="l27.184">             }</span>
<a href="#l27.185"></a><span id="l27.185">         } else {</span>
<a href="#l27.186"></a><span id="l27.186">             authSuccess();</span>
<a href="#l27.187"></a><span id="l27.187">         }</span>
<a href="#l27.188"></a><span id="l27.188">     },</span>
<a href="#l27.189"></a><span id="l27.189"> </span>
<a href="#l27.190"></a><span id="l27.190">     /**</span>
<a href="#l27.191"></a><span id="l27.191">      * Checks that the calendar URI exists and is a CalDAV calendar.</span>
<a href="#l27.192"></a><span id="l27.192" class="difflineat">@@ -2188,37 +2194,37 @@ calDavCalendar.prototype = {</span>
<a href="#l27.193"></a><span id="l27.193">             }</span>
<a href="#l27.194"></a><span id="l27.194"> </span>
<a href="#l27.195"></a><span id="l27.195">             let homeSets = caldavXPath(multistatus, &quot;/D:multistatus/D:response/D:propstat/D:prop/C:calendar-home-set/D:href/text()&quot;);</span>
<a href="#l27.196"></a><span id="l27.196">             function homeSetMatches(homeSet) {</span>
<a href="#l27.197"></a><span id="l27.197">                 let normalized = homeSet.replace(/([^\/])$/, &quot;$1/&quot;);</span>
<a href="#l27.198"></a><span id="l27.198">                 let chs = thisCalendar.mCalHomeSet;</span>
<a href="#l27.199"></a><span id="l27.199">                 return normalized == chs.path || normalized == chs.spec;</span>
<a href="#l27.200"></a><span id="l27.200">             }</span>
<a href="#l27.201"></a><span id="l27.201" class="difflineplus">+            function createBoxUrl(path) {</span>
<a href="#l27.202"></a><span id="l27.202" class="difflineplus">+                let url = thisCalendar.mUri.clone();</span>
<a href="#l27.203"></a><span id="l27.203" class="difflineplus">+                url.path = thisCalendar.ensureDecodedPath(path);</span>
<a href="#l27.204"></a><span id="l27.204" class="difflineplus">+                // Make sure the uri has a / at the end, as we do with the calendarUri.</span>
<a href="#l27.205"></a><span id="l27.205" class="difflineplus">+                if (url.path.charAt(url.path.length - 1) != '/') {</span>
<a href="#l27.206"></a><span id="l27.206" class="difflineplus">+                    url.path += &quot;/&quot;;</span>
<a href="#l27.207"></a><span id="l27.207" class="difflineplus">+                }</span>
<a href="#l27.208"></a><span id="l27.208" class="difflineplus">+                return url;</span>
<a href="#l27.209"></a><span id="l27.209" class="difflineplus">+            }</span>
<a href="#l27.210"></a><span id="l27.210"> </span>
<a href="#l27.211"></a><span id="l27.211">             // If there are multiple home sets, we need to match the email addresses for scheduling.</span>
<a href="#l27.212"></a><span id="l27.212">             // If there is only one, assume its the right one.</span>
<a href="#l27.213"></a><span id="l27.213">             // TODO with multiple address sets, we should just use the ACL manager.</span>
<a href="#l27.214"></a><span id="l27.214">             if (homeSets &amp;&amp; (homeSets.length == 1 || homeSets.some(homeSetMatches))) {</span>
<a href="#l27.215"></a><span id="l27.215">                 let cuaSets = caldavXPath(multistatus, &quot;/D:multistatus/D:response/D:propstat/D:prop/C:calendar-user-address-set/D:href/text()&quot;);</span>
<a href="#l27.216"></a><span id="l27.216">                 for each (let addr in cuaSets) {</span>
<a href="#l27.217"></a><span id="l27.217">                     if (addr.match(/^mailto:/i)) {</span>
<a href="#l27.218"></a><span id="l27.218">                         thisCalendar.mCalendarUserAddress = addr;</span>
<a href="#l27.219"></a><span id="l27.219">                     }</span>
<a href="#l27.220"></a><span id="l27.220">                 }</span>
<a href="#l27.221"></a><span id="l27.221"> </span>
<a href="#l27.222"></a><span id="l27.222" class="difflineminus">-                function createBoxUrl(path) {</span>
<a href="#l27.223"></a><span id="l27.223" class="difflineminus">-                    let url = thisCalendar.mUri.clone();</span>
<a href="#l27.224"></a><span id="l27.224" class="difflineminus">-                    url.path = thisCalendar.ensureDecodedPath(path);</span>
<a href="#l27.225"></a><span id="l27.225" class="difflineminus">-                    // Make sure the uri has a / at the end, as we do with the calendarUri.</span>
<a href="#l27.226"></a><span id="l27.226" class="difflineminus">-                    if (url.path.charAt(url.path.length - 1) != '/') {</span>
<a href="#l27.227"></a><span id="l27.227" class="difflineminus">-                        url.path += &quot;/&quot;;</span>
<a href="#l27.228"></a><span id="l27.228" class="difflineminus">-                    }</span>
<a href="#l27.229"></a><span id="l27.229" class="difflineminus">-                    return url;</span>
<a href="#l27.230"></a><span id="l27.230" class="difflineminus">-                }</span>
<a href="#l27.231"></a><span id="l27.231"> </span>
<a href="#l27.232"></a><span id="l27.232">                 let inboxPath = caldavXPathFirst(multistatus, &quot;/D:multistatus/D:response/D:propstat/D:prop/C:schedule-inbox-URL/D:href/text()&quot;);</span>
<a href="#l27.233"></a><span id="l27.233">                 if (!inboxPath) {</span>
<a href="#l27.234"></a><span id="l27.234">                     // most likely this is a Kerio server that omits the &quot;href&quot;</span>
<a href="#l27.235"></a><span id="l27.235">                     inboxPath = caldavXPathFirst(multistatus, &quot;/D:multistatus/D:response/D:propstat/D:prop/C:schedule-inbox-URL/text()&quot;);</span>
<a href="#l27.236"></a><span id="l27.236">                 }</span>
<a href="#l27.237"></a><span id="l27.237">                 thisCalendar.mInboxUrl = createBoxUrl(inboxPath);</span>
<a href="#l27.238"></a><span id="l27.238"> </span>
<a href="#l27.239"></a><span id="l27.239" class="difflineat">@@ -2777,17 +2783,17 @@ calDavCalendar.prototype = {</span>
<a href="#l27.240"></a><span id="l27.240">                         cal.LOG(&quot;CalDAV: Failed to parse iTIP response for&quot; +</span>
<a href="#l27.241"></a><span id="l27.241">                                 thisCalendar.name);</span>
<a href="#l27.242"></a><span id="l27.242">                     }</span>
<a href="#l27.243"></a><span id="l27.243"> </span>
<a href="#l27.244"></a><span id="l27.244">                     try {</span>
<a href="#l27.245"></a><span id="l27.245">                         var responseXML = cal.xml.parseString(str);</span>
<a href="#l27.246"></a><span id="l27.246">                     } catch (ex) {</span>
<a href="#l27.247"></a><span id="l27.247">                         cal.LOG(&quot;CalDAV: Could not parse multistatus response: &quot; + ex + &quot;\n&quot; + str);</span>
<a href="#l27.248"></a><span id="l27.248" class="difflineminus">-                        return false;</span>
<a href="#l27.249"></a><span id="l27.249" class="difflineplus">+                        return;</span>
<a href="#l27.250"></a><span id="l27.250">                     }</span>
<a href="#l27.251"></a><span id="l27.251"> </span>
<a href="#l27.252"></a><span id="l27.252">                     var remainingAttendees = [];</span>
<a href="#l27.253"></a><span id="l27.253">                     // TODO The following XPath expressions are currently</span>
<a href="#l27.254"></a><span id="l27.254">                     // untested code, as I don't have a caldav-sched server</span>
<a href="#l27.255"></a><span id="l27.255">                     // available. If you find someone who does, please test!</span>
<a href="#l27.256"></a><span id="l27.256">                     let responses = caldavXPath(responseXML, &quot;/C:schedule-response/C:response&quot;);</span>
<a href="#l27.257"></a><span id="l27.257">                     for each (let response in responses) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/calendar/providers/composite/calCompositeCalendar.js</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/calendar/providers/composite/calCompositeCalendar.js</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -93,21 +93,16 @@ calCompositeCalendar.prototype = {</span>
<a href="#l28.4"></a><span id="l28.4">     classInfo: XPCOMUtils.generateCI({</span>
<a href="#l28.5"></a><span id="l28.5">         classID: calCompositeCalendarClassID,</span>
<a href="#l28.6"></a><span id="l28.6">         contractID: &quot;@mozilla.org/calendar/calendar;1?type=composite&quot;,</span>
<a href="#l28.7"></a><span id="l28.7">         classDescription: &quot;Composite Calendar Provider&quot;,</span>
<a href="#l28.8"></a><span id="l28.8">         interfaces: calCompositeCalendarInterfaces,</span>
<a href="#l28.9"></a><span id="l28.9">     }),</span>
<a href="#l28.10"></a><span id="l28.10"> </span>
<a href="#l28.11"></a><span id="l28.11">     //</span>
<a href="#l28.12"></a><span id="l28.12" class="difflineminus">-    // private members</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineminus">-    //</span>
<a href="#l28.14"></a><span id="l28.14" class="difflineminus">-    mDefaultCalendar: null,</span>
<a href="#l28.15"></a><span id="l28.15" class="difflineminus">-</span>
<a href="#l28.16"></a><span id="l28.16" class="difflineminus">-    //</span>
<a href="#l28.17"></a><span id="l28.17">     // calICalendarProvider interface</span>
<a href="#l28.18"></a><span id="l28.18">     //</span>
<a href="#l28.19"></a><span id="l28.19">     get prefChromeOverlay() null,</span>
<a href="#l28.20"></a><span id="l28.20">     get displayName() cal.calGetString(&quot;calendar&quot;, &quot;compositeName&quot;),</span>
<a href="#l28.21"></a><span id="l28.21"> </span>
<a href="#l28.22"></a><span id="l28.22">     createCalendar: function comp_createCal() {</span>
<a href="#l28.23"></a><span id="l28.23">         throw NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l28.24"></a><span id="l28.24">     },</span>
<a href="#l28.25"></a><span id="l28.25" class="difflineat">@@ -385,17 +380,17 @@ calCompositeCalendar.prototype = {</span>
<a href="#l28.26"></a><span id="l28.26">         // If there are no calendars, then we just call onOperationComplete</span>
<a href="#l28.27"></a><span id="l28.27">         let enabledCalendars = this.enabledCalendars;</span>
<a href="#l28.28"></a><span id="l28.28">         if (enabledCalendars.length == 0) {</span>
<a href="#l28.29"></a><span id="l28.29">             aListener.onOperationComplete (this,</span>
<a href="#l28.30"></a><span id="l28.30">                                            Components.results.NS_OK,</span>
<a href="#l28.31"></a><span id="l28.31">                                            calIOperationListener.GET,</span>
<a href="#l28.32"></a><span id="l28.32">                                            null,</span>
<a href="#l28.33"></a><span id="l28.33">                                            null);</span>
<a href="#l28.34"></a><span id="l28.34" class="difflineminus">-            return;</span>
<a href="#l28.35"></a><span id="l28.35" class="difflineplus">+            return null;</span>
<a href="#l28.36"></a><span id="l28.36">         }</span>
<a href="#l28.37"></a><span id="l28.37">         if (this.mStatusObserver) {</span>
<a href="#l28.38"></a><span id="l28.38">             if (this.mStatusObserver.spinning == Components.interfaces.calIStatusObserver.NO_PROGRESS) {</span>
<a href="#l28.39"></a><span id="l28.39">                 this.mStatusObserver.startMeteors(Components.interfaces.calIStatusObserver.UNDETERMINED_PROGRESS, -1);</span>
<a href="#l28.40"></a><span id="l28.40">             }</span>
<a href="#l28.41"></a><span id="l28.41">         }</span>
<a href="#l28.42"></a><span id="l28.42">         let cmpListener = new calCompositeGetListenerHelper(this, aListener, aCount);</span>
<a href="#l28.43"></a><span id="l28.43"> </span>
<a href="#l28.44"></a><span id="l28.44" class="difflineat">@@ -451,30 +446,28 @@ calCompositeGetListenerHelper.prototype </span>
<a href="#l28.45"></a><span id="l28.45">     mOpGroup: null,</span>
<a href="#l28.46"></a><span id="l28.46">     mReceivedCompletes: 0,</span>
<a href="#l28.47"></a><span id="l28.47">     mFinished: false,</span>
<a href="#l28.48"></a><span id="l28.48">     mMaxItems: 0,</span>
<a href="#l28.49"></a><span id="l28.49">     mItemsReceived: 0,</span>
<a href="#l28.50"></a><span id="l28.50"> </span>
<a href="#l28.51"></a><span id="l28.51">     get opGroup() {</span>
<a href="#l28.52"></a><span id="l28.52">         if (!this.mOpGroup) {</span>
<a href="#l28.53"></a><span id="l28.53" class="difflineminus">-            let this_ = this;</span>
<a href="#l28.54"></a><span id="l28.54" class="difflineminus">-            function cancelFunc() { // operation group has been cancelled</span>
<a href="#l28.55"></a><span id="l28.55" class="difflineminus">-                let listener = this_.mRealListener;</span>
<a href="#l28.56"></a><span id="l28.56" class="difflineminus">-                this_.mRealListener = null;</span>
<a href="#l28.57"></a><span id="l28.57" class="difflineplus">+            this.mOpGroup = new cal.calOperationGroup(() =&gt; {</span>
<a href="#l28.58"></a><span id="l28.58" class="difflineplus">+                let listener = this.mRealListener;</span>
<a href="#l28.59"></a><span id="l28.59" class="difflineplus">+                this.mRealListener = null;</span>
<a href="#l28.60"></a><span id="l28.60">                 if (listener) {</span>
<a href="#l28.61"></a><span id="l28.61">                     listener.onOperationComplete(</span>
<a href="#l28.62"></a><span id="l28.62" class="difflineminus">-                        this_, Components.interfaces.calIErrors.OPERATION_CANCELLED,</span>
<a href="#l28.63"></a><span id="l28.63" class="difflineplus">+                        this, Components.interfaces.calIErrors.OPERATION_CANCELLED,</span>
<a href="#l28.64"></a><span id="l28.64">                         calIOperationListener.GET, null, null);</span>
<a href="#l28.65"></a><span id="l28.65" class="difflineminus">-                    if (this_.mCompositeCalendar.statusDisplayed) {</span>
<a href="#l28.66"></a><span id="l28.66" class="difflineminus">-                        this_.mCompositeCalendar.mStatusObserver.stopMeteors();</span>
<a href="#l28.67"></a><span id="l28.67" class="difflineplus">+                    if (this.mCompositeCalendar.statusDisplayed) {</span>
<a href="#l28.68"></a><span id="l28.68" class="difflineplus">+                        this.mCompositeCalendar.mStatusObserver.stopMeteors();</span>
<a href="#l28.69"></a><span id="l28.69">                     }</span>
<a href="#l28.70"></a><span id="l28.70">                 }</span>
<a href="#l28.71"></a><span id="l28.71" class="difflineminus">-            }</span>
<a href="#l28.72"></a><span id="l28.72" class="difflineminus">-            this.mOpGroup = new cal.calOperationGroup(cancelFunc);</span>
<a href="#l28.73"></a><span id="l28.73" class="difflineplus">+            });</span>
<a href="#l28.74"></a><span id="l28.74">         }</span>
<a href="#l28.75"></a><span id="l28.75">         return this.mOpGroup;</span>
<a href="#l28.76"></a><span id="l28.76">     },</span>
<a href="#l28.77"></a><span id="l28.77"> </span>
<a href="#l28.78"></a><span id="l28.78">     QueryInterface: function (aIID) {</span>
<a href="#l28.79"></a><span id="l28.79">         if (!aIID.equals(Components.interfaces.nsISupports) &amp;&amp;</span>
<a href="#l28.80"></a><span id="l28.80">             !aIID.equals(Components.interfaces.calIOperationListener))</span>
<a href="#l28.81"></a><span id="l28.81">         {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/calendar/providers/gdata/modules/gdataSession.jsm</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/calendar/providers/gdata/modules/gdataSession.jsm</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -285,25 +285,24 @@ calGoogleSession.prototype = {</span>
<a href="#l29.4"></a><span id="l29.4">                 deferred.resolve(accessToken);</span>
<a href="#l29.5"></a><span id="l29.5">             } else {</span>
<a href="#l29.6"></a><span id="l29.6">                 cal.LOG(&quot;[calGoogleCalendar] No access token for &quot; + this.mId +</span>
<a href="#l29.7"></a><span id="l29.7">                         &quot;, refreshing token&quot;);</span>
<a href="#l29.8"></a><span id="l29.8">                 // bug 901329: If the calendar window isn't loaded yet the</span>
<a href="#l29.9"></a><span id="l29.9">                 // master password prompt will show just the buttons and</span>
<a href="#l29.10"></a><span id="l29.10">                 // possibly hang. If we postpone until the window is loaded,</span>
<a href="#l29.11"></a><span id="l29.11">                 // all is well.</span>
<a href="#l29.12"></a><span id="l29.12" class="difflineminus">-                function postpone() {</span>
<a href="#l29.13"></a><span id="l29.13" class="difflineplus">+                setTimeout(function postpone() {</span>
<a href="#l29.14"></a><span id="l29.14">                     let win = cal.getCalendarWindow();</span>
<a href="#l29.15"></a><span id="l29.15">                     if (!win || win.document.readyState != &quot;complete&quot;) {</span>
<a href="#l29.16"></a><span id="l29.16">                         setTimeout(postpone, 400);</span>
<a href="#l29.17"></a><span id="l29.17">                     } else {</span>
<a href="#l29.18"></a><span id="l29.18">                         connect();</span>
<a href="#l29.19"></a><span id="l29.19">                     }</span>
<a href="#l29.20"></a><span id="l29.20" class="difflineminus">-                }</span>
<a href="#l29.21"></a><span id="l29.21" class="difflineminus">-                setTimeout(postpone, 0);</span>
<a href="#l29.22"></a><span id="l29.22" class="difflineplus">+                }, 0);</span>
<a href="#l29.23"></a><span id="l29.23">             }</span>
<a href="#l29.24"></a><span id="l29.24">         } catch (e) {</span>
<a href="#l29.25"></a><span id="l29.25">             // If something went wrong, reset the login state just in case</span>
<a href="#l29.26"></a><span id="l29.26">             cal.LOG(&quot;[calGoogleCalendar] Error Logging In: &quot; + e);</span>
<a href="#l29.27"></a><span id="l29.27">             deferred.reject(e);</span>
<a href="#l29.28"></a><span id="l29.28">         }</span>
<a href="#l29.29"></a><span id="l29.29">         return deferred.promise.then(function(accessToken) {</span>
<a href="#l29.30"></a><span id="l29.30">             this.mLoginPromise = null;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/calendar/providers/gdata/modules/gdataUtils.jsm</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/calendar/providers/gdata/modules/gdataUtils.jsm</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -257,23 +257,24 @@ function EventToJSON(aItem, aOfflineStor</span>
<a href="#l30.4"></a><span id="l30.4"> </span>
<a href="#l30.5"></a><span id="l30.5">     // Google does not support categories natively, but allows us to store data</span>
<a href="#l30.6"></a><span id="l30.6">     // as an &quot;extendedProperty&quot;, so we do here</span>
<a href="#l30.7"></a><span id="l30.7">     let categories = cal.categoriesArrayToString(aItem.getCategories({}));</span>
<a href="#l30.8"></a><span id="l30.8">     addExtendedProperty(&quot;X-MOZ-CATEGORIES&quot;, categories);</span>
<a href="#l30.9"></a><span id="l30.9"> </span>
<a href="#l30.10"></a><span id="l30.10">     // Only parse attendees if they are enabled, due to bug 407961</span>
<a href="#l30.11"></a><span id="l30.11">     if (Preferences.get(&quot;calendar.google.enableAttendees&quot;, false)) {</span>
<a href="#l30.12"></a><span id="l30.12" class="difflineminus">-        const statusMap = {</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineminus">-            &quot;NEEDS-ACTION&quot;: &quot;needsAction&quot;,</span>
<a href="#l30.14"></a><span id="l30.14" class="difflineminus">-            &quot;DECLINED&quot;: &quot;declined&quot;,</span>
<a href="#l30.15"></a><span id="l30.15" class="difflineminus">-            &quot;TENTATIVE&quot;: &quot;tentative&quot;,</span>
<a href="#l30.16"></a><span id="l30.16" class="difflineminus">-            &quot;ACCEPTED&quot;: &quot;accepted&quot;</span>
<a href="#l30.17"></a><span id="l30.17" class="difflineminus">-        };</span>
<a href="#l30.18"></a><span id="l30.18" class="difflineminus">-        function createAttendee(attendee) {</span>
<a href="#l30.19"></a><span id="l30.19" class="difflineplus">+        let createAttendee = function(attendee) {</span>
<a href="#l30.20"></a><span id="l30.20" class="difflineplus">+            const statusMap = {</span>
<a href="#l30.21"></a><span id="l30.21" class="difflineplus">+                &quot;NEEDS-ACTION&quot;: &quot;needsAction&quot;,</span>
<a href="#l30.22"></a><span id="l30.22" class="difflineplus">+                &quot;DECLINED&quot;: &quot;declined&quot;,</span>
<a href="#l30.23"></a><span id="l30.23" class="difflineplus">+                &quot;TENTATIVE&quot;: &quot;tentative&quot;,</span>
<a href="#l30.24"></a><span id="l30.24" class="difflineplus">+                &quot;ACCEPTED&quot;: &quot;accepted&quot;</span>
<a href="#l30.25"></a><span id="l30.25" class="difflineplus">+            };</span>
<a href="#l30.26"></a><span id="l30.26" class="difflineplus">+</span>
<a href="#l30.27"></a><span id="l30.27">             let attendeeData = {};</span>
<a href="#l30.28"></a><span id="l30.28">             if (aItem.organizer &amp;&amp; aItem.organizer.id == attendee.id) {</span>
<a href="#l30.29"></a><span id="l30.29">                 needsOrganizer = false;</span>
<a href="#l30.30"></a><span id="l30.30">             }</span>
<a href="#l30.31"></a><span id="l30.31">             let lowerId = attendee.id.toLowerCase();</span>
<a href="#l30.32"></a><span id="l30.32">             if (lowerId.startsWith(&quot;mailto:&quot;)) {</span>
<a href="#l30.33"></a><span id="l30.33">                 attendeeData.email = attendee.id.replace(/^mailto:/i, &quot;&quot;);</span>
<a href="#l30.34"></a><span id="l30.34">             } else if (lowerId.startsWith(&quot;urn:id:&quot;)) {</span>
<a href="#l30.35"></a><span id="l30.35" class="difflineat">@@ -282,17 +283,18 @@ function EventToJSON(aItem, aOfflineStor</span>
<a href="#l30.36"></a><span id="l30.36"> </span>
<a href="#l30.37"></a><span id="l30.37">             setIf(attendeeData, &quot;displayName&quot;, attendee.commonName);</span>
<a href="#l30.38"></a><span id="l30.38">             setIf(attendeeData, &quot;optional&quot;, attendee.role &amp;&amp; attendee.role != &quot;REQ-PARTICIPANT&quot;);</span>
<a href="#l30.39"></a><span id="l30.39">             setIf(attendeeData, &quot;responseStatus&quot;, statusMap[attendee.participationStatus]);</span>
<a href="#l30.40"></a><span id="l30.40">             setIf(attendeeData, &quot;comment&quot;, attendee.getProperty(&quot;COMMENT&quot;));</span>
<a href="#l30.41"></a><span id="l30.41">             setIf(attendeeData, &quot;resource&quot;, attendee.userType &amp;&amp; attendee.userType != &quot;INDIVIDUAL&quot;);</span>
<a href="#l30.42"></a><span id="l30.42">             setIf(attendeeData, &quot;additionalGuests&quot;, attendee.getProperty(&quot;X-NUM-GUESTS&quot;));</span>
<a href="#l30.43"></a><span id="l30.43">             return attendeeData;</span>
<a href="#l30.44"></a><span id="l30.44" class="difflineminus">-        }</span>
<a href="#l30.45"></a><span id="l30.45" class="difflineplus">+        };</span>
<a href="#l30.46"></a><span id="l30.46" class="difflineplus">+</span>
<a href="#l30.47"></a><span id="l30.47">         let needsOrganizer = true;</span>
<a href="#l30.48"></a><span id="l30.48">         let attendees = aItem.getAttendees({});</span>
<a href="#l30.49"></a><span id="l30.49">         let attendeeData = [ createAttendee(a) for each (a in attendees) ];</span>
<a href="#l30.50"></a><span id="l30.50"> </span>
<a href="#l30.51"></a><span id="l30.51">         if (aItem.organizer) {</span>
<a href="#l30.52"></a><span id="l30.52">             itemData.organizer = createAttendee(aItem.organizer);</span>
<a href="#l30.53"></a><span id="l30.53">             if (needsOrganizer) {</span>
<a href="#l30.54"></a><span id="l30.54">                 attendeeData.push(itemData.organizer);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/calendar/providers/memory/calMemoryCalendar.js</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/calendar/providers/memory/calMemoryCalendar.js</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -463,16 +463,17 @@ calMemoryCalendar.prototype = {</span>
<a href="#l31.4"></a><span id="l31.4">                        cal.checkIfInRange(item, aRangeStart, aRangeEnd)) {</span>
<a href="#l31.5"></a><span id="l31.5">                 // This needs fixing for recurring items, e.g. DTSTART of parent may occur before aRangeStart.</span>
<a href="#l31.6"></a><span id="l31.6">                 // This will be changed with bug 416975.</span>
<a href="#l31.7"></a><span id="l31.7">                 itemsFound.push(item);</span>
<a href="#l31.8"></a><span id="l31.8">             }</span>
<a href="#l31.9"></a><span id="l31.9">             if (aCount &amp;&amp; itemsFound.length &gt;= aCount) {</span>
<a href="#l31.10"></a><span id="l31.10">                 return cal.forEach.BREAK;</span>
<a href="#l31.11"></a><span id="l31.11">             }</span>
<a href="#l31.12"></a><span id="l31.12" class="difflineplus">+            return cal.forEach.CONTINUE;</span>
<a href="#l31.13"></a><span id="l31.13">         }, () =&gt; {</span>
<a href="#l31.14"></a><span id="l31.14">             aListener.onGetResult(this.superCalendar,</span>
<a href="#l31.15"></a><span id="l31.15">                                   Components.results.NS_OK,</span>
<a href="#l31.16"></a><span id="l31.16">                                   typeIID,</span>
<a href="#l31.17"></a><span id="l31.17">                                   null,</span>
<a href="#l31.18"></a><span id="l31.18">                                   itemsFound.length,</span>
<a href="#l31.19"></a><span id="l31.19">                                   itemsFound);</span>
<a href="#l31.20"></a><span id="l31.20">             this.notifyOperationComplete(aListener,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/calendar/providers/storage/calStorageCalendar.js</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/calendar/providers/storage/calStorageCalendar.js</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -273,17 +273,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l32.4"></a><span id="l32.4">             try {</span>
<a href="#l32.5"></a><span id="l32.5">                 /**</span>
<a href="#l32.6"></a><span id="l32.6">                  * Helper function to migrate all tables from one id to the next</span>
<a href="#l32.7"></a><span id="l32.7">                  *</span>
<a href="#l32.8"></a><span id="l32.8">                  * @param db        The database to use</span>
<a href="#l32.9"></a><span id="l32.9">                  * @param newCalId  The new calendar id to set</span>
<a href="#l32.10"></a><span id="l32.10">                  * @param oldCalId  The old calendar id to look for</span>
<a href="#l32.11"></a><span id="l32.11">                  */</span>
<a href="#l32.12"></a><span id="l32.12" class="difflineminus">-                function migrateTables(db, newCalId, oldCalId) {</span>
<a href="#l32.13"></a><span id="l32.13" class="difflineplus">+                let migrateTables = function(db, newCalId, oldCalId) {</span>
<a href="#l32.14"></a><span id="l32.14">                     for each (let tbl in [&quot;cal_alarms&quot;, &quot;cal_attachments&quot;,</span>
<a href="#l32.15"></a><span id="l32.15">                                           &quot;cal_attendees&quot;, &quot;cal_events&quot;,</span>
<a href="#l32.16"></a><span id="l32.16">                                           &quot;cal_metadata&quot;, &quot;cal_properties&quot;,</span>
<a href="#l32.17"></a><span id="l32.17">                                           &quot;cal_recurrence&quot;, &quot;cal_relations&quot;,</span>
<a href="#l32.18"></a><span id="l32.18">                                           &quot;cal_todos&quot;]) {</span>
<a href="#l32.19"></a><span id="l32.19">                         let stmt;</span>
<a href="#l32.20"></a><span id="l32.20">                         try {</span>
<a href="#l32.21"></a><span id="l32.21">                             stmt = db.createStatement(&quot;UPDATE &quot; + tbl +</span>
<a href="#l32.22"></a><span id="l32.22" class="difflineat">@@ -296,17 +296,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l32.23"></a><span id="l32.23">                             // Pass error through to enclosing try/catch block</span>
<a href="#l32.24"></a><span id="l32.24">                             throw e;</span>
<a href="#l32.25"></a><span id="l32.25">                         } finally {</span>
<a href="#l32.26"></a><span id="l32.26">                             if (stmt) {</span>
<a href="#l32.27"></a><span id="l32.27">                                 stmt.reset();</span>
<a href="#l32.28"></a><span id="l32.28">                             }</span>
<a href="#l32.29"></a><span id="l32.29">                         }</span>
<a href="#l32.30"></a><span id="l32.30">                     }</span>
<a href="#l32.31"></a><span id="l32.31" class="difflineminus">-                }</span>
<a href="#l32.32"></a><span id="l32.32" class="difflineplus">+                };</span>
<a href="#l32.33"></a><span id="l32.33"> </span>
<a href="#l32.34"></a><span id="l32.34">                 let id = 0;</span>
<a href="#l32.35"></a><span id="l32.35">                 let path = this.uri.path;</span>
<a href="#l32.36"></a><span id="l32.36">                 let pos = path.indexOf(&quot;?id=&quot;);</span>
<a href="#l32.37"></a><span id="l32.37"> </span>
<a href="#l32.38"></a><span id="l32.38">                 if (pos != -1) {</span>
<a href="#l32.39"></a><span id="l32.39">                     // There is an &quot;id&quot; parameter in the uri. This calendar</span>
<a href="#l32.40"></a><span id="l32.40">                     // has not been migrated to using the uuid as its cal_id.</span>
<a href="#l32.41"></a><span id="l32.41" class="difflineat">@@ -1556,17 +1556,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l32.42"></a><span id="l32.42">         } catch (e) {</span>
<a href="#l32.43"></a><span id="l32.43">             this.logError(&quot;Error selecting events with recurrence!&quot;, e);</span>
<a href="#l32.44"></a><span id="l32.44">         } finally {</span>
<a href="#l32.45"></a><span id="l32.45">             this.mSelectEventsWithRecurrence.reset();</span>
<a href="#l32.46"></a><span id="l32.46">         }</span>
<a href="#l32.47"></a><span id="l32.47"> </span>
<a href="#l32.48"></a><span id="l32.48">         try {</span>
<a href="#l32.49"></a><span id="l32.49">             this.prepareStatement(this.mSelectTodosWithRecurrence);</span>
<a href="#l32.50"></a><span id="l32.50" class="difflineminus">-            sp = this.mSelectTodosWithRecurrence.params;</span>
<a href="#l32.51"></a><span id="l32.51" class="difflineplus">+            let sp = this.mSelectTodosWithRecurrence.params;</span>
<a href="#l32.52"></a><span id="l32.52">             while (this.mSelectTodosWithRecurrence.executeStep()) {</span>
<a href="#l32.53"></a><span id="l32.53">                 var row = this.mSelectTodosWithRecurrence.row;</span>
<a href="#l32.54"></a><span id="l32.54">                 var item = this.getTodoFromRow(row, {});</span>
<a href="#l32.55"></a><span id="l32.55">                 this.mRecTodoCache[item.id] = item;</span>
<a href="#l32.56"></a><span id="l32.56">                 this.mRecTodoCacheOfflineFlags[item.id] = row.offline_journal || null;</span>
<a href="#l32.57"></a><span id="l32.57">             }</span>
<a href="#l32.58"></a><span id="l32.58">         } catch (e) {</span>
<a href="#l32.59"></a><span id="l32.59">             this.logError(&quot;Error selecting todos with recurrence!&quot;, e);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1" class="difflineminus">--- a/calendar/providers/storage/calStorageUpgrade.jsm</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineplus">+++ b/calendar/providers/storage/calStorageUpgrade.jsm</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineat">@@ -249,49 +249,41 @@ function setDbVersionAndCommit(db, versi</span>
<a href="#l33.4"></a><span id="l33.4"> /**</span>
<a href="#l33.5"></a><span id="l33.5">  * Creates a function that calls the given function |funcName| on it's passed</span>
<a href="#l33.6"></a><span id="l33.6">  * database. In addition, if no database is passed, the call is ignored.</span>
<a href="#l33.7"></a><span id="l33.7">  *</span>
<a href="#l33.8"></a><span id="l33.8">  * @param funcName      The function name to delegate.</span>
<a href="#l33.9"></a><span id="l33.9">  * @return              The delegate function for the passed named function.</span>
<a href="#l33.10"></a><span id="l33.10">  */</span>
<a href="#l33.11"></a><span id="l33.11"> function createDBDelegate(funcName) {</span>
<a href="#l33.12"></a><span id="l33.12" class="difflineminus">-    let func = function(db /* , ... */) {</span>
<a href="#l33.13"></a><span id="l33.13" class="difflineplus">+    return function(db, ...args) {</span>
<a href="#l33.14"></a><span id="l33.14">         if (db) {</span>
<a href="#l33.15"></a><span id="l33.15" class="difflineminus">-            let args = Array.slice(arguments);</span>
<a href="#l33.16"></a><span id="l33.16" class="difflineminus">-            args.shift();</span>
<a href="#l33.17"></a><span id="l33.17">             try {</span>
<a href="#l33.18"></a><span id="l33.18" class="difflineminus">-                return db[funcName].apply(db, args);</span>
<a href="#l33.19"></a><span id="l33.19" class="difflineplus">+                return db[funcName](...args);</span>
<a href="#l33.20"></a><span id="l33.20">             } catch (e) {</span>
<a href="#l33.21"></a><span id="l33.21">                 cal.ERROR(&quot;Error calling '&quot; + funcName + &quot;' db error: '&quot; +</span>
<a href="#l33.22"></a><span id="l33.22">                           lastErrorString(db) + &quot;'.\nException: &quot; + e);</span>
<a href="#l33.23"></a><span id="l33.23">                 cal.WARN(cal.STACK(10));</span>
<a href="#l33.24"></a><span id="l33.24">             }</span>
<a href="#l33.25"></a><span id="l33.25">         }</span>
<a href="#l33.26"></a><span id="l33.26">     };</span>
<a href="#l33.27"></a><span id="l33.27" class="difflineminus">-</span>
<a href="#l33.28"></a><span id="l33.28" class="difflineminus">-    func.name = &quot;dbDelegate_&quot; + funcName;</span>
<a href="#l33.29"></a><span id="l33.29" class="difflineminus">-    return func;</span>
<a href="#l33.30"></a><span id="l33.30"> }</span>
<a href="#l33.31"></a><span id="l33.31"> </span>
<a href="#l33.32"></a><span id="l33.32"> /**</span>
<a href="#l33.33"></a><span id="l33.33">  * Creates a delegate function for a database getter. Returns a function that</span>
<a href="#l33.34"></a><span id="l33.34">  * can be called to get the specified attribute, if a database is passed. If no</span>
<a href="#l33.35"></a><span id="l33.35">  * database is passed, no error is thrown but null is returned.</span>
<a href="#l33.36"></a><span id="l33.36">  *</span>
<a href="#l33.37"></a><span id="l33.37">  * @param getterAttr        The getter to delegate.</span>
<a href="#l33.38"></a><span id="l33.38">  * @return                  The function that delegates the getter.</span>
<a href="#l33.39"></a><span id="l33.39">  */</span>
<a href="#l33.40"></a><span id="l33.40"> function createDBDelegateGetter(getterAttr) {</span>
<a href="#l33.41"></a><span id="l33.41" class="difflineminus">-    let func = function(db) {</span>
<a href="#l33.42"></a><span id="l33.42" class="difflineplus">+    return function(db) {</span>
<a href="#l33.43"></a><span id="l33.43">         return (db ? db[getterAttr] : null);</span>
<a href="#l33.44"></a><span id="l33.44">     }</span>
<a href="#l33.45"></a><span id="l33.45" class="difflineminus">-</span>
<a href="#l33.46"></a><span id="l33.46" class="difflineminus">-    func.name = &quot;dbDelegate_get_&quot; + getterAttr;</span>
<a href="#l33.47"></a><span id="l33.47" class="difflineminus">-    return func;</span>
<a href="#l33.48"></a><span id="l33.48"> }</span>
<a href="#l33.49"></a><span id="l33.49"> </span>
<a href="#l33.50"></a><span id="l33.50"> // These functions use the db delegate to allow easier calling of common</span>
<a href="#l33.51"></a><span id="l33.51"> // database functions.</span>
<a href="#l33.52"></a><span id="l33.52"> var beginTransaction = createDBDelegate(&quot;beginTransaction&quot;);</span>
<a href="#l33.53"></a><span id="l33.53"> var commitTransaction = createDBDelegate(&quot;commitTransaction&quot;);</span>
<a href="#l33.54"></a><span id="l33.54"> var rollbackTransaction = createDBDelegate(&quot;rollbackTransaction&quot;);</span>
<a href="#l33.55"></a><span id="l33.55"> var createStatement = createDBDelegate(&quot;createStatement&quot;);</span>
<a href="#l33.56"></a><span id="l33.56" class="difflineat">@@ -736,16 +728,21 @@ upgrade.v2 = upgrade.v1 = function upgra</span>
<a href="#l33.57"></a><span id="l33.57"> </span>
<a href="#l33.58"></a><span id="l33.58"> /**</span>
<a href="#l33.59"></a><span id="l33.59">  * Upgrade to version 3.</span>
<a href="#l33.60"></a><span id="l33.60">  * Bug 293707, updates to storage provider; calendar manager database locked</span>
<a href="#l33.61"></a><span id="l33.61">  * fix, r=shaver, p=vlad</span>
<a href="#l33.62"></a><span id="l33.62">  * p=vlad</span>
<a href="#l33.63"></a><span id="l33.63">  */</span>
<a href="#l33.64"></a><span id="l33.64"> upgrade.v3 = function upgrade_v3(db, version) {</span>
<a href="#l33.65"></a><span id="l33.65" class="difflineplus">+    function updateSql(tbl, field) {</span>
<a href="#l33.66"></a><span id="l33.66" class="difflineplus">+        executeSimpleSQL(db, &quot;UPDATE &quot; + tbl + &quot; SET &quot; + field + &quot;_tz='UTC'&quot; +</span>
<a href="#l33.67"></a><span id="l33.67" class="difflineplus">+                             &quot; WHERE &quot; + field + &quot; IS NOT NULL&quot;);</span>
<a href="#l33.68"></a><span id="l33.68" class="difflineplus">+    }</span>
<a href="#l33.69"></a><span id="l33.69" class="difflineplus">+</span>
<a href="#l33.70"></a><span id="l33.70">     let tbl = upgrade.v2(version &lt; 2 &amp;&amp; db, version);</span>
<a href="#l33.71"></a><span id="l33.71">     LOGdb(db, &quot;Storage: Upgrading to v3&quot;);</span>
<a href="#l33.72"></a><span id="l33.72"> </span>
<a href="#l33.73"></a><span id="l33.73">     beginTransaction(db);</span>
<a href="#l33.74"></a><span id="l33.74">     try {</span>
<a href="#l33.75"></a><span id="l33.75"> </span>
<a href="#l33.76"></a><span id="l33.76">         copyTable(tbl, &quot;cal_items&quot;, &quot;cal_events&quot;, db, &quot;item_type = 0&quot;);</span>
<a href="#l33.77"></a><span id="l33.77">         copyTable(tbl, &quot;cal_items&quot;, &quot;cal_todos&quot;, db, &quot;item_type = 1&quot;);</span>
<a href="#l33.78"></a><span id="l33.78" class="difflineat">@@ -783,21 +780,16 @@ upgrade.v3 = function upgrade_v3(db, ver</span>
<a href="#l33.79"></a><span id="l33.79"> </span>
<a href="#l33.80"></a><span id="l33.80">         // The change between 2 and 3 includes the splitting of cal_items into</span>
<a href="#l33.81"></a><span id="l33.81">         // cal_events and cal_todos, and the addition of columns for</span>
<a href="#l33.82"></a><span id="l33.82">         // event_start_tz, event_end_tz, todo_entry_tz, todo_due_tz.</span>
<a href="#l33.83"></a><span id="l33.83">         // These need to default to &quot;UTC&quot; if their corresponding time is</span>
<a href="#l33.84"></a><span id="l33.84">         // given, since that's what the default was for v2 calendars</span>
<a href="#l33.85"></a><span id="l33.85"> </span>
<a href="#l33.86"></a><span id="l33.86">         // Fix up the new timezone columns</span>
<a href="#l33.87"></a><span id="l33.87" class="difflineminus">-        function updateSql(tbl, field) {</span>
<a href="#l33.88"></a><span id="l33.88" class="difflineminus">-            executeSimpleSQL(db, &quot;UPDATE &quot; + tbl + &quot; SET &quot; + field + &quot;_tz='UTC'&quot; +</span>
<a href="#l33.89"></a><span id="l33.89" class="difflineminus">-                                 &quot; WHERE &quot; + field + &quot; IS NOT NULL&quot;);</span>
<a href="#l33.90"></a><span id="l33.90" class="difflineminus">-        }</span>
<a href="#l33.91"></a><span id="l33.91" class="difflineminus">-</span>
<a href="#l33.92"></a><span id="l33.92">         updateSql(&quot;cal_events&quot;, &quot;event_start&quot;);</span>
<a href="#l33.93"></a><span id="l33.93">         updateSql(&quot;cal_events&quot;, &quot;event_end&quot;);</span>
<a href="#l33.94"></a><span id="l33.94">         updateSql(&quot;cal_todos&quot;, &quot;todo_entry&quot;);</span>
<a href="#l33.95"></a><span id="l33.95">         updateSql(&quot;cal_todos&quot;, &quot;todo_due&quot;);</span>
<a href="#l33.96"></a><span id="l33.96">         updateSql(&quot;cal_todos&quot;, &quot;todo_completed&quot;);</span>
<a href="#l33.97"></a><span id="l33.97"> </span>
<a href="#l33.98"></a><span id="l33.98">         setDbVersionAndCommit(db, 3);</span>
<a href="#l33.99"></a><span id="l33.99">     } catch (e) {</span>
<a href="#l33.100"></a><span id="l33.100" class="difflineat">@@ -1530,16 +1522,17 @@ upgrade.v22 = function upgrade_v22(db, v</span>
<a href="#l33.101"></a><span id="l33.101">         });</span>
<a href="#l33.102"></a><span id="l33.102">         migrateToIcalString(tbl, &quot;cal_attendees&quot;, &quot;translateAttendee&quot;,</span>
<a href="#l33.103"></a><span id="l33.103">                             [&quot;attendee_id&quot;, &quot;common_name&quot;, &quot;rsvp&quot;, &quot;role&quot;,</span>
<a href="#l33.104"></a><span id="l33.104">                              &quot;status&quot;, &quot;type&quot;, &quot;is_organizer&quot;, &quot;properties&quot;], db);</span>
<a href="#l33.105"></a><span id="l33.105"> </span>
<a href="#l33.106"></a><span id="l33.106">         // Update recurrence table to using icalString directly</span>
<a href="#l33.107"></a><span id="l33.107">         createFunction(db, &quot;translateRecurrence&quot;, 17, {</span>
<a href="#l33.108"></a><span id="l33.108">             onFunctionCall: function translateRecurrence(storArgs) {</span>
<a href="#l33.109"></a><span id="l33.109" class="difflineplus">+                function parseInt10(x) parseInt(x, 10);</span>
<a href="#l33.110"></a><span id="l33.110">                 try {</span>
<a href="#l33.111"></a><span id="l33.111">                     let [aIndex, aType, aIsNegative, aDates, aCount,</span>
<a href="#l33.112"></a><span id="l33.112">                          aEndDate, aInterval, aSecond, aMinute, aHour,</span>
<a href="#l33.113"></a><span id="l33.113">                          aDay, aMonthday, aYearday, aWeekno, aMonth,</span>
<a href="#l33.114"></a><span id="l33.114">                          aSetPos, aTmpFlags] = mapStorageArgs(storArgs);</span>
<a href="#l33.115"></a><span id="l33.115"> </span>
<a href="#l33.116"></a><span id="l33.116">                     let ritem;</span>
<a href="#l33.117"></a><span id="l33.117">                     if (aType == &quot;x-date&quot;) {</span>
<a href="#l33.118"></a><span id="l33.118" class="difflineat">@@ -1580,17 +1573,16 @@ upgrade.v22 = function upgrade_v22(db, v</span>
<a href="#l33.119"></a><span id="l33.119">                             DAY: aDay,</span>
<a href="#l33.120"></a><span id="l33.120">                             MONTHDAY: aMonthday,</span>
<a href="#l33.121"></a><span id="l33.121">                             YEARDAY: aYearday,</span>
<a href="#l33.122"></a><span id="l33.122">                             WEEKNO: aWeekno,</span>
<a href="#l33.123"></a><span id="l33.123">                             MONTH: aMonth,</span>
<a href="#l33.124"></a><span id="l33.124">                             SETPOS: aSetPos</span>
<a href="#l33.125"></a><span id="l33.125">                         };</span>
<a href="#l33.126"></a><span id="l33.126"> </span>
<a href="#l33.127"></a><span id="l33.127" class="difflineminus">-                        function parseInt10(x) parseInt(x, 10);</span>
<a href="#l33.128"></a><span id="l33.128">                         for (let rtype in rtypes) {</span>
<a href="#l33.129"></a><span id="l33.129">                             if (rtypes[rtype]) {</span>
<a href="#l33.130"></a><span id="l33.130">                                 let comp = &quot;BY&quot; + rtype;</span>
<a href="#l33.131"></a><span id="l33.131">                                 let rstr = rtypes[rtype].toString()</span>
<a href="#l33.132"></a><span id="l33.132">                                 let rarray = rstr.split(&quot;,&quot;).map(parseInt10);</span>
<a href="#l33.133"></a><span id="l33.133">                                 ritem.setComponent(comp, rarray.length, rarray);</span>
<a href="#l33.134"></a><span id="l33.134">                             }</span>
<a href="#l33.135"></a><span id="l33.135">                         }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1" class="difflineminus">--- a/calendar/providers/wcap/calWcapCalendarItems.js</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineplus">+++ b/calendar/providers/wcap/calWcapCalendarItems.js</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineat">@@ -152,17 +152,17 @@ function calWcapCalendar_getAlarmParams(</span>
<a href="#l34.4"></a><span id="l34.4">             // cs does not support explicit RELATED=END when</span>
<a href="#l34.5"></a><span id="l34.5">             // both start|entry and end|due are written</span>
<a href="#l34.6"></a><span id="l34.6">             let dur = item.duration;</span>
<a href="#l34.7"></a><span id="l34.7">             if (dur) { // both given</span>
<a href="#l34.8"></a><span id="l34.8">                 alarmStart = alarmStart.clone();</span>
<a href="#l34.9"></a><span id="l34.9">                 alarmStart.addDuration(dur);</span>
<a href="#l34.10"></a><span id="l34.10">             } // else only end|due is set, alarm makes little sense though</span>
<a href="#l34.11"></a><span id="l34.11">         }</span>
<a href="#l34.12"></a><span id="l34.12" class="difflineminus">-        </span>
<a href="#l34.13"></a><span id="l34.13" class="difflineplus">+</span>
<a href="#l34.14"></a><span id="l34.14">         let emails = &quot;&quot;;</span>
<a href="#l34.15"></a><span id="l34.15">         if (item.hasProperty(&quot;alarmEmailAddress&quot;)) {</span>
<a href="#l34.16"></a><span id="l34.16">             emails = encodeURIComponent(item.getProperty(&quot;alarmEmailAddress&quot;));</span>
<a href="#l34.17"></a><span id="l34.17">         } else {</span>
<a href="#l34.18"></a><span id="l34.18">             emails = this.session.getDefaultAlarmEmails({}).map(encodeURIComponent).join(&quot;;&quot;);</span>
<a href="#l34.19"></a><span id="l34.19">         }</span>
<a href="#l34.20"></a><span id="l34.20">         if (emails.length &gt; 0) {</span>
<a href="#l34.21"></a><span id="l34.21">             params = (&quot;&amp;alarmStart=&quot; + alarmStart.icalString);</span>
<a href="#l34.22"></a><span id="l34.22" class="difflineat">@@ -274,16 +274,61 @@ function diffProperty(newItem, oldItem, </span>
<a href="#l34.23"></a><span id="l34.23"> const METHOD_PUBLISH = 1;</span>
<a href="#l34.24"></a><span id="l34.24"> const METHOD_REQUEST = 2;</span>
<a href="#l34.25"></a><span id="l34.25"> const METHOD_REPLY   = 4;</span>
<a href="#l34.26"></a><span id="l34.26"> const METHOD_CANCEL  = 8;</span>
<a href="#l34.27"></a><span id="l34.27"> const METHOD_UPDATE  = 256;</span>
<a href="#l34.28"></a><span id="l34.28"> </span>
<a href="#l34.29"></a><span id="l34.29"> calWcapCalendar.prototype.storeItem =</span>
<a href="#l34.30"></a><span id="l34.30"> function calWcapCalendar_storeItem(bAddItem, item, oldItem, request) {</span>
<a href="#l34.31"></a><span id="l34.31" class="difflineplus">+    function getOrgId(item) {</span>
<a href="#l34.32"></a><span id="l34.32" class="difflineplus">+        return (item &amp;&amp; item.organizer &amp;&amp; item.organizer.id ? item.organizer.id : null);</span>
<a href="#l34.33"></a><span id="l34.33" class="difflineplus">+    }</span>
<a href="#l34.34"></a><span id="l34.34" class="difflineplus">+    function encodeAttendees(atts) {</span>
<a href="#l34.35"></a><span id="l34.35" class="difflineplus">+        function attendeeSort(one, two) {</span>
<a href="#l34.36"></a><span id="l34.36" class="difflineplus">+            one = one.id;</span>
<a href="#l34.37"></a><span id="l34.37" class="difflineplus">+            two = two.id;</span>
<a href="#l34.38"></a><span id="l34.38" class="difflineplus">+            if (one == two) {</span>
<a href="#l34.39"></a><span id="l34.39" class="difflineplus">+                return 0;</span>
<a href="#l34.40"></a><span id="l34.40" class="difflineplus">+            }</span>
<a href="#l34.41"></a><span id="l34.41" class="difflineplus">+            return (one &lt; two ? -1 : 1);</span>
<a href="#l34.42"></a><span id="l34.42" class="difflineplus">+        }</span>
<a href="#l34.43"></a><span id="l34.43" class="difflineplus">+        atts = atts.concat([]);</span>
<a href="#l34.44"></a><span id="l34.44" class="difflineplus">+        atts.sort(attendeeSort);</span>
<a href="#l34.45"></a><span id="l34.45" class="difflineplus">+        return atts.map(this_.encodeAttendee, this_).join(&quot;;&quot;);</span>
<a href="#l34.46"></a><span id="l34.46" class="difflineplus">+    }</span>
<a href="#l34.47"></a><span id="l34.47" class="difflineplus">+    function encodeCategories(cats) {</span>
<a href="#l34.48"></a><span id="l34.48" class="difflineplus">+        cats = cats.concat([]);</span>
<a href="#l34.49"></a><span id="l34.49" class="difflineplus">+        cats.sort();</span>
<a href="#l34.50"></a><span id="l34.50" class="difflineplus">+        return cats.join(&quot;;&quot;);</span>
<a href="#l34.51"></a><span id="l34.51" class="difflineplus">+    }</span>
<a href="#l34.52"></a><span id="l34.52" class="difflineplus">+    function getPrivacy(item) {</span>
<a href="#l34.53"></a><span id="l34.53" class="difflineplus">+        return ((item.privacy &amp;&amp; item.privacy != &quot;&quot;) ? item.privacy : &quot;PUBLIC&quot;);</span>
<a href="#l34.54"></a><span id="l34.54" class="difflineplus">+    }</span>
<a href="#l34.55"></a><span id="l34.55" class="difflineplus">+    function getAttachments(item) {</span>
<a href="#l34.56"></a><span id="l34.56" class="difflineplus">+        var ret;</span>
<a href="#l34.57"></a><span id="l34.57" class="difflineplus">+        var attachments = item.attachments;</span>
<a href="#l34.58"></a><span id="l34.58" class="difflineplus">+        if (attachments) {</span>
<a href="#l34.59"></a><span id="l34.59" class="difflineplus">+            var strings = [];</span>
<a href="#l34.60"></a><span id="l34.60" class="difflineplus">+            for each (var att in attachements) {</span>
<a href="#l34.61"></a><span id="l34.61" class="difflineplus">+                let wrappedAtt = cal.wrapInstance(att, Components.interfaces.calIAttachment);</span>
<a href="#l34.62"></a><span id="l34.62" class="difflineplus">+                if (typeof(att) == &quot;string&quot;) {</span>
<a href="#l34.63"></a><span id="l34.63" class="difflineplus">+                    strings.push(encodeURIComponent(att));</span>
<a href="#l34.64"></a><span id="l34.64" class="difflineplus">+                } else if (wrappedAtt &amp;&amp; wrappedAtt.uri) {</span>
<a href="#l34.65"></a><span id="l34.65" class="difflineplus">+                    strings.push(encodeURIComponent(wrappedAtt.uri.spec));</span>
<a href="#l34.66"></a><span id="l34.66" class="difflineplus">+                } else { // xxx todo</span>
<a href="#l34.67"></a><span id="l34.67" class="difflineplus">+                    logError(&quot;only URLs supported as attachment, not: &quot; + att, this_);</span>
<a href="#l34.68"></a><span id="l34.68" class="difflineplus">+                }</span>
<a href="#l34.69"></a><span id="l34.69" class="difflineplus">+            }</span>
<a href="#l34.70"></a><span id="l34.70" class="difflineplus">+            strings.sort();</span>
<a href="#l34.71"></a><span id="l34.71" class="difflineplus">+            ret = strings.join(&quot;;&quot;);</span>
<a href="#l34.72"></a><span id="l34.72" class="difflineplus">+        }</span>
<a href="#l34.73"></a><span id="l34.73" class="difflineplus">+        return ret || &quot;&quot;;</span>
<a href="#l34.74"></a><span id="l34.74" class="difflineplus">+    }</span>
<a href="#l34.75"></a><span id="l34.75" class="difflineplus">+</span>
<a href="#l34.76"></a><span id="l34.76">     var this_ = this;</span>
<a href="#l34.77"></a><span id="l34.77">     var bIsEvent = isEvent(item);</span>
<a href="#l34.78"></a><span id="l34.78">     var bIsParent = isParent(item);</span>
<a href="#l34.79"></a><span id="l34.79"> </span>
<a href="#l34.80"></a><span id="l34.80">     var method = METHOD_PUBLISH;</span>
<a href="#l34.81"></a><span id="l34.81">     var bNoSmtpNotify = false;</span>
<a href="#l34.82"></a><span id="l34.82">     var params = &quot;&quot;;</span>
<a href="#l34.83"></a><span id="l34.83"> </span>
<a href="#l34.84"></a><span id="l34.84" class="difflineat">@@ -353,44 +398,28 @@ function calWcapCalendar_storeItem(bAddI</span>
<a href="#l34.85"></a><span id="l34.85">         }</span>
<a href="#l34.86"></a><span id="l34.86">         if (bIsParent) {</span>
<a href="#l34.87"></a><span id="l34.87">             var recParams = this.encodeRecurrenceParams(item, oldItem, !bAddItem /* exclude EXDATEs */);</span>
<a href="#l34.88"></a><span id="l34.88">             if (recParams.length &gt; 0) {</span>
<a href="#l34.89"></a><span id="l34.89">                 oldItem = null; // recurrence/exceptions hack: write whole master</span>
<a href="#l34.90"></a><span id="l34.90">                 params += recParams;</span>
<a href="#l34.91"></a><span id="l34.91">             }</span>
<a href="#l34.92"></a><span id="l34.92">         }</span>
<a href="#l34.93"></a><span id="l34.93" class="difflineminus">-        </span>
<a href="#l34.94"></a><span id="l34.94" class="difflineminus">-        function getOrgId(item) {</span>
<a href="#l34.95"></a><span id="l34.95" class="difflineminus">-            return (item &amp;&amp; item.organizer &amp;&amp; item.organizer.id ? item.organizer.id : null);</span>
<a href="#l34.96"></a><span id="l34.96" class="difflineminus">-        }</span>
<a href="#l34.97"></a><span id="l34.97" class="difflineplus">+</span>
<a href="#l34.98"></a><span id="l34.98">         var orgCalId = getCalId(item.organizer);</span>
<a href="#l34.99"></a><span id="l34.99">         if (!orgCalId) { // new events yet don't have X-S1CS-CALID set on ORGANIZER or this is outbound iTIP</span>
<a href="#l34.100"></a><span id="l34.100">             var orgId = getOrgId(item);</span>
<a href="#l34.101"></a><span id="l34.101">             if (!orgId || (orgId.toLowerCase().replace(/^mailto:/, &quot;&quot;) == this.ownerId.toLowerCase())) {</span>
<a href="#l34.102"></a><span id="l34.102">                 orgCalId = calId; // own event</span>
<a href="#l34.103"></a><span id="l34.103">             } // else outbound</span>
<a href="#l34.104"></a><span id="l34.104">         }</span>
<a href="#l34.105"></a><span id="l34.105" class="difflineminus">-        </span>
<a href="#l34.106"></a><span id="l34.106" class="difflineplus">+</span>
<a href="#l34.107"></a><span id="l34.107">         var attendees = item.getAttendees({});</span>
<a href="#l34.108"></a><span id="l34.108">         if (attendees.length &gt; 0) {</span>
<a href="#l34.109"></a><span id="l34.109">             // xxx todo: why ever, X-S1CS-EMAIL is unsupported though documented for calprops... WTF.</span>
<a href="#l34.110"></a><span id="l34.110" class="difflineminus">-            function encodeAttendees(atts) {</span>
<a href="#l34.111"></a><span id="l34.111" class="difflineminus">-                function attendeeSort(one, two) {</span>
<a href="#l34.112"></a><span id="l34.112" class="difflineminus">-                    one = one.id;</span>
<a href="#l34.113"></a><span id="l34.113" class="difflineminus">-                    two = two.id;</span>
<a href="#l34.114"></a><span id="l34.114" class="difflineminus">-                    if (one == two) {</span>
<a href="#l34.115"></a><span id="l34.115" class="difflineminus">-                        return 0;</span>
<a href="#l34.116"></a><span id="l34.116" class="difflineminus">-                    }</span>
<a href="#l34.117"></a><span id="l34.117" class="difflineminus">-                    return (one &lt; two ? -1 : 1);</span>
<a href="#l34.118"></a><span id="l34.118" class="difflineminus">-                }</span>
<a href="#l34.119"></a><span id="l34.119" class="difflineminus">-                atts = atts.concat([]);</span>
<a href="#l34.120"></a><span id="l34.120" class="difflineminus">-                atts.sort(attendeeSort);</span>
<a href="#l34.121"></a><span id="l34.121" class="difflineminus">-                return atts.map(this_.encodeAttendee, this_).join(&quot;;&quot;);</span>
<a href="#l34.122"></a><span id="l34.122" class="difflineminus">-            }</span>
<a href="#l34.123"></a><span id="l34.123">             var attParam = encodeAttendees(attendees);</span>
<a href="#l34.124"></a><span id="l34.124">             if (!oldItem || attParam != encodeAttendees(oldItem.getAttendees({}))) {</span>
<a href="#l34.125"></a><span id="l34.125">                 params += (&quot;&amp;attendees=&quot; + attParam);</span>
<a href="#l34.126"></a><span id="l34.126">             }</span>
<a href="#l34.127"></a><span id="l34.127"> </span>
<a href="#l34.128"></a><span id="l34.128">             if (orgCalId == calId) {</span>
<a href="#l34.129"></a><span id="l34.129">                 method = METHOD_REQUEST;</span>
<a href="#l34.130"></a><span id="l34.130">             } else {</span>
<a href="#l34.131"></a><span id="l34.131" class="difflineat">@@ -414,21 +443,16 @@ function calWcapCalendar_storeItem(bAddI</span>
<a href="#l34.132"></a><span id="l34.132">         }</span>
<a href="#l34.133"></a><span id="l34.133"> </span>
<a href="#l34.134"></a><span id="l34.134">         var val = item.title;</span>
<a href="#l34.135"></a><span id="l34.135">         if (!oldItem || val != oldItem.title) {</span>
<a href="#l34.136"></a><span id="l34.136">             params += (&quot;&amp;summary=&quot; + encodeURIComponent(val));</span>
<a href="#l34.137"></a><span id="l34.137">         }</span>
<a href="#l34.138"></a><span id="l34.138"> </span>
<a href="#l34.139"></a><span id="l34.139">         let categories = item.getCategories({});</span>
<a href="#l34.140"></a><span id="l34.140" class="difflineminus">-        function encodeCategories(cats) {</span>
<a href="#l34.141"></a><span id="l34.141" class="difflineminus">-            cats = cats.concat([]);</span>
<a href="#l34.142"></a><span id="l34.142" class="difflineminus">-            cats.sort();</span>
<a href="#l34.143"></a><span id="l34.143" class="difflineminus">-            return cats.join(&quot;;&quot;);</span>
<a href="#l34.144"></a><span id="l34.144" class="difflineminus">-        }</span>
<a href="#l34.145"></a><span id="l34.145">         let catParam = encodeCategories(categories);</span>
<a href="#l34.146"></a><span id="l34.146">         if (!oldItem || catParam != encodeCategories(oldItem.getCategories({}))) {</span>
<a href="#l34.147"></a><span id="l34.147">             params += (&quot;&amp;categories=&quot; + catParam);</span>
<a href="#l34.148"></a><span id="l34.148">         }</span>
<a href="#l34.149"></a><span id="l34.149"> </span>
<a href="#l34.150"></a><span id="l34.150">         val = diffProperty(item, oldItem, &quot;DESCRIPTION&quot;);</span>
<a href="#l34.151"></a><span id="l34.151">         if (val !== null) {</span>
<a href="#l34.152"></a><span id="l34.152">             params += (&quot;&amp;desc=&quot; + encodeURIComponent(val));</span>
<a href="#l34.153"></a><span id="l34.153" class="difflineat">@@ -442,19 +466,16 @@ function calWcapCalendar_storeItem(bAddI</span>
<a href="#l34.154"></a><span id="l34.154">             params += (&quot;&amp;icsUrl=&quot; + encodeURIComponent(val));</span>
<a href="#l34.155"></a><span id="l34.155">         }</span>
<a href="#l34.156"></a><span id="l34.156">         // xxx todo: default prio is 0 (5 in sjs cs)</span>
<a href="#l34.157"></a><span id="l34.157">         val = item.priority;</span>
<a href="#l34.158"></a><span id="l34.158">         if (!oldItem || val != oldItem.priority) {</span>
<a href="#l34.159"></a><span id="l34.159">             params += (&quot;&amp;priority=&quot; + encodeURIComponent(val));</span>
<a href="#l34.160"></a><span id="l34.160">         }</span>
<a href="#l34.161"></a><span id="l34.161"> </span>
<a href="#l34.162"></a><span id="l34.162" class="difflineminus">-        function getPrivacy(item) {</span>
<a href="#l34.163"></a><span id="l34.163" class="difflineminus">-            return ((item.privacy &amp;&amp; item.privacy != &quot;&quot;) ? item.privacy : &quot;PUBLIC&quot;);</span>
<a href="#l34.164"></a><span id="l34.164" class="difflineminus">-        }</span>
<a href="#l34.165"></a><span id="l34.165">         var icsClass = getPrivacy(item);</span>
<a href="#l34.166"></a><span id="l34.166">         if (!oldItem || icsClass != getPrivacy(oldItem)) {</span>
<a href="#l34.167"></a><span id="l34.167">             params += (&quot;&amp;icsClass=&quot; + icsClass);</span>
<a href="#l34.168"></a><span id="l34.168">         }</span>
<a href="#l34.169"></a><span id="l34.169"> </span>
<a href="#l34.170"></a><span id="l34.170">         if (!oldItem || item.status != oldItem.status) {</span>
<a href="#l34.171"></a><span id="l34.171">             switch (item.status) {</span>
<a href="#l34.172"></a><span id="l34.172">                 case &quot;CONFIRMED&quot;:    params += &quot;&amp;status=0&quot;; break;</span>
<a href="#l34.173"></a><span id="l34.173" class="difflineat">@@ -491,42 +512,22 @@ function calWcapCalendar_storeItem(bAddI</span>
<a href="#l34.174"></a><span id="l34.174">                 params += (&quot;&amp;percent=&quot; + item.percentComplete.toString(10));</span>
<a href="#l34.175"></a><span id="l34.175">             }</span>
<a href="#l34.176"></a><span id="l34.176">             if (!oldItem || !equalDatetimes(item.completedDate, oldItem.completedDate)) {</span>
<a href="#l34.177"></a><span id="l34.177">                 params += (&quot;&amp;completed=&quot; + getIcalUTC(item.completedDate));</span>
<a href="#l34.178"></a><span id="l34.178">             }</span>
<a href="#l34.179"></a><span id="l34.179">         }</span>
<a href="#l34.180"></a><span id="l34.180"> </span>
<a href="#l34.181"></a><span id="l34.181">         // attachment urls:</span>
<a href="#l34.182"></a><span id="l34.182" class="difflineminus">-        function getAttachments(item) {</span>
<a href="#l34.183"></a><span id="l34.183" class="difflineminus">-            var ret = &quot;&quot;;</span>
<a href="#l34.184"></a><span id="l34.184" class="difflineminus">-            var attachments = item.attachments;</span>
<a href="#l34.185"></a><span id="l34.185" class="difflineminus">-            if (attachments) {</span>
<a href="#l34.186"></a><span id="l34.186" class="difflineminus">-                var strings = [];</span>
<a href="#l34.187"></a><span id="l34.187" class="difflineminus">-                for each (var att in attachements) {</span>
<a href="#l34.188"></a><span id="l34.188" class="difflineminus">-                    let wrappedAtt = cal.wrapInstance(att, Components.interfaces.calIAttachment);</span>
<a href="#l34.189"></a><span id="l34.189" class="difflineminus">-                    if (typeof(att) == &quot;string&quot;) {</span>
<a href="#l34.190"></a><span id="l34.190" class="difflineminus">-                        strings.push(encodeURIComponent(att));</span>
<a href="#l34.191"></a><span id="l34.191" class="difflineminus">-                    } else if (wrappedAtt &amp;&amp; wrappedAtt.uri) {</span>
<a href="#l34.192"></a><span id="l34.192" class="difflineminus">-                        strings.push(encodeURIComponent(wrappedAtt.uri.spec));</span>
<a href="#l34.193"></a><span id="l34.193" class="difflineminus">-                    } else { // xxx todo</span>
<a href="#l34.194"></a><span id="l34.194" class="difflineminus">-                        logError(&quot;only URLs supported as attachment, not: &quot; + att, this_);</span>
<a href="#l34.195"></a><span id="l34.195" class="difflineminus">-                    }</span>
<a href="#l34.196"></a><span id="l34.196" class="difflineminus">-                }</span>
<a href="#l34.197"></a><span id="l34.197" class="difflineminus">-                strings.sort();</span>
<a href="#l34.198"></a><span id="l34.198" class="difflineminus">-                ret += strings.join(&quot;;&quot;);</span>
<a href="#l34.199"></a><span id="l34.199" class="difflineminus">-            }</span>
<a href="#l34.200"></a><span id="l34.200" class="difflineminus">-            return ret;</span>
<a href="#l34.201"></a><span id="l34.201" class="difflineminus">-        }</span>
<a href="#l34.202"></a><span id="l34.202">         var val = getAttachments(item);</span>
<a href="#l34.203"></a><span id="l34.203">         if (!oldItem || val != getAttachments(oldItem)) {</span>
<a href="#l34.204"></a><span id="l34.204">             params += (&quot;&amp;attachments=&quot; + val);</span>
<a href="#l34.205"></a><span id="l34.205">         }</span>
<a href="#l34.206"></a><span id="l34.206">     } // PUBLISH, REQUEST</span>
<a href="#l34.207"></a><span id="l34.207" class="difflineminus">-    </span>
<a href="#l34.208"></a><span id="l34.208" class="difflineplus">+</span>
<a href="#l34.209"></a><span id="l34.209">     var alarmParams = this.getAlarmParams(item);</span>
<a href="#l34.210"></a><span id="l34.210">     if (!oldItem || (this.getAlarmParams(oldItem) != alarmParams)) {</span>
<a href="#l34.211"></a><span id="l34.211">         if ((method == METHOD_REQUEST) &amp;&amp; params.length == 0) {</span>
<a href="#l34.212"></a><span id="l34.212">             // assure no email notifications about this change:</span>
<a href="#l34.213"></a><span id="l34.213">             bNoSmtpNotify = true;</span>
<a href="#l34.214"></a><span id="l34.214">         }</span>
<a href="#l34.215"></a><span id="l34.215">         params += alarmParams;</span>
<a href="#l34.216"></a><span id="l34.216">     }</span>
<a href="#l34.217"></a><span id="l34.217" class="difflineat">@@ -561,38 +562,38 @@ function calWcapCalendar_storeItem(bAddI</span>
<a href="#l34.218"></a><span id="l34.218">         } else {</span>
<a href="#l34.219"></a><span id="l34.219">             params += (&quot;&amp;mod=1&amp;rid=&quot; + getIcalUTC(ensureDateTime(item.recurrenceId))); // THIS INSTANCE</span>
<a href="#l34.220"></a><span id="l34.220">         }</span>
<a href="#l34.221"></a><span id="l34.221"> </span>
<a href="#l34.222"></a><span id="l34.222">         params += (&quot;&amp;method=&quot; + method);</span>
<a href="#l34.223"></a><span id="l34.223">         if (bNoSmtpNotify) {</span>
<a href="#l34.224"></a><span id="l34.224">             params += &quot;&amp;smtp=0&amp;smtpNotify=0&amp;notify=0&quot;;</span>
<a href="#l34.225"></a><span id="l34.225">         }</span>
<a href="#l34.226"></a><span id="l34.226" class="difflineminus">-        params += &quot;&amp;replace=1&quot;; // (update) don't append to any lists    </span>
<a href="#l34.227"></a><span id="l34.227" class="difflineplus">+        params += &quot;&amp;replace=1&quot;; // (update) don't append to any lists</span>
<a href="#l34.228"></a><span id="l34.228">         params += &quot;&amp;fetch=1&amp;relativealarm=1&amp;compressed=1&amp;recurring=1&quot;;</span>
<a href="#l34.229"></a><span id="l34.229">         params += &quot;&amp;emailorcalid=1&amp;fmt-out=text%2Fcalendar&quot;;</span>
<a href="#l34.230"></a><span id="l34.230"> </span>
<a href="#l34.231"></a><span id="l34.231" class="difflineminus">-        function netRespFunc(err, icalRootComp) {</span>
<a href="#l34.232"></a><span id="l34.232" class="difflineplus">+        let netRespFunc = (err, icalRootComp) =&gt; {</span>
<a href="#l34.233"></a><span id="l34.233">             if (err) {</span>
<a href="#l34.234"></a><span id="l34.234">                 throw err;</span>
<a href="#l34.235"></a><span id="l34.235">             }</span>
<a href="#l34.236"></a><span id="l34.236" class="difflineminus">-            var items = this_.parseItems(icalRootComp, calICalendar.ITEM_FILTER_ALL_ITEMS,</span>
<a href="#l34.237"></a><span id="l34.237" class="difflineminus">-                                         0, null, null, true /* bLeaveMutable */);</span>
<a href="#l34.238"></a><span id="l34.238" class="difflineplus">+            var items = this.parseItems(icalRootComp, calICalendar.ITEM_FILTER_ALL_ITEMS,</span>
<a href="#l34.239"></a><span id="l34.239" class="difflineplus">+                                        0, null, null, true /* bLeaveMutable */);</span>
<a href="#l34.240"></a><span id="l34.240">             if (items.length != 1) {</span>
<a href="#l34.241"></a><span id="l34.241" class="difflineminus">-                this_.notifyError(NS_ERROR_UNEXPECTED,</span>
<a href="#l34.242"></a><span id="l34.242" class="difflineminus">-                                  &quot;unexpected number of items: &quot; + items.length);</span>
<a href="#l34.243"></a><span id="l34.243" class="difflineplus">+                this.notifyError(NS_ERROR_UNEXPECTED,</span>
<a href="#l34.244"></a><span id="l34.244" class="difflineplus">+                                 &quot;unexpected number of items: &quot; + items.length);</span>
<a href="#l34.245"></a><span id="l34.245">             }</span>
<a href="#l34.246"></a><span id="l34.246">             var newItem = items[0];</span>
<a href="#l34.247"></a><span id="l34.247" class="difflineminus">-            this_.tunnelXProps(newItem, item);</span>
<a href="#l34.248"></a><span id="l34.248" class="difflineplus">+            this.tunnelXProps(newItem, item);</span>
<a href="#l34.249"></a><span id="l34.249">             newItem.makeImmutable();</span>
<a href="#l34.250"></a><span id="l34.250">             // invalidate cached results:</span>
<a href="#l34.251"></a><span id="l34.251" class="difflineminus">-            delete this_.m_cachedResults;</span>
<a href="#l34.252"></a><span id="l34.252" class="difflineplus">+            delete this.m_cachedResults;</span>
<a href="#l34.253"></a><span id="l34.253">             // xxx todo: may log request status</span>
<a href="#l34.254"></a><span id="l34.254">             request.execRespFunc(null, newItem);</span>
<a href="#l34.255"></a><span id="l34.255" class="difflineminus">-        }</span>
<a href="#l34.256"></a><span id="l34.256" class="difflineplus">+        };</span>
<a href="#l34.257"></a><span id="l34.257">         this.issueNetworkRequest(request, netRespFunc, stringToIcal,</span>
<a href="#l34.258"></a><span id="l34.258">                                  bIsEvent ? &quot;storeevents&quot; : &quot;storetodos&quot;, params,</span>
<a href="#l34.259"></a><span id="l34.259">                                  calIWcapCalendar.AC_COMP_READ |</span>
<a href="#l34.260"></a><span id="l34.260">                                  calIWcapCalendar.AC_COMP_WRITE);</span>
<a href="#l34.261"></a><span id="l34.261">     }</span>
<a href="#l34.262"></a><span id="l34.262"> };</span>
<a href="#l34.263"></a><span id="l34.263"> </span>
<a href="#l34.264"></a><span id="l34.264"> calWcapCalendar.prototype.tunnelXProps =</span>
<a href="#l34.265"></a><span id="l34.265" class="difflineat">@@ -939,17 +940,17 @@ calWcapCalendar.prototype.parseItems = f</span>
<a href="#l34.266"></a><span id="l34.266">             parent.calendar = this.superCalendar;</span>
<a href="#l34.267"></a><span id="l34.267">             parent.setProperty(&quot;DTSTART&quot;, item.recurrenceId);</span>
<a href="#l34.268"></a><span id="l34.268">             parent.setProperty(&quot;X-MOZ-FAKED-MASTER&quot;, &quot;1&quot;); // this tag might be useful in the future</span>
<a href="#l34.269"></a><span id="l34.269">             parent.recurrenceInfo = createRecurrenceInfo(parent);</span>
<a href="#l34.270"></a><span id="l34.270">             fakedParents[item.id] = true;</span>
<a href="#l34.271"></a><span id="l34.271">             uid2parent[item.id] = parent;</span>
<a href="#l34.272"></a><span id="l34.272">             items.push(parent);</span>
<a href="#l34.273"></a><span id="l34.273">         }</span>
<a href="#l34.274"></a><span id="l34.274" class="difflineminus">-        if (item.id in fakedParents) { </span>
<a href="#l34.275"></a><span id="l34.275" class="difflineplus">+        if (item.id in fakedParents) {</span>
<a href="#l34.276"></a><span id="l34.276">             let rdate = Components.classes[&quot;@mozilla.org/calendar/recurrence-date;1&quot;]</span>
<a href="#l34.277"></a><span id="l34.277">                                   .createInstance(Components.interfaces.calIRecurrenceDate);</span>
<a href="#l34.278"></a><span id="l34.278">             rdate.date = item.recurrenceId;</span>
<a href="#l34.279"></a><span id="l34.279">             parent.recurrenceInfo.appendRecurrenceItem(rdate);</span>
<a href="#l34.280"></a><span id="l34.280">         }</span>
<a href="#l34.281"></a><span id="l34.281"> </span>
<a href="#l34.282"></a><span id="l34.282">         let recStartDate = parent.recurrenceStartDate;</span>
<a href="#l34.283"></a><span id="l34.283">         if (recStartDate &amp;&amp; recStartDate.isDate &amp;&amp; !item.recurrenceId.isDate) {</span>
<a href="#l34.284"></a><span id="l34.284" class="difflineat">@@ -1058,36 +1059,36 @@ function calWcapCalendar_getItem(id, lis</span>
<a href="#l34.285"></a><span id="l34.285">     try {</span>
<a href="#l34.286"></a><span id="l34.286">         if (!id) {</span>
<a href="#l34.287"></a><span id="l34.287">             throw new Components.Exception(&quot;no item id!&quot;);</span>
<a href="#l34.288"></a><span id="l34.288">         }</span>
<a href="#l34.289"></a><span id="l34.289">         var params = &quot;&amp;relativealarm=1&amp;compressed=1&amp;recurring=1&quot;;</span>
<a href="#l34.290"></a><span id="l34.290">         params += &quot;&amp;emailorcalid=1&amp;fmt-out=text%2Fcalendar&amp;uid=&quot;;</span>
<a href="#l34.291"></a><span id="l34.291">         params += encodeURIComponent(id);</span>
<a href="#l34.292"></a><span id="l34.292"> </span>
<a href="#l34.293"></a><span id="l34.293" class="difflineminus">-        function notifyResult(icalRootComp) {</span>
<a href="#l34.294"></a><span id="l34.294" class="difflineminus">-            var items = this_.parseItems(icalRootComp, calICalendar.ITEM_FILTER_ALL_ITEMS, 0, null, null);</span>
<a href="#l34.295"></a><span id="l34.295" class="difflineminus">-            if (items.length &lt; 1) {</span>
<a href="#l34.296"></a><span id="l34.296" class="difflineminus">-                throw new Components.Exception(&quot;no such item!&quot;);</span>
<a href="#l34.297"></a><span id="l34.297" class="difflineminus">-            }</span>
<a href="#l34.298"></a><span id="l34.298" class="difflineminus">-            if (items.length &gt; 1) {</span>
<a href="#l34.299"></a><span id="l34.299" class="difflineminus">-                this_.notifyError(NS_ERROR_UNEXPECTED,</span>
<a href="#l34.300"></a><span id="l34.300" class="difflineminus">-                                  &quot;unexpected number of items: &quot; + items.length);</span>
<a href="#l34.301"></a><span id="l34.301" class="difflineminus">-            }</span>
<a href="#l34.302"></a><span id="l34.302" class="difflineminus">-            if (listener) {</span>
<a href="#l34.303"></a><span id="l34.303" class="difflineminus">-                listener.onGetResult(this_.superCalendar, NS_OK,</span>
<a href="#l34.304"></a><span id="l34.304" class="difflineminus">-                                     calIItemBase, log(&quot;getItem(): success. id=&quot; + id, this_),</span>
<a href="#l34.305"></a><span id="l34.305" class="difflineminus">-                                     items.length, items);</span>
<a href="#l34.306"></a><span id="l34.306" class="difflineminus">-            }</span>
<a href="#l34.307"></a><span id="l34.307" class="difflineminus">-            request.execRespFunc(null, items[0]);</span>
<a href="#l34.308"></a><span id="l34.308" class="difflineminus">-        };</span>
<a href="#l34.309"></a><span id="l34.309">         // most common: try events first</span>
<a href="#l34.310"></a><span id="l34.310">         this.issueNetworkRequest(</span>
<a href="#l34.311"></a><span id="l34.311">             request,</span>
<a href="#l34.312"></a><span id="l34.312">             function fetchEventById_resp(err, icalRootComp) {</span>
<a href="#l34.313"></a><span id="l34.313" class="difflineplus">+                function notifyResult(icalRootComp) {</span>
<a href="#l34.314"></a><span id="l34.314" class="difflineplus">+                    var items = this_.parseItems(icalRootComp, calICalendar.ITEM_FILTER_ALL_ITEMS, 0, null, null);</span>
<a href="#l34.315"></a><span id="l34.315" class="difflineplus">+                    if (items.length &lt; 1) {</span>
<a href="#l34.316"></a><span id="l34.316" class="difflineplus">+                        throw new Components.Exception(&quot;no such item!&quot;);</span>
<a href="#l34.317"></a><span id="l34.317" class="difflineplus">+                    }</span>
<a href="#l34.318"></a><span id="l34.318" class="difflineplus">+                    if (items.length &gt; 1) {</span>
<a href="#l34.319"></a><span id="l34.319" class="difflineplus">+                        this_.notifyError(NS_ERROR_UNEXPECTED,</span>
<a href="#l34.320"></a><span id="l34.320" class="difflineplus">+                                          &quot;unexpected number of items: &quot; + items.length);</span>
<a href="#l34.321"></a><span id="l34.321" class="difflineplus">+                    }</span>
<a href="#l34.322"></a><span id="l34.322" class="difflineplus">+                    if (listener) {</span>
<a href="#l34.323"></a><span id="l34.323" class="difflineplus">+                        listener.onGetResult(this_.superCalendar, NS_OK,</span>
<a href="#l34.324"></a><span id="l34.324" class="difflineplus">+                                             calIItemBase, log(&quot;getItem(): success. id=&quot; + id, this_),</span>
<a href="#l34.325"></a><span id="l34.325" class="difflineplus">+                                             items.length, items);</span>
<a href="#l34.326"></a><span id="l34.326" class="difflineplus">+                    }</span>
<a href="#l34.327"></a><span id="l34.327" class="difflineplus">+                    request.execRespFunc(null, items[0]);</span>
<a href="#l34.328"></a><span id="l34.328" class="difflineplus">+                };</span>
<a href="#l34.329"></a><span id="l34.329">                 if (err) {</span>
<a href="#l34.330"></a><span id="l34.330">                     if (!checkErrorCode(err, calIWcapErrors.WCAP_FETCH_EVENTS_BY_ID_FAILED) &amp;&amp;</span>
<a href="#l34.331"></a><span id="l34.331">                         !checkErrorCode(err, calIWcapErrors.WCAP_COMPONENT_NOT_FOUND)) {</span>
<a href="#l34.332"></a><span id="l34.332">                         throw err;</span>
<a href="#l34.333"></a><span id="l34.333">                     }</span>
<a href="#l34.334"></a><span id="l34.334">                     // try todos:</span>
<a href="#l34.335"></a><span id="l34.335">                     this_.issueNetworkRequest(</span>
<a href="#l34.336"></a><span id="l34.336">                         request,</span>
<a href="#l34.337"></a><span id="l34.337" class="difflineat">@@ -1143,32 +1144,32 @@ function getItemFilterParams(itemFilter)</span>
<a href="#l34.338"></a><span id="l34.338"> }</span>
<a href="#l34.339"></a><span id="l34.339"> </span>
<a href="#l34.340"></a><span id="l34.340"> calWcapCalendar.prototype.getItems =</span>
<a href="#l34.341"></a><span id="l34.341"> function calWcapCalendar_getItems(itemFilter, maxResults, rangeStart, rangeEnd, listener) {</span>
<a href="#l34.342"></a><span id="l34.342">     rangeStart = ensureDateTime(rangeStart);</span>
<a href="#l34.343"></a><span id="l34.343">     rangeEnd = ensureDateTime(rangeEnd);</span>
<a href="#l34.344"></a><span id="l34.344">     var zRangeStart = getIcalUTC(rangeStart);</span>
<a href="#l34.345"></a><span id="l34.345">     var zRangeEnd = getIcalUTC(rangeEnd);</span>
<a href="#l34.346"></a><span id="l34.346" class="difflineminus">-    </span>
<a href="#l34.347"></a><span id="l34.347" class="difflineplus">+</span>
<a href="#l34.348"></a><span id="l34.348">     var this_ = this;</span>
<a href="#l34.349"></a><span id="l34.349">     var request = new calWcapRequest(</span>
<a href="#l34.350"></a><span id="l34.350">         function getItems_resp(request, err, data) {</span>
<a href="#l34.351"></a><span id="l34.351">             log(&quot;getItems() complete: &quot; + errorToString(err), this_);</span>
<a href="#l34.352"></a><span id="l34.352">             this_.notifyOperationComplete(listener,</span>
<a href="#l34.353"></a><span id="l34.353">                                           getResultCode(err),</span>
<a href="#l34.354"></a><span id="l34.354">                                           calIOperationListener.GET,</span>
<a href="#l34.355"></a><span id="l34.355">                                           null,</span>
<a href="#l34.356"></a><span id="l34.356">                                           err);</span>
<a href="#l34.357"></a><span id="l34.357">         },</span>
<a href="#l34.358"></a><span id="l34.358">         log(&quot;getItems():\n\titemFilter=0x&quot; + itemFilter.toString(0x10) +</span>
<a href="#l34.359"></a><span id="l34.359">             &quot;,\n\tmaxResults=&quot; + maxResults +</span>
<a href="#l34.360"></a><span id="l34.360">             &quot;,\n\trangeStart=&quot; + zRangeStart +</span>
<a href="#l34.361"></a><span id="l34.361">             &quot;,\n\trangeEnd=&quot; + zRangeEnd, this));</span>
<a href="#l34.362"></a><span id="l34.362" class="difflineminus">-    </span>
<a href="#l34.363"></a><span id="l34.363" class="difflineplus">+</span>
<a href="#l34.364"></a><span id="l34.364">     if (this.aboutToBeUnregistered) {</span>
<a href="#l34.365"></a><span id="l34.365">         // limiting the amount of network traffic while unregistering</span>
<a href="#l34.366"></a><span id="l34.366">         log(&quot;being unregistered, no results.&quot;, this);</span>
<a href="#l34.367"></a><span id="l34.367">         request.execRespFunc(null, []);</span>
<a href="#l34.368"></a><span id="l34.368">         return request;</span>
<a href="#l34.369"></a><span id="l34.369">     }</span>
<a href="#l34.370"></a><span id="l34.370"> </span>
<a href="#l34.371"></a><span id="l34.371">     // m_cachedResults holds the last data revtrieval. This is expecially useful when</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1" class="difflineminus">--- a/calendar/providers/wcap/calWcapSession.js</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineplus">+++ b/calendar/providers/wcap/calWcapSession.js</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineat">@@ -1053,25 +1053,26 @@ calWcapSession.prototype = {</span>
<a href="#l35.4"></a><span id="l35.4">             Services.obs.removeObserver(this, &quot;quit-application&quot;);</span>
<a href="#l35.5"></a><span id="l35.5">         }</span>
<a href="#l35.6"></a><span id="l35.6">     },</span>
<a href="#l35.7"></a><span id="l35.7"> </span>
<a href="#l35.8"></a><span id="l35.8">     // calICalendarManagerObserver:</span>
<a href="#l35.9"></a><span id="l35.9"> </span>
<a href="#l35.10"></a><span id="l35.10">     // called after the calendar is registered</span>
<a href="#l35.11"></a><span id="l35.11">     onCalendarRegistered: function calWcapSession_onCalendarRegistered(aCalendar) {</span>
<a href="#l35.12"></a><span id="l35.12" class="difflineplus">+        function assureDefault(pref, val) {</span>
<a href="#l35.13"></a><span id="l35.13" class="difflineplus">+            if (aCalendar.getProperty(pref) === null) {</span>
<a href="#l35.14"></a><span id="l35.14" class="difflineplus">+                aCalendar.setProperty(pref, val);</span>
<a href="#l35.15"></a><span id="l35.15" class="difflineplus">+            }</span>
<a href="#l35.16"></a><span id="l35.16" class="difflineplus">+        }</span>
<a href="#l35.17"></a><span id="l35.17" class="difflineplus">+</span>
<a href="#l35.18"></a><span id="l35.18">         try {</span>
<a href="#l35.19"></a><span id="l35.19">             // make sure the calendar belongs to this session:</span>
<a href="#l35.20"></a><span id="l35.20">             if (this.belongsTo(aCalendar)) {</span>
<a href="#l35.21"></a><span id="l35.21"> </span>
<a href="#l35.22"></a><span id="l35.22" class="difflineminus">-                function assureDefault(pref, val) {</span>
<a href="#l35.23"></a><span id="l35.23" class="difflineminus">-                    if (aCalendar.getProperty(pref) === null) {</span>
<a href="#l35.24"></a><span id="l35.24" class="difflineminus">-                        aCalendar.setProperty(pref, val);</span>
<a href="#l35.25"></a><span id="l35.25" class="difflineminus">-                    }</span>
<a href="#l35.26"></a><span id="l35.26" class="difflineminus">-                }</span>
<a href="#l35.27"></a><span id="l35.27"> </span>
<a href="#l35.28"></a><span id="l35.28">                 assureDefault(&quot;shared_context&quot;, this.m_contextId);</span>
<a href="#l35.29"></a><span id="l35.29">                 assureDefault(&quot;name&quot;, aCalendar.name);</span>
<a href="#l35.30"></a><span id="l35.30"> </span>
<a href="#l35.31"></a><span id="l35.31">                 const s_colors = [&quot;#FFCCCC&quot;, &quot;#FFCC99&quot;, &quot;#FFFF99&quot;, &quot;#FFFFCC&quot;, &quot;#99FF99&quot;,</span>
<a href="#l35.32"></a><span id="l35.32">                                   &quot;#99FFFF&quot;, &quot;#CCFFFF&quot;, &quot;#CCCCFF&quot;, &quot;#FFCCFF&quot;, &quot;#FF6666&quot;,</span>
<a href="#l35.33"></a><span id="l35.33">                                   &quot;#FF9966&quot;, &quot;#FFFF66&quot;, &quot;#FFFF33&quot;, &quot;#66FF99&quot;, &quot;#33FFFF&quot;,</span>
<a href="#l35.34"></a><span id="l35.34">                                   &quot;#66FFFF&quot;, &quot;#9999FF&quot;, &quot;#FF99FF&quot;, &quot;#FF0000&quot;, &quot;#FF9900&quot;,</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

